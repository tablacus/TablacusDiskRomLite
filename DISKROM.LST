                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
       0159                     CALBAS  EQU 00159H
       01F5                     REDCLK  EQU 001F5H  ;SUB
       01F9                     WRTCLK  EQU 001F9H  ;SUB
                                
       269A                     DECADD  EQU 0269AH
       27E6                     DECMUL  EQU 027E6H
       2F8A                     FRCINT  EQU 02F8AH
                                
       303A                     FRCDBL  EQU 0303AH
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
       7D17                     ST_BAS  EQU 07D17H
                                
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F847                     ARG EQU 0F847H
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
       FAF8                     EXBRSA  EQU 0FAF8H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBB1                     BASROM  EQU 0FBB1H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCC9                     SLTATR  EQU 0FCC9H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
       FD99                     DEVICE  EQU 0FD99H
                                
       FDDB                     H_PINL  EQU 0FDDBH
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                            ;ASCII-16K
                                ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
                                ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
       F280                     ISC EQU 0F280H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F280                     SP32    EQU 0F280H
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0042                    DW  INIT_ROM    ; Main program execution address.
000004 4004 6D4F                    DW  STATEMENT   ; STATEMENT
000006 4006 8A50                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C3DB51          10      JP  DISKIO
000013 4013 C31652          10      JP  DSKCHG
000016 4016 C36C52          10      JP  GETDPB
000019 4019 C35F53          10      JP  CHOICE
00001C 401C C36353          10      JP  DSKFMT
00001F 401F C36553          10      JP  DSKSTP
000022 4022 C36653          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C36353          10      JP  DSKFMT
000029 4029 C36553          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C39F53          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite"
            204449534B20524F    
            4D204C697465        
000096 4096                         ALIGN   32
0000A0 40A0 76302E362E302E32        DB  "v0.6.0.2"
0000A8 40A8                         ALIGN   32
       40C0                     MSG_ERROR_ROM_MODE:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DB  "Normal ROM/ASCII-16K only!",13,10
                                #else
0000C0 40C0 41534349492D384B        DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
            2F4B6F6E616D692D    
            384B2F4B6F6E616D    
            692D534343206F6E    
            6C79210D0A          
                                #endif
0001BD 41BD                         ORG 041BDH
0001BD 41BD C9              10      RET
                                
                                    ;MBR_Partition1 (2DDのデータ)
0001BE 41BE 00                      DB  0       ;ブートフラグ
0001BF 41BF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001C2 41C2 01                      DB  1       ;識別子(FAT12)
0001C3 41C3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001C6 41C6 10000000                DW  16,0        ;パーティションの最初のセクタ番号(LBA方式)
0001CA 41CA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                    ;MBR_Partition2 (2DDのデータ)
0001CE 41CE 00                      DB  0       ;ブートフラグ
0001CF 41CF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001D2 41D2 01                      DB  1       ;識別子(FAT12)
0001D3 41D3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001D6 41D6 B0050000                DW  16+1440,0   ;パーティションの最初のセクタ番号(LBA方式)
0001DA 41DA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                #endif
                                
0001FE 41FE                         ORG 041FEH
0001FE 41FE 55AA                    DB  055H,0AAH   ;MBR_Sig
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4200                     INIT_ROM:
000200 4200 3A21FB          13      LD  A,(DRVTBL)
000203 4203 FE01             7      CP  1
000205 4205 C8              11      RET Z
                                
000206 4206 AF               4      XOR A
000207 4207 2100F3          10      LD  HL,0F300H
00020A 420A 0668             7      LD  B,068H
00020C 420C CD214C          17      CALL    FILL_MEMORY
                                
00020F 420F 3E01             7      LD  A,1
000211 4211 3221FB          13      LD  (DRVTBL),A
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  HL,(STKTOP) ;起動時の空き容量表示の為
                                    LD  BC,-00140H
                                    ADD HL,BC
                                    LD  (STKTOP),HL
                                #else
000214 4214 2175F6          10      LD  HL,STKTOP+1 ;起動時の空き容量表示の為
000217 4217 35              11      DEC (HL)
                                #endif
                                
000218 4218 AF               4      XOR A
000219 4219 32EAF2          13      LD  (_DVSW),A
00021C 421C 3D               4      DEC A       ;0FFH
00021D 421D 3299FD          13      LD  (DEVICE),A
                                
000220 4220 210D44          10      LD  HL,AT_ISC
000223 4223 1180F2          10      LD  DE,ISC
000226 4226 018800          10      LD  BC,ISC_E-ISC
000229 4229 EDB0                    LDIR
                                    
00022B 422B 3EC3             7      LD  A,0C3H      ;JP
00022D 422D 3243FF          13      LD  (H_GONE),A
000230 4230 327DF3          13      LD  (BDOS),A
000233 4233 326BF3          13      LD  (RAMUSE),A
000236 4236 3268F3          13      LD  (ROMUSE),A
000239 4239 2180F2          10      LD  HL,REPLACE_COMMAND
00023C 423C 2244FF          16      LD  (H_GONE+1),HL
00023F 423F 2131F3          10      LD  HL,H_BDOS
000242 4242 227EF3          16      LD  (BDOS+1),HL
000245 4245 21ABF2          10      LD  HL,RAMUSE1
000248 4248 226CF3          16      LD  (RAMUSE+1),HL
00024B 424B 21BDF2          10      LD  HL,ROMUSE1
00024E 424E 2269F3          16      LD  (ROMUSE+1),HL
                                
000251 4251 3E                      DB  03EH
000252 4252 F7              12      RST 30H
000253 4253 3271FE          13      LD  (H_BINS),A
000256 4256 3276FE          13      LD  (H_BINL),A
000259 4259 327BFE          13      LD  (H_FILE),A
00025C 425C 3231F3          13      LD  (H_BDOS),A
00025F 425F 32DBFD          13      LD  (H_PINL),A
000262 4262 32A7FF          13      LD  (H_PHYD),A
                                
000265 4265 CD5943          17      CALL    GTSL1_
000268 4268 3297F2          13      LD  (ROM_SLT),A
00026B 426B 32A7F2          13      LD  (ROM_SLT_COPY),A
00026E 426E 3272FE          13      LD  (H_BINS+1),A
000271 4271 3277FE          13      LD  (H_BINL+1),A
000274 4274 327CFE          13      LD  (H_FILE+1),A
000277 4277 3232F3          13      LD  (H_BDOS+1),A
00027A 427A 32DCFD          13      LD  (H_PINL+1),A
00027D 427D 32A8FF          13      LD  (H_PHYD+1),A
000280 4280 3222FB          13      LD  (DRVTBL+1),A
000283 4283 3248F3          13      LD  (MASTERS),A
                                
000286 4286 212146          10      LD  HL,ROM_LOAD
000289 4289 2273FE          16      LD  (H_BINS+2),HL
00028C 428C 21D547          10      LD  HL,ROM_RUN
00028F 428F 2278FE          16      LD  (H_BINL+2),HL
000292 4292 21E347          10      LD  HL,ROM_FILES
000295 4295 227DFE          16      LD  (H_FILE+2),HL
000298 4298 210754          10      LD  HL,ROM_BDOS
00029B 429B 2233F3          16      LD  (H_BDOS+2),HL
00029E 429E 21D044          10      LD  HL,ROM_BOOT
0002A1 42A1 22DDFD          16      LD  (H_PINL+2),HL
0002A4 42A4 21DB51          10      LD  HL,DISKIO
0002A7 42A7 22A9FF          16      LD  (H_PHYD+2),HL
                                
0002AA 42AA 3E                      DB  03EH
0002AB 42AB C9              10      RET
0002AC 42AC 327FFE          13      LD  (H_FILE+4),A
0002AF 42AF 3275FE          13      LD  (H_BINS+4),A
0002B2 42B2 327AFE          13      LD  (H_BINL+4),A
0002B5 42B5 3235F3          13      LD  (H_BDOS+4),A
0002B8 42B8 32DFFD          13      LD  (H_PINL+4),A
0002BB 42BB 32ABFF          13      LD  (H_PHYD+4),A
                                
0002BE 42BE AF               4      XOR A
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK0_SEL),A       ;似非RAM対策でバンク0を設定
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0002BF 42BF 320060          13      LD  (BANK0_SEL),A           ;似非RAM対策でバンク0を設定
0002C2 42C2 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0002C5 42C5 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0002C8 42C8 3A0060          13      LD  A,(BANK1_ADR)
0002CB 42CB FE41             7      CP  'A'
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JR  Z,NOT_BANK_TYPE
                                    LD  A,DISK_BANK
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0002CD 42CD 2079            12      JR  NZ,NOT_BANK_TYPE
0002CF 42CF 3E01             7      LD  A,DISK_BANK
0002D1 42D1 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0002D4 42D4 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0002D7 42D7 CD3801          17      CALL    RSLREG      ;read primary slot #
0002DA 42DA 07               4      RLCA
0002DB 42DB 07               4      RLCA
0002DC 42DC F5              11      PUSH    AF
0002DD 42DD 1605             7      LD  D,4+1
0002DF 42DF CD6043          17      CALL    GTSL2_
0002E2 42E2 3244F3          13      LD  (RAMAD3),A
0002E5 42E5 F1              10      POP AF
0002E6 42E6 07               4      RLCA
0002E7 42E7 07               4      RLCA
0002E8 42E8 1603             7      LD  D,2+1
0002EA 42EA CD6043          17      CALL    GTSL2_
0002ED 42ED 2680             7      LD  H,080H
0002EF 42EF CD7D43          17      CALL    CHK_RAM
0002F2 42F2 3243F3          13      LD  (RAMAD2),A
       42F5                     RAMCHK2:
0002F5 42F5 3A44F3          13      LD  A,(RAMAD3)
0002F8 42F8 2640             7      LD  H,040H
0002FA 42FA CD7D43          17      CALL    CHK_RAM
0002FD 42FD 3242F3          13      LD  (RAMAD1),A
       4300                     RAMCHK1:
000300 4300 3A44F3          13      LD  A,(RAMAD3)
000303 4303 2600             7      LD  H,00H
000305 4305 CD7D43          17      CALL    CHK_RAM
000308 4308 3241F3          13      LD  (RAMAD0),A
       430B                     RAMCHK0:
00030B 430B 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
00030E 430E 010F00          10      LD  BC,0000FH       ;切り上げ
000311 4311 09              11      ADD HL,BC
000312 4312 7D               4      LD  A,L
                                
000313 4313 0604             7      LD  B,4
       4315                     B_DRIVE1:
000315 4315 CB3C             8      SRL H
000317 4317 1F               4      RRA
000318 4318 10FB            13      DJNZ    B_DRIVE1
                                
00031A 431A C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
00031C 431C 32E9F2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
                                    ;拡張スロットの選択を設定する
00031F 431F 3A97F2          13      LD  A,(ROM_SLT)
000322 4322 57               4      LD  D,A
000323 4323 E60C             7      AND 00CH
000325 4325 5F               4      LD  E,A
000326 4326 7A               4      LD  A,D
000327 4327 E603             7      AND 3
000329 4329 87               4      ADD A,A
00032A 432A 87               4      ADD A,A
00032B 432B 87               4      ADD A,A
00032C 432C 37               4      SCF
00032D 432D 8F               4      ADC A,A
00032E 432E B3               4      OR  E
00032F 432F 5F               4      LD  E,A
000330 4330 1600             7      LD  D,0
000332 4332 21C9FC          10      LD  HL,SLTATR
000335 4335 19              11      ADD HL,DE
000336 4336 3660            10      LD  (HL),060H
                                    ;CTRL+STOPを抑制する
000338 4338 3E01             7      LD  A,1
00033A 433A 32B1FB          13      LD  (BASROM),A
                                    ;BASICを起動する
00033D 433D FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000341 4341 DD21177D        14      LD  IX,ST_BAS   ;continue start of MSX-BASIC without executing BASIC programs in ROM
000345 4345 C35901          10      JP  CALBAS
                                
       4348                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
000348 4348 21C040          10      LD  HL,MSG_ERROR_ROM_MODE
00034B 434B CD9844          17      CALL    MSX
00034E 434E FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000352 4352 DD219F00        14      LD  IX,CHGET
000356 4356 C31C00          10      JP  _CALSLT
                                
       4359                     GTSL1_:             ;自分のいるスロットを知る
000359 4359 CD3801          17      CALL    RSLREG      ;read primary slot #
00035C 435C 0F               4      RRCA
00035D 435D 0F               4      RRCA
00035E 435E 1601             7      LD  D,1
       4360                     GTSL2_:
000360 4360 E603             7      AND 3       ;[A]=000000PP
000362 4362 5F               4      LD  E,A     ;[E]=000000PP
000363 4363 21C1FC          10      LD  HL,EXPTBL
000366 4366 85               4      ADD A,L     ;桁上りは無い
000367 4367 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000368 4368 7B               4      LD  A,E     ;[A]=000000PP
000369 4369 CB7E            13      BIT 7,(HL)
00036B 436B C8              11      RET Z
00036C 436C 7D               4      LD  A,L     ;point to SLTTBL entry
00036D 436D C604             7      ADD A,4     ;桁上りは無い
00036F 436F 6F               4      LD  L,A
000370 4370 7E               7      LD  A,(HL)      ;get currently expansion slot register
       4371                     GTSL3_:
000371 4371 15               4      DEC D
000372 4372 2803            12      JR  Z,GTSL4_:
000374 4374 0F               4      RRCA
000375 4375 18FA            12      JR  GTSL3_:
       4377                     GTSL4_:
000377 4377 E60C             7      AND 00CH        ;[A] = 0000SS00
000379 4379 B3               4      OR  E       ;[A] = 0000SSPP
00037A 437A F680             7      OR  080H        ;[A] = 1000SSPP
00037C 437C C9              10      RET
                                
       437D                     CHK_RAM:
00037D 437D E5              11      PUSH    HL
00037E 437E CDD243          17      CALL    CHK_RAM0
000381 4381 E1              10      POP HL
000382 4382 C8              11      RET Z
000383 4383 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000386 4386 E680             7      AND 080H
000388 4388 CDA943          17      CALL    CHK_RAM_SLT
00038B 438B C8              11      RET Z
00038C 438C 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
00038F 438F E680             7      AND 080H
000391 4391 C601             7      ADD A,1
000393 4393 CDA943          17      CALL    CHK_RAM_SLT
000396 4396 C8              11      RET Z
000397 4397 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00039A 439A E680             7      AND 080H
00039C 439C C602             7      ADD A,2
00039E 439E CDA943          17      CALL    CHK_RAM_SLT
0003A1 43A1 C8              11      RET Z
0003A2 43A2 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
0003A5 43A5 E680             7      AND 080H
0003A7 43A7 C603             7      ADD A,3
       43A9                     CHK_RAM_SLT:
0003A9 43A9 E5              11      PUSH    HL
0003AA 43AA CDD243          17      CALL    CHK_RAM0        ;スロット#X or X-0
0003AD 43AD E1              10      POP HL
0003AE 43AE C8              11      RET Z
0003AF 43AF CB79             8      BIT 7,C
0003B1 43B1 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
0003B3 43B3 79               4      LD  A,C
0003B4 43B4 C604             7      ADD A,4*1           ;スロット#X-1
0003B6 43B6 E5              11      PUSH    HL
0003B7 43B7 CDD243          17      CALL    CHK_RAM0
0003BA 43BA E1              10      POP HL
0003BB 43BB C8              11      RET Z
0003BC 43BC 79               4      LD  A,C
0003BD 43BD C608             7      ADD A,4*2           ;スロット#X-2
0003BF 43BF E5              11      PUSH    HL
0003C0 43C0 CDD243          17      CALL    CHK_RAM0
0003C3 43C3 E1              10      POP HL
0003C4 43C4 C8              11      RET Z
0003C5 43C5 79               4      LD  A,C
0003C6 43C6 C60C             7      ADD A,4*3           ;スロット#X-3
0003C8 43C8 E5              11      PUSH    HL
0003C9 43C9 CDD243          17      CALL    CHK_RAM0
0003CC 43CC E1              10      POP HL
       43CD                     CHK_RAM_E:
0003CD 43CD AF               4      XOR A
0003CE 43CE 3C               4      INC A           ;ZF=0にする
0003CF 43CF 3E00             7      LD  A,0
0003D1 43D1 C9              10      RET
                                
       43D2                     CHK_RAM0:
0003D2 43D2 4F               4      LD  C,A
0003D3 43D3 3A97F2          13      LD  A,(ROM_SLT)
0003D6 43D6 B9               4      CP  C
0003D7 43D7 28F4            12      JR  Z,CHK_RAM_E
0003D9 43D9 2E00             7      LD  L,0
       43DB                     CHK_RAM1:
0003DB 43DB 79               4      LD  A,C
0003DC 43DC CDC844          17      CALL    RDSLTX
0003DF 43DF C6E5             7      ADD A,0E5H
0003E1 43E1 47               4      LD  B,A
0003E2 43E2 5F               4      LD  E,A
0003E3 43E3 79               4      LD  A,C
0003E4 43E4 C5              11      PUSH    BC
0003E5 43E5 CD1400          17      CALL    _WRSLT
0003E8 43E8 C1              10      POP BC
0003E9 43E9 79               4      LD  A,C
0003EA 43EA CDC844          17      CALL    RDSLTX
0003ED 43ED B8               4      CP  B
0003EE 43EE C0              11      RET NZ
0003EF 43EF D6E5             7      SUB 0E5H
0003F1 43F1 79               4      LD  A,C
0003F2 43F2 5F               4      LD  E,A
0003F3 43F3 C5              11      PUSH    BC
0003F4 43F4 CD1400          17      CALL    _WRSLT
0003F7 43F7 C1              10      POP BC
0003F8 43F8 24               4      INC H
0003F9 43F9 7D               4      LD  A,L
0003FA 43FA C604             7      ADD A,4
0003FC 43FC 6F               4      LD  L,A
0003FD 43FD 20DC            12      JR  NZ,CHK_RAM1
0003FF 43FF 79               4      LD  A,C     ;ZF=1のハズ
000400 4400 C9              10      RET
                                
       4401                     CALSLT_R:
000401 4401 C5              11      PUSH    BC
000402 4402 E5              11      PUSH    HL
000403 4403 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000407 4407 CD1C00          17      CALL    _CALSLT
00040A 440A E1              10      POP HL
00040B 440B C1              10      POP BC
00040C 440C C9              10      RET
                                
       440D                     AT_ISC:
00040D F280                         ORG ISC,AT_ISC-RUN
       F280                     REPLACE_COMMAND:
00040D F280 FEB7             7      CP  0B7H            ;FILES
00040F F282 CC7BFE          17      CALL    Z,H_FILE
000412 F285 FEB5             7      CP  0B5H            ;LOAD
000414 F287 CA71FE          10      JP  Z,H_BINS
000417 F28A FE8A             7      CP  08AH            ;RUN
000419 F28C CA76FE          10      JP  Z,H_BINL
00041C F28F FED6             7      CP  0D6H            ;COPY
00041E F291 2813            12      JR  Z,FIX_COPY
000420 F293 FECF             7      CP  0CFH            ;BLOAD
000422 F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
000423 F296 F7              12      RST 30H
       F297                     ROM_SLT:
000424 F297 00                      DB  0
000425 F298 0347                    DW  ROM_BLOAD
000427 F29A F5              11      PUSH    AF
000428 F29B E5              11      PUSH    HL
000429 F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
00042C F29F E1              10      POP HL
00042D F2A0 F1              10      POP AF
00042E F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
000430 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
000432 F2A5 C9              10      RET
       F2A6                     FIX_COPY:
000433 F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
000434 F2A7 00                      DB  0
000435 F2A8 8148                    DW  ROM_COPY
000437 F2AA C9              10      RET
       F2AB                     RAMUSE1:
000438 F2AB 3A42F3          13      LD  A,(RAMAD1)
00043B F2AE 1810            12      JR  ENASLT2
       F2B0                     CAL_MP:
00043D F2B0 2640             7      LD  H,040H
00043F F2B2 3AC1FC          13      LD  A,(EXPTBL)
000442 F2B5 CD2400          17      CALL    _ENASLT
000445 F2B8 CD1C00          17      CALL    _CALSLT
000448 F2BB 2640             7      LD  H,040H
       F2BD                     ROMUSE1:
00044A F2BD 3A97F2          13      LD  A,(ROM_SLT)
       F2C0                     ENASLT2:
00044D F2C0 C32400          10      JP  _ENASLT
                                
       F2C3                     _RESULT:
000450 F2C3 00                      DB  0
       F2C4                     _BANK:
000451 F2C4 00                      DB  0
       F2C5                     _BANK1:
000452 F2C5 00                      DB  0
       F2C6                     CLSZ:               ;クラスタサイズ
000453 F2C6 0004                    DW  1024
       F2C7                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2C8                     SECSZ:              ;セクタサイズ
000455 F2C8 0002                    DW  512
       F2C9                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2CA                     RR_LOW:
000457 F2CA 0000                    DW  0
       F2CB                     RR_MID  EQU $-1
       F2CC                     RR_HIGH:
000459 F2CC 0000                    DW  0
       F2CE                     _CLPS:
00045B F2CE 0000                    DW  0
       F2D0                     _LEFT:
00045D F2D0 0000                    DW  0
       F2D2                     _DTPS:
00045F F2D2 0000                    DW  0
       F2D4                     _DTA:
000461 F2D4 0000                    DW  0
       F2D6                     FLG_LDIR:
000463 F2D6 00                      DB  0
       F2D7                     _FCB:
000464 F2D7 0000                    DW  0
       F2D9                     _BUF:
       F2D9                     _BUF_LO:        ;LOGICAL OPERATION
000466 F2D9 00                      DB  0
       F2DA                     _BUF_ST:
000467 F2DA 0000                    DW  0
       F2DC                     _BUF_EN:
000469 F2DC 0000                    DW  0
       F2DE                     _BUF_EX:
       F2DE                     _BUF_W:
00046B F2DE 0000                    DW  0
       F2E0                     _BUF_H:
00046D F2E0 0000                    DW  0
       F2E2                     _BUF_X:
00046F F2E2 0000                    DW  0
       F2E4                     _BUF_Y:
000471 F2E4 00                      DB  0
       F2E5                     _BUF_P:
000472 F2E5 00                      DB  0
       F2E6                     _BUF_O:
000473 F2E6 00                      DB  0
       F2E7                     DTAX:
000474 F2E7 0000                    DW  0
       F2E9                     B_DRIVE:
000476 F2E9 00                      DB  0
       F2EA                     _DVSW:          ;カレントドライブ
000477 F2EA 00                      DB  0
       F2EB                     _CD:            ;カレントディレクトリ
000478 F2EB 0000                    DW  0
       F2ED                     DIRENT1:
00047A F2ED 0000                    DW  0
       F2EF                     _DIR_BANK:
00047C F2EF 00                      DB  0
       F2F0                     LEFTX:
00047D F2F0 0000                    DW  0
       F2F2                     PARAM0:
00047F F2F2 0000                    DW  0
       F2F4                     PARAM1:
000481 F2F4 0000                    DW  0
       F2F6                     _CDX:
000483 F2F6 0000                    DW  0
       F2F8                     FDRV:
000485 F2F8 00                      DB  0
       F2F9                     FNAME:
000486 F2F9                         DS  8+3
       F304                     _HL:
000491 F304 0000                    DW  0
       F306                     _SP:
000493 F306 0000                    DW  0
       F307                     _SP_H   EQU $-1
       F308                     ISC_E:
000495 4495                         ORG $$+RUN          ;$DEPHASE
                                
       4495                     MSX1:
000495 4495 CD2054          17      CALL    MSGA1
       4498                     MSX:
000498 4498 7E               7      LD  A,(HL)
000499 4499 23               6      INC HL
00049A 449A B7               4      OR  A
00049B 449B 20F8            12      JR  NZ,MSX1
00049D 449D C9              10      RET
                                
       449E                     PRTHX:
00049E 449E F5              11      PUSH    AF
00049F 449F 07               4      RLCA
0004A0 44A0 07               4      RLCA
0004A1 44A1 07               4      RLCA
0004A2 44A2 07               4      RLCA
0004A3 44A3 CDA744          17      CALL    PRTA2
0004A6 44A6 F1              10      POP AF
       44A7                     PRTA2:
0004A7 44A7 CDAD44          17      CALL    ASC
0004AA 44AA C31C54          10      JP  MSG_A
                                    
       44AD                     ASC:
0004AD 44AD E60F             7      AND $0F
0004AF 44AF F630             7      OR  $30
0004B1 44B1 FE3A             7      CP  $3A
0004B3 44B3 D8              11      RET C
0004B4 44B4 C607             7      ADD A,7
0004B6 44B6 C9              10      RET
                                
       44B7                     MSN:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
0004B7 44B7 7E               7      LD  A,(HL)
                                #endif
0004B8 44B8 23               6      INC HL
0004B9 44B9 CD1C54          17      CALL    MSG_A
0004BC 44BC 10F9            13      DJNZ    MSN
0004BE 44BE C9              10      RET
                                
       44BF                     RDSLT_ROM3:
0004BF 44BF 7E               7      LD  A,(HL)
0004C0 44C0 C9              10      RET
       44C1                     RDSLT_ROM:
0004C1 44C1 CB7C             8      BIT 7,H
0004C3 44C3 28FA            12      JR  Z,RDSLT_ROM3
       44C5                     RDSLT_ROM2:
0004C5 44C5 3A97F2          13      LD  A,(ROM_SLT)
       44C8                     RDSLTX:
0004C8 44C8 C5              11      PUSH    BC
0004C9 44C9 D5              11      PUSH    DE
0004CA 44CA CD0C00          17      CALL    _RDSLT
0004CD 44CD D1              10      POP DE
0004CE 44CE C1              10      POP BC
0004CF 44CF C9              10      RET
                                
       44D0                     ROM_BOOT:
0004D0 44D0 3E                      DB  03EH
0004D1 44D1 C9              10      RET
0004D2 44D2 32DBFD          13      LD  (H_PINL),A
0004D5 44D5 3ACAFF          13      LD  A,(EXTBIO)
0004D8 44D8 FEF7             7      CP  0F7H        ;RST 30H
0004DA 44DA 280A            12      JR  Z,EXTBIO_OK
0004DC 44DC 3E                      DB  03EH
0004DD 44DD C9              10      RET
0004DE 44DE 21CAFF          10      LD  HL,EXTBIO
0004E1 44E1 061D             7      LD  B,29
0004E3 44E3 CD214C          17      CALL    FILL_MEMORY
       44E6                     EXTBIO_OK:
0004E6 44E6 211345          10      LD  HL,DELOK
0004E9 44E9 CD9844          17      CALL    MSX
                                
0004EC 44EC AF               4      XOR A
0004ED 44ED 3240F3          13      LD  (REBOOT),A
0004F0 44F0 2A48FC          16      LD  HL,(BOTTOM)
0004F3 44F3 110040          10      LD  DE,16384
0004F6 44F6 19              11      ADD HL,DE
0004F7 44F7 3817            12      JR  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
0004F9 44F9 57               4      LD  D,A
0004FA 44FA 0601             7      LD  B,1
0004FC 44FC 2100C0          10      LD  HL,0C000H
0004FF 44FF CDDB51          17      CALL    DISKIO
                                
000502 4502 116BF3          10      LD  DE,RAMUSE
000505 4505 AF               4      XOR A
000506 4506 CD1EC0          17      CALL    0C01EH
000509 4509 116BF3          10      LD  DE,RAMUSE
00050C 450C 37               4      SCF
00050D 450D CD1EC0          17      CALL    0C01EH
       4510                     BOOT1:
000510 4510 C36653          10      JP  BASENT
                                
       4513                     DELOK:
000513 4513 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       4517                     ROM_LDIR:
000517 4517 3AD6F2          13      LD  A,(FLG_LDIR)
00051A 451A B7               4      OR  A
00051B 451B 2008            12      JR  NZ,ROM_LDIRVM
00051D 451D CB7A             8      BIT 7,D
00051F 451F CA3745          10      JP  Z,ROM_LDIRSLT
                                #if exists USE_MORMAL32K_OR_ASCII16
                                LDIRA:
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ1
                                    LD  SP,SP32
                                SPJ1:
                                LDIR1:
                                    LD  A,B
                                    OR  C
                                    JR  Z,LDIRE
                                
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                LDIR2:
                                    LD  A,D
                                    CP  0C0H
                                    JR  NC,LDIR4
                                
                                    PUSH    BC
                                    PUSH    DE
                                    LD  DE,BUF
                                
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIR3
                                    LD  BC,00100H
                                LDIR3:
                                    PUSH    BC
                                    LDIR
                                    LD  (_HL),HL
                                
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                
                                    POP BC
                                    POP DE
                                    LD  HL,BUF
                                    LDIR
                                
                                    LD  HL,(_HL)
                                    POP BC
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIRE
                                    DEC B
                                    JR  LDIR1
                                LDIR4:
                                #endif
000522 4522 EDB0                    LDIR
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                LDIRE2:
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                LDIRE:
                                    LD  SP,(_SP)
                                #endif
000524 4524 C9              10      RET
                                
       4525                     ROM_LDIRVM:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ2
                                    LD  SP,SP32
                                SPJ2:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
000525 4525 C5              11      PUSH    BC
000526 4526 D5              11      PUSH    DE
000527 4527 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00052B 452B DD215C00        14      LD  IX,LDIRVM
00052F 452F CD1C00          17      CALL    _CALSLT
000532 4532 E1              10      POP HL
000533 4533 C1              10      POP BC
000534 4534 09              11      ADD HL,BC
000535 4535 EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JR  LDIRE2
                                #else
000536 4536 C9              10      RET
                                #endif
                                
       4537                     ROM_LDIRSLT:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ3
                                    LD  SP,SP32
                                SPJ3:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
       4537                     ROM_LDIRSLT1:
000537 4537 EB               4      EX  DE,HL
       4538                     RLDIRSLT1:
000538 4538 CB7C             8      BIT 7,H
00053A 453A 201F            12      JR  NZ,RLDIRSLT_EXIT
00053C 453C 1A               7      LD  A,(DE)
00053D 453D 13               6      INC DE
00053E 453E C5              11      PUSH    BC
00053F 453F D5              11      PUSH    DE
000540 4540 E5              11      PUSH    HL
000541 4541 5F               4      LD  E,A
                                
000542 4542 0141F3          10      LD  BC,RAMAD0
000545 4545 7C               4      LD  A,H
000546 4546 07               4      RLCA
000547 4547 07               4      RLCA
000548 4548 E603             7      AND 3
00054A 454A 81               4      ADD A,C
00054B 454B 4F               4      LD  C,A
00054C 454C 0A               7      LD  A,(BC)
       454D                     RLDIRSLT2:
00054D 454D CD1400          17      CALL    _WRSLT
000550 4550 08               4      EX  AF,AF'
000551 4551 E1              10      POP HL
000552 4552 D1              10      POP DE
000553 4553 C1              10      POP BC
000554 4554 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
000556 4556 EA3845          10      JP  PE,RLDIRSLT1
000559 4559 EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JP  LDIRE2
                                RLDIRSLT_EXIT:
                                    EX  DE,HL
                                    JP  LDIR1
                                #else
00055A 455A C9              10      RET
       455B                     RLDIRSLT_EXIT:
00055B 455B EB               4      EX  DE,HL
00055C 455C EDB0                    LDIR
00055E 455E C9              10      RET
                                #endif
                                
       455F                     END_OF_LINE:
00055F 455F 215EF5          10      LD  HL,BUF
       4562                     EOL1:
000562 4562 7E               7      LD  A,(HL)
000563 4563 C8              11      RET Z
000564 4564 FE0D             7      CP  00DH
000566 4566 2807            12      JR  Z,EOLE
000568 4568 FE0A             7      CP  00AH
00056A 456A 2803            12      JR  Z,EOLE
00056C 456C 23               6      INC HL
00056D 456D 18F3            12      JR  EOL1
       456F                     EOLE:
00056F 456F 3600            10      LD  (HL),0
000571 4571 23               6      INC HL
000572 4572 7E               7      LD  A,(HL)
000573 4573 FE0A             7      CP  00AH
000575 4575 C0              11      RET NZ
000576 4576 23               6      INC HL
000577 4577 C9              10      RET
                                
       4578                     ROM_LOAD_ASCII:
000578 4578 210000          10      LD  HL,0
00057B 457B 22DAF2          16      LD  (_BUF_ST),HL    ;読み出し位置
00057E 457E 2A76F6          16      LD  HL,(TXTTAB)
000581 4581 22DCF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
000584 4584 215EF5          10      LD  HL,BUF
000587 4587 22D4F2          16      LD  (_DTA),HL
       458A                     RLOAD_A1:
00058A 458A 2ADAF2          16      LD  HL,(_BUF_ST)
00058D 458D 22CAF2          16      LD  (RR_LOW),HL
000590 4590 210201          10      LD  HL,258
000593 4593 CDA14A          17      CALL    ROM_READ
000596 4596 7C               4      LD  A,H
000597 4597 B5               4      OR  L
000598 4598 2879            12      JR  Z,RLOAD_AEND
00059A 459A 015EF5          10      LD  BC,BUF
00059D 459D 09              11      ADD HL,BC
00059E 459E 3600            10      LD  (HL),0
0005A0 45A0 CD5F45          17      CALL    END_OF_LINE
0005A3 45A3 015EF5          10      LD  BC,BUF
0005A6 45A6 A7               4      AND A
0005A7 45A7 ED42            15      SBC HL,BC
0005A9 45A9 2810            12      JR  Z,RLOAD_A2
0005AB 45AB 4D               4      LD  C,L
0005AC 45AC 44               4      LD  B,H
0005AD 45AD ED5BDAF2        20      LD  DE,(_BUF_ST)
0005B1 45B1 19              11      ADD HL,DE
0005B2 45B2 22DAF2          16      LD  (_BUF_ST),HL
0005B5 45B5 3A5EF5          13      LD  A,(BUF)
0005B8 45B8 B7               4      OR  A
0005B9 45B9 28CF            12      JR  Z,RLOAD_A1
       45BB                     RLOAD_A2:
0005BB 45BB 115EF5          10      LD  DE,BUF
0005BE 45BE CD584C          17      CALL    SPCUTEX
0005C1 45C1 1A               7      LD  A,(DE)
0005C2 45C2 B7               4      OR  A
0005C3 45C3 284E            12      JR  Z,RLOAD_AEND
0005C5 45C5 CD6A4C          17      CALL    GETNUM
0005C8 45C8 7C               4      LD  A,H
0005C9 45C9 B5               4      OR  L
0005CA 45CA CAEA46          10      JP  Z,ERROR_DIRECT_IN_FILE
0005CD 45CD DD2ADCF2        20      LD  IX,(_BUF_EN)
0005D1 45D1 DD7502          19      LD  (IX+2),L
0005D4 45D4 DD7403          19      LD  (IX+3),H
                                
0005D7 45D7 CD514C          17      CALL    SPCUT
0005DA 45DA EB               4      EX  DE,HL
0005DB 45DB DDE5            15      PUSH    IX
0005DD 45DD DD21B242        14      LD  IX,CRUNCH
0005E1 45E1 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0005E5 45E5 CD1C00          17      CALL    _CALSLT
0005E8 45E8 DDE1            14      POP IX
0005EA 45EA EB               4      EX  DE,HL
0005EB 45EB 111FF4          10      LD  DE,KBUF
0005EE 45EE 37               4      SCF
0005EF 45EF ED52            15      SBC HL,DE
0005F1 45F1 CAEA46          10      JP  Z,ERROR_DIRECT_IN_FILE
0005F4 45F4 DAEA46          10      JP  C,ERROR_DIRECT_IN_FILE
0005F7 45F7 4D               4      LD  C,L
0005F8 45F8 44               4      LD  B,H
0005F9 45F9 2ADCF2          16      LD  HL,(_BUF_EN)
0005FC 45FC 110400          10      LD  DE,4
0005FF 45FF 19              11      ADD HL,DE
000600 4600 111FF4          10      LD  DE,KBUF
                                
000603 4603 EB               4      EX  DE,HL
000604 4604 EDB0                    LDIR
000606 4606 EB               4      EX  DE,HL
                                
000607 4607 DD7500          19      LD  (IX+0),L
00060A 460A DD7401          19      LD  (IX+1),H
00060D 460D 22DCF2          16      LD  (_BUF_EN),HL
000610 4610 C38A45          10      JP  RLOAD_A1
                                
       4613                     RLOAD_AEND:
000613 4613 2ADCF2          16      LD  HL,(_BUF_EN)
000616 4616 AF               4      XOR A
000617 4617 77               7      LD  (HL),A
000618 4618 23               6      INC HL
000619 4619 77               7      LD  (HL),A
00061A 461A 23               6      INC HL
00061B 461B 22DCF2          16      LD  (_BUF_EN),HL
00061E 461E C3AD46          10      JP  RLOAD_END1
                                
       4621                     ROM_LOAD:
000621 4621 CD4F48          17      CALL    INIT_PARAM
000624 4624 7E               7      LD  A,(HL)
000625 4625 FE2C             7      CP  ','
000627 4627 2003            12      JR  NZ,ROM_LOAD0
000629 4629 23               6      INC HL
00062A 462A 7E               7      LD  A,(HL)
00062B 462B 2B               6      DEC HL
       462C                     ROM_LOAD0:
00062C 462C 32BEFC          13      LD  (RUNBNF),A
00062F 462F CD424B          17      CALL    FILE_B
000632 4632 3AF9F2          13      LD  A,(FNAME)
000635 4635 FE20             7      CP  020H
000637 4637 CA3D4B          10      JP  Z,ROM_ORG
                                
00063A 463A CDC14C          17      CALL    ROM_OPEN
00063D 463D DAF646          10      JP  C,ERROR_FILE_NOT_FOUND
       4640                     ROM_LOAD1:
000640 4640 21D9F2          10      LD  HL,_BUF
000643 4643 22D4F2          16      LD  (_DTA),HL
000646 4646 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
000649 4649 CDA14A          17      CALL    ROM_READ
00064C 464C 3AD9F2          13      LD  A,(_BUF)
00064F 464F 3C               4      INC A
000650 4650 C27845          10      JP  NZ,ROM_LOAD_ASCII
000653 4653 2A76F6          16      LD  HL,(TXTTAB)
000656 4656 22D4F2          16      LD  (_DTA),HL
000659 4659 EB               4      EX  DE,HL
00065A 465A 2100FF          10      LD  HL,-256
00065D 465D 39              11      ADD HL,SP
00065E 465E ED52            15      SBC HL,DE
000660 4660 CDA14A          17      CALL    ROM_READ
000663 4663 ED5BD4F2        20      LD  DE,(_DTA)
000667 4667 19              11      ADD HL,DE
000668 4668 E5              11      PUSH    HL
000669 4669 2A76F6          16      LD  HL,(TXTTAB)
       466C                     ROM_LOAD2:          ;リンクポインタをFIX
00066C 466C E5              11      PUSH    HL
00066D 466D DDE1            14      POP IX
00066F 466F 7E               7      LD  A,(HL)      ;リンクポインタL
000670 4670 23               6      INC HL
000671 4671 B6               7      OR  (HL)        ;リンクポインタH
000672 4672 23               6      INC HL
000673 4673 2837            12      JR  Z,RLOAD_END0
000675 4675 23               6      INC HL      ;行番号
000676 4676 23               6      INC HL      ;行番号
       4677                     ROM_LOAD3:
000677 4677 7E               7      LD  A,(HL)
000678 4678 23               6      INC HL
000679 4679 FE0B             7      CP  00BH        ;8進数(&O)
00067B 467B 2822            12      JR  Z,INC_HL2
00067D 467D FE0C             7      CP  00CH        ;16進数(&H)
00067F 467F 281E            12      JR  Z,INC_HL2
000681 4681 FE0D             7      CP  00DH        ;行番号(RUN後)
000683 4683 281A            12      JR  Z,INC_HL2
000685 4685 FE0E             7      CP  00EH        ;行番号(RUN前)
000687 4687 2816            12      JR  Z,INC_HL2
000689 4689 FE0F             7      CP  00FH        ;10～255の整数(%)
00068B 468B 2813            12      JR  Z,INC_HL1
00068D 468D FE1C             7      CP  01CH        ;256～65535の整数(%)
00068F 468F 280E            12      JR  Z,INC_HL2
000691 4691 FE1D             7      CP  01DH        ;単精度実数(!)
000693 4693 2808            12      JR  Z,INC_HL4
000695 4695 FE1F             7      CP  01FH        ;倍制度実数(#)
000697 4697 2008            12      JR  NZ,INC_HL0
000699 4699 23               6      INC HL
00069A 469A 23               6      INC HL
00069B 469B 23               6      INC HL
00069C 469C 23               6      INC HL
       469D                     INC_HL4:
00069D 469D 23               6      INC HL
00069E 469E 23               6      INC HL
       469F                     INC_HL2:
00069F 469F 23               6      INC HL
       46A0                     INC_HL1:
0006A0 46A0 23               6      INC HL
       46A1                     INC_HL0:
0006A1 46A1 B7               4      OR  A
0006A2 46A2 20D3            12      JR  NZ,ROM_LOAD3
0006A4 46A4 DD7500          19      LD  (IX+0),L
0006A7 46A7 DD7401          19      LD  (IX+1),H
0006AA 46AA 18C0            12      JR  ROM_LOAD2
       46AC                     RLOAD_END0:
0006AC 46AC E1              10      POP HL
       46AD                     RLOAD_END1:
0006AD 46AD 22C2F6          16      LD  (VARTAB),HL
0006B0 46B0 22C4F6          16      LD  (ARYTAB),HL
0006B3 46B3 22C6F6          16      LD  (STREND),HL
                                
0006B6 46B6 3ABEFC          13      LD  A,(RUNBNF)
0006B9 46B9 CDAB4C          17      CALL    CAP
0006BC 46BC FE52             7      CP  'R'
0006BE 46BE 280E            12      JR  Z,RLOAD_END2
0006C0 46C0 AF               4      XOR A
0006C1 46C1 21DCF2          10      LD  HL,_BUF+3
0006C4 46C4 77               7      LD  (HL),A      ;3
0006C5 46C5 2B               6      DEC HL
0006C6 46C6 77               7      LD  (HL),A      ;2
0006C7 46C7 2B               6      DEC HL
0006C8 46C8 77               7      LD  (HL),A      ;1
0006C9 46C9 2B               6      DEC HL
0006CA 46CA 3E8F             7      LD  A,08FH      ;REM
0006CC 46CC 77               7      LD  (HL),A      ;0
0006CD 46CD C9              10      RET
       46CE                     RLOAD_END2:
0006CE 46CE D5              11      PUSH    DE
0006CF 46CF ED5B76F6        20      LD  DE,(TXTTAB)
0006D3 46D3 1B               6      DEC DE
0006D4 46D4 AF               4      XOR A
0006D5 46D5 21DFF2          10      LD  HL,_BUF+6
0006D8 46D8 77               7      LD  (HL),A      ;6
0006D9 46D9 2B               6      DEC HL
0006DA 46DA 77               7      LD  (HL),A      ;5
0006DB 46DB 2B               6      DEC HL
0006DC 46DC 77               7      LD  (HL),A      ;4
0006DD 46DD 2B               6      DEC HL
0006DE 46DE 72               7      LD  (HL),D      ;3 行番号H
0006DF 46DF 2B               6      DEC HL
0006E0 46E0 73               7      LD  (HL),E      ;2 行番号L
0006E1 46E1 2B               6      DEC HL
0006E2 46E2 360D            10      LD  (HL),00DH   ;1 行番号(RUN後)
0006E4 46E4 2B               6      DEC HL
0006E5 46E5 3E89             7      LD  A,089H      ;GOTO
0006E7 46E7 77               7      LD  (HL),A      ;0
0006E8 46E8 D1              10      POP DE
0006E9 46E9 C9              10      RET
                                
       46EA                     ERROR_DIRECT_IN_FILE:
0006EA 46EA 1E39             7      LD  E,57            ;Direct statement in file
0006EC 46EC 01                      DB  1           ;LD BC,
       46ED                     ERROR_DEVICE_IO_ERROR:
0006ED 46ED 1E13             7      LD  E,19            ;Device I/O error
0006EF 46EF 01                      DB  1           ;LD BC,
       46F0                     ERROR_INTERNAL_ERROR:
0006F0 46F0 1E33             7      LD  E,51            ;Internal error
0006F2 46F2 01                      DB  1           ;LD BC,
       46F3                     ERROR_FILE_NOT_OPEN:
0006F3 46F3 1E3B             7      LD  E,59            ;File not OPEN
0006F5 46F5 01                      DB  1           ;LD BC,
       46F6                     ERROR_FILE_NOT_FOUND:
0006F6 46F6 1E35             7      LD  E,53            ;File not found
       46F8                     ERROR:
0006F8 46F8 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0006FC 46FC DD216F40        14      LD  IX,ERRHAND
000700 4700 C31C00          10      JP  _CALSLT
                                
       4703                     ROM_BLOAD:
000703 4703 CD4F48          17      CALL    INIT_PARAM
000706 4706 CD424B          17      CALL    FILE_B
000709 4709 CDC14C          17      CALL    ROM_OPEN
00070C 470C 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
00070E 470E 21D9F2          10      LD  HL,_BUF
000711 4711 22D4F2          16      LD  (_DTA),HL
000714 4714 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
000717 4717 CDA14A          17      CALL    ROM_READ
00071A 471A 3AD9F2          13      LD  A,(_BUF)
00071D 471D FEFE             7      CP  0FEH
00071F 471F 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
000721 4721 21A5F2          10      LD  HL,BLOAD_RET
000724 4724 229DF2          16      LD  (SWC_BLOAD),HL
                                
000727 4727 2AF4F2          16      LD  HL,(PARAM1)
00072A 472A 7E               7      LD  A,(HL)
00072B 472B FE2C             7      CP  ','
00072D 472D 204C            12      JR  NZ,RBREAD_MEM
00072F 472F 23               6      INC HL
000730 4730 7E               7      LD  A,(HL)
000731 4731 CDAB4C          17      CALL    CAP
000734 4734 32BEFC          13      LD  (RUNBNF),A
000737 4737 FE52             7      CP  'R'     ;R,Sスイッチじゃ無い場合はオフセット値として処理する
000739 4739 2808            12      JR  Z,RBOS1
00073B 473B FE53             7      CP  'S'
00073D 473D 2804            12      JR  Z,RBOS1
00073F 473F FE2C             7      CP  ','
000741 4741 200D            12      JR  NZ,RBOS2
       4743                     RBOS1:
000743 4743 7E               7      LD  A,(HL)
000744 4744 23               6      INC HL
000745 4745 B7               4      OR  A
000746 4746 2824            12      JR  Z,RBREAD_OSE
000748 4748 FE3A             7      CP  ':'
00074A 474A 2820            12      JR  Z,RBREAD_OSE
00074C 474C FE2C             7      CP  ','     ;次のパラメータを探す
00074E 474E 20F3            12      JR  NZ,RBOS1
       4750                     RBOS2:              ;オフセット
000750 4750 22F4F2          16      LD  (PARAM1),HL
000753 4753 7E               7      LD  A,(HL)
000754 4754 B7               4      OR  A
000755 4755 2815            12      JR  Z,RBREAD_OSE
000757 4757 DD212F54        14      LD  IX,FRMQNT
00075B 475B FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00075F 475F CD1C00          17      CALL    _CALSLT
000762 4762 22F4F2          16      LD  (PARAM1),HL
000765 4765 2ADAF2          16      LD  HL,(_BUF_ST)
000768 4768 19              11      ADD HL,DE
000769 4769 22DAF2          16      LD  (_BUF_ST),HL
       476C                     RBREAD_OSE:
00076C 476C 3ABEFC          13      LD  A,(RUNBNF)
00076F 476F FE53             7      CP  'S'
000771 4771 2008            12      JR  NZ,RBREAD_MEM
000773 4773 CD2F4A          17      CALL    WAIT_VDP
000776 4776 3E01             7      LD  A,1
000778 4778 32D6F2          13      LD  (FLG_LDIR),A
       477B                     RBREAD_MEM:
00077B 477B 2ADAF2          16      LD  HL,(_BUF_ST)
00077E 477E 22BFFC          16      LD  (SAVENT),HL
000781 4781 22D4F2          16      LD  (_DTA),HL
000784 4784 21FFFF          10      LD  HL,0FFFFH
000787 4787 CDA14A          17      CALL    ROM_READ
00078A 478A AF               4      XOR A
00078B 478B 32D6F2          13      LD  (FLG_LDIR),A
00078E 478E 3ABEFC          13      LD  A,(RUNBNF)
000791 4791 FE52             7      CP  'R'
000793 4793 2006            12      JR  NZ,RBREAD1
000795 4795 2ADEF2          16      LD  HL,(_BUF_EX)
000798 4798 229DF2          16      LD  (SWC_BLOAD),HL
       479B                     RBREAD1:
       479B                     ROM_NEXT:
00079B 479B 2AF4F2          16      LD  HL,(PARAM1)
00079E 479E 7E               7      LD  A,(HL)
00079F 479F 2B               6      DEC HL
0007A0 47A0 B7               4      OR  A
0007A1 47A1 2805            12      JR  Z,ROM_NEXT1
0007A3 47A3 FE3A             7      CP  ':'
0007A5 47A5 2801            12      JR  Z,ROM_NEXT1
0007A7 47A7 23               6      INC HL
       47A8                     ROM_NEXT1:
0007A8 47A8 5D               4      LD  E,L
0007A9 47A9 54               4      LD  D,H
                                
0007AA 47AA CD814C          17      CALL    SEARCH_END
0007AD 47AD B7               4      OR  A
0007AE 47AE 2821            12      JR  Z,REM
       47B0                     RN3:                    ;マルチステートメントの処理
0007B0 47B0 7E               7      LD  A,(HL)
                                
0007B1 47B1 FEB5             7      CP  0B5H            ;LOAD
0007B3 47B3 CA2146          10      JP  Z,ROM_LOAD
0007B6 47B6 FE8A             7      CP  08AH            ;RUN
0007B8 47B8 281B            12      JR  Z,ROM_RUN
0007BA 47BA FEB7             7      CP  0B7H            ;FILES
0007BC 47BC 2825            12      JR  Z,ROM_FILES
0007BE 47BE FED6             7      CP  0D6H            ;COPY
0007C0 47C0 CA8148          10      JP  Z,ROM_COPY
0007C3 47C3 FE20             7      CP  020H
0007C5 47C5 2807            12      JR  Z,RN_SP
                                
0007C7 47C7 3E28             7      LD  A,028H          ;JR Z,
0007C9 47C9 32A3F2          13      LD  (SWC_BLOAD_M),A
0007CC 47CC 7E               7      LD  A,(HL)
0007CD 47CD C9              10      RET
       47CE                     RN_SP:
0007CE 47CE 23               6      INC HL
0007CF 47CF 18DF            12      JR  RN3
                                
       47D1                     REM:
0007D1 47D1 EB               4      EX  DE,HL
0007D2 47D2 3E8F             7      LD  A,08FH          ;REM
0007D4 47D4 C9              10      RET
                                
       47D5                     ROM_RUN:
0007D5 47D5 23               6      INC HL
0007D6 47D6 7E               7      LD  A,(HL)
0007D7 47D7 2B               6      DEC HL
0007D8 47D8 B7               4      OR  A
0007D9 47D9 C42146          17      CALL    NZ,ROM_LOAD
0007DC 47DC FE8F             7      CP  08FH            ;REM
0007DE 47DE 3E8A             7      LD  A,08AH          ;RUN
0007E0 47E0 C0              11      RET NZ
0007E1 47E1 77               7      LD  (HL),A
0007E2 47E2 C9              10      RET
                                
       47E3                     ROM_FILES:
0007E3 47E3 CD4F48          17      CALL    INIT_PARAM
0007E6 47E6 CD424B          17      CALL    FILE_B
0007E9 47E9 CDA353          17      CALL    GET_DISK_BANK_FDRV
0007EC 47EC 3AC9F2          13      LD  A,(SECSZ_H)
0007EF 47EF CD6152          17      CALL    IS_BPB1
0007F2 47F2 DAED46          10      JP  C,ERROR_DEVICE_IO_ERROR
0007F5 47F5 3AF9F2          13      LD  A,(FNAME)
0007F8 47F8 FE21             7      CP  021H
0007FA 47FA 3005            12      JR  NC,RFILES0
0007FC 47FC 060B             7      LD  B,11
0007FE 47FE CD154C          17      CALL    FILE10
       4801                     RFILES0:
000801 4801 CD1F4F          17      CALL    GET_DIR_DAT
       4804                     RFILES1:
000804 4804 CDDD4C          17      CALL    FILESE
000807 4807 3041            12      JR  NC,RFILES_NOT_MATCH
       4809                     RFILES_DISP:
000809 4809 E5              11      PUSH    HL
00080A 480A 110B00          10      LD  DE,0000BH   ;属性
00080D 480D 19              11      ADD HL,DE
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
00080E 480E 7E               7      LD  A,(HL)
                                #endif
00080F 480F E1              10      POP HL
000810 4810 CB4F             8      BIT 1,A     ;不可視属性
000812 4812 2033            12      JR  NZ,RFILES_NEXT
000814 4814 E5              11      PUSH    HL
000815 4815 0608             7      LD  B,8
000817 4817 CDB744          17      CALL    MSN
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
00081A 481A 7E               7      LD  A,(HL)
                                #endif
00081B 481B FE20             7      CP  020H
00081D 481D F5              11      PUSH    AF
00081E 481E 3E2E             7      LD  A,'.'
000820 4820 C41C54          17      CALL    NZ,MSG_A
000823 4823 0603             7      LD  B,3
000825 4825 CDB744          17      CALL    MSN
000828 4828 F1              10      POP AF
000829 4829 CC1C54          17      CALL    Z,MSG_A
00082C 482C 3ADDF3          13      LD  A,(CSRX)
00082F 482F 47               4      LD  B,A
000830 4830 3AB0F3          13      LD  A,(LINLEN)
000833 4833 90               4      SUB B
000834 4834 FE0C             7      CP  12
000836 4836 3009            12      JR  NC,RFILES2
000838 4838 3E0D             7      LD  A,00DH      ;改行
00083A 483A CD1C54          17      CALL    MSG_A
00083D 483D 3E0A             7      LD  A,00AH
00083F 483F 1802            12      JR  RFILES3
       4841                     RFILES2:
000841 4841 3E20             7      LD  A,020H
       4843                     RFILES3:
000843 4843 CD1C54          17      CALL    MSG_A
000846 4846 E1              10      POP HL
       4847                     RFILES_NEXT:
000847 4847 CDF94C          17      CALL    FNEXT
       484A                     RFILES_NOT_MATCH:
00084A 484A 20B8            12      JR  NZ,RFILES1
00084C 484C C39B47          10      JP  ROM_NEXT
                                
       484F                     INIT_PARAM:
00084F 484F 22F2F2          16      LD  (PARAM0),HL
000852 4852 22F4F2          16      LD  (PARAM1),HL
000855 4855 EB               4      EX  DE,HL
000856 4856 32BEFC          13      LD  (RUNBNF),A
000859 4859 3263F6          13      LD  (VALTYP),A
00085C 485C E5              11      PUSH    HL
00085D 485D 2AEBF2          16      LD  HL,(_CD)
000860 4860 22F6F2          16      LD  (_CDX),HL
000863 4863 E1              10      POP HL
000864 4864 13               6      INC DE
000865 4865 CD514C          17      CALL    SPCUT
000868 4868 1A               7      LD  A,(DE)
000869 4869 B7               4      OR  A
00086A 486A C8              11      RET Z
00086B 486B FE3A             7      CP  ':'
00086D 486D C8              11      RET Z
00086E 486E FE28             7      CP  '('
000870 4870 C8              11      RET Z
000871 4871 EB               4      EX  DE,HL
000872 4872 DD21644C        14      LD  IX,FRMEVL
000876 4876 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00087A 487A CD1C00          17      CALL    _CALSLT
00087D 487D 22F4F2          16      LD  (PARAM1),HL
000880 4880 C9              10      RET
                                
       4881                     ROM_COPY:
000881 4881 CD4F48          17      CALL    INIT_PARAM
000884 4884 3A63F6          13      LD  A,(VALTYP)
000887 4887 FE03             7      CP  3       ;string
000889 4889 C23D4B          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
00088C 488C CD424B          17      CALL    FILE_B
00088F 488F CDC14C          17      CALL    ROM_OPEN
000892 4892 DAF646          10      JP  C,ERROR_FILE_NOT_FOUND
                                
000895 4895 21DEF2          10      LD  HL,_BUF_W
000898 4898 22D4F2          16      LD  (_DTA),HL
00089B 489B 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
00089E 489E CDA14A          17      CALL    ROM_READ
                                
0008A1 48A1 AF               4      XOR A
0008A2 48A2 32D9F2          13      LD  (_BUF_LO),A     ;PSET
0008A5 48A5 32E6F2          13      LD  (_BUF_O),A      ;向き
                                
0008A8 48A8 2AF4F2          16      LD  HL,(PARAM1)
       48AB                     RCP_PARAM1:
0008AB 48AB 7E               7      LD  A,(HL)
0008AC 48AC 23               6      INC HL
0008AD 48AD B7               4      OR  A
0008AE 48AE CAA847          10      JP  Z,ROM_NEXT1
0008B1 48B1 FE3A             7      CP  ':'
0008B3 48B3 CAA847          10      JP  Z,ROM_NEXT1
0008B6 48B6 FE2C             7      CP  ','
0008B8 48B8 2012            12      JR  NZ,RCP_PARAM1_
                                
0008BA 48BA DD212F54        14      LD  IX,FRMQNT
0008BE 48BE FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0008C2 48C2 CD1C00          17      CALL    _CALSLT
0008C5 48C5 7B               4      LD  A,E
0008C6 48C6 87               4      ADD A,A
0008C7 48C7 87               4      ADD A,A
0008C8 48C8 32E6F2          13      LD  (_BUF_O),A
0008CB 48CB 7E               7      LD  A,(HL)
       48CC                     RCP_PARAM1_:
0008CC 48CC FE28             7      CP  '('
0008CE 48CE 20DB            12      JR  NZ,RCP_PARAM1
0008D0 48D0 DD212F54        14      LD  IX,FRMQNT
0008D4 48D4 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0008D8 48D8 CD1C00          17      CALL    _CALSLT
                                
0008DB 48DB ED53E2F2        20      LD  (_BUF_X),DE
                                
       48DF                     RCP_PARAM2:
0008DF 48DF 23               6      INC HL
0008E0 48E0 7E               7      LD  A,(HL)
0008E1 48E1 FE20             7      CP  020H
0008E3 48E3 28FA            12      JR  Z,RCP_PARAM2
0008E5 48E5 FE2C             7      CP  ','
0008E7 48E7 28F6            12      JR  Z,RCP_PARAM2
                                
0008E9 48E9 DD212F54        14      LD  IX,FRMQNT
0008ED 48ED FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0008F1 48F1 CD1C00          17      CALL    _CALSLT
                                
0008F4 48F4 3AF6FA          13      LD  A,(ACPAGE)
0008F7 48F7 57               4      LD  D,A
0008F8 48F8 ED53E4F2        20      LD  (_BUF_Y),DE
       48FC                     RCP_PARAM3:
0008FC 48FC 23               6      INC HL
0008FD 48FD 7E               7      LD  A,(HL)
0008FE 48FE FE20             7      CP  020H
000900 4900 28FA            12      JR  Z,RCP_PARAM3
000902 4902 FE29             7      CP  ')'
000904 4904 28F6            12      JR  Z,RCP_PARAM3
000906 4906 FE2C             7      CP  ','
000908 4908 2033            12      JR  NZ,RCP_ST
                                
00090A 490A 23               6      INC HL
00090B 490B DD212F54        14      LD  IX,FRMQNT
00090F 490F FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000913 4913 CD1C00          17      CALL    _CALSLT
                                
000916 4916 7B               4      LD  A,E
000917 4917 32E5F2          13      LD  (_BUF_P),A
                                
       491A                     RCP_PARAM4:
00091A 491A 7E               7      LD  A,(HL)
00091B 491B 23               6      INC HL
00091C 491C FE20             7      CP  020H
00091E 491E 28FA            12      JR  Z,RCP_PARAM4
                                
000920 4920 FE2C             7      CP  ','
000922 4922 2019            12      JR  NZ,RCP_ST
                                
000924 4924 7E               7      LD  A,(HL)
000925 4925 0604             7      LD  B,4
000927 4927 FEC3             7      CP  0C3H        ;PRESET
000929 4929 280E            12      JR  Z,RCP_LO
00092B 492B 05               4      DEC B       ;3
00092C 492C D6F8             7      SUB 0F8H        ;XOR
00092E 492E 2809            12      JR  Z,RCP_LO
000930 4930 05               4      DEC B       ;2
000931 4931 3C               4      INC A       ;OR
000932 4932 2805            12      JR  Z,RCP_LO
000934 4934 05               4      DEC B       ;1
000935 4935 3C               4      INC A       ;AND
000936 4936 2801            12      JR  Z,RCP_LO
000938 4938 05               4      DEC B       ;0
                                                ;PSET
       4939                     RCP_LO:
000939 4939 78               4      LD  A,B
00093A 493A 32D9F2          13      LD  (_BUF_LO),A
       493D                     RCP_ST:
00093D 493D 2AC6F6          16      LD  HL,(STREND)
000940 4940 22D4F2          16      LD  (_DTA),HL
000943 4943 EB               4      EX  DE,HL
000944 4944 2100FE          10      LD  HL,-512
000947 4947 39              11      ADD HL,SP
000948 4948 AF               4      XOR A
000949 4949 ED52            15      SBC HL,DE
00094B 494B 3008            12      JR  NC,RCP0
00094D 494D 215EF5          10      LD  HL,BUF
000950 4950 22D4F2          16      LD  (_DTA),HL
000953 4953 6F               4      LD  L,A ;0
000954 4954 67               4      LD  H,A ;0
       4955                     RCP0:
000955 4955 24               4      INC H
000956 4956 22DCF2          16      LD  (_BUF_EN),HL
       4959                     RCP1:
000959 4959 F3               4      DI
00095A 495A CD2F4A          17      CALL    WAIT_VDP
                                
00095D 495D 3A0700          13      LD  A,(WRVDP)
000960 4960 4F               4      LD  C,A
000961 4961 0C               4      INC C       ;C := PORT#1's address(WR)
000962 4962 3E24             7      LD  A,36
000964 4964 ED79            12      OUT (C),A
000966 4966 3E91             7      LD  A,080H+17
000968 4968 ED79            12      OUT (C),A       ;R#17 := 36
                                
00096A 496A 0C               4      INC C
00096B 496B 0C               4      INC C       ;C := PORT#3's address(WR)
00096C 496C 2AE2F2          16      LD  HL,(_BUF_X)
00096F 496F ED69            12      OUT (C),L       ;R#36 DX
000971 4971 ED61            12      OUT (C),H       ;R#37
000973 4973 2AE4F2          16      LD  HL,(_BUF_Y)
000976 4976 ED69            12      OUT (C),L       ;R#38 DY
000978 4978 ED61            12      OUT (C),H       ;R#39
00097A 497A 2ADEF2          16      LD  HL,(_BUF_W)
00097D 497D ED69            12      OUT (C),L       ;R#40 NX
00097F 497F ED61            12      OUT (C),H       ;R#41
000981 4981 2AE0F2          16      LD  HL,(_BUF_H)
000984 4984 ED69            12      OUT (C),L       ;R#42 NY
000986 4986 ED61            12      OUT (C),H       ;R#43
                                
000988 4988 DD2AAFFC        20      LD  IX,(SCRMOD)
00098C 498C 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00098F 498F B7               4      OR  A
000990 4990 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000992 4992 DD7D             9      LD  A,IXL
000994 4994 FE08             7      CP  8
000996 4996 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
000998 4998 FE06             7      CP  6
00099A 499A 2AE2F2          16      LD  HL,(_BUF_X)
00099D 499D 3ADEF2          13      LD  A,(_BUF_W)
0009A0 49A0 2005            12      JR  NZ,SCR57
0009A2 49A2 B5               4      OR  L       ;スクリーン6
0009A3 49A3 E603             7      AND 3
0009A5 49A5 200D            12      JR  NZ,USE_LMMC
       49A7                     SCR57:              ;スクリーン5,7
0009A7 49A7 B5               4      OR  L
0009A8 49A8 E601             7      AND 1
0009AA 49AA 2008            12      JR  NZ,USE_LMMC
       49AC                     USE_HMMC:
0009AC 49AC DD2E08          10      LD  IXL,8
       49AF                     USE_HMMC8:
0009AF 49AF 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
0009B1 49B1 32D9F2          13      LD  (_BUF_LO),A
       49B4                     USE_LMMC:
0009B4 49B4 110000          10      LD  DE,0
0009B7 49B7 06FF             7      LD  B,-1
0009B9 49B9 CD5A4A          17      CALL    GET_PIXEL
0009BC 49BC ED79            12      OUT (C),A       ;R#44 first DATA
0009BE 49BE 3AE6F2          13      LD  A,(_BUF_O)
0009C1 49C1 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
0009C3 49C3 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0009C6 49C6 F6B0             7      OR  0B0H        ;R#46 LMMC command
0009C8 49C8 ED79            12      OUT (C),A
                                
0009CA 49CA FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
0009CC 49CC 0D               4      DEC C
0009CD 49CD 0D               4      DEC C       ;C := PORT#1's address(WR)
0009CE 49CE 3EAC             7      LD  A,080H+44
0009D0 49D0 ED79            12      OUT (C),A
0009D2 49D2 3E91             7      LD  A,080H+17
0009D4 49D4 ED79            12      OUT (C),A       ;R#17 := 44
                                
0009D6 49D6 3A0600          13      LD  A,(RDVDP)
0009D9 49D9 3C               4      INC A
0009DA 49DA FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
0009DC 49DC 3E02             7      LD  A,2
0009DE 49DE ED79            12      OUT (C),A
0009E0 49E0 3E8F             7      LD  A,08FH
0009E2 49E2 ED79            12      OUT (C),A
0009E4 49E4 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0009E7 49E7 E640             7      AND 040H
0009E9 49E9 201C            12      JR  NZ,LOOP_HMMC
       49EB                     LOOP_COPY:
0009EB 49EB CD5A4A          17      CALL    GET_PIXEL
0009EE 49EE 08               4      EX  AF,AF'
0009EF 49EF FD4C             9      LD  C,IYH
       49F1                     LOOP_COPY1:
0009F1 49F1 ED78            12      IN  A,(C)
0009F3 49F3 0F               4      RRCA            ;RRCAではサインフラグは変化しない
0009F4 49F4 300A            12      JR  NC,EXIT_COPY    ;check CE bit
0009F6 49F6 F2F149          10      JP  P,LOOP_COPY1    ;check TR bit
0009F9 49F9 08               4      EX  AF,AF'
0009FA 49FA FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
0009FC 49FC ED79            12      OUT (C),A
0009FE 49FE 18EB            12      JR  LOOP_COPY
                                
       4A00                     EXIT_COPY:
000A00 4A00 CD374A          17      CALL    GET_STATUS_0
000A03 4A03 FB               4      EI
000A04 4A04 C39B47          10      JP  ROM_NEXT
                                
       4A07                     LOOP_HMMC:
000A07 4A07 F3               4      DI          ;必要
000A08 4A08 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000A0A 4A0A 43               4      LD  B,E
000A0B 4A0B 7B               4      LD  A,E
000A0C 4A0C B7               4      OR  A
000A0D 4A0D 2802            12      JR  Z,LOOP_HMMC1
000A0F 4A0F EDB3                    OTIR
       4A11                     LOOP_HMMC1:
000A11 4A11 14               4      INC D
       4A12                     LOOP_HMMC2:
000A12 4A12 15               4      DEC D
000A13 4A13 2805            12      JR  Z,LOOP_HMMC3
000A15 4A15 EDB3                    OTIR
000A17 4A17 C3124A          10      JP  LOOP_HMMC2
       4A1A                     LOOP_HMMC3:
000A1A 4A1A ED78            12      IN  A,(C)
000A1C 4A1C 0F               4      RRCA
000A1D 4A1D 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
000A1F 4A1F 2ADCF2          16      LD  HL,(_BUF_EN)
000A22 4A22 CDA14A          17      CALL    ROM_READ
000A25 4A25 EB               4      EX  DE,HL
000A26 4A26 2AD4F2          16      LD  HL,(_DTA)
000A29 4A29 7A               4      LD  A,D
000A2A 4A2A B3               4      OR  E
000A2B 4A2B 20DA            12      JR  NZ,LOOP_HMMC
000A2D 4A2D 18C2            12      JR  LOOP_COPY1
                                    
       4A2F                     WAIT_VDP:
000A2F 4A2F 3E02             7      LD  A,2
000A31 4A31 CD384A          17      CALL    GET_STATUS
000A34 4A34 0F               4      RRCA
000A35 4A35 38F8            12      JR  C,WAIT_VDP
       4A37                     GET_STATUS_0:
000A37 4A37 AF               4      XOR A
       4A38                     GET_STATUS:
000A38 4A38 C5              11      PUSH    BC
000A39 4A39 ED4B0600        20      LD  BC,(RDVDP)
000A3D 4A3D 0C               4      INC C
000A3E 4A3E ED79            12      OUT (C),A
000A40 4A40 3E8F             7      LD  A,08FH
000A42 4A42 ED79            12      OUT (C),A
000A44 4A44 ED78            12      IN  A,(C)
000A46 4A46 C1              10      POP BC
000A47 4A47 C9              10      RET
                                
       4A48                     GET_PIXEL256:
000A48 4A48 7A               4      LD  A,D
000A49 4A49 B3               4      OR  E
000A4A 4A4A 200A            12      JR  NZ,GET_PIXEL1
000A4C 4A4C 2ADCF2          16      LD  HL,(_BUF_EN)
000A4F 4A4F CDA14A          17      CALL    ROM_READ
000A52 4A52 EB               4      EX  DE,HL
000A53 4A53 2AD4F2          16      LD  HL,(_DTA)
       4A56                     GET_PIXEL1:
000A56 4A56 7E               7      LD  A,(HL)
000A57 4A57 23               6      INC HL
000A58 4A58 1B               6      DEC DE
000A59 4A59 C9              10      RET
                                
       4A5A                     GET_PIXEL:
000A5A 4A5A DD7D             9      LD  A,IXL
000A5C 4A5C FE08             7      CP  8
000A5E 4A5E 28E8            12      JR  Z,GET_PIXEL256
000A60 4A60 04               4      INC B
000A61 4A61 FE06             7      CP  6
000A63 4A63 282E            12      JR  Z,GET_PIXEL4
                                
000A65 4A65 CB40             8      BIT 0,B
000A67 4A67 20ED            12      JR  NZ,GET_PIXEL1
                                
000A69 4A69 7A               4      LD  A,D
000A6A 4A6A B3               4      OR  E
000A6B 4A6B 200A            12      JR  NZ,GET_PIXEL2
                                
000A6D 4A6D 2ADCF2          16      LD  HL,(_BUF_EN)
000A70 4A70 CDA14A          17      CALL    ROM_READ
000A73 4A73 EB               4      EX  DE,HL
000A74 4A74 2AD4F2          16      LD  HL,(_DTA)
                                
       4A77                     GET_PIXEL2:
000A77 4A77 7E               7      LD  A,(HL)
000A78 4A78 0F               4      RRCA
000A79 4A79 0F               4      RRCA
000A7A 4A7A 0F               4      RRCA
000A7B 4A7B 0F               4      RRCA
000A7C 4A7C C9              10      RET
                                
       4A7D                     GET_PIXEL3:
000A7D 4A7D 7A               4      LD  A,D
000A7E 4A7E B3               4      OR  E
000A7F 4A7F 200A            12      JR  NZ,GET_PIXEL5
                                
000A81 4A81 2ADCF2          16      LD  HL,(_BUF_EN)
000A84 4A84 CDA14A          17      CALL    ROM_READ
000A87 4A87 EB               4      EX  DE,HL
000A88 4A88 2AD4F2          16      LD  HL,(_DTA)
       4A8B                     GET_PIXEL5:
000A8B 4A8B 7E               7      LD  A,(HL)
000A8C 4A8C 0F               4      RRCA
000A8D 4A8D 0F               4      RRCA
000A8E 4A8E 0F               4      RRCA
000A8F 4A8F 0F               4      RRCA
000A90 4A90 0F               4      RRCA
000A91 4A91 0F               4      RRCA
000A92 4A92 C9              10      RET
                                
       4A93                     GET_PIXEL4:
000A93 4A93 78               4      LD  A,B
000A94 4A94 E603             7      AND 3   ;+0
000A96 4A96 28E5            12      JR  Z,GET_PIXEL3
000A98 4A98 3D               4      DEC A   ;+1
000A99 4A99 28DC            12      JR  Z,GET_PIXEL2
000A9B 4A9B 3D               4      DEC A   ;+2
000A9C 4A9C 7E               7      LD  A,(HL)
000A9D 4A9D C0              11      RET NZ
000A9E 4A9E 0F               4      RRCA        ;+3
000A9F 4A9F 0F               4      RRCA
000AA0 4AA0 C9              10      RET
                                
       4AA1                     ROM_READ:
000AA1 4AA1 E5              11      PUSH    HL
000AA2 4AA2 D5              11      PUSH    DE
000AA3 4AA3 C5              11      PUSH    BC
000AA4 4AA4 FDE5            15      PUSH    IY
000AA6 4AA6 22F0F2          16      LD  (LEFTX),HL
000AA9 4AA9 2AD4F2          16      LD  HL,(_DTA)
000AAC 4AAC 22E7F2          16      LD  (DTAX),HL
000AAF 4AAF 2AF0F2          16      LD  HL,(LEFTX)
                                
000AB2 4AB2 CD534D          17      CALL    RBX1
000AB5 4AB5 3870            12      JR  C,RBRERR1
000AB7 4AB7 79               4      LD  A,C
000AB8 4AB8 EB               4      EX  DE,HL
000AB9 4AB9 ED52            15      SBC HL,DE       ;CP 0HL,CDE
000ABB 4ABB 19              11      ADD HL,DE
000ABC 4ABC DE00             7      SBC A,000H
000ABE 4ABE 3801            12      JR  C,RBR1
000AC0 4AC0 EB               4      EX  DE,HL
       4AC1                     RBR1:
000AC1 4AC1 9F               4      SBC A,A
000AC2 4AC2 E601             7      AND 1
000AC4 4AC4 32C3F2          13      LD  (_RESULT),A
000AC7 4AC7 7C               4      LD  A,H
000AC8 4AC8 B5               4      OR  L
000AC9 4AC9 CA1D4B          10      JP  Z,RBREND0
                                
000ACC 4ACC 22D0F2          16      LD  (_LEFT),HL  ;Read record byte
000ACF 4ACF 22F0F2          16      LD  (LEFTX),HL
                                
000AD2 4AD2 CD7F4D          17      CALL    RBX2
000AD5 4AD5 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000AD7 4AD7 CD924D          17      CALL    RBXA
000ADA 4ADA DA334B          10      JP  C,RBRERR
000ADD 4ADD C5              11      PUSH    BC
000ADE 4ADE CD1745          17      CALL    ROM_LDIR
000AE1 4AE1 ED53E7F2        20      LD  (DTAX),DE
000AE5 4AE5 2AF0F2          16      LD  HL,(LEFTX)
000AE8 4AE8 D1              10      POP DE
000AE9 4AE9 A7               4      AND A
000AEA 4AEA ED52            15      SBC HL,DE
000AEC 4AEC 22F0F2          16      LD  (LEFTX),HL
000AEF 4AEF 2829            12      JR  Z,RBREND
                                
       4AF1                     RBRB:
000AF1 4AF1 CDCE4D          17      CALL    RBXB
000AF4 4AF4 2818            12      JR  Z,RBRC
       4AF6                     RBRB1:
000AF6 4AF6 C5              11      PUSH    BC
000AF7 4AF7 D5              11      PUSH    DE
000AF8 4AF8 CD794E          17      CALL    CLUST
000AFB 4AFB EB               4      EX  DE,HL
000AFC 4AFC ED4BC6F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000B00 4B00 CD1745          17      CALL    ROM_LDIR
000B03 4B03 EB               4      EX  DE,HL
000B04 4B04 D1              10      POP DE
000B05 4B05 C1              10      POP BC
000B06 4B06 CD564E          17      CALL    GNCL
000B09 4B09 DA334B          10      JP  C,RBRERR
000B0C 4B0C 10E8            13      DJNZ    RBRB1
       4B0E                     RBRC:
000B0E 4B0E CDE64D          17      CALL    RBXC
000B11 4B11 2807            12      JR  Z,RBREND
                                
000B13 4B13 CD794E          17      CALL    CLUST
000B16 4B16 EB               4      EX  DE,HL
000B17 4B17 CD1745          17      CALL    ROM_LDIR
       4B1A                     RBREND:
000B1A 4B1A CDF24D          17      CALL    RBXEND
       4B1D                     RBREND0:
000B1D 4B1D FDE1            14      POP IY
000B1F 4B1F C1              10      POP BC
000B20 4B20 D1              10      POP DE
000B21 4B21 F1              10      POP AF  ;(HL)
000B22 4B22 AF               4      XOR A
000B23 4B23 3AC3F2          13      LD  A,(_RESULT)
000B26 4B26 C9              10      RET
                                
       4B27                     RBRERR1:
000B27 4B27 3E01             7      LD  A,001H
       4B29                     RBRERR2:
000B29 4B29 FDE1            14      POP IY
000B2B 4B2B C1              10      POP BC
000B2C 4B2C D1              10      POP DE
000B2D 4B2D E1              10      POP HL
000B2E 4B2E 37               4      SCF
000B2F 4B2F 210000          10      LD  HL,0
000B32 4B32 C9              10      RET
       4B33                     RBRERR:
000B33 4B33 3EFF             7      LD  A,0FFH
000B35 4B35 18F2            12      JR  RBRERR2
                                
       4B37                     FILE_DD:
000B37 4B37 E1              10      POP HL
000B38 4B38 3E                      DB  03EH
000B39 4B39 C9              10      RET
000B3A 4B3A 32A3F2          13      LD  (SWC_BLOAD_M),A
       4B3D                     ROM_ORG:
000B3D 4B3D 2AF2F2          16      LD  HL,(PARAM0)
000B40 4B40 7E               7      LD  A,(HL)
000B41 4B41 C9              10      RET
       4B42                     FILE_B:
000B42 4B42 AF               4      XOR A
000B43 4B43 32F8F2          13      LD  (FDRV),A
000B46 4B46 1E00             7      LD  E,0
000B48 4B48 3A63F6          13      LD  A,(VALTYP)
000B4B 4B4B FE03             7      CP  3       ;string
000B4D 4B4D C2D24B          10      JP  NZ,FILED
                                
000B50 4B50 DD21D067        14      LD  IX,FRESTR
000B54 4B54 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000B58 4B58 CD1C00          17      CALL    _CALSLT
000B5B 4B5B E5              11      PUSH    HL
000B5C 4B5C DDE1            14      POP IX
                                
000B5E 4B5E DD5E00          19      LD  E,(IX+0)
000B61 4B61 DD7E01          19      LD  A,(IX+1)
000B64 4B64 DD5602          19      LD  D,(IX+2)
000B67 4B67 DD62             9      LD  IXH,D
000B69 4B69 DD6F             9      LD  IXL,A
000B6B 4B6B 7B               4      LD  A,E
       4B6C                     FILE_BDOS:
000B6C 4B6C FE04             7      CP  4
000B6E 4B6E 3808            12      JR  C,FILEB1
000B70 4B70 DD7E03          19      LD  A,(IX+3)
000B73 4B73 FE3A             7      CP  ':'
000B75 4B75 28C0            12      JR  Z,FILE_DD
000B77 4B77 7B               4      LD  A,E
       4B78                     FILEB1:
000B78 4B78 FE02             7      CP  2
000B7A 4B7A 3818            12      JR  C,DEVI1
000B7C 4B7C DD7E01          19      LD  A,(IX+1)
000B7F 4B7F FE3A             7      CP  ':'
000B81 4B81 2011            12      JR  NZ,DEVI1
000B83 4B83 DD7E00          19      LD  A,(IX+0)        ;DRIVE
000B86 4B86 CDAB4C          17      CALL    CAP
000B89 4B89 D640             7      SUB '@'
000B8B 4B8B DD23            10      INC IX
000B8D 4B8D DD23            10      INC IX
000B8F 4B8F 1D               4      DEC E
000B90 4B90 1D               4      DEC E
000B91 4B91 32F8F2          13      LD  (FDRV),A
       4B94                     DEVI1:
000B94 4B94 DD7E00          19      LD  A,(IX+0)
000B97 4B97 D65C             7      SUB 05CH        ;\
000B99 4B99 2008            12      JR  NZ,NOROOT
000B9B 4B9B 6F               4      LD  L,A
000B9C 4B9C 67               4      LD  H,A
000B9D 4B9D 22F6F2          16      LD  (_CDX),HL
000BA0 4BA0 DD23            10      INC IX
000BA2 4BA2 1D               4      DEC E
       4BA3                     NOROOT:
                                
       4BA3                     SETDIR:
000BA3 4BA3 CDD24B          17      CALL    FILED
000BA6 4BA6 DD7E00          19      LD  A,(IX+0)
000BA9 4BA9 FE5C             7      CP  05CH        ;\
000BAB 4BAB C0              11      RET NZ
000BAC 4BAC DD23            10      INC IX
000BAE 4BAE 1D               4      DEC E
000BAF 4BAF 3AF9F2          13      LD  A,(FNAME)
000BB2 4BB2 FE20             7      CP  020H        ;. の処理
000BB4 4BB4 28ED            12      JR  Z,SETDIR
                                
000BB6 4BB6 CDC14C          17      CALL    ROM_OPEN
000BB9 4BB9 B7               4      OR  A
000BBA 4BBA C0              11      RET NZ
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                #else
000BBB 4BBB FD2AEDF2        20      LD  IY,(DIRENT1)
000BBF 4BBF FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000BC3 4BC3 C8              11      RET Z
000BC4 4BC4 CD194C          17      CALL    FILEI
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
000BC7 4BC7 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000BCA 4BCA FD661B          19      LD  H,(IY+01BH)
                                #endif
000BCD 4BCD 22F6F2          16      LD  (_CDX),HL
000BD0 4BD0 18D1            12      JR  SETDIR
                                
       4BD2                     FILED:
000BD2 4BD2 CD194C          17      CALL    FILEI
000BD5 4BD5 21F9F2          10      LD  HL,FNAME
                                
000BD8 4BD8 0608             7      LD  B,8
       4BDA                     FILE2:
000BDA 4BDA CD264C          17      CALL    CCHKF
000BDD 4BDD C8              11      RET Z
000BDE 4BDE FE2A             7      CP  '*'
000BE0 4BE0 282E            12      JR  Z,FILE9
000BE2 4BE2 FE2E             7      CP  '.'
000BE4 4BE4 280C            12      JR  Z,FILE4
000BE6 4BE6 77               7      LD  (HL),A
000BE7 4BE7 23               6      INC HL
000BE8 4BE8 10F0            13      DJNZ    FILE2
                                
       4BEA                     FILE3:
000BEA 4BEA CD264C          17      CALL    CCHKF
000BED 4BED C8              11      RET Z
000BEE 4BEE FE2E             7      CP  '.'
000BF0 4BF0 20F8            12      JR  NZ,FILE3
                                
       4BF2                     FILE4:
000BF2 4BF2 2101F3          10      LD  HL,FNAME+8
000BF5 4BF5 0603             7      LD  B,3
                                
       4BF7                     FILE4L:
000BF7 4BF7 CD264C          17      CALL    CCHKF
000BFA 4BFA C8              11      RET Z
000BFB 4BFB FE2E             7      CP  '.'
000BFD 4BFD 2008            12      JR  NZ,FILE12
000BFF 4BFF 32F9F2          13      LD  (FNAME),A   ;Parent directory(..)
000C02 4C02 32FAF2          13      LD  (FNAME+1),A
000C05 4C05 3E20             7      LD  A,020H
       4C07                     FILE12:
000C07 4C07 FE2A             7      CP  '*'
000C09 4C09 280A            12      JR  Z,FILE10
000C0B 4C0B 77               7      LD  (HL),A
000C0C 4C0C 23               6      INC HL
000C0D 4C0D 10E8            13      DJNZ    FILE4L
000C0F 4C0F C9              10      RET
                                
       4C10                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000C10 4C10 CD154C          17      CALL    FILE10
000C13 4C13 18D5            12      JR  FILE3
                                
       4C15                     FILE10:
000C15 4C15 3E3F             7      LD  A,'?'
000C17 4C17 1808            12      JR  FILL_MEMORY
       4C19                     FILEI:              ;名前＋拡張子をスペースで初期化
000C19 4C19 3E20             7      LD  A,020H
000C1B 4C1B 01000B          10      LD  BC,11*256   ;C=0にしておく
000C1E 4C1E 21F9F2          10      LD  HL,FNAME
       4C21                     FILL_MEMORY:            ;HLからBバイトAで埋める
000C21 4C21 77               7      LD  (HL),A
000C22 4C22 23               6      INC HL
000C23 4C23 10FC            13      DJNZ    FILL_MEMORY
000C25 4C25 C9              10      RET
                                
       4C26                     CCHKF:
000C26 4C26 7B               4      LD  A,E
000C27 4C27 B7               4      OR  A
000C28 4C28 C8              11      RET Z
000C29 4C29 DD7E00          19      LD  A,(IX+0)
000C2C 4C2C CD334C          17      CALL    CCHK2
000C2F 4C2F C8              11      RET Z
000C30 4C30 C3964C          10      JP  FKAN
                                
       4C33                     CCHK2:
000C33 4C33 0C               4      INC C
000C34 4C34 0D               4      DEC C
000C35 4C35 C0              11      RET NZ
       4C36                     CCHK3:              ;ZF=1 で使えない文字
000C36 4C36 FE2B             7      CP  '+'
000C38 4C38 C8              11      RET Z
000C39 4C39 FE2C             7      CP  ','
000C3B 4C3B C8              11      RET Z
000C3C 4C3C FE2F             7      CP  '/'
000C3E 4C3E C8              11      RET Z
000C3F 4C3F FE3A             7      CP  ':'
000C41 4C41 C8              11      RET Z
000C42 4C42 FE3B             7      CP  ';'
000C44 4C44 C8              11      RET Z
000C45 4C45 FE3D             7      CP  '='
000C47 4C47 C8              11      RET Z
000C48 4C48 FE5C             7      CP  05CH    ;\
000C4A 4C4A C8              11      RET Z
000C4B 4C4B FE1F             7      CP  01FH
000C4D 4C4D D0              11      RET NC
000C4E 4C4E BF               4      CP  A       ;Z=1
000C4F 4C4F C9              10      RET
                                
       4C50                     SS1:
000C50 4C50 13               6      INC DE
       4C51                     SPCUT:              ;スペースをカット
000C51 4C51 1A               7      LD  A,(DE)
000C52 4C52 FE20             7      CP  020H
000C54 4C54 28FA            12      JR  Z,SS1
000C56 4C56 C9              10      RET
                                
       4C57                     SCREOF1:
000C57 4C57 13               6      INC DE
       4C58                     SPCUTEX:            ;スペース改行などをカット
000C58 4C58 1A               7      LD  A,(DE)
000C59 4C59 FE20             7      CP  020H
000C5B 4C5B 28FA            12      JR  Z,SCREOF1
000C5D 4C5D FE0D             7      CP  00DH
000C5F 4C5F 28F6            12      JR  Z,SCREOF1
000C61 4C61 FE0A             7      CP  00AH
000C63 4C63 28F2            12      JR  Z,SCREOF1
000C65 4C65 FE1A             7      CP  01AH
000C67 4C67 28EE            12      JR  Z,SCREOF1
000C69 4C69 C9              10      RET
                                
       4C6A                     GETNUM:
000C6A 4C6A 210000          10      LD  HL,0
       4C6D                     GETNUM1:
000C6D 4C6D 1A               7      LD  A,(DE)
000C6E 4C6E 13               6      INC DE
000C6F 4C6F D630             7      SUB '0'
000C71 4C71 D8              11      RET C
000C72 4C72 FE0A             7      CP  10
000C74 4C74 D0              11      RET NC
000C75 4C75 4D               4      LD  C,L
000C76 4C76 44               4      LD  B,H
000C77 4C77 29              11      ADD HL,HL   ;*2
000C78 4C78 29              11      ADD HL,HL   ;*4
000C79 4C79 09              11      ADD HL,BC   ;*5
000C7A 4C7A 29              11      ADD HL,HL   ;*10
000C7B 4C7B 4F               4      LD  C,A
000C7C 4C7C 0600             7      LD  B,0
000C7E 4C7E 09              11      ADD HL,BC
000C7F 4C7F 18EC            12      JR  GETNUM1
                                
       4C81                     SEARCH_END:
000C81 4C81 7E               7      LD  A,(HL)
       4C82                     SEARCH_END1:
000C82 4C82 23               6      INC HL
000C83 4C83 B7               4      OR  A
000C84 4C84 C8              11      RET Z
000C85 4C85 FE3A             7      CP  ':'
000C87 4C87 20F8            12      JR  NZ,SEARCH_END
000C89 4C89 7E               7      LD  A,(HL)
000C8A 4C8A FE3A             7      CP  ':'
000C8C 4C8C 28F4            12      JR  Z,SEARCH_END1
000C8E 4C8E C9              10      RET
                                
       4C8F                     FKANC:
000C8F 4C8F CB41             8      BIT 0,C
000C91 4C91 CCB44C          17      CALL    Z,CAP2
000C94 4C94 1803            12      JR  FKANX
       4C96                     FKAN:           ;漢字チェック
000C96 4C96 DD23            10      INC IX
000C98 4C98 1D               4      DEC E
       4C99                     FKANX:
000C99 4C99 CB41             8      BIT 0,C
000C9B 4C9B CB81             8      RES 0,C
000C9D 4C9D C0              11      RET NZ
000C9E 4C9E FE80             7      CP  080H
000CA0 4CA0 D8              11      RET C
000CA1 4CA1 FEA0             7      CP  0A0H
000CA3 4CA3 3803            12      JR  C,FKAN1
000CA5 4CA5 FEE0             7      CP  0E0H
000CA7 4CA7 D8              11      RET C
       4CA8                     FKAN1:
000CA8 4CA8 0C               4      INC C
000CA9 4CA9 A7               4      AND A
000CAA 4CAA C9              10      RET
                                
       4CAB                     CAP:
000CAB 4CAB FE61             7      CP  'a'
000CAD 4CAD D8              11      RET C
000CAE 4CAE FE7B             7      CP  'z'+1
000CB0 4CB0 D0              11      RET NC
000CB1 4CB1 D620             7      SUB 020H
000CB3 4CB3 C9              10      RET
       4CB4                     CAP2:
000CB4 4CB4 CDAB4C          17      CALL    CAP
       4CB7                     CAP3:               ;
000CB7 4CB7 FE05             7      CP  5
000CB9 4CB9 2803            12      JR  Z,CAP4
000CBB 4CBB FE21             7      CP  021H
000CBD 4CBD C9              10      RET
       4CBE                     CAP4:
000CBE 4CBE 3EE5             7      LD  A,0E5H
000CC0 4CC0 C9              10      RET
                                
       4CC1                     ROM_OPEN:
000CC1 4CC1 CDA353          17      CALL    GET_DISK_BANK_FDRV
                                
000CC4 4CC4 CD1F4F          17      CALL    GET_DIR_DAT
000CC7 4CC7 D5              11      PUSH    DE
000CC8 4CC8 CDDD4C          17      CALL    FILESE
000CCB 4CCB D1              10      POP DE
000CCC 4CCC 3F               4      CCF
000CCD 4CCD D8              11      RET C
000CCE 4CCE 22EDF2          16      LD  (DIRENT1),HL
000CD1 4CD1 E5              11      PUSH    HL
000CD2 4CD2 210000          10      LD  HL,0
000CD5 4CD5 22CAF2          16      LD  (RR_LOW),HL
000CD8 4CD8 22CCF2          16      LD  (RR_HIGH),HL
000CDB 4CDB E1              10      POP HL
000CDC 4CDC C9              10      RET
                                
       4CDD                     FILESE:
       4CDD                     FILESE0:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000CDD 4CDD 7E               7      LD  A,(HL)
                                #endif
000CDE 4CDE B7               4      OR  A
000CDF 4CDF C8              11      RET Z       ;END:ZF=1 CF=0
000CE0 4CE0 FEE5             7      CP  0E5H
000CE2 4CE2 280D            12      JR  Z,FILESE1
000CE4 4CE4 11F9F2          10      LD  DE,FNAME
000CE7 4CE7 E5              11      PUSH    HL
000CE8 4CE8 CD2E4D          17      CALL    CPFILE
000CEB 4CEB CC4F4D          17      CALL    Z,CPFILE2
000CEE 4CEE E1              10      POP HL
000CEF 4CEF 37               4      SCF
000CF0 4CF0 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4CF1                     FILESE1:
000CF1 4CF1 CDF94C          17      CALL    FNEXT
000CF4 4CF4 20E7            12      JR  NZ,FILESE0
000CF6 4CF6 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000CF8 4CF8 C9              10      RET
                                
       4CF9                     FNEXT:
000CF9 4CF9 112000          10      LD  DE,020H
000CFC 4CFC 19              11      ADD HL,DE
000CFD 4CFD ED5BF6F2        20      LD  DE,(_CDX)
000D01 4D01 7A               4      LD  A,D
000D02 4D02 B3               4      OR  E
000D03 4D03 2019            12      JR  NZ,FNEXT_SUBDIR
000D05 4D05 0D               4      DEC C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
       4D06                     CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
000D06 4D06 F5              11      PUSH    AF      ;※フラグを保存する必要あり
000D07 4D07 CB7C             8      BIT 7,H
000D09 4D09 2811            12      JR  Z,CHECK_DIR_PAGE1
000D0B 4D0B 7C               4      LD  A,H
000D0C 4D0C D620             7      SUB 020H
000D0E 4D0E 67               4      LD  H,A
000D0F 4D0F 3AEFF2          13      LD  A,(_DIR_BANK)
000D12 4D12 3C               4      INC A
000D13 4D13 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D16 4D16 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D19 4D19 32EFF2          13      LD  (_DIR_BANK),A
       4D1C                     CHECK_DIR_PAGE1:
000D1C 4D1C F1              10      POP AF
                                #endif
000D1D 4D1D C9              10      RET
                                
       4D1E                     FNEXT_SUBDIR:           ;サブディレクトリ
000D1E 4D1E 0D               4      DEC C
000D1F 4D1F C0              11      RET NZ
                                
000D20 4D20 ED5BF6F2        20      LD  DE,(_CDX)
000D24 4D24 CD564E          17      CALL    GNCL
000D27 4D27 EB               4      EX  DE,HL
000D28 4D28 22F6F2          16      LD  (_CDX),HL
000D2B 4D2B C35B4F          10      JP  GET_SUBDIR
                                
       4D2E                     CPFILE:
000D2E 4D2E C5              11      PUSH    BC
000D2F 4D2F 01000B          10      LD  BC,00B00H
       4D32                     CPSTR1:
000D32 4D32 1A               7      LD  A,(DE)
000D33 4D33 FE3F             7      CP  '?'     ;Wild card
000D35 4D35 2812            12      JR  Z,CPSTR2
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000D37 4D37 7E               7      LD  A,(HL)
                                #endif
000D38 4D38 CD8F4C          17      CALL    FKANC
000D3B 4D3B E5              11      PUSH    HL
000D3C 4D3C 67               4      LD  H,A
000D3D 4D3D 1A               7      LD  A,(DE)
000D3E 4D3E CB01             8      RLC C
000D40 4D40 CD8F4C          17      CALL    FKANC
000D43 4D43 CB09             8      RRC C
000D45 4D45 BC               4      CP  H       ;CP (HL),(DE)
000D46 4D46 E1              10      POP HL
000D47 4D47 2004            12      JR  NZ,CPSTR3
       4D49                     CPSTR2:
000D49 4D49 13               6      INC DE
000D4A 4D4A 23               6      INC HL
000D4B 4D4B 10E5            13      DJNZ    CPSTR1
       4D4D                     CPSTR3:
000D4D 4D4D C1              10      POP BC
000D4E 4D4E C9              10      RET
                                
       4D4F                     CPFILE2:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000D4F 4D4F 7E               7      LD  A,(HL)
                                #endif
000D50 4D50 E608             7      AND 008H    ;~0F7H
000D52 4D52 C9              10      RET
                                
       4D53                     RBX1:
000D53 4D53 E5              11      PUSH    HL      ;Record byte
                                
000D54 4D54 ED5BCAF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000D58 4D58 3ACDF2          13      LD  A,(RR_HIGH+1)
000D5B 4D5B 4F               4      LD  C,A
                                
000D5C 4D5C 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001CH
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    CALL    RDSLT_ROM
                                    EX  DE,HL       ;AHL=File size
                                    POP DE
                                #else
000D5F 4D5F 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D62 4D62 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D65 4D65 FD2AEDF2        20      LD  IY,(DIRENT1)
000D69 4D69 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000D6C 4D6C FD661D          19      LD  H,(IY+01DH)
000D6F 4D6F FD7E1E          19      LD  A,(IY+01EH)
                                #endif
                                
000D72 4D72 A7               4      AND A
000D73 4D73 ED52            15      SBC HL,DE
000D75 4D75 99               4      SBC A,C
000D76 4D76 D1              10      POP DE
                                
000D77 4D77 D8              11      RET C
000D78 4D78 4F               4      LD  C,A
000D79 4D79 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000D7A 4D7A B2               4      OR  D
000D7B 4D7B B3               4      OR  E
000D7C 4D7C C0              11      RET NZ
000D7D 4D7D 37               4      SCF
000D7E 4D7E C9              10      RET
                                
       4D7F                     RBX2:
000D7F 4D7F ED4BCBF2        20      LD  BC,(RR_LOW+1)
000D83 4D83 CD074E          17      CALL    RWXR
000D86 4D86 3AC7F2          13      LD  A,(CLSZ_H)
000D89 4D89 3D               4      DEC A
000D8A 4D8A E5              11      PUSH    HL
000D8B 4D8B 2ACAF2          16      LD  HL,(RR_LOW)
000D8E 4D8E A4               4      AND H
000D8F 4D8F B5               4      OR  L
000D90 4D90 E1              10      POP HL
000D91 4D91 C9              10      RET
                                
       4D92                     RBXA:
000D92 4D92 D5              11      PUSH    DE
000D93 4D93 CD794E          17      CALL    CLUST
000D96 4D96 ED53D2F2        20      LD  (_DTPS),DE
000D9A 4D9A D1              10      POP DE
000D9B 4D9B CD564E          17      CALL    GNCL
000D9E 4D9E D8              11      RET C
000D9F 4D9F ED53CEF2        20      LD  (_CLPS),DE
                                
000DA3 4DA3 ED4BCAF2        20      LD  BC,(RR_LOW)
000DA7 4DA7 2AC6F2          16      LD  HL,(CLSZ)
000DAA 4DAA 7C               4      LD  A,H
000DAB 4DAB 3D               4      DEC A
000DAC 4DAC A0               4      AND B
000DAD 4DAD 47               4      LD  B,A
000DAE 4DAE ED42            15      SBC HL,BC       ;remaining cluster
                                
000DB0 4DB0 ED5BF0F2        20      LD  DE,(LEFTX)
000DB4 4DB4 ED52            15      SBC HL,DE       ;CP HL,DE
000DB6 4DB6 19              11      ADD HL,DE
000DB7 4DB7 3801            12      JR  C,RBXA1
000DB9 4DB9 EB               4      EX  DE,HL
       4DBA                     RBXA1:
000DBA 4DBA 3AC4F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
000DBD 4DBD 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000DC0 4DC0 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000DC3 4DC3 E5              11      PUSH    HL
000DC4 4DC4 2AD2F2          16      LD  HL,(_DTPS)
000DC7 4DC7 09              11      ADD HL,BC
000DC8 4DC8 ED5BE7F2        20      LD  DE,(DTAX)
000DCC 4DCC C1              10      POP BC
000DCD 4DCD C9              10      RET
                                
       4DCE                     RBXB:
000DCE 4DCE 2AE7F2          16      LD  HL,(DTAX)
000DD1 4DD1 ED5BCEF2        20      LD  DE,(_CLPS)
000DD5 4DD5 3AF1F2          13      LD  A,(LEFTX+1)
000DD8 4DD8 47               4      LD  B,A
000DD9 4DD9 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4DDC                     RBXB1:
000DDC 4DDC 1F               4      RRA     ;->CF
000DDD 4DDD 3804            12      JR  C,RBXB2
000DDF 4DDF CB38             8      SRL B   ;B=B/2
000DE1 4DE1 18F9            12      JR  RBXB1
       4DE3                     RBXB2:
000DE3 4DE3 78               4      LD  A,B
000DE4 4DE4 B7               4      OR  A
000DE5 4DE5 C9              10      RET
                                
       4DE6                     RBXC:
000DE6 4DE6 ED4BF0F2        20      LD  BC,(LEFTX)
000DEA 4DEA 3AC7F2          13      LD  A,(CLSZ_H)
000DED 4DED 3D               4      DEC A
000DEE 4DEE A0               4      AND B
000DEF 4DEF 47               4      LD  B,A
000DF0 4DF0 B1               4      OR  C
000DF1 4DF1 C9              10      RET
                                
       4DF2                     RBXEND:
000DF2 4DF2 ED5BD0F2        20      LD  DE,(_LEFT)
000DF6 4DF6 2ACAF2          16      LD  HL,(RR_LOW)
000DF9 4DF9 3ACDF2          13      LD  A,(RR_HIGH+1)
000DFC 4DFC 19              11      ADD HL,DE
000DFD 4DFD CE00             7      ADC A,0
000DFF 4DFF 22CAF2          16      LD  (RR_LOW),HL
000E02 4E02 32CDF2          13      LD  (RR_HIGH+1),A
000E05 4E05 EB               4      EX  DE,HL       ;HL=Read byte
000E06 4E06 C9              10      RET 
                                
       4E07                     RWXR:
000E07 4E07 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4E0A                     L_RWX:
000E0A 4E0A 1F               4      RRA     ;->CF
000E0B 4E0B 3806            12      JR  C,E_RWX
000E0D 4E0D CB38             8      SRL B   ;BC=BC/2
000E0F 4E0F CB19             8      RR  C   ;
000E11 4E11 18F7            12      JR  L_RWX
       4E13                     E_RWX:
000E13 4E13 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
                                    PUSH    HL
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    POP HL
                                #else
000E16 4E16 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000E19 4E19 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000E1C 4E1C FD2AEDF2        20      LD  IY,(DIRENT1)
000E20 4E20 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000E23 4E23 FD561B          19      LD  D,(IY+01BH)
                                #endif
000E26 4E26 CDA353          17      CALL    GET_DISK_BANK_FDRV
       4E29                     RWX1:
000E29 4E29 ED53CEF2        20      LD  (_CLPS),DE
000E2D 4E2D 7A               4      LD  A,D
000E2E 4E2E B3               4      OR  E
000E2F 4E2F 37               4      SCF
000E30 4E30 C8              11      RET Z
                                
000E31 4E31 78               4      LD  A,B
000E32 4E32 B1               4      OR  C
000E33 4E33 C8              11      RET Z
                                
000E34 4E34 CD564E          17      CALL    GNCL
000E37 4E37 D8              11      RET C
000E38 4E38 0B               6      DEC BC
000E39 4E39 CDB84E          17      CALL    ENDCL
000E3C 4E3C 38EB            12      JR  C,RWX1
000E3E 4E3E 37               4      SCF
000E3F 4E3F C9              10      RET
                                
       4E40                     NCL3:
000E40 4E40 CDA353          17      CALL    GET_DISK_BANK_FDRV
000E43 4E43 6B               4      LD  L,E
000E44 4E44 62               4      LD  H,D
000E45 4E45 CB3C             8      SRL H
000E47 4E47 CB1D             8      RR  L
000E49 4E49 1F               4      RRA
000E4A 4E4A 19              11      ADD HL,DE
000E4B 4E4B 010060          10      LD  BC,BANK1_ADR
000E4E 4E4E 09              11      ADD HL,BC
000E4F 4E4F ED4BC8F2        20      LD  BC,(SECSZ)
000E53 4E53 09              11      ADD HL,BC
000E54 4E54 17               4      RLA
000E55 4E55 C9              10      RET
                                
       4E56                     GNCL:
000E56 4E56 7A               4      LD  A,D
000E57 4E57 B3               4      OR  E
000E58 4E58 37               4      SCF
000E59 4E59 C8              11      RET Z
000E5A 4E5A C5              11      PUSH    BC
000E5B 4E5B E5              11      PUSH    HL
000E5C 4E5C CD404E          17      CALL    NCL3
000E5F 4E5F 3809            12      JR  C,GNC1
000E61 4E61 5E               7      LD  E,(HL)
000E62 4E62 23               6      INC HL
000E63 4E63 7E               7      LD  A,(HL)
000E64 4E64 E60F             7      AND 00FH
000E66 4E66 57               4      LD  D,A
000E67 4E67 E1              10      POP HL
000E68 4E68 C1              10      POP BC
000E69 4E69 C9              10      RET
       4E6A                     GNC1:
000E6A 4E6A 7E               7      LD  A,(HL)
000E6B 4E6B 23               6      INC HL
000E6C 4E6C 56               7      LD  D,(HL)
000E6D 4E6D 0604             7      LD  B,4
       4E6F                     GNC1L:
000E6F 4E6F CB3A             8      SRL D
000E71 4E71 1F               4      RRA
000E72 4E72 10FB            13      DJNZ    GNC1L
                                
000E74 4E74 5F               4      LD  E,A
000E75 4E75 E1              10      POP HL
000E76 4E76 C1              10      POP BC
000E77 4E77 A7               4      AND A
000E78 4E78 C9              10      RET
                                
       4E79                     CLUST:
000E79 4E79 EB               4      EX  DE,HL
       4E7A                     CLUST_HL:
000E7A 4E7A 2B               6      DEC HL
000E7B 4E7B 2B               6      DEC HL
000E7C 4E7C C5              11      PUSH    BC
000E7D 4E7D 3AC7F2          13      LD  A,(CLSZ_H)
000E80 4E80 CDD353          17      CALL    MUL_AHL
                                
000E83 4E83 CD3C4F          17      CALL    GET_DIR_POS
000E86 4E86 4F               4      LD  C,A
000E87 4E87 0600             7      LD  B,0
000E89 4E89 09              11      ADD HL,BC
                                
000E8A 4E8A ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
000E8E 4E8E CB38             8      SRL B
000E90 4E90 CB19             8      RR  C           ;/2
000E92 4E92 CB38             8      SRL B
000E94 4E94 CB19             8      RR  C           ;/4
000E96 4E96 CB38             8      SRL B
000E98 4E98 CB19             8      RR  C           ;/8
000E9A 4E9A 09              11      ADD HL,BC
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  A,L
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    JR  NC,CLUST2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
000E9B 4E9B 4D               4      LD  C,L     ;C=読み出し元
000E9C 4E9C 29              11      ADD HL,HL   ;64KB→32KB
000E9D 4E9D 29              11      ADD HL,HL   ;32KB→16KB
000E9E 4E9E 29              11      ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
000E9F 4E9F CDA353          17      CALL    GET_DISK_BANK_FDRV
000EA2 4EA2 84               4      ADD A,H
000EA3 4EA3 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000EA6 4EA6 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000EA9 4EA9 32C4F2          13      LD  (_BANK),A
000EAC 4EAC 69               4      LD  L,C     ;C=読み出し元
000EAD 4EAD 3E1F             7      LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
000EAF 4EAF A5               4      AND L
                                #endif
       4EB0                     CLUST2:
000EB0 4EB0 C660             7      ADD A,high BANK1_ADR
000EB2 4EB2 67               4      LD  H,A
000EB3 4EB3 2E00             7      LD  L,0
000EB5 4EB5 EB               4      EX  DE,HL
000EB6 4EB6 C1              10      POP BC
000EB7 4EB7 C9              10      RET
                                
       4EB8                     ENDCL:
000EB8 4EB8 7A               4      LD  A,D ;END CLUSTER
000EB9 4EB9 FE0F             7      CP  00FH    ;FAT12の最大値
000EBB 4EBB C0              11      RET NZ
000EBC 4EBC 7B               4      LD  A,E
000EBD 4EBD FEF7             7      CP  0F7H
000EBF 4EBF C9              10      RET
                                
       4EC0                     RB_READ:
000EC0 4EC0 AF               4      XOR A   ;HLA = HL*128
000EC1 4EC1 CB3C             8      SRL H
000EC3 4EC3 CB1D             8      RR  L
000EC5 4EC5 1F               4      RRA
000EC6 4EC6 32CAF2          13      LD  (RR_LOW),A
000EC9 4EC9 22CBF2          16      LD  (RR_MID),HL
000ECC 4ECC 218000          10      LD  HL,128
                                
000ECF 4ECF CDA14A          17      CALL    ROM_READ
000ED2 4ED2 C9              10      RET
                                
       4ED3                     GETSEQ:
000ED3 4ED3 FD6E20          19      LD  L,(IY+32)
000ED6 4ED6 FD660C          19      LD  H,(IY+12)
                                
000ED9 4ED9 CB25             8      SLA L
                                
000EDB 4EDB CB3C             8      SRL H
000EDD 4EDD CB1D             8      RR  L
000EDF 4EDF C9              10      RET
                                
       4EE0                     SETSEQ:
000EE0 4EE0 F5              11      PUSH    AF
000EE1 4EE1 3ACAF2          13      LD  A,(RR_LOW)
000EE4 4EE4 2ACBF2          16      LD  HL,(RR_MID)
                                
000EE7 4EE7 CDFE4E          17      CALL    SSQ1
                                
000EEA 4EEA 29              11      ADD HL,HL
000EEB 4EEB CB3D             8      SRL L
000EED 4EED FD7520          19      LD  (IY+32),L
000EF0 4EF0 FD740C          19      LD  (IY+12),H
000EF3 4EF3 F1              10      POP AF
000EF4 4EF4 C9              10      RET
                                
       4EF5                     GETSIZE:
000EF5 4EF5 FD7E10          19      LD  A,(IY+16)
000EF8 4EF8 FD6E11          19      LD  L,(IY+17)
000EFB 4EFB FD6612          19      LD  H,(IY+18)
       4EFE                     SSQ1:
000EFE 4EFE 87               4      ADD A,A
000EFF 4EFF ED6A            15      ADC HL,HL
000F01 4F01 B7               4      OR  A
000F02 4F02 C8              11      RET Z
000F03 4F03 23               6      INC HL
000F04 4F04 C9              10      RET
                                
       4F05                     SET_FCB:
000F05 4F05 D5              11      PUSH    DE
000F06 4F06 FDE1            14      POP IY
000F08 4F08 FD7E1C          19      LD  A,(IY+28)
000F0B 4F0B FEFF             7      CP  0FFH
000F0D 4F0D 200C            12      JR  NZ,POPAF_SCF_FF_RET
000F0F 4F0F E5              11      PUSH    HL
000F10 4F10 FD6E1A          19      LD  L,(IY+26)
000F13 4F13 FD661B          19      LD  H,(IY+27)
000F16 4F16 22CEF2          16      LD  (_CLPS),HL
000F19 4F19 E1              10      POP HL
000F1A 4F1A C9              10      RET
                                
       4F1B                     POPAF_SCF_FF_RET:
000F1B 4F1B F1              10      POP AF
000F1C 4F1C 37               4      SCF
000F1D 4F1D 9F               4      SBC A,A
000F1E 4F1E C9              10      RET
                                
       4F1F                     GET_DIR_DAT:
000F1F 4F1F 2AF6F2          16      LD  HL,(_CDX)
000F22 4F22 7C               4      LD  A,H
000F23 4F23 B5               4      OR  L
000F24 4F24 2035            12      JR  NZ,GET_SUBDIR
000F26 4F26 CD3C4F          17      CALL    GET_DIR_POS
000F29 4F29 C660             7      ADD A,high BANK1_ADR
000F2B 4F2B 2E00             7      LD  L,0
000F2D 4F2D 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
000F2E 4F2E CD064D          17      CALL    CHECK_DIR_PAGE
                                #endif
000F31 4F31 3AC5F2          13      LD  A,(_BANK1)
000F34 4F34 32EFF2          13      LD  (_DIR_BANK),A
                                
000F37 4F37 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000F3A 4F3A 4F               4      LD  C,A
000F3B 4F3B C9              10      RET
                                
       4F3C                     GET_DIR_POS:                ;ルートディレクトリ
000F3C 4F3C CDA353          17      CALL    GET_DISK_BANK_FDRV
000F3F 4F3F 32C5F2          13      LD  (_BANK1),A
000F42 4F42 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000F45 4F45 47               4      LD  B,A
000F46 4F46 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000F49 4F49 4F               4      LD  C,A
000F4A 4F4A 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4F4D                     GET_DIR_POS1:
000F4D 4F4D 81               4      ADD A,C
000F4E 4F4E 10FD            13      DJNZ    GET_DIR_POS1
                                
000F50 4F50 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
000F54 4F54 37               4      SCF     ;無限ループ回避
       4F55                     L_MDP:
000F55 4F55 CB18             8      RR  B   ;->CF
000F57 4F57 D8              11      RET C
000F58 4F58 87               4      ADD A,A
000F59 4F59 18FA            12      JR  L_MDP
                                
       4F5B                     GET_SUBDIR:             ;サブディレクトリ
000F5B 4F5B CD7A4E          17      CALL    CLUST_HL
000F5E 4F5E EB               4      EX  DE,HL
000F5F 4F5F 3AC4F2          13      LD  A,(_BANK)
000F62 4F62 32EFF2          13      LD  (_DIR_BANK),A
000F65 4F65 3AC7F2          13      LD  A,(CLSZ_H)
000F68 4F68 87               4      ADD A,A     ;*2
000F69 4F69 87               4      ADD A,A     ;*4
000F6A 4F6A 87               4      ADD A,A     ;*8
000F6B 4F6B 4F               4      LD  C,A
000F6C 4F6C C9              10      RET
                                
       4F6D                     STATEMENT:
000F6D 4F6D 11C051          10      LD  DE,STR_CHDIR
000F70 4F70 CDA651          17      CALL    CPPROCNM
000F73 4F73 2812            12      JR  Z,_CHDIR
000F75 4F75 11C651          10      LD  DE,STR_CHDRV
000F78 4F78 CDA651          17      CALL    CPPROCNM
000F7B 4F7B 281C            12      JR  Z,_CHDRV
000F7D 4F7D 11CC51          10      LD  DE,STR_RAMDISK
000F80 4F80 CDA651          17      CALL    CPPROCNM
000F83 4F83 2829            12      JR  Z,_RAMDISK
000F85 4F85 37               4      SCF
000F86 4F86 C9              10      RET
       4F87                     _CHDIR:
000F87 4F87 7E               7      LD  A,(HL)
000F88 4F88 FE28             7      CP  '('
000F8A 4F8A 37               4      SCF
000F8B 4F8B C0              11      RET NZ
000F8C 4F8C CD4F48          17      CALL    INIT_PARAM
000F8F 4F8F CD424B          17      CALL    FILE_B
000F92 4F92 CDC24F          17      CALL    ROM_CD
000F95 4F95 D0              11      RET NC
000F96 4F96 C3F646          10      JP  ERROR_FILE_NOT_FOUND
                                
       4F99                     _CHDRV:
000F99 4F99 7E               7      LD  A,(HL)
000F9A 4F9A FE28             7      CP  '('
000F9C 4F9C 37               4      SCF
000F9D 4F9D C0              11      RET NZ
000F9E 4F9E CD4F48          17      CALL    INIT_PARAM
000FA1 4FA1 E5              11      PUSH    HL
000FA2 4FA2 CD424B          17      CALL    FILE_B
000FA5 4FA5 E1              10      POP HL
000FA6 4FA6 23               6      INC HL
000FA7 4FA7 3AF8F2          13      LD  A,(FDRV)
000FAA 4FAA 3D               4      DEC A
000FAB 4FAB C37956          10      JP  _SYS0EX1
                                
       4FAE                     _RAMDISK:
000FAE 4FAE 7E               7      LD  A,(HL)
000FAF 4FAF FE28             7      CP  '('
000FB1 4FB1 37               4      SCF
000FB2 4FB2 C0              11      RET NZ
000FB3 4FB3 23               6      INC HL
000FB4 4FB4 DD212F54        14      LD  IX,FRMQNT
000FB8 4FB8 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000FBC 4FBC CD1C00          17      CALL    _CALSLT
                                ;   LD  A,(HOKVLD)  ;bit0: 拡張 BIOSの存在
                                ;   CPL
                                ;   AND 1
                                ;   LD  A,D
                                ;   OR  E
                                ;   JP  NZ,ERROR_INTERNAL_ERROR
                                ;   PUSH    HL      ;EXTBIOもDISK BIOSで初期化してそう
                                ;   XOR A
                                ;   LD  DE,0401H    ;D=マッパサポートルチン(4) E=機能番号(1)
                                ;   CALL    EXTBIO
                                ;   POP HL
                                ;   OR  A
                                ;   JP  Z,ERROR_INTERNAL_ERROR
000FBF 4FBF 23               6      INC HL
000FC0 4FC0 AF               4      XOR A
000FC1 4FC1 C9              10      RET
                                
       4FC2                     ROM_CD:
000FC2 4FC2 3AF9F2          13      LD  A,(FNAME)
000FC5 4FC5 FE20             7      CP  020H
000FC7 4FC7 2822            12      JR  Z,CD1
000FC9 4FC9 CDC14C          17      CALL    ROM_OPEN
000FCC 4FCC D8              11      RET C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
000FCD 4FCD FD2AEDF2        20      LD  IY,(DIRENT1)
000FD1 4FD1 FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
000FD5 4FD5 CAF646          10      JP  Z,ERROR_FILE_NOT_FOUND
000FD8 4FD8 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000FDB 4FDB FD661B          19      LD  H,(IY+01BH)
                                #endif
       4FDE                     CD2:
000FDE 4FDE 22EBF2          16      LD  (_CD),HL
000FE1 4FE1 2AF4F2          16      LD  HL,(PARAM1)
       4FE4                     CD_SKIP:
000FE4 4FE4 7E               7      LD  A,(HL)
000FE5 4FE5 23               6      INC HL
000FE6 4FE6 FE21             7      CP  021H
000FE8 4FE8 38FA            12      JR  C,CD_SKIP
000FEA 4FEA C9              10      RET
       4FEB                     CD1:
000FEB 4FEB 2AF6F2          16      LD  HL,(_CDX)
000FEE 4FEE 18EE            12      JR  CD2
                                
       4FF0                     GET_BASIC_FCB:
000FF0 4FF0 D5              11      PUSH    DE
000FF1 4FF1 23               6      INC HL  ;+1
000FF2 4FF2 5E               7      LD  E,(HL)  ;FCB[1]
000FF3 4FF3 23               6      INC HL  ;+2
000FF4 4FF4 56               7      LD  D,(HL)  ;FCB[2]
000FF5 4FF5 23               6      INC HL  ;+3
000FF6 4FF6 ED53EDF2        20      LD  (DIRENT1),DE
                                            ;FCB[3] backup char
000FFA 4FFA 23               6      INC HL  ;+4
                                            ;FCB[4]
000FFB 4FFB 23               6      INC HL  ;+5
000FFC 4FFC 7E               7      LD  A,(HL)  ;FCB[5]
000FFD 4FFD 23               6      INC HL  ;+6
000FFE 4FFE 32EFF2          13      LD  (_DIR_BANK),A
001001 5001 5E               7      LD  E,(HL)  ;FCB[6]
001002 5002 23               6      INC HL  ;+7
001003 5003 56               7      LD  D,(HL)  ;FCB[7]
001004 5004 23               6      INC HL  ;+8
001005 5005 ED53CAF2        20      LD  (RR_LOW),DE
001009 5009 7E               7      LD  A,(HL)  ;FCB[8]
00100A 500A 23               6      INC HL  ;+9
00100B 500B 32CCF2          13      LD  (RR_HIGH),A
00100E 500E 22D4F2          16      LD  (_DTA),HL   ;FCB[9]
001011 5011 D1              10      POP DE
001012 5012 C9              10      RET
                                
       5013                     SET_BASIC_FCB:
001013 5013 E5              11      PUSH    HL
001014 5014 2A64F8          16      LD  HL,(PTRFIL)
001017 5017 23               6      INC HL  ;+1
001018 5018 D5              11      PUSH    DE
001019 5019 ED5BEDF2        20      LD  DE,(DIRENT1)
00101D 501D 73               7      LD  (HL),E  ;FCB[1]
00101E 501E 23               6      INC HL  ;+2
00101F 501F 72               7      LD  (HL),D  ;FCB[2]
001020 5020 23               6      INC HL  ;+3
001021 5021 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
001022 5022 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
001023 5023 23               6      INC HL  ;+5
001024 5024 3AEFF2          13      LD  A,(_DIR_BANK)
001027 5027 77               7      LD  (HL),A  ;FCB[5]
001028 5028 23               6      INC HL  ;+6
001029 5029 ED5BCAF2        20      LD  DE,(RR_LOW)
00102D 502D 73               7      LD  (HL),E  ;FCB[6]
00102E 502E 23               6      INC HL  ;+7
00102F 502F 72               7      LD  (HL),D  ;FCB[7]
001030 5030 23               6      INC HL  ;+8
001031 5031 3ACCF2          13      LD  A,(RR_HIGH)
001034 5034 77               7      LD  (HL),A  ;FCB[8]
001035 5035 D1              10      POP DE
001036 5036 E1              10      POP HL
001037 5037 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_18:BACKUP
                                ;in
                                ;   C : backup charactor
                                ;   HL: FBC pointer
                                ;out
       5038                     DEVICE_18_BACKUP:
001038 5038 D5              11      PUSH    DE
001039 5039 E5              11      PUSH    HL
00103A 503A 110300          10      LD  DE,3
00103D 503D 19              11      ADD HL,DE
00103E 503E 71               7      LD  (HL),C
00103F 503F E1              10      POP HL
001040 5040 D1              10      POP DE
001041 5041 C9              10      RET
                                
       5042                     DEVICE_CHECK:
001042 5042 3A8AFD          13      LD  A,(PROCNM+1)
001045 5045 B7               4      OR  A
001046 5046 C8              11      RET Z
001047 5047 11D451          10      LD  DE,STR_ROM
00104A 504A CDA651          17      CALL    CPPROCNM
00104D 504D 2802            12      JR  Z,DEVICE_OK
00104F 504F 37               4      SCF
001050 5050 C9              10      RET
       5051                     DEVICE_OK:
001051 5051 AF               4      XOR A
001052 5052 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファ
                                
       5053                     DEVICE_0_OPEN:
001053 5053 7B               4      LD  A,E
001054 5054 FE02             7      CP  2       ;FOR OUTPUT
001056 5056 281B            12      JR  Z,OPEN2
001058 5058 D5              11      PUSH    DE
001059 5059 E5              11      push    hl
                                ;
00105A 505A 3E01             7      LD  A,1     ;ドライブA
00105C 505C 32F8F2          13      LD  (FDRV),A
00105F 505F 2166F8          10      LD  HL,FILNAM
001062 5062 11F9F2          10      LD  DE,FNAME
001065 5065 010B00          10      LD  BC,8+3
001068 5068 CDF757          17      CALL    INIT_FILE1
00106B 506B CDC14C          17      CALL    ROM_OPEN
00106E 506E DAF646          10      JP  C,ERROR_FILE_NOT_FOUND
001071 5071 E1              10      pop hl
001072 5072 D1              10      POP DE
       5073                     OPEN2:
001073 5073 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
001076 5076 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
001077 5077 AF               4      XOR A
001078 5078 32F0F2          13      LD  (LEFTX),A
00107B 507B CD1350          17      CALL    SET_BASIC_FCB
00107E 507E 7B               4      ld  a,e
00107F 507F FE08             7      cp  8
001081 5081 3F               4      ccf
001082 5082 C9              10      ret
                                
       5083                     DEVICE_2_CLOSE:
001083 5083 AF               4      XOR A
                                ;   LD  (HL),A
001084 5084 6F               4      LD  L,A
001085 5085 67               4      LD  H,A
001086 5086 2264F8          16      LD  (PTRFIL),HL
001089 5089 C9              10      RET
                                
       508A                     DEVICE_ENTRY:
00108A 508A FE08             7      CP  8
00108C 508C 2826            12      JR  Z,DEVICE_8_SIN
00108E 508E 3C               4      INC A
00108F 508F 28B1            12      JR  Z,DEVICE_CHECK:
001091 5091 3D               4      DEC A
001092 5092 28BF            12      JR  Z,DEVICE_0_OPEN
001094 5094 FE0E             7      CP  14
001096 5096 2860            12      JR  Z,DEVICE_14_EOF
001098 5098 FE04             7      CP  4
00109A 509A 2834            12      JR  Z,DEVICE_4_RANDOM
00109C 509C FE0A             7      CP  10
00109E 509E 2850            12      JR  Z,DEVICE_10_LOC
0010A0 50A0 FE0C             7      CP  12
0010A2 50A2 2878            12      JR  Z,DEVICE_12_LOF
0010A4 50A4 FE02             7      CP  2
0010A6 50A6 2890            12      JR  Z,DEVICE_18_BACKUP  
0010A8 50A8 FE02             7      CP  2
0010AA 50AA 28D7            12      JR  Z,DEVICE_2_CLOSE
0010AC 50AC FE06             7      CP  6
0010AE 50AE 2802            12      JR  Z,DEVICE_6_SOUT
0010B0 50B0 37               4      SCF
0010B1 50B1 C9              10      RET
                                
       50B2                     DEVICE_6_SOUT:
0010B2 50B2 AF               4      XOR A
0010B3 50B3 C9              10      RET
                                
       50B4                     DEVICE_8_SIN:
0010B4 50B4 CDF04F          17      CALL    GET_BASIC_FCB
0010B7 50B7 210100          10      LD  HL,1
0010BA 50BA CDA14A          17      CALL    ROM_READ
0010BD 50BD 7C               4      LD  A,H
0010BE 50BE B5               4      OR  L
0010BF 50BF 280D            12      JR  Z,CCF_RET
0010C1 50C1 2AD4F2          16      LD  HL,(_DTA)
0010C4 50C4 7E               7      LD  A,(HL)
0010C5 50C5 F5              11      PUSH    AF
0010C6 50C6 CD1350          17      CALL    SET_BASIC_FCB
0010C9 50C9 F1              10      POP AF
0010CA 50CA FE0A             7      CP  00AH
0010CC 50CC C8              11      RET Z   ;ZF=separate
                                ;   CP  01AH
                                ;   JR  Z,SCF_RET
0010CD 50CD 37               4      SCF     ;
       50CE                     CCF_RET:
0010CE 50CE 3F               4      CCF     ;ZF=0 CF=0にしたい
0010CF 50CF C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_4:RANDOM
                                ;in
                                ;   A : 4
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
       50D0                     DEVICE_4_RANDOM:
0010D0 50D0 D5              11      PUSH    DE
0010D1 50D1 CDF04F          17      CALL    GET_BASIC_FCB
0010D4 50D4 DDE5            15      PUSH    IX
0010D6 50D6 DD218A2F        14      LD  IX,FRCINT
0010DA 50DA FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0010DE 50DE CDB0F2          17      CALL    CAL_MP
0010E1 50E1 DDE1            14      POP IX
0010E3 50E3 2AF8F7          16      LD  HL,(DACDAT)
0010E6 50E6 22CAF2          16      LD  (RR_LOW),HL
0010E9 50E9 AF               4      XOR A
0010EA 50EA CD1350          17      CALL    SET_BASIC_FCB
0010ED 50ED D1              10      POP DE
0010EE 50EE AF               4      XOR A
0010EF 50EF C9              10      RET
                                
                                ;FUNC_10:LOC
                                ;in
                                ;   A : 10
                                ;out
                                ;   DAC    : value of received bytes
                                ;   VALTYP : DAC type
       50F0                     DEVICE_10_LOC:
0010F0 50F0 CDF04F          17      CALL    GET_BASIC_FCB
0010F3 50F3 2ACAF2          16      LD  HL,(RR_LOW)
0010F6 50F6 183D            12      JR  RETURN_TYPE8_AHL
                                
                                ;--------------------------------------
                                ;FUNC_14:EOF
                                ;in
                                ;   A : 14
                                ;out
                                ;   DAC    : value of EOF value (EOF=-1)
                                ;   VALTYP : DAC type
       50F8                     DEVICE_14_EOF:
0010F8 50F8 CDF04F          17      CALL    GET_BASIC_FCB
0010FB 50FB CD534D          17      CALL    RBX1
0010FE 50FE 3810            12      JR  C,DEVICE_14_EOF1
001100 5100 210100          10      LD  HL,1
001103 5103 CDA14A          17      CALL    ROM_READ
001106 5106 2AD4F2          16      LD  HL,(_DTA)
001109 5109 7E               7      LD  A,(HL)
00110A 510A FE1A             7      CP  01AH
00110C 510C 37               4      SCF
00110D 510D 2801            12      JR  Z,DEVICE_14_EOF1
00110F 510F 3F               4      CCF
       5110                     DEVICE_14_EOF1:
001110 5110 9F               4      SBC A,A
001111 5111 6F               4      LD  L,A
001112 5112 67               4      LD  H,A
       5113                     return_type2_hl:
001113 5113 22F8F7          16      ld  (DACDAT),hl
001116 5116 3E02             7      ld  a,2
001118 5118 3263F6          13      ld  (VALTYP),a
00111B 511B C9              10      ret
                                
                                ;--------------------------------------
                                ;FUNC_16:FPOS
                                ;in
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
                                ;   illegal function call
                                
                                ;--------------------------------------
                                ;FUNC_12:LOF
                                ;in
                                ;   A : 12
                                ;out
                                ;   DAC    : value of LOC+RSIQLN
                                ;   VALTYP : DAC type
       511C                     DEVICE_12_LOF:
00111C 511C CDF04F          17      CALL    GET_BASIC_FCB
                                
00111F 511F 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001CH
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    CALL    RDSLT_ROM
                                    EX  DE,HL       ;AHL=File size
                                    POP DE
                                #else
001122 5122 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
001125 5125 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
001128 5128 FD2AEDF2        20      LD  IY,(DIRENT1)
00112C 512C FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
00112F 512F FD661D          19      LD  H,(IY+01DH)
001132 5132 FD7E1E          19      LD  A,(IY+01EH)
                                #endif
       5135                     RETURN_TYPE8_AHL:
001135 5135 B7               4      OR  A
001136 5136 2004            12      JR  NZ,RT8AHL1
001138 5138 CB7C             8      BIT 7,H
00113A 513A 28D7            12      JR  Z,return_type2_hl
       513C                     RT8AHL1:
00113C 513C E5              11      PUSH    HL
00113D 513D 29              11      ADD HL,HL
00113E 513E 8F               4      ADC A,A
00113F 513F 32F8F7          13      LD  (DACDAT),A
001142 5142 3E00             7      LD  A,0
001144 5144 8F               4      ADC A,A
001145 5145 32F9F7          13      LD  (DACDAT+1),A
                                
001148 5148 3E02             7      LD  A,2
00114A 514A 3263F6          13      LD  (VALTYP),A
00114D 514D DD213A30        14      LD  IX,FRCDBL
001151 5151 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001155 5155 CDB0F2          17      CALL    CAL_MP
                                
001158 5158 219E51          10      LD  HL,DBL32768
00115B 515B 1147F8          10      LD  DE,ARG
00115E 515E 010800          10      LD  BC,8
001161 5161 EDB0                    LDIR
                                
001163 5163 DD21E627        14      LD  IX,DECMUL
001167 5167 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00116B 516B CDB0F2          17      CALL    CAL_MP
                                
00116E 516E 21F6F7          10      LD  HL,DAC
001171 5171 1147F8          10      LD  DE,ARG
001174 5174 010800          10      LD  BC,8
001177 5177 EDB0                    LDIR
                                
001179 5179 E1              10      POP HL
00117A 517A 22F8F7          16      LD  (DACDAT),HL
                                
00117D 517D 3E02             7      LD  A,2
00117F 517F 3263F6          13      LD  (VALTYP),A
001182 5182 DD213A30        14      LD  IX,FRCDBL
001186 5186 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00118A 518A CDB0F2          17      CALL    CAL_MP
                                
00118D 518D DD219A26        14      LD  IX,DECADD
001191 5191 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001195 5195 CDB0F2          17      CALL    CAL_MP
                                
001198 5198 3E08             7      LD  A,8
00119A 519A 3263F6          13      LD  (VALTYP),A
00119D 519D C9              10      RET
                                
       519E                     DBL32768:
00119E 519E 4532768000000000        DB  045H,032H,076H,080H,0,0,0,0
                                
       51A6                     CPPROCNM:
0011A6 51A6 E5              11      PUSH    HL
0011A7 51A7 2189FD          10      LD  HL,PROCNM
       51AA                     CPPROCNM1:
0011AA 51AA 1A               7      LD  A,(DE)
0011AB 51AB 13               6      INC DE
0011AC 51AC BE               7      CP  (HL)
0011AD 51AD 23               6      INC HL
0011AE 51AE 2003            12      JR  NZ,CPPROCNM2
0011B0 51B0 B7               4      OR  A
0011B1 51B1 20F7            12      JR  NZ,CPPROCNM1
       51B3                     CPPROCNM2:
0011B3 51B3 E1              10      POP HL
0011B4 51B4 C9              10      RET
                                
       51B5                     WILDCARD:
0011B5 51B5 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       51C0                     STR_CHDIR:
0011C0 51C0 434844495200            DB  "CHDIR",0
       51C6                     STR_CHDRV:
0011C6 51C6 434844525600            DB  "CHDRV",0
       51CC                     STR_RAMDISK:
0011CC 51CC 52414D4449534B00        DB  "RAMDISK",0
       51D4                     STR_ROM:
0011D4 51D4 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       51D8                     ERROR_WRITE_PROTECTED:
0011D8 51D8 3E00             7      LD  A,0     ;Write protected
0011DA 51DA C9              10      RET
       51DB                     DISKIO:
0011DB 51DB 38FB            12      JR  C,ERROR_WRITE_PROTECTED
0011DD 51DD 48               4      LD  C,B
0011DE 51DE CDAD53          17      CALL    GET_DISK_BANK
       51E1                     SETMAP1:        
0011E1 51E1 E5              11      PUSH    HL
       51E2                     DISKIO1:
0011E2 51E2 C5              11      PUSH    BC      ;B=残りのセクタ数
0011E3 51E3 D5              11      PUSH    DE      ;DE=セクタ番号
0011E4 51E4 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
0011E5 51E5 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
0011E6 51E6 F5              11      PUSH    AF
0011E7 51E7 3AC9F2          13      LD  A,(SECSZ_H)
0011EA 51EA CDD353          17      CALL    MUL_AHL
0011ED 51ED F1              10      POP AF
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  A,L
                                    PUSH    BC
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    POP BC
                                    JR  NC,DISKIO2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
0011EE 51EE 4D               4      LD  C,L     ;C=読み出し元
0011EF 51EF 29              11      ADD HL,HL       ;64KB→32KB
0011F0 51F0 29              11      ADD HL,HL       ;32KB→16KB
0011F1 51F1 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
0011F2 51F2 84               4      ADD A,H
0011F3 51F3 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0011F6 51F6 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0011F9 51F9 32C4F2          13      LD  (_BANK),A
0011FC 51FC 79               4      LD  A,C     ;C=読み出し元
0011FD 51FD E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       51FF                     DISKIO2:
0011FF 51FF C660             7      ADD A,high BANK1_ADR
001201 5201 67               4      LD  H,A
001202 5202 ED4BC8F2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
001206 5206 69               4      LD  L,C     ;C=0
001207 5207 CD1745          17      CALL    ROM_LDIR
00120A 520A EB               4      EX  DE,HL
00120B 520B F1              10      POP AF
00120C 520C D1              10      POP DE
00120D 520D 13               6      INC DE
00120E 520E C1              10      POP BC
00120F 520F 10D1            13      DJNZ    DISKIO1
001211 5211 41               4      LD  B,C
                                
001212 5212 E1              10      POP HL
001213 5213 AF               4      XOR A
                                
001214 5214 FB               4      EI
001215 5215 C9              10      RET
                                
       5216                     DSKCHG:
001216 5216 CD4F52          17      CALL    IS_BPB
001219 5219 3824            12      JR  C,NOTREADY
00121B 521B 3A23FB          13      LD  A,(DRVTBL+2)
00121E 521E B7               4      OR  A
00121F 521F 201A            12      JR  NZ,DSKCHG1
001221 5221 3A21FB          13      LD  A,(DRVTBL)
001224 5224 FE02             7      CP  2
001226 5226 2013            12      JR  NZ,DSKCHG1
001228 5228 CD4F52          17      CALL    IS_BPB
00122B 522B 300E            12      JR  NC,DSKCHG1
00122D 522D 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
00122F 522F 3221FB          13      LD  (DRVTBL),A
001232 5232 3223FB          13      LD  (DRVTBL+2),A
001235 5235 3A48F3          13      LD  A,(MASTERS)
001238 5238 3224FB          13      LD  (DRVTBL+3),A
       523B                     DSKCHG1:
00123B 523B AF               4      XOR A
00123C 523C 0601             7      LD  B,1
00123E 523E C9              10      RET
       523F                     NOTREADY:
00123F 523F 3E02             7      LD  A,2
001241 5241 37               4      SCF
001242 5242 C9              10      RET
                                
       5243                     NO_BPB:
001243 5243 E1              10      POP HL
001244 5244 23               6      INC HL
001245 5245 11D953          10      LD  DE,DPB2DD
001248 5248 011200          10      LD  BC,DPB2DD_E-DPB2DD
00124B 524B EDB0                    LDIR
00124D 524D AF               4      XOR A
00124E 524E C9              10      RET
                                
       524F                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
00124F 524F CDAD53          17      CALL    GET_DISK_BANK
                                
001252 5252 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
001255 5255 FE01             7      CP  1
001257 5257 D8              11      RET C
                                
001258 5258 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
00125B 525B C6FF             7      ADD A,0FFH
00125D 525D D8              11      RET C
                                
00125E 525E 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       5261                     IS_BPB1:
001261 5261 FE01             7      CP  1
001263 5263 C8              11      RET Z
001264 5264 FE02             7      CP  2
001266 5266 C8              11      RET Z
001267 5267 FE04             7      CP  4
001269 5269 C8              11      RET Z
00126A 526A 37               4      SCF
00126B 526B C9              10      RET
                                
       526C                     GETDPB:
00126C 526C E5              11      PUSH    HL
00126D 526D CDAD53          17      CALL    GET_DISK_BANK
                                
001270 5270 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
001273 5273 B7               4      OR  A
001274 5274 28CD            12      JR  Z,NO_BPB
001276 5276 DDE1            14      POP IX
001278 5278 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
00127B 527B 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
00127E 527E DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
001281 5281 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
001284 5284 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
001287 5287 87               4      ADD A,A
001288 5288 87               4      ADD A,A
001289 5289 87               4      ADD A,A
00128A 528A 3D               4      DEC A
00128B 528B DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
00128E 528E 06FF             7      LD  B,-1
001290 5290 A7               4      AND A           ;無限ループ阻止
       5291                     GETDPB1:
001291 5291 04               4      INC B
001292 5292 1F               4      RRA
001293 5293 38FC            12      JR  C,GETDPB1
001295 5295 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
001298 5298 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
00129B 529B 3D               4      DEC A
00129C 529C DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
00129F 529F A7               4      AND A           ;無限ループ阻止
0012A0 52A0 06FF             7      LD  B,-1
       52A2                     GETDPB2:
0012A2 52A2 04               4      INC B
0012A3 52A3 1F               4      RRA
0012A4 52A4 38FC            12      JR  C,GETDPB2
0012A6 52A6 04               4      INC B
0012A7 52A7 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
0012AA 52AA 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
0012AD 52AD DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
0012B0 52B0 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
0012B3 52B3 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
0012B6 52B6 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
0012B9 52B9 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
0012BC 52BC DD770B          19      LD  (IX+11),A       ;MAXENT
                                
0012BF 52BF ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
0012C3 52C3 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
0012C6 52C6 DD460A          19      LD  B,(IX+10)       ;FATCNT
0012C9 52C9 210000          10      LD  HL,0
       52CC                     GETDPB3:
0012CC 52CC 19              11      ADD HL,DE
0012CD 52CD 10FD            13      DJNZ    GETDPB3
       52CF                     GETDPB4:
0012CF 52CF DD5E08          19      LD  E,(IX+8)        ;FIRFAT
0012D2 52D2 DD5609          19      LD  D,(IX+9)        ;FIRFAT
0012D5 52D5 19              11      ADD HL,DE
0012D6 52D6 DD7511          19      LD  (IX+17),L       ;FIRDIR
0012D9 52D9 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
0012DC 52DC DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0012DF 52DF 87               4      ADD A,A
0012E0 52E0 87               4      ADD A,A
0012E1 52E1 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       52E4                     GETDPB5:
0012E4 52E4 CB3B             8      SRL E
0012E6 52E6 1F               4      RRA
0012E7 52E7 30FB            12      JR  NC,GETDPB5
0012E9 52E9 1600             7      LD  D,0
0012EB 52EB 19              11      ADD HL,DE
0012EC 52EC DD750C          19      LD  (IX+12),L       ;FIRREC
0012EF 52EF DD740D          19      LD  (IX+13),H       ;FIRREC
                                
0012F2 52F2 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
0012F5 52F5 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
0012F8 52F8 DD560D          19      LD  D,(IX+13)       ;FIRREC
0012FB 52FB A7               4      AND A
0012FC 52FC ED52            15      SBC HL,DE
                                
0012FE 52FE DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
001301 5301 3C               4      INC A
001302 5302 37               4      SCF             ;無限ループ阻止
       5303                     GETDPB6:
001303 5303 1F               4      RRA
001304 5304 3806            12      JR  C,GETDPB7
001306 5306 CB3C             8      SRL H
001308 5308 CB1D             8      RR  L
00130A 530A 18F7            12      JR  GETDPB6
       530C                     GETDPB7:
00130C 530C 23               6      INC HL
00130D 530D DD750E          19      LD  (IX+14),L       ;MAXCLUS
001310 5310 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       5313                     GETDPBD1:
001313 5313 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001316 5316 E6FC             7      AND 0FCH
001318 5318 C8              11      RET Z
                                
001319 5319 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
00131D 531D 37               4      SCF
00131E 531E DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
001322 5322 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
001325 5325 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
001329 5329 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
00132D 532D DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
001331 5331 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
001335 5335 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
001339 5339 DDCB1126        23      SLA (IX+17)         ;FIRDIR
00133D 533D DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
001341 5341 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
001344 5344 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
001347 5347 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
00134A 534A 87               4      ADD A,A
00134B 534B 87               4      ADD A,A
00134C 534C DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       534F                     GETDPBD5:
00134F 534F CB3B             8      SRL E
001351 5351 1F               4      RRA
001352 5352 30FB            12      JR  NC,GETDPBD5
001354 5354 1600             7      LD  D,0
001356 5356 19              11      ADD HL,DE
001357 5357 DD750C          19      LD  (IX+12),L       ;FIRREC
00135A 535A DD740D          19      LD  (IX+13),H       ;FIRREC
                                
00135D 535D 18B4            12      JR  GETDPBD1
                                
       535F                     CHOICE:
00135F 535F 210000          10      LD  HL,0
001362 5362 C9              10      RET
                                
       5363                     DSKFMT:
001363 5363 AF               4      XOR A
001364 5364 37               4      SCF
       5365                     DSKSTP:
001365 5365 C9              10      RET
                                
       5366                     BASENT:
001366 5366 2A74F6          16      LD  HL,(STKTOP)
001369 5369 3A40F3          13      LD  A,(REBOOT)
00136C 536C C6FF             7      ADD A,0FFH
00136E 536E 3811            12      JR  C,REBOOT1
001370 5370 21EB53          10      LD  HL,AUTOEXEC
001373 5373 11F8F2          10      LD  DE,FDRV
001376 5376 010C00          10      LD  BC,1+8+3
001379 5379 EDB0                    LDIR
00137B 537B CDC14C          17      CALL    ROM_OPEN
00137E 537E D44046          17      CALL    NC,ROM_LOAD1
       5381                     REBOOT1:
001381 5381 21F753          10      LD  HL,CMD_RUN
001384 5384 111FF4          10      LD  DE,KBUF
001387 5387 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
00138A 538A D5              11      PUSH    DE
00138B 538B EDB0                    LDIR
00138D 538D 3004            12      JR  NC,REBOOT2
00138F 538F AF               4      XOR A
001390 5390 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       5393                     REBOOT2:
001393 5393 E1              10      POP HL
001394 5394 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
001398 5398 DD210146        14      LD  IX,NEWSTT
00139C 539C C31C00          10      JP  _CALSLT
                                
       539F                     GETSLT:
00139F 539F 3A22FB          13      LD  A,(DRVTBL+1)
0013A2 53A2 C9              10      RET
                                
       53A3                     GET_DISK_BANK_FDRV:
0013A3 53A3 3AF8F2          13      LD  A,(FDRV)
0013A6 53A6 D601             7      SUB 1
0013A8 53A8 3003            12      JR  NC,GET_DISK_BANK
0013AA 53AA 3AEAF2          13      LD  A,(_DVSW)
       53AD                     GET_DISK_BANK:
0013AD 53AD FE07             7      CP  7       ;H:
0013AF 53AF 2801            12      JR  Z,SET_DISK_BANK_A
0013B1 53B1 B7               4      OR  A       ;A=DRIVE
       53B2                     SET_DISK_BANK_A:
0013B2 53B2 3E01             7      LD  A,DISK_BANK
0013B4 53B4 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
0013B6 53B6 3AE9F2          13      LD  A,(B_DRIVE)
                                #endif
       53B9                     SET_DISK_BANK:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0013B9 53B9 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0013BC 53BC 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0013BF 53BF F5              11      PUSH    AF
0013C0 53C0 E5              11      PUSH    HL
0013C1 53C1 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
0013C4 53C4 22C8F2          16      LD  (SECSZ),HL
0013C7 53C7 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0013CA 53CA CDD353          17      CALL    MUL_AHL
0013CD 53CD 22C6F2          16      LD  (CLSZ),HL
0013D0 53D0 E1              10      POP HL
0013D1 53D1 F1              10      POP AF
0013D2 53D2 C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       53D3                     MUL_AHL:
0013D3 53D3 37               4      SCF     ;無限ループ回避
       53D4                     MUL_AHL1:
0013D4 53D4 1F               4      RRA     ;->CF
0013D5 53D5 D8              11      RET C
0013D6 53D6 29              11      ADD HL,HL
0013D7 53D7 18FB            12      JR  MUL_AHL1
                                
       53D9                     DPB2DD:
0013D9 53D9 F9                      DB  0F9H    ;MEDIA
0013DA 53DA 0002                    DW  00200H  ;SECSIZ
0013DC 53DC 0F                      DB  00FH    ;DIRMSK
0013DD 53DD 04                      DB  004H    ;DIRSHFT
0013DE 53DE 01                      DB  001H    ;CLUSMSK
0013DF 53DF 02                      DB  002H    ;CLUSSHFT
0013E0 53E0 0100                    DW  00001H  ;FIRFAT
0013E2 53E2 02                      DB  002H    ;FATCNT
0013E3 53E3 70                      DB  070H    ;MAXENT
0013E4 53E4 0E00                    DW  0000EH  ;FIRREC
0013E6 53E6 CA02                    DW  002CAH  ;MAXCLUS
0013E8 53E8 03                      DB  003H    ;FATSIZ
0013E9 53E9 0700                    DW  0007H   ;FIRDIR
       53EB                     DPB2DD_E:
                                
       53EB                     AUTOEXEC:
0013EB 53EB 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       53F7                     CMD_RUN:
0013F7 53F7 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DW  0F280H
                                #else
0013FD 53FD 40F2                    DW  0F240H
                                #endif
       53FF                     CMD_CLEAR_E:
0013FF 53FF 3A8A00                  DB  03AH,08AH,0         ;RUN
       5402                     CMD_RUN_E:
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       5402                     POP_HL_ERROR:
001402 5402 E1              10      POP     HL
       5403                     _ERROR:
001403 5403 0600             7      LD  B,0
001405 5405 A7               4      AND A
001406 5406 C9              10      RET
                                
       5407                     ROM_BDOS:
001407 5407 E5              11      PUSH    HL
001408 5408 79               4      LD  A,C
001409 5409 87               4      ADD A,A
00140A 540A 38F7            12      JR  C,_ERROR
00140C 540C 6F               4      LD  L,A
00140D 540D 265F             7      LD  H,high STABLE
00140F 540F 7E               7      LD  A,(HL)
001410 5410 2C               4      INC L
001411 5411 66               7      LD  H,(HL)
001412 5412 6F               4      LD  L,A
001413 5413 E3              19      EX  (SP),HL
001414 5414 79               4      LD  A,C
001415 5415 C9              10      RET
                                
       5416                     _PRINT:
       5416                     PRINT:
001416 5416 7B               4      LD  A,E
001417 5417 1803            12      JR  MSG_A
                                
       5419                     _SYS01:     ;(BDOS)コンソール入力
001419 5419 CD9E54          17      CALL    _SYS07
       541C                     MSG_A:
00141C 541C FE03             7      CP  3
00141E 541E 2814            12      JR  Z,MSG_BR
       5420                     MSGA1:
001420 5420 F5              11      PUSH    AF
001421 5421 C5              11      PUSH    BC
001422 5422 D5              11      PUSH    DE
001423 5423 E5              11      PUSH    HL
001424 5424 DDE5            15      PUSH    IX
001426 5426 DD21A200        14      LD  IX,CHPUT
00142A 542A CD0144          17      CALL    CALSLT_R
00142D 542D DDE1            14      POP IX
00142F 542F E1              10      POP HL
001430 5430 D1              10      POP DE
001431 5431 C1              10      POP BC
       5432                     MSGA2:
001432 5432 F1              10      POP AF
001433 5433 C9              10      RET
       5434                     MSG_BR:
001434 5434 F5              11      PUSH    AF
001435 5435 3ADDF3          13      LD  A,(CSRX)
001438 5438 FE02             7      CP  2
00143A 543A 38F6            12      JR  C,MSGA2
00143C 543C F1              10      POP AF
       543D                     MSG_CR:
00143D 543D F5              11      PUSH    AF
00143E 543E 3E0D             7      LD  A,00DH
001440 5440 CD2054          17      CALL    MSGA1
001443 5443 3E0A             7      LD  A,00AH
001445 5445 CD2054          17      CALL    MSGA1
001448 5448 F1              10      POP AF
001449 5449 C9              10      RET
                                
       544A                     _SYS02:     ;(BDOS)コンソール出力
00144A 544A CD6554          17      CALL    BREAK
00144D 544D 1805            12      JR  PRINTX
                                
       544F                     _SYS06:     ;(BDOS)コンソール直接入出力
00144F 544F 7B               4      LD  A,E
001450 5450 3C               4      INC A
001451 5451 CAB254          10      JP  Z,_INKEY
       5454                     PRINTX:
001454 5454 C31654          10      JP  _PRINT
                                
       5457                     _SYS08:     ;(BDOS)エコーなしコンソール入力
001457 5457 CD9E54          17      CALL    _SYS07
00145A 545A FE03             7      CP  3
00145C 545C CC6554          17      CALL    Z,_BREAK
00145F 545F FE13             7      CP  013H        ;CTRL+S
001461 5461 C0              11      RET NZ
       5462                     PAUSE:
001462 5462 CD7C54          17      CALL    KEYBC
                                
       5465                     _BREAK:
       5465                     BREAK:
001465 5465 F5              11      PUSH    AF
001466 5466 C5              11      PUSH    BC
001467 5467 D5              11      PUSH    DE
001468 5468 E5              11      PUSH    HL
001469 5469 DDE5            15      PUSH    IX
00146B 546B DD21B700        14      LD  IX,BREAKX
00146F 546F CD0144          17      CALL    CALSLT_R
001472 5472 DDE1            14      POP IX
001474 5474 E1              10      POP HL
001475 5475 D1              10      POP DE
001476 5476 C1              10      POP BC
001477 5477 DC6554          17      CALL    C,_BREAK
00147A 547A F1              10      POP AF
00147B 547B C9              10      RET
       547C                     KEYBC:
00147C 547C F5              11      PUSH    AF
00147D 547D C5              11      PUSH    BC
00147E 547E D5              11      PUSH    DE
00147F 547F E5              11      PUSH    HL
001480 5480 DDE5            15      PUSH    IX
001482 5482 DD215601        14      LD  IX,KILBUF
001486 5486 CD0144          17      CALL    CALSLT_R
001489 5489 DDE1            14      POP IX
00148B 548B E1              10      POP HL
00148C 548C D1              10      POP DE
00148D 548D C1              10      POP BC
00148E 548E F1              10      POP AF
00148F 548F C9              10      RET
                                
       5490                     _SYS09:     ;(BDOS)文字列出力
001490 5490 D5              11      PUSH    DE
       5491                     _SX09:
001491 5491 1A               7      LD  A,(DE)
001492 5492 13               6      INC DE
001493 5493 FE24             7      CP  '$'
001495 5495 2805            12      JR  Z,POPDE_RET
001497 5497 CD1C54          17      CALL    MSG_A
00149A 549A 18F5            12      JR  _SX09
       549C                     POPDE_RET:
00149C 549C D1              10      POP DE
00149D 549D C9              10      RET
                                
       549E                     _SYS07:
       549E                     FLGET:
00149E 549E C5              11      PUSH    BC
00149F 549F D5              11      PUSH    DE
0014A0 54A0 E5              11      PUSH    HL
0014A1 54A1 DDE5            15      PUSH    IX
0014A3 54A3 DD219F00        14      LD  IX,CHGET
0014A7 54A7 CD0144          17      CALL    CALSLT_R
0014AA 54AA DDE1            14      POP IX
0014AC 54AC E1              10      POP HL
0014AD 54AD D1              10      POP DE
0014AE 54AE C1              10      POP BC
0014AF 54AF FE03             7      CP  3
0014B1 54B1 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       54B2                     _INKEY:
       54B2                     INKEY:
0014B2 54B2 CD4C55          17      CALL    CPM_CONST
0014B5 54B5 C8              11      RET Z
0014B6 54B6 18E6            12      JR  FLGET
                                
       54B8                     _SYS0A:     ;(BDOS)文字列入力
0014B8 54B8 C5              11      PUSH    BC
0014B9 54B9 E5              11      PUSH    HL
0014BA 54BA D5              11      PUSH    DE
0014BB 54BB CDE454          17      CALL    GETL
0014BE 54BE 111FF4          10      LD  DE,KBUF
0014C1 54C1 E1              10      POP HL
0014C2 54C2 E5              11      PUSH    HL
0014C3 54C3 0E00             7      LD  C,0
0014C5 54C5 3004            12      JR  NC,SAX0
0014C7 54C7 23               6      INC HL
0014C8 54C8 23               6      INC HL
0014C9 54C9 1808            12      JR  SAX4
       54CB                     SAX0:
0014CB 54CB 46               7      LD  B,(HL)
0014CC 54CC 23               6      INC HL
       54CD                     SAX1:
0014CD 54CD 23               6      INC HL
0014CE 54CE 1A               7      LD  A,(DE)
0014CF 54CF 13               6      INC DE
0014D0 54D0 B7               4      OR  A
0014D1 54D1 2004            12      JR  NZ,SAX2
       54D3                     SAX4:
0014D3 54D3 360D            10      LD  (HL),00DH
0014D5 54D5 1804            12      JR  SAX3
       54D7                     SAX2:
0014D7 54D7 77               7      LD  (HL),A
0014D8 54D8 0C               4      INC C
0014D9 54D9 10F2            13      DJNZ    SAX1
       54DB                     SAX3:
0014DB 54DB D1              10      POP DE
0014DC 54DC 79               4      LD  A,C
0014DD 54DD 13               6      INC DE
0014DE 54DE 12               7      LD  (DE),A
0014DF 54DF 1B               6      DEC DE
0014E0 54E0 E1              10      POP HL
0014E1 54E1 C1              10      POP BC
0014E2 54E2 A7               4      AND A
0014E3 54E3 C9              10      RET
       54E4                     GETL:
0014E4 54E4 DDE5            15      PUSH    IX
0014E6 54E6 FDE5            15      PUSH    IY
                                
0014E8 54E8 2ADCF3          16      LD  HL,(CSRY)
0014EB 54EB 22CAFB          16      LD  (FSTPOS),HL
       54EE                     GETL1:
0014EE 54EE CD5754          17      CALL    _SYS08
0014F1 54F1 FE09             7      CP  9
0014F3 54F3 2008            12      JR  NZ,GETL1V
0014F5 54F5 211FF4          10      LD  HL,KBUF
0014F8 54F8 CD9844          17      CALL    MSX
0014FB 54FB 18F1            12      JR  GETL1
       54FD                     GETL1V:
0014FD 54FD 5F               4      LD  E,A
0014FE 54FE FE08             7      CP  8
001500 5500 CCF955          17      CALL    Z,CTRL02
001503 5503 FE20             7      CP  020H
001505 5505 D42556          17      CALL    NC,INSERT
001508 5508 CD2054          17      CALL    MSGA1
                                
00150B 550B 7B               4      LD  A,E
00150C 550C FE0D             7      CP  00DH
00150E 550E 20DE            12      JR  NZ,GETL1
                                
001510 5510 111FF4          10      LD  DE,KBUF
001513 5513 3AB0F3          13      LD  A,(LINLEN)
001516 5516 47               4      LD  B,A
001517 5517 CD0958          17      CALL    ZERO_MEMORY_DE
                                
00151A 551A 2ACAFB          16      LD  HL,(FSTPOS)
00151D 551D 3ADCF3          13      LD  A,(CSRY)
001520 5520 6F               4      LD  L,A
001521 5521 E5              11      PUSH    HL
001522 5522 CD5656          17      CALL    LOC0
001525 5525 4D               4      LD  C,L
001526 5526 44               4      LD  B,H
001527 5527 E1              10      POP HL
001528 5528 3AB0F3          13      LD  A,(LINLEN)
00152B 552B 94               4      SUB H
00152C 552C 3D               4      DEC A
00152D 552D 5F               4      LD  E,A
00152E 552E 211FF4          10      LD  HL,KBUF
       5531                     GETL2:
001531 5531 CDE955          17      CALL    _SCRN
001534 5534 03               6      INC BC
001535 5535 77               7      LD  (HL),A
001536 5536 23               6      INC HL
001537 5537 1D               4      DEC E
001538 5538 20F7            12      JR  NZ,GETL2
00153A 553A CD3D54          17      CALL    MSG_CR
                                
00153D 553D FDE1            14      POP IY
00153F 553F DDE1            14      POP IX
       5541                     GETL3:
001541 5541 2B               6      DEC HL
001542 5542 7E               7      LD  A,(HL)
001543 5543 FE21             7      CP  021H
001545 5545 D0              11      RET NC
001546 5546 3600            10      LD  (HL),0
001548 5548 15               4      DEC D
001549 5549 20F6            12      JR  NZ,GETL3
00154B 554B C9              10      RET
                                
       554C                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       554C                     CONSTX:
       554C                     CPM_CONST:
00154C 554C C5              11      PUSH    BC
00154D 554D D5              11      PUSH    DE
00154E 554E E5              11      PUSH    HL
00154F 554F DDE5            15      PUSH    IX
001551 5551 DD219C00        14      LD  IX,CHSNS
001555 5555 CD0144          17      CALL    CALSLT_R
001558 5558 DDE1            14      POP IX
00155A 555A E1              10      POP HL
00155B 555B D1              10      POP DE
00155C 555C C1              10      POP BC
00155D 555D C9              10      RET
                                
       555E                     _SYS2A:     ;(BDOS)日付の獲得
00155E 555E 0E0B             7      LD  C,11        ;年/Year→HL
001560 5560 CD9F55          17      CALL    RDCLK_BCD
001563 5563 6F               4      LD  L,A
001564 5564 2600             7      LD  H,0
001566 5566 3AF8FA          13      LD  A,(EXBRSA)
001569 5569 B7               4      OR  A
00156A 556A 2804            12      JR  Z,SX2A1
00156C 556C 11BC07          10      LD  DE,1980     ;1980年～2079年
00156F 556F 19              11      ADD HL,DE
       5570                     SX2A1:
001570 5570 0E09             7      LD  C,9     ;月/Month→D
001572 5572 CD9F55          17      CALL    RDCLK_BCD
001575 5575 57               4      LD  D,A
                                
001576 5576 0E07             7      LD  C,7     ;日/Day→E
001578 5578 CD9F55          17      CALL    RDCLK_BCD
00157B 557B 5F               4      LD  E,A
                                
00157C 557C 0E06             7      LD  C,6     ;曜日/Week→A
       557E                     RDCLK:
00157E 557E DDE5            15      PUSH    IX
001580 5580 DD21F501        14      LD  IX,REDCLK
       5584                     WRCLK1:
001584 5584 3AF8FA          13      LD  A,(EXBRSA)
001587 5587 B7               4      OR  A
001588 5588 280A            12      JR  Z,RDCLK1    ;MSX1
00158A 558A FDE5            15      PUSH    IY
00158C 558C FD67             9      LD  IYH,A
00158E 558E 78               4      LD  A,B
00158F 558F CD1C00          17      CALL    _CALSLT
001592 5592 FDE1            14      POP IY
       5594                     RDCLK1:
001594 5594 DDE1            14      POP IX
001596 5596 C9              10      RET
       5597                     WRCLK:
001597 5597 DDE5            15      PUSH    IX
001599 5599 DD21F901        14      LD  IX,WRTCLK
00159D 559D 18E5            12      JR  WRCLK1
                                
       559F                     RDCLK_BCD:
00159F 559F CD7E55          17      CALL    RDCLK       ;1の位
0015A2 55A2 47               4      LD  B,A
0015A3 55A3 0C               4      INC C
0015A4 55A4 CD7E55          17      CALL    RDCLK       ;10の位
0015A7 55A7 87               4      ADD A,A     ;*2
0015A8 55A8 4F               4      LD  C,A
0015A9 55A9 87               4      ADD A,A     ;*4
0015AA 55AA 87               4      ADD A,A     ;*8
0015AB 55AB 81               4      ADD A,C     ;*10(8+2)
0015AC 55AC 80               4      ADD A,B     ;1の位
0015AD 55AD C9              10      RET
                                
       55AE                     _SYS2C:     ;(BDOS)時刻の獲得
0015AE 55AE 011501          10      LD  BC,00115H       ;12時間計/24時間計の設定を24時間計に
0015B1 55B1 CD9755          17      CALL    WRCLK
0015B4 55B4 0E04             7      LD  C,4     ;H=時/Hour
0015B6 55B6 CD9F55          17      CALL    RDCLK_BCD
0015B9 55B9 67               4      LD  H,A
0015BA 55BA 0E02             7      LD  C,2     ;L=分/Minute
0015BC 55BC CD9F55          17      CALL    RDCLK_BCD
0015BF 55BF 6F               4      LD  L,A
0015C0 55C0 0E00             7      LD  C,0     ;D=秒/Second
0015C2 55C2 CD9F55          17      CALL    RDCLK_BCD
0015C5 55C5 57               4      LD  D,A
0015C6 55C6 AF               4      XOR A       ;E=1/100秒
0015C7 55C7 5F               4      LD  E,A
0015C8 55C8 C9              10      RET
                                
       55C9                     POS:
0015C9 55C9 F5              11      PUSH    AF
0015CA 55CA 2ADCF3          16      LD  HL,(CSRY)
0015CD 55CD 7D               4      LD  A,L
0015CE 55CE 6C               4      LD  L,H
0015CF 55CF 67               4      LD  H,A
0015D0 55D0 2C               4      INC L
0015D1 55D1 24               4      INC H
0015D2 55D2 F1              10      POP AF
0015D3 55D3 C9              10      RET
                                
       55D4                     LOC:
0015D4 55D4 F5              11      PUSH    AF
0015D5 55D5 E5              11      PUSH    HL
0015D6 55D6 7D               4      LD  A,L
0015D7 55D7 6C               4      LD  L,H
0015D8 55D8 67               4      LD  H,A
0015D9 55D9 2D               4      DEC L
0015DA 55DA 25               4      DEC H
0015DB 55DB DDE5            15      PUSH    IX
0015DD 55DD DD21C600        14      LD  IX,POSIT
0015E1 55E1 CD0144          17      CALL    CALSLT_R
0015E4 55E4 DDE1            14      POP IX
0015E6 55E6 E1              10      POP HL
0015E7 55E7 F1              10      POP AF
0015E8 55E8 C9              10      RET
                                
       55E9                     _SCRN:
       55E9                     SCRN:
0015E9 55E9 E5              11      PUSH    HL
0015EA 55EA DDE5            15      PUSH    IX
                                
0015EC 55EC 69               4      LD  L,C
0015ED 55ED 60               4      LD  H,B
0015EE 55EE DD214A00        14      LD  IX,RDVRM
0015F2 55F2 CD0144          17      CALL    CALSLT_R
                                
0015F5 55F5 DDE1            14      POP IX
0015F7 55F7 E1              10      POP HL
0015F8 55F8 C9              10      RET
                                
       55F9                     CTRL02:
0015F9 55F9 F5              11      PUSH    AF
0015FA 55FA D5              11      PUSH    DE
0015FB 55FB 2ADCF3          16      LD  HL,(CSRY)
0015FE 55FE 3AB0F3          13      LD  A,(LINLEN)
001601 5601 4F               4      LD  C,A
001602 5602 94               4      SUB H   ;CSRX
001603 5603 C602             7      ADD A,2
001605 5605 47               4      LD  B,A ;カーソルより右の文字数
001606 5606 61               4      LD  H,C ;LINLEN
001607 5607 C5              11      PUSH    BC
001608 5608 CD5656          17      CALL    LOC0
00160B 560B C1              10      POP BC
                                
00160C 560C 1620             7      LD  D,020H
       560E                     C8X1:
00160E 560E DD214A00        14      LD  IX,RDVRM
001612 5612 CD0144          17      CALL    CALSLT_R
001615 5615 4F               4      LD  C,A
001616 5616 7A               4      LD  A,D
001617 5617 DD214D00        14      LD  IX,WRTVRM
00161B 561B CD0144          17      CALL    CALSLT_R
00161E 561E 2B               6      DEC HL
00161F 561F 51               4      LD  D,C
001620 5620 10EC            13      DJNZ    C8X1
001622 5622 D1              10      POP DE
001623 5623 F1              10      POP AF
001624 5624 C9              10      RET
                                
       5625                     INSERT:
001625 5625 F5              11      PUSH    AF
001626 5626 D5              11      PUSH    DE
001627 5627 2ADCF3          16      LD  HL,(CSRY)
00162A 562A 3AB0F3          13      LD  A,(LINLEN)
00162D 562D 4F               4      LD  C,A
00162E 562E 94               4      SUB H   ;CSRX
00162F 562F 3C               4      INC A
001630 5630 47               4      LD  B,A ;カーソルより右の文字数
001631 5631 C5              11      PUSH    BC
001632 5632 CD5656          17      CALL    LOC0
001635 5635 C1              10      POP BC
                                
001636 5636 1620             7      LD  D,020H
       5638                     INS1:
001638 5638 DD214A00        14      LD  IX,RDVRM
00163C 563C CD0144          17      CALL    CALSLT_R
00163F 563F 4F               4      LD  C,A
001640 5640 7A               4      LD  A,D
001641 5641 DD214D00        14      LD  IX,WRTVRM
001645 5645 CD0144          17      CALL    CALSLT_R
001648 5648 23               6      INC HL
001649 5649 51               4      LD  D,C
00164A 564A 10EC            13      DJNZ    INS1
00164C 564C D1              10      POP DE
00164D 564D F1              10      POP AF
00164E 564E C9              10      RET
                                
       564F                     CONOUT1:
00164F 564F 59               4      LD  E,C
001650 5650 C31654          10      JP  _PRINT
                                
       5653                     GETVRAM:
001653 5653 2ADCF3          16      LD  HL,(CSRY)
       5656                     LOC0:
001656 5656 2D               4      DEC L
001657 5657 25               4      DEC H
001658 5658 4C               4      LD  C,H ;CSRX-1
001659 5659 5D               4      LD  E,L ;CSRY-1
       565A                     LOC1:
00165A 565A 3AB0F3          13      LD  A,(LINLEN)
00165D 565D 67               4      LD  H,A
00165E 565E 1600             7      LD  D,0
001660 5660 6A               4      LD  L,D ;0
001661 5661 0608             7      LD  B,8
       5663                     LOC2:
001663 5663 29              11      ADD HL,HL
001664 5664 3001            12      JR  NC,LOC3
001666 5666 19              11      ADD HL,DE
       5667                     LOC3:
001667 5667 10FA            13      DJNZ    LOC2
001669 5669 09              11      ADD HL,BC
00166A 566A C9              10      RET
                                
       566B                     _SYS0C:     ;(BDOS)バージョン番号の獲得
00166B 566B 212200          10      LD  HL,00022H
00166E 566E AF               4      XOR A
00166F 566F 7D               4      LD  A,L
001670 5670 C9              10      RET
                                
       5671                     _SYS0D:     ;(BDOS)ディスク・リセット
001671 5671 218000          10      LD  HL,00080H
001674 5674 22D4F2          16      LD  (_DTA),HL
001677 5677 C9              10      RET
                                
       5678                     _SYS0E:     ;(BDOS)カレントドライブの設定
001678 5678 7B               4      LD  A,E
       5679                     _SYS0EX1:
001679 5679 FE08             7      CP  8
00167B 567B 3F               4      CCF
00167C 567C D8              11      RET C
00167D 567D 32EAF2          13      LD  (_DVSW),A
001680 5680 C9              10      RET
                                
       5681                     _SYS0F:     ;(BDOS)ファイルのオープン
001681 5681 D5              11      PUSH    DE
001682 5682 FDE1            14      POP IY
001684 5684 CDF057          17      CALL    INIT_FILE
001687 5687 CDC14C          17      CALL    ROM_OPEN
00168A 568A 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
00168C 568C FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
001690 5690 FDE5            15      PUSH    IY
001692 5692 D1              10      POP DE
001693 5693 13               6      INC DE
001694 5694 010B00          10      LD  BC,11
001697 5697 EDB0                    LDIR
                                ;               Attribute
001699 5699 7E               7      LD  A,(HL)
00169A 569A FD770D          19      LD  (IY+13),A
                                ;               TIME
00169D 569D 110B00          10      LD  DE,11
0016A0 56A0 19              11      ADD HL,DE
0016A1 56A1 7E               7      LD  A,(HL)
0016A2 56A2 23               6      INC HL
0016A3 56A3 FD7716          19      LD  (IY+22),A
0016A6 56A6 7E               7      LD  A,(HL)
0016A7 56A7 23               6      INC HL
0016A8 56A8 FD7717          19      LD  (IY+23),A
                                ;               DATE
0016AB 56AB 7E               7      LD  A,(HL)
0016AC 56AC 23               6      INC HL
0016AD 56AD FD7714          19      LD  (IY+20),A
0016B0 56B0 7E               7      LD  A,(HL)
0016B1 56B1 23               6      INC HL
0016B2 56B2 FD7715          19      LD  (IY+21),A
                                ;               First cluster
0016B5 56B5 7E               7      LD  A,(HL)
0016B6 56B6 23               6      INC HL
0016B7 56B7 FD771A          19      LD  (IY+26),A
0016BA 56BA 7E               7      LD  A,(HL)
0016BB 56BB 23               6      INC HL
0016BC 56BC FD771B          19      LD  (IY+27),A
                                ;               SIZE
0016BF 56BF 7E               7      LD  A,(HL)
0016C0 56C0 23               6      INC HL
0016C1 56C1 FD7710          19      LD  (IY+16),A
0016C4 56C4 7E               7      LD  A,(HL)
0016C5 56C5 23               6      INC HL
0016C6 56C6 FD7711          19      LD  (IY+17),A
0016C9 56C9 7E               7      LD  A,(HL)
0016CA 56CA 23               6      INC HL
0016CB 56CB FD7712          19      LD  (IY+18),A
0016CE 56CE 7E               7      LD  A,(HL)
0016CF 56CF FD7713          19      LD  (IY+19),A
0016D2 56D2 AF               4      XOR A
0016D3 56D3 FD770C          19      LD  (IY+12),A
0016D6 56D6 C9              10      RET
                                
       56D7                     _SYS10:     ;(BDOS)ファイルのクローズ
0016D7 56D7 AF               4      XOR A
0016D8 56D8 C9              10      RET
                                
       56D9                     S11X1:
0016D9 56D9 FD7119          19      LD  (IY+25),C       ;RootEntCnt
0016DC 56DC FD750E          19      LD  (IY+14),L
0016DF 56DF FD740F          19      LD  (IY+15),H
       56E2                     SCF_FF_RET:
0016E2 56E2 37               4      SCF
0016E3 56E3 9F               4      SBC A,A
0016E4 56E4 C9              10      RET
                                
       56E5                     _SYS11:     ;(BDOS)最初のファイルの検索
0016E5 56E5 ED53D7F2        20      LD  (_FCB),DE
0016E9 56E9 D5              11      PUSH    DE
0016EA 56EA FDE1            14      POP IY
0016EC 56EC CDF057          17      CALL    INIT_FILE
0016EF 56EF CD1F4F          17      CALL    GET_DIR_DAT
       56F2                     S12X1:
0016F2 56F2 CDDD4C          17      CALL    FILESE
0016F5 56F5 30E2            12      JR  NC,S11X1
0016F7 56F7 0D               4      DEC C
0016F8 56F8 FD7119          19      LD  (IY+25),C       ;RootEntCnt
0016FB 56FB FDCB0D66        20      BIT 4,(IY+13)
0016FF 56FF 2809            12      JR  Z,S12X2
001701 5701 E5              11      PUSH    HL
001702 5702 DDE1            14      POP IX
001704 5704 DDCB0E66        20      BIT 4,(IX+1+13)
001708 5708 28E8            12      JR  Z,S12X1
       570A                     S12X2:
00170A 570A 012000          10      LD  BC,32
00170D 570D ED5BD4F2        20      LD  DE,(_DTA)
001711 5711 AF               4      XOR A
001712 5712 12               7      LD  (DE),A      ;ドライブ番号
001713 5713 13               6      INC DE
001714 5714 EDB0                    LDIR            ;ディレクトリエントリ
001716 5716 FD750E          19      LD  (IY+14),L
001719 5719 FD740F          19      LD  (IY+15),H
00171C 571C C9              10      RET
                                
       571D                     _SYS12:
00171D 571D FD2AD7F2        20      LD  IY,(_FCB)
001721 5721 FDE5            15      PUSH    IY
001723 5723 D1              10      POP DE
001724 5724 CDF057          17      CALL    INIT_FILE
                                
001727 5727 FD6E0E          19      LD  L,(IY+14)
00172A 572A FD660F          19      LD  H,(IY+15)
00172D 572D FD4E19          19      LD  C,(IY+25)
001730 5730 18C0            12      JR  S12X1
                                
       5732                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
001732 5732 CD054F          17      CALL    SET_FCB
001735 5735 CDD34E          17      CALL    GETSEQ
001738 5738 CDC04E          17      CALL    RB_READ
00173B 573B E5              11      PUSH    HL
00173C 573C CDE04E          17      CALL    SETSEQ
00173F 573F E1              10      POP HL
       5740                     SREAD:
001740 5740 C601             7      ADD A,001H
001742 5742 D8              11      RET C
                                
001743 5743 7D               4      LD  A,L
001744 5744 D601             7      SUB 001H
001746 5746 9F               4      SBC A,A
001747 5747 E603             7      AND 3
001749 5749 1F               4      RRA
00174A 574A C9              10      RET
                                
       574B                     _SYS18:     ;(BDOS)ログインベクトルの獲得
00174B 574B 218300          10      LD  HL,00083H
00174E 574E AF               4      XOR A
00174F 574F C9              10      RET
                                
       5750                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
001750 5750 3AEAF2          13      LD  A,(_DVSW)
001753 5753 A7               4      AND A
001754 5754 C9              10      RET
                                
       5755                     _SYS1A:     ;(BDOS)DTAの設定
001755 5755 ED53D4F2        20      LD  (_DTA),DE
001759 5759 AF               4      XOR A
00175A 575A C9              10      RET
                                
       575B                     _SYS1B:     ;(BDOS)ディスク情報の獲得
00175B 575B 010002          10      LD  BC,512
00175E 575E 11C302          10      LD  DE,707
001761 5761 210000          10      LD  HL,0
001764 5764 DD21D9F2        14      LD  IX,_BUF
001768 5768 FD21D9F2        14      LD  IY,_BUF
00176C 576C FD3600F9        19      LD  (IY+0),0F9H
001770 5770 3E02             7      LD  A,2
001772 5772 C9              10      RET
                                
       5773                     _SYS21:     ;(BDOS)ランダムな読み出し
001773 5773 CD054F          17      CALL    SET_FCB
                                
001776 5776 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001779 5779 FD6622          19      LD  H,(IY+34)
                                
00177C 577C CDC04E          17      CALL    RB_READ
00177F 577F 18BF            12      JR  SREAD
                                
       5781                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
001781 5781 CD8156          17      CALL    _SYS0F
001784 5784 D8              11      RET C
                                
001785 5785 D5              11      PUSH    DE      ;EX DE,IY
001786 5786 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001788 5788 CDF54E          17      CALL    GETSIZE
       578B                     _S24X1:
00178B 578B FD7521          19      LD  (IY+33),L   ;(FCB)Random record
00178E 578E FD7422          19      LD  (IY+34),H
001791 5791 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
001795 5795 FDE3            23      EX  (SP),IY     ;
001797 5797 D1              10      POP DE      ;
                                
001798 5798 AF               4      XOR A
001799 5799 C9              10      RET
                                
       579A                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
00179A 579A E5              11      PUSH    HL
00179B 579B D5              11      PUSH    DE      ;EX DE,IY
00179C 579C FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00179E 579E CDD34E          17      CALL    GETSEQ
0017A1 57A1 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       57A3                     _SYS27:     ;(BDOS)ランダムブロック読み込み
0017A3 57A3 CD054F          17      CALL    SET_FCB
0017A6 57A6 E5              11      PUSH    HL
0017A7 57A7 FD6E21          19      LD  L,(IY+33)
0017AA 57AA FD6622          19      LD  H,(IY+34)
0017AD 57AD 22CAF2          16      LD  (RR_LOW),HL
0017B0 57B0 FD6E23          19      LD  L,(IY+35)
0017B3 57B3 FD6624          19      LD  H,(IY+36)
0017B6 57B6 22CCF2          16      LD  (RR_HIGH),HL
0017B9 57B9 E1              10      POP HL
0017BA 57BA CDA14A          17      CALL    ROM_READ
0017BD 57BD ED5BCAF2        20      LD  DE,(RR_LOW)
0017C1 57C1 FD7321          19      LD  (IY+33),E
0017C4 57C4 FD7222          19      LD  (IY+34),D
0017C7 57C7 ED5BCCF2        20      LD  DE,(RR_HIGH)
0017CB 57CB FD7323          19      LD  (IY+35),E
0017CE 57CE FD7224          19      LD  (IY+36),D
0017D1 57D1 9F               4      SBC A,A
0017D2 57D2 C9              10      RET
                                
       57D3                     _SYS2F:
0017D3 57D3 44               4      LD  B,H
0017D4 57D4 2AD4F2          16      LD  HL,(_DTA)
0017D7 57D7 C3DB51          10      JP  DISKIO
                                
       57DA                     _SYS5A:
0017DA 57DA 0600             7      LD  B,0
0017DC 57DC D5              11      PUSH    DE
0017DD 57DD DDE1            14      POP IX
       57DF                     _SX5A1:
0017DF 57DF 1A               7      LD  A,(DE)
0017E0 57E0 B7               4      OR  A
0017E1 57E1 2804            12      JR  Z,_SX5A2
0017E3 57E3 13               6      INC DE
0017E4 57E4 04               4      INC B
0017E5 57E5 18F8            12      JR  _SX5A1
                                
       57E7                     _SX5A2:
0017E7 57E7 78               4      LD  A,B
0017E8 57E8 CD6C4B          17      CALL    FILE_BDOS
0017EB 57EB CDC24F          17      CALL    ROM_CD
0017EE 57EE 9F               4      SBC A,A
0017EF 57EF C9              10      RET
                                
       57F0                     INIT_FILE:
0017F0 57F0 EB               4      EX  DE,HL
0017F1 57F1 11F8F2          10      LD  DE,FDRV
0017F4 57F4 010C00          10      LD  BC,1+8+3
       57F7                     INIT_FILE1:
0017F7 57F7 EDB0                    LDIR
0017F9 57F9 CDA353          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0017FC 57FC 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0017FF 57FF 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
001802 5802 2AEBF2          16      LD  HL,(_CD)
001805 5805 22F6F2          16      LD  (_CDX),HL           ;カレントディレクトリ
001808 5808 C9              10      RET
                                
       5809                     ZERO_MEMORY_DE:
001809 5809 AF               4      XOR A
       580A                     FILL_MEMORY_DE:
00180A 580A 12               7      LD  (DE),A
00180B 580B 13               6      INC DE
00180C 580C 10FC            13      DJNZ    FILL_MEMORY_DE
00180E 580E C9              10      RET
                                
00180F 580F                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 035419544A540354        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 035403544F549E54        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 57549054B8544C55        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
001F18 5F18 6B56715678568156        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 D756E5561D570354        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 3257035403540354        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 4B57505755575B57        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 0354735703548157        DW  _ERROR,_SYS21,_ERROR,_SYS23
001F48 5F48 9A5703540354A357        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 035403545E550354        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 AE5503540354D357        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 03540354DA570354        DW  _ERROR,_ERROR,_SYS5A,_ERROR
001FB8 5FB8 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 0354035403540354        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
