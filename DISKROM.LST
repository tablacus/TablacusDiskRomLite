                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FDDB                     H_PINL  EQU 0FDDBH
                                
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                            ;ASCII-16K
                                ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
                                ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
       F280                     ISC EQU 0F280H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F280                     SP32    EQU 0F280H
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM    ; Main program execution address.
000004 4004 C24D                    DW  STATEMENT   ; STATEMENT
000006 4006 C04E                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C3414F          10      JP  DISKIO
000013 4013 C37C4F          10      JP  DSKCHG
000016 4016 C3D24F          10      JP  GETDPB
000019 4019 C3C550          10      JP  CHOICE
00001C 401C C3C950          10      JP  DSKFMT
00001F 401F C3CB50          10      JP  DSKSTP
000022 4022 C3CC50          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C3C950          10      JP  DSKFMT
000029 4029 C3CB50          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C30551          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.4.0.0",0
            204449534B20524F    
            4D204C6974652076    
            302E342E302E3000    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 AF               4      XOR A
000107 4107 2100F3          10      LD  HL,0F300H
00010A 410A 0668             7      LD  B,068H
00010C 410C CD764A          17      CALL    FILL_MEMORY
                                
00010F 410F 3E01             7      LD  A,1
000111 4111 3221FB          13      LD  (DRVTBL),A
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  HL,(STKTOP) ;起動時の空き容量表示の為
                                    LD  BC,-00140H
                                    ADD HL,BC
                                    LD  (STKTOP),HL
                                #else
000114 4114 2175F6          10      LD  HL,STKTOP+1 ;起動時の空き容量表示の為
000117 4117 35              11      DEC (HL)
                                #endif
                                
000118 4118 AF               4      XOR A
000119 4119 32DDF2          13      LD  (_DVSW),A
00011C 411C 3D               4      DEC A       ;0FFH
00011D 411D 3299FD          13      LD  (DEVICE),A
                                
000120 4120 21E042          10      LD  HL,AT_ISC
000123 4123 1180F2          10      LD  DE,ISC
000126 4126 017B00          10      LD  BC,ISC_E-ISC
000129 4129 EDB0                    LDIR
                                    
00012B 412B 3EC3             7      LD  A,0C3H      ;JP
00012D 412D 3243FF          13      LD  (H_GONE),A
000130 4130 327DF3          13      LD  (BDOS),A
000133 4133 326BF3          13      LD  (RAMUSE),A
000136 4136 3268F3          13      LD  (ROMUSE),A
000139 4139 2180F2          10      LD  HL,REPLACE_COMMAND
00013C 413C 2244FF          16      LD  (H_GONE+1),HL
00013F 413F 2131F3          10      LD  HL,H_BDOS
000142 4142 227EF3          16      LD  (BDOS+1),HL
000145 4145 21B0F2          10      LD  HL,RAMUSE1
000148 4148 226CF3          16      LD  (RAMUSE+1),HL
00014B 414B 21ABF2          10      LD  HL,ROMUSE1
00014E 414E 2269F3          16      LD  (ROMUSE+1),HL
                                
000151 4151 3E                      DB  03EH
000152 4152 F7              12      RST 30H
000153 4153 3271FE          13      LD  (H_BINS),A
000156 4156 3276FE          13      LD  (H_BINL),A
000159 4159 327BFE          13      LD  (H_FILE),A
00015C 415C 3231F3          13      LD  (H_BDOS),A
00015F 415F 32DBFD          13      LD  (H_PINL),A
000162 4162 32A7FF          13      LD  (H_PHYD),A
                                
000165 4165 CD2C42          17      CALL    GTSL1_
000168 4168 3297F2          13      LD  (ROM_SLT),A
00016B 416B 32A7F2          13      LD  (ROM_SLT_COPY),A
00016E 416E 3272FE          13      LD  (H_BINS+1),A
000171 4171 3277FE          13      LD  (H_BINL+1),A
000174 4174 327CFE          13      LD  (H_FILE+1),A
000177 4177 3232F3          13      LD  (H_BDOS+1),A
00017A 417A 32DCFD          13      LD  (H_PINL+1),A
00017D 417D 32A8FF          13      LD  (H_PHYD+1),A
000180 4180 3222FB          13      LD  (DRVTBL+1),A
000183 4183 3248F3          13      LD  (MASTERS),A
                                
000186 4186 210545          10      LD  HL,ROM_LOAD
000189 4189 2273FE          16      LD  (H_BINS+2),HL
00018C 418C 213E46          10      LD  HL,ROM_RUN
00018F 418F 2278FE          16      LD  (H_BINL+2),HL
000192 4192 214B46          10      LD  HL,ROM_FILES
000195 4195 227DFE          16      LD  (H_FILE+2),HL
000198 4198 216951          10      LD  HL,ROM_BDOS
00019B 419B 2233F3          16      LD  (H_BDOS+2),HL
00019E 419E 219643          10      LD  HL,ROM_BOOT
0001A1 41A1 22DDFD          16      LD  (H_PINL+2),HL
0001A4 41A4 21414F          10      LD  HL,DISKIO
0001A7 41A7 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001AA 41AA 3E                      DB  03EH
0001AB 41AB C9              10      RET
0001AC 41AC 327FFE          13      LD  (H_FILE+4),A
0001AF 41AF 3275FE          13      LD  (H_BINS+4),A
0001B2 41B2 327AFE          13      LD  (H_BINL+4),A
0001B5 41B5 3235F3          13      LD  (H_BDOS+4),A
0001B8 41B8 32DFFD          13      LD  (H_PINL+4),A
0001BB 41BB 32ABFF          13      LD  (H_PHYD+4),A
                                
0001BE 41BE AF               4      XOR A
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0001BF 41BF 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001C2 41C2 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001C5 41C5 3A0060          13      LD  A,(BANK1_ADR)
0001C8 41C8 FE41             7      CP  'A'
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JR  Z,NOT_BANK_TYPE
                                    LD  A,DISK_BANK
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0001CA 41CA 204F            12      JR  NZ,NOT_BANK_TYPE
0001CC 41CC 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001CF 41CF 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001D2 41D2 CD3801          17      CALL    RSLREG      ;read primary slot #
0001D5 41D5 07               4      RLCA
0001D6 41D6 07               4      RLCA
0001D7 41D7 F5              11      PUSH    AF
0001D8 41D8 1605             7      LD  D,4+1
0001DA 41DA CD3342          17      CALL    GTSL2_
0001DD 41DD 3244F3          13      LD  (RAMAD3),A
0001E0 41E0 F1              10      POP AF
0001E1 41E1 07               4      RLCA
0001E2 41E2 07               4      RLCA
0001E3 41E3 1603             7      LD  D,2+1
0001E5 41E5 CD3342          17      CALL    GTSL2_
0001E8 41E8 2680             7      LD  H,080H
0001EA 41EA CD5042          17      CALL    CHK_RAM
0001ED 41ED 3243F3          13      LD  (RAMAD2),A
       41F0                     RAMCHK2:
0001F0 41F0 3A44F3          13      LD  A,(RAMAD3)
0001F3 41F3 2640             7      LD  H,040H
0001F5 41F5 CD5042          17      CALL    CHK_RAM
0001F8 41F8 3242F3          13      LD  (RAMAD1),A
       41FB                     RAMCHK1:
0001FB 41FB 3A44F3          13      LD  A,(RAMAD3)
0001FE 41FE 2600             7      LD  H,00H
000200 4200 CD5042          17      CALL    CHK_RAM
000203 4203 3241F3          13      LD  (RAMAD0),A
       4206                     RAMCHK0:
000206 4206 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
000209 4209 010F00          10      LD  BC,0000FH       ;切り上げ
00020C 420C 09              11      ADD HL,BC
00020D 420D 7D               4      LD  A,L
                                
00020E 420E 0604             7      LD  B,4
       4210                     B_DRIVE1:
000210 4210 CB3C             8      SRL H
000212 4212 1F               4      RRA
000213 4213 10FB            13      DJNZ    B_DRIVE1
                                
000215 4215 C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000217 4217 32DCF2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
00021A 421A C9              10      RET
                                
       421B                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
00021B 421B 21D443          10      LD  HL,MSG_ERROR_ROM_MODE
00021E 421E CD5E43          17      CALL    MSX
000221 4221 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000225 4225 DD219F00        14      LD  IX,CHGET
000229 4229 C31C00          10      JP  _CALSLT
                                
       422C                     GTSL1_:             ;自分のいるスロットを知る
00022C 422C CD3801          17      CALL    RSLREG      ;read primary slot #
00022F 422F 0F               4      RRCA
000230 4230 0F               4      RRCA
000231 4231 1601             7      LD  D,1
       4233                     GTSL2_:
000233 4233 E603             7      AND 3       ;[A]=000000PP
000235 4235 5F               4      LD  E,A     ;[E]=000000PP
000236 4236 21C1FC          10      LD  HL,EXPTBL
000239 4239 85               4      ADD A,L     ;桁上りは無い
00023A 423A 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
00023B 423B 7B               4      LD  A,E     ;[A]=000000PP
00023C 423C CB7E            13      BIT 7,(HL)
00023E 423E C8              11      RET Z
00023F 423F 7D               4      LD  A,L     ;point to SLTTBL entry
000240 4240 C604             7      ADD A,4     ;桁上りは無い
000242 4242 6F               4      LD  L,A
000243 4243 7E               7      LD  A,(HL)      ;get currently expansion slot register
       4244                     GTSL3_:
000244 4244 15               4      DEC D
000245 4245 2803            12      JR  Z,GTSL4_:
000247 4247 0F               4      RRCA
000248 4248 18FA            12      JR  GTSL3_:
       424A                     GTSL4_:
00024A 424A E60C             7      AND 00CH        ;[A] = 0000SS00
00024C 424C B3               4      OR  E       ;[A] = 0000SSPP
00024D 424D F680             7      OR  080H        ;[A] = 1000SSPP
00024F 424F C9              10      RET
                                
       4250                     CHK_RAM:
000250 4250 E5              11      PUSH    HL
000251 4251 CDA542          17      CALL    CHK_RAM0
000254 4254 E1              10      POP HL
000255 4255 C8              11      RET Z
000256 4256 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000259 4259 E680             7      AND 080H
00025B 425B CD7C42          17      CALL    CHK_RAM_SLT
00025E 425E C8              11      RET Z
00025F 425F 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000262 4262 E680             7      AND 080H
000264 4264 C601             7      ADD A,1
000266 4266 CD7C42          17      CALL    CHK_RAM_SLT
000269 4269 C8              11      RET Z
00026A 426A 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00026D 426D E680             7      AND 080H
00026F 426F C602             7      ADD A,2
000271 4271 CD7C42          17      CALL    CHK_RAM_SLT
000274 4274 C8              11      RET Z
000275 4275 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000278 4278 E680             7      AND 080H
00027A 427A C603             7      ADD A,3
       427C                     CHK_RAM_SLT:
00027C 427C E5              11      PUSH    HL
00027D 427D CDA542          17      CALL    CHK_RAM0        ;スロット#X or X-0
000280 4280 E1              10      POP HL
000281 4281 C8              11      RET Z
000282 4282 CB79             8      BIT 7,C
000284 4284 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000286 4286 79               4      LD  A,C
000287 4287 C604             7      ADD A,4*1           ;スロット#X-1
000289 4289 E5              11      PUSH    HL
00028A 428A CDA542          17      CALL    CHK_RAM0
00028D 428D E1              10      POP HL
00028E 428E C8              11      RET Z
00028F 428F 79               4      LD  A,C
000290 4290 C608             7      ADD A,4*2           ;スロット#X-2
000292 4292 E5              11      PUSH    HL
000293 4293 CDA542          17      CALL    CHK_RAM0
000296 4296 E1              10      POP HL
000297 4297 C8              11      RET Z
000298 4298 79               4      LD  A,C
000299 4299 C60C             7      ADD A,4*3           ;スロット#X-3
00029B 429B E5              11      PUSH    HL
00029C 429C CDA542          17      CALL    CHK_RAM0
00029F 429F E1              10      POP HL
       42A0                     CHK_RAM_E:
0002A0 42A0 AF               4      XOR A
0002A1 42A1 3C               4      INC A           ;ZF=0にする
0002A2 42A2 3E00             7      LD  A,0
0002A4 42A4 C9              10      RET
                                
       42A5                     CHK_RAM0:
0002A5 42A5 4F               4      LD  C,A
0002A6 42A6 3A97F2          13      LD  A,(ROM_SLT)
0002A9 42A9 B9               4      CP  C
0002AA 42AA 28F4            12      JR  Z,CHK_RAM_E
0002AC 42AC 2E00             7      LD  L,0
       42AE                     CHK_RAM1:
0002AE 42AE 79               4      LD  A,C
0002AF 42AF CD8E43          17      CALL    RDSLTX
0002B2 42B2 C6E5             7      ADD A,0E5H
0002B4 42B4 47               4      LD  B,A
0002B5 42B5 5F               4      LD  E,A
0002B6 42B6 79               4      LD  A,C
0002B7 42B7 C5              11      PUSH    BC
0002B8 42B8 CD1400          17      CALL    _WRSLT
0002BB 42BB C1              10      POP BC
0002BC 42BC 79               4      LD  A,C
0002BD 42BD CD8E43          17      CALL    RDSLTX
0002C0 42C0 B8               4      CP  B
0002C1 42C1 C0              11      RET NZ
0002C2 42C2 D6E5             7      SUB 0E5H
0002C4 42C4 79               4      LD  A,C
0002C5 42C5 5F               4      LD  E,A
0002C6 42C6 C5              11      PUSH    BC
0002C7 42C7 CD1400          17      CALL    _WRSLT
0002CA 42CA C1              10      POP BC
0002CB 42CB 24               4      INC H
0002CC 42CC 7D               4      LD  A,L
0002CD 42CD C604             7      ADD A,4
0002CF 42CF 6F               4      LD  L,A
0002D0 42D0 20DC            12      JR  NZ,CHK_RAM1
0002D2 42D2 79               4      LD  A,C     ;ZF=1のハズ
0002D3 42D3 C9              10      RET
                                
       42D4                     CALSLT_R:
0002D4 42D4 C5              11      PUSH    BC
0002D5 42D5 E5              11      PUSH    HL
0002D6 42D6 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0002DA 42DA CD1C00          17      CALL    _CALSLT
0002DD 42DD E1              10      POP HL
0002DE 42DE C1              10      POP BC
0002DF 42DF C9              10      RET
                                
       42E0                     AT_ISC:
0002E0 F280                         ORG ISC,AT_ISC-RUN
       F280                     REPLACE_COMMAND:
0002E0 F280 FEB7             7      CP  0B7H            ;FILES
0002E2 F282 CC7BFE          17      CALL    Z,H_FILE
0002E5 F285 FEB5             7      CP  0B5H            ;LOAD
0002E7 F287 CA71FE          10      JP  Z,H_BINS
0002EA F28A FE8A             7      CP  08AH            ;RUN
0002EC F28C CA76FE          10      JP  Z,H_BINL
0002EF F28F FED6             7      CP  0D6H            ;COPY
0002F1 F291 2813            12      JR  Z,FIX_COPY
0002F3 F293 FECF             7      CP  0CFH            ;BLOAD
0002F5 F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
0002F6 F296 F7              12      RST 30H
       F297                     ROM_SLT:
0002F7 F297 00                      DB  0
0002F8 F298 7045                    DW  ROM_BLOAD
0002FA F29A F5              11      PUSH    AF
0002FB F29B E5              11      PUSH    HL
0002FC F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
0002FF F29F E1              10      POP HL
000300 F2A0 F1              10      POP AF
000301 F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
000303 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
000305 F2A5 C9              10      RET
       F2A6                     FIX_COPY:
000306 F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
000307 F2A7 00                      DB  0
000308 F2A8 D646                    DW  ROM_COPY
00030A F2AA C9              10      RET
       F2AB                     ROMUSE1:
00030B F2AB 3A97F2          13      LD  A,(ROM_SLT)
00030E F2AE 1803            12      JR  ROMUSE2
       F2B0                     RAMUSE1:
000310 F2B0 3A42F3          13      LD  A,(RAMAD1)
       F2B3                     ROMUSE2:
000313 F2B3 C32400          10      JP  _ENASLT
                                
       F2B6                     _RESULT:
000316 F2B6 00                      DB  0
       F2B7                     _BANK:
000317 F2B7 00                      DB  0
       F2B8                     _BANK1:
000318 F2B8 00                      DB  0
       F2B9                     CLSZ:               ;クラスタサイズ
000319 F2B9 0004                    DW  1024
       F2BA                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2BB                     SECSZ:              ;セクタサイズ
00031B F2BB 0002                    DW  512
       F2BC                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2BD                     RR_LOW:
00031D F2BD 0000                    DW  0
       F2BE                     RR_MID  EQU $-1
       F2BF                     RR_HIGH:
00031F F2BF 0000                    DW  0
       F2C1                     _CLPS:
000321 F2C1 0000                    DW  0
       F2C3                     _LEFT:
000323 F2C3 0000                    DW  0
       F2C5                     _DTPS:
000325 F2C5 0000                    DW  0
       F2C7                     _DTA:
000327 F2C7 0000                    DW  0
       F2C9                     FLG_LDIR:
000329 F2C9 00                      DB  0
       F2CA                     _FCB:
00032A F2CA 0000                    DW  0
       F2CC                     _BUF:
       F2CC                     _BUF_LO:        ;LOGICAL OPERATION
00032C F2CC 00                      DB  0
       F2CD                     _BUF_ST:
00032D F2CD 0000                    DW  0
       F2CF                     _BUF_EN:
00032F F2CF 0000                    DW  0
       F2D1                     _BUF_EX:
       F2D1                     _BUF_W:
000331 F2D1 0000                    DW  0
       F2D3                     _BUF_H:
000333 F2D3 0000                    DW  0
       F2D5                     _BUF_X:
000335 F2D5 0000                    DW  0
       F2D7                     _BUF_Y:
000337 F2D7 00                      DB  0
       F2D8                     _BUF_P:
000338 F2D8 00                      DB  0
       F2D9                     _BUF_O:
000339 F2D9 00                      DB  0
       F2DA                     DTAX:
00033A F2DA 0000                    DW  0
       F2DC                     B_DRIVE:
00033C F2DC 00                      DB  0
       F2DD                     _DVSW:          ;カレントドライブ
00033D F2DD 00                      DB  0
       F2DE                     _CD:            ;カレントディレクトリ
00033E F2DE 0000                    DW  0
       F2E0                     DIRENT1:
000340 F2E0 0000                    DW  0
       F2E2                     _DIR_BANK:
000342 F2E2 00                      DB  0
       F2E3                     LEFTX:
000343 F2E3 0000                    DW  0
       F2E5                     PARAM0:
000345 F2E5 0000                    DW  0
       F2E7                     PARAM1:
000347 F2E7 0000                    DW  0
       F2E9                     _CDX:
000349 F2E9 0000                    DW  0
       F2EB                     FDRV:
00034B F2EB 00                      DB  0
       F2EC                     FNAME:
00034C F2EC                         DS  8+3
       F2F7                     _HL:
000357 F2F7 0000                    DW  0
       F2F9                     _SP:
000359 F2F9 0000                    DW  0
       F2FA                     _SP_H   EQU $-1
       F2FB                     ISC_E:
00035B 435B                         ORG $$+RUN          ;$DEPHASE
                                
       435B                     MSX1:
00035B 435B CD8251          17      CALL    MSGA1
       435E                     MSX:
00035E 435E 7E               7      LD  A,(HL)
00035F 435F 23               6      INC HL
000360 4360 B7               4      OR  A
000361 4361 20F8            12      JR  NZ,MSX1
000363 4363 C9              10      RET
                                
       4364                     PRTHX:
000364 4364 F5              11      PUSH    AF
000365 4365 07               4      RLCA
000366 4366 07               4      RLCA
000367 4367 07               4      RLCA
000368 4368 07               4      RLCA
000369 4369 CD6D43          17      CALL    PRTA2
00036C 436C F1              10      POP AF
       436D                     PRTA2:
00036D 436D CD7343          17      CALL    ASC
000370 4370 C37E51          10      JP  MSG_A
                                    
       4373                     ASC:
000373 4373 E60F             7      AND $0F
000375 4375 F630             7      OR  $30
000377 4377 FE3A             7      CP  $3A
000379 4379 D8              11      RET C
00037A 437A C607             7      ADD A,7
00037C 437C C9              10      RET
                                
       437D                     MSN:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
00037D 437D 7E               7      LD  A,(HL)
                                #endif
00037E 437E 23               6      INC HL
00037F 437F CD7E51          17      CALL    MSG_A
000382 4382 10F9            13      DJNZ    MSN
000384 4384 C9              10      RET
                                
       4385                     RDSLT_ROM3:
000385 4385 7E               7      LD  A,(HL)
000386 4386 C9              10      RET
       4387                     RDSLT_ROM:
000387 4387 CB7C             8      BIT 7,H
000389 4389 28FA            12      JR  Z,RDSLT_ROM3
       438B                     RDSLT_ROM2:
00038B 438B 3A97F2          13      LD  A,(ROM_SLT)
       438E                     RDSLTX:
00038E 438E C5              11      PUSH    BC
00038F 438F D5              11      PUSH    DE
000390 4390 CD0C00          17      CALL    _RDSLT
000393 4393 D1              10      POP DE
000394 4394 C1              10      POP BC
000395 4395 C9              10      RET
                                
       4396                     ROM_BOOT:
000396 4396 3E                      DB  03EH
000397 4397 C9              10      RET
000398 4398 32DBFD          13      LD  (H_PINL),A
00039B 439B 3ACAFF          13      LD  A,(EXTBIO)
00039E 439E FEF7             7      CP  0F7H        ;RST 30H
0003A0 43A0 2805            12      JR  Z,EXTBIO_OK
0003A2 43A2 3E                      DB  03EH
0003A3 43A3 C9              10      RET
0003A4 43A4 32CAFF          13      LD  (EXTBIO),A
       43A7                     EXTBIO_OK:
0003A7 43A7 21FA43          10      LD  HL,DELOK
0003AA 43AA CD5E43          17      CALL    MSX
                                
0003AD 43AD AF               4      XOR A
0003AE 43AE 3240F3          13      LD  (REBOOT),A
0003B1 43B1 2A48FC          16      LD  HL,(BOTTOM)
0003B4 43B4 110040          10      LD  DE,16384
0003B7 43B7 19              11      ADD HL,DE
0003B8 43B8 3817            12      JR  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
0003BA 43BA 57               4      LD  D,A
0003BB 43BB 0601             7      LD  B,1
0003BD 43BD 2100C0          10      LD  HL,0C000H
0003C0 43C0 CD414F          17      CALL    DISKIO
                                
0003C3 43C3 116BF3          10      LD  DE,RAMUSE
0003C6 43C6 AF               4      XOR A
0003C7 43C7 CD1EC0          17      CALL    0C01EH
0003CA 43CA 116BF3          10      LD  DE,RAMUSE
0003CD 43CD 37               4      SCF
0003CE 43CE CD1EC0          17      CALL    0C01EH
       43D1                     BOOT1:
0003D1 43D1 C3CC50          10      JP  BASENT
                                
       43D4                     MSG_ERROR_ROM_MODE:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DB  "Normal ROM/ASCII-16K only!",13,10
                                #else
0003D4 43D4 41534349492D384B        DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
            2F4B6F6E616D692D    
            384B2F4B6F6E616D    
            692D534343206F6E    
            6C79210D0A          
                                #endif
       43F9                     NULL:
0003F9 43F9 00                      DB  0
       43FA                     DELOK:
0003FA 43FA 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       43FE                     ROM_LDIR:
0003FE 43FE 3AC9F2          13      LD  A,(FLG_LDIR)
000401 4401 B7               4      OR  A
000402 4402 2008            12      JR  NZ,ROM_LDIRVM
000404 4404 CB7A             8      BIT 7,D
000406 4406 CA1E44          10      JP  Z,ROM_LDIRSLT
                                #if exists USE_MORMAL32K_OR_ASCII16
                                LDIRA:
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ1
                                    LD  SP,SP32
                                SPJ1:
                                LDIR1:
                                    LD  A,B
                                    OR  C
                                    JR  Z,LDIRE
                                
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                LDIR2:
                                    LD  A,D
                                    CP  0C0H
                                    JR  NC,LDIR4
                                
                                    PUSH    BC
                                    PUSH    DE
                                    LD  DE,BUF
                                
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIR3
                                    LD  BC,00100H
                                LDIR3:
                                    PUSH    BC
                                    LDIR
                                    LD  (_HL),HL
                                
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                
                                    POP BC
                                    POP DE
                                    LD  HL,BUF
                                    LDIR
                                
                                    LD  HL,(_HL)
                                    POP BC
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIRE
                                    DEC B
                                    JR  LDIR1
                                LDIR4:
                                #endif
000409 4409 EDB0                    LDIR
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                LDIRE2:
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                LDIRE:
                                    LD  SP,(_SP)
                                #endif
00040B 440B C9              10      RET
                                
       440C                     ROM_LDIRVM:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ2
                                    LD  SP,SP32
                                SPJ2:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
00040C 440C C5              11      PUSH    BC
00040D 440D D5              11      PUSH    DE
00040E 440E FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000412 4412 DD215C00        14      LD  IX,LDIRVM
000416 4416 CD1C00          17      CALL    _CALSLT
000419 4419 E1              10      POP HL
00041A 441A C1              10      POP BC
00041B 441B 09              11      ADD HL,BC
00041C 441C EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JR  LDIRE2
                                #else
00041D 441D C9              10      RET
                                #endif
                                
       441E                     ROM_LDIRSLT:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ3
                                    LD  SP,SP32
                                SPJ3:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
       441E                     ROM_LDIRSLT1:
00041E 441E EB               4      EX  DE,HL
       441F                     RLDIRSLT1:
00041F 441F CB7C             8      BIT 7,H
000421 4421 201F            12      JR  NZ,RLDIRSLT_EXIT
000423 4423 1A               7      LD  A,(DE)
000424 4424 13               6      INC DE
000425 4425 C5              11      PUSH    BC
000426 4426 D5              11      PUSH    DE
000427 4427 E5              11      PUSH    HL
000428 4428 5F               4      LD  E,A
                                
000429 4429 0141F3          10      LD  BC,RAMAD0
00042C 442C 7C               4      LD  A,H
00042D 442D 07               4      RLCA
00042E 442E 07               4      RLCA
00042F 442F E603             7      AND 3
000431 4431 81               4      ADD A,C
000432 4432 4F               4      LD  C,A
000433 4433 0A               7      LD  A,(BC)
       4434                     RLDIRSLT2:
000434 4434 CD1400          17      CALL    _WRSLT
000437 4437 08               4      EX  AF,AF'
000438 4438 E1              10      POP HL
000439 4439 D1              10      POP DE
00043A 443A C1              10      POP BC
00043B 443B EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00043D 443D EA1F44          10      JP  PE,RLDIRSLT1
000440 4440 EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JP  LDIRE2
                                RLDIRSLT_EXIT:
                                    EX  DE,HL
                                    JP  LDIR1
                                #else
000441 4441 C9              10      RET
       4442                     RLDIRSLT_EXIT:
000442 4442 EB               4      EX  DE,HL
000443 4443 EDB0                    LDIR
000445 4445 C9              10      RET
                                #endif
                                
       4446                     END_OF_LINE:
000446 4446 215EF5          10      LD  HL,BUF
       4449                     EOL1:
000449 4449 7E               7      LD  A,(HL)
00044A 444A C8              11      RET Z
00044B 444B FE0D             7      CP  00DH
00044D 444D 2807            12      JR  Z,EOLE
00044F 444F FE0A             7      CP  00AH
000451 4451 2803            12      JR  Z,EOLE
000453 4453 23               6      INC HL
000454 4454 18F3            12      JR  EOL1
       4456                     EOLE:
000456 4456 3600            10      LD  (HL),0
000458 4458 23               6      INC HL
000459 4459 7E               7      LD  A,(HL)
00045A 445A FE0A             7      CP  00AH
00045C 445C C0              11      RET NZ
00045D 445D 23               6      INC HL
00045E 445E C9              10      RET
                                
       445F                     ROM_LOAD_ASCII:
00045F 445F 210000          10      LD  HL,0
000462 4462 22CDF2          16      LD  (_BUF_ST),HL    ;読み出し位置
000465 4465 2A76F6          16      LD  HL,(TXTTAB)
000468 4468 22CFF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
00046B 446B 215EF5          10      LD  HL,BUF
00046E 446E 22C7F2          16      LD  (_DTA),HL
       4471                     RLOAD_A1:
000471 4471 2ACDF2          16      LD  HL,(_BUF_ST)
000474 4474 22BDF2          16      LD  (RR_LOW),HL
000477 4477 210201          10      LD  HL,258
00047A 447A CDF648          17      CALL    ROM_READ
00047D 447D 7C               4      LD  A,H
00047E 447E B5               4      OR  L
00047F 447F 2877            12      JR  Z,RLOAD_AEND
000481 4481 015EF5          10      LD  BC,BUF
000484 4484 09              11      ADD HL,BC
000485 4485 3600            10      LD  (HL),0
000487 4487 CD4644          17      CALL    END_OF_LINE
00048A 448A 015EF5          10      LD  BC,BUF
00048D 448D A7               4      AND A
00048E 448E ED42            15      SBC HL,BC
000490 4490 2810            12      JR  Z,RLOAD_A2
000492 4492 4D               4      LD  C,L
000493 4493 44               4      LD  B,H
000494 4494 ED5BCDF2        20      LD  DE,(_BUF_ST)
000498 4498 19              11      ADD HL,DE
000499 4499 22CDF2          16      LD  (_BUF_ST),HL
00049C 449C 3A5EF5          13      LD  A,(BUF)
00049F 449F B7               4      OR  A
0004A0 44A0 28CF            12      JR  Z,RLOAD_A1
       44A2                     RLOAD_A2:
0004A2 44A2 115EF5          10      LD  DE,BUF
0004A5 44A5 CDAD4A          17      CALL    SPCUTEX
0004A8 44A8 1A               7      LD  A,(DE)
0004A9 44A9 B7               4      OR  A
0004AA 44AA 284C            12      JR  Z,RLOAD_AEND
0004AC 44AC CDBF4A          17      CALL    GETNUM
0004AF 44AF 7C               4      LD  A,H
0004B0 44B0 B5               4      OR  L
0004B1 44B1 CA5745          10      JP  Z,ERROR_DIRECT_IN_FILE
0004B4 44B4 DD2ACFF2        20      LD  IX,(_BUF_EN)
0004B8 44B8 DD7502          19      LD  (IX+2),L
0004BB 44BB DD7403          19      LD  (IX+3),H
                                
0004BE 44BE CDA64A          17      CALL    SPCUT
0004C1 44C1 EB               4      EX  DE,HL
0004C2 44C2 DDE5            15      PUSH    IX
0004C4 44C4 DD21B242        14      LD  IX,CRUNCH
0004C8 44C8 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0004CC 44CC CD1C00          17      CALL    _CALSLT
0004CF 44CF DDE1            14      POP IX
0004D1 44D1 EB               4      EX  DE,HL
0004D2 44D2 111FF4          10      LD  DE,KBUF
0004D5 44D5 37               4      SCF
0004D6 44D6 ED52            15      SBC HL,DE
0004D8 44D8 287D            12      JR  Z,ERROR_DIRECT_IN_FILE
0004DA 44DA 387B            12      JR  C,ERROR_DIRECT_IN_FILE
0004DC 44DC 4D               4      LD  C,L
0004DD 44DD 44               4      LD  B,H
0004DE 44DE 2ACFF2          16      LD  HL,(_BUF_EN)
0004E1 44E1 110400          10      LD  DE,4
0004E4 44E4 19              11      ADD HL,DE
0004E5 44E5 111FF4          10      LD  DE,KBUF
                                
0004E8 44E8 EB               4      EX  DE,HL
0004E9 44E9 EDB0                    LDIR
0004EB 44EB EB               4      EX  DE,HL
                                
0004EC 44EC DD7500          19      LD  (IX+0),L
0004EF 44EF DD7401          19      LD  (IX+1),H
0004F2 44F2 22CFF2          16      LD  (_BUF_EN),HL
0004F5 44F5 C37144          10      JP  RLOAD_A1
                                
       44F8                     RLOAD_AEND:
0004F8 44F8 2ACFF2          16      LD  HL,(_BUF_EN)
0004FB 44FB AF               4      XOR A
0004FC 44FC 77               7      LD  (HL),A
0004FD 44FD 23               6      INC HL
0004FE 44FE 77               7      LD  (HL),A
0004FF 44FF 23               6      INC HL
000500 4500 22CFF2          16      LD  (_BUF_EN),HL
000503 4503 183B            12      JR  RLOAD_END1
                                
       4505                     ROM_LOAD:
000505 4505 CDA446          17      CALL    INIT_PARAM
000508 4508 CD9749          17      CALL    FILE_B
00050B 450B 3AECF2          13      LD  A,(FNAME)
00050E 450E FE20             7      CP  020H
000510 4510 CA9249          10      JP  Z,ROM_ORG
                                
000513 4513 CD164B          17      CALL    ROM_OPEN
000516 4516 384B            12      JR  C,ERROR_FILE_NOT_FOUND
       4518                     ROM_LOAD1:
000518 4518 21CCF2          10      LD  HL,_BUF
00051B 451B 22C7F2          16      LD  (_DTA),HL
00051E 451E 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
000521 4521 CDF648          17      CALL    ROM_READ
000524 4524 3ACCF2          13      LD  A,(_BUF)
000527 4527 3C               4      INC A
000528 4528 C25F44          10      JP  NZ,ROM_LOAD_ASCII
00052B 452B 2A76F6          16      LD  HL,(TXTTAB)
00052E 452E 22C7F2          16      LD  (_DTA),HL
000531 4531 EB               4      EX  DE,HL
000532 4532 2100FF          10      LD  HL,-256
000535 4535 39              11      ADD HL,SP
000536 4536 ED52            15      SBC HL,DE
000538 4538 CDF648          17      CALL    ROM_READ
00053B 453B ED5BC7F2        20      LD  DE,(_DTA)
00053F 453F 19              11      ADD HL,DE
       4540                     RLOAD_END1:
000540 4540 22C2F6          16      LD  (VARTAB),HL
000543 4543 22C4F6          16      LD  (ARYTAB),HL
000546 4546 22C6F6          16      LD  (STREND),HL
                                
000549 4549 AF               4      XOR A
00054A 454A 21CFF2          10      LD  HL,_BUF+3
00054D 454D 77               7      LD  (HL),A
00054E 454E 2B               6      DEC HL
00054F 454F 77               7      LD  (HL),A
000550 4550 2B               6      DEC HL
000551 4551 77               7      LD  (HL),A
000552 4552 2B               6      DEC HL
000553 4553 3E8F             7      LD  A,08FH          ;REM
000555 4555 77               7      LD  (HL),A
000556 4556 C9              10      RET
                                
       4557                     ERROR_DIRECT_IN_FILE:
000557 4557 1E39             7      LD  E,57            ;Direct statement in file
000559 4559 01                      DB  1           ;LD BC,
       455A                     ERROR_DEVICE_IO_ERROR:
00055A 455A 1E13             7      LD  E,19            ;Device I/O error
00055C 455C 01                      DB  1           ;LD BC,
       455D                     ERROR_INTERNAL_ERROR:
00055D 455D 1E33             7      LD  E,51            ;Internal error
00055F 455F 01                      DB  1           ;LD BC,
       4560                     ERROR_FILE_NOT_OPEN:
000560 4560 1E3B             7      LD  E,59            ;File not OPEN
000562 4562 01                      DB  1           ;LD BC,
       4563                     ERROR_FILE_NOT_FOUND:
000563 4563 1E35             7      LD  E,53            ;File not found
       4565                     ERROR:
000565 4565 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000569 4569 DD216F40        14      LD  IX,ERRHAND
00056D 456D C31C00          10      JP  _CALSLT
                                
       4570                     ROM_BLOAD:
000570 4570 CDA446          17      CALL    INIT_PARAM
000573 4573 CD9749          17      CALL    FILE_B
000576 4576 CD164B          17      CALL    ROM_OPEN
000579 4579 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
00057B 457B 21CCF2          10      LD  HL,_BUF
00057E 457E 22C7F2          16      LD  (_DTA),HL
000581 4581 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
000584 4584 CDF648          17      CALL    ROM_READ
000587 4587 3ACCF2          13      LD  A,(_BUF)
00058A 458A FEFE             7      CP  0FEH
00058C 458C 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
00058E 458E 21A5F2          10      LD  HL,BLOAD_RET
000591 4591 229DF2          16      LD  (SWC_BLOAD),HL
                                
000594 4594 2AE7F2          16      LD  HL,(PARAM1)
000597 4597 7E               7      LD  A,(HL)
000598 4598 FE2C             7      CP  ','
00059A 459A 2048            12      JR  NZ,RBREAD_MEM
00059C 459C 23               6      INC HL
00059D 459D 7E               7      LD  A,(HL)
00059E 459E CD004B          17      CALL    CAP
0005A1 45A1 32BEFC          13      LD  (RUNBNF),A
       45A4                     RBOS1:
0005A4 45A4 7E               7      LD  A,(HL)
0005A5 45A5 23               6      INC HL
0005A6 45A6 B7               4      OR  A
0005A7 45A7 282F            12      JR  Z,RBREAD_OSE
0005A9 45A9 FE3A             7      CP  ':'
0005AB 45AB 282B            12      JR  Z,RBREAD_OSE
0005AD 45AD FE2C             7      CP  ','     ;次のパラメータを探す
0005AF 45AF 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
0005B1 45B1 22E7F2          16      LD  (PARAM1),HL
0005B4 45B4 7E               7      LD  A,(HL)
0005B5 45B5 B7               4      OR  A
0005B6 45B6 2820            12      JR  Z,RBREAD_OSE
0005B8 45B8 DD21644C        14      LD  IX,FRMEVL
0005BC 45BC FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0005C0 45C0 CD1C00          17      CALL    _CALSLT
0005C3 45C3 22E7F2          16      LD  (PARAM1),HL
0005C6 45C6 3A63F6          13      LD  A,(VALTYP)
0005C9 45C9 FE02             7      CP  2
0005CB 45CB 200B            12      JR  NZ,RBREAD_OSE
0005CD 45CD 2ACDF2          16      LD  HL,(_BUF_ST)
0005D0 45D0 ED5BF8F7        20      LD  DE,(DACDAT)
0005D4 45D4 19              11      ADD HL,DE
0005D5 45D5 22CDF2          16      LD  (_BUF_ST),HL
       45D8                     RBREAD_OSE:
0005D8 45D8 3ABEFC          13      LD  A,(RUNBNF)
0005DB 45DB FE53             7      CP  'S'
0005DD 45DD 2005            12      JR  NZ,RBREAD_MEM
0005DF 45DF 3E01             7      LD  A,1
0005E1 45E1 32C9F2          13      LD  (FLG_LDIR),A
       45E4                     RBREAD_MEM:
0005E4 45E4 2ACDF2          16      LD  HL,(_BUF_ST)
0005E7 45E7 22BFFC          16      LD  (SAVENT),HL
0005EA 45EA 22C7F2          16      LD  (_DTA),HL
0005ED 45ED 21FFFF          10      LD  HL,0FFFFH
0005F0 45F0 CDF648          17      CALL    ROM_READ
0005F3 45F3 AF               4      XOR A
0005F4 45F4 32C9F2          13      LD  (FLG_LDIR),A
0005F7 45F7 3ABEFC          13      LD  A,(RUNBNF)
0005FA 45FA FE52             7      CP  'R'
0005FC 45FC 2006            12      JR  NZ,RBREAD1
0005FE 45FE 2AD1F2          16      LD  HL,(_BUF_EX)
000601 4601 229DF2          16      LD  (SWC_BLOAD),HL
       4604                     RBREAD1:
       4604                     ROM_NEXT:
000604 4604 2AE7F2          16      LD  HL,(PARAM1)
000607 4607 7E               7      LD  A,(HL)
000608 4608 2B               6      DEC HL
000609 4609 B7               4      OR  A
00060A 460A 2805            12      JR  Z,RN1
00060C 460C FE3A             7      CP  ':'
00060E 460E 2801            12      JR  Z,RN1
000610 4610 23               6      INC HL
       4611                     RN1:
000611 4611 5D               4      LD  E,L
000612 4612 54               4      LD  D,H
                                
000613 4613 CDD64A          17      CALL    SEARCH_END
000616 4616 B7               4      OR  A
000617 4617 2821            12      JR  Z,REM
       4619                     RN3:                    ;マルチステートメントの処理
000619 4619 7E               7      LD  A,(HL)
                                
00061A 461A FEB5             7      CP  0B5H            ;LOAD
00061C 461C CA0545          10      JP  Z,ROM_LOAD
00061F 461F FE8A             7      CP  08AH            ;RUN
000621 4621 281B            12      JR  Z,ROM_RUN
000623 4623 FEB7             7      CP  0B7H            ;FILES
000625 4625 2824            12      JR  Z,ROM_FILES
000627 4627 FED6             7      CP  0D6H            ;COPY
000629 4629 CAD646          10      JP  Z,ROM_COPY
00062C 462C FE20             7      CP  020H
00062E 462E 2807            12      JR  Z,RN_SP
                                
000630 4630 3E28             7      LD  A,028H          ;JR Z,
000632 4632 32A3F2          13      LD  (SWC_BLOAD_M),A
000635 4635 7E               7      LD  A,(HL)
000636 4636 C9              10      RET
       4637                     RN_SP:
000637 4637 23               6      INC HL
000638 4638 18DF            12      JR  RN3
                                
       463A                     REM:
00063A 463A EB               4      EX  DE,HL
00063B 463B 3E8F             7      LD  A,08FH          ;REM
00063D 463D C9              10      RET
                                
       463E                     ROM_RUN:
00063E 463E 23               6      INC HL
00063F 463F 7E               7      LD  A,(HL)
000640 4640 2B               6      DEC HL
000641 4641 B7               4      OR  A
000642 4642 2803            12      JR  Z,ROM_RUN1
000644 4644 CD0545          17      CALL    ROM_LOAD
       4647                     ROM_RUN1:
000647 4647 3E8A             7      LD  A,08AH          ;RUN
000649 4649 77               7      LD  (HL),A
00064A 464A C9              10      RET
                                
       464B                     ROM_FILES:
00064B 464B CDA446          17      CALL    INIT_PARAM
00064E 464E CD9749          17      CALL    FILE_B
000651 4651 CD0951          17      CALL    GET_DISK_BANK_FDRV
000654 4654 3ABCF2          13      LD  A,(SECSZ_H)
000657 4657 CDC74F          17      CALL    IS_BPB1
00065A 465A DA5A45          10      JP  C,ERROR_DEVICE_IO_ERROR
00065D 465D 3AECF2          13      LD  A,(FNAME)
000660 4660 FE21             7      CP  021H
000662 4662 3005            12      JR  NC,RFILES0
000664 4664 060B             7      LD  B,11
000666 4666 CD6A4A          17      CALL    FILE10
       4669                     RFILES0:
000669 4669 CD744D          17      CALL    GET_DIR_DAT
       466C                     RFILES1:
00066C 466C CD324B          17      CALL    FILESE
00066F 466F 302E            12      JR  NC,RFILES_NOT_MATCH
       4671                     RFILES_DISP:
000671 4671 E5              11      PUSH    HL
000672 4672 0608             7      LD  B,8
000674 4674 CD7D43          17      CALL    MSN
000677 4677 3E2E             7      LD  A,'.'
000679 4679 CD7E51          17      CALL    MSG_A
00067C 467C 0603             7      LD  B,3
00067E 467E CD7D43          17      CALL    MSN
000681 4681 3ADDF3          13      LD  A,(CSRX)
000684 4684 47               4      LD  B,A
000685 4685 3AB0F3          13      LD  A,(LINLEN)
000688 4688 90               4      SUB B
000689 4689 FE0C             7      CP  12
00068B 468B 3009            12      JR  NC,RFILES2
00068D 468D 3E0D             7      LD  A,00DH      ;改行
00068F 468F CD7E51          17      CALL    MSG_A
000692 4692 3E0A             7      LD  A,00AH
000694 4694 1802            12      JR  RFILES3
       4696                     RFILES2:
000696 4696 3E20             7      LD  A,020H
       4698                     RFILES3:
000698 4698 CD7E51          17      CALL    MSG_A
00069B 469B E1              10      POP HL
00069C 469C CD4E4B          17      CALL    FNEXT
       469F                     RFILES_NOT_MATCH:
00069F 469F 20CB            12      JR  NZ,RFILES1
0006A1 46A1 C30446          10      JP  ROM_NEXT
                                
       46A4                     INIT_PARAM:
0006A4 46A4 22E5F2          16      LD  (PARAM0),HL
0006A7 46A7 22E7F2          16      LD  (PARAM1),HL
0006AA 46AA EB               4      EX  DE,HL
0006AB 46AB 32BEFC          13      LD  (RUNBNF),A
0006AE 46AE 3263F6          13      LD  (VALTYP),A
0006B1 46B1 E5              11      PUSH    HL
0006B2 46B2 2ADEF2          16      LD  HL,(_CD)
0006B5 46B5 22E9F2          16      LD  (_CDX),HL
0006B8 46B8 E1              10      POP HL
0006B9 46B9 13               6      INC DE
0006BA 46BA CDA64A          17      CALL    SPCUT
0006BD 46BD 1A               7      LD  A,(DE)
0006BE 46BE B7               4      OR  A
0006BF 46BF C8              11      RET Z
0006C0 46C0 FE3A             7      CP  ':'
0006C2 46C2 C8              11      RET Z
0006C3 46C3 FE28             7      CP  '('
0006C5 46C5 C8              11      RET Z
0006C6 46C6 EB               4      EX  DE,HL
0006C7 46C7 DD21644C        14      LD  IX,FRMEVL
0006CB 46CB FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0006CF 46CF CD1C00          17      CALL    _CALSLT
0006D2 46D2 22E7F2          16      LD  (PARAM1),HL
0006D5 46D5 C9              10      RET
                                
       46D6                     ROM_COPY:
0006D6 46D6 CDA446          17      CALL    INIT_PARAM
0006D9 46D9 3A63F6          13      LD  A,(VALTYP)
0006DC 46DC FE03             7      CP  3       ;string
0006DE 46DE C29249          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
0006E1 46E1 CD9749          17      CALL    FILE_B
0006E4 46E4 CD164B          17      CALL    ROM_OPEN
0006E7 46E7 DA6345          10      JP  C,ERROR_FILE_NOT_FOUND
                                
0006EA 46EA 21D1F2          10      LD  HL,_BUF_W
0006ED 46ED 22C7F2          16      LD  (_DTA),HL
0006F0 46F0 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
0006F3 46F3 CDF648          17      CALL    ROM_READ
                                
0006F6 46F6 AF               4      XOR A
0006F7 46F7 32CCF2          13      LD  (_BUF_LO),A     ;PSET
0006FA 46FA 32D9F2          13      LD  (_BUF_O),A      ;向き
                                
0006FD 46FD 2AE7F2          16      LD  HL,(PARAM1)
       4700                     RCP_PARAM1:
000700 4700 7E               7      LD  A,(HL)
000701 4701 23               6      INC HL
000702 4702 B7               4      OR  A
000703 4703 CA9249          10      JP  Z,ROM_ORG
000706 4706 FE3A             7      CP  ':'
000708 4708 CA9249          10      JP  Z,ROM_ORG
00070B 470B FE2C             7      CP  ','
00070D 470D 2012            12      JR  NZ,RCP_PARAM1_
                                
00070F 470F DD212F54        14      LD  IX,FRMQNT
000713 4713 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000717 4717 CD1C00          17      CALL    _CALSLT
00071A 471A 7B               4      LD  A,E
00071B 471B 87               4      ADD A,A
00071C 471C 87               4      ADD A,A
00071D 471D 32D9F2          13      LD  (_BUF_O),A
000720 4720 7E               7      LD  A,(HL)
       4721                     RCP_PARAM1_:
000721 4721 FE28             7      CP  '('
000723 4723 20DB            12      JR  NZ,RCP_PARAM1
                                
000725 4725 DD212F54        14      LD  IX,FRMQNT
000729 4729 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00072D 472D CD1C00          17      CALL    _CALSLT
                                
000730 4730 ED53D5F2        20      LD  (_BUF_X),DE
                                
       4734                     RCP_PARAM2:
000734 4734 23               6      INC HL
000735 4735 7E               7      LD  A,(HL)
000736 4736 FE20             7      CP  020H
000738 4738 28FA            12      JR  Z,RCP_PARAM2
00073A 473A FE2C             7      CP  ','
00073C 473C 28F6            12      JR  Z,RCP_PARAM2
                                
00073E 473E DD212F54        14      LD  IX,FRMQNT
000742 4742 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000746 4746 CD1C00          17      CALL    _CALSLT
                                
000749 4749 3AF6FA          13      LD  A,(ACPAGE)
00074C 474C 57               4      LD  D,A
00074D 474D ED53D7F2        20      LD  (_BUF_Y),DE
       4751                     RCP_PARAM3:
000751 4751 23               6      INC HL
000752 4752 7E               7      LD  A,(HL)
000753 4753 FE20             7      CP  020H
000755 4755 28FA            12      JR  Z,RCP_PARAM3
000757 4757 FE29             7      CP  ')'
000759 4759 28F6            12      JR  Z,RCP_PARAM3
00075B 475B FE2C             7      CP  ','
00075D 475D 2033            12      JR  NZ,RCP_ST
                                
00075F 475F 23               6      INC HL
000760 4760 DD212F54        14      LD  IX,FRMQNT
000764 4764 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000768 4768 CD1C00          17      CALL    _CALSLT
                                
00076B 476B 7B               4      LD  A,E
00076C 476C 32D8F2          13      LD  (_BUF_P),A
                                
       476F                     RCP_PARAM4:
00076F 476F 7E               7      LD  A,(HL)
000770 4770 23               6      INC HL
000771 4771 FE20             7      CP  020H
000773 4773 28FA            12      JR  Z,RCP_PARAM4
                                
000775 4775 FE2C             7      CP  ','
000777 4777 2019            12      JR  NZ,RCP_ST
                                
000779 4779 7E               7      LD  A,(HL)
00077A 477A 0604             7      LD  B,4
00077C 477C FEC3             7      CP  0C3H        ;PRESET
00077E 477E 280E            12      JR  Z,RCP_LO
000780 4780 05               4      DEC B       ;3
000781 4781 D6F8             7      SUB 0F8H        ;XOR
000783 4783 2809            12      JR  Z,RCP_LO
000785 4785 05               4      DEC B       ;2
000786 4786 3C               4      INC A       ;OR
000787 4787 2805            12      JR  Z,RCP_LO
000789 4789 05               4      DEC B       ;1
00078A 478A 3C               4      INC A       ;AND
00078B 478B 2801            12      JR  Z,RCP_LO
00078D 478D 05               4      DEC B       ;0
                                                ;PSET
       478E                     RCP_LO:
00078E 478E 78               4      LD  A,B
00078F 478F 32CCF2          13      LD  (_BUF_LO),A
       4792                     RCP_ST:
000792 4792 2AC6F6          16      LD  HL,(STREND)
000795 4795 22C7F2          16      LD  (_DTA),HL
000798 4798 EB               4      EX  DE,HL
000799 4799 2100FE          10      LD  HL,-512
00079C 479C 39              11      ADD HL,SP
00079D 479D AF               4      XOR A
00079E 479E ED52            15      SBC HL,DE
0007A0 47A0 3008            12      JR  NC,RCP0
0007A2 47A2 215EF5          10      LD  HL,BUF
0007A5 47A5 22C7F2          16      LD  (_DTA),HL
0007A8 47A8 6F               4      LD  L,A ;0
0007A9 47A9 67               4      LD  H,A ;0
       47AA                     RCP0:
0007AA 47AA 24               4      INC H
0007AB 47AB 22CFF2          16      LD  (_BUF_EN),HL
       47AE                     RCP1:
0007AE 47AE F3               4      DI
0007AF 47AF CD8448          17      CALL    WAIT_VDP
                                
0007B2 47B2 3A0700          13      LD  A,(WRVDP)
0007B5 47B5 4F               4      LD  C,A
0007B6 47B6 0C               4      INC C       ;C := PORT#1's address(WR)
0007B7 47B7 3E24             7      LD  A,36
0007B9 47B9 ED79            12      OUT (C),A
0007BB 47BB 3E91             7      LD  A,080H+17
0007BD 47BD ED79            12      OUT (C),A       ;R#17 := 36
                                
0007BF 47BF 0C               4      INC C
0007C0 47C0 0C               4      INC C       ;C := PORT#3's address(WR)
0007C1 47C1 2AD5F2          16      LD  HL,(_BUF_X)
0007C4 47C4 ED69            12      OUT (C),L       ;R#36 DX
0007C6 47C6 ED61            12      OUT (C),H       ;R#37
0007C8 47C8 2AD7F2          16      LD  HL,(_BUF_Y)
0007CB 47CB ED69            12      OUT (C),L       ;R#38 DY
0007CD 47CD ED61            12      OUT (C),H       ;R#39
0007CF 47CF 2AD1F2          16      LD  HL,(_BUF_W)
0007D2 47D2 ED69            12      OUT (C),L       ;R#40 NX
0007D4 47D4 ED61            12      OUT (C),H       ;R#41
0007D6 47D6 2AD3F2          16      LD  HL,(_BUF_H)
0007D9 47D9 ED69            12      OUT (C),L       ;R#42 NY
0007DB 47DB ED61            12      OUT (C),H       ;R#43
                                
0007DD 47DD DD2AAFFC        20      LD  IX,(SCRMOD)
0007E1 47E1 3ACCF2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0007E4 47E4 B7               4      OR  A
0007E5 47E5 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
0007E7 47E7 DD7D             9      LD  A,IXL
0007E9 47E9 FE08             7      CP  8
0007EB 47EB 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
0007ED 47ED FE06             7      CP  6
0007EF 47EF 2AD5F2          16      LD  HL,(_BUF_X)
0007F2 47F2 3AD1F2          13      LD  A,(_BUF_W)
0007F5 47F5 2005            12      JR  NZ,SCR57
0007F7 47F7 B5               4      OR  L       ;スクリーン6
0007F8 47F8 E603             7      AND 3
0007FA 47FA 200D            12      JR  NZ,USE_LMMC
       47FC                     SCR57:              ;スクリーン5,7
0007FC 47FC B5               4      OR  L
0007FD 47FD E601             7      AND 1
0007FF 47FF 2008            12      JR  NZ,USE_LMMC
       4801                     USE_HMMC:
000801 4801 DD2E08          10      LD  IXL,8
       4804                     USE_HMMC8:
000804 4804 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
000806 4806 32CCF2          13      LD  (_BUF_LO),A
       4809                     USE_LMMC:
000809 4809 110000          10      LD  DE,0
00080C 480C 06FF             7      LD  B,-1
00080E 480E CDAF48          17      CALL    GET_PIXEL
000811 4811 ED79            12      OUT (C),A       ;R#44 first DATA
000813 4813 3AD9F2          13      LD  A,(_BUF_O)
000816 4816 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
000818 4818 3ACCF2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00081B 481B F6B0             7      OR  0B0H        ;R#46 LMMC command
00081D 481D ED79            12      OUT (C),A
                                
00081F 481F FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
000821 4821 0D               4      DEC C
000822 4822 0D               4      DEC C       ;C := PORT#1's address(WR)
000823 4823 3EAC             7      LD  A,080H+44
000825 4825 ED79            12      OUT (C),A
000827 4827 3E91             7      LD  A,080H+17
000829 4829 ED79            12      OUT (C),A       ;R#17 := 44
                                
00082B 482B 3A0600          13      LD  A,(RDVDP)
00082E 482E 3C               4      INC A
00082F 482F FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
000831 4831 3E02             7      LD  A,2
000833 4833 ED79            12      OUT (C),A
000835 4835 3E8F             7      LD  A,08FH
000837 4837 ED79            12      OUT (C),A
000839 4839 3ACCF2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00083C 483C E640             7      AND 040H
00083E 483E 201C            12      JR  NZ,LOOP_HMMC
       4840                     LOOP_COPY:
000840 4840 CDAF48          17      CALL    GET_PIXEL
000843 4843 08               4      EX  AF,AF'
000844 4844 FD4C             9      LD  C,IYH
       4846                     LOOP_COPY1:
000846 4846 ED78            12      IN  A,(C)
000848 4848 0F               4      RRCA            ;RRCAではサインフラグは変化しない
000849 4849 300A            12      JR  NC,EXIT_COPY    ;check CE bit
00084B 484B F24648          10      JP  P,LOOP_COPY1    ;check TR bit
00084E 484E 08               4      EX  AF,AF'
00084F 484F FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000851 4851 ED79            12      OUT (C),A
000853 4853 18EB            12      JR  LOOP_COPY
                                
       4855                     EXIT_COPY:
000855 4855 CD8C48          17      CALL    GET_STATUS_0
000858 4858 FB               4      EI
000859 4859 C30446          10      JP  ROM_NEXT
                                
       485C                     LOOP_HMMC:
00085C 485C F3               4      DI          ;必要
00085D 485D FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
00085F 485F 43               4      LD  B,E
000860 4860 7B               4      LD  A,E
000861 4861 B7               4      OR  A
000862 4862 2802            12      JR  Z,LOOP_HMMC1
000864 4864 EDB3                    OTIR
       4866                     LOOP_HMMC1:
000866 4866 14               4      INC D
       4867                     LOOP_HMMC2:
000867 4867 15               4      DEC D
000868 4868 2805            12      JR  Z,LOOP_HMMC3
00086A 486A EDB3                    OTIR
00086C 486C C36748          10      JP  LOOP_HMMC2
       486F                     LOOP_HMMC3:
00086F 486F ED78            12      IN  A,(C)
000871 4871 0F               4      RRCA
000872 4872 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
000874 4874 2ACFF2          16      LD  HL,(_BUF_EN)
000877 4877 CDF648          17      CALL    ROM_READ
00087A 487A EB               4      EX  DE,HL
00087B 487B 2AC7F2          16      LD  HL,(_DTA)
00087E 487E 7A               4      LD  A,D
00087F 487F B3               4      OR  E
000880 4880 20DA            12      JR  NZ,LOOP_HMMC
000882 4882 18C2            12      JR  LOOP_COPY1
                                    
       4884                     WAIT_VDP:
000884 4884 3E02             7      LD  A,2
000886 4886 CD8D48          17      CALL    GET_STATUS
000889 4889 0F               4      RRCA
00088A 488A 38F8            12      JR  C,WAIT_VDP
       488C                     GET_STATUS_0:
00088C 488C AF               4      XOR A
       488D                     GET_STATUS:
00088D 488D C5              11      PUSH    BC
00088E 488E ED4B0600        20      LD  BC,(RDVDP)
000892 4892 0C               4      INC C
000893 4893 ED79            12      OUT (C),A
000895 4895 3E8F             7      LD  A,08FH
000897 4897 ED79            12      OUT (C),A
000899 4899 ED78            12      IN  A,(C)
00089B 489B C1              10      POP BC
00089C 489C C9              10      RET
                                
       489D                     GET_PIXEL256:
00089D 489D 7A               4      LD  A,D
00089E 489E B3               4      OR  E
00089F 489F 200A            12      JR  NZ,GET_PIXEL1
0008A1 48A1 2ACFF2          16      LD  HL,(_BUF_EN)
0008A4 48A4 CDF648          17      CALL    ROM_READ
0008A7 48A7 EB               4      EX  DE,HL
0008A8 48A8 2AC7F2          16      LD  HL,(_DTA)
       48AB                     GET_PIXEL1:
0008AB 48AB 7E               7      LD  A,(HL)
0008AC 48AC 23               6      INC HL
0008AD 48AD 1B               6      DEC DE
0008AE 48AE C9              10      RET
                                
       48AF                     GET_PIXEL:
0008AF 48AF DD7D             9      LD  A,IXL
0008B1 48B1 FE08             7      CP  8
0008B3 48B3 28E8            12      JR  Z,GET_PIXEL256
0008B5 48B5 04               4      INC B
0008B6 48B6 FE06             7      CP  6
0008B8 48B8 282E            12      JR  Z,GET_PIXEL4
                                
0008BA 48BA CB40             8      BIT 0,B
0008BC 48BC 20ED            12      JR  NZ,GET_PIXEL1
                                
0008BE 48BE 7A               4      LD  A,D
0008BF 48BF B3               4      OR  E
0008C0 48C0 200A            12      JR  NZ,GET_PIXEL2
                                
0008C2 48C2 2ACFF2          16      LD  HL,(_BUF_EN)
0008C5 48C5 CDF648          17      CALL    ROM_READ
0008C8 48C8 EB               4      EX  DE,HL
0008C9 48C9 2AC7F2          16      LD  HL,(_DTA)
                                
       48CC                     GET_PIXEL2:
0008CC 48CC 7E               7      LD  A,(HL)
0008CD 48CD 0F               4      RRCA
0008CE 48CE 0F               4      RRCA
0008CF 48CF 0F               4      RRCA
0008D0 48D0 0F               4      RRCA
0008D1 48D1 C9              10      RET
                                
       48D2                     GET_PIXEL3:
0008D2 48D2 7A               4      LD  A,D
0008D3 48D3 B3               4      OR  E
0008D4 48D4 200A            12      JR  NZ,GET_PIXEL5
                                
0008D6 48D6 2ACFF2          16      LD  HL,(_BUF_EN)
0008D9 48D9 CDF648          17      CALL    ROM_READ
0008DC 48DC EB               4      EX  DE,HL
0008DD 48DD 2AC7F2          16      LD  HL,(_DTA)
       48E0                     GET_PIXEL5:
0008E0 48E0 7E               7      LD  A,(HL)
0008E1 48E1 0F               4      RRCA
0008E2 48E2 0F               4      RRCA
0008E3 48E3 0F               4      RRCA
0008E4 48E4 0F               4      RRCA
0008E5 48E5 0F               4      RRCA
0008E6 48E6 0F               4      RRCA
0008E7 48E7 C9              10      RET
                                
       48E8                     GET_PIXEL4:
0008E8 48E8 78               4      LD  A,B
0008E9 48E9 E603             7      AND 3   ;+0
0008EB 48EB 28E5            12      JR  Z,GET_PIXEL3
0008ED 48ED 3D               4      DEC A   ;+1
0008EE 48EE 28DC            12      JR  Z,GET_PIXEL2
0008F0 48F0 3D               4      DEC A   ;+2
0008F1 48F1 7E               7      LD  A,(HL)
0008F2 48F2 C0              11      RET NZ
0008F3 48F3 0F               4      RRCA        ;+3
0008F4 48F4 0F               4      RRCA
0008F5 48F5 C9              10      RET
                                
       48F6                     ROM_READ:
0008F6 48F6 E5              11      PUSH    HL
0008F7 48F7 D5              11      PUSH    DE
0008F8 48F8 C5              11      PUSH    BC
0008F9 48F9 FDE5            15      PUSH    IY
0008FB 48FB 22E3F2          16      LD  (LEFTX),HL
0008FE 48FE 2AC7F2          16      LD  HL,(_DTA)
000901 4901 22DAF2          16      LD  (DTAX),HL
000904 4904 2AE3F2          16      LD  HL,(LEFTX)
                                
000907 4907 CDA84B          17      CALL    RBX1
00090A 490A 3870            12      JR  C,RBRERR1
00090C 490C 79               4      LD  A,C
00090D 490D EB               4      EX  DE,HL
00090E 490E ED52            15      SBC HL,DE       ;CP 0HL,CDE
000910 4910 19              11      ADD HL,DE
000911 4911 DE00             7      SBC A,000H
000913 4913 3801            12      JR  C,RBR1
000915 4915 EB               4      EX  DE,HL
       4916                     RBR1:
000916 4916 9F               4      SBC A,A
000917 4917 E601             7      AND 1
000919 4919 32B6F2          13      LD  (_RESULT),A
00091C 491C 7C               4      LD  A,H
00091D 491D B5               4      OR  L
00091E 491E CA7249          10      JP  Z,RBREND0
                                
000921 4921 22C3F2          16      LD  (_LEFT),HL  ;Read record byte
000924 4924 22E3F2          16      LD  (LEFTX),HL
                                
000927 4927 CDD44B          17      CALL    RBX2
00092A 492A 281A            12      JR  Z,RBRB
                                                ;先頭の端数
00092C 492C CDE74B          17      CALL    RBXA
00092F 492F DA8849          10      JP  C,RBRERR
000932 4932 C5              11      PUSH    BC
000933 4933 CDFE43          17      CALL    ROM_LDIR
000936 4936 ED53DAF2        20      LD  (DTAX),DE
00093A 493A 2AE3F2          16      LD  HL,(LEFTX)
00093D 493D D1              10      POP DE
00093E 493E A7               4      AND A
00093F 493F ED52            15      SBC HL,DE
000941 4941 22E3F2          16      LD  (LEFTX),HL
000944 4944 2829            12      JR  Z,RBREND
                                
       4946                     RBRB:
000946 4946 CD234C          17      CALL    RBXB
000949 4949 2818            12      JR  Z,RBRC
       494B                     RBRB1:
00094B 494B C5              11      PUSH    BC
00094C 494C D5              11      PUSH    DE
00094D 494D CDCE4C          17      CALL    CLUST
000950 4950 EB               4      EX  DE,HL
000951 4951 ED4BB9F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000955 4955 CDFE43          17      CALL    ROM_LDIR
000958 4958 EB               4      EX  DE,HL
000959 4959 D1              10      POP DE
00095A 495A C1              10      POP BC
00095B 495B CDAB4C          17      CALL    GNCL
00095E 495E DA8849          10      JP  C,RBRERR
000961 4961 10E8            13      DJNZ    RBRB1
       4963                     RBRC:
000963 4963 CD3B4C          17      CALL    RBXC
000966 4966 2807            12      JR  Z,RBREND
                                
000968 4968 CDCE4C          17      CALL    CLUST
00096B 496B EB               4      EX  DE,HL
00096C 496C CDFE43          17      CALL    ROM_LDIR
       496F                     RBREND:
00096F 496F CD474C          17      CALL    RBXEND
       4972                     RBREND0:
000972 4972 FDE1            14      POP IY
000974 4974 C1              10      POP BC
000975 4975 D1              10      POP DE
000976 4976 F1              10      POP AF  ;(HL)
000977 4977 AF               4      XOR A
000978 4978 3AB6F2          13      LD  A,(_RESULT)
00097B 497B C9              10      RET
                                
       497C                     RBRERR1:
00097C 497C 3E01             7      LD  A,001H
       497E                     RBRERR2:
00097E 497E FDE1            14      POP IY
000980 4980 C1              10      POP BC
000981 4981 D1              10      POP DE
000982 4982 E1              10      POP HL
000983 4983 37               4      SCF
000984 4984 210000          10      LD  HL,0
000987 4987 C9              10      RET
       4988                     RBRERR:
000988 4988 3EFF             7      LD  A,0FFH
00098A 498A 18F2            12      JR  RBRERR2
                                
       498C                     FILE_DD:
00098C 498C E1              10      POP HL
00098D 498D 3E                      DB  03EH
00098E 498E C9              10      RET
00098F 498F 32A3F2          13      LD  (SWC_BLOAD_M),A
       4992                     ROM_ORG:
000992 4992 2AE5F2          16      LD  HL,(PARAM0)
000995 4995 7E               7      LD  A,(HL)
000996 4996 C9              10      RET
       4997                     FILE_B:
000997 4997 AF               4      XOR A
000998 4998 32EBF2          13      LD  (FDRV),A
00099B 499B 1E00             7      LD  E,0
00099D 499D 3A63F6          13      LD  A,(VALTYP)
0009A0 49A0 FE03             7      CP  3       ;string
0009A2 49A2 C2274A          10      JP  NZ,FILED
                                
0009A5 49A5 DD21D067        14      LD  IX,FRESTR
0009A9 49A9 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009AD 49AD CD1C00          17      CALL    _CALSLT
0009B0 49B0 E5              11      PUSH    HL
0009B1 49B1 DDE1            14      POP IX
                                
0009B3 49B3 DD5E00          19      LD  E,(IX+0)
0009B6 49B6 DD7E01          19      LD  A,(IX+1)
0009B9 49B9 DD5602          19      LD  D,(IX+2)
0009BC 49BC DD62             9      LD  IXH,D
0009BE 49BE DD6F             9      LD  IXL,A
0009C0 49C0 7B               4      LD  A,E
       49C1                     FILE_BDOS:
0009C1 49C1 FE04             7      CP  4
0009C3 49C3 3808            12      JR  C,FILEB1
0009C5 49C5 DD7E03          19      LD  A,(IX+3)
0009C8 49C8 FE3A             7      CP  ':'
0009CA 49CA 28C0            12      JR  Z,FILE_DD
0009CC 49CC 7B               4      LD  A,E
       49CD                     FILEB1:
0009CD 49CD FE02             7      CP  2
0009CF 49CF 3818            12      JR  C,DEVI1
0009D1 49D1 DD7E01          19      LD  A,(IX+1)
0009D4 49D4 FE3A             7      CP  ':'
0009D6 49D6 2011            12      JR  NZ,DEVI1
0009D8 49D8 DD7E00          19      LD  A,(IX+0)        ;DRIVE
0009DB 49DB CD004B          17      CALL    CAP
0009DE 49DE D640             7      SUB '@'
0009E0 49E0 DD23            10      INC IX
0009E2 49E2 DD23            10      INC IX
0009E4 49E4 1D               4      DEC E
0009E5 49E5 1D               4      DEC E
0009E6 49E6 32EBF2          13      LD  (FDRV),A
       49E9                     DEVI1:
0009E9 49E9 DD7E00          19      LD  A,(IX+0)
0009EC 49EC D65C             7      SUB 05CH        ;\
0009EE 49EE 2008            12      JR  NZ,NOROOT
0009F0 49F0 6F               4      LD  L,A
0009F1 49F1 67               4      LD  H,A
0009F2 49F2 22E9F2          16      LD  (_CDX),HL
0009F5 49F5 DD23            10      INC IX
0009F7 49F7 1D               4      DEC E
       49F8                     NOROOT:
                                
       49F8                     SETDIR:
0009F8 49F8 CD274A          17      CALL    FILED
0009FB 49FB DD7E00          19      LD  A,(IX+0)
0009FE 49FE FE5C             7      CP  05CH        ;\
000A00 4A00 C0              11      RET NZ
000A01 4A01 DD23            10      INC IX
000A03 4A03 1D               4      DEC E
000A04 4A04 3AECF2          13      LD  A,(FNAME)
000A07 4A07 FE20             7      CP  020H        ;. の処理
000A09 4A09 28ED            12      JR  Z,SETDIR
                                
000A0B 4A0B CD164B          17      CALL    ROM_OPEN
000A0E 4A0E B7               4      OR  A
000A0F 4A0F C0              11      RET NZ
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                #else
000A10 4A10 FD2AE0F2        20      LD  IY,(DIRENT1)
000A14 4A14 FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000A18 4A18 C8              11      RET Z
000A19 4A19 CD6E4A          17      CALL    FILEI
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
000A1C 4A1C FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000A1F 4A1F FD661B          19      LD  H,(IY+01BH)
                                #endif
000A22 4A22 22E9F2          16      LD  (_CDX),HL
000A25 4A25 18D1            12      JR  SETDIR
                                
       4A27                     FILED:
000A27 4A27 CD6E4A          17      CALL    FILEI
000A2A 4A2A 21ECF2          10      LD  HL,FNAME
                                
000A2D 4A2D 0608             7      LD  B,8
       4A2F                     FILE2:
000A2F 4A2F CD7B4A          17      CALL    CCHKF
000A32 4A32 C8              11      RET Z
000A33 4A33 FE2A             7      CP  '*'
000A35 4A35 282E            12      JR  Z,FILE9
000A37 4A37 FE2E             7      CP  '.'
000A39 4A39 280C            12      JR  Z,FILE4
000A3B 4A3B 77               7      LD  (HL),A
000A3C 4A3C 23               6      INC HL
000A3D 4A3D 10F0            13      DJNZ    FILE2
                                
       4A3F                     FILE3:
000A3F 4A3F CD7B4A          17      CALL    CCHKF
000A42 4A42 C8              11      RET Z
000A43 4A43 FE2E             7      CP  '.'
000A45 4A45 20F8            12      JR  NZ,FILE3
                                
       4A47                     FILE4:
000A47 4A47 21F4F2          10      LD  HL,FNAME+8
000A4A 4A4A 0603             7      LD  B,3
                                
       4A4C                     FILE4L:
000A4C 4A4C CD7B4A          17      CALL    CCHKF
000A4F 4A4F C8              11      RET Z
000A50 4A50 FE2E             7      CP  '.'
000A52 4A52 2008            12      JR  NZ,FILE12
000A54 4A54 32ECF2          13      LD  (FNAME),A   ;Parent directory(..)
000A57 4A57 32EDF2          13      LD  (FNAME+1),A
000A5A 4A5A 3E20             7      LD  A,020H
       4A5C                     FILE12:
000A5C 4A5C FE2A             7      CP  '*'
000A5E 4A5E 280A            12      JR  Z,FILE10
000A60 4A60 77               7      LD  (HL),A
000A61 4A61 23               6      INC HL
000A62 4A62 10E8            13      DJNZ    FILE4L
000A64 4A64 C9              10      RET
                                
       4A65                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000A65 4A65 CD6A4A          17      CALL    FILE10
000A68 4A68 18D5            12      JR  FILE3
                                
       4A6A                     FILE10:
000A6A 4A6A 3E3F             7      LD  A,'?'
000A6C 4A6C 1808            12      JR  FILL_MEMORY
       4A6E                     FILEI:              ;名前＋拡張子をスペースで初期化
000A6E 4A6E 3E20             7      LD  A,020H
000A70 4A70 01000B          10      LD  BC,11*256   ;C=0にしておく
000A73 4A73 21ECF2          10      LD  HL,FNAME
       4A76                     FILL_MEMORY:            ;HLからBバイトAで埋める
000A76 4A76 77               7      LD  (HL),A
000A77 4A77 23               6      INC HL
000A78 4A78 10FC            13      DJNZ    FILL_MEMORY
000A7A 4A7A C9              10      RET
                                
       4A7B                     CCHKF:
000A7B 4A7B 7B               4      LD  A,E
000A7C 4A7C B7               4      OR  A
000A7D 4A7D C8              11      RET Z
000A7E 4A7E DD7E00          19      LD  A,(IX+0)
000A81 4A81 CD884A          17      CALL    CCHK2
000A84 4A84 C8              11      RET Z
000A85 4A85 C3EB4A          10      JP  FKAN
                                
       4A88                     CCHK2:
000A88 4A88 0C               4      INC C
000A89 4A89 0D               4      DEC C
000A8A 4A8A C0              11      RET NZ
       4A8B                     CCHK3:              ;ZF=1 で使えない文字
000A8B 4A8B FE2B             7      CP  '+'
000A8D 4A8D C8              11      RET Z
000A8E 4A8E FE2C             7      CP  ','
000A90 4A90 C8              11      RET Z
000A91 4A91 FE2F             7      CP  '/'
000A93 4A93 C8              11      RET Z
000A94 4A94 FE3A             7      CP  ':'
000A96 4A96 C8              11      RET Z
000A97 4A97 FE3B             7      CP  ';'
000A99 4A99 C8              11      RET Z
000A9A 4A9A FE3D             7      CP  '='
000A9C 4A9C C8              11      RET Z
000A9D 4A9D FE5C             7      CP  05CH    ;\
000A9F 4A9F C8              11      RET Z
000AA0 4AA0 FE1F             7      CP  01FH
000AA2 4AA2 D0              11      RET NC
000AA3 4AA3 BF               4      CP  A       ;Z=1
000AA4 4AA4 C9              10      RET
                                
       4AA5                     SS1:
000AA5 4AA5 13               6      INC DE
       4AA6                     SPCUT:              ;スペースをカット
000AA6 4AA6 1A               7      LD  A,(DE)
000AA7 4AA7 FE20             7      CP  020H
000AA9 4AA9 28FA            12      JR  Z,SS1
000AAB 4AAB C9              10      RET
                                
       4AAC                     SCREOF1:
000AAC 4AAC 13               6      INC DE
       4AAD                     SPCUTEX:            ;スペース改行などをカット
000AAD 4AAD 1A               7      LD  A,(DE)
000AAE 4AAE FE20             7      CP  020H
000AB0 4AB0 28FA            12      JR  Z,SCREOF1
000AB2 4AB2 FE0D             7      CP  00DH
000AB4 4AB4 28F6            12      JR  Z,SCREOF1
000AB6 4AB6 FE0A             7      CP  00AH
000AB8 4AB8 28F2            12      JR  Z,SCREOF1
000ABA 4ABA FE1A             7      CP  01AH
000ABC 4ABC 28EE            12      JR  Z,SCREOF1
000ABE 4ABE C9              10      RET
                                
       4ABF                     GETNUM:
000ABF 4ABF 210000          10      LD  HL,0
       4AC2                     GETNUM1:
000AC2 4AC2 1A               7      LD  A,(DE)
000AC3 4AC3 13               6      INC DE
000AC4 4AC4 D630             7      SUB '0'
000AC6 4AC6 D8              11      RET C
000AC7 4AC7 FE0A             7      CP  10
000AC9 4AC9 D0              11      RET NC
000ACA 4ACA 4D               4      LD  C,L
000ACB 4ACB 44               4      LD  B,H
000ACC 4ACC 29              11      ADD HL,HL   ;*2
000ACD 4ACD 29              11      ADD HL,HL   ;*4
000ACE 4ACE 09              11      ADD HL,BC   ;*5
000ACF 4ACF 29              11      ADD HL,HL   ;*10
000AD0 4AD0 4F               4      LD  C,A
000AD1 4AD1 0600             7      LD  B,0
000AD3 4AD3 09              11      ADD HL,BC
000AD4 4AD4 18EC            12      JR  GETNUM1
                                
       4AD6                     SEARCH_END:
000AD6 4AD6 7E               7      LD  A,(HL)
       4AD7                     SEARCH_END1:
000AD7 4AD7 23               6      INC HL
000AD8 4AD8 B7               4      OR  A
000AD9 4AD9 C8              11      RET Z
000ADA 4ADA FE3A             7      CP  ':'
000ADC 4ADC 20F8            12      JR  NZ,SEARCH_END
000ADE 4ADE 7E               7      LD  A,(HL)
000ADF 4ADF FE3A             7      CP  ':'
000AE1 4AE1 28F4            12      JR  Z,SEARCH_END1
000AE3 4AE3 C9              10      RET
                                
       4AE4                     FKANC:
000AE4 4AE4 CB41             8      BIT 0,C
000AE6 4AE6 CC094B          17      CALL    Z,CAP2
000AE9 4AE9 1803            12      JR  FKANX
       4AEB                     FKAN:           ;漢字チェック
000AEB 4AEB DD23            10      INC IX
000AED 4AED 1D               4      DEC E
       4AEE                     FKANX:
000AEE 4AEE CB41             8      BIT 0,C
000AF0 4AF0 CB81             8      RES 0,C
000AF2 4AF2 C0              11      RET NZ
000AF3 4AF3 FE80             7      CP  080H
000AF5 4AF5 D8              11      RET C
000AF6 4AF6 FEA0             7      CP  0A0H
000AF8 4AF8 3803            12      JR  C,FKAN1
000AFA 4AFA FEE0             7      CP  0E0H
000AFC 4AFC D8              11      RET C
       4AFD                     FKAN1:
000AFD 4AFD 0C               4      INC C
000AFE 4AFE A7               4      AND A
000AFF 4AFF C9              10      RET
                                
       4B00                     CAP:
000B00 4B00 FE61             7      CP  'a'
000B02 4B02 D8              11      RET C
000B03 4B03 FE7B             7      CP  'z'+1
000B05 4B05 D0              11      RET NC
000B06 4B06 D620             7      SUB 020H
000B08 4B08 C9              10      RET
       4B09                     CAP2:
000B09 4B09 CD004B          17      CALL    CAP
       4B0C                     CAP3:               ;
000B0C 4B0C FE05             7      CP  5
000B0E 4B0E 2803            12      JR  Z,CAP4
000B10 4B10 FE21             7      CP  021H
000B12 4B12 C9              10      RET
       4B13                     CAP4:
000B13 4B13 3EE5             7      LD  A,0E5H
000B15 4B15 C9              10      RET
                                
       4B16                     ROM_OPEN:
000B16 4B16 CD0951          17      CALL    GET_DISK_BANK_FDRV
                                
000B19 4B19 CD744D          17      CALL    GET_DIR_DAT
000B1C 4B1C D5              11      PUSH    DE
000B1D 4B1D CD324B          17      CALL    FILESE
000B20 4B20 D1              10      POP DE
000B21 4B21 3F               4      CCF
000B22 4B22 D8              11      RET C
000B23 4B23 22E0F2          16      LD  (DIRENT1),HL
000B26 4B26 E5              11      PUSH    HL
000B27 4B27 210000          10      LD  HL,0
000B2A 4B2A 22BDF2          16      LD  (RR_LOW),HL
000B2D 4B2D 22BFF2          16      LD  (RR_HIGH),HL
000B30 4B30 E1              10      POP HL
000B31 4B31 C9              10      RET
                                
       4B32                     FILESE:
       4B32                     FILESE0:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000B32 4B32 7E               7      LD  A,(HL)
                                #endif
000B33 4B33 B7               4      OR  A
000B34 4B34 C8              11      RET Z       ;END:ZF=1 CF=0
000B35 4B35 FEE5             7      CP  0E5H
000B37 4B37 280D            12      JR  Z,FILESE1
000B39 4B39 11ECF2          10      LD  DE,FNAME
000B3C 4B3C E5              11      PUSH    HL
000B3D 4B3D CD834B          17      CALL    CPFILE
000B40 4B40 CCA44B          17      CALL    Z,CPFILE2
000B43 4B43 E1              10      POP HL
000B44 4B44 37               4      SCF
000B45 4B45 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4B46                     FILESE1:
000B46 4B46 CD4E4B          17      CALL    FNEXT
000B49 4B49 20E7            12      JR  NZ,FILESE0
000B4B 4B4B F6FF             7      OR  0FFH        ;ZF=0 CF=0
000B4D 4B4D C9              10      RET
                                
       4B4E                     FNEXT:
000B4E 4B4E 112000          10      LD  DE,020H
000B51 4B51 19              11      ADD HL,DE
000B52 4B52 ED5BE9F2        20      LD  DE,(_CDX)
000B56 4B56 7A               4      LD  A,D
000B57 4B57 B3               4      OR  E
000B58 4B58 2019            12      JR  NZ,FNEXT_SUBDIR
000B5A 4B5A 0D               4      DEC C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
       4B5B                     CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
000B5B 4B5B F5              11      PUSH    AF      ;※フラグを保存する必要あり
000B5C 4B5C CB7C             8      BIT 7,H
000B5E 4B5E 2811            12      JR  Z,CHECK_DIR_PAGE1
000B60 4B60 7C               4      LD  A,H
000B61 4B61 D620             7      SUB 020H
000B63 4B63 67               4      LD  H,A
000B64 4B64 3AE2F2          13      LD  A,(_DIR_BANK)
000B67 4B67 3C               4      INC A
000B68 4B68 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000B6B 4B6B 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000B6E 4B6E 32E2F2          13      LD  (_DIR_BANK),A
       4B71                     CHECK_DIR_PAGE1:
000B71 4B71 F1              10      POP AF
                                #endif
000B72 4B72 C9              10      RET
                                
       4B73                     FNEXT_SUBDIR:           ;サブディレクトリ
000B73 4B73 0D               4      DEC C
000B74 4B74 C0              11      RET NZ
                                
000B75 4B75 ED5BE9F2        20      LD  DE,(_CDX)
000B79 4B79 CDAB4C          17      CALL    GNCL
000B7C 4B7C EB               4      EX  DE,HL
000B7D 4B7D 22E9F2          16      LD  (_CDX),HL
000B80 4B80 C3B04D          10      JP  GET_SUBDIR
                                
       4B83                     CPFILE:
000B83 4B83 C5              11      PUSH    BC
000B84 4B84 01000B          10      LD  BC,00B00H
       4B87                     CPSTR1:
000B87 4B87 1A               7      LD  A,(DE)
000B88 4B88 FE3F             7      CP  '?'     ;Wild card
000B8A 4B8A 2812            12      JR  Z,CPSTR2
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000B8C 4B8C 7E               7      LD  A,(HL)
                                #endif
000B8D 4B8D CDE44A          17      CALL    FKANC
000B90 4B90 E5              11      PUSH    HL
000B91 4B91 67               4      LD  H,A
000B92 4B92 1A               7      LD  A,(DE)
000B93 4B93 CB01             4      RLC C
000B95 4B95 CDE44A          17      CALL    FKANC
000B98 4B98 CB09             4      RRC C
000B9A 4B9A BC               4      CP  H       ;CP (HL),(DE)
000B9B 4B9B E1              10      POP HL
000B9C 4B9C 2004            12      JR  NZ,CPSTR3
       4B9E                     CPSTR2:
000B9E 4B9E 13               6      INC DE
000B9F 4B9F 23               6      INC HL
000BA0 4BA0 10E5            13      DJNZ    CPSTR1
       4BA2                     CPSTR3:
000BA2 4BA2 C1              10      POP BC
000BA3 4BA3 C9              10      RET
                                
       4BA4                     CPFILE2:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000BA4 4BA4 7E               7      LD  A,(HL)
                                #endif
000BA5 4BA5 E60E             7      AND 00EH    ;~0F1H
000BA7 4BA7 C9              10      RET
                                
       4BA8                     RBX1:
000BA8 4BA8 E5              11      PUSH    HL      ;Record byte
                                
000BA9 4BA9 ED5BBDF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000BAD 4BAD 3AC0F2          13      LD  A,(RR_HIGH+1)
000BB0 4BB0 4F               4      LD  C,A
                                
000BB1 4BB1 3AE2F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001CH
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    CALL    RDSLT_ROM
                                    EX  DE,HL       ;AHL=File size
                                    POP DE
                                #else
000BB4 4BB4 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000BB7 4BB7 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000BBA 4BBA FD2AE0F2        20      LD  IY,(DIRENT1)
000BBE 4BBE FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000BC1 4BC1 FD661D          19      LD  H,(IY+01DH)
000BC4 4BC4 FD7E1E          19      LD  A,(IY+01EH)
                                #endif
                                
000BC7 4BC7 A7               4      AND A
000BC8 4BC8 ED52            15      SBC HL,DE
000BCA 4BCA 99               4      SBC A,C
000BCB 4BCB D1              10      POP DE
                                
000BCC 4BCC D8              11      RET C
000BCD 4BCD 4F               4      LD  C,A
000BCE 4BCE EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000BCF 4BCF B2               4      OR  D
000BD0 4BD0 B3               4      OR  E
000BD1 4BD1 C0              11      RET NZ
000BD2 4BD2 37               4      SCF
000BD3 4BD3 C9              10      RET
                                
       4BD4                     RBX2:
000BD4 4BD4 ED4BBEF2        20      LD  BC,(RR_LOW+1)
000BD8 4BD8 CD5C4C          17      CALL    RWXR
000BDB 4BDB 3ABAF2          13      LD  A,(CLSZ_H)
000BDE 4BDE 3D               4      DEC A
000BDF 4BDF E5              11      PUSH    HL
000BE0 4BE0 2ABDF2          16      LD  HL,(RR_LOW)
000BE3 4BE3 A4               4      AND H
000BE4 4BE4 B5               4      OR  L
000BE5 4BE5 E1              10      POP HL
000BE6 4BE6 C9              10      RET
                                
       4BE7                     RBXA:
000BE7 4BE7 D5              11      PUSH    DE
000BE8 4BE8 CDCE4C          17      CALL    CLUST
000BEB 4BEB ED53C5F2        20      LD  (_DTPS),DE
000BEF 4BEF D1              10      POP DE
000BF0 4BF0 CDAB4C          17      CALL    GNCL
000BF3 4BF3 D8              11      RET C
000BF4 4BF4 ED53C1F2        20      LD  (_CLPS),DE
                                
000BF8 4BF8 ED4BBDF2        20      LD  BC,(RR_LOW)
000BFC 4BFC 2AB9F2          16      LD  HL,(CLSZ)
000BFF 4BFF 7C               4      LD  A,H
000C00 4C00 3D               4      DEC A
000C01 4C01 A0               4      AND B
000C02 4C02 47               4      LD  B,A
000C03 4C03 ED42            15      SBC HL,BC       ;remaining cluster
                                
000C05 4C05 ED5BE3F2        20      LD  DE,(LEFTX)
000C09 4C09 ED52            15      SBC HL,DE       ;CP HL,DE
000C0B 4C0B 19              11      ADD HL,DE
000C0C 4C0C 3801            12      JR  C,RBXA1
000C0E 4C0E EB               4      EX  DE,HL
       4C0F                     RBXA1:
000C0F 4C0F 3AB7F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
000C12 4C12 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C15 4C15 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000C18 4C18 E5              11      PUSH    HL
000C19 4C19 2AC5F2          16      LD  HL,(_DTPS)
000C1C 4C1C 09              11      ADD HL,BC
000C1D 4C1D ED5BDAF2        20      LD  DE,(DTAX)
000C21 4C21 C1              10      POP BC
000C22 4C22 C9              10      RET
                                
       4C23                     RBXB:
000C23 4C23 2ADAF2          16      LD  HL,(DTAX)
000C26 4C26 ED5BC1F2        20      LD  DE,(_CLPS)
000C2A 4C2A 3AE4F2          13      LD  A,(LEFTX+1)
000C2D 4C2D 47               4      LD  B,A
000C2E 4C2E 3ABAF2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4C31                     RBXB1:
000C31 4C31 1F               4      RRA     ;->CF
000C32 4C32 3804            12      JR  C,RBXB2
000C34 4C34 CB38             8      SRL B   ;B=B/2
000C36 4C36 18F9            12      JR  RBXB1
       4C38                     RBXB2:
000C38 4C38 78               4      LD  A,B
000C39 4C39 B7               4      OR  A
000C3A 4C3A C9              10      RET
                                
       4C3B                     RBXC:
000C3B 4C3B ED4BE3F2        20      LD  BC,(LEFTX)
000C3F 4C3F 3ABAF2          13      LD  A,(CLSZ_H)
000C42 4C42 3D               4      DEC A
000C43 4C43 A0               4      AND B
000C44 4C44 47               4      LD  B,A
000C45 4C45 B1               4      OR  C
000C46 4C46 C9              10      RET
                                
       4C47                     RBXEND:
000C47 4C47 ED5BC3F2        20      LD  DE,(_LEFT)
000C4B 4C4B 2ABDF2          16      LD  HL,(RR_LOW)
000C4E 4C4E 3AC0F2          13      LD  A,(RR_HIGH+1)
000C51 4C51 19              11      ADD HL,DE
000C52 4C52 CE00             7      ADC A,0
000C54 4C54 22BDF2          16      LD  (RR_LOW),HL
000C57 4C57 32C0F2          13      LD  (RR_HIGH+1),A
000C5A 4C5A EB               4      EX  DE,HL       ;HL=Read byte
000C5B 4C5B C9              10      RET 
                                
       4C5C                     RWXR:
000C5C 4C5C 3ABAF2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4C5F                     L_RWX:
000C5F 4C5F 1F               4      RRA     ;->CF
000C60 4C60 3806            12      JR  C,E_RWX
000C62 4C62 CB38             8      SRL B   ;BC=BC/2
000C64 4C64 CB19             8      RR  C   ;
000C66 4C66 18F7            12      JR  L_RWX
       4C68                     E_RWX:
000C68 4C68 3AE2F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
                                    PUSH    HL
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    POP HL
                                #else
000C6B 4C6B 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C6E 4C6E 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000C71 4C71 FD2AE0F2        20      LD  IY,(DIRENT1)
000C75 4C75 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000C78 4C78 FD561B          19      LD  D,(IY+01BH)
                                #endif
000C7B 4C7B CD0951          17      CALL    GET_DISK_BANK_FDRV
       4C7E                     RWX1:
000C7E 4C7E ED53C1F2        20      LD  (_CLPS),DE
000C82 4C82 7A               4      LD  A,D
000C83 4C83 B3               4      OR  E
000C84 4C84 37               4      SCF
000C85 4C85 C8              11      RET Z
                                
000C86 4C86 78               4      LD  A,B
000C87 4C87 B1               4      OR  C
000C88 4C88 C8              11      RET Z
                                
000C89 4C89 CDAB4C          17      CALL    GNCL
000C8C 4C8C D8              11      RET C
000C8D 4C8D 0B               6      DEC BC
000C8E 4C8E CD0D4D          17      CALL    ENDCL
000C91 4C91 38EB            12      JR  C,RWX1
000C93 4C93 37               4      SCF
000C94 4C94 C9              10      RET
                                
       4C95                     NCL3:
000C95 4C95 CD0951          17      CALL    GET_DISK_BANK_FDRV
000C98 4C98 6B               4      LD  L,E
000C99 4C99 62               4      LD  H,D
000C9A 4C9A CB3C             8      SRL H
000C9C 4C9C CB1D             8      RR  L
000C9E 4C9E 1F               4      RRA
000C9F 4C9F 19              11      ADD HL,DE
000CA0 4CA0 010060          10      LD  BC,BANK1_ADR
000CA3 4CA3 09              11      ADD HL,BC
000CA4 4CA4 ED4BBBF2        20      LD  BC,(SECSZ)
000CA8 4CA8 09              11      ADD HL,BC
000CA9 4CA9 17               4      RLA
000CAA 4CAA C9              10      RET
                                
       4CAB                     GNCL:
000CAB 4CAB 7A               4      LD  A,D
000CAC 4CAC B3               4      OR  E
000CAD 4CAD 37               4      SCF
000CAE 4CAE C8              11      RET Z
000CAF 4CAF C5              11      PUSH    BC
000CB0 4CB0 E5              11      PUSH    HL
000CB1 4CB1 CD954C          17      CALL    NCL3
000CB4 4CB4 3809            12      JR  C,GNC1
000CB6 4CB6 5E               7      LD  E,(HL)
000CB7 4CB7 23               6      INC HL
000CB8 4CB8 7E               7      LD  A,(HL)
000CB9 4CB9 E60F             7      AND 00FH
000CBB 4CBB 57               4      LD  D,A
000CBC 4CBC E1              10      POP HL
000CBD 4CBD C1              10      POP BC
000CBE 4CBE C9              10      RET
       4CBF                     GNC1:
000CBF 4CBF 7E               7      LD  A,(HL)
000CC0 4CC0 23               6      INC HL
000CC1 4CC1 56               7      LD  D,(HL)
000CC2 4CC2 0604             7      LD  B,4
       4CC4                     GNC1L:
000CC4 4CC4 CB3A             8      SRL D
000CC6 4CC6 1F               4      RRA
000CC7 4CC7 10FB            13      DJNZ    GNC1L
                                
000CC9 4CC9 5F               4      LD  E,A
000CCA 4CCA E1              10      POP HL
000CCB 4CCB C1              10      POP BC
000CCC 4CCC A7               4      AND A
000CCD 4CCD C9              10      RET
                                
       4CCE                     CLUST:
000CCE 4CCE EB               4      EX  DE,HL
       4CCF                     CLUST_HL:
000CCF 4CCF 2B               6      DEC HL
000CD0 4CD0 2B               6      DEC HL
000CD1 4CD1 C5              11      PUSH    BC
000CD2 4CD2 3ABAF2          13      LD  A,(CLSZ_H)
000CD5 4CD5 CD3551          17      CALL    MUL_AHL
                                
000CD8 4CD8 CD914D          17      CALL    GET_DIR_POS
000CDB 4CDB 4F               4      LD  C,A
000CDC 4CDC 0600             7      LD  B,0
000CDE 4CDE 09              11      ADD HL,BC
                                
000CDF 4CDF ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
000CE3 4CE3 CB38             8      SRL B
000CE5 4CE5 CB19             8      RR  C           ;/2
000CE7 4CE7 CB38             8      SRL B
000CE9 4CE9 CB19             8      RR  C           ;/4
000CEB 4CEB CB38             8      SRL B
000CED 4CED CB19             8      RR  C           ;/8
000CEF 4CEF 09              11      ADD HL,BC
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  A,L
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    JR  NC,CLUST2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
000CF0 4CF0 4D               4      LD  C,L     ;C=読み出し元
000CF1 4CF1 29              11      ADD HL,HL   ;64KB→32KB
000CF2 4CF2 29              11      ADD HL,HL   ;32KB→16KB
000CF3 4CF3 29              11      ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
000CF4 4CF4 CD0951          17      CALL    GET_DISK_BANK_FDRV
000CF7 4CF7 84               4      ADD A,H
000CF8 4CF8 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000CFB 4CFB 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000CFE 4CFE 32B7F2          13      LD  (_BANK),A
000D01 4D01 69               4      LD  L,C     ;C=読み出し元
000D02 4D02 3E1F             7      LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
000D04 4D04 A5               4      AND L
                                #endif
       4D05                     CLUST2:
000D05 4D05 C660             7      ADD A,high BANK1_ADR
000D07 4D07 67               4      LD  H,A
000D08 4D08 2E00             7      LD  L,0
000D0A 4D0A EB               4      EX  DE,HL
000D0B 4D0B C1              10      POP BC
000D0C 4D0C C9              10      RET
                                
       4D0D                     ENDCL:
000D0D 4D0D 7A               4      LD  A,D ;END CLUSTER
000D0E 4D0E FE0F             7      CP  00FH    ;FAT12の最大値
000D10 4D10 C0              11      RET NZ
000D11 4D11 7B               4      LD  A,E
000D12 4D12 FEF7             7      CP  0F7H
000D14 4D14 C9              10      RET
                                
       4D15                     RB_READ:
000D15 4D15 AF               4      XOR A   ;HLA = HL*128
000D16 4D16 CB3C             8      SRL H
000D18 4D18 CB1D             8      RR  L
000D1A 4D1A 1F               4      RRA
000D1B 4D1B 32BDF2          13      LD  (RR_LOW),A
000D1E 4D1E 22BEF2          16      LD  (RR_MID),HL
000D21 4D21 218000          10      LD  HL,128
                                
000D24 4D24 CDF648          17      CALL    ROM_READ
000D27 4D27 C9              10      RET
                                
       4D28                     GETSEQ:
000D28 4D28 FD6E20          19      LD  L,(IY+32)
000D2B 4D2B FD660C          19      LD  H,(IY+12)
                                
000D2E 4D2E CB25             8      SLA L
                                
000D30 4D30 CB3C             8      SRL H
000D32 4D32 CB1D             8      RR  L
000D34 4D34 C9              10      RET
                                
       4D35                     SETSEQ:
000D35 4D35 F5              11      PUSH    AF
000D36 4D36 3ABDF2          13      LD  A,(RR_LOW)
000D39 4D39 2ABEF2          16      LD  HL,(RR_MID)
                                
000D3C 4D3C CD534D          17      CALL    SSQ1
                                
000D3F 4D3F 29              11      ADD HL,HL
000D40 4D40 CB3D             8      SRL L
000D42 4D42 FD7520          19      LD  (IY+32),L
000D45 4D45 FD740C          19      LD  (IY+12),H
000D48 4D48 F1              10      POP AF
000D49 4D49 C9              10      RET
                                
       4D4A                     GETSIZE:
000D4A 4D4A FD7E10          19      LD  A,(IY+16)
000D4D 4D4D FD6E11          19      LD  L,(IY+17)
000D50 4D50 FD6612          19      LD  H,(IY+18)
       4D53                     SSQ1:
000D53 4D53 87               4      ADD A,A
000D54 4D54 ED6A            15      ADC HL,HL
000D56 4D56 B7               4      OR  A
000D57 4D57 C8              11      RET Z
000D58 4D58 23               6      INC HL
000D59 4D59 C9              10      RET
                                
       4D5A                     SET_FCB:
000D5A 4D5A D5              11      PUSH    DE
000D5B 4D5B FDE1            14      POP IY
000D5D 4D5D FD7E1C          19      LD  A,(IY+28)
000D60 4D60 FEFF             7      CP  0FFH
000D62 4D62 200C            12      JR  NZ,POPAF_SCF_FF_RET
000D64 4D64 E5              11      PUSH    HL
000D65 4D65 FD6E1A          19      LD  L,(IY+26)
000D68 4D68 FD661B          19      LD  H,(IY+27)
000D6B 4D6B 22C1F2          16      LD  (_CLPS),HL
000D6E 4D6E E1              10      POP HL
000D6F 4D6F C9              10      RET
                                
       4D70                     POPAF_SCF_FF_RET:
000D70 4D70 F1              10      POP AF
000D71 4D71 37               4      SCF
000D72 4D72 9F               4      SBC A,A
000D73 4D73 C9              10      RET
                                
       4D74                     GET_DIR_DAT:
000D74 4D74 2AE9F2          16      LD  HL,(_CDX)
000D77 4D77 7C               4      LD  A,H
000D78 4D78 B5               4      OR  L
000D79 4D79 2035            12      JR  NZ,GET_SUBDIR
000D7B 4D7B CD914D          17      CALL    GET_DIR_POS
000D7E 4D7E C660             7      ADD A,high BANK1_ADR
000D80 4D80 2E00             7      LD  L,0
000D82 4D82 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
000D83 4D83 CD5B4B          17      CALL    CHECK_DIR_PAGE
                                #endif
000D86 4D86 3AB8F2          13      LD  A,(_BANK1)
000D89 4D89 32E2F2          13      LD  (_DIR_BANK),A
                                
000D8C 4D8C 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000D8F 4D8F 4F               4      LD  C,A
000D90 4D90 C9              10      RET
                                
       4D91                     GET_DIR_POS:                ;ルートディレクトリ
000D91 4D91 CD0951          17      CALL    GET_DISK_BANK_FDRV
000D94 4D94 32B8F2          13      LD  (_BANK1),A
000D97 4D97 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000D9A 4D9A 47               4      LD  B,A
000D9B 4D9B 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000D9E 4D9E 4F               4      LD  C,A
000D9F 4D9F 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4DA2                     GET_DIR_POS1:
000DA2 4DA2 81               4      ADD A,C
000DA3 4DA3 10FD            13      DJNZ    GET_DIR_POS1
                                
000DA5 4DA5 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
000DA9 4DA9 37               4      SCF     ;無限ループ回避
       4DAA                     L_MDP:
000DAA 4DAA CB18             8      RR  B   ;->CF
000DAC 4DAC D8              11      RET C
000DAD 4DAD 87               4      ADD A,A
000DAE 4DAE 18FA            12      JR  L_MDP
                                
       4DB0                     GET_SUBDIR:             ;サブディレクトリ
000DB0 4DB0 CDCF4C          17      CALL    CLUST_HL
000DB3 4DB3 EB               4      EX  DE,HL
000DB4 4DB4 3AB7F2          13      LD  A,(_BANK)
000DB7 4DB7 32E2F2          13      LD  (_DIR_BANK),A
000DBA 4DBA 3ABAF2          13      LD  A,(CLSZ_H)
000DBD 4DBD 87               4      ADD A,A     ;*2
000DBE 4DBE 87               4      ADD A,A     ;*4
000DBF 4DBF 87               4      ADD A,A     ;*8
000DC0 4DC0 4F               4      LD  C,A
000DC1 4DC1 C9              10      RET
                                
       4DC2                     STATEMENT:
000DC2 4DC2 112A4F          10      LD  DE,STR_CHDIR
000DC5 4DC5 CD104F          17      CALL    CPPROCNM
000DC8 4DC8 280A            12      JR  Z,_CHDIR
000DCA 4DCA 11304F          10      LD  DE,STR_RAMDISK
000DCD 4DCD CD104F          17      CALL    CPPROCNM
000DD0 4DD0 2814            12      JR  Z,_RAMDISK
000DD2 4DD2 37               4      SCF
000DD3 4DD3 C9              10      RET
       4DD4                     _CHDIR:
000DD4 4DD4 7E               7      LD  A,(HL)
000DD5 4DD5 FE28             7      CP  '('
000DD7 4DD7 37               4      SCF
000DD8 4DD8 C0              11      RET NZ
000DD9 4DD9 CDA446          17      CALL    INIT_PARAM
000DDC 4DDC CD9749          17      CALL    FILE_B
000DDF 4DDF CDFE4D          17      CALL    ROM_CD
000DE2 4DE2 DA6345          10      JP  C,ERROR_FILE_NOT_FOUND
000DE5 4DE5 C9              10      RET
                                
       4DE6                     _RAMDISK:
000DE6 4DE6 7E               7      LD  A,(HL)
000DE7 4DE7 FE28             7      CP  '('
000DE9 4DE9 37               4      SCF
000DEA 4DEA C0              11      RET NZ
000DEB 4DEB 23               6      INC HL
000DEC 4DEC DD212F54        14      LD  IX,FRMQNT
000DF0 4DF0 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000DF4 4DF4 CD1C00          17      CALL    _CALSLT
                                ;   LD  A,(HOKVLD)  ;bit0: 拡張 BIOSの存在
                                ;   CPL
                                ;   AND 1
000DF7 4DF7 7A               4      LD  A,D
000DF8 4DF8 B3               4      OR  E
000DF9 4DF9 C25D45          10      JP  NZ,ERROR_INTERNAL_ERROR
                                ;   PUSH    HL      ;EXTBIOもDISK BIOSで初期化してそう
                                ;   LD  A,0     ;すでにA=0になっている
                                ;   LD  DE,0401H    ;D=マッパサポートルチン(4) E=機能番号(1)
                                ;   CALL    EXTBIO
                                ;   POP HL
                                ;   OR  A
                                ;   JP  Z,ERROR_INTERNAL_ERROR
000DFC 4DFC 23               6      INC HL
000DFD 4DFD C9              10      RET
                                
       4DFE                     ROM_CD:
000DFE 4DFE 3AECF2          13      LD  A,(FNAME)
000E01 4E01 FE20             7      CP  020H
000E03 4E03 2822            12      JR  Z,CD1
000E05 4E05 CD164B          17      CALL    ROM_OPEN
000E08 4E08 D8              11      RET C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
000E09 4E09 FD2AE0F2        20      LD  IY,(DIRENT1)
000E0D 4E0D FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
000E11 4E11 CA6345          10      JP  Z,ERROR_FILE_NOT_FOUND
000E14 4E14 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000E17 4E17 FD661B          19      LD  H,(IY+01BH)
                                #endif
       4E1A                     CD2:
000E1A 4E1A 22DEF2          16      LD  (_CD),HL
000E1D 4E1D 2AE7F2          16      LD  HL,(PARAM1)
       4E20                     CD_SKIP:
000E20 4E20 7E               7      LD  A,(HL)
000E21 4E21 23               6      INC HL
000E22 4E22 FE21             7      CP  021H
000E24 4E24 38FA            12      JR  C,CD_SKIP
000E26 4E26 C9              10      RET
       4E27                     CD1:
000E27 4E27 2AE9F2          16      LD  HL,(_CDX)
000E2A 4E2A 18EE            12      JR  CD2
                                
       4E2C                     GET_BASIC_FCB:
000E2C 4E2C D5              11      PUSH    DE
000E2D 4E2D 23               6      INC HL  ;+1
000E2E 4E2E 5E               7      LD  E,(HL)  ;FCB[1]
000E2F 4E2F 23               6      INC HL  ;+2
000E30 4E30 56               7      LD  D,(HL)  ;FCB[2]
000E31 4E31 23               6      INC HL  ;+3
000E32 4E32 ED53E0F2        20      LD  (DIRENT1),DE
                                            ;FCB[3]
000E36 4E36 23               6      INC HL  ;+4
                                            ;FCB[4]
000E37 4E37 23               6      INC HL  ;+5
000E38 4E38 7E               7      LD  A,(HL)  ;FCB[5]
000E39 4E39 23               6      INC HL  ;+6
000E3A 4E3A 32E2F2          13      LD  (_DIR_BANK),A
000E3D 4E3D 5E               7      LD  E,(HL)  ;FCB[6]
000E3E 4E3E 23               6      INC HL  ;+7
000E3F 4E3F 56               7      LD  D,(HL)  ;FCB[7]
000E40 4E40 23               6      INC HL  ;+8
000E41 4E41 ED53BDF2        20      LD  (RR_LOW),DE
000E45 4E45 7E               7      LD  A,(HL)  ;FCB[8]
000E46 4E46 23               6      INC HL  ;+9
000E47 4E47 32BFF2          13      LD  (RR_HIGH),A
000E4A 4E4A 7E               7      LD  A,(HL)  ;FCB[9]
000E4B 4E4B 23               6      INC HL  ;+10
000E4C 4E4C 22C7F2          16      LD  (_DTA),HL   ;FCB[10]
000E4F 4E4F D1              10      POP DE
000E50 4E50 C9              10      RET
                                
       4E51                     SET_BASIC_FCB:
000E51 4E51 E5              11      PUSH    HL
000E52 4E52 2A64F8          16      LD  HL,(PTRFIL)
000E55 4E55 23               6      INC HL  ;+1
000E56 4E56 D5              11      PUSH    DE
000E57 4E57 ED5BE0F2        20      LD  DE,(DIRENT1)
000E5B 4E5B 73               7      LD  (HL),E  ;FCB[1]
000E5C 4E5C 23               6      INC HL  ;+2
000E5D 4E5D 72               7      LD  (HL),D  ;FCB[2]
000E5E 4E5E 23               6      INC HL  ;+3
000E5F 4E5F AF               4      XOR A
000E60 4E60 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
000E61 4E61 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
000E62 4E62 23               6      INC HL  ;+5
000E63 4E63 3AE2F2          13      LD  A,(_DIR_BANK)
000E66 4E66 77               7      LD  (HL),A  ;FCB[5]
000E67 4E67 23               6      INC HL  ;+6
000E68 4E68 ED5BBDF2        20      LD  DE,(RR_LOW)
000E6C 4E6C 73               7      LD  (HL),E  ;FCB[6]
000E6D 4E6D 23               6      INC HL  ;+7
000E6E 4E6E 72               7      LD  (HL),D  ;FCB[7]
000E6F 4E6F 23               6      INC HL  ;+8
000E70 4E70 3ABFF2          13      LD  A,(RR_HIGH)
000E73 4E73 77               7      LD  (HL),A  ;FCB[8]
000E74 4E74 23               6      INC HL  ;+9
000E75 4E75 3600            10      LD  (HL),0  ;FCB[9]
000E77 4E77 D1              10      POP DE
000E78 4E78 E1              10      POP HL
000E79 4E79 C9              10      RET
                                
       4E7A                     DEVICE_CHECK:
000E7A 4E7A 11384F          10      LD  DE,STR_A
000E7D 4E7D CD104F          17      CALL    CPPROCNM
000E80 4E80 280A            12      JR  Z,DEVICE_OK
000E82 4E82 113A4F          10      LD  DE,STR_ROM
000E85 4E85 CD104F          17      CALL    CPPROCNM
000E88 4E88 2802            12      JR  Z,DEVICE_OK
000E8A 4E8A 37               4      SCF
000E8B 4E8B C9              10      RET
       4E8C                     DEVICE_OK:
000E8C 4E8C AF               4      XOR A
000E8D 4E8D C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファインデックス
                                ; +10: バッファ
                                
       4E8E                     DEVICE_0_OPEN:
000E8E 4E8E D5              11      PUSH    DE
000E8F 4E8F E5              11      push    hl
                                ;
000E90 4E90 3E01             7      LD  A,1     ;ドライブA
000E92 4E92 32EBF2          13      LD  (FDRV),A
000E95 4E95 2166F8          10      LD  HL,FILNAM
000E98 4E98 11ECF2          10      LD  DE,FNAME
000E9B 4E9B 010B00          10      LD  BC,8+3
000E9E 4E9E CDEA54          17      CALL    INIT_FILE1
000EA1 4EA1 CD164B          17      CALL    ROM_OPEN
000EA4 4EA4 DA6345          10      JP  C,ERROR_FILE_NOT_FOUND
000EA7 4EA7 E1              10      pop hl
000EA8 4EA8 D1              10      POP DE
000EA9 4EA9 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
000EAC 4EAC 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
000EAD 4EAD AF               4      XOR A
000EAE 4EAE 32E3F2          13      LD  (LEFTX),A
000EB1 4EB1 CD514E          17      CALL    SET_BASIC_FCB
000EB4 4EB4 7B               4      ld  a,e
000EB5 4EB5 FE08             7      cp  8
000EB7 4EB7 3F               4      ccf
000EB8 4EB8 C9              10      ret
                                
       4EB9                     DEVICE_2_CLOSE:
000EB9 4EB9 AF               4      XOR A
                                ;   LD  (HL),A
000EBA 4EBA 6F               4      LD  L,A
000EBB 4EBB 67               4      LD  H,A
000EBC 4EBC 2264F8          16      LD  (PTRFIL),HL
000EBF 4EBF C9              10      RET
                                
       4EC0                     DEVICE_ENTRY:
000EC0 4EC0 FE08             7      CP  8
000EC2 4EC2 280C            12      JR  Z,DEVICE_8_SIN
000EC4 4EC4 3C               4      INC A
000EC5 4EC5 28B3            12      JR  Z,DEVICE_CHECK:
000EC7 4EC7 3D               4      DEC A
000EC8 4EC8 28C4            12      JR  Z,DEVICE_0_OPEN
000ECA 4ECA FE02             7      CP  2
000ECC 4ECC 28EB            12      JR  Z,DEVICE_2_CLOSE
000ECE 4ECE 37               4      SCF
000ECF 4ECF C9              10      RET
                                
       4ED0                     DEVICE_8_SIN:
000ED0 4ED0 CD2C4E          17      CALL    GET_BASIC_FCB
000ED3 4ED3 E67F             7      AND 127
000ED5 4ED5 281D            12      JR  Z,SIN_READ_DISK
000ED7 4ED7 2AC7F2          16      LD  HL,(_DTA)
000EDA 4EDA 2B               6      DEC HL
000EDB 4EDB 34              11      INC (HL)
000EDC 4EDC 3C               4      INC A   ;(INC HL)
000EDD 4EDD 85               4      ADD A,L ;ADD HL,A
000EDE 4EDE 6F               4      LD  L,A ;
000EDF 4EDF 8C               4      ADC A,H ;
000EE0 4EE0 95               4      SUB L   ;
000EE1 4EE1 67               4      LD  H,A ;
       4EE2                     SIN_READ1:
000EE2 4EE2 7E               7      LD  A,(HL)
000EE3 4EE3 FE0A             7      CP  00AH
000EE5 4EE5 C8              11      RET Z   ;ZF=separate
000EE6 4EE6 FE1A             7      CP  01AH
000EE8 4EE8 2803            12      JR  Z,SIN_EOF
000EEA 4EEA 37               4      SCF
000EEB 4EEB 3F               4      CCF     ;ZF=0 CF=0にしたい
000EEC 4EEC C9              10      RET
       4EED                     SIN_EOF:
000EED 4EED 2AC7F2          16      LD  HL,(_DTA)
000EF0 4EF0 2B               6      DEC HL
000EF1 4EF1 35              11      DEC (HL)
       4EF2                     SCF_RET:
000EF2 4EF2 37               4      SCF
000EF3 4EF3 C9              10      RET
                                
       4EF4                     SIN_READ_DISK:
000EF4 4EF4 218000          10      LD  HL,128
000EF7 4EF7 CDF648          17      CALL    ROM_READ
000EFA 4EFA CD514E          17      CALL    SET_BASIC_FCB
000EFD 4EFD 7C               4      LD  A,H
000EFE 4EFE B5               4      OR  L
000EFF 4EFF 28F1            12      JR  Z,SCF_RET
000F01 4F01 ED5BC7F2        20      LD  DE,(_DTA)
000F05 4F05 19              11      ADD HL,DE
000F06 4F06 361A            10      LD  (HL),01AH
000F08 4F08 2AC7F2          16      LD  HL,(_DTA)
000F0B 4F0B 2B               6      DEC HL
000F0C 4F0C 34              11      INC (HL)
000F0D 4F0D 23               6      INC HL
000F0E 4F0E 18D2            12      JR  SIN_READ1
                                
       4F10                     CPPROCNM:
000F10 4F10 E5              11      PUSH    HL
000F11 4F11 2189FD          10      LD  HL,PROCNM
       4F14                     CPPROCNM1:
000F14 4F14 1A               7      LD  A,(DE)
000F15 4F15 13               6      INC DE
000F16 4F16 BE               7      CP  (HL)
000F17 4F17 23               6      INC HL
000F18 4F18 2003            12      JR  NZ,CPPROCNM2
000F1A 4F1A B7               4      OR  A
000F1B 4F1B 20F7            12      JR  NZ,CPPROCNM1
       4F1D                     CPPROCNM2:
000F1D 4F1D E1              10      POP HL
000F1E 4F1E C9              10      RET
                                
       4F1F                     WILDCARD:
000F1F 4F1F 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       4F2A                     STR_CHDIR:
000F2A 4F2A 434844495200            DB  "CHDIR",0
       4F30                     STR_RAMDISK:
000F30 4F30 52414D4449534B00        DB  "RAMDISK",0
       4F38                     STR_A:
000F38 4F38 4100                    DB  "A",0
       4F3A                     STR_ROM:
000F3A 4F3A 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4F3E                     ERROR_WRITE_PROTECTED:
000F3E 4F3E 3E00             7      LD  A,0     ;Write protected
000F40 4F40 C9              10      RET
       4F41                     DISKIO:
000F41 4F41 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000F43 4F43 48               4      LD  C,B
000F44 4F44 CD1351          17      CALL    GET_DISK_BANK
       4F47                     SETMAP1:        
000F47 4F47 E5              11      PUSH    HL
       4F48                     DISKIO1:
000F48 4F48 C5              11      PUSH    BC      ;B=残りのセクタ数
000F49 4F49 D5              11      PUSH    DE      ;DE=セクタ番号
000F4A 4F4A F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
000F4B 4F4B EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
000F4C 4F4C F5              11      PUSH    AF
000F4D 4F4D 3ABCF2          13      LD  A,(SECSZ_H)
000F50 4F50 CD3551          17      CALL    MUL_AHL
000F53 4F53 F1              10      POP AF
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  A,L
                                    PUSH    BC
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    POP BC
                                    JR  NC,DISKIO2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
000F54 4F54 4D               4      LD  C,L     ;C=読み出し元
000F55 4F55 29              11      ADD HL,HL       ;64KB→32KB
000F56 4F56 29              11      ADD HL,HL       ;32KB→16KB
000F57 4F57 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
000F58 4F58 84               4      ADD A,H
000F59 4F59 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000F5C 4F5C 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000F5F 4F5F 32B7F2          13      LD  (_BANK),A
000F62 4F62 79               4      LD  A,C     ;C=読み出し元
000F63 4F63 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       4F65                     DISKIO2:
000F65 4F65 C660             7      ADD A,high BANK1_ADR
000F67 4F67 67               4      LD  H,A
000F68 4F68 ED4BBBF2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
000F6C 4F6C 69               4      LD  L,C     ;C=0
000F6D 4F6D CDFE43          17      CALL    ROM_LDIR
000F70 4F70 EB               4      EX  DE,HL
000F71 4F71 F1              10      POP AF
000F72 4F72 D1              10      POP DE
000F73 4F73 13               6      INC DE
000F74 4F74 C1              10      POP BC
000F75 4F75 10D1            13      DJNZ    DISKIO1
000F77 4F77 41               4      LD  B,C
                                
000F78 4F78 E1              10      POP HL
000F79 4F79 AF               4      XOR A
                                
000F7A 4F7A FB               4      EI
000F7B 4F7B C9              10      RET
                                
       4F7C                     DSKCHG:
000F7C 4F7C CDB54F          17      CALL    IS_BPB
000F7F 4F7F 3824            12      JR  C,NOTREADY
000F81 4F81 3A23FB          13      LD  A,(DRVTBL+2)
000F84 4F84 B7               4      OR  A
000F85 4F85 201A            12      JR  NZ,DSKCHG1
000F87 4F87 3A21FB          13      LD  A,(DRVTBL)
000F8A 4F8A FE02             7      CP  2
000F8C 4F8C 2013            12      JR  NZ,DSKCHG1
000F8E 4F8E CDB54F          17      CALL    IS_BPB
000F91 4F91 300E            12      JR  NC,DSKCHG1
000F93 4F93 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000F95 4F95 3221FB          13      LD  (DRVTBL),A
000F98 4F98 3223FB          13      LD  (DRVTBL+2),A
000F9B 4F9B 3A48F3          13      LD  A,(MASTERS)
000F9E 4F9E 3224FB          13      LD  (DRVTBL+3),A
       4FA1                     DSKCHG1:
000FA1 4FA1 AF               4      XOR A
000FA2 4FA2 0601             7      LD  B,1
000FA4 4FA4 C9              10      RET
       4FA5                     NOTREADY:
000FA5 4FA5 3E02             7      LD  A,2
000FA7 4FA7 37               4      SCF
000FA8 4FA8 C9              10      RET
                                
       4FA9                     NO_BPB:
000FA9 4FA9 E1              10      POP HL
000FAA 4FAA 23               6      INC HL
000FAB 4FAB 113B51          10      LD  DE,DPB2DD
000FAE 4FAE 011200          10      LD  BC,DPB2DD_E-DPB2DD
000FB1 4FB1 EDB0                    LDIR
000FB3 4FB3 AF               4      XOR A
000FB4 4FB4 C9              10      RET
                                
       4FB5                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000FB5 4FB5 CD1351          17      CALL    GET_DISK_BANK
                                
000FB8 4FB8 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000FBB 4FBB FE01             7      CP  1
000FBD 4FBD D8              11      RET C
                                
000FBE 4FBE 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000FC1 4FC1 C6FF             7      ADD A,0FFH
000FC3 4FC3 D8              11      RET C
                                
000FC4 4FC4 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       4FC7                     IS_BPB1:
000FC7 4FC7 FE01             7      CP  1
000FC9 4FC9 C8              11      RET Z
000FCA 4FCA FE02             7      CP  2
000FCC 4FCC C8              11      RET Z
000FCD 4FCD FE04             7      CP  4
000FCF 4FCF C8              11      RET Z
000FD0 4FD0 37               4      SCF
000FD1 4FD1 C9              10      RET
                                
       4FD2                     GETDPB:
000FD2 4FD2 E5              11      PUSH    HL
000FD3 4FD3 CD1351          17      CALL    GET_DISK_BANK
                                
000FD6 4FD6 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000FD9 4FD9 B7               4      OR  A
000FDA 4FDA 28CD            12      JR  Z,NO_BPB
000FDC 4FDC DDE1            14      POP IX
000FDE 4FDE DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000FE1 4FE1 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000FE4 4FE4 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000FE7 4FE7 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000FEA 4FEA DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000FED 4FED 87               4      ADD A,A
000FEE 4FEE 87               4      ADD A,A
000FEF 4FEF 87               4      ADD A,A
000FF0 4FF0 3D               4      DEC A
000FF1 4FF1 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000FF4 4FF4 06FF             7      LD  B,-1
000FF6 4FF6 A7               4      AND A           ;無限ループ阻止
       4FF7                     GETDPB1:
000FF7 4FF7 04               4      INC B
000FF8 4FF8 1F               4      RRA
000FF9 4FF9 38FC            12      JR  C,GETDPB1
000FFB 4FFB DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000FFE 4FFE 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
001001 5001 3D               4      DEC A
001002 5002 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
001005 5005 A7               4      AND A           ;無限ループ阻止
001006 5006 06FF             7      LD  B,-1
       5008                     GETDPB2:
001008 5008 04               4      INC B
001009 5009 1F               4      RRA
00100A 500A 38FC            12      JR  C,GETDPB2
00100C 500C 04               4      INC B
00100D 500D DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
001010 5010 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
001013 5013 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
001016 5016 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
001019 5019 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
00101C 501C DD770A          19      LD  (IX+10),A       ;FATCNT
                                
00101F 501F 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
001022 5022 DD770B          19      LD  (IX+11),A       ;MAXENT
                                
001025 5025 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
001029 5029 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
00102C 502C DD460A          19      LD  B,(IX+10)       ;FATCNT
00102F 502F 210000          10      LD  HL,0
       5032                     GETDPB3:
001032 5032 19              11      ADD HL,DE
001033 5033 10FD            13      DJNZ    GETDPB3
       5035                     GETDPB4:
001035 5035 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
001038 5038 DD5609          19      LD  D,(IX+9)        ;FIRFAT
00103B 503B 19              11      ADD HL,DE
00103C 503C DD7511          19      LD  (IX+17),L       ;FIRDIR
00103F 503F DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
001042 5042 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001045 5045 87               4      ADD A,A
001046 5046 87               4      ADD A,A
001047 5047 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       504A                     GETDPB5:
00104A 504A CB3B             8      SRL E
00104C 504C 1F               4      RRA
00104D 504D 30FB            12      JR  NC,GETDPB5
00104F 504F 1600             7      LD  D,0
001051 5051 19              11      ADD HL,DE
001052 5052 DD750C          19      LD  (IX+12),L       ;FIRREC
001055 5055 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001058 5058 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
00105B 505B DD5E0C          19      LD  E,(IX+12)       ;FIRREC
00105E 505E DD560D          19      LD  D,(IX+13)       ;FIRREC
001061 5061 A7               4      AND A
001062 5062 ED52            15      SBC HL,DE
                                
001064 5064 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
001067 5067 3C               4      INC A
001068 5068 37               4      SCF             ;無限ループ阻止
       5069                     GETDPB6:
001069 5069 1F               4      RRA
00106A 506A 3806            12      JR  C,GETDPB7
00106C 506C CB3C             8      SRL H
00106E 506E CB1D             8      RR  L
001070 5070 18F7            12      JR  GETDPB6
       5072                     GETDPB7:
001072 5072 23               6      INC HL
001073 5073 DD750E          19      LD  (IX+14),L       ;MAXCLUS
001076 5076 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       5079                     GETDPBD1:
001079 5079 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
00107C 507C E6FC             7      AND 0FCH
00107E 507E C8              11      RET Z
                                
00107F 507F DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
001083 5083 37               4      SCF
001084 5084 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
001088 5088 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
00108B 508B DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
00108F 508F DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
001093 5093 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
001097 5097 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
00109B 509B DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
00109F 509F DDCB1126        23      SLA (IX+17)         ;FIRDIR
0010A3 50A3 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
0010A7 50A7 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
0010AA 50AA DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
0010AD 50AD DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0010B0 50B0 87               4      ADD A,A
0010B1 50B1 87               4      ADD A,A
0010B2 50B2 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       50B5                     GETDPBD5:
0010B5 50B5 CB3B             8      SRL E
0010B7 50B7 1F               4      RRA
0010B8 50B8 30FB            12      JR  NC,GETDPBD5
0010BA 50BA 1600             7      LD  D,0
0010BC 50BC 19              11      ADD HL,DE
0010BD 50BD DD750C          19      LD  (IX+12),L       ;FIRREC
0010C0 50C0 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
0010C3 50C3 18B4            12      JR  GETDPBD1
                                
       50C5                     CHOICE:
0010C5 50C5 210000          10      LD  HL,0
0010C8 50C8 C9              10      RET
                                
       50C9                     DSKFMT:
0010C9 50C9 AF               4      XOR A
0010CA 50CA 37               4      SCF
       50CB                     DSKSTP:
0010CB 50CB C9              10      RET
                                
       50CC                     BASENT:
0010CC 50CC 2A74F6          16      LD  HL,(STKTOP)
0010CF 50CF 3A40F3          13      LD  A,(REBOOT)
0010D2 50D2 C6FF             7      ADD A,0FFH
0010D4 50D4 3811            12      JR  C,REBOOT1
0010D6 50D6 214D51          10      LD  HL,AUTOEXEC
0010D9 50D9 11EBF2          10      LD  DE,FDRV
0010DC 50DC 010C00          10      LD  BC,1+8+3
0010DF 50DF EDB0                    LDIR
0010E1 50E1 CD164B          17      CALL    ROM_OPEN
0010E4 50E4 D41845          17      CALL    NC,ROM_LOAD1
       50E7                     REBOOT1:
0010E7 50E7 215951          10      LD  HL,CMD_RUN
0010EA 50EA 111FF4          10      LD  DE,KBUF
0010ED 50ED 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
0010F0 50F0 D5              11      PUSH    DE
0010F1 50F1 EDB0                    LDIR
0010F3 50F3 3004            12      JR  NC,REBOOT2
0010F5 50F5 AF               4      XOR A
0010F6 50F6 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       50F9                     REBOOT2:
0010F9 50F9 E1              10      POP HL
0010FA 50FA FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0010FE 50FE DD210146        14      LD  IX,NEWSTT
001102 5102 C31C00          10      JP  _CALSLT
                                
       5105                     GETSLT:
001105 5105 3A22FB          13      LD  A,(DRVTBL+1)
001108 5108 C9              10      RET
                                
       5109                     GET_DISK_BANK_FDRV:
001109 5109 3AEBF2          13      LD  A,(FDRV)
00110C 510C D601             7      SUB 1
00110E 510E 3003            12      JR  NC,GET_DISK_BANK
001110 5110 3ADDF2          13      LD  A,(_DVSW)
       5113                     GET_DISK_BANK:
001113 5113 B7               4      OR  A       ;A=DRIVE
001114 5114 3E01             7      LD  A,DISK_BANK
001116 5116 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
001118 5118 3ADCF2          13      LD  A,(B_DRIVE)
                                #endif
       511B                     SET_DISK_BANK:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
00111B 511B 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
00111E 511E 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
001121 5121 F5              11      PUSH    AF
001122 5122 E5              11      PUSH    HL
001123 5123 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
001126 5126 22BBF2          16      LD  (SECSZ),HL
001129 5129 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
00112C 512C CD3551          17      CALL    MUL_AHL
00112F 512F 22B9F2          16      LD  (CLSZ),HL
001132 5132 E1              10      POP HL
001133 5133 F1              10      POP AF
001134 5134 C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       5135                     MUL_AHL:
001135 5135 37               4      SCF     ;無限ループ回避
       5136                     MUL_AHL1:
001136 5136 1F               4      RRA     ;->CF
001137 5137 D8              11      RET C
001138 5138 29              11      ADD HL,HL
001139 5139 18FB            12      JR  MUL_AHL1
                                
       513B                     DPB2DD:
00113B 513B F9                      DB  0F9H    ;MEDIA
00113C 513C 0002                    DW  00200H  ;SECSIZ
00113E 513E 0F                      DB  00FH    ;DIRMSK
00113F 513F 04                      DB  004H    ;DIRSHFT
001140 5140 01                      DB  001H    ;CLUSMSK
001141 5141 02                      DB  002H    ;CLUSSHFT
001142 5142 0100                    DW  00001H  ;FIRFAT
001144 5144 02                      DB  002H    ;FATCNT
001145 5145 70                      DB  070H    ;MAXENT
001146 5146 0E00                    DW  0000EH  ;FIRREC
001148 5148 CA02                    DW  002CAH  ;MAXCLUS
00114A 514A 03                      DB  003H    ;FATSIZ
00114B 514B 0700                    DW  0007H   ;FIRDIR
       514D                     DPB2DD_E:
                                
       514D                     AUTOEXEC:
00114D 514D 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       5159                     CMD_RUN:
001159 5159 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DW  0F280H
                                #else
00115F 515F 40F2                    DW  0F240H
                                #endif
       5161                     CMD_CLEAR_E:
001161 5161 3A8A00                  DB  03AH,08AH,0         ;RUN
       5164                     CMD_RUN_E:
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       5164                     POP_HL_ERROR:
001164 5164 E1              10      POP     HL
       5165                     _ERROR:
001165 5165 0600             7      LD  B,0
001167 5167 A7               4      AND A
001168 5168 C9              10      RET
                                
       5169                     ROM_BDOS:
001169 5169 E5              11      PUSH    HL
00116A 516A 79               4      LD  A,C
00116B 516B 87               4      ADD A,A
00116C 516C 38F7            12      JR  C,_ERROR
00116E 516E 6F               4      LD  L,A
00116F 516F 265F             7      LD  H,high STABLE
001171 5171 7E               7      LD  A,(HL)
001172 5172 2C               4      INC L
001173 5173 66               7      LD  H,(HL)
001174 5174 6F               4      LD  L,A
001175 5175 E3              19      EX  (SP),HL
001176 5176 79               4      LD  A,C
001177 5177 C9              10      RET
                                
       5178                     _PRINT:
       5178                     PRINT:
001178 5178 7B               4      LD  A,E
001179 5179 1803            12      JR  MSG_A
                                
       517B                     _SYS01:     ;(BDOS)コンソール入力
00117B 517B CDF251          17      CALL    _SYS07
       517E                     MSG_A:
00117E 517E FE03             7      CP  3
001180 5180 2814            12      JR  Z,MSG_BR
       5182                     MSGA1:
001182 5182 F5              11      PUSH    AF
001183 5183 C5              11      PUSH    BC
001184 5184 D5              11      PUSH    DE
001185 5185 E5              11      PUSH    HL
001186 5186 DDE5            15      PUSH    IX
001188 5188 DD21A200        14      LD  IX,CHPUT
00118C 518C CDD442          17      CALL    CALSLT_R
00118F 518F DDE1            14      POP IX
001191 5191 E1              10      POP HL
001192 5192 D1              10      POP DE
001193 5193 C1              10      POP BC
       5194                     MSGA2:
001194 5194 F1              10      POP AF
001195 5195 C9              10      RET
       5196                     MSG_BR:
001196 5196 F5              11      PUSH    AF
001197 5197 3ADDF3          13      LD  A,(CSRX)
00119A 519A FE02             7      CP  2
00119C 519C 38F6            12      JR  C,MSGA2
00119E 519E F1              10      POP AF
       519F                     MSG_CR:
00119F 519F F5              11      PUSH    AF
0011A0 51A0 3E0D             7      LD  A,00DH
0011A2 51A2 CD8251          17      CALL    MSGA1
0011A5 51A5 3E0A             7      LD  A,00AH
0011A7 51A7 CD8251          17      CALL    MSGA1
0011AA 51AA F1              10      POP AF
0011AB 51AB C9              10      RET
                                
       51AC                     _SYS02:     ;(BDOS)コンソール出力
0011AC 51AC CDC751          17      CALL    BREAK
0011AF 51AF 1805            12      JR  PRINTX
                                
       51B1                     _SYS06:     ;(BDOS)コンソール直接入出力
0011B1 51B1 7B               4      LD  A,E
0011B2 51B2 3C               4      INC A
0011B3 51B3 CA0652          10      JP  Z,_INKEY
       51B6                     PRINTX:
0011B6 51B6 C37851          10      JP  _PRINT
                                
       51B9                     _SYS08:     ;(BDOS)エコーなしコンソール入力
0011B9 51B9 CDF251          17      CALL    _SYS07
0011BC 51BC FE03             7      CP  3
0011BE 51BE CCC751          17      CALL    Z,_BREAK
0011C1 51C1 FE13             7      CP  013H        ;CTRL+S
0011C3 51C3 C0              11      RET NZ
       51C4                     PAUSE:
0011C4 51C4 CDDE51          17      CALL    KEYBC
                                
       51C7                     _BREAK:
       51C7                     BREAK:
0011C7 51C7 F5              11      PUSH    AF
0011C8 51C8 C5              11      PUSH    BC
0011C9 51C9 D5              11      PUSH    DE
0011CA 51CA E5              11      PUSH    HL
0011CB 51CB DDE5            15      PUSH    IX
0011CD 51CD DD21B700        14      LD  IX,BREAKX
0011D1 51D1 CDD442          17      CALL    CALSLT_R
0011D4 51D4 DDE1            14      POP IX
0011D6 51D6 E1              10      POP HL
0011D7 51D7 D1              10      POP DE
0011D8 51D8 C1              10      POP BC
0011D9 51D9 DCC751          17      CALL    C,_BREAK
0011DC 51DC F1              10      POP AF
0011DD 51DD C9              10      RET
       51DE                     KEYBC:
0011DE 51DE F5              11      PUSH    AF
0011DF 51DF C5              11      PUSH    BC
0011E0 51E0 D5              11      PUSH    DE
0011E1 51E1 E5              11      PUSH    HL
0011E2 51E2 DDE5            15      PUSH    IX
0011E4 51E4 DD215601        14      LD  IX,KILBUF
0011E8 51E8 CDD442          17      CALL    CALSLT_R
0011EB 51EB DDE1            14      POP IX
0011ED 51ED E1              10      POP HL
0011EE 51EE D1              10      POP DE
0011EF 51EF C1              10      POP BC
0011F0 51F0 F1              10      POP AF
0011F1 51F1 C9              10      RET
                                
       51F2                     _SYS07:
       51F2                     FLGET:
0011F2 51F2 C5              11      PUSH    BC
0011F3 51F3 D5              11      PUSH    DE
0011F4 51F4 E5              11      PUSH    HL
0011F5 51F5 DDE5            15      PUSH    IX
0011F7 51F7 DD219F00        14      LD  IX,CHGET
0011FB 51FB CDD442          17      CALL    CALSLT_R
0011FE 51FE DDE1            14      POP IX
001200 5200 E1              10      POP HL
001201 5201 D1              10      POP DE
001202 5202 C1              10      POP BC
001203 5203 FE03             7      CP  3
001205 5205 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       5206                     _INKEY:
       5206                     INKEY:
001206 5206 CDA052          17      CALL    CPM_CONST
001209 5209 C8              11      RET Z
00120A 520A 18E6            12      JR  FLGET
                                
       520C                     _SYS0A:     ;(BDOS)文字列入力
00120C 520C C5              11      PUSH    BC
00120D 520D E5              11      PUSH    HL
00120E 520E D5              11      PUSH    DE
00120F 520F CD3852          17      CALL    GETL
001212 5212 111FF4          10      LD  DE,KBUF
001215 5215 E1              10      POP HL
001216 5216 E5              11      PUSH    HL
001217 5217 0E00             7      LD  C,0
001219 5219 3004            12      JR  NC,SAX0
00121B 521B 23               6      INC HL
00121C 521C 23               6      INC HL
00121D 521D 1808            12      JR  SAX4
       521F                     SAX0:
00121F 521F 46               7      LD  B,(HL)
001220 5220 23               6      INC HL
       5221                     SAX1:
001221 5221 23               6      INC HL
001222 5222 1A               7      LD  A,(DE)
001223 5223 13               6      INC DE
001224 5224 B7               4      OR  A
001225 5225 2004            12      JR  NZ,SAX2
       5227                     SAX4:
001227 5227 360D            10      LD  (HL),00DH
001229 5229 1804            12      JR  SAX3
       522B                     SAX2:
00122B 522B 77               7      LD  (HL),A
00122C 522C 0C               4      INC C
00122D 522D 10F2            13      DJNZ    SAX1
       522F                     SAX3:
00122F 522F D1              10      POP DE
001230 5230 79               4      LD  A,C
001231 5231 13               6      INC DE
001232 5232 12               7      LD  (DE),A
001233 5233 1B               6      DEC DE
001234 5234 E1              10      POP HL
001235 5235 C1              10      POP BC
001236 5236 A7               4      AND A
001237 5237 C9              10      RET
       5238                     GETL:
001238 5238 DDE5            15      PUSH    IX
00123A 523A FDE5            15      PUSH    IY
                                
00123C 523C 2ADCF3          16      LD  HL,(CSRY)
00123F 523F 22CAFB          16      LD  (FSTPOS),HL
       5242                     GETL1:
001242 5242 CDB951          17      CALL    _SYS08
001245 5245 FE09             7      CP  9
001247 5247 2008            12      JR  NZ,GETL1V
001249 5249 211FF4          10      LD  HL,KBUF
00124C 524C CD5E43          17      CALL    MSX
00124F 524F 18F1            12      JR  GETL1
       5251                     GETL1V:
001251 5251 5F               4      LD  E,A
001252 5252 FE08             7      CP  8
001254 5254 CCEE52          17      CALL    Z,CTRL02
001257 5257 FE20             7      CP  020H
001259 5259 D41A53          17      CALL    NC,INSERT
00125C 525C CD8251          17      CALL    MSGA1
                                
00125F 525F 7B               4      LD  A,E
001260 5260 FE0D             7      CP  00DH
001262 5262 20DE            12      JR  NZ,GETL1
                                
001264 5264 111FF4          10      LD  DE,KBUF
001267 5267 3AB0F3          13      LD  A,(LINLEN)
00126A 526A 47               4      LD  B,A
00126B 526B CDFC54          17      CALL    ZERO_MEMORY_DE
                                
00126E 526E 2ACAFB          16      LD  HL,(FSTPOS)
001271 5271 3ADCF3          13      LD  A,(CSRY)
001274 5274 6F               4      LD  L,A
001275 5275 E5              11      PUSH    HL
001276 5276 CD4B53          17      CALL    LOC0
001279 5279 4D               4      LD  C,L
00127A 527A 44               4      LD  B,H
00127B 527B E1              10      POP HL
00127C 527C 3AB0F3          13      LD  A,(LINLEN)
00127F 527F 94               4      SUB H
001280 5280 3D               4      DEC A
001281 5281 5F               4      LD  E,A
001282 5282 211FF4          10      LD  HL,KBUF
       5285                     GETL2:
001285 5285 CDDE52          17      CALL    _SCRN
001288 5288 03               6      INC BC
001289 5289 77               7      LD  (HL),A
00128A 528A 23               6      INC HL
00128B 528B 1D               4      DEC E
00128C 528C 20F7            12      JR  NZ,GETL2
00128E 528E CD9F51          17      CALL    MSG_CR
                                
001291 5291 FDE1            14      POP IY
001293 5293 DDE1            14      POP IX
       5295                     GETL3:
001295 5295 2B               6      DEC HL
001296 5296 7E               7      LD  A,(HL)
001297 5297 FE21             7      CP  021H
001299 5299 D0              11      RET NC
00129A 529A 3600            10      LD  (HL),0
00129C 529C 15               4      DEC D
00129D 529D 20F6            12      JR  NZ,GETL3
00129F 529F C9              10      RET
                                
       52A0                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       52A0                     CONSTX:
       52A0                     CPM_CONST:
0012A0 52A0 C5              11      PUSH    BC
0012A1 52A1 D5              11      PUSH    DE
0012A2 52A2 E5              11      PUSH    HL
0012A3 52A3 DDE5            15      PUSH    IX
0012A5 52A5 DD219C00        14      LD  IX,CHSNS
0012A9 52A9 CDD442          17      CALL    CALSLT_R
0012AC 52AC DDE1            14      POP IX
0012AE 52AE E1              10      POP HL
0012AF 52AF D1              10      POP DE
0012B0 52B0 C1              10      POP BC
0012B1 52B1 C9              10      RET
                                
       52B2                     _SYS2A:     ;(BDOS)日付の獲得
0012B2 52B2 AF               4      XOR A
0012B3 52B3 57               4      LD  D,A
0012B4 52B4 5F               4      LD  E,A
0012B5 52B5 67               4      LD  H,A
0012B6 52B6 6F               4      LD  L,A
0012B7 52B7 C9              10      RET
                                
       52B8                     _SYS2C:     ;(BDOS)時刻の獲得
0012B8 52B8 AF               4      XOR A
0012B9 52B9 57               4      LD  D,A
0012BA 52BA 5F               4      LD  E,A
0012BB 52BB 67               4      LD  H,A
0012BC 52BC 6F               4      LD  L,A
0012BD 52BD C9              10      RET
                                
       52BE                     POS:
0012BE 52BE F5              11      PUSH    AF
0012BF 52BF 2ADCF3          16      LD  HL,(CSRY)
0012C2 52C2 7D               4      LD  A,L
0012C3 52C3 6C               4      LD  L,H
0012C4 52C4 67               4      LD  H,A
0012C5 52C5 2C               4      INC L
0012C6 52C6 24               4      INC H
0012C7 52C7 F1              10      POP AF
0012C8 52C8 C9              10      RET
                                
       52C9                     LOC:
0012C9 52C9 F5              11      PUSH    AF
0012CA 52CA E5              11      PUSH    HL
0012CB 52CB 7D               4      LD  A,L
0012CC 52CC 6C               4      LD  L,H
0012CD 52CD 67               4      LD  H,A
0012CE 52CE 2D               4      DEC L
0012CF 52CF 25               4      DEC H
0012D0 52D0 DDE5            15      PUSH    IX
0012D2 52D2 DD21C600        14      LD  IX,POSIT
0012D6 52D6 CDD442          17      CALL    CALSLT_R
0012D9 52D9 DDE1            14      POP IX
0012DB 52DB E1              10      POP HL
0012DC 52DC F1              10      POP AF
0012DD 52DD C9              10      RET
                                
       52DE                     _SCRN:
       52DE                     SCRN:
0012DE 52DE E5              11      PUSH    HL
0012DF 52DF DDE5            15      PUSH    IX
                                
0012E1 52E1 69               4      LD  L,C
0012E2 52E2 60               4      LD  H,B
0012E3 52E3 DD214A00        14      LD  IX,RDVRM
0012E7 52E7 CDD442          17      CALL    CALSLT_R
                                
0012EA 52EA DDE1            14      POP IX
0012EC 52EC E1              10      POP HL
0012ED 52ED C9              10      RET
                                
       52EE                     CTRL02:
0012EE 52EE F5              11      PUSH    AF
0012EF 52EF D5              11      PUSH    DE
0012F0 52F0 2ADCF3          16      LD  HL,(CSRY)
0012F3 52F3 3AB0F3          13      LD  A,(LINLEN)
0012F6 52F6 4F               4      LD  C,A
0012F7 52F7 94               4      SUB H   ;CSRX
0012F8 52F8 C602             7      ADD A,2
0012FA 52FA 47               4      LD  B,A ;カーソルより右の文字数
0012FB 52FB 61               4      LD  H,C ;LINLEN
0012FC 52FC C5              11      PUSH    BC
0012FD 52FD CD4B53          17      CALL    LOC0
001300 5300 C1              10      POP BC
                                
001301 5301 1620             7      LD  D,020H
       5303                     C8X1:
001303 5303 DD214A00        14      LD  IX,RDVRM
001307 5307 CDD442          17      CALL    CALSLT_R
00130A 530A 4F               4      LD  C,A
00130B 530B 7A               4      LD  A,D
00130C 530C DD214D00        14      LD  IX,WRTVRM
001310 5310 CDD442          17      CALL    CALSLT_R
001313 5313 2B               6      DEC HL
001314 5314 51               4      LD  D,C
001315 5315 10EC            13      DJNZ    C8X1
001317 5317 D1              10      POP DE
001318 5318 F1              10      POP AF
001319 5319 C9              10      RET
                                
       531A                     INSERT:
00131A 531A F5              11      PUSH    AF
00131B 531B D5              11      PUSH    DE
00131C 531C 2ADCF3          16      LD  HL,(CSRY)
00131F 531F 3AB0F3          13      LD  A,(LINLEN)
001322 5322 4F               4      LD  C,A
001323 5323 94               4      SUB H   ;CSRX
001324 5324 3C               4      INC A
001325 5325 47               4      LD  B,A ;カーソルより右の文字数
001326 5326 C5              11      PUSH    BC
001327 5327 CD4B53          17      CALL    LOC0
00132A 532A C1              10      POP BC
                                
00132B 532B 1620             7      LD  D,020H
       532D                     INS1:
00132D 532D DD214A00        14      LD  IX,RDVRM
001331 5331 CDD442          17      CALL    CALSLT_R
001334 5334 4F               4      LD  C,A
001335 5335 7A               4      LD  A,D
001336 5336 DD214D00        14      LD  IX,WRTVRM
00133A 533A CDD442          17      CALL    CALSLT_R
00133D 533D 23               6      INC HL
00133E 533E 51               4      LD  D,C
00133F 533F 10EC            13      DJNZ    INS1
001341 5341 D1              10      POP DE
001342 5342 F1              10      POP AF
001343 5343 C9              10      RET
                                
       5344                     CONOUT1:
001344 5344 59               4      LD  E,C
001345 5345 C37851          10      JP  _PRINT
                                
       5348                     GETVRAM:
001348 5348 2ADCF3          16      LD  HL,(CSRY)
       534B                     LOC0:
00134B 534B 2D               4      DEC L
00134C 534C 25               4      DEC H
00134D 534D 4C               4      LD  C,H ;CSRX-1
00134E 534E 5D               4      LD  E,L ;CSRY-1
       534F                     LOC1:
00134F 534F 3AB0F3          13      LD  A,(LINLEN)
001352 5352 67               4      LD  H,A
001353 5353 1600             7      LD  D,0
001355 5355 6A               4      LD  L,D ;0
001356 5356 0608             7      LD  B,8
       5358                     LOC2:
001358 5358 29              11      ADD HL,HL
001359 5359 3001            12      JR  NC,LOC3
00135B 535B 19              11      ADD HL,DE
       535C                     LOC3:
00135C 535C 10FA            13      DJNZ    LOC2
00135E 535E 09              11      ADD HL,BC
00135F 535F C9              10      RET
                                
       5360                     _SYS0C:     ;(BDOS)バージョン番号の獲得
001360 5360 212200          10      LD  HL,00022H
001363 5363 AF               4      XOR A
001364 5364 7D               4      LD  A,L
001365 5365 C9              10      RET
                                
       5366                     _SYS0D:     ;(BDOS)ディスク・リセット
001366 5366 218000          10      LD  HL,00080H
001369 5369 22C7F2          16      LD  (_DTA),HL
00136C 536C C9              10      RET
                                
       536D                     _SYS0E:     ;(BDOS)カレントドライブの設定
00136D 536D 7B               4      LD  A,E
00136E 536E FE02             7      CP  2
001370 5370 D0              11      RET NC
001371 5371 32DDF2          13      LD  (_DVSW),A
001374 5374 C9              10      RET
                                
       5375                     _SYS0F:     ;(BDOS)ファイルのオープン
001375 5375 D5              11      PUSH    DE
001376 5376 FDE1            14      POP IY
001378 5378 CDE354          17      CALL    INIT_FILE
00137B 537B CD164B          17      CALL    ROM_OPEN
00137E 537E 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
001380 5380 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
001384 5384 FDE5            15      PUSH    IY
001386 5386 D1              10      POP DE
001387 5387 13               6      INC DE
001388 5388 010B00          10      LD  BC,11
00138B 538B EDB0                    LDIR
                                ;               Attribute
00138D 538D 7E               7      LD  A,(HL)
00138E 538E FD770D          19      LD  (IY+13),A
                                ;               TIME
001391 5391 110B00          10      LD  DE,11
001394 5394 19              11      ADD HL,DE
001395 5395 7E               7      LD  A,(HL)
001396 5396 23               6      INC HL
001397 5397 FD7716          19      LD  (IY+22),A
00139A 539A 7E               7      LD  A,(HL)
00139B 539B 23               6      INC HL
00139C 539C FD7717          19      LD  (IY+23),A
                                ;               DATE
00139F 539F 7E               7      LD  A,(HL)
0013A0 53A0 23               6      INC HL
0013A1 53A1 FD7714          19      LD  (IY+20),A
0013A4 53A4 7E               7      LD  A,(HL)
0013A5 53A5 23               6      INC HL
0013A6 53A6 FD7715          19      LD  (IY+21),A
                                ;               First cluster
0013A9 53A9 7E               7      LD  A,(HL)
0013AA 53AA 23               6      INC HL
0013AB 53AB FD771A          19      LD  (IY+26),A
0013AE 53AE 7E               7      LD  A,(HL)
0013AF 53AF 23               6      INC HL
0013B0 53B0 FD771B          19      LD  (IY+27),A
                                ;               SIZE
0013B3 53B3 7E               7      LD  A,(HL)
0013B4 53B4 23               6      INC HL
0013B5 53B5 FD7710          19      LD  (IY+16),A
0013B8 53B8 7E               7      LD  A,(HL)
0013B9 53B9 23               6      INC HL
0013BA 53BA FD7711          19      LD  (IY+17),A
0013BD 53BD 7E               7      LD  A,(HL)
0013BE 53BE 23               6      INC HL
0013BF 53BF FD7712          19      LD  (IY+18),A
0013C2 53C2 7E               7      LD  A,(HL)
0013C3 53C3 FD7713          19      LD  (IY+19),A
0013C6 53C6 AF               4      XOR A
0013C7 53C7 FD770C          19      LD  (IY+12),A
0013CA 53CA C9              10      RET
                                
       53CB                     _SYS10:     ;(BDOS)ファイルのクローズ
0013CB 53CB AF               4      XOR A
0013CC 53CC C9              10      RET
                                
       53CD                     S11X1:
0013CD 53CD FD7119          19      LD  (IY+25),C       ;RootEntCnt
0013D0 53D0 FD750E          19      LD  (IY+14),L
0013D3 53D3 FD740F          19      LD  (IY+15),H
       53D6                     SCF_FF_RET:
0013D6 53D6 37               4      SCF
0013D7 53D7 9F               4      SBC A,A
0013D8 53D8 C9              10      RET
                                
       53D9                     _SYS11:     ;(BDOS)最初のファイルの検索
0013D9 53D9 ED53CAF2        20      LD  (_FCB),DE
0013DD 53DD D5              11      PUSH    DE
0013DE 53DE FDE1            14      POP IY
0013E0 53E0 CDE354          17      CALL    INIT_FILE
0013E3 53E3 CD744D          17      CALL    GET_DIR_DAT
       53E6                     S12X1:
0013E6 53E6 CD324B          17      CALL    FILESE
0013E9 53E9 30E2            12      JR  NC,S11X1
0013EB 53EB 0D               4      DEC C
0013EC 53EC FD7119          19      LD  (IY+25),C       ;RootEntCnt
0013EF 53EF FDCB0D66        20      BIT 4,(IY+13)
0013F3 53F3 2809            12      JR  Z,S12X2
0013F5 53F5 E5              11      PUSH    HL
0013F6 53F6 DDE1            14      POP IX
0013F8 53F8 DDCB0E66        20      BIT 4,(IX+1+13)
0013FC 53FC 28E8            12      JR  Z,S12X1
       53FE                     S12X2:
0013FE 53FE 012000          10      LD  BC,32
001401 5401 ED5BC7F2        20      LD  DE,(_DTA)
001405 5405 AF               4      XOR A
001406 5406 12               7      LD  (DE),A      ;ドライブ番号
001407 5407 13               6      INC DE
001408 5408 EDB0                    LDIR            ;ディレクトリエントリ
00140A 540A FD750E          19      LD  (IY+14),L
00140D 540D FD740F          19      LD  (IY+15),H
001410 5410 C9              10      RET
                                
       5411                     _SYS12:
001411 5411 FD2ACAF2        20      LD  IY,(_FCB)
001415 5415 FDE5            15      PUSH    IY
001417 5417 D1              10      POP DE
001418 5418 CDE354          17      CALL    INIT_FILE
                                
00141B 541B FD6E0E          19      LD  L,(IY+14)
00141E 541E FD660F          19      LD  H,(IY+15)
001421 5421 FD4E19          19      LD  C,(IY+25)
001424 5424 18C0            12      JR  S12X1
                                
       5426                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
001426 5426 CD5A4D          17      CALL    SET_FCB
001429 5429 CD284D          17      CALL    GETSEQ
00142C 542C CD154D          17      CALL    RB_READ
00142F 542F E5              11      PUSH    HL
001430 5430 CD354D          17      CALL    SETSEQ
001433 5433 E1              10      POP HL
       5434                     SREAD:
001434 5434 C601             7      ADD A,001H
001436 5436 D8              11      RET C
                                
001437 5437 7D               4      LD  A,L
001438 5438 D601             7      SUB 001H
00143A 543A 9F               4      SBC A,A
00143B 543B E603             7      AND 3
00143D 543D 1F               4      RRA
00143E 543E C9              10      RET
                                
       543F                     _SYS18:     ;(BDOS)ログインベクトルの獲得
00143F 543F 210100          10      LD  HL,00001H
001442 5442 AF               4      XOR A
001443 5443 C9              10      RET
                                
       5444                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
001444 5444 3ADDF2          13      LD  A,(_DVSW)
001447 5447 C9              10      RET
                                
       5448                     _SYS1A:     ;(BDOS)DTAの設定
001448 5448 ED53C7F2        20      LD  (_DTA),DE
00144C 544C AF               4      XOR A
00144D 544D C9              10      RET
                                
       544E                     _SYS1B:     ;(BDOS)ディスク情報の獲得
00144E 544E 010002          10      LD  BC,512
001451 5451 11C302          10      LD  DE,707
001454 5454 210000          10      LD  HL,0
001457 5457 DD21CCF2        14      LD  IX,_BUF
00145B 545B FD21CCF2        14      LD  IY,_BUF
00145F 545F FD3600F9        19      LD  (IY+0),0F9H
001463 5463 3E02             7      LD  A,2
001465 5465 C9              10      RET
                                
       5466                     _SYS21:     ;(BDOS)ランダムな読み出し
001466 5466 CD5A4D          17      CALL    SET_FCB
                                
001469 5469 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
00146C 546C FD6622          19      LD  H,(IY+34)
                                
00146F 546F CD154D          17      CALL    RB_READ
001472 5472 18C0            12      JR  SREAD
                                
       5474                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
001474 5474 CD7553          17      CALL    _SYS0F
001477 5477 D8              11      RET C
                                
001478 5478 D5              11      PUSH    DE      ;EX DE,IY
001479 5479 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00147B 547B CD4A4D          17      CALL    GETSIZE
       547E                     _S24X1:
00147E 547E FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001481 5481 FD7422          19      LD  (IY+34),H
001484 5484 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
001488 5488 FDE3            23      EX  (SP),IY     ;
00148A 548A D1              10      POP DE      ;
                                
00148B 548B AF               4      XOR A
00148C 548C C9              10      RET
                                
       548D                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
00148D 548D E5              11      PUSH    HL
00148E 548E D5              11      PUSH    DE      ;EX DE,IY
00148F 548F FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001491 5491 CD284D          17      CALL    GETSEQ
001494 5494 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       5496                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001496 5496 CD5A4D          17      CALL    SET_FCB
001499 5499 E5              11      PUSH    HL
00149A 549A FD6E21          19      LD  L,(IY+33)
00149D 549D FD6622          19      LD  H,(IY+34)
0014A0 54A0 22BDF2          16      LD  (RR_LOW),HL
0014A3 54A3 FD6E23          19      LD  L,(IY+35)
0014A6 54A6 FD6624          19      LD  H,(IY+36)
0014A9 54A9 22BFF2          16      LD  (RR_HIGH),HL
0014AC 54AC E1              10      POP HL
0014AD 54AD CDF648          17      CALL    ROM_READ
0014B0 54B0 ED5BBDF2        20      LD  DE,(RR_LOW)
0014B4 54B4 FD7321          19      LD  (IY+33),E
0014B7 54B7 FD7222          19      LD  (IY+34),D
0014BA 54BA ED5BBFF2        20      LD  DE,(RR_HIGH)
0014BE 54BE FD7323          19      LD  (IY+35),E
0014C1 54C1 FD7224          19      LD  (IY+36),D
0014C4 54C4 9F               4      SBC A,A
0014C5 54C5 C9              10      RET
                                
       54C6                     _SYS2F:
0014C6 54C6 44               4      LD  B,H
0014C7 54C7 2AC7F2          16      LD  HL,(_DTA)
0014CA 54CA C3414F          10      JP  DISKIO
                                
       54CD                     _SYS5A:
0014CD 54CD 0600             7      LD  B,0
0014CF 54CF D5              11      PUSH    DE
0014D0 54D0 DDE1            14      POP IX
       54D2                     _SX5A1:
0014D2 54D2 1A               7      LD  A,(DE)
0014D3 54D3 B7               4      OR  A
0014D4 54D4 2804            12      JR  Z,_SX5A2
0014D6 54D6 13               6      INC DE
0014D7 54D7 04               4      INC B
0014D8 54D8 18F8            12      JR  _SX5A1
                                
       54DA                     _SX5A2:
0014DA 54DA 78               4      LD  A,B
0014DB 54DB CDC149          17      CALL    FILE_BDOS
0014DE 54DE CDFE4D          17      CALL    ROM_CD
0014E1 54E1 9F               4      SBC A,A
0014E2 54E2 C9              10      RET
                                
       54E3                     INIT_FILE:
0014E3 54E3 EB               4      EX  DE,HL
0014E4 54E4 11EBF2          10      LD  DE,FDRV
0014E7 54E7 010C00          10      LD  BC,1+8+3
       54EA                     INIT_FILE1:
0014EA 54EA EDB0                    LDIR
0014EC 54EC CD0951          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0014EF 54EF 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0014F2 54F2 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0014F5 54F5 2ADEF2          16      LD  HL,(_CD)
0014F8 54F8 22E9F2          16      LD  (_CDX),HL           ;カレントディレクトリ
0014FB 54FB C9              10      RET
                                
       54FC                     ZERO_MEMORY_DE:
0014FC 54FC AF               4      XOR A
       54FD                     FILL_MEMORY_DE:
0014FD 54FD 12               7      LD  (DE),A
0014FE 54FE 13               6      INC DE
0014FF 54FF 10FC            13      DJNZ    FILL_MEMORY_DE
001501 5501 C9              10      RET
                                
001502 5502                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 65517B51AC516551        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 65516551B151F251        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 B95165510C52A052        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 605366536D537553        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 CB53D95311546551        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 2654655165516551        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 3F54445448544E54        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 6551655165517454        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 8D54655165519654        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 65516551B2526551        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 B85265516551C654        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 65516551CD546551        DW  _ERROR,_ERROR,_SYS5A,_ERROR
001FB8 5FB8 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 6551655165516551        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
