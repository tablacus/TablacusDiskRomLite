                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       269A                     DECADD  EQU 0269AH
       27E6                     DECMUL  EQU 027E6H
       2F8A                     FRCINT  EQU 02F8AH
                                
       303A                     FRCDBL  EQU 0303AH
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F847                     ARG EQU 0F847H
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FDDB                     H_PINL  EQU 0FDDBH
                                
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                            ;ASCII-16K
                                ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
                                ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
       F280                     ISC EQU 0F280H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F280                     SP32    EQU 0F280H
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM    ; Main program execution address.
000004 4004 634E                    DW  STATEMENT   ; STATEMENT
000006 4006 804F                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C3D150          10      JP  DISKIO
000013 4013 C30C51          10      JP  DSKCHG
000016 4016 C36251          10      JP  GETDPB
000019 4019 C35552          10      JP  CHOICE
00001C 401C C35952          10      JP  DSKFMT
00001F 401F C35B52          10      JP  DSKSTP
000022 4022 C35C52          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C35952          10      JP  DSKFMT
000029 4029 C35B52          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C39552          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.4.2.1",0
            204449534B20524F    
            4D204C6974652076    
            302E342E322E3100    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 AF               4      XOR A
000107 4107 2100F3          10      LD  HL,0F300H
00010A 410A 0668             7      LD  B,068H
00010C 410C CD174B          17      CALL    FILL_MEMORY
                                
00010F 410F 3E01             7      LD  A,1
000111 4111 3221FB          13      LD  (DRVTBL),A
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  HL,(STKTOP) ;起動時の空き容量表示の為
                                    LD  BC,-00140H
                                    ADD HL,BC
                                    LD  (STKTOP),HL
                                #else
000114 4114 2175F6          10      LD  HL,STKTOP+1 ;起動時の空き容量表示の為
000117 4117 35              11      DEC (HL)
                                #endif
                                
000118 4118 AF               4      XOR A
000119 4119 32EAF2          13      LD  (_DVSW),A
00011C 411C 3D               4      DEC A       ;0FFH
00011D 411D 3299FD          13      LD  (DEVICE),A
                                
000120 4120 21E042          10      LD  HL,AT_ISC
000123 4123 1180F2          10      LD  DE,ISC
000126 4126 018800          10      LD  BC,ISC_E-ISC
000129 4129 EDB0                    LDIR
                                    
00012B 412B 3EC3             7      LD  A,0C3H      ;JP
00012D 412D 3243FF          13      LD  (H_GONE),A
000130 4130 327DF3          13      LD  (BDOS),A
000133 4133 326BF3          13      LD  (RAMUSE),A
000136 4136 3268F3          13      LD  (ROMUSE),A
000139 4139 2180F2          10      LD  HL,REPLACE_COMMAND
00013C 413C 2244FF          16      LD  (H_GONE+1),HL
00013F 413F 2131F3          10      LD  HL,H_BDOS
000142 4142 227EF3          16      LD  (BDOS+1),HL
000145 4145 21ABF2          10      LD  HL,RAMUSE1
000148 4148 226CF3          16      LD  (RAMUSE+1),HL
00014B 414B 21BEF2          10      LD  HL,ROMUSE1
00014E 414E 2269F3          16      LD  (ROMUSE+1),HL
                                
000151 4151 3E                      DB  03EH
000152 4152 F7              12      RST 30H
000153 4153 3271FE          13      LD  (H_BINS),A
000156 4156 3276FE          13      LD  (H_BINL),A
000159 4159 327BFE          13      LD  (H_FILE),A
00015C 415C 3231F3          13      LD  (H_BDOS),A
00015F 415F 32DBFD          13      LD  (H_PINL),A
000162 4162 32A7FF          13      LD  (H_PHYD),A
                                
000165 4165 CD2C42          17      CALL    GTSL1_
000168 4168 3297F2          13      LD  (ROM_SLT),A
00016B 416B 32A7F2          13      LD  (ROM_SLT_COPY),A
00016E 416E 3272FE          13      LD  (H_BINS+1),A
000171 4171 3277FE          13      LD  (H_BINL+1),A
000174 4174 327CFE          13      LD  (H_FILE+1),A
000177 4177 3232F3          13      LD  (H_BDOS+1),A
00017A 417A 32DCFD          13      LD  (H_PINL+1),A
00017D 417D 32A8FF          13      LD  (H_PHYD+1),A
000180 4180 3222FB          13      LD  (DRVTBL+1),A
000183 4183 3248F3          13      LD  (MASTERS),A
                                
000186 4186 211A45          10      LD  HL,ROM_LOAD
000189 4189 2273FE          16      LD  (H_BINS+2),HL
00018C 418C 21CB46          10      LD  HL,ROM_RUN
00018F 418F 2278FE          16      LD  (H_BINL+2),HL
000192 4192 21D946          10      LD  HL,ROM_FILES
000195 4195 227DFE          16      LD  (H_FILE+2),HL
000198 4198 21FD52          10      LD  HL,ROM_BDOS
00019B 419B 2233F3          16      LD  (H_BDOS+2),HL
00019E 419E 21A343          10      LD  HL,ROM_BOOT
0001A1 41A1 22DDFD          16      LD  (H_PINL+2),HL
0001A4 41A4 21D150          10      LD  HL,DISKIO
0001A7 41A7 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001AA 41AA 3E                      DB  03EH
0001AB 41AB C9              10      RET
0001AC 41AC 327FFE          13      LD  (H_FILE+4),A
0001AF 41AF 3275FE          13      LD  (H_BINS+4),A
0001B2 41B2 327AFE          13      LD  (H_BINL+4),A
0001B5 41B5 3235F3          13      LD  (H_BDOS+4),A
0001B8 41B8 32DFFD          13      LD  (H_PINL+4),A
0001BB 41BB 32ABFF          13      LD  (H_PHYD+4),A
                                
0001BE 41BE AF               4      XOR A
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0001BF 41BF 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001C2 41C2 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001C5 41C5 3A0060          13      LD  A,(BANK1_ADR)
0001C8 41C8 FE41             7      CP  'A'
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JR  Z,NOT_BANK_TYPE
                                    LD  A,DISK_BANK
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0001CA 41CA 204F            12      JR  NZ,NOT_BANK_TYPE
0001CC 41CC 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001CF 41CF 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001D2 41D2 CD3801          17      CALL    RSLREG      ;read primary slot #
0001D5 41D5 07               4      RLCA
0001D6 41D6 07               4      RLCA
0001D7 41D7 F5              11      PUSH    AF
0001D8 41D8 1605             7      LD  D,4+1
0001DA 41DA CD3342          17      CALL    GTSL2_
0001DD 41DD 3244F3          13      LD  (RAMAD3),A
0001E0 41E0 F1              10      POP AF
0001E1 41E1 07               4      RLCA
0001E2 41E2 07               4      RLCA
0001E3 41E3 1603             7      LD  D,2+1
0001E5 41E5 CD3342          17      CALL    GTSL2_
0001E8 41E8 2680             7      LD  H,080H
0001EA 41EA CD5042          17      CALL    CHK_RAM
0001ED 41ED 3243F3          13      LD  (RAMAD2),A
       41F0                     RAMCHK2:
0001F0 41F0 3A44F3          13      LD  A,(RAMAD3)
0001F3 41F3 2640             7      LD  H,040H
0001F5 41F5 CD5042          17      CALL    CHK_RAM
0001F8 41F8 3242F3          13      LD  (RAMAD1),A
       41FB                     RAMCHK1:
0001FB 41FB 3A44F3          13      LD  A,(RAMAD3)
0001FE 41FE 2600             7      LD  H,00H
000200 4200 CD5042          17      CALL    CHK_RAM
000203 4203 3241F3          13      LD  (RAMAD0),A
       4206                     RAMCHK0:
000206 4206 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
000209 4209 010F00          10      LD  BC,0000FH       ;切り上げ
00020C 420C 09              11      ADD HL,BC
00020D 420D 7D               4      LD  A,L
                                
00020E 420E 0604             7      LD  B,4
       4210                     B_DRIVE1:
000210 4210 CB3C             8      SRL H
000212 4212 1F               4      RRA
000213 4213 10FB            13      DJNZ    B_DRIVE1
                                
000215 4215 C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000217 4217 32E9F2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
00021A 421A C9              10      RET
                                
       421B                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
00021B 421B 21E643          10      LD  HL,MSG_ERROR_ROM_MODE
00021E 421E CD6B43          17      CALL    MSX
000221 4221 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000225 4225 DD219F00        14      LD  IX,CHGET
000229 4229 C31C00          10      JP  _CALSLT
                                
       422C                     GTSL1_:             ;自分のいるスロットを知る
00022C 422C CD3801          17      CALL    RSLREG      ;read primary slot #
00022F 422F 0F               4      RRCA
000230 4230 0F               4      RRCA
000231 4231 1601             7      LD  D,1
       4233                     GTSL2_:
000233 4233 E603             7      AND 3       ;[A]=000000PP
000235 4235 5F               4      LD  E,A     ;[E]=000000PP
000236 4236 21C1FC          10      LD  HL,EXPTBL
000239 4239 85               4      ADD A,L     ;桁上りは無い
00023A 423A 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
00023B 423B 7B               4      LD  A,E     ;[A]=000000PP
00023C 423C CB7E            13      BIT 7,(HL)
00023E 423E C8              11      RET Z
00023F 423F 7D               4      LD  A,L     ;point to SLTTBL entry
000240 4240 C604             7      ADD A,4     ;桁上りは無い
000242 4242 6F               4      LD  L,A
000243 4243 7E               7      LD  A,(HL)      ;get currently expansion slot register
       4244                     GTSL3_:
000244 4244 15               4      DEC D
000245 4245 2803            12      JR  Z,GTSL4_:
000247 4247 0F               4      RRCA
000248 4248 18FA            12      JR  GTSL3_:
       424A                     GTSL4_:
00024A 424A E60C             7      AND 00CH        ;[A] = 0000SS00
00024C 424C B3               4      OR  E       ;[A] = 0000SSPP
00024D 424D F680             7      OR  080H        ;[A] = 1000SSPP
00024F 424F C9              10      RET
                                
       4250                     CHK_RAM:
000250 4250 E5              11      PUSH    HL
000251 4251 CDA542          17      CALL    CHK_RAM0
000254 4254 E1              10      POP HL
000255 4255 C8              11      RET Z
000256 4256 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000259 4259 E680             7      AND 080H
00025B 425B CD7C42          17      CALL    CHK_RAM_SLT
00025E 425E C8              11      RET Z
00025F 425F 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000262 4262 E680             7      AND 080H
000264 4264 C601             7      ADD A,1
000266 4266 CD7C42          17      CALL    CHK_RAM_SLT
000269 4269 C8              11      RET Z
00026A 426A 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00026D 426D E680             7      AND 080H
00026F 426F C602             7      ADD A,2
000271 4271 CD7C42          17      CALL    CHK_RAM_SLT
000274 4274 C8              11      RET Z
000275 4275 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000278 4278 E680             7      AND 080H
00027A 427A C603             7      ADD A,3
       427C                     CHK_RAM_SLT:
00027C 427C E5              11      PUSH    HL
00027D 427D CDA542          17      CALL    CHK_RAM0        ;スロット#X or X-0
000280 4280 E1              10      POP HL
000281 4281 C8              11      RET Z
000282 4282 CB79             8      BIT 7,C
000284 4284 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000286 4286 79               4      LD  A,C
000287 4287 C604             7      ADD A,4*1           ;スロット#X-1
000289 4289 E5              11      PUSH    HL
00028A 428A CDA542          17      CALL    CHK_RAM0
00028D 428D E1              10      POP HL
00028E 428E C8              11      RET Z
00028F 428F 79               4      LD  A,C
000290 4290 C608             7      ADD A,4*2           ;スロット#X-2
000292 4292 E5              11      PUSH    HL
000293 4293 CDA542          17      CALL    CHK_RAM0
000296 4296 E1              10      POP HL
000297 4297 C8              11      RET Z
000298 4298 79               4      LD  A,C
000299 4299 C60C             7      ADD A,4*3           ;スロット#X-3
00029B 429B E5              11      PUSH    HL
00029C 429C CDA542          17      CALL    CHK_RAM0
00029F 429F E1              10      POP HL
       42A0                     CHK_RAM_E:
0002A0 42A0 AF               4      XOR A
0002A1 42A1 3C               4      INC A           ;ZF=0にする
0002A2 42A2 3E00             7      LD  A,0
0002A4 42A4 C9              10      RET
                                
       42A5                     CHK_RAM0:
0002A5 42A5 4F               4      LD  C,A
0002A6 42A6 3A97F2          13      LD  A,(ROM_SLT)
0002A9 42A9 B9               4      CP  C
0002AA 42AA 28F4            12      JR  Z,CHK_RAM_E
0002AC 42AC 2E00             7      LD  L,0
       42AE                     CHK_RAM1:
0002AE 42AE 79               4      LD  A,C
0002AF 42AF CD9B43          17      CALL    RDSLTX
0002B2 42B2 C6E5             7      ADD A,0E5H
0002B4 42B4 47               4      LD  B,A
0002B5 42B5 5F               4      LD  E,A
0002B6 42B6 79               4      LD  A,C
0002B7 42B7 C5              11      PUSH    BC
0002B8 42B8 CD1400          17      CALL    _WRSLT
0002BB 42BB C1              10      POP BC
0002BC 42BC 79               4      LD  A,C
0002BD 42BD CD9B43          17      CALL    RDSLTX
0002C0 42C0 B8               4      CP  B
0002C1 42C1 C0              11      RET NZ
0002C2 42C2 D6E5             7      SUB 0E5H
0002C4 42C4 79               4      LD  A,C
0002C5 42C5 5F               4      LD  E,A
0002C6 42C6 C5              11      PUSH    BC
0002C7 42C7 CD1400          17      CALL    _WRSLT
0002CA 42CA C1              10      POP BC
0002CB 42CB 24               4      INC H
0002CC 42CC 7D               4      LD  A,L
0002CD 42CD C604             7      ADD A,4
0002CF 42CF 6F               4      LD  L,A
0002D0 42D0 20DC            12      JR  NZ,CHK_RAM1
0002D2 42D2 79               4      LD  A,C     ;ZF=1のハズ
0002D3 42D3 C9              10      RET
                                
       42D4                     CALSLT_R:
0002D4 42D4 C5              11      PUSH    BC
0002D5 42D5 E5              11      PUSH    HL
0002D6 42D6 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0002DA 42DA CD1C00          17      CALL    _CALSLT
0002DD 42DD E1              10      POP HL
0002DE 42DE C1              10      POP BC
0002DF 42DF C9              10      RET
                                
       42E0                     AT_ISC:
0002E0 F280                         ORG ISC,AT_ISC-RUN
       F280                     REPLACE_COMMAND:
0002E0 F280 FEB7             7      CP  0B7H            ;FILES
0002E2 F282 CC7BFE          17      CALL    Z,H_FILE
0002E5 F285 FEB5             7      CP  0B5H            ;LOAD
0002E7 F287 CA71FE          10      JP  Z,H_BINS
0002EA F28A FE8A             7      CP  08AH            ;RUN
0002EC F28C CA76FE          10      JP  Z,H_BINL
0002EF F28F FED6             7      CP  0D6H            ;COPY
0002F1 F291 2813            12      JR  Z,FIX_COPY
0002F3 F293 FECF             7      CP  0CFH            ;BLOAD
0002F5 F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
0002F6 F296 F7              12      RST 30H
       F297                     ROM_SLT:
0002F7 F297 00                      DB  0
0002F8 F298 FC45                    DW  ROM_BLOAD
0002FA F29A F5              11      PUSH    AF
0002FB F29B E5              11      PUSH    HL
0002FC F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
0002FF F29F E1              10      POP HL
000300 F2A0 F1              10      POP AF
000301 F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
000303 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
000305 F2A5 C9              10      RET
       F2A6                     FIX_COPY:
000306 F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
000307 F2A7 00                      DB  0
000308 F2A8 7747                    DW  ROM_COPY
00030A F2AA C9              10      RET
       F2AB                     RAMUSE1:
00030B F2AB 3A42F3          13      LD  A,(RAMAD1)
       F2AE                     ROMUSE2:
00030E F2AE C32400          10      JP  _ENASLT
       F2B1                     CAL_MP:
000311 F2B1 2640             7      LD  H,040H
000313 F2B3 3AC1FC          13      LD  A,(EXPTBL)
000316 F2B6 CD2400          17      CALL    _ENASLT
000319 F2B9 CD1C00          17      CALL    _CALSLT
00031C F2BC 2640             7      LD  H,040H
       F2BE                     ROMUSE1:
00031E F2BE 3A97F2          13      LD  A,(ROM_SLT)
000321 F2C1 18EB            12      JR  ROMUSE2
                                
       F2C3                     _RESULT:
000323 F2C3 00                      DB  0
       F2C4                     _BANK:
000324 F2C4 00                      DB  0
       F2C5                     _BANK1:
000325 F2C5 00                      DB  0
       F2C6                     CLSZ:               ;クラスタサイズ
000326 F2C6 0004                    DW  1024
       F2C7                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2C8                     SECSZ:              ;セクタサイズ
000328 F2C8 0002                    DW  512
       F2C9                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2CA                     RR_LOW:
00032A F2CA 0000                    DW  0
       F2CB                     RR_MID  EQU $-1
       F2CC                     RR_HIGH:
00032C F2CC 0000                    DW  0
       F2CE                     _CLPS:
00032E F2CE 0000                    DW  0
       F2D0                     _LEFT:
000330 F2D0 0000                    DW  0
       F2D2                     _DTPS:
000332 F2D2 0000                    DW  0
       F2D4                     _DTA:
000334 F2D4 0000                    DW  0
       F2D6                     FLG_LDIR:
000336 F2D6 00                      DB  0
       F2D7                     _FCB:
000337 F2D7 0000                    DW  0
       F2D9                     _BUF:
       F2D9                     _BUF_LO:        ;LOGICAL OPERATION
000339 F2D9 00                      DB  0
       F2DA                     _BUF_ST:
00033A F2DA 0000                    DW  0
       F2DC                     _BUF_EN:
00033C F2DC 0000                    DW  0
       F2DE                     _BUF_EX:
       F2DE                     _BUF_W:
00033E F2DE 0000                    DW  0
       F2E0                     _BUF_H:
000340 F2E0 0000                    DW  0
       F2E2                     _BUF_X:
000342 F2E2 0000                    DW  0
       F2E4                     _BUF_Y:
000344 F2E4 00                      DB  0
       F2E5                     _BUF_P:
000345 F2E5 00                      DB  0
       F2E6                     _BUF_O:
000346 F2E6 00                      DB  0
       F2E7                     DTAX:
000347 F2E7 0000                    DW  0
       F2E9                     B_DRIVE:
000349 F2E9 00                      DB  0
       F2EA                     _DVSW:          ;カレントドライブ
00034A F2EA 00                      DB  0
       F2EB                     _CD:            ;カレントディレクトリ
00034B F2EB 0000                    DW  0
       F2ED                     DIRENT1:
00034D F2ED 0000                    DW  0
       F2EF                     _DIR_BANK:
00034F F2EF 00                      DB  0
       F2F0                     LEFTX:
000350 F2F0 0000                    DW  0
       F2F2                     PARAM0:
000352 F2F2 0000                    DW  0
       F2F4                     PARAM1:
000354 F2F4 0000                    DW  0
       F2F6                     _CDX:
000356 F2F6 0000                    DW  0
       F2F8                     FDRV:
000358 F2F8 00                      DB  0
       F2F9                     FNAME:
000359 F2F9                         DS  8+3
       F304                     _HL:
000364 F304 0000                    DW  0
       F306                     _SP:
000366 F306 0000                    DW  0
       F307                     _SP_H   EQU $-1
       F308                     ISC_E:
000368 4368                         ORG $$+RUN          ;$DEPHASE
                                
       4368                     MSX1:
000368 4368 CD1653          17      CALL    MSGA1
       436B                     MSX:
00036B 436B 7E               7      LD  A,(HL)
00036C 436C 23               6      INC HL
00036D 436D B7               4      OR  A
00036E 436E 20F8            12      JR  NZ,MSX1
000370 4370 C9              10      RET
                                
       4371                     PRTHX:
000371 4371 F5              11      PUSH    AF
000372 4372 07               4      RLCA
000373 4373 07               4      RLCA
000374 4374 07               4      RLCA
000375 4375 07               4      RLCA
000376 4376 CD7A43          17      CALL    PRTA2
000379 4379 F1              10      POP AF
       437A                     PRTA2:
00037A 437A CD8043          17      CALL    ASC
00037D 437D C31253          10      JP  MSG_A
                                    
       4380                     ASC:
000380 4380 E60F             7      AND $0F
000382 4382 F630             7      OR  $30
000384 4384 FE3A             7      CP  $3A
000386 4386 D8              11      RET C
000387 4387 C607             7      ADD A,7
000389 4389 C9              10      RET
                                
       438A                     MSN:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
00038A 438A 7E               7      LD  A,(HL)
                                #endif
00038B 438B 23               6      INC HL
00038C 438C CD1253          17      CALL    MSG_A
00038F 438F 10F9            13      DJNZ    MSN
000391 4391 C9              10      RET
                                
       4392                     RDSLT_ROM3:
000392 4392 7E               7      LD  A,(HL)
000393 4393 C9              10      RET
       4394                     RDSLT_ROM:
000394 4394 CB7C             8      BIT 7,H
000396 4396 28FA            12      JR  Z,RDSLT_ROM3
       4398                     RDSLT_ROM2:
000398 4398 3A97F2          13      LD  A,(ROM_SLT)
       439B                     RDSLTX:
00039B 439B C5              11      PUSH    BC
00039C 439C D5              11      PUSH    DE
00039D 439D CD0C00          17      CALL    _RDSLT
0003A0 43A0 D1              10      POP DE
0003A1 43A1 C1              10      POP BC
0003A2 43A2 C9              10      RET
                                
       43A3                     ROM_BOOT:
0003A3 43A3 3E                      DB  03EH
0003A4 43A4 C9              10      RET
0003A5 43A5 32DBFD          13      LD  (H_PINL),A
0003A8 43A8 3ACAFF          13      LD  A,(EXTBIO)
0003AB 43AB FEF7             7      CP  0F7H        ;RST 30H
0003AD 43AD 280A            12      JR  Z,EXTBIO_OK
0003AF 43AF 3E                      DB  03EH
0003B0 43B0 C9              10      RET
0003B1 43B1 21CAFF          10      LD  HL,EXTBIO
0003B4 43B4 061D             7      LD  B,29
0003B6 43B6 CD174B          17      CALL    FILL_MEMORY
       43B9                     EXTBIO_OK:
0003B9 43B9 210C44          10      LD  HL,DELOK
0003BC 43BC CD6B43          17      CALL    MSX
                                
0003BF 43BF AF               4      XOR A
0003C0 43C0 3240F3          13      LD  (REBOOT),A
0003C3 43C3 2A48FC          16      LD  HL,(BOTTOM)
0003C6 43C6 110040          10      LD  DE,16384
0003C9 43C9 19              11      ADD HL,DE
0003CA 43CA 3817            12      JR  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
0003CC 43CC 57               4      LD  D,A
0003CD 43CD 0601             7      LD  B,1
0003CF 43CF 2100C0          10      LD  HL,0C000H
0003D2 43D2 CDD150          17      CALL    DISKIO
                                
0003D5 43D5 116BF3          10      LD  DE,RAMUSE
0003D8 43D8 AF               4      XOR A
0003D9 43D9 CD1EC0          17      CALL    0C01EH
0003DC 43DC 116BF3          10      LD  DE,RAMUSE
0003DF 43DF 37               4      SCF
0003E0 43E0 CD1EC0          17      CALL    0C01EH
       43E3                     BOOT1:
0003E3 43E3 C35C52          10      JP  BASENT
                                
       43E6                     MSG_ERROR_ROM_MODE:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DB  "Normal ROM/ASCII-16K only!",13,10
                                #else
0003E6 43E6 41534349492D384B        DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
            2F4B6F6E616D692D    
            384B2F4B6F6E616D    
            692D534343206F6E    
            6C79210D0A          
                                #endif
       440B                     NULL:
00040B 440B 00                      DB  0
       440C                     DELOK:
00040C 440C 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       4410                     ROM_LDIR:
000410 4410 3AD6F2          13      LD  A,(FLG_LDIR)
000413 4413 B7               4      OR  A
000414 4414 2008            12      JR  NZ,ROM_LDIRVM
000416 4416 CB7A             8      BIT 7,D
000418 4418 CA3044          10      JP  Z,ROM_LDIRSLT
                                #if exists USE_MORMAL32K_OR_ASCII16
                                LDIRA:
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ1
                                    LD  SP,SP32
                                SPJ1:
                                LDIR1:
                                    LD  A,B
                                    OR  C
                                    JR  Z,LDIRE
                                
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                LDIR2:
                                    LD  A,D
                                    CP  0C0H
                                    JR  NC,LDIR4
                                
                                    PUSH    BC
                                    PUSH    DE
                                    LD  DE,BUF
                                
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIR3
                                    LD  BC,00100H
                                LDIR3:
                                    PUSH    BC
                                    LDIR
                                    LD  (_HL),HL
                                
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                
                                    POP BC
                                    POP DE
                                    LD  HL,BUF
                                    LDIR
                                
                                    LD  HL,(_HL)
                                    POP BC
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIRE
                                    DEC B
                                    JR  LDIR1
                                LDIR4:
                                #endif
00041B 441B EDB0                    LDIR
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                LDIRE2:
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                LDIRE:
                                    LD  SP,(_SP)
                                #endif
00041D 441D C9              10      RET
                                
       441E                     ROM_LDIRVM:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ2
                                    LD  SP,SP32
                                SPJ2:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
00041E 441E C5              11      PUSH    BC
00041F 441F D5              11      PUSH    DE
000420 4420 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000424 4424 DD215C00        14      LD  IX,LDIRVM
000428 4428 CD1C00          17      CALL    _CALSLT
00042B 442B E1              10      POP HL
00042C 442C C1              10      POP BC
00042D 442D 09              11      ADD HL,BC
00042E 442E EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JR  LDIRE2
                                #else
00042F 442F C9              10      RET
                                #endif
                                
       4430                     ROM_LDIRSLT:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ3
                                    LD  SP,SP32
                                SPJ3:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
       4430                     ROM_LDIRSLT1:
000430 4430 EB               4      EX  DE,HL
       4431                     RLDIRSLT1:
000431 4431 CB7C             8      BIT 7,H
000433 4433 201F            12      JR  NZ,RLDIRSLT_EXIT
000435 4435 1A               7      LD  A,(DE)
000436 4436 13               6      INC DE
000437 4437 C5              11      PUSH    BC
000438 4438 D5              11      PUSH    DE
000439 4439 E5              11      PUSH    HL
00043A 443A 5F               4      LD  E,A
                                
00043B 443B 0141F3          10      LD  BC,RAMAD0
00043E 443E 7C               4      LD  A,H
00043F 443F 07               4      RLCA
000440 4440 07               4      RLCA
000441 4441 E603             7      AND 3
000443 4443 81               4      ADD A,C
000444 4444 4F               4      LD  C,A
000445 4445 0A               7      LD  A,(BC)
       4446                     RLDIRSLT2:
000446 4446 CD1400          17      CALL    _WRSLT
000449 4449 08               4      EX  AF,AF'
00044A 444A E1              10      POP HL
00044B 444B D1              10      POP DE
00044C 444C C1              10      POP BC
00044D 444D EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00044F 444F EA3144          10      JP  PE,RLDIRSLT1
000452 4452 EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JP  LDIRE2
                                RLDIRSLT_EXIT:
                                    EX  DE,HL
                                    JP  LDIR1
                                #else
000453 4453 C9              10      RET
       4454                     RLDIRSLT_EXIT:
000454 4454 EB               4      EX  DE,HL
000455 4455 EDB0                    LDIR
000457 4457 C9              10      RET
                                #endif
                                
       4458                     END_OF_LINE:
000458 4458 215EF5          10      LD  HL,BUF
       445B                     EOL1:
00045B 445B 7E               7      LD  A,(HL)
00045C 445C C8              11      RET Z
00045D 445D FE0D             7      CP  00DH
00045F 445F 2807            12      JR  Z,EOLE
000461 4461 FE0A             7      CP  00AH
000463 4463 2803            12      JR  Z,EOLE
000465 4465 23               6      INC HL
000466 4466 18F3            12      JR  EOL1
       4468                     EOLE:
000468 4468 3600            10      LD  (HL),0
00046A 446A 23               6      INC HL
00046B 446B 7E               7      LD  A,(HL)
00046C 446C FE0A             7      CP  00AH
00046E 446E C0              11      RET NZ
00046F 446F 23               6      INC HL
000470 4470 C9              10      RET
                                
       4471                     ROM_LOAD_ASCII:
000471 4471 210000          10      LD  HL,0
000474 4474 22DAF2          16      LD  (_BUF_ST),HL    ;読み出し位置
000477 4477 2A76F6          16      LD  HL,(TXTTAB)
00047A 447A 22DCF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
00047D 447D 215EF5          10      LD  HL,BUF
000480 4480 22D4F2          16      LD  (_DTA),HL
       4483                     RLOAD_A1:
000483 4483 2ADAF2          16      LD  HL,(_BUF_ST)
000486 4486 22CAF2          16      LD  (RR_LOW),HL
000489 4489 210201          10      LD  HL,258
00048C 448C CD9749          17      CALL    ROM_READ
00048F 448F 7C               4      LD  A,H
000490 4490 B5               4      OR  L
000491 4491 2879            12      JR  Z,RLOAD_AEND
000493 4493 015EF5          10      LD  BC,BUF
000496 4496 09              11      ADD HL,BC
000497 4497 3600            10      LD  (HL),0
000499 4499 CD5844          17      CALL    END_OF_LINE
00049C 449C 015EF5          10      LD  BC,BUF
00049F 449F A7               4      AND A
0004A0 44A0 ED42            15      SBC HL,BC
0004A2 44A2 2810            12      JR  Z,RLOAD_A2
0004A4 44A4 4D               4      LD  C,L
0004A5 44A5 44               4      LD  B,H
0004A6 44A6 ED5BDAF2        20      LD  DE,(_BUF_ST)
0004AA 44AA 19              11      ADD HL,DE
0004AB 44AB 22DAF2          16      LD  (_BUF_ST),HL
0004AE 44AE 3A5EF5          13      LD  A,(BUF)
0004B1 44B1 B7               4      OR  A
0004B2 44B2 28CF            12      JR  Z,RLOAD_A1
       44B4                     RLOAD_A2:
0004B4 44B4 115EF5          10      LD  DE,BUF
0004B7 44B7 CD4E4B          17      CALL    SPCUTEX
0004BA 44BA 1A               7      LD  A,(DE)
0004BB 44BB B7               4      OR  A
0004BC 44BC 284E            12      JR  Z,RLOAD_AEND
0004BE 44BE CD604B          17      CALL    GETNUM
0004C1 44C1 7C               4      LD  A,H
0004C2 44C2 B5               4      OR  L
0004C3 44C3 CAE345          10      JP  Z,ERROR_DIRECT_IN_FILE
0004C6 44C6 DD2ADCF2        20      LD  IX,(_BUF_EN)
0004CA 44CA DD7502          19      LD  (IX+2),L
0004CD 44CD DD7403          19      LD  (IX+3),H
                                
0004D0 44D0 CD474B          17      CALL    SPCUT
0004D3 44D3 EB               4      EX  DE,HL
0004D4 44D4 DDE5            15      PUSH    IX
0004D6 44D6 DD21B242        14      LD  IX,CRUNCH
0004DA 44DA FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0004DE 44DE CD1C00          17      CALL    _CALSLT
0004E1 44E1 DDE1            14      POP IX
0004E3 44E3 EB               4      EX  DE,HL
0004E4 44E4 111FF4          10      LD  DE,KBUF
0004E7 44E7 37               4      SCF
0004E8 44E8 ED52            15      SBC HL,DE
0004EA 44EA CAE345          10      JP  Z,ERROR_DIRECT_IN_FILE
0004ED 44ED DAE345          10      JP  C,ERROR_DIRECT_IN_FILE
0004F0 44F0 4D               4      LD  C,L
0004F1 44F1 44               4      LD  B,H
0004F2 44F2 2ADCF2          16      LD  HL,(_BUF_EN)
0004F5 44F5 110400          10      LD  DE,4
0004F8 44F8 19              11      ADD HL,DE
0004F9 44F9 111FF4          10      LD  DE,KBUF
                                
0004FC 44FC EB               4      EX  DE,HL
0004FD 44FD EDB0                    LDIR
0004FF 44FF EB               4      EX  DE,HL
                                
000500 4500 DD7500          19      LD  (IX+0),L
000503 4503 DD7401          19      LD  (IX+1),H
000506 4506 22DCF2          16      LD  (_BUF_EN),HL
000509 4509 C38344          10      JP  RLOAD_A1
                                
       450C                     RLOAD_AEND:
00050C 450C 2ADCF2          16      LD  HL,(_BUF_EN)
00050F 450F AF               4      XOR A
000510 4510 77               7      LD  (HL),A
000511 4511 23               6      INC HL
000512 4512 77               7      LD  (HL),A
000513 4513 23               6      INC HL
000514 4514 22DCF2          16      LD  (_BUF_EN),HL
000517 4517 C3A645          10      JP  RLOAD_END1
                                
       451A                     ROM_LOAD:
00051A 451A CD4547          17      CALL    INIT_PARAM
00051D 451D 7E               7      LD  A,(HL)
00051E 451E FE2C             7      CP  ','
000520 4520 2003            12      JR  NZ,ROM_LOAD0
000522 4522 23               6      INC HL
000523 4523 7E               7      LD  A,(HL)
000524 4524 2B               6      DEC HL
       4525                     ROM_LOAD0:
000525 4525 32BEFC          13      LD  (RUNBNF),A
000528 4528 CD384A          17      CALL    FILE_B
00052B 452B 3AF9F2          13      LD  A,(FNAME)
00052E 452E FE20             7      CP  020H
000530 4530 CA334A          10      JP  Z,ROM_ORG
                                
000533 4533 CDB74B          17      CALL    ROM_OPEN
000536 4536 DAEF45          10      JP  C,ERROR_FILE_NOT_FOUND
       4539                     ROM_LOAD1:
000539 4539 21D9F2          10      LD  HL,_BUF
00053C 453C 22D4F2          16      LD  (_DTA),HL
00053F 453F 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
000542 4542 CD9749          17      CALL    ROM_READ
000545 4545 3AD9F2          13      LD  A,(_BUF)
000548 4548 3C               4      INC A
000549 4549 C27144          10      JP  NZ,ROM_LOAD_ASCII
00054C 454C 2A76F6          16      LD  HL,(TXTTAB)
00054F 454F 22D4F2          16      LD  (_DTA),HL
000552 4552 EB               4      EX  DE,HL
000553 4553 2100FF          10      LD  HL,-256
000556 4556 39              11      ADD HL,SP
000557 4557 ED52            15      SBC HL,DE
000559 4559 CD9749          17      CALL    ROM_READ
00055C 455C ED5BD4F2        20      LD  DE,(_DTA)
000560 4560 19              11      ADD HL,DE
000561 4561 E5              11      PUSH    HL
000562 4562 2A76F6          16      LD  HL,(TXTTAB)
       4565                     ROM_LOAD2:          ;リンクポインタをFIX
000565 4565 E5              11      PUSH    HL
000566 4566 DDE1            14      POP IX
000568 4568 7E               7      LD  A,(HL)      ;リンクポインタL
000569 4569 23               6      INC HL
00056A 456A B6               7      OR  (HL)        ;リンクポインタH
00056B 456B 23               6      INC HL
00056C 456C 2837            12      JR  Z,RLOAD_END0
00056E 456E 23               6      INC HL      ;行番号
00056F 456F 23               6      INC HL      ;行番号
       4570                     ROM_LOAD3:
000570 4570 7E               7      LD  A,(HL)
000571 4571 23               6      INC HL
000572 4572 FE0B             7      CP  00BH        ;8進数(&O)
000574 4574 2822            12      JR  Z,INC_HL2
000576 4576 FE0C             7      CP  00CH        ;16進数(&H)
000578 4578 281E            12      JR  Z,INC_HL2
00057A 457A FE0D             7      CP  00DH        ;行番号(RUN後)
00057C 457C 281A            12      JR  Z,INC_HL2
00057E 457E FE0E             7      CP  00EH        ;行番号(RUN前)
000580 4580 2816            12      JR  Z,INC_HL2
000582 4582 FE0F             7      CP  00FH        ;10～255の整数(%)
000584 4584 2813            12      JR  Z,INC_HL1
000586 4586 FE1C             7      CP  01CH        ;256～65535の整数(%)
000588 4588 280E            12      JR  Z,INC_HL2
00058A 458A FE1D             7      CP  01DH        ;単精度実数(!)
00058C 458C 2808            12      JR  Z,INC_HL4
00058E 458E FE1F             7      CP  01FH        ;倍制度実数(#)
000590 4590 2008            12      JR  NZ,INC_HL0
000592 4592 23               6      INC HL
000593 4593 23               6      INC HL
000594 4594 23               6      INC HL
000595 4595 23               6      INC HL
       4596                     INC_HL4:
000596 4596 23               6      INC HL
000597 4597 23               6      INC HL
       4598                     INC_HL2:
000598 4598 23               6      INC HL
       4599                     INC_HL1:
000599 4599 23               6      INC HL
       459A                     INC_HL0:
00059A 459A B7               4      OR  A
00059B 459B 20D3            12      JR  NZ,ROM_LOAD3
00059D 459D DD7500          19      LD  (IX+0),L
0005A0 45A0 DD7401          19      LD  (IX+1),H
0005A3 45A3 18C0            12      JR  ROM_LOAD2
       45A5                     RLOAD_END0:
0005A5 45A5 E1              10      POP HL
       45A6                     RLOAD_END1:
0005A6 45A6 22C2F6          16      LD  (VARTAB),HL
0005A9 45A9 22C4F6          16      LD  (ARYTAB),HL
0005AC 45AC 22C6F6          16      LD  (STREND),HL
                                
0005AF 45AF 3ABEFC          13      LD  A,(RUNBNF)
0005B2 45B2 CDA14B          17      CALL    CAP
0005B5 45B5 FE52             7      CP  'R'
0005B7 45B7 280E            12      JR  Z,RLOAD_END2
0005B9 45B9 AF               4      XOR A
0005BA 45BA 21DCF2          10      LD  HL,_BUF+3
0005BD 45BD 77               7      LD  (HL),A      ;3
0005BE 45BE 2B               6      DEC HL
0005BF 45BF 77               7      LD  (HL),A      ;2
0005C0 45C0 2B               6      DEC HL
0005C1 45C1 77               7      LD  (HL),A      ;1
0005C2 45C2 2B               6      DEC HL
0005C3 45C3 3E8F             7      LD  A,08FH      ;REM
0005C5 45C5 77               7      LD  (HL),A      ;0
0005C6 45C6 C9              10      RET
       45C7                     RLOAD_END2:
0005C7 45C7 D5              11      PUSH    DE
0005C8 45C8 ED5B76F6        20      LD  DE,(TXTTAB)
0005CC 45CC 1B               6      DEC DE
0005CD 45CD AF               4      XOR A
0005CE 45CE 21DFF2          10      LD  HL,_BUF+6
0005D1 45D1 77               7      LD  (HL),A      ;6
0005D2 45D2 2B               6      DEC HL
0005D3 45D3 77               7      LD  (HL),A      ;5
0005D4 45D4 2B               6      DEC HL
0005D5 45D5 77               7      LD  (HL),A      ;4
0005D6 45D6 2B               6      DEC HL
0005D7 45D7 72               7      LD  (HL),D      ;3 行番号H
0005D8 45D8 2B               6      DEC HL
0005D9 45D9 73               7      LD  (HL),E      ;2 行番号L
0005DA 45DA 2B               6      DEC HL
0005DB 45DB 360D            10      LD  (HL),00DH   ;1 行番号(RUN後)
0005DD 45DD 2B               6      DEC HL
0005DE 45DE 3E89             7      LD  A,089H      ;GOTO
0005E0 45E0 77               7      LD  (HL),A      ;0
0005E1 45E1 D1              10      POP DE
0005E2 45E2 C9              10      RET
                                
       45E3                     ERROR_DIRECT_IN_FILE:
0005E3 45E3 1E39             7      LD  E,57            ;Direct statement in file
0005E5 45E5 01                      DB  1           ;LD BC,
       45E6                     ERROR_DEVICE_IO_ERROR:
0005E6 45E6 1E13             7      LD  E,19            ;Device I/O error
0005E8 45E8 01                      DB  1           ;LD BC,
       45E9                     ERROR_INTERNAL_ERROR:
0005E9 45E9 1E33             7      LD  E,51            ;Internal error
0005EB 45EB 01                      DB  1           ;LD BC,
       45EC                     ERROR_FILE_NOT_OPEN:
0005EC 45EC 1E3B             7      LD  E,59            ;File not OPEN
0005EE 45EE 01                      DB  1           ;LD BC,
       45EF                     ERROR_FILE_NOT_FOUND:
0005EF 45EF 1E35             7      LD  E,53            ;File not found
       45F1                     ERROR:
0005F1 45F1 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0005F5 45F5 DD216F40        14      LD  IX,ERRHAND
0005F9 45F9 C31C00          10      JP  _CALSLT
                                
       45FC                     ROM_BLOAD:
0005FC 45FC CD4547          17      CALL    INIT_PARAM
0005FF 45FF CD384A          17      CALL    FILE_B
000602 4602 CDB74B          17      CALL    ROM_OPEN
000605 4605 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000607 4607 21D9F2          10      LD  HL,_BUF
00060A 460A 22D4F2          16      LD  (_DTA),HL
00060D 460D 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
000610 4610 CD9749          17      CALL    ROM_READ
000613 4613 3AD9F2          13      LD  A,(_BUF)
000616 4616 FEFE             7      CP  0FEH
000618 4618 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
00061A 461A 21A5F2          10      LD  HL,BLOAD_RET
00061D 461D 229DF2          16      LD  (SWC_BLOAD),HL
                                
000620 4620 2AF4F2          16      LD  HL,(PARAM1)
000623 4623 7E               7      LD  A,(HL)
000624 4624 FE2C             7      CP  ','
000626 4626 2049            12      JR  NZ,RBREAD_MEM
000628 4628 23               6      INC HL
000629 4629 7E               7      LD  A,(HL)
00062A 462A CDA14B          17      CALL    CAP
00062D 462D 32BEFC          13      LD  (RUNBNF),A
000630 4630 FE52             7      CP  'R'     ;R,Sスイッチじゃ無い場合はオフセット値として処理する
000632 4632 2808            12      JR  Z,RBOS1
000634 4634 FE53             7      CP  'S'
000636 4636 2804            12      JR  Z,RBOS1
000638 4638 FE2C             7      CP  ','
00063A 463A 200D            12      JR  NZ,RBOS2
       463C                     RBOS1:
00063C 463C 7E               7      LD  A,(HL)
00063D 463D 23               6      INC HL
00063E 463E B7               4      OR  A
00063F 463F 2824            12      JR  Z,RBREAD_OSE
000641 4641 FE3A             7      CP  ':'
000643 4643 2820            12      JR  Z,RBREAD_OSE
000645 4645 FE2C             7      CP  ','     ;次のパラメータを探す
000647 4647 20F3            12      JR  NZ,RBOS1
       4649                     RBOS2:              ;オフセット
000649 4649 22F4F2          16      LD  (PARAM1),HL
00064C 464C 7E               7      LD  A,(HL)
00064D 464D B7               4      OR  A
00064E 464E 2815            12      JR  Z,RBREAD_OSE
000650 4650 DD212F54        14      LD  IX,FRMQNT
000654 4654 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000658 4658 CD1C00          17      CALL    _CALSLT
00065B 465B 22F4F2          16      LD  (PARAM1),HL
00065E 465E 2ADAF2          16      LD  HL,(_BUF_ST)
000661 4661 19              11      ADD HL,DE
000662 4662 22DAF2          16      LD  (_BUF_ST),HL
       4665                     RBREAD_OSE:
000665 4665 3ABEFC          13      LD  A,(RUNBNF)
000668 4668 FE53             7      CP  'S'
00066A 466A 2005            12      JR  NZ,RBREAD_MEM
00066C 466C 3E01             7      LD  A,1
00066E 466E 32D6F2          13      LD  (FLG_LDIR),A
       4671                     RBREAD_MEM:
000671 4671 2ADAF2          16      LD  HL,(_BUF_ST)
000674 4674 22BFFC          16      LD  (SAVENT),HL
000677 4677 22D4F2          16      LD  (_DTA),HL
00067A 467A 21FFFF          10      LD  HL,0FFFFH
00067D 467D CD9749          17      CALL    ROM_READ
000680 4680 AF               4      XOR A
000681 4681 32D6F2          13      LD  (FLG_LDIR),A
000684 4684 3ABEFC          13      LD  A,(RUNBNF)
000687 4687 FE52             7      CP  'R'
000689 4689 2006            12      JR  NZ,RBREAD1
00068B 468B 2ADEF2          16      LD  HL,(_BUF_EX)
00068E 468E 229DF2          16      LD  (SWC_BLOAD),HL
       4691                     RBREAD1:
       4691                     ROM_NEXT:
000691 4691 2AF4F2          16      LD  HL,(PARAM1)
000694 4694 7E               7      LD  A,(HL)
000695 4695 2B               6      DEC HL
000696 4696 B7               4      OR  A
000697 4697 2805            12      JR  Z,ROM_NEXT1
000699 4699 FE3A             7      CP  ':'
00069B 469B 2801            12      JR  Z,ROM_NEXT1
00069D 469D 23               6      INC HL
       469E                     ROM_NEXT1:
00069E 469E 5D               4      LD  E,L
00069F 469F 54               4      LD  D,H
                                
0006A0 46A0 CD774B          17      CALL    SEARCH_END
0006A3 46A3 B7               4      OR  A
0006A4 46A4 2821            12      JR  Z,REM
       46A6                     RN3:                    ;マルチステートメントの処理
0006A6 46A6 7E               7      LD  A,(HL)
                                
0006A7 46A7 FEB5             7      CP  0B5H            ;LOAD
0006A9 46A9 CA1A45          10      JP  Z,ROM_LOAD
0006AC 46AC FE8A             7      CP  08AH            ;RUN
0006AE 46AE 281B            12      JR  Z,ROM_RUN
0006B0 46B0 FEB7             7      CP  0B7H            ;FILES
0006B2 46B2 2825            12      JR  Z,ROM_FILES
0006B4 46B4 FED6             7      CP  0D6H            ;COPY
0006B6 46B6 CA7747          10      JP  Z,ROM_COPY
0006B9 46B9 FE20             7      CP  020H
0006BB 46BB 2807            12      JR  Z,RN_SP
                                
0006BD 46BD 3E28             7      LD  A,028H          ;JR Z,
0006BF 46BF 32A3F2          13      LD  (SWC_BLOAD_M),A
0006C2 46C2 7E               7      LD  A,(HL)
0006C3 46C3 C9              10      RET
       46C4                     RN_SP:
0006C4 46C4 23               6      INC HL
0006C5 46C5 18DF            12      JR  RN3
                                
       46C7                     REM:
0006C7 46C7 EB               4      EX  DE,HL
0006C8 46C8 3E8F             7      LD  A,08FH          ;REM
0006CA 46CA C9              10      RET
                                
       46CB                     ROM_RUN:
0006CB 46CB 23               6      INC HL
0006CC 46CC 7E               7      LD  A,(HL)
0006CD 46CD 2B               6      DEC HL
0006CE 46CE B7               4      OR  A
0006CF 46CF C41A45          17      CALL    NZ,ROM_LOAD
0006D2 46D2 FE8F             7      CP  08FH            ;REM
0006D4 46D4 3E8A             7      LD  A,08AH          ;RUN
0006D6 46D6 C0              11      RET NZ
0006D7 46D7 77               7      LD  (HL),A
0006D8 46D8 C9              10      RET
                                
       46D9                     ROM_FILES:
0006D9 46D9 CD4547          17      CALL    INIT_PARAM
0006DC 46DC CD384A          17      CALL    FILE_B
0006DF 46DF CD9952          17      CALL    GET_DISK_BANK_FDRV
0006E2 46E2 3AC9F2          13      LD  A,(SECSZ_H)
0006E5 46E5 CD5751          17      CALL    IS_BPB1
0006E8 46E8 DAE645          10      JP  C,ERROR_DEVICE_IO_ERROR
0006EB 46EB 3AF9F2          13      LD  A,(FNAME)
0006EE 46EE FE21             7      CP  021H
0006F0 46F0 3005            12      JR  NC,RFILES0
0006F2 46F2 060B             7      LD  B,11
0006F4 46F4 CD0B4B          17      CALL    FILE10
       46F7                     RFILES0:
0006F7 46F7 CD154E          17      CALL    GET_DIR_DAT
       46FA                     RFILES1:
0006FA 46FA CDD34B          17      CALL    FILESE
0006FD 46FD 3041            12      JR  NC,RFILES_NOT_MATCH
       46FF                     RFILES_DISP:
0006FF 46FF E5              11      PUSH    HL
000700 4700 110B00          10      LD  DE,0000BH   ;属性
000703 4703 19              11      ADD HL,DE
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000704 4704 7E               7      LD  A,(HL)
                                #endif
000705 4705 E1              10      POP HL
000706 4706 CB4F             8      BIT 1,A     ;不可視属性
000708 4708 2033            12      JR  NZ,RFILES_NEXT
00070A 470A E5              11      PUSH    HL
00070B 470B 0608             7      LD  B,8
00070D 470D CD8A43          17      CALL    MSN
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000710 4710 7E               7      LD  A,(HL)
                                #endif
000711 4711 FE20             7      CP  020H
000713 4713 F5              11      PUSH    AF
000714 4714 3E2E             7      LD  A,'.'
000716 4716 C41253          17      CALL    NZ,MSG_A
000719 4719 0603             7      LD  B,3
00071B 471B CD8A43          17      CALL    MSN
00071E 471E F1              10      POP AF
00071F 471F CC1253          17      CALL    Z,MSG_A
000722 4722 3ADDF3          13      LD  A,(CSRX)
000725 4725 47               4      LD  B,A
000726 4726 3AB0F3          13      LD  A,(LINLEN)
000729 4729 90               4      SUB B
00072A 472A FE0C             7      CP  12
00072C 472C 3009            12      JR  NC,RFILES2
00072E 472E 3E0D             7      LD  A,00DH      ;改行
000730 4730 CD1253          17      CALL    MSG_A
000733 4733 3E0A             7      LD  A,00AH
000735 4735 1802            12      JR  RFILES3
       4737                     RFILES2:
000737 4737 3E20             7      LD  A,020H
       4739                     RFILES3:
000739 4739 CD1253          17      CALL    MSG_A
00073C 473C E1              10      POP HL
       473D                     RFILES_NEXT:
00073D 473D CDEF4B          17      CALL    FNEXT
       4740                     RFILES_NOT_MATCH:
000740 4740 20B8            12      JR  NZ,RFILES1
000742 4742 C39146          10      JP  ROM_NEXT
                                
       4745                     INIT_PARAM:
000745 4745 22F2F2          16      LD  (PARAM0),HL
000748 4748 22F4F2          16      LD  (PARAM1),HL
00074B 474B EB               4      EX  DE,HL
00074C 474C 32BEFC          13      LD  (RUNBNF),A
00074F 474F 3263F6          13      LD  (VALTYP),A
000752 4752 E5              11      PUSH    HL
000753 4753 2AEBF2          16      LD  HL,(_CD)
000756 4756 22F6F2          16      LD  (_CDX),HL
000759 4759 E1              10      POP HL
00075A 475A 13               6      INC DE
00075B 475B CD474B          17      CALL    SPCUT
00075E 475E 1A               7      LD  A,(DE)
00075F 475F B7               4      OR  A
000760 4760 C8              11      RET Z
000761 4761 FE3A             7      CP  ':'
000763 4763 C8              11      RET Z
000764 4764 FE28             7      CP  '('
000766 4766 C8              11      RET Z
000767 4767 EB               4      EX  DE,HL
000768 4768 DD21644C        14      LD  IX,FRMEVL
00076C 476C FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000770 4770 CD1C00          17      CALL    _CALSLT
000773 4773 22F4F2          16      LD  (PARAM1),HL
000776 4776 C9              10      RET
                                
       4777                     ROM_COPY:
000777 4777 CD4547          17      CALL    INIT_PARAM
00077A 477A 3A63F6          13      LD  A,(VALTYP)
00077D 477D FE03             7      CP  3       ;string
00077F 477F C2334A          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
000782 4782 CD384A          17      CALL    FILE_B
000785 4785 CDB74B          17      CALL    ROM_OPEN
000788 4788 DAEF45          10      JP  C,ERROR_FILE_NOT_FOUND
                                
00078B 478B 21DEF2          10      LD  HL,_BUF_W
00078E 478E 22D4F2          16      LD  (_DTA),HL
000791 4791 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
000794 4794 CD9749          17      CALL    ROM_READ
                                
000797 4797 AF               4      XOR A
000798 4798 32D9F2          13      LD  (_BUF_LO),A     ;PSET
00079B 479B 32E6F2          13      LD  (_BUF_O),A      ;向き
                                
00079E 479E 2AF4F2          16      LD  HL,(PARAM1)
       47A1                     RCP_PARAM1:
0007A1 47A1 7E               7      LD  A,(HL)
0007A2 47A2 23               6      INC HL
0007A3 47A3 B7               4      OR  A
0007A4 47A4 CA9E46          10      JP  Z,ROM_NEXT1
0007A7 47A7 FE3A             7      CP  ':'
0007A9 47A9 CA9E46          10      JP  Z,ROM_NEXT1
0007AC 47AC FE2C             7      CP  ','
0007AE 47AE 2012            12      JR  NZ,RCP_PARAM1_
                                
0007B0 47B0 DD212F54        14      LD  IX,FRMQNT
0007B4 47B4 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007B8 47B8 CD1C00          17      CALL    _CALSLT
0007BB 47BB 7B               4      LD  A,E
0007BC 47BC 87               4      ADD A,A
0007BD 47BD 87               4      ADD A,A
0007BE 47BE 32E6F2          13      LD  (_BUF_O),A
0007C1 47C1 7E               7      LD  A,(HL)
       47C2                     RCP_PARAM1_:
0007C2 47C2 FE28             7      CP  '('
0007C4 47C4 20DB            12      JR  NZ,RCP_PARAM1
0007C6 47C6 DD212F54        14      LD  IX,FRMQNT
0007CA 47CA FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007CE 47CE CD1C00          17      CALL    _CALSLT
                                
0007D1 47D1 ED53E2F2        20      LD  (_BUF_X),DE
                                
       47D5                     RCP_PARAM2:
0007D5 47D5 23               6      INC HL
0007D6 47D6 7E               7      LD  A,(HL)
0007D7 47D7 FE20             7      CP  020H
0007D9 47D9 28FA            12      JR  Z,RCP_PARAM2
0007DB 47DB FE2C             7      CP  ','
0007DD 47DD 28F6            12      JR  Z,RCP_PARAM2
                                
0007DF 47DF DD212F54        14      LD  IX,FRMQNT
0007E3 47E3 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007E7 47E7 CD1C00          17      CALL    _CALSLT
                                
0007EA 47EA 3AF6FA          13      LD  A,(ACPAGE)
0007ED 47ED 57               4      LD  D,A
0007EE 47EE ED53E4F2        20      LD  (_BUF_Y),DE
       47F2                     RCP_PARAM3:
0007F2 47F2 23               6      INC HL
0007F3 47F3 7E               7      LD  A,(HL)
0007F4 47F4 FE20             7      CP  020H
0007F6 47F6 28FA            12      JR  Z,RCP_PARAM3
0007F8 47F8 FE29             7      CP  ')'
0007FA 47FA 28F6            12      JR  Z,RCP_PARAM3
0007FC 47FC FE2C             7      CP  ','
0007FE 47FE 2033            12      JR  NZ,RCP_ST
                                
000800 4800 23               6      INC HL
000801 4801 DD212F54        14      LD  IX,FRMQNT
000805 4805 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000809 4809 CD1C00          17      CALL    _CALSLT
                                
00080C 480C 7B               4      LD  A,E
00080D 480D 32E5F2          13      LD  (_BUF_P),A
                                
       4810                     RCP_PARAM4:
000810 4810 7E               7      LD  A,(HL)
000811 4811 23               6      INC HL
000812 4812 FE20             7      CP  020H
000814 4814 28FA            12      JR  Z,RCP_PARAM4
                                
000816 4816 FE2C             7      CP  ','
000818 4818 2019            12      JR  NZ,RCP_ST
                                
00081A 481A 7E               7      LD  A,(HL)
00081B 481B 0604             7      LD  B,4
00081D 481D FEC3             7      CP  0C3H        ;PRESET
00081F 481F 280E            12      JR  Z,RCP_LO
000821 4821 05               4      DEC B       ;3
000822 4822 D6F8             7      SUB 0F8H        ;XOR
000824 4824 2809            12      JR  Z,RCP_LO
000826 4826 05               4      DEC B       ;2
000827 4827 3C               4      INC A       ;OR
000828 4828 2805            12      JR  Z,RCP_LO
00082A 482A 05               4      DEC B       ;1
00082B 482B 3C               4      INC A       ;AND
00082C 482C 2801            12      JR  Z,RCP_LO
00082E 482E 05               4      DEC B       ;0
                                                ;PSET
       482F                     RCP_LO:
00082F 482F 78               4      LD  A,B
000830 4830 32D9F2          13      LD  (_BUF_LO),A
       4833                     RCP_ST:
000833 4833 2AC6F6          16      LD  HL,(STREND)
000836 4836 22D4F2          16      LD  (_DTA),HL
000839 4839 EB               4      EX  DE,HL
00083A 483A 2100FE          10      LD  HL,-512
00083D 483D 39              11      ADD HL,SP
00083E 483E AF               4      XOR A
00083F 483F ED52            15      SBC HL,DE
000841 4841 3008            12      JR  NC,RCP0
000843 4843 215EF5          10      LD  HL,BUF
000846 4846 22D4F2          16      LD  (_DTA),HL
000849 4849 6F               4      LD  L,A ;0
00084A 484A 67               4      LD  H,A ;0
       484B                     RCP0:
00084B 484B 24               4      INC H
00084C 484C 22DCF2          16      LD  (_BUF_EN),HL
       484F                     RCP1:
00084F 484F F3               4      DI
000850 4850 CD2549          17      CALL    WAIT_VDP
                                
000853 4853 3A0700          13      LD  A,(WRVDP)
000856 4856 4F               4      LD  C,A
000857 4857 0C               4      INC C       ;C := PORT#1's address(WR)
000858 4858 3E24             7      LD  A,36
00085A 485A ED79            12      OUT (C),A
00085C 485C 3E91             7      LD  A,080H+17
00085E 485E ED79            12      OUT (C),A       ;R#17 := 36
                                
000860 4860 0C               4      INC C
000861 4861 0C               4      INC C       ;C := PORT#3's address(WR)
000862 4862 2AE2F2          16      LD  HL,(_BUF_X)
000865 4865 ED69            12      OUT (C),L       ;R#36 DX
000867 4867 ED61            12      OUT (C),H       ;R#37
000869 4869 2AE4F2          16      LD  HL,(_BUF_Y)
00086C 486C ED69            12      OUT (C),L       ;R#38 DY
00086E 486E ED61            12      OUT (C),H       ;R#39
000870 4870 2ADEF2          16      LD  HL,(_BUF_W)
000873 4873 ED69            12      OUT (C),L       ;R#40 NX
000875 4875 ED61            12      OUT (C),H       ;R#41
000877 4877 2AE0F2          16      LD  HL,(_BUF_H)
00087A 487A ED69            12      OUT (C),L       ;R#42 NY
00087C 487C ED61            12      OUT (C),H       ;R#43
                                
00087E 487E DD2AAFFC        20      LD  IX,(SCRMOD)
000882 4882 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000885 4885 B7               4      OR  A
000886 4886 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000888 4888 DD7D             9      LD  A,IXL
00088A 488A FE08             7      CP  8
00088C 488C 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
00088E 488E FE06             7      CP  6
000890 4890 2AE2F2          16      LD  HL,(_BUF_X)
000893 4893 3ADEF2          13      LD  A,(_BUF_W)
000896 4896 2005            12      JR  NZ,SCR57
000898 4898 B5               4      OR  L       ;スクリーン6
000899 4899 E603             7      AND 3
00089B 489B 200D            12      JR  NZ,USE_LMMC
       489D                     SCR57:              ;スクリーン5,7
00089D 489D B5               4      OR  L
00089E 489E E601             7      AND 1
0008A0 48A0 2008            12      JR  NZ,USE_LMMC
       48A2                     USE_HMMC:
0008A2 48A2 DD2E08          10      LD  IXL,8
       48A5                     USE_HMMC8:
0008A5 48A5 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
0008A7 48A7 32D9F2          13      LD  (_BUF_LO),A
       48AA                     USE_LMMC:
0008AA 48AA 110000          10      LD  DE,0
0008AD 48AD 06FF             7      LD  B,-1
0008AF 48AF CD5049          17      CALL    GET_PIXEL
0008B2 48B2 ED79            12      OUT (C),A       ;R#44 first DATA
0008B4 48B4 3AE6F2          13      LD  A,(_BUF_O)
0008B7 48B7 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
0008B9 48B9 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0008BC 48BC F6B0             7      OR  0B0H        ;R#46 LMMC command
0008BE 48BE ED79            12      OUT (C),A
                                
0008C0 48C0 FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
0008C2 48C2 0D               4      DEC C
0008C3 48C3 0D               4      DEC C       ;C := PORT#1's address(WR)
0008C4 48C4 3EAC             7      LD  A,080H+44
0008C6 48C6 ED79            12      OUT (C),A
0008C8 48C8 3E91             7      LD  A,080H+17
0008CA 48CA ED79            12      OUT (C),A       ;R#17 := 44
                                
0008CC 48CC 3A0600          13      LD  A,(RDVDP)
0008CF 48CF 3C               4      INC A
0008D0 48D0 FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
0008D2 48D2 3E02             7      LD  A,2
0008D4 48D4 ED79            12      OUT (C),A
0008D6 48D6 3E8F             7      LD  A,08FH
0008D8 48D8 ED79            12      OUT (C),A
0008DA 48DA 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0008DD 48DD E640             7      AND 040H
0008DF 48DF 201C            12      JR  NZ,LOOP_HMMC
       48E1                     LOOP_COPY:
0008E1 48E1 CD5049          17      CALL    GET_PIXEL
0008E4 48E4 08               4      EX  AF,AF'
0008E5 48E5 FD4C             9      LD  C,IYH
       48E7                     LOOP_COPY1:
0008E7 48E7 ED78            12      IN  A,(C)
0008E9 48E9 0F               4      RRCA            ;RRCAではサインフラグは変化しない
0008EA 48EA 300A            12      JR  NC,EXIT_COPY    ;check CE bit
0008EC 48EC F2E748          10      JP  P,LOOP_COPY1    ;check TR bit
0008EF 48EF 08               4      EX  AF,AF'
0008F0 48F0 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
0008F2 48F2 ED79            12      OUT (C),A
0008F4 48F4 18EB            12      JR  LOOP_COPY
                                
       48F6                     EXIT_COPY:
0008F6 48F6 CD2D49          17      CALL    GET_STATUS_0
0008F9 48F9 FB               4      EI
0008FA 48FA C39146          10      JP  ROM_NEXT
                                
       48FD                     LOOP_HMMC:
0008FD 48FD F3               4      DI          ;必要
0008FE 48FE FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000900 4900 43               4      LD  B,E
000901 4901 7B               4      LD  A,E
000902 4902 B7               4      OR  A
000903 4903 2802            12      JR  Z,LOOP_HMMC1
000905 4905 EDB3                    OTIR
       4907                     LOOP_HMMC1:
000907 4907 14               4      INC D
       4908                     LOOP_HMMC2:
000908 4908 15               4      DEC D
000909 4909 2805            12      JR  Z,LOOP_HMMC3
00090B 490B EDB3                    OTIR
00090D 490D C30849          10      JP  LOOP_HMMC2
       4910                     LOOP_HMMC3:
000910 4910 ED78            12      IN  A,(C)
000912 4912 0F               4      RRCA
000913 4913 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
000915 4915 2ADCF2          16      LD  HL,(_BUF_EN)
000918 4918 CD9749          17      CALL    ROM_READ
00091B 491B EB               4      EX  DE,HL
00091C 491C 2AD4F2          16      LD  HL,(_DTA)
00091F 491F 7A               4      LD  A,D
000920 4920 B3               4      OR  E
000921 4921 20DA            12      JR  NZ,LOOP_HMMC
000923 4923 18C2            12      JR  LOOP_COPY1
                                    
       4925                     WAIT_VDP:
000925 4925 3E02             7      LD  A,2
000927 4927 CD2E49          17      CALL    GET_STATUS
00092A 492A 0F               4      RRCA
00092B 492B 38F8            12      JR  C,WAIT_VDP
       492D                     GET_STATUS_0:
00092D 492D AF               4      XOR A
       492E                     GET_STATUS:
00092E 492E C5              11      PUSH    BC
00092F 492F ED4B0600        20      LD  BC,(RDVDP)
000933 4933 0C               4      INC C
000934 4934 ED79            12      OUT (C),A
000936 4936 3E8F             7      LD  A,08FH
000938 4938 ED79            12      OUT (C),A
00093A 493A ED78            12      IN  A,(C)
00093C 493C C1              10      POP BC
00093D 493D C9              10      RET
                                
       493E                     GET_PIXEL256:
00093E 493E 7A               4      LD  A,D
00093F 493F B3               4      OR  E
000940 4940 200A            12      JR  NZ,GET_PIXEL1
000942 4942 2ADCF2          16      LD  HL,(_BUF_EN)
000945 4945 CD9749          17      CALL    ROM_READ
000948 4948 EB               4      EX  DE,HL
000949 4949 2AD4F2          16      LD  HL,(_DTA)
       494C                     GET_PIXEL1:
00094C 494C 7E               7      LD  A,(HL)
00094D 494D 23               6      INC HL
00094E 494E 1B               6      DEC DE
00094F 494F C9              10      RET
                                
       4950                     GET_PIXEL:
000950 4950 DD7D             9      LD  A,IXL
000952 4952 FE08             7      CP  8
000954 4954 28E8            12      JR  Z,GET_PIXEL256
000956 4956 04               4      INC B
000957 4957 FE06             7      CP  6
000959 4959 282E            12      JR  Z,GET_PIXEL4
                                
00095B 495B CB40             8      BIT 0,B
00095D 495D 20ED            12      JR  NZ,GET_PIXEL1
                                
00095F 495F 7A               4      LD  A,D
000960 4960 B3               4      OR  E
000961 4961 200A            12      JR  NZ,GET_PIXEL2
                                
000963 4963 2ADCF2          16      LD  HL,(_BUF_EN)
000966 4966 CD9749          17      CALL    ROM_READ
000969 4969 EB               4      EX  DE,HL
00096A 496A 2AD4F2          16      LD  HL,(_DTA)
                                
       496D                     GET_PIXEL2:
00096D 496D 7E               7      LD  A,(HL)
00096E 496E 0F               4      RRCA
00096F 496F 0F               4      RRCA
000970 4970 0F               4      RRCA
000971 4971 0F               4      RRCA
000972 4972 C9              10      RET
                                
       4973                     GET_PIXEL3:
000973 4973 7A               4      LD  A,D
000974 4974 B3               4      OR  E
000975 4975 200A            12      JR  NZ,GET_PIXEL5
                                
000977 4977 2ADCF2          16      LD  HL,(_BUF_EN)
00097A 497A CD9749          17      CALL    ROM_READ
00097D 497D EB               4      EX  DE,HL
00097E 497E 2AD4F2          16      LD  HL,(_DTA)
       4981                     GET_PIXEL5:
000981 4981 7E               7      LD  A,(HL)
000982 4982 0F               4      RRCA
000983 4983 0F               4      RRCA
000984 4984 0F               4      RRCA
000985 4985 0F               4      RRCA
000986 4986 0F               4      RRCA
000987 4987 0F               4      RRCA
000988 4988 C9              10      RET
                                
       4989                     GET_PIXEL4:
000989 4989 78               4      LD  A,B
00098A 498A E603             7      AND 3   ;+0
00098C 498C 28E5            12      JR  Z,GET_PIXEL3
00098E 498E 3D               4      DEC A   ;+1
00098F 498F 28DC            12      JR  Z,GET_PIXEL2
000991 4991 3D               4      DEC A   ;+2
000992 4992 7E               7      LD  A,(HL)
000993 4993 C0              11      RET NZ
000994 4994 0F               4      RRCA        ;+3
000995 4995 0F               4      RRCA
000996 4996 C9              10      RET
                                
       4997                     ROM_READ:
000997 4997 E5              11      PUSH    HL
000998 4998 D5              11      PUSH    DE
000999 4999 C5              11      PUSH    BC
00099A 499A FDE5            15      PUSH    IY
00099C 499C 22F0F2          16      LD  (LEFTX),HL
00099F 499F 2AD4F2          16      LD  HL,(_DTA)
0009A2 49A2 22E7F2          16      LD  (DTAX),HL
0009A5 49A5 2AF0F2          16      LD  HL,(LEFTX)
                                
0009A8 49A8 CD494C          17      CALL    RBX1
0009AB 49AB 3870            12      JR  C,RBRERR1
0009AD 49AD 79               4      LD  A,C
0009AE 49AE EB               4      EX  DE,HL
0009AF 49AF ED52            15      SBC HL,DE       ;CP 0HL,CDE
0009B1 49B1 19              11      ADD HL,DE
0009B2 49B2 DE00             7      SBC A,000H
0009B4 49B4 3801            12      JR  C,RBR1
0009B6 49B6 EB               4      EX  DE,HL
       49B7                     RBR1:
0009B7 49B7 9F               4      SBC A,A
0009B8 49B8 E601             7      AND 1
0009BA 49BA 32C3F2          13      LD  (_RESULT),A
0009BD 49BD 7C               4      LD  A,H
0009BE 49BE B5               4      OR  L
0009BF 49BF CA134A          10      JP  Z,RBREND0
                                
0009C2 49C2 22D0F2          16      LD  (_LEFT),HL  ;Read record byte
0009C5 49C5 22F0F2          16      LD  (LEFTX),HL
                                
0009C8 49C8 CD754C          17      CALL    RBX2
0009CB 49CB 281A            12      JR  Z,RBRB
                                                ;先頭の端数
0009CD 49CD CD884C          17      CALL    RBXA
0009D0 49D0 DA294A          10      JP  C,RBRERR
0009D3 49D3 C5              11      PUSH    BC
0009D4 49D4 CD1044          17      CALL    ROM_LDIR
0009D7 49D7 ED53E7F2        20      LD  (DTAX),DE
0009DB 49DB 2AF0F2          16      LD  HL,(LEFTX)
0009DE 49DE D1              10      POP DE
0009DF 49DF A7               4      AND A
0009E0 49E0 ED52            15      SBC HL,DE
0009E2 49E2 22F0F2          16      LD  (LEFTX),HL
0009E5 49E5 2829            12      JR  Z,RBREND
                                
       49E7                     RBRB:
0009E7 49E7 CDC44C          17      CALL    RBXB
0009EA 49EA 2818            12      JR  Z,RBRC
       49EC                     RBRB1:
0009EC 49EC C5              11      PUSH    BC
0009ED 49ED D5              11      PUSH    DE
0009EE 49EE CD6F4D          17      CALL    CLUST
0009F1 49F1 EB               4      EX  DE,HL
0009F2 49F2 ED4BC6F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
0009F6 49F6 CD1044          17      CALL    ROM_LDIR
0009F9 49F9 EB               4      EX  DE,HL
0009FA 49FA D1              10      POP DE
0009FB 49FB C1              10      POP BC
0009FC 49FC CD4C4D          17      CALL    GNCL
0009FF 49FF DA294A          10      JP  C,RBRERR
000A02 4A02 10E8            13      DJNZ    RBRB1
       4A04                     RBRC:
000A04 4A04 CDDC4C          17      CALL    RBXC
000A07 4A07 2807            12      JR  Z,RBREND
                                
000A09 4A09 CD6F4D          17      CALL    CLUST
000A0C 4A0C EB               4      EX  DE,HL
000A0D 4A0D CD1044          17      CALL    ROM_LDIR
       4A10                     RBREND:
000A10 4A10 CDE84C          17      CALL    RBXEND
       4A13                     RBREND0:
000A13 4A13 FDE1            14      POP IY
000A15 4A15 C1              10      POP BC
000A16 4A16 D1              10      POP DE
000A17 4A17 F1              10      POP AF  ;(HL)
000A18 4A18 AF               4      XOR A
000A19 4A19 3AC3F2          13      LD  A,(_RESULT)
000A1C 4A1C C9              10      RET
                                
       4A1D                     RBRERR1:
000A1D 4A1D 3E01             7      LD  A,001H
       4A1F                     RBRERR2:
000A1F 4A1F FDE1            14      POP IY
000A21 4A21 C1              10      POP BC
000A22 4A22 D1              10      POP DE
000A23 4A23 E1              10      POP HL
000A24 4A24 37               4      SCF
000A25 4A25 210000          10      LD  HL,0
000A28 4A28 C9              10      RET
       4A29                     RBRERR:
000A29 4A29 3EFF             7      LD  A,0FFH
000A2B 4A2B 18F2            12      JR  RBRERR2
                                
       4A2D                     FILE_DD:
000A2D 4A2D E1              10      POP HL
000A2E 4A2E 3E                      DB  03EH
000A2F 4A2F C9              10      RET
000A30 4A30 32A3F2          13      LD  (SWC_BLOAD_M),A
       4A33                     ROM_ORG:
000A33 4A33 2AF2F2          16      LD  HL,(PARAM0)
000A36 4A36 7E               7      LD  A,(HL)
000A37 4A37 C9              10      RET
       4A38                     FILE_B:
000A38 4A38 AF               4      XOR A
000A39 4A39 32F8F2          13      LD  (FDRV),A
000A3C 4A3C 1E00             7      LD  E,0
000A3E 4A3E 3A63F6          13      LD  A,(VALTYP)
000A41 4A41 FE03             7      CP  3       ;string
000A43 4A43 C2C84A          10      JP  NZ,FILED
                                
000A46 4A46 DD21D067        14      LD  IX,FRESTR
000A4A 4A4A FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000A4E 4A4E CD1C00          17      CALL    _CALSLT
000A51 4A51 E5              11      PUSH    HL
000A52 4A52 DDE1            14      POP IX
                                
000A54 4A54 DD5E00          19      LD  E,(IX+0)
000A57 4A57 DD7E01          19      LD  A,(IX+1)
000A5A 4A5A DD5602          19      LD  D,(IX+2)
000A5D 4A5D DD62             9      LD  IXH,D
000A5F 4A5F DD6F             9      LD  IXL,A
000A61 4A61 7B               4      LD  A,E
       4A62                     FILE_BDOS:
000A62 4A62 FE04             7      CP  4
000A64 4A64 3808            12      JR  C,FILEB1
000A66 4A66 DD7E03          19      LD  A,(IX+3)
000A69 4A69 FE3A             7      CP  ':'
000A6B 4A6B 28C0            12      JR  Z,FILE_DD
000A6D 4A6D 7B               4      LD  A,E
       4A6E                     FILEB1:
000A6E 4A6E FE02             7      CP  2
000A70 4A70 3818            12      JR  C,DEVI1
000A72 4A72 DD7E01          19      LD  A,(IX+1)
000A75 4A75 FE3A             7      CP  ':'
000A77 4A77 2011            12      JR  NZ,DEVI1
000A79 4A79 DD7E00          19      LD  A,(IX+0)        ;DRIVE
000A7C 4A7C CDA14B          17      CALL    CAP
000A7F 4A7F D640             7      SUB '@'
000A81 4A81 DD23            10      INC IX
000A83 4A83 DD23            10      INC IX
000A85 4A85 1D               4      DEC E
000A86 4A86 1D               4      DEC E
000A87 4A87 32F8F2          13      LD  (FDRV),A
       4A8A                     DEVI1:
000A8A 4A8A DD7E00          19      LD  A,(IX+0)
000A8D 4A8D D65C             7      SUB 05CH        ;\
000A8F 4A8F 2008            12      JR  NZ,NOROOT
000A91 4A91 6F               4      LD  L,A
000A92 4A92 67               4      LD  H,A
000A93 4A93 22F6F2          16      LD  (_CDX),HL
000A96 4A96 DD23            10      INC IX
000A98 4A98 1D               4      DEC E
       4A99                     NOROOT:
                                
       4A99                     SETDIR:
000A99 4A99 CDC84A          17      CALL    FILED
000A9C 4A9C DD7E00          19      LD  A,(IX+0)
000A9F 4A9F FE5C             7      CP  05CH        ;\
000AA1 4AA1 C0              11      RET NZ
000AA2 4AA2 DD23            10      INC IX
000AA4 4AA4 1D               4      DEC E
000AA5 4AA5 3AF9F2          13      LD  A,(FNAME)
000AA8 4AA8 FE20             7      CP  020H        ;. の処理
000AAA 4AAA 28ED            12      JR  Z,SETDIR
                                
000AAC 4AAC CDB74B          17      CALL    ROM_OPEN
000AAF 4AAF B7               4      OR  A
000AB0 4AB0 C0              11      RET NZ
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                #else
000AB1 4AB1 FD2AEDF2        20      LD  IY,(DIRENT1)
000AB5 4AB5 FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000AB9 4AB9 C8              11      RET Z
000ABA 4ABA CD0F4B          17      CALL    FILEI
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
000ABD 4ABD FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000AC0 4AC0 FD661B          19      LD  H,(IY+01BH)
                                #endif
000AC3 4AC3 22F6F2          16      LD  (_CDX),HL
000AC6 4AC6 18D1            12      JR  SETDIR
                                
       4AC8                     FILED:
000AC8 4AC8 CD0F4B          17      CALL    FILEI
000ACB 4ACB 21F9F2          10      LD  HL,FNAME
                                
000ACE 4ACE 0608             7      LD  B,8
       4AD0                     FILE2:
000AD0 4AD0 CD1C4B          17      CALL    CCHKF
000AD3 4AD3 C8              11      RET Z
000AD4 4AD4 FE2A             7      CP  '*'
000AD6 4AD6 282E            12      JR  Z,FILE9
000AD8 4AD8 FE2E             7      CP  '.'
000ADA 4ADA 280C            12      JR  Z,FILE4
000ADC 4ADC 77               7      LD  (HL),A
000ADD 4ADD 23               6      INC HL
000ADE 4ADE 10F0            13      DJNZ    FILE2
                                
       4AE0                     FILE3:
000AE0 4AE0 CD1C4B          17      CALL    CCHKF
000AE3 4AE3 C8              11      RET Z
000AE4 4AE4 FE2E             7      CP  '.'
000AE6 4AE6 20F8            12      JR  NZ,FILE3
                                
       4AE8                     FILE4:
000AE8 4AE8 2101F3          10      LD  HL,FNAME+8
000AEB 4AEB 0603             7      LD  B,3
                                
       4AED                     FILE4L:
000AED 4AED CD1C4B          17      CALL    CCHKF
000AF0 4AF0 C8              11      RET Z
000AF1 4AF1 FE2E             7      CP  '.'
000AF3 4AF3 2008            12      JR  NZ,FILE12
000AF5 4AF5 32F9F2          13      LD  (FNAME),A   ;Parent directory(..)
000AF8 4AF8 32FAF2          13      LD  (FNAME+1),A
000AFB 4AFB 3E20             7      LD  A,020H
       4AFD                     FILE12:
000AFD 4AFD FE2A             7      CP  '*'
000AFF 4AFF 280A            12      JR  Z,FILE10
000B01 4B01 77               7      LD  (HL),A
000B02 4B02 23               6      INC HL
000B03 4B03 10E8            13      DJNZ    FILE4L
000B05 4B05 C9              10      RET
                                
       4B06                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000B06 4B06 CD0B4B          17      CALL    FILE10
000B09 4B09 18D5            12      JR  FILE3
                                
       4B0B                     FILE10:
000B0B 4B0B 3E3F             7      LD  A,'?'
000B0D 4B0D 1808            12      JR  FILL_MEMORY
       4B0F                     FILEI:              ;名前＋拡張子をスペースで初期化
000B0F 4B0F 3E20             7      LD  A,020H
000B11 4B11 01000B          10      LD  BC,11*256   ;C=0にしておく
000B14 4B14 21F9F2          10      LD  HL,FNAME
       4B17                     FILL_MEMORY:            ;HLからBバイトAで埋める
000B17 4B17 77               7      LD  (HL),A
000B18 4B18 23               6      INC HL
000B19 4B19 10FC            13      DJNZ    FILL_MEMORY
000B1B 4B1B C9              10      RET
                                
       4B1C                     CCHKF:
000B1C 4B1C 7B               4      LD  A,E
000B1D 4B1D B7               4      OR  A
000B1E 4B1E C8              11      RET Z
000B1F 4B1F DD7E00          19      LD  A,(IX+0)
000B22 4B22 CD294B          17      CALL    CCHK2
000B25 4B25 C8              11      RET Z
000B26 4B26 C38C4B          10      JP  FKAN
                                
       4B29                     CCHK2:
000B29 4B29 0C               4      INC C
000B2A 4B2A 0D               4      DEC C
000B2B 4B2B C0              11      RET NZ
       4B2C                     CCHK3:              ;ZF=1 で使えない文字
000B2C 4B2C FE2B             7      CP  '+'
000B2E 4B2E C8              11      RET Z
000B2F 4B2F FE2C             7      CP  ','
000B31 4B31 C8              11      RET Z
000B32 4B32 FE2F             7      CP  '/'
000B34 4B34 C8              11      RET Z
000B35 4B35 FE3A             7      CP  ':'
000B37 4B37 C8              11      RET Z
000B38 4B38 FE3B             7      CP  ';'
000B3A 4B3A C8              11      RET Z
000B3B 4B3B FE3D             7      CP  '='
000B3D 4B3D C8              11      RET Z
000B3E 4B3E FE5C             7      CP  05CH    ;\
000B40 4B40 C8              11      RET Z
000B41 4B41 FE1F             7      CP  01FH
000B43 4B43 D0              11      RET NC
000B44 4B44 BF               4      CP  A       ;Z=1
000B45 4B45 C9              10      RET
                                
       4B46                     SS1:
000B46 4B46 13               6      INC DE
       4B47                     SPCUT:              ;スペースをカット
000B47 4B47 1A               7      LD  A,(DE)
000B48 4B48 FE20             7      CP  020H
000B4A 4B4A 28FA            12      JR  Z,SS1
000B4C 4B4C C9              10      RET
                                
       4B4D                     SCREOF1:
000B4D 4B4D 13               6      INC DE
       4B4E                     SPCUTEX:            ;スペース改行などをカット
000B4E 4B4E 1A               7      LD  A,(DE)
000B4F 4B4F FE20             7      CP  020H
000B51 4B51 28FA            12      JR  Z,SCREOF1
000B53 4B53 FE0D             7      CP  00DH
000B55 4B55 28F6            12      JR  Z,SCREOF1
000B57 4B57 FE0A             7      CP  00AH
000B59 4B59 28F2            12      JR  Z,SCREOF1
000B5B 4B5B FE1A             7      CP  01AH
000B5D 4B5D 28EE            12      JR  Z,SCREOF1
000B5F 4B5F C9              10      RET
                                
       4B60                     GETNUM:
000B60 4B60 210000          10      LD  HL,0
       4B63                     GETNUM1:
000B63 4B63 1A               7      LD  A,(DE)
000B64 4B64 13               6      INC DE
000B65 4B65 D630             7      SUB '0'
000B67 4B67 D8              11      RET C
000B68 4B68 FE0A             7      CP  10
000B6A 4B6A D0              11      RET NC
000B6B 4B6B 4D               4      LD  C,L
000B6C 4B6C 44               4      LD  B,H
000B6D 4B6D 29              11      ADD HL,HL   ;*2
000B6E 4B6E 29              11      ADD HL,HL   ;*4
000B6F 4B6F 09              11      ADD HL,BC   ;*5
000B70 4B70 29              11      ADD HL,HL   ;*10
000B71 4B71 4F               4      LD  C,A
000B72 4B72 0600             7      LD  B,0
000B74 4B74 09              11      ADD HL,BC
000B75 4B75 18EC            12      JR  GETNUM1
                                
       4B77                     SEARCH_END:
000B77 4B77 7E               7      LD  A,(HL)
       4B78                     SEARCH_END1:
000B78 4B78 23               6      INC HL
000B79 4B79 B7               4      OR  A
000B7A 4B7A C8              11      RET Z
000B7B 4B7B FE3A             7      CP  ':'
000B7D 4B7D 20F8            12      JR  NZ,SEARCH_END
000B7F 4B7F 7E               7      LD  A,(HL)
000B80 4B80 FE3A             7      CP  ':'
000B82 4B82 28F4            12      JR  Z,SEARCH_END1
000B84 4B84 C9              10      RET
                                
       4B85                     FKANC:
000B85 4B85 CB41             8      BIT 0,C
000B87 4B87 CCAA4B          17      CALL    Z,CAP2
000B8A 4B8A 1803            12      JR  FKANX
       4B8C                     FKAN:           ;漢字チェック
000B8C 4B8C DD23            10      INC IX
000B8E 4B8E 1D               4      DEC E
       4B8F                     FKANX:
000B8F 4B8F CB41             8      BIT 0,C
000B91 4B91 CB81             8      RES 0,C
000B93 4B93 C0              11      RET NZ
000B94 4B94 FE80             7      CP  080H
000B96 4B96 D8              11      RET C
000B97 4B97 FEA0             7      CP  0A0H
000B99 4B99 3803            12      JR  C,FKAN1
000B9B 4B9B FEE0             7      CP  0E0H
000B9D 4B9D D8              11      RET C
       4B9E                     FKAN1:
000B9E 4B9E 0C               4      INC C
000B9F 4B9F A7               4      AND A
000BA0 4BA0 C9              10      RET
                                
       4BA1                     CAP:
000BA1 4BA1 FE61             7      CP  'a'
000BA3 4BA3 D8              11      RET C
000BA4 4BA4 FE7B             7      CP  'z'+1
000BA6 4BA6 D0              11      RET NC
000BA7 4BA7 D620             7      SUB 020H
000BA9 4BA9 C9              10      RET
       4BAA                     CAP2:
000BAA 4BAA CDA14B          17      CALL    CAP
       4BAD                     CAP3:               ;
000BAD 4BAD FE05             7      CP  5
000BAF 4BAF 2803            12      JR  Z,CAP4
000BB1 4BB1 FE21             7      CP  021H
000BB3 4BB3 C9              10      RET
       4BB4                     CAP4:
000BB4 4BB4 3EE5             7      LD  A,0E5H
000BB6 4BB6 C9              10      RET
                                
       4BB7                     ROM_OPEN:
000BB7 4BB7 CD9952          17      CALL    GET_DISK_BANK_FDRV
                                
000BBA 4BBA CD154E          17      CALL    GET_DIR_DAT
000BBD 4BBD D5              11      PUSH    DE
000BBE 4BBE CDD34B          17      CALL    FILESE
000BC1 4BC1 D1              10      POP DE
000BC2 4BC2 3F               4      CCF
000BC3 4BC3 D8              11      RET C
000BC4 4BC4 22EDF2          16      LD  (DIRENT1),HL
000BC7 4BC7 E5              11      PUSH    HL
000BC8 4BC8 210000          10      LD  HL,0
000BCB 4BCB 22CAF2          16      LD  (RR_LOW),HL
000BCE 4BCE 22CCF2          16      LD  (RR_HIGH),HL
000BD1 4BD1 E1              10      POP HL
000BD2 4BD2 C9              10      RET
                                
       4BD3                     FILESE:
       4BD3                     FILESE0:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000BD3 4BD3 7E               7      LD  A,(HL)
                                #endif
000BD4 4BD4 B7               4      OR  A
000BD5 4BD5 C8              11      RET Z       ;END:ZF=1 CF=0
000BD6 4BD6 FEE5             7      CP  0E5H
000BD8 4BD8 280D            12      JR  Z,FILESE1
000BDA 4BDA 11F9F2          10      LD  DE,FNAME
000BDD 4BDD E5              11      PUSH    HL
000BDE 4BDE CD244C          17      CALL    CPFILE
000BE1 4BE1 CC454C          17      CALL    Z,CPFILE2
000BE4 4BE4 E1              10      POP HL
000BE5 4BE5 37               4      SCF
000BE6 4BE6 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4BE7                     FILESE1:
000BE7 4BE7 CDEF4B          17      CALL    FNEXT
000BEA 4BEA 20E7            12      JR  NZ,FILESE0
000BEC 4BEC F6FF             7      OR  0FFH        ;ZF=0 CF=0
000BEE 4BEE C9              10      RET
                                
       4BEF                     FNEXT:
000BEF 4BEF 112000          10      LD  DE,020H
000BF2 4BF2 19              11      ADD HL,DE
000BF3 4BF3 ED5BF6F2        20      LD  DE,(_CDX)
000BF7 4BF7 7A               4      LD  A,D
000BF8 4BF8 B3               4      OR  E
000BF9 4BF9 2019            12      JR  NZ,FNEXT_SUBDIR
000BFB 4BFB 0D               4      DEC C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
       4BFC                     CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
000BFC 4BFC F5              11      PUSH    AF      ;※フラグを保存する必要あり
000BFD 4BFD CB7C             8      BIT 7,H
000BFF 4BFF 2811            12      JR  Z,CHECK_DIR_PAGE1
000C01 4C01 7C               4      LD  A,H
000C02 4C02 D620             7      SUB 020H
000C04 4C04 67               4      LD  H,A
000C05 4C05 3AEFF2          13      LD  A,(_DIR_BANK)
000C08 4C08 3C               4      INC A
000C09 4C09 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C0C 4C0C 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000C0F 4C0F 32EFF2          13      LD  (_DIR_BANK),A
       4C12                     CHECK_DIR_PAGE1:
000C12 4C12 F1              10      POP AF
                                #endif
000C13 4C13 C9              10      RET
                                
       4C14                     FNEXT_SUBDIR:           ;サブディレクトリ
000C14 4C14 0D               4      DEC C
000C15 4C15 C0              11      RET NZ
                                
000C16 4C16 ED5BF6F2        20      LD  DE,(_CDX)
000C1A 4C1A CD4C4D          17      CALL    GNCL
000C1D 4C1D EB               4      EX  DE,HL
000C1E 4C1E 22F6F2          16      LD  (_CDX),HL
000C21 4C21 C3514E          10      JP  GET_SUBDIR
                                
       4C24                     CPFILE:
000C24 4C24 C5              11      PUSH    BC
000C25 4C25 01000B          10      LD  BC,00B00H
       4C28                     CPSTR1:
000C28 4C28 1A               7      LD  A,(DE)
000C29 4C29 FE3F             7      CP  '?'     ;Wild card
000C2B 4C2B 2812            12      JR  Z,CPSTR2
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000C2D 4C2D 7E               7      LD  A,(HL)
                                #endif
000C2E 4C2E CD854B          17      CALL    FKANC
000C31 4C31 E5              11      PUSH    HL
000C32 4C32 67               4      LD  H,A
000C33 4C33 1A               7      LD  A,(DE)
000C34 4C34 CB01             4      RLC C
000C36 4C36 CD854B          17      CALL    FKANC
000C39 4C39 CB09             4      RRC C
000C3B 4C3B BC               4      CP  H       ;CP (HL),(DE)
000C3C 4C3C E1              10      POP HL
000C3D 4C3D 2004            12      JR  NZ,CPSTR3
       4C3F                     CPSTR2:
000C3F 4C3F 13               6      INC DE
000C40 4C40 23               6      INC HL
000C41 4C41 10E5            13      DJNZ    CPSTR1
       4C43                     CPSTR3:
000C43 4C43 C1              10      POP BC
000C44 4C44 C9              10      RET
                                
       4C45                     CPFILE2:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000C45 4C45 7E               7      LD  A,(HL)
                                #endif
000C46 4C46 E608             7      AND 008H    ;~0F7H
000C48 4C48 C9              10      RET
                                
       4C49                     RBX1:
000C49 4C49 E5              11      PUSH    HL      ;Record byte
                                
000C4A 4C4A ED5BCAF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000C4E 4C4E 3ACDF2          13      LD  A,(RR_HIGH+1)
000C51 4C51 4F               4      LD  C,A
                                
000C52 4C52 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001CH
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    CALL    RDSLT_ROM
                                    EX  DE,HL       ;AHL=File size
                                    POP DE
                                #else
000C55 4C55 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C58 4C58 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000C5B 4C5B FD2AEDF2        20      LD  IY,(DIRENT1)
000C5F 4C5F FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000C62 4C62 FD661D          19      LD  H,(IY+01DH)
000C65 4C65 FD7E1E          19      LD  A,(IY+01EH)
                                #endif
                                
000C68 4C68 A7               4      AND A
000C69 4C69 ED52            15      SBC HL,DE
000C6B 4C6B 99               4      SBC A,C
000C6C 4C6C D1              10      POP DE
                                
000C6D 4C6D D8              11      RET C
000C6E 4C6E 4F               4      LD  C,A
000C6F 4C6F EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000C70 4C70 B2               4      OR  D
000C71 4C71 B3               4      OR  E
000C72 4C72 C0              11      RET NZ
000C73 4C73 37               4      SCF
000C74 4C74 C9              10      RET
                                
       4C75                     RBX2:
000C75 4C75 ED4BCBF2        20      LD  BC,(RR_LOW+1)
000C79 4C79 CDFD4C          17      CALL    RWXR
000C7C 4C7C 3AC7F2          13      LD  A,(CLSZ_H)
000C7F 4C7F 3D               4      DEC A
000C80 4C80 E5              11      PUSH    HL
000C81 4C81 2ACAF2          16      LD  HL,(RR_LOW)
000C84 4C84 A4               4      AND H
000C85 4C85 B5               4      OR  L
000C86 4C86 E1              10      POP HL
000C87 4C87 C9              10      RET
                                
       4C88                     RBXA:
000C88 4C88 D5              11      PUSH    DE
000C89 4C89 CD6F4D          17      CALL    CLUST
000C8C 4C8C ED53D2F2        20      LD  (_DTPS),DE
000C90 4C90 D1              10      POP DE
000C91 4C91 CD4C4D          17      CALL    GNCL
000C94 4C94 D8              11      RET C
000C95 4C95 ED53CEF2        20      LD  (_CLPS),DE
                                
000C99 4C99 ED4BCAF2        20      LD  BC,(RR_LOW)
000C9D 4C9D 2AC6F2          16      LD  HL,(CLSZ)
000CA0 4CA0 7C               4      LD  A,H
000CA1 4CA1 3D               4      DEC A
000CA2 4CA2 A0               4      AND B
000CA3 4CA3 47               4      LD  B,A
000CA4 4CA4 ED42            15      SBC HL,BC       ;remaining cluster
                                
000CA6 4CA6 ED5BF0F2        20      LD  DE,(LEFTX)
000CAA 4CAA ED52            15      SBC HL,DE       ;CP HL,DE
000CAC 4CAC 19              11      ADD HL,DE
000CAD 4CAD 3801            12      JR  C,RBXA1
000CAF 4CAF EB               4      EX  DE,HL
       4CB0                     RBXA1:
000CB0 4CB0 3AC4F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
000CB3 4CB3 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000CB6 4CB6 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000CB9 4CB9 E5              11      PUSH    HL
000CBA 4CBA 2AD2F2          16      LD  HL,(_DTPS)
000CBD 4CBD 09              11      ADD HL,BC
000CBE 4CBE ED5BE7F2        20      LD  DE,(DTAX)
000CC2 4CC2 C1              10      POP BC
000CC3 4CC3 C9              10      RET
                                
       4CC4                     RBXB:
000CC4 4CC4 2AE7F2          16      LD  HL,(DTAX)
000CC7 4CC7 ED5BCEF2        20      LD  DE,(_CLPS)
000CCB 4CCB 3AF1F2          13      LD  A,(LEFTX+1)
000CCE 4CCE 47               4      LD  B,A
000CCF 4CCF 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4CD2                     RBXB1:
000CD2 4CD2 1F               4      RRA     ;->CF
000CD3 4CD3 3804            12      JR  C,RBXB2
000CD5 4CD5 CB38             8      SRL B   ;B=B/2
000CD7 4CD7 18F9            12      JR  RBXB1
       4CD9                     RBXB2:
000CD9 4CD9 78               4      LD  A,B
000CDA 4CDA B7               4      OR  A
000CDB 4CDB C9              10      RET
                                
       4CDC                     RBXC:
000CDC 4CDC ED4BF0F2        20      LD  BC,(LEFTX)
000CE0 4CE0 3AC7F2          13      LD  A,(CLSZ_H)
000CE3 4CE3 3D               4      DEC A
000CE4 4CE4 A0               4      AND B
000CE5 4CE5 47               4      LD  B,A
000CE6 4CE6 B1               4      OR  C
000CE7 4CE7 C9              10      RET
                                
       4CE8                     RBXEND:
000CE8 4CE8 ED5BD0F2        20      LD  DE,(_LEFT)
000CEC 4CEC 2ACAF2          16      LD  HL,(RR_LOW)
000CEF 4CEF 3ACDF2          13      LD  A,(RR_HIGH+1)
000CF2 4CF2 19              11      ADD HL,DE
000CF3 4CF3 CE00             7      ADC A,0
000CF5 4CF5 22CAF2          16      LD  (RR_LOW),HL
000CF8 4CF8 32CDF2          13      LD  (RR_HIGH+1),A
000CFB 4CFB EB               4      EX  DE,HL       ;HL=Read byte
000CFC 4CFC C9              10      RET 
                                
       4CFD                     RWXR:
000CFD 4CFD 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4D00                     L_RWX:
000D00 4D00 1F               4      RRA     ;->CF
000D01 4D01 3806            12      JR  C,E_RWX
000D03 4D03 CB38             8      SRL B   ;BC=BC/2
000D05 4D05 CB19             8      RR  C   ;
000D07 4D07 18F7            12      JR  L_RWX
       4D09                     E_RWX:
000D09 4D09 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
                                    PUSH    HL
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    POP HL
                                #else
000D0C 4D0C 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D0F 4D0F 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D12 4D12 FD2AEDF2        20      LD  IY,(DIRENT1)
000D16 4D16 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000D19 4D19 FD561B          19      LD  D,(IY+01BH)
                                #endif
000D1C 4D1C CD9952          17      CALL    GET_DISK_BANK_FDRV
       4D1F                     RWX1:
000D1F 4D1F ED53CEF2        20      LD  (_CLPS),DE
000D23 4D23 7A               4      LD  A,D
000D24 4D24 B3               4      OR  E
000D25 4D25 37               4      SCF
000D26 4D26 C8              11      RET Z
                                
000D27 4D27 78               4      LD  A,B
000D28 4D28 B1               4      OR  C
000D29 4D29 C8              11      RET Z
                                
000D2A 4D2A CD4C4D          17      CALL    GNCL
000D2D 4D2D D8              11      RET C
000D2E 4D2E 0B               6      DEC BC
000D2F 4D2F CDAE4D          17      CALL    ENDCL
000D32 4D32 38EB            12      JR  C,RWX1
000D34 4D34 37               4      SCF
000D35 4D35 C9              10      RET
                                
       4D36                     NCL3:
000D36 4D36 CD9952          17      CALL    GET_DISK_BANK_FDRV
000D39 4D39 6B               4      LD  L,E
000D3A 4D3A 62               4      LD  H,D
000D3B 4D3B CB3C             8      SRL H
000D3D 4D3D CB1D             8      RR  L
000D3F 4D3F 1F               4      RRA
000D40 4D40 19              11      ADD HL,DE
000D41 4D41 010060          10      LD  BC,BANK1_ADR
000D44 4D44 09              11      ADD HL,BC
000D45 4D45 ED4BC8F2        20      LD  BC,(SECSZ)
000D49 4D49 09              11      ADD HL,BC
000D4A 4D4A 17               4      RLA
000D4B 4D4B C9              10      RET
                                
       4D4C                     GNCL:
000D4C 4D4C 7A               4      LD  A,D
000D4D 4D4D B3               4      OR  E
000D4E 4D4E 37               4      SCF
000D4F 4D4F C8              11      RET Z
000D50 4D50 C5              11      PUSH    BC
000D51 4D51 E5              11      PUSH    HL
000D52 4D52 CD364D          17      CALL    NCL3
000D55 4D55 3809            12      JR  C,GNC1
000D57 4D57 5E               7      LD  E,(HL)
000D58 4D58 23               6      INC HL
000D59 4D59 7E               7      LD  A,(HL)
000D5A 4D5A E60F             7      AND 00FH
000D5C 4D5C 57               4      LD  D,A
000D5D 4D5D E1              10      POP HL
000D5E 4D5E C1              10      POP BC
000D5F 4D5F C9              10      RET
       4D60                     GNC1:
000D60 4D60 7E               7      LD  A,(HL)
000D61 4D61 23               6      INC HL
000D62 4D62 56               7      LD  D,(HL)
000D63 4D63 0604             7      LD  B,4
       4D65                     GNC1L:
000D65 4D65 CB3A             8      SRL D
000D67 4D67 1F               4      RRA
000D68 4D68 10FB            13      DJNZ    GNC1L
                                
000D6A 4D6A 5F               4      LD  E,A
000D6B 4D6B E1              10      POP HL
000D6C 4D6C C1              10      POP BC
000D6D 4D6D A7               4      AND A
000D6E 4D6E C9              10      RET
                                
       4D6F                     CLUST:
000D6F 4D6F EB               4      EX  DE,HL
       4D70                     CLUST_HL:
000D70 4D70 2B               6      DEC HL
000D71 4D71 2B               6      DEC HL
000D72 4D72 C5              11      PUSH    BC
000D73 4D73 3AC7F2          13      LD  A,(CLSZ_H)
000D76 4D76 CDC952          17      CALL    MUL_AHL
                                
000D79 4D79 CD324E          17      CALL    GET_DIR_POS
000D7C 4D7C 4F               4      LD  C,A
000D7D 4D7D 0600             7      LD  B,0
000D7F 4D7F 09              11      ADD HL,BC
                                
000D80 4D80 ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
000D84 4D84 CB38             8      SRL B
000D86 4D86 CB19             8      RR  C           ;/2
000D88 4D88 CB38             8      SRL B
000D8A 4D8A CB19             8      RR  C           ;/4
000D8C 4D8C CB38             8      SRL B
000D8E 4D8E CB19             8      RR  C           ;/8
000D90 4D90 09              11      ADD HL,BC
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  A,L
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    JR  NC,CLUST2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
000D91 4D91 4D               4      LD  C,L     ;C=読み出し元
000D92 4D92 29              11      ADD HL,HL   ;64KB→32KB
000D93 4D93 29              11      ADD HL,HL   ;32KB→16KB
000D94 4D94 29              11      ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
000D95 4D95 CD9952          17      CALL    GET_DISK_BANK_FDRV
000D98 4D98 84               4      ADD A,H
000D99 4D99 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D9C 4D9C 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D9F 4D9F 32C4F2          13      LD  (_BANK),A
000DA2 4DA2 69               4      LD  L,C     ;C=読み出し元
000DA3 4DA3 3E1F             7      LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
000DA5 4DA5 A5               4      AND L
                                #endif
       4DA6                     CLUST2:
000DA6 4DA6 C660             7      ADD A,high BANK1_ADR
000DA8 4DA8 67               4      LD  H,A
000DA9 4DA9 2E00             7      LD  L,0
000DAB 4DAB EB               4      EX  DE,HL
000DAC 4DAC C1              10      POP BC
000DAD 4DAD C9              10      RET
                                
       4DAE                     ENDCL:
000DAE 4DAE 7A               4      LD  A,D ;END CLUSTER
000DAF 4DAF FE0F             7      CP  00FH    ;FAT12の最大値
000DB1 4DB1 C0              11      RET NZ
000DB2 4DB2 7B               4      LD  A,E
000DB3 4DB3 FEF7             7      CP  0F7H
000DB5 4DB5 C9              10      RET
                                
       4DB6                     RB_READ:
000DB6 4DB6 AF               4      XOR A   ;HLA = HL*128
000DB7 4DB7 CB3C             8      SRL H
000DB9 4DB9 CB1D             8      RR  L
000DBB 4DBB 1F               4      RRA
000DBC 4DBC 32CAF2          13      LD  (RR_LOW),A
000DBF 4DBF 22CBF2          16      LD  (RR_MID),HL
000DC2 4DC2 218000          10      LD  HL,128
                                
000DC5 4DC5 CD9749          17      CALL    ROM_READ
000DC8 4DC8 C9              10      RET
                                
       4DC9                     GETSEQ:
000DC9 4DC9 FD6E20          19      LD  L,(IY+32)
000DCC 4DCC FD660C          19      LD  H,(IY+12)
                                
000DCF 4DCF CB25             8      SLA L
                                
000DD1 4DD1 CB3C             8      SRL H
000DD3 4DD3 CB1D             8      RR  L
000DD5 4DD5 C9              10      RET
                                
       4DD6                     SETSEQ:
000DD6 4DD6 F5              11      PUSH    AF
000DD7 4DD7 3ACAF2          13      LD  A,(RR_LOW)
000DDA 4DDA 2ACBF2          16      LD  HL,(RR_MID)
                                
000DDD 4DDD CDF44D          17      CALL    SSQ1
                                
000DE0 4DE0 29              11      ADD HL,HL
000DE1 4DE1 CB3D             8      SRL L
000DE3 4DE3 FD7520          19      LD  (IY+32),L
000DE6 4DE6 FD740C          19      LD  (IY+12),H
000DE9 4DE9 F1              10      POP AF
000DEA 4DEA C9              10      RET
                                
       4DEB                     GETSIZE:
000DEB 4DEB FD7E10          19      LD  A,(IY+16)
000DEE 4DEE FD6E11          19      LD  L,(IY+17)
000DF1 4DF1 FD6612          19      LD  H,(IY+18)
       4DF4                     SSQ1:
000DF4 4DF4 87               4      ADD A,A
000DF5 4DF5 ED6A            15      ADC HL,HL
000DF7 4DF7 B7               4      OR  A
000DF8 4DF8 C8              11      RET Z
000DF9 4DF9 23               6      INC HL
000DFA 4DFA C9              10      RET
                                
       4DFB                     SET_FCB:
000DFB 4DFB D5              11      PUSH    DE
000DFC 4DFC FDE1            14      POP IY
000DFE 4DFE FD7E1C          19      LD  A,(IY+28)
000E01 4E01 FEFF             7      CP  0FFH
000E03 4E03 200C            12      JR  NZ,POPAF_SCF_FF_RET
000E05 4E05 E5              11      PUSH    HL
000E06 4E06 FD6E1A          19      LD  L,(IY+26)
000E09 4E09 FD661B          19      LD  H,(IY+27)
000E0C 4E0C 22CEF2          16      LD  (_CLPS),HL
000E0F 4E0F E1              10      POP HL
000E10 4E10 C9              10      RET
                                
       4E11                     POPAF_SCF_FF_RET:
000E11 4E11 F1              10      POP AF
000E12 4E12 37               4      SCF
000E13 4E13 9F               4      SBC A,A
000E14 4E14 C9              10      RET
                                
       4E15                     GET_DIR_DAT:
000E15 4E15 2AF6F2          16      LD  HL,(_CDX)
000E18 4E18 7C               4      LD  A,H
000E19 4E19 B5               4      OR  L
000E1A 4E1A 2035            12      JR  NZ,GET_SUBDIR
000E1C 4E1C CD324E          17      CALL    GET_DIR_POS
000E1F 4E1F C660             7      ADD A,high BANK1_ADR
000E21 4E21 2E00             7      LD  L,0
000E23 4E23 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
000E24 4E24 CDFC4B          17      CALL    CHECK_DIR_PAGE
                                #endif
000E27 4E27 3AC5F2          13      LD  A,(_BANK1)
000E2A 4E2A 32EFF2          13      LD  (_DIR_BANK),A
                                
000E2D 4E2D 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000E30 4E30 4F               4      LD  C,A
000E31 4E31 C9              10      RET
                                
       4E32                     GET_DIR_POS:                ;ルートディレクトリ
000E32 4E32 CD9952          17      CALL    GET_DISK_BANK_FDRV
000E35 4E35 32C5F2          13      LD  (_BANK1),A
000E38 4E38 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000E3B 4E3B 47               4      LD  B,A
000E3C 4E3C 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000E3F 4E3F 4F               4      LD  C,A
000E40 4E40 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4E43                     GET_DIR_POS1:
000E43 4E43 81               4      ADD A,C
000E44 4E44 10FD            13      DJNZ    GET_DIR_POS1
                                
000E46 4E46 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
000E4A 4E4A 37               4      SCF     ;無限ループ回避
       4E4B                     L_MDP:
000E4B 4E4B CB18             8      RR  B   ;->CF
000E4D 4E4D D8              11      RET C
000E4E 4E4E 87               4      ADD A,A
000E4F 4E4F 18FA            12      JR  L_MDP
                                
       4E51                     GET_SUBDIR:             ;サブディレクトリ
000E51 4E51 CD704D          17      CALL    CLUST_HL
000E54 4E54 EB               4      EX  DE,HL
000E55 4E55 3AC4F2          13      LD  A,(_BANK)
000E58 4E58 32EFF2          13      LD  (_DIR_BANK),A
000E5B 4E5B 3AC7F2          13      LD  A,(CLSZ_H)
000E5E 4E5E 87               4      ADD A,A     ;*2
000E5F 4E5F 87               4      ADD A,A     ;*4
000E60 4E60 87               4      ADD A,A     ;*8
000E61 4E61 4F               4      LD  C,A
000E62 4E62 C9              10      RET
                                
       4E63                     STATEMENT:
000E63 4E63 11B650          10      LD  DE,STR_CHDIR
000E66 4E66 CD9C50          17      CALL    CPPROCNM
000E69 4E69 2812            12      JR  Z,_CHDIR
000E6B 4E6B 11BC50          10      LD  DE,STR_CHDRV
000E6E 4E6E CD9C50          17      CALL    CPPROCNM
000E71 4E71 281C            12      JR  Z,_CHDRV
000E73 4E73 11C250          10      LD  DE,STR_RAMDISK
000E76 4E76 CD9C50          17      CALL    CPPROCNM
000E79 4E79 2829            12      JR  Z,_RAMDISK
000E7B 4E7B 37               4      SCF
000E7C 4E7C C9              10      RET
       4E7D                     _CHDIR:
000E7D 4E7D 7E               7      LD  A,(HL)
000E7E 4E7E FE28             7      CP  '('
000E80 4E80 37               4      SCF
000E81 4E81 C0              11      RET NZ
000E82 4E82 CD4547          17      CALL    INIT_PARAM
000E85 4E85 CD384A          17      CALL    FILE_B
000E88 4E88 CDB84E          17      CALL    ROM_CD
000E8B 4E8B D0              11      RET NC
000E8C 4E8C C3EF45          10      JP  ERROR_FILE_NOT_FOUND
                                
       4E8F                     _CHDRV:
000E8F 4E8F 7E               7      LD  A,(HL)
000E90 4E90 FE28             7      CP  '('
000E92 4E92 37               4      SCF
000E93 4E93 C0              11      RET NZ
000E94 4E94 CD4547          17      CALL    INIT_PARAM
000E97 4E97 E5              11      PUSH    HL
000E98 4E98 CD384A          17      CALL    FILE_B
000E9B 4E9B E1              10      POP HL
000E9C 4E9C 23               6      INC HL
000E9D 4E9D 3AF8F2          13      LD  A,(FDRV)
000EA0 4EA0 3D               4      DEC A
000EA1 4EA1 C30255          10      JP  _SYS0EX1
                                
       4EA4                     _RAMDISK:
000EA4 4EA4 7E               7      LD  A,(HL)
000EA5 4EA5 FE28             7      CP  '('
000EA7 4EA7 37               4      SCF
000EA8 4EA8 C0              11      RET NZ
000EA9 4EA9 23               6      INC HL
000EAA 4EAA DD212F54        14      LD  IX,FRMQNT
000EAE 4EAE FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000EB2 4EB2 CD1C00          17      CALL    _CALSLT
                                ;   LD  A,(HOKVLD)  ;bit0: 拡張 BIOSの存在
                                ;   CPL
                                ;   AND 1
                                ;   LD  A,D
                                ;   OR  E
                                ;   JP  NZ,ERROR_INTERNAL_ERROR
                                ;   PUSH    HL      ;EXTBIOもDISK BIOSで初期化してそう
                                ;   XOR A
                                ;   LD  DE,0401H    ;D=マッパサポートルチン(4) E=機能番号(1)
                                ;   CALL    EXTBIO
                                ;   POP HL
                                ;   OR  A
                                ;   JP  Z,ERROR_INTERNAL_ERROR
000EB5 4EB5 23               6      INC HL
000EB6 4EB6 AF               4      XOR A
000EB7 4EB7 C9              10      RET
                                
       4EB8                     ROM_CD:
000EB8 4EB8 3AF9F2          13      LD  A,(FNAME)
000EBB 4EBB FE20             7      CP  020H
000EBD 4EBD 2822            12      JR  Z,CD1
000EBF 4EBF CDB74B          17      CALL    ROM_OPEN
000EC2 4EC2 D8              11      RET C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
000EC3 4EC3 FD2AEDF2        20      LD  IY,(DIRENT1)
000EC7 4EC7 FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
000ECB 4ECB CAEF45          10      JP  Z,ERROR_FILE_NOT_FOUND
000ECE 4ECE FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000ED1 4ED1 FD661B          19      LD  H,(IY+01BH)
                                #endif
       4ED4                     CD2:
000ED4 4ED4 22EBF2          16      LD  (_CD),HL
000ED7 4ED7 2AF4F2          16      LD  HL,(PARAM1)
       4EDA                     CD_SKIP:
000EDA 4EDA 7E               7      LD  A,(HL)
000EDB 4EDB 23               6      INC HL
000EDC 4EDC FE21             7      CP  021H
000EDE 4EDE 38FA            12      JR  C,CD_SKIP
000EE0 4EE0 C9              10      RET
       4EE1                     CD1:
000EE1 4EE1 2AF6F2          16      LD  HL,(_CDX)
000EE4 4EE4 18EE            12      JR  CD2
                                
       4EE6                     GET_BASIC_FCB:
000EE6 4EE6 D5              11      PUSH    DE
000EE7 4EE7 23               6      INC HL  ;+1
000EE8 4EE8 5E               7      LD  E,(HL)  ;FCB[1]
000EE9 4EE9 23               6      INC HL  ;+2
000EEA 4EEA 56               7      LD  D,(HL)  ;FCB[2]
000EEB 4EEB 23               6      INC HL  ;+3
000EEC 4EEC ED53EDF2        20      LD  (DIRENT1),DE
                                            ;FCB[3] backup char
000EF0 4EF0 23               6      INC HL  ;+4
                                            ;FCB[4]
000EF1 4EF1 23               6      INC HL  ;+5
000EF2 4EF2 7E               7      LD  A,(HL)  ;FCB[5]
000EF3 4EF3 23               6      INC HL  ;+6
000EF4 4EF4 32EFF2          13      LD  (_DIR_BANK),A
000EF7 4EF7 5E               7      LD  E,(HL)  ;FCB[6]
000EF8 4EF8 23               6      INC HL  ;+7
000EF9 4EF9 56               7      LD  D,(HL)  ;FCB[7]
000EFA 4EFA 23               6      INC HL  ;+8
000EFB 4EFB ED53CAF2        20      LD  (RR_LOW),DE
000EFF 4EFF 7E               7      LD  A,(HL)  ;FCB[8]
000F00 4F00 23               6      INC HL  ;+9
000F01 4F01 32CCF2          13      LD  (RR_HIGH),A
000F04 4F04 22D4F2          16      LD  (_DTA),HL   ;FCB[9]
000F07 4F07 D1              10      POP DE
000F08 4F08 C9              10      RET
                                
       4F09                     SET_BASIC_FCB:
000F09 4F09 E5              11      PUSH    HL
000F0A 4F0A 2A64F8          16      LD  HL,(PTRFIL)
000F0D 4F0D 23               6      INC HL  ;+1
000F0E 4F0E D5              11      PUSH    DE
000F0F 4F0F ED5BEDF2        20      LD  DE,(DIRENT1)
000F13 4F13 73               7      LD  (HL),E  ;FCB[1]
000F14 4F14 23               6      INC HL  ;+2
000F15 4F15 72               7      LD  (HL),D  ;FCB[2]
000F16 4F16 23               6      INC HL  ;+3
000F17 4F17 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
000F18 4F18 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
000F19 4F19 23               6      INC HL  ;+5
000F1A 4F1A 3AEFF2          13      LD  A,(_DIR_BANK)
000F1D 4F1D 77               7      LD  (HL),A  ;FCB[5]
000F1E 4F1E 23               6      INC HL  ;+6
000F1F 4F1F ED5BCAF2        20      LD  DE,(RR_LOW)
000F23 4F23 73               7      LD  (HL),E  ;FCB[6]
000F24 4F24 23               6      INC HL  ;+7
000F25 4F25 72               7      LD  (HL),D  ;FCB[7]
000F26 4F26 23               6      INC HL  ;+8
000F27 4F27 3ACCF2          13      LD  A,(RR_HIGH)
000F2A 4F2A 77               7      LD  (HL),A  ;FCB[8]
000F2B 4F2B D1              10      POP DE
000F2C 4F2C E1              10      POP HL
000F2D 4F2D C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_18:BACKUP
                                ;in
                                ;   C : backup charactor
                                ;   HL: FBC pointer
                                ;out
       4F2E                     DEVICE_18_BACKUP:
000F2E 4F2E D5              11      PUSH    DE
000F2F 4F2F E5              11      PUSH    HL
000F30 4F30 110300          10      LD  DE,3
000F33 4F33 19              11      ADD HL,DE
000F34 4F34 71               7      LD  (HL),C
000F35 4F35 E1              10      POP HL
000F36 4F36 D1              10      POP DE
000F37 4F37 C9              10      RET
                                
       4F38                     DEVICE_CHECK:
000F38 4F38 23               6      INC HL
000F39 4F39 7E               7      LD  A,(HL)
000F3A 4F3A 2B               6      DEC HL
000F3B 4F3B B7               4      OR  A
000F3C 4F3C C8              11      RET Z
000F3D 4F3D 11CA50          10      LD  DE,STR_ROM
000F40 4F40 CD9C50          17      CALL    CPPROCNM
000F43 4F43 2802            12      JR  Z,DEVICE_OK
000F45 4F45 37               4      SCF
000F46 4F46 C9              10      RET
       4F47                     DEVICE_OK:
000F47 4F47 AF               4      XOR A
000F48 4F48 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファ
                                
       4F49                     DEVICE_0_OPEN:
000F49 4F49 7B               4      LD  A,E
000F4A 4F4A FE02             7      CP  2       ;FOR OUTPUT
000F4C 4F4C 281B            12      JR  Z,OPEN2
000F4E 4F4E D5              11      PUSH    DE
000F4F 4F4F E5              11      push    hl
                                ;
000F50 4F50 3E01             7      LD  A,1     ;ドライブA
000F52 4F52 32F8F2          13      LD  (FDRV),A
000F55 4F55 2166F8          10      LD  HL,FILNAM
000F58 4F58 11F9F2          10      LD  DE,FNAME
000F5B 4F5B 010B00          10      LD  BC,8+3
000F5E 4F5E CD7F56          17      CALL    INIT_FILE1
000F61 4F61 CDB74B          17      CALL    ROM_OPEN
000F64 4F64 DAEF45          10      JP  C,ERROR_FILE_NOT_FOUND
000F67 4F67 E1              10      pop hl
000F68 4F68 D1              10      POP DE
       4F69                     OPEN2:
000F69 4F69 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
000F6C 4F6C 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
000F6D 4F6D AF               4      XOR A
000F6E 4F6E 32F0F2          13      LD  (LEFTX),A
000F71 4F71 CD094F          17      CALL    SET_BASIC_FCB
000F74 4F74 7B               4      ld  a,e
000F75 4F75 FE08             7      cp  8
000F77 4F77 3F               4      ccf
000F78 4F78 C9              10      ret
                                
       4F79                     DEVICE_2_CLOSE:
000F79 4F79 AF               4      XOR A
                                ;   LD  (HL),A
000F7A 4F7A 6F               4      LD  L,A
000F7B 4F7B 67               4      LD  H,A
000F7C 4F7C 2264F8          16      LD  (PTRFIL),HL
000F7F 4F7F C9              10      RET
                                
       4F80                     DEVICE_ENTRY:
000F80 4F80 FE08             7      CP  8
000F82 4F82 2826            12      JR  Z,DEVICE_8_SIN
000F84 4F84 3C               4      INC A
000F85 4F85 28B1            12      JR  Z,DEVICE_CHECK:
000F87 4F87 3D               4      DEC A
000F88 4F88 28BF            12      JR  Z,DEVICE_0_OPEN
000F8A 4F8A FE0E             7      CP  14
000F8C 4F8C 2860            12      JR  Z,DEVICE_14_EOF
000F8E 4F8E FE04             7      CP  4
000F90 4F90 2834            12      JR  Z,DEVICE_4_RANDOM
000F92 4F92 FE0A             7      CP  10
000F94 4F94 2850            12      JR  Z,DEVICE_10_LOC
000F96 4F96 FE0C             7      CP  12
000F98 4F98 2878            12      JR  Z,DEVICE_12_LOF
000F9A 4F9A FE02             7      CP  2
000F9C 4F9C 2890            12      JR  Z,DEVICE_18_BACKUP  
000F9E 4F9E FE02             7      CP  2
000FA0 4FA0 28D7            12      JR  Z,DEVICE_2_CLOSE
000FA2 4FA2 FE06             7      CP  6
000FA4 4FA4 2802            12      JR  Z,DEVICE_6_SOUT
000FA6 4FA6 37               4      SCF
000FA7 4FA7 C9              10      RET
                                
       4FA8                     DEVICE_6_SOUT:
000FA8 4FA8 AF               4      XOR A
000FA9 4FA9 C9              10      RET
                                
       4FAA                     DEVICE_8_SIN:
000FAA 4FAA CDE64E          17      CALL    GET_BASIC_FCB
000FAD 4FAD 210100          10      LD  HL,1
000FB0 4FB0 CD9749          17      CALL    ROM_READ
000FB3 4FB3 7C               4      LD  A,H
000FB4 4FB4 B5               4      OR  L
000FB5 4FB5 280D            12      JR  Z,CCF_RET
000FB7 4FB7 2AD4F2          16      LD  HL,(_DTA)
000FBA 4FBA 7E               7      LD  A,(HL)
000FBB 4FBB F5              11      PUSH    AF
000FBC 4FBC CD094F          17      CALL    SET_BASIC_FCB
000FBF 4FBF F1              10      POP AF
000FC0 4FC0 FE0A             7      CP  00AH
000FC2 4FC2 C8              11      RET Z   ;ZF=separate
                                ;   CP  01AH
                                ;   JR  Z,SCF_RET
000FC3 4FC3 37               4      SCF     ;
       4FC4                     CCF_RET:
000FC4 4FC4 3F               4      CCF     ;ZF=0 CF=0にしたい
000FC5 4FC5 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_4:RANDOM
                                ;in
                                ;   A : 4
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
       4FC6                     DEVICE_4_RANDOM:
000FC6 4FC6 D5              11      PUSH    DE
000FC7 4FC7 CDE64E          17      CALL    GET_BASIC_FCB
000FCA 4FCA DDE5            15      PUSH    IX
000FCC 4FCC DD218A2F        14      LD  IX,FRCINT
000FD0 4FD0 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000FD4 4FD4 CDB1F2          17      CALL    CAL_MP
000FD7 4FD7 DDE1            14      POP IX
000FD9 4FD9 2AF8F7          16      LD  HL,(DACDAT)
000FDC 4FDC 22CAF2          16      LD  (RR_LOW),HL
000FDF 4FDF AF               4      XOR A
000FE0 4FE0 CD094F          17      CALL    SET_BASIC_FCB
000FE3 4FE3 D1              10      POP DE
000FE4 4FE4 AF               4      XOR A
000FE5 4FE5 C9              10      RET
                                
                                ;FUNC_10:LOC
                                ;in
                                ;   A : 10
                                ;out
                                ;   DAC    : value of received bytes
                                ;   VALTYP : DAC type
       4FE6                     DEVICE_10_LOC:
000FE6 4FE6 CDE64E          17      CALL    GET_BASIC_FCB
000FE9 4FE9 2ACAF2          16      LD  HL,(RR_LOW)
000FEC 4FEC 183D            12      JR  RETURN_TYPE8_AHL
                                
                                ;--------------------------------------
                                ;FUNC_14:EOF
                                ;in
                                ;   A : 14
                                ;out
                                ;   DAC    : value of EOF value (EOF=-1)
                                ;   VALTYP : DAC type
       4FEE                     DEVICE_14_EOF:
000FEE 4FEE CDE64E          17      CALL    GET_BASIC_FCB
000FF1 4FF1 CD494C          17      CALL    RBX1
000FF4 4FF4 3810            12      JR  C,DEVICE_14_EOF1
000FF6 4FF6 210100          10      LD  HL,1
000FF9 4FF9 CD9749          17      CALL    ROM_READ
000FFC 4FFC 2AD4F2          16      LD  HL,(_DTA)
000FFF 4FFF 7E               7      LD  A,(HL)
001000 5000 FE1A             7      CP  01AH
001002 5002 37               4      SCF
001003 5003 2801            12      JR  Z,DEVICE_14_EOF1
001005 5005 3F               4      CCF
       5006                     DEVICE_14_EOF1:
001006 5006 9F               4      SBC A,A
001007 5007 6F               4      LD  L,A
001008 5008 67               4      LD  H,A
       5009                     return_type2_hl:
001009 5009 22F8F7          16      ld  (DACDAT),hl
00100C 500C 3E02             7      ld  a,2
00100E 500E 3263F6          13      ld  (VALTYP),a
001011 5011 C9              10      ret
                                
                                ;--------------------------------------
                                ;FUNC_16:FPOS
                                ;in
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
                                ;   illegal function call
                                
                                ;--------------------------------------
                                ;FUNC_12:LOF
                                ;in
                                ;   A : 12
                                ;out
                                ;   DAC    : value of LOC+RSIQLN
                                ;   VALTYP : DAC type
       5012                     DEVICE_12_LOF:
001012 5012 CDE64E          17      CALL    GET_BASIC_FCB
                                
001015 5015 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001CH
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    CALL    RDSLT_ROM
                                    EX  DE,HL       ;AHL=File size
                                    POP DE
                                #else
001018 5018 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
00101B 501B 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
00101E 501E FD2AEDF2        20      LD  IY,(DIRENT1)
001022 5022 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
001025 5025 FD661D          19      LD  H,(IY+01DH)
001028 5028 FD7E1E          19      LD  A,(IY+01EH)
                                #endif
       502B                     RETURN_TYPE8_AHL:
00102B 502B B7               4      OR  A
00102C 502C 2004            12      JR  NZ,RT8AHL1
00102E 502E CB7C             8      BIT 7,H
001030 5030 28D7            12      JR  Z,return_type2_hl
       5032                     RT8AHL1:
001032 5032 E5              11      PUSH    HL
001033 5033 29              11      ADD HL,HL
001034 5034 8F               4      ADC A,A
001035 5035 32F8F7          13      LD  (DACDAT),A
001038 5038 3E00             7      LD  A,0
00103A 503A 8F               4      ADC A,A
00103B 503B 32F9F7          13      LD  (DACDAT+1),A
                                
00103E 503E 3E02             7      LD  A,2
001040 5040 3263F6          13      LD  (VALTYP),A
001043 5043 DD213A30        14      LD  IX,FRCDBL
001047 5047 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00104B 504B CDB1F2          17      CALL    CAL_MP
                                
00104E 504E 219450          10      LD  HL,DBL32768
001051 5051 1147F8          10      LD  DE,ARG
001054 5054 010800          10      LD  BC,8
001057 5057 EDB0                    LDIR
                                
001059 5059 DD21E627        14      LD  IX,DECMUL
00105D 505D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001061 5061 CDB1F2          17      CALL    CAL_MP
                                
001064 5064 21F6F7          10      LD  HL,DAC
001067 5067 1147F8          10      LD  DE,ARG
00106A 506A 010800          10      LD  BC,8
00106D 506D EDB0                    LDIR
                                
00106F 506F E1              10      POP HL
001070 5070 22F8F7          16      LD  (DACDAT),HL
                                
001073 5073 3E02             7      LD  A,2
001075 5075 3263F6          13      LD  (VALTYP),A
001078 5078 DD213A30        14      LD  IX,FRCDBL
00107C 507C FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001080 5080 CDB1F2          17      CALL    CAL_MP
                                
001083 5083 DD219A26        14      LD  IX,DECADD
001087 5087 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00108B 508B CDB1F2          17      CALL    CAL_MP
                                
00108E 508E 3E08             7      LD  A,8
001090 5090 3263F6          13      LD  (VALTYP),A
001093 5093 C9              10      RET
                                
       5094                     DBL32768:
001094 5094 4532768000000000        DB  045H,032H,076H,080H,0,0,0,0
                                
       509C                     CPPROCNM:
00109C 509C E5              11      PUSH    HL
00109D 509D 2189FD          10      LD  HL,PROCNM
       50A0                     CPPROCNM1:
0010A0 50A0 1A               7      LD  A,(DE)
0010A1 50A1 13               6      INC DE
0010A2 50A2 BE               7      CP  (HL)
0010A3 50A3 23               6      INC HL
0010A4 50A4 2003            12      JR  NZ,CPPROCNM2
0010A6 50A6 B7               4      OR  A
0010A7 50A7 20F7            12      JR  NZ,CPPROCNM1
       50A9                     CPPROCNM2:
0010A9 50A9 E1              10      POP HL
0010AA 50AA C9              10      RET
                                
       50AB                     WILDCARD:
0010AB 50AB 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       50B6                     STR_CHDIR:
0010B6 50B6 434844495200            DB  "CHDIR",0
       50BC                     STR_CHDRV:
0010BC 50BC 434844525600            DB  "CHDRV",0
       50C2                     STR_RAMDISK:
0010C2 50C2 52414D4449534B00        DB  "RAMDISK",0
       50CA                     STR_ROM:
0010CA 50CA 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       50CE                     ERROR_WRITE_PROTECTED:
0010CE 50CE 3E00             7      LD  A,0     ;Write protected
0010D0 50D0 C9              10      RET
       50D1                     DISKIO:
0010D1 50D1 38FB            12      JR  C,ERROR_WRITE_PROTECTED
0010D3 50D3 48               4      LD  C,B
0010D4 50D4 CDA352          17      CALL    GET_DISK_BANK
       50D7                     SETMAP1:        
0010D7 50D7 E5              11      PUSH    HL
       50D8                     DISKIO1:
0010D8 50D8 C5              11      PUSH    BC      ;B=残りのセクタ数
0010D9 50D9 D5              11      PUSH    DE      ;DE=セクタ番号
0010DA 50DA F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
0010DB 50DB EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
0010DC 50DC F5              11      PUSH    AF
0010DD 50DD 3AC9F2          13      LD  A,(SECSZ_H)
0010E0 50E0 CDC952          17      CALL    MUL_AHL
0010E3 50E3 F1              10      POP AF
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  A,L
                                    PUSH    BC
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    POP BC
                                    JR  NC,DISKIO2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
0010E4 50E4 4D               4      LD  C,L     ;C=読み出し元
0010E5 50E5 29              11      ADD HL,HL       ;64KB→32KB
0010E6 50E6 29              11      ADD HL,HL       ;32KB→16KB
0010E7 50E7 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
0010E8 50E8 84               4      ADD A,H
0010E9 50E9 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0010EC 50EC 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0010EF 50EF 32C4F2          13      LD  (_BANK),A
0010F2 50F2 79               4      LD  A,C     ;C=読み出し元
0010F3 50F3 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       50F5                     DISKIO2:
0010F5 50F5 C660             7      ADD A,high BANK1_ADR
0010F7 50F7 67               4      LD  H,A
0010F8 50F8 ED4BC8F2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
0010FC 50FC 69               4      LD  L,C     ;C=0
0010FD 50FD CD1044          17      CALL    ROM_LDIR
001100 5100 EB               4      EX  DE,HL
001101 5101 F1              10      POP AF
001102 5102 D1              10      POP DE
001103 5103 13               6      INC DE
001104 5104 C1              10      POP BC
001105 5105 10D1            13      DJNZ    DISKIO1
001107 5107 41               4      LD  B,C
                                
001108 5108 E1              10      POP HL
001109 5109 AF               4      XOR A
                                
00110A 510A FB               4      EI
00110B 510B C9              10      RET
                                
       510C                     DSKCHG:
00110C 510C CD4551          17      CALL    IS_BPB
00110F 510F 3824            12      JR  C,NOTREADY
001111 5111 3A23FB          13      LD  A,(DRVTBL+2)
001114 5114 B7               4      OR  A
001115 5115 201A            12      JR  NZ,DSKCHG1
001117 5117 3A21FB          13      LD  A,(DRVTBL)
00111A 511A FE02             7      CP  2
00111C 511C 2013            12      JR  NZ,DSKCHG1
00111E 511E CD4551          17      CALL    IS_BPB
001121 5121 300E            12      JR  NC,DSKCHG1
001123 5123 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
001125 5125 3221FB          13      LD  (DRVTBL),A
001128 5128 3223FB          13      LD  (DRVTBL+2),A
00112B 512B 3A48F3          13      LD  A,(MASTERS)
00112E 512E 3224FB          13      LD  (DRVTBL+3),A
       5131                     DSKCHG1:
001131 5131 AF               4      XOR A
001132 5132 0601             7      LD  B,1
001134 5134 C9              10      RET
       5135                     NOTREADY:
001135 5135 3E02             7      LD  A,2
001137 5137 37               4      SCF
001138 5138 C9              10      RET
                                
       5139                     NO_BPB:
001139 5139 E1              10      POP HL
00113A 513A 23               6      INC HL
00113B 513B 11CF52          10      LD  DE,DPB2DD
00113E 513E 011200          10      LD  BC,DPB2DD_E-DPB2DD
001141 5141 EDB0                    LDIR
001143 5143 AF               4      XOR A
001144 5144 C9              10      RET
                                
       5145                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
001145 5145 CDA352          17      CALL    GET_DISK_BANK
                                
001148 5148 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
00114B 514B FE01             7      CP  1
00114D 514D D8              11      RET C
                                
00114E 514E 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
001151 5151 C6FF             7      ADD A,0FFH
001153 5153 D8              11      RET C
                                
001154 5154 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       5157                     IS_BPB1:
001157 5157 FE01             7      CP  1
001159 5159 C8              11      RET Z
00115A 515A FE02             7      CP  2
00115C 515C C8              11      RET Z
00115D 515D FE04             7      CP  4
00115F 515F C8              11      RET Z
001160 5160 37               4      SCF
001161 5161 C9              10      RET
                                
       5162                     GETDPB:
001162 5162 E5              11      PUSH    HL
001163 5163 CDA352          17      CALL    GET_DISK_BANK
                                
001166 5166 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
001169 5169 B7               4      OR  A
00116A 516A 28CD            12      JR  Z,NO_BPB
00116C 516C DDE1            14      POP IX
00116E 516E DD7701          19      LD  (IX+1),A        ;MEDIA
                                
001171 5171 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
001174 5174 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
001177 5177 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
00117A 517A DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
00117D 517D 87               4      ADD A,A
00117E 517E 87               4      ADD A,A
00117F 517F 87               4      ADD A,A
001180 5180 3D               4      DEC A
001181 5181 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
001184 5184 06FF             7      LD  B,-1
001186 5186 A7               4      AND A           ;無限ループ阻止
       5187                     GETDPB1:
001187 5187 04               4      INC B
001188 5188 1F               4      RRA
001189 5189 38FC            12      JR  C,GETDPB1
00118B 518B DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
00118E 518E 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
001191 5191 3D               4      DEC A
001192 5192 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
001195 5195 A7               4      AND A           ;無限ループ阻止
001196 5196 06FF             7      LD  B,-1
       5198                     GETDPB2:
001198 5198 04               4      INC B
001199 5199 1F               4      RRA
00119A 519A 38FC            12      JR  C,GETDPB2
00119C 519C 04               4      INC B
00119D 519D DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
0011A0 51A0 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
0011A3 51A3 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
0011A6 51A6 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
0011A9 51A9 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
0011AC 51AC DD770A          19      LD  (IX+10),A       ;FATCNT
                                
0011AF 51AF 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
0011B2 51B2 DD770B          19      LD  (IX+11),A       ;MAXENT
                                
0011B5 51B5 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
0011B9 51B9 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
0011BC 51BC DD460A          19      LD  B,(IX+10)       ;FATCNT
0011BF 51BF 210000          10      LD  HL,0
       51C2                     GETDPB3:
0011C2 51C2 19              11      ADD HL,DE
0011C3 51C3 10FD            13      DJNZ    GETDPB3
       51C5                     GETDPB4:
0011C5 51C5 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
0011C8 51C8 DD5609          19      LD  D,(IX+9)        ;FIRFAT
0011CB 51CB 19              11      ADD HL,DE
0011CC 51CC DD7511          19      LD  (IX+17),L       ;FIRDIR
0011CF 51CF DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
0011D2 51D2 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0011D5 51D5 87               4      ADD A,A
0011D6 51D6 87               4      ADD A,A
0011D7 51D7 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       51DA                     GETDPB5:
0011DA 51DA CB3B             8      SRL E
0011DC 51DC 1F               4      RRA
0011DD 51DD 30FB            12      JR  NC,GETDPB5
0011DF 51DF 1600             7      LD  D,0
0011E1 51E1 19              11      ADD HL,DE
0011E2 51E2 DD750C          19      LD  (IX+12),L       ;FIRREC
0011E5 51E5 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
0011E8 51E8 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
0011EB 51EB DD5E0C          19      LD  E,(IX+12)       ;FIRREC
0011EE 51EE DD560D          19      LD  D,(IX+13)       ;FIRREC
0011F1 51F1 A7               4      AND A
0011F2 51F2 ED52            15      SBC HL,DE
                                
0011F4 51F4 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
0011F7 51F7 3C               4      INC A
0011F8 51F8 37               4      SCF             ;無限ループ阻止
       51F9                     GETDPB6:
0011F9 51F9 1F               4      RRA
0011FA 51FA 3806            12      JR  C,GETDPB7
0011FC 51FC CB3C             8      SRL H
0011FE 51FE CB1D             8      RR  L
001200 5200 18F7            12      JR  GETDPB6
       5202                     GETDPB7:
001202 5202 23               6      INC HL
001203 5203 DD750E          19      LD  (IX+14),L       ;MAXCLUS
001206 5206 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       5209                     GETDPBD1:
001209 5209 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
00120C 520C E6FC             7      AND 0FCH
00120E 520E C8              11      RET Z
                                
00120F 520F DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
001213 5213 37               4      SCF
001214 5214 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
001218 5218 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
00121B 521B DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
00121F 521F DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
001223 5223 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
001227 5227 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
00122B 522B DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
00122F 522F DDCB1126        23      SLA (IX+17)         ;FIRDIR
001233 5233 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
001237 5237 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
00123A 523A DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
00123D 523D DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001240 5240 87               4      ADD A,A
001241 5241 87               4      ADD A,A
001242 5242 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       5245                     GETDPBD5:
001245 5245 CB3B             8      SRL E
001247 5247 1F               4      RRA
001248 5248 30FB            12      JR  NC,GETDPBD5
00124A 524A 1600             7      LD  D,0
00124C 524C 19              11      ADD HL,DE
00124D 524D DD750C          19      LD  (IX+12),L       ;FIRREC
001250 5250 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001253 5253 18B4            12      JR  GETDPBD1
                                
       5255                     CHOICE:
001255 5255 210000          10      LD  HL,0
001258 5258 C9              10      RET
                                
       5259                     DSKFMT:
001259 5259 AF               4      XOR A
00125A 525A 37               4      SCF
       525B                     DSKSTP:
00125B 525B C9              10      RET
                                
       525C                     BASENT:
00125C 525C 2A74F6          16      LD  HL,(STKTOP)
00125F 525F 3A40F3          13      LD  A,(REBOOT)
001262 5262 C6FF             7      ADD A,0FFH
001264 5264 3811            12      JR  C,REBOOT1
001266 5266 21E152          10      LD  HL,AUTOEXEC
001269 5269 11F8F2          10      LD  DE,FDRV
00126C 526C 010C00          10      LD  BC,1+8+3
00126F 526F EDB0                    LDIR
001271 5271 CDB74B          17      CALL    ROM_OPEN
001274 5274 D43945          17      CALL    NC,ROM_LOAD1
       5277                     REBOOT1:
001277 5277 21ED52          10      LD  HL,CMD_RUN
00127A 527A 111FF4          10      LD  DE,KBUF
00127D 527D 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
001280 5280 D5              11      PUSH    DE
001281 5281 EDB0                    LDIR
001283 5283 3004            12      JR  NC,REBOOT2
001285 5285 AF               4      XOR A
001286 5286 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       5289                     REBOOT2:
001289 5289 E1              10      POP HL
00128A 528A FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00128E 528E DD210146        14      LD  IX,NEWSTT
001292 5292 C31C00          10      JP  _CALSLT
                                
       5295                     GETSLT:
001295 5295 3A22FB          13      LD  A,(DRVTBL+1)
001298 5298 C9              10      RET
                                
       5299                     GET_DISK_BANK_FDRV:
001299 5299 3AF8F2          13      LD  A,(FDRV)
00129C 529C D601             7      SUB 1
00129E 529E 3003            12      JR  NC,GET_DISK_BANK
0012A0 52A0 3AEAF2          13      LD  A,(_DVSW)
       52A3                     GET_DISK_BANK:
0012A3 52A3 FE07             7      CP  7       ;H:
0012A5 52A5 2801            12      JR  Z,SET_DISK_BANK_A
0012A7 52A7 B7               4      OR  A       ;A=DRIVE
       52A8                     SET_DISK_BANK_A:
0012A8 52A8 3E01             7      LD  A,DISK_BANK
0012AA 52AA 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
0012AC 52AC 3AE9F2          13      LD  A,(B_DRIVE)
                                #endif
       52AF                     SET_DISK_BANK:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0012AF 52AF 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0012B2 52B2 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0012B5 52B5 F5              11      PUSH    AF
0012B6 52B6 E5              11      PUSH    HL
0012B7 52B7 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
0012BA 52BA 22C8F2          16      LD  (SECSZ),HL
0012BD 52BD 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0012C0 52C0 CDC952          17      CALL    MUL_AHL
0012C3 52C3 22C6F2          16      LD  (CLSZ),HL
0012C6 52C6 E1              10      POP HL
0012C7 52C7 F1              10      POP AF
0012C8 52C8 C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       52C9                     MUL_AHL:
0012C9 52C9 37               4      SCF     ;無限ループ回避
       52CA                     MUL_AHL1:
0012CA 52CA 1F               4      RRA     ;->CF
0012CB 52CB D8              11      RET C
0012CC 52CC 29              11      ADD HL,HL
0012CD 52CD 18FB            12      JR  MUL_AHL1
                                
       52CF                     DPB2DD:
0012CF 52CF F9                      DB  0F9H    ;MEDIA
0012D0 52D0 0002                    DW  00200H  ;SECSIZ
0012D2 52D2 0F                      DB  00FH    ;DIRMSK
0012D3 52D3 04                      DB  004H    ;DIRSHFT
0012D4 52D4 01                      DB  001H    ;CLUSMSK
0012D5 52D5 02                      DB  002H    ;CLUSSHFT
0012D6 52D6 0100                    DW  00001H  ;FIRFAT
0012D8 52D8 02                      DB  002H    ;FATCNT
0012D9 52D9 70                      DB  070H    ;MAXENT
0012DA 52DA 0E00                    DW  0000EH  ;FIRREC
0012DC 52DC CA02                    DW  002CAH  ;MAXCLUS
0012DE 52DE 03                      DB  003H    ;FATSIZ
0012DF 52DF 0700                    DW  0007H   ;FIRDIR
       52E1                     DPB2DD_E:
                                
       52E1                     AUTOEXEC:
0012E1 52E1 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       52ED                     CMD_RUN:
0012ED 52ED 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DW  0F280H
                                #else
0012F3 52F3 40F2                    DW  0F240H
                                #endif
       52F5                     CMD_CLEAR_E:
0012F5 52F5 3A8A00                  DB  03AH,08AH,0         ;RUN
       52F8                     CMD_RUN_E:
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       52F8                     POP_HL_ERROR:
0012F8 52F8 E1              10      POP     HL
       52F9                     _ERROR:
0012F9 52F9 0600             7      LD  B,0
0012FB 52FB A7               4      AND A
0012FC 52FC C9              10      RET
                                
       52FD                     ROM_BDOS:
0012FD 52FD E5              11      PUSH    HL
0012FE 52FE 79               4      LD  A,C
0012FF 52FF 87               4      ADD A,A
001300 5300 38F7            12      JR  C,_ERROR
001302 5302 6F               4      LD  L,A
001303 5303 265F             7      LD  H,high STABLE
001305 5305 7E               7      LD  A,(HL)
001306 5306 2C               4      INC L
001307 5307 66               7      LD  H,(HL)
001308 5308 6F               4      LD  L,A
001309 5309 E3              19      EX  (SP),HL
00130A 530A 79               4      LD  A,C
00130B 530B C9              10      RET
                                
       530C                     _PRINT:
       530C                     PRINT:
00130C 530C 7B               4      LD  A,E
00130D 530D 1803            12      JR  MSG_A
                                
       530F                     _SYS01:     ;(BDOS)コンソール入力
00130F 530F CD8653          17      CALL    _SYS07
       5312                     MSG_A:
001312 5312 FE03             7      CP  3
001314 5314 2814            12      JR  Z,MSG_BR
       5316                     MSGA1:
001316 5316 F5              11      PUSH    AF
001317 5317 C5              11      PUSH    BC
001318 5318 D5              11      PUSH    DE
001319 5319 E5              11      PUSH    HL
00131A 531A DDE5            15      PUSH    IX
00131C 531C DD21A200        14      LD  IX,CHPUT
001320 5320 CDD442          17      CALL    CALSLT_R
001323 5323 DDE1            14      POP IX
001325 5325 E1              10      POP HL
001326 5326 D1              10      POP DE
001327 5327 C1              10      POP BC
       5328                     MSGA2:
001328 5328 F1              10      POP AF
001329 5329 C9              10      RET
       532A                     MSG_BR:
00132A 532A F5              11      PUSH    AF
00132B 532B 3ADDF3          13      LD  A,(CSRX)
00132E 532E FE02             7      CP  2
001330 5330 38F6            12      JR  C,MSGA2
001332 5332 F1              10      POP AF
       5333                     MSG_CR:
001333 5333 F5              11      PUSH    AF
001334 5334 3E0D             7      LD  A,00DH
001336 5336 CD1653          17      CALL    MSGA1
001339 5339 3E0A             7      LD  A,00AH
00133B 533B CD1653          17      CALL    MSGA1
00133E 533E F1              10      POP AF
00133F 533F C9              10      RET
                                
       5340                     _SYS02:     ;(BDOS)コンソール出力
001340 5340 CD5B53          17      CALL    BREAK
001343 5343 1805            12      JR  PRINTX
                                
       5345                     _SYS06:     ;(BDOS)コンソール直接入出力
001345 5345 7B               4      LD  A,E
001346 5346 3C               4      INC A
001347 5347 CA9A53          10      JP  Z,_INKEY
       534A                     PRINTX:
00134A 534A C30C53          10      JP  _PRINT
                                
       534D                     _SYS08:     ;(BDOS)エコーなしコンソール入力
00134D 534D CD8653          17      CALL    _SYS07
001350 5350 FE03             7      CP  3
001352 5352 CC5B53          17      CALL    Z,_BREAK
001355 5355 FE13             7      CP  013H        ;CTRL+S
001357 5357 C0              11      RET NZ
       5358                     PAUSE:
001358 5358 CD7253          17      CALL    KEYBC
                                
       535B                     _BREAK:
       535B                     BREAK:
00135B 535B F5              11      PUSH    AF
00135C 535C C5              11      PUSH    BC
00135D 535D D5              11      PUSH    DE
00135E 535E E5              11      PUSH    HL
00135F 535F DDE5            15      PUSH    IX
001361 5361 DD21B700        14      LD  IX,BREAKX
001365 5365 CDD442          17      CALL    CALSLT_R
001368 5368 DDE1            14      POP IX
00136A 536A E1              10      POP HL
00136B 536B D1              10      POP DE
00136C 536C C1              10      POP BC
00136D 536D DC5B53          17      CALL    C,_BREAK
001370 5370 F1              10      POP AF
001371 5371 C9              10      RET
       5372                     KEYBC:
001372 5372 F5              11      PUSH    AF
001373 5373 C5              11      PUSH    BC
001374 5374 D5              11      PUSH    DE
001375 5375 E5              11      PUSH    HL
001376 5376 DDE5            15      PUSH    IX
001378 5378 DD215601        14      LD  IX,KILBUF
00137C 537C CDD442          17      CALL    CALSLT_R
00137F 537F DDE1            14      POP IX
001381 5381 E1              10      POP HL
001382 5382 D1              10      POP DE
001383 5383 C1              10      POP BC
001384 5384 F1              10      POP AF
001385 5385 C9              10      RET
                                
       5386                     _SYS07:
       5386                     FLGET:
001386 5386 C5              11      PUSH    BC
001387 5387 D5              11      PUSH    DE
001388 5388 E5              11      PUSH    HL
001389 5389 DDE5            15      PUSH    IX
00138B 538B DD219F00        14      LD  IX,CHGET
00138F 538F CDD442          17      CALL    CALSLT_R
001392 5392 DDE1            14      POP IX
001394 5394 E1              10      POP HL
001395 5395 D1              10      POP DE
001396 5396 C1              10      POP BC
001397 5397 FE03             7      CP  3
001399 5399 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       539A                     _INKEY:
       539A                     INKEY:
00139A 539A CD3454          17      CALL    CPM_CONST
00139D 539D C8              11      RET Z
00139E 539E 18E6            12      JR  FLGET
                                
       53A0                     _SYS0A:     ;(BDOS)文字列入力
0013A0 53A0 C5              11      PUSH    BC
0013A1 53A1 E5              11      PUSH    HL
0013A2 53A2 D5              11      PUSH    DE
0013A3 53A3 CDCC53          17      CALL    GETL
0013A6 53A6 111FF4          10      LD  DE,KBUF
0013A9 53A9 E1              10      POP HL
0013AA 53AA E5              11      PUSH    HL
0013AB 53AB 0E00             7      LD  C,0
0013AD 53AD 3004            12      JR  NC,SAX0
0013AF 53AF 23               6      INC HL
0013B0 53B0 23               6      INC HL
0013B1 53B1 1808            12      JR  SAX4
       53B3                     SAX0:
0013B3 53B3 46               7      LD  B,(HL)
0013B4 53B4 23               6      INC HL
       53B5                     SAX1:
0013B5 53B5 23               6      INC HL
0013B6 53B6 1A               7      LD  A,(DE)
0013B7 53B7 13               6      INC DE
0013B8 53B8 B7               4      OR  A
0013B9 53B9 2004            12      JR  NZ,SAX2
       53BB                     SAX4:
0013BB 53BB 360D            10      LD  (HL),00DH
0013BD 53BD 1804            12      JR  SAX3
       53BF                     SAX2:
0013BF 53BF 77               7      LD  (HL),A
0013C0 53C0 0C               4      INC C
0013C1 53C1 10F2            13      DJNZ    SAX1
       53C3                     SAX3:
0013C3 53C3 D1              10      POP DE
0013C4 53C4 79               4      LD  A,C
0013C5 53C5 13               6      INC DE
0013C6 53C6 12               7      LD  (DE),A
0013C7 53C7 1B               6      DEC DE
0013C8 53C8 E1              10      POP HL
0013C9 53C9 C1              10      POP BC
0013CA 53CA A7               4      AND A
0013CB 53CB C9              10      RET
       53CC                     GETL:
0013CC 53CC DDE5            15      PUSH    IX
0013CE 53CE FDE5            15      PUSH    IY
                                
0013D0 53D0 2ADCF3          16      LD  HL,(CSRY)
0013D3 53D3 22CAFB          16      LD  (FSTPOS),HL
       53D6                     GETL1:
0013D6 53D6 CD4D53          17      CALL    _SYS08
0013D9 53D9 FE09             7      CP  9
0013DB 53DB 2008            12      JR  NZ,GETL1V
0013DD 53DD 211FF4          10      LD  HL,KBUF
0013E0 53E0 CD6B43          17      CALL    MSX
0013E3 53E3 18F1            12      JR  GETL1
       53E5                     GETL1V:
0013E5 53E5 5F               4      LD  E,A
0013E6 53E6 FE08             7      CP  8
0013E8 53E8 CC8254          17      CALL    Z,CTRL02
0013EB 53EB FE20             7      CP  020H
0013ED 53ED D4AE54          17      CALL    NC,INSERT
0013F0 53F0 CD1653          17      CALL    MSGA1
                                
0013F3 53F3 7B               4      LD  A,E
0013F4 53F4 FE0D             7      CP  00DH
0013F6 53F6 20DE            12      JR  NZ,GETL1
                                
0013F8 53F8 111FF4          10      LD  DE,KBUF
0013FB 53FB 3AB0F3          13      LD  A,(LINLEN)
0013FE 53FE 47               4      LD  B,A
0013FF 53FF CD9156          17      CALL    ZERO_MEMORY_DE
                                
001402 5402 2ACAFB          16      LD  HL,(FSTPOS)
001405 5405 3ADCF3          13      LD  A,(CSRY)
001408 5408 6F               4      LD  L,A
001409 5409 E5              11      PUSH    HL
00140A 540A CDDF54          17      CALL    LOC0
00140D 540D 4D               4      LD  C,L
00140E 540E 44               4      LD  B,H
00140F 540F E1              10      POP HL
001410 5410 3AB0F3          13      LD  A,(LINLEN)
001413 5413 94               4      SUB H
001414 5414 3D               4      DEC A
001415 5415 5F               4      LD  E,A
001416 5416 211FF4          10      LD  HL,KBUF
       5419                     GETL2:
001419 5419 CD7254          17      CALL    _SCRN
00141C 541C 03               6      INC BC
00141D 541D 77               7      LD  (HL),A
00141E 541E 23               6      INC HL
00141F 541F 1D               4      DEC E
001420 5420 20F7            12      JR  NZ,GETL2
001422 5422 CD3353          17      CALL    MSG_CR
                                
001425 5425 FDE1            14      POP IY
001427 5427 DDE1            14      POP IX
       5429                     GETL3:
001429 5429 2B               6      DEC HL
00142A 542A 7E               7      LD  A,(HL)
00142B 542B FE21             7      CP  021H
00142D 542D D0              11      RET NC
00142E 542E 3600            10      LD  (HL),0
001430 5430 15               4      DEC D
001431 5431 20F6            12      JR  NZ,GETL3
001433 5433 C9              10      RET
                                
       5434                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       5434                     CONSTX:
       5434                     CPM_CONST:
001434 5434 C5              11      PUSH    BC
001435 5435 D5              11      PUSH    DE
001436 5436 E5              11      PUSH    HL
001437 5437 DDE5            15      PUSH    IX
001439 5439 DD219C00        14      LD  IX,CHSNS
00143D 543D CDD442          17      CALL    CALSLT_R
001440 5440 DDE1            14      POP IX
001442 5442 E1              10      POP HL
001443 5443 D1              10      POP DE
001444 5444 C1              10      POP BC
001445 5445 C9              10      RET
                                
       5446                     _SYS2A:     ;(BDOS)日付の獲得
001446 5446 AF               4      XOR A
001447 5447 57               4      LD  D,A
001448 5448 5F               4      LD  E,A
001449 5449 67               4      LD  H,A
00144A 544A 6F               4      LD  L,A
00144B 544B C9              10      RET
                                
       544C                     _SYS2C:     ;(BDOS)時刻の獲得
00144C 544C AF               4      XOR A
00144D 544D 57               4      LD  D,A
00144E 544E 5F               4      LD  E,A
00144F 544F 67               4      LD  H,A
001450 5450 6F               4      LD  L,A
001451 5451 C9              10      RET
                                
       5452                     POS:
001452 5452 F5              11      PUSH    AF
001453 5453 2ADCF3          16      LD  HL,(CSRY)
001456 5456 7D               4      LD  A,L
001457 5457 6C               4      LD  L,H
001458 5458 67               4      LD  H,A
001459 5459 2C               4      INC L
00145A 545A 24               4      INC H
00145B 545B F1              10      POP AF
00145C 545C C9              10      RET
                                
       545D                     LOC:
00145D 545D F5              11      PUSH    AF
00145E 545E E5              11      PUSH    HL
00145F 545F 7D               4      LD  A,L
001460 5460 6C               4      LD  L,H
001461 5461 67               4      LD  H,A
001462 5462 2D               4      DEC L
001463 5463 25               4      DEC H
001464 5464 DDE5            15      PUSH    IX
001466 5466 DD21C600        14      LD  IX,POSIT
00146A 546A CDD442          17      CALL    CALSLT_R
00146D 546D DDE1            14      POP IX
00146F 546F E1              10      POP HL
001470 5470 F1              10      POP AF
001471 5471 C9              10      RET
                                
       5472                     _SCRN:
       5472                     SCRN:
001472 5472 E5              11      PUSH    HL
001473 5473 DDE5            15      PUSH    IX
                                
001475 5475 69               4      LD  L,C
001476 5476 60               4      LD  H,B
001477 5477 DD214A00        14      LD  IX,RDVRM
00147B 547B CDD442          17      CALL    CALSLT_R
                                
00147E 547E DDE1            14      POP IX
001480 5480 E1              10      POP HL
001481 5481 C9              10      RET
                                
       5482                     CTRL02:
001482 5482 F5              11      PUSH    AF
001483 5483 D5              11      PUSH    DE
001484 5484 2ADCF3          16      LD  HL,(CSRY)
001487 5487 3AB0F3          13      LD  A,(LINLEN)
00148A 548A 4F               4      LD  C,A
00148B 548B 94               4      SUB H   ;CSRX
00148C 548C C602             7      ADD A,2
00148E 548E 47               4      LD  B,A ;カーソルより右の文字数
00148F 548F 61               4      LD  H,C ;LINLEN
001490 5490 C5              11      PUSH    BC
001491 5491 CDDF54          17      CALL    LOC0
001494 5494 C1              10      POP BC
                                
001495 5495 1620             7      LD  D,020H
       5497                     C8X1:
001497 5497 DD214A00        14      LD  IX,RDVRM
00149B 549B CDD442          17      CALL    CALSLT_R
00149E 549E 4F               4      LD  C,A
00149F 549F 7A               4      LD  A,D
0014A0 54A0 DD214D00        14      LD  IX,WRTVRM
0014A4 54A4 CDD442          17      CALL    CALSLT_R
0014A7 54A7 2B               6      DEC HL
0014A8 54A8 51               4      LD  D,C
0014A9 54A9 10EC            13      DJNZ    C8X1
0014AB 54AB D1              10      POP DE
0014AC 54AC F1              10      POP AF
0014AD 54AD C9              10      RET
                                
       54AE                     INSERT:
0014AE 54AE F5              11      PUSH    AF
0014AF 54AF D5              11      PUSH    DE
0014B0 54B0 2ADCF3          16      LD  HL,(CSRY)
0014B3 54B3 3AB0F3          13      LD  A,(LINLEN)
0014B6 54B6 4F               4      LD  C,A
0014B7 54B7 94               4      SUB H   ;CSRX
0014B8 54B8 3C               4      INC A
0014B9 54B9 47               4      LD  B,A ;カーソルより右の文字数
0014BA 54BA C5              11      PUSH    BC
0014BB 54BB CDDF54          17      CALL    LOC0
0014BE 54BE C1              10      POP BC
                                
0014BF 54BF 1620             7      LD  D,020H
       54C1                     INS1:
0014C1 54C1 DD214A00        14      LD  IX,RDVRM
0014C5 54C5 CDD442          17      CALL    CALSLT_R
0014C8 54C8 4F               4      LD  C,A
0014C9 54C9 7A               4      LD  A,D
0014CA 54CA DD214D00        14      LD  IX,WRTVRM
0014CE 54CE CDD442          17      CALL    CALSLT_R
0014D1 54D1 23               6      INC HL
0014D2 54D2 51               4      LD  D,C
0014D3 54D3 10EC            13      DJNZ    INS1
0014D5 54D5 D1              10      POP DE
0014D6 54D6 F1              10      POP AF
0014D7 54D7 C9              10      RET
                                
       54D8                     CONOUT1:
0014D8 54D8 59               4      LD  E,C
0014D9 54D9 C30C53          10      JP  _PRINT
                                
       54DC                     GETVRAM:
0014DC 54DC 2ADCF3          16      LD  HL,(CSRY)
       54DF                     LOC0:
0014DF 54DF 2D               4      DEC L
0014E0 54E0 25               4      DEC H
0014E1 54E1 4C               4      LD  C,H ;CSRX-1
0014E2 54E2 5D               4      LD  E,L ;CSRY-1
       54E3                     LOC1:
0014E3 54E3 3AB0F3          13      LD  A,(LINLEN)
0014E6 54E6 67               4      LD  H,A
0014E7 54E7 1600             7      LD  D,0
0014E9 54E9 6A               4      LD  L,D ;0
0014EA 54EA 0608             7      LD  B,8
       54EC                     LOC2:
0014EC 54EC 29              11      ADD HL,HL
0014ED 54ED 3001            12      JR  NC,LOC3
0014EF 54EF 19              11      ADD HL,DE
       54F0                     LOC3:
0014F0 54F0 10FA            13      DJNZ    LOC2
0014F2 54F2 09              11      ADD HL,BC
0014F3 54F3 C9              10      RET
                                
       54F4                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0014F4 54F4 212200          10      LD  HL,00022H
0014F7 54F7 AF               4      XOR A
0014F8 54F8 7D               4      LD  A,L
0014F9 54F9 C9              10      RET
                                
       54FA                     _SYS0D:     ;(BDOS)ディスク・リセット
0014FA 54FA 218000          10      LD  HL,00080H
0014FD 54FD 22D4F2          16      LD  (_DTA),HL
001500 5500 C9              10      RET
                                
       5501                     _SYS0E:     ;(BDOS)カレントドライブの設定
001501 5501 7B               4      LD  A,E
       5502                     _SYS0EX1:
001502 5502 FE08             7      CP  8
001504 5504 3F               4      CCF
001505 5505 D8              11      RET C
001506 5506 32EAF2          13      LD  (_DVSW),A
001509 5509 C9              10      RET
                                
       550A                     _SYS0F:     ;(BDOS)ファイルのオープン
00150A 550A D5              11      PUSH    DE
00150B 550B FDE1            14      POP IY
00150D 550D CD7856          17      CALL    INIT_FILE
001510 5510 CDB74B          17      CALL    ROM_OPEN
001513 5513 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
001515 5515 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
001519 5519 FDE5            15      PUSH    IY
00151B 551B D1              10      POP DE
00151C 551C 13               6      INC DE
00151D 551D 010B00          10      LD  BC,11
001520 5520 EDB0                    LDIR
                                ;               Attribute
001522 5522 7E               7      LD  A,(HL)
001523 5523 FD770D          19      LD  (IY+13),A
                                ;               TIME
001526 5526 110B00          10      LD  DE,11
001529 5529 19              11      ADD HL,DE
00152A 552A 7E               7      LD  A,(HL)
00152B 552B 23               6      INC HL
00152C 552C FD7716          19      LD  (IY+22),A
00152F 552F 7E               7      LD  A,(HL)
001530 5530 23               6      INC HL
001531 5531 FD7717          19      LD  (IY+23),A
                                ;               DATE
001534 5534 7E               7      LD  A,(HL)
001535 5535 23               6      INC HL
001536 5536 FD7714          19      LD  (IY+20),A
001539 5539 7E               7      LD  A,(HL)
00153A 553A 23               6      INC HL
00153B 553B FD7715          19      LD  (IY+21),A
                                ;               First cluster
00153E 553E 7E               7      LD  A,(HL)
00153F 553F 23               6      INC HL
001540 5540 FD771A          19      LD  (IY+26),A
001543 5543 7E               7      LD  A,(HL)
001544 5544 23               6      INC HL
001545 5545 FD771B          19      LD  (IY+27),A
                                ;               SIZE
001548 5548 7E               7      LD  A,(HL)
001549 5549 23               6      INC HL
00154A 554A FD7710          19      LD  (IY+16),A
00154D 554D 7E               7      LD  A,(HL)
00154E 554E 23               6      INC HL
00154F 554F FD7711          19      LD  (IY+17),A
001552 5552 7E               7      LD  A,(HL)
001553 5553 23               6      INC HL
001554 5554 FD7712          19      LD  (IY+18),A
001557 5557 7E               7      LD  A,(HL)
001558 5558 FD7713          19      LD  (IY+19),A
00155B 555B AF               4      XOR A
00155C 555C FD770C          19      LD  (IY+12),A
00155F 555F C9              10      RET
                                
       5560                     _SYS10:     ;(BDOS)ファイルのクローズ
001560 5560 AF               4      XOR A
001561 5561 C9              10      RET
                                
       5562                     S11X1:
001562 5562 FD7119          19      LD  (IY+25),C       ;RootEntCnt
001565 5565 FD750E          19      LD  (IY+14),L
001568 5568 FD740F          19      LD  (IY+15),H
       556B                     SCF_FF_RET:
00156B 556B 37               4      SCF
00156C 556C 9F               4      SBC A,A
00156D 556D C9              10      RET
                                
       556E                     _SYS11:     ;(BDOS)最初のファイルの検索
00156E 556E ED53D7F2        20      LD  (_FCB),DE
001572 5572 D5              11      PUSH    DE
001573 5573 FDE1            14      POP IY
001575 5575 CD7856          17      CALL    INIT_FILE
001578 5578 CD154E          17      CALL    GET_DIR_DAT
       557B                     S12X1:
00157B 557B CDD34B          17      CALL    FILESE
00157E 557E 30E2            12      JR  NC,S11X1
001580 5580 0D               4      DEC C
001581 5581 FD7119          19      LD  (IY+25),C       ;RootEntCnt
001584 5584 FDCB0D66        20      BIT 4,(IY+13)
001588 5588 2809            12      JR  Z,S12X2
00158A 558A E5              11      PUSH    HL
00158B 558B DDE1            14      POP IX
00158D 558D DDCB0E66        20      BIT 4,(IX+1+13)
001591 5591 28E8            12      JR  Z,S12X1
       5593                     S12X2:
001593 5593 012000          10      LD  BC,32
001596 5596 ED5BD4F2        20      LD  DE,(_DTA)
00159A 559A AF               4      XOR A
00159B 559B 12               7      LD  (DE),A      ;ドライブ番号
00159C 559C 13               6      INC DE
00159D 559D EDB0                    LDIR            ;ディレクトリエントリ
00159F 559F FD750E          19      LD  (IY+14),L
0015A2 55A2 FD740F          19      LD  (IY+15),H
0015A5 55A5 C9              10      RET
                                
       55A6                     _SYS12:
0015A6 55A6 FD2AD7F2        20      LD  IY,(_FCB)
0015AA 55AA FDE5            15      PUSH    IY
0015AC 55AC D1              10      POP DE
0015AD 55AD CD7856          17      CALL    INIT_FILE
                                
0015B0 55B0 FD6E0E          19      LD  L,(IY+14)
0015B3 55B3 FD660F          19      LD  H,(IY+15)
0015B6 55B6 FD4E19          19      LD  C,(IY+25)
0015B9 55B9 18C0            12      JR  S12X1
                                
       55BB                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0015BB 55BB CDFB4D          17      CALL    SET_FCB
0015BE 55BE CDC94D          17      CALL    GETSEQ
0015C1 55C1 CDB64D          17      CALL    RB_READ
0015C4 55C4 E5              11      PUSH    HL
0015C5 55C5 CDD64D          17      CALL    SETSEQ
0015C8 55C8 E1              10      POP HL
       55C9                     SREAD:
0015C9 55C9 C601             7      ADD A,001H
0015CB 55CB D8              11      RET C
                                
0015CC 55CC 7D               4      LD  A,L
0015CD 55CD D601             7      SUB 001H
0015CF 55CF 9F               4      SBC A,A
0015D0 55D0 E603             7      AND 3
0015D2 55D2 1F               4      RRA
0015D3 55D3 C9              10      RET
                                
       55D4                     _SYS18:     ;(BDOS)ログインベクトルの獲得
0015D4 55D4 210100          10      LD  HL,00001H
0015D7 55D7 AF               4      XOR A
0015D8 55D8 C9              10      RET
                                
       55D9                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
0015D9 55D9 3AEAF2          13      LD  A,(_DVSW)
0015DC 55DC C9              10      RET
                                
       55DD                     _SYS1A:     ;(BDOS)DTAの設定
0015DD 55DD ED53D4F2        20      LD  (_DTA),DE
0015E1 55E1 AF               4      XOR A
0015E2 55E2 C9              10      RET
                                
       55E3                     _SYS1B:     ;(BDOS)ディスク情報の獲得
0015E3 55E3 010002          10      LD  BC,512
0015E6 55E6 11C302          10      LD  DE,707
0015E9 55E9 210000          10      LD  HL,0
0015EC 55EC DD21D9F2        14      LD  IX,_BUF
0015F0 55F0 FD21D9F2        14      LD  IY,_BUF
0015F4 55F4 FD3600F9        19      LD  (IY+0),0F9H
0015F8 55F8 3E02             7      LD  A,2
0015FA 55FA C9              10      RET
                                
       55FB                     _SYS21:     ;(BDOS)ランダムな読み出し
0015FB 55FB CDFB4D          17      CALL    SET_FCB
                                
0015FE 55FE FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001601 5601 FD6622          19      LD  H,(IY+34)
                                
001604 5604 CDB64D          17      CALL    RB_READ
001607 5607 18C0            12      JR  SREAD
                                
       5609                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
001609 5609 CD0A55          17      CALL    _SYS0F
00160C 560C D8              11      RET C
                                
00160D 560D D5              11      PUSH    DE      ;EX DE,IY
00160E 560E FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001610 5610 CDEB4D          17      CALL    GETSIZE
       5613                     _S24X1:
001613 5613 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001616 5616 FD7422          19      LD  (IY+34),H
001619 5619 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
00161D 561D FDE3            23      EX  (SP),IY     ;
00161F 561F D1              10      POP DE      ;
                                
001620 5620 AF               4      XOR A
001621 5621 C9              10      RET
                                
       5622                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
001622 5622 E5              11      PUSH    HL
001623 5623 D5              11      PUSH    DE      ;EX DE,IY
001624 5624 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001626 5626 CDC94D          17      CALL    GETSEQ
001629 5629 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       562B                     _SYS27:     ;(BDOS)ランダムブロック読み込み
00162B 562B CDFB4D          17      CALL    SET_FCB
00162E 562E E5              11      PUSH    HL
00162F 562F FD6E21          19      LD  L,(IY+33)
001632 5632 FD6622          19      LD  H,(IY+34)
001635 5635 22CAF2          16      LD  (RR_LOW),HL
001638 5638 FD6E23          19      LD  L,(IY+35)
00163B 563B FD6624          19      LD  H,(IY+36)
00163E 563E 22CCF2          16      LD  (RR_HIGH),HL
001641 5641 E1              10      POP HL
001642 5642 CD9749          17      CALL    ROM_READ
001645 5645 ED5BCAF2        20      LD  DE,(RR_LOW)
001649 5649 FD7321          19      LD  (IY+33),E
00164C 564C FD7222          19      LD  (IY+34),D
00164F 564F ED5BCCF2        20      LD  DE,(RR_HIGH)
001653 5653 FD7323          19      LD  (IY+35),E
001656 5656 FD7224          19      LD  (IY+36),D
001659 5659 9F               4      SBC A,A
00165A 565A C9              10      RET
                                
       565B                     _SYS2F:
00165B 565B 44               4      LD  B,H
00165C 565C 2AD4F2          16      LD  HL,(_DTA)
00165F 565F C3D150          10      JP  DISKIO
                                
       5662                     _SYS5A:
001662 5662 0600             7      LD  B,0
001664 5664 D5              11      PUSH    DE
001665 5665 DDE1            14      POP IX
       5667                     _SX5A1:
001667 5667 1A               7      LD  A,(DE)
001668 5668 B7               4      OR  A
001669 5669 2804            12      JR  Z,_SX5A2
00166B 566B 13               6      INC DE
00166C 566C 04               4      INC B
00166D 566D 18F8            12      JR  _SX5A1
                                
       566F                     _SX5A2:
00166F 566F 78               4      LD  A,B
001670 5670 CD624A          17      CALL    FILE_BDOS
001673 5673 CDB84E          17      CALL    ROM_CD
001676 5676 9F               4      SBC A,A
001677 5677 C9              10      RET
                                
       5678                     INIT_FILE:
001678 5678 EB               4      EX  DE,HL
001679 5679 11F8F2          10      LD  DE,FDRV
00167C 567C 010C00          10      LD  BC,1+8+3
       567F                     INIT_FILE1:
00167F 567F EDB0                    LDIR
001681 5681 CD9952          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
001684 5684 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
001687 5687 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
00168A 568A 2AEBF2          16      LD  HL,(_CD)
00168D 568D 22F6F2          16      LD  (_CDX),HL           ;カレントディレクトリ
001690 5690 C9              10      RET
                                
       5691                     ZERO_MEMORY_DE:
001691 5691 AF               4      XOR A
       5692                     FILL_MEMORY_DE:
001692 5692 12               7      LD  (DE),A
001693 5693 13               6      INC DE
001694 5694 10FC            13      DJNZ    FILL_MEMORY_DE
001696 5696 C9              10      RET
                                
001697 5697                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 F9520F534053F952        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 F952F95245538653        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 4D53F952A0533454        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 F454FA5401550A55        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 60556E55A655F952        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 BB55F952F952F952        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 D455D955DD55E355        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 F952F952F9520956        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 2256F952F9522B56        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 F952F9524654F952        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 4C54F952F9525B56        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 F952F9526256F952        DW  _ERROR,_ERROR,_SYS5A,_ERROR
001FB8 5FB8 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 F952F952F952F952        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
