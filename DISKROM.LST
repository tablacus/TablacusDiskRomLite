                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       0138                     RSLREG  EQU 00138H
                                
       406F                     ERRHAND EQU 0406FH
       42B2                     CRUNCH  EQU 042B2H
       4C64                     FRMEVL  EQU 04C64H
                                
       F331                     H_BDOS  EQU 0F331H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F676                     TXTTAB  EQU 0F676H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
                                ;PTRFIL EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
                                ;FILNAM EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
                                ;RSTMP  EQU 0FB03H
       FB21                     DRVTBL  EQU 0FB21H
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCBE                     RUNBNF  EQU 0FCBEH
                                ;SAVENT EQU 0FCBFH
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FEDA                     H_STKE  EQU 0FEDAH
                                
       FF43                     H_GONE  EQU 0FF43H
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                
       F300                     ISC EQU 0F300H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       6200                     _FATBF  EQU BANK1_ADR+512       ;FATの先頭
                                
       F349                     DTAX    EQU 0F349H
       F34B                     B_DRIVE EQU DTAX+2
       F34C                     _DVSW   EQU B_DRIVE+1
       F34D                     FCBX    EQU _DVSW+1
       F34F                     LEFTX   EQU FCBX+2
       F351                     PARAM0  EQU LEFTX+2
       F353                     PARAM1  EQU PARAM0+2
       F355                     FDRV    EQU PARAM1+2
       F356                     FNAME   EQU FDRV+1
                                
       F7F8                     DACDAT  EQU DAC+2
[EOF:DEF.ASM:UTF_8]
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C3EB49          10      JP  DISKIO
000013 4013 C31A4A          10      JP  DSKCHG
000016 4016 C3704A          10      JP  GETDPB
000019 4019 C3584B          10      JP  CHOICE
00001C 401C C35C4B          10      JP  DSKFMT
00001F 401F C35E4B          10      JP  DSKSTP
                                ;   JP  BASENT
                                ;   SCF
                                ;   JP  DSKFMT
                                ;   JP  DSKSTP
                                ;   NOP
                                ;   JP  GETSLT
                                ;   LD  HL,(0F34BH)
                                ;   RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.1.0.0",0
            204449534B20524F    
            4D204C6974652076    
            302E312E302E3000    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 2100F3          10      LD  HL,ISC
000103 4103 224AFC          16      LD  (HIMEM),HL
                                
000106 4106 3EFF             7      LD  A,0FFH
000108 4108 3299FD          13      LD  (DEVICE),A
                                
00010B 410B 3E01             7      LD  A,1
00010D 410D 3221FB          13      LD  (DRVTBL),A
                                
000110 4110 AF               4      XOR A
000111 4111 324CF3          13      LD  (_DVSW),A
                                
000114 4114 215E42          10      LD  HL,AT_ISC
000117 4117 1100F3          10      LD  DE,ISC
00011A 411A 013F00          10      LD  BC,ISC_E-ISC
00011D 411D EDB0                    LDIR
                                
00011F 411F 3EC3             7      LD  A,0C3H      ;JP
000121 4121 3243FF          13      LD  (H_GONE),A
000124 4124 327DF3          13      LD  (BDOS),A
000127 4127 2100F3          10      LD  HL,ISC
00012A 412A 2244FF          16      LD  (H_GONE+1),HL
00012D 412D 2131F3          10      LD  HL,H_BDOS
000130 4130 227EF3          16      LD  (BDOS+1),HL
                                
000133 4133 3E                      DB  03EH
000134 4134 F7              12      RST 30H
000135 4135 3271FE          13      LD  (H_BINS),A
000138 4138 3276FE          13      LD  (H_BINL),A
00013B 413B 327BFE          13      LD  (H_FILE),A
                                ;   LD  (H_BDOS),A
00013E 413E 32DAFE          13      LD  (H_STKE),A
000141 4141 32A7FF          13      LD  (H_PHYD),A
                                
000144 4144 CD0D42          17      CALL    GTSL1_
000147 4147 3213F3          13      LD  (ROM_SLT),A
00014A 414A 3272FE          13      LD  (H_BINS+1),A
00014D 414D 3277FE          13      LD  (H_BINL+1),A
000150 4150 327CFE          13      LD  (H_FILE+1),A
000153 4153 3232F3          13      LD  (H_BDOS+1),A
000156 4156 32DBFE          13      LD  (H_STKE+1),A
000159 4159 32A8FF          13      LD  (H_PHYD+1),A
00015C 415C 3222FB          13      LD  (DRVTBL+1),A
00015F 415F 3248F3          13      LD  (MASTERS),A
                                
000162 4162 213E44          10      LD  HL,ROM_LOAD
000165 4165 2273FE          16      LD  (H_BINS+2),HL
000168 4168 215645          10      LD  HL,ROM_RUN
00016B 416B 2278FE          16      LD  (H_BINL+2),HL
00016E 416E 216345          10      LD  HL,ROM_FILES
000171 4171 227DFE          16      LD  (H_FILE+2),HL
                                ;   LD  HL,ROM_BDOS
                                ;   LD  (H_BDOS+2),HL
000174 4174 21D842          10      LD  HL,ROM_STKE
000177 4177 22DCFE          16      LD  (H_STKE+2),HL
00017A 417A 21EB49          10      LD  HL,DISKIO
00017D 417D 22A9FF          16      LD  (H_PHYD+2),HL
                                
000180 4180 3E                      DB  03EH
000181 4181 C9              10      RET
000182 4182 327FFE          13      LD  (H_FILE+4),A
000185 4185 3275FE          13      LD  (H_BINS+4),A
000188 4188 327AFE          13      LD  (H_BINL+4),A
                                ;   LD  (H_BDOS+4),A
00018B 418B 32DEFE          13      LD  (H_STKE+4),A
00018E 418E 32ABFF          13      LD  (H_PHYD+4),A
                                
000191 4191 AF               4      XOR A
000192 4192 320068          13      LD  (BANK1_SEL),A
000195 4195 3A0060          13      LD  A,(BANK1_ADR)
000198 4198 FE41             7      CP  'A'
00019A 419A 2060            12      JR  NZ,NOT_8K_BANK
00019C 419C 3E01             7      LD  A,DISK_BANK
00019E 419E 320068          13      LD  (BANK1_SEL),A
                                
0001A1 41A1 CD3801          17      CALL    RSLREG      ;read primary slot #
0001A4 41A4 07               4      RLCA
0001A5 41A5 07               4      RLCA
0001A6 41A6 F5              11      PUSH    AF
0001A7 41A7 CD1242          17      CALL    GTSL2_
0001AA 41AA 3244F3          13      LD  (RAMAD3),A
0001AD 41AD F1              10      POP AF  
0001AE 41AE CD1242          17      CALL    GTSL2_
0001B1 41B1 3243F3          13      LD  (RAMAD2),A
0001B4 41B4 3242F3          13      LD  (RAMAD1),A
0001B7 41B7 3241F3          13      LD  (RAMAD0),A
                                
0001BA 41BA 3A43F3          13      LD  A,(RAMAD2)
0001BD 41BD 210080          10      LD  HL,08000H
0001C0 41C0 CD2942          17      CALL    CHK_RAM
0001C3 41C3 2804            12      JR  Z,RAMCHK2
0001C5 41C5 AF               4      XOR A
0001C6 41C6 3243F3          13      LD  (RAMAD2),A
       41C9                     RAMCHK2:
0001C9 41C9 3A42F3          13      LD  A,(RAMAD1)
0001CC 41CC 210040          10      LD  HL,04000H
0001CF 41CF CD2942          17      CALL    CHK_RAM
0001D2 41D2 2804            12      JR  Z,RAMCHK1
0001D4 41D4 AF               4      XOR A
0001D5 41D5 3242F3          13      LD  (RAMAD1),A
       41D8                     RAMCHK1:
0001D8 41D8 3A41F3          13      LD  A,(RAMAD0)
0001DB 41DB 210000          10      LD  HL,00000H
0001DE 41DE CD2942          17      CALL    CHK_RAM
0001E1 41E1 2804            12      JR  Z,RAMCHK0
0001E3 41E3 AF               4      XOR A
0001E4 41E4 3241F3          13      LD  (RAMAD0),A
       41E7                     RAMCHK0:
0001E7 41E7 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
0001EA 41EA 010F00          10      LD  BC,0000FH       ;切り上げ
0001ED 41ED 09              11      ADD HL,BC
0001EE 41EE 7D               4      LD  A,L
                                
0001EF 41EF 0604             7      LD  B,4
       41F1                     B_DRIVE1:
0001F1 41F1 CB3C             8      SRL H
0001F3 41F3 1F               4      RRA
0001F4 41F4 10FB            13      DJNZ    B_DRIVE1
                                
0001F6 41F6 C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
0001F8 41F8 324BF3          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
0001FB 41FB C9              10      RET
                                
       41FC                     NOT_8K_BANK:
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K等)
0001FC 41FC 210743          10      LD  HL,MSG_ERROR_ROM_MODE
0001FF 41FF CDA042          17      CALL    MSX
000202 4202 FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
000206 4206 DD219F00        14      LD  IX,CHGET
00020A 420A C31C00          10      JP  _CALSLT
                                
       420D                     GTSL1_:             ;自分のいるスロットを知る
00020D 420D CD3801          17      CALL    RSLREG      ;read primary slot #
000210 4210 0F               4      RRCA
000211 4211 0F               4      RRCA
       4212                     GTSL2_:
000212 4212 E603             7      AND 3       ;[A]=000000PP
000214 4214 5F               4      LD  E,A     ;[E]=000000PP
000215 4215 21C1FC          10      LD  HL,EXPTBL
000218 4218 85               4      ADD A,L     ;桁上りは無い
000219 4219 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
00021A 421A 7B               4      LD  A,E     ;[A]=000000PP
00021B 421B CB7E            13      BIT 7,(HL)
00021D 421D C8              11      RET Z
00021E 421E 7D               4      LD  A,L     ;point to SLTTBL entry
00021F 421F C604             7      ADD A,4     ;桁上りは無い
000221 4221 6F               4      LD  L,A
000222 4222 7E               7      LD  A,(HL)      ;get currently expansion slot register
000223 4223 E60C             7      AND 00CH        ;[A] = 0000SS00
000225 4225 B3               4      OR  E       ;[A] = 0000SSPP
000226 4226 F680             7      OR  080H        ;[A] = 1000SSPP
000228 4228 C9              10      RET
       4229                     GTSL1_E:
                                
       4229                     CHK_RAM:
000229 4229 4F               4      LD  C,A
00022A 422A DD210C00        14      LD  IX,_RDSLT
00022E 422E CD5242          17      CALL    CALSLT_R
000231 4231 2F               4      CPL
000232 4232 47               4      LD  B,A
000233 4233 5F               4      LD  E,A
000234 4234 79               4      LD  A,C
000235 4235 DD211400        14      LD  IX,_WRSLT
000239 4239 CD5242          17      CALL    CALSLT_R
00023C 423C 79               4      LD  A,C
00023D 423D DD210C00        14      LD  IX,_RDSLT
000241 4241 CD5242          17      CALL    CALSLT_R
000244 4244 B8               4      CP  B
000245 4245 C0              11      RET NZ
000246 4246 2F               4      CPL
000247 4247 79               4      LD  A,C
000248 4248 5F               4      LD  E,A
000249 4249 DD211400        14      LD  IX,_WRSLT
00024D 424D CD5242          17      CALL    CALSLT_R
000250 4250 AF               4      XOR A
000251 4251 C9              10      RET
       4252                     CALSLT_R:
000252 4252 C5              11      PUSH    BC
000253 4253 E5              11      PUSH    HL
000254 4254 FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
000258 4258 CD1C00          17      CALL    _CALSLT
00025B 425B E1              10      POP HL
00025C 425C C1              10      POP BC
00025D 425D C9              10      RET
                                
       425E                     AT_ISC:
00025E F300                         ORG ISC,AT_ISC-RUN
00025E F300 FEB7             7      CP  0B7H            ;FILES
000260 F302 CC7BFE          17      CALL    Z,H_FILE
000263 F305 FEB5             7      CP  0B5H            ;LOAD
000265 F307 CA71FE          10      JP  Z,H_BINS
000268 F30A FE8A             7      CP  08AH            ;RUN
00026A F30C CA76FE          10      JP  Z,H_BINL
00026D F30F FECF             7      CP  0CFH            ;BLOAD
00026F F311 C0              11      RET NZ
       F312                     FIX_BLOAD:
000270 F312 F7              12      RST 30H
       F313                     ROM_SLT:
000271 F313 00                      DB  0
000272 F314 9B44                    DW  ROM_BLOAD
000274 F316 F5              11      PUSH    AF
000275 F317 E5              11      PUSH    HL
000276 F318 CD21F3          17      CALL    BLOAD_RET
       F319                     SWC_BLOAD   EQU $-2
000279 F31B E1              10      POP HL
00027A F31C F1              10      POP AF
00027B F31D FECF             7      CP  0CFH            ;BLOAD
       F31F                     SWC_BLOAD_M:
00027D F31F 28DF            12      JR  Z,ISC
       F321                     BLOAD_RET:
00027F F321 C9              10      RET
                                
       F322                     _RESULT:
000280 F322 00                      DB  0
       F323                     _BANK:
000281 F323 00                      DB  0
       F324                     RR_LOW:
000282 F324 0000                    DW  0
       F325                     RR_MID  EQU $-1
       F326                     RR_HIGH:
000284 F326 0000                    DW  0
       F328                     _CLPS:
000286 F328 0000                    DW  0
       F32A                     _LEFT:
000288 F32A 0000                    DW  0
       F32C                     _DTPS:
00028A F32C 0000                    DW  0
       F32E                     _DTA:
00028C F32E 0000                    DW  0
       F330                     FLG_LDIR:
00028E F330 00                      DB  0
                                ;   BDOS
00028F F331 F7              12      RST 30H
000290 F332 00                      DB  0
000291 F333 8C4B                    DW  ROM_BDOS
000293 F335 C9              10      RET 
       F336                     _FCB:
000294 F336 0000                    DW  0
       F338                     _BUF:
000296 F338 00                      DB  0
       F339                     _BUF_ST:
000297 F339 0000                    DW  0
       F33B                     _BUF_EN:
000299 F33B 0000                    DW  0
       F33D                     _BUF_EX:
00029B F33D 0000                    DW  0
                                
       F33F                     ISC_E:
00029D 429D                         ORG $$+RUN          ;$DEPHASE
                                
       429D                     MSX1:
00029D 429D CDB242          17      CALL    MSGA1
       42A0                     MSX:
0002A0 42A0 7E               7      LD  A,(HL)
0002A1 42A1 23               6      INC HL
0002A2 42A2 B7               4      OR  A
0002A3 42A3 20F8            12      JR  NZ,MSX1
0002A5 42A5 C9              10      RET
                                
       42A6                     PRTHX:
0002A6 42A6 F5              11      PUSH    AF
0002A7 42A7 07               4      RLCA
0002A8 42A8 07               4      RLCA
0002A9 42A9 07               4      RLCA
0002AA 42AA 07               4      RLCA
0002AB 42AB CDAF42          17      CALL    PRTA2
0002AE 42AE F1              10      POP AF
       42AF                     PRTA2:
0002AF 42AF CDC642          17      CALL    ASC
       42B2                     MSG_A:
       42B2                     MSGA1:
0002B2 42B2 F5              11      PUSH    AF
0002B3 42B3 C5              11      PUSH    BC
0002B4 42B4 D5              11      PUSH    DE
0002B5 42B5 E5              11      PUSH    HL
0002B6 42B6 FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
0002BA 42BA DD21A200        14      LD  IX,CHPUT
0002BE 42BE CD1C00          17      CALL    _CALSLT
0002C1 42C1 E1              10      POP HL
0002C2 42C2 D1              10      POP DE
0002C3 42C3 C1              10      POP BC
       42C4                     MSGA2:
0002C4 42C4 F1              10      POP AF
0002C5 42C5 C9              10      RET
       42C6                     ASC:
0002C6 42C6 E60F             7      AND $0F
0002C8 42C8 F630             7      OR  $30
0002CA 42CA FE3A             7      CP  $3A
0002CC 42CC D8              11      RET C
0002CD 42CD C607             7      ADD A,7
0002CF 42CF C9              10      RET
                                
       42D0                     MSN:
0002D0 42D0 7E               7      LD  A,(HL)
0002D1 42D1 23               6      INC HL
0002D2 42D2 CDB242          17      CALL    MSG_A
0002D5 42D5 10F9            13      DJNZ    MSN
0002D7 42D7 C9              10      RET
                                
       42D8                     ROM_STKE:
0002D8 42D8 3E                      DB  03EH
0002D9 42D9 C9              10      RET
0002DA 42DA 32DAFE          13      LD  (H_STKE),A
0002DD 42DD E5              11      PUSH    HL
0002DE 42DE D5              11      PUSH    DE
0002DF 42DF C5              11      PUSH    BC
0002E0 42E0 212243          10      LD  HL,AUTOEXEC
0002E3 42E3 1155F3          10      LD  DE,FDRV
0002E6 42E6 010C00          10      LD  BC,1+8+3
0002E9 42E9 EDB0                    LDIR
0002EB 42EB CDB347          17      CALL    ROM_OPEN
0002EE 42EE 3813            12      JR  C,RSTKEE
0002F0 42F0 212E43          10      LD  HL,RUN_AUTOEXEC
0002F3 42F3 11F0FB          10      LD  DE,KEYBUF
0002F6 42F6 ED53FAF3        20      LD  (GETPNT),DE
0002FA 42FA 011300          10      LD  BC,RUN_AUTOEXEC_E-RUN_AUTOEXEC
0002FD 42FD EDB0                    LDIR
0002FF 42FF ED53F8F3        20      LD  (PUTPNT),DE
       4303                     RSTKEE:
000303 4303 C1              10      POP BC
000304 4304 D1              10      POP DE
000305 4305 E1              10      POP HL
000306 4306 C9              10      RET
                                
       4307                     MSG_ERROR_ROM_MODE:
000307 4307 41534349492D384B        DB  "ASCII-8K/Konami-8K only!",13,10
            2F4B6F6E616D692D    
            384B206F6E6C7921    
            0D0A                
       4321                     NULL:
000321 4321 00                      DB  0
                                
       4322                     AUTOEXEC:
000322 4322 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       432E                     RUN_AUTOEXEC:
00032E 432E 52554E2022415554        DB  'RUN "AUTOEXEC.BAS"',00DH
            4F455845432E4241    
            53220D              
                                ;   DB  'LOAD "AUTOEXEC.BAS"',00DH  ;テスト用
       4341                     RUN_AUTOEXEC_E:
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       4341                     ROM_LDIR:
000341 4341 3A30F3          13      LD  A,(FLG_LDIR)
000344 4344 B7               4      OR  A
000345 4345 2007            12      JR  NZ,ROM_LDIRVM
000347 4347 CB7A             8      BIT 7,D
000349 4349 2815            12      JR  Z,ROM_LDIRSLT
00034B 434B EDB0                    LDIR
00034D 434D C9              10      RET
                                
       434E                     ROM_LDIRVM:
00034E 434E C5              11      PUSH    BC
00034F 434F D5              11      PUSH    DE
000350 4350 FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
000354 4354 DD215C00        14      LD  IX,LDIRVM
000358 4358 CD1C00          17      CALL    _CALSLT
00035B 435B E1              10      POP HL
00035C 435C C1              10      POP BC
00035D 435D 09              11      ADD HL,BC
00035E 435E EB               4      EX  DE,HL
00035F 435F C9              10      RET
                                
       4360                     ROM_LDIRSLT:
000360 4360 EB               4      EX  DE,HL
       4361                     RLDIRSLT1:
000361 4361 1A               7      LD  A,(DE)
000362 4362 13               6      INC DE
000363 4363 C5              11      PUSH    BC
000364 4364 D5              11      PUSH    DE
000365 4365 E5              11      PUSH    HL
000366 4366 5F               4      LD  E,A
000367 4367 3A42F3          13      LD  A,(RAMAD1)
00036A 436A FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
00036E 436E DD211400        14      LD  IX,_WRSLT
000372 4372 CD1C00          17      CALL    _CALSLT
000375 4375 E1              10      POP HL
000376 4376 D1              10      POP DE
000377 4377 C1              10      POP BC
000378 4378 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00037A 437A EA6143          10      JP  PE,RLDIRSLT1
00037D 437D EB               4      EX  DE,HL
00037E 437E C9              10      RET
                                
       437F                     END_OF_LINE:
00037F 437F 215EF5          10      LD  HL,BUF
       4382                     EOL1:
000382 4382 7E               7      LD  A,(HL)
000383 4383 C8              11      RET Z
000384 4384 FE0D             7      CP  00DH
000386 4386 2807            12      JR  Z,EOLE
000388 4388 FE0A             7      CP  00AH
00038A 438A 2803            12      JR  Z,EOLE
00038C 438C 23               6      INC HL
00038D 438D 18F3            12      JR  EOL1
       438F                     EOLE:
00038F 438F 3600            10      LD  (HL),0
000391 4391 23               6      INC HL
000392 4392 7E               7      LD  A,(HL)
000393 4393 FE0A             7      CP  00AH
000395 4395 C0              11      RET NZ
000396 4396 23               6      INC HL
000397 4397 C9              10      RET
                                
       4398                     ROM_LOAD_ASCII:
000398 4398 210000          10      LD  HL,0
00039B 439B 2239F3          16      LD  (_BUF_ST),HL    ;読み出し位置
00039E 439E 2A76F6          16      LD  HL,(TXTTAB)
0003A1 43A1 223BF3          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
0003A4 43A4 215EF5          10      LD  HL,BUF
0003A7 43A7 222EF3          16      LD  (_DTA),HL
       43AA                     RLOAD_A1:
0003AA 43AA 2A39F3          16      LD  HL,(_BUF_ST)
0003AD 43AD 2224F3          16      LD  (RR_LOW),HL
0003B0 43B0 210201          10      LD  HL,258
0003B3 43B3 CDDE45          17      CALL    ROM_READ
0003B6 43B6 7C               4      LD  A,H
0003B7 43B7 B5               4      OR  L
0003B8 43B8 2877            12      JR  Z,RLOAD_AEND
0003BA 43BA 015EF5          10      LD  BC,BUF
0003BD 43BD 09              11      ADD HL,BC
0003BE 43BE 3600            10      LD  (HL),0
0003C0 43C0 CD7F43          17      CALL    END_OF_LINE
0003C3 43C3 015EF5          10      LD  BC,BUF
0003C6 43C6 A7               4      AND A
0003C7 43C7 ED42            15      SBC HL,BC
0003C9 43C9 2810            12      JR  Z,RLOAD_A2
0003CB 43CB 4D               4      LD  C,L
0003CC 43CC 44               4      LD  B,H
0003CD 43CD ED5B39F3        20      LD  DE,(_BUF_ST)
0003D1 43D1 19              11      ADD HL,DE
0003D2 43D2 2239F3          16      LD  (_BUF_ST),HL
0003D5 43D5 3A5EF5          13      LD  A,(BUF)
0003D8 43D8 B7               4      OR  A
0003D9 43D9 28CF            12      JR  Z,RLOAD_A1
       43DB                     RLOAD_A2:
0003DB 43DB 115EF5          10      LD  DE,BUF
0003DE 43DE CD4A47          17      CALL    SPCUTEX
0003E1 43E1 1A               7      LD  A,(DE)
0003E2 43E2 B7               4      OR  A
0003E3 43E3 284C            12      JR  Z,RLOAD_AEND
0003E5 43E5 CD5C47          17      CALL    GETNUM
0003E8 43E8 7C               4      LD  A,H
0003E9 43E9 B5               4      OR  L
0003EA 43EA CA8844          10      JP  Z,ERROR_DIRECT_IN_FILE
0003ED 43ED DD2A3BF3        20      LD  IX,(_BUF_EN)
0003F1 43F1 DD7502          19      LD  (IX+2),L
0003F4 43F4 DD7403          19      LD  (IX+3),H
                                
0003F7 43F7 CD4347          17      CALL    SPCUT
0003FA 43FA EB               4      EX  DE,HL
0003FB 43FB DDE5            15      PUSH    IX
0003FD 43FD DD21B242        14      LD  IX,CRUNCH
000401 4401 FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
000405 4405 CD1C00          17      CALL    _CALSLT
000408 4408 DDE1            14      POP IX
00040A 440A EB               4      EX  DE,HL
00040B 440B 111FF4          10      LD  DE,KBUF
00040E 440E 37               4      SCF
00040F 440F ED52            15      SBC HL,DE
000411 4411 2875            12      JR  Z,ERROR_DIRECT_IN_FILE
000413 4413 3873            12      JR  C,ERROR_DIRECT_IN_FILE
000415 4415 4D               4      LD  C,L
000416 4416 44               4      LD  B,H
000417 4417 2A3BF3          16      LD  HL,(_BUF_EN)
00041A 441A 110400          10      LD  DE,4
00041D 441D 19              11      ADD HL,DE
00041E 441E 111FF4          10      LD  DE,KBUF
                                
000421 4421 EB               4      EX  DE,HL
000422 4422 EDB0                    LDIR
000424 4424 EB               4      EX  DE,HL
                                
000425 4425 DD7500          19      LD  (IX+0),L
000428 4428 DD7401          19      LD  (IX+1),H
00042B 442B 223BF3          16      LD  (_BUF_EN),HL
00042E 442E C3AA43          10      JP  RLOAD_A1
                                
       4431                     RLOAD_AEND:
000431 4431 2A3BF3          16      LD  HL,(_BUF_EN)
000434 4434 AF               4      XOR A
000435 4435 77               7      LD  (HL),A
000436 4436 23               6      INC HL
000437 4437 77               7      LD  (HL),A
000438 4438 23               6      INC HL
000439 4439 223BF3          16      LD  (_BUF_EN),HL
00043C 443C 1833            12      JR  RLOAD_END1
                                
       443E                     ROM_LOAD:
00043E 443E CDB645          17      CALL    INIT_PARAM
000441 4441 CD7D46          17      CALL    FILE_B:
000444 4444 CDB347          17      CALL    ROM_OPEN
000447 4447 3845            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000449 4449 2138F3          10      LD  HL,_BUF
00044C 444C 222EF3          16      LD  (_DTA),HL
00044F 444F 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
000452 4452 CDDE45          17      CALL    ROM_READ
000455 4455 3A38F3          13      LD  A,(_BUF)
000458 4458 3C               4      INC A
000459 4459 C29843          10      JP  NZ,ROM_LOAD_ASCII
00045C 445C 2A76F6          16      LD  HL,(TXTTAB)
00045F 445F 222EF3          16      LD  (_DTA),HL
000462 4462 EB               4      EX  DE,HL
000463 4463 2100FF          10      LD  HL,-256
000466 4466 39              11      ADD HL,SP
000467 4467 ED52            15      SBC HL,DE
000469 4469 CDDE45          17      CALL    ROM_READ
00046C 446C ED5B2EF3        20      LD  DE,(_DTA)
000470 4470 19              11      ADD HL,DE
       4471                     RLOAD_END1:
000471 4471 22C2F6          16      LD  (VARTAB),HL
000474 4474 22C4F6          16      LD  (ARYTAB),HL
000477 4477 22C6F6          16      LD  (STREND),HL
                                
00047A 447A AF               4      XOR A
00047B 447B 213BF3          10      LD  HL,_BUF+3
00047E 447E 77               7      LD  (HL),A
00047F 447F 2B               6      DEC HL
000480 4480 77               7      LD  (HL),A
000481 4481 2B               6      DEC HL
000482 4482 77               7      LD  (HL),A
000483 4483 2B               6      DEC HL
000484 4484 3E8F             7      LD  A,08FH          ;REM
000486 4486 77               7      LD  (HL),A
000487 4487 C9              10      RET
                                
       4488                     ERROR_DIRECT_IN_FILE:
000488 4488 1E39             7      LD  E,57            ;Direct statement in file
00048A 448A 01                      DB  1           ;LD BC,
       448B                     ERROR_FILE_NOT_OPEN:
00048B 448B 1E3B             7      LD  E,59            ;File not OPEN
00048D 448D 01                      DB  1           ;LD BC,
       448E                     ERROR_FILE_NOT_FOUND:
00048E 448E 1E35             7      LD  E,53            ;File not found
       4490                     ERROR:
000490 4490 FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
000494 4494 DD216F40        14      LD  IX,ERRHAND
000498 4498 C31C00          10      JP  _CALSLT
                                
       449B                     ROM_BLOAD:
00049B 449B CDB645          17      CALL    INIT_PARAM
00049E 449E CD7D46          17      CALL    FILE_B
0004A1 44A1 CDB347          17      CALL    ROM_OPEN
0004A4 44A4 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
0004A6 44A6 2138F3          10      LD  HL,_BUF
0004A9 44A9 222EF3          16      LD  (_DTA),HL
0004AC 44AC 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
0004AF 44AF CDDE45          17      CALL    ROM_READ
0004B2 44B2 3A38F3          13      LD  A,(_BUF)
0004B5 44B5 FEFE             7      CP  0FEH
0004B7 44B7 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
0004B9 44B9 2121F3          10      LD  HL,BLOAD_RET
0004BC 44BC 2219F3          16      LD  (SWC_BLOAD),HL
                                
0004BF 44BF 2A53F3          16      LD  HL,(PARAM1)
0004C2 44C2 7E               7      LD  A,(HL)
0004C3 44C3 FE2C             7      CP  ','
0004C5 44C5 2048            12      JR  NZ,RBREAD_MEM
0004C7 44C7 23               6      INC HL
0004C8 44C8 7E               7      LD  A,(HL)
0004C9 44C9 CD9D47          17      CALL    CAP
0004CC 44CC 32BEFC          13      LD  (RUNBNF),A
       44CF                     RBOS1:
0004CF 44CF 7E               7      LD  A,(HL)
0004D0 44D0 23               6      INC HL
0004D1 44D1 B7               4      OR  A
0004D2 44D2 282F            12      JR  Z,RBREAD_OSE
0004D4 44D4 FE3A             7      CP  ':'
0004D6 44D6 282B            12      JR  Z,RBREAD_OSE
0004D8 44D8 FE2C             7      CP  ','     ;次のパラメータを探す
0004DA 44DA 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
0004DC 44DC 2253F3          16      LD  (PARAM1),HL
0004DF 44DF 7E               7      LD  A,(HL)
0004E0 44E0 B7               4      OR  A
0004E1 44E1 2820            12      JR  Z,RBREAD_OSE
0004E3 44E3 DD21644C        14      LD  IX,FRMEVL
0004E7 44E7 FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
0004EB 44EB CD1C00          17      CALL    _CALSLT
0004EE 44EE 2253F3          16      LD  (PARAM1),HL
0004F1 44F1 3A63F6          13      LD  A,(VALTYP)
0004F4 44F4 FE02             7      CP  2
0004F6 44F6 200B            12      JR  NZ,RBREAD_OSE
0004F8 44F8 2A39F3          16      LD  HL,(_BUF_ST)
0004FB 44FB ED5BF8F7        20      LD  DE,(DACDAT)
0004FF 44FF 19              11      ADD HL,DE
000500 4500 2239F3          16      LD  (_BUF_ST),HL
       4503                     RBREAD_OSE:
000503 4503 3ABEFC          13      LD  A,(RUNBNF)
000506 4506 FE53             7      CP  'S'
000508 4508 2005            12      JR  NZ,RBREAD_MEM
00050A 450A 3E01             7      LD  A,1
00050C 450C 3230F3          13      LD  (FLG_LDIR),A
       450F                     RBREAD_MEM:
00050F 450F 2A39F3          16      LD  HL,(_BUF_ST)
000512 4512 222EF3          16      LD  (_DTA),HL
000515 4515 21FFFF          10      LD  HL,0FFFFH
000518 4518 CDDE45          17      CALL    ROM_READ
00051B 451B 3ABEFC          13      LD  A,(RUNBNF)
00051E 451E FE52             7      CP  'R'
000520 4520 2006            12      JR  NZ,RBREAD1
000522 4522 2A3DF3          16      LD  HL,(_BUF_EX)
000525 4525 2219F3          16      LD  (SWC_BLOAD),HL
       4528                     RBREAD1:
       4528                     ROM_NEXT:
000528 4528 2A53F3          16      LD  HL,(PARAM1)
00052B 452B 7E               7      LD  A,(HL)
00052C 452C 2B               6      DEC HL
00052D 452D B7               4      OR  A
00052E 452E 2805            12      JR  Z,RN1
000530 4530 FE3A             7      CP  ':'
000532 4532 2801            12      JR  Z,RN1
000534 4534 23               6      INC HL
       4535                     RN1:
000535 4535 5D               4      LD  E,L
000536 4536 54               4      LD  D,H
                                
000537 4537 CD7347          17      CALL    SEARCH_END
00053A 453A B7               4      OR  A
00053B 453B 2815            12      JR  Z,REM
                                                    ;マルチステートメントの処理
00053D 453D 7E               7      LD  A,(HL)
                                
00053E 453E FEB5             7      CP  0B5H            ;LOAD
000540 4540 CA3E44          10      JP  Z,ROM_LOAD
000543 4543 FE8A             7      CP  08AH            ;RUN
000545 4545 280F            12      JR  Z,ROM_RUN
000547 4547 FEB7             7      CP  0B7H            ;FILES
000549 4549 2818            12      JR  Z,ROM_FILES
00054B 454B 3E28             7      LD  A,028H          ;JR Z,
00054D 454D 321FF3          13      LD  (SWC_BLOAD_M),A
000550 4550 7E               7      LD  A,(HL)
000551 4551 C9              10      RET
                                
       4552                     REM:
000552 4552 EB               4      EX  DE,HL
000553 4553 3E8F             7      LD  A,08FH          ;REM
000555 4555 C9              10      RET
                                
       4556                     ROM_RUN:
000556 4556 23               6      INC HL
000557 4557 7E               7      LD  A,(HL)
000558 4558 2B               6      DEC HL
000559 4559 B7               4      OR  A
00055A 455A 2803            12      JR  Z,ROM_RUN1
00055C 455C CD3E44          17      CALL    ROM_LOAD
       455F                     ROM_RUN1:
00055F 455F 3E8A             7      LD  A,08AH          ;RUN
000561 4561 77               7      LD  (HL),A
000562 4562 C9              10      RET
                                
       4563                     ROM_FILES:
000563 4563 CDB645          17      CALL    INIT_PARAM
000566 4566 CD7D46          17      CALL    FILE_B
000569 4569 CD634B          17      CALL    GET_DISK_BANK_FDRV
00056C 456C 320068          13      LD  (BANK1_SEL),A
00056F 456F 3A56F3          13      LD  A,(FNAME)
000572 4572 FE21             7      CP  021H
000574 4574 3005            12      JR  NC,RFILES0
000576 4576 060B             7      LD  B,11
000578 4578 CD0747          17      CALL    FILE10
       457B                     RFILES0:
00057B 457B CDBA49          17      CALL    GET_DIR_DAT
       457E                     RFILES1:
00057E 457E CDD247          17      CALL    FILESE
000581 4581 302E            12      JR  NC,RFILES_NOT_MATCH
       4583                     RFILES_DISP:
000583 4583 E5              11      PUSH    HL
000584 4584 0608             7      LD  B,8
000586 4586 CDD042          17      CALL    MSN
000589 4589 3E2E             7      LD  A,'.'
00058B 458B CDB242          17      CALL    MSG_A
00058E 458E 0603             7      LD  B,3
000590 4590 CDD042          17      CALL    MSN
000593 4593 3ADDF3          13      LD  A,(CSRX)
000596 4596 47               4      LD  B,A
000597 4597 3AB0F3          13      LD  A,(LINLEN)
00059A 459A 90               4      SUB B
00059B 459B FE0C             7      CP  12
00059D 459D 3009            12      JR  NC,RFILES2
00059F 459F 3E0D             7      LD  A,00DH      ;改行
0005A1 45A1 CDB242          17      CALL    MSG_A
0005A4 45A4 3E0A             7      LD  A,00AH
0005A6 45A6 1802            12      JR  RFILES3
       45A8                     RFILES2:
0005A8 45A8 3E20             7      LD  A,020H
       45AA                     RFILES3:
0005AA 45AA CDB242          17      CALL    MSG_A
0005AD 45AD E1              10      POP HL
0005AE 45AE CDEE47          17      CALL    FNEXT
       45B1                     RFILES_NOT_MATCH:
0005B1 45B1 20CB            12      JR  NZ,RFILES1
0005B3 45B3 C32845          10      JP  ROM_NEXT
                                
       45B6                     INIT_PARAM:
0005B6 45B6 2251F3          16      LD  (PARAM0),HL
0005B9 45B9 EB               4      EX  DE,HL
0005BA 45BA AF               4      XOR A
0005BB 45BB 3230F3          13      LD  (FLG_LDIR),A
0005BE 45BE 32BEFC          13      LD  (RUNBNF),A
0005C1 45C1 3263F6          13      LD  (VALTYP),A
0005C4 45C4 13               6      INC DE
0005C5 45C5 CD4347          17      CALL    SPCUT
0005C8 45C8 1A               7      LD  A,(DE)
0005C9 45C9 B7               4      OR  A
0005CA 45CA C8              11      RET Z
0005CB 45CB FE3A             7      CP  ':'
0005CD 45CD C8              11      RET Z
0005CE 45CE EB               4      EX  DE,HL
0005CF 45CF DD21644C        14      LD  IX,FRMEVL
0005D3 45D3 FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
0005D7 45D7 CD1C00          17      CALL    _CALSLT
0005DA 45DA 2253F3          16      LD  (PARAM1),HL
0005DD 45DD C9              10      RET
                                
       45DE                     ROM_READ:
0005DE 45DE E5              11      PUSH    HL
0005DF 45DF D5              11      PUSH    DE
0005E0 45E0 C5              11      PUSH    BC
0005E1 45E1 FDE5            15      PUSH    IY
0005E3 45E3 224FF3          16      LD  (LEFTX),HL
0005E6 45E6 2A2EF3          16      LD  HL,(_DTA)
0005E9 45E9 2249F3          16      LD  (DTAX),HL
0005EC 45EC 2A4FF3          16      LD  HL,(LEFTX)
                                
0005EF 45EF CD1A48          17      CALL    RBX1
0005F2 45F2 386F            12      JR  C,RBRERR1
0005F4 45F4 79               4      LD  A,C
0005F5 45F5 EB               4      EX  DE,HL
0005F6 45F6 ED52            15      SBC HL,DE       ;CP 0HL,CDE
0005F8 45F8 19              11      ADD HL,DE
0005F9 45F9 DE00             7      SBC A,000H
0005FB 45FB 3801            12      JR  C,RBR1
0005FD 45FD EB               4      EX  DE,HL
       45FE                     RBR1:
0005FE 45FE 9F               4      SBC A,A
0005FF 45FF E601             7      AND 1
000601 4601 3222F3          13      LD  (_RESULT),A
000604 4604 7C               4      LD  A,H
000605 4605 B5               4      OR  L
000606 4606 CA5946          10      JP  Z,RBREND0
                                
000609 4609 222AF3          16      LD  (_LEFT),HL  ;Read record byte
00060C 460C 224FF3          16      LD  (LEFTX),HL
                                
00060F 460F CD4348          17      CALL    RBX2
000612 4612 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000614 4614 CD5448          17      CALL    RBXA
000617 4617 DA6F46          10      JP  C,RBRERR
00061A 461A C5              11      PUSH    BC
00061B 461B CD4143          17      CALL    ROM_LDIR
00061E 461E ED5349F3        20      LD  (DTAX),DE
000622 4622 2A4FF3          16      LD  HL,(LEFTX)
000625 4625 D1              10      POP DE
000626 4626 A7               4      AND A
000627 4627 ED52            15      SBC HL,DE
000629 4629 224FF3          16      LD  (LEFTX),HL
00062C 462C 2828            12      JR  Z,RBREND
                                
       462E                     RBRB:
00062E 462E CD8D48          17      CALL    RBXB
000631 4631 2817            12      JR  Z,RBRC
       4633                     RBRB1:
000633 4633 C5              11      PUSH    BC
000634 4634 D5              11      PUSH    DE
000635 4635 CD2249          17      CALL    CLUST
000638 4638 EB               4      EX  DE,HL
000639 4639 010004          10      LD  BC,1024     ;1クラスタのサイズ
00063C 463C CD4143          17      CALL    ROM_LDIR
00063F 463F EB               4      EX  DE,HL
000640 4640 D1              10      POP DE
000641 4641 C1              10      POP BC
000642 4642 CDFF48          17      CALL    GNCL
000645 4645 DA6F46          10      JP  C,RBRERR
000648 4648 10E9            13      DJNZ    RBRB1
       464A                     RBRC:
00064A 464A CD9D48          17      CALL    RBXC
00064D 464D 2807            12      JR  Z,RBREND
                                
00064F 464F CD2249          17      CALL    CLUST
000652 4652 EB               4      EX  DE,HL
000653 4653 CD4143          17      CALL    ROM_LDIR
       4656                     RBREND:
000656 4656 CDA748          17      CALL    RBXEND
       4659                     RBREND0:
000659 4659 FDE1            14      POP IY
00065B 465B C1              10      POP BC
00065C 465C D1              10      POP DE
00065D 465D F1              10      POP AF  ;(HL)
00065E 465E AF               4      XOR A
00065F 465F 3A22F3          13      LD  A,(_RESULT)
000662 4662 C9              10      RET
                                
       4663                     RBRERR1:
000663 4663 3E01             7      LD  A,001H
       4665                     RBRERR2:
000665 4665 FDE1            14      POP IY
000667 4667 C1              10      POP BC
000668 4668 D1              10      POP DE
000669 4669 E1              10      POP HL
00066A 466A 37               4      SCF
00066B 466B 210000          10      LD  HL,0
00066E 466E C9              10      RET
       466F                     RBRERR:
00066F 466F 3EFF             7      LD  A,0FFH
000671 4671 18F2            12      JR  RBRERR2
                                
       4673                     FILE_DD:
000673 4673 3E                      DB  03EH
000674 4674 C9              10      RET
000675 4675 321FF3          13      LD  (SWC_BLOAD_M),A
000678 4678 2A51F3          16      LD  HL,(PARAM0)
00067B 467B 7E               7      LD  A,(HL)
00067C 467C C9              10      RET
       467D                     FILE_B:
00067D 467D AF               4      XOR A
00067E 467E 3255F3          13      LD  (FDRV),A
000681 4681 1E00             7      LD  E,0
000683 4683 3A63F6          13      LD  A,(VALTYP)
000686 4686 FE03             7      CP  3       ;string
000688 4688 203A            12      JR  NZ,FILED
00068A 468A DD2AF8F7        20      LD  IX,(DACDAT)
00068E 468E DD5E00          19      LD  E,(IX+0)
000691 4691 DD7E01          19      LD  A,(IX+1)
000694 4694 DD5602          19      LD  D,(IX+2)
000697 4697 DD62             9      LD  IXH,D
000699 4699 DD6F             9      LD  IXL,A
00069B 469B 7B               4      LD  A,E
00069C 469C FE04             7      CP  4
00069E 469E 3808            12      JR  C,FILEB1
0006A0 46A0 DD7E03          19      LD  A,(IX+3)
0006A3 46A3 FE3A             7      CP  ':'
0006A5 46A5 28CC            12      JR  Z,FILE_DD
0006A7 46A7 7B               4      LD  A,E
       46A8                     FILEB1:
0006A8 46A8 FE02             7      CP  2
0006AA 46AA 3818            12      JR  C,FILED
0006AC 46AC DD7E01          19      LD  A,(IX+1)
0006AF 46AF FE3A             7      CP  ':'
0006B1 46B1 2011            12      JR  NZ,DEVI1
0006B3 46B3 DD7E00          19      LD  A,(IX+0)        ;DRIVE
0006B6 46B6 CD9D47          17      CALL    CAP
0006B9 46B9 D640             7      SUB '@'
0006BB 46BB DD23            10      INC IX
0006BD 46BD DD23            10      INC IX
0006BF 46BF 1D               4      DEC E
0006C0 46C0 1D               4      DEC E
0006C1 46C1 3255F3          13      LD  (FDRV),A
       46C4                     DEVI1:
                                
       46C4                     FILED:
0006C4 46C4 CD0B47          17      CALL    FILEI
0006C7 46C7 2156F3          10      LD  HL,FNAME
                                
0006CA 46CA 0608             7      LD  B,8
       46CC                     FILE2:
0006CC 46CC CD1847          17      CALL    CCHKF
0006CF 46CF C8              11      RET Z
0006D0 46D0 FE2A             7      CP  '*'
0006D2 46D2 282E            12      JR  Z,FILE9
0006D4 46D4 FE2E             7      CP  '.'
0006D6 46D6 280C            12      JR  Z,FILE4
0006D8 46D8 77               7      LD  (HL),A
0006D9 46D9 23               6      INC HL
0006DA 46DA 10F0            13      DJNZ    FILE2
                                
       46DC                     FILE3:
0006DC 46DC CD1847          17      CALL    CCHKF
0006DF 46DF C8              11      RET Z
0006E0 46E0 FE2E             7      CP  '.'
0006E2 46E2 20F8            12      JR  NZ,FILE3
                                
       46E4                     FILE4:
0006E4 46E4 215EF3          10      LD  HL,FNAME+8
0006E7 46E7 0603             7      LD  B,3
                                
       46E9                     FILE4L:
0006E9 46E9 CD1847          17      CALL    CCHKF
0006EC 46EC C8              11      RET Z
0006ED 46ED FE2E             7      CP  '.'
0006EF 46EF 2008            12      JR  NZ,FILE12
0006F1 46F1 3256F3          13      LD  (FNAME),A   ;Parent directory(..)
0006F4 46F4 3257F3          13      LD  (FNAME+1),A
0006F7 46F7 3E20             7      LD  A,020H
       46F9                     FILE12:
0006F9 46F9 FE2A             7      CP  '*'
0006FB 46FB 280A            12      JR  Z,FILE10
0006FD 46FD 77               7      LD  (HL),A
0006FE 46FE 23               6      INC HL
0006FF 46FF 10E8            13      DJNZ    FILE4L
000701 4701 C9              10      RET
                                
       4702                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000702 4702 CD0747          17      CALL    FILE10
000705 4705 18D5            12      JR  FILE3
                                
       4707                     FILE10:
000707 4707 3E3F             7      LD  A,'?'
000709 4709 1808            12      JR  FILL_MEMORY
       470B                     FILEI:              ;名前＋拡張子をスペースで初期化
00070B 470B 3E20             7      LD  A,020H
00070D 470D 01000B          10      LD  BC,11*256   ;C=0にしておく
000710 4710 2156F3          10      LD  HL,FNAME
       4713                     FILL_MEMORY:            ;HLからBバイトAで埋める
000713 4713 77               7      LD  (HL),A
000714 4714 23               6      INC HL
000715 4715 10FC            13      DJNZ    FILL_MEMORY
000717 4717 C9              10      RET
                                
       4718                     CCHKF:
000718 4718 7B               4      LD  A,E
000719 4719 B7               4      OR  A
00071A 471A C8              11      RET Z
00071B 471B DD7E00          19      LD  A,(IX+0)
00071E 471E CD2547          17      CALL    CCHK2
000721 4721 C8              11      RET Z
000722 4722 C38847          10      JP  FKAN
                                
       4725                     CCHK2:
000725 4725 0C               4      INC C
000726 4726 0D               4      DEC C
000727 4727 C0              11      RET NZ
       4728                     CCHK3:              ;ZF=1 で使えない文字
000728 4728 FE2B             7      CP  '+'
00072A 472A C8              11      RET Z
00072B 472B FE2C             7      CP  ','
00072D 472D C8              11      RET Z
00072E 472E FE2F             7      CP  '/'
000730 4730 C8              11      RET Z
000731 4731 FE3A             7      CP  ':'
000733 4733 C8              11      RET Z
000734 4734 FE3B             7      CP  ';'
000736 4736 C8              11      RET Z
000737 4737 FE3D             7      CP  '='
000739 4739 C8              11      RET Z
00073A 473A FE5C             7      CP  05CH    ;\
00073C 473C C8              11      RET Z
00073D 473D FE1F             7      CP  01FH
00073F 473F D0              11      RET NC
000740 4740 BF               4      CP  A       ;Z=1
000741 4741 C9              10      RET
                                
       4742                     SS1:
000742 4742 13               6      INC DE
       4743                     SPCUT:              ;スペースをカット
000743 4743 1A               7      LD  A,(DE)
000744 4744 FE20             7      CP  020H
000746 4746 28FA            12      JR  Z,SS1
000748 4748 C9              10      RET
                                
       4749                     SCREOF1:
000749 4749 13               6      INC DE
       474A                     SPCUTEX:            ;スペース改行などをカット
00074A 474A 1A               7      LD  A,(DE)
00074B 474B FE20             7      CP  020H
00074D 474D 28FA            12      JR  Z,SCREOF1
00074F 474F FE0D             7      CP  00DH
000751 4751 28F6            12      JR  Z,SCREOF1
000753 4753 FE0A             7      CP  00AH
000755 4755 28F2            12      JR  Z,SCREOF1
000757 4757 FE1A             7      CP  01AH
000759 4759 28EE            12      JR  Z,SCREOF1
00075B 475B C9              10      RET
                                
       475C                     GETNUM:
00075C 475C 210000          10      LD  HL,0
       475F                     GETNUM1:
00075F 475F 1A               7      LD  A,(DE)
000760 4760 13               6      INC DE
000761 4761 D630             7      SUB '0'
000763 4763 D8              11      RET C
000764 4764 FE0A             7      CP  10
000766 4766 D0              11      RET NC
000767 4767 4D               4      LD  C,L
000768 4768 44               4      LD  B,H
000769 4769 29              11      ADD HL,HL   ;*2
00076A 476A 29              11      ADD HL,HL   ;*4
00076B 476B 09              11      ADD HL,BC   ;*5
00076C 476C 29              11      ADD HL,HL   ;*10
00076D 476D 4F               4      LD  C,A
00076E 476E 0600             7      LD  B,0
000770 4770 09              11      ADD HL,BC
000771 4771 18EC            12      JR  GETNUM1
                                
       4773                     SEARCH_END:
000773 4773 7E               7      LD  A,(HL)
       4774                     SEARCH_END1:
000774 4774 23               6      INC HL
000775 4775 B7               4      OR  A
000776 4776 C8              11      RET Z
000777 4777 FE3A             7      CP  ':'
000779 4779 20F8            12      JR  NZ,SEARCH_END
00077B 477B 7E               7      LD  A,(HL)
00077C 477C FE3A             7      CP  ':'
00077E 477E 28F4            12      JR  Z,SEARCH_END1
000780 4780 C9              10      RET
                                
       4781                     FKANC:
000781 4781 CB41             8      BIT 0,C
000783 4783 CCA647          17      CALL    Z,CAP2
000786 4786 1803            12      JR  FKANX
       4788                     FKAN:           ;漢字チェック
000788 4788 DD23            10      INC IX
00078A 478A 1D               4      DEC E
       478B                     FKANX:
00078B 478B CB41             8      BIT 0,C
00078D 478D CB81             8      RES 0,C
00078F 478F C0              11      RET NZ
000790 4790 FE80             7      CP  080H
000792 4792 D8              11      RET C
000793 4793 FEA0             7      CP  0A0H
000795 4795 3803            12      JR  C,FKAN1
000797 4797 FEE0             7      CP  0E0H
000799 4799 D8              11      RET C
       479A                     FKAN1:
00079A 479A 0C               4      INC C
00079B 479B A7               4      AND A
00079C 479C C9              10      RET
                                
       479D                     CAP:
00079D 479D FE61             7      CP  'a'
00079F 479F D8              11      RET C
0007A0 47A0 FE7B             7      CP  'z'+1
0007A2 47A2 D0              11      RET NC
0007A3 47A3 D620             7      SUB 020H
0007A5 47A5 C9              10      RET
       47A6                     CAP2:
0007A6 47A6 CD9D47          17      CALL    CAP
       47A9                     CAP3:               ;
0007A9 47A9 FE05             7      CP  5
0007AB 47AB 2803            12      JR  Z,CAP4
0007AD 47AD FE21             7      CP  021H
0007AF 47AF C9              10      RET
       47B0                     CAP4:
0007B0 47B0 3EE5             7      LD  A,0E5H
0007B2 47B2 C9              10      RET
                                
       47B3                     ROM_OPEN:
0007B3 47B3 CD634B          17      CALL    GET_DISK_BANK_FDRV
0007B6 47B6 320068          13      LD  (BANK1_SEL),A
                                
0007B9 47B9 CDBA49          17      CALL    GET_DIR_DAT
0007BC 47BC D5              11      PUSH    DE
0007BD 47BD CDD247          17      CALL    FILESE
0007C0 47C0 D1              10      POP DE
0007C1 47C1 3F               4      CCF
0007C2 47C2 D8              11      RET C
0007C3 47C3 224DF3          16      LD  (FCBX),HL
0007C6 47C6 E5              11      PUSH    HL
0007C7 47C7 210000          10      LD  HL,0
0007CA 47CA 2224F3          16      LD  (RR_LOW),HL
0007CD 47CD 2226F3          16      LD  (RR_HIGH),HL
0007D0 47D0 E1              10      POP HL
0007D1 47D1 C9              10      RET
                                
       47D2                     FILESE:
0007D2 47D2 7E               7      LD  A,(HL)
0007D3 47D3 B7               4      OR  A
0007D4 47D4 C8              11      RET Z       ;END:ZF=1 CF=0
0007D5 47D5 FEE5             7      CP  0E5H
0007D7 47D7 280D            12      JR  Z,FILESE1
0007D9 47D9 1156F3          10      LD  DE,FNAME
0007DC 47DC E5              11      PUSH    HL
0007DD 47DD CDF447          17      CALL    CPFILE
0007E0 47E0 CC1548          17      CALL    Z,CPFILE2
0007E3 47E3 E1              10      POP HL
0007E4 47E4 37               4      SCF
0007E5 47E5 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       47E6                     FILESE1:
0007E6 47E6 CDEE47          17      CALL    FNEXT
0007E9 47E9 20E7            12      JR  NZ,FILESE
       47EB                     ZF0_CF0_AFF_RET:
0007EB 47EB F6FF             7      OR  0FFH        ;ZF=0 CF=0
0007ED 47ED C9              10      RET
                                
       47EE                     FNEXT:
                                ;   PUSH    HL
                                ;   LD  HL,_FILEN
                                ;   INC (HL)
                                ;   POP HL
0007EE 47EE 112000          10      LD  DE,020H
0007F1 47F1 19              11      ADD HL,DE
0007F2 47F2 0D               4      DEC C
0007F3 47F3 C9              10      RET
                                
       47F4                     CPFILE:
0007F4 47F4 C5              11      PUSH    BC
0007F5 47F5 01000B          10      LD  BC,00B00H
       47F8                     CPSTR1:
0007F8 47F8 1A               7      LD  A,(DE)
0007F9 47F9 FE3F             7      CP  '?'     ;Wild card
0007FB 47FB 2812            12      JR  Z,CPSTR2
0007FD 47FD 7E               7      LD  A,(HL)
0007FE 47FE CD8147          17      CALL    FKANC
000801 4801 E5              11      PUSH    HL
000802 4802 67               4      LD  H,A
000803 4803 1A               7      LD  A,(DE)
000804 4804 CB01             4      RLC C
000806 4806 CD8147          17      CALL    FKANC
000809 4809 CB09             4      RRC C
00080B 480B BC               4      CP  H       ;CP (HL),(DE)
00080C 480C E1              10      POP HL
00080D 480D 2004            12      JR  NZ,CPSTR3
       480F                     CPSTR2:
00080F 480F 13               6      INC DE
000810 4810 23               6      INC HL
000811 4811 10E5            13      DJNZ    CPSTR1
       4813                     CPSTR3:
000813 4813 C1              10      POP BC
000814 4814 C9              10      RET
                                
       4815                     CPFILE2:
                                ;   LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
                                ;   OR  0E1H
000815 4815 3EE1             7      LD  A,0E1H
000817 4817 2F               4      CPL
000818 4818 A6               7      AND (HL)
000819 4819 C9              10      RET
                                
       481A                     RBX1:
00081A 481A E5              11      PUSH    HL      ;Record byte
                                
00081B 481B ED5B24F3        20      LD  DE,(RR_LOW) ;CDE=Random record
00081F 481F 3A27F3          13      LD  A,(RR_HIGH+1)
000822 4822 4F               4      LD  C,A
                                
000823 4823 CD634B          17      CALL    GET_DISK_BANK_FDRV
000826 4826 320068          13      LD  (BANK1_SEL),A
                                
000829 4829 FD2A4DF3        20      LD  IY,(FCBX)
00082D 482D FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000830 4830 FD661D          19      LD  H,(IY+01DH)
000833 4833 FD7E1E          19      LD  A,(IY+01EH)
                                
000836 4836 A7               4      AND A
000837 4837 ED52            15      SBC HL,DE
000839 4839 99               4      SBC A,C
00083A 483A D1              10      POP DE
                                
00083B 483B D8              11      RET C
00083C 483C 4F               4      LD  C,A
00083D 483D EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
00083E 483E B2               4      OR  D
00083F 483F B3               4      OR  E
000840 4840 C0              11      RET NZ
000841 4841 37               4      SCF
000842 4842 C9              10      RET
                                
       4843                     RBX2:
000843 4843 ED4B25F3        20      LD  BC,(RR_LOW+1)
000847 4847 CDBC48          17      CALL    RWXR
00084A 484A 3E03             7      LD  A,3     ;ooo 1
00084C 484C E5              11      PUSH    HL
00084D 484D 2A24F3          16      LD  HL,(RR_LOW)
000850 4850 A4               4      AND H
000851 4851 B5               4      OR  L
000852 4852 E1              10      POP HL
000853 4853 C9              10      RET
                                
       4854                     RBXA:
000854 4854 D5              11      PUSH    DE
000855 4855 CD2249          17      CALL    CLUST
000858 4858 ED532CF3        20      LD  (_DTPS),DE
00085C 485C D1              10      POP DE
00085D 485D CDFF48          17      CALL    GNCL
000860 4860 D8              11      RET C
000861 4861 ED5328F3        20      LD  (_CLPS),DE
                                
000865 4865 ED4B24F3        20      LD  BC,(RR_LOW)
000869 4869 3E03             7      LD  A,3     ;ooo 1
00086B 486B A0               4      AND B
00086C 486C 47               4      LD  B,A
00086D 486D 210004          10  IBM7:   LD  HL,1024     ;ooo 512
000870 4870 ED42            15      SBC HL,BC       ;remaining cluster
                                
000872 4872 ED5B4FF3        20      LD  DE,(LEFTX)
000876 4876 ED52            15      SBC HL,DE       ;CP HL,DE
000878 4878 19              11      ADD HL,DE
000879 4879 3801            12      JR  C,RBXA1
00087B 487B EB               4      EX  DE,HL
       487C                     RBXA1:
00087C 487C 3A23F3          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
00087F 487F 320068          13      LD  (BANK1_SEL),A   ;ASCII-8K/Konami-8K共通で使える
000882 4882 E5              11      PUSH    HL
000883 4883 2A2CF3          16      LD  HL,(_DTPS)
000886 4886 09              11      ADD HL,BC
000887 4887 ED5B49F3        20      LD  DE,(DTAX)
00088B 488B C1              10      POP BC
00088C 488C C9              10      RET
                                
       488D                     RBXB:
00088D 488D 2A49F3          16      LD  HL,(DTAX)
000890 4890 ED5B28F3        20      LD  DE,(_CLPS)
000894 4894 3A50F3          13      LD  A,(LEFTX+1)
000897 4897 CB3F             8      SRL A
000899 4899 CB3F             8  IBM8:   SRL A       ;ooo
00089B 489B 47               4      LD  B,A
00089C 489C C9              10      RET
                                
       489D                     RBXC:
00089D 489D ED4B4FF3        20      LD  BC,(LEFTX)
0008A1 48A1 3E03             7      LD  A,3     ;ooo 1
0008A3 48A3 A0               4      AND B
0008A4 48A4 47               4      LD  B,A
0008A5 48A5 B1               4      OR  C
0008A6 48A6 C9              10      RET
                                
       48A7                     RBXEND:
0008A7 48A7 ED5B2AF3        20      LD  DE,(_LEFT)
0008AB 48AB 2A24F3          16      LD  HL,(RR_LOW)
0008AE 48AE 3A27F3          13      LD  A,(RR_HIGH+1)
0008B1 48B1 19              11      ADD HL,DE
0008B2 48B2 CE00             7      ADC A,0
0008B4 48B4 2224F3          16      LD  (RR_LOW),HL
0008B7 48B7 3227F3          13      LD  (RR_HIGH+1),A
0008BA 48BA EB               4      EX  DE,HL       ;HL=Read byte
0008BB 48BB C9              10      RET 
                                
       48BC                     RWXR:
0008BC 48BC CB38             8      SRL B
0008BE 48BE CB19             8      RR  C
0008C0 48C0 CB38             8  IBM4:   SRL B   ;ooo
0008C2 48C2 CB19             8      RR  C
                                
0008C4 48C4 CD634B          17      CALL    GET_DISK_BANK_FDRV
0008C7 48C7 320068          13      LD  (BANK1_SEL),A
                                
0008CA 48CA FD2A4DF3        20      LD  IY,(FCBX)
0008CE 48CE FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
0008D1 48D1 FD561B          19      LD  D,(IY+01BH)
       48D4                     RWX1:
0008D4 48D4 ED5328F3        20      LD  (_CLPS),DE
0008D8 48D8 7A               4      LD  A,D
0008D9 48D9 B3               4      OR  E
0008DA 48DA 37               4      SCF
0008DB 48DB C8              11      RET Z
                                
0008DC 48DC 78               4      LD  A,B
0008DD 48DD B1               4      OR  C
0008DE 48DE C8              11      RET Z
                                
0008DF 48DF CDFF48          17      CALL    GNCL
0008E2 48E2 D8              11      RET C
0008E3 48E3 0B               6      DEC BC
0008E4 48E4 CD5349          17      CALL    ENDCL
0008E7 48E7 38EB            12      JR  C,RWX1
0008E9 48E9 37               4      SCF
0008EA 48EA C9              10      RET
                                
       48EB                     NCL3:
0008EB 48EB CD634B          17      CALL    GET_DISK_BANK_FDRV
0008EE 48EE 320068          13      LD  (BANK1_SEL),A
0008F1 48F1 6B               4      LD  L,E
0008F2 48F2 62               4      LD  H,D
0008F3 48F3 CB3C             8      SRL H
0008F5 48F5 CB1D             8      RR  L
0008F7 48F7 1F               4      RRA
0008F8 48F8 010062          10      LD  BC,_FATBF
0008FB 48FB 19              11      ADD HL,DE
0008FC 48FC 09              11      ADD HL,BC
0008FD 48FD 17               4      RLA
0008FE 48FE C9              10      RET
                                
       48FF                     GNCL:
0008FF 48FF 7A               4      LD  A,D
000900 4900 B3               4      OR  E
000901 4901 37               4      SCF
000902 4902 C8              11      RET Z
000903 4903 C5              11      PUSH    BC
000904 4904 E5              11      PUSH    HL
000905 4905 CDEB48          17      CALL    NCL3
000908 4908 3809            12      JR  C,GNC1
00090A 490A 5E               7      LD  E,(HL)
00090B 490B 23               6      INC HL
00090C 490C 7E               7      LD  A,(HL)
00090D 490D E60F             7      AND 00FH
00090F 490F 57               4      LD  D,A
000910 4910 E1              10      POP HL
000911 4911 C1              10      POP BC
000912 4912 C9              10      RET
       4913                     GNC1:
000913 4913 7E               7      LD  A,(HL)
000914 4914 23               6      INC HL
000915 4915 56               7      LD  D,(HL)
000916 4916 0604             7      LD  B,4
       4918                     GNC1L:
000918 4918 CB3A             8      SRL D
00091A 491A 1F               4      RRA
00091B 491B 10FB            13      DJNZ    GNC1L
                                
00091D 491D 5F               4      LD  E,A
00091E 491E E1              10      POP HL
00091F 491F C1              10      POP BC
000920 4920 A7               4      AND A
000921 4921 C9              10      RET
                                
       4922                     CLUST:
000922 4922 EB               4      EX  DE,HL
000923 4923 C5              11      PUSH    BC
000924 4924 CDC849          17      CALL    GET_DIR_POS
000927 4927 87               4      ADD A,A
000928 4928 3D               4      DEC A
000929 4929 4F               4      LD  C,A
00092A 492A 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
00092D 492D 0F               4      RRCA
00092E 492E 0F               4      RRCA
00092F 492F 0F               4      RRCA
000930 4930 0F               4      RRCA
000931 4931 81               4      ADD A,C
000932 4932 C1              10      POP BC
000933 4933 29              11      ADD HL,HL   ;*2
000934 4934 29              11      ADD HL,HL   ;*4
000935 4935 85               4      ADD A,L
000936 4936 6F               4      LD  L,A
000937 4937 8C               4      ADC A,H
000938 4938 95               4      SUB L
000939 4939 67               4      LD  H,A
00093A 493A E5              11      PUSH    HL
00093B 493B 29              11      ADD HL,HL
00093C 493C 29              11      ADD HL,HL
00093D 493D 29              11      ADD HL,HL
00093E 493E CD634B          17      CALL    GET_DISK_BANK_FDRV
000941 4941 84               4      ADD A,H
000942 4942 320068          13      LD  (BANK1_SEL),A
000945 4945 3223F3          13      LD  (_BANK),A
000948 4948 E1              10      POP HL
000949 4949 3E1F             7      LD  A,01FH
00094B 494B A5               4      AND L
00094C 494C C660             7      ADD A,high BANK1_ADR
00094E 494E 67               4      LD  H,A
00094F 494F 2E00             7      LD  L,0
000951 4951 EB               4      EX  DE,HL
000952 4952 C9              10      RET
                                
       4953                     ENDCL:
000953 4953 7A               4      LD  A,D ;END CLUSTER
000954 4954 FE0F             7      CP  00FH    ;FAT12の最大値
000956 4956 C0              11      RET NZ
000957 4957 7B               4      LD  A,E
000958 4958 FEF7             7      CP  0F7H
00095A 495A C9              10      RET
                                
       495B                     RB_READ:
00095B 495B AF               4      XOR A   ;HLA = HL*128
00095C 495C CB3C             8      SRL H
00095E 495E CB1D             8      RR  L
000960 4960 1F               4      RRA
000961 4961 3224F3          13      LD  (RR_LOW),A
000964 4964 2225F3          16      LD  (RR_MID),HL
000967 4967 218000          10      LD  HL,128
                                
00096A 496A CDDE45          17      CALL    ROM_READ
00096D 496D C9              10      RET
                                
       496E                     GETSEQ:
00096E 496E FD6E20          19      LD  L,(IY+32)
000971 4971 FD660C          19      LD  H,(IY+12)
                                
000974 4974 CB25             8      SLA L
                                
000976 4976 CB3C             8      SRL H
000978 4978 CB1D             8      RR  L
00097A 497A C9              10      RET
                                
       497B                     SETSEQ:
00097B 497B F5              11      PUSH    AF
00097C 497C 3A24F3          13      LD  A,(RR_LOW)
00097F 497F 2A25F3          16      LD  HL,(RR_MID)
                                
000982 4982 CD9949          17      CALL    SSQ1
                                
000985 4985 29              11      ADD HL,HL
000986 4986 CB3D             8      SRL L
000988 4988 FD7520          19      LD  (IY+32),L
00098B 498B FD740C          19      LD  (IY+12),H
00098E 498E F1              10      POP AF
00098F 498F C9              10      RET
                                
       4990                     GETSIZE:
000990 4990 FD7E10          19      LD  A,(IY+16)
000993 4993 FD6E11          19      LD  L,(IY+17)
000996 4996 FD6612          19      LD  H,(IY+18)
       4999                     SSQ1:
000999 4999 87               4      ADD A,A
00099A 499A ED6A            15      ADC HL,HL
00099C 499C B7               4      OR  A
00099D 499D C8              11      RET Z
00099E 499E 23               6      INC HL
00099F 499F C9              10      RET
                                
       49A0                     SET_FCB:
0009A0 49A0 D5              11      PUSH    DE
0009A1 49A1 FDE1            14      POP IY
0009A3 49A3 FD7E1C          19      LD  A,(IY+28)
0009A6 49A6 FEFF             7      CP  0FFH
0009A8 49A8 200C            12      JR  NZ,POPAF_SCF_FF_RET
0009AA 49AA E5              11      PUSH    HL
0009AB 49AB FD6E1A          19      LD  L,(IY+26)
0009AE 49AE FD661B          19      LD  H,(IY+27)
0009B1 49B1 2228F3          16      LD  (_CLPS),HL
0009B4 49B4 E1              10      POP HL
0009B5 49B5 C9              10      RET
                                
       49B6                     POPAF_SCF_FF_RET:
0009B6 49B6 F1              10      POP AF
0009B7 49B7 37               4      SCF
0009B8 49B8 9F               4      SBC A,A
0009B9 49B9 C9              10      RET
                                
       49BA                     GET_DIR_DAT:
0009BA 49BA CDC849          17      CALL    GET_DIR_POS
0009BD 49BD 87               4      ADD A,A         ;*2
0009BE 49BE C660             7      ADD A,high BANK1_ADR
0009C0 49C0 2E00             7      LD  L,0
0009C2 49C2 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*512
0009C3 49C3 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
0009C6 49C6 4F               4      LD  C,A
0009C7 49C7 C9              10      RET
                                
       49C8                     GET_DIR_POS:
0009C8 49C8 CD634B          17      CALL    GET_DISK_BANK_FDRV
0009CB 49CB 320068          13      LD  (BANK1_SEL),A
0009CE 49CE 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
0009D1 49D1 47               4      LD  B,A
0009D2 49D2 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
0009D5 49D5 4F               4      LD  C,A
0009D6 49D6 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       49D9                     GET_DIR_POS1:
0009D9 49D9 81               4      ADD A,C
0009DA 49DA 10FD            13      DJNZ    GET_DIR_POS1
0009DC 49DC C9              10      RET
                                
       49DD                     WILDCARD:
0009DD 49DD 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       49E8                     ERROR_WRITE_PROTECTED:
0009E8 49E8 3E00             7      LD  A,0     ;Write protected
0009EA 49EA C9              10      RET
       49EB                     DISKIO:
0009EB 49EB 38FB            12      JR  C,ERROR_WRITE_PROTECTED
0009ED 49ED 48               4      LD  C,B
0009EE 49EE CD6D4B          17      CALL    GET_DISK_BANK
       49F1                     SETMAP1:        
0009F1 49F1 E5              11      PUSH    HL
       49F2                     DISKIO1:
0009F2 49F2 C5              11      PUSH    BC      ;B=残りのセクタ数
0009F3 49F3 D5              11      PUSH    DE      ;DE=セクタ番号
0009F4 49F4 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
0009F5 49F5 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
0009F6 49F6 29              11      ADD HL,HL
0009F7 49F7 4D               4      LD  C,L     ;C=読み出し元(セクタ番号*2)※1セクタ512バイトなので倍にしておく
0009F8 49F8 29              11      ADD HL,HL       ;64KB→32KB
0009F9 49F9 29              11      ADD HL,HL       ;32KB→16KB
0009FA 49FA 29              11      ADD HL,HL       ;16KB→8KB
0009FB 49FB 84               4      ADD A,H
0009FC 49FC 320068          13      LD  (BANK1_SEL),A   ;ASCII-8K/Konami-8K共通で使える
0009FF 49FF 3223F3          13      LD  (_BANK),A
000A02 4A02 79               4      LD  A,C     ;C=読み出し元
000A03 4A03 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F/16K:3F)
000A05 4A05 C660             7      ADD A,high BANK1_ADR
000A07 4A07 67               4      LD  H,A
000A08 4A08 010002          10      LD  BC,00200H   ;BCは読み出すセクタサイズ(512バイト)
000A0B 4A0B 69               4      LD  L,C     ;C=0
000A0C 4A0C EDB0                    LDIR
000A0E 4A0E EB               4      EX  DE,HL
000A0F 4A0F F1              10      POP AF
000A10 4A10 D1              10      POP DE
000A11 4A11 13               6      INC DE
000A12 4A12 C1              10      POP BC
000A13 4A13 10DD            13      DJNZ    DISKIO1
000A15 4A15 41               4      LD  B,C
                                
000A16 4A16 E1              10      POP HL
000A17 4A17 AF               4      XOR A
000A18 4A18 FB               4      EI
000A19 4A19 C9              10      RET
                                
       4A1A                     DSKCHG:
000A1A 4A1A CD534A          17      CALL    IS_BPB
000A1D 4A1D 3824            12      JR  C,NOTREADY
000A1F 4A1F 3A23FB          13      LD  A,(DRVTBL+2)
000A22 4A22 B7               4      OR  A
000A23 4A23 201A            12      JR  NZ,DSKCHG1
000A25 4A25 3A21FB          13      LD  A,(DRVTBL)
000A28 4A28 FE02             7      CP  2
000A2A 4A2A 2013            12      JR  NZ,DSKCHG1
000A2C 4A2C CD534A          17      CALL    IS_BPB
000A2F 4A2F 300E            12      JR  NC,DSKCHG1
000A31 4A31 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000A33 4A33 3221FB          13      LD  (DRVTBL),A
000A36 4A36 3223FB          13      LD  (DRVTBL+2),A
000A39 4A39 3A48F3          13      LD  A,(MASTERS)
000A3C 4A3C 3224FB          13      LD  (DRVTBL+3),A
       4A3F                     DSKCHG1:
000A3F 4A3F AF               4      XOR A
000A40 4A40 0601             7      LD  B,1
000A42 4A42 C9              10      RET
       4A43                     NOTREADY:
000A43 4A43 3E02             7      LD  A,2
000A45 4A45 37               4      SCF
000A46 4A46 C9              10      RET
                                
       4A47                     NO_BPB:
000A47 4A47 E1              10      POP HL
000A48 4A48 23               6      INC HL
000A49 4A49 11754B          10      LD  DE,DPB2DD
000A4C 4A4C 011200          10      LD  BC,DPB2DD_E-DPB2DD
000A4F 4A4F EDB0                    LDIR
000A51 4A51 AF               4      XOR A
000A52 4A52 C9              10      RET
                                
       4A53                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000A53 4A53 CD6D4B          17      CALL    GET_DISK_BANK
000A56 4A56 320068          13      LD  (BANK1_SEL),A
                                
000A59 4A59 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000A5C 4A5C FE01             7      CP  1
000A5E 4A5E D8              11      RET C
                                
000A5F 4A5F 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000A62 4A62 C6FF             7      ADD A,0FFH
000A64 4A64 D8              11      RET C
                                
000A65 4A65 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
000A68 4A68 FE02             7      CP  2
000A6A 4A6A C8              11      RET Z
000A6B 4A6B FE04             7      CP  4
000A6D 4A6D C8              11      RET Z
000A6E 4A6E 37               4      SCF
000A6F 4A6F C9              10      RET
                                
       4A70                     GETDPB:
000A70 4A70 E5              11      PUSH    HL
000A71 4A71 CD6D4B          17      CALL    GET_DISK_BANK
000A74 4A74 320068          13      LD  (BANK1_SEL),A
                                
000A77 4A77 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000A7A 4A7A B7               4      OR  A
000A7B 4A7B 28CA            12      JR  Z,NO_BPB
000A7D 4A7D DDE1            14      POP IX
000A7F 4A7F DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000A82 4A82 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000A85 4A85 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000A88 4A88 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000A8B 4A8B DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000A8E 4A8E 87               4      ADD A,A
000A8F 4A8F 87               4      ADD A,A
000A90 4A90 87               4      ADD A,A
000A91 4A91 3D               4      DEC A
000A92 4A92 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000A95 4A95 06FF             7      LD  B,-1
000A97 4A97 A7               4      AND A           ;無限ループ阻止
       4A98                     GETDPB1:
000A98 4A98 04               4      INC B
000A99 4A99 1F               4      RRA
000A9A 4A9A 38FC            12      JR  C,GETDPB1
000A9C 4A9C DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000A9F 4A9F 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus 
000AA2 4AA2 3D               4      DEC A
000AA3 4AA3 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000AA6 4AA6 A7               4      AND A           ;無限ループ阻止
000AA7 4AA7 06FF             7      LD  B,-1
       4AA9                     GETDPB2:
000AA9 4AA9 04               4      INC B
000AAA 4AAA 1F               4      RRA
000AAB 4AAB 38FC            12      JR  C,GETDPB2
000AAD 4AAD 04               4      INC B
000AAE 4AAE DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000AB1 4AB1 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
000AB4 4AB4 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
000AB7 4AB7 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
000ABA 4ABA 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
000ABD 4ABD DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000AC0 4AC0 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
000AC3 4AC3 DD770B          19      LD  (IX+11),A       ;FATCNT
                                
000AC6 4AC6 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
000ACA 4ACA DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
000ACD 4ACD DD460A          19      LD  B,(IX+10)       ;FATCNT
000AD0 4AD0 210000          10      LD  HL,0
       4AD3                     GETDPB3:
000AD3 4AD3 19              11      ADD HL,DE
000AD4 4AD4 10FD            13      DJNZ    GETDPB3
       4AD6                     GETDPB4:
000AD6 4AD6 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
000AD9 4AD9 DD5609          19      LD  D,(IX+9)        ;FIRFAT
000ADC 4ADC 19              11      ADD HL,DE
000ADD 4ADD DD7511          19      LD  (IX+17),L       ;FIRDIR
000AE0 4AE0 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000AE3 4AE3 3E08             7      LD  A,2*4           ;SECSIZ HIGH
000AE5 4AE5 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4AE8                     GETDPB5:
000AE8 4AE8 CB3B             8      SRL E
000AEA 4AEA 1F               4      RRA
000AEB 4AEB 30FB            12      JR  NC,GETDPB5
000AED 4AED 1600             7      LD  D,0
000AEF 4AEF 19              11      ADD HL,DE
000AF0 4AF0 DD750C          19      LD  (IX+12),L       ;FIRREC
000AF3 4AF3 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000AF6 4AF6 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
000AF9 4AF9 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
000AFC 4AFC DD560D          19      LD  D,(IX+13)       ;FIRREC
000AFF 4AFF A7               4      AND A
000B00 4B00 ED52            15      SBC HL,DE
                                
000B02 4B02 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
000B05 4B05 3C               4      INC A
000B06 4B06 37               4      SCF             ;無限ループ阻止
       4B07                     GETDPB6:
000B07 4B07 1F               4      RRA
000B08 4B08 3806            12      JR  C,GETDPB7
000B0A 4B0A CB3C             8      SRL H
000B0C 4B0C CB1D             8      RR  L
000B0E 4B0E 18F7            12      JR  GETDPB6
       4B10                     GETDPB7:
000B10 4B10 23               6      INC HL
000B11 4B11 DD750E          19      LD  (IX+14),L       ;MAXCLUS
000B14 4B14 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       4B17                     GETDPBD1:
000B17 4B17 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000B1A 4B1A E6FC             7      AND 0FCH
000B1C 4B1C C8              11      RET Z
                                
000B1D 4B1D DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
000B21 4B21 37               4      SCF
000B22 4B22 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
000B26 4B26 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
000B29 4B29 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
000B2D 4B2D DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
000B31 4B31 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
000B35 4B35 DDCB1126        23      SLA (IX+17)         ;FIRDIR
000B39 4B39 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
000B3D 4B3D DD6E11          19      LD  L,(IX+17)       ;FIRDIR
000B40 4B40 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
000B43 4B43 3E08             7      LD  A,2*4           ;SECSIZ HIGH
000B45 4B45 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4B48                     GETDPBD5:
000B48 4B48 CB3B             8      SRL E
000B4A 4B4A 1F               4      RRA
000B4B 4B4B 30FB            12      JR  NC,GETDPBD5
000B4D 4B4D 1600             7      LD  D,0
000B4F 4B4F 19              11      ADD HL,DE
000B50 4B50 DD750C          19      LD  (IX+12),L       ;FIRREC
000B53 4B53 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000B56 4B56 18BF            12      JR  GETDPBD1
                                
       4B58                     CHOICE:
000B58 4B58 210000          10      LD  HL,0
000B5B 4B5B C9              10      RET
                                
       4B5C                     DSKFMT:
000B5C 4B5C AF               4      XOR A
000B5D 4B5D 37               4      SCF
       4B5E                     DSKSTP:
       4B5E                     BASENT:
000B5E 4B5E C9              10      RET
                                
       4B5F                     GETSLT:
000B5F 4B5F 3A22FB          13      LD  A,(DRVTBL+1)
000B62 4B62 C9              10      RET
                                
       4B63                     GET_DISK_BANK_FDRV:
000B63 4B63 3A55F3          13      LD  A,(FDRV)
000B66 4B66 D601             7      SUB 1
000B68 4B68 3003            12      JR  NC,GET_DISK_BANK
000B6A 4B6A 3A4CF3          13      LD  A,(_DVSW)
       4B6D                     GET_DISK_BANK:
000B6D 4B6D B7               4      OR  A       ;A=DRIVE
000B6E 4B6E 3E01             7      LD  A,DISK_BANK
000B70 4B70 C8              11      RET Z
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
000B71 4B71 3A4BF3          13      LD  A,(B_DRIVE)
                                #endif
000B74 4B74 C9              10      RET
                                
       4B75                     DPB2DD:
000B75 4B75 F9                      DB  0F9H    ;MEDIA
000B76 4B76 0002                    DW  00200H  ;SECSIZ
000B78 4B78 0F                      DB  00FH    ;DIRMSK
000B79 4B79 04                      DB  004H    ;DIRSHFT
000B7A 4B7A 01                      DB  001H    ;CLUSMSK
000B7B 4B7B 02                      DB  002H    ;CLUSSHFT
000B7C 4B7C 0100                    DW  00001H  ;FIRFAT
000B7E 4B7E 02                      DB  002H    ;FATCNT
000B7F 4B7F 70                      DB  070H    ;MAXENT
000B80 4B80 0E00                    DW  0000EH  ;FIRREC
000B82 4B82 CA02                    DW  002CAH  ;MAXCLUS
000B84 4B84 03                      DB  003H    ;FATSIZ
000B85 4B85 0700                    DW  0007H   ;FIRDIR
       4B87                     DPB2DD_E:
                                
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       4B87                     POP_HL_ERROR:
000B87 4B87 E1              10      POP     HL
       4B88                     _ERROR:
000B88 4B88 0600             7      LD  B,0
000B8A 4B8A A7               4      AND A
000B8B 4B8B C9              10      RET
                                
       4B8C                     ROM_BDOS:
000B8C 4B8C E5              11      PUSH    HL
000B8D 4B8D 79               4      LD  A,C
000B8E 4B8E 87               4      ADD A,A
000B8F 4B8F 38F7            12      JR  C,_ERROR
000B91 4B91 6F               4      LD  L,A
000B92 4B92 265F             7      LD  H,high STABLE
000B94 4B94 7E               7      LD  A,(HL)
000B95 4B95 2C               4      INC L
000B96 4B96 66               7      LD  H,(HL)
000B97 4B97 6F               4      LD  L,A
000B98 4B98 E3              19      EX  (SP),HL
000B99 4B99 79               4      LD  A,C
000B9A 4B9A C9              10      RET
                                
       4B9B                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000B9B 4B9B C5              11      PUSH    BC
000B9C 4B9C D5              11      PUSH    DE
000B9D 4B9D E5              11      PUSH    HL
000B9E 4B9E DDE5            15      PUSH    IX
000BA0 4BA0 DD219C00        14      LD  IX,CHSNS
000BA4 4BA4 CD5242          17      CALL    CALSLT_R
000BA7 4BA7 DDE1            14      POP IX
000BA9 4BA9 E1              10      POP HL
000BAA 4BAA D1              10      POP DE
000BAB 4BAB C1              10      POP BC
000BAC 4BAC C9              10      RET
                                
       4BAD                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000BAD 4BAD 212200          10      LD  HL,00022H
000BB0 4BB0 AF               4      XOR A
000BB1 4BB1 7D               4      LD  A,L
000BB2 4BB2 C9              10      RET
                                
       4BB3                     _SYS0D:     ;(BDOS)ディスク・リセット
000BB3 4BB3 218000          10      LD  HL,00080H
000BB6 4BB6 222EF3          16      LD  (_DTA),HL
000BB9 4BB9 C9              10      RET
                                
       4BBA                     _SYS0E:     ;(BDOS)カレントドライブの設定
000BBA 4BBA 324CF3          13      LD  (_DVSW),A
000BBD 4BBD C9              10      RET
                                
       4BBE                     _SYS0F:     ;(BDOS)ファイルのオープン
000BBE 4BBE D5              11      PUSH    DE
000BBF 4BBF FDE1            14      POP IY
000BC1 4BC1 CD074D          17      CALL    INIT_FILE
000BC4 4BC4 CDB347          17      CALL    ROM_OPEN
000BC7 4BC7 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
000BC9 4BC9 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
000BCD 4BCD FDE5            15      PUSH    IY
000BCF 4BCF D1              10      POP DE
000BD0 4BD0 13               6      INC DE
000BD1 4BD1 010B00          10      LD  BC,11
000BD4 4BD4 EDB0                    LDIR
                                ;               Attribute
000BD6 4BD6 7E               7      LD  A,(HL)
000BD7 4BD7 FD770D          19      LD  (IY+13),A
                                ;               TIME
000BDA 4BDA 110B00          10      LD  DE,11
000BDD 4BDD 19              11      ADD HL,DE
000BDE 4BDE 7E               7      LD  A,(HL)
000BDF 4BDF 23               6      INC HL
000BE0 4BE0 FD7716          19      LD  (IY+22),A
000BE3 4BE3 7E               7      LD  A,(HL)
000BE4 4BE4 23               6      INC HL
000BE5 4BE5 FD7717          19      LD  (IY+23),A
                                ;               DATE
000BE8 4BE8 7E               7      LD  A,(HL)
000BE9 4BE9 23               6      INC HL
000BEA 4BEA FD7714          19      LD  (IY+20),A
000BED 4BED 7E               7      LD  A,(HL)
000BEE 4BEE 23               6      INC HL
000BEF 4BEF FD7715          19      LD  (IY+21),A
                                ;               First cluster
000BF2 4BF2 7E               7      LD  A,(HL)
000BF3 4BF3 23               6      INC HL
000BF4 4BF4 FD771A          19      LD  (IY+26),A
000BF7 4BF7 7E               7      LD  A,(HL)
000BF8 4BF8 23               6      INC HL
000BF9 4BF9 FD771B          19      LD  (IY+27),A
                                ;               SIZE
000BFC 4BFC 7E               7      LD  A,(HL)
000BFD 4BFD 23               6      INC HL
000BFE 4BFE FD7710          19      LD  (IY+16),A
000C01 4C01 7E               7      LD  A,(HL)
000C02 4C02 23               6      INC HL
000C03 4C03 FD7711          19      LD  (IY+17),A
000C06 4C06 7E               7      LD  A,(HL)
000C07 4C07 23               6      INC HL
000C08 4C08 FD7712          19      LD  (IY+18),A
000C0B 4C0B 7E               7      LD  A,(HL)
000C0C 4C0C FD7713          19      LD  (IY+19),A
000C0F 4C0F AF               4      XOR A
000C10 4C10 FD770C          19      LD  (IY+12),A
000C13 4C13 C9              10      RET
                                
       4C14                     _SYS10:     ;(BDOS)ファイルのクローズ
000C14 4C14 AF               4      XOR A
000C15 4C15 C9              10      RET
                                
       4C16                     S11X1:
000C16 4C16 FD7119          19      LD  (IY+25),C       ;RootEntCnt
000C19 4C19 FD750E          19      LD  (IY+14),L
000C1C 4C1C FD740F          19      LD  (IY+15),H
       4C1F                     SCF_FF_RET:
000C1F 4C1F 37               4      SCF
000C20 4C20 9F               4      SBC A,A
000C21 4C21 C9              10      RET
                                
       4C22                     _SYS11:     ;(BDOS)最初のファイルの検索
000C22 4C22 ED5336F3        20      LD  (_FCB),DE
000C26 4C26 D5              11      PUSH    DE
000C27 4C27 FDE1            14      POP IY
000C29 4C29 CD074D          17      CALL    INIT_FILE
000C2C 4C2C CDBA49          17      CALL    GET_DIR_DAT
       4C2F                     S12X1:
000C2F 4C2F CDD247          17      CALL    FILESE
000C32 4C32 30E2            12      JR  NC,S11X1
000C34 4C34 0D               4      DEC C
000C35 4C35 FD7119          19      LD  (IY+25),C       ;RootEntCnt
000C38 4C38 012000          10      LD  BC,32
000C3B 4C3B ED5B2EF3        20      LD  DE,(_DTA)
000C3F 4C3F AF               4      XOR A
000C40 4C40 12               7      LD  (DE),A      ;ドライブ番号
000C41 4C41 13               6      INC DE
000C42 4C42 EDB0                    LDIR            ;ディレクトリエントリ
000C44 4C44 FD750E          19      LD  (IY+14),L
000C47 4C47 FD740F          19      LD  (IY+15),H
000C4A 4C4A C9              10      RET
                                
       4C4B                     _SYS12:
000C4B 4C4B FD2A36F3        20      LD  IY,(_FCB)
000C4F 4C4F FDE5            15      PUSH    IY
000C51 4C51 D1              10      POP DE
000C52 4C52 CD074D          17      CALL    INIT_FILE
                                
000C55 4C55 FD6E0E          19      LD  L,(IY+14)
000C58 4C58 FD660F          19      LD  H,(IY+15)
000C5B 4C5B FD4E19          19      LD  C,(IY+25)
000C5E 4C5E 18CF            12      JR  S12X1
                                
       4C60                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000C60 4C60 CDA049          17      CALL    SET_FCB
000C63 4C63 CD6E49          17      CALL    GETSEQ
000C66 4C66 CD5B49          17      CALL    RB_READ
000C69 4C69 E5              11      PUSH    HL
000C6A 4C6A CD7B49          17      CALL    SETSEQ
000C6D 4C6D E1              10      POP HL
       4C6E                     SREAD:
000C6E 4C6E C601             7      ADD A,001H
000C70 4C70 D8              11      RET C
                                
000C71 4C71 7D               4      LD  A,L
000C72 4C72 D601             7      SUB 001H
000C74 4C74 9F               4      SBC A,A
000C75 4C75 E603             7      AND 3
000C77 4C77 1F               4      RRA
000C78 4C78 C9              10      RET
                                
       4C79                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000C79 4C79 210100          10      LD  HL,00001H
000C7C 4C7C AF               4      XOR A
000C7D 4C7D C9              10      RET
                                
       4C7E                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000C7E 4C7E 3A4CF3          13      LD  A,(_DVSW)
000C81 4C81 C9              10      RET
                                
       4C82                     _SYS1A:     ;(BDOS)DTAの設定
000C82 4C82 ED532EF3        20      LD  (_DTA),DE
000C86 4C86 AF               4      XOR A
000C87 4C87 C9              10      RET
                                
       4C88                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000C88 4C88 010002          10      LD  BC,512
000C8B 4C8B 11C302          10      LD  DE,707
000C8E 4C8E 210000          10      LD  HL,0
000C91 4C91 DD2138F3        14      LD  IX,_BUF
000C95 4C95 FD2138F3        14      LD  IY,_BUF
000C99 4C99 FD3600F9        19      LD  (IY+0),0F9H
000C9D 4C9D 3E02             7      LD  A,2
000C9F 4C9F C9              10      RET
                                
       4CA0                     _SYS21:     ;(BDOS)ランダムな読み出し
000CA0 4CA0 CDA049          17      CALL    SET_FCB
                                
000CA3 4CA3 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
000CA6 4CA6 FD6622          19      LD  H,(IY+34)
                                
000CA9 4CA9 CD5B49          17      CALL    RB_READ
000CAC 4CAC 18C0            12      JR  SREAD
                                
       4CAE                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
000CAE 4CAE CDBE4B          17      CALL    _SYS0F
000CB1 4CB1 D8              11      RET C
                                
000CB2 4CB2 D5              11      PUSH    DE      ;EX DE,IY
000CB3 4CB3 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000CB5 4CB5 CD9049          17      CALL    GETSIZE
       4CB8                     _S24X1:
000CB8 4CB8 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
000CBB 4CBB FD7422          19      LD  (IY+34),H
000CBE 4CBE FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000CC2 4CC2 FDE3            23      EX  (SP),IY     ;
000CC4 4CC4 D1              10      POP DE      ;
                                
000CC5 4CC5 AF               4      XOR A
000CC6 4CC6 C9              10      RET
                                
       4CC7                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
000CC7 4CC7 E5              11      PUSH    HL
000CC8 4CC8 D5              11      PUSH    DE      ;EX DE,IY
000CC9 4CC9 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000CCB 4CCB CD6E49          17      CALL    GETSEQ
000CCE 4CCE 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       4CD0                     _SYS27:     ;(BDOS)ランダムブロック読み込み
000CD0 4CD0 CDA049          17      CALL    SET_FCB
000CD3 4CD3 E5              11      PUSH    HL
000CD4 4CD4 FD6E21          19      LD  L,(IY+33)
000CD7 4CD7 FD6622          19      LD  H,(IY+34)
000CDA 4CDA 2224F3          16      LD  (RR_LOW),HL
000CDD 4CDD FD6E23          19      LD  L,(IY+35)
000CE0 4CE0 FD6624          19      LD  H,(IY+36)
000CE3 4CE3 2226F3          16      LD  (RR_HIGH),HL
000CE6 4CE6 E1              10      POP HL
000CE7 4CE7 CDDE45          17      CALL    ROM_READ
000CEA 4CEA ED5B24F3        20      LD  DE,(RR_LOW)
000CEE 4CEE FD7321          19      LD  (IY+33),E
000CF1 4CF1 FD7222          19      LD  (IY+34),D
000CF4 4CF4 ED5B26F3        20      LD  DE,(RR_HIGH)
000CF8 4CF8 FD7323          19      LD  (IY+35),E
000CFB 4CFB FD7224          19      LD  (IY+36),D
000CFE 4CFE 9F               4      SBC A,A
000CFF 4CFF C9              10      RET
                                
       4D00                     _SYS2F:
000D00 4D00 44               4      LD  B,H
000D01 4D01 2A2EF3          16      LD  HL,(_DTA)
000D04 4D04 C3EB49          10      JP  DISKIO
                                
       4D07                     INIT_FILE:
000D07 4D07 EB               4      EX  DE,HL
000D08 4D08 1155F3          10      LD  DE,FDRV
000D0B 4D0B 010C00          10      LD  BC,1+8+3
000D0E 4D0E EDB0                    LDIR
000D10 4D10 CD634B          17      CALL    GET_DISK_BANK_FDRV
000D13 4D13 320068          13      LD  (BANK1_SEL),A
000D16 4D16 C9              10      RET
                                
000D17 4D17                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F08 5F08 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F10 5F10 884B884B884B9B4B        DW  _ERROR,_ERROR,_ERROR,_SYS0B
001F18 5F18 AD4BB34BBA4BBE4B        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 144C224C4B4C884B        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 604C884B884B884B        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 794C7E4C824C884C        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 884B884B884BAE4C        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 C74C884B884BD04C        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F58 5F58 884B884B884B004D        DW  _ERROR,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB8 5FB8 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 884B884B884B884B        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
