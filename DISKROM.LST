                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
       0159                     CALBAS  EQU 00159H
                                
       269A                     DECADD  EQU 0269AH
       27E6                     DECMUL  EQU 027E6H
       2F8A                     FRCINT  EQU 02F8AH
                                
       303A                     FRCDBL  EQU 0303AH
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
       7D17                     ST_BAS  EQU 07D17H
                                
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F847                     ARG EQU 0F847H
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCC9                     SLTATR  EQU 0FCC9H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
       FD99                     DEVICE  EQU 0FD99H
                                
       FDDB                     H_PINL  EQU 0FDDBH
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                            ;ASCII-16K
                                ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
                                ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
       F280                     ISC EQU 0F280H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F280                     SP32    EQU 0F280H
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM    ; Main program execution address.
000004 4004 894E                    DW  STATEMENT   ; STATEMENT
000006 4006 A64F                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C3F750          10      JP  DISKIO
000013 4013 C33251          10      JP  DSKCHG
000016 4016 C38851          10      JP  GETDPB
000019 4019 C37B52          10      JP  CHOICE
00001C 401C C37F52          10      JP  DSKFMT
00001F 401F C38152          10      JP  DSKSTP
000022 4022 C38252          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C37F52          10      JP  DSKFMT
000029 4029 C38152          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3BB52          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.5.0.0",0
            204449534B20524F    
            4D204C6974652076    
            302E352E302E3000    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 AF               4      XOR A
000107 4107 2100F3          10      LD  HL,0F300H
00010A 410A 0668             7      LD  B,068H
00010C 410C CD3D4B          17      CALL    FILL_MEMORY
                                
00010F 410F 3E01             7      LD  A,1
000111 4111 3221FB          13      LD  (DRVTBL),A
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  HL,(STKTOP) ;起動時の空き容量表示の為
                                    LD  BC,-00140H
                                    ADD HL,BC
                                    LD  (STKTOP),HL
                                #else
000114 4114 2175F6          10      LD  HL,STKTOP+1 ;起動時の空き容量表示の為
000117 4117 35              11      DEC (HL)
                                #endif
                                
000118 4118 AF               4      XOR A
000119 4119 32EAF2          13      LD  (_DVSW),A
00011C 411C 3D               4      DEC A       ;0FFH
00011D 411D 3299FD          13      LD  (DEVICE),A
                                
000120 4120 210643          10      LD  HL,AT_ISC
000123 4123 1180F2          10      LD  DE,ISC
000126 4126 018800          10      LD  BC,ISC_E-ISC
000129 4129 EDB0                    LDIR
                                    
00012B 412B 3EC3             7      LD  A,0C3H      ;JP
00012D 412D 3243FF          13      LD  (H_GONE),A
000130 4130 327DF3          13      LD  (BDOS),A
000133 4133 326BF3          13      LD  (RAMUSE),A
000136 4136 3268F3          13      LD  (ROMUSE),A
000139 4139 2180F2          10      LD  HL,REPLACE_COMMAND
00013C 413C 2244FF          16      LD  (H_GONE+1),HL
00013F 413F 2131F3          10      LD  HL,H_BDOS
000142 4142 227EF3          16      LD  (BDOS+1),HL
000145 4145 21ABF2          10      LD  HL,RAMUSE1
000148 4148 226CF3          16      LD  (RAMUSE+1),HL
00014B 414B 21BEF2          10      LD  HL,ROMUSE1
00014E 414E 2269F3          16      LD  (ROMUSE+1),HL
                                
000151 4151 3E                      DB  03EH
000152 4152 F7              12      RST 30H
000153 4153 3271FE          13      LD  (H_BINS),A
000156 4156 3276FE          13      LD  (H_BINL),A
000159 4159 327BFE          13      LD  (H_FILE),A
00015C 415C 3231F3          13      LD  (H_BDOS),A
00015F 415F 32DBFD          13      LD  (H_PINL),A
000162 4162 32A7FF          13      LD  (H_PHYD),A
                                
000165 4165 CD5242          17      CALL    GTSL1_
000168 4168 3297F2          13      LD  (ROM_SLT),A
00016B 416B 32A7F2          13      LD  (ROM_SLT_COPY),A
00016E 416E 3272FE          13      LD  (H_BINS+1),A
000171 4171 3277FE          13      LD  (H_BINL+1),A
000174 4174 327CFE          13      LD  (H_FILE+1),A
000177 4177 3232F3          13      LD  (H_BDOS+1),A
00017A 417A 32DCFD          13      LD  (H_PINL+1),A
00017D 417D 32A8FF          13      LD  (H_PHYD+1),A
000180 4180 3222FB          13      LD  (DRVTBL+1),A
000183 4183 3248F3          13      LD  (MASTERS),A
                                
000186 4186 214045          10      LD  HL,ROM_LOAD
000189 4189 2273FE          16      LD  (H_BINS+2),HL
00018C 418C 21F146          10      LD  HL,ROM_RUN
00018F 418F 2278FE          16      LD  (H_BINL+2),HL
000192 4192 21FF46          10      LD  HL,ROM_FILES
000195 4195 227DFE          16      LD  (H_FILE+2),HL
000198 4198 212353          10      LD  HL,ROM_BDOS
00019B 419B 2233F3          16      LD  (H_BDOS+2),HL
00019E 419E 21C943          10      LD  HL,ROM_BOOT
0001A1 41A1 22DDFD          16      LD  (H_PINL+2),HL
0001A4 41A4 21F750          10      LD  HL,DISKIO
0001A7 41A7 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001AA 41AA 3E                      DB  03EH
0001AB 41AB C9              10      RET
0001AC 41AC 327FFE          13      LD  (H_FILE+4),A
0001AF 41AF 3275FE          13      LD  (H_BINS+4),A
0001B2 41B2 327AFE          13      LD  (H_BINL+4),A
0001B5 41B5 3235F3          13      LD  (H_BDOS+4),A
0001B8 41B8 32DFFD          13      LD  (H_PINL+4),A
0001BB 41BB 32ABFF          13      LD  (H_PHYD+4),A
                                
0001BE 41BE AF               4      XOR A
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK0_SEL),A       ;似非RAM対策でバンク0を設定
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0001BF 41BF 320060          13      LD  (BANK0_SEL),A           ;似非RAM対策でバンク0を設定
0001C2 41C2 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001C5 41C5 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001C8 41C8 3A0060          13      LD  A,(BANK1_ADR)
0001CB 41CB FE41             7      CP  'A'
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JR  Z,NOT_BANK_TYPE
                                    LD  A,DISK_BANK
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0001CD 41CD 2072            12      JR  NZ,NOT_BANK_TYPE
0001CF 41CF 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001D2 41D2 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001D5 41D5 CD3801          17      CALL    RSLREG      ;read primary slot #
0001D8 41D8 07               4      RLCA
0001D9 41D9 07               4      RLCA
0001DA 41DA F5              11      PUSH    AF
0001DB 41DB 1605             7      LD  D,4+1
0001DD 41DD CD5942          17      CALL    GTSL2_
0001E0 41E0 3244F3          13      LD  (RAMAD3),A
0001E3 41E3 F1              10      POP AF
0001E4 41E4 07               4      RLCA
0001E5 41E5 07               4      RLCA
0001E6 41E6 1603             7      LD  D,2+1
0001E8 41E8 CD5942          17      CALL    GTSL2_
0001EB 41EB 2680             7      LD  H,080H
0001ED 41ED CD7642          17      CALL    CHK_RAM
0001F0 41F0 3243F3          13      LD  (RAMAD2),A
       41F3                     RAMCHK2:
0001F3 41F3 3A44F3          13      LD  A,(RAMAD3)
0001F6 41F6 2640             7      LD  H,040H
0001F8 41F8 CD7642          17      CALL    CHK_RAM
0001FB 41FB 3242F3          13      LD  (RAMAD1),A
       41FE                     RAMCHK1:
0001FE 41FE 3A44F3          13      LD  A,(RAMAD3)
000201 4201 2600             7      LD  H,00H
000203 4203 CD7642          17      CALL    CHK_RAM
000206 4206 3241F3          13      LD  (RAMAD0),A
       4209                     RAMCHK0:
000209 4209 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
00020C 420C 010F00          10      LD  BC,0000FH       ;切り上げ
00020F 420F 09              11      ADD HL,BC
000210 4210 7D               4      LD  A,L
                                
000211 4211 0604             7      LD  B,4
       4213                     B_DRIVE1:
000213 4213 CB3C             8      SRL H
000215 4215 1F               4      RRA
000216 4216 10FB            13      DJNZ    B_DRIVE1
                                
000218 4218 C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
00021A 421A 32E9F2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
                                    ;拡張スロットの選択を設定する
00021D 421D 3A97F2          13      LD  A,(ROM_SLT)
000220 4220 57               4      LD  D,A
000221 4221 E60C             7      AND 00CH
000223 4223 5F               4      LD  E,A
000224 4224 7A               4      LD  A,D
000225 4225 E603             7      AND 3
000227 4227 87               4      ADD A,A
000228 4228 87               4      ADD A,A
000229 4229 87               4      ADD A,A
00022A 422A 37               4      SCF
00022B 422B 8F               4      ADC A,A
00022C 422C B3               4      OR  E
00022D 422D 5F               4      LD  E,A
00022E 422E 1600             7      LD  D,0
000230 4230 21C9FC          10      LD  HL,SLTATR
000233 4233 19              11      ADD HL,DE
000234 4234 3660            10      LD  (HL),060H
000236 4236 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00023A 423A DD21177D        14      LD  IX,ST_BAS   ;continue start of MSX-BASIC without executing BASIC programs in ROM
00023E 423E C35901          10      JP  CALBAS
                                
       4241                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
000241 4241 210C44          10      LD  HL,MSG_ERROR_ROM_MODE
000244 4244 CD9143          17      CALL    MSX
000247 4247 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00024B 424B DD219F00        14      LD  IX,CHGET
00024F 424F C31C00          10      JP  _CALSLT
                                
       4252                     GTSL1_:             ;自分のいるスロットを知る
000252 4252 CD3801          17      CALL    RSLREG      ;read primary slot #
000255 4255 0F               4      RRCA
000256 4256 0F               4      RRCA
000257 4257 1601             7      LD  D,1
       4259                     GTSL2_:
000259 4259 E603             7      AND 3       ;[A]=000000PP
00025B 425B 5F               4      LD  E,A     ;[E]=000000PP
00025C 425C 21C1FC          10      LD  HL,EXPTBL
00025F 425F 85               4      ADD A,L     ;桁上りは無い
000260 4260 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000261 4261 7B               4      LD  A,E     ;[A]=000000PP
000262 4262 CB7E            13      BIT 7,(HL)
000264 4264 C8              11      RET Z
000265 4265 7D               4      LD  A,L     ;point to SLTTBL entry
000266 4266 C604             7      ADD A,4     ;桁上りは無い
000268 4268 6F               4      LD  L,A
000269 4269 7E               7      LD  A,(HL)      ;get currently expansion slot register
       426A                     GTSL3_:
00026A 426A 15               4      DEC D
00026B 426B 2803            12      JR  Z,GTSL4_:
00026D 426D 0F               4      RRCA
00026E 426E 18FA            12      JR  GTSL3_:
       4270                     GTSL4_:
000270 4270 E60C             7      AND 00CH        ;[A] = 0000SS00
000272 4272 B3               4      OR  E       ;[A] = 0000SSPP
000273 4273 F680             7      OR  080H        ;[A] = 1000SSPP
000275 4275 C9              10      RET
                                
       4276                     CHK_RAM:
000276 4276 E5              11      PUSH    HL
000277 4277 CDCB42          17      CALL    CHK_RAM0
00027A 427A E1              10      POP HL
00027B 427B C8              11      RET Z
00027C 427C 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
00027F 427F E680             7      AND 080H
000281 4281 CDA242          17      CALL    CHK_RAM_SLT
000284 4284 C8              11      RET Z
000285 4285 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000288 4288 E680             7      AND 080H
00028A 428A C601             7      ADD A,1
00028C 428C CDA242          17      CALL    CHK_RAM_SLT
00028F 428F C8              11      RET Z
000290 4290 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000293 4293 E680             7      AND 080H
000295 4295 C602             7      ADD A,2
000297 4297 CDA242          17      CALL    CHK_RAM_SLT
00029A 429A C8              11      RET Z
00029B 429B 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
00029E 429E E680             7      AND 080H
0002A0 42A0 C603             7      ADD A,3
       42A2                     CHK_RAM_SLT:
0002A2 42A2 E5              11      PUSH    HL
0002A3 42A3 CDCB42          17      CALL    CHK_RAM0        ;スロット#X or X-0
0002A6 42A6 E1              10      POP HL
0002A7 42A7 C8              11      RET Z
0002A8 42A8 CB79             8      BIT 7,C
0002AA 42AA 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
0002AC 42AC 79               4      LD  A,C
0002AD 42AD C604             7      ADD A,4*1           ;スロット#X-1
0002AF 42AF E5              11      PUSH    HL
0002B0 42B0 CDCB42          17      CALL    CHK_RAM0
0002B3 42B3 E1              10      POP HL
0002B4 42B4 C8              11      RET Z
0002B5 42B5 79               4      LD  A,C
0002B6 42B6 C608             7      ADD A,4*2           ;スロット#X-2
0002B8 42B8 E5              11      PUSH    HL
0002B9 42B9 CDCB42          17      CALL    CHK_RAM0
0002BC 42BC E1              10      POP HL
0002BD 42BD C8              11      RET Z
0002BE 42BE 79               4      LD  A,C
0002BF 42BF C60C             7      ADD A,4*3           ;スロット#X-3
0002C1 42C1 E5              11      PUSH    HL
0002C2 42C2 CDCB42          17      CALL    CHK_RAM0
0002C5 42C5 E1              10      POP HL
       42C6                     CHK_RAM_E:
0002C6 42C6 AF               4      XOR A
0002C7 42C7 3C               4      INC A           ;ZF=0にする
0002C8 42C8 3E00             7      LD  A,0
0002CA 42CA C9              10      RET
                                
       42CB                     CHK_RAM0:
0002CB 42CB 4F               4      LD  C,A
0002CC 42CC 3A97F2          13      LD  A,(ROM_SLT)
0002CF 42CF B9               4      CP  C
0002D0 42D0 28F4            12      JR  Z,CHK_RAM_E
0002D2 42D2 2E00             7      LD  L,0
       42D4                     CHK_RAM1:
0002D4 42D4 79               4      LD  A,C
0002D5 42D5 CDC143          17      CALL    RDSLTX
0002D8 42D8 C6E5             7      ADD A,0E5H
0002DA 42DA 47               4      LD  B,A
0002DB 42DB 5F               4      LD  E,A
0002DC 42DC 79               4      LD  A,C
0002DD 42DD C5              11      PUSH    BC
0002DE 42DE CD1400          17      CALL    _WRSLT
0002E1 42E1 C1              10      POP BC
0002E2 42E2 79               4      LD  A,C
0002E3 42E3 CDC143          17      CALL    RDSLTX
0002E6 42E6 B8               4      CP  B
0002E7 42E7 C0              11      RET NZ
0002E8 42E8 D6E5             7      SUB 0E5H
0002EA 42EA 79               4      LD  A,C
0002EB 42EB 5F               4      LD  E,A
0002EC 42EC C5              11      PUSH    BC
0002ED 42ED CD1400          17      CALL    _WRSLT
0002F0 42F0 C1              10      POP BC
0002F1 42F1 24               4      INC H
0002F2 42F2 7D               4      LD  A,L
0002F3 42F3 C604             7      ADD A,4
0002F5 42F5 6F               4      LD  L,A
0002F6 42F6 20DC            12      JR  NZ,CHK_RAM1
0002F8 42F8 79               4      LD  A,C     ;ZF=1のハズ
0002F9 42F9 C9              10      RET
                                
       42FA                     CALSLT_R:
0002FA 42FA C5              11      PUSH    BC
0002FB 42FB E5              11      PUSH    HL
0002FC 42FC FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000300 4300 CD1C00          17      CALL    _CALSLT
000303 4303 E1              10      POP HL
000304 4304 C1              10      POP BC
000305 4305 C9              10      RET
                                
       4306                     AT_ISC:
000306 F280                         ORG ISC,AT_ISC-RUN
       F280                     REPLACE_COMMAND:
000306 F280 FEB7             7      CP  0B7H            ;FILES
000308 F282 CC7BFE          17      CALL    Z,H_FILE
00030B F285 FEB5             7      CP  0B5H            ;LOAD
00030D F287 CA71FE          10      JP  Z,H_BINS
000310 F28A FE8A             7      CP  08AH            ;RUN
000312 F28C CA76FE          10      JP  Z,H_BINL
000315 F28F FED6             7      CP  0D6H            ;COPY
000317 F291 2813            12      JR  Z,FIX_COPY
000319 F293 FECF             7      CP  0CFH            ;BLOAD
00031B F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
00031C F296 F7              12      RST 30H
       F297                     ROM_SLT:
00031D F297 00                      DB  0
00031E F298 2246                    DW  ROM_BLOAD
000320 F29A F5              11      PUSH    AF
000321 F29B E5              11      PUSH    HL
000322 F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
000325 F29F E1              10      POP HL
000326 F2A0 F1              10      POP AF
000327 F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
000329 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
00032B F2A5 C9              10      RET
       F2A6                     FIX_COPY:
00032C F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
00032D F2A7 00                      DB  0
00032E F2A8 9D47                    DW  ROM_COPY
000330 F2AA C9              10      RET
       F2AB                     RAMUSE1:
000331 F2AB 3A42F3          13      LD  A,(RAMAD1)
       F2AE                     ROMUSE2:
000334 F2AE C32400          10      JP  _ENASLT
       F2B1                     CAL_MP:
000337 F2B1 2640             7      LD  H,040H
000339 F2B3 3AC1FC          13      LD  A,(EXPTBL)
00033C F2B6 CD2400          17      CALL    _ENASLT
00033F F2B9 CD1C00          17      CALL    _CALSLT
000342 F2BC 2640             7      LD  H,040H
       F2BE                     ROMUSE1:
000344 F2BE 3A97F2          13      LD  A,(ROM_SLT)
000347 F2C1 18EB            12      JR  ROMUSE2
                                
       F2C3                     _RESULT:
000349 F2C3 00                      DB  0
       F2C4                     _BANK:
00034A F2C4 00                      DB  0
       F2C5                     _BANK1:
00034B F2C5 00                      DB  0
       F2C6                     CLSZ:               ;クラスタサイズ
00034C F2C6 0004                    DW  1024
       F2C7                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2C8                     SECSZ:              ;セクタサイズ
00034E F2C8 0002                    DW  512
       F2C9                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2CA                     RR_LOW:
000350 F2CA 0000                    DW  0
       F2CB                     RR_MID  EQU $-1
       F2CC                     RR_HIGH:
000352 F2CC 0000                    DW  0
       F2CE                     _CLPS:
000354 F2CE 0000                    DW  0
       F2D0                     _LEFT:
000356 F2D0 0000                    DW  0
       F2D2                     _DTPS:
000358 F2D2 0000                    DW  0
       F2D4                     _DTA:
00035A F2D4 0000                    DW  0
       F2D6                     FLG_LDIR:
00035C F2D6 00                      DB  0
       F2D7                     _FCB:
00035D F2D7 0000                    DW  0
       F2D9                     _BUF:
       F2D9                     _BUF_LO:        ;LOGICAL OPERATION
00035F F2D9 00                      DB  0
       F2DA                     _BUF_ST:
000360 F2DA 0000                    DW  0
       F2DC                     _BUF_EN:
000362 F2DC 0000                    DW  0
       F2DE                     _BUF_EX:
       F2DE                     _BUF_W:
000364 F2DE 0000                    DW  0
       F2E0                     _BUF_H:
000366 F2E0 0000                    DW  0
       F2E2                     _BUF_X:
000368 F2E2 0000                    DW  0
       F2E4                     _BUF_Y:
00036A F2E4 00                      DB  0
       F2E5                     _BUF_P:
00036B F2E5 00                      DB  0
       F2E6                     _BUF_O:
00036C F2E6 00                      DB  0
       F2E7                     DTAX:
00036D F2E7 0000                    DW  0
       F2E9                     B_DRIVE:
00036F F2E9 00                      DB  0
       F2EA                     _DVSW:          ;カレントドライブ
000370 F2EA 00                      DB  0
       F2EB                     _CD:            ;カレントディレクトリ
000371 F2EB 0000                    DW  0
       F2ED                     DIRENT1:
000373 F2ED 0000                    DW  0
       F2EF                     _DIR_BANK:
000375 F2EF 00                      DB  0
       F2F0                     LEFTX:
000376 F2F0 0000                    DW  0
       F2F2                     PARAM0:
000378 F2F2 0000                    DW  0
       F2F4                     PARAM1:
00037A F2F4 0000                    DW  0
       F2F6                     _CDX:
00037C F2F6 0000                    DW  0
       F2F8                     FDRV:
00037E F2F8 00                      DB  0
       F2F9                     FNAME:
00037F F2F9                         DS  8+3
       F304                     _HL:
00038A F304 0000                    DW  0
       F306                     _SP:
00038C F306 0000                    DW  0
       F307                     _SP_H   EQU $-1
       F308                     ISC_E:
00038E 438E                         ORG $$+RUN          ;$DEPHASE
                                
       438E                     MSX1:
00038E 438E CD3C53          17      CALL    MSGA1
       4391                     MSX:
000391 4391 7E               7      LD  A,(HL)
000392 4392 23               6      INC HL
000393 4393 B7               4      OR  A
000394 4394 20F8            12      JR  NZ,MSX1
000396 4396 C9              10      RET
                                
       4397                     PRTHX:
000397 4397 F5              11      PUSH    AF
000398 4398 07               4      RLCA
000399 4399 07               4      RLCA
00039A 439A 07               4      RLCA
00039B 439B 07               4      RLCA
00039C 439C CDA043          17      CALL    PRTA2
00039F 439F F1              10      POP AF
       43A0                     PRTA2:
0003A0 43A0 CDA643          17      CALL    ASC
0003A3 43A3 C33853          10      JP  MSG_A
                                    
       43A6                     ASC:
0003A6 43A6 E60F             7      AND $0F
0003A8 43A8 F630             7      OR  $30
0003AA 43AA FE3A             7      CP  $3A
0003AC 43AC D8              11      RET C
0003AD 43AD C607             7      ADD A,7
0003AF 43AF C9              10      RET
                                
       43B0                     MSN:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
0003B0 43B0 7E               7      LD  A,(HL)
                                #endif
0003B1 43B1 23               6      INC HL
0003B2 43B2 CD3853          17      CALL    MSG_A
0003B5 43B5 10F9            13      DJNZ    MSN
0003B7 43B7 C9              10      RET
                                
       43B8                     RDSLT_ROM3:
0003B8 43B8 7E               7      LD  A,(HL)
0003B9 43B9 C9              10      RET
       43BA                     RDSLT_ROM:
0003BA 43BA CB7C             8      BIT 7,H
0003BC 43BC 28FA            12      JR  Z,RDSLT_ROM3
       43BE                     RDSLT_ROM2:
0003BE 43BE 3A97F2          13      LD  A,(ROM_SLT)
       43C1                     RDSLTX:
0003C1 43C1 C5              11      PUSH    BC
0003C2 43C2 D5              11      PUSH    DE
0003C3 43C3 CD0C00          17      CALL    _RDSLT
0003C6 43C6 D1              10      POP DE
0003C7 43C7 C1              10      POP BC
0003C8 43C8 C9              10      RET
                                
       43C9                     ROM_BOOT:
0003C9 43C9 3E                      DB  03EH
0003CA 43CA C9              10      RET
0003CB 43CB 32DBFD          13      LD  (H_PINL),A
0003CE 43CE 3ACAFF          13      LD  A,(EXTBIO)
0003D1 43D1 FEF7             7      CP  0F7H        ;RST 30H
0003D3 43D3 280A            12      JR  Z,EXTBIO_OK
0003D5 43D5 3E                      DB  03EH
0003D6 43D6 C9              10      RET
0003D7 43D7 21CAFF          10      LD  HL,EXTBIO
0003DA 43DA 061D             7      LD  B,29
0003DC 43DC CD3D4B          17      CALL    FILL_MEMORY
       43DF                     EXTBIO_OK:
0003DF 43DF 213244          10      LD  HL,DELOK
0003E2 43E2 CD9143          17      CALL    MSX
                                
0003E5 43E5 AF               4      XOR A
0003E6 43E6 3240F3          13      LD  (REBOOT),A
0003E9 43E9 2A48FC          16      LD  HL,(BOTTOM)
0003EC 43EC 110040          10      LD  DE,16384
0003EF 43EF 19              11      ADD HL,DE
0003F0 43F0 3817            12      JR  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
0003F2 43F2 57               4      LD  D,A
0003F3 43F3 0601             7      LD  B,1
0003F5 43F5 2100C0          10      LD  HL,0C000H
0003F8 43F8 CDF750          17      CALL    DISKIO
                                
0003FB 43FB 116BF3          10      LD  DE,RAMUSE
0003FE 43FE AF               4      XOR A
0003FF 43FF CD1EC0          17      CALL    0C01EH
000402 4402 116BF3          10      LD  DE,RAMUSE
000405 4405 37               4      SCF
000406 4406 CD1EC0          17      CALL    0C01EH
       4409                     BOOT1:
000409 4409 C38252          10      JP  BASENT
                                
       440C                     MSG_ERROR_ROM_MODE:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DB  "Normal ROM/ASCII-16K only!",13,10
                                #else
00040C 440C 41534349492D384B        DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
            2F4B6F6E616D692D    
            384B2F4B6F6E616D    
            692D534343206F6E    
            6C79210D0A          
                                #endif
       4431                     NULL:
000431 4431 00                      DB  0
       4432                     DELOK:
000432 4432 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       4436                     ROM_LDIR:
000436 4436 3AD6F2          13      LD  A,(FLG_LDIR)
000439 4439 B7               4      OR  A
00043A 443A 2008            12      JR  NZ,ROM_LDIRVM
00043C 443C CB7A             8      BIT 7,D
00043E 443E CA5644          10      JP  Z,ROM_LDIRSLT
                                #if exists USE_MORMAL32K_OR_ASCII16
                                LDIRA:
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ1
                                    LD  SP,SP32
                                SPJ1:
                                LDIR1:
                                    LD  A,B
                                    OR  C
                                    JR  Z,LDIRE
                                
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                LDIR2:
                                    LD  A,D
                                    CP  0C0H
                                    JR  NC,LDIR4
                                
                                    PUSH    BC
                                    PUSH    DE
                                    LD  DE,BUF
                                
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIR3
                                    LD  BC,00100H
                                LDIR3:
                                    PUSH    BC
                                    LDIR
                                    LD  (_HL),HL
                                
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                
                                    POP BC
                                    POP DE
                                    LD  HL,BUF
                                    LDIR
                                
                                    LD  HL,(_HL)
                                    POP BC
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIRE
                                    DEC B
                                    JR  LDIR1
                                LDIR4:
                                #endif
000441 4441 EDB0                    LDIR
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                LDIRE2:
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                LDIRE:
                                    LD  SP,(_SP)
                                #endif
000443 4443 C9              10      RET
                                
       4444                     ROM_LDIRVM:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ2
                                    LD  SP,SP32
                                SPJ2:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
000444 4444 C5              11      PUSH    BC
000445 4445 D5              11      PUSH    DE
000446 4446 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00044A 444A DD215C00        14      LD  IX,LDIRVM
00044E 444E CD1C00          17      CALL    _CALSLT
000451 4451 E1              10      POP HL
000452 4452 C1              10      POP BC
000453 4453 09              11      ADD HL,BC
000454 4454 EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JR  LDIRE2
                                #else
000455 4455 C9              10      RET
                                #endif
                                
       4456                     ROM_LDIRSLT:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ3
                                    LD  SP,SP32
                                SPJ3:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
       4456                     ROM_LDIRSLT1:
000456 4456 EB               4      EX  DE,HL
       4457                     RLDIRSLT1:
000457 4457 CB7C             8      BIT 7,H
000459 4459 201F            12      JR  NZ,RLDIRSLT_EXIT
00045B 445B 1A               7      LD  A,(DE)
00045C 445C 13               6      INC DE
00045D 445D C5              11      PUSH    BC
00045E 445E D5              11      PUSH    DE
00045F 445F E5              11      PUSH    HL
000460 4460 5F               4      LD  E,A
                                
000461 4461 0141F3          10      LD  BC,RAMAD0
000464 4464 7C               4      LD  A,H
000465 4465 07               4      RLCA
000466 4466 07               4      RLCA
000467 4467 E603             7      AND 3
000469 4469 81               4      ADD A,C
00046A 446A 4F               4      LD  C,A
00046B 446B 0A               7      LD  A,(BC)
       446C                     RLDIRSLT2:
00046C 446C CD1400          17      CALL    _WRSLT
00046F 446F 08               4      EX  AF,AF'
000470 4470 E1              10      POP HL
000471 4471 D1              10      POP DE
000472 4472 C1              10      POP BC
000473 4473 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
000475 4475 EA5744          10      JP  PE,RLDIRSLT1
000478 4478 EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JP  LDIRE2
                                RLDIRSLT_EXIT:
                                    EX  DE,HL
                                    JP  LDIR1
                                #else
000479 4479 C9              10      RET
       447A                     RLDIRSLT_EXIT:
00047A 447A EB               4      EX  DE,HL
00047B 447B EDB0                    LDIR
00047D 447D C9              10      RET
                                #endif
                                
       447E                     END_OF_LINE:
00047E 447E 215EF5          10      LD  HL,BUF
       4481                     EOL1:
000481 4481 7E               7      LD  A,(HL)
000482 4482 C8              11      RET Z
000483 4483 FE0D             7      CP  00DH
000485 4485 2807            12      JR  Z,EOLE
000487 4487 FE0A             7      CP  00AH
000489 4489 2803            12      JR  Z,EOLE
00048B 448B 23               6      INC HL
00048C 448C 18F3            12      JR  EOL1
       448E                     EOLE:
00048E 448E 3600            10      LD  (HL),0
000490 4490 23               6      INC HL
000491 4491 7E               7      LD  A,(HL)
000492 4492 FE0A             7      CP  00AH
000494 4494 C0              11      RET NZ
000495 4495 23               6      INC HL
000496 4496 C9              10      RET
                                
       4497                     ROM_LOAD_ASCII:
000497 4497 210000          10      LD  HL,0
00049A 449A 22DAF2          16      LD  (_BUF_ST),HL    ;読み出し位置
00049D 449D 2A76F6          16      LD  HL,(TXTTAB)
0004A0 44A0 22DCF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
0004A3 44A3 215EF5          10      LD  HL,BUF
0004A6 44A6 22D4F2          16      LD  (_DTA),HL
       44A9                     RLOAD_A1:
0004A9 44A9 2ADAF2          16      LD  HL,(_BUF_ST)
0004AC 44AC 22CAF2          16      LD  (RR_LOW),HL
0004AF 44AF 210201          10      LD  HL,258
0004B2 44B2 CDBD49          17      CALL    ROM_READ
0004B5 44B5 7C               4      LD  A,H
0004B6 44B6 B5               4      OR  L
0004B7 44B7 2879            12      JR  Z,RLOAD_AEND
0004B9 44B9 015EF5          10      LD  BC,BUF
0004BC 44BC 09              11      ADD HL,BC
0004BD 44BD 3600            10      LD  (HL),0
0004BF 44BF CD7E44          17      CALL    END_OF_LINE
0004C2 44C2 015EF5          10      LD  BC,BUF
0004C5 44C5 A7               4      AND A
0004C6 44C6 ED42            15      SBC HL,BC
0004C8 44C8 2810            12      JR  Z,RLOAD_A2
0004CA 44CA 4D               4      LD  C,L
0004CB 44CB 44               4      LD  B,H
0004CC 44CC ED5BDAF2        20      LD  DE,(_BUF_ST)
0004D0 44D0 19              11      ADD HL,DE
0004D1 44D1 22DAF2          16      LD  (_BUF_ST),HL
0004D4 44D4 3A5EF5          13      LD  A,(BUF)
0004D7 44D7 B7               4      OR  A
0004D8 44D8 28CF            12      JR  Z,RLOAD_A1
       44DA                     RLOAD_A2:
0004DA 44DA 115EF5          10      LD  DE,BUF
0004DD 44DD CD744B          17      CALL    SPCUTEX
0004E0 44E0 1A               7      LD  A,(DE)
0004E1 44E1 B7               4      OR  A
0004E2 44E2 284E            12      JR  Z,RLOAD_AEND
0004E4 44E4 CD864B          17      CALL    GETNUM
0004E7 44E7 7C               4      LD  A,H
0004E8 44E8 B5               4      OR  L
0004E9 44E9 CA0946          10      JP  Z,ERROR_DIRECT_IN_FILE
0004EC 44EC DD2ADCF2        20      LD  IX,(_BUF_EN)
0004F0 44F0 DD7502          19      LD  (IX+2),L
0004F3 44F3 DD7403          19      LD  (IX+3),H
                                
0004F6 44F6 CD6D4B          17      CALL    SPCUT
0004F9 44F9 EB               4      EX  DE,HL
0004FA 44FA DDE5            15      PUSH    IX
0004FC 44FC DD21B242        14      LD  IX,CRUNCH
000500 4500 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000504 4504 CD1C00          17      CALL    _CALSLT
000507 4507 DDE1            14      POP IX
000509 4509 EB               4      EX  DE,HL
00050A 450A 111FF4          10      LD  DE,KBUF
00050D 450D 37               4      SCF
00050E 450E ED52            15      SBC HL,DE
000510 4510 CA0946          10      JP  Z,ERROR_DIRECT_IN_FILE
000513 4513 DA0946          10      JP  C,ERROR_DIRECT_IN_FILE
000516 4516 4D               4      LD  C,L
000517 4517 44               4      LD  B,H
000518 4518 2ADCF2          16      LD  HL,(_BUF_EN)
00051B 451B 110400          10      LD  DE,4
00051E 451E 19              11      ADD HL,DE
00051F 451F 111FF4          10      LD  DE,KBUF
                                
000522 4522 EB               4      EX  DE,HL
000523 4523 EDB0                    LDIR
000525 4525 EB               4      EX  DE,HL
                                
000526 4526 DD7500          19      LD  (IX+0),L
000529 4529 DD7401          19      LD  (IX+1),H
00052C 452C 22DCF2          16      LD  (_BUF_EN),HL
00052F 452F C3A944          10      JP  RLOAD_A1
                                
       4532                     RLOAD_AEND:
000532 4532 2ADCF2          16      LD  HL,(_BUF_EN)
000535 4535 AF               4      XOR A
000536 4536 77               7      LD  (HL),A
000537 4537 23               6      INC HL
000538 4538 77               7      LD  (HL),A
000539 4539 23               6      INC HL
00053A 453A 22DCF2          16      LD  (_BUF_EN),HL
00053D 453D C3CC45          10      JP  RLOAD_END1
                                
       4540                     ROM_LOAD:
000540 4540 CD6B47          17      CALL    INIT_PARAM
000543 4543 7E               7      LD  A,(HL)
000544 4544 FE2C             7      CP  ','
000546 4546 2003            12      JR  NZ,ROM_LOAD0
000548 4548 23               6      INC HL
000549 4549 7E               7      LD  A,(HL)
00054A 454A 2B               6      DEC HL
       454B                     ROM_LOAD0:
00054B 454B 32BEFC          13      LD  (RUNBNF),A
00054E 454E CD5E4A          17      CALL    FILE_B
000551 4551 3AF9F2          13      LD  A,(FNAME)
000554 4554 FE20             7      CP  020H
000556 4556 CA594A          10      JP  Z,ROM_ORG
                                
000559 4559 CDDD4B          17      CALL    ROM_OPEN
00055C 455C DA1546          10      JP  C,ERROR_FILE_NOT_FOUND
       455F                     ROM_LOAD1:
00055F 455F 21D9F2          10      LD  HL,_BUF
000562 4562 22D4F2          16      LD  (_DTA),HL
000565 4565 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
000568 4568 CDBD49          17      CALL    ROM_READ
00056B 456B 3AD9F2          13      LD  A,(_BUF)
00056E 456E 3C               4      INC A
00056F 456F C29744          10      JP  NZ,ROM_LOAD_ASCII
000572 4572 2A76F6          16      LD  HL,(TXTTAB)
000575 4575 22D4F2          16      LD  (_DTA),HL
000578 4578 EB               4      EX  DE,HL
000579 4579 2100FF          10      LD  HL,-256
00057C 457C 39              11      ADD HL,SP
00057D 457D ED52            15      SBC HL,DE
00057F 457F CDBD49          17      CALL    ROM_READ
000582 4582 ED5BD4F2        20      LD  DE,(_DTA)
000586 4586 19              11      ADD HL,DE
000587 4587 E5              11      PUSH    HL
000588 4588 2A76F6          16      LD  HL,(TXTTAB)
       458B                     ROM_LOAD2:          ;リンクポインタをFIX
00058B 458B E5              11      PUSH    HL
00058C 458C DDE1            14      POP IX
00058E 458E 7E               7      LD  A,(HL)      ;リンクポインタL
00058F 458F 23               6      INC HL
000590 4590 B6               7      OR  (HL)        ;リンクポインタH
000591 4591 23               6      INC HL
000592 4592 2837            12      JR  Z,RLOAD_END0
000594 4594 23               6      INC HL      ;行番号
000595 4595 23               6      INC HL      ;行番号
       4596                     ROM_LOAD3:
000596 4596 7E               7      LD  A,(HL)
000597 4597 23               6      INC HL
000598 4598 FE0B             7      CP  00BH        ;8進数(&O)
00059A 459A 2822            12      JR  Z,INC_HL2
00059C 459C FE0C             7      CP  00CH        ;16進数(&H)
00059E 459E 281E            12      JR  Z,INC_HL2
0005A0 45A0 FE0D             7      CP  00DH        ;行番号(RUN後)
0005A2 45A2 281A            12      JR  Z,INC_HL2
0005A4 45A4 FE0E             7      CP  00EH        ;行番号(RUN前)
0005A6 45A6 2816            12      JR  Z,INC_HL2
0005A8 45A8 FE0F             7      CP  00FH        ;10～255の整数(%)
0005AA 45AA 2813            12      JR  Z,INC_HL1
0005AC 45AC FE1C             7      CP  01CH        ;256～65535の整数(%)
0005AE 45AE 280E            12      JR  Z,INC_HL2
0005B0 45B0 FE1D             7      CP  01DH        ;単精度実数(!)
0005B2 45B2 2808            12      JR  Z,INC_HL4
0005B4 45B4 FE1F             7      CP  01FH        ;倍制度実数(#)
0005B6 45B6 2008            12      JR  NZ,INC_HL0
0005B8 45B8 23               6      INC HL
0005B9 45B9 23               6      INC HL
0005BA 45BA 23               6      INC HL
0005BB 45BB 23               6      INC HL
       45BC                     INC_HL4:
0005BC 45BC 23               6      INC HL
0005BD 45BD 23               6      INC HL
       45BE                     INC_HL2:
0005BE 45BE 23               6      INC HL
       45BF                     INC_HL1:
0005BF 45BF 23               6      INC HL
       45C0                     INC_HL0:
0005C0 45C0 B7               4      OR  A
0005C1 45C1 20D3            12      JR  NZ,ROM_LOAD3
0005C3 45C3 DD7500          19      LD  (IX+0),L
0005C6 45C6 DD7401          19      LD  (IX+1),H
0005C9 45C9 18C0            12      JR  ROM_LOAD2
       45CB                     RLOAD_END0:
0005CB 45CB E1              10      POP HL
       45CC                     RLOAD_END1:
0005CC 45CC 22C2F6          16      LD  (VARTAB),HL
0005CF 45CF 22C4F6          16      LD  (ARYTAB),HL
0005D2 45D2 22C6F6          16      LD  (STREND),HL
                                
0005D5 45D5 3ABEFC          13      LD  A,(RUNBNF)
0005D8 45D8 CDC74B          17      CALL    CAP
0005DB 45DB FE52             7      CP  'R'
0005DD 45DD 280E            12      JR  Z,RLOAD_END2
0005DF 45DF AF               4      XOR A
0005E0 45E0 21DCF2          10      LD  HL,_BUF+3
0005E3 45E3 77               7      LD  (HL),A      ;3
0005E4 45E4 2B               6      DEC HL
0005E5 45E5 77               7      LD  (HL),A      ;2
0005E6 45E6 2B               6      DEC HL
0005E7 45E7 77               7      LD  (HL),A      ;1
0005E8 45E8 2B               6      DEC HL
0005E9 45E9 3E8F             7      LD  A,08FH      ;REM
0005EB 45EB 77               7      LD  (HL),A      ;0
0005EC 45EC C9              10      RET
       45ED                     RLOAD_END2:
0005ED 45ED D5              11      PUSH    DE
0005EE 45EE ED5B76F6        20      LD  DE,(TXTTAB)
0005F2 45F2 1B               6      DEC DE
0005F3 45F3 AF               4      XOR A
0005F4 45F4 21DFF2          10      LD  HL,_BUF+6
0005F7 45F7 77               7      LD  (HL),A      ;6
0005F8 45F8 2B               6      DEC HL
0005F9 45F9 77               7      LD  (HL),A      ;5
0005FA 45FA 2B               6      DEC HL
0005FB 45FB 77               7      LD  (HL),A      ;4
0005FC 45FC 2B               6      DEC HL
0005FD 45FD 72               7      LD  (HL),D      ;3 行番号H
0005FE 45FE 2B               6      DEC HL
0005FF 45FF 73               7      LD  (HL),E      ;2 行番号L
000600 4600 2B               6      DEC HL
000601 4601 360D            10      LD  (HL),00DH   ;1 行番号(RUN後)
000603 4603 2B               6      DEC HL
000604 4604 3E89             7      LD  A,089H      ;GOTO
000606 4606 77               7      LD  (HL),A      ;0
000607 4607 D1              10      POP DE
000608 4608 C9              10      RET
                                
       4609                     ERROR_DIRECT_IN_FILE:
000609 4609 1E39             7      LD  E,57            ;Direct statement in file
00060B 460B 01                      DB  1           ;LD BC,
       460C                     ERROR_DEVICE_IO_ERROR:
00060C 460C 1E13             7      LD  E,19            ;Device I/O error
00060E 460E 01                      DB  1           ;LD BC,
       460F                     ERROR_INTERNAL_ERROR:
00060F 460F 1E33             7      LD  E,51            ;Internal error
000611 4611 01                      DB  1           ;LD BC,
       4612                     ERROR_FILE_NOT_OPEN:
000612 4612 1E3B             7      LD  E,59            ;File not OPEN
000614 4614 01                      DB  1           ;LD BC,
       4615                     ERROR_FILE_NOT_FOUND:
000615 4615 1E35             7      LD  E,53            ;File not found
       4617                     ERROR:
000617 4617 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00061B 461B DD216F40        14      LD  IX,ERRHAND
00061F 461F C31C00          10      JP  _CALSLT
                                
       4622                     ROM_BLOAD:
000622 4622 CD6B47          17      CALL    INIT_PARAM
000625 4625 CD5E4A          17      CALL    FILE_B
000628 4628 CDDD4B          17      CALL    ROM_OPEN
00062B 462B 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
00062D 462D 21D9F2          10      LD  HL,_BUF
000630 4630 22D4F2          16      LD  (_DTA),HL
000633 4633 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
000636 4636 CDBD49          17      CALL    ROM_READ
000639 4639 3AD9F2          13      LD  A,(_BUF)
00063C 463C FEFE             7      CP  0FEH
00063E 463E 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
000640 4640 21A5F2          10      LD  HL,BLOAD_RET
000643 4643 229DF2          16      LD  (SWC_BLOAD),HL
                                
000646 4646 2AF4F2          16      LD  HL,(PARAM1)
000649 4649 7E               7      LD  A,(HL)
00064A 464A FE2C             7      CP  ','
00064C 464C 2049            12      JR  NZ,RBREAD_MEM
00064E 464E 23               6      INC HL
00064F 464F 7E               7      LD  A,(HL)
000650 4650 CDC74B          17      CALL    CAP
000653 4653 32BEFC          13      LD  (RUNBNF),A
000656 4656 FE52             7      CP  'R'     ;R,Sスイッチじゃ無い場合はオフセット値として処理する
000658 4658 2808            12      JR  Z,RBOS1
00065A 465A FE53             7      CP  'S'
00065C 465C 2804            12      JR  Z,RBOS1
00065E 465E FE2C             7      CP  ','
000660 4660 200D            12      JR  NZ,RBOS2
       4662                     RBOS1:
000662 4662 7E               7      LD  A,(HL)
000663 4663 23               6      INC HL
000664 4664 B7               4      OR  A
000665 4665 2824            12      JR  Z,RBREAD_OSE
000667 4667 FE3A             7      CP  ':'
000669 4669 2820            12      JR  Z,RBREAD_OSE
00066B 466B FE2C             7      CP  ','     ;次のパラメータを探す
00066D 466D 20F3            12      JR  NZ,RBOS1
       466F                     RBOS2:              ;オフセット
00066F 466F 22F4F2          16      LD  (PARAM1),HL
000672 4672 7E               7      LD  A,(HL)
000673 4673 B7               4      OR  A
000674 4674 2815            12      JR  Z,RBREAD_OSE
000676 4676 DD212F54        14      LD  IX,FRMQNT
00067A 467A FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00067E 467E CD1C00          17      CALL    _CALSLT
000681 4681 22F4F2          16      LD  (PARAM1),HL
000684 4684 2ADAF2          16      LD  HL,(_BUF_ST)
000687 4687 19              11      ADD HL,DE
000688 4688 22DAF2          16      LD  (_BUF_ST),HL
       468B                     RBREAD_OSE:
00068B 468B 3ABEFC          13      LD  A,(RUNBNF)
00068E 468E FE53             7      CP  'S'
000690 4690 2005            12      JR  NZ,RBREAD_MEM
000692 4692 3E01             7      LD  A,1
000694 4694 32D6F2          13      LD  (FLG_LDIR),A
       4697                     RBREAD_MEM:
000697 4697 2ADAF2          16      LD  HL,(_BUF_ST)
00069A 469A 22BFFC          16      LD  (SAVENT),HL
00069D 469D 22D4F2          16      LD  (_DTA),HL
0006A0 46A0 21FFFF          10      LD  HL,0FFFFH
0006A3 46A3 CDBD49          17      CALL    ROM_READ
0006A6 46A6 AF               4      XOR A
0006A7 46A7 32D6F2          13      LD  (FLG_LDIR),A
0006AA 46AA 3ABEFC          13      LD  A,(RUNBNF)
0006AD 46AD FE52             7      CP  'R'
0006AF 46AF 2006            12      JR  NZ,RBREAD1
0006B1 46B1 2ADEF2          16      LD  HL,(_BUF_EX)
0006B4 46B4 229DF2          16      LD  (SWC_BLOAD),HL
       46B7                     RBREAD1:
       46B7                     ROM_NEXT:
0006B7 46B7 2AF4F2          16      LD  HL,(PARAM1)
0006BA 46BA 7E               7      LD  A,(HL)
0006BB 46BB 2B               6      DEC HL
0006BC 46BC B7               4      OR  A
0006BD 46BD 2805            12      JR  Z,ROM_NEXT1
0006BF 46BF FE3A             7      CP  ':'
0006C1 46C1 2801            12      JR  Z,ROM_NEXT1
0006C3 46C3 23               6      INC HL
       46C4                     ROM_NEXT1:
0006C4 46C4 5D               4      LD  E,L
0006C5 46C5 54               4      LD  D,H
                                
0006C6 46C6 CD9D4B          17      CALL    SEARCH_END
0006C9 46C9 B7               4      OR  A
0006CA 46CA 2821            12      JR  Z,REM
       46CC                     RN3:                    ;マルチステートメントの処理
0006CC 46CC 7E               7      LD  A,(HL)
                                
0006CD 46CD FEB5             7      CP  0B5H            ;LOAD
0006CF 46CF CA4045          10      JP  Z,ROM_LOAD
0006D2 46D2 FE8A             7      CP  08AH            ;RUN
0006D4 46D4 281B            12      JR  Z,ROM_RUN
0006D6 46D6 FEB7             7      CP  0B7H            ;FILES
0006D8 46D8 2825            12      JR  Z,ROM_FILES
0006DA 46DA FED6             7      CP  0D6H            ;COPY
0006DC 46DC CA9D47          10      JP  Z,ROM_COPY
0006DF 46DF FE20             7      CP  020H
0006E1 46E1 2807            12      JR  Z,RN_SP
                                
0006E3 46E3 3E28             7      LD  A,028H          ;JR Z,
0006E5 46E5 32A3F2          13      LD  (SWC_BLOAD_M),A
0006E8 46E8 7E               7      LD  A,(HL)
0006E9 46E9 C9              10      RET
       46EA                     RN_SP:
0006EA 46EA 23               6      INC HL
0006EB 46EB 18DF            12      JR  RN3
                                
       46ED                     REM:
0006ED 46ED EB               4      EX  DE,HL
0006EE 46EE 3E8F             7      LD  A,08FH          ;REM
0006F0 46F0 C9              10      RET
                                
       46F1                     ROM_RUN:
0006F1 46F1 23               6      INC HL
0006F2 46F2 7E               7      LD  A,(HL)
0006F3 46F3 2B               6      DEC HL
0006F4 46F4 B7               4      OR  A
0006F5 46F5 C44045          17      CALL    NZ,ROM_LOAD
0006F8 46F8 FE8F             7      CP  08FH            ;REM
0006FA 46FA 3E8A             7      LD  A,08AH          ;RUN
0006FC 46FC C0              11      RET NZ
0006FD 46FD 77               7      LD  (HL),A
0006FE 46FE C9              10      RET
                                
       46FF                     ROM_FILES:
0006FF 46FF CD6B47          17      CALL    INIT_PARAM
000702 4702 CD5E4A          17      CALL    FILE_B
000705 4705 CDBF52          17      CALL    GET_DISK_BANK_FDRV
000708 4708 3AC9F2          13      LD  A,(SECSZ_H)
00070B 470B CD7D51          17      CALL    IS_BPB1
00070E 470E DA0C46          10      JP  C,ERROR_DEVICE_IO_ERROR
000711 4711 3AF9F2          13      LD  A,(FNAME)
000714 4714 FE21             7      CP  021H
000716 4716 3005            12      JR  NC,RFILES0
000718 4718 060B             7      LD  B,11
00071A 471A CD314B          17      CALL    FILE10
       471D                     RFILES0:
00071D 471D CD3B4E          17      CALL    GET_DIR_DAT
       4720                     RFILES1:
000720 4720 CDF94B          17      CALL    FILESE
000723 4723 3041            12      JR  NC,RFILES_NOT_MATCH
       4725                     RFILES_DISP:
000725 4725 E5              11      PUSH    HL
000726 4726 110B00          10      LD  DE,0000BH   ;属性
000729 4729 19              11      ADD HL,DE
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
00072A 472A 7E               7      LD  A,(HL)
                                #endif
00072B 472B E1              10      POP HL
00072C 472C CB4F             8      BIT 1,A     ;不可視属性
00072E 472E 2033            12      JR  NZ,RFILES_NEXT
000730 4730 E5              11      PUSH    HL
000731 4731 0608             7      LD  B,8
000733 4733 CDB043          17      CALL    MSN
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000736 4736 7E               7      LD  A,(HL)
                                #endif
000737 4737 FE20             7      CP  020H
000739 4739 F5              11      PUSH    AF
00073A 473A 3E2E             7      LD  A,'.'
00073C 473C C43853          17      CALL    NZ,MSG_A
00073F 473F 0603             7      LD  B,3
000741 4741 CDB043          17      CALL    MSN
000744 4744 F1              10      POP AF
000745 4745 CC3853          17      CALL    Z,MSG_A
000748 4748 3ADDF3          13      LD  A,(CSRX)
00074B 474B 47               4      LD  B,A
00074C 474C 3AB0F3          13      LD  A,(LINLEN)
00074F 474F 90               4      SUB B
000750 4750 FE0C             7      CP  12
000752 4752 3009            12      JR  NC,RFILES2
000754 4754 3E0D             7      LD  A,00DH      ;改行
000756 4756 CD3853          17      CALL    MSG_A
000759 4759 3E0A             7      LD  A,00AH
00075B 475B 1802            12      JR  RFILES3
       475D                     RFILES2:
00075D 475D 3E20             7      LD  A,020H
       475F                     RFILES3:
00075F 475F CD3853          17      CALL    MSG_A
000762 4762 E1              10      POP HL
       4763                     RFILES_NEXT:
000763 4763 CD154C          17      CALL    FNEXT
       4766                     RFILES_NOT_MATCH:
000766 4766 20B8            12      JR  NZ,RFILES1
000768 4768 C3B746          10      JP  ROM_NEXT
                                
       476B                     INIT_PARAM:
00076B 476B 22F2F2          16      LD  (PARAM0),HL
00076E 476E 22F4F2          16      LD  (PARAM1),HL
000771 4771 EB               4      EX  DE,HL
000772 4772 32BEFC          13      LD  (RUNBNF),A
000775 4775 3263F6          13      LD  (VALTYP),A
000778 4778 E5              11      PUSH    HL
000779 4779 2AEBF2          16      LD  HL,(_CD)
00077C 477C 22F6F2          16      LD  (_CDX),HL
00077F 477F E1              10      POP HL
000780 4780 13               6      INC DE
000781 4781 CD6D4B          17      CALL    SPCUT
000784 4784 1A               7      LD  A,(DE)
000785 4785 B7               4      OR  A
000786 4786 C8              11      RET Z
000787 4787 FE3A             7      CP  ':'
000789 4789 C8              11      RET Z
00078A 478A FE28             7      CP  '('
00078C 478C C8              11      RET Z
00078D 478D EB               4      EX  DE,HL
00078E 478E DD21644C        14      LD  IX,FRMEVL
000792 4792 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000796 4796 CD1C00          17      CALL    _CALSLT
000799 4799 22F4F2          16      LD  (PARAM1),HL
00079C 479C C9              10      RET
                                
       479D                     ROM_COPY:
00079D 479D CD6B47          17      CALL    INIT_PARAM
0007A0 47A0 3A63F6          13      LD  A,(VALTYP)
0007A3 47A3 FE03             7      CP  3       ;string
0007A5 47A5 C2594A          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
0007A8 47A8 CD5E4A          17      CALL    FILE_B
0007AB 47AB CDDD4B          17      CALL    ROM_OPEN
0007AE 47AE DA1546          10      JP  C,ERROR_FILE_NOT_FOUND
                                
0007B1 47B1 21DEF2          10      LD  HL,_BUF_W
0007B4 47B4 22D4F2          16      LD  (_DTA),HL
0007B7 47B7 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
0007BA 47BA CDBD49          17      CALL    ROM_READ
                                
0007BD 47BD AF               4      XOR A
0007BE 47BE 32D9F2          13      LD  (_BUF_LO),A     ;PSET
0007C1 47C1 32E6F2          13      LD  (_BUF_O),A      ;向き
                                
0007C4 47C4 2AF4F2          16      LD  HL,(PARAM1)
       47C7                     RCP_PARAM1:
0007C7 47C7 7E               7      LD  A,(HL)
0007C8 47C8 23               6      INC HL
0007C9 47C9 B7               4      OR  A
0007CA 47CA CAC446          10      JP  Z,ROM_NEXT1
0007CD 47CD FE3A             7      CP  ':'
0007CF 47CF CAC446          10      JP  Z,ROM_NEXT1
0007D2 47D2 FE2C             7      CP  ','
0007D4 47D4 2012            12      JR  NZ,RCP_PARAM1_
                                
0007D6 47D6 DD212F54        14      LD  IX,FRMQNT
0007DA 47DA FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007DE 47DE CD1C00          17      CALL    _CALSLT
0007E1 47E1 7B               4      LD  A,E
0007E2 47E2 87               4      ADD A,A
0007E3 47E3 87               4      ADD A,A
0007E4 47E4 32E6F2          13      LD  (_BUF_O),A
0007E7 47E7 7E               7      LD  A,(HL)
       47E8                     RCP_PARAM1_:
0007E8 47E8 FE28             7      CP  '('
0007EA 47EA 20DB            12      JR  NZ,RCP_PARAM1
0007EC 47EC DD212F54        14      LD  IX,FRMQNT
0007F0 47F0 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007F4 47F4 CD1C00          17      CALL    _CALSLT
                                
0007F7 47F7 ED53E2F2        20      LD  (_BUF_X),DE
                                
       47FB                     RCP_PARAM2:
0007FB 47FB 23               6      INC HL
0007FC 47FC 7E               7      LD  A,(HL)
0007FD 47FD FE20             7      CP  020H
0007FF 47FF 28FA            12      JR  Z,RCP_PARAM2
000801 4801 FE2C             7      CP  ','
000803 4803 28F6            12      JR  Z,RCP_PARAM2
                                
000805 4805 DD212F54        14      LD  IX,FRMQNT
000809 4809 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00080D 480D CD1C00          17      CALL    _CALSLT
                                
000810 4810 3AF6FA          13      LD  A,(ACPAGE)
000813 4813 57               4      LD  D,A
000814 4814 ED53E4F2        20      LD  (_BUF_Y),DE
       4818                     RCP_PARAM3:
000818 4818 23               6      INC HL
000819 4819 7E               7      LD  A,(HL)
00081A 481A FE20             7      CP  020H
00081C 481C 28FA            12      JR  Z,RCP_PARAM3
00081E 481E FE29             7      CP  ')'
000820 4820 28F6            12      JR  Z,RCP_PARAM3
000822 4822 FE2C             7      CP  ','
000824 4824 2033            12      JR  NZ,RCP_ST
                                
000826 4826 23               6      INC HL
000827 4827 DD212F54        14      LD  IX,FRMQNT
00082B 482B FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00082F 482F CD1C00          17      CALL    _CALSLT
                                
000832 4832 7B               4      LD  A,E
000833 4833 32E5F2          13      LD  (_BUF_P),A
                                
       4836                     RCP_PARAM4:
000836 4836 7E               7      LD  A,(HL)
000837 4837 23               6      INC HL
000838 4838 FE20             7      CP  020H
00083A 483A 28FA            12      JR  Z,RCP_PARAM4
                                
00083C 483C FE2C             7      CP  ','
00083E 483E 2019            12      JR  NZ,RCP_ST
                                
000840 4840 7E               7      LD  A,(HL)
000841 4841 0604             7      LD  B,4
000843 4843 FEC3             7      CP  0C3H        ;PRESET
000845 4845 280E            12      JR  Z,RCP_LO
000847 4847 05               4      DEC B       ;3
000848 4848 D6F8             7      SUB 0F8H        ;XOR
00084A 484A 2809            12      JR  Z,RCP_LO
00084C 484C 05               4      DEC B       ;2
00084D 484D 3C               4      INC A       ;OR
00084E 484E 2805            12      JR  Z,RCP_LO
000850 4850 05               4      DEC B       ;1
000851 4851 3C               4      INC A       ;AND
000852 4852 2801            12      JR  Z,RCP_LO
000854 4854 05               4      DEC B       ;0
                                                ;PSET
       4855                     RCP_LO:
000855 4855 78               4      LD  A,B
000856 4856 32D9F2          13      LD  (_BUF_LO),A
       4859                     RCP_ST:
000859 4859 2AC6F6          16      LD  HL,(STREND)
00085C 485C 22D4F2          16      LD  (_DTA),HL
00085F 485F EB               4      EX  DE,HL
000860 4860 2100FE          10      LD  HL,-512
000863 4863 39              11      ADD HL,SP
000864 4864 AF               4      XOR A
000865 4865 ED52            15      SBC HL,DE
000867 4867 3008            12      JR  NC,RCP0
000869 4869 215EF5          10      LD  HL,BUF
00086C 486C 22D4F2          16      LD  (_DTA),HL
00086F 486F 6F               4      LD  L,A ;0
000870 4870 67               4      LD  H,A ;0
       4871                     RCP0:
000871 4871 24               4      INC H
000872 4872 22DCF2          16      LD  (_BUF_EN),HL
       4875                     RCP1:
000875 4875 F3               4      DI
000876 4876 CD4B49          17      CALL    WAIT_VDP
                                
000879 4879 3A0700          13      LD  A,(WRVDP)
00087C 487C 4F               4      LD  C,A
00087D 487D 0C               4      INC C       ;C := PORT#1's address(WR)
00087E 487E 3E24             7      LD  A,36
000880 4880 ED79            12      OUT (C),A
000882 4882 3E91             7      LD  A,080H+17
000884 4884 ED79            12      OUT (C),A       ;R#17 := 36
                                
000886 4886 0C               4      INC C
000887 4887 0C               4      INC C       ;C := PORT#3's address(WR)
000888 4888 2AE2F2          16      LD  HL,(_BUF_X)
00088B 488B ED69            12      OUT (C),L       ;R#36 DX
00088D 488D ED61            12      OUT (C),H       ;R#37
00088F 488F 2AE4F2          16      LD  HL,(_BUF_Y)
000892 4892 ED69            12      OUT (C),L       ;R#38 DY
000894 4894 ED61            12      OUT (C),H       ;R#39
000896 4896 2ADEF2          16      LD  HL,(_BUF_W)
000899 4899 ED69            12      OUT (C),L       ;R#40 NX
00089B 489B ED61            12      OUT (C),H       ;R#41
00089D 489D 2AE0F2          16      LD  HL,(_BUF_H)
0008A0 48A0 ED69            12      OUT (C),L       ;R#42 NY
0008A2 48A2 ED61            12      OUT (C),H       ;R#43
                                
0008A4 48A4 DD2AAFFC        20      LD  IX,(SCRMOD)
0008A8 48A8 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0008AB 48AB B7               4      OR  A
0008AC 48AC 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
0008AE 48AE DD7D             9      LD  A,IXL
0008B0 48B0 FE08             7      CP  8
0008B2 48B2 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
0008B4 48B4 FE06             7      CP  6
0008B6 48B6 2AE2F2          16      LD  HL,(_BUF_X)
0008B9 48B9 3ADEF2          13      LD  A,(_BUF_W)
0008BC 48BC 2005            12      JR  NZ,SCR57
0008BE 48BE B5               4      OR  L       ;スクリーン6
0008BF 48BF E603             7      AND 3
0008C1 48C1 200D            12      JR  NZ,USE_LMMC
       48C3                     SCR57:              ;スクリーン5,7
0008C3 48C3 B5               4      OR  L
0008C4 48C4 E601             7      AND 1
0008C6 48C6 2008            12      JR  NZ,USE_LMMC
       48C8                     USE_HMMC:
0008C8 48C8 DD2E08          10      LD  IXL,8
       48CB                     USE_HMMC8:
0008CB 48CB 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
0008CD 48CD 32D9F2          13      LD  (_BUF_LO),A
       48D0                     USE_LMMC:
0008D0 48D0 110000          10      LD  DE,0
0008D3 48D3 06FF             7      LD  B,-1
0008D5 48D5 CD7649          17      CALL    GET_PIXEL
0008D8 48D8 ED79            12      OUT (C),A       ;R#44 first DATA
0008DA 48DA 3AE6F2          13      LD  A,(_BUF_O)
0008DD 48DD ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
0008DF 48DF 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0008E2 48E2 F6B0             7      OR  0B0H        ;R#46 LMMC command
0008E4 48E4 ED79            12      OUT (C),A
                                
0008E6 48E6 FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
0008E8 48E8 0D               4      DEC C
0008E9 48E9 0D               4      DEC C       ;C := PORT#1's address(WR)
0008EA 48EA 3EAC             7      LD  A,080H+44
0008EC 48EC ED79            12      OUT (C),A
0008EE 48EE 3E91             7      LD  A,080H+17
0008F0 48F0 ED79            12      OUT (C),A       ;R#17 := 44
                                
0008F2 48F2 3A0600          13      LD  A,(RDVDP)
0008F5 48F5 3C               4      INC A
0008F6 48F6 FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
0008F8 48F8 3E02             7      LD  A,2
0008FA 48FA ED79            12      OUT (C),A
0008FC 48FC 3E8F             7      LD  A,08FH
0008FE 48FE ED79            12      OUT (C),A
000900 4900 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000903 4903 E640             7      AND 040H
000905 4905 201C            12      JR  NZ,LOOP_HMMC
       4907                     LOOP_COPY:
000907 4907 CD7649          17      CALL    GET_PIXEL
00090A 490A 08               4      EX  AF,AF'
00090B 490B FD4C             9      LD  C,IYH
       490D                     LOOP_COPY1:
00090D 490D ED78            12      IN  A,(C)
00090F 490F 0F               4      RRCA            ;RRCAではサインフラグは変化しない
000910 4910 300A            12      JR  NC,EXIT_COPY    ;check CE bit
000912 4912 F20D49          10      JP  P,LOOP_COPY1    ;check TR bit
000915 4915 08               4      EX  AF,AF'
000916 4916 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000918 4918 ED79            12      OUT (C),A
00091A 491A 18EB            12      JR  LOOP_COPY
                                
       491C                     EXIT_COPY:
00091C 491C CD5349          17      CALL    GET_STATUS_0
00091F 491F FB               4      EI
000920 4920 C3B746          10      JP  ROM_NEXT
                                
       4923                     LOOP_HMMC:
000923 4923 F3               4      DI          ;必要
000924 4924 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000926 4926 43               4      LD  B,E
000927 4927 7B               4      LD  A,E
000928 4928 B7               4      OR  A
000929 4929 2802            12      JR  Z,LOOP_HMMC1
00092B 492B EDB3                    OTIR
       492D                     LOOP_HMMC1:
00092D 492D 14               4      INC D
       492E                     LOOP_HMMC2:
00092E 492E 15               4      DEC D
00092F 492F 2805            12      JR  Z,LOOP_HMMC3
000931 4931 EDB3                    OTIR
000933 4933 C32E49          10      JP  LOOP_HMMC2
       4936                     LOOP_HMMC3:
000936 4936 ED78            12      IN  A,(C)
000938 4938 0F               4      RRCA
000939 4939 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
00093B 493B 2ADCF2          16      LD  HL,(_BUF_EN)
00093E 493E CDBD49          17      CALL    ROM_READ
000941 4941 EB               4      EX  DE,HL
000942 4942 2AD4F2          16      LD  HL,(_DTA)
000945 4945 7A               4      LD  A,D
000946 4946 B3               4      OR  E
000947 4947 20DA            12      JR  NZ,LOOP_HMMC
000949 4949 18C2            12      JR  LOOP_COPY1
                                    
       494B                     WAIT_VDP:
00094B 494B 3E02             7      LD  A,2
00094D 494D CD5449          17      CALL    GET_STATUS
000950 4950 0F               4      RRCA
000951 4951 38F8            12      JR  C,WAIT_VDP
       4953                     GET_STATUS_0:
000953 4953 AF               4      XOR A
       4954                     GET_STATUS:
000954 4954 C5              11      PUSH    BC
000955 4955 ED4B0600        20      LD  BC,(RDVDP)
000959 4959 0C               4      INC C
00095A 495A ED79            12      OUT (C),A
00095C 495C 3E8F             7      LD  A,08FH
00095E 495E ED79            12      OUT (C),A
000960 4960 ED78            12      IN  A,(C)
000962 4962 C1              10      POP BC
000963 4963 C9              10      RET
                                
       4964                     GET_PIXEL256:
000964 4964 7A               4      LD  A,D
000965 4965 B3               4      OR  E
000966 4966 200A            12      JR  NZ,GET_PIXEL1
000968 4968 2ADCF2          16      LD  HL,(_BUF_EN)
00096B 496B CDBD49          17      CALL    ROM_READ
00096E 496E EB               4      EX  DE,HL
00096F 496F 2AD4F2          16      LD  HL,(_DTA)
       4972                     GET_PIXEL1:
000972 4972 7E               7      LD  A,(HL)
000973 4973 23               6      INC HL
000974 4974 1B               6      DEC DE
000975 4975 C9              10      RET
                                
       4976                     GET_PIXEL:
000976 4976 DD7D             9      LD  A,IXL
000978 4978 FE08             7      CP  8
00097A 497A 28E8            12      JR  Z,GET_PIXEL256
00097C 497C 04               4      INC B
00097D 497D FE06             7      CP  6
00097F 497F 282E            12      JR  Z,GET_PIXEL4
                                
000981 4981 CB40             8      BIT 0,B
000983 4983 20ED            12      JR  NZ,GET_PIXEL1
                                
000985 4985 7A               4      LD  A,D
000986 4986 B3               4      OR  E
000987 4987 200A            12      JR  NZ,GET_PIXEL2
                                
000989 4989 2ADCF2          16      LD  HL,(_BUF_EN)
00098C 498C CDBD49          17      CALL    ROM_READ
00098F 498F EB               4      EX  DE,HL
000990 4990 2AD4F2          16      LD  HL,(_DTA)
                                
       4993                     GET_PIXEL2:
000993 4993 7E               7      LD  A,(HL)
000994 4994 0F               4      RRCA
000995 4995 0F               4      RRCA
000996 4996 0F               4      RRCA
000997 4997 0F               4      RRCA
000998 4998 C9              10      RET
                                
       4999                     GET_PIXEL3:
000999 4999 7A               4      LD  A,D
00099A 499A B3               4      OR  E
00099B 499B 200A            12      JR  NZ,GET_PIXEL5
                                
00099D 499D 2ADCF2          16      LD  HL,(_BUF_EN)
0009A0 49A0 CDBD49          17      CALL    ROM_READ
0009A3 49A3 EB               4      EX  DE,HL
0009A4 49A4 2AD4F2          16      LD  HL,(_DTA)
       49A7                     GET_PIXEL5:
0009A7 49A7 7E               7      LD  A,(HL)
0009A8 49A8 0F               4      RRCA
0009A9 49A9 0F               4      RRCA
0009AA 49AA 0F               4      RRCA
0009AB 49AB 0F               4      RRCA
0009AC 49AC 0F               4      RRCA
0009AD 49AD 0F               4      RRCA
0009AE 49AE C9              10      RET
                                
       49AF                     GET_PIXEL4:
0009AF 49AF 78               4      LD  A,B
0009B0 49B0 E603             7      AND 3   ;+0
0009B2 49B2 28E5            12      JR  Z,GET_PIXEL3
0009B4 49B4 3D               4      DEC A   ;+1
0009B5 49B5 28DC            12      JR  Z,GET_PIXEL2
0009B7 49B7 3D               4      DEC A   ;+2
0009B8 49B8 7E               7      LD  A,(HL)
0009B9 49B9 C0              11      RET NZ
0009BA 49BA 0F               4      RRCA        ;+3
0009BB 49BB 0F               4      RRCA
0009BC 49BC C9              10      RET
                                
       49BD                     ROM_READ:
0009BD 49BD E5              11      PUSH    HL
0009BE 49BE D5              11      PUSH    DE
0009BF 49BF C5              11      PUSH    BC
0009C0 49C0 FDE5            15      PUSH    IY
0009C2 49C2 22F0F2          16      LD  (LEFTX),HL
0009C5 49C5 2AD4F2          16      LD  HL,(_DTA)
0009C8 49C8 22E7F2          16      LD  (DTAX),HL
0009CB 49CB 2AF0F2          16      LD  HL,(LEFTX)
                                
0009CE 49CE CD6F4C          17      CALL    RBX1
0009D1 49D1 3870            12      JR  C,RBRERR1
0009D3 49D3 79               4      LD  A,C
0009D4 49D4 EB               4      EX  DE,HL
0009D5 49D5 ED52            15      SBC HL,DE       ;CP 0HL,CDE
0009D7 49D7 19              11      ADD HL,DE
0009D8 49D8 DE00             7      SBC A,000H
0009DA 49DA 3801            12      JR  C,RBR1
0009DC 49DC EB               4      EX  DE,HL
       49DD                     RBR1:
0009DD 49DD 9F               4      SBC A,A
0009DE 49DE E601             7      AND 1
0009E0 49E0 32C3F2          13      LD  (_RESULT),A
0009E3 49E3 7C               4      LD  A,H
0009E4 49E4 B5               4      OR  L
0009E5 49E5 CA394A          10      JP  Z,RBREND0
                                
0009E8 49E8 22D0F2          16      LD  (_LEFT),HL  ;Read record byte
0009EB 49EB 22F0F2          16      LD  (LEFTX),HL
                                
0009EE 49EE CD9B4C          17      CALL    RBX2
0009F1 49F1 281A            12      JR  Z,RBRB
                                                ;先頭の端数
0009F3 49F3 CDAE4C          17      CALL    RBXA
0009F6 49F6 DA4F4A          10      JP  C,RBRERR
0009F9 49F9 C5              11      PUSH    BC
0009FA 49FA CD3644          17      CALL    ROM_LDIR
0009FD 49FD ED53E7F2        20      LD  (DTAX),DE
000A01 4A01 2AF0F2          16      LD  HL,(LEFTX)
000A04 4A04 D1              10      POP DE
000A05 4A05 A7               4      AND A
000A06 4A06 ED52            15      SBC HL,DE
000A08 4A08 22F0F2          16      LD  (LEFTX),HL
000A0B 4A0B 2829            12      JR  Z,RBREND
                                
       4A0D                     RBRB:
000A0D 4A0D CDEA4C          17      CALL    RBXB
000A10 4A10 2818            12      JR  Z,RBRC
       4A12                     RBRB1:
000A12 4A12 C5              11      PUSH    BC
000A13 4A13 D5              11      PUSH    DE
000A14 4A14 CD954D          17      CALL    CLUST
000A17 4A17 EB               4      EX  DE,HL
000A18 4A18 ED4BC6F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000A1C 4A1C CD3644          17      CALL    ROM_LDIR
000A1F 4A1F EB               4      EX  DE,HL
000A20 4A20 D1              10      POP DE
000A21 4A21 C1              10      POP BC
000A22 4A22 CD724D          17      CALL    GNCL
000A25 4A25 DA4F4A          10      JP  C,RBRERR
000A28 4A28 10E8            13      DJNZ    RBRB1
       4A2A                     RBRC:
000A2A 4A2A CD024D          17      CALL    RBXC
000A2D 4A2D 2807            12      JR  Z,RBREND
                                
000A2F 4A2F CD954D          17      CALL    CLUST
000A32 4A32 EB               4      EX  DE,HL
000A33 4A33 CD3644          17      CALL    ROM_LDIR
       4A36                     RBREND:
000A36 4A36 CD0E4D          17      CALL    RBXEND
       4A39                     RBREND0:
000A39 4A39 FDE1            14      POP IY
000A3B 4A3B C1              10      POP BC
000A3C 4A3C D1              10      POP DE
000A3D 4A3D F1              10      POP AF  ;(HL)
000A3E 4A3E AF               4      XOR A
000A3F 4A3F 3AC3F2          13      LD  A,(_RESULT)
000A42 4A42 C9              10      RET
                                
       4A43                     RBRERR1:
000A43 4A43 3E01             7      LD  A,001H
       4A45                     RBRERR2:
000A45 4A45 FDE1            14      POP IY
000A47 4A47 C1              10      POP BC
000A48 4A48 D1              10      POP DE
000A49 4A49 E1              10      POP HL
000A4A 4A4A 37               4      SCF
000A4B 4A4B 210000          10      LD  HL,0
000A4E 4A4E C9              10      RET
       4A4F                     RBRERR:
000A4F 4A4F 3EFF             7      LD  A,0FFH
000A51 4A51 18F2            12      JR  RBRERR2
                                
       4A53                     FILE_DD:
000A53 4A53 E1              10      POP HL
000A54 4A54 3E                      DB  03EH
000A55 4A55 C9              10      RET
000A56 4A56 32A3F2          13      LD  (SWC_BLOAD_M),A
       4A59                     ROM_ORG:
000A59 4A59 2AF2F2          16      LD  HL,(PARAM0)
000A5C 4A5C 7E               7      LD  A,(HL)
000A5D 4A5D C9              10      RET
       4A5E                     FILE_B:
000A5E 4A5E AF               4      XOR A
000A5F 4A5F 32F8F2          13      LD  (FDRV),A
000A62 4A62 1E00             7      LD  E,0
000A64 4A64 3A63F6          13      LD  A,(VALTYP)
000A67 4A67 FE03             7      CP  3       ;string
000A69 4A69 C2EE4A          10      JP  NZ,FILED
                                
000A6C 4A6C DD21D067        14      LD  IX,FRESTR
000A70 4A70 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000A74 4A74 CD1C00          17      CALL    _CALSLT
000A77 4A77 E5              11      PUSH    HL
000A78 4A78 DDE1            14      POP IX
                                
000A7A 4A7A DD5E00          19      LD  E,(IX+0)
000A7D 4A7D DD7E01          19      LD  A,(IX+1)
000A80 4A80 DD5602          19      LD  D,(IX+2)
000A83 4A83 DD62             9      LD  IXH,D
000A85 4A85 DD6F             9      LD  IXL,A
000A87 4A87 7B               4      LD  A,E
       4A88                     FILE_BDOS:
000A88 4A88 FE04             7      CP  4
000A8A 4A8A 3808            12      JR  C,FILEB1
000A8C 4A8C DD7E03          19      LD  A,(IX+3)
000A8F 4A8F FE3A             7      CP  ':'
000A91 4A91 28C0            12      JR  Z,FILE_DD
000A93 4A93 7B               4      LD  A,E
       4A94                     FILEB1:
000A94 4A94 FE02             7      CP  2
000A96 4A96 3818            12      JR  C,DEVI1
000A98 4A98 DD7E01          19      LD  A,(IX+1)
000A9B 4A9B FE3A             7      CP  ':'
000A9D 4A9D 2011            12      JR  NZ,DEVI1
000A9F 4A9F DD7E00          19      LD  A,(IX+0)        ;DRIVE
000AA2 4AA2 CDC74B          17      CALL    CAP
000AA5 4AA5 D640             7      SUB '@'
000AA7 4AA7 DD23            10      INC IX
000AA9 4AA9 DD23            10      INC IX
000AAB 4AAB 1D               4      DEC E
000AAC 4AAC 1D               4      DEC E
000AAD 4AAD 32F8F2          13      LD  (FDRV),A
       4AB0                     DEVI1:
000AB0 4AB0 DD7E00          19      LD  A,(IX+0)
000AB3 4AB3 D65C             7      SUB 05CH        ;\
000AB5 4AB5 2008            12      JR  NZ,NOROOT
000AB7 4AB7 6F               4      LD  L,A
000AB8 4AB8 67               4      LD  H,A
000AB9 4AB9 22F6F2          16      LD  (_CDX),HL
000ABC 4ABC DD23            10      INC IX
000ABE 4ABE 1D               4      DEC E
       4ABF                     NOROOT:
                                
       4ABF                     SETDIR:
000ABF 4ABF CDEE4A          17      CALL    FILED
000AC2 4AC2 DD7E00          19      LD  A,(IX+0)
000AC5 4AC5 FE5C             7      CP  05CH        ;\
000AC7 4AC7 C0              11      RET NZ
000AC8 4AC8 DD23            10      INC IX
000ACA 4ACA 1D               4      DEC E
000ACB 4ACB 3AF9F2          13      LD  A,(FNAME)
000ACE 4ACE FE20             7      CP  020H        ;. の処理
000AD0 4AD0 28ED            12      JR  Z,SETDIR
                                
000AD2 4AD2 CDDD4B          17      CALL    ROM_OPEN
000AD5 4AD5 B7               4      OR  A
000AD6 4AD6 C0              11      RET NZ
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                #else
000AD7 4AD7 FD2AEDF2        20      LD  IY,(DIRENT1)
000ADB 4ADB FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000ADF 4ADF C8              11      RET Z
000AE0 4AE0 CD354B          17      CALL    FILEI
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
000AE3 4AE3 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000AE6 4AE6 FD661B          19      LD  H,(IY+01BH)
                                #endif
000AE9 4AE9 22F6F2          16      LD  (_CDX),HL
000AEC 4AEC 18D1            12      JR  SETDIR
                                
       4AEE                     FILED:
000AEE 4AEE CD354B          17      CALL    FILEI
000AF1 4AF1 21F9F2          10      LD  HL,FNAME
                                
000AF4 4AF4 0608             7      LD  B,8
       4AF6                     FILE2:
000AF6 4AF6 CD424B          17      CALL    CCHKF
000AF9 4AF9 C8              11      RET Z
000AFA 4AFA FE2A             7      CP  '*'
000AFC 4AFC 282E            12      JR  Z,FILE9
000AFE 4AFE FE2E             7      CP  '.'
000B00 4B00 280C            12      JR  Z,FILE4
000B02 4B02 77               7      LD  (HL),A
000B03 4B03 23               6      INC HL
000B04 4B04 10F0            13      DJNZ    FILE2
                                
       4B06                     FILE3:
000B06 4B06 CD424B          17      CALL    CCHKF
000B09 4B09 C8              11      RET Z
000B0A 4B0A FE2E             7      CP  '.'
000B0C 4B0C 20F8            12      JR  NZ,FILE3
                                
       4B0E                     FILE4:
000B0E 4B0E 2101F3          10      LD  HL,FNAME+8
000B11 4B11 0603             7      LD  B,3
                                
       4B13                     FILE4L:
000B13 4B13 CD424B          17      CALL    CCHKF
000B16 4B16 C8              11      RET Z
000B17 4B17 FE2E             7      CP  '.'
000B19 4B19 2008            12      JR  NZ,FILE12
000B1B 4B1B 32F9F2          13      LD  (FNAME),A   ;Parent directory(..)
000B1E 4B1E 32FAF2          13      LD  (FNAME+1),A
000B21 4B21 3E20             7      LD  A,020H
       4B23                     FILE12:
000B23 4B23 FE2A             7      CP  '*'
000B25 4B25 280A            12      JR  Z,FILE10
000B27 4B27 77               7      LD  (HL),A
000B28 4B28 23               6      INC HL
000B29 4B29 10E8            13      DJNZ    FILE4L
000B2B 4B2B C9              10      RET
                                
       4B2C                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000B2C 4B2C CD314B          17      CALL    FILE10
000B2F 4B2F 18D5            12      JR  FILE3
                                
       4B31                     FILE10:
000B31 4B31 3E3F             7      LD  A,'?'
000B33 4B33 1808            12      JR  FILL_MEMORY
       4B35                     FILEI:              ;名前＋拡張子をスペースで初期化
000B35 4B35 3E20             7      LD  A,020H
000B37 4B37 01000B          10      LD  BC,11*256   ;C=0にしておく
000B3A 4B3A 21F9F2          10      LD  HL,FNAME
       4B3D                     FILL_MEMORY:            ;HLからBバイトAで埋める
000B3D 4B3D 77               7      LD  (HL),A
000B3E 4B3E 23               6      INC HL
000B3F 4B3F 10FC            13      DJNZ    FILL_MEMORY
000B41 4B41 C9              10      RET
                                
       4B42                     CCHKF:
000B42 4B42 7B               4      LD  A,E
000B43 4B43 B7               4      OR  A
000B44 4B44 C8              11      RET Z
000B45 4B45 DD7E00          19      LD  A,(IX+0)
000B48 4B48 CD4F4B          17      CALL    CCHK2
000B4B 4B4B C8              11      RET Z
000B4C 4B4C C3B24B          10      JP  FKAN
                                
       4B4F                     CCHK2:
000B4F 4B4F 0C               4      INC C
000B50 4B50 0D               4      DEC C
000B51 4B51 C0              11      RET NZ
       4B52                     CCHK3:              ;ZF=1 で使えない文字
000B52 4B52 FE2B             7      CP  '+'
000B54 4B54 C8              11      RET Z
000B55 4B55 FE2C             7      CP  ','
000B57 4B57 C8              11      RET Z
000B58 4B58 FE2F             7      CP  '/'
000B5A 4B5A C8              11      RET Z
000B5B 4B5B FE3A             7      CP  ':'
000B5D 4B5D C8              11      RET Z
000B5E 4B5E FE3B             7      CP  ';'
000B60 4B60 C8              11      RET Z
000B61 4B61 FE3D             7      CP  '='
000B63 4B63 C8              11      RET Z
000B64 4B64 FE5C             7      CP  05CH    ;\
000B66 4B66 C8              11      RET Z
000B67 4B67 FE1F             7      CP  01FH
000B69 4B69 D0              11      RET NC
000B6A 4B6A BF               4      CP  A       ;Z=1
000B6B 4B6B C9              10      RET
                                
       4B6C                     SS1:
000B6C 4B6C 13               6      INC DE
       4B6D                     SPCUT:              ;スペースをカット
000B6D 4B6D 1A               7      LD  A,(DE)
000B6E 4B6E FE20             7      CP  020H
000B70 4B70 28FA            12      JR  Z,SS1
000B72 4B72 C9              10      RET
                                
       4B73                     SCREOF1:
000B73 4B73 13               6      INC DE
       4B74                     SPCUTEX:            ;スペース改行などをカット
000B74 4B74 1A               7      LD  A,(DE)
000B75 4B75 FE20             7      CP  020H
000B77 4B77 28FA            12      JR  Z,SCREOF1
000B79 4B79 FE0D             7      CP  00DH
000B7B 4B7B 28F6            12      JR  Z,SCREOF1
000B7D 4B7D FE0A             7      CP  00AH
000B7F 4B7F 28F2            12      JR  Z,SCREOF1
000B81 4B81 FE1A             7      CP  01AH
000B83 4B83 28EE            12      JR  Z,SCREOF1
000B85 4B85 C9              10      RET
                                
       4B86                     GETNUM:
000B86 4B86 210000          10      LD  HL,0
       4B89                     GETNUM1:
000B89 4B89 1A               7      LD  A,(DE)
000B8A 4B8A 13               6      INC DE
000B8B 4B8B D630             7      SUB '0'
000B8D 4B8D D8              11      RET C
000B8E 4B8E FE0A             7      CP  10
000B90 4B90 D0              11      RET NC
000B91 4B91 4D               4      LD  C,L
000B92 4B92 44               4      LD  B,H
000B93 4B93 29              11      ADD HL,HL   ;*2
000B94 4B94 29              11      ADD HL,HL   ;*4
000B95 4B95 09              11      ADD HL,BC   ;*5
000B96 4B96 29              11      ADD HL,HL   ;*10
000B97 4B97 4F               4      LD  C,A
000B98 4B98 0600             7      LD  B,0
000B9A 4B9A 09              11      ADD HL,BC
000B9B 4B9B 18EC            12      JR  GETNUM1
                                
       4B9D                     SEARCH_END:
000B9D 4B9D 7E               7      LD  A,(HL)
       4B9E                     SEARCH_END1:
000B9E 4B9E 23               6      INC HL
000B9F 4B9F B7               4      OR  A
000BA0 4BA0 C8              11      RET Z
000BA1 4BA1 FE3A             7      CP  ':'
000BA3 4BA3 20F8            12      JR  NZ,SEARCH_END
000BA5 4BA5 7E               7      LD  A,(HL)
000BA6 4BA6 FE3A             7      CP  ':'
000BA8 4BA8 28F4            12      JR  Z,SEARCH_END1
000BAA 4BAA C9              10      RET
                                
       4BAB                     FKANC:
000BAB 4BAB CB41             8      BIT 0,C
000BAD 4BAD CCD04B          17      CALL    Z,CAP2
000BB0 4BB0 1803            12      JR  FKANX
       4BB2                     FKAN:           ;漢字チェック
000BB2 4BB2 DD23            10      INC IX
000BB4 4BB4 1D               4      DEC E
       4BB5                     FKANX:
000BB5 4BB5 CB41             8      BIT 0,C
000BB7 4BB7 CB81             8      RES 0,C
000BB9 4BB9 C0              11      RET NZ
000BBA 4BBA FE80             7      CP  080H
000BBC 4BBC D8              11      RET C
000BBD 4BBD FEA0             7      CP  0A0H
000BBF 4BBF 3803            12      JR  C,FKAN1
000BC1 4BC1 FEE0             7      CP  0E0H
000BC3 4BC3 D8              11      RET C
       4BC4                     FKAN1:
000BC4 4BC4 0C               4      INC C
000BC5 4BC5 A7               4      AND A
000BC6 4BC6 C9              10      RET
                                
       4BC7                     CAP:
000BC7 4BC7 FE61             7      CP  'a'
000BC9 4BC9 D8              11      RET C
000BCA 4BCA FE7B             7      CP  'z'+1
000BCC 4BCC D0              11      RET NC
000BCD 4BCD D620             7      SUB 020H
000BCF 4BCF C9              10      RET
       4BD0                     CAP2:
000BD0 4BD0 CDC74B          17      CALL    CAP
       4BD3                     CAP3:               ;
000BD3 4BD3 FE05             7      CP  5
000BD5 4BD5 2803            12      JR  Z,CAP4
000BD7 4BD7 FE21             7      CP  021H
000BD9 4BD9 C9              10      RET
       4BDA                     CAP4:
000BDA 4BDA 3EE5             7      LD  A,0E5H
000BDC 4BDC C9              10      RET
                                
       4BDD                     ROM_OPEN:
000BDD 4BDD CDBF52          17      CALL    GET_DISK_BANK_FDRV
                                
000BE0 4BE0 CD3B4E          17      CALL    GET_DIR_DAT
000BE3 4BE3 D5              11      PUSH    DE
000BE4 4BE4 CDF94B          17      CALL    FILESE
000BE7 4BE7 D1              10      POP DE
000BE8 4BE8 3F               4      CCF
000BE9 4BE9 D8              11      RET C
000BEA 4BEA 22EDF2          16      LD  (DIRENT1),HL
000BED 4BED E5              11      PUSH    HL
000BEE 4BEE 210000          10      LD  HL,0
000BF1 4BF1 22CAF2          16      LD  (RR_LOW),HL
000BF4 4BF4 22CCF2          16      LD  (RR_HIGH),HL
000BF7 4BF7 E1              10      POP HL
000BF8 4BF8 C9              10      RET
                                
       4BF9                     FILESE:
       4BF9                     FILESE0:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000BF9 4BF9 7E               7      LD  A,(HL)
                                #endif
000BFA 4BFA B7               4      OR  A
000BFB 4BFB C8              11      RET Z       ;END:ZF=1 CF=0
000BFC 4BFC FEE5             7      CP  0E5H
000BFE 4BFE 280D            12      JR  Z,FILESE1
000C00 4C00 11F9F2          10      LD  DE,FNAME
000C03 4C03 E5              11      PUSH    HL
000C04 4C04 CD4A4C          17      CALL    CPFILE
000C07 4C07 CC6B4C          17      CALL    Z,CPFILE2
000C0A 4C0A E1              10      POP HL
000C0B 4C0B 37               4      SCF
000C0C 4C0C C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4C0D                     FILESE1:
000C0D 4C0D CD154C          17      CALL    FNEXT
000C10 4C10 20E7            12      JR  NZ,FILESE0
000C12 4C12 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000C14 4C14 C9              10      RET
                                
       4C15                     FNEXT:
000C15 4C15 112000          10      LD  DE,020H
000C18 4C18 19              11      ADD HL,DE
000C19 4C19 ED5BF6F2        20      LD  DE,(_CDX)
000C1D 4C1D 7A               4      LD  A,D
000C1E 4C1E B3               4      OR  E
000C1F 4C1F 2019            12      JR  NZ,FNEXT_SUBDIR
000C21 4C21 0D               4      DEC C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
       4C22                     CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
000C22 4C22 F5              11      PUSH    AF      ;※フラグを保存する必要あり
000C23 4C23 CB7C             8      BIT 7,H
000C25 4C25 2811            12      JR  Z,CHECK_DIR_PAGE1
000C27 4C27 7C               4      LD  A,H
000C28 4C28 D620             7      SUB 020H
000C2A 4C2A 67               4      LD  H,A
000C2B 4C2B 3AEFF2          13      LD  A,(_DIR_BANK)
000C2E 4C2E 3C               4      INC A
000C2F 4C2F 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C32 4C32 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000C35 4C35 32EFF2          13      LD  (_DIR_BANK),A
       4C38                     CHECK_DIR_PAGE1:
000C38 4C38 F1              10      POP AF
                                #endif
000C39 4C39 C9              10      RET
                                
       4C3A                     FNEXT_SUBDIR:           ;サブディレクトリ
000C3A 4C3A 0D               4      DEC C
000C3B 4C3B C0              11      RET NZ
                                
000C3C 4C3C ED5BF6F2        20      LD  DE,(_CDX)
000C40 4C40 CD724D          17      CALL    GNCL
000C43 4C43 EB               4      EX  DE,HL
000C44 4C44 22F6F2          16      LD  (_CDX),HL
000C47 4C47 C3774E          10      JP  GET_SUBDIR
                                
       4C4A                     CPFILE:
000C4A 4C4A C5              11      PUSH    BC
000C4B 4C4B 01000B          10      LD  BC,00B00H
       4C4E                     CPSTR1:
000C4E 4C4E 1A               7      LD  A,(DE)
000C4F 4C4F FE3F             7      CP  '?'     ;Wild card
000C51 4C51 2812            12      JR  Z,CPSTR2
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000C53 4C53 7E               7      LD  A,(HL)
                                #endif
000C54 4C54 CDAB4B          17      CALL    FKANC
000C57 4C57 E5              11      PUSH    HL
000C58 4C58 67               4      LD  H,A
000C59 4C59 1A               7      LD  A,(DE)
000C5A 4C5A CB01             8      RLC C
000C5C 4C5C CDAB4B          17      CALL    FKANC
000C5F 4C5F CB09             8      RRC C
000C61 4C61 BC               4      CP  H       ;CP (HL),(DE)
000C62 4C62 E1              10      POP HL
000C63 4C63 2004            12      JR  NZ,CPSTR3
       4C65                     CPSTR2:
000C65 4C65 13               6      INC DE
000C66 4C66 23               6      INC HL
000C67 4C67 10E5            13      DJNZ    CPSTR1
       4C69                     CPSTR3:
000C69 4C69 C1              10      POP BC
000C6A 4C6A C9              10      RET
                                
       4C6B                     CPFILE2:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000C6B 4C6B 7E               7      LD  A,(HL)
                                #endif
000C6C 4C6C E608             7      AND 008H    ;~0F7H
000C6E 4C6E C9              10      RET
                                
       4C6F                     RBX1:
000C6F 4C6F E5              11      PUSH    HL      ;Record byte
                                
000C70 4C70 ED5BCAF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000C74 4C74 3ACDF2          13      LD  A,(RR_HIGH+1)
000C77 4C77 4F               4      LD  C,A
                                
000C78 4C78 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001CH
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    CALL    RDSLT_ROM
                                    EX  DE,HL       ;AHL=File size
                                    POP DE
                                #else
000C7B 4C7B 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C7E 4C7E 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000C81 4C81 FD2AEDF2        20      LD  IY,(DIRENT1)
000C85 4C85 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000C88 4C88 FD661D          19      LD  H,(IY+01DH)
000C8B 4C8B FD7E1E          19      LD  A,(IY+01EH)
                                #endif
                                
000C8E 4C8E A7               4      AND A
000C8F 4C8F ED52            15      SBC HL,DE
000C91 4C91 99               4      SBC A,C
000C92 4C92 D1              10      POP DE
                                
000C93 4C93 D8              11      RET C
000C94 4C94 4F               4      LD  C,A
000C95 4C95 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000C96 4C96 B2               4      OR  D
000C97 4C97 B3               4      OR  E
000C98 4C98 C0              11      RET NZ
000C99 4C99 37               4      SCF
000C9A 4C9A C9              10      RET
                                
       4C9B                     RBX2:
000C9B 4C9B ED4BCBF2        20      LD  BC,(RR_LOW+1)
000C9F 4C9F CD234D          17      CALL    RWXR
000CA2 4CA2 3AC7F2          13      LD  A,(CLSZ_H)
000CA5 4CA5 3D               4      DEC A
000CA6 4CA6 E5              11      PUSH    HL
000CA7 4CA7 2ACAF2          16      LD  HL,(RR_LOW)
000CAA 4CAA A4               4      AND H
000CAB 4CAB B5               4      OR  L
000CAC 4CAC E1              10      POP HL
000CAD 4CAD C9              10      RET
                                
       4CAE                     RBXA:
000CAE 4CAE D5              11      PUSH    DE
000CAF 4CAF CD954D          17      CALL    CLUST
000CB2 4CB2 ED53D2F2        20      LD  (_DTPS),DE
000CB6 4CB6 D1              10      POP DE
000CB7 4CB7 CD724D          17      CALL    GNCL
000CBA 4CBA D8              11      RET C
000CBB 4CBB ED53CEF2        20      LD  (_CLPS),DE
                                
000CBF 4CBF ED4BCAF2        20      LD  BC,(RR_LOW)
000CC3 4CC3 2AC6F2          16      LD  HL,(CLSZ)
000CC6 4CC6 7C               4      LD  A,H
000CC7 4CC7 3D               4      DEC A
000CC8 4CC8 A0               4      AND B
000CC9 4CC9 47               4      LD  B,A
000CCA 4CCA ED42            15      SBC HL,BC       ;remaining cluster
                                
000CCC 4CCC ED5BF0F2        20      LD  DE,(LEFTX)
000CD0 4CD0 ED52            15      SBC HL,DE       ;CP HL,DE
000CD2 4CD2 19              11      ADD HL,DE
000CD3 4CD3 3801            12      JR  C,RBXA1
000CD5 4CD5 EB               4      EX  DE,HL
       4CD6                     RBXA1:
000CD6 4CD6 3AC4F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
000CD9 4CD9 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000CDC 4CDC 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000CDF 4CDF E5              11      PUSH    HL
000CE0 4CE0 2AD2F2          16      LD  HL,(_DTPS)
000CE3 4CE3 09              11      ADD HL,BC
000CE4 4CE4 ED5BE7F2        20      LD  DE,(DTAX)
000CE8 4CE8 C1              10      POP BC
000CE9 4CE9 C9              10      RET
                                
       4CEA                     RBXB:
000CEA 4CEA 2AE7F2          16      LD  HL,(DTAX)
000CED 4CED ED5BCEF2        20      LD  DE,(_CLPS)
000CF1 4CF1 3AF1F2          13      LD  A,(LEFTX+1)
000CF4 4CF4 47               4      LD  B,A
000CF5 4CF5 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4CF8                     RBXB1:
000CF8 4CF8 1F               4      RRA     ;->CF
000CF9 4CF9 3804            12      JR  C,RBXB2
000CFB 4CFB CB38             8      SRL B   ;B=B/2
000CFD 4CFD 18F9            12      JR  RBXB1
       4CFF                     RBXB2:
000CFF 4CFF 78               4      LD  A,B
000D00 4D00 B7               4      OR  A
000D01 4D01 C9              10      RET
                                
       4D02                     RBXC:
000D02 4D02 ED4BF0F2        20      LD  BC,(LEFTX)
000D06 4D06 3AC7F2          13      LD  A,(CLSZ_H)
000D09 4D09 3D               4      DEC A
000D0A 4D0A A0               4      AND B
000D0B 4D0B 47               4      LD  B,A
000D0C 4D0C B1               4      OR  C
000D0D 4D0D C9              10      RET
                                
       4D0E                     RBXEND:
000D0E 4D0E ED5BD0F2        20      LD  DE,(_LEFT)
000D12 4D12 2ACAF2          16      LD  HL,(RR_LOW)
000D15 4D15 3ACDF2          13      LD  A,(RR_HIGH+1)
000D18 4D18 19              11      ADD HL,DE
000D19 4D19 CE00             7      ADC A,0
000D1B 4D1B 22CAF2          16      LD  (RR_LOW),HL
000D1E 4D1E 32CDF2          13      LD  (RR_HIGH+1),A
000D21 4D21 EB               4      EX  DE,HL       ;HL=Read byte
000D22 4D22 C9              10      RET 
                                
       4D23                     RWXR:
000D23 4D23 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4D26                     L_RWX:
000D26 4D26 1F               4      RRA     ;->CF
000D27 4D27 3806            12      JR  C,E_RWX
000D29 4D29 CB38             8      SRL B   ;BC=BC/2
000D2B 4D2B CB19             8      RR  C   ;
000D2D 4D2D 18F7            12      JR  L_RWX
       4D2F                     E_RWX:
000D2F 4D2F 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
                                    PUSH    HL
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    POP HL
                                #else
000D32 4D32 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D35 4D35 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D38 4D38 FD2AEDF2        20      LD  IY,(DIRENT1)
000D3C 4D3C FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000D3F 4D3F FD561B          19      LD  D,(IY+01BH)
                                #endif
000D42 4D42 CDBF52          17      CALL    GET_DISK_BANK_FDRV
       4D45                     RWX1:
000D45 4D45 ED53CEF2        20      LD  (_CLPS),DE
000D49 4D49 7A               4      LD  A,D
000D4A 4D4A B3               4      OR  E
000D4B 4D4B 37               4      SCF
000D4C 4D4C C8              11      RET Z
                                
000D4D 4D4D 78               4      LD  A,B
000D4E 4D4E B1               4      OR  C
000D4F 4D4F C8              11      RET Z
                                
000D50 4D50 CD724D          17      CALL    GNCL
000D53 4D53 D8              11      RET C
000D54 4D54 0B               6      DEC BC
000D55 4D55 CDD44D          17      CALL    ENDCL
000D58 4D58 38EB            12      JR  C,RWX1
000D5A 4D5A 37               4      SCF
000D5B 4D5B C9              10      RET
                                
       4D5C                     NCL3:
000D5C 4D5C CDBF52          17      CALL    GET_DISK_BANK_FDRV
000D5F 4D5F 6B               4      LD  L,E
000D60 4D60 62               4      LD  H,D
000D61 4D61 CB3C             8      SRL H
000D63 4D63 CB1D             8      RR  L
000D65 4D65 1F               4      RRA
000D66 4D66 19              11      ADD HL,DE
000D67 4D67 010060          10      LD  BC,BANK1_ADR
000D6A 4D6A 09              11      ADD HL,BC
000D6B 4D6B ED4BC8F2        20      LD  BC,(SECSZ)
000D6F 4D6F 09              11      ADD HL,BC
000D70 4D70 17               4      RLA
000D71 4D71 C9              10      RET
                                
       4D72                     GNCL:
000D72 4D72 7A               4      LD  A,D
000D73 4D73 B3               4      OR  E
000D74 4D74 37               4      SCF
000D75 4D75 C8              11      RET Z
000D76 4D76 C5              11      PUSH    BC
000D77 4D77 E5              11      PUSH    HL
000D78 4D78 CD5C4D          17      CALL    NCL3
000D7B 4D7B 3809            12      JR  C,GNC1
000D7D 4D7D 5E               7      LD  E,(HL)
000D7E 4D7E 23               6      INC HL
000D7F 4D7F 7E               7      LD  A,(HL)
000D80 4D80 E60F             7      AND 00FH
000D82 4D82 57               4      LD  D,A
000D83 4D83 E1              10      POP HL
000D84 4D84 C1              10      POP BC
000D85 4D85 C9              10      RET
       4D86                     GNC1:
000D86 4D86 7E               7      LD  A,(HL)
000D87 4D87 23               6      INC HL
000D88 4D88 56               7      LD  D,(HL)
000D89 4D89 0604             7      LD  B,4
       4D8B                     GNC1L:
000D8B 4D8B CB3A             8      SRL D
000D8D 4D8D 1F               4      RRA
000D8E 4D8E 10FB            13      DJNZ    GNC1L
                                
000D90 4D90 5F               4      LD  E,A
000D91 4D91 E1              10      POP HL
000D92 4D92 C1              10      POP BC
000D93 4D93 A7               4      AND A
000D94 4D94 C9              10      RET
                                
       4D95                     CLUST:
000D95 4D95 EB               4      EX  DE,HL
       4D96                     CLUST_HL:
000D96 4D96 2B               6      DEC HL
000D97 4D97 2B               6      DEC HL
000D98 4D98 C5              11      PUSH    BC
000D99 4D99 3AC7F2          13      LD  A,(CLSZ_H)
000D9C 4D9C CDEF52          17      CALL    MUL_AHL
                                
000D9F 4D9F CD584E          17      CALL    GET_DIR_POS
000DA2 4DA2 4F               4      LD  C,A
000DA3 4DA3 0600             7      LD  B,0
000DA5 4DA5 09              11      ADD HL,BC
                                
000DA6 4DA6 ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
000DAA 4DAA CB38             8      SRL B
000DAC 4DAC CB19             8      RR  C           ;/2
000DAE 4DAE CB38             8      SRL B
000DB0 4DB0 CB19             8      RR  C           ;/4
000DB2 4DB2 CB38             8      SRL B
000DB4 4DB4 CB19             8      RR  C           ;/8
000DB6 4DB6 09              11      ADD HL,BC
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  A,L
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    JR  NC,CLUST2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
000DB7 4DB7 4D               4      LD  C,L     ;C=読み出し元
000DB8 4DB8 29              11      ADD HL,HL   ;64KB→32KB
000DB9 4DB9 29              11      ADD HL,HL   ;32KB→16KB
000DBA 4DBA 29              11      ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
000DBB 4DBB CDBF52          17      CALL    GET_DISK_BANK_FDRV
000DBE 4DBE 84               4      ADD A,H
000DBF 4DBF 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000DC2 4DC2 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000DC5 4DC5 32C4F2          13      LD  (_BANK),A
000DC8 4DC8 69               4      LD  L,C     ;C=読み出し元
000DC9 4DC9 3E1F             7      LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
000DCB 4DCB A5               4      AND L
                                #endif
       4DCC                     CLUST2:
000DCC 4DCC C660             7      ADD A,high BANK1_ADR
000DCE 4DCE 67               4      LD  H,A
000DCF 4DCF 2E00             7      LD  L,0
000DD1 4DD1 EB               4      EX  DE,HL
000DD2 4DD2 C1              10      POP BC
000DD3 4DD3 C9              10      RET
                                
       4DD4                     ENDCL:
000DD4 4DD4 7A               4      LD  A,D ;END CLUSTER
000DD5 4DD5 FE0F             7      CP  00FH    ;FAT12の最大値
000DD7 4DD7 C0              11      RET NZ
000DD8 4DD8 7B               4      LD  A,E
000DD9 4DD9 FEF7             7      CP  0F7H
000DDB 4DDB C9              10      RET
                                
       4DDC                     RB_READ:
000DDC 4DDC AF               4      XOR A   ;HLA = HL*128
000DDD 4DDD CB3C             8      SRL H
000DDF 4DDF CB1D             8      RR  L
000DE1 4DE1 1F               4      RRA
000DE2 4DE2 32CAF2          13      LD  (RR_LOW),A
000DE5 4DE5 22CBF2          16      LD  (RR_MID),HL
000DE8 4DE8 218000          10      LD  HL,128
                                
000DEB 4DEB CDBD49          17      CALL    ROM_READ
000DEE 4DEE C9              10      RET
                                
       4DEF                     GETSEQ:
000DEF 4DEF FD6E20          19      LD  L,(IY+32)
000DF2 4DF2 FD660C          19      LD  H,(IY+12)
                                
000DF5 4DF5 CB25             8      SLA L
                                
000DF7 4DF7 CB3C             8      SRL H
000DF9 4DF9 CB1D             8      RR  L
000DFB 4DFB C9              10      RET
                                
       4DFC                     SETSEQ:
000DFC 4DFC F5              11      PUSH    AF
000DFD 4DFD 3ACAF2          13      LD  A,(RR_LOW)
000E00 4E00 2ACBF2          16      LD  HL,(RR_MID)
                                
000E03 4E03 CD1A4E          17      CALL    SSQ1
                                
000E06 4E06 29              11      ADD HL,HL
000E07 4E07 CB3D             8      SRL L
000E09 4E09 FD7520          19      LD  (IY+32),L
000E0C 4E0C FD740C          19      LD  (IY+12),H
000E0F 4E0F F1              10      POP AF
000E10 4E10 C9              10      RET
                                
       4E11                     GETSIZE:
000E11 4E11 FD7E10          19      LD  A,(IY+16)
000E14 4E14 FD6E11          19      LD  L,(IY+17)
000E17 4E17 FD6612          19      LD  H,(IY+18)
       4E1A                     SSQ1:
000E1A 4E1A 87               4      ADD A,A
000E1B 4E1B ED6A            15      ADC HL,HL
000E1D 4E1D B7               4      OR  A
000E1E 4E1E C8              11      RET Z
000E1F 4E1F 23               6      INC HL
000E20 4E20 C9              10      RET
                                
       4E21                     SET_FCB:
000E21 4E21 D5              11      PUSH    DE
000E22 4E22 FDE1            14      POP IY
000E24 4E24 FD7E1C          19      LD  A,(IY+28)
000E27 4E27 FEFF             7      CP  0FFH
000E29 4E29 200C            12      JR  NZ,POPAF_SCF_FF_RET
000E2B 4E2B E5              11      PUSH    HL
000E2C 4E2C FD6E1A          19      LD  L,(IY+26)
000E2F 4E2F FD661B          19      LD  H,(IY+27)
000E32 4E32 22CEF2          16      LD  (_CLPS),HL
000E35 4E35 E1              10      POP HL
000E36 4E36 C9              10      RET
                                
       4E37                     POPAF_SCF_FF_RET:
000E37 4E37 F1              10      POP AF
000E38 4E38 37               4      SCF
000E39 4E39 9F               4      SBC A,A
000E3A 4E3A C9              10      RET
                                
       4E3B                     GET_DIR_DAT:
000E3B 4E3B 2AF6F2          16      LD  HL,(_CDX)
000E3E 4E3E 7C               4      LD  A,H
000E3F 4E3F B5               4      OR  L
000E40 4E40 2035            12      JR  NZ,GET_SUBDIR
000E42 4E42 CD584E          17      CALL    GET_DIR_POS
000E45 4E45 C660             7      ADD A,high BANK1_ADR
000E47 4E47 2E00             7      LD  L,0
000E49 4E49 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
000E4A 4E4A CD224C          17      CALL    CHECK_DIR_PAGE
                                #endif
000E4D 4E4D 3AC5F2          13      LD  A,(_BANK1)
000E50 4E50 32EFF2          13      LD  (_DIR_BANK),A
                                
000E53 4E53 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000E56 4E56 4F               4      LD  C,A
000E57 4E57 C9              10      RET
                                
       4E58                     GET_DIR_POS:                ;ルートディレクトリ
000E58 4E58 CDBF52          17      CALL    GET_DISK_BANK_FDRV
000E5B 4E5B 32C5F2          13      LD  (_BANK1),A
000E5E 4E5E 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000E61 4E61 47               4      LD  B,A
000E62 4E62 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000E65 4E65 4F               4      LD  C,A
000E66 4E66 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4E69                     GET_DIR_POS1:
000E69 4E69 81               4      ADD A,C
000E6A 4E6A 10FD            13      DJNZ    GET_DIR_POS1
                                
000E6C 4E6C ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
000E70 4E70 37               4      SCF     ;無限ループ回避
       4E71                     L_MDP:
000E71 4E71 CB18             8      RR  B   ;->CF
000E73 4E73 D8              11      RET C
000E74 4E74 87               4      ADD A,A
000E75 4E75 18FA            12      JR  L_MDP
                                
       4E77                     GET_SUBDIR:             ;サブディレクトリ
000E77 4E77 CD964D          17      CALL    CLUST_HL
000E7A 4E7A EB               4      EX  DE,HL
000E7B 4E7B 3AC4F2          13      LD  A,(_BANK)
000E7E 4E7E 32EFF2          13      LD  (_DIR_BANK),A
000E81 4E81 3AC7F2          13      LD  A,(CLSZ_H)
000E84 4E84 87               4      ADD A,A     ;*2
000E85 4E85 87               4      ADD A,A     ;*4
000E86 4E86 87               4      ADD A,A     ;*8
000E87 4E87 4F               4      LD  C,A
000E88 4E88 C9              10      RET
                                
       4E89                     STATEMENT:
000E89 4E89 11DC50          10      LD  DE,STR_CHDIR
000E8C 4E8C CDC250          17      CALL    CPPROCNM
000E8F 4E8F 2812            12      JR  Z,_CHDIR
000E91 4E91 11E250          10      LD  DE,STR_CHDRV
000E94 4E94 CDC250          17      CALL    CPPROCNM
000E97 4E97 281C            12      JR  Z,_CHDRV
000E99 4E99 11E850          10      LD  DE,STR_RAMDISK
000E9C 4E9C CDC250          17      CALL    CPPROCNM
000E9F 4E9F 2829            12      JR  Z,_RAMDISK
000EA1 4EA1 37               4      SCF
000EA2 4EA2 C9              10      RET
       4EA3                     _CHDIR:
000EA3 4EA3 7E               7      LD  A,(HL)
000EA4 4EA4 FE28             7      CP  '('
000EA6 4EA6 37               4      SCF
000EA7 4EA7 C0              11      RET NZ
000EA8 4EA8 CD6B47          17      CALL    INIT_PARAM
000EAB 4EAB CD5E4A          17      CALL    FILE_B
000EAE 4EAE CDDE4E          17      CALL    ROM_CD
000EB1 4EB1 D0              11      RET NC
000EB2 4EB2 C31546          10      JP  ERROR_FILE_NOT_FOUND
                                
       4EB5                     _CHDRV:
000EB5 4EB5 7E               7      LD  A,(HL)
000EB6 4EB6 FE28             7      CP  '('
000EB8 4EB8 37               4      SCF
000EB9 4EB9 C0              11      RET NZ
000EBA 4EBA CD6B47          17      CALL    INIT_PARAM
000EBD 4EBD E5              11      PUSH    HL
000EBE 4EBE CD5E4A          17      CALL    FILE_B
000EC1 4EC1 E1              10      POP HL
000EC2 4EC2 23               6      INC HL
000EC3 4EC3 3AF8F2          13      LD  A,(FDRV)
000EC6 4EC6 3D               4      DEC A
000EC7 4EC7 C32855          10      JP  _SYS0EX1
                                
       4ECA                     _RAMDISK:
000ECA 4ECA 7E               7      LD  A,(HL)
000ECB 4ECB FE28             7      CP  '('
000ECD 4ECD 37               4      SCF
000ECE 4ECE C0              11      RET NZ
000ECF 4ECF 23               6      INC HL
000ED0 4ED0 DD212F54        14      LD  IX,FRMQNT
000ED4 4ED4 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000ED8 4ED8 CD1C00          17      CALL    _CALSLT
                                ;   LD  A,(HOKVLD)  ;bit0: 拡張 BIOSの存在
                                ;   CPL
                                ;   AND 1
                                ;   LD  A,D
                                ;   OR  E
                                ;   JP  NZ,ERROR_INTERNAL_ERROR
                                ;   PUSH    HL      ;EXTBIOもDISK BIOSで初期化してそう
                                ;   XOR A
                                ;   LD  DE,0401H    ;D=マッパサポートルチン(4) E=機能番号(1)
                                ;   CALL    EXTBIO
                                ;   POP HL
                                ;   OR  A
                                ;   JP  Z,ERROR_INTERNAL_ERROR
000EDB 4EDB 23               6      INC HL
000EDC 4EDC AF               4      XOR A
000EDD 4EDD C9              10      RET
                                
       4EDE                     ROM_CD:
000EDE 4EDE 3AF9F2          13      LD  A,(FNAME)
000EE1 4EE1 FE20             7      CP  020H
000EE3 4EE3 2822            12      JR  Z,CD1
000EE5 4EE5 CDDD4B          17      CALL    ROM_OPEN
000EE8 4EE8 D8              11      RET C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
000EE9 4EE9 FD2AEDF2        20      LD  IY,(DIRENT1)
000EED 4EED FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
000EF1 4EF1 CA1546          10      JP  Z,ERROR_FILE_NOT_FOUND
000EF4 4EF4 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000EF7 4EF7 FD661B          19      LD  H,(IY+01BH)
                                #endif
       4EFA                     CD2:
000EFA 4EFA 22EBF2          16      LD  (_CD),HL
000EFD 4EFD 2AF4F2          16      LD  HL,(PARAM1)
       4F00                     CD_SKIP:
000F00 4F00 7E               7      LD  A,(HL)
000F01 4F01 23               6      INC HL
000F02 4F02 FE21             7      CP  021H
000F04 4F04 38FA            12      JR  C,CD_SKIP
000F06 4F06 C9              10      RET
       4F07                     CD1:
000F07 4F07 2AF6F2          16      LD  HL,(_CDX)
000F0A 4F0A 18EE            12      JR  CD2
                                
       4F0C                     GET_BASIC_FCB:
000F0C 4F0C D5              11      PUSH    DE
000F0D 4F0D 23               6      INC HL  ;+1
000F0E 4F0E 5E               7      LD  E,(HL)  ;FCB[1]
000F0F 4F0F 23               6      INC HL  ;+2
000F10 4F10 56               7      LD  D,(HL)  ;FCB[2]
000F11 4F11 23               6      INC HL  ;+3
000F12 4F12 ED53EDF2        20      LD  (DIRENT1),DE
                                            ;FCB[3] backup char
000F16 4F16 23               6      INC HL  ;+4
                                            ;FCB[4]
000F17 4F17 23               6      INC HL  ;+5
000F18 4F18 7E               7      LD  A,(HL)  ;FCB[5]
000F19 4F19 23               6      INC HL  ;+6
000F1A 4F1A 32EFF2          13      LD  (_DIR_BANK),A
000F1D 4F1D 5E               7      LD  E,(HL)  ;FCB[6]
000F1E 4F1E 23               6      INC HL  ;+7
000F1F 4F1F 56               7      LD  D,(HL)  ;FCB[7]
000F20 4F20 23               6      INC HL  ;+8
000F21 4F21 ED53CAF2        20      LD  (RR_LOW),DE
000F25 4F25 7E               7      LD  A,(HL)  ;FCB[8]
000F26 4F26 23               6      INC HL  ;+9
000F27 4F27 32CCF2          13      LD  (RR_HIGH),A
000F2A 4F2A 22D4F2          16      LD  (_DTA),HL   ;FCB[9]
000F2D 4F2D D1              10      POP DE
000F2E 4F2E C9              10      RET
                                
       4F2F                     SET_BASIC_FCB:
000F2F 4F2F E5              11      PUSH    HL
000F30 4F30 2A64F8          16      LD  HL,(PTRFIL)
000F33 4F33 23               6      INC HL  ;+1
000F34 4F34 D5              11      PUSH    DE
000F35 4F35 ED5BEDF2        20      LD  DE,(DIRENT1)
000F39 4F39 73               7      LD  (HL),E  ;FCB[1]
000F3A 4F3A 23               6      INC HL  ;+2
000F3B 4F3B 72               7      LD  (HL),D  ;FCB[2]
000F3C 4F3C 23               6      INC HL  ;+3
000F3D 4F3D 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
000F3E 4F3E 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
000F3F 4F3F 23               6      INC HL  ;+5
000F40 4F40 3AEFF2          13      LD  A,(_DIR_BANK)
000F43 4F43 77               7      LD  (HL),A  ;FCB[5]
000F44 4F44 23               6      INC HL  ;+6
000F45 4F45 ED5BCAF2        20      LD  DE,(RR_LOW)
000F49 4F49 73               7      LD  (HL),E  ;FCB[6]
000F4A 4F4A 23               6      INC HL  ;+7
000F4B 4F4B 72               7      LD  (HL),D  ;FCB[7]
000F4C 4F4C 23               6      INC HL  ;+8
000F4D 4F4D 3ACCF2          13      LD  A,(RR_HIGH)
000F50 4F50 77               7      LD  (HL),A  ;FCB[8]
000F51 4F51 D1              10      POP DE
000F52 4F52 E1              10      POP HL
000F53 4F53 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_18:BACKUP
                                ;in
                                ;   C : backup charactor
                                ;   HL: FBC pointer
                                ;out
       4F54                     DEVICE_18_BACKUP:
000F54 4F54 D5              11      PUSH    DE
000F55 4F55 E5              11      PUSH    HL
000F56 4F56 110300          10      LD  DE,3
000F59 4F59 19              11      ADD HL,DE
000F5A 4F5A 71               7      LD  (HL),C
000F5B 4F5B E1              10      POP HL
000F5C 4F5C D1              10      POP DE
000F5D 4F5D C9              10      RET
                                
       4F5E                     DEVICE_CHECK:
000F5E 4F5E 3A8AFD          13      LD  A,(PROCNM+1)
000F61 4F61 B7               4      OR  A
000F62 4F62 C8              11      RET Z
000F63 4F63 11F050          10      LD  DE,STR_ROM
000F66 4F66 CDC250          17      CALL    CPPROCNM
000F69 4F69 2802            12      JR  Z,DEVICE_OK
000F6B 4F6B 37               4      SCF
000F6C 4F6C C9              10      RET
       4F6D                     DEVICE_OK:
000F6D 4F6D AF               4      XOR A
000F6E 4F6E C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファ
                                
       4F6F                     DEVICE_0_OPEN:
000F6F 4F6F 7B               4      LD  A,E
000F70 4F70 FE02             7      CP  2       ;FOR OUTPUT
000F72 4F72 281B            12      JR  Z,OPEN2
000F74 4F74 D5              11      PUSH    DE
000F75 4F75 E5              11      push    hl
                                ;
000F76 4F76 3E01             7      LD  A,1     ;ドライブA
000F78 4F78 32F8F2          13      LD  (FDRV),A
000F7B 4F7B 2166F8          10      LD  HL,FILNAM
000F7E 4F7E 11F9F2          10      LD  DE,FNAME
000F81 4F81 010B00          10      LD  BC,8+3
000F84 4F84 CDA556          17      CALL    INIT_FILE1
000F87 4F87 CDDD4B          17      CALL    ROM_OPEN
000F8A 4F8A DA1546          10      JP  C,ERROR_FILE_NOT_FOUND
000F8D 4F8D E1              10      pop hl
000F8E 4F8E D1              10      POP DE
       4F8F                     OPEN2:
000F8F 4F8F 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
000F92 4F92 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
000F93 4F93 AF               4      XOR A
000F94 4F94 32F0F2          13      LD  (LEFTX),A
000F97 4F97 CD2F4F          17      CALL    SET_BASIC_FCB
000F9A 4F9A 7B               4      ld  a,e
000F9B 4F9B FE08             7      cp  8
000F9D 4F9D 3F               4      ccf
000F9E 4F9E C9              10      ret
                                
       4F9F                     DEVICE_2_CLOSE:
000F9F 4F9F AF               4      XOR A
                                ;   LD  (HL),A
000FA0 4FA0 6F               4      LD  L,A
000FA1 4FA1 67               4      LD  H,A
000FA2 4FA2 2264F8          16      LD  (PTRFIL),HL
000FA5 4FA5 C9              10      RET
                                
       4FA6                     DEVICE_ENTRY:
000FA6 4FA6 FE08             7      CP  8
000FA8 4FA8 2826            12      JR  Z,DEVICE_8_SIN
000FAA 4FAA 3C               4      INC A
000FAB 4FAB 28B1            12      JR  Z,DEVICE_CHECK:
000FAD 4FAD 3D               4      DEC A
000FAE 4FAE 28BF            12      JR  Z,DEVICE_0_OPEN
000FB0 4FB0 FE0E             7      CP  14
000FB2 4FB2 2860            12      JR  Z,DEVICE_14_EOF
000FB4 4FB4 FE04             7      CP  4
000FB6 4FB6 2834            12      JR  Z,DEVICE_4_RANDOM
000FB8 4FB8 FE0A             7      CP  10
000FBA 4FBA 2850            12      JR  Z,DEVICE_10_LOC
000FBC 4FBC FE0C             7      CP  12
000FBE 4FBE 2878            12      JR  Z,DEVICE_12_LOF
000FC0 4FC0 FE02             7      CP  2
000FC2 4FC2 2890            12      JR  Z,DEVICE_18_BACKUP  
000FC4 4FC4 FE02             7      CP  2
000FC6 4FC6 28D7            12      JR  Z,DEVICE_2_CLOSE
000FC8 4FC8 FE06             7      CP  6
000FCA 4FCA 2802            12      JR  Z,DEVICE_6_SOUT
000FCC 4FCC 37               4      SCF
000FCD 4FCD C9              10      RET
                                
       4FCE                     DEVICE_6_SOUT:
000FCE 4FCE AF               4      XOR A
000FCF 4FCF C9              10      RET
                                
       4FD0                     DEVICE_8_SIN:
000FD0 4FD0 CD0C4F          17      CALL    GET_BASIC_FCB
000FD3 4FD3 210100          10      LD  HL,1
000FD6 4FD6 CDBD49          17      CALL    ROM_READ
000FD9 4FD9 7C               4      LD  A,H
000FDA 4FDA B5               4      OR  L
000FDB 4FDB 280D            12      JR  Z,CCF_RET
000FDD 4FDD 2AD4F2          16      LD  HL,(_DTA)
000FE0 4FE0 7E               7      LD  A,(HL)
000FE1 4FE1 F5              11      PUSH    AF
000FE2 4FE2 CD2F4F          17      CALL    SET_BASIC_FCB
000FE5 4FE5 F1              10      POP AF
000FE6 4FE6 FE0A             7      CP  00AH
000FE8 4FE8 C8              11      RET Z   ;ZF=separate
                                ;   CP  01AH
                                ;   JR  Z,SCF_RET
000FE9 4FE9 37               4      SCF     ;
       4FEA                     CCF_RET:
000FEA 4FEA 3F               4      CCF     ;ZF=0 CF=0にしたい
000FEB 4FEB C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_4:RANDOM
                                ;in
                                ;   A : 4
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
       4FEC                     DEVICE_4_RANDOM:
000FEC 4FEC D5              11      PUSH    DE
000FED 4FED CD0C4F          17      CALL    GET_BASIC_FCB
000FF0 4FF0 DDE5            15      PUSH    IX
000FF2 4FF2 DD218A2F        14      LD  IX,FRCINT
000FF6 4FF6 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000FFA 4FFA CDB1F2          17      CALL    CAL_MP
000FFD 4FFD DDE1            14      POP IX
000FFF 4FFF 2AF8F7          16      LD  HL,(DACDAT)
001002 5002 22CAF2          16      LD  (RR_LOW),HL
001005 5005 AF               4      XOR A
001006 5006 CD2F4F          17      CALL    SET_BASIC_FCB
001009 5009 D1              10      POP DE
00100A 500A AF               4      XOR A
00100B 500B C9              10      RET
                                
                                ;FUNC_10:LOC
                                ;in
                                ;   A : 10
                                ;out
                                ;   DAC    : value of received bytes
                                ;   VALTYP : DAC type
       500C                     DEVICE_10_LOC:
00100C 500C CD0C4F          17      CALL    GET_BASIC_FCB
00100F 500F 2ACAF2          16      LD  HL,(RR_LOW)
001012 5012 183D            12      JR  RETURN_TYPE8_AHL
                                
                                ;--------------------------------------
                                ;FUNC_14:EOF
                                ;in
                                ;   A : 14
                                ;out
                                ;   DAC    : value of EOF value (EOF=-1)
                                ;   VALTYP : DAC type
       5014                     DEVICE_14_EOF:
001014 5014 CD0C4F          17      CALL    GET_BASIC_FCB
001017 5017 CD6F4C          17      CALL    RBX1
00101A 501A 3810            12      JR  C,DEVICE_14_EOF1
00101C 501C 210100          10      LD  HL,1
00101F 501F CDBD49          17      CALL    ROM_READ
001022 5022 2AD4F2          16      LD  HL,(_DTA)
001025 5025 7E               7      LD  A,(HL)
001026 5026 FE1A             7      CP  01AH
001028 5028 37               4      SCF
001029 5029 2801            12      JR  Z,DEVICE_14_EOF1
00102B 502B 3F               4      CCF
       502C                     DEVICE_14_EOF1:
00102C 502C 9F               4      SBC A,A
00102D 502D 6F               4      LD  L,A
00102E 502E 67               4      LD  H,A
       502F                     return_type2_hl:
00102F 502F 22F8F7          16      ld  (DACDAT),hl
001032 5032 3E02             7      ld  a,2
001034 5034 3263F6          13      ld  (VALTYP),a
001037 5037 C9              10      ret
                                
                                ;--------------------------------------
                                ;FUNC_16:FPOS
                                ;in
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
                                ;   illegal function call
                                
                                ;--------------------------------------
                                ;FUNC_12:LOF
                                ;in
                                ;   A : 12
                                ;out
                                ;   DAC    : value of LOC+RSIQLN
                                ;   VALTYP : DAC type
       5038                     DEVICE_12_LOF:
001038 5038 CD0C4F          17      CALL    GET_BASIC_FCB
                                
00103B 503B 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001CH
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    CALL    RDSLT_ROM
                                    EX  DE,HL       ;AHL=File size
                                    POP DE
                                #else
00103E 503E 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
001041 5041 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
001044 5044 FD2AEDF2        20      LD  IY,(DIRENT1)
001048 5048 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
00104B 504B FD661D          19      LD  H,(IY+01DH)
00104E 504E FD7E1E          19      LD  A,(IY+01EH)
                                #endif
       5051                     RETURN_TYPE8_AHL:
001051 5051 B7               4      OR  A
001052 5052 2004            12      JR  NZ,RT8AHL1
001054 5054 CB7C             8      BIT 7,H
001056 5056 28D7            12      JR  Z,return_type2_hl
       5058                     RT8AHL1:
001058 5058 E5              11      PUSH    HL
001059 5059 29              11      ADD HL,HL
00105A 505A 8F               4      ADC A,A
00105B 505B 32F8F7          13      LD  (DACDAT),A
00105E 505E 3E00             7      LD  A,0
001060 5060 8F               4      ADC A,A
001061 5061 32F9F7          13      LD  (DACDAT+1),A
                                
001064 5064 3E02             7      LD  A,2
001066 5066 3263F6          13      LD  (VALTYP),A
001069 5069 DD213A30        14      LD  IX,FRCDBL
00106D 506D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001071 5071 CDB1F2          17      CALL    CAL_MP
                                
001074 5074 21BA50          10      LD  HL,DBL32768
001077 5077 1147F8          10      LD  DE,ARG
00107A 507A 010800          10      LD  BC,8
00107D 507D EDB0                    LDIR
                                
00107F 507F DD21E627        14      LD  IX,DECMUL
001083 5083 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001087 5087 CDB1F2          17      CALL    CAL_MP
                                
00108A 508A 21F6F7          10      LD  HL,DAC
00108D 508D 1147F8          10      LD  DE,ARG
001090 5090 010800          10      LD  BC,8
001093 5093 EDB0                    LDIR
                                
001095 5095 E1              10      POP HL
001096 5096 22F8F7          16      LD  (DACDAT),HL
                                
001099 5099 3E02             7      LD  A,2
00109B 509B 3263F6          13      LD  (VALTYP),A
00109E 509E DD213A30        14      LD  IX,FRCDBL
0010A2 50A2 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0010A6 50A6 CDB1F2          17      CALL    CAL_MP
                                
0010A9 50A9 DD219A26        14      LD  IX,DECADD
0010AD 50AD FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0010B1 50B1 CDB1F2          17      CALL    CAL_MP
                                
0010B4 50B4 3E08             7      LD  A,8
0010B6 50B6 3263F6          13      LD  (VALTYP),A
0010B9 50B9 C9              10      RET
                                
       50BA                     DBL32768:
0010BA 50BA 4532768000000000        DB  045H,032H,076H,080H,0,0,0,0
                                
       50C2                     CPPROCNM:
0010C2 50C2 E5              11      PUSH    HL
0010C3 50C3 2189FD          10      LD  HL,PROCNM
       50C6                     CPPROCNM1:
0010C6 50C6 1A               7      LD  A,(DE)
0010C7 50C7 13               6      INC DE
0010C8 50C8 BE               7      CP  (HL)
0010C9 50C9 23               6      INC HL
0010CA 50CA 2003            12      JR  NZ,CPPROCNM2
0010CC 50CC B7               4      OR  A
0010CD 50CD 20F7            12      JR  NZ,CPPROCNM1
       50CF                     CPPROCNM2:
0010CF 50CF E1              10      POP HL
0010D0 50D0 C9              10      RET
                                
       50D1                     WILDCARD:
0010D1 50D1 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       50DC                     STR_CHDIR:
0010DC 50DC 434844495200            DB  "CHDIR",0
       50E2                     STR_CHDRV:
0010E2 50E2 434844525600            DB  "CHDRV",0
       50E8                     STR_RAMDISK:
0010E8 50E8 52414D4449534B00        DB  "RAMDISK",0
       50F0                     STR_ROM:
0010F0 50F0 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       50F4                     ERROR_WRITE_PROTECTED:
0010F4 50F4 3E00             7      LD  A,0     ;Write protected
0010F6 50F6 C9              10      RET
       50F7                     DISKIO:
0010F7 50F7 38FB            12      JR  C,ERROR_WRITE_PROTECTED
0010F9 50F9 48               4      LD  C,B
0010FA 50FA CDC952          17      CALL    GET_DISK_BANK
       50FD                     SETMAP1:        
0010FD 50FD E5              11      PUSH    HL
       50FE                     DISKIO1:
0010FE 50FE C5              11      PUSH    BC      ;B=残りのセクタ数
0010FF 50FF D5              11      PUSH    DE      ;DE=セクタ番号
001100 5100 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
001101 5101 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
001102 5102 F5              11      PUSH    AF
001103 5103 3AC9F2          13      LD  A,(SECSZ_H)
001106 5106 CDEF52          17      CALL    MUL_AHL
001109 5109 F1              10      POP AF
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  A,L
                                    PUSH    BC
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    POP BC
                                    JR  NC,DISKIO2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
00110A 510A 4D               4      LD  C,L     ;C=読み出し元
00110B 510B 29              11      ADD HL,HL       ;64KB→32KB
00110C 510C 29              11      ADD HL,HL       ;32KB→16KB
00110D 510D 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
00110E 510E 84               4      ADD A,H
00110F 510F 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
001112 5112 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
001115 5115 32C4F2          13      LD  (_BANK),A
001118 5118 79               4      LD  A,C     ;C=読み出し元
001119 5119 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       511B                     DISKIO2:
00111B 511B C660             7      ADD A,high BANK1_ADR
00111D 511D 67               4      LD  H,A
00111E 511E ED4BC8F2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
001122 5122 69               4      LD  L,C     ;C=0
001123 5123 CD3644          17      CALL    ROM_LDIR
001126 5126 EB               4      EX  DE,HL
001127 5127 F1              10      POP AF
001128 5128 D1              10      POP DE
001129 5129 13               6      INC DE
00112A 512A C1              10      POP BC
00112B 512B 10D1            13      DJNZ    DISKIO1
00112D 512D 41               4      LD  B,C
                                
00112E 512E E1              10      POP HL
00112F 512F AF               4      XOR A
                                
001130 5130 FB               4      EI
001131 5131 C9              10      RET
                                
       5132                     DSKCHG:
001132 5132 CD6B51          17      CALL    IS_BPB
001135 5135 3824            12      JR  C,NOTREADY
001137 5137 3A23FB          13      LD  A,(DRVTBL+2)
00113A 513A B7               4      OR  A
00113B 513B 201A            12      JR  NZ,DSKCHG1
00113D 513D 3A21FB          13      LD  A,(DRVTBL)
001140 5140 FE02             7      CP  2
001142 5142 2013            12      JR  NZ,DSKCHG1
001144 5144 CD6B51          17      CALL    IS_BPB
001147 5147 300E            12      JR  NC,DSKCHG1
001149 5149 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
00114B 514B 3221FB          13      LD  (DRVTBL),A
00114E 514E 3223FB          13      LD  (DRVTBL+2),A
001151 5151 3A48F3          13      LD  A,(MASTERS)
001154 5154 3224FB          13      LD  (DRVTBL+3),A
       5157                     DSKCHG1:
001157 5157 AF               4      XOR A
001158 5158 0601             7      LD  B,1
00115A 515A C9              10      RET
       515B                     NOTREADY:
00115B 515B 3E02             7      LD  A,2
00115D 515D 37               4      SCF
00115E 515E C9              10      RET
                                
       515F                     NO_BPB:
00115F 515F E1              10      POP HL
001160 5160 23               6      INC HL
001161 5161 11F552          10      LD  DE,DPB2DD
001164 5164 011200          10      LD  BC,DPB2DD_E-DPB2DD
001167 5167 EDB0                    LDIR
001169 5169 AF               4      XOR A
00116A 516A C9              10      RET
                                
       516B                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
00116B 516B CDC952          17      CALL    GET_DISK_BANK
                                
00116E 516E 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
001171 5171 FE01             7      CP  1
001173 5173 D8              11      RET C
                                
001174 5174 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
001177 5177 C6FF             7      ADD A,0FFH
001179 5179 D8              11      RET C
                                
00117A 517A 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       517D                     IS_BPB1:
00117D 517D FE01             7      CP  1
00117F 517F C8              11      RET Z
001180 5180 FE02             7      CP  2
001182 5182 C8              11      RET Z
001183 5183 FE04             7      CP  4
001185 5185 C8              11      RET Z
001186 5186 37               4      SCF
001187 5187 C9              10      RET
                                
       5188                     GETDPB:
001188 5188 E5              11      PUSH    HL
001189 5189 CDC952          17      CALL    GET_DISK_BANK
                                
00118C 518C 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
00118F 518F B7               4      OR  A
001190 5190 28CD            12      JR  Z,NO_BPB
001192 5192 DDE1            14      POP IX
001194 5194 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
001197 5197 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
00119A 519A DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
00119D 519D 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
0011A0 51A0 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
0011A3 51A3 87               4      ADD A,A
0011A4 51A4 87               4      ADD A,A
0011A5 51A5 87               4      ADD A,A
0011A6 51A6 3D               4      DEC A
0011A7 51A7 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
0011AA 51AA 06FF             7      LD  B,-1
0011AC 51AC A7               4      AND A           ;無限ループ阻止
       51AD                     GETDPB1:
0011AD 51AD 04               4      INC B
0011AE 51AE 1F               4      RRA
0011AF 51AF 38FC            12      JR  C,GETDPB1
0011B1 51B1 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
0011B4 51B4 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0011B7 51B7 3D               4      DEC A
0011B8 51B8 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
0011BB 51BB A7               4      AND A           ;無限ループ阻止
0011BC 51BC 06FF             7      LD  B,-1
       51BE                     GETDPB2:
0011BE 51BE 04               4      INC B
0011BF 51BF 1F               4      RRA
0011C0 51C0 38FC            12      JR  C,GETDPB2
0011C2 51C2 04               4      INC B
0011C3 51C3 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
0011C6 51C6 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
0011C9 51C9 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
0011CC 51CC DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
0011CF 51CF 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
0011D2 51D2 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
0011D5 51D5 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
0011D8 51D8 DD770B          19      LD  (IX+11),A       ;MAXENT
                                
0011DB 51DB ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
0011DF 51DF DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
0011E2 51E2 DD460A          19      LD  B,(IX+10)       ;FATCNT
0011E5 51E5 210000          10      LD  HL,0
       51E8                     GETDPB3:
0011E8 51E8 19              11      ADD HL,DE
0011E9 51E9 10FD            13      DJNZ    GETDPB3
       51EB                     GETDPB4:
0011EB 51EB DD5E08          19      LD  E,(IX+8)        ;FIRFAT
0011EE 51EE DD5609          19      LD  D,(IX+9)        ;FIRFAT
0011F1 51F1 19              11      ADD HL,DE
0011F2 51F2 DD7511          19      LD  (IX+17),L       ;FIRDIR
0011F5 51F5 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
0011F8 51F8 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0011FB 51FB 87               4      ADD A,A
0011FC 51FC 87               4      ADD A,A
0011FD 51FD DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       5200                     GETDPB5:
001200 5200 CB3B             8      SRL E
001202 5202 1F               4      RRA
001203 5203 30FB            12      JR  NC,GETDPB5
001205 5205 1600             7      LD  D,0
001207 5207 19              11      ADD HL,DE
001208 5208 DD750C          19      LD  (IX+12),L       ;FIRREC
00120B 520B DD740D          19      LD  (IX+13),H       ;FIRREC
                                
00120E 520E 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
001211 5211 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
001214 5214 DD560D          19      LD  D,(IX+13)       ;FIRREC
001217 5217 A7               4      AND A
001218 5218 ED52            15      SBC HL,DE
                                
00121A 521A DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
00121D 521D 3C               4      INC A
00121E 521E 37               4      SCF             ;無限ループ阻止
       521F                     GETDPB6:
00121F 521F 1F               4      RRA
001220 5220 3806            12      JR  C,GETDPB7
001222 5222 CB3C             8      SRL H
001224 5224 CB1D             8      RR  L
001226 5226 18F7            12      JR  GETDPB6
       5228                     GETDPB7:
001228 5228 23               6      INC HL
001229 5229 DD750E          19      LD  (IX+14),L       ;MAXCLUS
00122C 522C DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       522F                     GETDPBD1:
00122F 522F DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001232 5232 E6FC             7      AND 0FCH
001234 5234 C8              11      RET Z
                                
001235 5235 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
001239 5239 37               4      SCF
00123A 523A DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
00123E 523E DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
001241 5241 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
001245 5245 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
001249 5249 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
00124D 524D DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
001251 5251 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
001255 5255 DDCB1126        23      SLA (IX+17)         ;FIRDIR
001259 5259 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
00125D 525D DD6E11          19      LD  L,(IX+17)       ;FIRDIR
001260 5260 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
001263 5263 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001266 5266 87               4      ADD A,A
001267 5267 87               4      ADD A,A
001268 5268 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       526B                     GETDPBD5:
00126B 526B CB3B             8      SRL E
00126D 526D 1F               4      RRA
00126E 526E 30FB            12      JR  NC,GETDPBD5
001270 5270 1600             7      LD  D,0
001272 5272 19              11      ADD HL,DE
001273 5273 DD750C          19      LD  (IX+12),L       ;FIRREC
001276 5276 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001279 5279 18B4            12      JR  GETDPBD1
                                
       527B                     CHOICE:
00127B 527B 210000          10      LD  HL,0
00127E 527E C9              10      RET
                                
       527F                     DSKFMT:
00127F 527F AF               4      XOR A
001280 5280 37               4      SCF
       5281                     DSKSTP:
001281 5281 C9              10      RET
                                
       5282                     BASENT:
001282 5282 2A74F6          16      LD  HL,(STKTOP)
001285 5285 3A40F3          13      LD  A,(REBOOT)
001288 5288 C6FF             7      ADD A,0FFH
00128A 528A 3811            12      JR  C,REBOOT1
00128C 528C 210753          10      LD  HL,AUTOEXEC
00128F 528F 11F8F2          10      LD  DE,FDRV
001292 5292 010C00          10      LD  BC,1+8+3
001295 5295 EDB0                    LDIR
001297 5297 CDDD4B          17      CALL    ROM_OPEN
00129A 529A D45F45          17      CALL    NC,ROM_LOAD1
       529D                     REBOOT1:
00129D 529D 211353          10      LD  HL,CMD_RUN
0012A0 52A0 111FF4          10      LD  DE,KBUF
0012A3 52A3 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
0012A6 52A6 D5              11      PUSH    DE
0012A7 52A7 EDB0                    LDIR
0012A9 52A9 3004            12      JR  NC,REBOOT2
0012AB 52AB AF               4      XOR A
0012AC 52AC 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       52AF                     REBOOT2:
0012AF 52AF E1              10      POP HL
0012B0 52B0 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0012B4 52B4 DD210146        14      LD  IX,NEWSTT
0012B8 52B8 C31C00          10      JP  _CALSLT
                                
       52BB                     GETSLT:
0012BB 52BB 3A22FB          13      LD  A,(DRVTBL+1)
0012BE 52BE C9              10      RET
                                
       52BF                     GET_DISK_BANK_FDRV:
0012BF 52BF 3AF8F2          13      LD  A,(FDRV)
0012C2 52C2 D601             7      SUB 1
0012C4 52C4 3003            12      JR  NC,GET_DISK_BANK
0012C6 52C6 3AEAF2          13      LD  A,(_DVSW)
       52C9                     GET_DISK_BANK:
0012C9 52C9 FE07             7      CP  7       ;H:
0012CB 52CB 2801            12      JR  Z,SET_DISK_BANK_A
0012CD 52CD B7               4      OR  A       ;A=DRIVE
       52CE                     SET_DISK_BANK_A:
0012CE 52CE 3E01             7      LD  A,DISK_BANK
0012D0 52D0 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
0012D2 52D2 3AE9F2          13      LD  A,(B_DRIVE)
                                #endif
       52D5                     SET_DISK_BANK:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0012D5 52D5 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0012D8 52D8 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0012DB 52DB F5              11      PUSH    AF
0012DC 52DC E5              11      PUSH    HL
0012DD 52DD 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
0012E0 52E0 22C8F2          16      LD  (SECSZ),HL
0012E3 52E3 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0012E6 52E6 CDEF52          17      CALL    MUL_AHL
0012E9 52E9 22C6F2          16      LD  (CLSZ),HL
0012EC 52EC E1              10      POP HL
0012ED 52ED F1              10      POP AF
0012EE 52EE C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       52EF                     MUL_AHL:
0012EF 52EF 37               4      SCF     ;無限ループ回避
       52F0                     MUL_AHL1:
0012F0 52F0 1F               4      RRA     ;->CF
0012F1 52F1 D8              11      RET C
0012F2 52F2 29              11      ADD HL,HL
0012F3 52F3 18FB            12      JR  MUL_AHL1
                                
       52F5                     DPB2DD:
0012F5 52F5 F9                      DB  0F9H    ;MEDIA
0012F6 52F6 0002                    DW  00200H  ;SECSIZ
0012F8 52F8 0F                      DB  00FH    ;DIRMSK
0012F9 52F9 04                      DB  004H    ;DIRSHFT
0012FA 52FA 01                      DB  001H    ;CLUSMSK
0012FB 52FB 02                      DB  002H    ;CLUSSHFT
0012FC 52FC 0100                    DW  00001H  ;FIRFAT
0012FE 52FE 02                      DB  002H    ;FATCNT
0012FF 52FF 70                      DB  070H    ;MAXENT
001300 5300 0E00                    DW  0000EH  ;FIRREC
001302 5302 CA02                    DW  002CAH  ;MAXCLUS
001304 5304 03                      DB  003H    ;FATSIZ
001305 5305 0700                    DW  0007H   ;FIRDIR
       5307                     DPB2DD_E:
                                
       5307                     AUTOEXEC:
001307 5307 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       5313                     CMD_RUN:
001313 5313 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DW  0F280H
                                #else
001319 5319 40F2                    DW  0F240H
                                #endif
       531B                     CMD_CLEAR_E:
00131B 531B 3A8A00                  DB  03AH,08AH,0         ;RUN
       531E                     CMD_RUN_E:
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       531E                     POP_HL_ERROR:
00131E 531E E1              10      POP     HL
       531F                     _ERROR:
00131F 531F 0600             7      LD  B,0
001321 5321 A7               4      AND A
001322 5322 C9              10      RET
                                
       5323                     ROM_BDOS:
001323 5323 E5              11      PUSH    HL
001324 5324 79               4      LD  A,C
001325 5325 87               4      ADD A,A
001326 5326 38F7            12      JR  C,_ERROR
001328 5328 6F               4      LD  L,A
001329 5329 265F             7      LD  H,high STABLE
00132B 532B 7E               7      LD  A,(HL)
00132C 532C 2C               4      INC L
00132D 532D 66               7      LD  H,(HL)
00132E 532E 6F               4      LD  L,A
00132F 532F E3              19      EX  (SP),HL
001330 5330 79               4      LD  A,C
001331 5331 C9              10      RET
                                
       5332                     _PRINT:
       5332                     PRINT:
001332 5332 7B               4      LD  A,E
001333 5333 1803            12      JR  MSG_A
                                
       5335                     _SYS01:     ;(BDOS)コンソール入力
001335 5335 CDAC53          17      CALL    _SYS07
       5338                     MSG_A:
001338 5338 FE03             7      CP  3
00133A 533A 2814            12      JR  Z,MSG_BR
       533C                     MSGA1:
00133C 533C F5              11      PUSH    AF
00133D 533D C5              11      PUSH    BC
00133E 533E D5              11      PUSH    DE
00133F 533F E5              11      PUSH    HL
001340 5340 DDE5            15      PUSH    IX
001342 5342 DD21A200        14      LD  IX,CHPUT
001346 5346 CDFA42          17      CALL    CALSLT_R
001349 5349 DDE1            14      POP IX
00134B 534B E1              10      POP HL
00134C 534C D1              10      POP DE
00134D 534D C1              10      POP BC
       534E                     MSGA2:
00134E 534E F1              10      POP AF
00134F 534F C9              10      RET
       5350                     MSG_BR:
001350 5350 F5              11      PUSH    AF
001351 5351 3ADDF3          13      LD  A,(CSRX)
001354 5354 FE02             7      CP  2
001356 5356 38F6            12      JR  C,MSGA2
001358 5358 F1              10      POP AF
       5359                     MSG_CR:
001359 5359 F5              11      PUSH    AF
00135A 535A 3E0D             7      LD  A,00DH
00135C 535C CD3C53          17      CALL    MSGA1
00135F 535F 3E0A             7      LD  A,00AH
001361 5361 CD3C53          17      CALL    MSGA1
001364 5364 F1              10      POP AF
001365 5365 C9              10      RET
                                
       5366                     _SYS02:     ;(BDOS)コンソール出力
001366 5366 CD8153          17      CALL    BREAK
001369 5369 1805            12      JR  PRINTX
                                
       536B                     _SYS06:     ;(BDOS)コンソール直接入出力
00136B 536B 7B               4      LD  A,E
00136C 536C 3C               4      INC A
00136D 536D CAC053          10      JP  Z,_INKEY
       5370                     PRINTX:
001370 5370 C33253          10      JP  _PRINT
                                
       5373                     _SYS08:     ;(BDOS)エコーなしコンソール入力
001373 5373 CDAC53          17      CALL    _SYS07
001376 5376 FE03             7      CP  3
001378 5378 CC8153          17      CALL    Z,_BREAK
00137B 537B FE13             7      CP  013H        ;CTRL+S
00137D 537D C0              11      RET NZ
       537E                     PAUSE:
00137E 537E CD9853          17      CALL    KEYBC
                                
       5381                     _BREAK:
       5381                     BREAK:
001381 5381 F5              11      PUSH    AF
001382 5382 C5              11      PUSH    BC
001383 5383 D5              11      PUSH    DE
001384 5384 E5              11      PUSH    HL
001385 5385 DDE5            15      PUSH    IX
001387 5387 DD21B700        14      LD  IX,BREAKX
00138B 538B CDFA42          17      CALL    CALSLT_R
00138E 538E DDE1            14      POP IX
001390 5390 E1              10      POP HL
001391 5391 D1              10      POP DE
001392 5392 C1              10      POP BC
001393 5393 DC8153          17      CALL    C,_BREAK
001396 5396 F1              10      POP AF
001397 5397 C9              10      RET
       5398                     KEYBC:
001398 5398 F5              11      PUSH    AF
001399 5399 C5              11      PUSH    BC
00139A 539A D5              11      PUSH    DE
00139B 539B E5              11      PUSH    HL
00139C 539C DDE5            15      PUSH    IX
00139E 539E DD215601        14      LD  IX,KILBUF
0013A2 53A2 CDFA42          17      CALL    CALSLT_R
0013A5 53A5 DDE1            14      POP IX
0013A7 53A7 E1              10      POP HL
0013A8 53A8 D1              10      POP DE
0013A9 53A9 C1              10      POP BC
0013AA 53AA F1              10      POP AF
0013AB 53AB C9              10      RET
                                
       53AC                     _SYS07:
       53AC                     FLGET:
0013AC 53AC C5              11      PUSH    BC
0013AD 53AD D5              11      PUSH    DE
0013AE 53AE E5              11      PUSH    HL
0013AF 53AF DDE5            15      PUSH    IX
0013B1 53B1 DD219F00        14      LD  IX,CHGET
0013B5 53B5 CDFA42          17      CALL    CALSLT_R
0013B8 53B8 DDE1            14      POP IX
0013BA 53BA E1              10      POP HL
0013BB 53BB D1              10      POP DE
0013BC 53BC C1              10      POP BC
0013BD 53BD FE03             7      CP  3
0013BF 53BF C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       53C0                     _INKEY:
       53C0                     INKEY:
0013C0 53C0 CD5A54          17      CALL    CPM_CONST
0013C3 53C3 C8              11      RET Z
0013C4 53C4 18E6            12      JR  FLGET
                                
       53C6                     _SYS0A:     ;(BDOS)文字列入力
0013C6 53C6 C5              11      PUSH    BC
0013C7 53C7 E5              11      PUSH    HL
0013C8 53C8 D5              11      PUSH    DE
0013C9 53C9 CDF253          17      CALL    GETL
0013CC 53CC 111FF4          10      LD  DE,KBUF
0013CF 53CF E1              10      POP HL
0013D0 53D0 E5              11      PUSH    HL
0013D1 53D1 0E00             7      LD  C,0
0013D3 53D3 3004            12      JR  NC,SAX0
0013D5 53D5 23               6      INC HL
0013D6 53D6 23               6      INC HL
0013D7 53D7 1808            12      JR  SAX4
       53D9                     SAX0:
0013D9 53D9 46               7      LD  B,(HL)
0013DA 53DA 23               6      INC HL
       53DB                     SAX1:
0013DB 53DB 23               6      INC HL
0013DC 53DC 1A               7      LD  A,(DE)
0013DD 53DD 13               6      INC DE
0013DE 53DE B7               4      OR  A
0013DF 53DF 2004            12      JR  NZ,SAX2
       53E1                     SAX4:
0013E1 53E1 360D            10      LD  (HL),00DH
0013E3 53E3 1804            12      JR  SAX3
       53E5                     SAX2:
0013E5 53E5 77               7      LD  (HL),A
0013E6 53E6 0C               4      INC C
0013E7 53E7 10F2            13      DJNZ    SAX1
       53E9                     SAX3:
0013E9 53E9 D1              10      POP DE
0013EA 53EA 79               4      LD  A,C
0013EB 53EB 13               6      INC DE
0013EC 53EC 12               7      LD  (DE),A
0013ED 53ED 1B               6      DEC DE
0013EE 53EE E1              10      POP HL
0013EF 53EF C1              10      POP BC
0013F0 53F0 A7               4      AND A
0013F1 53F1 C9              10      RET
       53F2                     GETL:
0013F2 53F2 DDE5            15      PUSH    IX
0013F4 53F4 FDE5            15      PUSH    IY
                                
0013F6 53F6 2ADCF3          16      LD  HL,(CSRY)
0013F9 53F9 22CAFB          16      LD  (FSTPOS),HL
       53FC                     GETL1:
0013FC 53FC CD7353          17      CALL    _SYS08
0013FF 53FF FE09             7      CP  9
001401 5401 2008            12      JR  NZ,GETL1V
001403 5403 211FF4          10      LD  HL,KBUF
001406 5406 CD9143          17      CALL    MSX
001409 5409 18F1            12      JR  GETL1
       540B                     GETL1V:
00140B 540B 5F               4      LD  E,A
00140C 540C FE08             7      CP  8
00140E 540E CCA854          17      CALL    Z,CTRL02
001411 5411 FE20             7      CP  020H
001413 5413 D4D454          17      CALL    NC,INSERT
001416 5416 CD3C53          17      CALL    MSGA1
                                
001419 5419 7B               4      LD  A,E
00141A 541A FE0D             7      CP  00DH
00141C 541C 20DE            12      JR  NZ,GETL1
                                
00141E 541E 111FF4          10      LD  DE,KBUF
001421 5421 3AB0F3          13      LD  A,(LINLEN)
001424 5424 47               4      LD  B,A
001425 5425 CDB756          17      CALL    ZERO_MEMORY_DE
                                
001428 5428 2ACAFB          16      LD  HL,(FSTPOS)
00142B 542B 3ADCF3          13      LD  A,(CSRY)
00142E 542E 6F               4      LD  L,A
00142F 542F E5              11      PUSH    HL
001430 5430 CD0555          17      CALL    LOC0
001433 5433 4D               4      LD  C,L
001434 5434 44               4      LD  B,H
001435 5435 E1              10      POP HL
001436 5436 3AB0F3          13      LD  A,(LINLEN)
001439 5439 94               4      SUB H
00143A 543A 3D               4      DEC A
00143B 543B 5F               4      LD  E,A
00143C 543C 211FF4          10      LD  HL,KBUF
       543F                     GETL2:
00143F 543F CD9854          17      CALL    _SCRN
001442 5442 03               6      INC BC
001443 5443 77               7      LD  (HL),A
001444 5444 23               6      INC HL
001445 5445 1D               4      DEC E
001446 5446 20F7            12      JR  NZ,GETL2
001448 5448 CD5953          17      CALL    MSG_CR
                                
00144B 544B FDE1            14      POP IY
00144D 544D DDE1            14      POP IX
       544F                     GETL3:
00144F 544F 2B               6      DEC HL
001450 5450 7E               7      LD  A,(HL)
001451 5451 FE21             7      CP  021H
001453 5453 D0              11      RET NC
001454 5454 3600            10      LD  (HL),0
001456 5456 15               4      DEC D
001457 5457 20F6            12      JR  NZ,GETL3
001459 5459 C9              10      RET
                                
       545A                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       545A                     CONSTX:
       545A                     CPM_CONST:
00145A 545A C5              11      PUSH    BC
00145B 545B D5              11      PUSH    DE
00145C 545C E5              11      PUSH    HL
00145D 545D DDE5            15      PUSH    IX
00145F 545F DD219C00        14      LD  IX,CHSNS
001463 5463 CDFA42          17      CALL    CALSLT_R
001466 5466 DDE1            14      POP IX
001468 5468 E1              10      POP HL
001469 5469 D1              10      POP DE
00146A 546A C1              10      POP BC
00146B 546B C9              10      RET
                                
       546C                     _SYS2A:     ;(BDOS)日付の獲得
00146C 546C AF               4      XOR A
00146D 546D 57               4      LD  D,A
00146E 546E 5F               4      LD  E,A
00146F 546F 67               4      LD  H,A
001470 5470 6F               4      LD  L,A
001471 5471 C9              10      RET
                                
       5472                     _SYS2C:     ;(BDOS)時刻の獲得
001472 5472 AF               4      XOR A
001473 5473 57               4      LD  D,A
001474 5474 5F               4      LD  E,A
001475 5475 67               4      LD  H,A
001476 5476 6F               4      LD  L,A
001477 5477 C9              10      RET
                                
       5478                     POS:
001478 5478 F5              11      PUSH    AF
001479 5479 2ADCF3          16      LD  HL,(CSRY)
00147C 547C 7D               4      LD  A,L
00147D 547D 6C               4      LD  L,H
00147E 547E 67               4      LD  H,A
00147F 547F 2C               4      INC L
001480 5480 24               4      INC H
001481 5481 F1              10      POP AF
001482 5482 C9              10      RET
                                
       5483                     LOC:
001483 5483 F5              11      PUSH    AF
001484 5484 E5              11      PUSH    HL
001485 5485 7D               4      LD  A,L
001486 5486 6C               4      LD  L,H
001487 5487 67               4      LD  H,A
001488 5488 2D               4      DEC L
001489 5489 25               4      DEC H
00148A 548A DDE5            15      PUSH    IX
00148C 548C DD21C600        14      LD  IX,POSIT
001490 5490 CDFA42          17      CALL    CALSLT_R
001493 5493 DDE1            14      POP IX
001495 5495 E1              10      POP HL
001496 5496 F1              10      POP AF
001497 5497 C9              10      RET
                                
       5498                     _SCRN:
       5498                     SCRN:
001498 5498 E5              11      PUSH    HL
001499 5499 DDE5            15      PUSH    IX
                                
00149B 549B 69               4      LD  L,C
00149C 549C 60               4      LD  H,B
00149D 549D DD214A00        14      LD  IX,RDVRM
0014A1 54A1 CDFA42          17      CALL    CALSLT_R
                                
0014A4 54A4 DDE1            14      POP IX
0014A6 54A6 E1              10      POP HL
0014A7 54A7 C9              10      RET
                                
       54A8                     CTRL02:
0014A8 54A8 F5              11      PUSH    AF
0014A9 54A9 D5              11      PUSH    DE
0014AA 54AA 2ADCF3          16      LD  HL,(CSRY)
0014AD 54AD 3AB0F3          13      LD  A,(LINLEN)
0014B0 54B0 4F               4      LD  C,A
0014B1 54B1 94               4      SUB H   ;CSRX
0014B2 54B2 C602             7      ADD A,2
0014B4 54B4 47               4      LD  B,A ;カーソルより右の文字数
0014B5 54B5 61               4      LD  H,C ;LINLEN
0014B6 54B6 C5              11      PUSH    BC
0014B7 54B7 CD0555          17      CALL    LOC0
0014BA 54BA C1              10      POP BC
                                
0014BB 54BB 1620             7      LD  D,020H
       54BD                     C8X1:
0014BD 54BD DD214A00        14      LD  IX,RDVRM
0014C1 54C1 CDFA42          17      CALL    CALSLT_R
0014C4 54C4 4F               4      LD  C,A
0014C5 54C5 7A               4      LD  A,D
0014C6 54C6 DD214D00        14      LD  IX,WRTVRM
0014CA 54CA CDFA42          17      CALL    CALSLT_R
0014CD 54CD 2B               6      DEC HL
0014CE 54CE 51               4      LD  D,C
0014CF 54CF 10EC            13      DJNZ    C8X1
0014D1 54D1 D1              10      POP DE
0014D2 54D2 F1              10      POP AF
0014D3 54D3 C9              10      RET
                                
       54D4                     INSERT:
0014D4 54D4 F5              11      PUSH    AF
0014D5 54D5 D5              11      PUSH    DE
0014D6 54D6 2ADCF3          16      LD  HL,(CSRY)
0014D9 54D9 3AB0F3          13      LD  A,(LINLEN)
0014DC 54DC 4F               4      LD  C,A
0014DD 54DD 94               4      SUB H   ;CSRX
0014DE 54DE 3C               4      INC A
0014DF 54DF 47               4      LD  B,A ;カーソルより右の文字数
0014E0 54E0 C5              11      PUSH    BC
0014E1 54E1 CD0555          17      CALL    LOC0
0014E4 54E4 C1              10      POP BC
                                
0014E5 54E5 1620             7      LD  D,020H
       54E7                     INS1:
0014E7 54E7 DD214A00        14      LD  IX,RDVRM
0014EB 54EB CDFA42          17      CALL    CALSLT_R
0014EE 54EE 4F               4      LD  C,A
0014EF 54EF 7A               4      LD  A,D
0014F0 54F0 DD214D00        14      LD  IX,WRTVRM
0014F4 54F4 CDFA42          17      CALL    CALSLT_R
0014F7 54F7 23               6      INC HL
0014F8 54F8 51               4      LD  D,C
0014F9 54F9 10EC            13      DJNZ    INS1
0014FB 54FB D1              10      POP DE
0014FC 54FC F1              10      POP AF
0014FD 54FD C9              10      RET
                                
       54FE                     CONOUT1:
0014FE 54FE 59               4      LD  E,C
0014FF 54FF C33253          10      JP  _PRINT
                                
       5502                     GETVRAM:
001502 5502 2ADCF3          16      LD  HL,(CSRY)
       5505                     LOC0:
001505 5505 2D               4      DEC L
001506 5506 25               4      DEC H
001507 5507 4C               4      LD  C,H ;CSRX-1
001508 5508 5D               4      LD  E,L ;CSRY-1
       5509                     LOC1:
001509 5509 3AB0F3          13      LD  A,(LINLEN)
00150C 550C 67               4      LD  H,A
00150D 550D 1600             7      LD  D,0
00150F 550F 6A               4      LD  L,D ;0
001510 5510 0608             7      LD  B,8
       5512                     LOC2:
001512 5512 29              11      ADD HL,HL
001513 5513 3001            12      JR  NC,LOC3
001515 5515 19              11      ADD HL,DE
       5516                     LOC3:
001516 5516 10FA            13      DJNZ    LOC2
001518 5518 09              11      ADD HL,BC
001519 5519 C9              10      RET
                                
       551A                     _SYS0C:     ;(BDOS)バージョン番号の獲得
00151A 551A 212200          10      LD  HL,00022H
00151D 551D AF               4      XOR A
00151E 551E 7D               4      LD  A,L
00151F 551F C9              10      RET
                                
       5520                     _SYS0D:     ;(BDOS)ディスク・リセット
001520 5520 218000          10      LD  HL,00080H
001523 5523 22D4F2          16      LD  (_DTA),HL
001526 5526 C9              10      RET
                                
       5527                     _SYS0E:     ;(BDOS)カレントドライブの設定
001527 5527 7B               4      LD  A,E
       5528                     _SYS0EX1:
001528 5528 FE08             7      CP  8
00152A 552A 3F               4      CCF
00152B 552B D8              11      RET C
00152C 552C 32EAF2          13      LD  (_DVSW),A
00152F 552F C9              10      RET
                                
       5530                     _SYS0F:     ;(BDOS)ファイルのオープン
001530 5530 D5              11      PUSH    DE
001531 5531 FDE1            14      POP IY
001533 5533 CD9E56          17      CALL    INIT_FILE
001536 5536 CDDD4B          17      CALL    ROM_OPEN
001539 5539 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
00153B 553B FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
00153F 553F FDE5            15      PUSH    IY
001541 5541 D1              10      POP DE
001542 5542 13               6      INC DE
001543 5543 010B00          10      LD  BC,11
001546 5546 EDB0                    LDIR
                                ;               Attribute
001548 5548 7E               7      LD  A,(HL)
001549 5549 FD770D          19      LD  (IY+13),A
                                ;               TIME
00154C 554C 110B00          10      LD  DE,11
00154F 554F 19              11      ADD HL,DE
001550 5550 7E               7      LD  A,(HL)
001551 5551 23               6      INC HL
001552 5552 FD7716          19      LD  (IY+22),A
001555 5555 7E               7      LD  A,(HL)
001556 5556 23               6      INC HL
001557 5557 FD7717          19      LD  (IY+23),A
                                ;               DATE
00155A 555A 7E               7      LD  A,(HL)
00155B 555B 23               6      INC HL
00155C 555C FD7714          19      LD  (IY+20),A
00155F 555F 7E               7      LD  A,(HL)
001560 5560 23               6      INC HL
001561 5561 FD7715          19      LD  (IY+21),A
                                ;               First cluster
001564 5564 7E               7      LD  A,(HL)
001565 5565 23               6      INC HL
001566 5566 FD771A          19      LD  (IY+26),A
001569 5569 7E               7      LD  A,(HL)
00156A 556A 23               6      INC HL
00156B 556B FD771B          19      LD  (IY+27),A
                                ;               SIZE
00156E 556E 7E               7      LD  A,(HL)
00156F 556F 23               6      INC HL
001570 5570 FD7710          19      LD  (IY+16),A
001573 5573 7E               7      LD  A,(HL)
001574 5574 23               6      INC HL
001575 5575 FD7711          19      LD  (IY+17),A
001578 5578 7E               7      LD  A,(HL)
001579 5579 23               6      INC HL
00157A 557A FD7712          19      LD  (IY+18),A
00157D 557D 7E               7      LD  A,(HL)
00157E 557E FD7713          19      LD  (IY+19),A
001581 5581 AF               4      XOR A
001582 5582 FD770C          19      LD  (IY+12),A
001585 5585 C9              10      RET
                                
       5586                     _SYS10:     ;(BDOS)ファイルのクローズ
001586 5586 AF               4      XOR A
001587 5587 C9              10      RET
                                
       5588                     S11X1:
001588 5588 FD7119          19      LD  (IY+25),C       ;RootEntCnt
00158B 558B FD750E          19      LD  (IY+14),L
00158E 558E FD740F          19      LD  (IY+15),H
       5591                     SCF_FF_RET:
001591 5591 37               4      SCF
001592 5592 9F               4      SBC A,A
001593 5593 C9              10      RET
                                
       5594                     _SYS11:     ;(BDOS)最初のファイルの検索
001594 5594 ED53D7F2        20      LD  (_FCB),DE
001598 5598 D5              11      PUSH    DE
001599 5599 FDE1            14      POP IY
00159B 559B CD9E56          17      CALL    INIT_FILE
00159E 559E CD3B4E          17      CALL    GET_DIR_DAT
       55A1                     S12X1:
0015A1 55A1 CDF94B          17      CALL    FILESE
0015A4 55A4 30E2            12      JR  NC,S11X1
0015A6 55A6 0D               4      DEC C
0015A7 55A7 FD7119          19      LD  (IY+25),C       ;RootEntCnt
0015AA 55AA FDCB0D66        20      BIT 4,(IY+13)
0015AE 55AE 2809            12      JR  Z,S12X2
0015B0 55B0 E5              11      PUSH    HL
0015B1 55B1 DDE1            14      POP IX
0015B3 55B3 DDCB0E66        20      BIT 4,(IX+1+13)
0015B7 55B7 28E8            12      JR  Z,S12X1
       55B9                     S12X2:
0015B9 55B9 012000          10      LD  BC,32
0015BC 55BC ED5BD4F2        20      LD  DE,(_DTA)
0015C0 55C0 AF               4      XOR A
0015C1 55C1 12               7      LD  (DE),A      ;ドライブ番号
0015C2 55C2 13               6      INC DE
0015C3 55C3 EDB0                    LDIR            ;ディレクトリエントリ
0015C5 55C5 FD750E          19      LD  (IY+14),L
0015C8 55C8 FD740F          19      LD  (IY+15),H
0015CB 55CB C9              10      RET
                                
       55CC                     _SYS12:
0015CC 55CC FD2AD7F2        20      LD  IY,(_FCB)
0015D0 55D0 FDE5            15      PUSH    IY
0015D2 55D2 D1              10      POP DE
0015D3 55D3 CD9E56          17      CALL    INIT_FILE
                                
0015D6 55D6 FD6E0E          19      LD  L,(IY+14)
0015D9 55D9 FD660F          19      LD  H,(IY+15)
0015DC 55DC FD4E19          19      LD  C,(IY+25)
0015DF 55DF 18C0            12      JR  S12X1
                                
       55E1                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0015E1 55E1 CD214E          17      CALL    SET_FCB
0015E4 55E4 CDEF4D          17      CALL    GETSEQ
0015E7 55E7 CDDC4D          17      CALL    RB_READ
0015EA 55EA E5              11      PUSH    HL
0015EB 55EB CDFC4D          17      CALL    SETSEQ
0015EE 55EE E1              10      POP HL
       55EF                     SREAD:
0015EF 55EF C601             7      ADD A,001H
0015F1 55F1 D8              11      RET C
                                
0015F2 55F2 7D               4      LD  A,L
0015F3 55F3 D601             7      SUB 001H
0015F5 55F5 9F               4      SBC A,A
0015F6 55F6 E603             7      AND 3
0015F8 55F8 1F               4      RRA
0015F9 55F9 C9              10      RET
                                
       55FA                     _SYS18:     ;(BDOS)ログインベクトルの獲得
0015FA 55FA 210100          10      LD  HL,00001H
0015FD 55FD AF               4      XOR A
0015FE 55FE C9              10      RET
                                
       55FF                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
0015FF 55FF 3AEAF2          13      LD  A,(_DVSW)
001602 5602 C9              10      RET
                                
       5603                     _SYS1A:     ;(BDOS)DTAの設定
001603 5603 ED53D4F2        20      LD  (_DTA),DE
001607 5607 AF               4      XOR A
001608 5608 C9              10      RET
                                
       5609                     _SYS1B:     ;(BDOS)ディスク情報の獲得
001609 5609 010002          10      LD  BC,512
00160C 560C 11C302          10      LD  DE,707
00160F 560F 210000          10      LD  HL,0
001612 5612 DD21D9F2        14      LD  IX,_BUF
001616 5616 FD21D9F2        14      LD  IY,_BUF
00161A 561A FD3600F9        19      LD  (IY+0),0F9H
00161E 561E 3E02             7      LD  A,2
001620 5620 C9              10      RET
                                
       5621                     _SYS21:     ;(BDOS)ランダムな読み出し
001621 5621 CD214E          17      CALL    SET_FCB
                                
001624 5624 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001627 5627 FD6622          19      LD  H,(IY+34)
                                
00162A 562A CDDC4D          17      CALL    RB_READ
00162D 562D 18C0            12      JR  SREAD
                                
       562F                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
00162F 562F CD3055          17      CALL    _SYS0F
001632 5632 D8              11      RET C
                                
001633 5633 D5              11      PUSH    DE      ;EX DE,IY
001634 5634 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001636 5636 CD114E          17      CALL    GETSIZE
       5639                     _S24X1:
001639 5639 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
00163C 563C FD7422          19      LD  (IY+34),H
00163F 563F FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
001643 5643 FDE3            23      EX  (SP),IY     ;
001645 5645 D1              10      POP DE      ;
                                
001646 5646 AF               4      XOR A
001647 5647 C9              10      RET
                                
       5648                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
001648 5648 E5              11      PUSH    HL
001649 5649 D5              11      PUSH    DE      ;EX DE,IY
00164A 564A FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00164C 564C CDEF4D          17      CALL    GETSEQ
00164F 564F 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       5651                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001651 5651 CD214E          17      CALL    SET_FCB
001654 5654 E5              11      PUSH    HL
001655 5655 FD6E21          19      LD  L,(IY+33)
001658 5658 FD6622          19      LD  H,(IY+34)
00165B 565B 22CAF2          16      LD  (RR_LOW),HL
00165E 565E FD6E23          19      LD  L,(IY+35)
001661 5661 FD6624          19      LD  H,(IY+36)
001664 5664 22CCF2          16      LD  (RR_HIGH),HL
001667 5667 E1              10      POP HL
001668 5668 CDBD49          17      CALL    ROM_READ
00166B 566B ED5BCAF2        20      LD  DE,(RR_LOW)
00166F 566F FD7321          19      LD  (IY+33),E
001672 5672 FD7222          19      LD  (IY+34),D
001675 5675 ED5BCCF2        20      LD  DE,(RR_HIGH)
001679 5679 FD7323          19      LD  (IY+35),E
00167C 567C FD7224          19      LD  (IY+36),D
00167F 567F 9F               4      SBC A,A
001680 5680 C9              10      RET
                                
       5681                     _SYS2F:
001681 5681 44               4      LD  B,H
001682 5682 2AD4F2          16      LD  HL,(_DTA)
001685 5685 C3F750          10      JP  DISKIO
                                
       5688                     _SYS5A:
001688 5688 0600             7      LD  B,0
00168A 568A D5              11      PUSH    DE
00168B 568B DDE1            14      POP IX
       568D                     _SX5A1:
00168D 568D 1A               7      LD  A,(DE)
00168E 568E B7               4      OR  A
00168F 568F 2804            12      JR  Z,_SX5A2
001691 5691 13               6      INC DE
001692 5692 04               4      INC B
001693 5693 18F8            12      JR  _SX5A1
                                
       5695                     _SX5A2:
001695 5695 78               4      LD  A,B
001696 5696 CD884A          17      CALL    FILE_BDOS
001699 5699 CDDE4E          17      CALL    ROM_CD
00169C 569C 9F               4      SBC A,A
00169D 569D C9              10      RET
                                
       569E                     INIT_FILE:
00169E 569E EB               4      EX  DE,HL
00169F 569F 11F8F2          10      LD  DE,FDRV
0016A2 56A2 010C00          10      LD  BC,1+8+3
       56A5                     INIT_FILE1:
0016A5 56A5 EDB0                    LDIR
0016A7 56A7 CDBF52          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0016AA 56AA 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0016AD 56AD 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0016B0 56B0 2AEBF2          16      LD  HL,(_CD)
0016B3 56B3 22F6F2          16      LD  (_CDX),HL           ;カレントディレクトリ
0016B6 56B6 C9              10      RET
                                
       56B7                     ZERO_MEMORY_DE:
0016B7 56B7 AF               4      XOR A
       56B8                     FILL_MEMORY_DE:
0016B8 56B8 12               7      LD  (DE),A
0016B9 56B9 13               6      INC DE
0016BA 56BA 10FC            13      DJNZ    FILL_MEMORY_DE
0016BC 56BC C9              10      RET
                                
0016BD 56BD                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 1F53355366531F53        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 1F531F536B53AC53        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 73531F53C6535A54        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 1A55205527553055        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 86559455CC551F53        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 E1551F531F531F53        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 FA55FF5503560956        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 1F531F531F532F56        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 48561F531F535156        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 1F531F536C541F53        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 72541F531F538156        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 1F531F5388561F53        DW  _ERROR,_ERROR,_SYS5A,_ERROR
001FB8 5FB8 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 1F531F531F531F53        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
