                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       42B2                     CRUNCH  EQU 042B2H
       4C64                     FRMEVL  EQU 04C64H
                                
       F331                     H_BDOS  EQU 0F331H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
                                ;PTRFIL EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
                                ;FILNAM EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
                                ;RSTMP  EQU 0FB03H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FEDA                     H_STKE  EQU 0FEDAH
                                
       FF43                     H_GONE  EQU 0FF43H
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                
       F0E8                     ISC EQU 0F0E8H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       6200                     _FATBF  EQU BANK1_ADR+512       ;FATの先頭
                                
       F7F8                     DACDAT  EQU DAC+2
[EOF:DEF.ASM:UTF_8]
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C3B84A          10      JP  DISKIO
000013 4013 C3E74A          10      JP  DSKCHG
000016 4016 C33D4B          10      JP  GETDPB
000019 4019 C3254C          10      JP  CHOICE
00001C 401C C3294C          10      JP  DSKFMT
00001F 401F C32B4C          10      JP  DSKSTP
000022 4022 C32C4C          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C3294C          10      JP  DSKFMT
000029 4029 C32B4C          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3334C          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.1.2.0",0
            204449534B20524F    
            4D204C6974652076    
            302E312E322E3000    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 0180FF          10      LD  BC,-00080H
000109 4109 2A72F6          16      LD  HL,(MEMSIZ)
00010C 410C 09              11      ADD HL,BC
00010D 410D 2272F6          16      LD  (MEMSIZ),HL
000110 4110 2A74F6          16      LD  HL,(STKTOP)
000113 4113 09              11      ADD HL,BC
000114 4114 2274F6          16      LD  (STKTOP),HL
000117 4117 2180F0          10      LD  HL,0F080H
00011A 411A 1100F0          10      LD  DE,0F000H
00011D 411D 012000          10      LD  BC,00020H
000120 4120 EDB0                    LDIR
000122 4122 2180FF          10      LD  HL,-00080H
000125 4125 39              11      ADD HL,SP
000126 4126 2252F1          16      LD  (BASSTK),HL
000129 4129 ED7B52F1        20      LD  SP,(BASSTK)
                                
00012D 412D 3EFF             7      LD  A,0FFH
00012F 412F 3299FD          13      LD  (DEVICE),A
                                
000132 4132 3E01             7      LD  A,1
000134 4134 3221FB          13      LD  (DRVTBL),A
                                
000137 4137 AF               4      XOR A
000138 4138 323DF1          13      LD  (_DVSW),A
                                
00013B 413B 21ED42          10      LD  HL,AT_ISC
00013E 413E 11E8F0          10      LD  DE,ISC
000141 4141 016C00          10      LD  BC,ISC_E-ISC
000144 4144 EDB0                    LDIR
                                    
000146 4146 3EC3             7      LD  A,0C3H      ;JP
000148 4148 3243FF          13      LD  (H_GONE),A
00014B 414B 327DF3          13      LD  (BDOS),A
00014E 414E 326BF3          13      LD  (RAMUSE),A
000151 4151 3268F3          13      LD  (ROMUSE),A
000154 4154 21E8F0          10      LD  HL,REPLACE_COMMAND
000157 4157 2244FF          16      LD  (H_GONE+1),HL
00015A 415A 2131F3          10      LD  HL,H_BDOS
00015D 415D 227EF3          16      LD  (BDOS+1),HL
000160 4160 210FF1          10      LD  HL,RAMUSE1
000163 4163 226CF3          16      LD  (RAMUSE+1),HL
000166 4166 210AF1          10      LD  HL,ROMUSE1
000169 4169 2269F3          16      LD  (ROMUSE+1),HL
                                
00016C 416C 3E                      DB  03EH
00016D 416D F7              12      RST 30H
00016E 416E 3271FE          13      LD  (H_BINS),A
000171 4171 3276FE          13      LD  (H_BINL),A
000174 4174 327BFE          13      LD  (H_FILE),A
000177 4177 3231F3          13      LD  (H_BDOS),A
00017A 417A 32DAFE          13      LD  (H_STKE),A
00017D 417D 32A7FF          13      LD  (H_PHYD),A
                                
000180 4180 CD3542          17      CALL    GTSL1_
000183 4183 32FBF0          13      LD  (ROM_SLT),A
000186 4186 3272FE          13      LD  (H_BINS+1),A
000189 4189 3277FE          13      LD  (H_BINL+1),A
00018C 418C 327CFE          13      LD  (H_FILE+1),A
00018F 418F 3232F3          13      LD  (H_BDOS+1),A
000192 4192 32DBFE          13      LD  (H_STKE+1),A
000195 4195 32A8FF          13      LD  (H_PHYD+1),A
000198 4198 3222FB          13      LD  (DRVTBL+1),A
00019B 419B 3248F3          13      LD  (MASTERS),A
                                
00019E 419E 210845          10      LD  HL,ROM_LOAD
0001A1 41A1 2273FE          16      LD  (H_BINS+2),HL
0001A4 41A4 212346          10      LD  HL,ROM_RUN
0001A7 41A7 2278FE          16      LD  (H_BINL+2),HL
0001AA 41AA 213046          10      LD  HL,ROM_FILES
0001AD 41AD 227DFE          16      LD  (H_FILE+2),HL
0001B0 41B0 21604C          10      LD  HL,ROM_BDOS
0001B3 41B3 2233F3          16      LD  (H_BDOS+2),HL
0001B6 41B6 218343          10      LD  HL,ROM_STKE
0001B9 41B9 22DCFE          16      LD  (H_STKE+2),HL
0001BC 41BC 21B84A          10      LD  HL,DISKIO
0001BF 41BF 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001C2 41C2 3E                      DB  03EH
0001C3 41C3 C9              10      RET
0001C4 41C4 327FFE          13      LD  (H_FILE+4),A
0001C7 41C7 3275FE          13      LD  (H_BINS+4),A
0001CA 41CA 327AFE          13      LD  (H_BINL+4),A
0001CD 41CD 3235F3          13      LD  (H_BDOS+4),A
0001D0 41D0 32DEFE          13      LD  (H_STKE+4),A
0001D3 41D3 32ABFF          13      LD  (H_PHYD+4),A
                                
0001D6 41D6 AF               4      XOR A
0001D7 41D7 320068          13      LD  (BANK1_SEL),A
0001DA 41DA 3A0060          13      LD  A,(BANK1_ADR)
0001DD 41DD FE41             7      CP  'A'
0001DF 41DF 2043            12      JR  NZ,NOT_8K_BANK
0001E1 41E1 3E01             7      LD  A,DISK_BANK
0001E3 41E3 320068          13      LD  (BANK1_SEL),A
                                
0001E6 41E6 CD3801          17      CALL    RSLREG      ;read primary slot #
0001E9 41E9 07               4      RLCA
0001EA 41EA 07               4      RLCA
0001EB 41EB F5              11      PUSH    AF
0001EC 41EC CD3A42          17      CALL    GTSL2_
0001EF 41EF 3244F3          13      LD  (RAMAD3),A
0001F2 41F2 F1              10      POP AF  
0001F3 41F3 CD3A42          17      CALL    GTSL2_
0001F6 41F6 3243F3          13      LD  (RAMAD2),A
       41F9                     RAMCHK2:
0001F9 41F9 3A44F3          13      LD  A,(RAMAD3)
0001FC 41FC 2640             7      LD  H,040H
0001FE 41FE CD5142          17      CALL    CHK_RAM
000201 4201 3242F3          13      LD  (RAMAD1),A
       4204                     RAMCHK1:
000204 4204 3A44F3          13      LD  A,(RAMAD3)
000207 4207 2600             7      LD  H,00H
000209 4209 CD5142          17      CALL    CHK_RAM
00020C 420C 3241F3          13      LD  (RAMAD0),A
       420F                     RAMCHK0:
00020F 420F 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
000212 4212 010F00          10      LD  BC,0000FH       ;切り上げ
000215 4215 09              11      ADD HL,BC
000216 4216 7D               4      LD  A,L
                                
000217 4217 0604             7      LD  B,4
       4219                     B_DRIVE1:
000219 4219 CB3C             8      SRL H
00021B 421B 1F               4      RRA
00021C 421C 10FB            13      DJNZ    B_DRIVE1
                                
00021E 421E C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000220 4220 323CF1          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
000223 4223 C9              10      RET
                                
       4224                     NOT_8K_BANK:
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K等)
000224 4224 21D143          10      LD  HL,MSG_ERROR_ROM_MODE
000227 4227 CD5C43          17      CALL    MSX
00022A 422A FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
00022E 422E DD219F00        14      LD  IX,CHGET
000232 4232 C31C00          10      JP  _CALSLT
                                
       4235                     GTSL1_:             ;自分のいるスロットを知る
000235 4235 CD3801          17      CALL    RSLREG      ;read primary slot #
000238 4238 0F               4      RRCA
000239 4239 0F               4      RRCA
       423A                     GTSL2_:
00023A 423A E603             7      AND 3       ;[A]=000000PP
00023C 423C 5F               4      LD  E,A     ;[E]=000000PP
00023D 423D 21C1FC          10      LD  HL,EXPTBL
000240 4240 85               4      ADD A,L     ;桁上りは無い
000241 4241 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000242 4242 7B               4      LD  A,E     ;[A]=000000PP
000243 4243 CB7E            13      BIT 7,(HL)
000245 4245 C8              11      RET Z
000246 4246 7D               4      LD  A,L     ;point to SLTTBL entry
000247 4247 C604             7      ADD A,4     ;桁上りは無い
000249 4249 6F               4      LD  L,A
00024A 424A 7E               7      LD  A,(HL)      ;get currently expansion slot register
00024B 424B E60C             7      AND 00CH        ;[A] = 0000SS00
00024D 424D B3               4      OR  E       ;[A] = 0000SSPP
00024E 424E F680             7      OR  080H        ;[A] = 1000SSPP
000250 4250 C9              10      RET
       4251                     GTSL1_E:
                                
       4251                     CHK_RAM:
000251 4251 E5              11      PUSH    HL
000252 4252 CDA642          17      CALL    CHK_RAM0
000255 4255 E1              10      POP HL
000256 4256 C8              11      RET Z
000257 4257 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
00025A 425A E680             7      AND 080H
00025C 425C CD7D42          17      CALL    CHK_RAM_SLT
00025F 425F C8              11      RET Z
000260 4260 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000263 4263 E680             7      AND 080H
000265 4265 C601             7      ADD A,1
000267 4267 CD7D42          17      CALL    CHK_RAM_SLT
00026A 426A C8              11      RET Z
00026B 426B 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00026E 426E E680             7      AND 080H
000270 4270 C602             7      ADD A,2
000272 4272 CD7D42          17      CALL    CHK_RAM_SLT
000275 4275 C8              11      RET Z
000276 4276 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000279 4279 E680             7      AND 080H
00027B 427B C603             7      ADD A,3
       427D                     CHK_RAM_SLT:
00027D 427D E5              11      PUSH    HL
00027E 427E CDA642          17      CALL    CHK_RAM0        ;スロット#X or X-0
000281 4281 E1              10      POP HL
000282 4282 C8              11      RET Z
000283 4283 CB79             8      BIT 7,C
000285 4285 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000287 4287 79               4      LD  A,C
000288 4288 C604             7      ADD A,4         ;スロット#X-1
00028A 428A E5              11      PUSH    HL
00028B 428B CDA642          17      CALL    CHK_RAM0
00028E 428E E1              10      POP HL
00028F 428F C8              11      RET Z
000290 4290 79               4      LD  A,C
000291 4291 C604             7      ADD A,4         ;スロット#X-2
000293 4293 E5              11      PUSH    HL
000294 4294 CDA642          17      CALL    CHK_RAM0
000297 4297 E1              10      POP HL
000298 4298 C8              11      RET Z
000299 4299 79               4      LD  A,C
00029A 429A C604             7      ADD A,4         ;スロット#X-3
00029C 429C E5              11      PUSH    HL
00029D 429D CDA642          17      CALL    CHK_RAM0
0002A0 42A0 E1              10      POP HL
       42A1                     CHK_RAM_E:
0002A1 42A1 AF               4      XOR A
0002A2 42A2 3C               4      INC A           ;ZF=0にする
0002A3 42A3 3E00             7      LD  A,0
0002A5 42A5 C9              10      RET
                                
       42A6                     CHK_RAM0:
0002A6 42A6 4F               4      LD  C,A
0002A7 42A7 3AFBF0          13      LD  A,(ROM_SLT)
0002AA 42AA B9               4      CP  C
0002AB 42AB 28F4            12      JR  Z,CHK_RAM_E
0002AD 42AD 2E00             7      LD  L,0
       42AF                     CHK_RAM1:
0002AF 42AF 79               4      LD  A,C
0002B0 42B0 DD210C00        14      LD  IX,_RDSLT
0002B4 42B4 CDE142          17      CALL    CALSLT_R
0002B7 42B7 C6E5             7      ADD A,0E5H
0002B9 42B9 47               4      LD  B,A
0002BA 42BA 5F               4      LD  E,A
0002BB 42BB 79               4      LD  A,C
0002BC 42BC DD211400        14      LD  IX,_WRSLT
0002C0 42C0 CDE142          17      CALL    CALSLT_R
0002C3 42C3 79               4      LD  A,C
0002C4 42C4 DD210C00        14      LD  IX,_RDSLT
0002C8 42C8 CDE142          17      CALL    CALSLT_R
0002CB 42CB B8               4      CP  B
0002CC 42CC C0              11      RET NZ
0002CD 42CD D6E5             7      SUB 0E5H
0002CF 42CF 79               4      LD  A,C
0002D0 42D0 5F               4      LD  E,A
0002D1 42D1 DD211400        14      LD  IX,_WRSLT
0002D5 42D5 CDE142          17      CALL    CALSLT_R
0002D8 42D8 24               4      INC H
0002D9 42D9 7D               4      LD  A,L
0002DA 42DA C604             7      ADD A,4
0002DC 42DC 6F               4      LD  L,A
0002DD 42DD 20D0            12      JR  NZ,CHK_RAM1
0002DF 42DF 79               4      LD  A,C     ;ZF=1のハズ
0002E0 42E0 C9              10      RET
                                
       42E1                     CALSLT_R:
0002E1 42E1 C5              11      PUSH    BC
0002E2 42E2 E5              11      PUSH    HL
0002E3 42E3 FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
0002E7 42E7 CD1C00          17      CALL    _CALSLT
0002EA 42EA E1              10      POP HL
0002EB 42EB C1              10      POP BC
0002EC 42EC C9              10      RET
                                
       42ED                     AT_ISC:
0002ED F0E8                         ORG ISC,AT_ISC-RUN
       F0E8                     REPLACE_COMMAND:
0002ED F0E8 FEB7             7      CP  0B7H            ;FILES
0002EF F0EA CC7BFE          17      CALL    Z,H_FILE
0002F2 F0ED FEB5             7      CP  0B5H            ;LOAD
0002F4 F0EF CA71FE          10      JP  Z,H_BINS
0002F7 F0F2 FE8A             7      CP  08AH            ;RUN
0002F9 F0F4 CA76FE          10      JP  Z,H_BINL
0002FC F0F7 FECF             7      CP  0CFH            ;BLOAD
0002FE F0F9 C0              11      RET NZ
       F0FA                     FIX_BLOAD:
0002FF F0FA F7              12      RST 30H
       F0FB                     ROM_SLT:
000300 F0FB 00                      DB  0
000301 F0FC 6545                    DW  ROM_BLOAD
000303 F0FE F5              11      PUSH    AF
000304 F0FF E5              11      PUSH    HL
000305 F100 CD09F1          17      CALL    BLOAD_RET
       F101                     SWC_BLOAD   EQU $-2
000308 F103 E1              10      POP HL
000309 F104 F1              10      POP AF
00030A F105 FECF             7      CP  0CFH            ;BLOAD
       F107                     SWC_BLOAD_M:
00030C F107 28DF            12      JR  Z,REPLACE_COMMAND
       F109                     BLOAD_RET:
00030E F109 C9              10      RET
       F10A                     ROMUSE1:
00030F F10A 3AFBF0          13      LD  A,(ROM_SLT)
000312 F10D 1803            12      JR  ROMUSE2
       F10F                     RAMUSE1:
000314 F10F 3A42F3          13      LD  A,(RAMAD1)
       F112                     ROMUSE2:
000317 F112 DD212400        14      LD  IX,_ENASLT
00031B F116 FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
00031F F11A C31C00          10      JP  _CALSLT
                                
       F11D                     _RESULT:
000322 F11D 00                      DB  0
       F11E                     _BANK:
000323 F11E 00                      DB  0
       F11F                     RR_LOW:
000324 F11F 0000                    DW  0
       F120                     RR_MID  EQU $-1
       F121                     RR_HIGH:
000326 F121 0000                    DW  0
       F123                     _CLPS:
000328 F123 0000                    DW  0
       F125                     _LEFT:
00032A F125 0000                    DW  0
       F127                     _DTPS:
00032C F127 0000                    DW  0
       F129                     _DTA:
00032E F129 0000                    DW  0
       F12B                     FLG_LDIR:
000330 F12B 00                      DB  0
                                ;   BDOS
000331 F12C F7              12      RST 30H
000332 F12D 00                      DB  0
000333 F12E 604C                    DW  ROM_BDOS
000335 F130 C9              10      RET 
       F131                     _FCB:
000336 F131 0000                    DW  0
       F133                     _BUF:
000338 F133 00                      DB  0
       F134                     _BUF_ST:
000339 F134 0000                    DW  0
       F136                     _BUF_EN:
00033B F136 0000                    DW  0
       F138                     _BUF_EX:
00033D F138 0000                    DW  0
                                
       F13A                     DTAX:
00033F F13A 0000                    DW  0
       F13C                     B_DRIVE:
000341 F13C 00                      DB  0
       F13D                     _DVSW:
000342 F13D 00                      DB  0
       F13E                     FCBX:
000343 F13E 0000                    DW  0
       F140                     LEFTX:
000345 F140 0000                    DW  0
       F142                     PARAM0:
000347 F142 0000                    DW  0
       F144                     PARAM1:
000349 F144 0000                    DW  0
       F146                     FDRV:
00034B F146 00                      DB  0
       F147                     FNAME:
00034C F147                         DS  8+3
                                
000357 F152 0000                BASSTK  DW  0
                                
       F154                     ISC_E:
000359 4359                         ORG $$+RUN          ;$DEPHASE
                                
       4359                     MSX1:
000359 4359 CD794C          17      CALL    MSGA1
       435C                     MSX:
00035C 435C 7E               7      LD  A,(HL)
00035D 435D 23               6      INC HL
00035E 435E B7               4      OR  A
00035F 435F 20F8            12      JR  NZ,MSX1
000361 4361 C9              10      RET
                                
       4362                     PRTHX:
000362 4362 F5              11      PUSH    AF
000363 4363 07               4      RLCA
000364 4364 07               4      RLCA
000365 4365 07               4      RLCA
000366 4366 07               4      RLCA
000367 4367 CD6B43          17      CALL    PRTA2
00036A 436A F1              10      POP AF
       436B                     PRTA2:
00036B 436B CD7143          17      CALL    ASC
00036E 436E C3754C          10      JP  MSG_A
                                    
       4371                     ASC:
000371 4371 E60F             7      AND $0F
000373 4373 F630             7      OR  $30
000375 4375 FE3A             7      CP  $3A
000377 4377 D8              11      RET C
000378 4378 C607             7      ADD A,7
00037A 437A C9              10      RET
                                
       437B                     MSN:
00037B 437B 7E               7      LD  A,(HL)
00037C 437C 23               6      INC HL
00037D 437D CD754C          17      CALL    MSG_A
000380 4380 10F9            13      DJNZ    MSN
000382 4382 C9              10      RET
                                
       4383                     ROM_STKE:
000383 4383 3E                      DB  03EH
000384 4384 C9              10      RET
000385 4385 32DAFE          13      LD  (H_STKE),A
000388 4388 E5              11      PUSH    HL
000389 4389 D5              11      PUSH    DE
00038A 438A C5              11      PUSH    BC
00038B 438B 181D            12      JR  BASAUTO
                                
00038D 438D AF               4      XOR A
00038E 438E 5F               4      LD  E,A
00038F 438F 57               4      LD  D,A
000390 4390 0601             7      LD  B,1
000392 4392 2100C0          10      LD  HL,0C000H
000395 4395 CDB84A          17      CALL    DISKIO
                                
000398 4398 ED7352F1        20      LD  (BASSTK),SP
00039C 439C 116BF3          10      LD  DE,RAMUSE
00039F 439F AF               4      XOR A
0003A0 43A0 CD1EC0          17      CALL    0C01EH
0003A3 43A3 116BF3          10      LD  DE,RAMUSE
0003A6 43A6 37               4      SCF
0003A7 43A7 CD1EC0          17      CALL    0C01EH
       43AA                     BASAUTO:
0003AA 43AA 21EC43          10      LD  HL,AUTOEXEC
0003AD 43AD 1146F1          10      LD  DE,FDRV
0003B0 43B0 010C00          10      LD  BC,1+8+3
0003B3 43B3 EDB0                    LDIR
0003B5 43B5 CD8048          17      CALL    ROM_OPEN
0003B8 43B8 3813            12      JR  C,RSTKEE
0003BA 43BA 21F843          10      LD  HL,RUN_AUTOEXEC
0003BD 43BD 11F0FB          10      LD  DE,KEYBUF
0003C0 43C0 ED53FAF3        20      LD  (GETPNT),DE
0003C4 43C4 011300          10      LD  BC,RUN_AUTOEXEC_E-RUN_AUTOEXEC
0003C7 43C7 EDB0                    LDIR
0003C9 43C9 ED53F8F3        20      LD  (PUTPNT),DE
       43CD                     RSTKEE:
0003CD 43CD C1              10      POP BC
0003CE 43CE D1              10      POP DE
0003CF 43CF E1              10      POP HL
0003D0 43D0 C9              10      RET
                                
       43D1                     MSG_ERROR_ROM_MODE:
0003D1 43D1 41534349492D384B        DB  "ASCII-8K/Konami-8K only!",13,10
            2F4B6F6E616D692D    
            384B206F6E6C7921    
            0D0A                
       43EB                     NULL:
0003EB 43EB 00                      DB  0
                                
       43EC                     AUTOEXEC:
0003EC 43EC 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       43F8                     RUN_AUTOEXEC:
0003F8 43F8 52554E2022415554        DB  'RUN "AUTOEXEC.BAS"',00DH
            4F455845432E4241    
            53220D              
                                ;   DB  'LOAD "AUTOEXEC.BAS"',00DH  ;テスト用
       440B                     RUN_AUTOEXEC_E:
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       440B                     ROM_LDIR:
00040B 440B 3A2BF1          13      LD  A,(FLG_LDIR)
00040E 440E B7               4      OR  A
00040F 440F 2007            12      JR  NZ,ROM_LDIRVM
000411 4411 CB7A             8      BIT 7,D
000413 4413 2815            12      JR  Z,ROM_LDIRSLT
000415 4415 EDB0                    LDIR
000417 4417 C9              10      RET
                                
       4418                     ROM_LDIRVM:
000418 4418 C5              11      PUSH    BC
000419 4419 D5              11      PUSH    DE
00041A 441A FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
00041E 441E DD215C00        14      LD  IX,LDIRVM
000422 4422 CD1C00          17      CALL    _CALSLT
000425 4425 E1              10      POP HL
000426 4426 C1              10      POP BC
000427 4427 09              11      ADD HL,BC
000428 4428 EB               4      EX  DE,HL
000429 4429 C9              10      RET
                                
       442A                     ROM_LDIRSLT:
00042A 442A EB               4      EX  DE,HL
       442B                     RLDIRSLT1:
00042B 442B 1A               7      LD  A,(DE)
00042C 442C 13               6      INC DE
00042D 442D C5              11      PUSH    BC
00042E 442E D5              11      PUSH    DE
00042F 442F E5              11      PUSH    HL
000430 4430 5F               4      LD  E,A
000431 4431 3A42F3          13      LD  A,(RAMAD1)
000434 4434 FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
000438 4438 DD211400        14      LD  IX,_WRSLT
00043C 443C CD1C00          17      CALL    _CALSLT
00043F 443F E1              10      POP HL
000440 4440 D1              10      POP DE
000441 4441 C1              10      POP BC
000442 4442 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
000444 4444 EA2B44          10      JP  PE,RLDIRSLT1
000447 4447 EB               4      EX  DE,HL
000448 4448 C9              10      RET
                                
       4449                     END_OF_LINE:
000449 4449 215EF5          10      LD  HL,BUF
       444C                     EOL1:
00044C 444C 7E               7      LD  A,(HL)
00044D 444D C8              11      RET Z
00044E 444E FE0D             7      CP  00DH
000450 4450 2807            12      JR  Z,EOLE
000452 4452 FE0A             7      CP  00AH
000454 4454 2803            12      JR  Z,EOLE
000456 4456 23               6      INC HL
000457 4457 18F3            12      JR  EOL1
       4459                     EOLE:
000459 4459 3600            10      LD  (HL),0
00045B 445B 23               6      INC HL
00045C 445C 7E               7      LD  A,(HL)
00045D 445D FE0A             7      CP  00AH
00045F 445F C0              11      RET NZ
000460 4460 23               6      INC HL
000461 4461 C9              10      RET
                                
       4462                     ROM_LOAD_ASCII:
000462 4462 210000          10      LD  HL,0
000465 4465 2234F1          16      LD  (_BUF_ST),HL    ;読み出し位置
000468 4468 2A76F6          16      LD  HL,(TXTTAB)
00046B 446B 2236F1          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
00046E 446E 215EF5          10      LD  HL,BUF
000471 4471 2229F1          16      LD  (_DTA),HL
       4474                     RLOAD_A1:
000474 4474 2A34F1          16      LD  HL,(_BUF_ST)
000477 4477 221FF1          16      LD  (RR_LOW),HL
00047A 447A 210201          10      LD  HL,258
00047D 447D CDAB46          17      CALL    ROM_READ
000480 4480 7C               4      LD  A,H
000481 4481 B5               4      OR  L
000482 4482 2877            12      JR  Z,RLOAD_AEND
000484 4484 015EF5          10      LD  BC,BUF
000487 4487 09              11      ADD HL,BC
000488 4488 3600            10      LD  (HL),0
00048A 448A CD4944          17      CALL    END_OF_LINE
00048D 448D 015EF5          10      LD  BC,BUF
000490 4490 A7               4      AND A
000491 4491 ED42            15      SBC HL,BC
000493 4493 2810            12      JR  Z,RLOAD_A2
000495 4495 4D               4      LD  C,L
000496 4496 44               4      LD  B,H
000497 4497 ED5B34F1        20      LD  DE,(_BUF_ST)
00049B 449B 19              11      ADD HL,DE
00049C 449C 2234F1          16      LD  (_BUF_ST),HL
00049F 449F 3A5EF5          13      LD  A,(BUF)
0004A2 44A2 B7               4      OR  A
0004A3 44A3 28CF            12      JR  Z,RLOAD_A1
       44A5                     RLOAD_A2:
0004A5 44A5 115EF5          10      LD  DE,BUF
0004A8 44A8 CD1748          17      CALL    SPCUTEX
0004AB 44AB 1A               7      LD  A,(DE)
0004AC 44AC B7               4      OR  A
0004AD 44AD 284C            12      JR  Z,RLOAD_AEND
0004AF 44AF CD2948          17      CALL    GETNUM
0004B2 44B2 7C               4      LD  A,H
0004B3 44B3 B5               4      OR  L
0004B4 44B4 CA5245          10      JP  Z,ERROR_DIRECT_IN_FILE
0004B7 44B7 DD2A36F1        20      LD  IX,(_BUF_EN)
0004BB 44BB DD7502          19      LD  (IX+2),L
0004BE 44BE DD7403          19      LD  (IX+3),H
                                
0004C1 44C1 CD1048          17      CALL    SPCUT
0004C4 44C4 EB               4      EX  DE,HL
0004C5 44C5 DDE5            15      PUSH    IX
0004C7 44C7 DD21B242        14      LD  IX,CRUNCH
0004CB 44CB FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
0004CF 44CF CD1C00          17      CALL    _CALSLT
0004D2 44D2 DDE1            14      POP IX
0004D4 44D4 EB               4      EX  DE,HL
0004D5 44D5 111FF4          10      LD  DE,KBUF
0004D8 44D8 37               4      SCF
0004D9 44D9 ED52            15      SBC HL,DE
0004DB 44DB 2875            12      JR  Z,ERROR_DIRECT_IN_FILE
0004DD 44DD 3873            12      JR  C,ERROR_DIRECT_IN_FILE
0004DF 44DF 4D               4      LD  C,L
0004E0 44E0 44               4      LD  B,H
0004E1 44E1 2A36F1          16      LD  HL,(_BUF_EN)
0004E4 44E4 110400          10      LD  DE,4
0004E7 44E7 19              11      ADD HL,DE
0004E8 44E8 111FF4          10      LD  DE,KBUF
                                
0004EB 44EB EB               4      EX  DE,HL
0004EC 44EC EDB0                    LDIR
0004EE 44EE EB               4      EX  DE,HL
                                
0004EF 44EF DD7500          19      LD  (IX+0),L
0004F2 44F2 DD7401          19      LD  (IX+1),H
0004F5 44F5 2236F1          16      LD  (_BUF_EN),HL
0004F8 44F8 C37444          10      JP  RLOAD_A1
                                
       44FB                     RLOAD_AEND:
0004FB 44FB 2A36F1          16      LD  HL,(_BUF_EN)
0004FE 44FE AF               4      XOR A
0004FF 44FF 77               7      LD  (HL),A
000500 4500 23               6      INC HL
000501 4501 77               7      LD  (HL),A
000502 4502 23               6      INC HL
000503 4503 2236F1          16      LD  (_BUF_EN),HL
000506 4506 1833            12      JR  RLOAD_END1
                                
       4508                     ROM_LOAD:
000508 4508 CD8346          17      CALL    INIT_PARAM
00050B 450B CD4A47          17      CALL    FILE_B:
00050E 450E CD8048          17      CALL    ROM_OPEN
000511 4511 3845            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000513 4513 2133F1          10      LD  HL,_BUF
000516 4516 2229F1          16      LD  (_DTA),HL
000519 4519 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
00051C 451C CDAB46          17      CALL    ROM_READ
00051F 451F 3A33F1          13      LD  A,(_BUF)
000522 4522 3C               4      INC A
000523 4523 C26244          10      JP  NZ,ROM_LOAD_ASCII
000526 4526 2A76F6          16      LD  HL,(TXTTAB)
000529 4529 2229F1          16      LD  (_DTA),HL
00052C 452C EB               4      EX  DE,HL
00052D 452D 2100FF          10      LD  HL,-256
000530 4530 39              11      ADD HL,SP
000531 4531 ED52            15      SBC HL,DE
000533 4533 CDAB46          17      CALL    ROM_READ
000536 4536 ED5B29F1        20      LD  DE,(_DTA)
00053A 453A 19              11      ADD HL,DE
       453B                     RLOAD_END1:
00053B 453B 22C2F6          16      LD  (VARTAB),HL
00053E 453E 22C4F6          16      LD  (ARYTAB),HL
000541 4541 22C6F6          16      LD  (STREND),HL
                                
000544 4544 AF               4      XOR A
000545 4545 2136F1          10      LD  HL,_BUF+3
000548 4548 77               7      LD  (HL),A
000549 4549 2B               6      DEC HL
00054A 454A 77               7      LD  (HL),A
00054B 454B 2B               6      DEC HL
00054C 454C 77               7      LD  (HL),A
00054D 454D 2B               6      DEC HL
00054E 454E 3E8F             7      LD  A,08FH          ;REM
000550 4550 77               7      LD  (HL),A
000551 4551 C9              10      RET
                                
       4552                     ERROR_DIRECT_IN_FILE:
000552 4552 1E39             7      LD  E,57            ;Direct statement in file
000554 4554 01                      DB  1           ;LD BC,
       4555                     ERROR_FILE_NOT_OPEN:
000555 4555 1E3B             7      LD  E,59            ;File not OPEN
000557 4557 01                      DB  1           ;LD BC,
       4558                     ERROR_FILE_NOT_FOUND:
000558 4558 1E35             7      LD  E,53            ;File not found
       455A                     ERROR:
00055A 455A FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
00055E 455E DD216F40        14      LD  IX,ERRHAND
000562 4562 C31C00          10      JP  _CALSLT
                                
       4565                     ROM_BLOAD:
000565 4565 CD8346          17      CALL    INIT_PARAM
000568 4568 CD4A47          17      CALL    FILE_B
00056B 456B CD8048          17      CALL    ROM_OPEN
00056E 456E 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000570 4570 2133F1          10      LD  HL,_BUF
000573 4573 2229F1          16      LD  (_DTA),HL
000576 4576 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
000579 4579 CDAB46          17      CALL    ROM_READ
00057C 457C 3A33F1          13      LD  A,(_BUF)
00057F 457F FEFE             7      CP  0FEH
000581 4581 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
000583 4583 2109F1          10      LD  HL,BLOAD_RET
000586 4586 2201F1          16      LD  (SWC_BLOAD),HL
                                
000589 4589 2A44F1          16      LD  HL,(PARAM1)
00058C 458C 7E               7      LD  A,(HL)
00058D 458D FE2C             7      CP  ','
00058F 458F 2048            12      JR  NZ,RBREAD_MEM
000591 4591 23               6      INC HL
000592 4592 7E               7      LD  A,(HL)
000593 4593 CD6A48          17      CALL    CAP
000596 4596 32BEFC          13      LD  (RUNBNF),A
       4599                     RBOS1:
000599 4599 7E               7      LD  A,(HL)
00059A 459A 23               6      INC HL
00059B 459B B7               4      OR  A
00059C 459C 282F            12      JR  Z,RBREAD_OSE
00059E 459E FE3A             7      CP  ':'
0005A0 45A0 282B            12      JR  Z,RBREAD_OSE
0005A2 45A2 FE2C             7      CP  ','     ;次のパラメータを探す
0005A4 45A4 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
0005A6 45A6 2244F1          16      LD  (PARAM1),HL
0005A9 45A9 7E               7      LD  A,(HL)
0005AA 45AA B7               4      OR  A
0005AB 45AB 2820            12      JR  Z,RBREAD_OSE
0005AD 45AD DD21644C        14      LD  IX,FRMEVL
0005B1 45B1 FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
0005B5 45B5 CD1C00          17      CALL    _CALSLT
0005B8 45B8 2244F1          16      LD  (PARAM1),HL
0005BB 45BB 3A63F6          13      LD  A,(VALTYP)
0005BE 45BE FE02             7      CP  2
0005C0 45C0 200B            12      JR  NZ,RBREAD_OSE
0005C2 45C2 2A34F1          16      LD  HL,(_BUF_ST)
0005C5 45C5 ED5BF8F7        20      LD  DE,(DACDAT)
0005C9 45C9 19              11      ADD HL,DE
0005CA 45CA 2234F1          16      LD  (_BUF_ST),HL
       45CD                     RBREAD_OSE:
0005CD 45CD 3ABEFC          13      LD  A,(RUNBNF)
0005D0 45D0 FE53             7      CP  'S'
0005D2 45D2 2005            12      JR  NZ,RBREAD_MEM
0005D4 45D4 3E01             7      LD  A,1
0005D6 45D6 322BF1          13      LD  (FLG_LDIR),A
       45D9                     RBREAD_MEM:
0005D9 45D9 2A34F1          16      LD  HL,(_BUF_ST)
0005DC 45DC 22BFFC          16      LD  (SAVENT),HL
0005DF 45DF 2229F1          16      LD  (_DTA),HL
0005E2 45E2 21FFFF          10      LD  HL,0FFFFH
0005E5 45E5 CDAB46          17      CALL    ROM_READ
0005E8 45E8 3ABEFC          13      LD  A,(RUNBNF)
0005EB 45EB FE52             7      CP  'R'
0005ED 45ED 2006            12      JR  NZ,RBREAD1
0005EF 45EF 2A38F1          16      LD  HL,(_BUF_EX)
0005F2 45F2 2201F1          16      LD  (SWC_BLOAD),HL
       45F5                     RBREAD1:
       45F5                     ROM_NEXT:
0005F5 45F5 2A44F1          16      LD  HL,(PARAM1)
0005F8 45F8 7E               7      LD  A,(HL)
0005F9 45F9 2B               6      DEC HL
0005FA 45FA B7               4      OR  A
0005FB 45FB 2805            12      JR  Z,RN1
0005FD 45FD FE3A             7      CP  ':'
0005FF 45FF 2801            12      JR  Z,RN1
000601 4601 23               6      INC HL
       4602                     RN1:
000602 4602 5D               4      LD  E,L
000603 4603 54               4      LD  D,H
                                
000604 4604 CD4048          17      CALL    SEARCH_END
000607 4607 B7               4      OR  A
000608 4608 2815            12      JR  Z,REM
                                                    ;マルチステートメントの処理
00060A 460A 7E               7      LD  A,(HL)
                                
00060B 460B FEB5             7      CP  0B5H            ;LOAD
00060D 460D CA0845          10      JP  Z,ROM_LOAD
000610 4610 FE8A             7      CP  08AH            ;RUN
000612 4612 280F            12      JR  Z,ROM_RUN
000614 4614 FEB7             7      CP  0B7H            ;FILES
000616 4616 2818            12      JR  Z,ROM_FILES
000618 4618 3E28             7      LD  A,028H          ;JR Z,
00061A 461A 3207F1          13      LD  (SWC_BLOAD_M),A
00061D 461D 7E               7      LD  A,(HL)
00061E 461E C9              10      RET
                                
       461F                     REM:
00061F 461F EB               4      EX  DE,HL
000620 4620 3E8F             7      LD  A,08FH          ;REM
000622 4622 C9              10      RET
                                
       4623                     ROM_RUN:
000623 4623 23               6      INC HL
000624 4624 7E               7      LD  A,(HL)
000625 4625 2B               6      DEC HL
000626 4626 B7               4      OR  A
000627 4627 2803            12      JR  Z,ROM_RUN1
000629 4629 CD0845          17      CALL    ROM_LOAD
       462C                     ROM_RUN1:
00062C 462C 3E8A             7      LD  A,08AH          ;RUN
00062E 462E 77               7      LD  (HL),A
00062F 462F C9              10      RET
                                
       4630                     ROM_FILES:
000630 4630 CD8346          17      CALL    INIT_PARAM
000633 4633 CD4A47          17      CALL    FILE_B
000636 4636 CD374C          17      CALL    GET_DISK_BANK_FDRV
000639 4639 320068          13      LD  (BANK1_SEL),A
00063C 463C 3A47F1          13      LD  A,(FNAME)
00063F 463F FE21             7      CP  021H
000641 4641 3005            12      JR  NC,RFILES0
000643 4643 060B             7      LD  B,11
000645 4645 CDD447          17      CALL    FILE10
       4648                     RFILES0:
000648 4648 CD874A          17      CALL    GET_DIR_DAT
       464B                     RFILES1:
00064B 464B CD9F48          17      CALL    FILESE
00064E 464E 302E            12      JR  NC,RFILES_NOT_MATCH
       4650                     RFILES_DISP:
000650 4650 E5              11      PUSH    HL
000651 4651 0608             7      LD  B,8
000653 4653 CD7B43          17      CALL    MSN
000656 4656 3E2E             7      LD  A,'.'
000658 4658 CD754C          17      CALL    MSG_A
00065B 465B 0603             7      LD  B,3
00065D 465D CD7B43          17      CALL    MSN
000660 4660 3ADDF3          13      LD  A,(CSRX)
000663 4663 47               4      LD  B,A
000664 4664 3AB0F3          13      LD  A,(LINLEN)
000667 4667 90               4      SUB B
000668 4668 FE0C             7      CP  12
00066A 466A 3009            12      JR  NC,RFILES2
00066C 466C 3E0D             7      LD  A,00DH      ;改行
00066E 466E CD754C          17      CALL    MSG_A
000671 4671 3E0A             7      LD  A,00AH
000673 4673 1802            12      JR  RFILES3
       4675                     RFILES2:
000675 4675 3E20             7      LD  A,020H
       4677                     RFILES3:
000677 4677 CD754C          17      CALL    MSG_A
00067A 467A E1              10      POP HL
00067B 467B CDBB48          17      CALL    FNEXT
       467E                     RFILES_NOT_MATCH:
00067E 467E 20CB            12      JR  NZ,RFILES1
000680 4680 C3F545          10      JP  ROM_NEXT
                                
       4683                     INIT_PARAM:
000683 4683 2242F1          16      LD  (PARAM0),HL
000686 4686 EB               4      EX  DE,HL
000687 4687 AF               4      XOR A
000688 4688 322BF1          13      LD  (FLG_LDIR),A
00068B 468B 32BEFC          13      LD  (RUNBNF),A
00068E 468E 3263F6          13      LD  (VALTYP),A
000691 4691 13               6      INC DE
000692 4692 CD1048          17      CALL    SPCUT
000695 4695 1A               7      LD  A,(DE)
000696 4696 B7               4      OR  A
000697 4697 C8              11      RET Z
000698 4698 FE3A             7      CP  ':'
00069A 469A C8              11      RET Z
00069B 469B EB               4      EX  DE,HL
00069C 469C DD21644C        14      LD  IX,FRMEVL
0006A0 46A0 FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
0006A4 46A4 CD1C00          17      CALL    _CALSLT
0006A7 46A7 2244F1          16      LD  (PARAM1),HL
0006AA 46AA C9              10      RET
                                
       46AB                     ROM_READ:
0006AB 46AB E5              11      PUSH    HL
0006AC 46AC D5              11      PUSH    DE
0006AD 46AD C5              11      PUSH    BC
0006AE 46AE FDE5            15      PUSH    IY
0006B0 46B0 2240F1          16      LD  (LEFTX),HL
0006B3 46B3 2A29F1          16      LD  HL,(_DTA)
0006B6 46B6 223AF1          16      LD  (DTAX),HL
0006B9 46B9 2A40F1          16      LD  HL,(LEFTX)
                                
0006BC 46BC CDE748          17      CALL    RBX1
0006BF 46BF 386F            12      JR  C,RBRERR1
0006C1 46C1 79               4      LD  A,C
0006C2 46C2 EB               4      EX  DE,HL
0006C3 46C3 ED52            15      SBC HL,DE       ;CP 0HL,CDE
0006C5 46C5 19              11      ADD HL,DE
0006C6 46C6 DE00             7      SBC A,000H
0006C8 46C8 3801            12      JR  C,RBR1
0006CA 46CA EB               4      EX  DE,HL
       46CB                     RBR1:
0006CB 46CB 9F               4      SBC A,A
0006CC 46CC E601             7      AND 1
0006CE 46CE 321DF1          13      LD  (_RESULT),A
0006D1 46D1 7C               4      LD  A,H
0006D2 46D2 B5               4      OR  L
0006D3 46D3 CA2647          10      JP  Z,RBREND0
                                
0006D6 46D6 2225F1          16      LD  (_LEFT),HL  ;Read record byte
0006D9 46D9 2240F1          16      LD  (LEFTX),HL
                                
0006DC 46DC CD1049          17      CALL    RBX2
0006DF 46DF 281A            12      JR  Z,RBRB
                                                ;先頭の端数
0006E1 46E1 CD2149          17      CALL    RBXA
0006E4 46E4 DA3C47          10      JP  C,RBRERR
0006E7 46E7 C5              11      PUSH    BC
0006E8 46E8 CD0B44          17      CALL    ROM_LDIR
0006EB 46EB ED533AF1        20      LD  (DTAX),DE
0006EF 46EF 2A40F1          16      LD  HL,(LEFTX)
0006F2 46F2 D1              10      POP DE
0006F3 46F3 A7               4      AND A
0006F4 46F4 ED52            15      SBC HL,DE
0006F6 46F6 2240F1          16      LD  (LEFTX),HL
0006F9 46F9 2828            12      JR  Z,RBREND
                                
       46FB                     RBRB:
0006FB 46FB CD5A49          17      CALL    RBXB
0006FE 46FE 2817            12      JR  Z,RBRC
       4700                     RBRB1:
000700 4700 C5              11      PUSH    BC
000701 4701 D5              11      PUSH    DE
000702 4702 CDEF49          17      CALL    CLUST
000705 4705 EB               4      EX  DE,HL
000706 4706 010004          10      LD  BC,1024     ;1クラスタのサイズ
000709 4709 CD0B44          17      CALL    ROM_LDIR
00070C 470C EB               4      EX  DE,HL
00070D 470D D1              10      POP DE
00070E 470E C1              10      POP BC
00070F 470F CDCC49          17      CALL    GNCL
000712 4712 DA3C47          10      JP  C,RBRERR
000715 4715 10E9            13      DJNZ    RBRB1
       4717                     RBRC:
000717 4717 CD6A49          17      CALL    RBXC
00071A 471A 2807            12      JR  Z,RBREND
                                
00071C 471C CDEF49          17      CALL    CLUST
00071F 471F EB               4      EX  DE,HL
000720 4720 CD0B44          17      CALL    ROM_LDIR
       4723                     RBREND:
000723 4723 CD7449          17      CALL    RBXEND
       4726                     RBREND0:
000726 4726 FDE1            14      POP IY
000728 4728 C1              10      POP BC
000729 4729 D1              10      POP DE
00072A 472A F1              10      POP AF  ;(HL)
00072B 472B AF               4      XOR A
00072C 472C 3A1DF1          13      LD  A,(_RESULT)
00072F 472F C9              10      RET
                                
       4730                     RBRERR1:
000730 4730 3E01             7      LD  A,001H
       4732                     RBRERR2:
000732 4732 FDE1            14      POP IY
000734 4734 C1              10      POP BC
000735 4735 D1              10      POP DE
000736 4736 E1              10      POP HL
000737 4737 37               4      SCF
000738 4738 210000          10      LD  HL,0
00073B 473B C9              10      RET
       473C                     RBRERR:
00073C 473C 3EFF             7      LD  A,0FFH
00073E 473E 18F2            12      JR  RBRERR2
                                
       4740                     FILE_DD:
000740 4740 3E                      DB  03EH
000741 4741 C9              10      RET
000742 4742 3207F1          13      LD  (SWC_BLOAD_M),A
000745 4745 2A42F1          16      LD  HL,(PARAM0)
000748 4748 7E               7      LD  A,(HL)
000749 4749 C9              10      RET
       474A                     FILE_B:
00074A 474A AF               4      XOR A
00074B 474B 3246F1          13      LD  (FDRV),A
00074E 474E 1E00             7      LD  E,0
000750 4750 3A63F6          13      LD  A,(VALTYP)
000753 4753 FE03             7      CP  3       ;string
000755 4755 203A            12      JR  NZ,FILED
000757 4757 DD2AF8F7        20      LD  IX,(DACDAT)
00075B 475B DD5E00          19      LD  E,(IX+0)
00075E 475E DD7E01          19      LD  A,(IX+1)
000761 4761 DD5602          19      LD  D,(IX+2)
000764 4764 DD62             9      LD  IXH,D
000766 4766 DD6F             9      LD  IXL,A
000768 4768 7B               4      LD  A,E
000769 4769 FE04             7      CP  4
00076B 476B 3808            12      JR  C,FILEB1
00076D 476D DD7E03          19      LD  A,(IX+3)
000770 4770 FE3A             7      CP  ':'
000772 4772 28CC            12      JR  Z,FILE_DD
000774 4774 7B               4      LD  A,E
       4775                     FILEB1:
000775 4775 FE02             7      CP  2
000777 4777 3818            12      JR  C,FILED
000779 4779 DD7E01          19      LD  A,(IX+1)
00077C 477C FE3A             7      CP  ':'
00077E 477E 2011            12      JR  NZ,DEVI1
000780 4780 DD7E00          19      LD  A,(IX+0)        ;DRIVE
000783 4783 CD6A48          17      CALL    CAP
000786 4786 D640             7      SUB '@'
000788 4788 DD23            10      INC IX
00078A 478A DD23            10      INC IX
00078C 478C 1D               4      DEC E
00078D 478D 1D               4      DEC E
00078E 478E 3246F1          13      LD  (FDRV),A
       4791                     DEVI1:
                                
       4791                     FILED:
000791 4791 CDD847          17      CALL    FILEI
000794 4794 2147F1          10      LD  HL,FNAME
                                
000797 4797 0608             7      LD  B,8
       4799                     FILE2:
000799 4799 CDE547          17      CALL    CCHKF
00079C 479C C8              11      RET Z
00079D 479D FE2A             7      CP  '*'
00079F 479F 282E            12      JR  Z,FILE9
0007A1 47A1 FE2E             7      CP  '.'
0007A3 47A3 280C            12      JR  Z,FILE4
0007A5 47A5 77               7      LD  (HL),A
0007A6 47A6 23               6      INC HL
0007A7 47A7 10F0            13      DJNZ    FILE2
                                
       47A9                     FILE3:
0007A9 47A9 CDE547          17      CALL    CCHKF
0007AC 47AC C8              11      RET Z
0007AD 47AD FE2E             7      CP  '.'
0007AF 47AF 20F8            12      JR  NZ,FILE3
                                
       47B1                     FILE4:
0007B1 47B1 214FF1          10      LD  HL,FNAME+8
0007B4 47B4 0603             7      LD  B,3
                                
       47B6                     FILE4L:
0007B6 47B6 CDE547          17      CALL    CCHKF
0007B9 47B9 C8              11      RET Z
0007BA 47BA FE2E             7      CP  '.'
0007BC 47BC 2008            12      JR  NZ,FILE12
0007BE 47BE 3247F1          13      LD  (FNAME),A   ;Parent directory(..)
0007C1 47C1 3248F1          13      LD  (FNAME+1),A
0007C4 47C4 3E20             7      LD  A,020H
       47C6                     FILE12:
0007C6 47C6 FE2A             7      CP  '*'
0007C8 47C8 280A            12      JR  Z,FILE10
0007CA 47CA 77               7      LD  (HL),A
0007CB 47CB 23               6      INC HL
0007CC 47CC 10E8            13      DJNZ    FILE4L
0007CE 47CE C9              10      RET
                                
       47CF                     FILE9:              ;名前の*処理、名前の残りを?で埋める
0007CF 47CF CDD447          17      CALL    FILE10
0007D2 47D2 18D5            12      JR  FILE3
                                
       47D4                     FILE10:
0007D4 47D4 3E3F             7      LD  A,'?'
0007D6 47D6 1808            12      JR  FILL_MEMORY
       47D8                     FILEI:              ;名前＋拡張子をスペースで初期化
0007D8 47D8 3E20             7      LD  A,020H
0007DA 47DA 01000B          10      LD  BC,11*256   ;C=0にしておく
0007DD 47DD 2147F1          10      LD  HL,FNAME
       47E0                     FILL_MEMORY:            ;HLからBバイトAで埋める
0007E0 47E0 77               7      LD  (HL),A
0007E1 47E1 23               6      INC HL
0007E2 47E2 10FC            13      DJNZ    FILL_MEMORY
0007E4 47E4 C9              10      RET
                                
       47E5                     CCHKF:
0007E5 47E5 7B               4      LD  A,E
0007E6 47E6 B7               4      OR  A
0007E7 47E7 C8              11      RET Z
0007E8 47E8 DD7E00          19      LD  A,(IX+0)
0007EB 47EB CDF247          17      CALL    CCHK2
0007EE 47EE C8              11      RET Z
0007EF 47EF C35548          10      JP  FKAN
                                
       47F2                     CCHK2:
0007F2 47F2 0C               4      INC C
0007F3 47F3 0D               4      DEC C
0007F4 47F4 C0              11      RET NZ
       47F5                     CCHK3:              ;ZF=1 で使えない文字
0007F5 47F5 FE2B             7      CP  '+'
0007F7 47F7 C8              11      RET Z
0007F8 47F8 FE2C             7      CP  ','
0007FA 47FA C8              11      RET Z
0007FB 47FB FE2F             7      CP  '/'
0007FD 47FD C8              11      RET Z
0007FE 47FE FE3A             7      CP  ':'
000800 4800 C8              11      RET Z
000801 4801 FE3B             7      CP  ';'
000803 4803 C8              11      RET Z
000804 4804 FE3D             7      CP  '='
000806 4806 C8              11      RET Z
000807 4807 FE5C             7      CP  05CH    ;\
000809 4809 C8              11      RET Z
00080A 480A FE1F             7      CP  01FH
00080C 480C D0              11      RET NC
00080D 480D BF               4      CP  A       ;Z=1
00080E 480E C9              10      RET
                                
       480F                     SS1:
00080F 480F 13               6      INC DE
       4810                     SPCUT:              ;スペースをカット
000810 4810 1A               7      LD  A,(DE)
000811 4811 FE20             7      CP  020H
000813 4813 28FA            12      JR  Z,SS1
000815 4815 C9              10      RET
                                
       4816                     SCREOF1:
000816 4816 13               6      INC DE
       4817                     SPCUTEX:            ;スペース改行などをカット
000817 4817 1A               7      LD  A,(DE)
000818 4818 FE20             7      CP  020H
00081A 481A 28FA            12      JR  Z,SCREOF1
00081C 481C FE0D             7      CP  00DH
00081E 481E 28F6            12      JR  Z,SCREOF1
000820 4820 FE0A             7      CP  00AH
000822 4822 28F2            12      JR  Z,SCREOF1
000824 4824 FE1A             7      CP  01AH
000826 4826 28EE            12      JR  Z,SCREOF1
000828 4828 C9              10      RET
                                
       4829                     GETNUM:
000829 4829 210000          10      LD  HL,0
       482C                     GETNUM1:
00082C 482C 1A               7      LD  A,(DE)
00082D 482D 13               6      INC DE
00082E 482E D630             7      SUB '0'
000830 4830 D8              11      RET C
000831 4831 FE0A             7      CP  10
000833 4833 D0              11      RET NC
000834 4834 4D               4      LD  C,L
000835 4835 44               4      LD  B,H
000836 4836 29              11      ADD HL,HL   ;*2
000837 4837 29              11      ADD HL,HL   ;*4
000838 4838 09              11      ADD HL,BC   ;*5
000839 4839 29              11      ADD HL,HL   ;*10
00083A 483A 4F               4      LD  C,A
00083B 483B 0600             7      LD  B,0
00083D 483D 09              11      ADD HL,BC
00083E 483E 18EC            12      JR  GETNUM1
                                
       4840                     SEARCH_END:
000840 4840 7E               7      LD  A,(HL)
       4841                     SEARCH_END1:
000841 4841 23               6      INC HL
000842 4842 B7               4      OR  A
000843 4843 C8              11      RET Z
000844 4844 FE3A             7      CP  ':'
000846 4846 20F8            12      JR  NZ,SEARCH_END
000848 4848 7E               7      LD  A,(HL)
000849 4849 FE3A             7      CP  ':'
00084B 484B 28F4            12      JR  Z,SEARCH_END1
00084D 484D C9              10      RET
                                
       484E                     FKANC:
00084E 484E CB41             8      BIT 0,C
000850 4850 CC7348          17      CALL    Z,CAP2
000853 4853 1803            12      JR  FKANX
       4855                     FKAN:           ;漢字チェック
000855 4855 DD23            10      INC IX
000857 4857 1D               4      DEC E
       4858                     FKANX:
000858 4858 CB41             8      BIT 0,C
00085A 485A CB81             8      RES 0,C
00085C 485C C0              11      RET NZ
00085D 485D FE80             7      CP  080H
00085F 485F D8              11      RET C
000860 4860 FEA0             7      CP  0A0H
000862 4862 3803            12      JR  C,FKAN1
000864 4864 FEE0             7      CP  0E0H
000866 4866 D8              11      RET C
       4867                     FKAN1:
000867 4867 0C               4      INC C
000868 4868 A7               4      AND A
000869 4869 C9              10      RET
                                
       486A                     CAP:
00086A 486A FE61             7      CP  'a'
00086C 486C D8              11      RET C
00086D 486D FE7B             7      CP  'z'+1
00086F 486F D0              11      RET NC
000870 4870 D620             7      SUB 020H
000872 4872 C9              10      RET
       4873                     CAP2:
000873 4873 CD6A48          17      CALL    CAP
       4876                     CAP3:               ;
000876 4876 FE05             7      CP  5
000878 4878 2803            12      JR  Z,CAP4
00087A 487A FE21             7      CP  021H
00087C 487C C9              10      RET
       487D                     CAP4:
00087D 487D 3EE5             7      LD  A,0E5H
00087F 487F C9              10      RET
                                
       4880                     ROM_OPEN:
000880 4880 CD374C          17      CALL    GET_DISK_BANK_FDRV
000883 4883 320068          13      LD  (BANK1_SEL),A
                                
000886 4886 CD874A          17      CALL    GET_DIR_DAT
000889 4889 D5              11      PUSH    DE
00088A 488A CD9F48          17      CALL    FILESE
00088D 488D D1              10      POP DE
00088E 488E 3F               4      CCF
00088F 488F D8              11      RET C
000890 4890 223EF1          16      LD  (FCBX),HL
000893 4893 E5              11      PUSH    HL
000894 4894 210000          10      LD  HL,0
000897 4897 221FF1          16      LD  (RR_LOW),HL
00089A 489A 2221F1          16      LD  (RR_HIGH),HL
00089D 489D E1              10      POP HL
00089E 489E C9              10      RET
                                
       489F                     FILESE:
00089F 489F 7E               7      LD  A,(HL)
0008A0 48A0 B7               4      OR  A
0008A1 48A1 C8              11      RET Z       ;END:ZF=1 CF=0
0008A2 48A2 FEE5             7      CP  0E5H
0008A4 48A4 280D            12      JR  Z,FILESE1
0008A6 48A6 1147F1          10      LD  DE,FNAME
0008A9 48A9 E5              11      PUSH    HL
0008AA 48AA CDC148          17      CALL    CPFILE
0008AD 48AD CCE248          17      CALL    Z,CPFILE2
0008B0 48B0 E1              10      POP HL
0008B1 48B1 37               4      SCF
0008B2 48B2 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       48B3                     FILESE1:
0008B3 48B3 CDBB48          17      CALL    FNEXT
0008B6 48B6 20E7            12      JR  NZ,FILESE
       48B8                     ZF0_CF0_AFF_RET:
0008B8 48B8 F6FF             7      OR  0FFH        ;ZF=0 CF=0
0008BA 48BA C9              10      RET
                                
       48BB                     FNEXT:
                                ;   PUSH    HL
                                ;   LD  HL,_FILEN
                                ;   INC (HL)
                                ;   POP HL
0008BB 48BB 112000          10      LD  DE,020H
0008BE 48BE 19              11      ADD HL,DE
0008BF 48BF 0D               4      DEC C
0008C0 48C0 C9              10      RET
                                
       48C1                     CPFILE:
0008C1 48C1 C5              11      PUSH    BC
0008C2 48C2 01000B          10      LD  BC,00B00H
       48C5                     CPSTR1:
0008C5 48C5 1A               7      LD  A,(DE)
0008C6 48C6 FE3F             7      CP  '?'     ;Wild card
0008C8 48C8 2812            12      JR  Z,CPSTR2
0008CA 48CA 7E               7      LD  A,(HL)
0008CB 48CB CD4E48          17      CALL    FKANC
0008CE 48CE E5              11      PUSH    HL
0008CF 48CF 67               4      LD  H,A
0008D0 48D0 1A               7      LD  A,(DE)
0008D1 48D1 CB01             4      RLC C
0008D3 48D3 CD4E48          17      CALL    FKANC
0008D6 48D6 CB09             4      RRC C
0008D8 48D8 BC               4      CP  H       ;CP (HL),(DE)
0008D9 48D9 E1              10      POP HL
0008DA 48DA 2004            12      JR  NZ,CPSTR3
       48DC                     CPSTR2:
0008DC 48DC 13               6      INC DE
0008DD 48DD 23               6      INC HL
0008DE 48DE 10E5            13      DJNZ    CPSTR1
       48E0                     CPSTR3:
0008E0 48E0 C1              10      POP BC
0008E1 48E1 C9              10      RET
                                
       48E2                     CPFILE2:
                                ;   LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
                                ;   OR  0E1H
0008E2 48E2 3EE1             7      LD  A,0E1H
0008E4 48E4 2F               4      CPL
0008E5 48E5 A6               7      AND (HL)
0008E6 48E6 C9              10      RET
                                
       48E7                     RBX1:
0008E7 48E7 E5              11      PUSH    HL      ;Record byte
                                
0008E8 48E8 ED5B1FF1        20      LD  DE,(RR_LOW) ;CDE=Random record
0008EC 48EC 3A22F1          13      LD  A,(RR_HIGH+1)
0008EF 48EF 4F               4      LD  C,A
                                
0008F0 48F0 CD374C          17      CALL    GET_DISK_BANK_FDRV
0008F3 48F3 320068          13      LD  (BANK1_SEL),A
                                
0008F6 48F6 FD2A3EF1        20      LD  IY,(FCBX)
0008FA 48FA FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
0008FD 48FD FD661D          19      LD  H,(IY+01DH)
000900 4900 FD7E1E          19      LD  A,(IY+01EH)
                                
000903 4903 A7               4      AND A
000904 4904 ED52            15      SBC HL,DE
000906 4906 99               4      SBC A,C
000907 4907 D1              10      POP DE
                                
000908 4908 D8              11      RET C
000909 4909 4F               4      LD  C,A
00090A 490A EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
00090B 490B B2               4      OR  D
00090C 490C B3               4      OR  E
00090D 490D C0              11      RET NZ
00090E 490E 37               4      SCF
00090F 490F C9              10      RET
                                
       4910                     RBX2:
000910 4910 ED4B20F1        20      LD  BC,(RR_LOW+1)
000914 4914 CD8949          17      CALL    RWXR
000917 4917 3E03             7      LD  A,3     ;ooo 1
000919 4919 E5              11      PUSH    HL
00091A 491A 2A1FF1          16      LD  HL,(RR_LOW)
00091D 491D A4               4      AND H
00091E 491E B5               4      OR  L
00091F 491F E1              10      POP HL
000920 4920 C9              10      RET
                                
       4921                     RBXA:
000921 4921 D5              11      PUSH    DE
000922 4922 CDEF49          17      CALL    CLUST
000925 4925 ED5327F1        20      LD  (_DTPS),DE
000929 4929 D1              10      POP DE
00092A 492A CDCC49          17      CALL    GNCL
00092D 492D D8              11      RET C
00092E 492E ED5323F1        20      LD  (_CLPS),DE
                                
000932 4932 ED4B1FF1        20      LD  BC,(RR_LOW)
000936 4936 3E03             7      LD  A,3     ;ooo 1
000938 4938 A0               4      AND B
000939 4939 47               4      LD  B,A
00093A 493A 210004          10  IBM7:   LD  HL,1024     ;ooo 512
00093D 493D ED42            15      SBC HL,BC       ;remaining cluster
                                
00093F 493F ED5B40F1        20      LD  DE,(LEFTX)
000943 4943 ED52            15      SBC HL,DE       ;CP HL,DE
000945 4945 19              11      ADD HL,DE
000946 4946 3801            12      JR  C,RBXA1
000948 4948 EB               4      EX  DE,HL
       4949                     RBXA1:
000949 4949 3A1EF1          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
00094C 494C 320068          13      LD  (BANK1_SEL),A   ;ASCII-8K/Konami-8K共通で使える
00094F 494F E5              11      PUSH    HL
000950 4950 2A27F1          16      LD  HL,(_DTPS)
000953 4953 09              11      ADD HL,BC
000954 4954 ED5B3AF1        20      LD  DE,(DTAX)
000958 4958 C1              10      POP BC
000959 4959 C9              10      RET
                                
       495A                     RBXB:
00095A 495A 2A3AF1          16      LD  HL,(DTAX)
00095D 495D ED5B23F1        20      LD  DE,(_CLPS)
000961 4961 3A41F1          13      LD  A,(LEFTX+1)
000964 4964 CB3F             8      SRL A
000966 4966 CB3F             8  IBM8:   SRL A       ;ooo
000968 4968 47               4      LD  B,A
000969 4969 C9              10      RET
                                
       496A                     RBXC:
00096A 496A ED4B40F1        20      LD  BC,(LEFTX)
00096E 496E 3E03             7      LD  A,3     ;ooo 1
000970 4970 A0               4      AND B
000971 4971 47               4      LD  B,A
000972 4972 B1               4      OR  C
000973 4973 C9              10      RET
                                
       4974                     RBXEND:
000974 4974 ED5B25F1        20      LD  DE,(_LEFT)
000978 4978 2A1FF1          16      LD  HL,(RR_LOW)
00097B 497B 3A22F1          13      LD  A,(RR_HIGH+1)
00097E 497E 19              11      ADD HL,DE
00097F 497F CE00             7      ADC A,0
000981 4981 221FF1          16      LD  (RR_LOW),HL
000984 4984 3222F1          13      LD  (RR_HIGH+1),A
000987 4987 EB               4      EX  DE,HL       ;HL=Read byte
000988 4988 C9              10      RET 
                                
       4989                     RWXR:
000989 4989 CB38             8      SRL B
00098B 498B CB19             8      RR  C
00098D 498D CB38             8  IBM4:   SRL B   ;ooo
00098F 498F CB19             8      RR  C
                                
000991 4991 CD374C          17      CALL    GET_DISK_BANK_FDRV
000994 4994 320068          13      LD  (BANK1_SEL),A
                                
000997 4997 FD2A3EF1        20      LD  IY,(FCBX)
00099B 499B FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
00099E 499E FD561B          19      LD  D,(IY+01BH)
       49A1                     RWX1:
0009A1 49A1 ED5323F1        20      LD  (_CLPS),DE
0009A5 49A5 7A               4      LD  A,D
0009A6 49A6 B3               4      OR  E
0009A7 49A7 37               4      SCF
0009A8 49A8 C8              11      RET Z
                                
0009A9 49A9 78               4      LD  A,B
0009AA 49AA B1               4      OR  C
0009AB 49AB C8              11      RET Z
                                
0009AC 49AC CDCC49          17      CALL    GNCL
0009AF 49AF D8              11      RET C
0009B0 49B0 0B               6      DEC BC
0009B1 49B1 CD204A          17      CALL    ENDCL
0009B4 49B4 38EB            12      JR  C,RWX1
0009B6 49B6 37               4      SCF
0009B7 49B7 C9              10      RET
                                
       49B8                     NCL3:
0009B8 49B8 CD374C          17      CALL    GET_DISK_BANK_FDRV
0009BB 49BB 320068          13      LD  (BANK1_SEL),A
0009BE 49BE 6B               4      LD  L,E
0009BF 49BF 62               4      LD  H,D
0009C0 49C0 CB3C             8      SRL H
0009C2 49C2 CB1D             8      RR  L
0009C4 49C4 1F               4      RRA
0009C5 49C5 010062          10      LD  BC,_FATBF
0009C8 49C8 19              11      ADD HL,DE
0009C9 49C9 09              11      ADD HL,BC
0009CA 49CA 17               4      RLA
0009CB 49CB C9              10      RET
                                
       49CC                     GNCL:
0009CC 49CC 7A               4      LD  A,D
0009CD 49CD B3               4      OR  E
0009CE 49CE 37               4      SCF
0009CF 49CF C8              11      RET Z
0009D0 49D0 C5              11      PUSH    BC
0009D1 49D1 E5              11      PUSH    HL
0009D2 49D2 CDB849          17      CALL    NCL3
0009D5 49D5 3809            12      JR  C,GNC1
0009D7 49D7 5E               7      LD  E,(HL)
0009D8 49D8 23               6      INC HL
0009D9 49D9 7E               7      LD  A,(HL)
0009DA 49DA E60F             7      AND 00FH
0009DC 49DC 57               4      LD  D,A
0009DD 49DD E1              10      POP HL
0009DE 49DE C1              10      POP BC
0009DF 49DF C9              10      RET
       49E0                     GNC1:
0009E0 49E0 7E               7      LD  A,(HL)
0009E1 49E1 23               6      INC HL
0009E2 49E2 56               7      LD  D,(HL)
0009E3 49E3 0604             7      LD  B,4
       49E5                     GNC1L:
0009E5 49E5 CB3A             8      SRL D
0009E7 49E7 1F               4      RRA
0009E8 49E8 10FB            13      DJNZ    GNC1L
                                
0009EA 49EA 5F               4      LD  E,A
0009EB 49EB E1              10      POP HL
0009EC 49EC C1              10      POP BC
0009ED 49ED A7               4      AND A
0009EE 49EE C9              10      RET
                                
       49EF                     CLUST:
0009EF 49EF EB               4      EX  DE,HL
0009F0 49F0 C5              11      PUSH    BC
0009F1 49F1 CD954A          17      CALL    GET_DIR_POS
0009F4 49F4 87               4      ADD A,A
0009F5 49F5 3D               4      DEC A
0009F6 49F6 4F               4      LD  C,A
0009F7 49F7 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
0009FA 49FA 0F               4      RRCA
0009FB 49FB 0F               4      RRCA
0009FC 49FC 0F               4      RRCA
0009FD 49FD 0F               4      RRCA
0009FE 49FE 81               4      ADD A,C
0009FF 49FF C1              10      POP BC
000A00 4A00 29              11      ADD HL,HL   ;*2
000A01 4A01 29              11      ADD HL,HL   ;*4
000A02 4A02 85               4      ADD A,L
000A03 4A03 6F               4      LD  L,A
000A04 4A04 8C               4      ADC A,H
000A05 4A05 95               4      SUB L
000A06 4A06 67               4      LD  H,A
000A07 4A07 E5              11      PUSH    HL
000A08 4A08 29              11      ADD HL,HL
000A09 4A09 29              11      ADD HL,HL
000A0A 4A0A 29              11      ADD HL,HL
000A0B 4A0B CD374C          17      CALL    GET_DISK_BANK_FDRV
000A0E 4A0E 84               4      ADD A,H
000A0F 4A0F 320068          13      LD  (BANK1_SEL),A
000A12 4A12 321EF1          13      LD  (_BANK),A
000A15 4A15 E1              10      POP HL
000A16 4A16 3E1F             7      LD  A,01FH
000A18 4A18 A5               4      AND L
000A19 4A19 C660             7      ADD A,high BANK1_ADR
000A1B 4A1B 67               4      LD  H,A
000A1C 4A1C 2E00             7      LD  L,0
000A1E 4A1E EB               4      EX  DE,HL
000A1F 4A1F C9              10      RET
                                
       4A20                     ENDCL:
000A20 4A20 7A               4      LD  A,D ;END CLUSTER
000A21 4A21 FE0F             7      CP  00FH    ;FAT12の最大値
000A23 4A23 C0              11      RET NZ
000A24 4A24 7B               4      LD  A,E
000A25 4A25 FEF7             7      CP  0F7H
000A27 4A27 C9              10      RET
                                
       4A28                     RB_READ:
000A28 4A28 AF               4      XOR A   ;HLA = HL*128
000A29 4A29 CB3C             8      SRL H
000A2B 4A2B CB1D             8      RR  L
000A2D 4A2D 1F               4      RRA
000A2E 4A2E 321FF1          13      LD  (RR_LOW),A
000A31 4A31 2220F1          16      LD  (RR_MID),HL
000A34 4A34 218000          10      LD  HL,128
                                
000A37 4A37 CDAB46          17      CALL    ROM_READ
000A3A 4A3A C9              10      RET
                                
       4A3B                     GETSEQ:
000A3B 4A3B FD6E20          19      LD  L,(IY+32)
000A3E 4A3E FD660C          19      LD  H,(IY+12)
                                
000A41 4A41 CB25             8      SLA L
                                
000A43 4A43 CB3C             8      SRL H
000A45 4A45 CB1D             8      RR  L
000A47 4A47 C9              10      RET
                                
       4A48                     SETSEQ:
000A48 4A48 F5              11      PUSH    AF
000A49 4A49 3A1FF1          13      LD  A,(RR_LOW)
000A4C 4A4C 2A20F1          16      LD  HL,(RR_MID)
                                
000A4F 4A4F CD664A          17      CALL    SSQ1
                                
000A52 4A52 29              11      ADD HL,HL
000A53 4A53 CB3D             8      SRL L
000A55 4A55 FD7520          19      LD  (IY+32),L
000A58 4A58 FD740C          19      LD  (IY+12),H
000A5B 4A5B F1              10      POP AF
000A5C 4A5C C9              10      RET
                                
       4A5D                     GETSIZE:
000A5D 4A5D FD7E10          19      LD  A,(IY+16)
000A60 4A60 FD6E11          19      LD  L,(IY+17)
000A63 4A63 FD6612          19      LD  H,(IY+18)
       4A66                     SSQ1:
000A66 4A66 87               4      ADD A,A
000A67 4A67 ED6A            15      ADC HL,HL
000A69 4A69 B7               4      OR  A
000A6A 4A6A C8              11      RET Z
000A6B 4A6B 23               6      INC HL
000A6C 4A6C C9              10      RET
                                
       4A6D                     SET_FCB:
000A6D 4A6D D5              11      PUSH    DE
000A6E 4A6E FDE1            14      POP IY
000A70 4A70 FD7E1C          19      LD  A,(IY+28)
000A73 4A73 FEFF             7      CP  0FFH
000A75 4A75 200C            12      JR  NZ,POPAF_SCF_FF_RET
000A77 4A77 E5              11      PUSH    HL
000A78 4A78 FD6E1A          19      LD  L,(IY+26)
000A7B 4A7B FD661B          19      LD  H,(IY+27)
000A7E 4A7E 2223F1          16      LD  (_CLPS),HL
000A81 4A81 E1              10      POP HL
000A82 4A82 C9              10      RET
                                
       4A83                     POPAF_SCF_FF_RET:
000A83 4A83 F1              10      POP AF
000A84 4A84 37               4      SCF
000A85 4A85 9F               4      SBC A,A
000A86 4A86 C9              10      RET
                                
       4A87                     GET_DIR_DAT:
000A87 4A87 CD954A          17      CALL    GET_DIR_POS
000A8A 4A8A 87               4      ADD A,A         ;*2
000A8B 4A8B C660             7      ADD A,high BANK1_ADR
000A8D 4A8D 2E00             7      LD  L,0
000A8F 4A8F 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*512
000A90 4A90 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000A93 4A93 4F               4      LD  C,A
000A94 4A94 C9              10      RET
                                
       4A95                     GET_DIR_POS:
000A95 4A95 CD374C          17      CALL    GET_DISK_BANK_FDRV
000A98 4A98 320068          13      LD  (BANK1_SEL),A
000A9B 4A9B 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000A9E 4A9E 47               4      LD  B,A
000A9F 4A9F 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000AA2 4AA2 4F               4      LD  C,A
000AA3 4AA3 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4AA6                     GET_DIR_POS1:
000AA6 4AA6 81               4      ADD A,C
000AA7 4AA7 10FD            13      DJNZ    GET_DIR_POS1
000AA9 4AA9 C9              10      RET
                                
       4AAA                     WILDCARD:
000AAA 4AAA 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4AB5                     ERROR_WRITE_PROTECTED:
000AB5 4AB5 3E00             7      LD  A,0     ;Write protected
000AB7 4AB7 C9              10      RET
       4AB8                     DISKIO:
000AB8 4AB8 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000ABA 4ABA 48               4      LD  C,B
000ABB 4ABB CD414C          17      CALL    GET_DISK_BANK
       4ABE                     SETMAP1:        
000ABE 4ABE E5              11      PUSH    HL
       4ABF                     DISKIO1:
000ABF 4ABF C5              11      PUSH    BC      ;B=残りのセクタ数
000AC0 4AC0 D5              11      PUSH    DE      ;DE=セクタ番号
000AC1 4AC1 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
000AC2 4AC2 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
000AC3 4AC3 29              11      ADD HL,HL
000AC4 4AC4 4D               4      LD  C,L     ;C=読み出し元(セクタ番号*2)※1セクタ512バイトなので倍にしておく
000AC5 4AC5 29              11      ADD HL,HL       ;64KB→32KB
000AC6 4AC6 29              11      ADD HL,HL       ;32KB→16KB
000AC7 4AC7 29              11      ADD HL,HL       ;16KB→8KB
000AC8 4AC8 84               4      ADD A,H
000AC9 4AC9 320068          13      LD  (BANK1_SEL),A   ;ASCII-8K/Konami-8K共通で使える
000ACC 4ACC 321EF1          13      LD  (_BANK),A
000ACF 4ACF 79               4      LD  A,C     ;C=読み出し元
000AD0 4AD0 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F/16K:3F)
000AD2 4AD2 C660             7      ADD A,high BANK1_ADR
000AD4 4AD4 67               4      LD  H,A
000AD5 4AD5 010002          10      LD  BC,00200H   ;BCは読み出すセクタサイズ(512バイト)
000AD8 4AD8 69               4      LD  L,C     ;C=0
000AD9 4AD9 EDB0                    LDIR
000ADB 4ADB EB               4      EX  DE,HL
000ADC 4ADC F1              10      POP AF
000ADD 4ADD D1              10      POP DE
000ADE 4ADE 13               6      INC DE
000ADF 4ADF C1              10      POP BC
000AE0 4AE0 10DD            13      DJNZ    DISKIO1
000AE2 4AE2 41               4      LD  B,C
                                
000AE3 4AE3 E1              10      POP HL
000AE4 4AE4 AF               4      XOR A
000AE5 4AE5 FB               4      EI
000AE6 4AE6 C9              10      RET
                                
       4AE7                     DSKCHG:
000AE7 4AE7 CD204B          17      CALL    IS_BPB
000AEA 4AEA 3824            12      JR  C,NOTREADY
000AEC 4AEC 3A23FB          13      LD  A,(DRVTBL+2)
000AEF 4AEF B7               4      OR  A
000AF0 4AF0 201A            12      JR  NZ,DSKCHG1
000AF2 4AF2 3A21FB          13      LD  A,(DRVTBL)
000AF5 4AF5 FE02             7      CP  2
000AF7 4AF7 2013            12      JR  NZ,DSKCHG1
000AF9 4AF9 CD204B          17      CALL    IS_BPB
000AFC 4AFC 300E            12      JR  NC,DSKCHG1
000AFE 4AFE 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000B00 4B00 3221FB          13      LD  (DRVTBL),A
000B03 4B03 3223FB          13      LD  (DRVTBL+2),A
000B06 4B06 3A48F3          13      LD  A,(MASTERS)
000B09 4B09 3224FB          13      LD  (DRVTBL+3),A
       4B0C                     DSKCHG1:
000B0C 4B0C AF               4      XOR A
000B0D 4B0D 0601             7      LD  B,1
000B0F 4B0F C9              10      RET
       4B10                     NOTREADY:
000B10 4B10 3E02             7      LD  A,2
000B12 4B12 37               4      SCF
000B13 4B13 C9              10      RET
                                
       4B14                     NO_BPB:
000B14 4B14 E1              10      POP HL
000B15 4B15 23               6      INC HL
000B16 4B16 11494C          10      LD  DE,DPB2DD
000B19 4B19 011200          10      LD  BC,DPB2DD_E-DPB2DD
000B1C 4B1C EDB0                    LDIR
000B1E 4B1E AF               4      XOR A
000B1F 4B1F C9              10      RET
                                
       4B20                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000B20 4B20 CD414C          17      CALL    GET_DISK_BANK
000B23 4B23 320068          13      LD  (BANK1_SEL),A
                                
000B26 4B26 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000B29 4B29 FE01             7      CP  1
000B2B 4B2B D8              11      RET C
                                
000B2C 4B2C 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000B2F 4B2F C6FF             7      ADD A,0FFH
000B31 4B31 D8              11      RET C
                                
000B32 4B32 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
000B35 4B35 FE02             7      CP  2
000B37 4B37 C8              11      RET Z
000B38 4B38 FE04             7      CP  4
000B3A 4B3A C8              11      RET Z
000B3B 4B3B 37               4      SCF
000B3C 4B3C C9              10      RET
                                
       4B3D                     GETDPB:
000B3D 4B3D E5              11      PUSH    HL
000B3E 4B3E CD414C          17      CALL    GET_DISK_BANK
000B41 4B41 320068          13      LD  (BANK1_SEL),A
                                
000B44 4B44 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000B47 4B47 B7               4      OR  A
000B48 4B48 28CA            12      JR  Z,NO_BPB
000B4A 4B4A DDE1            14      POP IX
000B4C 4B4C DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000B4F 4B4F 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000B52 4B52 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000B55 4B55 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000B58 4B58 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000B5B 4B5B 87               4      ADD A,A
000B5C 4B5C 87               4      ADD A,A
000B5D 4B5D 87               4      ADD A,A
000B5E 4B5E 3D               4      DEC A
000B5F 4B5F DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000B62 4B62 06FF             7      LD  B,-1
000B64 4B64 A7               4      AND A           ;無限ループ阻止
       4B65                     GETDPB1:
000B65 4B65 04               4      INC B
000B66 4B66 1F               4      RRA
000B67 4B67 38FC            12      JR  C,GETDPB1
000B69 4B69 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000B6C 4B6C 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus 
000B6F 4B6F 3D               4      DEC A
000B70 4B70 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000B73 4B73 A7               4      AND A           ;無限ループ阻止
000B74 4B74 06FF             7      LD  B,-1
       4B76                     GETDPB2:
000B76 4B76 04               4      INC B
000B77 4B77 1F               4      RRA
000B78 4B78 38FC            12      JR  C,GETDPB2
000B7A 4B7A 04               4      INC B
000B7B 4B7B DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000B7E 4B7E 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
000B81 4B81 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
000B84 4B84 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
000B87 4B87 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
000B8A 4B8A DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000B8D 4B8D 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
000B90 4B90 DD770B          19      LD  (IX+11),A       ;FATCNT
                                
000B93 4B93 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
000B97 4B97 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
000B9A 4B9A DD460A          19      LD  B,(IX+10)       ;FATCNT
000B9D 4B9D 210000          10      LD  HL,0
       4BA0                     GETDPB3:
000BA0 4BA0 19              11      ADD HL,DE
000BA1 4BA1 10FD            13      DJNZ    GETDPB3
       4BA3                     GETDPB4:
000BA3 4BA3 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
000BA6 4BA6 DD5609          19      LD  D,(IX+9)        ;FIRFAT
000BA9 4BA9 19              11      ADD HL,DE
000BAA 4BAA DD7511          19      LD  (IX+17),L       ;FIRDIR
000BAD 4BAD DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000BB0 4BB0 3E08             7      LD  A,2*4           ;SECSIZ HIGH
000BB2 4BB2 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4BB5                     GETDPB5:
000BB5 4BB5 CB3B             8      SRL E
000BB7 4BB7 1F               4      RRA
000BB8 4BB8 30FB            12      JR  NC,GETDPB5
000BBA 4BBA 1600             7      LD  D,0
000BBC 4BBC 19              11      ADD HL,DE
000BBD 4BBD DD750C          19      LD  (IX+12),L       ;FIRREC
000BC0 4BC0 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000BC3 4BC3 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
000BC6 4BC6 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
000BC9 4BC9 DD560D          19      LD  D,(IX+13)       ;FIRREC
000BCC 4BCC A7               4      AND A
000BCD 4BCD ED52            15      SBC HL,DE
                                
000BCF 4BCF DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
000BD2 4BD2 3C               4      INC A
000BD3 4BD3 37               4      SCF             ;無限ループ阻止
       4BD4                     GETDPB6:
000BD4 4BD4 1F               4      RRA
000BD5 4BD5 3806            12      JR  C,GETDPB7
000BD7 4BD7 CB3C             8      SRL H
000BD9 4BD9 CB1D             8      RR  L
000BDB 4BDB 18F7            12      JR  GETDPB6
       4BDD                     GETDPB7:
000BDD 4BDD 23               6      INC HL
000BDE 4BDE DD750E          19      LD  (IX+14),L       ;MAXCLUS
000BE1 4BE1 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       4BE4                     GETDPBD1:
000BE4 4BE4 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000BE7 4BE7 E6FC             7      AND 0FCH
000BE9 4BE9 C8              11      RET Z
                                
000BEA 4BEA DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
000BEE 4BEE 37               4      SCF
000BEF 4BEF DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
000BF3 4BF3 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
000BF6 4BF6 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
000BFA 4BFA DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
000BFE 4BFE DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
000C02 4C02 DDCB1126        23      SLA (IX+17)         ;FIRDIR
000C06 4C06 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
000C0A 4C0A DD6E11          19      LD  L,(IX+17)       ;FIRDIR
000C0D 4C0D DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
000C10 4C10 3E08             7      LD  A,2*4           ;SECSIZ HIGH
000C12 4C12 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4C15                     GETDPBD5:
000C15 4C15 CB3B             8      SRL E
000C17 4C17 1F               4      RRA
000C18 4C18 30FB            12      JR  NC,GETDPBD5
000C1A 4C1A 1600             7      LD  D,0
000C1C 4C1C 19              11      ADD HL,DE
000C1D 4C1D DD750C          19      LD  (IX+12),L       ;FIRREC
000C20 4C20 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000C23 4C23 18BF            12      JR  GETDPBD1
                                
       4C25                     CHOICE:
000C25 4C25 210000          10      LD  HL,0
000C28 4C28 C9              10      RET
                                
       4C29                     DSKFMT:
000C29 4C29 AF               4      XOR A
000C2A 4C2A 37               4      SCF
       4C2B                     DSKSTP:
000C2B 4C2B C9              10      RET
                                
       4C2C                     BASENT:
000C2C 4C2C ED7B52F1        20      LD  SP,(BASSTK)
000C30 4C30 C3AA43          10      JP  BASAUTO
                                
       4C33                     GETSLT:
000C33 4C33 3A22FB          13      LD  A,(DRVTBL+1)
000C36 4C36 C9              10      RET
                                
       4C37                     GET_DISK_BANK_FDRV:
000C37 4C37 3A46F1          13      LD  A,(FDRV)
000C3A 4C3A D601             7      SUB 1
000C3C 4C3C 3003            12      JR  NC,GET_DISK_BANK
000C3E 4C3E 3A3DF1          13      LD  A,(_DVSW)
       4C41                     GET_DISK_BANK:
000C41 4C41 B7               4      OR  A       ;A=DRIVE
000C42 4C42 3E01             7      LD  A,DISK_BANK
000C44 4C44 C8              11      RET Z
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
000C45 4C45 3A3CF1          13      LD  A,(B_DRIVE)
                                #endif
000C48 4C48 C9              10      RET
                                
       4C49                     DPB2DD:
000C49 4C49 F9                      DB  0F9H    ;MEDIA
000C4A 4C4A 0002                    DW  00200H  ;SECSIZ
000C4C 4C4C 0F                      DB  00FH    ;DIRMSK
000C4D 4C4D 04                      DB  004H    ;DIRSHFT
000C4E 4C4E 01                      DB  001H    ;CLUSMSK
000C4F 4C4F 02                      DB  002H    ;CLUSSHFT
000C50 4C50 0100                    DW  00001H  ;FIRFAT
000C52 4C52 02                      DB  002H    ;FATCNT
000C53 4C53 70                      DB  070H    ;MAXENT
000C54 4C54 0E00                    DW  0000EH  ;FIRREC
000C56 4C56 CA02                    DW  002CAH  ;MAXCLUS
000C58 4C58 03                      DB  003H    ;FATSIZ
000C59 4C59 0700                    DW  0007H   ;FIRDIR
       4C5B                     DPB2DD_E:
                                
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       4C5B                     POP_HL_ERROR:
000C5B 4C5B E1              10      POP     HL
       4C5C                     _ERROR:
000C5C 4C5C 0600             7      LD  B,0
000C5E 4C5E A7               4      AND A
000C5F 4C5F C9              10      RET
                                
       4C60                     ROM_BDOS:
000C60 4C60 E5              11      PUSH    HL
000C61 4C61 79               4      LD  A,C
000C62 4C62 87               4      ADD A,A
000C63 4C63 38F7            12      JR  C,_ERROR
000C65 4C65 6F               4      LD  L,A
000C66 4C66 265F             7      LD  H,high STABLE
000C68 4C68 7E               7      LD  A,(HL)
000C69 4C69 2C               4      INC L
000C6A 4C6A 66               7      LD  H,(HL)
000C6B 4C6B 6F               4      LD  L,A
000C6C 4C6C E3              19      EX  (SP),HL
000C6D 4C6D 79               4      LD  A,C
000C6E 4C6E C9              10      RET
                                
       4C6F                     _PRINT:
       4C6F                     PRINT:
000C6F 4C6F 7B               4      LD  A,E
000C70 4C70 1803            12      JR  MSG_A
                                
       4C72                     _SYS01:     ;(BDOS)コンソール入力
000C72 4C72 CDE94C          17      CALL    _SYS07
       4C75                     MSG_A:
000C75 4C75 FE03             7      CP  3
000C77 4C77 2814            12      JR  Z,MSG_BR
       4C79                     MSGA1:
000C79 4C79 F5              11      PUSH    AF
000C7A 4C7A C5              11      PUSH    BC
000C7B 4C7B D5              11      PUSH    DE
000C7C 4C7C E5              11      PUSH    HL
000C7D 4C7D DDE5            15      PUSH    IX
000C7F 4C7F DD21A200        14      LD  IX,CHPUT
000C83 4C83 CDE142          17      CALL    CALSLT_R
000C86 4C86 DDE1            14      POP IX
000C88 4C88 E1              10      POP HL
000C89 4C89 D1              10      POP DE
000C8A 4C8A C1              10      POP BC
       4C8B                     MSGA2:
000C8B 4C8B F1              10      POP AF
000C8C 4C8C C9              10      RET
       4C8D                     MSG_BR:
000C8D 4C8D F5              11      PUSH    AF
000C8E 4C8E 3ADDF3          13      LD  A,(CSRX)
000C91 4C91 FE02             7      CP  2
000C93 4C93 38F6            12      JR  C,MSGA2
000C95 4C95 F1              10      POP AF
       4C96                     MSG_CR:
000C96 4C96 F5              11      PUSH    AF
000C97 4C97 3E0D             7      LD  A,00DH
000C99 4C99 CD794C          17      CALL    MSGA1
000C9C 4C9C 3E0A             7      LD  A,00AH
000C9E 4C9E CD794C          17      CALL    MSGA1
000CA1 4CA1 F1              10      POP AF
000CA2 4CA2 C9              10      RET
                                
       4CA3                     _SYS02:     ;(BDOS)コンソール出力
000CA3 4CA3 CDBE4C          17      CALL    BREAK
000CA6 4CA6 1805            12      JR  PRINTX
                                
       4CA8                     _SYS06:     ;(BDOS)コンソール直接入出力
000CA8 4CA8 7B               4      LD  A,E
000CA9 4CA9 3C               4      INC A
000CAA 4CAA CAFD4C          10      JP  Z,_INKEY
       4CAD                     PRINTX:
000CAD 4CAD C36F4C          10      JP  _PRINT
                                
       4CB0                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000CB0 4CB0 CDE94C          17      CALL    _SYS07
000CB3 4CB3 FE03             7      CP  3
000CB5 4CB5 CCBE4C          17      CALL    Z,_BREAK
000CB8 4CB8 FE13             7      CP  013H        ;CTRL+S
000CBA 4CBA C0              11      RET NZ
       4CBB                     PAUSE:
000CBB 4CBB CDD54C          17      CALL    KEYBC
                                
       4CBE                     _BREAK:
       4CBE                     BREAK:
000CBE 4CBE F5              11      PUSH    AF
000CBF 4CBF C5              11      PUSH    BC
000CC0 4CC0 D5              11      PUSH    DE
000CC1 4CC1 E5              11      PUSH    HL
000CC2 4CC2 DDE5            15      PUSH    IX
000CC4 4CC4 DD21B700        14      LD  IX,BREAKX
000CC8 4CC8 CDE142          17      CALL    CALSLT_R
000CCB 4CCB DDE1            14      POP IX
000CCD 4CCD E1              10      POP HL
000CCE 4CCE D1              10      POP DE
000CCF 4CCF C1              10      POP BC
000CD0 4CD0 DCBE4C          17      CALL    C,_BREAK
000CD3 4CD3 F1              10      POP AF
000CD4 4CD4 C9              10      RET
       4CD5                     KEYBC:
000CD5 4CD5 F5              11      PUSH    AF
000CD6 4CD6 C5              11      PUSH    BC
000CD7 4CD7 D5              11      PUSH    DE
000CD8 4CD8 E5              11      PUSH    HL
000CD9 4CD9 DDE5            15      PUSH    IX
000CDB 4CDB DD215601        14      LD  IX,KILBUF
000CDF 4CDF CDE142          17      CALL    CALSLT_R
000CE2 4CE2 DDE1            14      POP IX
000CE4 4CE4 E1              10      POP HL
000CE5 4CE5 D1              10      POP DE
000CE6 4CE6 C1              10      POP BC
000CE7 4CE7 F1              10      POP AF
000CE8 4CE8 C9              10      RET
                                
       4CE9                     _SYS07:
       4CE9                     FLGET:
000CE9 4CE9 C5              11      PUSH    BC
000CEA 4CEA D5              11      PUSH    DE
000CEB 4CEB E5              11      PUSH    HL
000CEC 4CEC DDE5            15      PUSH    IX
000CEE 4CEE DD219F00        14      LD  IX,CHGET
000CF2 4CF2 CDE142          17      CALL    CALSLT_R
000CF5 4CF5 DDE1            14      POP IX
000CF7 4CF7 E1              10      POP HL
000CF8 4CF8 D1              10      POP DE
000CF9 4CF9 C1              10      POP BC
000CFA 4CFA FE03             7      CP  3
000CFC 4CFC C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       4CFD                     _INKEY:
       4CFD                     INKEY:
000CFD 4CFD CD974D          17      CALL    CPM_CONST
000D00 4D00 C8              11      RET Z
000D01 4D01 18E6            12      JR  FLGET
                                
       4D03                     _SYS0A:     ;(BDOS)文字列入力
000D03 4D03 C5              11      PUSH    BC
000D04 4D04 E5              11      PUSH    HL
000D05 4D05 D5              11      PUSH    DE
000D06 4D06 CD2F4D          17      CALL    GETL
000D09 4D09 111FF4          10      LD  DE,KBUF
000D0C 4D0C E1              10      POP HL
000D0D 4D0D E5              11      PUSH    HL
000D0E 4D0E 0E00             7      LD  C,0
000D10 4D10 3004            12      JR  NC,SAX0
000D12 4D12 23               6      INC HL
000D13 4D13 23               6      INC HL
000D14 4D14 1808            12      JR  SAX4
       4D16                     SAX0:
000D16 4D16 46               7      LD  B,(HL)
000D17 4D17 23               6      INC HL
       4D18                     SAX1:
000D18 4D18 23               6      INC HL
000D19 4D19 1A               7      LD  A,(DE)
000D1A 4D1A 13               6      INC DE
000D1B 4D1B B7               4      OR  A
000D1C 4D1C 2004            12      JR  NZ,SAX2
       4D1E                     SAX4:
000D1E 4D1E 360D            10      LD  (HL),00DH
000D20 4D20 1804            12      JR  SAX3
       4D22                     SAX2:
000D22 4D22 77               7      LD  (HL),A
000D23 4D23 0C               4      INC C
000D24 4D24 10F2            13      DJNZ    SAX1
       4D26                     SAX3:
000D26 4D26 D1              10      POP DE
000D27 4D27 79               4      LD  A,C
000D28 4D28 13               6      INC DE
000D29 4D29 12               7      LD  (DE),A
000D2A 4D2A 1B               6      DEC DE
000D2B 4D2B E1              10      POP HL
000D2C 4D2C C1              10      POP BC
000D2D 4D2D A7               4      AND A
000D2E 4D2E C9              10      RET
       4D2F                     GETL:
000D2F 4D2F DDE5            15      PUSH    IX
000D31 4D31 FDE5            15      PUSH    IY
                                
000D33 4D33 2ADCF3          16      LD  HL,(CSRY)
000D36 4D36 22CAFB          16      LD  (FSTPOS),HL
       4D39                     GETL1:
000D39 4D39 CDB04C          17      CALL    _SYS08
000D3C 4D3C FE09             7      CP  9
000D3E 4D3E 2008            12      JR  NZ,GETL1V
000D40 4D40 211FF4          10      LD  HL,KBUF
000D43 4D43 CD5C43          17      CALL    MSX
000D46 4D46 18F1            12      JR  GETL1
       4D48                     GETL1V:
000D48 4D48 5F               4      LD  E,A
000D49 4D49 FE08             7      CP  8
000D4B 4D4B CCE54D          17      CALL    Z,CTRL02
000D4E 4D4E FE20             7      CP  020H
000D50 4D50 D4114E          17      CALL    NC,INSERT
000D53 4D53 CD794C          17      CALL    MSGA1
                                
000D56 4D56 7B               4      LD  A,E
000D57 4D57 FE0D             7      CP  00DH
000D59 4D59 20DE            12      JR  NZ,GETL1
                                
000D5B 4D5B 111FF4          10      LD  DE,KBUF
000D5E 4D5E 3AB0F3          13      LD  A,(LINLEN)
000D61 4D61 47               4      LD  B,A
000D62 4D62 CDC14F          17      CALL    ZERO_MEMORY_DE
                                
000D65 4D65 2ACAFB          16      LD  HL,(FSTPOS)
000D68 4D68 3ADCF3          13      LD  A,(CSRY)
000D6B 4D6B 6F               4      LD  L,A
000D6C 4D6C E5              11      PUSH    HL
000D6D 4D6D CD424E          17      CALL    LOC0
000D70 4D70 4D               4      LD  C,L
000D71 4D71 44               4      LD  B,H
000D72 4D72 E1              10      POP HL
000D73 4D73 3AB0F3          13      LD  A,(LINLEN)
000D76 4D76 94               4      SUB H
000D77 4D77 3D               4      DEC A
000D78 4D78 5F               4      LD  E,A
000D79 4D79 211FF4          10      LD  HL,KBUF
       4D7C                     GETL2:
000D7C 4D7C CDD54D          17      CALL    _SCRN
000D7F 4D7F 03               6      INC BC
000D80 4D80 77               7      LD  (HL),A
000D81 4D81 23               6      INC HL
000D82 4D82 1D               4      DEC E
000D83 4D83 20F7            12      JR  NZ,GETL2
000D85 4D85 CD964C          17      CALL    MSG_CR
                                
000D88 4D88 FDE1            14      POP IY
000D8A 4D8A DDE1            14      POP IX
       4D8C                     GETL3:
000D8C 4D8C 2B               6      DEC HL
000D8D 4D8D 7E               7      LD  A,(HL)
000D8E 4D8E FE21             7      CP  021H
000D90 4D90 D0              11      RET NC
000D91 4D91 3600            10      LD  (HL),0
000D93 4D93 15               4      DEC D
000D94 4D94 20F6            12      JR  NZ,GETL3
000D96 4D96 C9              10      RET
                                
       4D97                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       4D97                     CONSTX:
       4D97                     CPM_CONST:
000D97 4D97 C5              11      PUSH    BC
000D98 4D98 D5              11      PUSH    DE
000D99 4D99 E5              11      PUSH    HL
000D9A 4D9A DDE5            15      PUSH    IX
000D9C 4D9C DD219C00        14      LD  IX,CHSNS
000DA0 4DA0 CDE142          17      CALL    CALSLT_R
000DA3 4DA3 DDE1            14      POP IX
000DA5 4DA5 E1              10      POP HL
000DA6 4DA6 D1              10      POP DE
000DA7 4DA7 C1              10      POP BC
000DA8 4DA8 C9              10      RET
                                
       4DA9                     _SYS2A:     ;(BDOS)日付の獲得
000DA9 4DA9 AF               4      XOR A
000DAA 4DAA 57               4      LD  D,A
000DAB 4DAB 5F               4      LD  E,A
000DAC 4DAC 67               4      LD  H,A
000DAD 4DAD 6F               4      LD  L,A
000DAE 4DAE C9              10      RET
                                
       4DAF                     _SYS2C:     ;(BDOS)時刻の獲得
000DAF 4DAF AF               4      XOR A
000DB0 4DB0 57               4      LD  D,A
000DB1 4DB1 5F               4      LD  E,A
000DB2 4DB2 67               4      LD  H,A
000DB3 4DB3 6F               4      LD  L,A
000DB4 4DB4 C9              10      RET
                                
       4DB5                     POS:
000DB5 4DB5 F5              11      PUSH    AF
000DB6 4DB6 2ADCF3          16      LD  HL,(CSRY)
000DB9 4DB9 7D               4      LD  A,L
000DBA 4DBA 6C               4      LD  L,H
000DBB 4DBB 67               4      LD  H,A
000DBC 4DBC 2C               4      INC L
000DBD 4DBD 24               4      INC H
000DBE 4DBE F1              10      POP AF
000DBF 4DBF C9              10      RET
                                
       4DC0                     LOC:
000DC0 4DC0 F5              11      PUSH    AF
000DC1 4DC1 E5              11      PUSH    HL
000DC2 4DC2 7D               4      LD  A,L
000DC3 4DC3 6C               4      LD  L,H
000DC4 4DC4 67               4      LD  H,A
000DC5 4DC5 2D               4      DEC L
000DC6 4DC6 25               4      DEC H
000DC7 4DC7 DDE5            15      PUSH    IX
000DC9 4DC9 DD21C600        14      LD  IX,POSIT
000DCD 4DCD CDE142          17      CALL    CALSLT_R
000DD0 4DD0 DDE1            14      POP IX
000DD2 4DD2 E1              10      POP HL
000DD3 4DD3 F1              10      POP AF
000DD4 4DD4 C9              10      RET
                                
       4DD5                     _SCRN:
       4DD5                     SCRN:
000DD5 4DD5 E5              11      PUSH    HL
000DD6 4DD6 DDE5            15      PUSH    IX
                                
000DD8 4DD8 69               4      LD  L,C
000DD9 4DD9 60               4      LD  H,B
000DDA 4DDA DD214A00        14      LD  IX,RDVRM
000DDE 4DDE CDE142          17      CALL    CALSLT_R
                                
000DE1 4DE1 DDE1            14      POP IX
000DE3 4DE3 E1              10      POP HL
000DE4 4DE4 C9              10      RET
                                
       4DE5                     CTRL02:
000DE5 4DE5 F5              11      PUSH    AF
000DE6 4DE6 D5              11      PUSH    DE
000DE7 4DE7 2ADCF3          16      LD  HL,(CSRY)
000DEA 4DEA 3AB0F3          13      LD  A,(LINLEN)
000DED 4DED 4F               4      LD  C,A
000DEE 4DEE 94               4      SUB H   ;CSRX
000DEF 4DEF C602             7      ADD A,2
000DF1 4DF1 47               4      LD  B,A ;カーソルより右の文字数
000DF2 4DF2 61               4      LD  H,C ;LINLEN
000DF3 4DF3 C5              11      PUSH    BC
000DF4 4DF4 CD424E          17      CALL    LOC0
000DF7 4DF7 C1              10      POP BC
                                
000DF8 4DF8 1620             7      LD  D,020H
       4DFA                     C8X1:
000DFA 4DFA DD214A00        14      LD  IX,RDVRM
000DFE 4DFE CDE142          17      CALL    CALSLT_R
000E01 4E01 4F               4      LD  C,A
000E02 4E02 7A               4      LD  A,D
000E03 4E03 DD214D00        14      LD  IX,WRTVRM
000E07 4E07 CDE142          17      CALL    CALSLT_R
000E0A 4E0A 2B               6      DEC HL
000E0B 4E0B 51               4      LD  D,C
000E0C 4E0C 10EC            13      DJNZ    C8X1
000E0E 4E0E D1              10      POP DE
000E0F 4E0F F1              10      POP AF
000E10 4E10 C9              10      RET
                                
       4E11                     INSERT:
000E11 4E11 F5              11      PUSH    AF
000E12 4E12 D5              11      PUSH    DE
000E13 4E13 2ADCF3          16      LD  HL,(CSRY)
000E16 4E16 3AB0F3          13      LD  A,(LINLEN)
000E19 4E19 4F               4      LD  C,A
000E1A 4E1A 94               4      SUB H   ;CSRX
000E1B 4E1B 3C               4      INC A
000E1C 4E1C 47               4      LD  B,A ;カーソルより右の文字数
000E1D 4E1D C5              11      PUSH    BC
000E1E 4E1E CD424E          17      CALL    LOC0
000E21 4E21 C1              10      POP BC
                                
000E22 4E22 1620             7      LD  D,020H
       4E24                     INS1:
000E24 4E24 DD214A00        14      LD  IX,RDVRM
000E28 4E28 CDE142          17      CALL    CALSLT_R
000E2B 4E2B 4F               4      LD  C,A
000E2C 4E2C 7A               4      LD  A,D
000E2D 4E2D DD214D00        14      LD  IX,WRTVRM
000E31 4E31 CDE142          17      CALL    CALSLT_R
000E34 4E34 23               6      INC HL
000E35 4E35 51               4      LD  D,C
000E36 4E36 10EC            13      DJNZ    INS1
000E38 4E38 D1              10      POP DE
000E39 4E39 F1              10      POP AF
000E3A 4E3A C9              10      RET
                                
       4E3B                     CONOUT1:
000E3B 4E3B 59               4      LD  E,C
000E3C 4E3C C36F4C          10      JP  _PRINT
                                
       4E3F                     GETVRAM:
000E3F 4E3F 2ADCF3          16      LD  HL,(CSRY)
       4E42                     LOC0:
000E42 4E42 2D               4      DEC L
000E43 4E43 25               4      DEC H
000E44 4E44 4C               4      LD  C,H ;CSRX-1
000E45 4E45 5D               4      LD  E,L ;CSRY-1
       4E46                     LOC1:
000E46 4E46 3AB0F3          13      LD  A,(LINLEN)
000E49 4E49 67               4      LD  H,A
000E4A 4E4A 1600             7      LD  D,0
000E4C 4E4C 6A               4      LD  L,D ;0
000E4D 4E4D 0608             7      LD  B,8
       4E4F                     LOC2:
000E4F 4E4F 29              11      ADD HL,HL
000E50 4E50 3001            12      JR  NC,LOC3
000E52 4E52 19              11      ADD HL,DE
       4E53                     LOC3:
000E53 4E53 10FA            13      DJNZ    LOC2
000E55 4E55 09              11      ADD HL,BC
000E56 4E56 C9              10      RET
                                
       4E57                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000E57 4E57 212200          10      LD  HL,00022H
000E5A 4E5A AF               4      XOR A
000E5B 4E5B 7D               4      LD  A,L
000E5C 4E5C C9              10      RET
                                
       4E5D                     _SYS0D:     ;(BDOS)ディスク・リセット
000E5D 4E5D 218000          10      LD  HL,00080H
000E60 4E60 2229F1          16      LD  (_DTA),HL
000E63 4E63 C9              10      RET
                                
       4E64                     _SYS0E:     ;(BDOS)カレントドライブの設定
000E64 4E64 323DF1          13      LD  (_DVSW),A
000E67 4E67 C9              10      RET
                                
       4E68                     _SYS0F:     ;(BDOS)ファイルのオープン
000E68 4E68 D5              11      PUSH    DE
000E69 4E69 FDE1            14      POP IY
000E6B 4E6B CDB14F          17      CALL    INIT_FILE
000E6E 4E6E CD8048          17      CALL    ROM_OPEN
000E71 4E71 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
000E73 4E73 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
000E77 4E77 FDE5            15      PUSH    IY
000E79 4E79 D1              10      POP DE
000E7A 4E7A 13               6      INC DE
000E7B 4E7B 010B00          10      LD  BC,11
000E7E 4E7E EDB0                    LDIR
                                ;               Attribute
000E80 4E80 7E               7      LD  A,(HL)
000E81 4E81 FD770D          19      LD  (IY+13),A
                                ;               TIME
000E84 4E84 110B00          10      LD  DE,11
000E87 4E87 19              11      ADD HL,DE
000E88 4E88 7E               7      LD  A,(HL)
000E89 4E89 23               6      INC HL
000E8A 4E8A FD7716          19      LD  (IY+22),A
000E8D 4E8D 7E               7      LD  A,(HL)
000E8E 4E8E 23               6      INC HL
000E8F 4E8F FD7717          19      LD  (IY+23),A
                                ;               DATE
000E92 4E92 7E               7      LD  A,(HL)
000E93 4E93 23               6      INC HL
000E94 4E94 FD7714          19      LD  (IY+20),A
000E97 4E97 7E               7      LD  A,(HL)
000E98 4E98 23               6      INC HL
000E99 4E99 FD7715          19      LD  (IY+21),A
                                ;               First cluster
000E9C 4E9C 7E               7      LD  A,(HL)
000E9D 4E9D 23               6      INC HL
000E9E 4E9E FD771A          19      LD  (IY+26),A
000EA1 4EA1 7E               7      LD  A,(HL)
000EA2 4EA2 23               6      INC HL
000EA3 4EA3 FD771B          19      LD  (IY+27),A
                                ;               SIZE
000EA6 4EA6 7E               7      LD  A,(HL)
000EA7 4EA7 23               6      INC HL
000EA8 4EA8 FD7710          19      LD  (IY+16),A
000EAB 4EAB 7E               7      LD  A,(HL)
000EAC 4EAC 23               6      INC HL
000EAD 4EAD FD7711          19      LD  (IY+17),A
000EB0 4EB0 7E               7      LD  A,(HL)
000EB1 4EB1 23               6      INC HL
000EB2 4EB2 FD7712          19      LD  (IY+18),A
000EB5 4EB5 7E               7      LD  A,(HL)
000EB6 4EB6 FD7713          19      LD  (IY+19),A
000EB9 4EB9 AF               4      XOR A
000EBA 4EBA FD770C          19      LD  (IY+12),A
000EBD 4EBD C9              10      RET
                                
       4EBE                     _SYS10:     ;(BDOS)ファイルのクローズ
000EBE 4EBE AF               4      XOR A
000EBF 4EBF C9              10      RET
                                
       4EC0                     S11X1:
000EC0 4EC0 FD7119          19      LD  (IY+25),C       ;RootEntCnt
000EC3 4EC3 FD750E          19      LD  (IY+14),L
000EC6 4EC6 FD740F          19      LD  (IY+15),H
       4EC9                     SCF_FF_RET:
000EC9 4EC9 37               4      SCF
000ECA 4ECA 9F               4      SBC A,A
000ECB 4ECB C9              10      RET
                                
       4ECC                     _SYS11:     ;(BDOS)最初のファイルの検索
000ECC 4ECC ED5331F1        20      LD  (_FCB),DE
000ED0 4ED0 D5              11      PUSH    DE
000ED1 4ED1 FDE1            14      POP IY
000ED3 4ED3 CDB14F          17      CALL    INIT_FILE
000ED6 4ED6 CD874A          17      CALL    GET_DIR_DAT
       4ED9                     S12X1:
000ED9 4ED9 CD9F48          17      CALL    FILESE
000EDC 4EDC 30E2            12      JR  NC,S11X1
000EDE 4EDE 0D               4      DEC C
000EDF 4EDF FD7119          19      LD  (IY+25),C       ;RootEntCnt
000EE2 4EE2 012000          10      LD  BC,32
000EE5 4EE5 ED5B29F1        20      LD  DE,(_DTA)
000EE9 4EE9 AF               4      XOR A
000EEA 4EEA 12               7      LD  (DE),A      ;ドライブ番号
000EEB 4EEB 13               6      INC DE
000EEC 4EEC EDB0                    LDIR            ;ディレクトリエントリ
000EEE 4EEE FD750E          19      LD  (IY+14),L
000EF1 4EF1 FD740F          19      LD  (IY+15),H
000EF4 4EF4 C9              10      RET
                                
       4EF5                     _SYS12:
000EF5 4EF5 FD2A31F1        20      LD  IY,(_FCB)
000EF9 4EF9 FDE5            15      PUSH    IY
000EFB 4EFB D1              10      POP DE
000EFC 4EFC CDB14F          17      CALL    INIT_FILE
                                
000EFF 4EFF FD6E0E          19      LD  L,(IY+14)
000F02 4F02 FD660F          19      LD  H,(IY+15)
000F05 4F05 FD4E19          19      LD  C,(IY+25)
000F08 4F08 18CF            12      JR  S12X1
                                
       4F0A                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000F0A 4F0A CD6D4A          17      CALL    SET_FCB
000F0D 4F0D CD3B4A          17      CALL    GETSEQ
000F10 4F10 CD284A          17      CALL    RB_READ
000F13 4F13 E5              11      PUSH    HL
000F14 4F14 CD484A          17      CALL    SETSEQ
000F17 4F17 E1              10      POP HL
       4F18                     SREAD:
000F18 4F18 C601             7      ADD A,001H
000F1A 4F1A D8              11      RET C
                                
000F1B 4F1B 7D               4      LD  A,L
000F1C 4F1C D601             7      SUB 001H
000F1E 4F1E 9F               4      SBC A,A
000F1F 4F1F E603             7      AND 3
000F21 4F21 1F               4      RRA
000F22 4F22 C9              10      RET
                                
       4F23                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000F23 4F23 210100          10      LD  HL,00001H
000F26 4F26 AF               4      XOR A
000F27 4F27 C9              10      RET
                                
       4F28                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000F28 4F28 3A3DF1          13      LD  A,(_DVSW)
000F2B 4F2B C9              10      RET
                                
       4F2C                     _SYS1A:     ;(BDOS)DTAの設定
000F2C 4F2C ED5329F1        20      LD  (_DTA),DE
000F30 4F30 AF               4      XOR A
000F31 4F31 C9              10      RET
                                
       4F32                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000F32 4F32 010002          10      LD  BC,512
000F35 4F35 11C302          10      LD  DE,707
000F38 4F38 210000          10      LD  HL,0
000F3B 4F3B DD2133F1        14      LD  IX,_BUF
000F3F 4F3F FD2133F1        14      LD  IY,_BUF
000F43 4F43 FD3600F9        19      LD  (IY+0),0F9H
000F47 4F47 3E02             7      LD  A,2
000F49 4F49 C9              10      RET
                                
       4F4A                     _SYS21:     ;(BDOS)ランダムな読み出し
000F4A 4F4A CD6D4A          17      CALL    SET_FCB
                                
000F4D 4F4D FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
000F50 4F50 FD6622          19      LD  H,(IY+34)
                                
000F53 4F53 CD284A          17      CALL    RB_READ
000F56 4F56 18C0            12      JR  SREAD
                                
       4F58                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
000F58 4F58 CD684E          17      CALL    _SYS0F
000F5B 4F5B D8              11      RET C
                                
000F5C 4F5C D5              11      PUSH    DE      ;EX DE,IY
000F5D 4F5D FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000F5F 4F5F CD5D4A          17      CALL    GETSIZE
       4F62                     _S24X1:
000F62 4F62 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
000F65 4F65 FD7422          19      LD  (IY+34),H
000F68 4F68 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000F6C 4F6C FDE3            23      EX  (SP),IY     ;
000F6E 4F6E D1              10      POP DE      ;
                                
000F6F 4F6F AF               4      XOR A
000F70 4F70 C9              10      RET
                                
       4F71                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
000F71 4F71 E5              11      PUSH    HL
000F72 4F72 D5              11      PUSH    DE      ;EX DE,IY
000F73 4F73 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000F75 4F75 CD3B4A          17      CALL    GETSEQ
000F78 4F78 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       4F7A                     _SYS27:     ;(BDOS)ランダムブロック読み込み
000F7A 4F7A CD6D4A          17      CALL    SET_FCB
000F7D 4F7D E5              11      PUSH    HL
000F7E 4F7E FD6E21          19      LD  L,(IY+33)
000F81 4F81 FD6622          19      LD  H,(IY+34)
000F84 4F84 221FF1          16      LD  (RR_LOW),HL
000F87 4F87 FD6E23          19      LD  L,(IY+35)
000F8A 4F8A FD6624          19      LD  H,(IY+36)
000F8D 4F8D 2221F1          16      LD  (RR_HIGH),HL
000F90 4F90 E1              10      POP HL
000F91 4F91 CDAB46          17      CALL    ROM_READ
000F94 4F94 ED5B1FF1        20      LD  DE,(RR_LOW)
000F98 4F98 FD7321          19      LD  (IY+33),E
000F9B 4F9B FD7222          19      LD  (IY+34),D
000F9E 4F9E ED5B21F1        20      LD  DE,(RR_HIGH)
000FA2 4FA2 FD7323          19      LD  (IY+35),E
000FA5 4FA5 FD7224          19      LD  (IY+36),D
000FA8 4FA8 9F               4      SBC A,A
000FA9 4FA9 C9              10      RET
                                
       4FAA                     _SYS2F:
000FAA 4FAA 44               4      LD  B,H
000FAB 4FAB 2A29F1          16      LD  HL,(_DTA)
000FAE 4FAE C3B84A          10      JP  DISKIO
                                
       4FB1                     INIT_FILE:
000FB1 4FB1 EB               4      EX  DE,HL
000FB2 4FB2 1146F1          10      LD  DE,FDRV
000FB5 4FB5 010C00          10      LD  BC,1+8+3
000FB8 4FB8 EDB0                    LDIR
000FBA 4FBA CD374C          17      CALL    GET_DISK_BANK_FDRV
000FBD 4FBD 320068          13      LD  (BANK1_SEL),A
000FC0 4FC0 C9              10      RET
                                
       4FC1                     ZERO_MEMORY_DE:
000FC1 4FC1 AF               4      XOR A
       4FC2                     FILL_MEMORY_DE:
000FC2 4FC2 12               7      LD  (DE),A
000FC3 4FC3 13               6      INC DE
000FC4 4FC4 10FC            13      DJNZ    FILL_MEMORY_DE
000FC6 4FC6 C9              10      RET
                                
000FC7 4FC7                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 5C4C724CA34C5C4C        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 5C4C5C4CA84CE94C        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 B04C5C4C034D974D        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 574E5D4E644E684E        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 BE4ECC4EF54E5C4C        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 0A4F5C4C5C4C5C4C        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 234F284F2C4F324F        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 5C4C5C4C5C4C584F        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 714F5C4C5C4C7A4F        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 5C4C5C4CA94D5C4C        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 AF4D5C4C5C4CAA4F        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB8 5FB8 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 5C4C5C4C5C4C5C4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
