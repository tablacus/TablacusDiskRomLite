                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       0138                     RSLREG  EQU 00138H
                                
       406F                     ERRHAND EQU 0406FH
       42B2                     CRUNCH  EQU 042B2H
       4C64                     FRMEVL  EQU 04C64H
                                
       F331                     H_BDOS  EQU 0F331H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F676                     TXTTAB  EQU 0F676H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
                                ;PTRFIL EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
                                ;FILNAM EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
                                ;RSTMP  EQU 0FB03H
       FB21                     DRVTBL  EQU 0FB21H
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FEDA                     H_STKE  EQU 0FEDAH
                                
       FF43                     H_GONE  EQU 0FF43H
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                
       F280                     ISC EQU 0F280H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       6200                     _FATBF  EQU BANK1_ADR+512       ;FATの先頭
                                
       F7F8                     DACDAT  EQU DAC+2
[EOF:DEF.ASM:UTF_8]
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C3754A          10      JP  DISKIO
000013 4013 C3A44A          10      JP  DSKCHG
000016 4016 C3FA4A          10      JP  GETDPB
000019 4019 C3E24B          10      JP  CHOICE
00001C 401C C3E64B          10      JP  DSKFMT
00001F 401F C3E84B          10      JP  DSKSTP
                                ;   JP  BASENT
                                ;   SCF
                                ;   JP  DSKFMT
                                ;   JP  DSKSTP
                                ;   NOP
                                ;   JP  GETSLT
                                ;   LD  HL,(0F34BH)
                                ;   RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.1.1.0",0
            204449534B20524F    
            4D204C6974652076    
            302E312E312E3000    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 2180F2          10      LD  HL,ISC
000103 4103 224AFC          16      LD  (HIMEM),HL
                                
000106 4106 3EFF             7      LD  A,0FFH
000108 4108 3299FD          13      LD  (DEVICE),A
                                
00010B 410B 3E01             7      LD  A,1
00010D 410D 3221FB          13      LD  (DRVTBL),A
                                
000110 4110 AF               4      XOR A
000111 4111 32D5F2          13      LD  (_DVSW),A
                                
000114 4114 21BA42          10      LD  HL,AT_ISC
000117 4117 1180F2          10      LD  DE,ISC
00011A 411A 016A00          10      LD  BC,ISC_E-ISC
00011D 411D EDB0                    LDIR
                                
00011F 411F 3EC3             7      LD  A,0C3H      ;JP
000121 4121 3243FF          13      LD  (H_GONE),A
000124 4124 327DF3          13      LD  (BDOS),A
000127 4127 326BF3          13      LD  (RAMUSE),A
00012A 412A 3268F3          13      LD  (ROMUSE),A
00012D 412D 2180F2          10      LD  HL,ISC
000130 4130 2244FF          16      LD  (H_GONE+1),HL
000133 4133 2131F3          10      LD  HL,H_BDOS
000136 4136 227EF3          16      LD  (BDOS+1),HL
000139 4139 21A7F2          10      LD  HL,RAMUSE1
00013C 413C 226CF3          16      LD  (RAMUSE+1),HL
00013F 413F 21A2F2          10      LD  HL,ROMUSE1
000142 4142 2269F3          16      LD  (ROMUSE+1),HL
                                
000145 4145 3E                      DB  03EH
000146 4146 F7              12      RST 30H
000147 4147 3271FE          13      LD  (H_BINS),A
00014A 414A 3276FE          13      LD  (H_BINL),A
00014D 414D 327BFE          13      LD  (H_FILE),A
                                ;   LD  (H_BDOS),A
000150 4150 32DAFE          13      LD  (H_STKE),A
000153 4153 32A7FF          13      LD  (H_PHYD),A
                                
000156 4156 CD0242          17      CALL    GTSL1_
000159 4159 3293F2          13      LD  (ROM_SLT),A
00015C 415C 3272FE          13      LD  (H_BINS+1),A
00015F 415F 3277FE          13      LD  (H_BINL+1),A
000162 4162 327CFE          13      LD  (H_FILE+1),A
000165 4165 3232F3          13      LD  (H_BDOS+1),A
000168 4168 32DBFE          13      LD  (H_STKE+1),A
00016B 416B 32A8FF          13      LD  (H_PHYD+1),A
00016E 416E 3222FB          13      LD  (DRVTBL+1),A
000171 4171 3248F3          13      LD  (MASTERS),A
                                
000174 4174 21C544          10      LD  HL,ROM_LOAD
000177 4177 2273FE          16      LD  (H_BINS+2),HL
00017A 417A 21E045          10      LD  HL,ROM_RUN
00017D 417D 2278FE          16      LD  (H_BINL+2),HL
000180 4180 21ED45          10      LD  HL,ROM_FILES
000183 4183 227DFE          16      LD  (H_FILE+2),HL
                                ;   LD  HL,ROM_BDOS
                                ;   LD  (H_BDOS+2),HL
000186 4186 215F43          10      LD  HL,ROM_STKE
000189 4189 22DCFE          16      LD  (H_STKE+2),HL
00018C 418C 21754A          10      LD  HL,DISKIO
00018F 418F 22A9FF          16      LD  (H_PHYD+2),HL
                                
000192 4192 3E                      DB  03EH
000193 4193 C9              10      RET
000194 4194 327FFE          13      LD  (H_FILE+4),A
000197 4197 3275FE          13      LD  (H_BINS+4),A
00019A 419A 327AFE          13      LD  (H_BINL+4),A
                                ;   LD  (H_BDOS+4),A
00019D 419D 32DEFE          13      LD  (H_STKE+4),A
0001A0 41A0 32ABFF          13      LD  (H_PHYD+4),A
                                
0001A3 41A3 AF               4      XOR A
0001A4 41A4 320068          13      LD  (BANK1_SEL),A
0001A7 41A7 3A0060          13      LD  A,(BANK1_ADR)
0001AA 41AA FE41             7      CP  'A'
0001AC 41AC 2043            12      JR  NZ,NOT_8K_BANK
0001AE 41AE 3E01             7      LD  A,DISK_BANK
0001B0 41B0 320068          13      LD  (BANK1_SEL),A
                                
0001B3 41B3 CD3801          17      CALL    RSLREG      ;read primary slot #
0001B6 41B6 07               4      RLCA
0001B7 41B7 07               4      RLCA
0001B8 41B8 F5              11      PUSH    AF
0001B9 41B9 CD0742          17      CALL    GTSL2_
0001BC 41BC 3244F3          13      LD  (RAMAD3),A
0001BF 41BF F1              10      POP AF  
0001C0 41C0 CD0742          17      CALL    GTSL2_
0001C3 41C3 3243F3          13      LD  (RAMAD2),A
       41C6                     RAMCHK2:
0001C6 41C6 3A44F3          13      LD  A,(RAMAD3)
0001C9 41C9 2640             7      LD  H,040H
0001CB 41CB CD1E42          17      CALL    CHK_RAM
0001CE 41CE 3242F3          13      LD  (RAMAD1),A
       41D1                     RAMCHK1:
0001D1 41D1 3A44F3          13      LD  A,(RAMAD3)
0001D4 41D4 2600             7      LD  H,00H
0001D6 41D6 CD1E42          17      CALL    CHK_RAM
0001D9 41D9 3241F3          13      LD  (RAMAD0),A
       41DC                     RAMCHK0:
0001DC 41DC 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
0001DF 41DF 010F00          10      LD  BC,0000FH       ;切り上げ
0001E2 41E2 09              11      ADD HL,BC
0001E3 41E3 7D               4      LD  A,L
                                
0001E4 41E4 0604             7      LD  B,4
       41E6                     B_DRIVE1:
0001E6 41E6 CB3C             8      SRL H
0001E8 41E8 1F               4      RRA
0001E9 41E9 10FB            13      DJNZ    B_DRIVE1
                                
0001EB 41EB C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
0001ED 41ED 32D4F2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
0001F0 41F0 C9              10      RET
                                
       41F1                     NOT_8K_BANK:
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K等)
0001F1 41F1 218E43          10      LD  HL,MSG_ERROR_ROM_MODE
0001F4 41F4 CD2743          17      CALL    MSX
0001F7 41F7 FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
0001FB 41FB DD219F00        14      LD  IX,CHGET
0001FF 41FF C31C00          10      JP  _CALSLT
                                
       4202                     GTSL1_:             ;自分のいるスロットを知る
000202 4202 CD3801          17      CALL    RSLREG      ;read primary slot #
000205 4205 0F               4      RRCA
000206 4206 0F               4      RRCA
       4207                     GTSL2_:
000207 4207 E603             7      AND 3       ;[A]=000000PP
000209 4209 5F               4      LD  E,A     ;[E]=000000PP
00020A 420A 21C1FC          10      LD  HL,EXPTBL
00020D 420D 85               4      ADD A,L     ;桁上りは無い
00020E 420E 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
00020F 420F 7B               4      LD  A,E     ;[A]=000000PP
000210 4210 CB7E            13      BIT 7,(HL)
000212 4212 C8              11      RET Z
000213 4213 7D               4      LD  A,L     ;point to SLTTBL entry
000214 4214 C604             7      ADD A,4     ;桁上りは無い
000216 4216 6F               4      LD  L,A
000217 4217 7E               7      LD  A,(HL)      ;get currently expansion slot register
000218 4218 E60C             7      AND 00CH        ;[A] = 0000SS00
00021A 421A B3               4      OR  E       ;[A] = 0000SSPP
00021B 421B F680             7      OR  080H        ;[A] = 1000SSPP
00021D 421D C9              10      RET
       421E                     GTSL1_E:
                                
       421E                     CHK_RAM:
00021E 421E E5              11      PUSH    HL
00021F 421F CD7342          17      CALL    CHK_RAM0
000222 4222 E1              10      POP HL
000223 4223 C8              11      RET Z
000224 4224 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000227 4227 E680             7      AND 080H
000229 4229 CD4A42          17      CALL    CHK_RAM_SLT
00022C 422C C8              11      RET Z
00022D 422D 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000230 4230 E680             7      AND 080H
000232 4232 C601             7      ADD A,1
000234 4234 CD4A42          17      CALL    CHK_RAM_SLT
000237 4237 C8              11      RET Z
000238 4238 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00023B 423B E680             7      AND 080H
00023D 423D C602             7      ADD A,2
00023F 423F CD4A42          17      CALL    CHK_RAM_SLT
000242 4242 C8              11      RET Z
000243 4243 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000246 4246 E680             7      AND 080H
000248 4248 C603             7      ADD A,3
       424A                     CHK_RAM_SLT:
00024A 424A E5              11      PUSH    HL
00024B 424B CD7342          17      CALL    CHK_RAM0        ;スロット#X or X-0
00024E 424E E1              10      POP HL
00024F 424F C8              11      RET Z
000250 4250 CB79             8      BIT 7,C
000252 4252 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000254 4254 79               4      LD  A,C
000255 4255 C604             7      ADD A,4         ;スロット#X-1
000257 4257 E5              11      PUSH    HL
000258 4258 CD7342          17      CALL    CHK_RAM0
00025B 425B E1              10      POP HL
00025C 425C C8              11      RET Z
00025D 425D 79               4      LD  A,C
00025E 425E C604             7      ADD A,4         ;スロット#X-2
000260 4260 E5              11      PUSH    HL
000261 4261 CD7342          17      CALL    CHK_RAM0
000264 4264 E1              10      POP HL
000265 4265 C8              11      RET Z
000266 4266 79               4      LD  A,C
000267 4267 C604             7      ADD A,4         ;スロット#X-3
000269 4269 E5              11      PUSH    HL
00026A 426A CD7342          17      CALL    CHK_RAM0
00026D 426D E1              10      POP HL
       426E                     CHK_RAM_E:
00026E 426E AF               4      XOR A
00026F 426F 3C               4      INC A           ;ZF=0にする
000270 4270 3E00             7      LD  A,0
000272 4272 C9              10      RET
                                
       4273                     CHK_RAM0:
000273 4273 4F               4      LD  C,A
000274 4274 3A93F2          13      LD  A,(ROM_SLT)
000277 4277 B9               4      CP  C
000278 4278 28F4            12      JR  Z,CHK_RAM_E
00027A 427A 2E00             7      LD  L,0
       427C                     CHK_RAM1:
00027C 427C 79               4      LD  A,C
00027D 427D DD210C00        14      LD  IX,_RDSLT
000281 4281 CDAE42          17      CALL    CALSLT_R
000284 4284 C6E5             7      ADD A,0E5H
000286 4286 47               4      LD  B,A
000287 4287 5F               4      LD  E,A
000288 4288 79               4      LD  A,C
000289 4289 DD211400        14      LD  IX,_WRSLT
00028D 428D CDAE42          17      CALL    CALSLT_R
000290 4290 79               4      LD  A,C
000291 4291 DD210C00        14      LD  IX,_RDSLT
000295 4295 CDAE42          17      CALL    CALSLT_R
000298 4298 B8               4      CP  B
000299 4299 C0              11      RET NZ
00029A 429A D6E5             7      SUB 0E5H
00029C 429C 79               4      LD  A,C
00029D 429D 5F               4      LD  E,A
00029E 429E DD211400        14      LD  IX,_WRSLT
0002A2 42A2 CDAE42          17      CALL    CALSLT_R
0002A5 42A5 24               4      INC H
0002A6 42A6 7D               4      LD  A,L
0002A7 42A7 C604             7      ADD A,4
0002A9 42A9 6F               4      LD  L,A
0002AA 42AA 20D0            12      JR  NZ,CHK_RAM1
0002AC 42AC 79               4      LD  A,C     ;ZF=1のハズ
0002AD 42AD C9              10      RET
                                
       42AE                     CALSLT_R:
0002AE 42AE C5              11      PUSH    BC
0002AF 42AF E5              11      PUSH    HL
0002B0 42B0 FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
0002B4 42B4 CD1C00          17      CALL    _CALSLT
0002B7 42B7 E1              10      POP HL
0002B8 42B8 C1              10      POP BC
0002B9 42B9 C9              10      RET
                                
       42BA                     AT_ISC:
0002BA F280                         ORG ISC,AT_ISC-RUN
0002BA F280 FEB7             7      CP  0B7H            ;FILES
0002BC F282 CC7BFE          17      CALL    Z,H_FILE
0002BF F285 FEB5             7      CP  0B5H            ;LOAD
0002C1 F287 CA71FE          10      JP  Z,H_BINS
0002C4 F28A FE8A             7      CP  08AH            ;RUN
0002C6 F28C CA76FE          10      JP  Z,H_BINL
0002C9 F28F FECF             7      CP  0CFH            ;BLOAD
0002CB F291 C0              11      RET NZ
       F292                     FIX_BLOAD:
0002CC F292 F7              12      RST 30H
       F293                     ROM_SLT:
0002CD F293 00                      DB  0
0002CE F294 2245                    DW  ROM_BLOAD
0002D0 F296 F5              11      PUSH    AF
0002D1 F297 E5              11      PUSH    HL
0002D2 F298 CDA1F2          17      CALL    BLOAD_RET
       F299                     SWC_BLOAD   EQU $-2
0002D5 F29B E1              10      POP HL
0002D6 F29C F1              10      POP AF
0002D7 F29D FECF             7      CP  0CFH            ;BLOAD
       F29F                     SWC_BLOAD_M:
0002D9 F29F 28DF            12      JR  Z,ISC
       F2A1                     BLOAD_RET:
0002DB F2A1 C9              10      RET
       F2A2                     ROMUSE1:
0002DC F2A2 3A93F2          13      LD  A,(ROM_SLT)
0002DF F2A5 1803            12      JR  ROMUSE2
       F2A7                     RAMUSE1:
0002E1 F2A7 3A42F3          13      LD  A,(RAMAD1)
       F2AA                     ROMUSE2:
0002E4 F2AA DD212400        14      LD  IX,_ENASLT
0002E8 F2AE FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
0002EC F2B2 C31C00          10      JP  _CALSLT
                                
       F2B5                     _RESULT:
0002EF F2B5 00                      DB  0
       F2B6                     _BANK:
0002F0 F2B6 00                      DB  0
       F2B7                     RR_LOW:
0002F1 F2B7 0000                    DW  0
       F2B8                     RR_MID  EQU $-1
       F2B9                     RR_HIGH:
0002F3 F2B9 0000                    DW  0
       F2BB                     _CLPS:
0002F5 F2BB 0000                    DW  0
       F2BD                     _LEFT:
0002F7 F2BD 0000                    DW  0
       F2BF                     _DTPS:
0002F9 F2BF 0000                    DW  0
       F2C1                     _DTA:
0002FB F2C1 0000                    DW  0
       F2C3                     FLG_LDIR:
0002FD F2C3 00                      DB  0
                                ;   BDOS
0002FE F2C4 F7              12      RST 30H
0002FF F2C5 00                      DB  0
000300 F2C6 164C                    DW  ROM_BDOS
000302 F2C8 C9              10      RET 
       F2C9                     _FCB:
000303 F2C9 0000                    DW  0
       F2CB                     _BUF:
000305 F2CB 00                      DB  0
       F2CC                     _BUF_ST:
000306 F2CC 0000                    DW  0
       F2CE                     _BUF_EN:
000308 F2CE 0000                    DW  0
       F2D0                     _BUF_EX:
00030A F2D0 0000                    DW  0
                                
       F2D2                     DTAX:
00030C F2D2 0000                    DW  0
       F2D4                     B_DRIVE:
00030E F2D4 00                      DB  0
       F2D5                     _DVSW:
00030F F2D5 00                      DB  0
       F2D6                     FCBX:
000310 F2D6 0000                    DW  0
       F2D8                     LEFTX:
000312 F2D8 0000                    DW  0
       F2DA                     PARAM0:
000314 F2DA 0000                    DW  0
       F2DC                     PARAM1:
000316 F2DC 0000                    DW  0
       F2DE                     FDRV:
000318 F2DE 00                      DB  0
       F2DF                     FNAME:
000319 F2DF                         DS  8+3
                                
       F2EA                     ISC_E:
000324 4324                         ORG $$+RUN          ;$DEPHASE
                                
       4324                     MSX1:
000324 4324 CD3943          17      CALL    MSGA1
       4327                     MSX:
000327 4327 7E               7      LD  A,(HL)
000328 4328 23               6      INC HL
000329 4329 B7               4      OR  A
00032A 432A 20F8            12      JR  NZ,MSX1
00032C 432C C9              10      RET
                                
       432D                     PRTHX:
00032D 432D F5              11      PUSH    AF
00032E 432E 07               4      RLCA
00032F 432F 07               4      RLCA
000330 4330 07               4      RLCA
000331 4331 07               4      RLCA
000332 4332 CD3643          17      CALL    PRTA2
000335 4335 F1              10      POP AF
       4336                     PRTA2:
000336 4336 CD4D43          17      CALL    ASC
       4339                     MSG_A:
       4339                     MSGA1:
000339 4339 F5              11      PUSH    AF
00033A 433A C5              11      PUSH    BC
00033B 433B D5              11      PUSH    DE
00033C 433C E5              11      PUSH    HL
00033D 433D FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
000341 4341 DD21A200        14      LD  IX,CHPUT
000345 4345 CD1C00          17      CALL    _CALSLT
000348 4348 E1              10      POP HL
000349 4349 D1              10      POP DE
00034A 434A C1              10      POP BC
       434B                     MSGA2:
00034B 434B F1              10      POP AF
00034C 434C C9              10      RET
       434D                     ASC:
00034D 434D E60F             7      AND $0F
00034F 434F F630             7      OR  $30
000351 4351 FE3A             7      CP  $3A
000353 4353 D8              11      RET C
000354 4354 C607             7      ADD A,7
000356 4356 C9              10      RET
                                
       4357                     MSN:
000357 4357 7E               7      LD  A,(HL)
000358 4358 23               6      INC HL
000359 4359 CD3943          17      CALL    MSG_A
00035C 435C 10F9            13      DJNZ    MSN
00035E 435E C9              10      RET
                                
       435F                     ROM_STKE:
00035F 435F 3E                      DB  03EH
000360 4360 C9              10      RET
000361 4361 32DAFE          13      LD  (H_STKE),A
000364 4364 E5              11      PUSH    HL
000365 4365 D5              11      PUSH    DE
000366 4366 C5              11      PUSH    BC
000367 4367 21A943          10      LD  HL,AUTOEXEC
00036A 436A 11DEF2          10      LD  DE,FDRV
00036D 436D 010C00          10      LD  BC,1+8+3
000370 4370 EDB0                    LDIR
000372 4372 CD3D48          17      CALL    ROM_OPEN
000375 4375 3813            12      JR  C,RSTKEE
000377 4377 21B543          10      LD  HL,RUN_AUTOEXEC
00037A 437A 11F0FB          10      LD  DE,KEYBUF
00037D 437D ED53FAF3        20      LD  (GETPNT),DE
000381 4381 011300          10      LD  BC,RUN_AUTOEXEC_E-RUN_AUTOEXEC
000384 4384 EDB0                    LDIR
000386 4386 ED53F8F3        20      LD  (PUTPNT),DE
       438A                     RSTKEE:
00038A 438A C1              10      POP BC
00038B 438B D1              10      POP DE
00038C 438C E1              10      POP HL
00038D 438D C9              10      RET
                                
       438E                     MSG_ERROR_ROM_MODE:
00038E 438E 41534349492D384B        DB  "ASCII-8K/Konami-8K only!",13,10
            2F4B6F6E616D692D    
            384B206F6E6C7921    
            0D0A                
       43A8                     NULL:
0003A8 43A8 00                      DB  0
                                
       43A9                     AUTOEXEC:
0003A9 43A9 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       43B5                     RUN_AUTOEXEC:
0003B5 43B5 52554E2022415554        DB  'RUN "AUTOEXEC.BAS"',00DH
            4F455845432E4241    
            53220D              
                                ;   DB  'LOAD "AUTOEXEC.BAS"',00DH  ;テスト用
       43C8                     RUN_AUTOEXEC_E:
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       43C8                     ROM_LDIR:
0003C8 43C8 3AC3F2          13      LD  A,(FLG_LDIR)
0003CB 43CB B7               4      OR  A
0003CC 43CC 2007            12      JR  NZ,ROM_LDIRVM
0003CE 43CE CB7A             8      BIT 7,D
0003D0 43D0 2815            12      JR  Z,ROM_LDIRSLT
0003D2 43D2 EDB0                    LDIR
0003D4 43D4 C9              10      RET
                                
       43D5                     ROM_LDIRVM:
0003D5 43D5 C5              11      PUSH    BC
0003D6 43D6 D5              11      PUSH    DE
0003D7 43D7 FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
0003DB 43DB DD215C00        14      LD  IX,LDIRVM
0003DF 43DF CD1C00          17      CALL    _CALSLT
0003E2 43E2 E1              10      POP HL
0003E3 43E3 C1              10      POP BC
0003E4 43E4 09              11      ADD HL,BC
0003E5 43E5 EB               4      EX  DE,HL
0003E6 43E6 C9              10      RET
                                
       43E7                     ROM_LDIRSLT:
0003E7 43E7 EB               4      EX  DE,HL
       43E8                     RLDIRSLT1:
0003E8 43E8 1A               7      LD  A,(DE)
0003E9 43E9 13               6      INC DE
0003EA 43EA C5              11      PUSH    BC
0003EB 43EB D5              11      PUSH    DE
0003EC 43EC E5              11      PUSH    HL
0003ED 43ED 5F               4      LD  E,A
0003EE 43EE 3A42F3          13      LD  A,(RAMAD1)
0003F1 43F1 FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
0003F5 43F5 DD211400        14      LD  IX,_WRSLT
0003F9 43F9 CD1C00          17      CALL    _CALSLT
0003FC 43FC E1              10      POP HL
0003FD 43FD D1              10      POP DE
0003FE 43FE C1              10      POP BC
0003FF 43FF EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
000401 4401 EAE843          10      JP  PE,RLDIRSLT1
000404 4404 EB               4      EX  DE,HL
000405 4405 C9              10      RET
                                
       4406                     END_OF_LINE:
000406 4406 215EF5          10      LD  HL,BUF
       4409                     EOL1:
000409 4409 7E               7      LD  A,(HL)
00040A 440A C8              11      RET Z
00040B 440B FE0D             7      CP  00DH
00040D 440D 2807            12      JR  Z,EOLE
00040F 440F FE0A             7      CP  00AH
000411 4411 2803            12      JR  Z,EOLE
000413 4413 23               6      INC HL
000414 4414 18F3            12      JR  EOL1
       4416                     EOLE:
000416 4416 3600            10      LD  (HL),0
000418 4418 23               6      INC HL
000419 4419 7E               7      LD  A,(HL)
00041A 441A FE0A             7      CP  00AH
00041C 441C C0              11      RET NZ
00041D 441D 23               6      INC HL
00041E 441E C9              10      RET
                                
       441F                     ROM_LOAD_ASCII:
00041F 441F 210000          10      LD  HL,0
000422 4422 22CCF2          16      LD  (_BUF_ST),HL    ;読み出し位置
000425 4425 2A76F6          16      LD  HL,(TXTTAB)
000428 4428 22CEF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
00042B 442B 215EF5          10      LD  HL,BUF
00042E 442E 22C1F2          16      LD  (_DTA),HL
       4431                     RLOAD_A1:
000431 4431 2ACCF2          16      LD  HL,(_BUF_ST)
000434 4434 22B7F2          16      LD  (RR_LOW),HL
000437 4437 210201          10      LD  HL,258
00043A 443A CD6846          17      CALL    ROM_READ
00043D 443D 7C               4      LD  A,H
00043E 443E B5               4      OR  L
00043F 443F 2877            12      JR  Z,RLOAD_AEND
000441 4441 015EF5          10      LD  BC,BUF
000444 4444 09              11      ADD HL,BC
000445 4445 3600            10      LD  (HL),0
000447 4447 CD0644          17      CALL    END_OF_LINE
00044A 444A 015EF5          10      LD  BC,BUF
00044D 444D A7               4      AND A
00044E 444E ED42            15      SBC HL,BC
000450 4450 2810            12      JR  Z,RLOAD_A2
000452 4452 4D               4      LD  C,L
000453 4453 44               4      LD  B,H
000454 4454 ED5BCCF2        20      LD  DE,(_BUF_ST)
000458 4458 19              11      ADD HL,DE
000459 4459 22CCF2          16      LD  (_BUF_ST),HL
00045C 445C 3A5EF5          13      LD  A,(BUF)
00045F 445F B7               4      OR  A
000460 4460 28CF            12      JR  Z,RLOAD_A1
       4462                     RLOAD_A2:
000462 4462 115EF5          10      LD  DE,BUF
000465 4465 CDD447          17      CALL    SPCUTEX
000468 4468 1A               7      LD  A,(DE)
000469 4469 B7               4      OR  A
00046A 446A 284C            12      JR  Z,RLOAD_AEND
00046C 446C CDE647          17      CALL    GETNUM
00046F 446F 7C               4      LD  A,H
000470 4470 B5               4      OR  L
000471 4471 CA0F45          10      JP  Z,ERROR_DIRECT_IN_FILE
000474 4474 DD2ACEF2        20      LD  IX,(_BUF_EN)
000478 4478 DD7502          19      LD  (IX+2),L
00047B 447B DD7403          19      LD  (IX+3),H
                                
00047E 447E CDCD47          17      CALL    SPCUT
000481 4481 EB               4      EX  DE,HL
000482 4482 DDE5            15      PUSH    IX
000484 4484 DD21B242        14      LD  IX,CRUNCH
000488 4488 FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
00048C 448C CD1C00          17      CALL    _CALSLT
00048F 448F DDE1            14      POP IX
000491 4491 EB               4      EX  DE,HL
000492 4492 111FF4          10      LD  DE,KBUF
000495 4495 37               4      SCF
000496 4496 ED52            15      SBC HL,DE
000498 4498 2875            12      JR  Z,ERROR_DIRECT_IN_FILE
00049A 449A 3873            12      JR  C,ERROR_DIRECT_IN_FILE
00049C 449C 4D               4      LD  C,L
00049D 449D 44               4      LD  B,H
00049E 449E 2ACEF2          16      LD  HL,(_BUF_EN)
0004A1 44A1 110400          10      LD  DE,4
0004A4 44A4 19              11      ADD HL,DE
0004A5 44A5 111FF4          10      LD  DE,KBUF
                                
0004A8 44A8 EB               4      EX  DE,HL
0004A9 44A9 EDB0                    LDIR
0004AB 44AB EB               4      EX  DE,HL
                                
0004AC 44AC DD7500          19      LD  (IX+0),L
0004AF 44AF DD7401          19      LD  (IX+1),H
0004B2 44B2 22CEF2          16      LD  (_BUF_EN),HL
0004B5 44B5 C33144          10      JP  RLOAD_A1
                                
       44B8                     RLOAD_AEND:
0004B8 44B8 2ACEF2          16      LD  HL,(_BUF_EN)
0004BB 44BB AF               4      XOR A
0004BC 44BC 77               7      LD  (HL),A
0004BD 44BD 23               6      INC HL
0004BE 44BE 77               7      LD  (HL),A
0004BF 44BF 23               6      INC HL
0004C0 44C0 22CEF2          16      LD  (_BUF_EN),HL
0004C3 44C3 1833            12      JR  RLOAD_END1
                                
       44C5                     ROM_LOAD:
0004C5 44C5 CD4046          17      CALL    INIT_PARAM
0004C8 44C8 CD0747          17      CALL    FILE_B:
0004CB 44CB CD3D48          17      CALL    ROM_OPEN
0004CE 44CE 3845            12      JR  C,ERROR_FILE_NOT_FOUND
                                
0004D0 44D0 21CBF2          10      LD  HL,_BUF
0004D3 44D3 22C1F2          16      LD  (_DTA),HL
0004D6 44D6 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
0004D9 44D9 CD6846          17      CALL    ROM_READ
0004DC 44DC 3ACBF2          13      LD  A,(_BUF)
0004DF 44DF 3C               4      INC A
0004E0 44E0 C21F44          10      JP  NZ,ROM_LOAD_ASCII
0004E3 44E3 2A76F6          16      LD  HL,(TXTTAB)
0004E6 44E6 22C1F2          16      LD  (_DTA),HL
0004E9 44E9 EB               4      EX  DE,HL
0004EA 44EA 2100FF          10      LD  HL,-256
0004ED 44ED 39              11      ADD HL,SP
0004EE 44EE ED52            15      SBC HL,DE
0004F0 44F0 CD6846          17      CALL    ROM_READ
0004F3 44F3 ED5BC1F2        20      LD  DE,(_DTA)
0004F7 44F7 19              11      ADD HL,DE
       44F8                     RLOAD_END1:
0004F8 44F8 22C2F6          16      LD  (VARTAB),HL
0004FB 44FB 22C4F6          16      LD  (ARYTAB),HL
0004FE 44FE 22C6F6          16      LD  (STREND),HL
                                
000501 4501 AF               4      XOR A
000502 4502 21CEF2          10      LD  HL,_BUF+3
000505 4505 77               7      LD  (HL),A
000506 4506 2B               6      DEC HL
000507 4507 77               7      LD  (HL),A
000508 4508 2B               6      DEC HL
000509 4509 77               7      LD  (HL),A
00050A 450A 2B               6      DEC HL
00050B 450B 3E8F             7      LD  A,08FH          ;REM
00050D 450D 77               7      LD  (HL),A
00050E 450E C9              10      RET
                                
       450F                     ERROR_DIRECT_IN_FILE:
00050F 450F 1E39             7      LD  E,57            ;Direct statement in file
000511 4511 01                      DB  1           ;LD BC,
       4512                     ERROR_FILE_NOT_OPEN:
000512 4512 1E3B             7      LD  E,59            ;File not OPEN
000514 4514 01                      DB  1           ;LD BC,
       4515                     ERROR_FILE_NOT_FOUND:
000515 4515 1E35             7      LD  E,53            ;File not found
       4517                     ERROR:
000517 4517 FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
00051B 451B DD216F40        14      LD  IX,ERRHAND
00051F 451F C31C00          10      JP  _CALSLT
                                
       4522                     ROM_BLOAD:
000522 4522 CD4046          17      CALL    INIT_PARAM
000525 4525 CD0747          17      CALL    FILE_B
000528 4528 CD3D48          17      CALL    ROM_OPEN
00052B 452B 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
00052D 452D 21CBF2          10      LD  HL,_BUF
000530 4530 22C1F2          16      LD  (_DTA),HL
000533 4533 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
000536 4536 CD6846          17      CALL    ROM_READ
000539 4539 3ACBF2          13      LD  A,(_BUF)
00053C 453C FEFE             7      CP  0FEH
00053E 453E 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
000540 4540 21A1F2          10      LD  HL,BLOAD_RET
000543 4543 2299F2          16      LD  (SWC_BLOAD),HL
                                
000546 4546 2ADCF2          16      LD  HL,(PARAM1)
000549 4549 7E               7      LD  A,(HL)
00054A 454A FE2C             7      CP  ','
00054C 454C 2048            12      JR  NZ,RBREAD_MEM
00054E 454E 23               6      INC HL
00054F 454F 7E               7      LD  A,(HL)
000550 4550 CD2748          17      CALL    CAP
000553 4553 32BEFC          13      LD  (RUNBNF),A
       4556                     RBOS1:
000556 4556 7E               7      LD  A,(HL)
000557 4557 23               6      INC HL
000558 4558 B7               4      OR  A
000559 4559 282F            12      JR  Z,RBREAD_OSE
00055B 455B FE3A             7      CP  ':'
00055D 455D 282B            12      JR  Z,RBREAD_OSE
00055F 455F FE2C             7      CP  ','     ;次のパラメータを探す
000561 4561 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
000563 4563 22DCF2          16      LD  (PARAM1),HL
000566 4566 7E               7      LD  A,(HL)
000567 4567 B7               4      OR  A
000568 4568 2820            12      JR  Z,RBREAD_OSE
00056A 456A DD21644C        14      LD  IX,FRMEVL
00056E 456E FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
000572 4572 CD1C00          17      CALL    _CALSLT
000575 4575 22DCF2          16      LD  (PARAM1),HL
000578 4578 3A63F6          13      LD  A,(VALTYP)
00057B 457B FE02             7      CP  2
00057D 457D 200B            12      JR  NZ,RBREAD_OSE
00057F 457F 2ACCF2          16      LD  HL,(_BUF_ST)
000582 4582 ED5BF8F7        20      LD  DE,(DACDAT)
000586 4586 19              11      ADD HL,DE
000587 4587 22CCF2          16      LD  (_BUF_ST),HL
       458A                     RBREAD_OSE:
00058A 458A 3ABEFC          13      LD  A,(RUNBNF)
00058D 458D FE53             7      CP  'S'
00058F 458F 2005            12      JR  NZ,RBREAD_MEM
000591 4591 3E01             7      LD  A,1
000593 4593 32C3F2          13      LD  (FLG_LDIR),A
       4596                     RBREAD_MEM:
000596 4596 2ACCF2          16      LD  HL,(_BUF_ST)
000599 4599 22BFFC          16      LD  (SAVENT),HL
00059C 459C 22C1F2          16      LD  (_DTA),HL
00059F 459F 21FFFF          10      LD  HL,0FFFFH
0005A2 45A2 CD6846          17      CALL    ROM_READ
0005A5 45A5 3ABEFC          13      LD  A,(RUNBNF)
0005A8 45A8 FE52             7      CP  'R'
0005AA 45AA 2006            12      JR  NZ,RBREAD1
0005AC 45AC 2AD0F2          16      LD  HL,(_BUF_EX)
0005AF 45AF 2299F2          16      LD  (SWC_BLOAD),HL
       45B2                     RBREAD1:
       45B2                     ROM_NEXT:
0005B2 45B2 2ADCF2          16      LD  HL,(PARAM1)
0005B5 45B5 7E               7      LD  A,(HL)
0005B6 45B6 2B               6      DEC HL
0005B7 45B7 B7               4      OR  A
0005B8 45B8 2805            12      JR  Z,RN1
0005BA 45BA FE3A             7      CP  ':'
0005BC 45BC 2801            12      JR  Z,RN1
0005BE 45BE 23               6      INC HL
       45BF                     RN1:
0005BF 45BF 5D               4      LD  E,L
0005C0 45C0 54               4      LD  D,H
                                
0005C1 45C1 CDFD47          17      CALL    SEARCH_END
0005C4 45C4 B7               4      OR  A
0005C5 45C5 2815            12      JR  Z,REM
                                                    ;マルチステートメントの処理
0005C7 45C7 7E               7      LD  A,(HL)
                                
0005C8 45C8 FEB5             7      CP  0B5H            ;LOAD
0005CA 45CA CAC544          10      JP  Z,ROM_LOAD
0005CD 45CD FE8A             7      CP  08AH            ;RUN
0005CF 45CF 280F            12      JR  Z,ROM_RUN
0005D1 45D1 FEB7             7      CP  0B7H            ;FILES
0005D3 45D3 2818            12      JR  Z,ROM_FILES
0005D5 45D5 3E28             7      LD  A,028H          ;JR Z,
0005D7 45D7 329FF2          13      LD  (SWC_BLOAD_M),A
0005DA 45DA 7E               7      LD  A,(HL)
0005DB 45DB C9              10      RET
                                
       45DC                     REM:
0005DC 45DC EB               4      EX  DE,HL
0005DD 45DD 3E8F             7      LD  A,08FH          ;REM
0005DF 45DF C9              10      RET
                                
       45E0                     ROM_RUN:
0005E0 45E0 23               6      INC HL
0005E1 45E1 7E               7      LD  A,(HL)
0005E2 45E2 2B               6      DEC HL
0005E3 45E3 B7               4      OR  A
0005E4 45E4 2803            12      JR  Z,ROM_RUN1
0005E6 45E6 CDC544          17      CALL    ROM_LOAD
       45E9                     ROM_RUN1:
0005E9 45E9 3E8A             7      LD  A,08AH          ;RUN
0005EB 45EB 77               7      LD  (HL),A
0005EC 45EC C9              10      RET
                                
       45ED                     ROM_FILES:
0005ED 45ED CD4046          17      CALL    INIT_PARAM
0005F0 45F0 CD0747          17      CALL    FILE_B
0005F3 45F3 CDED4B          17      CALL    GET_DISK_BANK_FDRV
0005F6 45F6 320068          13      LD  (BANK1_SEL),A
0005F9 45F9 3ADFF2          13      LD  A,(FNAME)
0005FC 45FC FE21             7      CP  021H
0005FE 45FE 3005            12      JR  NC,RFILES0
000600 4600 060B             7      LD  B,11
000602 4602 CD9147          17      CALL    FILE10
       4605                     RFILES0:
000605 4605 CD444A          17      CALL    GET_DIR_DAT
       4608                     RFILES1:
000608 4608 CD5C48          17      CALL    FILESE
00060B 460B 302E            12      JR  NC,RFILES_NOT_MATCH
       460D                     RFILES_DISP:
00060D 460D E5              11      PUSH    HL
00060E 460E 0608             7      LD  B,8
000610 4610 CD5743          17      CALL    MSN
000613 4613 3E2E             7      LD  A,'.'
000615 4615 CD3943          17      CALL    MSG_A
000618 4618 0603             7      LD  B,3
00061A 461A CD5743          17      CALL    MSN
00061D 461D 3ADDF3          13      LD  A,(CSRX)
000620 4620 47               4      LD  B,A
000621 4621 3AB0F3          13      LD  A,(LINLEN)
000624 4624 90               4      SUB B
000625 4625 FE0C             7      CP  12
000627 4627 3009            12      JR  NC,RFILES2
000629 4629 3E0D             7      LD  A,00DH      ;改行
00062B 462B CD3943          17      CALL    MSG_A
00062E 462E 3E0A             7      LD  A,00AH
000630 4630 1802            12      JR  RFILES3
       4632                     RFILES2:
000632 4632 3E20             7      LD  A,020H
       4634                     RFILES3:
000634 4634 CD3943          17      CALL    MSG_A
000637 4637 E1              10      POP HL
000638 4638 CD7848          17      CALL    FNEXT
       463B                     RFILES_NOT_MATCH:
00063B 463B 20CB            12      JR  NZ,RFILES1
00063D 463D C3B245          10      JP  ROM_NEXT
                                
       4640                     INIT_PARAM:
000640 4640 22DAF2          16      LD  (PARAM0),HL
000643 4643 EB               4      EX  DE,HL
000644 4644 AF               4      XOR A
000645 4645 32C3F2          13      LD  (FLG_LDIR),A
000648 4648 32BEFC          13      LD  (RUNBNF),A
00064B 464B 3263F6          13      LD  (VALTYP),A
00064E 464E 13               6      INC DE
00064F 464F CDCD47          17      CALL    SPCUT
000652 4652 1A               7      LD  A,(DE)
000653 4653 B7               4      OR  A
000654 4654 C8              11      RET Z
000655 4655 FE3A             7      CP  ':'
000657 4657 C8              11      RET Z
000658 4658 EB               4      EX  DE,HL
000659 4659 DD21644C        14      LD  IX,FRMEVL
00065D 465D FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
000661 4661 CD1C00          17      CALL    _CALSLT
000664 4664 22DCF2          16      LD  (PARAM1),HL
000667 4667 C9              10      RET
                                
       4668                     ROM_READ:
000668 4668 E5              11      PUSH    HL
000669 4669 D5              11      PUSH    DE
00066A 466A C5              11      PUSH    BC
00066B 466B FDE5            15      PUSH    IY
00066D 466D 22D8F2          16      LD  (LEFTX),HL
000670 4670 2AC1F2          16      LD  HL,(_DTA)
000673 4673 22D2F2          16      LD  (DTAX),HL
000676 4676 2AD8F2          16      LD  HL,(LEFTX)
                                
000679 4679 CDA448          17      CALL    RBX1
00067C 467C 386F            12      JR  C,RBRERR1
00067E 467E 79               4      LD  A,C
00067F 467F EB               4      EX  DE,HL
000680 4680 ED52            15      SBC HL,DE       ;CP 0HL,CDE
000682 4682 19              11      ADD HL,DE
000683 4683 DE00             7      SBC A,000H
000685 4685 3801            12      JR  C,RBR1
000687 4687 EB               4      EX  DE,HL
       4688                     RBR1:
000688 4688 9F               4      SBC A,A
000689 4689 E601             7      AND 1
00068B 468B 32B5F2          13      LD  (_RESULT),A
00068E 468E 7C               4      LD  A,H
00068F 468F B5               4      OR  L
000690 4690 CAE346          10      JP  Z,RBREND0
                                
000693 4693 22BDF2          16      LD  (_LEFT),HL  ;Read record byte
000696 4696 22D8F2          16      LD  (LEFTX),HL
                                
000699 4699 CDCD48          17      CALL    RBX2
00069C 469C 281A            12      JR  Z,RBRB
                                                ;先頭の端数
00069E 469E CDDE48          17      CALL    RBXA
0006A1 46A1 DAF946          10      JP  C,RBRERR
0006A4 46A4 C5              11      PUSH    BC
0006A5 46A5 CDC843          17      CALL    ROM_LDIR
0006A8 46A8 ED53D2F2        20      LD  (DTAX),DE
0006AC 46AC 2AD8F2          16      LD  HL,(LEFTX)
0006AF 46AF D1              10      POP DE
0006B0 46B0 A7               4      AND A
0006B1 46B1 ED52            15      SBC HL,DE
0006B3 46B3 22D8F2          16      LD  (LEFTX),HL
0006B6 46B6 2828            12      JR  Z,RBREND
                                
       46B8                     RBRB:
0006B8 46B8 CD1749          17      CALL    RBXB
0006BB 46BB 2817            12      JR  Z,RBRC
       46BD                     RBRB1:
0006BD 46BD C5              11      PUSH    BC
0006BE 46BE D5              11      PUSH    DE
0006BF 46BF CDAC49          17      CALL    CLUST
0006C2 46C2 EB               4      EX  DE,HL
0006C3 46C3 010004          10      LD  BC,1024     ;1クラスタのサイズ
0006C6 46C6 CDC843          17      CALL    ROM_LDIR
0006C9 46C9 EB               4      EX  DE,HL
0006CA 46CA D1              10      POP DE
0006CB 46CB C1              10      POP BC
0006CC 46CC CD8949          17      CALL    GNCL
0006CF 46CF DAF946          10      JP  C,RBRERR
0006D2 46D2 10E9            13      DJNZ    RBRB1
       46D4                     RBRC:
0006D4 46D4 CD2749          17      CALL    RBXC
0006D7 46D7 2807            12      JR  Z,RBREND
                                
0006D9 46D9 CDAC49          17      CALL    CLUST
0006DC 46DC EB               4      EX  DE,HL
0006DD 46DD CDC843          17      CALL    ROM_LDIR
       46E0                     RBREND:
0006E0 46E0 CD3149          17      CALL    RBXEND
       46E3                     RBREND0:
0006E3 46E3 FDE1            14      POP IY
0006E5 46E5 C1              10      POP BC
0006E6 46E6 D1              10      POP DE
0006E7 46E7 F1              10      POP AF  ;(HL)
0006E8 46E8 AF               4      XOR A
0006E9 46E9 3AB5F2          13      LD  A,(_RESULT)
0006EC 46EC C9              10      RET
                                
       46ED                     RBRERR1:
0006ED 46ED 3E01             7      LD  A,001H
       46EF                     RBRERR2:
0006EF 46EF FDE1            14      POP IY
0006F1 46F1 C1              10      POP BC
0006F2 46F2 D1              10      POP DE
0006F3 46F3 E1              10      POP HL
0006F4 46F4 37               4      SCF
0006F5 46F5 210000          10      LD  HL,0
0006F8 46F8 C9              10      RET
       46F9                     RBRERR:
0006F9 46F9 3EFF             7      LD  A,0FFH
0006FB 46FB 18F2            12      JR  RBRERR2
                                
       46FD                     FILE_DD:
0006FD 46FD 3E                      DB  03EH
0006FE 46FE C9              10      RET
0006FF 46FF 329FF2          13      LD  (SWC_BLOAD_M),A
000702 4702 2ADAF2          16      LD  HL,(PARAM0)
000705 4705 7E               7      LD  A,(HL)
000706 4706 C9              10      RET
       4707                     FILE_B:
000707 4707 AF               4      XOR A
000708 4708 32DEF2          13      LD  (FDRV),A
00070B 470B 1E00             7      LD  E,0
00070D 470D 3A63F6          13      LD  A,(VALTYP)
000710 4710 FE03             7      CP  3       ;string
000712 4712 203A            12      JR  NZ,FILED
000714 4714 DD2AF8F7        20      LD  IX,(DACDAT)
000718 4718 DD5E00          19      LD  E,(IX+0)
00071B 471B DD7E01          19      LD  A,(IX+1)
00071E 471E DD5602          19      LD  D,(IX+2)
000721 4721 DD62             9      LD  IXH,D
000723 4723 DD6F             9      LD  IXL,A
000725 4725 7B               4      LD  A,E
000726 4726 FE04             7      CP  4
000728 4728 3808            12      JR  C,FILEB1
00072A 472A DD7E03          19      LD  A,(IX+3)
00072D 472D FE3A             7      CP  ':'
00072F 472F 28CC            12      JR  Z,FILE_DD
000731 4731 7B               4      LD  A,E
       4732                     FILEB1:
000732 4732 FE02             7      CP  2
000734 4734 3818            12      JR  C,FILED
000736 4736 DD7E01          19      LD  A,(IX+1)
000739 4739 FE3A             7      CP  ':'
00073B 473B 2011            12      JR  NZ,DEVI1
00073D 473D DD7E00          19      LD  A,(IX+0)        ;DRIVE
000740 4740 CD2748          17      CALL    CAP
000743 4743 D640             7      SUB '@'
000745 4745 DD23            10      INC IX
000747 4747 DD23            10      INC IX
000749 4749 1D               4      DEC E
00074A 474A 1D               4      DEC E
00074B 474B 32DEF2          13      LD  (FDRV),A
       474E                     DEVI1:
                                
       474E                     FILED:
00074E 474E CD9547          17      CALL    FILEI
000751 4751 21DFF2          10      LD  HL,FNAME
                                
000754 4754 0608             7      LD  B,8
       4756                     FILE2:
000756 4756 CDA247          17      CALL    CCHKF
000759 4759 C8              11      RET Z
00075A 475A FE2A             7      CP  '*'
00075C 475C 282E            12      JR  Z,FILE9
00075E 475E FE2E             7      CP  '.'
000760 4760 280C            12      JR  Z,FILE4
000762 4762 77               7      LD  (HL),A
000763 4763 23               6      INC HL
000764 4764 10F0            13      DJNZ    FILE2
                                
       4766                     FILE3:
000766 4766 CDA247          17      CALL    CCHKF
000769 4769 C8              11      RET Z
00076A 476A FE2E             7      CP  '.'
00076C 476C 20F8            12      JR  NZ,FILE3
                                
       476E                     FILE4:
00076E 476E 21E7F2          10      LD  HL,FNAME+8
000771 4771 0603             7      LD  B,3
                                
       4773                     FILE4L:
000773 4773 CDA247          17      CALL    CCHKF
000776 4776 C8              11      RET Z
000777 4777 FE2E             7      CP  '.'
000779 4779 2008            12      JR  NZ,FILE12
00077B 477B 32DFF2          13      LD  (FNAME),A   ;Parent directory(..)
00077E 477E 32E0F2          13      LD  (FNAME+1),A
000781 4781 3E20             7      LD  A,020H
       4783                     FILE12:
000783 4783 FE2A             7      CP  '*'
000785 4785 280A            12      JR  Z,FILE10
000787 4787 77               7      LD  (HL),A
000788 4788 23               6      INC HL
000789 4789 10E8            13      DJNZ    FILE4L
00078B 478B C9              10      RET
                                
       478C                     FILE9:              ;名前の*処理、名前の残りを?で埋める
00078C 478C CD9147          17      CALL    FILE10
00078F 478F 18D5            12      JR  FILE3
                                
       4791                     FILE10:
000791 4791 3E3F             7      LD  A,'?'
000793 4793 1808            12      JR  FILL_MEMORY
       4795                     FILEI:              ;名前＋拡張子をスペースで初期化
000795 4795 3E20             7      LD  A,020H
000797 4797 01000B          10      LD  BC,11*256   ;C=0にしておく
00079A 479A 21DFF2          10      LD  HL,FNAME
       479D                     FILL_MEMORY:            ;HLからBバイトAで埋める
00079D 479D 77               7      LD  (HL),A
00079E 479E 23               6      INC HL
00079F 479F 10FC            13      DJNZ    FILL_MEMORY
0007A1 47A1 C9              10      RET
                                
       47A2                     CCHKF:
0007A2 47A2 7B               4      LD  A,E
0007A3 47A3 B7               4      OR  A
0007A4 47A4 C8              11      RET Z
0007A5 47A5 DD7E00          19      LD  A,(IX+0)
0007A8 47A8 CDAF47          17      CALL    CCHK2
0007AB 47AB C8              11      RET Z
0007AC 47AC C31248          10      JP  FKAN
                                
       47AF                     CCHK2:
0007AF 47AF 0C               4      INC C
0007B0 47B0 0D               4      DEC C
0007B1 47B1 C0              11      RET NZ
       47B2                     CCHK3:              ;ZF=1 で使えない文字
0007B2 47B2 FE2B             7      CP  '+'
0007B4 47B4 C8              11      RET Z
0007B5 47B5 FE2C             7      CP  ','
0007B7 47B7 C8              11      RET Z
0007B8 47B8 FE2F             7      CP  '/'
0007BA 47BA C8              11      RET Z
0007BB 47BB FE3A             7      CP  ':'
0007BD 47BD C8              11      RET Z
0007BE 47BE FE3B             7      CP  ';'
0007C0 47C0 C8              11      RET Z
0007C1 47C1 FE3D             7      CP  '='
0007C3 47C3 C8              11      RET Z
0007C4 47C4 FE5C             7      CP  05CH    ;\
0007C6 47C6 C8              11      RET Z
0007C7 47C7 FE1F             7      CP  01FH
0007C9 47C9 D0              11      RET NC
0007CA 47CA BF               4      CP  A       ;Z=1
0007CB 47CB C9              10      RET
                                
       47CC                     SS1:
0007CC 47CC 13               6      INC DE
       47CD                     SPCUT:              ;スペースをカット
0007CD 47CD 1A               7      LD  A,(DE)
0007CE 47CE FE20             7      CP  020H
0007D0 47D0 28FA            12      JR  Z,SS1
0007D2 47D2 C9              10      RET
                                
       47D3                     SCREOF1:
0007D3 47D3 13               6      INC DE
       47D4                     SPCUTEX:            ;スペース改行などをカット
0007D4 47D4 1A               7      LD  A,(DE)
0007D5 47D5 FE20             7      CP  020H
0007D7 47D7 28FA            12      JR  Z,SCREOF1
0007D9 47D9 FE0D             7      CP  00DH
0007DB 47DB 28F6            12      JR  Z,SCREOF1
0007DD 47DD FE0A             7      CP  00AH
0007DF 47DF 28F2            12      JR  Z,SCREOF1
0007E1 47E1 FE1A             7      CP  01AH
0007E3 47E3 28EE            12      JR  Z,SCREOF1
0007E5 47E5 C9              10      RET
                                
       47E6                     GETNUM:
0007E6 47E6 210000          10      LD  HL,0
       47E9                     GETNUM1:
0007E9 47E9 1A               7      LD  A,(DE)
0007EA 47EA 13               6      INC DE
0007EB 47EB D630             7      SUB '0'
0007ED 47ED D8              11      RET C
0007EE 47EE FE0A             7      CP  10
0007F0 47F0 D0              11      RET NC
0007F1 47F1 4D               4      LD  C,L
0007F2 47F2 44               4      LD  B,H
0007F3 47F3 29              11      ADD HL,HL   ;*2
0007F4 47F4 29              11      ADD HL,HL   ;*4
0007F5 47F5 09              11      ADD HL,BC   ;*5
0007F6 47F6 29              11      ADD HL,HL   ;*10
0007F7 47F7 4F               4      LD  C,A
0007F8 47F8 0600             7      LD  B,0
0007FA 47FA 09              11      ADD HL,BC
0007FB 47FB 18EC            12      JR  GETNUM1
                                
       47FD                     SEARCH_END:
0007FD 47FD 7E               7      LD  A,(HL)
       47FE                     SEARCH_END1:
0007FE 47FE 23               6      INC HL
0007FF 47FF B7               4      OR  A
000800 4800 C8              11      RET Z
000801 4801 FE3A             7      CP  ':'
000803 4803 20F8            12      JR  NZ,SEARCH_END
000805 4805 7E               7      LD  A,(HL)
000806 4806 FE3A             7      CP  ':'
000808 4808 28F4            12      JR  Z,SEARCH_END1
00080A 480A C9              10      RET
                                
       480B                     FKANC:
00080B 480B CB41             8      BIT 0,C
00080D 480D CC3048          17      CALL    Z,CAP2
000810 4810 1803            12      JR  FKANX
       4812                     FKAN:           ;漢字チェック
000812 4812 DD23            10      INC IX
000814 4814 1D               4      DEC E
       4815                     FKANX:
000815 4815 CB41             8      BIT 0,C
000817 4817 CB81             8      RES 0,C
000819 4819 C0              11      RET NZ
00081A 481A FE80             7      CP  080H
00081C 481C D8              11      RET C
00081D 481D FEA0             7      CP  0A0H
00081F 481F 3803            12      JR  C,FKAN1
000821 4821 FEE0             7      CP  0E0H
000823 4823 D8              11      RET C
       4824                     FKAN1:
000824 4824 0C               4      INC C
000825 4825 A7               4      AND A
000826 4826 C9              10      RET
                                
       4827                     CAP:
000827 4827 FE61             7      CP  'a'
000829 4829 D8              11      RET C
00082A 482A FE7B             7      CP  'z'+1
00082C 482C D0              11      RET NC
00082D 482D D620             7      SUB 020H
00082F 482F C9              10      RET
       4830                     CAP2:
000830 4830 CD2748          17      CALL    CAP
       4833                     CAP3:               ;
000833 4833 FE05             7      CP  5
000835 4835 2803            12      JR  Z,CAP4
000837 4837 FE21             7      CP  021H
000839 4839 C9              10      RET
       483A                     CAP4:
00083A 483A 3EE5             7      LD  A,0E5H
00083C 483C C9              10      RET
                                
       483D                     ROM_OPEN:
00083D 483D CDED4B          17      CALL    GET_DISK_BANK_FDRV
000840 4840 320068          13      LD  (BANK1_SEL),A
                                
000843 4843 CD444A          17      CALL    GET_DIR_DAT
000846 4846 D5              11      PUSH    DE
000847 4847 CD5C48          17      CALL    FILESE
00084A 484A D1              10      POP DE
00084B 484B 3F               4      CCF
00084C 484C D8              11      RET C
00084D 484D 22D6F2          16      LD  (FCBX),HL
000850 4850 E5              11      PUSH    HL
000851 4851 210000          10      LD  HL,0
000854 4854 22B7F2          16      LD  (RR_LOW),HL
000857 4857 22B9F2          16      LD  (RR_HIGH),HL
00085A 485A E1              10      POP HL
00085B 485B C9              10      RET
                                
       485C                     FILESE:
00085C 485C 7E               7      LD  A,(HL)
00085D 485D B7               4      OR  A
00085E 485E C8              11      RET Z       ;END:ZF=1 CF=0
00085F 485F FEE5             7      CP  0E5H
000861 4861 280D            12      JR  Z,FILESE1
000863 4863 11DFF2          10      LD  DE,FNAME
000866 4866 E5              11      PUSH    HL
000867 4867 CD7E48          17      CALL    CPFILE
00086A 486A CC9F48          17      CALL    Z,CPFILE2
00086D 486D E1              10      POP HL
00086E 486E 37               4      SCF
00086F 486F C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4870                     FILESE1:
000870 4870 CD7848          17      CALL    FNEXT
000873 4873 20E7            12      JR  NZ,FILESE
       4875                     ZF0_CF0_AFF_RET:
000875 4875 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000877 4877 C9              10      RET
                                
       4878                     FNEXT:
                                ;   PUSH    HL
                                ;   LD  HL,_FILEN
                                ;   INC (HL)
                                ;   POP HL
000878 4878 112000          10      LD  DE,020H
00087B 487B 19              11      ADD HL,DE
00087C 487C 0D               4      DEC C
00087D 487D C9              10      RET
                                
       487E                     CPFILE:
00087E 487E C5              11      PUSH    BC
00087F 487F 01000B          10      LD  BC,00B00H
       4882                     CPSTR1:
000882 4882 1A               7      LD  A,(DE)
000883 4883 FE3F             7      CP  '?'     ;Wild card
000885 4885 2812            12      JR  Z,CPSTR2
000887 4887 7E               7      LD  A,(HL)
000888 4888 CD0B48          17      CALL    FKANC
00088B 488B E5              11      PUSH    HL
00088C 488C 67               4      LD  H,A
00088D 488D 1A               7      LD  A,(DE)
00088E 488E CB01             4      RLC C
000890 4890 CD0B48          17      CALL    FKANC
000893 4893 CB09             4      RRC C
000895 4895 BC               4      CP  H       ;CP (HL),(DE)
000896 4896 E1              10      POP HL
000897 4897 2004            12      JR  NZ,CPSTR3
       4899                     CPSTR2:
000899 4899 13               6      INC DE
00089A 489A 23               6      INC HL
00089B 489B 10E5            13      DJNZ    CPSTR1
       489D                     CPSTR3:
00089D 489D C1              10      POP BC
00089E 489E C9              10      RET
                                
       489F                     CPFILE2:
                                ;   LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
                                ;   OR  0E1H
00089F 489F 3EE1             7      LD  A,0E1H
0008A1 48A1 2F               4      CPL
0008A2 48A2 A6               7      AND (HL)
0008A3 48A3 C9              10      RET
                                
       48A4                     RBX1:
0008A4 48A4 E5              11      PUSH    HL      ;Record byte
                                
0008A5 48A5 ED5BB7F2        20      LD  DE,(RR_LOW) ;CDE=Random record
0008A9 48A9 3ABAF2          13      LD  A,(RR_HIGH+1)
0008AC 48AC 4F               4      LD  C,A
                                
0008AD 48AD CDED4B          17      CALL    GET_DISK_BANK_FDRV
0008B0 48B0 320068          13      LD  (BANK1_SEL),A
                                
0008B3 48B3 FD2AD6F2        20      LD  IY,(FCBX)
0008B7 48B7 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
0008BA 48BA FD661D          19      LD  H,(IY+01DH)
0008BD 48BD FD7E1E          19      LD  A,(IY+01EH)
                                
0008C0 48C0 A7               4      AND A
0008C1 48C1 ED52            15      SBC HL,DE
0008C3 48C3 99               4      SBC A,C
0008C4 48C4 D1              10      POP DE
                                
0008C5 48C5 D8              11      RET C
0008C6 48C6 4F               4      LD  C,A
0008C7 48C7 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
0008C8 48C8 B2               4      OR  D
0008C9 48C9 B3               4      OR  E
0008CA 48CA C0              11      RET NZ
0008CB 48CB 37               4      SCF
0008CC 48CC C9              10      RET
                                
       48CD                     RBX2:
0008CD 48CD ED4BB8F2        20      LD  BC,(RR_LOW+1)
0008D1 48D1 CD4649          17      CALL    RWXR
0008D4 48D4 3E03             7      LD  A,3     ;ooo 1
0008D6 48D6 E5              11      PUSH    HL
0008D7 48D7 2AB7F2          16      LD  HL,(RR_LOW)
0008DA 48DA A4               4      AND H
0008DB 48DB B5               4      OR  L
0008DC 48DC E1              10      POP HL
0008DD 48DD C9              10      RET
                                
       48DE                     RBXA:
0008DE 48DE D5              11      PUSH    DE
0008DF 48DF CDAC49          17      CALL    CLUST
0008E2 48E2 ED53BFF2        20      LD  (_DTPS),DE
0008E6 48E6 D1              10      POP DE
0008E7 48E7 CD8949          17      CALL    GNCL
0008EA 48EA D8              11      RET C
0008EB 48EB ED53BBF2        20      LD  (_CLPS),DE
                                
0008EF 48EF ED4BB7F2        20      LD  BC,(RR_LOW)
0008F3 48F3 3E03             7      LD  A,3     ;ooo 1
0008F5 48F5 A0               4      AND B
0008F6 48F6 47               4      LD  B,A
0008F7 48F7 210004          10  IBM7:   LD  HL,1024     ;ooo 512
0008FA 48FA ED42            15      SBC HL,BC       ;remaining cluster
                                
0008FC 48FC ED5BD8F2        20      LD  DE,(LEFTX)
000900 4900 ED52            15      SBC HL,DE       ;CP HL,DE
000902 4902 19              11      ADD HL,DE
000903 4903 3801            12      JR  C,RBXA1
000905 4905 EB               4      EX  DE,HL
       4906                     RBXA1:
000906 4906 3AB6F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
000909 4909 320068          13      LD  (BANK1_SEL),A   ;ASCII-8K/Konami-8K共通で使える
00090C 490C E5              11      PUSH    HL
00090D 490D 2ABFF2          16      LD  HL,(_DTPS)
000910 4910 09              11      ADD HL,BC
000911 4911 ED5BD2F2        20      LD  DE,(DTAX)
000915 4915 C1              10      POP BC
000916 4916 C9              10      RET
                                
       4917                     RBXB:
000917 4917 2AD2F2          16      LD  HL,(DTAX)
00091A 491A ED5BBBF2        20      LD  DE,(_CLPS)
00091E 491E 3AD9F2          13      LD  A,(LEFTX+1)
000921 4921 CB3F             8      SRL A
000923 4923 CB3F             8  IBM8:   SRL A       ;ooo
000925 4925 47               4      LD  B,A
000926 4926 C9              10      RET
                                
       4927                     RBXC:
000927 4927 ED4BD8F2        20      LD  BC,(LEFTX)
00092B 492B 3E03             7      LD  A,3     ;ooo 1
00092D 492D A0               4      AND B
00092E 492E 47               4      LD  B,A
00092F 492F B1               4      OR  C
000930 4930 C9              10      RET
                                
       4931                     RBXEND:
000931 4931 ED5BBDF2        20      LD  DE,(_LEFT)
000935 4935 2AB7F2          16      LD  HL,(RR_LOW)
000938 4938 3ABAF2          13      LD  A,(RR_HIGH+1)
00093B 493B 19              11      ADD HL,DE
00093C 493C CE00             7      ADC A,0
00093E 493E 22B7F2          16      LD  (RR_LOW),HL
000941 4941 32BAF2          13      LD  (RR_HIGH+1),A
000944 4944 EB               4      EX  DE,HL       ;HL=Read byte
000945 4945 C9              10      RET 
                                
       4946                     RWXR:
000946 4946 CB38             8      SRL B
000948 4948 CB19             8      RR  C
00094A 494A CB38             8  IBM4:   SRL B   ;ooo
00094C 494C CB19             8      RR  C
                                
00094E 494E CDED4B          17      CALL    GET_DISK_BANK_FDRV
000951 4951 320068          13      LD  (BANK1_SEL),A
                                
000954 4954 FD2AD6F2        20      LD  IY,(FCBX)
000958 4958 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
00095B 495B FD561B          19      LD  D,(IY+01BH)
       495E                     RWX1:
00095E 495E ED53BBF2        20      LD  (_CLPS),DE
000962 4962 7A               4      LD  A,D
000963 4963 B3               4      OR  E
000964 4964 37               4      SCF
000965 4965 C8              11      RET Z
                                
000966 4966 78               4      LD  A,B
000967 4967 B1               4      OR  C
000968 4968 C8              11      RET Z
                                
000969 4969 CD8949          17      CALL    GNCL
00096C 496C D8              11      RET C
00096D 496D 0B               6      DEC BC
00096E 496E CDDD49          17      CALL    ENDCL
000971 4971 38EB            12      JR  C,RWX1
000973 4973 37               4      SCF
000974 4974 C9              10      RET
                                
       4975                     NCL3:
000975 4975 CDED4B          17      CALL    GET_DISK_BANK_FDRV
000978 4978 320068          13      LD  (BANK1_SEL),A
00097B 497B 6B               4      LD  L,E
00097C 497C 62               4      LD  H,D
00097D 497D CB3C             8      SRL H
00097F 497F CB1D             8      RR  L
000981 4981 1F               4      RRA
000982 4982 010062          10      LD  BC,_FATBF
000985 4985 19              11      ADD HL,DE
000986 4986 09              11      ADD HL,BC
000987 4987 17               4      RLA
000988 4988 C9              10      RET
                                
       4989                     GNCL:
000989 4989 7A               4      LD  A,D
00098A 498A B3               4      OR  E
00098B 498B 37               4      SCF
00098C 498C C8              11      RET Z
00098D 498D C5              11      PUSH    BC
00098E 498E E5              11      PUSH    HL
00098F 498F CD7549          17      CALL    NCL3
000992 4992 3809            12      JR  C,GNC1
000994 4994 5E               7      LD  E,(HL)
000995 4995 23               6      INC HL
000996 4996 7E               7      LD  A,(HL)
000997 4997 E60F             7      AND 00FH
000999 4999 57               4      LD  D,A
00099A 499A E1              10      POP HL
00099B 499B C1              10      POP BC
00099C 499C C9              10      RET
       499D                     GNC1:
00099D 499D 7E               7      LD  A,(HL)
00099E 499E 23               6      INC HL
00099F 499F 56               7      LD  D,(HL)
0009A0 49A0 0604             7      LD  B,4
       49A2                     GNC1L:
0009A2 49A2 CB3A             8      SRL D
0009A4 49A4 1F               4      RRA
0009A5 49A5 10FB            13      DJNZ    GNC1L
                                
0009A7 49A7 5F               4      LD  E,A
0009A8 49A8 E1              10      POP HL
0009A9 49A9 C1              10      POP BC
0009AA 49AA A7               4      AND A
0009AB 49AB C9              10      RET
                                
       49AC                     CLUST:
0009AC 49AC EB               4      EX  DE,HL
0009AD 49AD C5              11      PUSH    BC
0009AE 49AE CD524A          17      CALL    GET_DIR_POS
0009B1 49B1 87               4      ADD A,A
0009B2 49B2 3D               4      DEC A
0009B3 49B3 4F               4      LD  C,A
0009B4 49B4 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
0009B7 49B7 0F               4      RRCA
0009B8 49B8 0F               4      RRCA
0009B9 49B9 0F               4      RRCA
0009BA 49BA 0F               4      RRCA
0009BB 49BB 81               4      ADD A,C
0009BC 49BC C1              10      POP BC
0009BD 49BD 29              11      ADD HL,HL   ;*2
0009BE 49BE 29              11      ADD HL,HL   ;*4
0009BF 49BF 85               4      ADD A,L
0009C0 49C0 6F               4      LD  L,A
0009C1 49C1 8C               4      ADC A,H
0009C2 49C2 95               4      SUB L
0009C3 49C3 67               4      LD  H,A
0009C4 49C4 E5              11      PUSH    HL
0009C5 49C5 29              11      ADD HL,HL
0009C6 49C6 29              11      ADD HL,HL
0009C7 49C7 29              11      ADD HL,HL
0009C8 49C8 CDED4B          17      CALL    GET_DISK_BANK_FDRV
0009CB 49CB 84               4      ADD A,H
0009CC 49CC 320068          13      LD  (BANK1_SEL),A
0009CF 49CF 32B6F2          13      LD  (_BANK),A
0009D2 49D2 E1              10      POP HL
0009D3 49D3 3E1F             7      LD  A,01FH
0009D5 49D5 A5               4      AND L
0009D6 49D6 C660             7      ADD A,high BANK1_ADR
0009D8 49D8 67               4      LD  H,A
0009D9 49D9 2E00             7      LD  L,0
0009DB 49DB EB               4      EX  DE,HL
0009DC 49DC C9              10      RET
                                
       49DD                     ENDCL:
0009DD 49DD 7A               4      LD  A,D ;END CLUSTER
0009DE 49DE FE0F             7      CP  00FH    ;FAT12の最大値
0009E0 49E0 C0              11      RET NZ
0009E1 49E1 7B               4      LD  A,E
0009E2 49E2 FEF7             7      CP  0F7H
0009E4 49E4 C9              10      RET
                                
       49E5                     RB_READ:
0009E5 49E5 AF               4      XOR A   ;HLA = HL*128
0009E6 49E6 CB3C             8      SRL H
0009E8 49E8 CB1D             8      RR  L
0009EA 49EA 1F               4      RRA
0009EB 49EB 32B7F2          13      LD  (RR_LOW),A
0009EE 49EE 22B8F2          16      LD  (RR_MID),HL
0009F1 49F1 218000          10      LD  HL,128
                                
0009F4 49F4 CD6846          17      CALL    ROM_READ
0009F7 49F7 C9              10      RET
                                
       49F8                     GETSEQ:
0009F8 49F8 FD6E20          19      LD  L,(IY+32)
0009FB 49FB FD660C          19      LD  H,(IY+12)
                                
0009FE 49FE CB25             8      SLA L
                                
000A00 4A00 CB3C             8      SRL H
000A02 4A02 CB1D             8      RR  L
000A04 4A04 C9              10      RET
                                
       4A05                     SETSEQ:
000A05 4A05 F5              11      PUSH    AF
000A06 4A06 3AB7F2          13      LD  A,(RR_LOW)
000A09 4A09 2AB8F2          16      LD  HL,(RR_MID)
                                
000A0C 4A0C CD234A          17      CALL    SSQ1
                                
000A0F 4A0F 29              11      ADD HL,HL
000A10 4A10 CB3D             8      SRL L
000A12 4A12 FD7520          19      LD  (IY+32),L
000A15 4A15 FD740C          19      LD  (IY+12),H
000A18 4A18 F1              10      POP AF
000A19 4A19 C9              10      RET
                                
       4A1A                     GETSIZE:
000A1A 4A1A FD7E10          19      LD  A,(IY+16)
000A1D 4A1D FD6E11          19      LD  L,(IY+17)
000A20 4A20 FD6612          19      LD  H,(IY+18)
       4A23                     SSQ1:
000A23 4A23 87               4      ADD A,A
000A24 4A24 ED6A            15      ADC HL,HL
000A26 4A26 B7               4      OR  A
000A27 4A27 C8              11      RET Z
000A28 4A28 23               6      INC HL
000A29 4A29 C9              10      RET
                                
       4A2A                     SET_FCB:
000A2A 4A2A D5              11      PUSH    DE
000A2B 4A2B FDE1            14      POP IY
000A2D 4A2D FD7E1C          19      LD  A,(IY+28)
000A30 4A30 FEFF             7      CP  0FFH
000A32 4A32 200C            12      JR  NZ,POPAF_SCF_FF_RET
000A34 4A34 E5              11      PUSH    HL
000A35 4A35 FD6E1A          19      LD  L,(IY+26)
000A38 4A38 FD661B          19      LD  H,(IY+27)
000A3B 4A3B 22BBF2          16      LD  (_CLPS),HL
000A3E 4A3E E1              10      POP HL
000A3F 4A3F C9              10      RET
                                
       4A40                     POPAF_SCF_FF_RET:
000A40 4A40 F1              10      POP AF
000A41 4A41 37               4      SCF
000A42 4A42 9F               4      SBC A,A
000A43 4A43 C9              10      RET
                                
       4A44                     GET_DIR_DAT:
000A44 4A44 CD524A          17      CALL    GET_DIR_POS
000A47 4A47 87               4      ADD A,A         ;*2
000A48 4A48 C660             7      ADD A,high BANK1_ADR
000A4A 4A4A 2E00             7      LD  L,0
000A4C 4A4C 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*512
000A4D 4A4D 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000A50 4A50 4F               4      LD  C,A
000A51 4A51 C9              10      RET
                                
       4A52                     GET_DIR_POS:
000A52 4A52 CDED4B          17      CALL    GET_DISK_BANK_FDRV
000A55 4A55 320068          13      LD  (BANK1_SEL),A
000A58 4A58 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000A5B 4A5B 47               4      LD  B,A
000A5C 4A5C 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000A5F 4A5F 4F               4      LD  C,A
000A60 4A60 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4A63                     GET_DIR_POS1:
000A63 4A63 81               4      ADD A,C
000A64 4A64 10FD            13      DJNZ    GET_DIR_POS1
000A66 4A66 C9              10      RET
                                
       4A67                     WILDCARD:
000A67 4A67 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4A72                     ERROR_WRITE_PROTECTED:
000A72 4A72 3E00             7      LD  A,0     ;Write protected
000A74 4A74 C9              10      RET
       4A75                     DISKIO:
000A75 4A75 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000A77 4A77 48               4      LD  C,B
000A78 4A78 CDF74B          17      CALL    GET_DISK_BANK
       4A7B                     SETMAP1:        
000A7B 4A7B E5              11      PUSH    HL
       4A7C                     DISKIO1:
000A7C 4A7C C5              11      PUSH    BC      ;B=残りのセクタ数
000A7D 4A7D D5              11      PUSH    DE      ;DE=セクタ番号
000A7E 4A7E F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
000A7F 4A7F EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
000A80 4A80 29              11      ADD HL,HL
000A81 4A81 4D               4      LD  C,L     ;C=読み出し元(セクタ番号*2)※1セクタ512バイトなので倍にしておく
000A82 4A82 29              11      ADD HL,HL       ;64KB→32KB
000A83 4A83 29              11      ADD HL,HL       ;32KB→16KB
000A84 4A84 29              11      ADD HL,HL       ;16KB→8KB
000A85 4A85 84               4      ADD A,H
000A86 4A86 320068          13      LD  (BANK1_SEL),A   ;ASCII-8K/Konami-8K共通で使える
000A89 4A89 32B6F2          13      LD  (_BANK),A
000A8C 4A8C 79               4      LD  A,C     ;C=読み出し元
000A8D 4A8D E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F/16K:3F)
000A8F 4A8F C660             7      ADD A,high BANK1_ADR
000A91 4A91 67               4      LD  H,A
000A92 4A92 010002          10      LD  BC,00200H   ;BCは読み出すセクタサイズ(512バイト)
000A95 4A95 69               4      LD  L,C     ;C=0
000A96 4A96 EDB0                    LDIR
000A98 4A98 EB               4      EX  DE,HL
000A99 4A99 F1              10      POP AF
000A9A 4A9A D1              10      POP DE
000A9B 4A9B 13               6      INC DE
000A9C 4A9C C1              10      POP BC
000A9D 4A9D 10DD            13      DJNZ    DISKIO1
000A9F 4A9F 41               4      LD  B,C
                                
000AA0 4AA0 E1              10      POP HL
000AA1 4AA1 AF               4      XOR A
000AA2 4AA2 FB               4      EI
000AA3 4AA3 C9              10      RET
                                
       4AA4                     DSKCHG:
000AA4 4AA4 CDDD4A          17      CALL    IS_BPB
000AA7 4AA7 3824            12      JR  C,NOTREADY
000AA9 4AA9 3A23FB          13      LD  A,(DRVTBL+2)
000AAC 4AAC B7               4      OR  A
000AAD 4AAD 201A            12      JR  NZ,DSKCHG1
000AAF 4AAF 3A21FB          13      LD  A,(DRVTBL)
000AB2 4AB2 FE02             7      CP  2
000AB4 4AB4 2013            12      JR  NZ,DSKCHG1
000AB6 4AB6 CDDD4A          17      CALL    IS_BPB
000AB9 4AB9 300E            12      JR  NC,DSKCHG1
000ABB 4ABB 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000ABD 4ABD 3221FB          13      LD  (DRVTBL),A
000AC0 4AC0 3223FB          13      LD  (DRVTBL+2),A
000AC3 4AC3 3A48F3          13      LD  A,(MASTERS)
000AC6 4AC6 3224FB          13      LD  (DRVTBL+3),A
       4AC9                     DSKCHG1:
000AC9 4AC9 AF               4      XOR A
000ACA 4ACA 0601             7      LD  B,1
000ACC 4ACC C9              10      RET
       4ACD                     NOTREADY:
000ACD 4ACD 3E02             7      LD  A,2
000ACF 4ACF 37               4      SCF
000AD0 4AD0 C9              10      RET
                                
       4AD1                     NO_BPB:
000AD1 4AD1 E1              10      POP HL
000AD2 4AD2 23               6      INC HL
000AD3 4AD3 11FF4B          10      LD  DE,DPB2DD
000AD6 4AD6 011200          10      LD  BC,DPB2DD_E-DPB2DD
000AD9 4AD9 EDB0                    LDIR
000ADB 4ADB AF               4      XOR A
000ADC 4ADC C9              10      RET
                                
       4ADD                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000ADD 4ADD CDF74B          17      CALL    GET_DISK_BANK
000AE0 4AE0 320068          13      LD  (BANK1_SEL),A
                                
000AE3 4AE3 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000AE6 4AE6 FE01             7      CP  1
000AE8 4AE8 D8              11      RET C
                                
000AE9 4AE9 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000AEC 4AEC C6FF             7      ADD A,0FFH
000AEE 4AEE D8              11      RET C
                                
000AEF 4AEF 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
000AF2 4AF2 FE02             7      CP  2
000AF4 4AF4 C8              11      RET Z
000AF5 4AF5 FE04             7      CP  4
000AF7 4AF7 C8              11      RET Z
000AF8 4AF8 37               4      SCF
000AF9 4AF9 C9              10      RET
                                
       4AFA                     GETDPB:
000AFA 4AFA E5              11      PUSH    HL
000AFB 4AFB CDF74B          17      CALL    GET_DISK_BANK
000AFE 4AFE 320068          13      LD  (BANK1_SEL),A
                                
000B01 4B01 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000B04 4B04 B7               4      OR  A
000B05 4B05 28CA            12      JR  Z,NO_BPB
000B07 4B07 DDE1            14      POP IX
000B09 4B09 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000B0C 4B0C 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000B0F 4B0F DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000B12 4B12 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000B15 4B15 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000B18 4B18 87               4      ADD A,A
000B19 4B19 87               4      ADD A,A
000B1A 4B1A 87               4      ADD A,A
000B1B 4B1B 3D               4      DEC A
000B1C 4B1C DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000B1F 4B1F 06FF             7      LD  B,-1
000B21 4B21 A7               4      AND A           ;無限ループ阻止
       4B22                     GETDPB1:
000B22 4B22 04               4      INC B
000B23 4B23 1F               4      RRA
000B24 4B24 38FC            12      JR  C,GETDPB1
000B26 4B26 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000B29 4B29 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus 
000B2C 4B2C 3D               4      DEC A
000B2D 4B2D DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000B30 4B30 A7               4      AND A           ;無限ループ阻止
000B31 4B31 06FF             7      LD  B,-1
       4B33                     GETDPB2:
000B33 4B33 04               4      INC B
000B34 4B34 1F               4      RRA
000B35 4B35 38FC            12      JR  C,GETDPB2
000B37 4B37 04               4      INC B
000B38 4B38 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000B3B 4B3B 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
000B3E 4B3E DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
000B41 4B41 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
000B44 4B44 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
000B47 4B47 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000B4A 4B4A 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
000B4D 4B4D DD770B          19      LD  (IX+11),A       ;FATCNT
                                
000B50 4B50 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
000B54 4B54 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
000B57 4B57 DD460A          19      LD  B,(IX+10)       ;FATCNT
000B5A 4B5A 210000          10      LD  HL,0
       4B5D                     GETDPB3:
000B5D 4B5D 19              11      ADD HL,DE
000B5E 4B5E 10FD            13      DJNZ    GETDPB3
       4B60                     GETDPB4:
000B60 4B60 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
000B63 4B63 DD5609          19      LD  D,(IX+9)        ;FIRFAT
000B66 4B66 19              11      ADD HL,DE
000B67 4B67 DD7511          19      LD  (IX+17),L       ;FIRDIR
000B6A 4B6A DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000B6D 4B6D 3E08             7      LD  A,2*4           ;SECSIZ HIGH
000B6F 4B6F DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4B72                     GETDPB5:
000B72 4B72 CB3B             8      SRL E
000B74 4B74 1F               4      RRA
000B75 4B75 30FB            12      JR  NC,GETDPB5
000B77 4B77 1600             7      LD  D,0
000B79 4B79 19              11      ADD HL,DE
000B7A 4B7A DD750C          19      LD  (IX+12),L       ;FIRREC
000B7D 4B7D DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000B80 4B80 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
000B83 4B83 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
000B86 4B86 DD560D          19      LD  D,(IX+13)       ;FIRREC
000B89 4B89 A7               4      AND A
000B8A 4B8A ED52            15      SBC HL,DE
                                
000B8C 4B8C DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
000B8F 4B8F 3C               4      INC A
000B90 4B90 37               4      SCF             ;無限ループ阻止
       4B91                     GETDPB6:
000B91 4B91 1F               4      RRA
000B92 4B92 3806            12      JR  C,GETDPB7
000B94 4B94 CB3C             8      SRL H
000B96 4B96 CB1D             8      RR  L
000B98 4B98 18F7            12      JR  GETDPB6
       4B9A                     GETDPB7:
000B9A 4B9A 23               6      INC HL
000B9B 4B9B DD750E          19      LD  (IX+14),L       ;MAXCLUS
000B9E 4B9E DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       4BA1                     GETDPBD1:
000BA1 4BA1 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000BA4 4BA4 E6FC             7      AND 0FCH
000BA6 4BA6 C8              11      RET Z
                                
000BA7 4BA7 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
000BAB 4BAB 37               4      SCF
000BAC 4BAC DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
000BB0 4BB0 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
000BB3 4BB3 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
000BB7 4BB7 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
000BBB 4BBB DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
000BBF 4BBF DDCB1126        23      SLA (IX+17)         ;FIRDIR
000BC3 4BC3 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
000BC7 4BC7 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
000BCA 4BCA DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
000BCD 4BCD 3E08             7      LD  A,2*4           ;SECSIZ HIGH
000BCF 4BCF DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4BD2                     GETDPBD5:
000BD2 4BD2 CB3B             8      SRL E
000BD4 4BD4 1F               4      RRA
000BD5 4BD5 30FB            12      JR  NC,GETDPBD5
000BD7 4BD7 1600             7      LD  D,0
000BD9 4BD9 19              11      ADD HL,DE
000BDA 4BDA DD750C          19      LD  (IX+12),L       ;FIRREC
000BDD 4BDD DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000BE0 4BE0 18BF            12      JR  GETDPBD1
                                
       4BE2                     CHOICE:
000BE2 4BE2 210000          10      LD  HL,0
000BE5 4BE5 C9              10      RET
                                
       4BE6                     DSKFMT:
000BE6 4BE6 AF               4      XOR A
000BE7 4BE7 37               4      SCF
       4BE8                     DSKSTP:
       4BE8                     BASENT:
000BE8 4BE8 C9              10      RET
                                
       4BE9                     GETSLT:
000BE9 4BE9 3A22FB          13      LD  A,(DRVTBL+1)
000BEC 4BEC C9              10      RET
                                
       4BED                     GET_DISK_BANK_FDRV:
000BED 4BED 3ADEF2          13      LD  A,(FDRV)
000BF0 4BF0 D601             7      SUB 1
000BF2 4BF2 3003            12      JR  NC,GET_DISK_BANK
000BF4 4BF4 3AD5F2          13      LD  A,(_DVSW)
       4BF7                     GET_DISK_BANK:
000BF7 4BF7 B7               4      OR  A       ;A=DRIVE
000BF8 4BF8 3E01             7      LD  A,DISK_BANK
000BFA 4BFA C8              11      RET Z
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
000BFB 4BFB 3AD4F2          13      LD  A,(B_DRIVE)
                                #endif
000BFE 4BFE C9              10      RET
                                
       4BFF                     DPB2DD:
000BFF 4BFF F9                      DB  0F9H    ;MEDIA
000C00 4C00 0002                    DW  00200H  ;SECSIZ
000C02 4C02 0F                      DB  00FH    ;DIRMSK
000C03 4C03 04                      DB  004H    ;DIRSHFT
000C04 4C04 01                      DB  001H    ;CLUSMSK
000C05 4C05 02                      DB  002H    ;CLUSSHFT
000C06 4C06 0100                    DW  00001H  ;FIRFAT
000C08 4C08 02                      DB  002H    ;FATCNT
000C09 4C09 70                      DB  070H    ;MAXENT
000C0A 4C0A 0E00                    DW  0000EH  ;FIRREC
000C0C 4C0C CA02                    DW  002CAH  ;MAXCLUS
000C0E 4C0E 03                      DB  003H    ;FATSIZ
000C0F 4C0F 0700                    DW  0007H   ;FIRDIR
       4C11                     DPB2DD_E:
                                
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       4C11                     POP_HL_ERROR:
000C11 4C11 E1              10      POP     HL
       4C12                     _ERROR:
000C12 4C12 0600             7      LD  B,0
000C14 4C14 A7               4      AND A
000C15 4C15 C9              10      RET
                                
       4C16                     ROM_BDOS:
000C16 4C16 E5              11      PUSH    HL
000C17 4C17 79               4      LD  A,C
000C18 4C18 87               4      ADD A,A
000C19 4C19 38F7            12      JR  C,_ERROR
000C1B 4C1B 6F               4      LD  L,A
000C1C 4C1C 265F             7      LD  H,high STABLE
000C1E 4C1E 7E               7      LD  A,(HL)
000C1F 4C1F 2C               4      INC L
000C20 4C20 66               7      LD  H,(HL)
000C21 4C21 6F               4      LD  L,A
000C22 4C22 E3              19      EX  (SP),HL
000C23 4C23 79               4      LD  A,C
000C24 4C24 C9              10      RET
                                
       4C25                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000C25 4C25 C5              11      PUSH    BC
000C26 4C26 D5              11      PUSH    DE
000C27 4C27 E5              11      PUSH    HL
000C28 4C28 DDE5            15      PUSH    IX
000C2A 4C2A DD219C00        14      LD  IX,CHSNS
000C2E 4C2E CDAE42          17      CALL    CALSLT_R
000C31 4C31 DDE1            14      POP IX
000C33 4C33 E1              10      POP HL
000C34 4C34 D1              10      POP DE
000C35 4C35 C1              10      POP BC
000C36 4C36 C9              10      RET
                                
       4C37                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000C37 4C37 212200          10      LD  HL,00022H
000C3A 4C3A AF               4      XOR A
000C3B 4C3B 7D               4      LD  A,L
000C3C 4C3C C9              10      RET
                                
       4C3D                     _SYS0D:     ;(BDOS)ディスク・リセット
000C3D 4C3D 218000          10      LD  HL,00080H
000C40 4C40 22C1F2          16      LD  (_DTA),HL
000C43 4C43 C9              10      RET
                                
       4C44                     _SYS0E:     ;(BDOS)カレントドライブの設定
000C44 4C44 32D5F2          13      LD  (_DVSW),A
000C47 4C47 C9              10      RET
                                
       4C48                     _SYS0F:     ;(BDOS)ファイルのオープン
000C48 4C48 D5              11      PUSH    DE
000C49 4C49 FDE1            14      POP IY
000C4B 4C4B CD914D          17      CALL    INIT_FILE
000C4E 4C4E CD3D48          17      CALL    ROM_OPEN
000C51 4C51 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
000C53 4C53 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
000C57 4C57 FDE5            15      PUSH    IY
000C59 4C59 D1              10      POP DE
000C5A 4C5A 13               6      INC DE
000C5B 4C5B 010B00          10      LD  BC,11
000C5E 4C5E EDB0                    LDIR
                                ;               Attribute
000C60 4C60 7E               7      LD  A,(HL)
000C61 4C61 FD770D          19      LD  (IY+13),A
                                ;               TIME
000C64 4C64 110B00          10      LD  DE,11
000C67 4C67 19              11      ADD HL,DE
000C68 4C68 7E               7      LD  A,(HL)
000C69 4C69 23               6      INC HL
000C6A 4C6A FD7716          19      LD  (IY+22),A
000C6D 4C6D 7E               7      LD  A,(HL)
000C6E 4C6E 23               6      INC HL
000C6F 4C6F FD7717          19      LD  (IY+23),A
                                ;               DATE
000C72 4C72 7E               7      LD  A,(HL)
000C73 4C73 23               6      INC HL
000C74 4C74 FD7714          19      LD  (IY+20),A
000C77 4C77 7E               7      LD  A,(HL)
000C78 4C78 23               6      INC HL
000C79 4C79 FD7715          19      LD  (IY+21),A
                                ;               First cluster
000C7C 4C7C 7E               7      LD  A,(HL)
000C7D 4C7D 23               6      INC HL
000C7E 4C7E FD771A          19      LD  (IY+26),A
000C81 4C81 7E               7      LD  A,(HL)
000C82 4C82 23               6      INC HL
000C83 4C83 FD771B          19      LD  (IY+27),A
                                ;               SIZE
000C86 4C86 7E               7      LD  A,(HL)
000C87 4C87 23               6      INC HL
000C88 4C88 FD7710          19      LD  (IY+16),A
000C8B 4C8B 7E               7      LD  A,(HL)
000C8C 4C8C 23               6      INC HL
000C8D 4C8D FD7711          19      LD  (IY+17),A
000C90 4C90 7E               7      LD  A,(HL)
000C91 4C91 23               6      INC HL
000C92 4C92 FD7712          19      LD  (IY+18),A
000C95 4C95 7E               7      LD  A,(HL)
000C96 4C96 FD7713          19      LD  (IY+19),A
000C99 4C99 AF               4      XOR A
000C9A 4C9A FD770C          19      LD  (IY+12),A
000C9D 4C9D C9              10      RET
                                
       4C9E                     _SYS10:     ;(BDOS)ファイルのクローズ
000C9E 4C9E AF               4      XOR A
000C9F 4C9F C9              10      RET
                                
       4CA0                     S11X1:
000CA0 4CA0 FD7119          19      LD  (IY+25),C       ;RootEntCnt
000CA3 4CA3 FD750E          19      LD  (IY+14),L
000CA6 4CA6 FD740F          19      LD  (IY+15),H
       4CA9                     SCF_FF_RET:
000CA9 4CA9 37               4      SCF
000CAA 4CAA 9F               4      SBC A,A
000CAB 4CAB C9              10      RET
                                
       4CAC                     _SYS11:     ;(BDOS)最初のファイルの検索
000CAC 4CAC ED53C9F2        20      LD  (_FCB),DE
000CB0 4CB0 D5              11      PUSH    DE
000CB1 4CB1 FDE1            14      POP IY
000CB3 4CB3 CD914D          17      CALL    INIT_FILE
000CB6 4CB6 CD444A          17      CALL    GET_DIR_DAT
       4CB9                     S12X1:
000CB9 4CB9 CD5C48          17      CALL    FILESE
000CBC 4CBC 30E2            12      JR  NC,S11X1
000CBE 4CBE 0D               4      DEC C
000CBF 4CBF FD7119          19      LD  (IY+25),C       ;RootEntCnt
000CC2 4CC2 012000          10      LD  BC,32
000CC5 4CC5 ED5BC1F2        20      LD  DE,(_DTA)
000CC9 4CC9 AF               4      XOR A
000CCA 4CCA 12               7      LD  (DE),A      ;ドライブ番号
000CCB 4CCB 13               6      INC DE
000CCC 4CCC EDB0                    LDIR            ;ディレクトリエントリ
000CCE 4CCE FD750E          19      LD  (IY+14),L
000CD1 4CD1 FD740F          19      LD  (IY+15),H
000CD4 4CD4 C9              10      RET
                                
       4CD5                     _SYS12:
000CD5 4CD5 FD2AC9F2        20      LD  IY,(_FCB)
000CD9 4CD9 FDE5            15      PUSH    IY
000CDB 4CDB D1              10      POP DE
000CDC 4CDC CD914D          17      CALL    INIT_FILE
                                
000CDF 4CDF FD6E0E          19      LD  L,(IY+14)
000CE2 4CE2 FD660F          19      LD  H,(IY+15)
000CE5 4CE5 FD4E19          19      LD  C,(IY+25)
000CE8 4CE8 18CF            12      JR  S12X1
                                
       4CEA                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000CEA 4CEA CD2A4A          17      CALL    SET_FCB
000CED 4CED CDF849          17      CALL    GETSEQ
000CF0 4CF0 CDE549          17      CALL    RB_READ
000CF3 4CF3 E5              11      PUSH    HL
000CF4 4CF4 CD054A          17      CALL    SETSEQ
000CF7 4CF7 E1              10      POP HL
       4CF8                     SREAD:
000CF8 4CF8 C601             7      ADD A,001H
000CFA 4CFA D8              11      RET C
                                
000CFB 4CFB 7D               4      LD  A,L
000CFC 4CFC D601             7      SUB 001H
000CFE 4CFE 9F               4      SBC A,A
000CFF 4CFF E603             7      AND 3
000D01 4D01 1F               4      RRA
000D02 4D02 C9              10      RET
                                
       4D03                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000D03 4D03 210100          10      LD  HL,00001H
000D06 4D06 AF               4      XOR A
000D07 4D07 C9              10      RET
                                
       4D08                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000D08 4D08 3AD5F2          13      LD  A,(_DVSW)
000D0B 4D0B C9              10      RET
                                
       4D0C                     _SYS1A:     ;(BDOS)DTAの設定
000D0C 4D0C ED53C1F2        20      LD  (_DTA),DE
000D10 4D10 AF               4      XOR A
000D11 4D11 C9              10      RET
                                
       4D12                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000D12 4D12 010002          10      LD  BC,512
000D15 4D15 11C302          10      LD  DE,707
000D18 4D18 210000          10      LD  HL,0
000D1B 4D1B DD21CBF2        14      LD  IX,_BUF
000D1F 4D1F FD21CBF2        14      LD  IY,_BUF
000D23 4D23 FD3600F9        19      LD  (IY+0),0F9H
000D27 4D27 3E02             7      LD  A,2
000D29 4D29 C9              10      RET
                                
       4D2A                     _SYS21:     ;(BDOS)ランダムな読み出し
000D2A 4D2A CD2A4A          17      CALL    SET_FCB
                                
000D2D 4D2D FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
000D30 4D30 FD6622          19      LD  H,(IY+34)
                                
000D33 4D33 CDE549          17      CALL    RB_READ
000D36 4D36 18C0            12      JR  SREAD
                                
       4D38                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
000D38 4D38 CD484C          17      CALL    _SYS0F
000D3B 4D3B D8              11      RET C
                                
000D3C 4D3C D5              11      PUSH    DE      ;EX DE,IY
000D3D 4D3D FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000D3F 4D3F CD1A4A          17      CALL    GETSIZE
       4D42                     _S24X1:
000D42 4D42 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
000D45 4D45 FD7422          19      LD  (IY+34),H
000D48 4D48 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000D4C 4D4C FDE3            23      EX  (SP),IY     ;
000D4E 4D4E D1              10      POP DE      ;
                                
000D4F 4D4F AF               4      XOR A
000D50 4D50 C9              10      RET
                                
       4D51                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
000D51 4D51 E5              11      PUSH    HL
000D52 4D52 D5              11      PUSH    DE      ;EX DE,IY
000D53 4D53 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000D55 4D55 CDF849          17      CALL    GETSEQ
000D58 4D58 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       4D5A                     _SYS27:     ;(BDOS)ランダムブロック読み込み
000D5A 4D5A CD2A4A          17      CALL    SET_FCB
000D5D 4D5D E5              11      PUSH    HL
000D5E 4D5E FD6E21          19      LD  L,(IY+33)
000D61 4D61 FD6622          19      LD  H,(IY+34)
000D64 4D64 22B7F2          16      LD  (RR_LOW),HL
000D67 4D67 FD6E23          19      LD  L,(IY+35)
000D6A 4D6A FD6624          19      LD  H,(IY+36)
000D6D 4D6D 22B9F2          16      LD  (RR_HIGH),HL
000D70 4D70 E1              10      POP HL
000D71 4D71 CD6846          17      CALL    ROM_READ
000D74 4D74 ED5BB7F2        20      LD  DE,(RR_LOW)
000D78 4D78 FD7321          19      LD  (IY+33),E
000D7B 4D7B FD7222          19      LD  (IY+34),D
000D7E 4D7E ED5BB9F2        20      LD  DE,(RR_HIGH)
000D82 4D82 FD7323          19      LD  (IY+35),E
000D85 4D85 FD7224          19      LD  (IY+36),D
000D88 4D88 9F               4      SBC A,A
000D89 4D89 C9              10      RET
                                
       4D8A                     _SYS2F:
000D8A 4D8A 44               4      LD  B,H
000D8B 4D8B 2AC1F2          16      LD  HL,(_DTA)
000D8E 4D8E C3754A          10      JP  DISKIO
                                
       4D91                     INIT_FILE:
000D91 4D91 EB               4      EX  DE,HL
000D92 4D92 11DEF2          10      LD  DE,FDRV
000D95 4D95 010C00          10      LD  BC,1+8+3
000D98 4D98 EDB0                    LDIR
000D9A 4D9A CDED4B          17      CALL    GET_DISK_BANK_FDRV
000D9D 4D9D 320068          13      LD  (BANK1_SEL),A
000DA0 4DA0 C9              10      RET
                                
000DA1 4DA1                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F08 5F08 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F10 5F10 124C124C124C254C        DW  _ERROR,_ERROR,_ERROR,_SYS0B
001F18 5F18 374C3D4C444C484C        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 9E4CAC4CD54C124C        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 EA4C124C124C124C        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 034D084D0C4D124D        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 124C124C124C384D        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 514D124C124C5A4D        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F58 5F58 124C124C124C8A4D        DW  _ERROR,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB8 5FB8 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 124C124C124C124C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
