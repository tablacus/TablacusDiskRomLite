                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       42B2                     CRUNCH  EQU 042B2H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
                                ;PTRFIL EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
                                ;FILNAM EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
                                ;RSTMP  EQU 0FB03H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FEDA                     H_STKE  EQU 0FEDAH
                                
       FF43                     H_GONE  EQU 0FF43H
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;KONAMI-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                
       F0E9                     ISC EQU 0F0E9H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
[EOF:DEF.ASM:UTF_8]
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C33D4D          10      JP  DISKIO
000013 4013 C3774D          10      JP  DSKCHG
000016 4016 C3CD4D          10      JP  GETDPB
000019 4019 C3C04E          10      JP  CHOICE
00001C 401C C3C44E          10      JP  DSKFMT
00001F 401F C3C64E          10      JP  DSKSTP
000022 4022 C3C74E          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C3C44E          10      JP  DSKFMT
000029 4029 C3C64E          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3CE4E          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.1.5.0",0
            204449534B20524F    
            4D204C6974652076    
            302E312E352E3000    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 0180FF          10      LD  BC,-00080H
000109 4109 2A72F6          16      LD  HL,(MEMSIZ)
00010C 410C 09              11      ADD HL,BC
00010D 410D 2272F6          16      LD  (MEMSIZ),HL
000110 4110 2A74F6          16      LD  HL,(STKTOP)
000113 4113 09              11      ADD HL,BC
000114 4114 2274F6          16      LD  (STKTOP),HL
000117 4117 2180F0          10      LD  HL,0F080H
00011A 411A 1100F0          10      LD  DE,0F000H
00011D 411D 012000          10      LD  BC,00020H
000120 4120 EDB0                    LDIR
000122 4122 2180FF          10      LD  HL,-00080H
000125 4125 39              11      ADD HL,SP
000126 4126 225FF1          16      LD  (BASSTK),HL
000129 4129 ED7B5FF1        20      LD  SP,(BASSTK)
                                
00012D 412D 3EFF             7      LD  A,0FFH
00012F 412F 3299FD          13      LD  (DEVICE),A
                                
000132 4132 3E01             7      LD  A,1
000134 4134 3221FB          13      LD  (DRVTBL),A
                                
000137 4137 AF               4      XOR A
000138 4138 324AF1          13      LD  (_DVSW),A
                                
00013B 413B 210943          10      LD  HL,AT_ISC
00013E 413E 11E9F0          10      LD  DE,ISC
000141 4141 017C00          10      LD  BC,ISC_E-ISC
000144 4144 EDB0                    LDIR
                                    
000146 4146 3EC3             7      LD  A,0C3H      ;JP
000148 4148 3243FF          13      LD  (H_GONE),A
00014B 414B 327DF3          13      LD  (BDOS),A
00014E 414E 326BF3          13      LD  (RAMUSE),A
000151 4151 3268F3          13      LD  (ROMUSE),A
000154 4154 21E9F0          10      LD  HL,REPLACE_COMMAND
000157 4157 2244FF          16      LD  (H_GONE+1),HL
00015A 415A 2131F3          10      LD  HL,H_BDOS
00015D 415D 227EF3          16      LD  (BDOS+1),HL
000160 4160 2119F1          10      LD  HL,RAMUSE1
000163 4163 226CF3          16      LD  (RAMUSE+1),HL
000166 4166 2114F1          10      LD  HL,ROMUSE1
000169 4169 2269F3          16      LD  (ROMUSE+1),HL
                                
00016C 416C 3E                      DB  03EH
00016D 416D F7              12      RST 30H
00016E 416E 3271FE          13      LD  (H_BINS),A
000171 4171 3276FE          13      LD  (H_BINL),A
000174 4174 327BFE          13      LD  (H_FILE),A
000177 4177 3231F3          13      LD  (H_BDOS),A
00017A 417A 32DAFE          13      LD  (H_STKE),A
00017D 417D 32A7FF          13      LD  (H_PHYD),A
                                
000180 4180 CD4942          17      CALL    GTSL1_
000183 4183 3200F1          13      LD  (ROM_SLT),A
000186 4186 3210F1          13      LD  (ROM_SLT_COPY),A
000189 4189 3272FE          13      LD  (H_BINS+1),A
00018C 418C 3277FE          13      LD  (H_BINL+1),A
00018F 418F 327CFE          13      LD  (H_FILE+1),A
000192 4192 3232F3          13      LD  (H_BDOS+1),A
000195 4195 32DBFE          13      LD  (H_STKE+1),A
000198 4198 32A8FF          13      LD  (H_PHYD+1),A
00019B 419B 3222FB          13      LD  (DRVTBL+1),A
00019E 419E 3248F3          13      LD  (MASTERS),A
                                
0001A1 41A1 214045          10      LD  HL,ROM_LOAD
0001A4 41A4 2273FE          16      LD  (H_BINS+2),HL
0001A7 41A7 215B46          10      LD  HL,ROM_RUN
0001AA 41AA 2278FE          16      LD  (H_BINL+2),HL
0001AD 41AD 216846          10      LD  HL,ROM_FILES
0001B0 41B0 227DFE          16      LD  (H_FILE+2),HL
0001B3 41B3 211A4F          10      LD  HL,ROM_BDOS
0001B6 41B6 2233F3          16      LD  (H_BDOS+2),HL
0001B9 41B9 21AF43          10      LD  HL,ROM_STKE
0001BC 41BC 22DCFE          16      LD  (H_STKE+2),HL
0001BF 41BF 213D4D          10      LD  HL,DISKIO
0001C2 41C2 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001C5 41C5 3E                      DB  03EH
0001C6 41C6 C9              10      RET
0001C7 41C7 327FFE          13      LD  (H_FILE+4),A
0001CA 41CA 3275FE          13      LD  (H_BINS+4),A
0001CD 41CD 327AFE          13      LD  (H_BINL+4),A
0001D0 41D0 3235F3          13      LD  (H_BDOS+4),A
0001D3 41D3 32DEFE          13      LD  (H_STKE+4),A
0001D6 41D6 32ABFF          13      LD  (H_PHYD+4),A
                                
                                #if exists USE_NORMAL_32K_ROM
                                #else
0001D9 41D9 AF               4      XOR A
0001DA 41DA 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001DD 41DD 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0001E0 41E0 3A0060          13      LD  A,(BANK1_ADR)
0001E3 41E3 FE41             7      CP  'A'
0001E5 41E5 2051            12      JR  NZ,NOT_8K_BANK
0001E7 41E7 3E01             7      LD  A,DISK_BANK
0001E9 41E9 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001EC 41EC 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001EF 41EF CD3801          17      CALL    RSLREG      ;read primary slot #
0001F2 41F2 07               4      RLCA
0001F3 41F3 07               4      RLCA
0001F4 41F4 F5              11      PUSH    AF
0001F5 41F5 1605             7      LD  D,4+1
0001F7 41F7 CD5042          17      CALL    GTSL2_
0001FA 41FA 3244F3          13      LD  (RAMAD3),A
0001FD 41FD F1              10      POP AF
0001FE 41FE 07               4      RLCA
0001FF 41FF 07               4      RLCA
000200 4200 1603             7      LD  D,2+1
000202 4202 CD5042          17      CALL    GTSL2_
000205 4205 2680             7      LD  H,080H
000207 4207 CD6D42          17      CALL    CHK_RAM
00020A 420A 3243F3          13      LD  (RAMAD2),A
       420D                     RAMCHK2:
00020D 420D 3A44F3          13      LD  A,(RAMAD3)
000210 4210 2640             7      LD  H,040H
000212 4212 CD6D42          17      CALL    CHK_RAM
000215 4215 3242F3          13      LD  (RAMAD1),A
       4218                     RAMCHK1:
000218 4218 3A44F3          13      LD  A,(RAMAD3)
00021B 421B 2600             7      LD  H,00H
00021D 421D CD6D42          17      CALL    CHK_RAM
000220 4220 3241F3          13      LD  (RAMAD0),A
       4223                     RAMCHK0:
000223 4223 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
000226 4226 010F00          10      LD  BC,0000FH       ;切り上げ
000229 4229 09              11      ADD HL,BC
00022A 422A 7D               4      LD  A,L
                                
00022B 422B 0604             7      LD  B,4
       422D                     B_DRIVE1:
00022D 422D CB3C             8      SRL H
00022F 422F 1F               4      RRA
000230 4230 10FB            13      DJNZ    B_DRIVE1
                                
000232 4232 C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000234 4234 3249F1          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
000237 4237 C9              10      RET
                                
       4238                     NOT_8K_BANK:
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K等)
000238 4238 21FD43          10      LD  HL,MSG_ERROR_ROM_MODE
00023B 423B CD8843          17      CALL    MSX
00023E 423E FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000242 4242 DD219F00        14      LD  IX,CHGET
000246 4246 C31C00          10      JP  _CALSLT
                                
       4249                     GTSL1_:             ;自分のいるスロットを知る
000249 4249 CD3801          17      CALL    RSLREG      ;read primary slot #
00024C 424C 0F               4      RRCA
00024D 424D 0F               4      RRCA
00024E 424E 1601             7      LD  D,1
       4250                     GTSL2_:
000250 4250 E603             7      AND 3       ;[A]=000000PP
000252 4252 5F               4      LD  E,A     ;[E]=000000PP
000253 4253 21C1FC          10      LD  HL,EXPTBL
000256 4256 85               4      ADD A,L     ;桁上りは無い
000257 4257 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000258 4258 7B               4      LD  A,E     ;[A]=000000PP
000259 4259 CB7E            13      BIT 7,(HL)
00025B 425B C8              11      RET Z
00025C 425C 7D               4      LD  A,L     ;point to SLTTBL entry
00025D 425D C604             7      ADD A,4     ;桁上りは無い
00025F 425F 6F               4      LD  L,A
000260 4260 7E               7      LD  A,(HL)      ;get currently expansion slot register
       4261                     GTSL3_:
000261 4261 15               4      DEC D
000262 4262 2803            12      JR  Z,GTSL4_:
000264 4264 0F               4      RRCA
000265 4265 18FA            12      JR  GTSL3_:
       4267                     GTSL4_:
000267 4267 E60C             7      AND 00CH        ;[A] = 0000SS00
000269 4269 B3               4      OR  E       ;[A] = 0000SSPP
00026A 426A F680             7      OR  080H        ;[A] = 1000SSPP
00026C 426C C9              10      RET
                                
       426D                     CHK_RAM:
00026D 426D E5              11      PUSH    HL
00026E 426E CDC242          17      CALL    CHK_RAM0
000271 4271 E1              10      POP HL
000272 4272 C8              11      RET Z
000273 4273 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000276 4276 E680             7      AND 080H
000278 4278 CD9942          17      CALL    CHK_RAM_SLT
00027B 427B C8              11      RET Z
00027C 427C 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
00027F 427F E680             7      AND 080H
000281 4281 C601             7      ADD A,1
000283 4283 CD9942          17      CALL    CHK_RAM_SLT
000286 4286 C8              11      RET Z
000287 4287 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00028A 428A E680             7      AND 080H
00028C 428C C602             7      ADD A,2
00028E 428E CD9942          17      CALL    CHK_RAM_SLT
000291 4291 C8              11      RET Z
000292 4292 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000295 4295 E680             7      AND 080H
000297 4297 C603             7      ADD A,3
       4299                     CHK_RAM_SLT:
000299 4299 E5              11      PUSH    HL
00029A 429A CDC242          17      CALL    CHK_RAM0        ;スロット#X or X-0
00029D 429D E1              10      POP HL
00029E 429E C8              11      RET Z
00029F 429F CB79             8      BIT 7,C
0002A1 42A1 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
0002A3 42A3 79               4      LD  A,C
0002A4 42A4 C604             7      ADD A,4*1           ;スロット#X-1
0002A6 42A6 E5              11      PUSH    HL
0002A7 42A7 CDC242          17      CALL    CHK_RAM0
0002AA 42AA E1              10      POP HL
0002AB 42AB C8              11      RET Z
0002AC 42AC 79               4      LD  A,C
0002AD 42AD C608             7      ADD A,4*2           ;スロット#X-2
0002AF 42AF E5              11      PUSH    HL
0002B0 42B0 CDC242          17      CALL    CHK_RAM0
0002B3 42B3 E1              10      POP HL
0002B4 42B4 C8              11      RET Z
0002B5 42B5 79               4      LD  A,C
0002B6 42B6 C60C             7      ADD A,4*3           ;スロット#X-3
0002B8 42B8 E5              11      PUSH    HL
0002B9 42B9 CDC242          17      CALL    CHK_RAM0
0002BC 42BC E1              10      POP HL
       42BD                     CHK_RAM_E:
0002BD 42BD AF               4      XOR A
0002BE 42BE 3C               4      INC A           ;ZF=0にする
0002BF 42BF 3E00             7      LD  A,0
0002C1 42C1 C9              10      RET
                                
       42C2                     CHK_RAM0:
0002C2 42C2 4F               4      LD  C,A
0002C3 42C3 3A00F1          13      LD  A,(ROM_SLT)
0002C6 42C6 B9               4      CP  C
0002C7 42C7 28F4            12      JR  Z,CHK_RAM_E
0002C9 42C9 2E00             7      LD  L,0
       42CB                     CHK_RAM1:
0002CB 42CB 79               4      LD  A,C
0002CC 42CC DD210C00        14      LD  IX,_RDSLT
0002D0 42D0 CDFD42          17      CALL    CALSLT_R
0002D3 42D3 C6E5             7      ADD A,0E5H
0002D5 42D5 47               4      LD  B,A
0002D6 42D6 5F               4      LD  E,A
0002D7 42D7 79               4      LD  A,C
0002D8 42D8 DD211400        14      LD  IX,_WRSLT
0002DC 42DC CDFD42          17      CALL    CALSLT_R
0002DF 42DF 79               4      LD  A,C
0002E0 42E0 DD210C00        14      LD  IX,_RDSLT
0002E4 42E4 CDFD42          17      CALL    CALSLT_R
0002E7 42E7 B8               4      CP  B
0002E8 42E8 C0              11      RET NZ
0002E9 42E9 D6E5             7      SUB 0E5H
0002EB 42EB 79               4      LD  A,C
0002EC 42EC 5F               4      LD  E,A
0002ED 42ED DD211400        14      LD  IX,_WRSLT
0002F1 42F1 CDFD42          17      CALL    CALSLT_R
0002F4 42F4 24               4      INC H
0002F5 42F5 7D               4      LD  A,L
0002F6 42F6 C604             7      ADD A,4
0002F8 42F8 6F               4      LD  L,A
0002F9 42F9 20D0            12      JR  NZ,CHK_RAM1
0002FB 42FB 79               4      LD  A,C     ;ZF=1のハズ
0002FC 42FC C9              10      RET
                                
       42FD                     CALSLT_R:
0002FD 42FD C5              11      PUSH    BC
0002FE 42FE E5              11      PUSH    HL
0002FF 42FF FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000303 4303 CD1C00          17      CALL    _CALSLT
000306 4306 E1              10      POP HL
000307 4307 C1              10      POP BC
000308 4308 C9              10      RET
                                
       4309                     AT_ISC:
000309 F0E9                         ORG ISC,AT_ISC-RUN
       F0E9                     REPLACE_COMMAND:
000309 F0E9 FEB7             7      CP  0B7H            ;FILES
00030B F0EB CC7BFE          17      CALL    Z,H_FILE
00030E F0EE FEB5             7      CP  0B5H            ;LOAD
000310 F0F0 CA71FE          10      JP  Z,H_BINS
000313 F0F3 FE8A             7      CP  08AH            ;RUN
000315 F0F5 CA76FE          10      JP  Z,H_BINL
000318 F0F8 FED6             7      CP  0D6H            ;COPY
00031A F0FA 2813            12      JR  Z,FIX_COPY
00031C F0FC FECF             7      CP  0CFH            ;BLOAD
00031E F0FE C0              11      RET NZ
       F0FF                     FIX_BLOAD:
00031F F0FF F7              12      RST 30H
       F100                     ROM_SLT:
000320 F100 00                      DB  0
000321 F101 9D45                    DW  ROM_BLOAD
000323 F103 F5              11      PUSH    AF
000324 F104 E5              11      PUSH    HL
000325 F105 CD0EF1          17      CALL    BLOAD_RET
       F106                     SWC_BLOAD   EQU $-2
000328 F108 E1              10      POP HL
000329 F109 F1              10      POP AF
00032A F10A FECF             7      CP  0CFH            ;BLOAD
       F10C                     SWC_BLOAD_M:
00032C F10C 28DB            12      JR  Z,REPLACE_COMMAND
       F10E                     BLOAD_RET:
00032E F10E C9              10      RET
       F10F                     FIX_COPY:
00032F F10F F7              12      RST 30H
       F110                     ROM_SLT_COPY:
000330 F110 00                      DB  0
000331 F111 ED46                    DW  ROM_COPY
000333 F113 C9              10      RET
       F114                     ROMUSE1:
000334 F114 3A00F1          13      LD  A,(ROM_SLT)
000337 F117 1803            12      JR  ROMUSE2
       F119                     RAMUSE1:
000339 F119 3A42F3          13      LD  A,(RAMAD1)
       F11C                     ROMUSE2:
00033C F11C C32400          10      JP  _ENASLT
                                
       F11F                     _RESULT:
00033F F11F 00                      DB  0
       F120                     _BANK:
000340 F120 00                      DB  0
       F121                     CLSZ:               ;クラスタサイズ
000341 F121 0004                    DW  1024
       F122                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F123                     SECSZ:              ;セクタサイズ
000343 F123 0002                    DW  512
       F124                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F125                     RR_LOW:
000345 F125 0000                    DW  0
       F126                     RR_MID  EQU $-1
       F127                     RR_HIGH:
000347 F127 0000                    DW  0
       F129                     _CLPS:
000349 F129 0000                    DW  0
       F12B                     _LEFT:
00034B F12B 0000                    DW  0
       F12D                     _DTPS:
00034D F12D 0000                    DW  0
       F12F                     _DTA:
00034F F12F 0000                    DW  0
       F131                     FLG_LDIR:
000351 F131 00                      DB  0
                                
                                ;   BDOS
000352 F132 F7              12      RST 30H
000353 F133 00                      DB  0
000354 F134 1A4F                    DW  ROM_BDOS
000356 F136 C9              10      RET 
       F137                     _FCB:
000357 F137 0000                    DW  0
       F139                     _BUF:
       F139                     _BUF_LO:        ;LOGICAL OPERATION
000359 F139 00                      DB  0
       F13A                     _BUF_ST:
00035A F13A 0000                    DW  0
       F13C                     _BUF_EN:
00035C F13C 0000                    DW  0
       F13E                     _BUF_EX:
       F13E                     _BUF_W:
00035E F13E 0000                    DW  0
       F140                     _BUF_H:
000360 F140 0000                    DW  0
       F142                     _BUF_X:
000362 F142 0000                    DW  0
       F144                     _BUF_Y:
000364 F144 00                      DB  0
       F145                     _BUF_P:
000365 F145 00                      DB  0
       F146                     _BUF_O:
000366 F146 00                      DB  0
       F147                     DTAX:
000367 F147 0000                    DW  0
       F149                     B_DRIVE:
000369 F149 00                      DB  0
       F14A                     _DVSW:
00036A F14A 00                      DB  0
       F14B                     FCBX:
00036B F14B 0000                    DW  0
       F14D                     LEFTX:
00036D F14D 0000                    DW  0
       F14F                     PARAM0:
00036F F14F 0000                    DW  0
       F151                     PARAM1:
000371 F151 0000                    DW  0
       F153                     FDRV:
000373 F153 00                      DB  0
       F154                     FNAME:
000374 F154                         DS  8+3
                                
       F15F                     BASSTK:
00037F F15F 0000                    DW  0
       F161                     _HL:
000381 F161 0000                    DW  0
       F163                     _SP:
000383 F163 0000                    DW  0
                                
       F165                     ISC_E:
000385 4385                         ORG $$+RUN          ;$DEPHASE
                                
       4385                     MSX1:
000385 4385 CD334F          17      CALL    MSGA1
       4388                     MSX:
000388 4388 7E               7      LD  A,(HL)
000389 4389 23               6      INC HL
00038A 438A B7               4      OR  A
00038B 438B 20F8            12      JR  NZ,MSX1
00038D 438D C9              10      RET
                                
       438E                     PRTHX:
00038E 438E F5              11      PUSH    AF
00038F 438F 07               4      RLCA
000390 4390 07               4      RLCA
000391 4391 07               4      RLCA
000392 4392 07               4      RLCA
000393 4393 CD9743          17      CALL    PRTA2
000396 4396 F1              10      POP AF
       4397                     PRTA2:
000397 4397 CD9D43          17      CALL    ASC
00039A 439A C32F4F          10      JP  MSG_A
                                    
       439D                     ASC:
00039D 439D E60F             7      AND $0F
00039F 439F F630             7      OR  $30
0003A1 43A1 FE3A             7      CP  $3A
0003A3 43A3 D8              11      RET C
0003A4 43A4 C607             7      ADD A,7
0003A6 43A6 C9              10      RET
                                
       43A7                     MSN:
0003A7 43A7 7E               7      LD  A,(HL)
0003A8 43A8 23               6      INC HL
0003A9 43A9 CD2F4F          17      CALL    MSG_A
0003AC 43AC 10F9            13      DJNZ    MSN
0003AE 43AE C9              10      RET
                                
       43AF                     ROM_STKE:
0003AF 43AF 3E                      DB  03EH
0003B0 43B0 C9              10      RET
0003B1 43B1 32DAFE          13      LD  (H_STKE),A
0003B4 43B4 E5              11      PUSH    HL
0003B5 43B5 D5              11      PUSH    DE
0003B6 43B6 C5              11      PUSH    BC
0003B7 43B7 181D            12      JR  BASAUTO
                                
0003B9 43B9 AF               4      XOR A
0003BA 43BA 5F               4      LD  E,A
0003BB 43BB 57               4      LD  D,A
0003BC 43BC 0601             7      LD  B,1
0003BE 43BE 2100C0          10      LD  HL,0C000H
0003C1 43C1 CD3D4D          17      CALL    DISKIO
                                
0003C4 43C4 ED735FF1        20      LD  (BASSTK),SP
0003C8 43C8 116BF3          10      LD  DE,RAMUSE
0003CB 43CB AF               4      XOR A
0003CC 43CC CD1EC0          17      CALL    0C01EH
0003CF 43CF 116BF3          10      LD  DE,RAMUSE
0003D2 43D2 37               4      SCF
0003D3 43D3 CD1EC0          17      CALL    0C01EH
       43D6                     BASAUTO:
0003D6 43D6 212344          10      LD  HL,AUTOEXEC
0003D9 43D9 1153F1          10      LD  DE,FDRV
0003DC 43DC 010C00          10      LD  BC,1+8+3
0003DF 43DF EDB0                    LDIR
0003E1 43E1 CDB34A          17      CALL    ROM_OPEN
0003E4 43E4 3813            12      JR  C,RSTKEE
0003E6 43E6 212F44          10      LD  HL,RUN_AUTOEXEC
0003E9 43E9 11F0FB          10      LD  DE,KEYBUF
0003EC 43EC ED53FAF3        20      LD  (GETPNT),DE
0003F0 43F0 011300          10      LD  BC,RUN_AUTOEXEC_E-RUN_AUTOEXEC
0003F3 43F3 EDB0                    LDIR
0003F5 43F5 ED53F8F3        20      LD  (PUTPNT),DE
       43F9                     RSTKEE:
0003F9 43F9 C1              10      POP BC
0003FA 43FA D1              10      POP DE
0003FB 43FB E1              10      POP HL
0003FC 43FC C9              10      RET
                                
       43FD                     MSG_ERROR_ROM_MODE:
0003FD 43FD 41534349492D384B        DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
            2F4B6F6E616D692D    
            384B2F4B6F6E616D    
            692D534343206F6E    
            6C79210D0A          
       4422                     NULL:
000422 4422 00                      DB  0
                                
       4423                     AUTOEXEC:
000423 4423 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       442F                     RUN_AUTOEXEC:
00042F 442F 52554E2022415554        DB  'RUN "AUTOEXEC.BAS"',00DH
            4F455845432E4241    
            53220D              
                                ;   DB  'LOAD "AUTOEXEC.BAS"',00DH  ;テスト用
       4442                     RUN_AUTOEXEC_E:
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       4442                     ROM_LDIR:
000442 4442 3A31F1          13      LD  A,(FLG_LDIR)
000445 4445 B7               4      OR  A
000446 4446 2008            12      JR  NZ,ROM_LDIRVM
000448 4448 CB7A             8      BIT 7,D
00044A 444A CA6244          10      JP  Z,ROM_LDIRSLT
                                
                                #if exists USE_NORMAL_32K_ROM
                                    LD  (_SP),SP
                                    LD  SP,DRVTBL
                                LDIR1:
                                    LD  A,B
                                    OR  C
                                    JR  Z,LDIRE
                                
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                LDIR2:
                                    LD  A,D
                                    CP  0C0H
                                    JR  NC,LDIR4
                                
                                    PUSH    BC
                                    PUSH    DE
                                    LD  DE,BUF
                                
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIR3
                                    LD  BC,00100H
                                LDIR3:
                                    PUSH    BC
                                    LDIR
                                    LD  (_HL),HL
                                
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                
                                    LD  HL,BUF
                                    POP BC
                                    POP DE
                                    LDIR
                                
                                    LD  HL,(_HL)
                                    POP BC
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIRE
                                    DEC B
                                    JR  LDIR1
                                LDIR4:
                                #endif
00044D 444D EDB0                    LDIR
                                
                                #if exists USE_NORMAL_32K_ROM
                                LDIRE:
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    LD  SP,(_SP)
                                #endif
00044F 444F C9              10      RET
                                
       4450                     ROM_LDIRVM:
                                #if exists USE_NORMAL_32K_ROM
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
000450 4450 C5              11      PUSH    BC
000451 4451 D5              11      PUSH    DE
000452 4452 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000456 4456 DD215C00        14      LD  IX,LDIRVM
00045A 445A CD1C00          17      CALL    _CALSLT
                                #if exists USE_NORMAL_32K_ROM
                                    LD  H,080H
                                    LD  A,(RAMAD2)
                                    CALL    _ENASLT
                                #endif
00045D 445D E1              10      POP HL
00045E 445E C1              10      POP BC
00045F 445F 09              11      ADD HL,BC
000460 4460 EB               4      EX  DE,HL
000461 4461 C9              10      RET
                                
       4462                     ROM_LDIRSLT:
000462 4462 EB               4      EX  DE,HL
       4463                     RLDIRSLT1:
000463 4463 1A               7      LD  A,(DE)
000464 4464 13               6      INC DE
000465 4465 C5              11      PUSH    BC
000466 4466 D5              11      PUSH    DE
000467 4467 E5              11      PUSH    HL
000468 4468 5F               4      LD  E,A
000469 4469 3A42F3          13      LD  A,(RAMAD1)
00046C 446C FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000470 4470 DD211400        14      LD  IX,_WRSLT
000474 4474 CD1C00          17      CALL    _CALSLT
000477 4477 E1              10      POP HL
000478 4478 D1              10      POP DE
000479 4479 C1              10      POP BC
00047A 447A EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00047C 447C EA6344          10      JP  PE,RLDIRSLT1
00047F 447F EB               4      EX  DE,HL
000480 4480 C9              10      RET
                                
       4481                     END_OF_LINE:
000481 4481 215EF5          10      LD  HL,BUF
       4484                     EOL1:
000484 4484 7E               7      LD  A,(HL)
000485 4485 C8              11      RET Z
000486 4486 FE0D             7      CP  00DH
000488 4488 2807            12      JR  Z,EOLE
00048A 448A FE0A             7      CP  00AH
00048C 448C 2803            12      JR  Z,EOLE
00048E 448E 23               6      INC HL
00048F 448F 18F3            12      JR  EOL1
       4491                     EOLE:
000491 4491 3600            10      LD  (HL),0
000493 4493 23               6      INC HL
000494 4494 7E               7      LD  A,(HL)
000495 4495 FE0A             7      CP  00AH
000497 4497 C0              11      RET NZ
000498 4498 23               6      INC HL
000499 4499 C9              10      RET
                                
       449A                     ROM_LOAD_ASCII:
00049A 449A 210000          10      LD  HL,0
00049D 449D 223AF1          16      LD  (_BUF_ST),HL    ;読み出し位置
0004A0 44A0 2A76F6          16      LD  HL,(TXTTAB)
0004A3 44A3 223CF1          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
0004A6 44A6 215EF5          10      LD  HL,BUF
0004A9 44A9 222FF1          16      LD  (_DTA),HL
       44AC                     RLOAD_A1:
0004AC 44AC 2A3AF1          16      LD  HL,(_BUF_ST)
0004AF 44AF 2225F1          16      LD  (RR_LOW),HL
0004B2 44B2 210201          10      LD  HL,258
0004B5 44B5 CDD348          17      CALL    ROM_READ
0004B8 44B8 7C               4      LD  A,H
0004B9 44B9 B5               4      OR  L
0004BA 44BA 2877            12      JR  Z,RLOAD_AEND
0004BC 44BC 015EF5          10      LD  BC,BUF
0004BF 44BF 09              11      ADD HL,BC
0004C0 44C0 3600            10      LD  (HL),0
0004C2 44C2 CD8144          17      CALL    END_OF_LINE
0004C5 44C5 015EF5          10      LD  BC,BUF
0004C8 44C8 A7               4      AND A
0004C9 44C9 ED42            15      SBC HL,BC
0004CB 44CB 2810            12      JR  Z,RLOAD_A2
0004CD 44CD 4D               4      LD  C,L
0004CE 44CE 44               4      LD  B,H
0004CF 44CF ED5B3AF1        20      LD  DE,(_BUF_ST)
0004D3 44D3 19              11      ADD HL,DE
0004D4 44D4 223AF1          16      LD  (_BUF_ST),HL
0004D7 44D7 3A5EF5          13      LD  A,(BUF)
0004DA 44DA B7               4      OR  A
0004DB 44DB 28CF            12      JR  Z,RLOAD_A1
       44DD                     RLOAD_A2:
0004DD 44DD 115EF5          10      LD  DE,BUF
0004E0 44E0 CD4A4A          17      CALL    SPCUTEX
0004E3 44E3 1A               7      LD  A,(DE)
0004E4 44E4 B7               4      OR  A
0004E5 44E5 284C            12      JR  Z,RLOAD_AEND
0004E7 44E7 CD5C4A          17      CALL    GETNUM
0004EA 44EA 7C               4      LD  A,H
0004EB 44EB B5               4      OR  L
0004EC 44EC CA8A45          10      JP  Z,ERROR_DIRECT_IN_FILE
0004EF 44EF DD2A3CF1        20      LD  IX,(_BUF_EN)
0004F3 44F3 DD7502          19      LD  (IX+2),L
0004F6 44F6 DD7403          19      LD  (IX+3),H
                                
0004F9 44F9 CD434A          17      CALL    SPCUT
0004FC 44FC EB               4      EX  DE,HL
0004FD 44FD DDE5            15      PUSH    IX
0004FF 44FF DD21B242        14      LD  IX,CRUNCH
000503 4503 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000507 4507 CD1C00          17      CALL    _CALSLT
00050A 450A DDE1            14      POP IX
00050C 450C EB               4      EX  DE,HL
00050D 450D 111FF4          10      LD  DE,KBUF
000510 4510 37               4      SCF
000511 4511 ED52            15      SBC HL,DE
000513 4513 2875            12      JR  Z,ERROR_DIRECT_IN_FILE
000515 4515 3873            12      JR  C,ERROR_DIRECT_IN_FILE
000517 4517 4D               4      LD  C,L
000518 4518 44               4      LD  B,H
000519 4519 2A3CF1          16      LD  HL,(_BUF_EN)
00051C 451C 110400          10      LD  DE,4
00051F 451F 19              11      ADD HL,DE
000520 4520 111FF4          10      LD  DE,KBUF
                                
000523 4523 EB               4      EX  DE,HL
000524 4524 EDB0                    LDIR
000526 4526 EB               4      EX  DE,HL
                                
000527 4527 DD7500          19      LD  (IX+0),L
00052A 452A DD7401          19      LD  (IX+1),H
00052D 452D 223CF1          16      LD  (_BUF_EN),HL
000530 4530 C3AC44          10      JP  RLOAD_A1
                                
       4533                     RLOAD_AEND:
000533 4533 2A3CF1          16      LD  HL,(_BUF_EN)
000536 4536 AF               4      XOR A
000537 4537 77               7      LD  (HL),A
000538 4538 23               6      INC HL
000539 4539 77               7      LD  (HL),A
00053A 453A 23               6      INC HL
00053B 453B 223CF1          16      LD  (_BUF_EN),HL
00053E 453E 1833            12      JR  RLOAD_END1
                                
       4540                     ROM_LOAD:
000540 4540 CDBE46          17      CALL    INIT_PARAM
000543 4543 CD7349          17      CALL    FILE_B
000546 4546 CDB34A          17      CALL    ROM_OPEN
000549 4549 3845            12      JR  C,ERROR_FILE_NOT_FOUND
                                
00054B 454B 2139F1          10      LD  HL,_BUF
00054E 454E 222FF1          16      LD  (_DTA),HL
000551 4551 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
000554 4554 CDD348          17      CALL    ROM_READ
000557 4557 3A39F1          13      LD  A,(_BUF)
00055A 455A 3C               4      INC A
00055B 455B C29A44          10      JP  NZ,ROM_LOAD_ASCII
00055E 455E 2A76F6          16      LD  HL,(TXTTAB)
000561 4561 222FF1          16      LD  (_DTA),HL
000564 4564 EB               4      EX  DE,HL
000565 4565 2100FF          10      LD  HL,-256
000568 4568 39              11      ADD HL,SP
000569 4569 ED52            15      SBC HL,DE
00056B 456B CDD348          17      CALL    ROM_READ
00056E 456E ED5B2FF1        20      LD  DE,(_DTA)
000572 4572 19              11      ADD HL,DE
       4573                     RLOAD_END1:
000573 4573 22C2F6          16      LD  (VARTAB),HL
000576 4576 22C4F6          16      LD  (ARYTAB),HL
000579 4579 22C6F6          16      LD  (STREND),HL
                                
00057C 457C AF               4      XOR A
00057D 457D 213CF1          10      LD  HL,_BUF+3
000580 4580 77               7      LD  (HL),A
000581 4581 2B               6      DEC HL
000582 4582 77               7      LD  (HL),A
000583 4583 2B               6      DEC HL
000584 4584 77               7      LD  (HL),A
000585 4585 2B               6      DEC HL
000586 4586 3E8F             7      LD  A,08FH          ;REM
000588 4588 77               7      LD  (HL),A
000589 4589 C9              10      RET
                                
       458A                     ERROR_DIRECT_IN_FILE:
00058A 458A 1E39             7      LD  E,57            ;Direct statement in file
00058C 458C 01                      DB  1           ;LD BC,
       458D                     ERROR_FILE_NOT_OPEN:
00058D 458D 1E3B             7      LD  E,59            ;File not OPEN
00058F 458F 01                      DB  1           ;LD BC,
       4590                     ERROR_FILE_NOT_FOUND:
000590 4590 1E35             7      LD  E,53            ;File not found
       4592                     ERROR:
000592 4592 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000596 4596 DD216F40        14      LD  IX,ERRHAND
00059A 459A C31C00          10      JP  _CALSLT
                                
       459D                     ROM_BLOAD:
00059D 459D CDBE46          17      CALL    INIT_PARAM
0005A0 45A0 CD7349          17      CALL    FILE_B
0005A3 45A3 CDB34A          17      CALL    ROM_OPEN
0005A6 45A6 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
0005A8 45A8 2139F1          10      LD  HL,_BUF
0005AB 45AB 222FF1          16      LD  (_DTA),HL
0005AE 45AE 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
0005B1 45B1 CDD348          17      CALL    ROM_READ
0005B4 45B4 3A39F1          13      LD  A,(_BUF)
0005B7 45B7 FEFE             7      CP  0FEH
0005B9 45B9 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
0005BB 45BB 210EF1          10      LD  HL,BLOAD_RET
0005BE 45BE 2206F1          16      LD  (SWC_BLOAD),HL
                                
0005C1 45C1 2A51F1          16      LD  HL,(PARAM1)
0005C4 45C4 7E               7      LD  A,(HL)
0005C5 45C5 FE2C             7      CP  ','
0005C7 45C7 2048            12      JR  NZ,RBREAD_MEM
0005C9 45C9 23               6      INC HL
0005CA 45CA 7E               7      LD  A,(HL)
0005CB 45CB CD9D4A          17      CALL    CAP
0005CE 45CE 32BEFC          13      LD  (RUNBNF),A
       45D1                     RBOS1:
0005D1 45D1 7E               7      LD  A,(HL)
0005D2 45D2 23               6      INC HL
0005D3 45D3 B7               4      OR  A
0005D4 45D4 282F            12      JR  Z,RBREAD_OSE
0005D6 45D6 FE3A             7      CP  ':'
0005D8 45D8 282B            12      JR  Z,RBREAD_OSE
0005DA 45DA FE2C             7      CP  ','     ;次のパラメータを探す
0005DC 45DC 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
0005DE 45DE 2251F1          16      LD  (PARAM1),HL
0005E1 45E1 7E               7      LD  A,(HL)
0005E2 45E2 B7               4      OR  A
0005E3 45E3 2820            12      JR  Z,RBREAD_OSE
0005E5 45E5 DD21644C        14      LD  IX,FRMEVL
0005E9 45E9 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0005ED 45ED CD1C00          17      CALL    _CALSLT
0005F0 45F0 2251F1          16      LD  (PARAM1),HL
0005F3 45F3 3A63F6          13      LD  A,(VALTYP)
0005F6 45F6 FE02             7      CP  2
0005F8 45F8 200B            12      JR  NZ,RBREAD_OSE
0005FA 45FA 2A3AF1          16      LD  HL,(_BUF_ST)
0005FD 45FD ED5BF8F7        20      LD  DE,(DACDAT)
000601 4601 19              11      ADD HL,DE
000602 4602 223AF1          16      LD  (_BUF_ST),HL
       4605                     RBREAD_OSE:
000605 4605 3ABEFC          13      LD  A,(RUNBNF)
000608 4608 FE53             7      CP  'S'
00060A 460A 2005            12      JR  NZ,RBREAD_MEM
00060C 460C 3E01             7      LD  A,1
00060E 460E 3231F1          13      LD  (FLG_LDIR),A
       4611                     RBREAD_MEM:
000611 4611 2A3AF1          16      LD  HL,(_BUF_ST)
000614 4614 22BFFC          16      LD  (SAVENT),HL
000617 4617 222FF1          16      LD  (_DTA),HL
00061A 461A 21FFFF          10      LD  HL,0FFFFH
00061D 461D CDD348          17      CALL    ROM_READ
000620 4620 3ABEFC          13      LD  A,(RUNBNF)
000623 4623 FE52             7      CP  'R'
000625 4625 2006            12      JR  NZ,RBREAD1
000627 4627 2A3EF1          16      LD  HL,(_BUF_EX)
00062A 462A 2206F1          16      LD  (SWC_BLOAD),HL
       462D                     RBREAD1:
       462D                     ROM_NEXT:
00062D 462D 2A51F1          16      LD  HL,(PARAM1)
000630 4630 7E               7      LD  A,(HL)
000631 4631 2B               6      DEC HL
000632 4632 B7               4      OR  A
000633 4633 2805            12      JR  Z,RN1
000635 4635 FE3A             7      CP  ':'
000637 4637 2801            12      JR  Z,RN1
000639 4639 23               6      INC HL
       463A                     RN1:
00063A 463A 5D               4      LD  E,L
00063B 463B 54               4      LD  D,H
                                
00063C 463C CD734A          17      CALL    SEARCH_END
00063F 463F B7               4      OR  A
000640 4640 2815            12      JR  Z,REM
                                                    ;マルチステートメントの処理
000642 4642 7E               7      LD  A,(HL)
                                
000643 4643 FEB5             7      CP  0B5H            ;LOAD
000645 4645 CA4045          10      JP  Z,ROM_LOAD
000648 4648 FE8A             7      CP  08AH            ;RUN
00064A 464A 280F            12      JR  Z,ROM_RUN
00064C 464C FEB7             7      CP  0B7H            ;FILES
00064E 464E 2818            12      JR  Z,ROM_FILES
000650 4650 3E28             7      LD  A,028H          ;JR Z,
000652 4652 320CF1          13      LD  (SWC_BLOAD_M),A
000655 4655 7E               7      LD  A,(HL)
000656 4656 C9              10      RET
                                
       4657                     REM:
000657 4657 EB               4      EX  DE,HL
000658 4658 3E8F             7      LD  A,08FH          ;REM
00065A 465A C9              10      RET
                                
       465B                     ROM_RUN:
00065B 465B 23               6      INC HL
00065C 465C 7E               7      LD  A,(HL)
00065D 465D 2B               6      DEC HL
00065E 465E B7               4      OR  A
00065F 465F 2803            12      JR  Z,ROM_RUN1
000661 4661 CD4045          17      CALL    ROM_LOAD
       4664                     ROM_RUN1:
000664 4664 3E8A             7      LD  A,08AH          ;RUN
000666 4666 77               7      LD  (HL),A
000667 4667 C9              10      RET
                                
       4668                     ROM_FILES:
000668 4668 CDBE46          17      CALL    INIT_PARAM
00066B 466B CD7349          17      CALL    FILE_B
00066E 466E CDD24E          17      CALL    GET_DISK_BANK_FDRV
000671 4671 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000674 4674 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000677 4677 3A54F1          13      LD  A,(FNAME)
00067A 467A FE21             7      CP  021H
00067C 467C 3005            12      JR  NC,RFILES0
00067E 467E 060B             7      LD  B,11
000680 4680 CD074A          17      CALL    FILE10
       4683                     RFILES0:
000683 4683 CDFB4C          17      CALL    GET_DIR_DAT
       4686                     RFILES1:
000686 4686 CDCF4A          17      CALL    FILESE
000689 4689 302E            12      JR  NC,RFILES_NOT_MATCH
       468B                     RFILES_DISP:
00068B 468B E5              11      PUSH    HL
00068C 468C 0608             7      LD  B,8
00068E 468E CDA743          17      CALL    MSN
000691 4691 3E2E             7      LD  A,'.'
000693 4693 CD2F4F          17      CALL    MSG_A
000696 4696 0603             7      LD  B,3
000698 4698 CDA743          17      CALL    MSN
00069B 469B 3ADDF3          13      LD  A,(CSRX)
00069E 469E 47               4      LD  B,A
00069F 469F 3AB0F3          13      LD  A,(LINLEN)
0006A2 46A2 90               4      SUB B
0006A3 46A3 FE0C             7      CP  12
0006A5 46A5 3009            12      JR  NC,RFILES2
0006A7 46A7 3E0D             7      LD  A,00DH      ;改行
0006A9 46A9 CD2F4F          17      CALL    MSG_A
0006AC 46AC 3E0A             7      LD  A,00AH
0006AE 46AE 1802            12      JR  RFILES3
       46B0                     RFILES2:
0006B0 46B0 3E20             7      LD  A,020H
       46B2                     RFILES3:
0006B2 46B2 CD2F4F          17      CALL    MSG_A
0006B5 46B5 E1              10      POP HL
0006B6 46B6 CDEB4A          17      CALL    FNEXT
       46B9                     RFILES_NOT_MATCH:
0006B9 46B9 20CB            12      JR  NZ,RFILES1
0006BB 46BB C32D46          10      JP  ROM_NEXT
                                
       46BE                     INIT_PARAM:
0006BE 46BE 224FF1          16      LD  (PARAM0),HL
0006C1 46C1 2251F1          16      LD  (PARAM1),HL
0006C4 46C4 EB               4      EX  DE,HL
0006C5 46C5 AF               4      XOR A
0006C6 46C6 3231F1          13      LD  (FLG_LDIR),A
0006C9 46C9 32BEFC          13      LD  (RUNBNF),A
0006CC 46CC 3263F6          13      LD  (VALTYP),A
0006CF 46CF 13               6      INC DE
0006D0 46D0 CD434A          17      CALL    SPCUT
0006D3 46D3 1A               7      LD  A,(DE)
0006D4 46D4 B7               4      OR  A
0006D5 46D5 C8              11      RET Z
0006D6 46D6 FE3A             7      CP  ':'
0006D8 46D8 C8              11      RET Z
0006D9 46D9 FE28             7      CP  '('
0006DB 46DB C8              11      RET Z
0006DC 46DC EB               4      EX  DE,HL
0006DD 46DD DD21644C        14      LD  IX,FRMEVL
0006E1 46E1 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0006E5 46E5 CD1C00          17      CALL    _CALSLT
0006E8 46E8 2251F1          16      LD  (PARAM1),HL
0006EB 46EB C9              10      RET
                                
0006EC 46EC 00               4      NOP
       46ED                     ROM_COPY:
0006ED 46ED CDBE46          17      CALL    INIT_PARAM
0006F0 46F0 3A63F6          13      LD  A,(VALTYP)
0006F3 46F3 FE03             7      CP  3       ;string
0006F5 46F5 C26E49          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
0006F8 46F8 CD7349          17      CALL    FILE_B
0006FB 46FB CDB34A          17      CALL    ROM_OPEN
0006FE 46FE DA9045          10      JP  C,ERROR_FILE_NOT_FOUND
                                
000701 4701 213EF1          10      LD  HL,_BUF_W
000704 4704 222FF1          16      LD  (_DTA),HL
000707 4707 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
00070A 470A CDD348          17      CALL    ROM_READ
                                
00070D 470D AF               4      XOR A
00070E 470E 3239F1          13      LD  (_BUF_LO),A     ;PSET
000711 4711 3246F1          13      LD  (_BUF_O),A      ;向き
                                
000714 4714 2A51F1          16      LD  HL,(PARAM1)
       4717                     RCP_PARAM1:
000717 4717 7E               7      LD  A,(HL)
000718 4718 23               6      INC HL
000719 4719 B7               4      OR  A
00071A 471A CA6E49          10      JP  Z,ROM_ORG
00071D 471D FE3A             7      CP  ':'
00071F 471F CA6E49          10      JP  Z,ROM_ORG
000722 4722 FE2C             7      CP  ','
000724 4724 2012            12      JR  NZ,RCP_PARAM1_
                                
000726 4726 DD212F54        14      LD  IX,FRMQNT
00072A 472A FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00072E 472E CD1C00          17      CALL    _CALSLT
000731 4731 7B               4      LD  A,E
000732 4732 87               4      ADD A,A
000733 4733 87               4      ADD A,A
000734 4734 3246F1          13      LD  (_BUF_O),A
000737 4737 7E               7      LD  A,(HL)
       4738                     RCP_PARAM1_:
000738 4738 FE28             7      CP  '('
00073A 473A 20DB            12      JR  NZ,RCP_PARAM1
                                
00073C 473C DD212F54        14      LD  IX,FRMQNT
000740 4740 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000744 4744 CD1C00          17      CALL    _CALSLT
                                
000747 4747 ED5342F1        20      LD  (_BUF_X),DE
                                
       474B                     RCP_PARAM2:
00074B 474B 23               6      INC HL
00074C 474C 7E               7      LD  A,(HL)
00074D 474D FE20             7      CP  020H
00074F 474F 28FA            12      JR  Z,RCP_PARAM2
000751 4751 FE2C             7      CP  ','
000753 4753 28F6            12      JR  Z,RCP_PARAM2
                                
000755 4755 DD212F54        14      LD  IX,FRMQNT
000759 4759 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00075D 475D CD1C00          17      CALL    _CALSLT
                                
000760 4760 ED5344F1        20      LD  (_BUF_Y),DE
       4764                     RCP_PARAM3:
000764 4764 23               6      INC HL
000765 4765 7E               7      LD  A,(HL)
000766 4766 FE20             7      CP  020H
000768 4768 28FA            12      JR  Z,RCP_PARAM3
00076A 476A FE29             7      CP  ')'
00076C 476C 28F6            12      JR  Z,RCP_PARAM3
00076E 476E FE2C             7      CP  ','
000770 4770 2033            12      JR  NZ,RCP_ST
                                
000772 4772 23               6      INC HL
000773 4773 DD212F54        14      LD  IX,FRMQNT
000777 4777 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00077B 477B CD1C00          17      CALL    _CALSLT
                                
00077E 477E 7B               4      LD  A,E
00077F 477F 3245F1          13      LD  (_BUF_P),A
                                
       4782                     RCP_PARAM4:
000782 4782 7E               7      LD  A,(HL)
000783 4783 23               6      INC HL
000784 4784 FE20             7      CP  020H
000786 4786 28FA            12      JR  Z,RCP_PARAM4
                                
000788 4788 FE2C             7      CP  ','
00078A 478A 2019            12      JR  NZ,RCP_ST
                                
00078C 478C 7E               7      LD  A,(HL)
00078D 478D 0604             7      LD  B,4
00078F 478F FEC3             7      CP  0C3H        ;PRESET
000791 4791 280E            12      JR  Z,RCP_LO
000793 4793 05               4      DEC B       ;3
000794 4794 D6F8             7      SUB 0F8H        ;XOR
000796 4796 2809            12      JR  Z,RCP_LO
000798 4798 05               4      DEC B       ;2
000799 4799 3C               4      INC A       ;OR
00079A 479A 2805            12      JR  Z,RCP_LO
00079C 479C 05               4      DEC B       ;1
00079D 479D 3C               4      INC A       ;AND
00079E 479E 2801            12      JR  Z,RCP_LO
0007A0 47A0 05               4      DEC B       ;0
                                                ;PSET
       47A1                     RCP_LO:
0007A1 47A1 78               4      LD  A,B
0007A2 47A2 3239F1          13      LD  (_BUF_LO),A
       47A5                     RCP_ST:
0007A5 47A5 2AC6F6          16      LD  HL,(STREND)
0007A8 47A8 222FF1          16      LD  (_DTA),HL
0007AB 47AB EB               4      EX  DE,HL
0007AC 47AC 2100FE          10      LD  HL,-512
0007AF 47AF 39              11      ADD HL,SP
0007B0 47B0 AF               4      XOR A
0007B1 47B1 ED52            15      SBC HL,DE
0007B3 47B3 3008            12      JR  NC,RCP0
0007B5 47B5 215EF5          10      LD  HL,BUF
0007B8 47B8 222FF1          16      LD  (_DTA),HL
0007BB 47BB 6F               4      LD  L,A ;0
0007BC 47BC 67               4      LD  H,A ;0
       47BD                     RCP0:
0007BD 47BD 24               4      INC H
0007BE 47BE 223CF1          16      LD  (_BUF_EN),HL
       47C1                     RCP1:
0007C1 47C1 F3               4      DI
0007C2 47C2 CD6C48          17      CALL    WAIT_VDP
                                
0007C5 47C5 3A0700          13      LD  A,(WRVDP)
0007C8 47C8 4F               4      LD  C,A
0007C9 47C9 0C               4      INC C       ;C := PORT#1's address
0007CA 47CA 3E24             7      LD  A,36
0007CC 47CC ED79            12      OUT (C),A
0007CE 47CE 3E91             7      LD  A,080H+17
0007D0 47D0 ED79            12      OUT (C),A       ;R#17 := 36
                                
0007D2 47D2 0C               4      INC C
0007D3 47D3 0C               4      INC C       ;C := PORT#3's address
0007D4 47D4 2A42F1          16      LD  HL,(_BUF_X)
0007D7 47D7 ED69            12      OUT (C),L       ;R#36 DX
0007D9 47D9 ED61            12      OUT (C),H       ;R#37
0007DB 47DB 2A44F1          16      LD  HL,(_BUF_Y)
0007DE 47DE ED69            12      OUT (C),L       ;R#38 DY
0007E0 47E0 ED61            12      OUT (C),H       ;R#39
0007E2 47E2 2A3EF1          16      LD  HL,(_BUF_W)
0007E5 47E5 ED69            12      OUT (C),L       ;R#40 NX
0007E7 47E7 ED61            12      OUT (C),H       ;R#41
0007E9 47E9 2A40F1          16      LD  HL,(_BUF_H)
0007EC 47EC ED69            12      OUT (C),L       ;R#42 NY
0007EE 47EE ED61            12      OUT (C),H       ;R#43
                                
0007F0 47F0 DD2AAFFC        20      LD  IX,(SCRMOD)
0007F4 47F4 3A39F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0007F7 47F7 B7               4      OR  A
0007F8 47F8 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
0007FA 47FA DD7D             9      LD  A,IXL
0007FC 47FC FE08             7      CP  8
0007FE 47FE 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
000800 4800 FE06             7      CP  6
000802 4802 2A42F1          16      LD  HL,(_BUF_X)
000805 4805 3A3EF1          13      LD  A,(_BUF_W)
000808 4808 2005            12      JR  NZ,SCR57
00080A 480A B5               4      OR  L       ;スクリーン6
00080B 480B E603             7      AND 3
00080D 480D 200D            12      JR  NZ,USE_LMMC
       480F                     SCR57:              ;スクリーン5,7
00080F 480F B5               4      OR  L
000810 4810 E601             7      AND 1
000812 4812 2008            12      JR  NZ,USE_LMMC
       4814                     USE_HMMC:
000814 4814 DD2E08          10      LD  IXL,8
       4817                     USE_HMMC8:
000817 4817 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
000819 4819 3239F1          13      LD  (_BUF_LO),A
       481C                     USE_LMMC:
00081C 481C 110000          10      LD  DE,0
00081F 481F 06FF             7      LD  B,-1
000821 4821 CD8C48          17      CALL    GET_PIXEL
000824 4824 ED79            12      OUT (C),A       ;R#44 first DATA
000826 4826 3A46F1          13      LD  A,(_BUF_O)
000829 4829 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
00082B 482B 3A39F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00082E 482E F6B0             7      OR  0B0H        ;R#46 LMMC command
000830 4830 ED79            12      OUT (C),A
                                
000832 4832 0D               4      DEC C
000833 4833 0D               4      DEC C       ;C := PORT#1's address
000834 4834 3EAC             7      LD  A,080H+44
000836 4836 ED79            12      OUT (C),A
000838 4838 3E91             7      LD  A,080H+17
00083A 483A ED79            12      OUT (C),A       ;R#17 := 44
00083C 483C 0C               4      INC C
00083D 483D 0C               4      INC C       ;C := PORT#3's address
       483E                     LOOP_COPY:
00083E 483E CD8C48          17      CALL    GET_PIXEL
000841 4841 08               4      EX  AF,AF'
000842 4842 3E02             7      LD  A,2
000844 4844 CD5C48          17      CALL    GET_STATUS
000847 4847 CB47             8      BIT 0,A     ;check CE bit
000849 4849 2809            12      JR  Z,EXIT_COPY
00084B 484B CB7F             8      BIT 7,A     ;check TR bit
00084D 484D 28EF            12      JR  Z,LOOP_COPY
00084F 484F 08               4      EX  AF,AF'
000850 4850 ED79            12      OUT (C),A
000852 4852 18EA            12      JR  LOOP_COPY
                                
       4854                     EXIT_COPY:
000854 4854 AF               4      XOR A
000855 4855 CD5C48          17      CALL    GET_STATUS
                                
000858 4858 FB               4      EI
000859 4859 C32D46          10      JP  ROM_NEXT
                                
       485C                     GET_STATUS:
00085C 485C C5              11      PUSH    BC
00085D 485D ED4B0600        20      LD  BC,(RDVDP)
000861 4861 0C               4      INC C
000862 4862 ED79            12      OUT (C),A
000864 4864 3E8F             7      LD  A,8FH
000866 4866 ED79            12      OUT (C),A
000868 4868 ED78            12      IN  A,(C)
00086A 486A C1              10      POP BC
00086B 486B C9              10      RET
                                
       486C                     WAIT_VDP:
00086C 486C 3E02             7      LD  A,2
00086E 486E CD5C48          17      CALL    GET_STATUS
000871 4871 E601             7      AND 1
000873 4873 20F7            12      JR  NZ,WAIT_VDP
000875 4875 AF               4      XOR A
000876 4876 CD5C48          17      CALL    GET_STATUS
000879 4879 C9              10      RET
                                
       487A                     GET_PIXEL256:
00087A 487A 7A               4      LD  A,D
00087B 487B B3               4      OR  E
00087C 487C 200A            12      JR  NZ,GET_PIXEL1
                                
00087E 487E 2A3CF1          16      LD  HL,(_BUF_EN)
000881 4881 CDD348          17      CALL    ROM_READ
000884 4884 EB               4      EX  DE,HL
000885 4885 2A2FF1          16      LD  HL,(_DTA)
       4888                     GET_PIXEL1:
000888 4888 7E               7      LD  A,(HL)
000889 4889 23               6      INC HL
00088A 488A 1B               6      DEC DE
00088B 488B C9              10      RET
                                
       488C                     GET_PIXEL:
00088C 488C 04               4      INC B
00088D 488D DD7D             9      LD  A,IXL
00088F 488F FE08             7      CP  8
000891 4891 28E7            12      JR  Z,GET_PIXEL256
000893 4893 FE06             7      CP  6
000895 4895 282E            12      JR  Z,GET_PIXEL4
                                
000897 4897 CB40             8      BIT 0,B
000899 4899 20ED            12      JR  NZ,GET_PIXEL1
                                
00089B 489B 7A               4      LD  A,D
00089C 489C B3               4      OR  E
00089D 489D 200A            12      JR  NZ,GET_PIXEL2
                                
00089F 489F 2A3CF1          16      LD  HL,(_BUF_EN)
0008A2 48A2 CDD348          17      CALL    ROM_READ
0008A5 48A5 EB               4      EX  DE,HL
0008A6 48A6 2A2FF1          16      LD  HL,(_DTA)
                                
       48A9                     GET_PIXEL2:
0008A9 48A9 7E               7      LD  A,(HL)
0008AA 48AA 0F               4      RRCA
0008AB 48AB 0F               4      RRCA
0008AC 48AC 0F               4      RRCA
0008AD 48AD 0F               4      RRCA
0008AE 48AE C9              10      RET
                                
       48AF                     GET_PIXEL3:
0008AF 48AF 7A               4      LD  A,D
0008B0 48B0 B3               4      OR  E
0008B1 48B1 200A            12      JR  NZ,GET_PIXEL5
                                
0008B3 48B3 2A3CF1          16      LD  HL,(_BUF_EN)
0008B6 48B6 CDD348          17      CALL    ROM_READ
0008B9 48B9 EB               4      EX  DE,HL
0008BA 48BA 2A2FF1          16      LD  HL,(_DTA)
       48BD                     GET_PIXEL5:
0008BD 48BD 7E               7      LD  A,(HL)
0008BE 48BE 0F               4      RRCA
0008BF 48BF 0F               4      RRCA
0008C0 48C0 0F               4      RRCA
0008C1 48C1 0F               4      RRCA
0008C2 48C2 0F               4      RRCA
0008C3 48C3 0F               4      RRCA
0008C4 48C4 C9              10      RET
                                
       48C5                     GET_PIXEL4:
0008C5 48C5 78               4      LD  A,B
0008C6 48C6 E603             7      AND 3   ;+0
0008C8 48C8 28E5            12      JR  Z,GET_PIXEL3
0008CA 48CA 3D               4      DEC A   ;+1
0008CB 48CB 28DC            12      JR  Z,GET_PIXEL2
0008CD 48CD 3D               4      DEC A   ;+2
0008CE 48CE 7E               7      LD  A,(HL)
0008CF 48CF C0              11      RET NZ
0008D0 48D0 0F               4      RRCA        ;+3
0008D1 48D1 0F               4      RRCA
0008D2 48D2 C9              10      RET
                                
       48D3                     ROM_READ:
0008D3 48D3 E5              11      PUSH    HL
0008D4 48D4 D5              11      PUSH    DE
0008D5 48D5 C5              11      PUSH    BC
0008D6 48D6 FDE5            15      PUSH    IY
0008D8 48D8 224DF1          16      LD  (LEFTX),HL
0008DB 48DB 2A2FF1          16      LD  HL,(_DTA)
0008DE 48DE 2247F1          16      LD  (DTAX),HL
0008E1 48E1 2A4DF1          16      LD  HL,(LEFTX)
                                
0008E4 48E4 CD2E4B          17      CALL    RBX1
0008E7 48E7 3870            12      JR  C,RBRERR1
0008E9 48E9 79               4      LD  A,C
0008EA 48EA EB               4      EX  DE,HL
0008EB 48EB ED52            15      SBC HL,DE       ;CP 0HL,CDE
0008ED 48ED 19              11      ADD HL,DE
0008EE 48EE DE00             7      SBC A,000H
0008F0 48F0 3801            12      JR  C,RBR1
0008F2 48F2 EB               4      EX  DE,HL
       48F3                     RBR1:
0008F3 48F3 9F               4      SBC A,A
0008F4 48F4 E601             7      AND 1
0008F6 48F6 321FF1          13      LD  (_RESULT),A
0008F9 48F9 7C               4      LD  A,H
0008FA 48FA B5               4      OR  L
0008FB 48FB CA4F49          10      JP  Z,RBREND0
                                
0008FE 48FE 222BF1          16      LD  (_LEFT),HL  ;Read record byte
000901 4901 224DF1          16      LD  (LEFTX),HL
                                
000904 4904 CD544B          17      CALL    RBX2
000907 4907 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000909 4909 CD674B          17      CALL    RBXA
00090C 490C DA6549          10      JP  C,RBRERR
00090F 490F C5              11      PUSH    BC
000910 4910 CD4244          17      CALL    ROM_LDIR
000913 4913 ED5347F1        20      LD  (DTAX),DE
000917 4917 2A4DF1          16      LD  HL,(LEFTX)
00091A 491A D1              10      POP DE
00091B 491B A7               4      AND A
00091C 491C ED52            15      SBC HL,DE
00091E 491E 224DF1          16      LD  (LEFTX),HL
000921 4921 2829            12      JR  Z,RBREND
                                
       4923                     RBRB:
000923 4923 CDA34B          17      CALL    RBXB
000926 4926 2818            12      JR  Z,RBRC
       4928                     RBRB1:
000928 4928 C5              11      PUSH    BC
000929 4929 D5              11      PUSH    DE
00092A 492A CD4B4C          17      CALL    CLUST
00092D 492D EB               4      EX  DE,HL
00092E 492E ED4B21F1        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000932 4932 CD4244          17      CALL    ROM_LDIR
000935 4935 EB               4      EX  DE,HL
000936 4936 D1              10      POP DE
000937 4937 C1              10      POP BC
000938 4938 CD284C          17      CALL    GNCL
00093B 493B DA6549          10      JP  C,RBRERR
00093E 493E 10E8            13      DJNZ    RBRB1
       4940                     RBRC:
000940 4940 CDBB4B          17      CALL    RBXC
000943 4943 2807            12      JR  Z,RBREND
                                
000945 4945 CD4B4C          17      CALL    CLUST
000948 4948 EB               4      EX  DE,HL
000949 4949 CD4244          17      CALL    ROM_LDIR
       494C                     RBREND:
00094C 494C CDC74B          17      CALL    RBXEND
       494F                     RBREND0:
00094F 494F FDE1            14      POP IY
000951 4951 C1              10      POP BC
000952 4952 D1              10      POP DE
000953 4953 F1              10      POP AF  ;(HL)
000954 4954 AF               4      XOR A
000955 4955 3A1FF1          13      LD  A,(_RESULT)
000958 4958 C9              10      RET
                                
       4959                     RBRERR1:
000959 4959 3E01             7      LD  A,001H
       495B                     RBRERR2:
00095B 495B FDE1            14      POP IY
00095D 495D C1              10      POP BC
00095E 495E D1              10      POP DE
00095F 495F E1              10      POP HL
000960 4960 37               4      SCF
000961 4961 210000          10      LD  HL,0
000964 4964 C9              10      RET
       4965                     RBRERR:
000965 4965 3EFF             7      LD  A,0FFH
000967 4967 18F2            12      JR  RBRERR2
                                
       4969                     FILE_DD:
000969 4969 3E                      DB  03EH
00096A 496A C9              10      RET
00096B 496B 320CF1          13      LD  (SWC_BLOAD_M),A
       496E                     ROM_ORG:
00096E 496E 2A4FF1          16      LD  HL,(PARAM0)
000971 4971 7E               7      LD  A,(HL)
000972 4972 C9              10      RET
       4973                     FILE_B:
000973 4973 AF               4      XOR A
000974 4974 3253F1          13      LD  (FDRV),A
000977 4977 1E00             7      LD  E,0
000979 4979 3A63F6          13      LD  A,(VALTYP)
00097C 497C FE03             7      CP  3       ;string
00097E 497E 2044            12      JR  NZ,FILED
                                
000980 4980 DD21D067        14      LD  IX,FRESTR
000984 4984 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000988 4988 CD1C00          17      CALL    _CALSLT
00098B 498B E5              11      PUSH    HL
00098C 498C DDE1            14      POP IX
                                
00098E 498E DD5E00          19      LD  E,(IX+0)
000991 4991 DD7E01          19      LD  A,(IX+1)
000994 4994 DD5602          19      LD  D,(IX+2)
000997 4997 DD62             9      LD  IXH,D
000999 4999 DD6F             9      LD  IXL,A
00099B 499B 7B               4      LD  A,E
00099C 499C FE04             7      CP  4
00099E 499E 3808            12      JR  C,FILEB1
0009A0 49A0 DD7E03          19      LD  A,(IX+3)
0009A3 49A3 FE3A             7      CP  ':'
0009A5 49A5 28C2            12      JR  Z,FILE_DD
0009A7 49A7 7B               4      LD  A,E
       49A8                     FILEB1:
0009A8 49A8 FE02             7      CP  2
0009AA 49AA 3818            12      JR  C,FILED
0009AC 49AC DD7E01          19      LD  A,(IX+1)
0009AF 49AF FE3A             7      CP  ':'
0009B1 49B1 2011            12      JR  NZ,DEVI1
0009B3 49B3 DD7E00          19      LD  A,(IX+0)        ;DRIVE
0009B6 49B6 CD9D4A          17      CALL    CAP
0009B9 49B9 D640             7      SUB '@'
0009BB 49BB DD23            10      INC IX
0009BD 49BD DD23            10      INC IX
0009BF 49BF 1D               4      DEC E
0009C0 49C0 1D               4      DEC E
0009C1 49C1 3253F1          13      LD  (FDRV),A
       49C4                     DEVI1:
                                
       49C4                     FILED:
0009C4 49C4 CD0B4A          17      CALL    FILEI
0009C7 49C7 2154F1          10      LD  HL,FNAME
                                
0009CA 49CA 0608             7      LD  B,8
       49CC                     FILE2:
0009CC 49CC CD184A          17      CALL    CCHKF
0009CF 49CF C8              11      RET Z
0009D0 49D0 FE2A             7      CP  '*'
0009D2 49D2 282E            12      JR  Z,FILE9
0009D4 49D4 FE2E             7      CP  '.'
0009D6 49D6 280C            12      JR  Z,FILE4
0009D8 49D8 77               7      LD  (HL),A
0009D9 49D9 23               6      INC HL
0009DA 49DA 10F0            13      DJNZ    FILE2
                                
       49DC                     FILE3:
0009DC 49DC CD184A          17      CALL    CCHKF
0009DF 49DF C8              11      RET Z
0009E0 49E0 FE2E             7      CP  '.'
0009E2 49E2 20F8            12      JR  NZ,FILE3
                                
       49E4                     FILE4:
0009E4 49E4 215CF1          10      LD  HL,FNAME+8
0009E7 49E7 0603             7      LD  B,3
                                
       49E9                     FILE4L:
0009E9 49E9 CD184A          17      CALL    CCHKF
0009EC 49EC C8              11      RET Z
0009ED 49ED FE2E             7      CP  '.'
0009EF 49EF 2008            12      JR  NZ,FILE12
0009F1 49F1 3254F1          13      LD  (FNAME),A   ;Parent directory(..)
0009F4 49F4 3255F1          13      LD  (FNAME+1),A
0009F7 49F7 3E20             7      LD  A,020H
       49F9                     FILE12:
0009F9 49F9 FE2A             7      CP  '*'
0009FB 49FB 280A            12      JR  Z,FILE10
0009FD 49FD 77               7      LD  (HL),A
0009FE 49FE 23               6      INC HL
0009FF 49FF 10E8            13      DJNZ    FILE4L
000A01 4A01 C9              10      RET
                                
       4A02                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000A02 4A02 CD074A          17      CALL    FILE10
000A05 4A05 18D5            12      JR  FILE3
                                
       4A07                     FILE10:
000A07 4A07 3E3F             7      LD  A,'?'
000A09 4A09 1808            12      JR  FILL_MEMORY
       4A0B                     FILEI:              ;名前＋拡張子をスペースで初期化
000A0B 4A0B 3E20             7      LD  A,020H
000A0D 4A0D 01000B          10      LD  BC,11*256   ;C=0にしておく
000A10 4A10 2154F1          10      LD  HL,FNAME
       4A13                     FILL_MEMORY:            ;HLからBバイトAで埋める
000A13 4A13 77               7      LD  (HL),A
000A14 4A14 23               6      INC HL
000A15 4A15 10FC            13      DJNZ    FILL_MEMORY
000A17 4A17 C9              10      RET
                                
       4A18                     CCHKF:
000A18 4A18 7B               4      LD  A,E
000A19 4A19 B7               4      OR  A
000A1A 4A1A C8              11      RET Z
000A1B 4A1B DD7E00          19      LD  A,(IX+0)
000A1E 4A1E CD254A          17      CALL    CCHK2
000A21 4A21 C8              11      RET Z
000A22 4A22 C3884A          10      JP  FKAN
                                
       4A25                     CCHK2:
000A25 4A25 0C               4      INC C
000A26 4A26 0D               4      DEC C
000A27 4A27 C0              11      RET NZ
       4A28                     CCHK3:              ;ZF=1 で使えない文字
000A28 4A28 FE2B             7      CP  '+'
000A2A 4A2A C8              11      RET Z
000A2B 4A2B FE2C             7      CP  ','
000A2D 4A2D C8              11      RET Z
000A2E 4A2E FE2F             7      CP  '/'
000A30 4A30 C8              11      RET Z
000A31 4A31 FE3A             7      CP  ':'
000A33 4A33 C8              11      RET Z
000A34 4A34 FE3B             7      CP  ';'
000A36 4A36 C8              11      RET Z
000A37 4A37 FE3D             7      CP  '='
000A39 4A39 C8              11      RET Z
000A3A 4A3A FE5C             7      CP  05CH    ;\
000A3C 4A3C C8              11      RET Z
000A3D 4A3D FE1F             7      CP  01FH
000A3F 4A3F D0              11      RET NC
000A40 4A40 BF               4      CP  A       ;Z=1
000A41 4A41 C9              10      RET
                                
       4A42                     SS1:
000A42 4A42 13               6      INC DE
       4A43                     SPCUT:              ;スペースをカット
000A43 4A43 1A               7      LD  A,(DE)
000A44 4A44 FE20             7      CP  020H
000A46 4A46 28FA            12      JR  Z,SS1
000A48 4A48 C9              10      RET
                                
       4A49                     SCREOF1:
000A49 4A49 13               6      INC DE
       4A4A                     SPCUTEX:            ;スペース改行などをカット
000A4A 4A4A 1A               7      LD  A,(DE)
000A4B 4A4B FE20             7      CP  020H
000A4D 4A4D 28FA            12      JR  Z,SCREOF1
000A4F 4A4F FE0D             7      CP  00DH
000A51 4A51 28F6            12      JR  Z,SCREOF1
000A53 4A53 FE0A             7      CP  00AH
000A55 4A55 28F2            12      JR  Z,SCREOF1
000A57 4A57 FE1A             7      CP  01AH
000A59 4A59 28EE            12      JR  Z,SCREOF1
000A5B 4A5B C9              10      RET
                                
       4A5C                     GETNUM:
000A5C 4A5C 210000          10      LD  HL,0
       4A5F                     GETNUM1:
000A5F 4A5F 1A               7      LD  A,(DE)
000A60 4A60 13               6      INC DE
000A61 4A61 D630             7      SUB '0'
000A63 4A63 D8              11      RET C
000A64 4A64 FE0A             7      CP  10
000A66 4A66 D0              11      RET NC
000A67 4A67 4D               4      LD  C,L
000A68 4A68 44               4      LD  B,H
000A69 4A69 29              11      ADD HL,HL   ;*2
000A6A 4A6A 29              11      ADD HL,HL   ;*4
000A6B 4A6B 09              11      ADD HL,BC   ;*5
000A6C 4A6C 29              11      ADD HL,HL   ;*10
000A6D 4A6D 4F               4      LD  C,A
000A6E 4A6E 0600             7      LD  B,0
000A70 4A70 09              11      ADD HL,BC
000A71 4A71 18EC            12      JR  GETNUM1
                                
       4A73                     SEARCH_END:
000A73 4A73 7E               7      LD  A,(HL)
       4A74                     SEARCH_END1:
000A74 4A74 23               6      INC HL
000A75 4A75 B7               4      OR  A
000A76 4A76 C8              11      RET Z
000A77 4A77 FE3A             7      CP  ':'
000A79 4A79 20F8            12      JR  NZ,SEARCH_END
000A7B 4A7B 7E               7      LD  A,(HL)
000A7C 4A7C FE3A             7      CP  ':'
000A7E 4A7E 28F4            12      JR  Z,SEARCH_END1
000A80 4A80 C9              10      RET
                                
       4A81                     FKANC:
000A81 4A81 CB41             8      BIT 0,C
000A83 4A83 CCA64A          17      CALL    Z,CAP2
000A86 4A86 1803            12      JR  FKANX
       4A88                     FKAN:           ;漢字チェック
000A88 4A88 DD23            10      INC IX
000A8A 4A8A 1D               4      DEC E
       4A8B                     FKANX:
000A8B 4A8B CB41             8      BIT 0,C
000A8D 4A8D CB81             8      RES 0,C
000A8F 4A8F C0              11      RET NZ
000A90 4A90 FE80             7      CP  080H
000A92 4A92 D8              11      RET C
000A93 4A93 FEA0             7      CP  0A0H
000A95 4A95 3803            12      JR  C,FKAN1
000A97 4A97 FEE0             7      CP  0E0H
000A99 4A99 D8              11      RET C
       4A9A                     FKAN1:
000A9A 4A9A 0C               4      INC C
000A9B 4A9B A7               4      AND A
000A9C 4A9C C9              10      RET
                                
       4A9D                     CAP:
000A9D 4A9D FE61             7      CP  'a'
000A9F 4A9F D8              11      RET C
000AA0 4AA0 FE7B             7      CP  'z'+1
000AA2 4AA2 D0              11      RET NC
000AA3 4AA3 D620             7      SUB 020H
000AA5 4AA5 C9              10      RET
       4AA6                     CAP2:
000AA6 4AA6 CD9D4A          17      CALL    CAP
       4AA9                     CAP3:               ;
000AA9 4AA9 FE05             7      CP  5
000AAB 4AAB 2803            12      JR  Z,CAP4
000AAD 4AAD FE21             7      CP  021H
000AAF 4AAF C9              10      RET
       4AB0                     CAP4:
000AB0 4AB0 3EE5             7      LD  A,0E5H
000AB2 4AB2 C9              10      RET
                                
       4AB3                     ROM_OPEN:
000AB3 4AB3 CDD24E          17      CALL    GET_DISK_BANK_FDRV
                                
000AB6 4AB6 CDFB4C          17      CALL    GET_DIR_DAT
000AB9 4AB9 D5              11      PUSH    DE
000ABA 4ABA CDCF4A          17      CALL    FILESE
000ABD 4ABD D1              10      POP DE
000ABE 4ABE 3F               4      CCF
000ABF 4ABF D8              11      RET C
000AC0 4AC0 224BF1          16      LD  (FCBX),HL
000AC3 4AC3 E5              11      PUSH    HL
000AC4 4AC4 210000          10      LD  HL,0
000AC7 4AC7 2225F1          16      LD  (RR_LOW),HL
000ACA 4ACA 2227F1          16      LD  (RR_HIGH),HL
000ACD 4ACD E1              10      POP HL
000ACE 4ACE C9              10      RET
                                
       4ACF                     FILESE:
000ACF 4ACF 7E               7      LD  A,(HL)
000AD0 4AD0 B7               4      OR  A
000AD1 4AD1 C8              11      RET Z       ;END:ZF=1 CF=0
000AD2 4AD2 FEE5             7      CP  0E5H
000AD4 4AD4 280D            12      JR  Z,FILESE1
000AD6 4AD6 1154F1          10      LD  DE,FNAME
000AD9 4AD9 E5              11      PUSH    HL
000ADA 4ADA CD084B          17      CALL    CPFILE
000ADD 4ADD CC294B          17      CALL    Z,CPFILE2
000AE0 4AE0 E1              10      POP HL
000AE1 4AE1 37               4      SCF
000AE2 4AE2 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4AE3                     FILESE1:
000AE3 4AE3 CDEB4A          17      CALL    FNEXT
000AE6 4AE6 20E7            12      JR  NZ,FILESE
       4AE8                     ZF0_CF0_AFF_RET:
000AE8 4AE8 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000AEA 4AEA C9              10      RET
                                
       4AEB                     FNEXT:
000AEB 4AEB 112000          10      LD  DE,020H
000AEE 4AEE 19              11      ADD HL,DE
000AEF 4AEF 0D               4      DEC C
                                #if exists USE_NORMAL_32K_ROM
                                #else
       4AF0                     CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
000AF0 4AF0 F5              11      PUSH    AF
000AF1 4AF1 CB7C             8      BIT 7,H
000AF3 4AF3 2811            12      JR  Z,CHECK_DIR_PAGE1
000AF5 4AF5 7C               4      LD  A,H
000AF6 4AF6 D620             7      SUB 020H
000AF8 4AF8 67               4      LD  H,A
000AF9 4AF9 3A20F1          13      LD  A,(_BANK)
000AFC 4AFC 3C               4      INC A
000AFD 4AFD 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000B00 4B00 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000B03 4B03 3220F1          13      LD  (_BANK),A
       4B06                     CHECK_DIR_PAGE1:
000B06 4B06 F1              10      POP AF
                                #endif
000B07 4B07 C9              10      RET
                                
       4B08                     CPFILE:
000B08 4B08 C5              11      PUSH    BC
000B09 4B09 01000B          10      LD  BC,00B00H
       4B0C                     CPSTR1:
000B0C 4B0C 1A               7      LD  A,(DE)
000B0D 4B0D FE3F             7      CP  '?'     ;Wild card
000B0F 4B0F 2812            12      JR  Z,CPSTR2
000B11 4B11 7E               7      LD  A,(HL)
000B12 4B12 CD814A          17      CALL    FKANC
000B15 4B15 E5              11      PUSH    HL
000B16 4B16 67               4      LD  H,A
000B17 4B17 1A               7      LD  A,(DE)
000B18 4B18 CB01             4      RLC C
000B1A 4B1A CD814A          17      CALL    FKANC
000B1D 4B1D CB09             4      RRC C
000B1F 4B1F BC               4      CP  H       ;CP (HL),(DE)
000B20 4B20 E1              10      POP HL
000B21 4B21 2004            12      JR  NZ,CPSTR3
       4B23                     CPSTR2:
000B23 4B23 13               6      INC DE
000B24 4B24 23               6      INC HL
000B25 4B25 10E5            13      DJNZ    CPSTR1
       4B27                     CPSTR3:
000B27 4B27 C1              10      POP BC
000B28 4B28 C9              10      RET
                                
       4B29                     CPFILE2:
                                ;   LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
                                ;   OR  0E1H
000B29 4B29 3EE1             7      LD  A,0E1H
000B2B 4B2B 2F               4      CPL
000B2C 4B2C A6               7      AND (HL)
000B2D 4B2D C9              10      RET
                                
       4B2E                     RBX1:
000B2E 4B2E E5              11      PUSH    HL      ;Record byte
                                
000B2F 4B2F ED5B25F1        20      LD  DE,(RR_LOW) ;CDE=Random record
000B33 4B33 3A28F1          13      LD  A,(RR_HIGH+1)
000B36 4B36 4F               4      LD  C,A
                                
000B37 4B37 CDD24E          17      CALL    GET_DISK_BANK_FDRV
                                
000B3A 4B3A FD2A4BF1        20      LD  IY,(FCBX)
000B3E 4B3E FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000B41 4B41 FD661D          19      LD  H,(IY+01DH)
000B44 4B44 FD7E1E          19      LD  A,(IY+01EH)
                                
000B47 4B47 A7               4      AND A
000B48 4B48 ED52            15      SBC HL,DE
000B4A 4B4A 99               4      SBC A,C
000B4B 4B4B D1              10      POP DE
                                
000B4C 4B4C D8              11      RET C
000B4D 4B4D 4F               4      LD  C,A
000B4E 4B4E EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000B4F 4B4F B2               4      OR  D
000B50 4B50 B3               4      OR  E
000B51 4B51 C0              11      RET NZ
000B52 4B52 37               4      SCF
000B53 4B53 C9              10      RET
                                
       4B54                     RBX2:
000B54 4B54 ED4B26F1        20      LD  BC,(RR_LOW+1)
000B58 4B58 CDDC4B          17      CALL    RWXR
000B5B 4B5B 3A22F1          13      LD  A,(CLSZ_H)
000B5E 4B5E 3D               4      DEC A
000B5F 4B5F E5              11      PUSH    HL
000B60 4B60 2A25F1          16      LD  HL,(RR_LOW)
000B63 4B63 A4               4      AND H
000B64 4B64 B5               4      OR  L
000B65 4B65 E1              10      POP HL
000B66 4B66 C9              10      RET
                                
       4B67                     RBXA:
000B67 4B67 D5              11      PUSH    DE
000B68 4B68 CD4B4C          17      CALL    CLUST
000B6B 4B6B ED532DF1        20      LD  (_DTPS),DE
000B6F 4B6F D1              10      POP DE
000B70 4B70 CD284C          17      CALL    GNCL
000B73 4B73 D8              11      RET C
000B74 4B74 ED5329F1        20      LD  (_CLPS),DE
                                
000B78 4B78 ED4B25F1        20      LD  BC,(RR_LOW)
000B7C 4B7C 2A21F1          16      LD  HL,(CLSZ)
000B7F 4B7F 7C               4      LD  A,H
000B80 4B80 3D               4      DEC A
000B81 4B81 A0               4      AND B
000B82 4B82 47               4      LD  B,A
000B83 4B83 ED42            15      SBC HL,BC       ;remaining cluster
                                
000B85 4B85 ED5B4DF1        20      LD  DE,(LEFTX)
000B89 4B89 ED52            15      SBC HL,DE       ;CP HL,DE
000B8B 4B8B 19              11      ADD HL,DE
000B8C 4B8C 3801            12      JR  C,RBXA1
000B8E 4B8E EB               4      EX  DE,HL
       4B8F                     RBXA1:
000B8F 4B8F 3A20F1          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
000B92 4B92 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000B95 4B95 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000B98 4B98 E5              11      PUSH    HL
000B99 4B99 2A2DF1          16      LD  HL,(_DTPS)
000B9C 4B9C 09              11      ADD HL,BC
000B9D 4B9D ED5B47F1        20      LD  DE,(DTAX)
000BA1 4BA1 C1              10      POP BC
000BA2 4BA2 C9              10      RET
                                
       4BA3                     RBXB:
000BA3 4BA3 2A47F1          16      LD  HL,(DTAX)
000BA6 4BA6 ED5B29F1        20      LD  DE,(_CLPS)
000BAA 4BAA 3A4EF1          13      LD  A,(LEFTX+1)
000BAD 4BAD 47               4      LD  B,A
000BAE 4BAE 3A22F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4BB1                     RBXB1:
000BB1 4BB1 1F               4      RRA     ;->CF
000BB2 4BB2 3804            12      JR  C,RBXB2
000BB4 4BB4 CB38             8      SRL B   ;B=B/2
000BB6 4BB6 18F9            12      JR  RBXB1
       4BB8                     RBXB2:
000BB8 4BB8 78               4      LD  A,B
000BB9 4BB9 B7               4      OR  A
000BBA 4BBA C9              10      RET
                                
       4BBB                     RBXC:
000BBB 4BBB ED4B4DF1        20      LD  BC,(LEFTX)
000BBF 4BBF 3A22F1          13      LD  A,(CLSZ_H)
000BC2 4BC2 3D               4      DEC A
000BC3 4BC3 A0               4      AND B
000BC4 4BC4 47               4      LD  B,A
000BC5 4BC5 B1               4      OR  C
000BC6 4BC6 C9              10      RET
                                
       4BC7                     RBXEND:
000BC7 4BC7 ED5B2BF1        20      LD  DE,(_LEFT)
000BCB 4BCB 2A25F1          16      LD  HL,(RR_LOW)
000BCE 4BCE 3A28F1          13      LD  A,(RR_HIGH+1)
000BD1 4BD1 19              11      ADD HL,DE
000BD2 4BD2 CE00             7      ADC A,0
000BD4 4BD4 2225F1          16      LD  (RR_LOW),HL
000BD7 4BD7 3228F1          13      LD  (RR_HIGH+1),A
000BDA 4BDA EB               4      EX  DE,HL       ;HL=Read byte
000BDB 4BDB C9              10      RET 
                                
       4BDC                     RWXR:
000BDC 4BDC 3A22F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4BDF                     L_RWX:
000BDF 4BDF 1F               4      RRA     ;->CF
000BE0 4BE0 3806            12      JR  C,E_RWX
000BE2 4BE2 CB38             8      SRL B   ;BC=BC/2
000BE4 4BE4 CB19             8      RR  C   ;
000BE6 4BE6 18F7            12      JR  L_RWX
       4BE8                     E_RWX:
000BE8 4BE8 CDD24E          17      CALL    GET_DISK_BANK_FDRV
                                
000BEB 4BEB FD2A4BF1        20      LD  IY,(FCBX)
000BEF 4BEF FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000BF2 4BF2 FD561B          19      LD  D,(IY+01BH)
       4BF5                     RWX1:
000BF5 4BF5 ED5329F1        20      LD  (_CLPS),DE
000BF9 4BF9 7A               4      LD  A,D
000BFA 4BFA B3               4      OR  E
000BFB 4BFB 37               4      SCF
000BFC 4BFC C8              11      RET Z
                                
000BFD 4BFD 78               4      LD  A,B
000BFE 4BFE B1               4      OR  C
000BFF 4BFF C8              11      RET Z
                                
000C00 4C00 CD284C          17      CALL    GNCL
000C03 4C03 D8              11      RET C
000C04 4C04 0B               6      DEC BC
000C05 4C05 CD944C          17      CALL    ENDCL
000C08 4C08 38EB            12      JR  C,RWX1
000C0A 4C0A 37               4      SCF
000C0B 4C0B C9              10      RET
                                
       4C0C                     NCL3:
000C0C 4C0C CDD24E          17      CALL    GET_DISK_BANK_FDRV
000C0F 4C0F 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C12 4C12 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000C15 4C15 6B               4      LD  L,E
000C16 4C16 62               4      LD  H,D
000C17 4C17 CB3C             8      SRL H
000C19 4C19 CB1D             8      RR  L
000C1B 4C1B 1F               4      RRA
000C1C 4C1C 19              11      ADD HL,DE
000C1D 4C1D 010060          10      LD  BC,BANK1_ADR
000C20 4C20 09              11      ADD HL,BC
000C21 4C21 ED4B23F1        20      LD  BC,(SECSZ)
000C25 4C25 09              11      ADD HL,BC
000C26 4C26 17               4      RLA
000C27 4C27 C9              10      RET
                                
       4C28                     GNCL:
000C28 4C28 7A               4      LD  A,D
000C29 4C29 B3               4      OR  E
000C2A 4C2A 37               4      SCF
000C2B 4C2B C8              11      RET Z
000C2C 4C2C C5              11      PUSH    BC
000C2D 4C2D E5              11      PUSH    HL
000C2E 4C2E CD0C4C          17      CALL    NCL3
000C31 4C31 3809            12      JR  C,GNC1
000C33 4C33 5E               7      LD  E,(HL)
000C34 4C34 23               6      INC HL
000C35 4C35 7E               7      LD  A,(HL)
000C36 4C36 E60F             7      AND 00FH
000C38 4C38 57               4      LD  D,A
000C39 4C39 E1              10      POP HL
000C3A 4C3A C1              10      POP BC
000C3B 4C3B C9              10      RET
       4C3C                     GNC1:
000C3C 4C3C 7E               7      LD  A,(HL)
000C3D 4C3D 23               6      INC HL
000C3E 4C3E 56               7      LD  D,(HL)
000C3F 4C3F 0604             7      LD  B,4
       4C41                     GNC1L:
000C41 4C41 CB3A             8      SRL D
000C43 4C43 1F               4      RRA
000C44 4C44 10FB            13      DJNZ    GNC1L
                                
000C46 4C46 5F               4      LD  E,A
000C47 4C47 E1              10      POP HL
000C48 4C48 C1              10      POP BC
000C49 4C49 A7               4      AND A
000C4A 4C4A C9              10      RET
                                
       4C4B                     CLUST:
000C4B 4C4B EB               4      EX  DE,HL
000C4C 4C4C C5              11      PUSH    BC
000C4D 4C4D 3A22F1          13      LD  A,(CLSZ_H)
000C50 4C50 CDFE4E          17      CALL    MUL_AHL
                                
000C53 4C53 CD0B4D          17      CALL    GET_DIR_POS
000C56 4C56 4F               4      LD  C,A
000C57 4C57 0600             7      LD  B,0
000C59 4C59 09              11      ADD HL,BC
                                
000C5A 4C5A 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000C5D 4C5D 0F               4      RRCA
000C5E 4C5E 0F               4      RRCA
000C5F 4C5F 0F               4      RRCA
000C60 4C60 0F               4      RRCA
000C61 4C61 4F               4      LD  C,A
                                
000C62 4C62 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000C65 4C65 FE02             7      CP  2
000C67 4C67 280C            12      JR  Z,CLUST1
000C69 4C69 CB01             4      RLC C
000C6B 4C6B 0D               4      DEC C
000C6C 4C6C 3A0C60          13      LD  A,(BANK1_ADR+11+1)  ;BPB_BytsPerSec High    
000C6F 4C6F FE02             7      CP  2
000C71 4C71 2002            12      JR  NZ,CLUST1
000C73 4C73 0D               4      DEC C
000C74 4C74 0D               4      DEC C
       4C75                     CLUST1:
000C75 4C75 0D               4      DEC C
000C76 4C76 09              11      ADD HL,BC
                                
                                #if exists USE_NORMAL_32K_ROM
                                    LD  A,L
                                #else
000C77 4C77 E5              11      PUSH    HL
000C78 4C78 29              11      ADD HL,HL   ;*2
000C79 4C79 29              11      ADD HL,HL   ;*4
000C7A 4C7A 29              11      ADD HL,HL   ;*8
000C7B 4C7B CDD24E          17      CALL    GET_DISK_BANK_FDRV
000C7E 4C7E 84               4      ADD A,H
000C7F 4C7F 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C82 4C82 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000C85 4C85 3220F1          13      LD  (_BANK),A
000C88 4C88 E1              10      POP HL
000C89 4C89 3E1F             7      LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
000C8B 4C8B A5               4      AND L
                                #endif
000C8C 4C8C C660             7      ADD A,high BANK1_ADR
000C8E 4C8E 67               4      LD  H,A
000C8F 4C8F 2E00             7      LD  L,0
000C91 4C91 EB               4      EX  DE,HL
000C92 4C92 C1              10      POP BC
000C93 4C93 C9              10      RET
                                
       4C94                     ENDCL:
000C94 4C94 7A               4      LD  A,D ;END CLUSTER
000C95 4C95 FE0F             7      CP  00FH    ;FAT12の最大値
000C97 4C97 C0              11      RET NZ
000C98 4C98 7B               4      LD  A,E
000C99 4C99 FEF7             7      CP  0F7H
000C9B 4C9B C9              10      RET
                                
       4C9C                     RB_READ:
000C9C 4C9C AF               4      XOR A   ;HLA = HL*128
000C9D 4C9D CB3C             8      SRL H
000C9F 4C9F CB1D             8      RR  L
000CA1 4CA1 1F               4      RRA
000CA2 4CA2 3225F1          13      LD  (RR_LOW),A
000CA5 4CA5 2226F1          16      LD  (RR_MID),HL
000CA8 4CA8 218000          10      LD  HL,128
                                
000CAB 4CAB CDD348          17      CALL    ROM_READ
000CAE 4CAE C9              10      RET
                                
       4CAF                     GETSEQ:
000CAF 4CAF FD6E20          19      LD  L,(IY+32)
000CB2 4CB2 FD660C          19      LD  H,(IY+12)
                                
000CB5 4CB5 CB25             8      SLA L
                                
000CB7 4CB7 CB3C             8      SRL H
000CB9 4CB9 CB1D             8      RR  L
000CBB 4CBB C9              10      RET
                                
       4CBC                     SETSEQ:
000CBC 4CBC F5              11      PUSH    AF
000CBD 4CBD 3A25F1          13      LD  A,(RR_LOW)
000CC0 4CC0 2A26F1          16      LD  HL,(RR_MID)
                                
000CC3 4CC3 CDDA4C          17      CALL    SSQ1
                                
000CC6 4CC6 29              11      ADD HL,HL
000CC7 4CC7 CB3D             8      SRL L
000CC9 4CC9 FD7520          19      LD  (IY+32),L
000CCC 4CCC FD740C          19      LD  (IY+12),H
000CCF 4CCF F1              10      POP AF
000CD0 4CD0 C9              10      RET
                                
       4CD1                     GETSIZE:
000CD1 4CD1 FD7E10          19      LD  A,(IY+16)
000CD4 4CD4 FD6E11          19      LD  L,(IY+17)
000CD7 4CD7 FD6612          19      LD  H,(IY+18)
       4CDA                     SSQ1:
000CDA 4CDA 87               4      ADD A,A
000CDB 4CDB ED6A            15      ADC HL,HL
000CDD 4CDD B7               4      OR  A
000CDE 4CDE C8              11      RET Z
000CDF 4CDF 23               6      INC HL
000CE0 4CE0 C9              10      RET
                                
       4CE1                     SET_FCB:
000CE1 4CE1 D5              11      PUSH    DE
000CE2 4CE2 FDE1            14      POP IY
000CE4 4CE4 FD7E1C          19      LD  A,(IY+28)
000CE7 4CE7 FEFF             7      CP  0FFH
000CE9 4CE9 200C            12      JR  NZ,POPAF_SCF_FF_RET
000CEB 4CEB E5              11      PUSH    HL
000CEC 4CEC FD6E1A          19      LD  L,(IY+26)
000CEF 4CEF FD661B          19      LD  H,(IY+27)
000CF2 4CF2 2229F1          16      LD  (_CLPS),HL
000CF5 4CF5 E1              10      POP HL
000CF6 4CF6 C9              10      RET
                                
       4CF7                     POPAF_SCF_FF_RET:
000CF7 4CF7 F1              10      POP AF
000CF8 4CF8 37               4      SCF
000CF9 4CF9 9F               4      SBC A,A
000CFA 4CFA C9              10      RET
                                
       4CFB                     GET_DIR_DAT:
000CFB 4CFB CD0B4D          17      CALL    GET_DIR_POS
000CFE 4CFE C660             7      ADD A,high BANK1_ADR
000D00 4D00 2E00             7      LD  L,0
000D02 4D02 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_NORMAL_32K_ROM
                                #else
000D03 4D03 CDF04A          17      CALL    CHECK_DIR_PAGE
                                #endif
000D06 4D06 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000D09 4D09 4F               4      LD  C,A
000D0A 4D0A C9              10      RET
                                
       4D0B                     GET_DIR_POS:
000D0B 4D0B CDD24E          17      CALL    GET_DISK_BANK_FDRV
000D0E 4D0E 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D11 4D11 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D14 4D14 3220F1          13      LD  (_BANK),A
000D17 4D17 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000D1A 4D1A 47               4      LD  B,A
000D1B 4D1B 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000D1E 4D1E 4F               4      LD  C,A
000D1F 4D1F 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4D22                     GET_DIR_POS1:
000D22 4D22 81               4      ADD A,C
000D23 4D23 10FD            13      DJNZ    GET_DIR_POS1
                                
000D25 4D25 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec 
       4D29                     L_MDP:
000D29 4D29 CB18             8      RR  B   ;->CF
000D2B 4D2B D8              11      RET C
000D2C 4D2C 87               4      ADD A,A
000D2D 4D2D 18FA            12      JR  L_MDP
                                
       4D2F                     WILDCARD:
000D2F 4D2F 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4D3A                     ERROR_WRITE_PROTECTED:
000D3A 4D3A 3E00             7      LD  A,0     ;Write protected
000D3C 4D3C C9              10      RET
       4D3D                     DISKIO:
000D3D 4D3D 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000D3F 4D3F 48               4      LD  C,B
000D40 4D40 CDDC4E          17      CALL    GET_DISK_BANK
       4D43                     SETMAP1:        
000D43 4D43 E5              11      PUSH    HL
       4D44                     DISKIO1:
000D44 4D44 C5              11      PUSH    BC      ;B=残りのセクタ数
000D45 4D45 D5              11      PUSH    DE      ;DE=セクタ番号
000D46 4D46 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
000D47 4D47 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
000D48 4D48 F5              11      PUSH    AF
000D49 4D49 3A24F1          13      LD  A,(SECSZ_H)
000D4C 4D4C CDFE4E          17      CALL    MUL_AHL
000D4F 4D4F F1              10      POP AF
000D50 4D50 4D               4      LD  C,L     ;C=読み出し元
000D51 4D51 29              11      ADD HL,HL       ;64KB→32KB
000D52 4D52 29              11      ADD HL,HL       ;32KB→16KB
000D53 4D53 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
000D54 4D54 84               4      ADD A,H
000D55 4D55 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D58 4D58 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D5B 4D5B 3220F1          13      LD  (_BANK),A
000D5E 4D5E 79               4      LD  A,C     ;C=読み出し元
000D5F 4D5F E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
000D61 4D61 C660             7      ADD A,high BANK1_ADR
000D63 4D63 67               4      LD  H,A
000D64 4D64 ED4B23F1        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
000D68 4D68 69               4      LD  L,C     ;C=0
000D69 4D69 EDB0                    LDIR
000D6B 4D6B EB               4      EX  DE,HL
000D6C 4D6C F1              10      POP AF
000D6D 4D6D D1              10      POP DE
000D6E 4D6E 13               6      INC DE
000D6F 4D6F C1              10      POP BC
000D70 4D70 10D2            13      DJNZ    DISKIO1
000D72 4D72 41               4      LD  B,C
                                
000D73 4D73 E1              10      POP HL
000D74 4D74 AF               4      XOR A
000D75 4D75 FB               4      EI
000D76 4D76 C9              10      RET
                                
       4D77                     DSKCHG:
000D77 4D77 CDB04D          17      CALL    IS_BPB
000D7A 4D7A 3824            12      JR  C,NOTREADY
000D7C 4D7C 3A23FB          13      LD  A,(DRVTBL+2)
000D7F 4D7F B7               4      OR  A
000D80 4D80 201A            12      JR  NZ,DSKCHG1
000D82 4D82 3A21FB          13      LD  A,(DRVTBL)
000D85 4D85 FE02             7      CP  2
000D87 4D87 2013            12      JR  NZ,DSKCHG1
000D89 4D89 CDB04D          17      CALL    IS_BPB
000D8C 4D8C 300E            12      JR  NC,DSKCHG1
000D8E 4D8E 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000D90 4D90 3221FB          13      LD  (DRVTBL),A
000D93 4D93 3223FB          13      LD  (DRVTBL+2),A
000D96 4D96 3A48F3          13      LD  A,(MASTERS)
000D99 4D99 3224FB          13      LD  (DRVTBL+3),A
       4D9C                     DSKCHG1:
000D9C 4D9C AF               4      XOR A
000D9D 4D9D 0601             7      LD  B,1
000D9F 4D9F C9              10      RET
       4DA0                     NOTREADY:
000DA0 4DA0 3E02             7      LD  A,2
000DA2 4DA2 37               4      SCF
000DA3 4DA3 C9              10      RET
                                
       4DA4                     NO_BPB:
000DA4 4DA4 E1              10      POP HL
000DA5 4DA5 23               6      INC HL
000DA6 4DA6 11034F          10      LD  DE,DPB2DD
000DA9 4DA9 011200          10      LD  BC,DPB2DD_E-DPB2DD
000DAC 4DAC EDB0                    LDIR
000DAE 4DAE AF               4      XOR A
000DAF 4DAF C9              10      RET
                                
       4DB0                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000DB0 4DB0 CDDC4E          17      CALL    GET_DISK_BANK
                                
000DB3 4DB3 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000DB6 4DB6 FE01             7      CP  1
000DB8 4DB8 D8              11      RET C
                                
000DB9 4DB9 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000DBC 4DBC C6FF             7      ADD A,0FFH
000DBE 4DBE D8              11      RET C
                                
000DBF 4DBF 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
000DC2 4DC2 FE01             7      CP  1
000DC4 4DC4 C8              11      RET Z
000DC5 4DC5 FE02             7      CP  2
000DC7 4DC7 C8              11      RET Z
000DC8 4DC8 FE04             7      CP  4
000DCA 4DCA C8              11      RET Z
000DCB 4DCB 37               4      SCF
000DCC 4DCC C9              10      RET
                                
       4DCD                     GETDPB:
000DCD 4DCD E5              11      PUSH    HL
000DCE 4DCE CDDC4E          17      CALL    GET_DISK_BANK
                                
000DD1 4DD1 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000DD4 4DD4 B7               4      OR  A
000DD5 4DD5 28CD            12      JR  Z,NO_BPB
000DD7 4DD7 DDE1            14      POP IX
000DD9 4DD9 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000DDC 4DDC 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000DDF 4DDF DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000DE2 4DE2 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000DE5 4DE5 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000DE8 4DE8 87               4      ADD A,A
000DE9 4DE9 87               4      ADD A,A
000DEA 4DEA 87               4      ADD A,A
000DEB 4DEB 3D               4      DEC A
000DEC 4DEC DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000DEF 4DEF 06FF             7      LD  B,-1
000DF1 4DF1 A7               4      AND A           ;無限ループ阻止
       4DF2                     GETDPB1:
000DF2 4DF2 04               4      INC B
000DF3 4DF3 1F               4      RRA
000DF4 4DF4 38FC            12      JR  C,GETDPB1
000DF6 4DF6 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000DF9 4DF9 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000DFC 4DFC 3D               4      DEC A
000DFD 4DFD DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000E00 4E00 A7               4      AND A           ;無限ループ阻止
000E01 4E01 06FF             7      LD  B,-1
       4E03                     GETDPB2:
000E03 4E03 04               4      INC B
000E04 4E04 1F               4      RRA
000E05 4E05 38FC            12      JR  C,GETDPB2
000E07 4E07 04               4      INC B
000E08 4E08 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000E0B 4E0B 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
000E0E 4E0E DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
000E11 4E11 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
000E14 4E14 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
000E17 4E17 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000E1A 4E1A 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
000E1D 4E1D DD770B          19      LD  (IX+11),A       ;FATCNT
                                
000E20 4E20 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
000E24 4E24 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
000E27 4E27 DD460A          19      LD  B,(IX+10)       ;FATCNT
000E2A 4E2A 210000          10      LD  HL,0
       4E2D                     GETDPB3:
000E2D 4E2D 19              11      ADD HL,DE
000E2E 4E2E 10FD            13      DJNZ    GETDPB3
       4E30                     GETDPB4:
000E30 4E30 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
000E33 4E33 DD5609          19      LD  D,(IX+9)        ;FIRFAT
000E36 4E36 19              11      ADD HL,DE
000E37 4E37 DD7511          19      LD  (IX+17),L       ;FIRDIR
000E3A 4E3A DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000E3D 4E3D DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000E40 4E40 87               4      ADD A,A
000E41 4E41 87               4      ADD A,A
000E42 4E42 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4E45                     GETDPB5:
000E45 4E45 CB3B             8      SRL E
000E47 4E47 1F               4      RRA
000E48 4E48 30FB            12      JR  NC,GETDPB5
000E4A 4E4A 1600             7      LD  D,0
000E4C 4E4C 19              11      ADD HL,DE
000E4D 4E4D DD750C          19      LD  (IX+12),L       ;FIRREC
000E50 4E50 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000E53 4E53 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
000E56 4E56 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
000E59 4E59 DD560D          19      LD  D,(IX+13)       ;FIRREC
000E5C 4E5C A7               4      AND A
000E5D 4E5D ED52            15      SBC HL,DE
                                
000E5F 4E5F DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
000E62 4E62 3C               4      INC A
000E63 4E63 37               4      SCF             ;無限ループ阻止
       4E64                     GETDPB6:
000E64 4E64 1F               4      RRA
000E65 4E65 3806            12      JR  C,GETDPB7
000E67 4E67 CB3C             8      SRL H
000E69 4E69 CB1D             8      RR  L
000E6B 4E6B 18F7            12      JR  GETDPB6
       4E6D                     GETDPB7:
000E6D 4E6D 23               6      INC HL
000E6E 4E6E DD750E          19      LD  (IX+14),L       ;MAXCLUS
000E71 4E71 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       4E74                     GETDPBD1:
000E74 4E74 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000E77 4E77 E6FC             7      AND 0FCH
000E79 4E79 C8              11      RET Z
                                
000E7A 4E7A DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
000E7E 4E7E 37               4      SCF
000E7F 4E7F DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
000E83 4E83 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
000E86 4E86 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
000E8A 4E8A DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
000E8E 4E8E DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
000E92 4E92 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
000E96 4E96 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
000E9A 4E9A DDCB1126        23      SLA (IX+17)         ;FIRDIR
000E9E 4E9E DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
000EA2 4EA2 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
000EA5 4EA5 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
000EA8 4EA8 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000EAB 4EAB 87               4      ADD A,A
000EAC 4EAC 87               4      ADD A,A
000EAD 4EAD DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4EB0                     GETDPBD5:
000EB0 4EB0 CB3B             8      SRL E
000EB2 4EB2 1F               4      RRA
000EB3 4EB3 30FB            12      JR  NC,GETDPBD5
000EB5 4EB5 1600             7      LD  D,0
000EB7 4EB7 19              11      ADD HL,DE
000EB8 4EB8 DD750C          19      LD  (IX+12),L       ;FIRREC
000EBB 4EBB DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000EBE 4EBE 18B4            12      JR  GETDPBD1
                                
       4EC0                     CHOICE:
000EC0 4EC0 210000          10      LD  HL,0
000EC3 4EC3 C9              10      RET
                                
       4EC4                     DSKFMT:
000EC4 4EC4 AF               4      XOR A
000EC5 4EC5 37               4      SCF
       4EC6                     DSKSTP:
000EC6 4EC6 C9              10      RET
                                
       4EC7                     BASENT:
000EC7 4EC7 ED7B5FF1        20      LD  SP,(BASSTK)
000ECB 4ECB C3D643          10      JP  BASAUTO
                                
       4ECE                     GETSLT:
000ECE 4ECE 3A22FB          13      LD  A,(DRVTBL+1)
000ED1 4ED1 C9              10      RET
                                
       4ED2                     GET_DISK_BANK_FDRV:
000ED2 4ED2 3A53F1          13      LD  A,(FDRV)
000ED5 4ED5 D601             7      SUB 1
000ED7 4ED7 3003            12      JR  NC,GET_DISK_BANK
000ED9 4ED9 3A4AF1          13      LD  A,(_DVSW)
       4EDC                     GET_DISK_BANK:
000EDC 4EDC B7               4      OR  A       ;A=DRIVE
000EDD 4EDD 3E01             7      LD  A,DISK_BANK
000EDF 4EDF 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
000EE1 4EE1 3A49F1          13      LD  A,(B_DRIVE)
                                #endif
       4EE4                     SET_DISK_BANK:
000EE4 4EE4 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000EE7 4EE7 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000EEA 4EEA F5              11      PUSH    AF
000EEB 4EEB E5              11      PUSH    HL
000EEC 4EEC 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
000EEF 4EEF 2223F1          16      LD  (SECSZ),HL
000EF2 4EF2 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000EF5 4EF5 CDFE4E          17      CALL    MUL_AHL
000EF8 4EF8 2221F1          16      LD  (CLSZ),HL
000EFB 4EFB E1              10      POP HL
000EFC 4EFC F1              10      POP AF
000EFD 4EFD C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)
       4EFE                     MUL_AHL:
000EFE 4EFE 1F               4      RRA     ;->CF
000EFF 4EFF D8              11      RET C
000F00 4F00 29              11      ADD HL,HL
000F01 4F01 18FB            12      JR  MUL_AHL
                                
       4F03                     DPB2DD:
000F03 4F03 F9                      DB  0F9H    ;MEDIA
000F04 4F04 0002                    DW  00200H  ;SECSIZ
000F06 4F06 0F                      DB  00FH    ;DIRMSK
000F07 4F07 04                      DB  004H    ;DIRSHFT
000F08 4F08 01                      DB  001H    ;CLUSMSK
000F09 4F09 02                      DB  002H    ;CLUSSHFT
000F0A 4F0A 0100                    DW  00001H  ;FIRFAT
000F0C 4F0C 02                      DB  002H    ;FATCNT
000F0D 4F0D 70                      DB  070H    ;MAXENT
000F0E 4F0E 0E00                    DW  0000EH  ;FIRREC
000F10 4F10 CA02                    DW  002CAH  ;MAXCLUS
000F12 4F12 03                      DB  003H    ;FATSIZ
000F13 4F13 0700                    DW  0007H   ;FIRDIR
       4F15                     DPB2DD_E:
                                
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       4F15                     POP_HL_ERROR:
000F15 4F15 E1              10      POP     HL
       4F16                     _ERROR:
000F16 4F16 0600             7      LD  B,0
000F18 4F18 A7               4      AND A
000F19 4F19 C9              10      RET
                                
       4F1A                     ROM_BDOS:
000F1A 4F1A E5              11      PUSH    HL
000F1B 4F1B 79               4      LD  A,C
000F1C 4F1C 87               4      ADD A,A
000F1D 4F1D 38F7            12      JR  C,_ERROR
000F1F 4F1F 6F               4      LD  L,A
000F20 4F20 265F             7      LD  H,high STABLE
000F22 4F22 7E               7      LD  A,(HL)
000F23 4F23 2C               4      INC L
000F24 4F24 66               7      LD  H,(HL)
000F25 4F25 6F               4      LD  L,A
000F26 4F26 E3              19      EX  (SP),HL
000F27 4F27 79               4      LD  A,C
000F28 4F28 C9              10      RET
                                
       4F29                     _PRINT:
       4F29                     PRINT:
000F29 4F29 7B               4      LD  A,E
000F2A 4F2A 1803            12      JR  MSG_A
                                
       4F2C                     _SYS01:     ;(BDOS)コンソール入力
000F2C 4F2C CDA34F          17      CALL    _SYS07
       4F2F                     MSG_A:
000F2F 4F2F FE03             7      CP  3
000F31 4F31 2814            12      JR  Z,MSG_BR
       4F33                     MSGA1:
000F33 4F33 F5              11      PUSH    AF
000F34 4F34 C5              11      PUSH    BC
000F35 4F35 D5              11      PUSH    DE
000F36 4F36 E5              11      PUSH    HL
000F37 4F37 DDE5            15      PUSH    IX
000F39 4F39 DD21A200        14      LD  IX,CHPUT
000F3D 4F3D CDFD42          17      CALL    CALSLT_R
000F40 4F40 DDE1            14      POP IX
000F42 4F42 E1              10      POP HL
000F43 4F43 D1              10      POP DE
000F44 4F44 C1              10      POP BC
       4F45                     MSGA2:
000F45 4F45 F1              10      POP AF
000F46 4F46 C9              10      RET
       4F47                     MSG_BR:
000F47 4F47 F5              11      PUSH    AF
000F48 4F48 3ADDF3          13      LD  A,(CSRX)
000F4B 4F4B FE02             7      CP  2
000F4D 4F4D 38F6            12      JR  C,MSGA2
000F4F 4F4F F1              10      POP AF
       4F50                     MSG_CR:
000F50 4F50 F5              11      PUSH    AF
000F51 4F51 3E0D             7      LD  A,00DH
000F53 4F53 CD334F          17      CALL    MSGA1
000F56 4F56 3E0A             7      LD  A,00AH
000F58 4F58 CD334F          17      CALL    MSGA1
000F5B 4F5B F1              10      POP AF
000F5C 4F5C C9              10      RET
                                
       4F5D                     _SYS02:     ;(BDOS)コンソール出力
000F5D 4F5D CD784F          17      CALL    BREAK
000F60 4F60 1805            12      JR  PRINTX
                                
       4F62                     _SYS06:     ;(BDOS)コンソール直接入出力
000F62 4F62 7B               4      LD  A,E
000F63 4F63 3C               4      INC A
000F64 4F64 CAB74F          10      JP  Z,_INKEY
       4F67                     PRINTX:
000F67 4F67 C3294F          10      JP  _PRINT
                                
       4F6A                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000F6A 4F6A CDA34F          17      CALL    _SYS07
000F6D 4F6D FE03             7      CP  3
000F6F 4F6F CC784F          17      CALL    Z,_BREAK
000F72 4F72 FE13             7      CP  013H        ;CTRL+S
000F74 4F74 C0              11      RET NZ
       4F75                     PAUSE:
000F75 4F75 CD8F4F          17      CALL    KEYBC
                                
       4F78                     _BREAK:
       4F78                     BREAK:
000F78 4F78 F5              11      PUSH    AF
000F79 4F79 C5              11      PUSH    BC
000F7A 4F7A D5              11      PUSH    DE
000F7B 4F7B E5              11      PUSH    HL
000F7C 4F7C DDE5            15      PUSH    IX
000F7E 4F7E DD21B700        14      LD  IX,BREAKX
000F82 4F82 CDFD42          17      CALL    CALSLT_R
000F85 4F85 DDE1            14      POP IX
000F87 4F87 E1              10      POP HL
000F88 4F88 D1              10      POP DE
000F89 4F89 C1              10      POP BC
000F8A 4F8A DC784F          17      CALL    C,_BREAK
000F8D 4F8D F1              10      POP AF
000F8E 4F8E C9              10      RET
       4F8F                     KEYBC:
000F8F 4F8F F5              11      PUSH    AF
000F90 4F90 C5              11      PUSH    BC
000F91 4F91 D5              11      PUSH    DE
000F92 4F92 E5              11      PUSH    HL
000F93 4F93 DDE5            15      PUSH    IX
000F95 4F95 DD215601        14      LD  IX,KILBUF
000F99 4F99 CDFD42          17      CALL    CALSLT_R
000F9C 4F9C DDE1            14      POP IX
000F9E 4F9E E1              10      POP HL
000F9F 4F9F D1              10      POP DE
000FA0 4FA0 C1              10      POP BC
000FA1 4FA1 F1              10      POP AF
000FA2 4FA2 C9              10      RET
                                
       4FA3                     _SYS07:
       4FA3                     FLGET:
000FA3 4FA3 C5              11      PUSH    BC
000FA4 4FA4 D5              11      PUSH    DE
000FA5 4FA5 E5              11      PUSH    HL
000FA6 4FA6 DDE5            15      PUSH    IX
000FA8 4FA8 DD219F00        14      LD  IX,CHGET
000FAC 4FAC CDFD42          17      CALL    CALSLT_R
000FAF 4FAF DDE1            14      POP IX
000FB1 4FB1 E1              10      POP HL
000FB2 4FB2 D1              10      POP DE
000FB3 4FB3 C1              10      POP BC
000FB4 4FB4 FE03             7      CP  3
000FB6 4FB6 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       4FB7                     _INKEY:
       4FB7                     INKEY:
000FB7 4FB7 CD5150          17      CALL    CPM_CONST
000FBA 4FBA C8              11      RET Z
000FBB 4FBB 18E6            12      JR  FLGET
                                
       4FBD                     _SYS0A:     ;(BDOS)文字列入力
000FBD 4FBD C5              11      PUSH    BC
000FBE 4FBE E5              11      PUSH    HL
000FBF 4FBF D5              11      PUSH    DE
000FC0 4FC0 CDE94F          17      CALL    GETL
000FC3 4FC3 111FF4          10      LD  DE,KBUF
000FC6 4FC6 E1              10      POP HL
000FC7 4FC7 E5              11      PUSH    HL
000FC8 4FC8 0E00             7      LD  C,0
000FCA 4FCA 3004            12      JR  NC,SAX0
000FCC 4FCC 23               6      INC HL
000FCD 4FCD 23               6      INC HL
000FCE 4FCE 1808            12      JR  SAX4
       4FD0                     SAX0:
000FD0 4FD0 46               7      LD  B,(HL)
000FD1 4FD1 23               6      INC HL
       4FD2                     SAX1:
000FD2 4FD2 23               6      INC HL
000FD3 4FD3 1A               7      LD  A,(DE)
000FD4 4FD4 13               6      INC DE
000FD5 4FD5 B7               4      OR  A
000FD6 4FD6 2004            12      JR  NZ,SAX2
       4FD8                     SAX4:
000FD8 4FD8 360D            10      LD  (HL),00DH
000FDA 4FDA 1804            12      JR  SAX3
       4FDC                     SAX2:
000FDC 4FDC 77               7      LD  (HL),A
000FDD 4FDD 0C               4      INC C
000FDE 4FDE 10F2            13      DJNZ    SAX1
       4FE0                     SAX3:
000FE0 4FE0 D1              10      POP DE
000FE1 4FE1 79               4      LD  A,C
000FE2 4FE2 13               6      INC DE
000FE3 4FE3 12               7      LD  (DE),A
000FE4 4FE4 1B               6      DEC DE
000FE5 4FE5 E1              10      POP HL
000FE6 4FE6 C1              10      POP BC
000FE7 4FE7 A7               4      AND A
000FE8 4FE8 C9              10      RET
       4FE9                     GETL:
000FE9 4FE9 DDE5            15      PUSH    IX
000FEB 4FEB FDE5            15      PUSH    IY
                                
000FED 4FED 2ADCF3          16      LD  HL,(CSRY)
000FF0 4FF0 22CAFB          16      LD  (FSTPOS),HL
       4FF3                     GETL1:
000FF3 4FF3 CD6A4F          17      CALL    _SYS08
000FF6 4FF6 FE09             7      CP  9
000FF8 4FF8 2008            12      JR  NZ,GETL1V
000FFA 4FFA 211FF4          10      LD  HL,KBUF
000FFD 4FFD CD8843          17      CALL    MSX
001000 5000 18F1            12      JR  GETL1
       5002                     GETL1V:
001002 5002 5F               4      LD  E,A
001003 5003 FE08             7      CP  8
001005 5005 CC9F50          17      CALL    Z,CTRL02
001008 5008 FE20             7      CP  020H
00100A 500A D4CB50          17      CALL    NC,INSERT
00100D 500D CD334F          17      CALL    MSGA1
                                
001010 5010 7B               4      LD  A,E
001011 5011 FE0D             7      CP  00DH
001013 5013 20DE            12      JR  NZ,GETL1
                                
001015 5015 111FF4          10      LD  DE,KBUF
001018 5018 3AB0F3          13      LD  A,(LINLEN)
00101B 501B 47               4      LD  B,A
00101C 501C CD7E52          17      CALL    ZERO_MEMORY_DE
                                
00101F 501F 2ACAFB          16      LD  HL,(FSTPOS)
001022 5022 3ADCF3          13      LD  A,(CSRY)
001025 5025 6F               4      LD  L,A
001026 5026 E5              11      PUSH    HL
001027 5027 CDFC50          17      CALL    LOC0
00102A 502A 4D               4      LD  C,L
00102B 502B 44               4      LD  B,H
00102C 502C E1              10      POP HL
00102D 502D 3AB0F3          13      LD  A,(LINLEN)
001030 5030 94               4      SUB H
001031 5031 3D               4      DEC A
001032 5032 5F               4      LD  E,A
001033 5033 211FF4          10      LD  HL,KBUF
       5036                     GETL2:
001036 5036 CD8F50          17      CALL    _SCRN
001039 5039 03               6      INC BC
00103A 503A 77               7      LD  (HL),A
00103B 503B 23               6      INC HL
00103C 503C 1D               4      DEC E
00103D 503D 20F7            12      JR  NZ,GETL2
00103F 503F CD504F          17      CALL    MSG_CR
                                
001042 5042 FDE1            14      POP IY
001044 5044 DDE1            14      POP IX
       5046                     GETL3:
001046 5046 2B               6      DEC HL
001047 5047 7E               7      LD  A,(HL)
001048 5048 FE21             7      CP  021H
00104A 504A D0              11      RET NC
00104B 504B 3600            10      LD  (HL),0
00104D 504D 15               4      DEC D
00104E 504E 20F6            12      JR  NZ,GETL3
001050 5050 C9              10      RET
                                
       5051                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       5051                     CONSTX:
       5051                     CPM_CONST:
001051 5051 C5              11      PUSH    BC
001052 5052 D5              11      PUSH    DE
001053 5053 E5              11      PUSH    HL
001054 5054 DDE5            15      PUSH    IX
001056 5056 DD219C00        14      LD  IX,CHSNS
00105A 505A CDFD42          17      CALL    CALSLT_R
00105D 505D DDE1            14      POP IX
00105F 505F E1              10      POP HL
001060 5060 D1              10      POP DE
001061 5061 C1              10      POP BC
001062 5062 C9              10      RET
                                
       5063                     _SYS2A:     ;(BDOS)日付の獲得
001063 5063 AF               4      XOR A
001064 5064 57               4      LD  D,A
001065 5065 5F               4      LD  E,A
001066 5066 67               4      LD  H,A
001067 5067 6F               4      LD  L,A
001068 5068 C9              10      RET
                                
       5069                     _SYS2C:     ;(BDOS)時刻の獲得
001069 5069 AF               4      XOR A
00106A 506A 57               4      LD  D,A
00106B 506B 5F               4      LD  E,A
00106C 506C 67               4      LD  H,A
00106D 506D 6F               4      LD  L,A
00106E 506E C9              10      RET
                                
       506F                     POS:
00106F 506F F5              11      PUSH    AF
001070 5070 2ADCF3          16      LD  HL,(CSRY)
001073 5073 7D               4      LD  A,L
001074 5074 6C               4      LD  L,H
001075 5075 67               4      LD  H,A
001076 5076 2C               4      INC L
001077 5077 24               4      INC H
001078 5078 F1              10      POP AF
001079 5079 C9              10      RET
                                
       507A                     LOC:
00107A 507A F5              11      PUSH    AF
00107B 507B E5              11      PUSH    HL
00107C 507C 7D               4      LD  A,L
00107D 507D 6C               4      LD  L,H
00107E 507E 67               4      LD  H,A
00107F 507F 2D               4      DEC L
001080 5080 25               4      DEC H
001081 5081 DDE5            15      PUSH    IX
001083 5083 DD21C600        14      LD  IX,POSIT
001087 5087 CDFD42          17      CALL    CALSLT_R
00108A 508A DDE1            14      POP IX
00108C 508C E1              10      POP HL
00108D 508D F1              10      POP AF
00108E 508E C9              10      RET
                                
       508F                     _SCRN:
       508F                     SCRN:
00108F 508F E5              11      PUSH    HL
001090 5090 DDE5            15      PUSH    IX
                                
001092 5092 69               4      LD  L,C
001093 5093 60               4      LD  H,B
001094 5094 DD214A00        14      LD  IX,RDVRM
001098 5098 CDFD42          17      CALL    CALSLT_R
                                
00109B 509B DDE1            14      POP IX
00109D 509D E1              10      POP HL
00109E 509E C9              10      RET
                                
       509F                     CTRL02:
00109F 509F F5              11      PUSH    AF
0010A0 50A0 D5              11      PUSH    DE
0010A1 50A1 2ADCF3          16      LD  HL,(CSRY)
0010A4 50A4 3AB0F3          13      LD  A,(LINLEN)
0010A7 50A7 4F               4      LD  C,A
0010A8 50A8 94               4      SUB H   ;CSRX
0010A9 50A9 C602             7      ADD A,2
0010AB 50AB 47               4      LD  B,A ;カーソルより右の文字数
0010AC 50AC 61               4      LD  H,C ;LINLEN
0010AD 50AD C5              11      PUSH    BC
0010AE 50AE CDFC50          17      CALL    LOC0
0010B1 50B1 C1              10      POP BC
                                
0010B2 50B2 1620             7      LD  D,020H
       50B4                     C8X1:
0010B4 50B4 DD214A00        14      LD  IX,RDVRM
0010B8 50B8 CDFD42          17      CALL    CALSLT_R
0010BB 50BB 4F               4      LD  C,A
0010BC 50BC 7A               4      LD  A,D
0010BD 50BD DD214D00        14      LD  IX,WRTVRM
0010C1 50C1 CDFD42          17      CALL    CALSLT_R
0010C4 50C4 2B               6      DEC HL
0010C5 50C5 51               4      LD  D,C
0010C6 50C6 10EC            13      DJNZ    C8X1
0010C8 50C8 D1              10      POP DE
0010C9 50C9 F1              10      POP AF
0010CA 50CA C9              10      RET
                                
       50CB                     INSERT:
0010CB 50CB F5              11      PUSH    AF
0010CC 50CC D5              11      PUSH    DE
0010CD 50CD 2ADCF3          16      LD  HL,(CSRY)
0010D0 50D0 3AB0F3          13      LD  A,(LINLEN)
0010D3 50D3 4F               4      LD  C,A
0010D4 50D4 94               4      SUB H   ;CSRX
0010D5 50D5 3C               4      INC A
0010D6 50D6 47               4      LD  B,A ;カーソルより右の文字数
0010D7 50D7 C5              11      PUSH    BC
0010D8 50D8 CDFC50          17      CALL    LOC0
0010DB 50DB C1              10      POP BC
                                
0010DC 50DC 1620             7      LD  D,020H
       50DE                     INS1:
0010DE 50DE DD214A00        14      LD  IX,RDVRM
0010E2 50E2 CDFD42          17      CALL    CALSLT_R
0010E5 50E5 4F               4      LD  C,A
0010E6 50E6 7A               4      LD  A,D
0010E7 50E7 DD214D00        14      LD  IX,WRTVRM
0010EB 50EB CDFD42          17      CALL    CALSLT_R
0010EE 50EE 23               6      INC HL
0010EF 50EF 51               4      LD  D,C
0010F0 50F0 10EC            13      DJNZ    INS1
0010F2 50F2 D1              10      POP DE
0010F3 50F3 F1              10      POP AF
0010F4 50F4 C9              10      RET
                                
       50F5                     CONOUT1:
0010F5 50F5 59               4      LD  E,C
0010F6 50F6 C3294F          10      JP  _PRINT
                                
       50F9                     GETVRAM:
0010F9 50F9 2ADCF3          16      LD  HL,(CSRY)
       50FC                     LOC0:
0010FC 50FC 2D               4      DEC L
0010FD 50FD 25               4      DEC H
0010FE 50FE 4C               4      LD  C,H ;CSRX-1
0010FF 50FF 5D               4      LD  E,L ;CSRY-1
       5100                     LOC1:
001100 5100 3AB0F3          13      LD  A,(LINLEN)
001103 5103 67               4      LD  H,A
001104 5104 1600             7      LD  D,0
001106 5106 6A               4      LD  L,D ;0
001107 5107 0608             7      LD  B,8
       5109                     LOC2:
001109 5109 29              11      ADD HL,HL
00110A 510A 3001            12      JR  NC,LOC3
00110C 510C 19              11      ADD HL,DE
       510D                     LOC3:
00110D 510D 10FA            13      DJNZ    LOC2
00110F 510F 09              11      ADD HL,BC
001110 5110 C9              10      RET
                                
       5111                     _SYS0C:     ;(BDOS)バージョン番号の獲得
001111 5111 212200          10      LD  HL,00022H
001114 5114 AF               4      XOR A
001115 5115 7D               4      LD  A,L
001116 5116 C9              10      RET
                                
       5117                     _SYS0D:     ;(BDOS)ディスク・リセット
001117 5117 218000          10      LD  HL,00080H
00111A 511A 222FF1          16      LD  (_DTA),HL
00111D 511D C9              10      RET
                                
       511E                     _SYS0E:     ;(BDOS)カレントドライブの設定
00111E 511E 324AF1          13      LD  (_DVSW),A
001121 5121 C9              10      RET
                                
       5122                     _SYS0F:     ;(BDOS)ファイルのオープン
001122 5122 D5              11      PUSH    DE
001123 5123 FDE1            14      POP IY
001125 5125 CD6B52          17      CALL    INIT_FILE
001128 5128 CDB34A          17      CALL    ROM_OPEN
00112B 512B 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
00112D 512D FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
001131 5131 FDE5            15      PUSH    IY
001133 5133 D1              10      POP DE
001134 5134 13               6      INC DE
001135 5135 010B00          10      LD  BC,11
001138 5138 EDB0                    LDIR
                                ;               Attribute
00113A 513A 7E               7      LD  A,(HL)
00113B 513B FD770D          19      LD  (IY+13),A
                                ;               TIME
00113E 513E 110B00          10      LD  DE,11
001141 5141 19              11      ADD HL,DE
001142 5142 7E               7      LD  A,(HL)
001143 5143 23               6      INC HL
001144 5144 FD7716          19      LD  (IY+22),A
001147 5147 7E               7      LD  A,(HL)
001148 5148 23               6      INC HL
001149 5149 FD7717          19      LD  (IY+23),A
                                ;               DATE
00114C 514C 7E               7      LD  A,(HL)
00114D 514D 23               6      INC HL
00114E 514E FD7714          19      LD  (IY+20),A
001151 5151 7E               7      LD  A,(HL)
001152 5152 23               6      INC HL
001153 5153 FD7715          19      LD  (IY+21),A
                                ;               First cluster
001156 5156 7E               7      LD  A,(HL)
001157 5157 23               6      INC HL
001158 5158 FD771A          19      LD  (IY+26),A
00115B 515B 7E               7      LD  A,(HL)
00115C 515C 23               6      INC HL
00115D 515D FD771B          19      LD  (IY+27),A
                                ;               SIZE
001160 5160 7E               7      LD  A,(HL)
001161 5161 23               6      INC HL
001162 5162 FD7710          19      LD  (IY+16),A
001165 5165 7E               7      LD  A,(HL)
001166 5166 23               6      INC HL
001167 5167 FD7711          19      LD  (IY+17),A
00116A 516A 7E               7      LD  A,(HL)
00116B 516B 23               6      INC HL
00116C 516C FD7712          19      LD  (IY+18),A
00116F 516F 7E               7      LD  A,(HL)
001170 5170 FD7713          19      LD  (IY+19),A
001173 5173 AF               4      XOR A
001174 5174 FD770C          19      LD  (IY+12),A
001177 5177 C9              10      RET
                                
       5178                     _SYS10:     ;(BDOS)ファイルのクローズ
001178 5178 AF               4      XOR A
001179 5179 C9              10      RET
                                
       517A                     S11X1:
00117A 517A FD7119          19      LD  (IY+25),C       ;RootEntCnt
00117D 517D FD750E          19      LD  (IY+14),L
001180 5180 FD740F          19      LD  (IY+15),H
       5183                     SCF_FF_RET:
001183 5183 37               4      SCF
001184 5184 9F               4      SBC A,A
001185 5185 C9              10      RET
                                
       5186                     _SYS11:     ;(BDOS)最初のファイルの検索
001186 5186 ED5337F1        20      LD  (_FCB),DE
00118A 518A D5              11      PUSH    DE
00118B 518B FDE1            14      POP IY
00118D 518D CD6B52          17      CALL    INIT_FILE
001190 5190 CDFB4C          17      CALL    GET_DIR_DAT
       5193                     S12X1:
001193 5193 CDCF4A          17      CALL    FILESE
001196 5196 30E2            12      JR  NC,S11X1
001198 5198 0D               4      DEC C
001199 5199 FD7119          19      LD  (IY+25),C       ;RootEntCnt
00119C 519C 012000          10      LD  BC,32
00119F 519F ED5B2FF1        20      LD  DE,(_DTA)
0011A3 51A3 AF               4      XOR A
0011A4 51A4 12               7      LD  (DE),A      ;ドライブ番号
0011A5 51A5 13               6      INC DE
0011A6 51A6 EDB0                    LDIR            ;ディレクトリエントリ
0011A8 51A8 FD750E          19      LD  (IY+14),L
0011AB 51AB FD740F          19      LD  (IY+15),H
0011AE 51AE C9              10      RET
                                
       51AF                     _SYS12:
0011AF 51AF FD2A37F1        20      LD  IY,(_FCB)
0011B3 51B3 FDE5            15      PUSH    IY
0011B5 51B5 D1              10      POP DE
0011B6 51B6 CD6B52          17      CALL    INIT_FILE
                                
0011B9 51B9 FD6E0E          19      LD  L,(IY+14)
0011BC 51BC FD660F          19      LD  H,(IY+15)
0011BF 51BF FD4E19          19      LD  C,(IY+25)
0011C2 51C2 18CF            12      JR  S12X1
                                
       51C4                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0011C4 51C4 CDE14C          17      CALL    SET_FCB
0011C7 51C7 CDAF4C          17      CALL    GETSEQ
0011CA 51CA CD9C4C          17      CALL    RB_READ
0011CD 51CD E5              11      PUSH    HL
0011CE 51CE CDBC4C          17      CALL    SETSEQ
0011D1 51D1 E1              10      POP HL
       51D2                     SREAD:
0011D2 51D2 C601             7      ADD A,001H
0011D4 51D4 D8              11      RET C
                                
0011D5 51D5 7D               4      LD  A,L
0011D6 51D6 D601             7      SUB 001H
0011D8 51D8 9F               4      SBC A,A
0011D9 51D9 E603             7      AND 3
0011DB 51DB 1F               4      RRA
0011DC 51DC C9              10      RET
                                
       51DD                     _SYS18:     ;(BDOS)ログインベクトルの獲得
0011DD 51DD 210100          10      LD  HL,00001H
0011E0 51E0 AF               4      XOR A
0011E1 51E1 C9              10      RET
                                
       51E2                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
0011E2 51E2 3A4AF1          13      LD  A,(_DVSW)
0011E5 51E5 C9              10      RET
                                
       51E6                     _SYS1A:     ;(BDOS)DTAの設定
0011E6 51E6 ED532FF1        20      LD  (_DTA),DE
0011EA 51EA AF               4      XOR A
0011EB 51EB C9              10      RET
                                
       51EC                     _SYS1B:     ;(BDOS)ディスク情報の獲得
0011EC 51EC 010002          10      LD  BC,512
0011EF 51EF 11C302          10      LD  DE,707
0011F2 51F2 210000          10      LD  HL,0
0011F5 51F5 DD2139F1        14      LD  IX,_BUF
0011F9 51F9 FD2139F1        14      LD  IY,_BUF
0011FD 51FD FD3600F9        19      LD  (IY+0),0F9H
001201 5201 3E02             7      LD  A,2
001203 5203 C9              10      RET
                                
       5204                     _SYS21:     ;(BDOS)ランダムな読み出し
001204 5204 CDE14C          17      CALL    SET_FCB
                                
001207 5207 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
00120A 520A FD6622          19      LD  H,(IY+34)
                                
00120D 520D CD9C4C          17      CALL    RB_READ
001210 5210 18C0            12      JR  SREAD
                                
       5212                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
001212 5212 CD2251          17      CALL    _SYS0F
001215 5215 D8              11      RET C
                                
001216 5216 D5              11      PUSH    DE      ;EX DE,IY
001217 5217 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001219 5219 CDD14C          17      CALL    GETSIZE
       521C                     _S24X1:
00121C 521C FD7521          19      LD  (IY+33),L   ;(FCB)Random record
00121F 521F FD7422          19      LD  (IY+34),H
001222 5222 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
001226 5226 FDE3            23      EX  (SP),IY     ;
001228 5228 D1              10      POP DE      ;
                                
001229 5229 AF               4      XOR A
00122A 522A C9              10      RET
                                
       522B                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
00122B 522B E5              11      PUSH    HL
00122C 522C D5              11      PUSH    DE      ;EX DE,IY
00122D 522D FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00122F 522F CDAF4C          17      CALL    GETSEQ
001232 5232 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       5234                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001234 5234 CDE14C          17      CALL    SET_FCB
001237 5237 E5              11      PUSH    HL
001238 5238 FD6E21          19      LD  L,(IY+33)
00123B 523B FD6622          19      LD  H,(IY+34)
00123E 523E 2225F1          16      LD  (RR_LOW),HL
001241 5241 FD6E23          19      LD  L,(IY+35)
001244 5244 FD6624          19      LD  H,(IY+36)
001247 5247 2227F1          16      LD  (RR_HIGH),HL
00124A 524A E1              10      POP HL
00124B 524B CDD348          17      CALL    ROM_READ
00124E 524E ED5B25F1        20      LD  DE,(RR_LOW)
001252 5252 FD7321          19      LD  (IY+33),E
001255 5255 FD7222          19      LD  (IY+34),D
001258 5258 ED5B27F1        20      LD  DE,(RR_HIGH)
00125C 525C FD7323          19      LD  (IY+35),E
00125F 525F FD7224          19      LD  (IY+36),D
001262 5262 9F               4      SBC A,A
001263 5263 C9              10      RET
                                
       5264                     _SYS2F:
001264 5264 44               4      LD  B,H
001265 5265 2A2FF1          16      LD  HL,(_DTA)
001268 5268 C33D4D          10      JP  DISKIO
                                
       526B                     INIT_FILE:
00126B 526B EB               4      EX  DE,HL
00126C 526C 1153F1          10      LD  DE,FDRV
00126F 526F 010C00          10      LD  BC,1+8+3
001272 5272 EDB0                    LDIR
001274 5274 CDD24E          17      CALL    GET_DISK_BANK_FDRV
001277 5277 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
00127A 527A 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
00127D 527D C9              10      RET
                                
       527E                     ZERO_MEMORY_DE:
00127E 527E AF               4      XOR A
       527F                     FILL_MEMORY_DE:
00127F 527F 12               7      LD  (DE),A
001280 5280 13               6      INC DE
001281 5281 10FC            13      DJNZ    FILL_MEMORY_DE
001283 5283 C9              10      RET
                                
001284 5284                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 164F2C4F5D4F164F        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 164F164F624FA34F        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 6A4F164FBD4F5150        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 115117511E512251        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 78518651AF51164F        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 C451164F164F164F        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 DD51E251E651EC51        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 164F164F164F1252        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 2B52164F164F3452        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 164F164F6350164F        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 6950164F164F6452        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB8 5FB8 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 164F164F164F164F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
