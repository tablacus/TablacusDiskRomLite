                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       42B2                     CRUNCH  EQU 042B2H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
                                ;PTRFIL EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
                                ;FILNAM EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
                                ;RSTMP  EQU 0FB03H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FEDA                     H_STKE  EQU 0FEDAH
                                
       FF43                     H_GONE  EQU 0FF43H
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;KONAMI-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                
       F0E9                     ISC EQU 0F0E9H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
[EOF:DEF.ASM:UTF_8]
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C3834D          10      JP  DISKIO
000013 4013 C3BD4D          10      JP  DSKCHG
000016 4016 C3134E          10      JP  GETDPB
000019 4019 C3064F          10      JP  CHOICE
00001C 401C C30A4F          10      JP  DSKFMT
00001F 401F C30C4F          10      JP  DSKSTP
000022 4022 C30D4F          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C30A4F          10      JP  DSKFMT
000029 4029 C30C4F          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3144F          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.1.5.2",0
            204449534B20524F    
            4D204C6974652076    
            302E312E352E3200    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 0180FF          10      LD  BC,-00080H
000109 4109 2A72F6          16      LD  HL,(MEMSIZ)
00010C 410C 09              11      ADD HL,BC
00010D 410D 2272F6          16      LD  (MEMSIZ),HL
000110 4110 2A74F6          16      LD  HL,(STKTOP)
000113 4113 09              11      ADD HL,BC
000114 4114 2274F6          16      LD  (STKTOP),HL
000117 4117 2180F0          10      LD  HL,0F080H
00011A 411A 1100F0          10      LD  DE,0F000H
00011D 411D 012000          10      LD  BC,00020H
000120 4120 EDB0                    LDIR
000122 4122 2180FF          10      LD  HL,-00080H
000125 4125 39              11      ADD HL,SP
000126 4126 225FF1          16      LD  (BASSTK),HL
000129 4129 ED7B5FF1        20      LD  SP,(BASSTK)
                                
00012D 412D 3EFF             7      LD  A,0FFH
00012F 412F 3299FD          13      LD  (DEVICE),A
                                
000132 4132 3E01             7      LD  A,1
000134 4134 3221FB          13      LD  (DRVTBL),A
                                
000137 4137 AF               4      XOR A
000138 4138 324AF1          13      LD  (_DVSW),A
                                
00013B 413B 210943          10      LD  HL,AT_ISC
00013E 413E 11E9F0          10      LD  DE,ISC
000141 4141 017C00          10      LD  BC,ISC_E-ISC
000144 4144 EDB0                    LDIR
                                    
000146 4146 3EC3             7      LD  A,0C3H      ;JP
000148 4148 3243FF          13      LD  (H_GONE),A
00014B 414B 327DF3          13      LD  (BDOS),A
00014E 414E 326BF3          13      LD  (RAMUSE),A
000151 4151 3268F3          13      LD  (ROMUSE),A
000154 4154 21E9F0          10      LD  HL,REPLACE_COMMAND
000157 4157 2244FF          16      LD  (H_GONE+1),HL
00015A 415A 2131F3          10      LD  HL,H_BDOS
00015D 415D 227EF3          16      LD  (BDOS+1),HL
000160 4160 2119F1          10      LD  HL,RAMUSE1
000163 4163 226CF3          16      LD  (RAMUSE+1),HL
000166 4166 2114F1          10      LD  HL,ROMUSE1
000169 4169 2269F3          16      LD  (ROMUSE+1),HL
                                
00016C 416C 3E                      DB  03EH
00016D 416D F7              12      RST 30H
00016E 416E 3271FE          13      LD  (H_BINS),A
000171 4171 3276FE          13      LD  (H_BINL),A
000174 4174 327BFE          13      LD  (H_FILE),A
000177 4177 3231F3          13      LD  (H_BDOS),A
00017A 417A 32DAFE          13      LD  (H_STKE),A
00017D 417D 32A7FF          13      LD  (H_PHYD),A
                                
000180 4180 CD4942          17      CALL    GTSL1_
000183 4183 3200F1          13      LD  (ROM_SLT),A
000186 4186 3210F1          13      LD  (ROM_SLT_COPY),A
000189 4189 3272FE          13      LD  (H_BINS+1),A
00018C 418C 3277FE          13      LD  (H_BINL+1),A
00018F 418F 327CFE          13      LD  (H_FILE+1),A
000192 4192 3232F3          13      LD  (H_BDOS+1),A
000195 4195 32DBFE          13      LD  (H_STKE+1),A
000198 4198 32A8FF          13      LD  (H_PHYD+1),A
00019B 419B 3222FB          13      LD  (DRVTBL+1),A
00019E 419E 3248F3          13      LD  (MASTERS),A
                                
0001A1 41A1 214045          10      LD  HL,ROM_LOAD
0001A4 41A4 2273FE          16      LD  (H_BINS+2),HL
0001A7 41A7 216846          10      LD  HL,ROM_RUN
0001AA 41AA 2278FE          16      LD  (H_BINL+2),HL
0001AD 41AD 217546          10      LD  HL,ROM_FILES
0001B0 41B0 227DFE          16      LD  (H_FILE+2),HL
0001B3 41B3 21604F          10      LD  HL,ROM_BDOS
0001B6 41B6 2233F3          16      LD  (H_BDOS+2),HL
0001B9 41B9 21AF43          10      LD  HL,ROM_STKE
0001BC 41BC 22DCFE          16      LD  (H_STKE+2),HL
0001BF 41BF 21834D          10      LD  HL,DISKIO
0001C2 41C2 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001C5 41C5 3E                      DB  03EH
0001C6 41C6 C9              10      RET
0001C7 41C7 327FFE          13      LD  (H_FILE+4),A
0001CA 41CA 3275FE          13      LD  (H_BINS+4),A
0001CD 41CD 327AFE          13      LD  (H_BINL+4),A
0001D0 41D0 3235F3          13      LD  (H_BDOS+4),A
0001D3 41D3 32DEFE          13      LD  (H_STKE+4),A
0001D6 41D6 32ABFF          13      LD  (H_PHYD+4),A
                                
                                #if exists USE_NORMAL_32K_ROM
                                #else
0001D9 41D9 AF               4      XOR A
0001DA 41DA 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001DD 41DD 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0001E0 41E0 3A0060          13      LD  A,(BANK1_ADR)
0001E3 41E3 FE41             7      CP  'A'
0001E5 41E5 2051            12      JR  NZ,NOT_8K_BANK
0001E7 41E7 3E01             7      LD  A,DISK_BANK
0001E9 41E9 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001EC 41EC 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001EF 41EF CD3801          17      CALL    RSLREG      ;read primary slot #
0001F2 41F2 07               4      RLCA
0001F3 41F3 07               4      RLCA
0001F4 41F4 F5              11      PUSH    AF
0001F5 41F5 1605             7      LD  D,4+1
0001F7 41F7 CD5042          17      CALL    GTSL2_
0001FA 41FA 3244F3          13      LD  (RAMAD3),A
0001FD 41FD F1              10      POP AF
0001FE 41FE 07               4      RLCA
0001FF 41FF 07               4      RLCA
000200 4200 1603             7      LD  D,2+1
000202 4202 CD5042          17      CALL    GTSL2_
000205 4205 2680             7      LD  H,080H
000207 4207 CD6D42          17      CALL    CHK_RAM
00020A 420A 3243F3          13      LD  (RAMAD2),A
       420D                     RAMCHK2:
00020D 420D 3A44F3          13      LD  A,(RAMAD3)
000210 4210 2640             7      LD  H,040H
000212 4212 CD6D42          17      CALL    CHK_RAM
000215 4215 3242F3          13      LD  (RAMAD1),A
       4218                     RAMCHK1:
000218 4218 3A44F3          13      LD  A,(RAMAD3)
00021B 421B 2600             7      LD  H,00H
00021D 421D CD6D42          17      CALL    CHK_RAM
000220 4220 3241F3          13      LD  (RAMAD0),A
       4223                     RAMCHK0:
000223 4223 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
000226 4226 010F00          10      LD  BC,0000FH       ;切り上げ
000229 4229 09              11      ADD HL,BC
00022A 422A 7D               4      LD  A,L
                                
00022B 422B 0604             7      LD  B,4
       422D                     B_DRIVE1:
00022D 422D CB3C             8      SRL H
00022F 422F 1F               4      RRA
000230 4230 10FB            13      DJNZ    B_DRIVE1
                                
000232 4232 C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000234 4234 3249F1          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
000237 4237 C9              10      RET
                                
       4238                     NOT_8K_BANK:
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K等)
000238 4238 21FD43          10      LD  HL,MSG_ERROR_ROM_MODE
00023B 423B CD8843          17      CALL    MSX
00023E 423E FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000242 4242 DD219F00        14      LD  IX,CHGET
000246 4246 C31C00          10      JP  _CALSLT
                                
       4249                     GTSL1_:             ;自分のいるスロットを知る
000249 4249 CD3801          17      CALL    RSLREG      ;read primary slot #
00024C 424C 0F               4      RRCA
00024D 424D 0F               4      RRCA
00024E 424E 1601             7      LD  D,1
       4250                     GTSL2_:
000250 4250 E603             7      AND 3       ;[A]=000000PP
000252 4252 5F               4      LD  E,A     ;[E]=000000PP
000253 4253 21C1FC          10      LD  HL,EXPTBL
000256 4256 85               4      ADD A,L     ;桁上りは無い
000257 4257 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000258 4258 7B               4      LD  A,E     ;[A]=000000PP
000259 4259 CB7E            13      BIT 7,(HL)
00025B 425B C8              11      RET Z
00025C 425C 7D               4      LD  A,L     ;point to SLTTBL entry
00025D 425D C604             7      ADD A,4     ;桁上りは無い
00025F 425F 6F               4      LD  L,A
000260 4260 7E               7      LD  A,(HL)      ;get currently expansion slot register
       4261                     GTSL3_:
000261 4261 15               4      DEC D
000262 4262 2803            12      JR  Z,GTSL4_:
000264 4264 0F               4      RRCA
000265 4265 18FA            12      JR  GTSL3_:
       4267                     GTSL4_:
000267 4267 E60C             7      AND 00CH        ;[A] = 0000SS00
000269 4269 B3               4      OR  E       ;[A] = 0000SSPP
00026A 426A F680             7      OR  080H        ;[A] = 1000SSPP
00026C 426C C9              10      RET
                                
       426D                     CHK_RAM:
00026D 426D E5              11      PUSH    HL
00026E 426E CDC242          17      CALL    CHK_RAM0
000271 4271 E1              10      POP HL
000272 4272 C8              11      RET Z
000273 4273 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000276 4276 E680             7      AND 080H
000278 4278 CD9942          17      CALL    CHK_RAM_SLT
00027B 427B C8              11      RET Z
00027C 427C 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
00027F 427F E680             7      AND 080H
000281 4281 C601             7      ADD A,1
000283 4283 CD9942          17      CALL    CHK_RAM_SLT
000286 4286 C8              11      RET Z
000287 4287 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00028A 428A E680             7      AND 080H
00028C 428C C602             7      ADD A,2
00028E 428E CD9942          17      CALL    CHK_RAM_SLT
000291 4291 C8              11      RET Z
000292 4292 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000295 4295 E680             7      AND 080H
000297 4297 C603             7      ADD A,3
       4299                     CHK_RAM_SLT:
000299 4299 E5              11      PUSH    HL
00029A 429A CDC242          17      CALL    CHK_RAM0        ;スロット#X or X-0
00029D 429D E1              10      POP HL
00029E 429E C8              11      RET Z
00029F 429F CB79             8      BIT 7,C
0002A1 42A1 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
0002A3 42A3 79               4      LD  A,C
0002A4 42A4 C604             7      ADD A,4*1           ;スロット#X-1
0002A6 42A6 E5              11      PUSH    HL
0002A7 42A7 CDC242          17      CALL    CHK_RAM0
0002AA 42AA E1              10      POP HL
0002AB 42AB C8              11      RET Z
0002AC 42AC 79               4      LD  A,C
0002AD 42AD C608             7      ADD A,4*2           ;スロット#X-2
0002AF 42AF E5              11      PUSH    HL
0002B0 42B0 CDC242          17      CALL    CHK_RAM0
0002B3 42B3 E1              10      POP HL
0002B4 42B4 C8              11      RET Z
0002B5 42B5 79               4      LD  A,C
0002B6 42B6 C60C             7      ADD A,4*3           ;スロット#X-3
0002B8 42B8 E5              11      PUSH    HL
0002B9 42B9 CDC242          17      CALL    CHK_RAM0
0002BC 42BC E1              10      POP HL
       42BD                     CHK_RAM_E:
0002BD 42BD AF               4      XOR A
0002BE 42BE 3C               4      INC A           ;ZF=0にする
0002BF 42BF 3E00             7      LD  A,0
0002C1 42C1 C9              10      RET
                                
       42C2                     CHK_RAM0:
0002C2 42C2 4F               4      LD  C,A
0002C3 42C3 3A00F1          13      LD  A,(ROM_SLT)
0002C6 42C6 B9               4      CP  C
0002C7 42C7 28F4            12      JR  Z,CHK_RAM_E
0002C9 42C9 2E00             7      LD  L,0
       42CB                     CHK_RAM1:
0002CB 42CB 79               4      LD  A,C
0002CC 42CC DD210C00        14      LD  IX,_RDSLT
0002D0 42D0 CDFD42          17      CALL    CALSLT_R
0002D3 42D3 C6E5             7      ADD A,0E5H
0002D5 42D5 47               4      LD  B,A
0002D6 42D6 5F               4      LD  E,A
0002D7 42D7 79               4      LD  A,C
0002D8 42D8 DD211400        14      LD  IX,_WRSLT
0002DC 42DC CDFD42          17      CALL    CALSLT_R
0002DF 42DF 79               4      LD  A,C
0002E0 42E0 DD210C00        14      LD  IX,_RDSLT
0002E4 42E4 CDFD42          17      CALL    CALSLT_R
0002E7 42E7 B8               4      CP  B
0002E8 42E8 C0              11      RET NZ
0002E9 42E9 D6E5             7      SUB 0E5H
0002EB 42EB 79               4      LD  A,C
0002EC 42EC 5F               4      LD  E,A
0002ED 42ED DD211400        14      LD  IX,_WRSLT
0002F1 42F1 CDFD42          17      CALL    CALSLT_R
0002F4 42F4 24               4      INC H
0002F5 42F5 7D               4      LD  A,L
0002F6 42F6 C604             7      ADD A,4
0002F8 42F8 6F               4      LD  L,A
0002F9 42F9 20D0            12      JR  NZ,CHK_RAM1
0002FB 42FB 79               4      LD  A,C     ;ZF=1のハズ
0002FC 42FC C9              10      RET
                                
       42FD                     CALSLT_R:
0002FD 42FD C5              11      PUSH    BC
0002FE 42FE E5              11      PUSH    HL
0002FF 42FF FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000303 4303 CD1C00          17      CALL    _CALSLT
000306 4306 E1              10      POP HL
000307 4307 C1              10      POP BC
000308 4308 C9              10      RET
                                
       4309                     AT_ISC:
000309 F0E9                         ORG ISC,AT_ISC-RUN
       F0E9                     REPLACE_COMMAND:
000309 F0E9 FEB7             7      CP  0B7H            ;FILES
00030B F0EB CC7BFE          17      CALL    Z,H_FILE
00030E F0EE FEB5             7      CP  0B5H            ;LOAD
000310 F0F0 CA71FE          10      JP  Z,H_BINS
000313 F0F3 FE8A             7      CP  08AH            ;RUN
000315 F0F5 CA76FE          10      JP  Z,H_BINL
000318 F0F8 FED6             7      CP  0D6H            ;COPY
00031A F0FA 2813            12      JR  Z,FIX_COPY
00031C F0FC FECF             7      CP  0CFH            ;BLOAD
00031E F0FE C0              11      RET NZ
       F0FF                     FIX_BLOAD:
00031F F0FF F7              12      RST 30H
       F100                     ROM_SLT:
000320 F100 00                      DB  0
000321 F101 A545                    DW  ROM_BLOAD
000323 F103 F5              11      PUSH    AF
000324 F104 E5              11      PUSH    HL
000325 F105 CD0EF1          17      CALL    BLOAD_RET
       F106                     SWC_BLOAD   EQU $-2
000328 F108 E1              10      POP HL
000329 F109 F1              10      POP AF
00032A F10A FECF             7      CP  0CFH            ;BLOAD
       F10C                     SWC_BLOAD_M:
00032C F10C 28DB            12      JR  Z,REPLACE_COMMAND
       F10E                     BLOAD_RET:
00032E F10E C9              10      RET
       F10F                     FIX_COPY:
00032F F10F F7              12      RST 30H
       F110                     ROM_SLT_COPY:
000330 F110 00                      DB  0
000331 F111 FA46                    DW  ROM_COPY
000333 F113 C9              10      RET
       F114                     ROMUSE1:
000334 F114 3A00F1          13      LD  A,(ROM_SLT)
000337 F117 1803            12      JR  ROMUSE2
       F119                     RAMUSE1:
000339 F119 3A42F3          13      LD  A,(RAMAD1)
       F11C                     ROMUSE2:
00033C F11C C32400          10      JP  _ENASLT
                                
       F11F                     _RESULT:
00033F F11F 00                      DB  0
       F120                     _BANK:
000340 F120 00                      DB  0
       F121                     CLSZ:               ;クラスタサイズ
000341 F121 0004                    DW  1024
       F122                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F123                     SECSZ:              ;セクタサイズ
000343 F123 0002                    DW  512
       F124                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F125                     RR_LOW:
000345 F125 0000                    DW  0
       F126                     RR_MID  EQU $-1
       F127                     RR_HIGH:
000347 F127 0000                    DW  0
       F129                     _CLPS:
000349 F129 0000                    DW  0
       F12B                     _LEFT:
00034B F12B 0000                    DW  0
       F12D                     _DTPS:
00034D F12D 0000                    DW  0
       F12F                     _DTA:
00034F F12F 0000                    DW  0
       F131                     FLG_LDIR:
000351 F131 00                      DB  0
                                
                                ;   BDOS
000352 F132 F7              12      RST 30H
000353 F133 00                      DB  0
000354 F134 604F                    DW  ROM_BDOS
000356 F136 C9              10      RET 
       F137                     _FCB:
000357 F137 0000                    DW  0
       F139                     _BUF:
       F139                     _BUF_LO:        ;LOGICAL OPERATION
000359 F139 00                      DB  0
       F13A                     _BUF_ST:
00035A F13A 0000                    DW  0
       F13C                     _BUF_EN:
00035C F13C 0000                    DW  0
       F13E                     _BUF_EX:
       F13E                     _BUF_W:
00035E F13E 0000                    DW  0
       F140                     _BUF_H:
000360 F140 0000                    DW  0
       F142                     _BUF_X:
000362 F142 0000                    DW  0
       F144                     _BUF_Y:
000364 F144 00                      DB  0
       F145                     _BUF_P:
000365 F145 00                      DB  0
       F146                     _BUF_O:
000366 F146 00                      DB  0
       F147                     DTAX:
000367 F147 0000                    DW  0
       F149                     B_DRIVE:
000369 F149 00                      DB  0
       F14A                     _DVSW:
00036A F14A 00                      DB  0
       F14B                     FCBX:
00036B F14B 0000                    DW  0
       F14D                     LEFTX:
00036D F14D 0000                    DW  0
       F14F                     PARAM0:
00036F F14F 0000                    DW  0
       F151                     PARAM1:
000371 F151 0000                    DW  0
       F153                     FDRV:
000373 F153 00                      DB  0
       F154                     FNAME:
000374 F154                         DS  8+3
                                
       F15F                     BASSTK:
00037F F15F 0000                    DW  0
       F161                     _HL:
000381 F161 0000                    DW  0
       F163                     _SP:
000383 F163 0000                    DW  0
                                
       F165                     ISC_E:
000385 4385                         ORG $$+RUN          ;$DEPHASE
                                
       4385                     MSX1:
000385 4385 CD794F          17      CALL    MSGA1
       4388                     MSX:
000388 4388 7E               7      LD  A,(HL)
000389 4389 23               6      INC HL
00038A 438A B7               4      OR  A
00038B 438B 20F8            12      JR  NZ,MSX1
00038D 438D C9              10      RET
                                
       438E                     PRTHX:
00038E 438E F5              11      PUSH    AF
00038F 438F 07               4      RLCA
000390 4390 07               4      RLCA
000391 4391 07               4      RLCA
000392 4392 07               4      RLCA
000393 4393 CD9743          17      CALL    PRTA2
000396 4396 F1              10      POP AF
       4397                     PRTA2:
000397 4397 CD9D43          17      CALL    ASC
00039A 439A C3754F          10      JP  MSG_A
                                    
       439D                     ASC:
00039D 439D E60F             7      AND $0F
00039F 439F F630             7      OR  $30
0003A1 43A1 FE3A             7      CP  $3A
0003A3 43A3 D8              11      RET C
0003A4 43A4 C607             7      ADD A,7
0003A6 43A6 C9              10      RET
                                
       43A7                     MSN:
0003A7 43A7 7E               7      LD  A,(HL)
0003A8 43A8 23               6      INC HL
0003A9 43A9 CD754F          17      CALL    MSG_A
0003AC 43AC 10F9            13      DJNZ    MSN
0003AE 43AE C9              10      RET
                                
       43AF                     ROM_STKE:
0003AF 43AF 3E                      DB  03EH
0003B0 43B0 C9              10      RET
0003B1 43B1 32DAFE          13      LD  (H_STKE),A
0003B4 43B4 E5              11      PUSH    HL
0003B5 43B5 D5              11      PUSH    DE
0003B6 43B6 C5              11      PUSH    BC
0003B7 43B7 181D            12      JR  BASAUTO
                                
0003B9 43B9 AF               4      XOR A
0003BA 43BA 5F               4      LD  E,A
0003BB 43BB 57               4      LD  D,A
0003BC 43BC 0601             7      LD  B,1
0003BE 43BE 2100C0          10      LD  HL,0C000H
0003C1 43C1 CD834D          17      CALL    DISKIO
                                
0003C4 43C4 ED735FF1        20      LD  (BASSTK),SP
0003C8 43C8 116BF3          10      LD  DE,RAMUSE
0003CB 43CB AF               4      XOR A
0003CC 43CC CD1EC0          17      CALL    0C01EH
0003CF 43CF 116BF3          10      LD  DE,RAMUSE
0003D2 43D2 37               4      SCF
0003D3 43D3 CD1EC0          17      CALL    0C01EH
       43D6                     BASAUTO:
0003D6 43D6 212344          10      LD  HL,AUTOEXEC
0003D9 43D9 1153F1          10      LD  DE,FDRV
0003DC 43DC 010C00          10      LD  BC,1+8+3
0003DF 43DF EDB0                    LDIR
0003E1 43E1 CDF94A          17      CALL    ROM_OPEN
0003E4 43E4 3813            12      JR  C,RSTKEE
0003E6 43E6 212F44          10      LD  HL,RUN_AUTOEXEC
0003E9 43E9 11F0FB          10      LD  DE,KEYBUF
0003EC 43EC ED53FAF3        20      LD  (GETPNT),DE
0003F0 43F0 011300          10      LD  BC,RUN_AUTOEXEC_E-RUN_AUTOEXEC
0003F3 43F3 EDB0                    LDIR
0003F5 43F5 ED53F8F3        20      LD  (PUTPNT),DE
       43F9                     RSTKEE:
0003F9 43F9 C1              10      POP BC
0003FA 43FA D1              10      POP DE
0003FB 43FB E1              10      POP HL
0003FC 43FC C9              10      RET
                                
       43FD                     MSG_ERROR_ROM_MODE:
0003FD 43FD 41534349492D384B        DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
            2F4B6F6E616D692D    
            384B2F4B6F6E616D    
            692D534343206F6E    
            6C79210D0A          
       4422                     NULL:
000422 4422 00                      DB  0
                                
       4423                     AUTOEXEC:
000423 4423 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       442F                     RUN_AUTOEXEC:
00042F 442F 52554E2022415554        DB  'RUN "AUTOEXEC.BAS"',00DH
            4F455845432E4241    
            53220D              
                                ;   DB  'LOAD "AUTOEXEC.BAS"',00DH  ;テスト用
       4442                     RUN_AUTOEXEC_E:
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       4442                     ROM_LDIR:
000442 4442 3A31F1          13      LD  A,(FLG_LDIR)
000445 4445 B7               4      OR  A
000446 4446 2008            12      JR  NZ,ROM_LDIRVM
000448 4448 CB7A             8      BIT 7,D
00044A 444A CA6244          10      JP  Z,ROM_LDIRSLT
                                
                                #if exists USE_NORMAL_32K_ROM
                                    LD  (_SP),SP
                                    LD  SP,DRVTBL
                                LDIR1:
                                    LD  A,B
                                    OR  C
                                    JR  Z,LDIRE
                                
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                LDIR2:
                                    LD  A,D
                                    CP  0C0H
                                    JR  NC,LDIR4
                                
                                    PUSH    BC
                                    PUSH    DE
                                    LD  DE,BUF
                                
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIR3
                                    LD  BC,00100H
                                LDIR3:
                                    PUSH    BC
                                    LDIR
                                    LD  (_HL),HL
                                
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                
                                    LD  HL,BUF
                                    POP BC
                                    POP DE
                                    LDIR
                                
                                    LD  HL,(_HL)
                                    POP BC
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIRE
                                    DEC B
                                    JR  LDIR1
                                LDIR4:
                                #endif
00044D 444D EDB0                    LDIR
                                
                                #if exists USE_NORMAL_32K_ROM
                                LDIRE:
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    LD  SP,(_SP)
                                #endif
00044F 444F C9              10      RET
                                
       4450                     ROM_LDIRVM:
                                #if exists USE_NORMAL_32K_ROM
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
000450 4450 C5              11      PUSH    BC
000451 4451 D5              11      PUSH    DE
000452 4452 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000456 4456 DD215C00        14      LD  IX,LDIRVM
00045A 445A CD1C00          17      CALL    _CALSLT
                                #if exists USE_NORMAL_32K_ROM
                                    LD  H,080H
                                    LD  A,(RAMAD2)
                                    CALL    _ENASLT
                                #endif
00045D 445D E1              10      POP HL
00045E 445E C1              10      POP BC
00045F 445F 09              11      ADD HL,BC
000460 4460 EB               4      EX  DE,HL
000461 4461 C9              10      RET
                                
       4462                     ROM_LDIRSLT:
000462 4462 EB               4      EX  DE,HL
       4463                     RLDIRSLT1:
000463 4463 1A               7      LD  A,(DE)
000464 4464 13               6      INC DE
000465 4465 C5              11      PUSH    BC
000466 4466 D5              11      PUSH    DE
000467 4467 E5              11      PUSH    HL
000468 4468 5F               4      LD  E,A
000469 4469 3A42F3          13      LD  A,(RAMAD1)
00046C 446C FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000470 4470 DD211400        14      LD  IX,_WRSLT
000474 4474 CD1C00          17      CALL    _CALSLT
000477 4477 E1              10      POP HL
000478 4478 D1              10      POP DE
000479 4479 C1              10      POP BC
00047A 447A EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00047C 447C EA6344          10      JP  PE,RLDIRSLT1
00047F 447F EB               4      EX  DE,HL
000480 4480 C9              10      RET
                                
       4481                     END_OF_LINE:
000481 4481 215EF5          10      LD  HL,BUF
       4484                     EOL1:
000484 4484 7E               7      LD  A,(HL)
000485 4485 C8              11      RET Z
000486 4486 FE0D             7      CP  00DH
000488 4488 2807            12      JR  Z,EOLE
00048A 448A FE0A             7      CP  00AH
00048C 448C 2803            12      JR  Z,EOLE
00048E 448E 23               6      INC HL
00048F 448F 18F3            12      JR  EOL1
       4491                     EOLE:
000491 4491 3600            10      LD  (HL),0
000493 4493 23               6      INC HL
000494 4494 7E               7      LD  A,(HL)
000495 4495 FE0A             7      CP  00AH
000497 4497 C0              11      RET NZ
000498 4498 23               6      INC HL
000499 4499 C9              10      RET
                                
       449A                     ROM_LOAD_ASCII:
00049A 449A 210000          10      LD  HL,0
00049D 449D 223AF1          16      LD  (_BUF_ST),HL    ;読み出し位置
0004A0 44A0 2A76F6          16      LD  HL,(TXTTAB)
0004A3 44A3 223CF1          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
0004A6 44A6 215EF5          10      LD  HL,BUF
0004A9 44A9 222FF1          16      LD  (_DTA),HL
       44AC                     RLOAD_A1:
0004AC 44AC 2A3AF1          16      LD  HL,(_BUF_ST)
0004AF 44AF 2225F1          16      LD  (RR_LOW),HL
0004B2 44B2 210201          10      LD  HL,258
0004B5 44B5 CD1549          17      CALL    ROM_READ
0004B8 44B8 7C               4      LD  A,H
0004B9 44B9 B5               4      OR  L
0004BA 44BA 2877            12      JR  Z,RLOAD_AEND
0004BC 44BC 015EF5          10      LD  BC,BUF
0004BF 44BF 09              11      ADD HL,BC
0004C0 44C0 3600            10      LD  (HL),0
0004C2 44C2 CD8144          17      CALL    END_OF_LINE
0004C5 44C5 015EF5          10      LD  BC,BUF
0004C8 44C8 A7               4      AND A
0004C9 44C9 ED42            15      SBC HL,BC
0004CB 44CB 2810            12      JR  Z,RLOAD_A2
0004CD 44CD 4D               4      LD  C,L
0004CE 44CE 44               4      LD  B,H
0004CF 44CF ED5B3AF1        20      LD  DE,(_BUF_ST)
0004D3 44D3 19              11      ADD HL,DE
0004D4 44D4 223AF1          16      LD  (_BUF_ST),HL
0004D7 44D7 3A5EF5          13      LD  A,(BUF)
0004DA 44DA B7               4      OR  A
0004DB 44DB 28CF            12      JR  Z,RLOAD_A1
       44DD                     RLOAD_A2:
0004DD 44DD 115EF5          10      LD  DE,BUF
0004E0 44E0 CD8C4A          17      CALL    SPCUTEX
0004E3 44E3 1A               7      LD  A,(DE)
0004E4 44E4 B7               4      OR  A
0004E5 44E5 284C            12      JR  Z,RLOAD_AEND
0004E7 44E7 CD9E4A          17      CALL    GETNUM
0004EA 44EA 7C               4      LD  A,H
0004EB 44EB B5               4      OR  L
0004EC 44EC CA9245          10      JP  Z,ERROR_DIRECT_IN_FILE
0004EF 44EF DD2A3CF1        20      LD  IX,(_BUF_EN)
0004F3 44F3 DD7502          19      LD  (IX+2),L
0004F6 44F6 DD7403          19      LD  (IX+3),H
                                
0004F9 44F9 CD854A          17      CALL    SPCUT
0004FC 44FC EB               4      EX  DE,HL
0004FD 44FD DDE5            15      PUSH    IX
0004FF 44FF DD21B242        14      LD  IX,CRUNCH
000503 4503 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000507 4507 CD1C00          17      CALL    _CALSLT
00050A 450A DDE1            14      POP IX
00050C 450C EB               4      EX  DE,HL
00050D 450D 111FF4          10      LD  DE,KBUF
000510 4510 37               4      SCF
000511 4511 ED52            15      SBC HL,DE
000513 4513 287D            12      JR  Z,ERROR_DIRECT_IN_FILE
000515 4515 387B            12      JR  C,ERROR_DIRECT_IN_FILE
000517 4517 4D               4      LD  C,L
000518 4518 44               4      LD  B,H
000519 4519 2A3CF1          16      LD  HL,(_BUF_EN)
00051C 451C 110400          10      LD  DE,4
00051F 451F 19              11      ADD HL,DE
000520 4520 111FF4          10      LD  DE,KBUF
                                
000523 4523 EB               4      EX  DE,HL
000524 4524 EDB0                    LDIR
000526 4526 EB               4      EX  DE,HL
                                
000527 4527 DD7500          19      LD  (IX+0),L
00052A 452A DD7401          19      LD  (IX+1),H
00052D 452D 223CF1          16      LD  (_BUF_EN),HL
000530 4530 C3AC44          10      JP  RLOAD_A1
                                
       4533                     RLOAD_AEND:
000533 4533 2A3CF1          16      LD  HL,(_BUF_EN)
000536 4536 AF               4      XOR A
000537 4537 77               7      LD  (HL),A
000538 4538 23               6      INC HL
000539 4539 77               7      LD  (HL),A
00053A 453A 23               6      INC HL
00053B 453B 223CF1          16      LD  (_BUF_EN),HL
00053E 453E 183B            12      JR  RLOAD_END1
                                
       4540                     ROM_LOAD:
000540 4540 CDCB46          17      CALL    INIT_PARAM
000543 4543 CDB549          17      CALL    FILE_B
000546 4546 3A54F1          13      LD  A,(FNAME)
000549 4549 FE20             7      CP  020H
00054B 454B CAB049          10      JP  Z,ROM_ORG
                                
00054E 454E CDF94A          17      CALL    ROM_OPEN
000551 4551 3845            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000553 4553 2139F1          10      LD  HL,_BUF
000556 4556 222FF1          16      LD  (_DTA),HL
000559 4559 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
00055C 455C CD1549          17      CALL    ROM_READ
00055F 455F 3A39F1          13      LD  A,(_BUF)
000562 4562 3C               4      INC A
000563 4563 C29A44          10      JP  NZ,ROM_LOAD_ASCII
000566 4566 2A76F6          16      LD  HL,(TXTTAB)
000569 4569 222FF1          16      LD  (_DTA),HL
00056C 456C EB               4      EX  DE,HL
00056D 456D 2100FF          10      LD  HL,-256
000570 4570 39              11      ADD HL,SP
000571 4571 ED52            15      SBC HL,DE
000573 4573 CD1549          17      CALL    ROM_READ
000576 4576 ED5B2FF1        20      LD  DE,(_DTA)
00057A 457A 19              11      ADD HL,DE
       457B                     RLOAD_END1:
00057B 457B 22C2F6          16      LD  (VARTAB),HL
00057E 457E 22C4F6          16      LD  (ARYTAB),HL
000581 4581 22C6F6          16      LD  (STREND),HL
                                
000584 4584 AF               4      XOR A
000585 4585 213CF1          10      LD  HL,_BUF+3
000588 4588 77               7      LD  (HL),A
000589 4589 2B               6      DEC HL
00058A 458A 77               7      LD  (HL),A
00058B 458B 2B               6      DEC HL
00058C 458C 77               7      LD  (HL),A
00058D 458D 2B               6      DEC HL
00058E 458E 3E8F             7      LD  A,08FH          ;REM
000590 4590 77               7      LD  (HL),A
000591 4591 C9              10      RET
                                
       4592                     ERROR_DIRECT_IN_FILE:
000592 4592 1E39             7      LD  E,57            ;Direct statement in file
000594 4594 01                      DB  1           ;LD BC,
       4595                     ERROR_FILE_NOT_OPEN:
000595 4595 1E3B             7      LD  E,59            ;File not OPEN
000597 4597 01                      DB  1           ;LD BC,
       4598                     ERROR_FILE_NOT_FOUND:
000598 4598 1E35             7      LD  E,53            ;File not found
       459A                     ERROR:
00059A 459A FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00059E 459E DD216F40        14      LD  IX,ERRHAND
0005A2 45A2 C31C00          10      JP  _CALSLT
                                
       45A5                     ROM_BLOAD:
0005A5 45A5 CDCB46          17      CALL    INIT_PARAM
0005A8 45A8 CDB549          17      CALL    FILE_B
0005AB 45AB CDF94A          17      CALL    ROM_OPEN
0005AE 45AE 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
0005B0 45B0 2139F1          10      LD  HL,_BUF
0005B3 45B3 222FF1          16      LD  (_DTA),HL
0005B6 45B6 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
0005B9 45B9 CD1549          17      CALL    ROM_READ
0005BC 45BC 3A39F1          13      LD  A,(_BUF)
0005BF 45BF FEFE             7      CP  0FEH
0005C1 45C1 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
0005C3 45C3 210EF1          10      LD  HL,BLOAD_RET
0005C6 45C6 2206F1          16      LD  (SWC_BLOAD),HL
                                
0005C9 45C9 2A51F1          16      LD  HL,(PARAM1)
0005CC 45CC 7E               7      LD  A,(HL)
0005CD 45CD FE2C             7      CP  ','
0005CF 45CF 2048            12      JR  NZ,RBREAD_MEM
0005D1 45D1 23               6      INC HL
0005D2 45D2 7E               7      LD  A,(HL)
0005D3 45D3 CDE34A          17      CALL    CAP
0005D6 45D6 32BEFC          13      LD  (RUNBNF),A
       45D9                     RBOS1:
0005D9 45D9 7E               7      LD  A,(HL)
0005DA 45DA 23               6      INC HL
0005DB 45DB B7               4      OR  A
0005DC 45DC 282F            12      JR  Z,RBREAD_OSE
0005DE 45DE FE3A             7      CP  ':'
0005E0 45E0 282B            12      JR  Z,RBREAD_OSE
0005E2 45E2 FE2C             7      CP  ','     ;次のパラメータを探す
0005E4 45E4 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
0005E6 45E6 2251F1          16      LD  (PARAM1),HL
0005E9 45E9 7E               7      LD  A,(HL)
0005EA 45EA B7               4      OR  A
0005EB 45EB 2820            12      JR  Z,RBREAD_OSE
0005ED 45ED DD21644C        14      LD  IX,FRMEVL
0005F1 45F1 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0005F5 45F5 CD1C00          17      CALL    _CALSLT
0005F8 45F8 2251F1          16      LD  (PARAM1),HL
0005FB 45FB 3A63F6          13      LD  A,(VALTYP)
0005FE 45FE FE02             7      CP  2
000600 4600 200B            12      JR  NZ,RBREAD_OSE
000602 4602 2A3AF1          16      LD  HL,(_BUF_ST)
000605 4605 ED5BF8F7        20      LD  DE,(DACDAT)
000609 4609 19              11      ADD HL,DE
00060A 460A 223AF1          16      LD  (_BUF_ST),HL
       460D                     RBREAD_OSE:
00060D 460D 3ABEFC          13      LD  A,(RUNBNF)
000610 4610 FE53             7      CP  'S'
000612 4612 2005            12      JR  NZ,RBREAD_MEM
000614 4614 3E01             7      LD  A,1
000616 4616 3231F1          13      LD  (FLG_LDIR),A
       4619                     RBREAD_MEM:
000619 4619 2A3AF1          16      LD  HL,(_BUF_ST)
00061C 461C 22BFFC          16      LD  (SAVENT),HL
00061F 461F 222FF1          16      LD  (_DTA),HL
000622 4622 21FFFF          10      LD  HL,0FFFFH
000625 4625 CD1549          17      CALL    ROM_READ
000628 4628 3ABEFC          13      LD  A,(RUNBNF)
00062B 462B FE52             7      CP  'R'
00062D 462D 2006            12      JR  NZ,RBREAD1
00062F 462F 2A3EF1          16      LD  HL,(_BUF_EX)
000632 4632 2206F1          16      LD  (SWC_BLOAD),HL
       4635                     RBREAD1:
       4635                     ROM_NEXT:
000635 4635 2A51F1          16      LD  HL,(PARAM1)
000638 4638 7E               7      LD  A,(HL)
000639 4639 2B               6      DEC HL
00063A 463A B7               4      OR  A
00063B 463B 2805            12      JR  Z,RN1
00063D 463D FE3A             7      CP  ':'
00063F 463F 2801            12      JR  Z,RN1
000641 4641 23               6      INC HL
       4642                     RN1:
000642 4642 5D               4      LD  E,L
000643 4643 54               4      LD  D,H
                                
000644 4644 CDB54A          17      CALL    SEARCH_END
000647 4647 B7               4      OR  A
000648 4648 281A            12      JR  Z,REM
                                                    ;マルチステートメントの処理
00064A 464A 7E               7      LD  A,(HL)
                                
00064B 464B FEB5             7      CP  0B5H            ;LOAD
00064D 464D CA4045          10      JP  Z,ROM_LOAD
000650 4650 FE8A             7      CP  08AH            ;RUN
000652 4652 2814            12      JR  Z,ROM_RUN
000654 4654 FEB7             7      CP  0B7H            ;FILES
000656 4656 281D            12      JR  Z,ROM_FILES
000658 4658 FED6             7      CP  0D6H            ;COPY
00065A 465A CAFA46          10      JP  Z,ROM_COPY
00065D 465D 3E28             7      LD  A,028H          ;JR Z,
00065F 465F 320CF1          13      LD  (SWC_BLOAD_M),A
000662 4662 7E               7      LD  A,(HL)
000663 4663 C9              10      RET
                                
       4664                     REM:
000664 4664 EB               4      EX  DE,HL
000665 4665 3E8F             7      LD  A,08FH          ;REM
000667 4667 C9              10      RET
                                
       4668                     ROM_RUN:
000668 4668 23               6      INC HL
000669 4669 7E               7      LD  A,(HL)
00066A 466A 2B               6      DEC HL
00066B 466B B7               4      OR  A
00066C 466C 2803            12      JR  Z,ROM_RUN1
00066E 466E CD4045          17      CALL    ROM_LOAD
       4671                     ROM_RUN1:
000671 4671 3E8A             7      LD  A,08AH          ;RUN
000673 4673 77               7      LD  (HL),A
000674 4674 C9              10      RET
                                
       4675                     ROM_FILES:
000675 4675 CDCB46          17      CALL    INIT_PARAM
000678 4678 CDB549          17      CALL    FILE_B
00067B 467B CD184F          17      CALL    GET_DISK_BANK_FDRV
00067E 467E 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000681 4681 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000684 4684 3A54F1          13      LD  A,(FNAME)
000687 4687 FE21             7      CP  021H
000689 4689 3005            12      JR  NC,RFILES0
00068B 468B 060B             7      LD  B,11
00068D 468D CD494A          17      CALL    FILE10
       4690                     RFILES0:
000690 4690 CD414D          17      CALL    GET_DIR_DAT
       4693                     RFILES1:
000693 4693 CD154B          17      CALL    FILESE
000696 4696 302E            12      JR  NC,RFILES_NOT_MATCH
       4698                     RFILES_DISP:
000698 4698 E5              11      PUSH    HL
000699 4699 0608             7      LD  B,8
00069B 469B CDA743          17      CALL    MSN
00069E 469E 3E2E             7      LD  A,'.'
0006A0 46A0 CD754F          17      CALL    MSG_A
0006A3 46A3 0603             7      LD  B,3
0006A5 46A5 CDA743          17      CALL    MSN
0006A8 46A8 3ADDF3          13      LD  A,(CSRX)
0006AB 46AB 47               4      LD  B,A
0006AC 46AC 3AB0F3          13      LD  A,(LINLEN)
0006AF 46AF 90               4      SUB B
0006B0 46B0 FE0C             7      CP  12
0006B2 46B2 3009            12      JR  NC,RFILES2
0006B4 46B4 3E0D             7      LD  A,00DH      ;改行
0006B6 46B6 CD754F          17      CALL    MSG_A
0006B9 46B9 3E0A             7      LD  A,00AH
0006BB 46BB 1802            12      JR  RFILES3
       46BD                     RFILES2:
0006BD 46BD 3E20             7      LD  A,020H
       46BF                     RFILES3:
0006BF 46BF CD754F          17      CALL    MSG_A
0006C2 46C2 E1              10      POP HL
0006C3 46C3 CD314B          17      CALL    FNEXT
       46C6                     RFILES_NOT_MATCH:
0006C6 46C6 20CB            12      JR  NZ,RFILES1
0006C8 46C8 C33546          10      JP  ROM_NEXT
                                
       46CB                     INIT_PARAM:
0006CB 46CB 224FF1          16      LD  (PARAM0),HL
0006CE 46CE 2251F1          16      LD  (PARAM1),HL
0006D1 46D1 EB               4      EX  DE,HL
0006D2 46D2 AF               4      XOR A
0006D3 46D3 3231F1          13      LD  (FLG_LDIR),A
0006D6 46D6 32BEFC          13      LD  (RUNBNF),A
0006D9 46D9 3263F6          13      LD  (VALTYP),A
0006DC 46DC 13               6      INC DE
0006DD 46DD CD854A          17      CALL    SPCUT
0006E0 46E0 1A               7      LD  A,(DE)
0006E1 46E1 B7               4      OR  A
0006E2 46E2 C8              11      RET Z
0006E3 46E3 FE3A             7      CP  ':'
0006E5 46E5 C8              11      RET Z
0006E6 46E6 FE28             7      CP  '('
0006E8 46E8 C8              11      RET Z
0006E9 46E9 EB               4      EX  DE,HL
0006EA 46EA DD21644C        14      LD  IX,FRMEVL
0006EE 46EE FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0006F2 46F2 CD1C00          17      CALL    _CALSLT
0006F5 46F5 2251F1          16      LD  (PARAM1),HL
0006F8 46F8 C9              10      RET
                                
0006F9 46F9 00               4      NOP
       46FA                     ROM_COPY:
0006FA 46FA CDCB46          17      CALL    INIT_PARAM
0006FD 46FD 3A63F6          13      LD  A,(VALTYP)
000700 4700 FE03             7      CP  3       ;string
000702 4702 C2B049          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
000705 4705 CDB549          17      CALL    FILE_B
000708 4708 CDF94A          17      CALL    ROM_OPEN
00070B 470B DA9845          10      JP  C,ERROR_FILE_NOT_FOUND
                                
00070E 470E 213EF1          10      LD  HL,_BUF_W
000711 4711 222FF1          16      LD  (_DTA),HL
000714 4714 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
000717 4717 CD1549          17      CALL    ROM_READ
                                
00071A 471A AF               4      XOR A
00071B 471B 3239F1          13      LD  (_BUF_LO),A     ;PSET
00071E 471E 3246F1          13      LD  (_BUF_O),A      ;向き
                                
000721 4721 2A51F1          16      LD  HL,(PARAM1)
       4724                     RCP_PARAM1:
000724 4724 7E               7      LD  A,(HL)
000725 4725 23               6      INC HL
000726 4726 B7               4      OR  A
000727 4727 CAB049          10      JP  Z,ROM_ORG
00072A 472A FE3A             7      CP  ':'
00072C 472C CAB049          10      JP  Z,ROM_ORG
00072F 472F FE2C             7      CP  ','
000731 4731 2012            12      JR  NZ,RCP_PARAM1_
                                
000733 4733 DD212F54        14      LD  IX,FRMQNT
000737 4737 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00073B 473B CD1C00          17      CALL    _CALSLT
00073E 473E 7B               4      LD  A,E
00073F 473F 87               4      ADD A,A
000740 4740 87               4      ADD A,A
000741 4741 3246F1          13      LD  (_BUF_O),A
000744 4744 7E               7      LD  A,(HL)
       4745                     RCP_PARAM1_:
000745 4745 FE28             7      CP  '('
000747 4747 20DB            12      JR  NZ,RCP_PARAM1
                                
000749 4749 DD212F54        14      LD  IX,FRMQNT
00074D 474D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000751 4751 CD1C00          17      CALL    _CALSLT
                                
000754 4754 ED5342F1        20      LD  (_BUF_X),DE
                                
       4758                     RCP_PARAM2:
000758 4758 23               6      INC HL
000759 4759 7E               7      LD  A,(HL)
00075A 475A FE20             7      CP  020H
00075C 475C 28FA            12      JR  Z,RCP_PARAM2
00075E 475E FE2C             7      CP  ','
000760 4760 28F6            12      JR  Z,RCP_PARAM2
                                
000762 4762 DD212F54        14      LD  IX,FRMQNT
000766 4766 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00076A 476A CD1C00          17      CALL    _CALSLT
                                
00076D 476D ED5344F1        20      LD  (_BUF_Y),DE
       4771                     RCP_PARAM3:
000771 4771 23               6      INC HL
000772 4772 7E               7      LD  A,(HL)
000773 4773 FE20             7      CP  020H
000775 4775 28FA            12      JR  Z,RCP_PARAM3
000777 4777 FE29             7      CP  ')'
000779 4779 28F6            12      JR  Z,RCP_PARAM3
00077B 477B FE2C             7      CP  ','
00077D 477D 2033            12      JR  NZ,RCP_ST
                                
00077F 477F 23               6      INC HL
000780 4780 DD212F54        14      LD  IX,FRMQNT
000784 4784 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000788 4788 CD1C00          17      CALL    _CALSLT
                                
00078B 478B 7B               4      LD  A,E
00078C 478C 3245F1          13      LD  (_BUF_P),A
                                
       478F                     RCP_PARAM4:
00078F 478F 7E               7      LD  A,(HL)
000790 4790 23               6      INC HL
000791 4791 FE20             7      CP  020H
000793 4793 28FA            12      JR  Z,RCP_PARAM4
                                
000795 4795 FE2C             7      CP  ','
000797 4797 2019            12      JR  NZ,RCP_ST
                                
000799 4799 7E               7      LD  A,(HL)
00079A 479A 0604             7      LD  B,4
00079C 479C FEC3             7      CP  0C3H        ;PRESET
00079E 479E 280E            12      JR  Z,RCP_LO
0007A0 47A0 05               4      DEC B       ;3
0007A1 47A1 D6F8             7      SUB 0F8H        ;XOR
0007A3 47A3 2809            12      JR  Z,RCP_LO
0007A5 47A5 05               4      DEC B       ;2
0007A6 47A6 3C               4      INC A       ;OR
0007A7 47A7 2805            12      JR  Z,RCP_LO
0007A9 47A9 05               4      DEC B       ;1
0007AA 47AA 3C               4      INC A       ;AND
0007AB 47AB 2801            12      JR  Z,RCP_LO
0007AD 47AD 05               4      DEC B       ;0
                                                ;PSET
       47AE                     RCP_LO:
0007AE 47AE 78               4      LD  A,B
0007AF 47AF 3239F1          13      LD  (_BUF_LO),A
       47B2                     RCP_ST:
0007B2 47B2 2AC6F6          16      LD  HL,(STREND)
0007B5 47B5 222FF1          16      LD  (_DTA),HL
0007B8 47B8 EB               4      EX  DE,HL
0007B9 47B9 2100FE          10      LD  HL,-512
0007BC 47BC 39              11      ADD HL,SP
0007BD 47BD AF               4      XOR A
0007BE 47BE ED52            15      SBC HL,DE
0007C0 47C0 3008            12      JR  NC,RCP0
0007C2 47C2 215EF5          10      LD  HL,BUF
0007C5 47C5 222FF1          16      LD  (_DTA),HL
0007C8 47C8 6F               4      LD  L,A ;0
0007C9 47C9 67               4      LD  H,A ;0
       47CA                     RCP0:
0007CA 47CA 24               4      INC H
0007CB 47CB 223CF1          16      LD  (_BUF_EN),HL
       47CE                     RCP1:
0007CE 47CE F3               4      DI
0007CF 47CF CDA348          17      CALL    WAIT_VDP
                                
0007D2 47D2 3A0700          13      LD  A,(WRVDP)
0007D5 47D5 4F               4      LD  C,A
0007D6 47D6 0C               4      INC C       ;C := PORT#1's address(WR)
0007D7 47D7 3E24             7      LD  A,36
0007D9 47D9 ED79            12      OUT (C),A
0007DB 47DB 3E91             7      LD  A,080H+17
0007DD 47DD ED79            12      OUT (C),A       ;R#17 := 36
                                
0007DF 47DF 0C               4      INC C
0007E0 47E0 0C               4      INC C       ;C := PORT#3's address(WR)
0007E1 47E1 2A42F1          16      LD  HL,(_BUF_X)
0007E4 47E4 ED69            12      OUT (C),L       ;R#36 DX
0007E6 47E6 ED61            12      OUT (C),H       ;R#37
0007E8 47E8 2A44F1          16      LD  HL,(_BUF_Y)
0007EB 47EB ED69            12      OUT (C),L       ;R#38 DY
0007ED 47ED ED61            12      OUT (C),H       ;R#39
0007EF 47EF 2A3EF1          16      LD  HL,(_BUF_W)
0007F2 47F2 ED69            12      OUT (C),L       ;R#40 NX
0007F4 47F4 ED61            12      OUT (C),H       ;R#41
0007F6 47F6 2A40F1          16      LD  HL,(_BUF_H)
0007F9 47F9 ED69            12      OUT (C),L       ;R#42 NY
0007FB 47FB ED61            12      OUT (C),H       ;R#43
                                
0007FD 47FD DD2AAFFC        20      LD  IX,(SCRMOD)
000801 4801 3A39F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000804 4804 B7               4      OR  A
000805 4805 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000807 4807 DD7D             9      LD  A,IXL
000809 4809 FE08             7      CP  8
00080B 480B 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
00080D 480D FE06             7      CP  6
00080F 480F 2A42F1          16      LD  HL,(_BUF_X)
000812 4812 3A3EF1          13      LD  A,(_BUF_W)
000815 4815 2005            12      JR  NZ,SCR57
000817 4817 B5               4      OR  L       ;スクリーン6
000818 4818 E603             7      AND 3
00081A 481A 200D            12      JR  NZ,USE_LMMC
       481C                     SCR57:              ;スクリーン5,7
00081C 481C B5               4      OR  L
00081D 481D E601             7      AND 1
00081F 481F 2008            12      JR  NZ,USE_LMMC
       4821                     USE_HMMC:
000821 4821 DD2E08          10      LD  IXL,8
       4824                     USE_HMMC8:
000824 4824 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
000826 4826 3239F1          13      LD  (_BUF_LO),A
       4829                     USE_LMMC:
000829 4829 110000          10      LD  DE,0
00082C 482C 06FF             7      LD  B,-1
00082E 482E CDCE48          17      CALL    GET_PIXEL
000831 4831 ED79            12      OUT (C),A       ;R#44 first DATA
000833 4833 3A46F1          13      LD  A,(_BUF_O)
000836 4836 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
000838 4838 3A39F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00083B 483B F6B0             7      OR  0B0H        ;R#46 LMMC command
00083D 483D ED79            12      OUT (C),A
                                
00083F 483F FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
000841 4841 0D               4      DEC C
000842 4842 0D               4      DEC C       ;C := PORT#1's address(WR)
000843 4843 3EAC             7      LD  A,080H+44
000845 4845 ED79            12      OUT (C),A
000847 4847 3E91             7      LD  A,080H+17
000849 4849 ED79            12      OUT (C),A       ;R#17 := 44
                                
00084B 484B 3A0600          13      LD  A,(RDVDP)
00084E 484E 3C               4      INC A
00084F 484F FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
000851 4851 3E02             7      LD  A,2
000853 4853 ED79            12      OUT (C),A
000855 4855 3E8F             7      LD  A,08FH
000857 4857 ED79            12      OUT (C),A
000859 4859 3A39F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00085C 485C E640             7      AND 040H
00085E 485E 201C            12      JR  NZ,LOOP_HMMC
       4860                     LOOP_COPY:
000860 4860 CDCE48          17      CALL    GET_PIXEL
000863 4863 08               4      EX  AF,AF'
000864 4864 FD4C             9      LD  C,IYH
       4866                     LOOP_COPY1:
000866 4866 ED78            12      IN  A,(C)
000868 4868 0F               4      RRCA            ;RRCAではサインフラグは変化しない
000869 4869 300A            12      JR  NC,EXIT_COPY    ;check CE bit
00086B 486B F26648          10      JP  P,LOOP_COPY1    ;check TR bit
00086E 486E 08               4      EX  AF,AF'
00086F 486F FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000871 4871 ED79            12      OUT (C),A
000873 4873 18EB            12      JR  LOOP_COPY
                                
       4875                     EXIT_COPY:
000875 4875 CDAB48          17      CALL    GET_STATUS_0
000878 4878 FB               4      EI
000879 4879 C33546          10      JP  ROM_NEXT
                                
       487C                     LOOP_HMMC:
00087C 487C FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
00087E 487E 43               4      LD  B,E
00087F 487F 7B               4      LD  A,E
000880 4880 B7               4      OR  A
000881 4881 2802            12      JR  Z,LOOP_HMMC1
000883 4883 EDB3                    OTIR
       4885                     LOOP_HMMC1:
000885 4885 14               4      INC D
       4886                     LOOP_HMMC2:
000886 4886 15               4      DEC D
000887 4887 2805            12      JR  Z,LOOP_HMMC3
000889 4889 EDB3                    OTIR
00088B 488B C38648          10      JP  LOOP_HMMC2
       488E                     LOOP_HMMC3:
00088E 488E ED78            12      IN  A,(C)
000890 4890 0F               4      RRCA
000891 4891 30E2            12      JR  NC,EXIT_COPY    ;check CE bit
000893 4893 2A3CF1          16      LD  HL,(_BUF_EN)
000896 4896 CD1549          17      CALL    ROM_READ
000899 4899 EB               4      EX  DE,HL
00089A 489A 2A2FF1          16      LD  HL,(_DTA)
00089D 489D 7A               4      LD  A,D
00089E 489E B3               4      OR  E
00089F 489F 20DB            12      JR  NZ,LOOP_HMMC
0008A1 48A1 18C3            12      JR  LOOP_COPY1
                                    
       48A3                     WAIT_VDP:
0008A3 48A3 3E02             7      LD  A,2
0008A5 48A5 CDAC48          17      CALL    GET_STATUS
0008A8 48A8 0F               4      RRCA
0008A9 48A9 38F8            12      JR  C,WAIT_VDP
       48AB                     GET_STATUS_0:
0008AB 48AB AF               4      XOR A
       48AC                     GET_STATUS:
0008AC 48AC C5              11      PUSH    BC
0008AD 48AD ED4B0600        20      LD  BC,(RDVDP)
0008B1 48B1 0C               4      INC C
0008B2 48B2 ED79            12      OUT (C),A
0008B4 48B4 3E8F             7      LD  A,08FH
0008B6 48B6 ED79            12      OUT (C),A
0008B8 48B8 ED78            12      IN  A,(C)
0008BA 48BA C1              10      POP BC
0008BB 48BB C9              10      RET
                                
       48BC                     GET_PIXEL256:
0008BC 48BC 7A               4      LD  A,D
0008BD 48BD B3               4      OR  E
0008BE 48BE 200A            12      JR  NZ,GET_PIXEL1
0008C0 48C0 2A3CF1          16      LD  HL,(_BUF_EN)
0008C3 48C3 CD1549          17      CALL    ROM_READ
0008C6 48C6 EB               4      EX  DE,HL
0008C7 48C7 2A2FF1          16      LD  HL,(_DTA)
       48CA                     GET_PIXEL1:
0008CA 48CA 7E               7      LD  A,(HL)
0008CB 48CB 23               6      INC HL
0008CC 48CC 1B               6      DEC DE
0008CD 48CD C9              10      RET
                                
       48CE                     GET_PIXEL:
0008CE 48CE 04               4      INC B
0008CF 48CF DD7D             9      LD  A,IXL
0008D1 48D1 FE08             7      CP  8
0008D3 48D3 28E7            12      JR  Z,GET_PIXEL256
0008D5 48D5 FE06             7      CP  6
0008D7 48D7 282E            12      JR  Z,GET_PIXEL4
                                
0008D9 48D9 CB40             8      BIT 0,B
0008DB 48DB 20ED            12      JR  NZ,GET_PIXEL1
                                
0008DD 48DD 7A               4      LD  A,D
0008DE 48DE B3               4      OR  E
0008DF 48DF 200A            12      JR  NZ,GET_PIXEL2
                                
0008E1 48E1 2A3CF1          16      LD  HL,(_BUF_EN)
0008E4 48E4 CD1549          17      CALL    ROM_READ
0008E7 48E7 EB               4      EX  DE,HL
0008E8 48E8 2A2FF1          16      LD  HL,(_DTA)
                                
       48EB                     GET_PIXEL2:
0008EB 48EB 7E               7      LD  A,(HL)
0008EC 48EC 0F               4      RRCA
0008ED 48ED 0F               4      RRCA
0008EE 48EE 0F               4      RRCA
0008EF 48EF 0F               4      RRCA
0008F0 48F0 C9              10      RET
                                
       48F1                     GET_PIXEL3:
0008F1 48F1 7A               4      LD  A,D
0008F2 48F2 B3               4      OR  E
0008F3 48F3 200A            12      JR  NZ,GET_PIXEL5
                                
0008F5 48F5 2A3CF1          16      LD  HL,(_BUF_EN)
0008F8 48F8 CD1549          17      CALL    ROM_READ
0008FB 48FB EB               4      EX  DE,HL
0008FC 48FC 2A2FF1          16      LD  HL,(_DTA)
       48FF                     GET_PIXEL5:
0008FF 48FF 7E               7      LD  A,(HL)
000900 4900 0F               4      RRCA
000901 4901 0F               4      RRCA
000902 4902 0F               4      RRCA
000903 4903 0F               4      RRCA
000904 4904 0F               4      RRCA
000905 4905 0F               4      RRCA
000906 4906 C9              10      RET
                                
       4907                     GET_PIXEL4:
000907 4907 78               4      LD  A,B
000908 4908 E603             7      AND 3   ;+0
00090A 490A 28E5            12      JR  Z,GET_PIXEL3
00090C 490C 3D               4      DEC A   ;+1
00090D 490D 28DC            12      JR  Z,GET_PIXEL2
00090F 490F 3D               4      DEC A   ;+2
000910 4910 7E               7      LD  A,(HL)
000911 4911 C0              11      RET NZ
000912 4912 0F               4      RRCA        ;+3
000913 4913 0F               4      RRCA
000914 4914 C9              10      RET
                                
       4915                     ROM_READ:
000915 4915 E5              11      PUSH    HL
000916 4916 D5              11      PUSH    DE
000917 4917 C5              11      PUSH    BC
000918 4918 FDE5            15      PUSH    IY
00091A 491A 224DF1          16      LD  (LEFTX),HL
00091D 491D 2A2FF1          16      LD  HL,(_DTA)
000920 4920 2247F1          16      LD  (DTAX),HL
000923 4923 2A4DF1          16      LD  HL,(LEFTX)
                                
000926 4926 CD744B          17      CALL    RBX1
000929 4929 3870            12      JR  C,RBRERR1
00092B 492B 79               4      LD  A,C
00092C 492C EB               4      EX  DE,HL
00092D 492D ED52            15      SBC HL,DE       ;CP 0HL,CDE
00092F 492F 19              11      ADD HL,DE
000930 4930 DE00             7      SBC A,000H
000932 4932 3801            12      JR  C,RBR1
000934 4934 EB               4      EX  DE,HL
       4935                     RBR1:
000935 4935 9F               4      SBC A,A
000936 4936 E601             7      AND 1
000938 4938 321FF1          13      LD  (_RESULT),A
00093B 493B 7C               4      LD  A,H
00093C 493C B5               4      OR  L
00093D 493D CA9149          10      JP  Z,RBREND0
                                
000940 4940 222BF1          16      LD  (_LEFT),HL  ;Read record byte
000943 4943 224DF1          16      LD  (LEFTX),HL
                                
000946 4946 CD9A4B          17      CALL    RBX2
000949 4949 281A            12      JR  Z,RBRB
                                                ;先頭の端数
00094B 494B CDAD4B          17      CALL    RBXA
00094E 494E DAA749          10      JP  C,RBRERR
000951 4951 C5              11      PUSH    BC
000952 4952 CD4244          17      CALL    ROM_LDIR
000955 4955 ED5347F1        20      LD  (DTAX),DE
000959 4959 2A4DF1          16      LD  HL,(LEFTX)
00095C 495C D1              10      POP DE
00095D 495D A7               4      AND A
00095E 495E ED52            15      SBC HL,DE
000960 4960 224DF1          16      LD  (LEFTX),HL
000963 4963 2829            12      JR  Z,RBREND
                                
       4965                     RBRB:
000965 4965 CDE94B          17      CALL    RBXB
000968 4968 2818            12      JR  Z,RBRC
       496A                     RBRB1:
00096A 496A C5              11      PUSH    BC
00096B 496B D5              11      PUSH    DE
00096C 496C CD914C          17      CALL    CLUST
00096F 496F EB               4      EX  DE,HL
000970 4970 ED4B21F1        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000974 4974 CD4244          17      CALL    ROM_LDIR
000977 4977 EB               4      EX  DE,HL
000978 4978 D1              10      POP DE
000979 4979 C1              10      POP BC
00097A 497A CD6E4C          17      CALL    GNCL
00097D 497D DAA749          10      JP  C,RBRERR
000980 4980 10E8            13      DJNZ    RBRB1
       4982                     RBRC:
000982 4982 CD014C          17      CALL    RBXC
000985 4985 2807            12      JR  Z,RBREND
                                
000987 4987 CD914C          17      CALL    CLUST
00098A 498A EB               4      EX  DE,HL
00098B 498B CD4244          17      CALL    ROM_LDIR
       498E                     RBREND:
00098E 498E CD0D4C          17      CALL    RBXEND
       4991                     RBREND0:
000991 4991 FDE1            14      POP IY
000993 4993 C1              10      POP BC
000994 4994 D1              10      POP DE
000995 4995 F1              10      POP AF  ;(HL)
000996 4996 AF               4      XOR A
000997 4997 3A1FF1          13      LD  A,(_RESULT)
00099A 499A C9              10      RET
                                
       499B                     RBRERR1:
00099B 499B 3E01             7      LD  A,001H
       499D                     RBRERR2:
00099D 499D FDE1            14      POP IY
00099F 499F C1              10      POP BC
0009A0 49A0 D1              10      POP DE
0009A1 49A1 E1              10      POP HL
0009A2 49A2 37               4      SCF
0009A3 49A3 210000          10      LD  HL,0
0009A6 49A6 C9              10      RET
       49A7                     RBRERR:
0009A7 49A7 3EFF             7      LD  A,0FFH
0009A9 49A9 18F2            12      JR  RBRERR2
                                
       49AB                     FILE_DD:
0009AB 49AB 3E                      DB  03EH
0009AC 49AC C9              10      RET
0009AD 49AD 320CF1          13      LD  (SWC_BLOAD_M),A
       49B0                     ROM_ORG:
0009B0 49B0 2A4FF1          16      LD  HL,(PARAM0)
0009B3 49B3 7E               7      LD  A,(HL)
0009B4 49B4 C9              10      RET
       49B5                     FILE_B:
0009B5 49B5 AF               4      XOR A
0009B6 49B6 3253F1          13      LD  (FDRV),A
0009B9 49B9 1E00             7      LD  E,0
0009BB 49BB 3A63F6          13      LD  A,(VALTYP)
0009BE 49BE FE03             7      CP  3       ;string
0009C0 49C0 2044            12      JR  NZ,FILED
                                
0009C2 49C2 DD21D067        14      LD  IX,FRESTR
0009C6 49C6 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009CA 49CA CD1C00          17      CALL    _CALSLT
0009CD 49CD E5              11      PUSH    HL
0009CE 49CE DDE1            14      POP IX
                                
0009D0 49D0 DD5E00          19      LD  E,(IX+0)
0009D3 49D3 DD7E01          19      LD  A,(IX+1)
0009D6 49D6 DD5602          19      LD  D,(IX+2)
0009D9 49D9 DD62             9      LD  IXH,D
0009DB 49DB DD6F             9      LD  IXL,A
0009DD 49DD 7B               4      LD  A,E
0009DE 49DE FE04             7      CP  4
0009E0 49E0 3808            12      JR  C,FILEB1
0009E2 49E2 DD7E03          19      LD  A,(IX+3)
0009E5 49E5 FE3A             7      CP  ':'
0009E7 49E7 28C2            12      JR  Z,FILE_DD
0009E9 49E9 7B               4      LD  A,E
       49EA                     FILEB1:
0009EA 49EA FE02             7      CP  2
0009EC 49EC 3818            12      JR  C,FILED
0009EE 49EE DD7E01          19      LD  A,(IX+1)
0009F1 49F1 FE3A             7      CP  ':'
0009F3 49F3 2011            12      JR  NZ,DEVI1
0009F5 49F5 DD7E00          19      LD  A,(IX+0)        ;DRIVE
0009F8 49F8 CDE34A          17      CALL    CAP
0009FB 49FB D640             7      SUB '@'
0009FD 49FD DD23            10      INC IX
0009FF 49FF DD23            10      INC IX
000A01 4A01 1D               4      DEC E
000A02 4A02 1D               4      DEC E
000A03 4A03 3253F1          13      LD  (FDRV),A
       4A06                     DEVI1:
                                
       4A06                     FILED:
000A06 4A06 CD4D4A          17      CALL    FILEI
000A09 4A09 2154F1          10      LD  HL,FNAME
                                
000A0C 4A0C 0608             7      LD  B,8
       4A0E                     FILE2:
000A0E 4A0E CD5A4A          17      CALL    CCHKF
000A11 4A11 C8              11      RET Z
000A12 4A12 FE2A             7      CP  '*'
000A14 4A14 282E            12      JR  Z,FILE9
000A16 4A16 FE2E             7      CP  '.'
000A18 4A18 280C            12      JR  Z,FILE4
000A1A 4A1A 77               7      LD  (HL),A
000A1B 4A1B 23               6      INC HL
000A1C 4A1C 10F0            13      DJNZ    FILE2
                                
       4A1E                     FILE3:
000A1E 4A1E CD5A4A          17      CALL    CCHKF
000A21 4A21 C8              11      RET Z
000A22 4A22 FE2E             7      CP  '.'
000A24 4A24 20F8            12      JR  NZ,FILE3
                                
       4A26                     FILE4:
000A26 4A26 215CF1          10      LD  HL,FNAME+8
000A29 4A29 0603             7      LD  B,3
                                
       4A2B                     FILE4L:
000A2B 4A2B CD5A4A          17      CALL    CCHKF
000A2E 4A2E C8              11      RET Z
000A2F 4A2F FE2E             7      CP  '.'
000A31 4A31 2008            12      JR  NZ,FILE12
000A33 4A33 3254F1          13      LD  (FNAME),A   ;Parent directory(..)
000A36 4A36 3255F1          13      LD  (FNAME+1),A
000A39 4A39 3E20             7      LD  A,020H
       4A3B                     FILE12:
000A3B 4A3B FE2A             7      CP  '*'
000A3D 4A3D 280A            12      JR  Z,FILE10
000A3F 4A3F 77               7      LD  (HL),A
000A40 4A40 23               6      INC HL
000A41 4A41 10E8            13      DJNZ    FILE4L
000A43 4A43 C9              10      RET
                                
       4A44                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000A44 4A44 CD494A          17      CALL    FILE10
000A47 4A47 18D5            12      JR  FILE3
                                
       4A49                     FILE10:
000A49 4A49 3E3F             7      LD  A,'?'
000A4B 4A4B 1808            12      JR  FILL_MEMORY
       4A4D                     FILEI:              ;名前＋拡張子をスペースで初期化
000A4D 4A4D 3E20             7      LD  A,020H
000A4F 4A4F 01000B          10      LD  BC,11*256   ;C=0にしておく
000A52 4A52 2154F1          10      LD  HL,FNAME
       4A55                     FILL_MEMORY:            ;HLからBバイトAで埋める
000A55 4A55 77               7      LD  (HL),A
000A56 4A56 23               6      INC HL
000A57 4A57 10FC            13      DJNZ    FILL_MEMORY
000A59 4A59 C9              10      RET
                                
       4A5A                     CCHKF:
000A5A 4A5A 7B               4      LD  A,E
000A5B 4A5B B7               4      OR  A
000A5C 4A5C C8              11      RET Z
000A5D 4A5D DD7E00          19      LD  A,(IX+0)
000A60 4A60 CD674A          17      CALL    CCHK2
000A63 4A63 C8              11      RET Z
000A64 4A64 C3CE4A          10      JP  FKAN
                                
       4A67                     CCHK2:
000A67 4A67 0C               4      INC C
000A68 4A68 0D               4      DEC C
000A69 4A69 C0              11      RET NZ
       4A6A                     CCHK3:              ;ZF=1 で使えない文字
000A6A 4A6A FE2B             7      CP  '+'
000A6C 4A6C C8              11      RET Z
000A6D 4A6D FE2C             7      CP  ','
000A6F 4A6F C8              11      RET Z
000A70 4A70 FE2F             7      CP  '/'
000A72 4A72 C8              11      RET Z
000A73 4A73 FE3A             7      CP  ':'
000A75 4A75 C8              11      RET Z
000A76 4A76 FE3B             7      CP  ';'
000A78 4A78 C8              11      RET Z
000A79 4A79 FE3D             7      CP  '='
000A7B 4A7B C8              11      RET Z
000A7C 4A7C FE5C             7      CP  05CH    ;\
000A7E 4A7E C8              11      RET Z
000A7F 4A7F FE1F             7      CP  01FH
000A81 4A81 D0              11      RET NC
000A82 4A82 BF               4      CP  A       ;Z=1
000A83 4A83 C9              10      RET
                                
       4A84                     SS1:
000A84 4A84 13               6      INC DE
       4A85                     SPCUT:              ;スペースをカット
000A85 4A85 1A               7      LD  A,(DE)
000A86 4A86 FE20             7      CP  020H
000A88 4A88 28FA            12      JR  Z,SS1
000A8A 4A8A C9              10      RET
                                
       4A8B                     SCREOF1:
000A8B 4A8B 13               6      INC DE
       4A8C                     SPCUTEX:            ;スペース改行などをカット
000A8C 4A8C 1A               7      LD  A,(DE)
000A8D 4A8D FE20             7      CP  020H
000A8F 4A8F 28FA            12      JR  Z,SCREOF1
000A91 4A91 FE0D             7      CP  00DH
000A93 4A93 28F6            12      JR  Z,SCREOF1
000A95 4A95 FE0A             7      CP  00AH
000A97 4A97 28F2            12      JR  Z,SCREOF1
000A99 4A99 FE1A             7      CP  01AH
000A9B 4A9B 28EE            12      JR  Z,SCREOF1
000A9D 4A9D C9              10      RET
                                
       4A9E                     GETNUM:
000A9E 4A9E 210000          10      LD  HL,0
       4AA1                     GETNUM1:
000AA1 4AA1 1A               7      LD  A,(DE)
000AA2 4AA2 13               6      INC DE
000AA3 4AA3 D630             7      SUB '0'
000AA5 4AA5 D8              11      RET C
000AA6 4AA6 FE0A             7      CP  10
000AA8 4AA8 D0              11      RET NC
000AA9 4AA9 4D               4      LD  C,L
000AAA 4AAA 44               4      LD  B,H
000AAB 4AAB 29              11      ADD HL,HL   ;*2
000AAC 4AAC 29              11      ADD HL,HL   ;*4
000AAD 4AAD 09              11      ADD HL,BC   ;*5
000AAE 4AAE 29              11      ADD HL,HL   ;*10
000AAF 4AAF 4F               4      LD  C,A
000AB0 4AB0 0600             7      LD  B,0
000AB2 4AB2 09              11      ADD HL,BC
000AB3 4AB3 18EC            12      JR  GETNUM1
                                
       4AB5                     SEARCH_END:
000AB5 4AB5 7E               7      LD  A,(HL)
       4AB6                     SEARCH_END1:
000AB6 4AB6 23               6      INC HL
000AB7 4AB7 B7               4      OR  A
000AB8 4AB8 C8              11      RET Z
000AB9 4AB9 FE3A             7      CP  ':'
000ABB 4ABB 20F8            12      JR  NZ,SEARCH_END
000ABD 4ABD 7E               7      LD  A,(HL)
000ABE 4ABE FE3A             7      CP  ':'
000AC0 4AC0 28F4            12      JR  Z,SEARCH_END1
000AC2 4AC2 FE20             7      CP  020H
000AC4 4AC4 28F0            12      JR  Z,SEARCH_END1
000AC6 4AC6 C9              10      RET
                                
       4AC7                     FKANC:
000AC7 4AC7 CB41             8      BIT 0,C
000AC9 4AC9 CCEC4A          17      CALL    Z,CAP2
000ACC 4ACC 1803            12      JR  FKANX
       4ACE                     FKAN:           ;漢字チェック
000ACE 4ACE DD23            10      INC IX
000AD0 4AD0 1D               4      DEC E
       4AD1                     FKANX:
000AD1 4AD1 CB41             8      BIT 0,C
000AD3 4AD3 CB81             8      RES 0,C
000AD5 4AD5 C0              11      RET NZ
000AD6 4AD6 FE80             7      CP  080H
000AD8 4AD8 D8              11      RET C
000AD9 4AD9 FEA0             7      CP  0A0H
000ADB 4ADB 3803            12      JR  C,FKAN1
000ADD 4ADD FEE0             7      CP  0E0H
000ADF 4ADF D8              11      RET C
       4AE0                     FKAN1:
000AE0 4AE0 0C               4      INC C
000AE1 4AE1 A7               4      AND A
000AE2 4AE2 C9              10      RET
                                
       4AE3                     CAP:
000AE3 4AE3 FE61             7      CP  'a'
000AE5 4AE5 D8              11      RET C
000AE6 4AE6 FE7B             7      CP  'z'+1
000AE8 4AE8 D0              11      RET NC
000AE9 4AE9 D620             7      SUB 020H
000AEB 4AEB C9              10      RET
       4AEC                     CAP2:
000AEC 4AEC CDE34A          17      CALL    CAP
       4AEF                     CAP3:               ;
000AEF 4AEF FE05             7      CP  5
000AF1 4AF1 2803            12      JR  Z,CAP4
000AF3 4AF3 FE21             7      CP  021H
000AF5 4AF5 C9              10      RET
       4AF6                     CAP4:
000AF6 4AF6 3EE5             7      LD  A,0E5H
000AF8 4AF8 C9              10      RET
                                
       4AF9                     ROM_OPEN:
000AF9 4AF9 CD184F          17      CALL    GET_DISK_BANK_FDRV
                                
000AFC 4AFC CD414D          17      CALL    GET_DIR_DAT
000AFF 4AFF D5              11      PUSH    DE
000B00 4B00 CD154B          17      CALL    FILESE
000B03 4B03 D1              10      POP DE
000B04 4B04 3F               4      CCF
000B05 4B05 D8              11      RET C
000B06 4B06 224BF1          16      LD  (FCBX),HL
000B09 4B09 E5              11      PUSH    HL
000B0A 4B0A 210000          10      LD  HL,0
000B0D 4B0D 2225F1          16      LD  (RR_LOW),HL
000B10 4B10 2227F1          16      LD  (RR_HIGH),HL
000B13 4B13 E1              10      POP HL
000B14 4B14 C9              10      RET
                                
       4B15                     FILESE:
000B15 4B15 7E               7      LD  A,(HL)
000B16 4B16 B7               4      OR  A
000B17 4B17 C8              11      RET Z       ;END:ZF=1 CF=0
000B18 4B18 FEE5             7      CP  0E5H
000B1A 4B1A 280D            12      JR  Z,FILESE1
000B1C 4B1C 1154F1          10      LD  DE,FNAME
000B1F 4B1F E5              11      PUSH    HL
000B20 4B20 CD4E4B          17      CALL    CPFILE
000B23 4B23 CC6F4B          17      CALL    Z,CPFILE2
000B26 4B26 E1              10      POP HL
000B27 4B27 37               4      SCF
000B28 4B28 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4B29                     FILESE1:
000B29 4B29 CD314B          17      CALL    FNEXT
000B2C 4B2C 20E7            12      JR  NZ,FILESE
       4B2E                     ZF0_CF0_AFF_RET:
000B2E 4B2E F6FF             7      OR  0FFH        ;ZF=0 CF=0
000B30 4B30 C9              10      RET
                                
       4B31                     FNEXT:
000B31 4B31 112000          10      LD  DE,020H
000B34 4B34 19              11      ADD HL,DE
000B35 4B35 0D               4      DEC C
                                #if exists USE_NORMAL_32K_ROM
                                #else
       4B36                     CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
000B36 4B36 F5              11      PUSH    AF
000B37 4B37 CB7C             8      BIT 7,H
000B39 4B39 2811            12      JR  Z,CHECK_DIR_PAGE1
000B3B 4B3B 7C               4      LD  A,H
000B3C 4B3C D620             7      SUB 020H
000B3E 4B3E 67               4      LD  H,A
000B3F 4B3F 3A20F1          13      LD  A,(_BANK)
000B42 4B42 3C               4      INC A
000B43 4B43 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000B46 4B46 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000B49 4B49 3220F1          13      LD  (_BANK),A
       4B4C                     CHECK_DIR_PAGE1:
000B4C 4B4C F1              10      POP AF
                                #endif
000B4D 4B4D C9              10      RET
                                
       4B4E                     CPFILE:
000B4E 4B4E C5              11      PUSH    BC
000B4F 4B4F 01000B          10      LD  BC,00B00H
       4B52                     CPSTR1:
000B52 4B52 1A               7      LD  A,(DE)
000B53 4B53 FE3F             7      CP  '?'     ;Wild card
000B55 4B55 2812            12      JR  Z,CPSTR2
000B57 4B57 7E               7      LD  A,(HL)
000B58 4B58 CDC74A          17      CALL    FKANC
000B5B 4B5B E5              11      PUSH    HL
000B5C 4B5C 67               4      LD  H,A
000B5D 4B5D 1A               7      LD  A,(DE)
000B5E 4B5E CB01             4      RLC C
000B60 4B60 CDC74A          17      CALL    FKANC
000B63 4B63 CB09             4      RRC C
000B65 4B65 BC               4      CP  H       ;CP (HL),(DE)
000B66 4B66 E1              10      POP HL
000B67 4B67 2004            12      JR  NZ,CPSTR3
       4B69                     CPSTR2:
000B69 4B69 13               6      INC DE
000B6A 4B6A 23               6      INC HL
000B6B 4B6B 10E5            13      DJNZ    CPSTR1
       4B6D                     CPSTR3:
000B6D 4B6D C1              10      POP BC
000B6E 4B6E C9              10      RET
                                
       4B6F                     CPFILE2:
                                ;   LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
                                ;   OR  0E1H
000B6F 4B6F 3EE1             7      LD  A,0E1H
000B71 4B71 2F               4      CPL
000B72 4B72 A6               7      AND (HL)
000B73 4B73 C9              10      RET
                                
       4B74                     RBX1:
000B74 4B74 E5              11      PUSH    HL      ;Record byte
                                
000B75 4B75 ED5B25F1        20      LD  DE,(RR_LOW) ;CDE=Random record
000B79 4B79 3A28F1          13      LD  A,(RR_HIGH+1)
000B7C 4B7C 4F               4      LD  C,A
                                
000B7D 4B7D CD184F          17      CALL    GET_DISK_BANK_FDRV
                                
000B80 4B80 FD2A4BF1        20      LD  IY,(FCBX)
000B84 4B84 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000B87 4B87 FD661D          19      LD  H,(IY+01DH)
000B8A 4B8A FD7E1E          19      LD  A,(IY+01EH)
                                
000B8D 4B8D A7               4      AND A
000B8E 4B8E ED52            15      SBC HL,DE
000B90 4B90 99               4      SBC A,C
000B91 4B91 D1              10      POP DE
                                
000B92 4B92 D8              11      RET C
000B93 4B93 4F               4      LD  C,A
000B94 4B94 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000B95 4B95 B2               4      OR  D
000B96 4B96 B3               4      OR  E
000B97 4B97 C0              11      RET NZ
000B98 4B98 37               4      SCF
000B99 4B99 C9              10      RET
                                
       4B9A                     RBX2:
000B9A 4B9A ED4B26F1        20      LD  BC,(RR_LOW+1)
000B9E 4B9E CD224C          17      CALL    RWXR
000BA1 4BA1 3A22F1          13      LD  A,(CLSZ_H)
000BA4 4BA4 3D               4      DEC A
000BA5 4BA5 E5              11      PUSH    HL
000BA6 4BA6 2A25F1          16      LD  HL,(RR_LOW)
000BA9 4BA9 A4               4      AND H
000BAA 4BAA B5               4      OR  L
000BAB 4BAB E1              10      POP HL
000BAC 4BAC C9              10      RET
                                
       4BAD                     RBXA:
000BAD 4BAD D5              11      PUSH    DE
000BAE 4BAE CD914C          17      CALL    CLUST
000BB1 4BB1 ED532DF1        20      LD  (_DTPS),DE
000BB5 4BB5 D1              10      POP DE
000BB6 4BB6 CD6E4C          17      CALL    GNCL
000BB9 4BB9 D8              11      RET C
000BBA 4BBA ED5329F1        20      LD  (_CLPS),DE
                                
000BBE 4BBE ED4B25F1        20      LD  BC,(RR_LOW)
000BC2 4BC2 2A21F1          16      LD  HL,(CLSZ)
000BC5 4BC5 7C               4      LD  A,H
000BC6 4BC6 3D               4      DEC A
000BC7 4BC7 A0               4      AND B
000BC8 4BC8 47               4      LD  B,A
000BC9 4BC9 ED42            15      SBC HL,BC       ;remaining cluster
                                
000BCB 4BCB ED5B4DF1        20      LD  DE,(LEFTX)
000BCF 4BCF ED52            15      SBC HL,DE       ;CP HL,DE
000BD1 4BD1 19              11      ADD HL,DE
000BD2 4BD2 3801            12      JR  C,RBXA1
000BD4 4BD4 EB               4      EX  DE,HL
       4BD5                     RBXA1:
000BD5 4BD5 3A20F1          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
000BD8 4BD8 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000BDB 4BDB 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000BDE 4BDE E5              11      PUSH    HL
000BDF 4BDF 2A2DF1          16      LD  HL,(_DTPS)
000BE2 4BE2 09              11      ADD HL,BC
000BE3 4BE3 ED5B47F1        20      LD  DE,(DTAX)
000BE7 4BE7 C1              10      POP BC
000BE8 4BE8 C9              10      RET
                                
       4BE9                     RBXB:
000BE9 4BE9 2A47F1          16      LD  HL,(DTAX)
000BEC 4BEC ED5B29F1        20      LD  DE,(_CLPS)
000BF0 4BF0 3A4EF1          13      LD  A,(LEFTX+1)
000BF3 4BF3 47               4      LD  B,A
000BF4 4BF4 3A22F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4BF7                     RBXB1:
000BF7 4BF7 1F               4      RRA     ;->CF
000BF8 4BF8 3804            12      JR  C,RBXB2
000BFA 4BFA CB38             8      SRL B   ;B=B/2
000BFC 4BFC 18F9            12      JR  RBXB1
       4BFE                     RBXB2:
000BFE 4BFE 78               4      LD  A,B
000BFF 4BFF B7               4      OR  A
000C00 4C00 C9              10      RET
                                
       4C01                     RBXC:
000C01 4C01 ED4B4DF1        20      LD  BC,(LEFTX)
000C05 4C05 3A22F1          13      LD  A,(CLSZ_H)
000C08 4C08 3D               4      DEC A
000C09 4C09 A0               4      AND B
000C0A 4C0A 47               4      LD  B,A
000C0B 4C0B B1               4      OR  C
000C0C 4C0C C9              10      RET
                                
       4C0D                     RBXEND:
000C0D 4C0D ED5B2BF1        20      LD  DE,(_LEFT)
000C11 4C11 2A25F1          16      LD  HL,(RR_LOW)
000C14 4C14 3A28F1          13      LD  A,(RR_HIGH+1)
000C17 4C17 19              11      ADD HL,DE
000C18 4C18 CE00             7      ADC A,0
000C1A 4C1A 2225F1          16      LD  (RR_LOW),HL
000C1D 4C1D 3228F1          13      LD  (RR_HIGH+1),A
000C20 4C20 EB               4      EX  DE,HL       ;HL=Read byte
000C21 4C21 C9              10      RET 
                                
       4C22                     RWXR:
000C22 4C22 3A22F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4C25                     L_RWX:
000C25 4C25 1F               4      RRA     ;->CF
000C26 4C26 3806            12      JR  C,E_RWX
000C28 4C28 CB38             8      SRL B   ;BC=BC/2
000C2A 4C2A CB19             8      RR  C   ;
000C2C 4C2C 18F7            12      JR  L_RWX
       4C2E                     E_RWX:
000C2E 4C2E CD184F          17      CALL    GET_DISK_BANK_FDRV
                                
000C31 4C31 FD2A4BF1        20      LD  IY,(FCBX)
000C35 4C35 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000C38 4C38 FD561B          19      LD  D,(IY+01BH)
       4C3B                     RWX1:
000C3B 4C3B ED5329F1        20      LD  (_CLPS),DE
000C3F 4C3F 7A               4      LD  A,D
000C40 4C40 B3               4      OR  E
000C41 4C41 37               4      SCF
000C42 4C42 C8              11      RET Z
                                
000C43 4C43 78               4      LD  A,B
000C44 4C44 B1               4      OR  C
000C45 4C45 C8              11      RET Z
                                
000C46 4C46 CD6E4C          17      CALL    GNCL
000C49 4C49 D8              11      RET C
000C4A 4C4A 0B               6      DEC BC
000C4B 4C4B CDDA4C          17      CALL    ENDCL
000C4E 4C4E 38EB            12      JR  C,RWX1
000C50 4C50 37               4      SCF
000C51 4C51 C9              10      RET
                                
       4C52                     NCL3:
000C52 4C52 CD184F          17      CALL    GET_DISK_BANK_FDRV
000C55 4C55 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C58 4C58 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000C5B 4C5B 6B               4      LD  L,E
000C5C 4C5C 62               4      LD  H,D
000C5D 4C5D CB3C             8      SRL H
000C5F 4C5F CB1D             8      RR  L
000C61 4C61 1F               4      RRA
000C62 4C62 19              11      ADD HL,DE
000C63 4C63 010060          10      LD  BC,BANK1_ADR
000C66 4C66 09              11      ADD HL,BC
000C67 4C67 ED4B23F1        20      LD  BC,(SECSZ)
000C6B 4C6B 09              11      ADD HL,BC
000C6C 4C6C 17               4      RLA
000C6D 4C6D C9              10      RET
                                
       4C6E                     GNCL:
000C6E 4C6E 7A               4      LD  A,D
000C6F 4C6F B3               4      OR  E
000C70 4C70 37               4      SCF
000C71 4C71 C8              11      RET Z
000C72 4C72 C5              11      PUSH    BC
000C73 4C73 E5              11      PUSH    HL
000C74 4C74 CD524C          17      CALL    NCL3
000C77 4C77 3809            12      JR  C,GNC1
000C79 4C79 5E               7      LD  E,(HL)
000C7A 4C7A 23               6      INC HL
000C7B 4C7B 7E               7      LD  A,(HL)
000C7C 4C7C E60F             7      AND 00FH
000C7E 4C7E 57               4      LD  D,A
000C7F 4C7F E1              10      POP HL
000C80 4C80 C1              10      POP BC
000C81 4C81 C9              10      RET
       4C82                     GNC1:
000C82 4C82 7E               7      LD  A,(HL)
000C83 4C83 23               6      INC HL
000C84 4C84 56               7      LD  D,(HL)
000C85 4C85 0604             7      LD  B,4
       4C87                     GNC1L:
000C87 4C87 CB3A             8      SRL D
000C89 4C89 1F               4      RRA
000C8A 4C8A 10FB            13      DJNZ    GNC1L
                                
000C8C 4C8C 5F               4      LD  E,A
000C8D 4C8D E1              10      POP HL
000C8E 4C8E C1              10      POP BC
000C8F 4C8F A7               4      AND A
000C90 4C90 C9              10      RET
                                
       4C91                     CLUST:
000C91 4C91 EB               4      EX  DE,HL
000C92 4C92 C5              11      PUSH    BC
000C93 4C93 3A22F1          13      LD  A,(CLSZ_H)
000C96 4C96 CD444F          17      CALL    MUL_AHL
                                
000C99 4C99 CD514D          17      CALL    GET_DIR_POS
000C9C 4C9C 4F               4      LD  C,A
000C9D 4C9D 0600             7      LD  B,0
000C9F 4C9F 09              11      ADD HL,BC
                                
000CA0 4CA0 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000CA3 4CA3 0F               4      RRCA
000CA4 4CA4 0F               4      RRCA
000CA5 4CA5 0F               4      RRCA
000CA6 4CA6 0F               4      RRCA
000CA7 4CA7 4F               4      LD  C,A
                                
000CA8 4CA8 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000CAB 4CAB FE02             7      CP  2
000CAD 4CAD 280C            12      JR  Z,CLUST1
000CAF 4CAF CB01             4      RLC C
000CB1 4CB1 0D               4      DEC C
000CB2 4CB2 3A0C60          13      LD  A,(BANK1_ADR+11+1)  ;BPB_BytsPerSec High    
000CB5 4CB5 FE02             7      CP  2
000CB7 4CB7 2002            12      JR  NZ,CLUST1
000CB9 4CB9 0D               4      DEC C
000CBA 4CBA 0D               4      DEC C
       4CBB                     CLUST1:
000CBB 4CBB 0D               4      DEC C
000CBC 4CBC 09              11      ADD HL,BC
                                
                                #if exists USE_NORMAL_32K_ROM
                                    LD  A,L
                                #else
000CBD 4CBD E5              11      PUSH    HL
000CBE 4CBE 29              11      ADD HL,HL   ;*2
000CBF 4CBF 29              11      ADD HL,HL   ;*4
000CC0 4CC0 29              11      ADD HL,HL   ;*8
000CC1 4CC1 CD184F          17      CALL    GET_DISK_BANK_FDRV
000CC4 4CC4 84               4      ADD A,H
000CC5 4CC5 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000CC8 4CC8 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000CCB 4CCB 3220F1          13      LD  (_BANK),A
000CCE 4CCE E1              10      POP HL
000CCF 4CCF 3E1F             7      LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
000CD1 4CD1 A5               4      AND L
                                #endif
000CD2 4CD2 C660             7      ADD A,high BANK1_ADR
000CD4 4CD4 67               4      LD  H,A
000CD5 4CD5 2E00             7      LD  L,0
000CD7 4CD7 EB               4      EX  DE,HL
000CD8 4CD8 C1              10      POP BC
000CD9 4CD9 C9              10      RET
                                
       4CDA                     ENDCL:
000CDA 4CDA 7A               4      LD  A,D ;END CLUSTER
000CDB 4CDB FE0F             7      CP  00FH    ;FAT12の最大値
000CDD 4CDD C0              11      RET NZ
000CDE 4CDE 7B               4      LD  A,E
000CDF 4CDF FEF7             7      CP  0F7H
000CE1 4CE1 C9              10      RET
                                
       4CE2                     RB_READ:
000CE2 4CE2 AF               4      XOR A   ;HLA = HL*128
000CE3 4CE3 CB3C             8      SRL H
000CE5 4CE5 CB1D             8      RR  L
000CE7 4CE7 1F               4      RRA
000CE8 4CE8 3225F1          13      LD  (RR_LOW),A
000CEB 4CEB 2226F1          16      LD  (RR_MID),HL
000CEE 4CEE 218000          10      LD  HL,128
                                
000CF1 4CF1 CD1549          17      CALL    ROM_READ
000CF4 4CF4 C9              10      RET
                                
       4CF5                     GETSEQ:
000CF5 4CF5 FD6E20          19      LD  L,(IY+32)
000CF8 4CF8 FD660C          19      LD  H,(IY+12)
                                
000CFB 4CFB CB25             8      SLA L
                                
000CFD 4CFD CB3C             8      SRL H
000CFF 4CFF CB1D             8      RR  L
000D01 4D01 C9              10      RET
                                
       4D02                     SETSEQ:
000D02 4D02 F5              11      PUSH    AF
000D03 4D03 3A25F1          13      LD  A,(RR_LOW)
000D06 4D06 2A26F1          16      LD  HL,(RR_MID)
                                
000D09 4D09 CD204D          17      CALL    SSQ1
                                
000D0C 4D0C 29              11      ADD HL,HL
000D0D 4D0D CB3D             8      SRL L
000D0F 4D0F FD7520          19      LD  (IY+32),L
000D12 4D12 FD740C          19      LD  (IY+12),H
000D15 4D15 F1              10      POP AF
000D16 4D16 C9              10      RET
                                
       4D17                     GETSIZE:
000D17 4D17 FD7E10          19      LD  A,(IY+16)
000D1A 4D1A FD6E11          19      LD  L,(IY+17)
000D1D 4D1D FD6612          19      LD  H,(IY+18)
       4D20                     SSQ1:
000D20 4D20 87               4      ADD A,A
000D21 4D21 ED6A            15      ADC HL,HL
000D23 4D23 B7               4      OR  A
000D24 4D24 C8              11      RET Z
000D25 4D25 23               6      INC HL
000D26 4D26 C9              10      RET
                                
       4D27                     SET_FCB:
000D27 4D27 D5              11      PUSH    DE
000D28 4D28 FDE1            14      POP IY
000D2A 4D2A FD7E1C          19      LD  A,(IY+28)
000D2D 4D2D FEFF             7      CP  0FFH
000D2F 4D2F 200C            12      JR  NZ,POPAF_SCF_FF_RET
000D31 4D31 E5              11      PUSH    HL
000D32 4D32 FD6E1A          19      LD  L,(IY+26)
000D35 4D35 FD661B          19      LD  H,(IY+27)
000D38 4D38 2229F1          16      LD  (_CLPS),HL
000D3B 4D3B E1              10      POP HL
000D3C 4D3C C9              10      RET
                                
       4D3D                     POPAF_SCF_FF_RET:
000D3D 4D3D F1              10      POP AF
000D3E 4D3E 37               4      SCF
000D3F 4D3F 9F               4      SBC A,A
000D40 4D40 C9              10      RET
                                
       4D41                     GET_DIR_DAT:
000D41 4D41 CD514D          17      CALL    GET_DIR_POS
000D44 4D44 C660             7      ADD A,high BANK1_ADR
000D46 4D46 2E00             7      LD  L,0
000D48 4D48 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_NORMAL_32K_ROM
                                #else
000D49 4D49 CD364B          17      CALL    CHECK_DIR_PAGE
                                #endif
000D4C 4D4C 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000D4F 4D4F 4F               4      LD  C,A
000D50 4D50 C9              10      RET
                                
       4D51                     GET_DIR_POS:
000D51 4D51 CD184F          17      CALL    GET_DISK_BANK_FDRV
000D54 4D54 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D57 4D57 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D5A 4D5A 3220F1          13      LD  (_BANK),A
000D5D 4D5D 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000D60 4D60 47               4      LD  B,A
000D61 4D61 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000D64 4D64 4F               4      LD  C,A
000D65 4D65 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4D68                     GET_DIR_POS1:
000D68 4D68 81               4      ADD A,C
000D69 4D69 10FD            13      DJNZ    GET_DIR_POS1
                                
000D6B 4D6B ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec 
       4D6F                     L_MDP:
000D6F 4D6F CB18             8      RR  B   ;->CF
000D71 4D71 D8              11      RET C
000D72 4D72 87               4      ADD A,A
000D73 4D73 18FA            12      JR  L_MDP
                                
       4D75                     WILDCARD:
000D75 4D75 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4D80                     ERROR_WRITE_PROTECTED:
000D80 4D80 3E00             7      LD  A,0     ;Write protected
000D82 4D82 C9              10      RET
       4D83                     DISKIO:
000D83 4D83 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000D85 4D85 48               4      LD  C,B
000D86 4D86 CD224F          17      CALL    GET_DISK_BANK
       4D89                     SETMAP1:        
000D89 4D89 E5              11      PUSH    HL
       4D8A                     DISKIO1:
000D8A 4D8A C5              11      PUSH    BC      ;B=残りのセクタ数
000D8B 4D8B D5              11      PUSH    DE      ;DE=セクタ番号
000D8C 4D8C F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
000D8D 4D8D EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
000D8E 4D8E F5              11      PUSH    AF
000D8F 4D8F 3A24F1          13      LD  A,(SECSZ_H)
000D92 4D92 CD444F          17      CALL    MUL_AHL
000D95 4D95 F1              10      POP AF
000D96 4D96 4D               4      LD  C,L     ;C=読み出し元
000D97 4D97 29              11      ADD HL,HL       ;64KB→32KB
000D98 4D98 29              11      ADD HL,HL       ;32KB→16KB
000D99 4D99 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
000D9A 4D9A 84               4      ADD A,H
000D9B 4D9B 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D9E 4D9E 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000DA1 4DA1 3220F1          13      LD  (_BANK),A
000DA4 4DA4 79               4      LD  A,C     ;C=読み出し元
000DA5 4DA5 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
000DA7 4DA7 C660             7      ADD A,high BANK1_ADR
000DA9 4DA9 67               4      LD  H,A
000DAA 4DAA ED4B23F1        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
000DAE 4DAE 69               4      LD  L,C     ;C=0
000DAF 4DAF EDB0                    LDIR
000DB1 4DB1 EB               4      EX  DE,HL
000DB2 4DB2 F1              10      POP AF
000DB3 4DB3 D1              10      POP DE
000DB4 4DB4 13               6      INC DE
000DB5 4DB5 C1              10      POP BC
000DB6 4DB6 10D2            13      DJNZ    DISKIO1
000DB8 4DB8 41               4      LD  B,C
                                
000DB9 4DB9 E1              10      POP HL
000DBA 4DBA AF               4      XOR A
000DBB 4DBB FB               4      EI
000DBC 4DBC C9              10      RET
                                
       4DBD                     DSKCHG:
000DBD 4DBD CDF64D          17      CALL    IS_BPB
000DC0 4DC0 3824            12      JR  C,NOTREADY
000DC2 4DC2 3A23FB          13      LD  A,(DRVTBL+2)
000DC5 4DC5 B7               4      OR  A
000DC6 4DC6 201A            12      JR  NZ,DSKCHG1
000DC8 4DC8 3A21FB          13      LD  A,(DRVTBL)
000DCB 4DCB FE02             7      CP  2
000DCD 4DCD 2013            12      JR  NZ,DSKCHG1
000DCF 4DCF CDF64D          17      CALL    IS_BPB
000DD2 4DD2 300E            12      JR  NC,DSKCHG1
000DD4 4DD4 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000DD6 4DD6 3221FB          13      LD  (DRVTBL),A
000DD9 4DD9 3223FB          13      LD  (DRVTBL+2),A
000DDC 4DDC 3A48F3          13      LD  A,(MASTERS)
000DDF 4DDF 3224FB          13      LD  (DRVTBL+3),A
       4DE2                     DSKCHG1:
000DE2 4DE2 AF               4      XOR A
000DE3 4DE3 0601             7      LD  B,1
000DE5 4DE5 C9              10      RET
       4DE6                     NOTREADY:
000DE6 4DE6 3E02             7      LD  A,2
000DE8 4DE8 37               4      SCF
000DE9 4DE9 C9              10      RET
                                
       4DEA                     NO_BPB:
000DEA 4DEA E1              10      POP HL
000DEB 4DEB 23               6      INC HL
000DEC 4DEC 11494F          10      LD  DE,DPB2DD
000DEF 4DEF 011200          10      LD  BC,DPB2DD_E-DPB2DD
000DF2 4DF2 EDB0                    LDIR
000DF4 4DF4 AF               4      XOR A
000DF5 4DF5 C9              10      RET
                                
       4DF6                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000DF6 4DF6 CD224F          17      CALL    GET_DISK_BANK
                                
000DF9 4DF9 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000DFC 4DFC FE01             7      CP  1
000DFE 4DFE D8              11      RET C
                                
000DFF 4DFF 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000E02 4E02 C6FF             7      ADD A,0FFH
000E04 4E04 D8              11      RET C
                                
000E05 4E05 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
000E08 4E08 FE01             7      CP  1
000E0A 4E0A C8              11      RET Z
000E0B 4E0B FE02             7      CP  2
000E0D 4E0D C8              11      RET Z
000E0E 4E0E FE04             7      CP  4
000E10 4E10 C8              11      RET Z
000E11 4E11 37               4      SCF
000E12 4E12 C9              10      RET
                                
       4E13                     GETDPB:
000E13 4E13 E5              11      PUSH    HL
000E14 4E14 CD224F          17      CALL    GET_DISK_BANK
                                
000E17 4E17 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000E1A 4E1A B7               4      OR  A
000E1B 4E1B 28CD            12      JR  Z,NO_BPB
000E1D 4E1D DDE1            14      POP IX
000E1F 4E1F DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000E22 4E22 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000E25 4E25 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000E28 4E28 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000E2B 4E2B DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000E2E 4E2E 87               4      ADD A,A
000E2F 4E2F 87               4      ADD A,A
000E30 4E30 87               4      ADD A,A
000E31 4E31 3D               4      DEC A
000E32 4E32 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000E35 4E35 06FF             7      LD  B,-1
000E37 4E37 A7               4      AND A           ;無限ループ阻止
       4E38                     GETDPB1:
000E38 4E38 04               4      INC B
000E39 4E39 1F               4      RRA
000E3A 4E3A 38FC            12      JR  C,GETDPB1
000E3C 4E3C DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000E3F 4E3F 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000E42 4E42 3D               4      DEC A
000E43 4E43 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000E46 4E46 A7               4      AND A           ;無限ループ阻止
000E47 4E47 06FF             7      LD  B,-1
       4E49                     GETDPB2:
000E49 4E49 04               4      INC B
000E4A 4E4A 1F               4      RRA
000E4B 4E4B 38FC            12      JR  C,GETDPB2
000E4D 4E4D 04               4      INC B
000E4E 4E4E DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000E51 4E51 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
000E54 4E54 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
000E57 4E57 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
000E5A 4E5A 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
000E5D 4E5D DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000E60 4E60 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
000E63 4E63 DD770B          19      LD  (IX+11),A       ;FATCNT
                                
000E66 4E66 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
000E6A 4E6A DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
000E6D 4E6D DD460A          19      LD  B,(IX+10)       ;FATCNT
000E70 4E70 210000          10      LD  HL,0
       4E73                     GETDPB3:
000E73 4E73 19              11      ADD HL,DE
000E74 4E74 10FD            13      DJNZ    GETDPB3
       4E76                     GETDPB4:
000E76 4E76 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
000E79 4E79 DD5609          19      LD  D,(IX+9)        ;FIRFAT
000E7C 4E7C 19              11      ADD HL,DE
000E7D 4E7D DD7511          19      LD  (IX+17),L       ;FIRDIR
000E80 4E80 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000E83 4E83 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000E86 4E86 87               4      ADD A,A
000E87 4E87 87               4      ADD A,A
000E88 4E88 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4E8B                     GETDPB5:
000E8B 4E8B CB3B             8      SRL E
000E8D 4E8D 1F               4      RRA
000E8E 4E8E 30FB            12      JR  NC,GETDPB5
000E90 4E90 1600             7      LD  D,0
000E92 4E92 19              11      ADD HL,DE
000E93 4E93 DD750C          19      LD  (IX+12),L       ;FIRREC
000E96 4E96 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000E99 4E99 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
000E9C 4E9C DD5E0C          19      LD  E,(IX+12)       ;FIRREC
000E9F 4E9F DD560D          19      LD  D,(IX+13)       ;FIRREC
000EA2 4EA2 A7               4      AND A
000EA3 4EA3 ED52            15      SBC HL,DE
                                
000EA5 4EA5 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
000EA8 4EA8 3C               4      INC A
000EA9 4EA9 37               4      SCF             ;無限ループ阻止
       4EAA                     GETDPB6:
000EAA 4EAA 1F               4      RRA
000EAB 4EAB 3806            12      JR  C,GETDPB7
000EAD 4EAD CB3C             8      SRL H
000EAF 4EAF CB1D             8      RR  L
000EB1 4EB1 18F7            12      JR  GETDPB6
       4EB3                     GETDPB7:
000EB3 4EB3 23               6      INC HL
000EB4 4EB4 DD750E          19      LD  (IX+14),L       ;MAXCLUS
000EB7 4EB7 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       4EBA                     GETDPBD1:
000EBA 4EBA DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000EBD 4EBD E6FC             7      AND 0FCH
000EBF 4EBF C8              11      RET Z
                                
000EC0 4EC0 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
000EC4 4EC4 37               4      SCF
000EC5 4EC5 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
000EC9 4EC9 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
000ECC 4ECC DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
000ED0 4ED0 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
000ED4 4ED4 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
000ED8 4ED8 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
000EDC 4EDC DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
000EE0 4EE0 DDCB1126        23      SLA (IX+17)         ;FIRDIR
000EE4 4EE4 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
000EE8 4EE8 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
000EEB 4EEB DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
000EEE 4EEE DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000EF1 4EF1 87               4      ADD A,A
000EF2 4EF2 87               4      ADD A,A
000EF3 4EF3 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4EF6                     GETDPBD5:
000EF6 4EF6 CB3B             8      SRL E
000EF8 4EF8 1F               4      RRA
000EF9 4EF9 30FB            12      JR  NC,GETDPBD5
000EFB 4EFB 1600             7      LD  D,0
000EFD 4EFD 19              11      ADD HL,DE
000EFE 4EFE DD750C          19      LD  (IX+12),L       ;FIRREC
000F01 4F01 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000F04 4F04 18B4            12      JR  GETDPBD1
                                
       4F06                     CHOICE:
000F06 4F06 210000          10      LD  HL,0
000F09 4F09 C9              10      RET
                                
       4F0A                     DSKFMT:
000F0A 4F0A AF               4      XOR A
000F0B 4F0B 37               4      SCF
       4F0C                     DSKSTP:
000F0C 4F0C C9              10      RET
                                
       4F0D                     BASENT:
000F0D 4F0D ED7B5FF1        20      LD  SP,(BASSTK)
000F11 4F11 C3D643          10      JP  BASAUTO
                                
       4F14                     GETSLT:
000F14 4F14 3A22FB          13      LD  A,(DRVTBL+1)
000F17 4F17 C9              10      RET
                                
       4F18                     GET_DISK_BANK_FDRV:
000F18 4F18 3A53F1          13      LD  A,(FDRV)
000F1B 4F1B D601             7      SUB 1
000F1D 4F1D 3003            12      JR  NC,GET_DISK_BANK
000F1F 4F1F 3A4AF1          13      LD  A,(_DVSW)
       4F22                     GET_DISK_BANK:
000F22 4F22 B7               4      OR  A       ;A=DRIVE
000F23 4F23 3E01             7      LD  A,DISK_BANK
000F25 4F25 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
000F27 4F27 3A49F1          13      LD  A,(B_DRIVE)
                                #endif
       4F2A                     SET_DISK_BANK:
000F2A 4F2A 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000F2D 4F2D 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000F30 4F30 F5              11      PUSH    AF
000F31 4F31 E5              11      PUSH    HL
000F32 4F32 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
000F35 4F35 2223F1          16      LD  (SECSZ),HL
000F38 4F38 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000F3B 4F3B CD444F          17      CALL    MUL_AHL
000F3E 4F3E 2221F1          16      LD  (CLSZ),HL
000F41 4F41 E1              10      POP HL
000F42 4F42 F1              10      POP AF
000F43 4F43 C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)
       4F44                     MUL_AHL:
000F44 4F44 1F               4      RRA     ;->CF
000F45 4F45 D8              11      RET C
000F46 4F46 29              11      ADD HL,HL
000F47 4F47 18FB            12      JR  MUL_AHL
                                
       4F49                     DPB2DD:
000F49 4F49 F9                      DB  0F9H    ;MEDIA
000F4A 4F4A 0002                    DW  00200H  ;SECSIZ
000F4C 4F4C 0F                      DB  00FH    ;DIRMSK
000F4D 4F4D 04                      DB  004H    ;DIRSHFT
000F4E 4F4E 01                      DB  001H    ;CLUSMSK
000F4F 4F4F 02                      DB  002H    ;CLUSSHFT
000F50 4F50 0100                    DW  00001H  ;FIRFAT
000F52 4F52 02                      DB  002H    ;FATCNT
000F53 4F53 70                      DB  070H    ;MAXENT
000F54 4F54 0E00                    DW  0000EH  ;FIRREC
000F56 4F56 CA02                    DW  002CAH  ;MAXCLUS
000F58 4F58 03                      DB  003H    ;FATSIZ
000F59 4F59 0700                    DW  0007H   ;FIRDIR
       4F5B                     DPB2DD_E:
                                
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       4F5B                     POP_HL_ERROR:
000F5B 4F5B E1              10      POP     HL
       4F5C                     _ERROR:
000F5C 4F5C 0600             7      LD  B,0
000F5E 4F5E A7               4      AND A
000F5F 4F5F C9              10      RET
                                
       4F60                     ROM_BDOS:
000F60 4F60 E5              11      PUSH    HL
000F61 4F61 79               4      LD  A,C
000F62 4F62 87               4      ADD A,A
000F63 4F63 38F7            12      JR  C,_ERROR
000F65 4F65 6F               4      LD  L,A
000F66 4F66 265F             7      LD  H,high STABLE
000F68 4F68 7E               7      LD  A,(HL)
000F69 4F69 2C               4      INC L
000F6A 4F6A 66               7      LD  H,(HL)
000F6B 4F6B 6F               4      LD  L,A
000F6C 4F6C E3              19      EX  (SP),HL
000F6D 4F6D 79               4      LD  A,C
000F6E 4F6E C9              10      RET
                                
       4F6F                     _PRINT:
       4F6F                     PRINT:
000F6F 4F6F 7B               4      LD  A,E
000F70 4F70 1803            12      JR  MSG_A
                                
       4F72                     _SYS01:     ;(BDOS)コンソール入力
000F72 4F72 CDE94F          17      CALL    _SYS07
       4F75                     MSG_A:
000F75 4F75 FE03             7      CP  3
000F77 4F77 2814            12      JR  Z,MSG_BR
       4F79                     MSGA1:
000F79 4F79 F5              11      PUSH    AF
000F7A 4F7A C5              11      PUSH    BC
000F7B 4F7B D5              11      PUSH    DE
000F7C 4F7C E5              11      PUSH    HL
000F7D 4F7D DDE5            15      PUSH    IX
000F7F 4F7F DD21A200        14      LD  IX,CHPUT
000F83 4F83 CDFD42          17      CALL    CALSLT_R
000F86 4F86 DDE1            14      POP IX
000F88 4F88 E1              10      POP HL
000F89 4F89 D1              10      POP DE
000F8A 4F8A C1              10      POP BC
       4F8B                     MSGA2:
000F8B 4F8B F1              10      POP AF
000F8C 4F8C C9              10      RET
       4F8D                     MSG_BR:
000F8D 4F8D F5              11      PUSH    AF
000F8E 4F8E 3ADDF3          13      LD  A,(CSRX)
000F91 4F91 FE02             7      CP  2
000F93 4F93 38F6            12      JR  C,MSGA2
000F95 4F95 F1              10      POP AF
       4F96                     MSG_CR:
000F96 4F96 F5              11      PUSH    AF
000F97 4F97 3E0D             7      LD  A,00DH
000F99 4F99 CD794F          17      CALL    MSGA1
000F9C 4F9C 3E0A             7      LD  A,00AH
000F9E 4F9E CD794F          17      CALL    MSGA1
000FA1 4FA1 F1              10      POP AF
000FA2 4FA2 C9              10      RET
                                
       4FA3                     _SYS02:     ;(BDOS)コンソール出力
000FA3 4FA3 CDBE4F          17      CALL    BREAK
000FA6 4FA6 1805            12      JR  PRINTX
                                
       4FA8                     _SYS06:     ;(BDOS)コンソール直接入出力
000FA8 4FA8 7B               4      LD  A,E
000FA9 4FA9 3C               4      INC A
000FAA 4FAA CAFD4F          10      JP  Z,_INKEY
       4FAD                     PRINTX:
000FAD 4FAD C36F4F          10      JP  _PRINT
                                
       4FB0                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000FB0 4FB0 CDE94F          17      CALL    _SYS07
000FB3 4FB3 FE03             7      CP  3
000FB5 4FB5 CCBE4F          17      CALL    Z,_BREAK
000FB8 4FB8 FE13             7      CP  013H        ;CTRL+S
000FBA 4FBA C0              11      RET NZ
       4FBB                     PAUSE:
000FBB 4FBB CDD54F          17      CALL    KEYBC
                                
       4FBE                     _BREAK:
       4FBE                     BREAK:
000FBE 4FBE F5              11      PUSH    AF
000FBF 4FBF C5              11      PUSH    BC
000FC0 4FC0 D5              11      PUSH    DE
000FC1 4FC1 E5              11      PUSH    HL
000FC2 4FC2 DDE5            15      PUSH    IX
000FC4 4FC4 DD21B700        14      LD  IX,BREAKX
000FC8 4FC8 CDFD42          17      CALL    CALSLT_R
000FCB 4FCB DDE1            14      POP IX
000FCD 4FCD E1              10      POP HL
000FCE 4FCE D1              10      POP DE
000FCF 4FCF C1              10      POP BC
000FD0 4FD0 DCBE4F          17      CALL    C,_BREAK
000FD3 4FD3 F1              10      POP AF
000FD4 4FD4 C9              10      RET
       4FD5                     KEYBC:
000FD5 4FD5 F5              11      PUSH    AF
000FD6 4FD6 C5              11      PUSH    BC
000FD7 4FD7 D5              11      PUSH    DE
000FD8 4FD8 E5              11      PUSH    HL
000FD9 4FD9 DDE5            15      PUSH    IX
000FDB 4FDB DD215601        14      LD  IX,KILBUF
000FDF 4FDF CDFD42          17      CALL    CALSLT_R
000FE2 4FE2 DDE1            14      POP IX
000FE4 4FE4 E1              10      POP HL
000FE5 4FE5 D1              10      POP DE
000FE6 4FE6 C1              10      POP BC
000FE7 4FE7 F1              10      POP AF
000FE8 4FE8 C9              10      RET
                                
       4FE9                     _SYS07:
       4FE9                     FLGET:
000FE9 4FE9 C5              11      PUSH    BC
000FEA 4FEA D5              11      PUSH    DE
000FEB 4FEB E5              11      PUSH    HL
000FEC 4FEC DDE5            15      PUSH    IX
000FEE 4FEE DD219F00        14      LD  IX,CHGET
000FF2 4FF2 CDFD42          17      CALL    CALSLT_R
000FF5 4FF5 DDE1            14      POP IX
000FF7 4FF7 E1              10      POP HL
000FF8 4FF8 D1              10      POP DE
000FF9 4FF9 C1              10      POP BC
000FFA 4FFA FE03             7      CP  3
000FFC 4FFC C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       4FFD                     _INKEY:
       4FFD                     INKEY:
000FFD 4FFD CD9750          17      CALL    CPM_CONST
001000 5000 C8              11      RET Z
001001 5001 18E6            12      JR  FLGET
                                
       5003                     _SYS0A:     ;(BDOS)文字列入力
001003 5003 C5              11      PUSH    BC
001004 5004 E5              11      PUSH    HL
001005 5005 D5              11      PUSH    DE
001006 5006 CD2F50          17      CALL    GETL
001009 5009 111FF4          10      LD  DE,KBUF
00100C 500C E1              10      POP HL
00100D 500D E5              11      PUSH    HL
00100E 500E 0E00             7      LD  C,0
001010 5010 3004            12      JR  NC,SAX0
001012 5012 23               6      INC HL
001013 5013 23               6      INC HL
001014 5014 1808            12      JR  SAX4
       5016                     SAX0:
001016 5016 46               7      LD  B,(HL)
001017 5017 23               6      INC HL
       5018                     SAX1:
001018 5018 23               6      INC HL
001019 5019 1A               7      LD  A,(DE)
00101A 501A 13               6      INC DE
00101B 501B B7               4      OR  A
00101C 501C 2004            12      JR  NZ,SAX2
       501E                     SAX4:
00101E 501E 360D            10      LD  (HL),00DH
001020 5020 1804            12      JR  SAX3
       5022                     SAX2:
001022 5022 77               7      LD  (HL),A
001023 5023 0C               4      INC C
001024 5024 10F2            13      DJNZ    SAX1
       5026                     SAX3:
001026 5026 D1              10      POP DE
001027 5027 79               4      LD  A,C
001028 5028 13               6      INC DE
001029 5029 12               7      LD  (DE),A
00102A 502A 1B               6      DEC DE
00102B 502B E1              10      POP HL
00102C 502C C1              10      POP BC
00102D 502D A7               4      AND A
00102E 502E C9              10      RET
       502F                     GETL:
00102F 502F DDE5            15      PUSH    IX
001031 5031 FDE5            15      PUSH    IY
                                
001033 5033 2ADCF3          16      LD  HL,(CSRY)
001036 5036 22CAFB          16      LD  (FSTPOS),HL
       5039                     GETL1:
001039 5039 CDB04F          17      CALL    _SYS08
00103C 503C FE09             7      CP  9
00103E 503E 2008            12      JR  NZ,GETL1V
001040 5040 211FF4          10      LD  HL,KBUF
001043 5043 CD8843          17      CALL    MSX
001046 5046 18F1            12      JR  GETL1
       5048                     GETL1V:
001048 5048 5F               4      LD  E,A
001049 5049 FE08             7      CP  8
00104B 504B CCE550          17      CALL    Z,CTRL02
00104E 504E FE20             7      CP  020H
001050 5050 D41151          17      CALL    NC,INSERT
001053 5053 CD794F          17      CALL    MSGA1
                                
001056 5056 7B               4      LD  A,E
001057 5057 FE0D             7      CP  00DH
001059 5059 20DE            12      JR  NZ,GETL1
                                
00105B 505B 111FF4          10      LD  DE,KBUF
00105E 505E 3AB0F3          13      LD  A,(LINLEN)
001061 5061 47               4      LD  B,A
001062 5062 CDC452          17      CALL    ZERO_MEMORY_DE
                                
001065 5065 2ACAFB          16      LD  HL,(FSTPOS)
001068 5068 3ADCF3          13      LD  A,(CSRY)
00106B 506B 6F               4      LD  L,A
00106C 506C E5              11      PUSH    HL
00106D 506D CD4251          17      CALL    LOC0
001070 5070 4D               4      LD  C,L
001071 5071 44               4      LD  B,H
001072 5072 E1              10      POP HL
001073 5073 3AB0F3          13      LD  A,(LINLEN)
001076 5076 94               4      SUB H
001077 5077 3D               4      DEC A
001078 5078 5F               4      LD  E,A
001079 5079 211FF4          10      LD  HL,KBUF
       507C                     GETL2:
00107C 507C CDD550          17      CALL    _SCRN
00107F 507F 03               6      INC BC
001080 5080 77               7      LD  (HL),A
001081 5081 23               6      INC HL
001082 5082 1D               4      DEC E
001083 5083 20F7            12      JR  NZ,GETL2
001085 5085 CD964F          17      CALL    MSG_CR
                                
001088 5088 FDE1            14      POP IY
00108A 508A DDE1            14      POP IX
       508C                     GETL3:
00108C 508C 2B               6      DEC HL
00108D 508D 7E               7      LD  A,(HL)
00108E 508E FE21             7      CP  021H
001090 5090 D0              11      RET NC
001091 5091 3600            10      LD  (HL),0
001093 5093 15               4      DEC D
001094 5094 20F6            12      JR  NZ,GETL3
001096 5096 C9              10      RET
                                
       5097                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       5097                     CONSTX:
       5097                     CPM_CONST:
001097 5097 C5              11      PUSH    BC
001098 5098 D5              11      PUSH    DE
001099 5099 E5              11      PUSH    HL
00109A 509A DDE5            15      PUSH    IX
00109C 509C DD219C00        14      LD  IX,CHSNS
0010A0 50A0 CDFD42          17      CALL    CALSLT_R
0010A3 50A3 DDE1            14      POP IX
0010A5 50A5 E1              10      POP HL
0010A6 50A6 D1              10      POP DE
0010A7 50A7 C1              10      POP BC
0010A8 50A8 C9              10      RET
                                
       50A9                     _SYS2A:     ;(BDOS)日付の獲得
0010A9 50A9 AF               4      XOR A
0010AA 50AA 57               4      LD  D,A
0010AB 50AB 5F               4      LD  E,A
0010AC 50AC 67               4      LD  H,A
0010AD 50AD 6F               4      LD  L,A
0010AE 50AE C9              10      RET
                                
       50AF                     _SYS2C:     ;(BDOS)時刻の獲得
0010AF 50AF AF               4      XOR A
0010B0 50B0 57               4      LD  D,A
0010B1 50B1 5F               4      LD  E,A
0010B2 50B2 67               4      LD  H,A
0010B3 50B3 6F               4      LD  L,A
0010B4 50B4 C9              10      RET
                                
       50B5                     POS:
0010B5 50B5 F5              11      PUSH    AF
0010B6 50B6 2ADCF3          16      LD  HL,(CSRY)
0010B9 50B9 7D               4      LD  A,L
0010BA 50BA 6C               4      LD  L,H
0010BB 50BB 67               4      LD  H,A
0010BC 50BC 2C               4      INC L
0010BD 50BD 24               4      INC H
0010BE 50BE F1              10      POP AF
0010BF 50BF C9              10      RET
                                
       50C0                     LOC:
0010C0 50C0 F5              11      PUSH    AF
0010C1 50C1 E5              11      PUSH    HL
0010C2 50C2 7D               4      LD  A,L
0010C3 50C3 6C               4      LD  L,H
0010C4 50C4 67               4      LD  H,A
0010C5 50C5 2D               4      DEC L
0010C6 50C6 25               4      DEC H
0010C7 50C7 DDE5            15      PUSH    IX
0010C9 50C9 DD21C600        14      LD  IX,POSIT
0010CD 50CD CDFD42          17      CALL    CALSLT_R
0010D0 50D0 DDE1            14      POP IX
0010D2 50D2 E1              10      POP HL
0010D3 50D3 F1              10      POP AF
0010D4 50D4 C9              10      RET
                                
       50D5                     _SCRN:
       50D5                     SCRN:
0010D5 50D5 E5              11      PUSH    HL
0010D6 50D6 DDE5            15      PUSH    IX
                                
0010D8 50D8 69               4      LD  L,C
0010D9 50D9 60               4      LD  H,B
0010DA 50DA DD214A00        14      LD  IX,RDVRM
0010DE 50DE CDFD42          17      CALL    CALSLT_R
                                
0010E1 50E1 DDE1            14      POP IX
0010E3 50E3 E1              10      POP HL
0010E4 50E4 C9              10      RET
                                
       50E5                     CTRL02:
0010E5 50E5 F5              11      PUSH    AF
0010E6 50E6 D5              11      PUSH    DE
0010E7 50E7 2ADCF3          16      LD  HL,(CSRY)
0010EA 50EA 3AB0F3          13      LD  A,(LINLEN)
0010ED 50ED 4F               4      LD  C,A
0010EE 50EE 94               4      SUB H   ;CSRX
0010EF 50EF C602             7      ADD A,2
0010F1 50F1 47               4      LD  B,A ;カーソルより右の文字数
0010F2 50F2 61               4      LD  H,C ;LINLEN
0010F3 50F3 C5              11      PUSH    BC
0010F4 50F4 CD4251          17      CALL    LOC0
0010F7 50F7 C1              10      POP BC
                                
0010F8 50F8 1620             7      LD  D,020H
       50FA                     C8X1:
0010FA 50FA DD214A00        14      LD  IX,RDVRM
0010FE 50FE CDFD42          17      CALL    CALSLT_R
001101 5101 4F               4      LD  C,A
001102 5102 7A               4      LD  A,D
001103 5103 DD214D00        14      LD  IX,WRTVRM
001107 5107 CDFD42          17      CALL    CALSLT_R
00110A 510A 2B               6      DEC HL
00110B 510B 51               4      LD  D,C
00110C 510C 10EC            13      DJNZ    C8X1
00110E 510E D1              10      POP DE
00110F 510F F1              10      POP AF
001110 5110 C9              10      RET
                                
       5111                     INSERT:
001111 5111 F5              11      PUSH    AF
001112 5112 D5              11      PUSH    DE
001113 5113 2ADCF3          16      LD  HL,(CSRY)
001116 5116 3AB0F3          13      LD  A,(LINLEN)
001119 5119 4F               4      LD  C,A
00111A 511A 94               4      SUB H   ;CSRX
00111B 511B 3C               4      INC A
00111C 511C 47               4      LD  B,A ;カーソルより右の文字数
00111D 511D C5              11      PUSH    BC
00111E 511E CD4251          17      CALL    LOC0
001121 5121 C1              10      POP BC
                                
001122 5122 1620             7      LD  D,020H
       5124                     INS1:
001124 5124 DD214A00        14      LD  IX,RDVRM
001128 5128 CDFD42          17      CALL    CALSLT_R
00112B 512B 4F               4      LD  C,A
00112C 512C 7A               4      LD  A,D
00112D 512D DD214D00        14      LD  IX,WRTVRM
001131 5131 CDFD42          17      CALL    CALSLT_R
001134 5134 23               6      INC HL
001135 5135 51               4      LD  D,C
001136 5136 10EC            13      DJNZ    INS1
001138 5138 D1              10      POP DE
001139 5139 F1              10      POP AF
00113A 513A C9              10      RET
                                
       513B                     CONOUT1:
00113B 513B 59               4      LD  E,C
00113C 513C C36F4F          10      JP  _PRINT
                                
       513F                     GETVRAM:
00113F 513F 2ADCF3          16      LD  HL,(CSRY)
       5142                     LOC0:
001142 5142 2D               4      DEC L
001143 5143 25               4      DEC H
001144 5144 4C               4      LD  C,H ;CSRX-1
001145 5145 5D               4      LD  E,L ;CSRY-1
       5146                     LOC1:
001146 5146 3AB0F3          13      LD  A,(LINLEN)
001149 5149 67               4      LD  H,A
00114A 514A 1600             7      LD  D,0
00114C 514C 6A               4      LD  L,D ;0
00114D 514D 0608             7      LD  B,8
       514F                     LOC2:
00114F 514F 29              11      ADD HL,HL
001150 5150 3001            12      JR  NC,LOC3
001152 5152 19              11      ADD HL,DE
       5153                     LOC3:
001153 5153 10FA            13      DJNZ    LOC2
001155 5155 09              11      ADD HL,BC
001156 5156 C9              10      RET
                                
       5157                     _SYS0C:     ;(BDOS)バージョン番号の獲得
001157 5157 212200          10      LD  HL,00022H
00115A 515A AF               4      XOR A
00115B 515B 7D               4      LD  A,L
00115C 515C C9              10      RET
                                
       515D                     _SYS0D:     ;(BDOS)ディスク・リセット
00115D 515D 218000          10      LD  HL,00080H
001160 5160 222FF1          16      LD  (_DTA),HL
001163 5163 C9              10      RET
                                
       5164                     _SYS0E:     ;(BDOS)カレントドライブの設定
001164 5164 324AF1          13      LD  (_DVSW),A
001167 5167 C9              10      RET
                                
       5168                     _SYS0F:     ;(BDOS)ファイルのオープン
001168 5168 D5              11      PUSH    DE
001169 5169 FDE1            14      POP IY
00116B 516B CDB152          17      CALL    INIT_FILE
00116E 516E CDF94A          17      CALL    ROM_OPEN
001171 5171 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
001173 5173 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
001177 5177 FDE5            15      PUSH    IY
001179 5179 D1              10      POP DE
00117A 517A 13               6      INC DE
00117B 517B 010B00          10      LD  BC,11
00117E 517E EDB0                    LDIR
                                ;               Attribute
001180 5180 7E               7      LD  A,(HL)
001181 5181 FD770D          19      LD  (IY+13),A
                                ;               TIME
001184 5184 110B00          10      LD  DE,11
001187 5187 19              11      ADD HL,DE
001188 5188 7E               7      LD  A,(HL)
001189 5189 23               6      INC HL
00118A 518A FD7716          19      LD  (IY+22),A
00118D 518D 7E               7      LD  A,(HL)
00118E 518E 23               6      INC HL
00118F 518F FD7717          19      LD  (IY+23),A
                                ;               DATE
001192 5192 7E               7      LD  A,(HL)
001193 5193 23               6      INC HL
001194 5194 FD7714          19      LD  (IY+20),A
001197 5197 7E               7      LD  A,(HL)
001198 5198 23               6      INC HL
001199 5199 FD7715          19      LD  (IY+21),A
                                ;               First cluster
00119C 519C 7E               7      LD  A,(HL)
00119D 519D 23               6      INC HL
00119E 519E FD771A          19      LD  (IY+26),A
0011A1 51A1 7E               7      LD  A,(HL)
0011A2 51A2 23               6      INC HL
0011A3 51A3 FD771B          19      LD  (IY+27),A
                                ;               SIZE
0011A6 51A6 7E               7      LD  A,(HL)
0011A7 51A7 23               6      INC HL
0011A8 51A8 FD7710          19      LD  (IY+16),A
0011AB 51AB 7E               7      LD  A,(HL)
0011AC 51AC 23               6      INC HL
0011AD 51AD FD7711          19      LD  (IY+17),A
0011B0 51B0 7E               7      LD  A,(HL)
0011B1 51B1 23               6      INC HL
0011B2 51B2 FD7712          19      LD  (IY+18),A
0011B5 51B5 7E               7      LD  A,(HL)
0011B6 51B6 FD7713          19      LD  (IY+19),A
0011B9 51B9 AF               4      XOR A
0011BA 51BA FD770C          19      LD  (IY+12),A
0011BD 51BD C9              10      RET
                                
       51BE                     _SYS10:     ;(BDOS)ファイルのクローズ
0011BE 51BE AF               4      XOR A
0011BF 51BF C9              10      RET
                                
       51C0                     S11X1:
0011C0 51C0 FD7119          19      LD  (IY+25),C       ;RootEntCnt
0011C3 51C3 FD750E          19      LD  (IY+14),L
0011C6 51C6 FD740F          19      LD  (IY+15),H
       51C9                     SCF_FF_RET:
0011C9 51C9 37               4      SCF
0011CA 51CA 9F               4      SBC A,A
0011CB 51CB C9              10      RET
                                
       51CC                     _SYS11:     ;(BDOS)最初のファイルの検索
0011CC 51CC ED5337F1        20      LD  (_FCB),DE
0011D0 51D0 D5              11      PUSH    DE
0011D1 51D1 FDE1            14      POP IY
0011D3 51D3 CDB152          17      CALL    INIT_FILE
0011D6 51D6 CD414D          17      CALL    GET_DIR_DAT
       51D9                     S12X1:
0011D9 51D9 CD154B          17      CALL    FILESE
0011DC 51DC 30E2            12      JR  NC,S11X1
0011DE 51DE 0D               4      DEC C
0011DF 51DF FD7119          19      LD  (IY+25),C       ;RootEntCnt
0011E2 51E2 012000          10      LD  BC,32
0011E5 51E5 ED5B2FF1        20      LD  DE,(_DTA)
0011E9 51E9 AF               4      XOR A
0011EA 51EA 12               7      LD  (DE),A      ;ドライブ番号
0011EB 51EB 13               6      INC DE
0011EC 51EC EDB0                    LDIR            ;ディレクトリエントリ
0011EE 51EE FD750E          19      LD  (IY+14),L
0011F1 51F1 FD740F          19      LD  (IY+15),H
0011F4 51F4 C9              10      RET
                                
       51F5                     _SYS12:
0011F5 51F5 FD2A37F1        20      LD  IY,(_FCB)
0011F9 51F9 FDE5            15      PUSH    IY
0011FB 51FB D1              10      POP DE
0011FC 51FC CDB152          17      CALL    INIT_FILE
                                
0011FF 51FF FD6E0E          19      LD  L,(IY+14)
001202 5202 FD660F          19      LD  H,(IY+15)
001205 5205 FD4E19          19      LD  C,(IY+25)
001208 5208 18CF            12      JR  S12X1
                                
       520A                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
00120A 520A CD274D          17      CALL    SET_FCB
00120D 520D CDF54C          17      CALL    GETSEQ
001210 5210 CDE24C          17      CALL    RB_READ
001213 5213 E5              11      PUSH    HL
001214 5214 CD024D          17      CALL    SETSEQ
001217 5217 E1              10      POP HL
       5218                     SREAD:
001218 5218 C601             7      ADD A,001H
00121A 521A D8              11      RET C
                                
00121B 521B 7D               4      LD  A,L
00121C 521C D601             7      SUB 001H
00121E 521E 9F               4      SBC A,A
00121F 521F E603             7      AND 3
001221 5221 1F               4      RRA
001222 5222 C9              10      RET
                                
       5223                     _SYS18:     ;(BDOS)ログインベクトルの獲得
001223 5223 210100          10      LD  HL,00001H
001226 5226 AF               4      XOR A
001227 5227 C9              10      RET
                                
       5228                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
001228 5228 3A4AF1          13      LD  A,(_DVSW)
00122B 522B C9              10      RET
                                
       522C                     _SYS1A:     ;(BDOS)DTAの設定
00122C 522C ED532FF1        20      LD  (_DTA),DE
001230 5230 AF               4      XOR A
001231 5231 C9              10      RET
                                
       5232                     _SYS1B:     ;(BDOS)ディスク情報の獲得
001232 5232 010002          10      LD  BC,512
001235 5235 11C302          10      LD  DE,707
001238 5238 210000          10      LD  HL,0
00123B 523B DD2139F1        14      LD  IX,_BUF
00123F 523F FD2139F1        14      LD  IY,_BUF
001243 5243 FD3600F9        19      LD  (IY+0),0F9H
001247 5247 3E02             7      LD  A,2
001249 5249 C9              10      RET
                                
       524A                     _SYS21:     ;(BDOS)ランダムな読み出し
00124A 524A CD274D          17      CALL    SET_FCB
                                
00124D 524D FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001250 5250 FD6622          19      LD  H,(IY+34)
                                
001253 5253 CDE24C          17      CALL    RB_READ
001256 5256 18C0            12      JR  SREAD
                                
       5258                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
001258 5258 CD6851          17      CALL    _SYS0F
00125B 525B D8              11      RET C
                                
00125C 525C D5              11      PUSH    DE      ;EX DE,IY
00125D 525D FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00125F 525F CD174D          17      CALL    GETSIZE
       5262                     _S24X1:
001262 5262 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001265 5265 FD7422          19      LD  (IY+34),H
001268 5268 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
00126C 526C FDE3            23      EX  (SP),IY     ;
00126E 526E D1              10      POP DE      ;
                                
00126F 526F AF               4      XOR A
001270 5270 C9              10      RET
                                
       5271                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
001271 5271 E5              11      PUSH    HL
001272 5272 D5              11      PUSH    DE      ;EX DE,IY
001273 5273 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001275 5275 CDF54C          17      CALL    GETSEQ
001278 5278 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       527A                     _SYS27:     ;(BDOS)ランダムブロック読み込み
00127A 527A CD274D          17      CALL    SET_FCB
00127D 527D E5              11      PUSH    HL
00127E 527E FD6E21          19      LD  L,(IY+33)
001281 5281 FD6622          19      LD  H,(IY+34)
001284 5284 2225F1          16      LD  (RR_LOW),HL
001287 5287 FD6E23          19      LD  L,(IY+35)
00128A 528A FD6624          19      LD  H,(IY+36)
00128D 528D 2227F1          16      LD  (RR_HIGH),HL
001290 5290 E1              10      POP HL
001291 5291 CD1549          17      CALL    ROM_READ
001294 5294 ED5B25F1        20      LD  DE,(RR_LOW)
001298 5298 FD7321          19      LD  (IY+33),E
00129B 529B FD7222          19      LD  (IY+34),D
00129E 529E ED5B27F1        20      LD  DE,(RR_HIGH)
0012A2 52A2 FD7323          19      LD  (IY+35),E
0012A5 52A5 FD7224          19      LD  (IY+36),D
0012A8 52A8 9F               4      SBC A,A
0012A9 52A9 C9              10      RET
                                
       52AA                     _SYS2F:
0012AA 52AA 44               4      LD  B,H
0012AB 52AB 2A2FF1          16      LD  HL,(_DTA)
0012AE 52AE C3834D          10      JP  DISKIO
                                
       52B1                     INIT_FILE:
0012B1 52B1 EB               4      EX  DE,HL
0012B2 52B2 1153F1          10      LD  DE,FDRV
0012B5 52B5 010C00          10      LD  BC,1+8+3
0012B8 52B8 EDB0                    LDIR
0012BA 52BA CD184F          17      CALL    GET_DISK_BANK_FDRV
0012BD 52BD 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0012C0 52C0 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0012C3 52C3 C9              10      RET
                                
       52C4                     ZERO_MEMORY_DE:
0012C4 52C4 AF               4      XOR A
       52C5                     FILL_MEMORY_DE:
0012C5 52C5 12               7      LD  (DE),A
0012C6 52C6 13               6      INC DE
0012C7 52C7 10FC            13      DJNZ    FILL_MEMORY_DE
0012C9 52C9 C9              10      RET
                                
0012CA 52CA                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 5C4F724FA34F5C4F        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 5C4F5C4FA84FE94F        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 B04F5C4F03509750        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 57515D5164516851        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 BE51CC51F5515C4F        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 0A525C4F5C4F5C4F        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 235228522C523252        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 5C4F5C4F5C4F5852        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 71525C4F5C4F7A52        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 5C4F5C4FA9505C4F        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 AF505C4F5C4FAA52        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB8 5FB8 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 5C4F5C4F5C4F5C4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
