                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       269A                     DECADD  EQU 0269AH
       27E6                     DECMUL  EQU 027E6H
       2F8A                     FRCINT  EQU 02F8AH
                                
       303A                     FRCDBL  EQU 0303AH
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F847                     ARG EQU 0F847H
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FDDB                     H_PINL  EQU 0FDDBH
                                
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                            ;ASCII-16K
                                ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
                                ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
       F280                     ISC EQU 0F280H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F280                     SP32    EQU 0F280H
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM    ; Main program execution address.
000004 4004 664E                    DW  STATEMENT   ; STATEMENT
000006 4006 834F                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C3D450          10      JP  DISKIO
000013 4013 C30F51          10      JP  DSKCHG
000016 4016 C36551          10      JP  GETDPB
000019 4019 C35852          10      JP  CHOICE
00001C 401C C35C52          10      JP  DSKFMT
00001F 401F C35E52          10      JP  DSKSTP
000022 4022 C35F52          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C35C52          10      JP  DSKFMT
000029 4029 C35E52          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C39852          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.4.2.2",0
            204449534B20524F    
            4D204C6974652076    
            302E342E322E3200    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 AF               4      XOR A
000107 4107 2100F3          10      LD  HL,0F300H
00010A 410A 0668             7      LD  B,068H
00010C 410C CD1A4B          17      CALL    FILL_MEMORY
                                
00010F 410F 3E01             7      LD  A,1
000111 4111 3221FB          13      LD  (DRVTBL),A
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  HL,(STKTOP) ;起動時の空き容量表示の為
                                    LD  BC,-00140H
                                    ADD HL,BC
                                    LD  (STKTOP),HL
                                #else
000114 4114 2175F6          10      LD  HL,STKTOP+1 ;起動時の空き容量表示の為
000117 4117 35              11      DEC (HL)
                                #endif
                                
000118 4118 AF               4      XOR A
000119 4119 32EAF2          13      LD  (_DVSW),A
00011C 411C 3D               4      DEC A       ;0FFH
00011D 411D 3299FD          13      LD  (DEVICE),A
                                
000120 4120 21E342          10      LD  HL,AT_ISC
000123 4123 1180F2          10      LD  DE,ISC
000126 4126 018800          10      LD  BC,ISC_E-ISC
000129 4129 EDB0                    LDIR
                                    
00012B 412B 3EC3             7      LD  A,0C3H      ;JP
00012D 412D 3243FF          13      LD  (H_GONE),A
000130 4130 327DF3          13      LD  (BDOS),A
000133 4133 326BF3          13      LD  (RAMUSE),A
000136 4136 3268F3          13      LD  (ROMUSE),A
000139 4139 2180F2          10      LD  HL,REPLACE_COMMAND
00013C 413C 2244FF          16      LD  (H_GONE+1),HL
00013F 413F 2131F3          10      LD  HL,H_BDOS
000142 4142 227EF3          16      LD  (BDOS+1),HL
000145 4145 21ABF2          10      LD  HL,RAMUSE1
000148 4148 226CF3          16      LD  (RAMUSE+1),HL
00014B 414B 21BEF2          10      LD  HL,ROMUSE1
00014E 414E 2269F3          16      LD  (ROMUSE+1),HL
                                
000151 4151 3E                      DB  03EH
000152 4152 F7              12      RST 30H
000153 4153 3271FE          13      LD  (H_BINS),A
000156 4156 3276FE          13      LD  (H_BINL),A
000159 4159 327BFE          13      LD  (H_FILE),A
00015C 415C 3231F3          13      LD  (H_BDOS),A
00015F 415F 32DBFD          13      LD  (H_PINL),A
000162 4162 32A7FF          13      LD  (H_PHYD),A
                                
000165 4165 CD2F42          17      CALL    GTSL1_
000168 4168 3297F2          13      LD  (ROM_SLT),A
00016B 416B 32A7F2          13      LD  (ROM_SLT_COPY),A
00016E 416E 3272FE          13      LD  (H_BINS+1),A
000171 4171 3277FE          13      LD  (H_BINL+1),A
000174 4174 327CFE          13      LD  (H_FILE+1),A
000177 4177 3232F3          13      LD  (H_BDOS+1),A
00017A 417A 32DCFD          13      LD  (H_PINL+1),A
00017D 417D 32A8FF          13      LD  (H_PHYD+1),A
000180 4180 3222FB          13      LD  (DRVTBL+1),A
000183 4183 3248F3          13      LD  (MASTERS),A
                                
000186 4186 211D45          10      LD  HL,ROM_LOAD
000189 4189 2273FE          16      LD  (H_BINS+2),HL
00018C 418C 21CE46          10      LD  HL,ROM_RUN
00018F 418F 2278FE          16      LD  (H_BINL+2),HL
000192 4192 21DC46          10      LD  HL,ROM_FILES
000195 4195 227DFE          16      LD  (H_FILE+2),HL
000198 4198 210053          10      LD  HL,ROM_BDOS
00019B 419B 2233F3          16      LD  (H_BDOS+2),HL
00019E 419E 21A643          10      LD  HL,ROM_BOOT
0001A1 41A1 22DDFD          16      LD  (H_PINL+2),HL
0001A4 41A4 21D450          10      LD  HL,DISKIO
0001A7 41A7 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001AA 41AA 3E                      DB  03EH
0001AB 41AB C9              10      RET
0001AC 41AC 327FFE          13      LD  (H_FILE+4),A
0001AF 41AF 3275FE          13      LD  (H_BINS+4),A
0001B2 41B2 327AFE          13      LD  (H_BINL+4),A
0001B5 41B5 3235F3          13      LD  (H_BDOS+4),A
0001B8 41B8 32DFFD          13      LD  (H_PINL+4),A
0001BB 41BB 32ABFF          13      LD  (H_PHYD+4),A
                                
0001BE 41BE AF               4      XOR A
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK0_SEL),A       ;似非RAM対策でバンク0を設定
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0001BF 41BF 320060          13      LD  (BANK0_SEL),A           ;似非RAM対策でバンク0を設定
0001C2 41C2 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001C5 41C5 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001C8 41C8 3A0060          13      LD  A,(BANK1_ADR)
0001CB 41CB FE41             7      CP  'A'
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JR  Z,NOT_BANK_TYPE
                                    LD  A,DISK_BANK
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0001CD 41CD 204F            12      JR  NZ,NOT_BANK_TYPE
0001CF 41CF 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001D2 41D2 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001D5 41D5 CD3801          17      CALL    RSLREG      ;read primary slot #
0001D8 41D8 07               4      RLCA
0001D9 41D9 07               4      RLCA
0001DA 41DA F5              11      PUSH    AF
0001DB 41DB 1605             7      LD  D,4+1
0001DD 41DD CD3642          17      CALL    GTSL2_
0001E0 41E0 3244F3          13      LD  (RAMAD3),A
0001E3 41E3 F1              10      POP AF
0001E4 41E4 07               4      RLCA
0001E5 41E5 07               4      RLCA
0001E6 41E6 1603             7      LD  D,2+1
0001E8 41E8 CD3642          17      CALL    GTSL2_
0001EB 41EB 2680             7      LD  H,080H
0001ED 41ED CD5342          17      CALL    CHK_RAM
0001F0 41F0 3243F3          13      LD  (RAMAD2),A
       41F3                     RAMCHK2:
0001F3 41F3 3A44F3          13      LD  A,(RAMAD3)
0001F6 41F6 2640             7      LD  H,040H
0001F8 41F8 CD5342          17      CALL    CHK_RAM
0001FB 41FB 3242F3          13      LD  (RAMAD1),A
       41FE                     RAMCHK1:
0001FE 41FE 3A44F3          13      LD  A,(RAMAD3)
000201 4201 2600             7      LD  H,00H
000203 4203 CD5342          17      CALL    CHK_RAM
000206 4206 3241F3          13      LD  (RAMAD0),A
       4209                     RAMCHK0:
000209 4209 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
00020C 420C 010F00          10      LD  BC,0000FH       ;切り上げ
00020F 420F 09              11      ADD HL,BC
000210 4210 7D               4      LD  A,L
                                
000211 4211 0604             7      LD  B,4
       4213                     B_DRIVE1:
000213 4213 CB3C             8      SRL H
000215 4215 1F               4      RRA
000216 4216 10FB            13      DJNZ    B_DRIVE1
                                
000218 4218 C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
00021A 421A 32E9F2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
00021D 421D C9              10      RET
                                
       421E                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
00021E 421E 21E943          10      LD  HL,MSG_ERROR_ROM_MODE
000221 4221 CD6E43          17      CALL    MSX
000224 4224 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000228 4228 DD219F00        14      LD  IX,CHGET
00022C 422C C31C00          10      JP  _CALSLT
                                
       422F                     GTSL1_:             ;自分のいるスロットを知る
00022F 422F CD3801          17      CALL    RSLREG      ;read primary slot #
000232 4232 0F               4      RRCA
000233 4233 0F               4      RRCA
000234 4234 1601             7      LD  D,1
       4236                     GTSL2_:
000236 4236 E603             7      AND 3       ;[A]=000000PP
000238 4238 5F               4      LD  E,A     ;[E]=000000PP
000239 4239 21C1FC          10      LD  HL,EXPTBL
00023C 423C 85               4      ADD A,L     ;桁上りは無い
00023D 423D 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
00023E 423E 7B               4      LD  A,E     ;[A]=000000PP
00023F 423F CB7E            13      BIT 7,(HL)
000241 4241 C8              11      RET Z
000242 4242 7D               4      LD  A,L     ;point to SLTTBL entry
000243 4243 C604             7      ADD A,4     ;桁上りは無い
000245 4245 6F               4      LD  L,A
000246 4246 7E               7      LD  A,(HL)      ;get currently expansion slot register
       4247                     GTSL3_:
000247 4247 15               4      DEC D
000248 4248 2803            12      JR  Z,GTSL4_:
00024A 424A 0F               4      RRCA
00024B 424B 18FA            12      JR  GTSL3_:
       424D                     GTSL4_:
00024D 424D E60C             7      AND 00CH        ;[A] = 0000SS00
00024F 424F B3               4      OR  E       ;[A] = 0000SSPP
000250 4250 F680             7      OR  080H        ;[A] = 1000SSPP
000252 4252 C9              10      RET
                                
       4253                     CHK_RAM:
000253 4253 E5              11      PUSH    HL
000254 4254 CDA842          17      CALL    CHK_RAM0
000257 4257 E1              10      POP HL
000258 4258 C8              11      RET Z
000259 4259 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
00025C 425C E680             7      AND 080H
00025E 425E CD7F42          17      CALL    CHK_RAM_SLT
000261 4261 C8              11      RET Z
000262 4262 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000265 4265 E680             7      AND 080H
000267 4267 C601             7      ADD A,1
000269 4269 CD7F42          17      CALL    CHK_RAM_SLT
00026C 426C C8              11      RET Z
00026D 426D 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000270 4270 E680             7      AND 080H
000272 4272 C602             7      ADD A,2
000274 4274 CD7F42          17      CALL    CHK_RAM_SLT
000277 4277 C8              11      RET Z
000278 4278 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
00027B 427B E680             7      AND 080H
00027D 427D C603             7      ADD A,3
       427F                     CHK_RAM_SLT:
00027F 427F E5              11      PUSH    HL
000280 4280 CDA842          17      CALL    CHK_RAM0        ;スロット#X or X-0
000283 4283 E1              10      POP HL
000284 4284 C8              11      RET Z
000285 4285 CB79             8      BIT 7,C
000287 4287 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000289 4289 79               4      LD  A,C
00028A 428A C604             7      ADD A,4*1           ;スロット#X-1
00028C 428C E5              11      PUSH    HL
00028D 428D CDA842          17      CALL    CHK_RAM0
000290 4290 E1              10      POP HL
000291 4291 C8              11      RET Z
000292 4292 79               4      LD  A,C
000293 4293 C608             7      ADD A,4*2           ;スロット#X-2
000295 4295 E5              11      PUSH    HL
000296 4296 CDA842          17      CALL    CHK_RAM0
000299 4299 E1              10      POP HL
00029A 429A C8              11      RET Z
00029B 429B 79               4      LD  A,C
00029C 429C C60C             7      ADD A,4*3           ;スロット#X-3
00029E 429E E5              11      PUSH    HL
00029F 429F CDA842          17      CALL    CHK_RAM0
0002A2 42A2 E1              10      POP HL
       42A3                     CHK_RAM_E:
0002A3 42A3 AF               4      XOR A
0002A4 42A4 3C               4      INC A           ;ZF=0にする
0002A5 42A5 3E00             7      LD  A,0
0002A7 42A7 C9              10      RET
                                
       42A8                     CHK_RAM0:
0002A8 42A8 4F               4      LD  C,A
0002A9 42A9 3A97F2          13      LD  A,(ROM_SLT)
0002AC 42AC B9               4      CP  C
0002AD 42AD 28F4            12      JR  Z,CHK_RAM_E
0002AF 42AF 2E00             7      LD  L,0
       42B1                     CHK_RAM1:
0002B1 42B1 79               4      LD  A,C
0002B2 42B2 CD9E43          17      CALL    RDSLTX
0002B5 42B5 C6E5             7      ADD A,0E5H
0002B7 42B7 47               4      LD  B,A
0002B8 42B8 5F               4      LD  E,A
0002B9 42B9 79               4      LD  A,C
0002BA 42BA C5              11      PUSH    BC
0002BB 42BB CD1400          17      CALL    _WRSLT
0002BE 42BE C1              10      POP BC
0002BF 42BF 79               4      LD  A,C
0002C0 42C0 CD9E43          17      CALL    RDSLTX
0002C3 42C3 B8               4      CP  B
0002C4 42C4 C0              11      RET NZ
0002C5 42C5 D6E5             7      SUB 0E5H
0002C7 42C7 79               4      LD  A,C
0002C8 42C8 5F               4      LD  E,A
0002C9 42C9 C5              11      PUSH    BC
0002CA 42CA CD1400          17      CALL    _WRSLT
0002CD 42CD C1              10      POP BC
0002CE 42CE 24               4      INC H
0002CF 42CF 7D               4      LD  A,L
0002D0 42D0 C604             7      ADD A,4
0002D2 42D2 6F               4      LD  L,A
0002D3 42D3 20DC            12      JR  NZ,CHK_RAM1
0002D5 42D5 79               4      LD  A,C     ;ZF=1のハズ
0002D6 42D6 C9              10      RET
                                
       42D7                     CALSLT_R:
0002D7 42D7 C5              11      PUSH    BC
0002D8 42D8 E5              11      PUSH    HL
0002D9 42D9 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0002DD 42DD CD1C00          17      CALL    _CALSLT
0002E0 42E0 E1              10      POP HL
0002E1 42E1 C1              10      POP BC
0002E2 42E2 C9              10      RET
                                
       42E3                     AT_ISC:
0002E3 F280                         ORG ISC,AT_ISC-RUN
       F280                     REPLACE_COMMAND:
0002E3 F280 FEB7             7      CP  0B7H            ;FILES
0002E5 F282 CC7BFE          17      CALL    Z,H_FILE
0002E8 F285 FEB5             7      CP  0B5H            ;LOAD
0002EA F287 CA71FE          10      JP  Z,H_BINS
0002ED F28A FE8A             7      CP  08AH            ;RUN
0002EF F28C CA76FE          10      JP  Z,H_BINL
0002F2 F28F FED6             7      CP  0D6H            ;COPY
0002F4 F291 2813            12      JR  Z,FIX_COPY
0002F6 F293 FECF             7      CP  0CFH            ;BLOAD
0002F8 F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
0002F9 F296 F7              12      RST 30H
       F297                     ROM_SLT:
0002FA F297 00                      DB  0
0002FB F298 FF45                    DW  ROM_BLOAD
0002FD F29A F5              11      PUSH    AF
0002FE F29B E5              11      PUSH    HL
0002FF F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
000302 F29F E1              10      POP HL
000303 F2A0 F1              10      POP AF
000304 F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
000306 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
000308 F2A5 C9              10      RET
       F2A6                     FIX_COPY:
000309 F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
00030A F2A7 00                      DB  0
00030B F2A8 7A47                    DW  ROM_COPY
00030D F2AA C9              10      RET
       F2AB                     RAMUSE1:
00030E F2AB 3A42F3          13      LD  A,(RAMAD1)
       F2AE                     ROMUSE2:
000311 F2AE C32400          10      JP  _ENASLT
       F2B1                     CAL_MP:
000314 F2B1 2640             7      LD  H,040H
000316 F2B3 3AC1FC          13      LD  A,(EXPTBL)
000319 F2B6 CD2400          17      CALL    _ENASLT
00031C F2B9 CD1C00          17      CALL    _CALSLT
00031F F2BC 2640             7      LD  H,040H
       F2BE                     ROMUSE1:
000321 F2BE 3A97F2          13      LD  A,(ROM_SLT)
000324 F2C1 18EB            12      JR  ROMUSE2
                                
       F2C3                     _RESULT:
000326 F2C3 00                      DB  0
       F2C4                     _BANK:
000327 F2C4 00                      DB  0
       F2C5                     _BANK1:
000328 F2C5 00                      DB  0
       F2C6                     CLSZ:               ;クラスタサイズ
000329 F2C6 0004                    DW  1024
       F2C7                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2C8                     SECSZ:              ;セクタサイズ
00032B F2C8 0002                    DW  512
       F2C9                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2CA                     RR_LOW:
00032D F2CA 0000                    DW  0
       F2CB                     RR_MID  EQU $-1
       F2CC                     RR_HIGH:
00032F F2CC 0000                    DW  0
       F2CE                     _CLPS:
000331 F2CE 0000                    DW  0
       F2D0                     _LEFT:
000333 F2D0 0000                    DW  0
       F2D2                     _DTPS:
000335 F2D2 0000                    DW  0
       F2D4                     _DTA:
000337 F2D4 0000                    DW  0
       F2D6                     FLG_LDIR:
000339 F2D6 00                      DB  0
       F2D7                     _FCB:
00033A F2D7 0000                    DW  0
       F2D9                     _BUF:
       F2D9                     _BUF_LO:        ;LOGICAL OPERATION
00033C F2D9 00                      DB  0
       F2DA                     _BUF_ST:
00033D F2DA 0000                    DW  0
       F2DC                     _BUF_EN:
00033F F2DC 0000                    DW  0
       F2DE                     _BUF_EX:
       F2DE                     _BUF_W:
000341 F2DE 0000                    DW  0
       F2E0                     _BUF_H:
000343 F2E0 0000                    DW  0
       F2E2                     _BUF_X:
000345 F2E2 0000                    DW  0
       F2E4                     _BUF_Y:
000347 F2E4 00                      DB  0
       F2E5                     _BUF_P:
000348 F2E5 00                      DB  0
       F2E6                     _BUF_O:
000349 F2E6 00                      DB  0
       F2E7                     DTAX:
00034A F2E7 0000                    DW  0
       F2E9                     B_DRIVE:
00034C F2E9 00                      DB  0
       F2EA                     _DVSW:          ;カレントドライブ
00034D F2EA 00                      DB  0
       F2EB                     _CD:            ;カレントディレクトリ
00034E F2EB 0000                    DW  0
       F2ED                     DIRENT1:
000350 F2ED 0000                    DW  0
       F2EF                     _DIR_BANK:
000352 F2EF 00                      DB  0
       F2F0                     LEFTX:
000353 F2F0 0000                    DW  0
       F2F2                     PARAM0:
000355 F2F2 0000                    DW  0
       F2F4                     PARAM1:
000357 F2F4 0000                    DW  0
       F2F6                     _CDX:
000359 F2F6 0000                    DW  0
       F2F8                     FDRV:
00035B F2F8 00                      DB  0
       F2F9                     FNAME:
00035C F2F9                         DS  8+3
       F304                     _HL:
000367 F304 0000                    DW  0
       F306                     _SP:
000369 F306 0000                    DW  0
       F307                     _SP_H   EQU $-1
       F308                     ISC_E:
00036B 436B                         ORG $$+RUN          ;$DEPHASE
                                
       436B                     MSX1:
00036B 436B CD1953          17      CALL    MSGA1
       436E                     MSX:
00036E 436E 7E               7      LD  A,(HL)
00036F 436F 23               6      INC HL
000370 4370 B7               4      OR  A
000371 4371 20F8            12      JR  NZ,MSX1
000373 4373 C9              10      RET
                                
       4374                     PRTHX:
000374 4374 F5              11      PUSH    AF
000375 4375 07               4      RLCA
000376 4376 07               4      RLCA
000377 4377 07               4      RLCA
000378 4378 07               4      RLCA
000379 4379 CD7D43          17      CALL    PRTA2
00037C 437C F1              10      POP AF
       437D                     PRTA2:
00037D 437D CD8343          17      CALL    ASC
000380 4380 C31553          10      JP  MSG_A
                                    
       4383                     ASC:
000383 4383 E60F             7      AND $0F
000385 4385 F630             7      OR  $30
000387 4387 FE3A             7      CP  $3A
000389 4389 D8              11      RET C
00038A 438A C607             7      ADD A,7
00038C 438C C9              10      RET
                                
       438D                     MSN:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
00038D 438D 7E               7      LD  A,(HL)
                                #endif
00038E 438E 23               6      INC HL
00038F 438F CD1553          17      CALL    MSG_A
000392 4392 10F9            13      DJNZ    MSN
000394 4394 C9              10      RET
                                
       4395                     RDSLT_ROM3:
000395 4395 7E               7      LD  A,(HL)
000396 4396 C9              10      RET
       4397                     RDSLT_ROM:
000397 4397 CB7C             8      BIT 7,H
000399 4399 28FA            12      JR  Z,RDSLT_ROM3
       439B                     RDSLT_ROM2:
00039B 439B 3A97F2          13      LD  A,(ROM_SLT)
       439E                     RDSLTX:
00039E 439E C5              11      PUSH    BC
00039F 439F D5              11      PUSH    DE
0003A0 43A0 CD0C00          17      CALL    _RDSLT
0003A3 43A3 D1              10      POP DE
0003A4 43A4 C1              10      POP BC
0003A5 43A5 C9              10      RET
                                
       43A6                     ROM_BOOT:
0003A6 43A6 3E                      DB  03EH
0003A7 43A7 C9              10      RET
0003A8 43A8 32DBFD          13      LD  (H_PINL),A
0003AB 43AB 3ACAFF          13      LD  A,(EXTBIO)
0003AE 43AE FEF7             7      CP  0F7H        ;RST 30H
0003B0 43B0 280A            12      JR  Z,EXTBIO_OK
0003B2 43B2 3E                      DB  03EH
0003B3 43B3 C9              10      RET
0003B4 43B4 21CAFF          10      LD  HL,EXTBIO
0003B7 43B7 061D             7      LD  B,29
0003B9 43B9 CD1A4B          17      CALL    FILL_MEMORY
       43BC                     EXTBIO_OK:
0003BC 43BC 210F44          10      LD  HL,DELOK
0003BF 43BF CD6E43          17      CALL    MSX
                                
0003C2 43C2 AF               4      XOR A
0003C3 43C3 3240F3          13      LD  (REBOOT),A
0003C6 43C6 2A48FC          16      LD  HL,(BOTTOM)
0003C9 43C9 110040          10      LD  DE,16384
0003CC 43CC 19              11      ADD HL,DE
0003CD 43CD 3817            12      JR  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
0003CF 43CF 57               4      LD  D,A
0003D0 43D0 0601             7      LD  B,1
0003D2 43D2 2100C0          10      LD  HL,0C000H
0003D5 43D5 CDD450          17      CALL    DISKIO
                                
0003D8 43D8 116BF3          10      LD  DE,RAMUSE
0003DB 43DB AF               4      XOR A
0003DC 43DC CD1EC0          17      CALL    0C01EH
0003DF 43DF 116BF3          10      LD  DE,RAMUSE
0003E2 43E2 37               4      SCF
0003E3 43E3 CD1EC0          17      CALL    0C01EH
       43E6                     BOOT1:
0003E6 43E6 C35F52          10      JP  BASENT
                                
       43E9                     MSG_ERROR_ROM_MODE:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DB  "Normal ROM/ASCII-16K only!",13,10
                                #else
0003E9 43E9 41534349492D384B        DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
            2F4B6F6E616D692D    
            384B2F4B6F6E616D    
            692D534343206F6E    
            6C79210D0A          
                                #endif
       440E                     NULL:
00040E 440E 00                      DB  0
       440F                     DELOK:
00040F 440F 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       4413                     ROM_LDIR:
000413 4413 3AD6F2          13      LD  A,(FLG_LDIR)
000416 4416 B7               4      OR  A
000417 4417 2008            12      JR  NZ,ROM_LDIRVM
000419 4419 CB7A             8      BIT 7,D
00041B 441B CA3344          10      JP  Z,ROM_LDIRSLT
                                #if exists USE_MORMAL32K_OR_ASCII16
                                LDIRA:
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ1
                                    LD  SP,SP32
                                SPJ1:
                                LDIR1:
                                    LD  A,B
                                    OR  C
                                    JR  Z,LDIRE
                                
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                LDIR2:
                                    LD  A,D
                                    CP  0C0H
                                    JR  NC,LDIR4
                                
                                    PUSH    BC
                                    PUSH    DE
                                    LD  DE,BUF
                                
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIR3
                                    LD  BC,00100H
                                LDIR3:
                                    PUSH    BC
                                    LDIR
                                    LD  (_HL),HL
                                
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                
                                    POP BC
                                    POP DE
                                    LD  HL,BUF
                                    LDIR
                                
                                    LD  HL,(_HL)
                                    POP BC
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIRE
                                    DEC B
                                    JR  LDIR1
                                LDIR4:
                                #endif
00041E 441E EDB0                    LDIR
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                LDIRE2:
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                LDIRE:
                                    LD  SP,(_SP)
                                #endif
000420 4420 C9              10      RET
                                
       4421                     ROM_LDIRVM:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ2
                                    LD  SP,SP32
                                SPJ2:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
000421 4421 C5              11      PUSH    BC
000422 4422 D5              11      PUSH    DE
000423 4423 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000427 4427 DD215C00        14      LD  IX,LDIRVM
00042B 442B CD1C00          17      CALL    _CALSLT
00042E 442E E1              10      POP HL
00042F 442F C1              10      POP BC
000430 4430 09              11      ADD HL,BC
000431 4431 EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JR  LDIRE2
                                #else
000432 4432 C9              10      RET
                                #endif
                                
       4433                     ROM_LDIRSLT:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ3
                                    LD  SP,SP32
                                SPJ3:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
       4433                     ROM_LDIRSLT1:
000433 4433 EB               4      EX  DE,HL
       4434                     RLDIRSLT1:
000434 4434 CB7C             8      BIT 7,H
000436 4436 201F            12      JR  NZ,RLDIRSLT_EXIT
000438 4438 1A               7      LD  A,(DE)
000439 4439 13               6      INC DE
00043A 443A C5              11      PUSH    BC
00043B 443B D5              11      PUSH    DE
00043C 443C E5              11      PUSH    HL
00043D 443D 5F               4      LD  E,A
                                
00043E 443E 0141F3          10      LD  BC,RAMAD0
000441 4441 7C               4      LD  A,H
000442 4442 07               4      RLCA
000443 4443 07               4      RLCA
000444 4444 E603             7      AND 3
000446 4446 81               4      ADD A,C
000447 4447 4F               4      LD  C,A
000448 4448 0A               7      LD  A,(BC)
       4449                     RLDIRSLT2:
000449 4449 CD1400          17      CALL    _WRSLT
00044C 444C 08               4      EX  AF,AF'
00044D 444D E1              10      POP HL
00044E 444E D1              10      POP DE
00044F 444F C1              10      POP BC
000450 4450 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
000452 4452 EA3444          10      JP  PE,RLDIRSLT1
000455 4455 EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JP  LDIRE2
                                RLDIRSLT_EXIT:
                                    EX  DE,HL
                                    JP  LDIR1
                                #else
000456 4456 C9              10      RET
       4457                     RLDIRSLT_EXIT:
000457 4457 EB               4      EX  DE,HL
000458 4458 EDB0                    LDIR
00045A 445A C9              10      RET
                                #endif
                                
       445B                     END_OF_LINE:
00045B 445B 215EF5          10      LD  HL,BUF
       445E                     EOL1:
00045E 445E 7E               7      LD  A,(HL)
00045F 445F C8              11      RET Z
000460 4460 FE0D             7      CP  00DH
000462 4462 2807            12      JR  Z,EOLE
000464 4464 FE0A             7      CP  00AH
000466 4466 2803            12      JR  Z,EOLE
000468 4468 23               6      INC HL
000469 4469 18F3            12      JR  EOL1
       446B                     EOLE:
00046B 446B 3600            10      LD  (HL),0
00046D 446D 23               6      INC HL
00046E 446E 7E               7      LD  A,(HL)
00046F 446F FE0A             7      CP  00AH
000471 4471 C0              11      RET NZ
000472 4472 23               6      INC HL
000473 4473 C9              10      RET
                                
       4474                     ROM_LOAD_ASCII:
000474 4474 210000          10      LD  HL,0
000477 4477 22DAF2          16      LD  (_BUF_ST),HL    ;読み出し位置
00047A 447A 2A76F6          16      LD  HL,(TXTTAB)
00047D 447D 22DCF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
000480 4480 215EF5          10      LD  HL,BUF
000483 4483 22D4F2          16      LD  (_DTA),HL
       4486                     RLOAD_A1:
000486 4486 2ADAF2          16      LD  HL,(_BUF_ST)
000489 4489 22CAF2          16      LD  (RR_LOW),HL
00048C 448C 210201          10      LD  HL,258
00048F 448F CD9A49          17      CALL    ROM_READ
000492 4492 7C               4      LD  A,H
000493 4493 B5               4      OR  L
000494 4494 2879            12      JR  Z,RLOAD_AEND
000496 4496 015EF5          10      LD  BC,BUF
000499 4499 09              11      ADD HL,BC
00049A 449A 3600            10      LD  (HL),0
00049C 449C CD5B44          17      CALL    END_OF_LINE
00049F 449F 015EF5          10      LD  BC,BUF
0004A2 44A2 A7               4      AND A
0004A3 44A3 ED42            15      SBC HL,BC
0004A5 44A5 2810            12      JR  Z,RLOAD_A2
0004A7 44A7 4D               4      LD  C,L
0004A8 44A8 44               4      LD  B,H
0004A9 44A9 ED5BDAF2        20      LD  DE,(_BUF_ST)
0004AD 44AD 19              11      ADD HL,DE
0004AE 44AE 22DAF2          16      LD  (_BUF_ST),HL
0004B1 44B1 3A5EF5          13      LD  A,(BUF)
0004B4 44B4 B7               4      OR  A
0004B5 44B5 28CF            12      JR  Z,RLOAD_A1
       44B7                     RLOAD_A2:
0004B7 44B7 115EF5          10      LD  DE,BUF
0004BA 44BA CD514B          17      CALL    SPCUTEX
0004BD 44BD 1A               7      LD  A,(DE)
0004BE 44BE B7               4      OR  A
0004BF 44BF 284E            12      JR  Z,RLOAD_AEND
0004C1 44C1 CD634B          17      CALL    GETNUM
0004C4 44C4 7C               4      LD  A,H
0004C5 44C5 B5               4      OR  L
0004C6 44C6 CAE645          10      JP  Z,ERROR_DIRECT_IN_FILE
0004C9 44C9 DD2ADCF2        20      LD  IX,(_BUF_EN)
0004CD 44CD DD7502          19      LD  (IX+2),L
0004D0 44D0 DD7403          19      LD  (IX+3),H
                                
0004D3 44D3 CD4A4B          17      CALL    SPCUT
0004D6 44D6 EB               4      EX  DE,HL
0004D7 44D7 DDE5            15      PUSH    IX
0004D9 44D9 DD21B242        14      LD  IX,CRUNCH
0004DD 44DD FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0004E1 44E1 CD1C00          17      CALL    _CALSLT
0004E4 44E4 DDE1            14      POP IX
0004E6 44E6 EB               4      EX  DE,HL
0004E7 44E7 111FF4          10      LD  DE,KBUF
0004EA 44EA 37               4      SCF
0004EB 44EB ED52            15      SBC HL,DE
0004ED 44ED CAE645          10      JP  Z,ERROR_DIRECT_IN_FILE
0004F0 44F0 DAE645          10      JP  C,ERROR_DIRECT_IN_FILE
0004F3 44F3 4D               4      LD  C,L
0004F4 44F4 44               4      LD  B,H
0004F5 44F5 2ADCF2          16      LD  HL,(_BUF_EN)
0004F8 44F8 110400          10      LD  DE,4
0004FB 44FB 19              11      ADD HL,DE
0004FC 44FC 111FF4          10      LD  DE,KBUF
                                
0004FF 44FF EB               4      EX  DE,HL
000500 4500 EDB0                    LDIR
000502 4502 EB               4      EX  DE,HL
                                
000503 4503 DD7500          19      LD  (IX+0),L
000506 4506 DD7401          19      LD  (IX+1),H
000509 4509 22DCF2          16      LD  (_BUF_EN),HL
00050C 450C C38644          10      JP  RLOAD_A1
                                
       450F                     RLOAD_AEND:
00050F 450F 2ADCF2          16      LD  HL,(_BUF_EN)
000512 4512 AF               4      XOR A
000513 4513 77               7      LD  (HL),A
000514 4514 23               6      INC HL
000515 4515 77               7      LD  (HL),A
000516 4516 23               6      INC HL
000517 4517 22DCF2          16      LD  (_BUF_EN),HL
00051A 451A C3A945          10      JP  RLOAD_END1
                                
       451D                     ROM_LOAD:
00051D 451D CD4847          17      CALL    INIT_PARAM
000520 4520 7E               7      LD  A,(HL)
000521 4521 FE2C             7      CP  ','
000523 4523 2003            12      JR  NZ,ROM_LOAD0
000525 4525 23               6      INC HL
000526 4526 7E               7      LD  A,(HL)
000527 4527 2B               6      DEC HL
       4528                     ROM_LOAD0:
000528 4528 32BEFC          13      LD  (RUNBNF),A
00052B 452B CD3B4A          17      CALL    FILE_B
00052E 452E 3AF9F2          13      LD  A,(FNAME)
000531 4531 FE20             7      CP  020H
000533 4533 CA364A          10      JP  Z,ROM_ORG
                                
000536 4536 CDBA4B          17      CALL    ROM_OPEN
000539 4539 DAF245          10      JP  C,ERROR_FILE_NOT_FOUND
       453C                     ROM_LOAD1:
00053C 453C 21D9F2          10      LD  HL,_BUF
00053F 453F 22D4F2          16      LD  (_DTA),HL
000542 4542 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
000545 4545 CD9A49          17      CALL    ROM_READ
000548 4548 3AD9F2          13      LD  A,(_BUF)
00054B 454B 3C               4      INC A
00054C 454C C27444          10      JP  NZ,ROM_LOAD_ASCII
00054F 454F 2A76F6          16      LD  HL,(TXTTAB)
000552 4552 22D4F2          16      LD  (_DTA),HL
000555 4555 EB               4      EX  DE,HL
000556 4556 2100FF          10      LD  HL,-256
000559 4559 39              11      ADD HL,SP
00055A 455A ED52            15      SBC HL,DE
00055C 455C CD9A49          17      CALL    ROM_READ
00055F 455F ED5BD4F2        20      LD  DE,(_DTA)
000563 4563 19              11      ADD HL,DE
000564 4564 E5              11      PUSH    HL
000565 4565 2A76F6          16      LD  HL,(TXTTAB)
       4568                     ROM_LOAD2:          ;リンクポインタをFIX
000568 4568 E5              11      PUSH    HL
000569 4569 DDE1            14      POP IX
00056B 456B 7E               7      LD  A,(HL)      ;リンクポインタL
00056C 456C 23               6      INC HL
00056D 456D B6               7      OR  (HL)        ;リンクポインタH
00056E 456E 23               6      INC HL
00056F 456F 2837            12      JR  Z,RLOAD_END0
000571 4571 23               6      INC HL      ;行番号
000572 4572 23               6      INC HL      ;行番号
       4573                     ROM_LOAD3:
000573 4573 7E               7      LD  A,(HL)
000574 4574 23               6      INC HL
000575 4575 FE0B             7      CP  00BH        ;8進数(&O)
000577 4577 2822            12      JR  Z,INC_HL2
000579 4579 FE0C             7      CP  00CH        ;16進数(&H)
00057B 457B 281E            12      JR  Z,INC_HL2
00057D 457D FE0D             7      CP  00DH        ;行番号(RUN後)
00057F 457F 281A            12      JR  Z,INC_HL2
000581 4581 FE0E             7      CP  00EH        ;行番号(RUN前)
000583 4583 2816            12      JR  Z,INC_HL2
000585 4585 FE0F             7      CP  00FH        ;10～255の整数(%)
000587 4587 2813            12      JR  Z,INC_HL1
000589 4589 FE1C             7      CP  01CH        ;256～65535の整数(%)
00058B 458B 280E            12      JR  Z,INC_HL2
00058D 458D FE1D             7      CP  01DH        ;単精度実数(!)
00058F 458F 2808            12      JR  Z,INC_HL4
000591 4591 FE1F             7      CP  01FH        ;倍制度実数(#)
000593 4593 2008            12      JR  NZ,INC_HL0
000595 4595 23               6      INC HL
000596 4596 23               6      INC HL
000597 4597 23               6      INC HL
000598 4598 23               6      INC HL
       4599                     INC_HL4:
000599 4599 23               6      INC HL
00059A 459A 23               6      INC HL
       459B                     INC_HL2:
00059B 459B 23               6      INC HL
       459C                     INC_HL1:
00059C 459C 23               6      INC HL
       459D                     INC_HL0:
00059D 459D B7               4      OR  A
00059E 459E 20D3            12      JR  NZ,ROM_LOAD3
0005A0 45A0 DD7500          19      LD  (IX+0),L
0005A3 45A3 DD7401          19      LD  (IX+1),H
0005A6 45A6 18C0            12      JR  ROM_LOAD2
       45A8                     RLOAD_END0:
0005A8 45A8 E1              10      POP HL
       45A9                     RLOAD_END1:
0005A9 45A9 22C2F6          16      LD  (VARTAB),HL
0005AC 45AC 22C4F6          16      LD  (ARYTAB),HL
0005AF 45AF 22C6F6          16      LD  (STREND),HL
                                
0005B2 45B2 3ABEFC          13      LD  A,(RUNBNF)
0005B5 45B5 CDA44B          17      CALL    CAP
0005B8 45B8 FE52             7      CP  'R'
0005BA 45BA 280E            12      JR  Z,RLOAD_END2
0005BC 45BC AF               4      XOR A
0005BD 45BD 21DCF2          10      LD  HL,_BUF+3
0005C0 45C0 77               7      LD  (HL),A      ;3
0005C1 45C1 2B               6      DEC HL
0005C2 45C2 77               7      LD  (HL),A      ;2
0005C3 45C3 2B               6      DEC HL
0005C4 45C4 77               7      LD  (HL),A      ;1
0005C5 45C5 2B               6      DEC HL
0005C6 45C6 3E8F             7      LD  A,08FH      ;REM
0005C8 45C8 77               7      LD  (HL),A      ;0
0005C9 45C9 C9              10      RET
       45CA                     RLOAD_END2:
0005CA 45CA D5              11      PUSH    DE
0005CB 45CB ED5B76F6        20      LD  DE,(TXTTAB)
0005CF 45CF 1B               6      DEC DE
0005D0 45D0 AF               4      XOR A
0005D1 45D1 21DFF2          10      LD  HL,_BUF+6
0005D4 45D4 77               7      LD  (HL),A      ;6
0005D5 45D5 2B               6      DEC HL
0005D6 45D6 77               7      LD  (HL),A      ;5
0005D7 45D7 2B               6      DEC HL
0005D8 45D8 77               7      LD  (HL),A      ;4
0005D9 45D9 2B               6      DEC HL
0005DA 45DA 72               7      LD  (HL),D      ;3 行番号H
0005DB 45DB 2B               6      DEC HL
0005DC 45DC 73               7      LD  (HL),E      ;2 行番号L
0005DD 45DD 2B               6      DEC HL
0005DE 45DE 360D            10      LD  (HL),00DH   ;1 行番号(RUN後)
0005E0 45E0 2B               6      DEC HL
0005E1 45E1 3E89             7      LD  A,089H      ;GOTO
0005E3 45E3 77               7      LD  (HL),A      ;0
0005E4 45E4 D1              10      POP DE
0005E5 45E5 C9              10      RET
                                
       45E6                     ERROR_DIRECT_IN_FILE:
0005E6 45E6 1E39             7      LD  E,57            ;Direct statement in file
0005E8 45E8 01                      DB  1           ;LD BC,
       45E9                     ERROR_DEVICE_IO_ERROR:
0005E9 45E9 1E13             7      LD  E,19            ;Device I/O error
0005EB 45EB 01                      DB  1           ;LD BC,
       45EC                     ERROR_INTERNAL_ERROR:
0005EC 45EC 1E33             7      LD  E,51            ;Internal error
0005EE 45EE 01                      DB  1           ;LD BC,
       45EF                     ERROR_FILE_NOT_OPEN:
0005EF 45EF 1E3B             7      LD  E,59            ;File not OPEN
0005F1 45F1 01                      DB  1           ;LD BC,
       45F2                     ERROR_FILE_NOT_FOUND:
0005F2 45F2 1E35             7      LD  E,53            ;File not found
       45F4                     ERROR:
0005F4 45F4 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0005F8 45F8 DD216F40        14      LD  IX,ERRHAND
0005FC 45FC C31C00          10      JP  _CALSLT
                                
       45FF                     ROM_BLOAD:
0005FF 45FF CD4847          17      CALL    INIT_PARAM
000602 4602 CD3B4A          17      CALL    FILE_B
000605 4605 CDBA4B          17      CALL    ROM_OPEN
000608 4608 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
00060A 460A 21D9F2          10      LD  HL,_BUF
00060D 460D 22D4F2          16      LD  (_DTA),HL
000610 4610 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
000613 4613 CD9A49          17      CALL    ROM_READ
000616 4616 3AD9F2          13      LD  A,(_BUF)
000619 4619 FEFE             7      CP  0FEH
00061B 461B 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
00061D 461D 21A5F2          10      LD  HL,BLOAD_RET
000620 4620 229DF2          16      LD  (SWC_BLOAD),HL
                                
000623 4623 2AF4F2          16      LD  HL,(PARAM1)
000626 4626 7E               7      LD  A,(HL)
000627 4627 FE2C             7      CP  ','
000629 4629 2049            12      JR  NZ,RBREAD_MEM
00062B 462B 23               6      INC HL
00062C 462C 7E               7      LD  A,(HL)
00062D 462D CDA44B          17      CALL    CAP
000630 4630 32BEFC          13      LD  (RUNBNF),A
000633 4633 FE52             7      CP  'R'     ;R,Sスイッチじゃ無い場合はオフセット値として処理する
000635 4635 2808            12      JR  Z,RBOS1
000637 4637 FE53             7      CP  'S'
000639 4639 2804            12      JR  Z,RBOS1
00063B 463B FE2C             7      CP  ','
00063D 463D 200D            12      JR  NZ,RBOS2
       463F                     RBOS1:
00063F 463F 7E               7      LD  A,(HL)
000640 4640 23               6      INC HL
000641 4641 B7               4      OR  A
000642 4642 2824            12      JR  Z,RBREAD_OSE
000644 4644 FE3A             7      CP  ':'
000646 4646 2820            12      JR  Z,RBREAD_OSE
000648 4648 FE2C             7      CP  ','     ;次のパラメータを探す
00064A 464A 20F3            12      JR  NZ,RBOS1
       464C                     RBOS2:              ;オフセット
00064C 464C 22F4F2          16      LD  (PARAM1),HL
00064F 464F 7E               7      LD  A,(HL)
000650 4650 B7               4      OR  A
000651 4651 2815            12      JR  Z,RBREAD_OSE
000653 4653 DD212F54        14      LD  IX,FRMQNT
000657 4657 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00065B 465B CD1C00          17      CALL    _CALSLT
00065E 465E 22F4F2          16      LD  (PARAM1),HL
000661 4661 2ADAF2          16      LD  HL,(_BUF_ST)
000664 4664 19              11      ADD HL,DE
000665 4665 22DAF2          16      LD  (_BUF_ST),HL
       4668                     RBREAD_OSE:
000668 4668 3ABEFC          13      LD  A,(RUNBNF)
00066B 466B FE53             7      CP  'S'
00066D 466D 2005            12      JR  NZ,RBREAD_MEM
00066F 466F 3E01             7      LD  A,1
000671 4671 32D6F2          13      LD  (FLG_LDIR),A
       4674                     RBREAD_MEM:
000674 4674 2ADAF2          16      LD  HL,(_BUF_ST)
000677 4677 22BFFC          16      LD  (SAVENT),HL
00067A 467A 22D4F2          16      LD  (_DTA),HL
00067D 467D 21FFFF          10      LD  HL,0FFFFH
000680 4680 CD9A49          17      CALL    ROM_READ
000683 4683 AF               4      XOR A
000684 4684 32D6F2          13      LD  (FLG_LDIR),A
000687 4687 3ABEFC          13      LD  A,(RUNBNF)
00068A 468A FE52             7      CP  'R'
00068C 468C 2006            12      JR  NZ,RBREAD1
00068E 468E 2ADEF2          16      LD  HL,(_BUF_EX)
000691 4691 229DF2          16      LD  (SWC_BLOAD),HL
       4694                     RBREAD1:
       4694                     ROM_NEXT:
000694 4694 2AF4F2          16      LD  HL,(PARAM1)
000697 4697 7E               7      LD  A,(HL)
000698 4698 2B               6      DEC HL
000699 4699 B7               4      OR  A
00069A 469A 2805            12      JR  Z,ROM_NEXT1
00069C 469C FE3A             7      CP  ':'
00069E 469E 2801            12      JR  Z,ROM_NEXT1
0006A0 46A0 23               6      INC HL
       46A1                     ROM_NEXT1:
0006A1 46A1 5D               4      LD  E,L
0006A2 46A2 54               4      LD  D,H
                                
0006A3 46A3 CD7A4B          17      CALL    SEARCH_END
0006A6 46A6 B7               4      OR  A
0006A7 46A7 2821            12      JR  Z,REM
       46A9                     RN3:                    ;マルチステートメントの処理
0006A9 46A9 7E               7      LD  A,(HL)
                                
0006AA 46AA FEB5             7      CP  0B5H            ;LOAD
0006AC 46AC CA1D45          10      JP  Z,ROM_LOAD
0006AF 46AF FE8A             7      CP  08AH            ;RUN
0006B1 46B1 281B            12      JR  Z,ROM_RUN
0006B3 46B3 FEB7             7      CP  0B7H            ;FILES
0006B5 46B5 2825            12      JR  Z,ROM_FILES
0006B7 46B7 FED6             7      CP  0D6H            ;COPY
0006B9 46B9 CA7A47          10      JP  Z,ROM_COPY
0006BC 46BC FE20             7      CP  020H
0006BE 46BE 2807            12      JR  Z,RN_SP
                                
0006C0 46C0 3E28             7      LD  A,028H          ;JR Z,
0006C2 46C2 32A3F2          13      LD  (SWC_BLOAD_M),A
0006C5 46C5 7E               7      LD  A,(HL)
0006C6 46C6 C9              10      RET
       46C7                     RN_SP:
0006C7 46C7 23               6      INC HL
0006C8 46C8 18DF            12      JR  RN3
                                
       46CA                     REM:
0006CA 46CA EB               4      EX  DE,HL
0006CB 46CB 3E8F             7      LD  A,08FH          ;REM
0006CD 46CD C9              10      RET
                                
       46CE                     ROM_RUN:
0006CE 46CE 23               6      INC HL
0006CF 46CF 7E               7      LD  A,(HL)
0006D0 46D0 2B               6      DEC HL
0006D1 46D1 B7               4      OR  A
0006D2 46D2 C41D45          17      CALL    NZ,ROM_LOAD
0006D5 46D5 FE8F             7      CP  08FH            ;REM
0006D7 46D7 3E8A             7      LD  A,08AH          ;RUN
0006D9 46D9 C0              11      RET NZ
0006DA 46DA 77               7      LD  (HL),A
0006DB 46DB C9              10      RET
                                
       46DC                     ROM_FILES:
0006DC 46DC CD4847          17      CALL    INIT_PARAM
0006DF 46DF CD3B4A          17      CALL    FILE_B
0006E2 46E2 CD9C52          17      CALL    GET_DISK_BANK_FDRV
0006E5 46E5 3AC9F2          13      LD  A,(SECSZ_H)
0006E8 46E8 CD5A51          17      CALL    IS_BPB1
0006EB 46EB DAE945          10      JP  C,ERROR_DEVICE_IO_ERROR
0006EE 46EE 3AF9F2          13      LD  A,(FNAME)
0006F1 46F1 FE21             7      CP  021H
0006F3 46F3 3005            12      JR  NC,RFILES0
0006F5 46F5 060B             7      LD  B,11
0006F7 46F7 CD0E4B          17      CALL    FILE10
       46FA                     RFILES0:
0006FA 46FA CD184E          17      CALL    GET_DIR_DAT
       46FD                     RFILES1:
0006FD 46FD CDD64B          17      CALL    FILESE
000700 4700 3041            12      JR  NC,RFILES_NOT_MATCH
       4702                     RFILES_DISP:
000702 4702 E5              11      PUSH    HL
000703 4703 110B00          10      LD  DE,0000BH   ;属性
000706 4706 19              11      ADD HL,DE
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000707 4707 7E               7      LD  A,(HL)
                                #endif
000708 4708 E1              10      POP HL
000709 4709 CB4F             8      BIT 1,A     ;不可視属性
00070B 470B 2033            12      JR  NZ,RFILES_NEXT
00070D 470D E5              11      PUSH    HL
00070E 470E 0608             7      LD  B,8
000710 4710 CD8D43          17      CALL    MSN
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000713 4713 7E               7      LD  A,(HL)
                                #endif
000714 4714 FE20             7      CP  020H
000716 4716 F5              11      PUSH    AF
000717 4717 3E2E             7      LD  A,'.'
000719 4719 C41553          17      CALL    NZ,MSG_A
00071C 471C 0603             7      LD  B,3
00071E 471E CD8D43          17      CALL    MSN
000721 4721 F1              10      POP AF
000722 4722 CC1553          17      CALL    Z,MSG_A
000725 4725 3ADDF3          13      LD  A,(CSRX)
000728 4728 47               4      LD  B,A
000729 4729 3AB0F3          13      LD  A,(LINLEN)
00072C 472C 90               4      SUB B
00072D 472D FE0C             7      CP  12
00072F 472F 3009            12      JR  NC,RFILES2
000731 4731 3E0D             7      LD  A,00DH      ;改行
000733 4733 CD1553          17      CALL    MSG_A
000736 4736 3E0A             7      LD  A,00AH
000738 4738 1802            12      JR  RFILES3
       473A                     RFILES2:
00073A 473A 3E20             7      LD  A,020H
       473C                     RFILES3:
00073C 473C CD1553          17      CALL    MSG_A
00073F 473F E1              10      POP HL
       4740                     RFILES_NEXT:
000740 4740 CDF24B          17      CALL    FNEXT
       4743                     RFILES_NOT_MATCH:
000743 4743 20B8            12      JR  NZ,RFILES1
000745 4745 C39446          10      JP  ROM_NEXT
                                
       4748                     INIT_PARAM:
000748 4748 22F2F2          16      LD  (PARAM0),HL
00074B 474B 22F4F2          16      LD  (PARAM1),HL
00074E 474E EB               4      EX  DE,HL
00074F 474F 32BEFC          13      LD  (RUNBNF),A
000752 4752 3263F6          13      LD  (VALTYP),A
000755 4755 E5              11      PUSH    HL
000756 4756 2AEBF2          16      LD  HL,(_CD)
000759 4759 22F6F2          16      LD  (_CDX),HL
00075C 475C E1              10      POP HL
00075D 475D 13               6      INC DE
00075E 475E CD4A4B          17      CALL    SPCUT
000761 4761 1A               7      LD  A,(DE)
000762 4762 B7               4      OR  A
000763 4763 C8              11      RET Z
000764 4764 FE3A             7      CP  ':'
000766 4766 C8              11      RET Z
000767 4767 FE28             7      CP  '('
000769 4769 C8              11      RET Z
00076A 476A EB               4      EX  DE,HL
00076B 476B DD21644C        14      LD  IX,FRMEVL
00076F 476F FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000773 4773 CD1C00          17      CALL    _CALSLT
000776 4776 22F4F2          16      LD  (PARAM1),HL
000779 4779 C9              10      RET
                                
       477A                     ROM_COPY:
00077A 477A CD4847          17      CALL    INIT_PARAM
00077D 477D 3A63F6          13      LD  A,(VALTYP)
000780 4780 FE03             7      CP  3       ;string
000782 4782 C2364A          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
000785 4785 CD3B4A          17      CALL    FILE_B
000788 4788 CDBA4B          17      CALL    ROM_OPEN
00078B 478B DAF245          10      JP  C,ERROR_FILE_NOT_FOUND
                                
00078E 478E 21DEF2          10      LD  HL,_BUF_W
000791 4791 22D4F2          16      LD  (_DTA),HL
000794 4794 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
000797 4797 CD9A49          17      CALL    ROM_READ
                                
00079A 479A AF               4      XOR A
00079B 479B 32D9F2          13      LD  (_BUF_LO),A     ;PSET
00079E 479E 32E6F2          13      LD  (_BUF_O),A      ;向き
                                
0007A1 47A1 2AF4F2          16      LD  HL,(PARAM1)
       47A4                     RCP_PARAM1:
0007A4 47A4 7E               7      LD  A,(HL)
0007A5 47A5 23               6      INC HL
0007A6 47A6 B7               4      OR  A
0007A7 47A7 CAA146          10      JP  Z,ROM_NEXT1
0007AA 47AA FE3A             7      CP  ':'
0007AC 47AC CAA146          10      JP  Z,ROM_NEXT1
0007AF 47AF FE2C             7      CP  ','
0007B1 47B1 2012            12      JR  NZ,RCP_PARAM1_
                                
0007B3 47B3 DD212F54        14      LD  IX,FRMQNT
0007B7 47B7 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007BB 47BB CD1C00          17      CALL    _CALSLT
0007BE 47BE 7B               4      LD  A,E
0007BF 47BF 87               4      ADD A,A
0007C0 47C0 87               4      ADD A,A
0007C1 47C1 32E6F2          13      LD  (_BUF_O),A
0007C4 47C4 7E               7      LD  A,(HL)
       47C5                     RCP_PARAM1_:
0007C5 47C5 FE28             7      CP  '('
0007C7 47C7 20DB            12      JR  NZ,RCP_PARAM1
0007C9 47C9 DD212F54        14      LD  IX,FRMQNT
0007CD 47CD FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007D1 47D1 CD1C00          17      CALL    _CALSLT
                                
0007D4 47D4 ED53E2F2        20      LD  (_BUF_X),DE
                                
       47D8                     RCP_PARAM2:
0007D8 47D8 23               6      INC HL
0007D9 47D9 7E               7      LD  A,(HL)
0007DA 47DA FE20             7      CP  020H
0007DC 47DC 28FA            12      JR  Z,RCP_PARAM2
0007DE 47DE FE2C             7      CP  ','
0007E0 47E0 28F6            12      JR  Z,RCP_PARAM2
                                
0007E2 47E2 DD212F54        14      LD  IX,FRMQNT
0007E6 47E6 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007EA 47EA CD1C00          17      CALL    _CALSLT
                                
0007ED 47ED 3AF6FA          13      LD  A,(ACPAGE)
0007F0 47F0 57               4      LD  D,A
0007F1 47F1 ED53E4F2        20      LD  (_BUF_Y),DE
       47F5                     RCP_PARAM3:
0007F5 47F5 23               6      INC HL
0007F6 47F6 7E               7      LD  A,(HL)
0007F7 47F7 FE20             7      CP  020H
0007F9 47F9 28FA            12      JR  Z,RCP_PARAM3
0007FB 47FB FE29             7      CP  ')'
0007FD 47FD 28F6            12      JR  Z,RCP_PARAM3
0007FF 47FF FE2C             7      CP  ','
000801 4801 2033            12      JR  NZ,RCP_ST
                                
000803 4803 23               6      INC HL
000804 4804 DD212F54        14      LD  IX,FRMQNT
000808 4808 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00080C 480C CD1C00          17      CALL    _CALSLT
                                
00080F 480F 7B               4      LD  A,E
000810 4810 32E5F2          13      LD  (_BUF_P),A
                                
       4813                     RCP_PARAM4:
000813 4813 7E               7      LD  A,(HL)
000814 4814 23               6      INC HL
000815 4815 FE20             7      CP  020H
000817 4817 28FA            12      JR  Z,RCP_PARAM4
                                
000819 4819 FE2C             7      CP  ','
00081B 481B 2019            12      JR  NZ,RCP_ST
                                
00081D 481D 7E               7      LD  A,(HL)
00081E 481E 0604             7      LD  B,4
000820 4820 FEC3             7      CP  0C3H        ;PRESET
000822 4822 280E            12      JR  Z,RCP_LO
000824 4824 05               4      DEC B       ;3
000825 4825 D6F8             7      SUB 0F8H        ;XOR
000827 4827 2809            12      JR  Z,RCP_LO
000829 4829 05               4      DEC B       ;2
00082A 482A 3C               4      INC A       ;OR
00082B 482B 2805            12      JR  Z,RCP_LO
00082D 482D 05               4      DEC B       ;1
00082E 482E 3C               4      INC A       ;AND
00082F 482F 2801            12      JR  Z,RCP_LO
000831 4831 05               4      DEC B       ;0
                                                ;PSET
       4832                     RCP_LO:
000832 4832 78               4      LD  A,B
000833 4833 32D9F2          13      LD  (_BUF_LO),A
       4836                     RCP_ST:
000836 4836 2AC6F6          16      LD  HL,(STREND)
000839 4839 22D4F2          16      LD  (_DTA),HL
00083C 483C EB               4      EX  DE,HL
00083D 483D 2100FE          10      LD  HL,-512
000840 4840 39              11      ADD HL,SP
000841 4841 AF               4      XOR A
000842 4842 ED52            15      SBC HL,DE
000844 4844 3008            12      JR  NC,RCP0
000846 4846 215EF5          10      LD  HL,BUF
000849 4849 22D4F2          16      LD  (_DTA),HL
00084C 484C 6F               4      LD  L,A ;0
00084D 484D 67               4      LD  H,A ;0
       484E                     RCP0:
00084E 484E 24               4      INC H
00084F 484F 22DCF2          16      LD  (_BUF_EN),HL
       4852                     RCP1:
000852 4852 F3               4      DI
000853 4853 CD2849          17      CALL    WAIT_VDP
                                
000856 4856 3A0700          13      LD  A,(WRVDP)
000859 4859 4F               4      LD  C,A
00085A 485A 0C               4      INC C       ;C := PORT#1's address(WR)
00085B 485B 3E24             7      LD  A,36
00085D 485D ED79            12      OUT (C),A
00085F 485F 3E91             7      LD  A,080H+17
000861 4861 ED79            12      OUT (C),A       ;R#17 := 36
                                
000863 4863 0C               4      INC C
000864 4864 0C               4      INC C       ;C := PORT#3's address(WR)
000865 4865 2AE2F2          16      LD  HL,(_BUF_X)
000868 4868 ED69            12      OUT (C),L       ;R#36 DX
00086A 486A ED61            12      OUT (C),H       ;R#37
00086C 486C 2AE4F2          16      LD  HL,(_BUF_Y)
00086F 486F ED69            12      OUT (C),L       ;R#38 DY
000871 4871 ED61            12      OUT (C),H       ;R#39
000873 4873 2ADEF2          16      LD  HL,(_BUF_W)
000876 4876 ED69            12      OUT (C),L       ;R#40 NX
000878 4878 ED61            12      OUT (C),H       ;R#41
00087A 487A 2AE0F2          16      LD  HL,(_BUF_H)
00087D 487D ED69            12      OUT (C),L       ;R#42 NY
00087F 487F ED61            12      OUT (C),H       ;R#43
                                
000881 4881 DD2AAFFC        20      LD  IX,(SCRMOD)
000885 4885 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000888 4888 B7               4      OR  A
000889 4889 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
00088B 488B DD7D             9      LD  A,IXL
00088D 488D FE08             7      CP  8
00088F 488F 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
000891 4891 FE06             7      CP  6
000893 4893 2AE2F2          16      LD  HL,(_BUF_X)
000896 4896 3ADEF2          13      LD  A,(_BUF_W)
000899 4899 2005            12      JR  NZ,SCR57
00089B 489B B5               4      OR  L       ;スクリーン6
00089C 489C E603             7      AND 3
00089E 489E 200D            12      JR  NZ,USE_LMMC
       48A0                     SCR57:              ;スクリーン5,7
0008A0 48A0 B5               4      OR  L
0008A1 48A1 E601             7      AND 1
0008A3 48A3 2008            12      JR  NZ,USE_LMMC
       48A5                     USE_HMMC:
0008A5 48A5 DD2E08          10      LD  IXL,8
       48A8                     USE_HMMC8:
0008A8 48A8 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
0008AA 48AA 32D9F2          13      LD  (_BUF_LO),A
       48AD                     USE_LMMC:
0008AD 48AD 110000          10      LD  DE,0
0008B0 48B0 06FF             7      LD  B,-1
0008B2 48B2 CD5349          17      CALL    GET_PIXEL
0008B5 48B5 ED79            12      OUT (C),A       ;R#44 first DATA
0008B7 48B7 3AE6F2          13      LD  A,(_BUF_O)
0008BA 48BA ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
0008BC 48BC 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0008BF 48BF F6B0             7      OR  0B0H        ;R#46 LMMC command
0008C1 48C1 ED79            12      OUT (C),A
                                
0008C3 48C3 FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
0008C5 48C5 0D               4      DEC C
0008C6 48C6 0D               4      DEC C       ;C := PORT#1's address(WR)
0008C7 48C7 3EAC             7      LD  A,080H+44
0008C9 48C9 ED79            12      OUT (C),A
0008CB 48CB 3E91             7      LD  A,080H+17
0008CD 48CD ED79            12      OUT (C),A       ;R#17 := 44
                                
0008CF 48CF 3A0600          13      LD  A,(RDVDP)
0008D2 48D2 3C               4      INC A
0008D3 48D3 FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
0008D5 48D5 3E02             7      LD  A,2
0008D7 48D7 ED79            12      OUT (C),A
0008D9 48D9 3E8F             7      LD  A,08FH
0008DB 48DB ED79            12      OUT (C),A
0008DD 48DD 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0008E0 48E0 E640             7      AND 040H
0008E2 48E2 201C            12      JR  NZ,LOOP_HMMC
       48E4                     LOOP_COPY:
0008E4 48E4 CD5349          17      CALL    GET_PIXEL
0008E7 48E7 08               4      EX  AF,AF'
0008E8 48E8 FD4C             9      LD  C,IYH
       48EA                     LOOP_COPY1:
0008EA 48EA ED78            12      IN  A,(C)
0008EC 48EC 0F               4      RRCA            ;RRCAではサインフラグは変化しない
0008ED 48ED 300A            12      JR  NC,EXIT_COPY    ;check CE bit
0008EF 48EF F2EA48          10      JP  P,LOOP_COPY1    ;check TR bit
0008F2 48F2 08               4      EX  AF,AF'
0008F3 48F3 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
0008F5 48F5 ED79            12      OUT (C),A
0008F7 48F7 18EB            12      JR  LOOP_COPY
                                
       48F9                     EXIT_COPY:
0008F9 48F9 CD3049          17      CALL    GET_STATUS_0
0008FC 48FC FB               4      EI
0008FD 48FD C39446          10      JP  ROM_NEXT
                                
       4900                     LOOP_HMMC:
000900 4900 F3               4      DI          ;必要
000901 4901 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000903 4903 43               4      LD  B,E
000904 4904 7B               4      LD  A,E
000905 4905 B7               4      OR  A
000906 4906 2802            12      JR  Z,LOOP_HMMC1
000908 4908 EDB3                    OTIR
       490A                     LOOP_HMMC1:
00090A 490A 14               4      INC D
       490B                     LOOP_HMMC2:
00090B 490B 15               4      DEC D
00090C 490C 2805            12      JR  Z,LOOP_HMMC3
00090E 490E EDB3                    OTIR
000910 4910 C30B49          10      JP  LOOP_HMMC2
       4913                     LOOP_HMMC3:
000913 4913 ED78            12      IN  A,(C)
000915 4915 0F               4      RRCA
000916 4916 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
000918 4918 2ADCF2          16      LD  HL,(_BUF_EN)
00091B 491B CD9A49          17      CALL    ROM_READ
00091E 491E EB               4      EX  DE,HL
00091F 491F 2AD4F2          16      LD  HL,(_DTA)
000922 4922 7A               4      LD  A,D
000923 4923 B3               4      OR  E
000924 4924 20DA            12      JR  NZ,LOOP_HMMC
000926 4926 18C2            12      JR  LOOP_COPY1
                                    
       4928                     WAIT_VDP:
000928 4928 3E02             7      LD  A,2
00092A 492A CD3149          17      CALL    GET_STATUS
00092D 492D 0F               4      RRCA
00092E 492E 38F8            12      JR  C,WAIT_VDP
       4930                     GET_STATUS_0:
000930 4930 AF               4      XOR A
       4931                     GET_STATUS:
000931 4931 C5              11      PUSH    BC
000932 4932 ED4B0600        20      LD  BC,(RDVDP)
000936 4936 0C               4      INC C
000937 4937 ED79            12      OUT (C),A
000939 4939 3E8F             7      LD  A,08FH
00093B 493B ED79            12      OUT (C),A
00093D 493D ED78            12      IN  A,(C)
00093F 493F C1              10      POP BC
000940 4940 C9              10      RET
                                
       4941                     GET_PIXEL256:
000941 4941 7A               4      LD  A,D
000942 4942 B3               4      OR  E
000943 4943 200A            12      JR  NZ,GET_PIXEL1
000945 4945 2ADCF2          16      LD  HL,(_BUF_EN)
000948 4948 CD9A49          17      CALL    ROM_READ
00094B 494B EB               4      EX  DE,HL
00094C 494C 2AD4F2          16      LD  HL,(_DTA)
       494F                     GET_PIXEL1:
00094F 494F 7E               7      LD  A,(HL)
000950 4950 23               6      INC HL
000951 4951 1B               6      DEC DE
000952 4952 C9              10      RET
                                
       4953                     GET_PIXEL:
000953 4953 DD7D             9      LD  A,IXL
000955 4955 FE08             7      CP  8
000957 4957 28E8            12      JR  Z,GET_PIXEL256
000959 4959 04               4      INC B
00095A 495A FE06             7      CP  6
00095C 495C 282E            12      JR  Z,GET_PIXEL4
                                
00095E 495E CB40             8      BIT 0,B
000960 4960 20ED            12      JR  NZ,GET_PIXEL1
                                
000962 4962 7A               4      LD  A,D
000963 4963 B3               4      OR  E
000964 4964 200A            12      JR  NZ,GET_PIXEL2
                                
000966 4966 2ADCF2          16      LD  HL,(_BUF_EN)
000969 4969 CD9A49          17      CALL    ROM_READ
00096C 496C EB               4      EX  DE,HL
00096D 496D 2AD4F2          16      LD  HL,(_DTA)
                                
       4970                     GET_PIXEL2:
000970 4970 7E               7      LD  A,(HL)
000971 4971 0F               4      RRCA
000972 4972 0F               4      RRCA
000973 4973 0F               4      RRCA
000974 4974 0F               4      RRCA
000975 4975 C9              10      RET
                                
       4976                     GET_PIXEL3:
000976 4976 7A               4      LD  A,D
000977 4977 B3               4      OR  E
000978 4978 200A            12      JR  NZ,GET_PIXEL5
                                
00097A 497A 2ADCF2          16      LD  HL,(_BUF_EN)
00097D 497D CD9A49          17      CALL    ROM_READ
000980 4980 EB               4      EX  DE,HL
000981 4981 2AD4F2          16      LD  HL,(_DTA)
       4984                     GET_PIXEL5:
000984 4984 7E               7      LD  A,(HL)
000985 4985 0F               4      RRCA
000986 4986 0F               4      RRCA
000987 4987 0F               4      RRCA
000988 4988 0F               4      RRCA
000989 4989 0F               4      RRCA
00098A 498A 0F               4      RRCA
00098B 498B C9              10      RET
                                
       498C                     GET_PIXEL4:
00098C 498C 78               4      LD  A,B
00098D 498D E603             7      AND 3   ;+0
00098F 498F 28E5            12      JR  Z,GET_PIXEL3
000991 4991 3D               4      DEC A   ;+1
000992 4992 28DC            12      JR  Z,GET_PIXEL2
000994 4994 3D               4      DEC A   ;+2
000995 4995 7E               7      LD  A,(HL)
000996 4996 C0              11      RET NZ
000997 4997 0F               4      RRCA        ;+3
000998 4998 0F               4      RRCA
000999 4999 C9              10      RET
                                
       499A                     ROM_READ:
00099A 499A E5              11      PUSH    HL
00099B 499B D5              11      PUSH    DE
00099C 499C C5              11      PUSH    BC
00099D 499D FDE5            15      PUSH    IY
00099F 499F 22F0F2          16      LD  (LEFTX),HL
0009A2 49A2 2AD4F2          16      LD  HL,(_DTA)
0009A5 49A5 22E7F2          16      LD  (DTAX),HL
0009A8 49A8 2AF0F2          16      LD  HL,(LEFTX)
                                
0009AB 49AB CD4C4C          17      CALL    RBX1
0009AE 49AE 3870            12      JR  C,RBRERR1
0009B0 49B0 79               4      LD  A,C
0009B1 49B1 EB               4      EX  DE,HL
0009B2 49B2 ED52            15      SBC HL,DE       ;CP 0HL,CDE
0009B4 49B4 19              11      ADD HL,DE
0009B5 49B5 DE00             7      SBC A,000H
0009B7 49B7 3801            12      JR  C,RBR1
0009B9 49B9 EB               4      EX  DE,HL
       49BA                     RBR1:
0009BA 49BA 9F               4      SBC A,A
0009BB 49BB E601             7      AND 1
0009BD 49BD 32C3F2          13      LD  (_RESULT),A
0009C0 49C0 7C               4      LD  A,H
0009C1 49C1 B5               4      OR  L
0009C2 49C2 CA164A          10      JP  Z,RBREND0
                                
0009C5 49C5 22D0F2          16      LD  (_LEFT),HL  ;Read record byte
0009C8 49C8 22F0F2          16      LD  (LEFTX),HL
                                
0009CB 49CB CD784C          17      CALL    RBX2
0009CE 49CE 281A            12      JR  Z,RBRB
                                                ;先頭の端数
0009D0 49D0 CD8B4C          17      CALL    RBXA
0009D3 49D3 DA2C4A          10      JP  C,RBRERR
0009D6 49D6 C5              11      PUSH    BC
0009D7 49D7 CD1344          17      CALL    ROM_LDIR
0009DA 49DA ED53E7F2        20      LD  (DTAX),DE
0009DE 49DE 2AF0F2          16      LD  HL,(LEFTX)
0009E1 49E1 D1              10      POP DE
0009E2 49E2 A7               4      AND A
0009E3 49E3 ED52            15      SBC HL,DE
0009E5 49E5 22F0F2          16      LD  (LEFTX),HL
0009E8 49E8 2829            12      JR  Z,RBREND
                                
       49EA                     RBRB:
0009EA 49EA CDC74C          17      CALL    RBXB
0009ED 49ED 2818            12      JR  Z,RBRC
       49EF                     RBRB1:
0009EF 49EF C5              11      PUSH    BC
0009F0 49F0 D5              11      PUSH    DE
0009F1 49F1 CD724D          17      CALL    CLUST
0009F4 49F4 EB               4      EX  DE,HL
0009F5 49F5 ED4BC6F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
0009F9 49F9 CD1344          17      CALL    ROM_LDIR
0009FC 49FC EB               4      EX  DE,HL
0009FD 49FD D1              10      POP DE
0009FE 49FE C1              10      POP BC
0009FF 49FF CD4F4D          17      CALL    GNCL
000A02 4A02 DA2C4A          10      JP  C,RBRERR
000A05 4A05 10E8            13      DJNZ    RBRB1
       4A07                     RBRC:
000A07 4A07 CDDF4C          17      CALL    RBXC
000A0A 4A0A 2807            12      JR  Z,RBREND
                                
000A0C 4A0C CD724D          17      CALL    CLUST
000A0F 4A0F EB               4      EX  DE,HL
000A10 4A10 CD1344          17      CALL    ROM_LDIR
       4A13                     RBREND:
000A13 4A13 CDEB4C          17      CALL    RBXEND
       4A16                     RBREND0:
000A16 4A16 FDE1            14      POP IY
000A18 4A18 C1              10      POP BC
000A19 4A19 D1              10      POP DE
000A1A 4A1A F1              10      POP AF  ;(HL)
000A1B 4A1B AF               4      XOR A
000A1C 4A1C 3AC3F2          13      LD  A,(_RESULT)
000A1F 4A1F C9              10      RET
                                
       4A20                     RBRERR1:
000A20 4A20 3E01             7      LD  A,001H
       4A22                     RBRERR2:
000A22 4A22 FDE1            14      POP IY
000A24 4A24 C1              10      POP BC
000A25 4A25 D1              10      POP DE
000A26 4A26 E1              10      POP HL
000A27 4A27 37               4      SCF
000A28 4A28 210000          10      LD  HL,0
000A2B 4A2B C9              10      RET
       4A2C                     RBRERR:
000A2C 4A2C 3EFF             7      LD  A,0FFH
000A2E 4A2E 18F2            12      JR  RBRERR2
                                
       4A30                     FILE_DD:
000A30 4A30 E1              10      POP HL
000A31 4A31 3E                      DB  03EH
000A32 4A32 C9              10      RET
000A33 4A33 32A3F2          13      LD  (SWC_BLOAD_M),A
       4A36                     ROM_ORG:
000A36 4A36 2AF2F2          16      LD  HL,(PARAM0)
000A39 4A39 7E               7      LD  A,(HL)
000A3A 4A3A C9              10      RET
       4A3B                     FILE_B:
000A3B 4A3B AF               4      XOR A
000A3C 4A3C 32F8F2          13      LD  (FDRV),A
000A3F 4A3F 1E00             7      LD  E,0
000A41 4A41 3A63F6          13      LD  A,(VALTYP)
000A44 4A44 FE03             7      CP  3       ;string
000A46 4A46 C2CB4A          10      JP  NZ,FILED
                                
000A49 4A49 DD21D067        14      LD  IX,FRESTR
000A4D 4A4D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000A51 4A51 CD1C00          17      CALL    _CALSLT
000A54 4A54 E5              11      PUSH    HL
000A55 4A55 DDE1            14      POP IX
                                
000A57 4A57 DD5E00          19      LD  E,(IX+0)
000A5A 4A5A DD7E01          19      LD  A,(IX+1)
000A5D 4A5D DD5602          19      LD  D,(IX+2)
000A60 4A60 DD62             9      LD  IXH,D
000A62 4A62 DD6F             9      LD  IXL,A
000A64 4A64 7B               4      LD  A,E
       4A65                     FILE_BDOS:
000A65 4A65 FE04             7      CP  4
000A67 4A67 3808            12      JR  C,FILEB1
000A69 4A69 DD7E03          19      LD  A,(IX+3)
000A6C 4A6C FE3A             7      CP  ':'
000A6E 4A6E 28C0            12      JR  Z,FILE_DD
000A70 4A70 7B               4      LD  A,E
       4A71                     FILEB1:
000A71 4A71 FE02             7      CP  2
000A73 4A73 3818            12      JR  C,DEVI1
000A75 4A75 DD7E01          19      LD  A,(IX+1)
000A78 4A78 FE3A             7      CP  ':'
000A7A 4A7A 2011            12      JR  NZ,DEVI1
000A7C 4A7C DD7E00          19      LD  A,(IX+0)        ;DRIVE
000A7F 4A7F CDA44B          17      CALL    CAP
000A82 4A82 D640             7      SUB '@'
000A84 4A84 DD23            10      INC IX
000A86 4A86 DD23            10      INC IX
000A88 4A88 1D               4      DEC E
000A89 4A89 1D               4      DEC E
000A8A 4A8A 32F8F2          13      LD  (FDRV),A
       4A8D                     DEVI1:
000A8D 4A8D DD7E00          19      LD  A,(IX+0)
000A90 4A90 D65C             7      SUB 05CH        ;\
000A92 4A92 2008            12      JR  NZ,NOROOT
000A94 4A94 6F               4      LD  L,A
000A95 4A95 67               4      LD  H,A
000A96 4A96 22F6F2          16      LD  (_CDX),HL
000A99 4A99 DD23            10      INC IX
000A9B 4A9B 1D               4      DEC E
       4A9C                     NOROOT:
                                
       4A9C                     SETDIR:
000A9C 4A9C CDCB4A          17      CALL    FILED
000A9F 4A9F DD7E00          19      LD  A,(IX+0)
000AA2 4AA2 FE5C             7      CP  05CH        ;\
000AA4 4AA4 C0              11      RET NZ
000AA5 4AA5 DD23            10      INC IX
000AA7 4AA7 1D               4      DEC E
000AA8 4AA8 3AF9F2          13      LD  A,(FNAME)
000AAB 4AAB FE20             7      CP  020H        ;. の処理
000AAD 4AAD 28ED            12      JR  Z,SETDIR
                                
000AAF 4AAF CDBA4B          17      CALL    ROM_OPEN
000AB2 4AB2 B7               4      OR  A
000AB3 4AB3 C0              11      RET NZ
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                #else
000AB4 4AB4 FD2AEDF2        20      LD  IY,(DIRENT1)
000AB8 4AB8 FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000ABC 4ABC C8              11      RET Z
000ABD 4ABD CD124B          17      CALL    FILEI
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
000AC0 4AC0 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000AC3 4AC3 FD661B          19      LD  H,(IY+01BH)
                                #endif
000AC6 4AC6 22F6F2          16      LD  (_CDX),HL
000AC9 4AC9 18D1            12      JR  SETDIR
                                
       4ACB                     FILED:
000ACB 4ACB CD124B          17      CALL    FILEI
000ACE 4ACE 21F9F2          10      LD  HL,FNAME
                                
000AD1 4AD1 0608             7      LD  B,8
       4AD3                     FILE2:
000AD3 4AD3 CD1F4B          17      CALL    CCHKF
000AD6 4AD6 C8              11      RET Z
000AD7 4AD7 FE2A             7      CP  '*'
000AD9 4AD9 282E            12      JR  Z,FILE9
000ADB 4ADB FE2E             7      CP  '.'
000ADD 4ADD 280C            12      JR  Z,FILE4
000ADF 4ADF 77               7      LD  (HL),A
000AE0 4AE0 23               6      INC HL
000AE1 4AE1 10F0            13      DJNZ    FILE2
                                
       4AE3                     FILE3:
000AE3 4AE3 CD1F4B          17      CALL    CCHKF
000AE6 4AE6 C8              11      RET Z
000AE7 4AE7 FE2E             7      CP  '.'
000AE9 4AE9 20F8            12      JR  NZ,FILE3
                                
       4AEB                     FILE4:
000AEB 4AEB 2101F3          10      LD  HL,FNAME+8
000AEE 4AEE 0603             7      LD  B,3
                                
       4AF0                     FILE4L:
000AF0 4AF0 CD1F4B          17      CALL    CCHKF
000AF3 4AF3 C8              11      RET Z
000AF4 4AF4 FE2E             7      CP  '.'
000AF6 4AF6 2008            12      JR  NZ,FILE12
000AF8 4AF8 32F9F2          13      LD  (FNAME),A   ;Parent directory(..)
000AFB 4AFB 32FAF2          13      LD  (FNAME+1),A
000AFE 4AFE 3E20             7      LD  A,020H
       4B00                     FILE12:
000B00 4B00 FE2A             7      CP  '*'
000B02 4B02 280A            12      JR  Z,FILE10
000B04 4B04 77               7      LD  (HL),A
000B05 4B05 23               6      INC HL
000B06 4B06 10E8            13      DJNZ    FILE4L
000B08 4B08 C9              10      RET
                                
       4B09                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000B09 4B09 CD0E4B          17      CALL    FILE10
000B0C 4B0C 18D5            12      JR  FILE3
                                
       4B0E                     FILE10:
000B0E 4B0E 3E3F             7      LD  A,'?'
000B10 4B10 1808            12      JR  FILL_MEMORY
       4B12                     FILEI:              ;名前＋拡張子をスペースで初期化
000B12 4B12 3E20             7      LD  A,020H
000B14 4B14 01000B          10      LD  BC,11*256   ;C=0にしておく
000B17 4B17 21F9F2          10      LD  HL,FNAME
       4B1A                     FILL_MEMORY:            ;HLからBバイトAで埋める
000B1A 4B1A 77               7      LD  (HL),A
000B1B 4B1B 23               6      INC HL
000B1C 4B1C 10FC            13      DJNZ    FILL_MEMORY
000B1E 4B1E C9              10      RET
                                
       4B1F                     CCHKF:
000B1F 4B1F 7B               4      LD  A,E
000B20 4B20 B7               4      OR  A
000B21 4B21 C8              11      RET Z
000B22 4B22 DD7E00          19      LD  A,(IX+0)
000B25 4B25 CD2C4B          17      CALL    CCHK2
000B28 4B28 C8              11      RET Z
000B29 4B29 C38F4B          10      JP  FKAN
                                
       4B2C                     CCHK2:
000B2C 4B2C 0C               4      INC C
000B2D 4B2D 0D               4      DEC C
000B2E 4B2E C0              11      RET NZ
       4B2F                     CCHK3:              ;ZF=1 で使えない文字
000B2F 4B2F FE2B             7      CP  '+'
000B31 4B31 C8              11      RET Z
000B32 4B32 FE2C             7      CP  ','
000B34 4B34 C8              11      RET Z
000B35 4B35 FE2F             7      CP  '/'
000B37 4B37 C8              11      RET Z
000B38 4B38 FE3A             7      CP  ':'
000B3A 4B3A C8              11      RET Z
000B3B 4B3B FE3B             7      CP  ';'
000B3D 4B3D C8              11      RET Z
000B3E 4B3E FE3D             7      CP  '='
000B40 4B40 C8              11      RET Z
000B41 4B41 FE5C             7      CP  05CH    ;\
000B43 4B43 C8              11      RET Z
000B44 4B44 FE1F             7      CP  01FH
000B46 4B46 D0              11      RET NC
000B47 4B47 BF               4      CP  A       ;Z=1
000B48 4B48 C9              10      RET
                                
       4B49                     SS1:
000B49 4B49 13               6      INC DE
       4B4A                     SPCUT:              ;スペースをカット
000B4A 4B4A 1A               7      LD  A,(DE)
000B4B 4B4B FE20             7      CP  020H
000B4D 4B4D 28FA            12      JR  Z,SS1
000B4F 4B4F C9              10      RET
                                
       4B50                     SCREOF1:
000B50 4B50 13               6      INC DE
       4B51                     SPCUTEX:            ;スペース改行などをカット
000B51 4B51 1A               7      LD  A,(DE)
000B52 4B52 FE20             7      CP  020H
000B54 4B54 28FA            12      JR  Z,SCREOF1
000B56 4B56 FE0D             7      CP  00DH
000B58 4B58 28F6            12      JR  Z,SCREOF1
000B5A 4B5A FE0A             7      CP  00AH
000B5C 4B5C 28F2            12      JR  Z,SCREOF1
000B5E 4B5E FE1A             7      CP  01AH
000B60 4B60 28EE            12      JR  Z,SCREOF1
000B62 4B62 C9              10      RET
                                
       4B63                     GETNUM:
000B63 4B63 210000          10      LD  HL,0
       4B66                     GETNUM1:
000B66 4B66 1A               7      LD  A,(DE)
000B67 4B67 13               6      INC DE
000B68 4B68 D630             7      SUB '0'
000B6A 4B6A D8              11      RET C
000B6B 4B6B FE0A             7      CP  10
000B6D 4B6D D0              11      RET NC
000B6E 4B6E 4D               4      LD  C,L
000B6F 4B6F 44               4      LD  B,H
000B70 4B70 29              11      ADD HL,HL   ;*2
000B71 4B71 29              11      ADD HL,HL   ;*4
000B72 4B72 09              11      ADD HL,BC   ;*5
000B73 4B73 29              11      ADD HL,HL   ;*10
000B74 4B74 4F               4      LD  C,A
000B75 4B75 0600             7      LD  B,0
000B77 4B77 09              11      ADD HL,BC
000B78 4B78 18EC            12      JR  GETNUM1
                                
       4B7A                     SEARCH_END:
000B7A 4B7A 7E               7      LD  A,(HL)
       4B7B                     SEARCH_END1:
000B7B 4B7B 23               6      INC HL
000B7C 4B7C B7               4      OR  A
000B7D 4B7D C8              11      RET Z
000B7E 4B7E FE3A             7      CP  ':'
000B80 4B80 20F8            12      JR  NZ,SEARCH_END
000B82 4B82 7E               7      LD  A,(HL)
000B83 4B83 FE3A             7      CP  ':'
000B85 4B85 28F4            12      JR  Z,SEARCH_END1
000B87 4B87 C9              10      RET
                                
       4B88                     FKANC:
000B88 4B88 CB41             8      BIT 0,C
000B8A 4B8A CCAD4B          17      CALL    Z,CAP2
000B8D 4B8D 1803            12      JR  FKANX
       4B8F                     FKAN:           ;漢字チェック
000B8F 4B8F DD23            10      INC IX
000B91 4B91 1D               4      DEC E
       4B92                     FKANX:
000B92 4B92 CB41             8      BIT 0,C
000B94 4B94 CB81             8      RES 0,C
000B96 4B96 C0              11      RET NZ
000B97 4B97 FE80             7      CP  080H
000B99 4B99 D8              11      RET C
000B9A 4B9A FEA0             7      CP  0A0H
000B9C 4B9C 3803            12      JR  C,FKAN1
000B9E 4B9E FEE0             7      CP  0E0H
000BA0 4BA0 D8              11      RET C
       4BA1                     FKAN1:
000BA1 4BA1 0C               4      INC C
000BA2 4BA2 A7               4      AND A
000BA3 4BA3 C9              10      RET
                                
       4BA4                     CAP:
000BA4 4BA4 FE61             7      CP  'a'
000BA6 4BA6 D8              11      RET C
000BA7 4BA7 FE7B             7      CP  'z'+1
000BA9 4BA9 D0              11      RET NC
000BAA 4BAA D620             7      SUB 020H
000BAC 4BAC C9              10      RET
       4BAD                     CAP2:
000BAD 4BAD CDA44B          17      CALL    CAP
       4BB0                     CAP3:               ;
000BB0 4BB0 FE05             7      CP  5
000BB2 4BB2 2803            12      JR  Z,CAP4
000BB4 4BB4 FE21             7      CP  021H
000BB6 4BB6 C9              10      RET
       4BB7                     CAP4:
000BB7 4BB7 3EE5             7      LD  A,0E5H
000BB9 4BB9 C9              10      RET
                                
       4BBA                     ROM_OPEN:
000BBA 4BBA CD9C52          17      CALL    GET_DISK_BANK_FDRV
                                
000BBD 4BBD CD184E          17      CALL    GET_DIR_DAT
000BC0 4BC0 D5              11      PUSH    DE
000BC1 4BC1 CDD64B          17      CALL    FILESE
000BC4 4BC4 D1              10      POP DE
000BC5 4BC5 3F               4      CCF
000BC6 4BC6 D8              11      RET C
000BC7 4BC7 22EDF2          16      LD  (DIRENT1),HL
000BCA 4BCA E5              11      PUSH    HL
000BCB 4BCB 210000          10      LD  HL,0
000BCE 4BCE 22CAF2          16      LD  (RR_LOW),HL
000BD1 4BD1 22CCF2          16      LD  (RR_HIGH),HL
000BD4 4BD4 E1              10      POP HL
000BD5 4BD5 C9              10      RET
                                
       4BD6                     FILESE:
       4BD6                     FILESE0:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000BD6 4BD6 7E               7      LD  A,(HL)
                                #endif
000BD7 4BD7 B7               4      OR  A
000BD8 4BD8 C8              11      RET Z       ;END:ZF=1 CF=0
000BD9 4BD9 FEE5             7      CP  0E5H
000BDB 4BDB 280D            12      JR  Z,FILESE1
000BDD 4BDD 11F9F2          10      LD  DE,FNAME
000BE0 4BE0 E5              11      PUSH    HL
000BE1 4BE1 CD274C          17      CALL    CPFILE
000BE4 4BE4 CC484C          17      CALL    Z,CPFILE2
000BE7 4BE7 E1              10      POP HL
000BE8 4BE8 37               4      SCF
000BE9 4BE9 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4BEA                     FILESE1:
000BEA 4BEA CDF24B          17      CALL    FNEXT
000BED 4BED 20E7            12      JR  NZ,FILESE0
000BEF 4BEF F6FF             7      OR  0FFH        ;ZF=0 CF=0
000BF1 4BF1 C9              10      RET
                                
       4BF2                     FNEXT:
000BF2 4BF2 112000          10      LD  DE,020H
000BF5 4BF5 19              11      ADD HL,DE
000BF6 4BF6 ED5BF6F2        20      LD  DE,(_CDX)
000BFA 4BFA 7A               4      LD  A,D
000BFB 4BFB B3               4      OR  E
000BFC 4BFC 2019            12      JR  NZ,FNEXT_SUBDIR
000BFE 4BFE 0D               4      DEC C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
       4BFF                     CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
000BFF 4BFF F5              11      PUSH    AF      ;※フラグを保存する必要あり
000C00 4C00 CB7C             8      BIT 7,H
000C02 4C02 2811            12      JR  Z,CHECK_DIR_PAGE1
000C04 4C04 7C               4      LD  A,H
000C05 4C05 D620             7      SUB 020H
000C07 4C07 67               4      LD  H,A
000C08 4C08 3AEFF2          13      LD  A,(_DIR_BANK)
000C0B 4C0B 3C               4      INC A
000C0C 4C0C 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C0F 4C0F 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000C12 4C12 32EFF2          13      LD  (_DIR_BANK),A
       4C15                     CHECK_DIR_PAGE1:
000C15 4C15 F1              10      POP AF
                                #endif
000C16 4C16 C9              10      RET
                                
       4C17                     FNEXT_SUBDIR:           ;サブディレクトリ
000C17 4C17 0D               4      DEC C
000C18 4C18 C0              11      RET NZ
                                
000C19 4C19 ED5BF6F2        20      LD  DE,(_CDX)
000C1D 4C1D CD4F4D          17      CALL    GNCL
000C20 4C20 EB               4      EX  DE,HL
000C21 4C21 22F6F2          16      LD  (_CDX),HL
000C24 4C24 C3544E          10      JP  GET_SUBDIR
                                
       4C27                     CPFILE:
000C27 4C27 C5              11      PUSH    BC
000C28 4C28 01000B          10      LD  BC,00B00H
       4C2B                     CPSTR1:
000C2B 4C2B 1A               7      LD  A,(DE)
000C2C 4C2C FE3F             7      CP  '?'     ;Wild card
000C2E 4C2E 2812            12      JR  Z,CPSTR2
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000C30 4C30 7E               7      LD  A,(HL)
                                #endif
000C31 4C31 CD884B          17      CALL    FKANC
000C34 4C34 E5              11      PUSH    HL
000C35 4C35 67               4      LD  H,A
000C36 4C36 1A               7      LD  A,(DE)
000C37 4C37 CB01             8      RLC C
000C39 4C39 CD884B          17      CALL    FKANC
000C3C 4C3C CB09             8      RRC C
000C3E 4C3E BC               4      CP  H       ;CP (HL),(DE)
000C3F 4C3F E1              10      POP HL
000C40 4C40 2004            12      JR  NZ,CPSTR3
       4C42                     CPSTR2:
000C42 4C42 13               6      INC DE
000C43 4C43 23               6      INC HL
000C44 4C44 10E5            13      DJNZ    CPSTR1
       4C46                     CPSTR3:
000C46 4C46 C1              10      POP BC
000C47 4C47 C9              10      RET
                                
       4C48                     CPFILE2:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000C48 4C48 7E               7      LD  A,(HL)
                                #endif
000C49 4C49 E608             7      AND 008H    ;~0F7H
000C4B 4C4B C9              10      RET
                                
       4C4C                     RBX1:
000C4C 4C4C E5              11      PUSH    HL      ;Record byte
                                
000C4D 4C4D ED5BCAF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000C51 4C51 3ACDF2          13      LD  A,(RR_HIGH+1)
000C54 4C54 4F               4      LD  C,A
                                
000C55 4C55 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001CH
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    CALL    RDSLT_ROM
                                    EX  DE,HL       ;AHL=File size
                                    POP DE
                                #else
000C58 4C58 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C5B 4C5B 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000C5E 4C5E FD2AEDF2        20      LD  IY,(DIRENT1)
000C62 4C62 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000C65 4C65 FD661D          19      LD  H,(IY+01DH)
000C68 4C68 FD7E1E          19      LD  A,(IY+01EH)
                                #endif
                                
000C6B 4C6B A7               4      AND A
000C6C 4C6C ED52            15      SBC HL,DE
000C6E 4C6E 99               4      SBC A,C
000C6F 4C6F D1              10      POP DE
                                
000C70 4C70 D8              11      RET C
000C71 4C71 4F               4      LD  C,A
000C72 4C72 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000C73 4C73 B2               4      OR  D
000C74 4C74 B3               4      OR  E
000C75 4C75 C0              11      RET NZ
000C76 4C76 37               4      SCF
000C77 4C77 C9              10      RET
                                
       4C78                     RBX2:
000C78 4C78 ED4BCBF2        20      LD  BC,(RR_LOW+1)
000C7C 4C7C CD004D          17      CALL    RWXR
000C7F 4C7F 3AC7F2          13      LD  A,(CLSZ_H)
000C82 4C82 3D               4      DEC A
000C83 4C83 E5              11      PUSH    HL
000C84 4C84 2ACAF2          16      LD  HL,(RR_LOW)
000C87 4C87 A4               4      AND H
000C88 4C88 B5               4      OR  L
000C89 4C89 E1              10      POP HL
000C8A 4C8A C9              10      RET
                                
       4C8B                     RBXA:
000C8B 4C8B D5              11      PUSH    DE
000C8C 4C8C CD724D          17      CALL    CLUST
000C8F 4C8F ED53D2F2        20      LD  (_DTPS),DE
000C93 4C93 D1              10      POP DE
000C94 4C94 CD4F4D          17      CALL    GNCL
000C97 4C97 D8              11      RET C
000C98 4C98 ED53CEF2        20      LD  (_CLPS),DE
                                
000C9C 4C9C ED4BCAF2        20      LD  BC,(RR_LOW)
000CA0 4CA0 2AC6F2          16      LD  HL,(CLSZ)
000CA3 4CA3 7C               4      LD  A,H
000CA4 4CA4 3D               4      DEC A
000CA5 4CA5 A0               4      AND B
000CA6 4CA6 47               4      LD  B,A
000CA7 4CA7 ED42            15      SBC HL,BC       ;remaining cluster
                                
000CA9 4CA9 ED5BF0F2        20      LD  DE,(LEFTX)
000CAD 4CAD ED52            15      SBC HL,DE       ;CP HL,DE
000CAF 4CAF 19              11      ADD HL,DE
000CB0 4CB0 3801            12      JR  C,RBXA1
000CB2 4CB2 EB               4      EX  DE,HL
       4CB3                     RBXA1:
000CB3 4CB3 3AC4F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
000CB6 4CB6 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000CB9 4CB9 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000CBC 4CBC E5              11      PUSH    HL
000CBD 4CBD 2AD2F2          16      LD  HL,(_DTPS)
000CC0 4CC0 09              11      ADD HL,BC
000CC1 4CC1 ED5BE7F2        20      LD  DE,(DTAX)
000CC5 4CC5 C1              10      POP BC
000CC6 4CC6 C9              10      RET
                                
       4CC7                     RBXB:
000CC7 4CC7 2AE7F2          16      LD  HL,(DTAX)
000CCA 4CCA ED5BCEF2        20      LD  DE,(_CLPS)
000CCE 4CCE 3AF1F2          13      LD  A,(LEFTX+1)
000CD1 4CD1 47               4      LD  B,A
000CD2 4CD2 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4CD5                     RBXB1:
000CD5 4CD5 1F               4      RRA     ;->CF
000CD6 4CD6 3804            12      JR  C,RBXB2
000CD8 4CD8 CB38             8      SRL B   ;B=B/2
000CDA 4CDA 18F9            12      JR  RBXB1
       4CDC                     RBXB2:
000CDC 4CDC 78               4      LD  A,B
000CDD 4CDD B7               4      OR  A
000CDE 4CDE C9              10      RET
                                
       4CDF                     RBXC:
000CDF 4CDF ED4BF0F2        20      LD  BC,(LEFTX)
000CE3 4CE3 3AC7F2          13      LD  A,(CLSZ_H)
000CE6 4CE6 3D               4      DEC A
000CE7 4CE7 A0               4      AND B
000CE8 4CE8 47               4      LD  B,A
000CE9 4CE9 B1               4      OR  C
000CEA 4CEA C9              10      RET
                                
       4CEB                     RBXEND:
000CEB 4CEB ED5BD0F2        20      LD  DE,(_LEFT)
000CEF 4CEF 2ACAF2          16      LD  HL,(RR_LOW)
000CF2 4CF2 3ACDF2          13      LD  A,(RR_HIGH+1)
000CF5 4CF5 19              11      ADD HL,DE
000CF6 4CF6 CE00             7      ADC A,0
000CF8 4CF8 22CAF2          16      LD  (RR_LOW),HL
000CFB 4CFB 32CDF2          13      LD  (RR_HIGH+1),A
000CFE 4CFE EB               4      EX  DE,HL       ;HL=Read byte
000CFF 4CFF C9              10      RET 
                                
       4D00                     RWXR:
000D00 4D00 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4D03                     L_RWX:
000D03 4D03 1F               4      RRA     ;->CF
000D04 4D04 3806            12      JR  C,E_RWX
000D06 4D06 CB38             8      SRL B   ;BC=BC/2
000D08 4D08 CB19             8      RR  C   ;
000D0A 4D0A 18F7            12      JR  L_RWX
       4D0C                     E_RWX:
000D0C 4D0C 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
                                    PUSH    HL
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    POP HL
                                #else
000D0F 4D0F 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D12 4D12 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D15 4D15 FD2AEDF2        20      LD  IY,(DIRENT1)
000D19 4D19 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000D1C 4D1C FD561B          19      LD  D,(IY+01BH)
                                #endif
000D1F 4D1F CD9C52          17      CALL    GET_DISK_BANK_FDRV
       4D22                     RWX1:
000D22 4D22 ED53CEF2        20      LD  (_CLPS),DE
000D26 4D26 7A               4      LD  A,D
000D27 4D27 B3               4      OR  E
000D28 4D28 37               4      SCF
000D29 4D29 C8              11      RET Z
                                
000D2A 4D2A 78               4      LD  A,B
000D2B 4D2B B1               4      OR  C
000D2C 4D2C C8              11      RET Z
                                
000D2D 4D2D CD4F4D          17      CALL    GNCL
000D30 4D30 D8              11      RET C
000D31 4D31 0B               6      DEC BC
000D32 4D32 CDB14D          17      CALL    ENDCL
000D35 4D35 38EB            12      JR  C,RWX1
000D37 4D37 37               4      SCF
000D38 4D38 C9              10      RET
                                
       4D39                     NCL3:
000D39 4D39 CD9C52          17      CALL    GET_DISK_BANK_FDRV
000D3C 4D3C 6B               4      LD  L,E
000D3D 4D3D 62               4      LD  H,D
000D3E 4D3E CB3C             8      SRL H
000D40 4D40 CB1D             8      RR  L
000D42 4D42 1F               4      RRA
000D43 4D43 19              11      ADD HL,DE
000D44 4D44 010060          10      LD  BC,BANK1_ADR
000D47 4D47 09              11      ADD HL,BC
000D48 4D48 ED4BC8F2        20      LD  BC,(SECSZ)
000D4C 4D4C 09              11      ADD HL,BC
000D4D 4D4D 17               4      RLA
000D4E 4D4E C9              10      RET
                                
       4D4F                     GNCL:
000D4F 4D4F 7A               4      LD  A,D
000D50 4D50 B3               4      OR  E
000D51 4D51 37               4      SCF
000D52 4D52 C8              11      RET Z
000D53 4D53 C5              11      PUSH    BC
000D54 4D54 E5              11      PUSH    HL
000D55 4D55 CD394D          17      CALL    NCL3
000D58 4D58 3809            12      JR  C,GNC1
000D5A 4D5A 5E               7      LD  E,(HL)
000D5B 4D5B 23               6      INC HL
000D5C 4D5C 7E               7      LD  A,(HL)
000D5D 4D5D E60F             7      AND 00FH
000D5F 4D5F 57               4      LD  D,A
000D60 4D60 E1              10      POP HL
000D61 4D61 C1              10      POP BC
000D62 4D62 C9              10      RET
       4D63                     GNC1:
000D63 4D63 7E               7      LD  A,(HL)
000D64 4D64 23               6      INC HL
000D65 4D65 56               7      LD  D,(HL)
000D66 4D66 0604             7      LD  B,4
       4D68                     GNC1L:
000D68 4D68 CB3A             8      SRL D
000D6A 4D6A 1F               4      RRA
000D6B 4D6B 10FB            13      DJNZ    GNC1L
                                
000D6D 4D6D 5F               4      LD  E,A
000D6E 4D6E E1              10      POP HL
000D6F 4D6F C1              10      POP BC
000D70 4D70 A7               4      AND A
000D71 4D71 C9              10      RET
                                
       4D72                     CLUST:
000D72 4D72 EB               4      EX  DE,HL
       4D73                     CLUST_HL:
000D73 4D73 2B               6      DEC HL
000D74 4D74 2B               6      DEC HL
000D75 4D75 C5              11      PUSH    BC
000D76 4D76 3AC7F2          13      LD  A,(CLSZ_H)
000D79 4D79 CDCC52          17      CALL    MUL_AHL
                                
000D7C 4D7C CD354E          17      CALL    GET_DIR_POS
000D7F 4D7F 4F               4      LD  C,A
000D80 4D80 0600             7      LD  B,0
000D82 4D82 09              11      ADD HL,BC
                                
000D83 4D83 ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
000D87 4D87 CB38             8      SRL B
000D89 4D89 CB19             8      RR  C           ;/2
000D8B 4D8B CB38             8      SRL B
000D8D 4D8D CB19             8      RR  C           ;/4
000D8F 4D8F CB38             8      SRL B
000D91 4D91 CB19             8      RR  C           ;/8
000D93 4D93 09              11      ADD HL,BC
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  A,L
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    JR  NC,CLUST2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
000D94 4D94 4D               4      LD  C,L     ;C=読み出し元
000D95 4D95 29              11      ADD HL,HL   ;64KB→32KB
000D96 4D96 29              11      ADD HL,HL   ;32KB→16KB
000D97 4D97 29              11      ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
000D98 4D98 CD9C52          17      CALL    GET_DISK_BANK_FDRV
000D9B 4D9B 84               4      ADD A,H
000D9C 4D9C 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D9F 4D9F 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000DA2 4DA2 32C4F2          13      LD  (_BANK),A
000DA5 4DA5 69               4      LD  L,C     ;C=読み出し元
000DA6 4DA6 3E1F             7      LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
000DA8 4DA8 A5               4      AND L
                                #endif
       4DA9                     CLUST2:
000DA9 4DA9 C660             7      ADD A,high BANK1_ADR
000DAB 4DAB 67               4      LD  H,A
000DAC 4DAC 2E00             7      LD  L,0
000DAE 4DAE EB               4      EX  DE,HL
000DAF 4DAF C1              10      POP BC
000DB0 4DB0 C9              10      RET
                                
       4DB1                     ENDCL:
000DB1 4DB1 7A               4      LD  A,D ;END CLUSTER
000DB2 4DB2 FE0F             7      CP  00FH    ;FAT12の最大値
000DB4 4DB4 C0              11      RET NZ
000DB5 4DB5 7B               4      LD  A,E
000DB6 4DB6 FEF7             7      CP  0F7H
000DB8 4DB8 C9              10      RET
                                
       4DB9                     RB_READ:
000DB9 4DB9 AF               4      XOR A   ;HLA = HL*128
000DBA 4DBA CB3C             8      SRL H
000DBC 4DBC CB1D             8      RR  L
000DBE 4DBE 1F               4      RRA
000DBF 4DBF 32CAF2          13      LD  (RR_LOW),A
000DC2 4DC2 22CBF2          16      LD  (RR_MID),HL
000DC5 4DC5 218000          10      LD  HL,128
                                
000DC8 4DC8 CD9A49          17      CALL    ROM_READ
000DCB 4DCB C9              10      RET
                                
       4DCC                     GETSEQ:
000DCC 4DCC FD6E20          19      LD  L,(IY+32)
000DCF 4DCF FD660C          19      LD  H,(IY+12)
                                
000DD2 4DD2 CB25             8      SLA L
                                
000DD4 4DD4 CB3C             8      SRL H
000DD6 4DD6 CB1D             8      RR  L
000DD8 4DD8 C9              10      RET
                                
       4DD9                     SETSEQ:
000DD9 4DD9 F5              11      PUSH    AF
000DDA 4DDA 3ACAF2          13      LD  A,(RR_LOW)
000DDD 4DDD 2ACBF2          16      LD  HL,(RR_MID)
                                
000DE0 4DE0 CDF74D          17      CALL    SSQ1
                                
000DE3 4DE3 29              11      ADD HL,HL
000DE4 4DE4 CB3D             8      SRL L
000DE6 4DE6 FD7520          19      LD  (IY+32),L
000DE9 4DE9 FD740C          19      LD  (IY+12),H
000DEC 4DEC F1              10      POP AF
000DED 4DED C9              10      RET
                                
       4DEE                     GETSIZE:
000DEE 4DEE FD7E10          19      LD  A,(IY+16)
000DF1 4DF1 FD6E11          19      LD  L,(IY+17)
000DF4 4DF4 FD6612          19      LD  H,(IY+18)
       4DF7                     SSQ1:
000DF7 4DF7 87               4      ADD A,A
000DF8 4DF8 ED6A            15      ADC HL,HL
000DFA 4DFA B7               4      OR  A
000DFB 4DFB C8              11      RET Z
000DFC 4DFC 23               6      INC HL
000DFD 4DFD C9              10      RET
                                
       4DFE                     SET_FCB:
000DFE 4DFE D5              11      PUSH    DE
000DFF 4DFF FDE1            14      POP IY
000E01 4E01 FD7E1C          19      LD  A,(IY+28)
000E04 4E04 FEFF             7      CP  0FFH
000E06 4E06 200C            12      JR  NZ,POPAF_SCF_FF_RET
000E08 4E08 E5              11      PUSH    HL
000E09 4E09 FD6E1A          19      LD  L,(IY+26)
000E0C 4E0C FD661B          19      LD  H,(IY+27)
000E0F 4E0F 22CEF2          16      LD  (_CLPS),HL
000E12 4E12 E1              10      POP HL
000E13 4E13 C9              10      RET
                                
       4E14                     POPAF_SCF_FF_RET:
000E14 4E14 F1              10      POP AF
000E15 4E15 37               4      SCF
000E16 4E16 9F               4      SBC A,A
000E17 4E17 C9              10      RET
                                
       4E18                     GET_DIR_DAT:
000E18 4E18 2AF6F2          16      LD  HL,(_CDX)
000E1B 4E1B 7C               4      LD  A,H
000E1C 4E1C B5               4      OR  L
000E1D 4E1D 2035            12      JR  NZ,GET_SUBDIR
000E1F 4E1F CD354E          17      CALL    GET_DIR_POS
000E22 4E22 C660             7      ADD A,high BANK1_ADR
000E24 4E24 2E00             7      LD  L,0
000E26 4E26 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
000E27 4E27 CDFF4B          17      CALL    CHECK_DIR_PAGE
                                #endif
000E2A 4E2A 3AC5F2          13      LD  A,(_BANK1)
000E2D 4E2D 32EFF2          13      LD  (_DIR_BANK),A
                                
000E30 4E30 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000E33 4E33 4F               4      LD  C,A
000E34 4E34 C9              10      RET
                                
       4E35                     GET_DIR_POS:                ;ルートディレクトリ
000E35 4E35 CD9C52          17      CALL    GET_DISK_BANK_FDRV
000E38 4E38 32C5F2          13      LD  (_BANK1),A
000E3B 4E3B 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000E3E 4E3E 47               4      LD  B,A
000E3F 4E3F 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000E42 4E42 4F               4      LD  C,A
000E43 4E43 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4E46                     GET_DIR_POS1:
000E46 4E46 81               4      ADD A,C
000E47 4E47 10FD            13      DJNZ    GET_DIR_POS1
                                
000E49 4E49 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
000E4D 4E4D 37               4      SCF     ;無限ループ回避
       4E4E                     L_MDP:
000E4E 4E4E CB18             8      RR  B   ;->CF
000E50 4E50 D8              11      RET C
000E51 4E51 87               4      ADD A,A
000E52 4E52 18FA            12      JR  L_MDP
                                
       4E54                     GET_SUBDIR:             ;サブディレクトリ
000E54 4E54 CD734D          17      CALL    CLUST_HL
000E57 4E57 EB               4      EX  DE,HL
000E58 4E58 3AC4F2          13      LD  A,(_BANK)
000E5B 4E5B 32EFF2          13      LD  (_DIR_BANK),A
000E5E 4E5E 3AC7F2          13      LD  A,(CLSZ_H)
000E61 4E61 87               4      ADD A,A     ;*2
000E62 4E62 87               4      ADD A,A     ;*4
000E63 4E63 87               4      ADD A,A     ;*8
000E64 4E64 4F               4      LD  C,A
000E65 4E65 C9              10      RET
                                
       4E66                     STATEMENT:
000E66 4E66 11B950          10      LD  DE,STR_CHDIR
000E69 4E69 CD9F50          17      CALL    CPPROCNM
000E6C 4E6C 2812            12      JR  Z,_CHDIR
000E6E 4E6E 11BF50          10      LD  DE,STR_CHDRV
000E71 4E71 CD9F50          17      CALL    CPPROCNM
000E74 4E74 281C            12      JR  Z,_CHDRV
000E76 4E76 11C550          10      LD  DE,STR_RAMDISK
000E79 4E79 CD9F50          17      CALL    CPPROCNM
000E7C 4E7C 2829            12      JR  Z,_RAMDISK
000E7E 4E7E 37               4      SCF
000E7F 4E7F C9              10      RET
       4E80                     _CHDIR:
000E80 4E80 7E               7      LD  A,(HL)
000E81 4E81 FE28             7      CP  '('
000E83 4E83 37               4      SCF
000E84 4E84 C0              11      RET NZ
000E85 4E85 CD4847          17      CALL    INIT_PARAM
000E88 4E88 CD3B4A          17      CALL    FILE_B
000E8B 4E8B CDBB4E          17      CALL    ROM_CD
000E8E 4E8E D0              11      RET NC
000E8F 4E8F C3F245          10      JP  ERROR_FILE_NOT_FOUND
                                
       4E92                     _CHDRV:
000E92 4E92 7E               7      LD  A,(HL)
000E93 4E93 FE28             7      CP  '('
000E95 4E95 37               4      SCF
000E96 4E96 C0              11      RET NZ
000E97 4E97 CD4847          17      CALL    INIT_PARAM
000E9A 4E9A E5              11      PUSH    HL
000E9B 4E9B CD3B4A          17      CALL    FILE_B
000E9E 4E9E E1              10      POP HL
000E9F 4E9F 23               6      INC HL
000EA0 4EA0 3AF8F2          13      LD  A,(FDRV)
000EA3 4EA3 3D               4      DEC A
000EA4 4EA4 C30555          10      JP  _SYS0EX1
                                
       4EA7                     _RAMDISK:
000EA7 4EA7 7E               7      LD  A,(HL)
000EA8 4EA8 FE28             7      CP  '('
000EAA 4EAA 37               4      SCF
000EAB 4EAB C0              11      RET NZ
000EAC 4EAC 23               6      INC HL
000EAD 4EAD DD212F54        14      LD  IX,FRMQNT
000EB1 4EB1 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000EB5 4EB5 CD1C00          17      CALL    _CALSLT
                                ;   LD  A,(HOKVLD)  ;bit0: 拡張 BIOSの存在
                                ;   CPL
                                ;   AND 1
                                ;   LD  A,D
                                ;   OR  E
                                ;   JP  NZ,ERROR_INTERNAL_ERROR
                                ;   PUSH    HL      ;EXTBIOもDISK BIOSで初期化してそう
                                ;   XOR A
                                ;   LD  DE,0401H    ;D=マッパサポートルチン(4) E=機能番号(1)
                                ;   CALL    EXTBIO
                                ;   POP HL
                                ;   OR  A
                                ;   JP  Z,ERROR_INTERNAL_ERROR
000EB8 4EB8 23               6      INC HL
000EB9 4EB9 AF               4      XOR A
000EBA 4EBA C9              10      RET
                                
       4EBB                     ROM_CD:
000EBB 4EBB 3AF9F2          13      LD  A,(FNAME)
000EBE 4EBE FE20             7      CP  020H
000EC0 4EC0 2822            12      JR  Z,CD1
000EC2 4EC2 CDBA4B          17      CALL    ROM_OPEN
000EC5 4EC5 D8              11      RET C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
000EC6 4EC6 FD2AEDF2        20      LD  IY,(DIRENT1)
000ECA 4ECA FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
000ECE 4ECE CAF245          10      JP  Z,ERROR_FILE_NOT_FOUND
000ED1 4ED1 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000ED4 4ED4 FD661B          19      LD  H,(IY+01BH)
                                #endif
       4ED7                     CD2:
000ED7 4ED7 22EBF2          16      LD  (_CD),HL
000EDA 4EDA 2AF4F2          16      LD  HL,(PARAM1)
       4EDD                     CD_SKIP:
000EDD 4EDD 7E               7      LD  A,(HL)
000EDE 4EDE 23               6      INC HL
000EDF 4EDF FE21             7      CP  021H
000EE1 4EE1 38FA            12      JR  C,CD_SKIP
000EE3 4EE3 C9              10      RET
       4EE4                     CD1:
000EE4 4EE4 2AF6F2          16      LD  HL,(_CDX)
000EE7 4EE7 18EE            12      JR  CD2
                                
       4EE9                     GET_BASIC_FCB:
000EE9 4EE9 D5              11      PUSH    DE
000EEA 4EEA 23               6      INC HL  ;+1
000EEB 4EEB 5E               7      LD  E,(HL)  ;FCB[1]
000EEC 4EEC 23               6      INC HL  ;+2
000EED 4EED 56               7      LD  D,(HL)  ;FCB[2]
000EEE 4EEE 23               6      INC HL  ;+3
000EEF 4EEF ED53EDF2        20      LD  (DIRENT1),DE
                                            ;FCB[3] backup char
000EF3 4EF3 23               6      INC HL  ;+4
                                            ;FCB[4]
000EF4 4EF4 23               6      INC HL  ;+5
000EF5 4EF5 7E               7      LD  A,(HL)  ;FCB[5]
000EF6 4EF6 23               6      INC HL  ;+6
000EF7 4EF7 32EFF2          13      LD  (_DIR_BANK),A
000EFA 4EFA 5E               7      LD  E,(HL)  ;FCB[6]
000EFB 4EFB 23               6      INC HL  ;+7
000EFC 4EFC 56               7      LD  D,(HL)  ;FCB[7]
000EFD 4EFD 23               6      INC HL  ;+8
000EFE 4EFE ED53CAF2        20      LD  (RR_LOW),DE
000F02 4F02 7E               7      LD  A,(HL)  ;FCB[8]
000F03 4F03 23               6      INC HL  ;+9
000F04 4F04 32CCF2          13      LD  (RR_HIGH),A
000F07 4F07 22D4F2          16      LD  (_DTA),HL   ;FCB[9]
000F0A 4F0A D1              10      POP DE
000F0B 4F0B C9              10      RET
                                
       4F0C                     SET_BASIC_FCB:
000F0C 4F0C E5              11      PUSH    HL
000F0D 4F0D 2A64F8          16      LD  HL,(PTRFIL)
000F10 4F10 23               6      INC HL  ;+1
000F11 4F11 D5              11      PUSH    DE
000F12 4F12 ED5BEDF2        20      LD  DE,(DIRENT1)
000F16 4F16 73               7      LD  (HL),E  ;FCB[1]
000F17 4F17 23               6      INC HL  ;+2
000F18 4F18 72               7      LD  (HL),D  ;FCB[2]
000F19 4F19 23               6      INC HL  ;+3
000F1A 4F1A 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
000F1B 4F1B 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
000F1C 4F1C 23               6      INC HL  ;+5
000F1D 4F1D 3AEFF2          13      LD  A,(_DIR_BANK)
000F20 4F20 77               7      LD  (HL),A  ;FCB[5]
000F21 4F21 23               6      INC HL  ;+6
000F22 4F22 ED5BCAF2        20      LD  DE,(RR_LOW)
000F26 4F26 73               7      LD  (HL),E  ;FCB[6]
000F27 4F27 23               6      INC HL  ;+7
000F28 4F28 72               7      LD  (HL),D  ;FCB[7]
000F29 4F29 23               6      INC HL  ;+8
000F2A 4F2A 3ACCF2          13      LD  A,(RR_HIGH)
000F2D 4F2D 77               7      LD  (HL),A  ;FCB[8]
000F2E 4F2E D1              10      POP DE
000F2F 4F2F E1              10      POP HL
000F30 4F30 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_18:BACKUP
                                ;in
                                ;   C : backup charactor
                                ;   HL: FBC pointer
                                ;out
       4F31                     DEVICE_18_BACKUP:
000F31 4F31 D5              11      PUSH    DE
000F32 4F32 E5              11      PUSH    HL
000F33 4F33 110300          10      LD  DE,3
000F36 4F36 19              11      ADD HL,DE
000F37 4F37 71               7      LD  (HL),C
000F38 4F38 E1              10      POP HL
000F39 4F39 D1              10      POP DE
000F3A 4F3A C9              10      RET
                                
       4F3B                     DEVICE_CHECK:
000F3B 4F3B 23               6      INC HL
000F3C 4F3C 7E               7      LD  A,(HL)
000F3D 4F3D 2B               6      DEC HL
000F3E 4F3E B7               4      OR  A
000F3F 4F3F C8              11      RET Z
000F40 4F40 11CD50          10      LD  DE,STR_ROM
000F43 4F43 CD9F50          17      CALL    CPPROCNM
000F46 4F46 2802            12      JR  Z,DEVICE_OK
000F48 4F48 37               4      SCF
000F49 4F49 C9              10      RET
       4F4A                     DEVICE_OK:
000F4A 4F4A AF               4      XOR A
000F4B 4F4B C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファ
                                
       4F4C                     DEVICE_0_OPEN:
000F4C 4F4C 7B               4      LD  A,E
000F4D 4F4D FE02             7      CP  2       ;FOR OUTPUT
000F4F 4F4F 281B            12      JR  Z,OPEN2
000F51 4F51 D5              11      PUSH    DE
000F52 4F52 E5              11      push    hl
                                ;
000F53 4F53 3E01             7      LD  A,1     ;ドライブA
000F55 4F55 32F8F2          13      LD  (FDRV),A
000F58 4F58 2166F8          10      LD  HL,FILNAM
000F5B 4F5B 11F9F2          10      LD  DE,FNAME
000F5E 4F5E 010B00          10      LD  BC,8+3
000F61 4F61 CD8256          17      CALL    INIT_FILE1
000F64 4F64 CDBA4B          17      CALL    ROM_OPEN
000F67 4F67 DAF245          10      JP  C,ERROR_FILE_NOT_FOUND
000F6A 4F6A E1              10      pop hl
000F6B 4F6B D1              10      POP DE
       4F6C                     OPEN2:
000F6C 4F6C 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
000F6F 4F6F 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
000F70 4F70 AF               4      XOR A
000F71 4F71 32F0F2          13      LD  (LEFTX),A
000F74 4F74 CD0C4F          17      CALL    SET_BASIC_FCB
000F77 4F77 7B               4      ld  a,e
000F78 4F78 FE08             7      cp  8
000F7A 4F7A 3F               4      ccf
000F7B 4F7B C9              10      ret
                                
       4F7C                     DEVICE_2_CLOSE:
000F7C 4F7C AF               4      XOR A
                                ;   LD  (HL),A
000F7D 4F7D 6F               4      LD  L,A
000F7E 4F7E 67               4      LD  H,A
000F7F 4F7F 2264F8          16      LD  (PTRFIL),HL
000F82 4F82 C9              10      RET
                                
       4F83                     DEVICE_ENTRY:
000F83 4F83 FE08             7      CP  8
000F85 4F85 2826            12      JR  Z,DEVICE_8_SIN
000F87 4F87 3C               4      INC A
000F88 4F88 28B1            12      JR  Z,DEVICE_CHECK:
000F8A 4F8A 3D               4      DEC A
000F8B 4F8B 28BF            12      JR  Z,DEVICE_0_OPEN
000F8D 4F8D FE0E             7      CP  14
000F8F 4F8F 2860            12      JR  Z,DEVICE_14_EOF
000F91 4F91 FE04             7      CP  4
000F93 4F93 2834            12      JR  Z,DEVICE_4_RANDOM
000F95 4F95 FE0A             7      CP  10
000F97 4F97 2850            12      JR  Z,DEVICE_10_LOC
000F99 4F99 FE0C             7      CP  12
000F9B 4F9B 2878            12      JR  Z,DEVICE_12_LOF
000F9D 4F9D FE02             7      CP  2
000F9F 4F9F 2890            12      JR  Z,DEVICE_18_BACKUP  
000FA1 4FA1 FE02             7      CP  2
000FA3 4FA3 28D7            12      JR  Z,DEVICE_2_CLOSE
000FA5 4FA5 FE06             7      CP  6
000FA7 4FA7 2802            12      JR  Z,DEVICE_6_SOUT
000FA9 4FA9 37               4      SCF
000FAA 4FAA C9              10      RET
                                
       4FAB                     DEVICE_6_SOUT:
000FAB 4FAB AF               4      XOR A
000FAC 4FAC C9              10      RET
                                
       4FAD                     DEVICE_8_SIN:
000FAD 4FAD CDE94E          17      CALL    GET_BASIC_FCB
000FB0 4FB0 210100          10      LD  HL,1
000FB3 4FB3 CD9A49          17      CALL    ROM_READ
000FB6 4FB6 7C               4      LD  A,H
000FB7 4FB7 B5               4      OR  L
000FB8 4FB8 280D            12      JR  Z,CCF_RET
000FBA 4FBA 2AD4F2          16      LD  HL,(_DTA)
000FBD 4FBD 7E               7      LD  A,(HL)
000FBE 4FBE F5              11      PUSH    AF
000FBF 4FBF CD0C4F          17      CALL    SET_BASIC_FCB
000FC2 4FC2 F1              10      POP AF
000FC3 4FC3 FE0A             7      CP  00AH
000FC5 4FC5 C8              11      RET Z   ;ZF=separate
                                ;   CP  01AH
                                ;   JR  Z,SCF_RET
000FC6 4FC6 37               4      SCF     ;
       4FC7                     CCF_RET:
000FC7 4FC7 3F               4      CCF     ;ZF=0 CF=0にしたい
000FC8 4FC8 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_4:RANDOM
                                ;in
                                ;   A : 4
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
       4FC9                     DEVICE_4_RANDOM:
000FC9 4FC9 D5              11      PUSH    DE
000FCA 4FCA CDE94E          17      CALL    GET_BASIC_FCB
000FCD 4FCD DDE5            15      PUSH    IX
000FCF 4FCF DD218A2F        14      LD  IX,FRCINT
000FD3 4FD3 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000FD7 4FD7 CDB1F2          17      CALL    CAL_MP
000FDA 4FDA DDE1            14      POP IX
000FDC 4FDC 2AF8F7          16      LD  HL,(DACDAT)
000FDF 4FDF 22CAF2          16      LD  (RR_LOW),HL
000FE2 4FE2 AF               4      XOR A
000FE3 4FE3 CD0C4F          17      CALL    SET_BASIC_FCB
000FE6 4FE6 D1              10      POP DE
000FE7 4FE7 AF               4      XOR A
000FE8 4FE8 C9              10      RET
                                
                                ;FUNC_10:LOC
                                ;in
                                ;   A : 10
                                ;out
                                ;   DAC    : value of received bytes
                                ;   VALTYP : DAC type
       4FE9                     DEVICE_10_LOC:
000FE9 4FE9 CDE94E          17      CALL    GET_BASIC_FCB
000FEC 4FEC 2ACAF2          16      LD  HL,(RR_LOW)
000FEF 4FEF 183D            12      JR  RETURN_TYPE8_AHL
                                
                                ;--------------------------------------
                                ;FUNC_14:EOF
                                ;in
                                ;   A : 14
                                ;out
                                ;   DAC    : value of EOF value (EOF=-1)
                                ;   VALTYP : DAC type
       4FF1                     DEVICE_14_EOF:
000FF1 4FF1 CDE94E          17      CALL    GET_BASIC_FCB
000FF4 4FF4 CD4C4C          17      CALL    RBX1
000FF7 4FF7 3810            12      JR  C,DEVICE_14_EOF1
000FF9 4FF9 210100          10      LD  HL,1
000FFC 4FFC CD9A49          17      CALL    ROM_READ
000FFF 4FFF 2AD4F2          16      LD  HL,(_DTA)
001002 5002 7E               7      LD  A,(HL)
001003 5003 FE1A             7      CP  01AH
001005 5005 37               4      SCF
001006 5006 2801            12      JR  Z,DEVICE_14_EOF1
001008 5008 3F               4      CCF
       5009                     DEVICE_14_EOF1:
001009 5009 9F               4      SBC A,A
00100A 500A 6F               4      LD  L,A
00100B 500B 67               4      LD  H,A
       500C                     return_type2_hl:
00100C 500C 22F8F7          16      ld  (DACDAT),hl
00100F 500F 3E02             7      ld  a,2
001011 5011 3263F6          13      ld  (VALTYP),a
001014 5014 C9              10      ret
                                
                                ;--------------------------------------
                                ;FUNC_16:FPOS
                                ;in
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
                                ;   illegal function call
                                
                                ;--------------------------------------
                                ;FUNC_12:LOF
                                ;in
                                ;   A : 12
                                ;out
                                ;   DAC    : value of LOC+RSIQLN
                                ;   VALTYP : DAC type
       5015                     DEVICE_12_LOF:
001015 5015 CDE94E          17      CALL    GET_BASIC_FCB
                                
001018 5018 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001CH
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    CALL    RDSLT_ROM
                                    EX  DE,HL       ;AHL=File size
                                    POP DE
                                #else
00101B 501B 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
00101E 501E 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
001021 5021 FD2AEDF2        20      LD  IY,(DIRENT1)
001025 5025 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
001028 5028 FD661D          19      LD  H,(IY+01DH)
00102B 502B FD7E1E          19      LD  A,(IY+01EH)
                                #endif
       502E                     RETURN_TYPE8_AHL:
00102E 502E B7               4      OR  A
00102F 502F 2004            12      JR  NZ,RT8AHL1
001031 5031 CB7C             8      BIT 7,H
001033 5033 28D7            12      JR  Z,return_type2_hl
       5035                     RT8AHL1:
001035 5035 E5              11      PUSH    HL
001036 5036 29              11      ADD HL,HL
001037 5037 8F               4      ADC A,A
001038 5038 32F8F7          13      LD  (DACDAT),A
00103B 503B 3E00             7      LD  A,0
00103D 503D 8F               4      ADC A,A
00103E 503E 32F9F7          13      LD  (DACDAT+1),A
                                
001041 5041 3E02             7      LD  A,2
001043 5043 3263F6          13      LD  (VALTYP),A
001046 5046 DD213A30        14      LD  IX,FRCDBL
00104A 504A FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00104E 504E CDB1F2          17      CALL    CAL_MP
                                
001051 5051 219750          10      LD  HL,DBL32768
001054 5054 1147F8          10      LD  DE,ARG
001057 5057 010800          10      LD  BC,8
00105A 505A EDB0                    LDIR
                                
00105C 505C DD21E627        14      LD  IX,DECMUL
001060 5060 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001064 5064 CDB1F2          17      CALL    CAL_MP
                                
001067 5067 21F6F7          10      LD  HL,DAC
00106A 506A 1147F8          10      LD  DE,ARG
00106D 506D 010800          10      LD  BC,8
001070 5070 EDB0                    LDIR
                                
001072 5072 E1              10      POP HL
001073 5073 22F8F7          16      LD  (DACDAT),HL
                                
001076 5076 3E02             7      LD  A,2
001078 5078 3263F6          13      LD  (VALTYP),A
00107B 507B DD213A30        14      LD  IX,FRCDBL
00107F 507F FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001083 5083 CDB1F2          17      CALL    CAL_MP
                                
001086 5086 DD219A26        14      LD  IX,DECADD
00108A 508A FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00108E 508E CDB1F2          17      CALL    CAL_MP
                                
001091 5091 3E08             7      LD  A,8
001093 5093 3263F6          13      LD  (VALTYP),A
001096 5096 C9              10      RET
                                
       5097                     DBL32768:
001097 5097 4532768000000000        DB  045H,032H,076H,080H,0,0,0,0
                                
       509F                     CPPROCNM:
00109F 509F E5              11      PUSH    HL
0010A0 50A0 2189FD          10      LD  HL,PROCNM
       50A3                     CPPROCNM1:
0010A3 50A3 1A               7      LD  A,(DE)
0010A4 50A4 13               6      INC DE
0010A5 50A5 BE               7      CP  (HL)
0010A6 50A6 23               6      INC HL
0010A7 50A7 2003            12      JR  NZ,CPPROCNM2
0010A9 50A9 B7               4      OR  A
0010AA 50AA 20F7            12      JR  NZ,CPPROCNM1
       50AC                     CPPROCNM2:
0010AC 50AC E1              10      POP HL
0010AD 50AD C9              10      RET
                                
       50AE                     WILDCARD:
0010AE 50AE 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       50B9                     STR_CHDIR:
0010B9 50B9 434844495200            DB  "CHDIR",0
       50BF                     STR_CHDRV:
0010BF 50BF 434844525600            DB  "CHDRV",0
       50C5                     STR_RAMDISK:
0010C5 50C5 52414D4449534B00        DB  "RAMDISK",0
       50CD                     STR_ROM:
0010CD 50CD 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       50D1                     ERROR_WRITE_PROTECTED:
0010D1 50D1 3E00             7      LD  A,0     ;Write protected
0010D3 50D3 C9              10      RET
       50D4                     DISKIO:
0010D4 50D4 38FB            12      JR  C,ERROR_WRITE_PROTECTED
0010D6 50D6 48               4      LD  C,B
0010D7 50D7 CDA652          17      CALL    GET_DISK_BANK
       50DA                     SETMAP1:        
0010DA 50DA E5              11      PUSH    HL
       50DB                     DISKIO1:
0010DB 50DB C5              11      PUSH    BC      ;B=残りのセクタ数
0010DC 50DC D5              11      PUSH    DE      ;DE=セクタ番号
0010DD 50DD F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
0010DE 50DE EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
0010DF 50DF F5              11      PUSH    AF
0010E0 50E0 3AC9F2          13      LD  A,(SECSZ_H)
0010E3 50E3 CDCC52          17      CALL    MUL_AHL
0010E6 50E6 F1              10      POP AF
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  A,L
                                    PUSH    BC
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    POP BC
                                    JR  NC,DISKIO2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
0010E7 50E7 4D               4      LD  C,L     ;C=読み出し元
0010E8 50E8 29              11      ADD HL,HL       ;64KB→32KB
0010E9 50E9 29              11      ADD HL,HL       ;32KB→16KB
0010EA 50EA 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
0010EB 50EB 84               4      ADD A,H
0010EC 50EC 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0010EF 50EF 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0010F2 50F2 32C4F2          13      LD  (_BANK),A
0010F5 50F5 79               4      LD  A,C     ;C=読み出し元
0010F6 50F6 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       50F8                     DISKIO2:
0010F8 50F8 C660             7      ADD A,high BANK1_ADR
0010FA 50FA 67               4      LD  H,A
0010FB 50FB ED4BC8F2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
0010FF 50FF 69               4      LD  L,C     ;C=0
001100 5100 CD1344          17      CALL    ROM_LDIR
001103 5103 EB               4      EX  DE,HL
001104 5104 F1              10      POP AF
001105 5105 D1              10      POP DE
001106 5106 13               6      INC DE
001107 5107 C1              10      POP BC
001108 5108 10D1            13      DJNZ    DISKIO1
00110A 510A 41               4      LD  B,C
                                
00110B 510B E1              10      POP HL
00110C 510C AF               4      XOR A
                                
00110D 510D FB               4      EI
00110E 510E C9              10      RET
                                
       510F                     DSKCHG:
00110F 510F CD4851          17      CALL    IS_BPB
001112 5112 3824            12      JR  C,NOTREADY
001114 5114 3A23FB          13      LD  A,(DRVTBL+2)
001117 5117 B7               4      OR  A
001118 5118 201A            12      JR  NZ,DSKCHG1
00111A 511A 3A21FB          13      LD  A,(DRVTBL)
00111D 511D FE02             7      CP  2
00111F 511F 2013            12      JR  NZ,DSKCHG1
001121 5121 CD4851          17      CALL    IS_BPB
001124 5124 300E            12      JR  NC,DSKCHG1
001126 5126 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
001128 5128 3221FB          13      LD  (DRVTBL),A
00112B 512B 3223FB          13      LD  (DRVTBL+2),A
00112E 512E 3A48F3          13      LD  A,(MASTERS)
001131 5131 3224FB          13      LD  (DRVTBL+3),A
       5134                     DSKCHG1:
001134 5134 AF               4      XOR A
001135 5135 0601             7      LD  B,1
001137 5137 C9              10      RET
       5138                     NOTREADY:
001138 5138 3E02             7      LD  A,2
00113A 513A 37               4      SCF
00113B 513B C9              10      RET
                                
       513C                     NO_BPB:
00113C 513C E1              10      POP HL
00113D 513D 23               6      INC HL
00113E 513E 11D252          10      LD  DE,DPB2DD
001141 5141 011200          10      LD  BC,DPB2DD_E-DPB2DD
001144 5144 EDB0                    LDIR
001146 5146 AF               4      XOR A
001147 5147 C9              10      RET
                                
       5148                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
001148 5148 CDA652          17      CALL    GET_DISK_BANK
                                
00114B 514B 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
00114E 514E FE01             7      CP  1
001150 5150 D8              11      RET C
                                
001151 5151 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
001154 5154 C6FF             7      ADD A,0FFH
001156 5156 D8              11      RET C
                                
001157 5157 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       515A                     IS_BPB1:
00115A 515A FE01             7      CP  1
00115C 515C C8              11      RET Z
00115D 515D FE02             7      CP  2
00115F 515F C8              11      RET Z
001160 5160 FE04             7      CP  4
001162 5162 C8              11      RET Z
001163 5163 37               4      SCF
001164 5164 C9              10      RET
                                
       5165                     GETDPB:
001165 5165 E5              11      PUSH    HL
001166 5166 CDA652          17      CALL    GET_DISK_BANK
                                
001169 5169 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
00116C 516C B7               4      OR  A
00116D 516D 28CD            12      JR  Z,NO_BPB
00116F 516F DDE1            14      POP IX
001171 5171 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
001174 5174 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
001177 5177 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
00117A 517A 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
00117D 517D DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
001180 5180 87               4      ADD A,A
001181 5181 87               4      ADD A,A
001182 5182 87               4      ADD A,A
001183 5183 3D               4      DEC A
001184 5184 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
001187 5187 06FF             7      LD  B,-1
001189 5189 A7               4      AND A           ;無限ループ阻止
       518A                     GETDPB1:
00118A 518A 04               4      INC B
00118B 518B 1F               4      RRA
00118C 518C 38FC            12      JR  C,GETDPB1
00118E 518E DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
001191 5191 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
001194 5194 3D               4      DEC A
001195 5195 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
001198 5198 A7               4      AND A           ;無限ループ阻止
001199 5199 06FF             7      LD  B,-1
       519B                     GETDPB2:
00119B 519B 04               4      INC B
00119C 519C 1F               4      RRA
00119D 519D 38FC            12      JR  C,GETDPB2
00119F 519F 04               4      INC B
0011A0 51A0 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
0011A3 51A3 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
0011A6 51A6 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
0011A9 51A9 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
0011AC 51AC 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
0011AF 51AF DD770A          19      LD  (IX+10),A       ;FATCNT
                                
0011B2 51B2 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
0011B5 51B5 DD770B          19      LD  (IX+11),A       ;MAXENT
                                
0011B8 51B8 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
0011BC 51BC DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
0011BF 51BF DD460A          19      LD  B,(IX+10)       ;FATCNT
0011C2 51C2 210000          10      LD  HL,0
       51C5                     GETDPB3:
0011C5 51C5 19              11      ADD HL,DE
0011C6 51C6 10FD            13      DJNZ    GETDPB3
       51C8                     GETDPB4:
0011C8 51C8 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
0011CB 51CB DD5609          19      LD  D,(IX+9)        ;FIRFAT
0011CE 51CE 19              11      ADD HL,DE
0011CF 51CF DD7511          19      LD  (IX+17),L       ;FIRDIR
0011D2 51D2 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
0011D5 51D5 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0011D8 51D8 87               4      ADD A,A
0011D9 51D9 87               4      ADD A,A
0011DA 51DA DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       51DD                     GETDPB5:
0011DD 51DD CB3B             8      SRL E
0011DF 51DF 1F               4      RRA
0011E0 51E0 30FB            12      JR  NC,GETDPB5
0011E2 51E2 1600             7      LD  D,0
0011E4 51E4 19              11      ADD HL,DE
0011E5 51E5 DD750C          19      LD  (IX+12),L       ;FIRREC
0011E8 51E8 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
0011EB 51EB 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
0011EE 51EE DD5E0C          19      LD  E,(IX+12)       ;FIRREC
0011F1 51F1 DD560D          19      LD  D,(IX+13)       ;FIRREC
0011F4 51F4 A7               4      AND A
0011F5 51F5 ED52            15      SBC HL,DE
                                
0011F7 51F7 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
0011FA 51FA 3C               4      INC A
0011FB 51FB 37               4      SCF             ;無限ループ阻止
       51FC                     GETDPB6:
0011FC 51FC 1F               4      RRA
0011FD 51FD 3806            12      JR  C,GETDPB7
0011FF 51FF CB3C             8      SRL H
001201 5201 CB1D             8      RR  L
001203 5203 18F7            12      JR  GETDPB6
       5205                     GETDPB7:
001205 5205 23               6      INC HL
001206 5206 DD750E          19      LD  (IX+14),L       ;MAXCLUS
001209 5209 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       520C                     GETDPBD1:
00120C 520C DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
00120F 520F E6FC             7      AND 0FCH
001211 5211 C8              11      RET Z
                                
001212 5212 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
001216 5216 37               4      SCF
001217 5217 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
00121B 521B DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
00121E 521E DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
001222 5222 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
001226 5226 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
00122A 522A DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
00122E 522E DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
001232 5232 DDCB1126        23      SLA (IX+17)         ;FIRDIR
001236 5236 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
00123A 523A DD6E11          19      LD  L,(IX+17)       ;FIRDIR
00123D 523D DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
001240 5240 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001243 5243 87               4      ADD A,A
001244 5244 87               4      ADD A,A
001245 5245 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       5248                     GETDPBD5:
001248 5248 CB3B             8      SRL E
00124A 524A 1F               4      RRA
00124B 524B 30FB            12      JR  NC,GETDPBD5
00124D 524D 1600             7      LD  D,0
00124F 524F 19              11      ADD HL,DE
001250 5250 DD750C          19      LD  (IX+12),L       ;FIRREC
001253 5253 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001256 5256 18B4            12      JR  GETDPBD1
                                
       5258                     CHOICE:
001258 5258 210000          10      LD  HL,0
00125B 525B C9              10      RET
                                
       525C                     DSKFMT:
00125C 525C AF               4      XOR A
00125D 525D 37               4      SCF
       525E                     DSKSTP:
00125E 525E C9              10      RET
                                
       525F                     BASENT:
00125F 525F 2A74F6          16      LD  HL,(STKTOP)
001262 5262 3A40F3          13      LD  A,(REBOOT)
001265 5265 C6FF             7      ADD A,0FFH
001267 5267 3811            12      JR  C,REBOOT1
001269 5269 21E452          10      LD  HL,AUTOEXEC
00126C 526C 11F8F2          10      LD  DE,FDRV
00126F 526F 010C00          10      LD  BC,1+8+3
001272 5272 EDB0                    LDIR
001274 5274 CDBA4B          17      CALL    ROM_OPEN
001277 5277 D43C45          17      CALL    NC,ROM_LOAD1
       527A                     REBOOT1:
00127A 527A 21F052          10      LD  HL,CMD_RUN
00127D 527D 111FF4          10      LD  DE,KBUF
001280 5280 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
001283 5283 D5              11      PUSH    DE
001284 5284 EDB0                    LDIR
001286 5286 3004            12      JR  NC,REBOOT2
001288 5288 AF               4      XOR A
001289 5289 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       528C                     REBOOT2:
00128C 528C E1              10      POP HL
00128D 528D FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
001291 5291 DD210146        14      LD  IX,NEWSTT
001295 5295 C31C00          10      JP  _CALSLT
                                
       5298                     GETSLT:
001298 5298 3A22FB          13      LD  A,(DRVTBL+1)
00129B 529B C9              10      RET
                                
       529C                     GET_DISK_BANK_FDRV:
00129C 529C 3AF8F2          13      LD  A,(FDRV)
00129F 529F D601             7      SUB 1
0012A1 52A1 3003            12      JR  NC,GET_DISK_BANK
0012A3 52A3 3AEAF2          13      LD  A,(_DVSW)
       52A6                     GET_DISK_BANK:
0012A6 52A6 FE07             7      CP  7       ;H:
0012A8 52A8 2801            12      JR  Z,SET_DISK_BANK_A
0012AA 52AA B7               4      OR  A       ;A=DRIVE
       52AB                     SET_DISK_BANK_A:
0012AB 52AB 3E01             7      LD  A,DISK_BANK
0012AD 52AD 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
0012AF 52AF 3AE9F2          13      LD  A,(B_DRIVE)
                                #endif
       52B2                     SET_DISK_BANK:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0012B2 52B2 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0012B5 52B5 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0012B8 52B8 F5              11      PUSH    AF
0012B9 52B9 E5              11      PUSH    HL
0012BA 52BA 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
0012BD 52BD 22C8F2          16      LD  (SECSZ),HL
0012C0 52C0 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0012C3 52C3 CDCC52          17      CALL    MUL_AHL
0012C6 52C6 22C6F2          16      LD  (CLSZ),HL
0012C9 52C9 E1              10      POP HL
0012CA 52CA F1              10      POP AF
0012CB 52CB C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       52CC                     MUL_AHL:
0012CC 52CC 37               4      SCF     ;無限ループ回避
       52CD                     MUL_AHL1:
0012CD 52CD 1F               4      RRA     ;->CF
0012CE 52CE D8              11      RET C
0012CF 52CF 29              11      ADD HL,HL
0012D0 52D0 18FB            12      JR  MUL_AHL1
                                
       52D2                     DPB2DD:
0012D2 52D2 F9                      DB  0F9H    ;MEDIA
0012D3 52D3 0002                    DW  00200H  ;SECSIZ
0012D5 52D5 0F                      DB  00FH    ;DIRMSK
0012D6 52D6 04                      DB  004H    ;DIRSHFT
0012D7 52D7 01                      DB  001H    ;CLUSMSK
0012D8 52D8 02                      DB  002H    ;CLUSSHFT
0012D9 52D9 0100                    DW  00001H  ;FIRFAT
0012DB 52DB 02                      DB  002H    ;FATCNT
0012DC 52DC 70                      DB  070H    ;MAXENT
0012DD 52DD 0E00                    DW  0000EH  ;FIRREC
0012DF 52DF CA02                    DW  002CAH  ;MAXCLUS
0012E1 52E1 03                      DB  003H    ;FATSIZ
0012E2 52E2 0700                    DW  0007H   ;FIRDIR
       52E4                     DPB2DD_E:
                                
       52E4                     AUTOEXEC:
0012E4 52E4 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       52F0                     CMD_RUN:
0012F0 52F0 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DW  0F280H
                                #else
0012F6 52F6 40F2                    DW  0F240H
                                #endif
       52F8                     CMD_CLEAR_E:
0012F8 52F8 3A8A00                  DB  03AH,08AH,0         ;RUN
       52FB                     CMD_RUN_E:
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       52FB                     POP_HL_ERROR:
0012FB 52FB E1              10      POP     HL
       52FC                     _ERROR:
0012FC 52FC 0600             7      LD  B,0
0012FE 52FE A7               4      AND A
0012FF 52FF C9              10      RET
                                
       5300                     ROM_BDOS:
001300 5300 E5              11      PUSH    HL
001301 5301 79               4      LD  A,C
001302 5302 87               4      ADD A,A
001303 5303 38F7            12      JR  C,_ERROR
001305 5305 6F               4      LD  L,A
001306 5306 265F             7      LD  H,high STABLE
001308 5308 7E               7      LD  A,(HL)
001309 5309 2C               4      INC L
00130A 530A 66               7      LD  H,(HL)
00130B 530B 6F               4      LD  L,A
00130C 530C E3              19      EX  (SP),HL
00130D 530D 79               4      LD  A,C
00130E 530E C9              10      RET
                                
       530F                     _PRINT:
       530F                     PRINT:
00130F 530F 7B               4      LD  A,E
001310 5310 1803            12      JR  MSG_A
                                
       5312                     _SYS01:     ;(BDOS)コンソール入力
001312 5312 CD8953          17      CALL    _SYS07
       5315                     MSG_A:
001315 5315 FE03             7      CP  3
001317 5317 2814            12      JR  Z,MSG_BR
       5319                     MSGA1:
001319 5319 F5              11      PUSH    AF
00131A 531A C5              11      PUSH    BC
00131B 531B D5              11      PUSH    DE
00131C 531C E5              11      PUSH    HL
00131D 531D DDE5            15      PUSH    IX
00131F 531F DD21A200        14      LD  IX,CHPUT
001323 5323 CDD742          17      CALL    CALSLT_R
001326 5326 DDE1            14      POP IX
001328 5328 E1              10      POP HL
001329 5329 D1              10      POP DE
00132A 532A C1              10      POP BC
       532B                     MSGA2:
00132B 532B F1              10      POP AF
00132C 532C C9              10      RET
       532D                     MSG_BR:
00132D 532D F5              11      PUSH    AF
00132E 532E 3ADDF3          13      LD  A,(CSRX)
001331 5331 FE02             7      CP  2
001333 5333 38F6            12      JR  C,MSGA2
001335 5335 F1              10      POP AF
       5336                     MSG_CR:
001336 5336 F5              11      PUSH    AF
001337 5337 3E0D             7      LD  A,00DH
001339 5339 CD1953          17      CALL    MSGA1
00133C 533C 3E0A             7      LD  A,00AH
00133E 533E CD1953          17      CALL    MSGA1
001341 5341 F1              10      POP AF
001342 5342 C9              10      RET
                                
       5343                     _SYS02:     ;(BDOS)コンソール出力
001343 5343 CD5E53          17      CALL    BREAK
001346 5346 1805            12      JR  PRINTX
                                
       5348                     _SYS06:     ;(BDOS)コンソール直接入出力
001348 5348 7B               4      LD  A,E
001349 5349 3C               4      INC A
00134A 534A CA9D53          10      JP  Z,_INKEY
       534D                     PRINTX:
00134D 534D C30F53          10      JP  _PRINT
                                
       5350                     _SYS08:     ;(BDOS)エコーなしコンソール入力
001350 5350 CD8953          17      CALL    _SYS07
001353 5353 FE03             7      CP  3
001355 5355 CC5E53          17      CALL    Z,_BREAK
001358 5358 FE13             7      CP  013H        ;CTRL+S
00135A 535A C0              11      RET NZ
       535B                     PAUSE:
00135B 535B CD7553          17      CALL    KEYBC
                                
       535E                     _BREAK:
       535E                     BREAK:
00135E 535E F5              11      PUSH    AF
00135F 535F C5              11      PUSH    BC
001360 5360 D5              11      PUSH    DE
001361 5361 E5              11      PUSH    HL
001362 5362 DDE5            15      PUSH    IX
001364 5364 DD21B700        14      LD  IX,BREAKX
001368 5368 CDD742          17      CALL    CALSLT_R
00136B 536B DDE1            14      POP IX
00136D 536D E1              10      POP HL
00136E 536E D1              10      POP DE
00136F 536F C1              10      POP BC
001370 5370 DC5E53          17      CALL    C,_BREAK
001373 5373 F1              10      POP AF
001374 5374 C9              10      RET
       5375                     KEYBC:
001375 5375 F5              11      PUSH    AF
001376 5376 C5              11      PUSH    BC
001377 5377 D5              11      PUSH    DE
001378 5378 E5              11      PUSH    HL
001379 5379 DDE5            15      PUSH    IX
00137B 537B DD215601        14      LD  IX,KILBUF
00137F 537F CDD742          17      CALL    CALSLT_R
001382 5382 DDE1            14      POP IX
001384 5384 E1              10      POP HL
001385 5385 D1              10      POP DE
001386 5386 C1              10      POP BC
001387 5387 F1              10      POP AF
001388 5388 C9              10      RET
                                
       5389                     _SYS07:
       5389                     FLGET:
001389 5389 C5              11      PUSH    BC
00138A 538A D5              11      PUSH    DE
00138B 538B E5              11      PUSH    HL
00138C 538C DDE5            15      PUSH    IX
00138E 538E DD219F00        14      LD  IX,CHGET
001392 5392 CDD742          17      CALL    CALSLT_R
001395 5395 DDE1            14      POP IX
001397 5397 E1              10      POP HL
001398 5398 D1              10      POP DE
001399 5399 C1              10      POP BC
00139A 539A FE03             7      CP  3
00139C 539C C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       539D                     _INKEY:
       539D                     INKEY:
00139D 539D CD3754          17      CALL    CPM_CONST
0013A0 53A0 C8              11      RET Z
0013A1 53A1 18E6            12      JR  FLGET
                                
       53A3                     _SYS0A:     ;(BDOS)文字列入力
0013A3 53A3 C5              11      PUSH    BC
0013A4 53A4 E5              11      PUSH    HL
0013A5 53A5 D5              11      PUSH    DE
0013A6 53A6 CDCF53          17      CALL    GETL
0013A9 53A9 111FF4          10      LD  DE,KBUF
0013AC 53AC E1              10      POP HL
0013AD 53AD E5              11      PUSH    HL
0013AE 53AE 0E00             7      LD  C,0
0013B0 53B0 3004            12      JR  NC,SAX0
0013B2 53B2 23               6      INC HL
0013B3 53B3 23               6      INC HL
0013B4 53B4 1808            12      JR  SAX4
       53B6                     SAX0:
0013B6 53B6 46               7      LD  B,(HL)
0013B7 53B7 23               6      INC HL
       53B8                     SAX1:
0013B8 53B8 23               6      INC HL
0013B9 53B9 1A               7      LD  A,(DE)
0013BA 53BA 13               6      INC DE
0013BB 53BB B7               4      OR  A
0013BC 53BC 2004            12      JR  NZ,SAX2
       53BE                     SAX4:
0013BE 53BE 360D            10      LD  (HL),00DH
0013C0 53C0 1804            12      JR  SAX3
       53C2                     SAX2:
0013C2 53C2 77               7      LD  (HL),A
0013C3 53C3 0C               4      INC C
0013C4 53C4 10F2            13      DJNZ    SAX1
       53C6                     SAX3:
0013C6 53C6 D1              10      POP DE
0013C7 53C7 79               4      LD  A,C
0013C8 53C8 13               6      INC DE
0013C9 53C9 12               7      LD  (DE),A
0013CA 53CA 1B               6      DEC DE
0013CB 53CB E1              10      POP HL
0013CC 53CC C1              10      POP BC
0013CD 53CD A7               4      AND A
0013CE 53CE C9              10      RET
       53CF                     GETL:
0013CF 53CF DDE5            15      PUSH    IX
0013D1 53D1 FDE5            15      PUSH    IY
                                
0013D3 53D3 2ADCF3          16      LD  HL,(CSRY)
0013D6 53D6 22CAFB          16      LD  (FSTPOS),HL
       53D9                     GETL1:
0013D9 53D9 CD5053          17      CALL    _SYS08
0013DC 53DC FE09             7      CP  9
0013DE 53DE 2008            12      JR  NZ,GETL1V
0013E0 53E0 211FF4          10      LD  HL,KBUF
0013E3 53E3 CD6E43          17      CALL    MSX
0013E6 53E6 18F1            12      JR  GETL1
       53E8                     GETL1V:
0013E8 53E8 5F               4      LD  E,A
0013E9 53E9 FE08             7      CP  8
0013EB 53EB CC8554          17      CALL    Z,CTRL02
0013EE 53EE FE20             7      CP  020H
0013F0 53F0 D4B154          17      CALL    NC,INSERT
0013F3 53F3 CD1953          17      CALL    MSGA1
                                
0013F6 53F6 7B               4      LD  A,E
0013F7 53F7 FE0D             7      CP  00DH
0013F9 53F9 20DE            12      JR  NZ,GETL1
                                
0013FB 53FB 111FF4          10      LD  DE,KBUF
0013FE 53FE 3AB0F3          13      LD  A,(LINLEN)
001401 5401 47               4      LD  B,A
001402 5402 CD9456          17      CALL    ZERO_MEMORY_DE
                                
001405 5405 2ACAFB          16      LD  HL,(FSTPOS)
001408 5408 3ADCF3          13      LD  A,(CSRY)
00140B 540B 6F               4      LD  L,A
00140C 540C E5              11      PUSH    HL
00140D 540D CDE254          17      CALL    LOC0
001410 5410 4D               4      LD  C,L
001411 5411 44               4      LD  B,H
001412 5412 E1              10      POP HL
001413 5413 3AB0F3          13      LD  A,(LINLEN)
001416 5416 94               4      SUB H
001417 5417 3D               4      DEC A
001418 5418 5F               4      LD  E,A
001419 5419 211FF4          10      LD  HL,KBUF
       541C                     GETL2:
00141C 541C CD7554          17      CALL    _SCRN
00141F 541F 03               6      INC BC
001420 5420 77               7      LD  (HL),A
001421 5421 23               6      INC HL
001422 5422 1D               4      DEC E
001423 5423 20F7            12      JR  NZ,GETL2
001425 5425 CD3653          17      CALL    MSG_CR
                                
001428 5428 FDE1            14      POP IY
00142A 542A DDE1            14      POP IX
       542C                     GETL3:
00142C 542C 2B               6      DEC HL
00142D 542D 7E               7      LD  A,(HL)
00142E 542E FE21             7      CP  021H
001430 5430 D0              11      RET NC
001431 5431 3600            10      LD  (HL),0
001433 5433 15               4      DEC D
001434 5434 20F6            12      JR  NZ,GETL3
001436 5436 C9              10      RET
                                
       5437                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       5437                     CONSTX:
       5437                     CPM_CONST:
001437 5437 C5              11      PUSH    BC
001438 5438 D5              11      PUSH    DE
001439 5439 E5              11      PUSH    HL
00143A 543A DDE5            15      PUSH    IX
00143C 543C DD219C00        14      LD  IX,CHSNS
001440 5440 CDD742          17      CALL    CALSLT_R
001443 5443 DDE1            14      POP IX
001445 5445 E1              10      POP HL
001446 5446 D1              10      POP DE
001447 5447 C1              10      POP BC
001448 5448 C9              10      RET
                                
       5449                     _SYS2A:     ;(BDOS)日付の獲得
001449 5449 AF               4      XOR A
00144A 544A 57               4      LD  D,A
00144B 544B 5F               4      LD  E,A
00144C 544C 67               4      LD  H,A
00144D 544D 6F               4      LD  L,A
00144E 544E C9              10      RET
                                
       544F                     _SYS2C:     ;(BDOS)時刻の獲得
00144F 544F AF               4      XOR A
001450 5450 57               4      LD  D,A
001451 5451 5F               4      LD  E,A
001452 5452 67               4      LD  H,A
001453 5453 6F               4      LD  L,A
001454 5454 C9              10      RET
                                
       5455                     POS:
001455 5455 F5              11      PUSH    AF
001456 5456 2ADCF3          16      LD  HL,(CSRY)
001459 5459 7D               4      LD  A,L
00145A 545A 6C               4      LD  L,H
00145B 545B 67               4      LD  H,A
00145C 545C 2C               4      INC L
00145D 545D 24               4      INC H
00145E 545E F1              10      POP AF
00145F 545F C9              10      RET
                                
       5460                     LOC:
001460 5460 F5              11      PUSH    AF
001461 5461 E5              11      PUSH    HL
001462 5462 7D               4      LD  A,L
001463 5463 6C               4      LD  L,H
001464 5464 67               4      LD  H,A
001465 5465 2D               4      DEC L
001466 5466 25               4      DEC H
001467 5467 DDE5            15      PUSH    IX
001469 5469 DD21C600        14      LD  IX,POSIT
00146D 546D CDD742          17      CALL    CALSLT_R
001470 5470 DDE1            14      POP IX
001472 5472 E1              10      POP HL
001473 5473 F1              10      POP AF
001474 5474 C9              10      RET
                                
       5475                     _SCRN:
       5475                     SCRN:
001475 5475 E5              11      PUSH    HL
001476 5476 DDE5            15      PUSH    IX
                                
001478 5478 69               4      LD  L,C
001479 5479 60               4      LD  H,B
00147A 547A DD214A00        14      LD  IX,RDVRM
00147E 547E CDD742          17      CALL    CALSLT_R
                                
001481 5481 DDE1            14      POP IX
001483 5483 E1              10      POP HL
001484 5484 C9              10      RET
                                
       5485                     CTRL02:
001485 5485 F5              11      PUSH    AF
001486 5486 D5              11      PUSH    DE
001487 5487 2ADCF3          16      LD  HL,(CSRY)
00148A 548A 3AB0F3          13      LD  A,(LINLEN)
00148D 548D 4F               4      LD  C,A
00148E 548E 94               4      SUB H   ;CSRX
00148F 548F C602             7      ADD A,2
001491 5491 47               4      LD  B,A ;カーソルより右の文字数
001492 5492 61               4      LD  H,C ;LINLEN
001493 5493 C5              11      PUSH    BC
001494 5494 CDE254          17      CALL    LOC0
001497 5497 C1              10      POP BC
                                
001498 5498 1620             7      LD  D,020H
       549A                     C8X1:
00149A 549A DD214A00        14      LD  IX,RDVRM
00149E 549E CDD742          17      CALL    CALSLT_R
0014A1 54A1 4F               4      LD  C,A
0014A2 54A2 7A               4      LD  A,D
0014A3 54A3 DD214D00        14      LD  IX,WRTVRM
0014A7 54A7 CDD742          17      CALL    CALSLT_R
0014AA 54AA 2B               6      DEC HL
0014AB 54AB 51               4      LD  D,C
0014AC 54AC 10EC            13      DJNZ    C8X1
0014AE 54AE D1              10      POP DE
0014AF 54AF F1              10      POP AF
0014B0 54B0 C9              10      RET
                                
       54B1                     INSERT:
0014B1 54B1 F5              11      PUSH    AF
0014B2 54B2 D5              11      PUSH    DE
0014B3 54B3 2ADCF3          16      LD  HL,(CSRY)
0014B6 54B6 3AB0F3          13      LD  A,(LINLEN)
0014B9 54B9 4F               4      LD  C,A
0014BA 54BA 94               4      SUB H   ;CSRX
0014BB 54BB 3C               4      INC A
0014BC 54BC 47               4      LD  B,A ;カーソルより右の文字数
0014BD 54BD C5              11      PUSH    BC
0014BE 54BE CDE254          17      CALL    LOC0
0014C1 54C1 C1              10      POP BC
                                
0014C2 54C2 1620             7      LD  D,020H
       54C4                     INS1:
0014C4 54C4 DD214A00        14      LD  IX,RDVRM
0014C8 54C8 CDD742          17      CALL    CALSLT_R
0014CB 54CB 4F               4      LD  C,A
0014CC 54CC 7A               4      LD  A,D
0014CD 54CD DD214D00        14      LD  IX,WRTVRM
0014D1 54D1 CDD742          17      CALL    CALSLT_R
0014D4 54D4 23               6      INC HL
0014D5 54D5 51               4      LD  D,C
0014D6 54D6 10EC            13      DJNZ    INS1
0014D8 54D8 D1              10      POP DE
0014D9 54D9 F1              10      POP AF
0014DA 54DA C9              10      RET
                                
       54DB                     CONOUT1:
0014DB 54DB 59               4      LD  E,C
0014DC 54DC C30F53          10      JP  _PRINT
                                
       54DF                     GETVRAM:
0014DF 54DF 2ADCF3          16      LD  HL,(CSRY)
       54E2                     LOC0:
0014E2 54E2 2D               4      DEC L
0014E3 54E3 25               4      DEC H
0014E4 54E4 4C               4      LD  C,H ;CSRX-1
0014E5 54E5 5D               4      LD  E,L ;CSRY-1
       54E6                     LOC1:
0014E6 54E6 3AB0F3          13      LD  A,(LINLEN)
0014E9 54E9 67               4      LD  H,A
0014EA 54EA 1600             7      LD  D,0
0014EC 54EC 6A               4      LD  L,D ;0
0014ED 54ED 0608             7      LD  B,8
       54EF                     LOC2:
0014EF 54EF 29              11      ADD HL,HL
0014F0 54F0 3001            12      JR  NC,LOC3
0014F2 54F2 19              11      ADD HL,DE
       54F3                     LOC3:
0014F3 54F3 10FA            13      DJNZ    LOC2
0014F5 54F5 09              11      ADD HL,BC
0014F6 54F6 C9              10      RET
                                
       54F7                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0014F7 54F7 212200          10      LD  HL,00022H
0014FA 54FA AF               4      XOR A
0014FB 54FB 7D               4      LD  A,L
0014FC 54FC C9              10      RET
                                
       54FD                     _SYS0D:     ;(BDOS)ディスク・リセット
0014FD 54FD 218000          10      LD  HL,00080H
001500 5500 22D4F2          16      LD  (_DTA),HL
001503 5503 C9              10      RET
                                
       5504                     _SYS0E:     ;(BDOS)カレントドライブの設定
001504 5504 7B               4      LD  A,E
       5505                     _SYS0EX1:
001505 5505 FE08             7      CP  8
001507 5507 3F               4      CCF
001508 5508 D8              11      RET C
001509 5509 32EAF2          13      LD  (_DVSW),A
00150C 550C C9              10      RET
                                
       550D                     _SYS0F:     ;(BDOS)ファイルのオープン
00150D 550D D5              11      PUSH    DE
00150E 550E FDE1            14      POP IY
001510 5510 CD7B56          17      CALL    INIT_FILE
001513 5513 CDBA4B          17      CALL    ROM_OPEN
001516 5516 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
001518 5518 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
00151C 551C FDE5            15      PUSH    IY
00151E 551E D1              10      POP DE
00151F 551F 13               6      INC DE
001520 5520 010B00          10      LD  BC,11
001523 5523 EDB0                    LDIR
                                ;               Attribute
001525 5525 7E               7      LD  A,(HL)
001526 5526 FD770D          19      LD  (IY+13),A
                                ;               TIME
001529 5529 110B00          10      LD  DE,11
00152C 552C 19              11      ADD HL,DE
00152D 552D 7E               7      LD  A,(HL)
00152E 552E 23               6      INC HL
00152F 552F FD7716          19      LD  (IY+22),A
001532 5532 7E               7      LD  A,(HL)
001533 5533 23               6      INC HL
001534 5534 FD7717          19      LD  (IY+23),A
                                ;               DATE
001537 5537 7E               7      LD  A,(HL)
001538 5538 23               6      INC HL
001539 5539 FD7714          19      LD  (IY+20),A
00153C 553C 7E               7      LD  A,(HL)
00153D 553D 23               6      INC HL
00153E 553E FD7715          19      LD  (IY+21),A
                                ;               First cluster
001541 5541 7E               7      LD  A,(HL)
001542 5542 23               6      INC HL
001543 5543 FD771A          19      LD  (IY+26),A
001546 5546 7E               7      LD  A,(HL)
001547 5547 23               6      INC HL
001548 5548 FD771B          19      LD  (IY+27),A
                                ;               SIZE
00154B 554B 7E               7      LD  A,(HL)
00154C 554C 23               6      INC HL
00154D 554D FD7710          19      LD  (IY+16),A
001550 5550 7E               7      LD  A,(HL)
001551 5551 23               6      INC HL
001552 5552 FD7711          19      LD  (IY+17),A
001555 5555 7E               7      LD  A,(HL)
001556 5556 23               6      INC HL
001557 5557 FD7712          19      LD  (IY+18),A
00155A 555A 7E               7      LD  A,(HL)
00155B 555B FD7713          19      LD  (IY+19),A
00155E 555E AF               4      XOR A
00155F 555F FD770C          19      LD  (IY+12),A
001562 5562 C9              10      RET
                                
       5563                     _SYS10:     ;(BDOS)ファイルのクローズ
001563 5563 AF               4      XOR A
001564 5564 C9              10      RET
                                
       5565                     S11X1:
001565 5565 FD7119          19      LD  (IY+25),C       ;RootEntCnt
001568 5568 FD750E          19      LD  (IY+14),L
00156B 556B FD740F          19      LD  (IY+15),H
       556E                     SCF_FF_RET:
00156E 556E 37               4      SCF
00156F 556F 9F               4      SBC A,A
001570 5570 C9              10      RET
                                
       5571                     _SYS11:     ;(BDOS)最初のファイルの検索
001571 5571 ED53D7F2        20      LD  (_FCB),DE
001575 5575 D5              11      PUSH    DE
001576 5576 FDE1            14      POP IY
001578 5578 CD7B56          17      CALL    INIT_FILE
00157B 557B CD184E          17      CALL    GET_DIR_DAT
       557E                     S12X1:
00157E 557E CDD64B          17      CALL    FILESE
001581 5581 30E2            12      JR  NC,S11X1
001583 5583 0D               4      DEC C
001584 5584 FD7119          19      LD  (IY+25),C       ;RootEntCnt
001587 5587 FDCB0D66        20      BIT 4,(IY+13)
00158B 558B 2809            12      JR  Z,S12X2
00158D 558D E5              11      PUSH    HL
00158E 558E DDE1            14      POP IX
001590 5590 DDCB0E66        20      BIT 4,(IX+1+13)
001594 5594 28E8            12      JR  Z,S12X1
       5596                     S12X2:
001596 5596 012000          10      LD  BC,32
001599 5599 ED5BD4F2        20      LD  DE,(_DTA)
00159D 559D AF               4      XOR A
00159E 559E 12               7      LD  (DE),A      ;ドライブ番号
00159F 559F 13               6      INC DE
0015A0 55A0 EDB0                    LDIR            ;ディレクトリエントリ
0015A2 55A2 FD750E          19      LD  (IY+14),L
0015A5 55A5 FD740F          19      LD  (IY+15),H
0015A8 55A8 C9              10      RET
                                
       55A9                     _SYS12:
0015A9 55A9 FD2AD7F2        20      LD  IY,(_FCB)
0015AD 55AD FDE5            15      PUSH    IY
0015AF 55AF D1              10      POP DE
0015B0 55B0 CD7B56          17      CALL    INIT_FILE
                                
0015B3 55B3 FD6E0E          19      LD  L,(IY+14)
0015B6 55B6 FD660F          19      LD  H,(IY+15)
0015B9 55B9 FD4E19          19      LD  C,(IY+25)
0015BC 55BC 18C0            12      JR  S12X1
                                
       55BE                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0015BE 55BE CDFE4D          17      CALL    SET_FCB
0015C1 55C1 CDCC4D          17      CALL    GETSEQ
0015C4 55C4 CDB94D          17      CALL    RB_READ
0015C7 55C7 E5              11      PUSH    HL
0015C8 55C8 CDD94D          17      CALL    SETSEQ
0015CB 55CB E1              10      POP HL
       55CC                     SREAD:
0015CC 55CC C601             7      ADD A,001H
0015CE 55CE D8              11      RET C
                                
0015CF 55CF 7D               4      LD  A,L
0015D0 55D0 D601             7      SUB 001H
0015D2 55D2 9F               4      SBC A,A
0015D3 55D3 E603             7      AND 3
0015D5 55D5 1F               4      RRA
0015D6 55D6 C9              10      RET
                                
       55D7                     _SYS18:     ;(BDOS)ログインベクトルの獲得
0015D7 55D7 210100          10      LD  HL,00001H
0015DA 55DA AF               4      XOR A
0015DB 55DB C9              10      RET
                                
       55DC                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
0015DC 55DC 3AEAF2          13      LD  A,(_DVSW)
0015DF 55DF C9              10      RET
                                
       55E0                     _SYS1A:     ;(BDOS)DTAの設定
0015E0 55E0 ED53D4F2        20      LD  (_DTA),DE
0015E4 55E4 AF               4      XOR A
0015E5 55E5 C9              10      RET
                                
       55E6                     _SYS1B:     ;(BDOS)ディスク情報の獲得
0015E6 55E6 010002          10      LD  BC,512
0015E9 55E9 11C302          10      LD  DE,707
0015EC 55EC 210000          10      LD  HL,0
0015EF 55EF DD21D9F2        14      LD  IX,_BUF
0015F3 55F3 FD21D9F2        14      LD  IY,_BUF
0015F7 55F7 FD3600F9        19      LD  (IY+0),0F9H
0015FB 55FB 3E02             7      LD  A,2
0015FD 55FD C9              10      RET
                                
       55FE                     _SYS21:     ;(BDOS)ランダムな読み出し
0015FE 55FE CDFE4D          17      CALL    SET_FCB
                                
001601 5601 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001604 5604 FD6622          19      LD  H,(IY+34)
                                
001607 5607 CDB94D          17      CALL    RB_READ
00160A 560A 18C0            12      JR  SREAD
                                
       560C                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
00160C 560C CD0D55          17      CALL    _SYS0F
00160F 560F D8              11      RET C
                                
001610 5610 D5              11      PUSH    DE      ;EX DE,IY
001611 5611 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001613 5613 CDEE4D          17      CALL    GETSIZE
       5616                     _S24X1:
001616 5616 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001619 5619 FD7422          19      LD  (IY+34),H
00161C 561C FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
001620 5620 FDE3            23      EX  (SP),IY     ;
001622 5622 D1              10      POP DE      ;
                                
001623 5623 AF               4      XOR A
001624 5624 C9              10      RET
                                
       5625                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
001625 5625 E5              11      PUSH    HL
001626 5626 D5              11      PUSH    DE      ;EX DE,IY
001627 5627 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001629 5629 CDCC4D          17      CALL    GETSEQ
00162C 562C 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       562E                     _SYS27:     ;(BDOS)ランダムブロック読み込み
00162E 562E CDFE4D          17      CALL    SET_FCB
001631 5631 E5              11      PUSH    HL
001632 5632 FD6E21          19      LD  L,(IY+33)
001635 5635 FD6622          19      LD  H,(IY+34)
001638 5638 22CAF2          16      LD  (RR_LOW),HL
00163B 563B FD6E23          19      LD  L,(IY+35)
00163E 563E FD6624          19      LD  H,(IY+36)
001641 5641 22CCF2          16      LD  (RR_HIGH),HL
001644 5644 E1              10      POP HL
001645 5645 CD9A49          17      CALL    ROM_READ
001648 5648 ED5BCAF2        20      LD  DE,(RR_LOW)
00164C 564C FD7321          19      LD  (IY+33),E
00164F 564F FD7222          19      LD  (IY+34),D
001652 5652 ED5BCCF2        20      LD  DE,(RR_HIGH)
001656 5656 FD7323          19      LD  (IY+35),E
001659 5659 FD7224          19      LD  (IY+36),D
00165C 565C 9F               4      SBC A,A
00165D 565D C9              10      RET
                                
       565E                     _SYS2F:
00165E 565E 44               4      LD  B,H
00165F 565F 2AD4F2          16      LD  HL,(_DTA)
001662 5662 C3D450          10      JP  DISKIO
                                
       5665                     _SYS5A:
001665 5665 0600             7      LD  B,0
001667 5667 D5              11      PUSH    DE
001668 5668 DDE1            14      POP IX
       566A                     _SX5A1:
00166A 566A 1A               7      LD  A,(DE)
00166B 566B B7               4      OR  A
00166C 566C 2804            12      JR  Z,_SX5A2
00166E 566E 13               6      INC DE
00166F 566F 04               4      INC B
001670 5670 18F8            12      JR  _SX5A1
                                
       5672                     _SX5A2:
001672 5672 78               4      LD  A,B
001673 5673 CD654A          17      CALL    FILE_BDOS
001676 5676 CDBB4E          17      CALL    ROM_CD
001679 5679 9F               4      SBC A,A
00167A 567A C9              10      RET
                                
       567B                     INIT_FILE:
00167B 567B EB               4      EX  DE,HL
00167C 567C 11F8F2          10      LD  DE,FDRV
00167F 567F 010C00          10      LD  BC,1+8+3
       5682                     INIT_FILE1:
001682 5682 EDB0                    LDIR
001684 5684 CD9C52          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
001687 5687 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
00168A 568A 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
00168D 568D 2AEBF2          16      LD  HL,(_CD)
001690 5690 22F6F2          16      LD  (_CDX),HL           ;カレントディレクトリ
001693 5693 C9              10      RET
                                
       5694                     ZERO_MEMORY_DE:
001694 5694 AF               4      XOR A
       5695                     FILL_MEMORY_DE:
001695 5695 12               7      LD  (DE),A
001696 5696 13               6      INC DE
001697 5697 10FC            13      DJNZ    FILL_MEMORY_DE
001699 5699 C9              10      RET
                                
00169A 569A                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 FC5212534353FC52        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 FC52FC5248538953        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 5053FC52A3533754        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 F754FD5404550D55        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 63557155A955FC52        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 BE55FC52FC52FC52        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 D755DC55E055E655        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 FC52FC52FC520C56        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 2556FC52FC522E56        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 FC52FC524954FC52        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 4F54FC52FC525E56        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 FC52FC526556FC52        DW  _ERROR,_ERROR,_SYS5A,_ERROR
001FB8 5FB8 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 FC52FC52FC52FC52        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
