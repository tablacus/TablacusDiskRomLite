                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
       0159                     CALBAS  EQU 00159H
       01F5                     REDCLK  EQU 001F5H  ;SUB
       01F9                     WRTCLK  EQU 001F9H  ;SUB
                                
       269A                     DECADD  EQU 0269AH
       27E6                     DECMUL  EQU 027E6H
       2F8A                     FRCINT  EQU 02F8AH
                                
       303A                     FRCDBL  EQU 0303AH
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
       7D17                     ST_BAS  EQU 07D17H
                                
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F847                     ARG EQU 0F847H
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
       FAF8                     EXBRSA  EQU 0FAF8H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBB1                     BASROM  EQU 0FBB1H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCC9                     SLTATR  EQU 0FCC9H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
       FD99                     DEVICE  EQU 0FD99H
                                
       FDDB                     H_PINL  EQU 0FDDBH
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                            ;ASCII-16K
                                ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
                                ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
                                #if exists _RAM64K
                                ISC EQU 0F200H
                                #else
       F280                     ISC EQU 0F280H
                                #endif
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                NEW_HIMEM   EQU ISC-040H
                                #else
       F280                     NEW_HIMEM   EQU ISC
                                #endif
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F280                     SP32    EQU ISC
                                
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0042                    DW  INIT_ROM    ; Main program execution address.
000004 4004 774F                    DW  STATEMENT   ; STATEMENT
000006 4006 9450                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C3E551          10      JP  DISKIO
000013 4013 C32052          10      JP  DSKCHG
000016 4016 C37652          10      JP  GETDPB
000019 4019 C36953          10      JP  CHOICE
00001C 401C C36D53          10      JP  DSKFMT
00001F 401F C36F53          10      JP  DSKSTP
000022 4022 C37053          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C36D53          10      JP  DSKFMT
000029 4029 C36F53          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3A953          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite"
            204449534B20524F    
            4D204C697465        
000096 4096                         ALIGN   32
0000A0 40A0 76302E362E302E33        DB  "v0.6.0.3"
0000A8 40A8                         ALIGN   32
       40C0                     MSG_ERROR_ROM_MODE:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DB  "Normal ROM/ASCII-16K only!",13,10
                                #else
0000C0 40C0 41534349492D384B        DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
            2F4B6F6E616D692D    
            384B2F4B6F6E616D    
            692D534343206F6E    
            6C79210D0A          
                                #endif
0001BD 41BD                         ORG 041BDH
0001BD 41BD C9              10      RET
                                
                                    ;MBR_Partition1 (2DDのデータ)
0001BE 41BE 00                      DB  0       ;ブートフラグ
0001BF 41BF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001C2 41C2 01                      DB  1       ;識別子(FAT12)
0001C3 41C3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001C6 41C6 10000000                DW  16,0        ;パーティションの最初のセクタ番号(LBA方式)
0001CA 41CA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                    ;MBR_Partition2 (2DDのデータ)
0001CE 41CE 00                      DB  0       ;ブートフラグ
0001CF 41CF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001D2 41D2 01                      DB  1       ;識別子(FAT12)
0001D3 41D3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001D6 41D6 B0050000                DW  16+1440,0   ;パーティションの最初のセクタ番号(LBA方式)
0001DA 41DA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                #endif
                                
0001FE 41FE                         ORG 041FEH
0001FE 41FE 55AA                    DB  055H,0AAH   ;MBR_Sig
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4200                     INIT_ROM:
000200 4200 AF               4      XOR A
000201 4201 2100F3          10      LD  HL,0F300H
000204 4204 0668             7      LD  B,068H
000206 4206 CD2B4C          17      CALL    FILL_MEMORY
                                
000209 4209 3E01             7      LD  A,1
00020B 420B 3221FB          13      LD  (DRVTBL),A
                                
00020E 420E 2180F2          10      LD  HL,NEW_HIMEM
000211 4211 ED4B4AFC        20      LD  BC,(HIMEM)
000215 4215 A7               4      AND A
000216 4216 ED42            15      SBC HL,BC
000218 4218 3008            12      JR  NC,INIT1
00021A 421A ED4B74F6        20      LD  BC,(STKTOP)
00021E 421E 09              11      ADD HL,BC
00021F 421F 2274F6          16      LD  (STKTOP),HL ;起動時の空き容量表示の為
       4222                     INIT1:
000222 4222 AF               4      XOR A
000223 4223 32EAF2          13      LD  (_DVSW),A
000226 4226 3D               4      DEC A       ;0FFH
000227 4227 3299FD          13      LD  (DEVICE),A
                                
00022A 422A 211744          10      LD  HL,AT_ISC
00022D 422D 1180F2          10      LD  DE,ISC
000230 4230 018800          10      LD  BC,ISC_E-ISC
000233 4233 EDB0                    LDIR
                                    
000235 4235 3EC3             7      LD  A,0C3H      ;JP
000237 4237 3243FF          13      LD  (H_GONE),A
00023A 423A 327DF3          13      LD  (BDOS),A
00023D 423D 326BF3          13      LD  (RAMUSE),A
000240 4240 3268F3          13      LD  (ROMUSE),A
000243 4243 2180F2          10      LD  HL,REPLACE_COMMAND
000246 4246 2244FF          16      LD  (H_GONE+1),HL
000249 4249 2131F3          10      LD  HL,H_BDOS
00024C 424C 227EF3          16      LD  (BDOS+1),HL
00024F 424F 21ABF2          10      LD  HL,RAMUSE1
000252 4252 226CF3          16      LD  (RAMUSE+1),HL
000255 4255 21BDF2          10      LD  HL,ROMUSE1
000258 4258 2269F3          16      LD  (ROMUSE+1),HL
                                
00025B 425B 3E                      DB  03EH
00025C 425C F7              12      RST 30H
00025D 425D 3271FE          13      LD  (H_BINS),A
000260 4260 3276FE          13      LD  (H_BINL),A
000263 4263 327BFE          13      LD  (H_FILE),A
000266 4266 3231F3          13      LD  (H_BDOS),A
000269 4269 32DBFD          13      LD  (H_PINL),A
00026C 426C 32A7FF          13      LD  (H_PHYD),A
                                
00026F 426F CD6343          17      CALL    GTSL1_
000272 4272 3297F2          13      LD  (ROM_SLT),A
000275 4275 32A7F2          13      LD  (ROM_SLT_COPY),A
000278 4278 3272FE          13      LD  (H_BINS+1),A
00027B 427B 3277FE          13      LD  (H_BINL+1),A
00027E 427E 327CFE          13      LD  (H_FILE+1),A
000281 4281 3232F3          13      LD  (H_BDOS+1),A
000284 4284 32DCFD          13      LD  (H_PINL+1),A
000287 4287 32A8FF          13      LD  (H_PHYD+1),A
00028A 428A 3222FB          13      LD  (DRVTBL+1),A
00028D 428D 3248F3          13      LD  (MASTERS),A
                                
000290 4290 212B46          10      LD  HL,ROM_LOAD
000293 4293 2273FE          16      LD  (H_BINS+2),HL
000296 4296 21DF47          10      LD  HL,ROM_RUN
000299 4299 2278FE          16      LD  (H_BINL+2),HL
00029C 429C 21ED47          10      LD  HL,ROM_FILES
00029F 429F 227DFE          16      LD  (H_FILE+2),HL
0002A2 42A2 211154          10      LD  HL,ROM_BDOS
0002A5 42A5 2233F3          16      LD  (H_BDOS+2),HL
0002A8 42A8 21DA44          10      LD  HL,ROM_BOOT
0002AB 42AB 22DDFD          16      LD  (H_PINL+2),HL
0002AE 42AE 21E551          10      LD  HL,DISKIO
0002B1 42B1 22A9FF          16      LD  (H_PHYD+2),HL
                                
0002B4 42B4 3E                      DB  03EH
0002B5 42B5 C9              10      RET
0002B6 42B6 327FFE          13      LD  (H_FILE+4),A
0002B9 42B9 3275FE          13      LD  (H_BINS+4),A
0002BC 42BC 327AFE          13      LD  (H_BINL+4),A
0002BF 42BF 3235F3          13      LD  (H_BDOS+4),A
0002C2 42C2 32DFFD          13      LD  (H_PINL+4),A
0002C5 42C5 32ABFF          13      LD  (H_PHYD+4),A
                                
0002C8 42C8 AF               4      XOR A
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK0_SEL),A       ;似非RAM対策でバンク0を設定
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0002C9 42C9 320060          13      LD  (BANK0_SEL),A           ;似非RAM対策でバンク0を設定
0002CC 42CC 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0002CF 42CF 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0002D2 42D2 3A0060          13      LD  A,(BANK1_ADR)
0002D5 42D5 FE41             7      CP  'A'
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JR  Z,NOT_BANK_TYPE
                                    LD  A,DISK_BANK
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0002D7 42D7 2079            12      JR  NZ,NOT_BANK_TYPE
0002D9 42D9 3E01             7      LD  A,DISK_BANK
0002DB 42DB 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0002DE 42DE 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0002E1 42E1 CD3801          17      CALL    RSLREG      ;read primary slot #
0002E4 42E4 07               4      RLCA
0002E5 42E5 07               4      RLCA
0002E6 42E6 F5              11      PUSH    AF
0002E7 42E7 1605             7      LD  D,4+1
0002E9 42E9 CD6A43          17      CALL    GTSL2_
0002EC 42EC 3244F3          13      LD  (RAMAD3),A
0002EF 42EF F1              10      POP AF
0002F0 42F0 07               4      RLCA
0002F1 42F1 07               4      RLCA
0002F2 42F2 1603             7      LD  D,2+1
0002F4 42F4 CD6A43          17      CALL    GTSL2_
0002F7 42F7 2680             7      LD  H,080H
0002F9 42F9 CD8743          17      CALL    CHK_RAM
0002FC 42FC 3243F3          13      LD  (RAMAD2),A
       42FF                     RAMCHK2:
0002FF 42FF 3A44F3          13      LD  A,(RAMAD3)
000302 4302 2640             7      LD  H,040H
000304 4304 CD8743          17      CALL    CHK_RAM
000307 4307 3242F3          13      LD  (RAMAD1),A
       430A                     RAMCHK1:
00030A 430A 3A44F3          13      LD  A,(RAMAD3)
00030D 430D 2600             7      LD  H,00H
00030F 430F CD8743          17      CALL    CHK_RAM
000312 4312 3241F3          13      LD  (RAMAD0),A
       4315                     RAMCHK0:
000315 4315 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
000318 4318 010F00          10      LD  BC,0000FH       ;切り上げ
00031B 431B 09              11      ADD HL,BC
00031C 431C 7D               4      LD  A,L
                                
00031D 431D 0604             7      LD  B,4
       431F                     B_DRIVE1:
00031F 431F CB3C             8      SRL H
000321 4321 1F               4      RRA
000322 4322 10FB            13      DJNZ    B_DRIVE1
                                
000324 4324 C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000326 4326 32E9F2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
                                    ;拡張スロットの選択を設定する
000329 4329 3A97F2          13      LD  A,(ROM_SLT)
00032C 432C 57               4      LD  D,A
00032D 432D E60C             7      AND 00CH
00032F 432F 5F               4      LD  E,A
000330 4330 7A               4      LD  A,D
000331 4331 E603             7      AND 3
000333 4333 87               4      ADD A,A
000334 4334 87               4      ADD A,A
000335 4335 87               4      ADD A,A
000336 4336 37               4      SCF
000337 4337 8F               4      ADC A,A
000338 4338 B3               4      OR  E
000339 4339 5F               4      LD  E,A
00033A 433A 1600             7      LD  D,0
00033C 433C 21C9FC          10      LD  HL,SLTATR
00033F 433F 19              11      ADD HL,DE
000340 4340 3660            10      LD  (HL),060H
                                    ;CTRL+STOPを抑制する
000342 4342 3E01             7      LD  A,1
000344 4344 32B1FB          13      LD  (BASROM),A
                                    ;BASICを起動する
000347 4347 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00034B 434B DD21177D        14      LD  IX,ST_BAS   ;continue start of MSX-BASIC without executing BASIC programs in ROM
00034F 434F C35901          10      JP  CALBAS
                                
       4352                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
000352 4352 21C040          10      LD  HL,MSG_ERROR_ROM_MODE
000355 4355 CDA244          17      CALL    MSX
000358 4358 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00035C 435C DD219F00        14      LD  IX,CHGET
000360 4360 C31C00          10      JP  _CALSLT
                                
       4363                     GTSL1_:             ;自分のいるスロットを知る
000363 4363 CD3801          17      CALL    RSLREG      ;read primary slot #
000366 4366 0F               4      RRCA
000367 4367 0F               4      RRCA
000368 4368 1601             7      LD  D,1
       436A                     GTSL2_:
00036A 436A E603             7      AND 3       ;[A]=000000PP
00036C 436C 5F               4      LD  E,A     ;[E]=000000PP
00036D 436D 21C1FC          10      LD  HL,EXPTBL
000370 4370 85               4      ADD A,L     ;桁上りは無い
000371 4371 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000372 4372 7B               4      LD  A,E     ;[A]=000000PP
000373 4373 CB7E            13      BIT 7,(HL)
000375 4375 C8              11      RET Z
000376 4376 7D               4      LD  A,L     ;point to SLTTBL entry
000377 4377 C604             7      ADD A,4     ;桁上りは無い
000379 4379 6F               4      LD  L,A
00037A 437A 7E               7      LD  A,(HL)      ;get currently expansion slot register
       437B                     GTSL3_:
00037B 437B 15               4      DEC D
00037C 437C 2803            12      JR  Z,GTSL4_:
00037E 437E 0F               4      RRCA
00037F 437F 18FA            12      JR  GTSL3_:
       4381                     GTSL4_:
000381 4381 E60C             7      AND 00CH        ;[A] = 0000SS00
000383 4383 B3               4      OR  E       ;[A] = 0000SSPP
000384 4384 F680             7      OR  080H        ;[A] = 1000SSPP
000386 4386 C9              10      RET
                                
       4387                     CHK_RAM:
000387 4387 E5              11      PUSH    HL
000388 4388 CDDC43          17      CALL    CHK_RAM0
00038B 438B E1              10      POP HL
00038C 438C C8              11      RET Z
00038D 438D 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000390 4390 E680             7      AND 080H
000392 4392 CDB343          17      CALL    CHK_RAM_SLT
000395 4395 C8              11      RET Z
000396 4396 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000399 4399 E680             7      AND 080H
00039B 439B C601             7      ADD A,1
00039D 439D CDB343          17      CALL    CHK_RAM_SLT
0003A0 43A0 C8              11      RET Z
0003A1 43A1 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
0003A4 43A4 E680             7      AND 080H
0003A6 43A6 C602             7      ADD A,2
0003A8 43A8 CDB343          17      CALL    CHK_RAM_SLT
0003AB 43AB C8              11      RET Z
0003AC 43AC 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
0003AF 43AF E680             7      AND 080H
0003B1 43B1 C603             7      ADD A,3
       43B3                     CHK_RAM_SLT:
0003B3 43B3 E5              11      PUSH    HL
0003B4 43B4 CDDC43          17      CALL    CHK_RAM0        ;スロット#X or X-0
0003B7 43B7 E1              10      POP HL
0003B8 43B8 C8              11      RET Z
0003B9 43B9 CB79             8      BIT 7,C
0003BB 43BB 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
0003BD 43BD 79               4      LD  A,C
0003BE 43BE C604             7      ADD A,4*1           ;スロット#X-1
0003C0 43C0 E5              11      PUSH    HL
0003C1 43C1 CDDC43          17      CALL    CHK_RAM0
0003C4 43C4 E1              10      POP HL
0003C5 43C5 C8              11      RET Z
0003C6 43C6 79               4      LD  A,C
0003C7 43C7 C608             7      ADD A,4*2           ;スロット#X-2
0003C9 43C9 E5              11      PUSH    HL
0003CA 43CA CDDC43          17      CALL    CHK_RAM0
0003CD 43CD E1              10      POP HL
0003CE 43CE C8              11      RET Z
0003CF 43CF 79               4      LD  A,C
0003D0 43D0 C60C             7      ADD A,4*3           ;スロット#X-3
0003D2 43D2 E5              11      PUSH    HL
0003D3 43D3 CDDC43          17      CALL    CHK_RAM0
0003D6 43D6 E1              10      POP HL
       43D7                     CHK_RAM_E:
0003D7 43D7 AF               4      XOR A
0003D8 43D8 3C               4      INC A           ;ZF=0にする
0003D9 43D9 3E00             7      LD  A,0
0003DB 43DB C9              10      RET
                                
       43DC                     CHK_RAM0:
0003DC 43DC 4F               4      LD  C,A
0003DD 43DD 3A97F2          13      LD  A,(ROM_SLT)
0003E0 43E0 B9               4      CP  C
0003E1 43E1 28F4            12      JR  Z,CHK_RAM_E
0003E3 43E3 2E00             7      LD  L,0
       43E5                     CHK_RAM1:
0003E5 43E5 79               4      LD  A,C
0003E6 43E6 CDD244          17      CALL    RDSLTX
0003E9 43E9 C6E5             7      ADD A,0E5H
0003EB 43EB 47               4      LD  B,A
0003EC 43EC 5F               4      LD  E,A
0003ED 43ED 79               4      LD  A,C
0003EE 43EE C5              11      PUSH    BC
0003EF 43EF CD1400          17      CALL    _WRSLT
0003F2 43F2 C1              10      POP BC
0003F3 43F3 79               4      LD  A,C
0003F4 43F4 CDD244          17      CALL    RDSLTX
0003F7 43F7 B8               4      CP  B
0003F8 43F8 C0              11      RET NZ
0003F9 43F9 D6E5             7      SUB 0E5H
0003FB 43FB 79               4      LD  A,C
0003FC 43FC 5F               4      LD  E,A
0003FD 43FD C5              11      PUSH    BC
0003FE 43FE CD1400          17      CALL    _WRSLT
000401 4401 C1              10      POP BC
000402 4402 24               4      INC H
000403 4403 7D               4      LD  A,L
000404 4404 C604             7      ADD A,4
000406 4406 6F               4      LD  L,A
000407 4407 20DC            12      JR  NZ,CHK_RAM1
000409 4409 79               4      LD  A,C     ;ZF=1のハズ
00040A 440A C9              10      RET
                                
       440B                     CALSLT_R:
00040B 440B C5              11      PUSH    BC
00040C 440C E5              11      PUSH    HL
00040D 440D FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000411 4411 CD1C00          17      CALL    _CALSLT
000414 4414 E1              10      POP HL
000415 4415 C1              10      POP BC
000416 4416 C9              10      RET
                                
       4417                     AT_ISC:
000417 F280                         ORG ISC,AT_ISC-RUN
       F280                     REPLACE_COMMAND:
000417 F280 FEB7             7      CP  0B7H            ;FILES
000419 F282 CC7BFE          17      CALL    Z,H_FILE
00041C F285 FEB5             7      CP  0B5H            ;LOAD
00041E F287 CA71FE          10      JP  Z,H_BINS
000421 F28A FE8A             7      CP  08AH            ;RUN
000423 F28C CA76FE          10      JP  Z,H_BINL
000426 F28F FED6             7      CP  0D6H            ;COPY
000428 F291 2813            12      JR  Z,FIX_COPY
00042A F293 FECF             7      CP  0CFH            ;BLOAD
00042C F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
00042D F296 F7              12      RST 30H
       F297                     ROM_SLT:
00042E F297 00                      DB  0
00042F F298 0D47                    DW  ROM_BLOAD
000431 F29A F5              11      PUSH    AF
000432 F29B E5              11      PUSH    HL
000433 F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
000436 F29F E1              10      POP HL
000437 F2A0 F1              10      POP AF
000438 F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
00043A F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
00043C F2A5 C9              10      RET
       F2A6                     FIX_COPY:
00043D F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
00043E F2A7 00                      DB  0
00043F F2A8 8B48                    DW  ROM_COPY
000441 F2AA C9              10      RET
       F2AB                     RAMUSE1:
000442 F2AB 3A42F3          13      LD  A,(RAMAD1)
000445 F2AE 1810            12      JR  ENASLT2
       F2B0                     CAL_MP:
000447 F2B0 2640             7      LD  H,040H
000449 F2B2 3AC1FC          13      LD  A,(EXPTBL)
00044C F2B5 CD2400          17      CALL    _ENASLT
00044F F2B8 CD1C00          17      CALL    _CALSLT
000452 F2BB 2640             7      LD  H,040H
       F2BD                     ROMUSE1:
000454 F2BD 3A97F2          13      LD  A,(ROM_SLT)
       F2C0                     ENASLT2:
000457 F2C0 C32400          10      JP  _ENASLT
                                
       F2C3                     _RESULT:
00045A F2C3 00                      DB  0
       F2C4                     _BANK:
00045B F2C4 00                      DB  0
       F2C5                     _BANK1:
00045C F2C5 00                      DB  0
       F2C6                     CLSZ:               ;クラスタサイズ
00045D F2C6 0004                    DW  1024
       F2C7                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2C8                     SECSZ:              ;セクタサイズ
00045F F2C8 0002                    DW  512
       F2C9                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2CA                     RR_LOW:
000461 F2CA 0000                    DW  0
       F2CB                     RR_MID  EQU $-1
       F2CC                     RR_HIGH:
000463 F2CC 0000                    DW  0
       F2CE                     _CLPS:
000465 F2CE 0000                    DW  0
       F2D0                     _LEFT:
000467 F2D0 0000                    DW  0
       F2D2                     _DTPS:
000469 F2D2 0000                    DW  0
       F2D4                     _DTA:
00046B F2D4 0000                    DW  0
       F2D6                     FLG_LDIR:
00046D F2D6 00                      DB  0
       F2D7                     _FCB:
00046E F2D7 0000                    DW  0
       F2D9                     _BUF:
       F2D9                     _BUF_LO:        ;LOGICAL OPERATION
000470 F2D9 00                      DB  0
       F2DA                     _BUF_ST:
000471 F2DA 0000                    DW  0
       F2DC                     _BUF_EN:
000473 F2DC 0000                    DW  0
       F2DE                     _BUF_EX:
       F2DE                     _BUF_W:
000475 F2DE 0000                    DW  0
       F2E0                     _BUF_H:
000477 F2E0 0000                    DW  0
       F2E2                     _BUF_X:
000479 F2E2 0000                    DW  0
       F2E4                     _BUF_Y:
00047B F2E4 00                      DB  0
       F2E5                     _BUF_P:
00047C F2E5 00                      DB  0
       F2E6                     _BUF_O:
00047D F2E6 00                      DB  0
       F2E7                     DTAX:
00047E F2E7 0000                    DW  0
       F2E9                     B_DRIVE:
000480 F2E9 00                      DB  0
       F2EA                     _DVSW:          ;カレントドライブ
000481 F2EA 00                      DB  0
       F2EB                     _CD:            ;カレントディレクトリ
000482 F2EB 0000                    DW  0
       F2ED                     DIRENT1:
000484 F2ED 0000                    DW  0
       F2EF                     _DIR_BANK:
000486 F2EF 00                      DB  0
       F2F0                     LEFTX:
000487 F2F0 0000                    DW  0
       F2F2                     PARAM0:
000489 F2F2 0000                    DW  0
       F2F4                     PARAM1:
00048B F2F4 0000                    DW  0
       F2F6                     _CDX:
00048D F2F6 0000                    DW  0
       F2F8                     FDRV:
00048F F2F8 00                      DB  0
       F2F9                     FNAME:
000490 F2F9                         DS  8+3
       F304                     _HL:
00049B F304 0000                    DW  0
       F306                     _SP:
00049D F306 0000                    DW  0
       F307                     _SP_H   EQU $-1
       F308                     ISC_E:
00049F 449F                         ORG $$+RUN          ;$DEPHASE
                                
       449F                     MSX1:
00049F 449F CD2A54          17      CALL    MSGA1
       44A2                     MSX:
0004A2 44A2 7E               7      LD  A,(HL)
0004A3 44A3 23               6      INC HL
0004A4 44A4 B7               4      OR  A
0004A5 44A5 20F8            12      JR  NZ,MSX1
0004A7 44A7 C9              10      RET
                                
       44A8                     PRTHX:
0004A8 44A8 F5              11      PUSH    AF
0004A9 44A9 07               4      RLCA
0004AA 44AA 07               4      RLCA
0004AB 44AB 07               4      RLCA
0004AC 44AC 07               4      RLCA
0004AD 44AD CDB144          17      CALL    PRTA2
0004B0 44B0 F1              10      POP AF
       44B1                     PRTA2:
0004B1 44B1 CDB744          17      CALL    ASC
0004B4 44B4 C32654          10      JP  MSG_A
                                    
       44B7                     ASC:
0004B7 44B7 E60F             7      AND $0F
0004B9 44B9 F630             7      OR  $30
0004BB 44BB FE3A             7      CP  $3A
0004BD 44BD D8              11      RET C
0004BE 44BE C607             7      ADD A,7
0004C0 44C0 C9              10      RET
                                
       44C1                     MSN:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
0004C1 44C1 7E               7      LD  A,(HL)
                                #endif
0004C2 44C2 23               6      INC HL
0004C3 44C3 CD2654          17      CALL    MSG_A
0004C6 44C6 10F9            13      DJNZ    MSN
0004C8 44C8 C9              10      RET
                                
       44C9                     RDSLT_ROM3:
0004C9 44C9 7E               7      LD  A,(HL)
0004CA 44CA C9              10      RET
       44CB                     RDSLT_ROM:
0004CB 44CB CB7C             8      BIT 7,H
0004CD 44CD 28FA            12      JR  Z,RDSLT_ROM3
       44CF                     RDSLT_ROM2:
0004CF 44CF 3A97F2          13      LD  A,(ROM_SLT)
       44D2                     RDSLTX:
0004D2 44D2 C5              11      PUSH    BC
0004D3 44D3 D5              11      PUSH    DE
0004D4 44D4 CD0C00          17      CALL    _RDSLT
0004D7 44D7 D1              10      POP DE
0004D8 44D8 C1              10      POP BC
0004D9 44D9 C9              10      RET
                                
       44DA                     ROM_BOOT:
0004DA 44DA 3E                      DB  03EH
0004DB 44DB C9              10      RET
0004DC 44DC 32DBFD          13      LD  (H_PINL),A
0004DF 44DF 3ACAFF          13      LD  A,(EXTBIO)
0004E2 44E2 FEF7             7      CP  0F7H        ;RST 30H
0004E4 44E4 280A            12      JR  Z,EXTBIO_OK
0004E6 44E6 3E                      DB  03EH
0004E7 44E7 C9              10      RET
0004E8 44E8 21CAFF          10      LD  HL,EXTBIO
0004EB 44EB 061D             7      LD  B,29
0004ED 44ED CD2B4C          17      CALL    FILL_MEMORY
       44F0                     EXTBIO_OK:
0004F0 44F0 211D45          10      LD  HL,DELOK
0004F3 44F3 CDA244          17      CALL    MSX
                                
0004F6 44F6 AF               4      XOR A
0004F7 44F7 3240F3          13      LD  (REBOOT),A
0004FA 44FA 2A48FC          16      LD  HL,(BOTTOM)
0004FD 44FD 110040          10      LD  DE,16384
000500 4500 19              11      ADD HL,DE
000501 4501 3817            12      JR  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
000503 4503 57               4      LD  D,A
000504 4504 0601             7      LD  B,1
000506 4506 2100C0          10      LD  HL,0C000H
000509 4509 CDE551          17      CALL    DISKIO
                                
00050C 450C 116BF3          10      LD  DE,RAMUSE
00050F 450F AF               4      XOR A
000510 4510 CD1EC0          17      CALL    0C01EH
000513 4513 116BF3          10      LD  DE,RAMUSE
000516 4516 37               4      SCF
000517 4517 CD1EC0          17      CALL    0C01EH
       451A                     BOOT1:
00051A 451A C37053          10      JP  BASENT
                                
       451D                     DELOK:
00051D 451D 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       4521                     ROM_LDIR:
000521 4521 3AD6F2          13      LD  A,(FLG_LDIR)
000524 4524 B7               4      OR  A
000525 4525 2008            12      JR  NZ,ROM_LDIRVM
000527 4527 CB7A             8      BIT 7,D
000529 4529 CA4145          10      JP  Z,ROM_LDIRSLT
                                #if exists USE_MORMAL32K_OR_ASCII16
                                LDIRA:
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ1
                                    LD  SP,SP32
                                SPJ1:
                                LDIR1:
                                    LD  A,B
                                    OR  C
                                    JR  Z,LDIRE
                                
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                LDIR2:
                                    LD  A,D
                                    CP  0C0H
                                    JR  NC,LDIR4
                                
                                    PUSH    BC
                                    PUSH    DE
                                    LD  DE,BUF
                                
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIR3
                                    LD  BC,00100H
                                LDIR3:
                                    PUSH    BC
                                    LDIR
                                    LD  (_HL),HL
                                
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                
                                    POP BC
                                    POP DE
                                    LD  HL,BUF
                                    LDIR
                                
                                    LD  HL,(_HL)
                                    POP BC
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIRE
                                    DEC B
                                    JR  LDIR1
                                LDIR4:
                                #endif
00052C 452C EDB0                    LDIR
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                LDIRE2:
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                LDIRE:
                                    LD  SP,(_SP)
                                #endif
00052E 452E C9              10      RET
                                
       452F                     ROM_LDIRVM:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ2
                                    LD  SP,SP32
                                SPJ2:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
00052F 452F C5              11      PUSH    BC
000530 4530 D5              11      PUSH    DE
000531 4531 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000535 4535 DD215C00        14      LD  IX,LDIRVM
000539 4539 CD1C00          17      CALL    _CALSLT
00053C 453C E1              10      POP HL
00053D 453D C1              10      POP BC
00053E 453E 09              11      ADD HL,BC
00053F 453F EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JR  LDIRE2
                                #else
000540 4540 C9              10      RET
                                #endif
                                
       4541                     ROM_LDIRSLT:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ3
                                    LD  SP,SP32
                                SPJ3:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
       4541                     ROM_LDIRSLT1:
000541 4541 EB               4      EX  DE,HL
       4542                     RLDIRSLT1:
000542 4542 CB7C             8      BIT 7,H
000544 4544 201F            12      JR  NZ,RLDIRSLT_EXIT
000546 4546 1A               7      LD  A,(DE)
000547 4547 13               6      INC DE
000548 4548 C5              11      PUSH    BC
000549 4549 D5              11      PUSH    DE
00054A 454A E5              11      PUSH    HL
00054B 454B 5F               4      LD  E,A
                                
00054C 454C 0141F3          10      LD  BC,RAMAD0
00054F 454F 7C               4      LD  A,H
000550 4550 07               4      RLCA
000551 4551 07               4      RLCA
000552 4552 E603             7      AND 3
000554 4554 81               4      ADD A,C
000555 4555 4F               4      LD  C,A
000556 4556 0A               7      LD  A,(BC)
       4557                     RLDIRSLT2:
000557 4557 CD1400          17      CALL    _WRSLT
00055A 455A 08               4      EX  AF,AF'
00055B 455B E1              10      POP HL
00055C 455C D1              10      POP DE
00055D 455D C1              10      POP BC
00055E 455E EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
000560 4560 EA4245          10      JP  PE,RLDIRSLT1
000563 4563 EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JP  LDIRE2
                                RLDIRSLT_EXIT:
                                    EX  DE,HL
                                    JP  LDIR1
                                #else
000564 4564 C9              10      RET
       4565                     RLDIRSLT_EXIT:
000565 4565 EB               4      EX  DE,HL
000566 4566 EDB0                    LDIR
000568 4568 C9              10      RET
                                #endif
                                
       4569                     END_OF_LINE:
000569 4569 215EF5          10      LD  HL,BUF
       456C                     EOL1:
00056C 456C 7E               7      LD  A,(HL)
00056D 456D C8              11      RET Z
00056E 456E FE0D             7      CP  00DH
000570 4570 2807            12      JR  Z,EOLE
000572 4572 FE0A             7      CP  00AH
000574 4574 2803            12      JR  Z,EOLE
000576 4576 23               6      INC HL
000577 4577 18F3            12      JR  EOL1
       4579                     EOLE:
000579 4579 3600            10      LD  (HL),0
00057B 457B 23               6      INC HL
00057C 457C 7E               7      LD  A,(HL)
00057D 457D FE0A             7      CP  00AH
00057F 457F C0              11      RET NZ
000580 4580 23               6      INC HL
000581 4581 C9              10      RET
                                
       4582                     ROM_LOAD_ASCII:
000582 4582 210000          10      LD  HL,0
000585 4585 22DAF2          16      LD  (_BUF_ST),HL    ;読み出し位置
000588 4588 2A76F6          16      LD  HL,(TXTTAB)
00058B 458B 22DCF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
00058E 458E 215EF5          10      LD  HL,BUF
000591 4591 22D4F2          16      LD  (_DTA),HL
       4594                     RLOAD_A1:
000594 4594 2ADAF2          16      LD  HL,(_BUF_ST)
000597 4597 22CAF2          16      LD  (RR_LOW),HL
00059A 459A 210201          10      LD  HL,258
00059D 459D CDAB4A          17      CALL    ROM_READ
0005A0 45A0 7C               4      LD  A,H
0005A1 45A1 B5               4      OR  L
0005A2 45A2 2879            12      JR  Z,RLOAD_AEND
0005A4 45A4 015EF5          10      LD  BC,BUF
0005A7 45A7 09              11      ADD HL,BC
0005A8 45A8 3600            10      LD  (HL),0
0005AA 45AA CD6945          17      CALL    END_OF_LINE
0005AD 45AD 015EF5          10      LD  BC,BUF
0005B0 45B0 A7               4      AND A
0005B1 45B1 ED42            15      SBC HL,BC
0005B3 45B3 2810            12      JR  Z,RLOAD_A2
0005B5 45B5 4D               4      LD  C,L
0005B6 45B6 44               4      LD  B,H
0005B7 45B7 ED5BDAF2        20      LD  DE,(_BUF_ST)
0005BB 45BB 19              11      ADD HL,DE
0005BC 45BC 22DAF2          16      LD  (_BUF_ST),HL
0005BF 45BF 3A5EF5          13      LD  A,(BUF)
0005C2 45C2 B7               4      OR  A
0005C3 45C3 28CF            12      JR  Z,RLOAD_A1
       45C5                     RLOAD_A2:
0005C5 45C5 115EF5          10      LD  DE,BUF
0005C8 45C8 CD624C          17      CALL    SPCUTEX
0005CB 45CB 1A               7      LD  A,(DE)
0005CC 45CC B7               4      OR  A
0005CD 45CD 284E            12      JR  Z,RLOAD_AEND
0005CF 45CF CD744C          17      CALL    GETNUM
0005D2 45D2 7C               4      LD  A,H
0005D3 45D3 B5               4      OR  L
0005D4 45D4 CAF446          10      JP  Z,ERROR_DIRECT_IN_FILE
0005D7 45D7 DD2ADCF2        20      LD  IX,(_BUF_EN)
0005DB 45DB DD7502          19      LD  (IX+2),L
0005DE 45DE DD7403          19      LD  (IX+3),H
                                
0005E1 45E1 CD5B4C          17      CALL    SPCUT
0005E4 45E4 EB               4      EX  DE,HL
0005E5 45E5 DDE5            15      PUSH    IX
0005E7 45E7 DD21B242        14      LD  IX,CRUNCH
0005EB 45EB FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0005EF 45EF CD1C00          17      CALL    _CALSLT
0005F2 45F2 DDE1            14      POP IX
0005F4 45F4 EB               4      EX  DE,HL
0005F5 45F5 111FF4          10      LD  DE,KBUF
0005F8 45F8 37               4      SCF
0005F9 45F9 ED52            15      SBC HL,DE
0005FB 45FB CAF446          10      JP  Z,ERROR_DIRECT_IN_FILE
0005FE 45FE DAF446          10      JP  C,ERROR_DIRECT_IN_FILE
000601 4601 4D               4      LD  C,L
000602 4602 44               4      LD  B,H
000603 4603 2ADCF2          16      LD  HL,(_BUF_EN)
000606 4606 110400          10      LD  DE,4
000609 4609 19              11      ADD HL,DE
00060A 460A 111FF4          10      LD  DE,KBUF
                                
00060D 460D EB               4      EX  DE,HL
00060E 460E EDB0                    LDIR
000610 4610 EB               4      EX  DE,HL
                                
000611 4611 DD7500          19      LD  (IX+0),L
000614 4614 DD7401          19      LD  (IX+1),H
000617 4617 22DCF2          16      LD  (_BUF_EN),HL
00061A 461A C39445          10      JP  RLOAD_A1
                                
       461D                     RLOAD_AEND:
00061D 461D 2ADCF2          16      LD  HL,(_BUF_EN)
000620 4620 AF               4      XOR A
000621 4621 77               7      LD  (HL),A
000622 4622 23               6      INC HL
000623 4623 77               7      LD  (HL),A
000624 4624 23               6      INC HL
000625 4625 22DCF2          16      LD  (_BUF_EN),HL
000628 4628 C3B746          10      JP  RLOAD_END1
                                
       462B                     ROM_LOAD:
00062B 462B CD5948          17      CALL    INIT_PARAM
00062E 462E 7E               7      LD  A,(HL)
00062F 462F FE2C             7      CP  ','
000631 4631 2003            12      JR  NZ,ROM_LOAD0
000633 4633 23               6      INC HL
000634 4634 7E               7      LD  A,(HL)
000635 4635 2B               6      DEC HL
       4636                     ROM_LOAD0:
000636 4636 32BEFC          13      LD  (RUNBNF),A
000639 4639 CD4C4B          17      CALL    FILE_B
00063C 463C 3AF9F2          13      LD  A,(FNAME)
00063F 463F FE20             7      CP  020H
000641 4641 CA474B          10      JP  Z,ROM_ORG
                                
000644 4644 CDCB4C          17      CALL    ROM_OPEN
000647 4647 DA0047          10      JP  C,ERROR_FILE_NOT_FOUND
       464A                     ROM_LOAD1:
00064A 464A 21D9F2          10      LD  HL,_BUF
00064D 464D 22D4F2          16      LD  (_DTA),HL
000650 4650 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
000653 4653 CDAB4A          17      CALL    ROM_READ
000656 4656 3AD9F2          13      LD  A,(_BUF)
000659 4659 3C               4      INC A
00065A 465A C28245          10      JP  NZ,ROM_LOAD_ASCII
00065D 465D 2A76F6          16      LD  HL,(TXTTAB)
000660 4660 22D4F2          16      LD  (_DTA),HL
000663 4663 EB               4      EX  DE,HL
000664 4664 2100FF          10      LD  HL,-256
000667 4667 39              11      ADD HL,SP
000668 4668 ED52            15      SBC HL,DE
00066A 466A CDAB4A          17      CALL    ROM_READ
00066D 466D ED5BD4F2        20      LD  DE,(_DTA)
000671 4671 19              11      ADD HL,DE
000672 4672 E5              11      PUSH    HL
000673 4673 2A76F6          16      LD  HL,(TXTTAB)
       4676                     ROM_LOAD2:          ;リンクポインタをFIX
000676 4676 E5              11      PUSH    HL
000677 4677 DDE1            14      POP IX
000679 4679 7E               7      LD  A,(HL)      ;リンクポインタL
00067A 467A 23               6      INC HL
00067B 467B B6               7      OR  (HL)        ;リンクポインタH
00067C 467C 23               6      INC HL
00067D 467D 2837            12      JR  Z,RLOAD_END0
00067F 467F 23               6      INC HL      ;行番号
000680 4680 23               6      INC HL      ;行番号
       4681                     ROM_LOAD3:
000681 4681 7E               7      LD  A,(HL)
000682 4682 23               6      INC HL
000683 4683 FE0B             7      CP  00BH        ;8進数(&O)
000685 4685 2822            12      JR  Z,INC_HL2
000687 4687 FE0C             7      CP  00CH        ;16進数(&H)
000689 4689 281E            12      JR  Z,INC_HL2
00068B 468B FE0D             7      CP  00DH        ;行番号(RUN後)
00068D 468D 281A            12      JR  Z,INC_HL2
00068F 468F FE0E             7      CP  00EH        ;行番号(RUN前)
000691 4691 2816            12      JR  Z,INC_HL2
000693 4693 FE0F             7      CP  00FH        ;10～255の整数(%)
000695 4695 2813            12      JR  Z,INC_HL1
000697 4697 FE1C             7      CP  01CH        ;256～65535の整数(%)
000699 4699 280E            12      JR  Z,INC_HL2
00069B 469B FE1D             7      CP  01DH        ;単精度実数(!)
00069D 469D 2808            12      JR  Z,INC_HL4
00069F 469F FE1F             7      CP  01FH        ;倍制度実数(#)
0006A1 46A1 2008            12      JR  NZ,INC_HL0
0006A3 46A3 23               6      INC HL
0006A4 46A4 23               6      INC HL
0006A5 46A5 23               6      INC HL
0006A6 46A6 23               6      INC HL
       46A7                     INC_HL4:
0006A7 46A7 23               6      INC HL
0006A8 46A8 23               6      INC HL
       46A9                     INC_HL2:
0006A9 46A9 23               6      INC HL
       46AA                     INC_HL1:
0006AA 46AA 23               6      INC HL
       46AB                     INC_HL0:
0006AB 46AB B7               4      OR  A
0006AC 46AC 20D3            12      JR  NZ,ROM_LOAD3
0006AE 46AE DD7500          19      LD  (IX+0),L
0006B1 46B1 DD7401          19      LD  (IX+1),H
0006B4 46B4 18C0            12      JR  ROM_LOAD2
       46B6                     RLOAD_END0:
0006B6 46B6 E1              10      POP HL
       46B7                     RLOAD_END1:
0006B7 46B7 22C2F6          16      LD  (VARTAB),HL
0006BA 46BA 22C4F6          16      LD  (ARYTAB),HL
0006BD 46BD 22C6F6          16      LD  (STREND),HL
                                
0006C0 46C0 3ABEFC          13      LD  A,(RUNBNF)
0006C3 46C3 CDB54C          17      CALL    CAP
0006C6 46C6 FE52             7      CP  'R'
0006C8 46C8 280E            12      JR  Z,RLOAD_END2
0006CA 46CA AF               4      XOR A
0006CB 46CB 21DCF2          10      LD  HL,_BUF+3
0006CE 46CE 77               7      LD  (HL),A      ;3
0006CF 46CF 2B               6      DEC HL
0006D0 46D0 77               7      LD  (HL),A      ;2
0006D1 46D1 2B               6      DEC HL
0006D2 46D2 77               7      LD  (HL),A      ;1
0006D3 46D3 2B               6      DEC HL
0006D4 46D4 3E8F             7      LD  A,08FH      ;REM
0006D6 46D6 77               7      LD  (HL),A      ;0
0006D7 46D7 C9              10      RET
       46D8                     RLOAD_END2:
0006D8 46D8 D5              11      PUSH    DE
0006D9 46D9 ED5B76F6        20      LD  DE,(TXTTAB)
0006DD 46DD 1B               6      DEC DE
0006DE 46DE AF               4      XOR A
0006DF 46DF 21DFF2          10      LD  HL,_BUF+6
0006E2 46E2 77               7      LD  (HL),A      ;6
0006E3 46E3 2B               6      DEC HL
0006E4 46E4 77               7      LD  (HL),A      ;5
0006E5 46E5 2B               6      DEC HL
0006E6 46E6 77               7      LD  (HL),A      ;4
0006E7 46E7 2B               6      DEC HL
0006E8 46E8 72               7      LD  (HL),D      ;3 行番号H
0006E9 46E9 2B               6      DEC HL
0006EA 46EA 73               7      LD  (HL),E      ;2 行番号L
0006EB 46EB 2B               6      DEC HL
0006EC 46EC 360D            10      LD  (HL),00DH   ;1 行番号(RUN後)
0006EE 46EE 2B               6      DEC HL
0006EF 46EF 3E89             7      LD  A,089H      ;GOTO
0006F1 46F1 77               7      LD  (HL),A      ;0
0006F2 46F2 D1              10      POP DE
0006F3 46F3 C9              10      RET
                                
       46F4                     ERROR_DIRECT_IN_FILE:
0006F4 46F4 1E39             7      LD  E,57            ;Direct statement in file
0006F6 46F6 01                      DB  1           ;LD BC,
       46F7                     ERROR_DEVICE_IO_ERROR:
0006F7 46F7 1E13             7      LD  E,19            ;Device I/O error
0006F9 46F9 01                      DB  1           ;LD BC,
       46FA                     ERROR_INTERNAL_ERROR:
0006FA 46FA 1E33             7      LD  E,51            ;Internal error
0006FC 46FC 01                      DB  1           ;LD BC,
       46FD                     ERROR_FILE_NOT_OPEN:
0006FD 46FD 1E3B             7      LD  E,59            ;File not OPEN
0006FF 46FF 01                      DB  1           ;LD BC,
       4700                     ERROR_FILE_NOT_FOUND:
000700 4700 1E35             7      LD  E,53            ;File not found
       4702                     ERROR:
000702 4702 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000706 4706 DD216F40        14      LD  IX,ERRHAND
00070A 470A C31C00          10      JP  _CALSLT
                                
       470D                     ROM_BLOAD:
00070D 470D CD5948          17      CALL    INIT_PARAM
000710 4710 CD4C4B          17      CALL    FILE_B
000713 4713 CDCB4C          17      CALL    ROM_OPEN
000716 4716 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000718 4718 21D9F2          10      LD  HL,_BUF
00071B 471B 22D4F2          16      LD  (_DTA),HL
00071E 471E 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
000721 4721 CDAB4A          17      CALL    ROM_READ
000724 4724 3AD9F2          13      LD  A,(_BUF)
000727 4727 FEFE             7      CP  0FEH
000729 4729 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
00072B 472B 21A5F2          10      LD  HL,BLOAD_RET
00072E 472E 229DF2          16      LD  (SWC_BLOAD),HL
                                
000731 4731 2AF4F2          16      LD  HL,(PARAM1)
000734 4734 7E               7      LD  A,(HL)
000735 4735 FE2C             7      CP  ','
000737 4737 204C            12      JR  NZ,RBREAD_MEM
000739 4739 23               6      INC HL
00073A 473A 7E               7      LD  A,(HL)
00073B 473B CDB54C          17      CALL    CAP
00073E 473E 32BEFC          13      LD  (RUNBNF),A
000741 4741 FE52             7      CP  'R'     ;R,Sスイッチじゃ無い場合はオフセット値として処理する
000743 4743 2808            12      JR  Z,RBOS1
000745 4745 FE53             7      CP  'S'
000747 4747 2804            12      JR  Z,RBOS1
000749 4749 FE2C             7      CP  ','
00074B 474B 200D            12      JR  NZ,RBOS2
       474D                     RBOS1:
00074D 474D 7E               7      LD  A,(HL)
00074E 474E 23               6      INC HL
00074F 474F B7               4      OR  A
000750 4750 2824            12      JR  Z,RBREAD_OSE
000752 4752 FE3A             7      CP  ':'
000754 4754 2820            12      JR  Z,RBREAD_OSE
000756 4756 FE2C             7      CP  ','     ;次のパラメータを探す
000758 4758 20F3            12      JR  NZ,RBOS1
       475A                     RBOS2:              ;オフセット
00075A 475A 22F4F2          16      LD  (PARAM1),HL
00075D 475D 7E               7      LD  A,(HL)
00075E 475E B7               4      OR  A
00075F 475F 2815            12      JR  Z,RBREAD_OSE
000761 4761 DD212F54        14      LD  IX,FRMQNT
000765 4765 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000769 4769 CD1C00          17      CALL    _CALSLT
00076C 476C 22F4F2          16      LD  (PARAM1),HL
00076F 476F 2ADAF2          16      LD  HL,(_BUF_ST)
000772 4772 19              11      ADD HL,DE
000773 4773 22DAF2          16      LD  (_BUF_ST),HL
       4776                     RBREAD_OSE:
000776 4776 3ABEFC          13      LD  A,(RUNBNF)
000779 4779 FE53             7      CP  'S'
00077B 477B 2008            12      JR  NZ,RBREAD_MEM
00077D 477D CD394A          17      CALL    WAIT_VDP
000780 4780 3E01             7      LD  A,1
000782 4782 32D6F2          13      LD  (FLG_LDIR),A
       4785                     RBREAD_MEM:
000785 4785 2ADAF2          16      LD  HL,(_BUF_ST)
000788 4788 22BFFC          16      LD  (SAVENT),HL
00078B 478B 22D4F2          16      LD  (_DTA),HL
00078E 478E 21FFFF          10      LD  HL,0FFFFH
000791 4791 CDAB4A          17      CALL    ROM_READ
000794 4794 AF               4      XOR A
000795 4795 32D6F2          13      LD  (FLG_LDIR),A
000798 4798 3ABEFC          13      LD  A,(RUNBNF)
00079B 479B FE52             7      CP  'R'
00079D 479D 2006            12      JR  NZ,RBREAD1
00079F 479F 2ADEF2          16      LD  HL,(_BUF_EX)
0007A2 47A2 229DF2          16      LD  (SWC_BLOAD),HL
       47A5                     RBREAD1:
       47A5                     ROM_NEXT:
0007A5 47A5 2AF4F2          16      LD  HL,(PARAM1)
0007A8 47A8 7E               7      LD  A,(HL)
0007A9 47A9 2B               6      DEC HL
0007AA 47AA B7               4      OR  A
0007AB 47AB 2805            12      JR  Z,ROM_NEXT1
0007AD 47AD FE3A             7      CP  ':'
0007AF 47AF 2801            12      JR  Z,ROM_NEXT1
0007B1 47B1 23               6      INC HL
       47B2                     ROM_NEXT1:
0007B2 47B2 5D               4      LD  E,L
0007B3 47B3 54               4      LD  D,H
                                
0007B4 47B4 CD8B4C          17      CALL    SEARCH_END
0007B7 47B7 B7               4      OR  A
0007B8 47B8 2821            12      JR  Z,REM
       47BA                     RN3:                    ;マルチステートメントの処理
0007BA 47BA 7E               7      LD  A,(HL)
                                
0007BB 47BB FEB5             7      CP  0B5H            ;LOAD
0007BD 47BD CA2B46          10      JP  Z,ROM_LOAD
0007C0 47C0 FE8A             7      CP  08AH            ;RUN
0007C2 47C2 281B            12      JR  Z,ROM_RUN
0007C4 47C4 FEB7             7      CP  0B7H            ;FILES
0007C6 47C6 2825            12      JR  Z,ROM_FILES
0007C8 47C8 FED6             7      CP  0D6H            ;COPY
0007CA 47CA CA8B48          10      JP  Z,ROM_COPY
0007CD 47CD FE20             7      CP  020H
0007CF 47CF 2807            12      JR  Z,RN_SP
                                
0007D1 47D1 3E28             7      LD  A,028H          ;JR Z,
0007D3 47D3 32A3F2          13      LD  (SWC_BLOAD_M),A
0007D6 47D6 7E               7      LD  A,(HL)
0007D7 47D7 C9              10      RET
       47D8                     RN_SP:
0007D8 47D8 23               6      INC HL
0007D9 47D9 18DF            12      JR  RN3
                                
       47DB                     REM:
0007DB 47DB EB               4      EX  DE,HL
0007DC 47DC 3E8F             7      LD  A,08FH          ;REM
0007DE 47DE C9              10      RET
                                
       47DF                     ROM_RUN:
0007DF 47DF 23               6      INC HL
0007E0 47E0 7E               7      LD  A,(HL)
0007E1 47E1 2B               6      DEC HL
0007E2 47E2 B7               4      OR  A
0007E3 47E3 C42B46          17      CALL    NZ,ROM_LOAD
0007E6 47E6 FE8F             7      CP  08FH            ;REM
0007E8 47E8 3E8A             7      LD  A,08AH          ;RUN
0007EA 47EA C0              11      RET NZ
0007EB 47EB 77               7      LD  (HL),A
0007EC 47EC C9              10      RET
                                
       47ED                     ROM_FILES:
0007ED 47ED CD5948          17      CALL    INIT_PARAM
0007F0 47F0 CD4C4B          17      CALL    FILE_B
0007F3 47F3 CDAD53          17      CALL    GET_DISK_BANK_FDRV
0007F6 47F6 3AC9F2          13      LD  A,(SECSZ_H)
0007F9 47F9 CD6B52          17      CALL    IS_BPB1
0007FC 47FC DAF746          10      JP  C,ERROR_DEVICE_IO_ERROR
0007FF 47FF 3AF9F2          13      LD  A,(FNAME)
000802 4802 FE21             7      CP  021H
000804 4804 3005            12      JR  NC,RFILES0
000806 4806 060B             7      LD  B,11
000808 4808 CD1F4C          17      CALL    FILE10
       480B                     RFILES0:
00080B 480B CD294F          17      CALL    GET_DIR_DAT
       480E                     RFILES1:
00080E 480E CDE74C          17      CALL    FILESE
000811 4811 3041            12      JR  NC,RFILES_NOT_MATCH
       4813                     RFILES_DISP:
000813 4813 E5              11      PUSH    HL
000814 4814 110B00          10      LD  DE,0000BH   ;属性
000817 4817 19              11      ADD HL,DE
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000818 4818 7E               7      LD  A,(HL)
                                #endif
000819 4819 E1              10      POP HL
00081A 481A CB4F             8      BIT 1,A     ;不可視属性
00081C 481C 2033            12      JR  NZ,RFILES_NEXT
00081E 481E E5              11      PUSH    HL
00081F 481F 0608             7      LD  B,8
000821 4821 CDC144          17      CALL    MSN
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000824 4824 7E               7      LD  A,(HL)
                                #endif
000825 4825 FE20             7      CP  020H
000827 4827 F5              11      PUSH    AF
000828 4828 3E2E             7      LD  A,'.'
00082A 482A C42654          17      CALL    NZ,MSG_A
00082D 482D 0603             7      LD  B,3
00082F 482F CDC144          17      CALL    MSN
000832 4832 F1              10      POP AF
000833 4833 CC2654          17      CALL    Z,MSG_A
000836 4836 3ADDF3          13      LD  A,(CSRX)
000839 4839 47               4      LD  B,A
00083A 483A 3AB0F3          13      LD  A,(LINLEN)
00083D 483D 90               4      SUB B
00083E 483E FE0C             7      CP  12
000840 4840 3009            12      JR  NC,RFILES2
000842 4842 3E0D             7      LD  A,00DH      ;改行
000844 4844 CD2654          17      CALL    MSG_A
000847 4847 3E0A             7      LD  A,00AH
000849 4849 1802            12      JR  RFILES3
       484B                     RFILES2:
00084B 484B 3E20             7      LD  A,020H
       484D                     RFILES3:
00084D 484D CD2654          17      CALL    MSG_A
000850 4850 E1              10      POP HL
       4851                     RFILES_NEXT:
000851 4851 CD034D          17      CALL    FNEXT
       4854                     RFILES_NOT_MATCH:
000854 4854 20B8            12      JR  NZ,RFILES1
000856 4856 C3A547          10      JP  ROM_NEXT
                                
       4859                     INIT_PARAM:
000859 4859 22F2F2          16      LD  (PARAM0),HL
00085C 485C 22F4F2          16      LD  (PARAM1),HL
00085F 485F EB               4      EX  DE,HL
000860 4860 32BEFC          13      LD  (RUNBNF),A
000863 4863 3263F6          13      LD  (VALTYP),A
000866 4866 E5              11      PUSH    HL
000867 4867 2AEBF2          16      LD  HL,(_CD)
00086A 486A 22F6F2          16      LD  (_CDX),HL
00086D 486D E1              10      POP HL
00086E 486E 13               6      INC DE
00086F 486F CD5B4C          17      CALL    SPCUT
000872 4872 1A               7      LD  A,(DE)
000873 4873 B7               4      OR  A
000874 4874 C8              11      RET Z
000875 4875 FE3A             7      CP  ':'
000877 4877 C8              11      RET Z
000878 4878 FE28             7      CP  '('
00087A 487A C8              11      RET Z
00087B 487B EB               4      EX  DE,HL
00087C 487C DD21644C        14      LD  IX,FRMEVL
000880 4880 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000884 4884 CD1C00          17      CALL    _CALSLT
000887 4887 22F4F2          16      LD  (PARAM1),HL
00088A 488A C9              10      RET
                                
       488B                     ROM_COPY:
00088B 488B CD5948          17      CALL    INIT_PARAM
00088E 488E 3A63F6          13      LD  A,(VALTYP)
000891 4891 FE03             7      CP  3       ;string
000893 4893 C2474B          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
000896 4896 CD4C4B          17      CALL    FILE_B
000899 4899 CDCB4C          17      CALL    ROM_OPEN
00089C 489C DA0047          10      JP  C,ERROR_FILE_NOT_FOUND
                                
00089F 489F 21DEF2          10      LD  HL,_BUF_W
0008A2 48A2 22D4F2          16      LD  (_DTA),HL
0008A5 48A5 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
0008A8 48A8 CDAB4A          17      CALL    ROM_READ
                                
0008AB 48AB AF               4      XOR A
0008AC 48AC 32D9F2          13      LD  (_BUF_LO),A     ;PSET
0008AF 48AF 32E6F2          13      LD  (_BUF_O),A      ;向き
                                
0008B2 48B2 2AF4F2          16      LD  HL,(PARAM1)
       48B5                     RCP_PARAM1:
0008B5 48B5 7E               7      LD  A,(HL)
0008B6 48B6 23               6      INC HL
0008B7 48B7 B7               4      OR  A
0008B8 48B8 CAB247          10      JP  Z,ROM_NEXT1
0008BB 48BB FE3A             7      CP  ':'
0008BD 48BD CAB247          10      JP  Z,ROM_NEXT1
0008C0 48C0 FE2C             7      CP  ','
0008C2 48C2 2012            12      JR  NZ,RCP_PARAM1_
                                
0008C4 48C4 DD212F54        14      LD  IX,FRMQNT
0008C8 48C8 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0008CC 48CC CD1C00          17      CALL    _CALSLT
0008CF 48CF 7B               4      LD  A,E
0008D0 48D0 87               4      ADD A,A
0008D1 48D1 87               4      ADD A,A
0008D2 48D2 32E6F2          13      LD  (_BUF_O),A
0008D5 48D5 7E               7      LD  A,(HL)
       48D6                     RCP_PARAM1_:
0008D6 48D6 FE28             7      CP  '('
0008D8 48D8 20DB            12      JR  NZ,RCP_PARAM1
0008DA 48DA DD212F54        14      LD  IX,FRMQNT
0008DE 48DE FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0008E2 48E2 CD1C00          17      CALL    _CALSLT
                                
0008E5 48E5 ED53E2F2        20      LD  (_BUF_X),DE
                                
       48E9                     RCP_PARAM2:
0008E9 48E9 23               6      INC HL
0008EA 48EA 7E               7      LD  A,(HL)
0008EB 48EB FE20             7      CP  020H
0008ED 48ED 28FA            12      JR  Z,RCP_PARAM2
0008EF 48EF FE2C             7      CP  ','
0008F1 48F1 28F6            12      JR  Z,RCP_PARAM2
                                
0008F3 48F3 DD212F54        14      LD  IX,FRMQNT
0008F7 48F7 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0008FB 48FB CD1C00          17      CALL    _CALSLT
                                
0008FE 48FE 3AF6FA          13      LD  A,(ACPAGE)
000901 4901 57               4      LD  D,A
000902 4902 ED53E4F2        20      LD  (_BUF_Y),DE
       4906                     RCP_PARAM3:
000906 4906 23               6      INC HL
000907 4907 7E               7      LD  A,(HL)
000908 4908 FE20             7      CP  020H
00090A 490A 28FA            12      JR  Z,RCP_PARAM3
00090C 490C FE29             7      CP  ')'
00090E 490E 28F6            12      JR  Z,RCP_PARAM3
000910 4910 FE2C             7      CP  ','
000912 4912 2033            12      JR  NZ,RCP_ST
                                
000914 4914 23               6      INC HL
000915 4915 DD212F54        14      LD  IX,FRMQNT
000919 4919 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00091D 491D CD1C00          17      CALL    _CALSLT
                                
000920 4920 7B               4      LD  A,E
000921 4921 32E5F2          13      LD  (_BUF_P),A
                                
       4924                     RCP_PARAM4:
000924 4924 7E               7      LD  A,(HL)
000925 4925 23               6      INC HL
000926 4926 FE20             7      CP  020H
000928 4928 28FA            12      JR  Z,RCP_PARAM4
                                
00092A 492A FE2C             7      CP  ','
00092C 492C 2019            12      JR  NZ,RCP_ST
                                
00092E 492E 7E               7      LD  A,(HL)
00092F 492F 0604             7      LD  B,4
000931 4931 FEC3             7      CP  0C3H        ;PRESET
000933 4933 280E            12      JR  Z,RCP_LO
000935 4935 05               4      DEC B       ;3
000936 4936 D6F8             7      SUB 0F8H        ;XOR
000938 4938 2809            12      JR  Z,RCP_LO
00093A 493A 05               4      DEC B       ;2
00093B 493B 3C               4      INC A       ;OR
00093C 493C 2805            12      JR  Z,RCP_LO
00093E 493E 05               4      DEC B       ;1
00093F 493F 3C               4      INC A       ;AND
000940 4940 2801            12      JR  Z,RCP_LO
000942 4942 05               4      DEC B       ;0
                                                ;PSET
       4943                     RCP_LO:
000943 4943 78               4      LD  A,B
000944 4944 32D9F2          13      LD  (_BUF_LO),A
       4947                     RCP_ST:
000947 4947 2AC6F6          16      LD  HL,(STREND)
00094A 494A 22D4F2          16      LD  (_DTA),HL
00094D 494D EB               4      EX  DE,HL
00094E 494E 2100FE          10      LD  HL,-512
000951 4951 39              11      ADD HL,SP
000952 4952 AF               4      XOR A
000953 4953 ED52            15      SBC HL,DE
000955 4955 3008            12      JR  NC,RCP0
000957 4957 215EF5          10      LD  HL,BUF
00095A 495A 22D4F2          16      LD  (_DTA),HL
00095D 495D 6F               4      LD  L,A ;0
00095E 495E 67               4      LD  H,A ;0
       495F                     RCP0:
00095F 495F 24               4      INC H
000960 4960 22DCF2          16      LD  (_BUF_EN),HL
       4963                     RCP1:
000963 4963 F3               4      DI
000964 4964 CD394A          17      CALL    WAIT_VDP
                                
000967 4967 3A0700          13      LD  A,(WRVDP)
00096A 496A 4F               4      LD  C,A
00096B 496B 0C               4      INC C       ;C := PORT#1's address(WR)
00096C 496C 3E24             7      LD  A,36
00096E 496E ED79            12      OUT (C),A
000970 4970 3E91             7      LD  A,080H+17
000972 4972 ED79            12      OUT (C),A       ;R#17 := 36
                                
000974 4974 0C               4      INC C
000975 4975 0C               4      INC C       ;C := PORT#3's address(WR)
000976 4976 2AE2F2          16      LD  HL,(_BUF_X)
000979 4979 ED69            12      OUT (C),L       ;R#36 DX
00097B 497B ED61            12      OUT (C),H       ;R#37
00097D 497D 2AE4F2          16      LD  HL,(_BUF_Y)
000980 4980 ED69            12      OUT (C),L       ;R#38 DY
000982 4982 ED61            12      OUT (C),H       ;R#39
000984 4984 2ADEF2          16      LD  HL,(_BUF_W)
000987 4987 ED69            12      OUT (C),L       ;R#40 NX
000989 4989 ED61            12      OUT (C),H       ;R#41
00098B 498B 2AE0F2          16      LD  HL,(_BUF_H)
00098E 498E ED69            12      OUT (C),L       ;R#42 NY
000990 4990 ED61            12      OUT (C),H       ;R#43
                                
000992 4992 DD2AAFFC        20      LD  IX,(SCRMOD)
000996 4996 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000999 4999 B7               4      OR  A
00099A 499A 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
00099C 499C DD7D             9      LD  A,IXL
00099E 499E FE08             7      CP  8
0009A0 49A0 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
0009A2 49A2 FE06             7      CP  6
0009A4 49A4 2AE2F2          16      LD  HL,(_BUF_X)
0009A7 49A7 3ADEF2          13      LD  A,(_BUF_W)
0009AA 49AA 2005            12      JR  NZ,SCR57
0009AC 49AC B5               4      OR  L       ;スクリーン6
0009AD 49AD E603             7      AND 3
0009AF 49AF 200D            12      JR  NZ,USE_LMMC
       49B1                     SCR57:              ;スクリーン5,7
0009B1 49B1 B5               4      OR  L
0009B2 49B2 E601             7      AND 1
0009B4 49B4 2008            12      JR  NZ,USE_LMMC
       49B6                     USE_HMMC:
0009B6 49B6 DD2E08          10      LD  IXL,8
       49B9                     USE_HMMC8:
0009B9 49B9 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
0009BB 49BB 32D9F2          13      LD  (_BUF_LO),A
       49BE                     USE_LMMC:
0009BE 49BE 110000          10      LD  DE,0
0009C1 49C1 06FF             7      LD  B,-1
0009C3 49C3 CD644A          17      CALL    GET_PIXEL
0009C6 49C6 ED79            12      OUT (C),A       ;R#44 first DATA
0009C8 49C8 3AE6F2          13      LD  A,(_BUF_O)
0009CB 49CB ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
0009CD 49CD 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0009D0 49D0 F6B0             7      OR  0B0H        ;R#46 LMMC command
0009D2 49D2 ED79            12      OUT (C),A
                                
0009D4 49D4 FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
0009D6 49D6 0D               4      DEC C
0009D7 49D7 0D               4      DEC C       ;C := PORT#1's address(WR)
0009D8 49D8 3EAC             7      LD  A,080H+44
0009DA 49DA ED79            12      OUT (C),A
0009DC 49DC 3E91             7      LD  A,080H+17
0009DE 49DE ED79            12      OUT (C),A       ;R#17 := 44
                                
0009E0 49E0 3A0600          13      LD  A,(RDVDP)
0009E3 49E3 3C               4      INC A
0009E4 49E4 FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
0009E6 49E6 3E02             7      LD  A,2
0009E8 49E8 ED79            12      OUT (C),A
0009EA 49EA 3E8F             7      LD  A,08FH
0009EC 49EC ED79            12      OUT (C),A
0009EE 49EE 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0009F1 49F1 E640             7      AND 040H
0009F3 49F3 201C            12      JR  NZ,LOOP_HMMC
       49F5                     LOOP_COPY:
0009F5 49F5 CD644A          17      CALL    GET_PIXEL
0009F8 49F8 08               4      EX  AF,AF'
0009F9 49F9 FD4C             9      LD  C,IYH
       49FB                     LOOP_COPY1:
0009FB 49FB ED78            12      IN  A,(C)
0009FD 49FD 0F               4      RRCA            ;RRCAではサインフラグは変化しない
0009FE 49FE 300A            12      JR  NC,EXIT_COPY    ;check CE bit
000A00 4A00 F2FB49          10      JP  P,LOOP_COPY1    ;check TR bit
000A03 4A03 08               4      EX  AF,AF'
000A04 4A04 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000A06 4A06 ED79            12      OUT (C),A
000A08 4A08 18EB            12      JR  LOOP_COPY
                                
       4A0A                     EXIT_COPY:
000A0A 4A0A CD414A          17      CALL    GET_STATUS_0
000A0D 4A0D FB               4      EI
000A0E 4A0E C3A547          10      JP  ROM_NEXT
                                
       4A11                     LOOP_HMMC:
000A11 4A11 F3               4      DI          ;必要
000A12 4A12 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000A14 4A14 43               4      LD  B,E
000A15 4A15 7B               4      LD  A,E
000A16 4A16 B7               4      OR  A
000A17 4A17 2802            12      JR  Z,LOOP_HMMC1
000A19 4A19 EDB3                    OTIR
       4A1B                     LOOP_HMMC1:
000A1B 4A1B 14               4      INC D
       4A1C                     LOOP_HMMC2:
000A1C 4A1C 15               4      DEC D
000A1D 4A1D 2805            12      JR  Z,LOOP_HMMC3
000A1F 4A1F EDB3                    OTIR
000A21 4A21 C31C4A          10      JP  LOOP_HMMC2
       4A24                     LOOP_HMMC3:
000A24 4A24 ED78            12      IN  A,(C)
000A26 4A26 0F               4      RRCA
000A27 4A27 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
000A29 4A29 2ADCF2          16      LD  HL,(_BUF_EN)
000A2C 4A2C CDAB4A          17      CALL    ROM_READ
000A2F 4A2F EB               4      EX  DE,HL
000A30 4A30 2AD4F2          16      LD  HL,(_DTA)
000A33 4A33 7A               4      LD  A,D
000A34 4A34 B3               4      OR  E
000A35 4A35 20DA            12      JR  NZ,LOOP_HMMC
000A37 4A37 18C2            12      JR  LOOP_COPY1
                                    
       4A39                     WAIT_VDP:
000A39 4A39 3E02             7      LD  A,2
000A3B 4A3B CD424A          17      CALL    GET_STATUS
000A3E 4A3E 0F               4      RRCA
000A3F 4A3F 38F8            12      JR  C,WAIT_VDP
       4A41                     GET_STATUS_0:
000A41 4A41 AF               4      XOR A
       4A42                     GET_STATUS:
000A42 4A42 C5              11      PUSH    BC
000A43 4A43 ED4B0600        20      LD  BC,(RDVDP)
000A47 4A47 0C               4      INC C
000A48 4A48 ED79            12      OUT (C),A
000A4A 4A4A 3E8F             7      LD  A,08FH
000A4C 4A4C ED79            12      OUT (C),A
000A4E 4A4E ED78            12      IN  A,(C)
000A50 4A50 C1              10      POP BC
000A51 4A51 C9              10      RET
                                
       4A52                     GET_PIXEL256:
000A52 4A52 7A               4      LD  A,D
000A53 4A53 B3               4      OR  E
000A54 4A54 200A            12      JR  NZ,GET_PIXEL1
000A56 4A56 2ADCF2          16      LD  HL,(_BUF_EN)
000A59 4A59 CDAB4A          17      CALL    ROM_READ
000A5C 4A5C EB               4      EX  DE,HL
000A5D 4A5D 2AD4F2          16      LD  HL,(_DTA)
       4A60                     GET_PIXEL1:
000A60 4A60 7E               7      LD  A,(HL)
000A61 4A61 23               6      INC HL
000A62 4A62 1B               6      DEC DE
000A63 4A63 C9              10      RET
                                
       4A64                     GET_PIXEL:
000A64 4A64 DD7D             9      LD  A,IXL
000A66 4A66 FE08             7      CP  8
000A68 4A68 28E8            12      JR  Z,GET_PIXEL256
000A6A 4A6A 04               4      INC B
000A6B 4A6B FE06             7      CP  6
000A6D 4A6D 282E            12      JR  Z,GET_PIXEL4
                                
000A6F 4A6F CB40             8      BIT 0,B
000A71 4A71 20ED            12      JR  NZ,GET_PIXEL1
                                
000A73 4A73 7A               4      LD  A,D
000A74 4A74 B3               4      OR  E
000A75 4A75 200A            12      JR  NZ,GET_PIXEL2
                                
000A77 4A77 2ADCF2          16      LD  HL,(_BUF_EN)
000A7A 4A7A CDAB4A          17      CALL    ROM_READ
000A7D 4A7D EB               4      EX  DE,HL
000A7E 4A7E 2AD4F2          16      LD  HL,(_DTA)
                                
       4A81                     GET_PIXEL2:
000A81 4A81 7E               7      LD  A,(HL)
000A82 4A82 0F               4      RRCA
000A83 4A83 0F               4      RRCA
000A84 4A84 0F               4      RRCA
000A85 4A85 0F               4      RRCA
000A86 4A86 C9              10      RET
                                
       4A87                     GET_PIXEL3:
000A87 4A87 7A               4      LD  A,D
000A88 4A88 B3               4      OR  E
000A89 4A89 200A            12      JR  NZ,GET_PIXEL5
                                
000A8B 4A8B 2ADCF2          16      LD  HL,(_BUF_EN)
000A8E 4A8E CDAB4A          17      CALL    ROM_READ
000A91 4A91 EB               4      EX  DE,HL
000A92 4A92 2AD4F2          16      LD  HL,(_DTA)
       4A95                     GET_PIXEL5:
000A95 4A95 7E               7      LD  A,(HL)
000A96 4A96 0F               4      RRCA
000A97 4A97 0F               4      RRCA
000A98 4A98 0F               4      RRCA
000A99 4A99 0F               4      RRCA
000A9A 4A9A 0F               4      RRCA
000A9B 4A9B 0F               4      RRCA
000A9C 4A9C C9              10      RET
                                
       4A9D                     GET_PIXEL4:
000A9D 4A9D 78               4      LD  A,B
000A9E 4A9E E603             7      AND 3   ;+0
000AA0 4AA0 28E5            12      JR  Z,GET_PIXEL3
000AA2 4AA2 3D               4      DEC A   ;+1
000AA3 4AA3 28DC            12      JR  Z,GET_PIXEL2
000AA5 4AA5 3D               4      DEC A   ;+2
000AA6 4AA6 7E               7      LD  A,(HL)
000AA7 4AA7 C0              11      RET NZ
000AA8 4AA8 0F               4      RRCA        ;+3
000AA9 4AA9 0F               4      RRCA
000AAA 4AAA C9              10      RET
                                
       4AAB                     ROM_READ:
000AAB 4AAB E5              11      PUSH    HL
000AAC 4AAC D5              11      PUSH    DE
000AAD 4AAD C5              11      PUSH    BC
000AAE 4AAE FDE5            15      PUSH    IY
000AB0 4AB0 22F0F2          16      LD  (LEFTX),HL
000AB3 4AB3 2AD4F2          16      LD  HL,(_DTA)
000AB6 4AB6 22E7F2          16      LD  (DTAX),HL
000AB9 4AB9 2AF0F2          16      LD  HL,(LEFTX)
                                
000ABC 4ABC CD5D4D          17      CALL    RBX1
000ABF 4ABF 3870            12      JR  C,RBRERR1
000AC1 4AC1 79               4      LD  A,C
000AC2 4AC2 EB               4      EX  DE,HL
000AC3 4AC3 ED52            15      SBC HL,DE       ;CP 0HL,CDE
000AC5 4AC5 19              11      ADD HL,DE
000AC6 4AC6 DE00             7      SBC A,000H
000AC8 4AC8 3801            12      JR  C,RBR1
000ACA 4ACA EB               4      EX  DE,HL
       4ACB                     RBR1:
000ACB 4ACB 9F               4      SBC A,A
000ACC 4ACC E601             7      AND 1
000ACE 4ACE 32C3F2          13      LD  (_RESULT),A
000AD1 4AD1 7C               4      LD  A,H
000AD2 4AD2 B5               4      OR  L
000AD3 4AD3 CA274B          10      JP  Z,RBREND0
                                
000AD6 4AD6 22D0F2          16      LD  (_LEFT),HL  ;Read record byte
000AD9 4AD9 22F0F2          16      LD  (LEFTX),HL
                                
000ADC 4ADC CD894D          17      CALL    RBX2
000ADF 4ADF 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000AE1 4AE1 CD9C4D          17      CALL    RBXA
000AE4 4AE4 DA3D4B          10      JP  C,RBRERR
000AE7 4AE7 C5              11      PUSH    BC
000AE8 4AE8 CD2145          17      CALL    ROM_LDIR
000AEB 4AEB ED53E7F2        20      LD  (DTAX),DE
000AEF 4AEF 2AF0F2          16      LD  HL,(LEFTX)
000AF2 4AF2 D1              10      POP DE
000AF3 4AF3 A7               4      AND A
000AF4 4AF4 ED52            15      SBC HL,DE
000AF6 4AF6 22F0F2          16      LD  (LEFTX),HL
000AF9 4AF9 2829            12      JR  Z,RBREND
                                
       4AFB                     RBRB:
000AFB 4AFB CDD84D          17      CALL    RBXB
000AFE 4AFE 2818            12      JR  Z,RBRC
       4B00                     RBRB1:
000B00 4B00 C5              11      PUSH    BC
000B01 4B01 D5              11      PUSH    DE
000B02 4B02 CD834E          17      CALL    CLUST
000B05 4B05 EB               4      EX  DE,HL
000B06 4B06 ED4BC6F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000B0A 4B0A CD2145          17      CALL    ROM_LDIR
000B0D 4B0D EB               4      EX  DE,HL
000B0E 4B0E D1              10      POP DE
000B0F 4B0F C1              10      POP BC
000B10 4B10 CD604E          17      CALL    GNCL
000B13 4B13 DA3D4B          10      JP  C,RBRERR
000B16 4B16 10E8            13      DJNZ    RBRB1
       4B18                     RBRC:
000B18 4B18 CDF04D          17      CALL    RBXC
000B1B 4B1B 2807            12      JR  Z,RBREND
                                
000B1D 4B1D CD834E          17      CALL    CLUST
000B20 4B20 EB               4      EX  DE,HL
000B21 4B21 CD2145          17      CALL    ROM_LDIR
       4B24                     RBREND:
000B24 4B24 CDFC4D          17      CALL    RBXEND
       4B27                     RBREND0:
000B27 4B27 FDE1            14      POP IY
000B29 4B29 C1              10      POP BC
000B2A 4B2A D1              10      POP DE
000B2B 4B2B F1              10      POP AF  ;(HL)
000B2C 4B2C AF               4      XOR A
000B2D 4B2D 3AC3F2          13      LD  A,(_RESULT)
000B30 4B30 C9              10      RET
                                
       4B31                     RBRERR1:
000B31 4B31 3E01             7      LD  A,001H
       4B33                     RBRERR2:
000B33 4B33 FDE1            14      POP IY
000B35 4B35 C1              10      POP BC
000B36 4B36 D1              10      POP DE
000B37 4B37 E1              10      POP HL
000B38 4B38 37               4      SCF
000B39 4B39 210000          10      LD  HL,0
000B3C 4B3C C9              10      RET
       4B3D                     RBRERR:
000B3D 4B3D 3EFF             7      LD  A,0FFH
000B3F 4B3F 18F2            12      JR  RBRERR2
                                
       4B41                     FILE_DD:
000B41 4B41 E1              10      POP HL
000B42 4B42 3E                      DB  03EH
000B43 4B43 C9              10      RET
000B44 4B44 32A3F2          13      LD  (SWC_BLOAD_M),A
       4B47                     ROM_ORG:
000B47 4B47 2AF2F2          16      LD  HL,(PARAM0)
000B4A 4B4A 7E               7      LD  A,(HL)
000B4B 4B4B C9              10      RET
       4B4C                     FILE_B:
000B4C 4B4C AF               4      XOR A
000B4D 4B4D 32F8F2          13      LD  (FDRV),A
000B50 4B50 1E00             7      LD  E,0
000B52 4B52 3A63F6          13      LD  A,(VALTYP)
000B55 4B55 FE03             7      CP  3       ;string
000B57 4B57 C2DC4B          10      JP  NZ,FILED
                                
000B5A 4B5A DD21D067        14      LD  IX,FRESTR
000B5E 4B5E FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000B62 4B62 CD1C00          17      CALL    _CALSLT
000B65 4B65 E5              11      PUSH    HL
000B66 4B66 DDE1            14      POP IX
                                
000B68 4B68 DD5E00          19      LD  E,(IX+0)
000B6B 4B6B DD7E01          19      LD  A,(IX+1)
000B6E 4B6E DD5602          19      LD  D,(IX+2)
000B71 4B71 DD62             9      LD  IXH,D
000B73 4B73 DD6F             9      LD  IXL,A
000B75 4B75 7B               4      LD  A,E
       4B76                     FILE_BDOS:
000B76 4B76 FE04             7      CP  4
000B78 4B78 3808            12      JR  C,FILEB1
000B7A 4B7A DD7E03          19      LD  A,(IX+3)
000B7D 4B7D FE3A             7      CP  ':'
000B7F 4B7F 28C0            12      JR  Z,FILE_DD
000B81 4B81 7B               4      LD  A,E
       4B82                     FILEB1:
000B82 4B82 FE02             7      CP  2
000B84 4B84 3818            12      JR  C,DEVI1
000B86 4B86 DD7E01          19      LD  A,(IX+1)
000B89 4B89 FE3A             7      CP  ':'
000B8B 4B8B 2011            12      JR  NZ,DEVI1
000B8D 4B8D DD7E00          19      LD  A,(IX+0)        ;DRIVE
000B90 4B90 CDB54C          17      CALL    CAP
000B93 4B93 D640             7      SUB '@'
000B95 4B95 DD23            10      INC IX
000B97 4B97 DD23            10      INC IX
000B99 4B99 1D               4      DEC E
000B9A 4B9A 1D               4      DEC E
000B9B 4B9B 32F8F2          13      LD  (FDRV),A
       4B9E                     DEVI1:
000B9E 4B9E DD7E00          19      LD  A,(IX+0)
000BA1 4BA1 D65C             7      SUB 05CH        ;\
000BA3 4BA3 2008            12      JR  NZ,NOROOT
000BA5 4BA5 6F               4      LD  L,A
000BA6 4BA6 67               4      LD  H,A
000BA7 4BA7 22F6F2          16      LD  (_CDX),HL
000BAA 4BAA DD23            10      INC IX
000BAC 4BAC 1D               4      DEC E
       4BAD                     NOROOT:
                                
       4BAD                     SETDIR:
000BAD 4BAD CDDC4B          17      CALL    FILED
000BB0 4BB0 DD7E00          19      LD  A,(IX+0)
000BB3 4BB3 FE5C             7      CP  05CH        ;\
000BB5 4BB5 C0              11      RET NZ
000BB6 4BB6 DD23            10      INC IX
000BB8 4BB8 1D               4      DEC E
000BB9 4BB9 3AF9F2          13      LD  A,(FNAME)
000BBC 4BBC FE20             7      CP  020H        ;. の処理
000BBE 4BBE 28ED            12      JR  Z,SETDIR
                                
000BC0 4BC0 CDCB4C          17      CALL    ROM_OPEN
000BC3 4BC3 B7               4      OR  A
000BC4 4BC4 C0              11      RET NZ
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                #else
000BC5 4BC5 FD2AEDF2        20      LD  IY,(DIRENT1)
000BC9 4BC9 FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000BCD 4BCD C8              11      RET Z
000BCE 4BCE CD234C          17      CALL    FILEI
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
000BD1 4BD1 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000BD4 4BD4 FD661B          19      LD  H,(IY+01BH)
                                #endif
000BD7 4BD7 22F6F2          16      LD  (_CDX),HL
000BDA 4BDA 18D1            12      JR  SETDIR
                                
       4BDC                     FILED:
000BDC 4BDC CD234C          17      CALL    FILEI
000BDF 4BDF 21F9F2          10      LD  HL,FNAME
                                
000BE2 4BE2 0608             7      LD  B,8
       4BE4                     FILE2:
000BE4 4BE4 CD304C          17      CALL    CCHKF
000BE7 4BE7 C8              11      RET Z
000BE8 4BE8 FE2A             7      CP  '*'
000BEA 4BEA 282E            12      JR  Z,FILE9
000BEC 4BEC FE2E             7      CP  '.'
000BEE 4BEE 280C            12      JR  Z,FILE4
000BF0 4BF0 77               7      LD  (HL),A
000BF1 4BF1 23               6      INC HL
000BF2 4BF2 10F0            13      DJNZ    FILE2
                                
       4BF4                     FILE3:
000BF4 4BF4 CD304C          17      CALL    CCHKF
000BF7 4BF7 C8              11      RET Z
000BF8 4BF8 FE2E             7      CP  '.'
000BFA 4BFA 20F8            12      JR  NZ,FILE3
                                
       4BFC                     FILE4:
000BFC 4BFC 2101F3          10      LD  HL,FNAME+8
000BFF 4BFF 0603             7      LD  B,3
                                
       4C01                     FILE4L:
000C01 4C01 CD304C          17      CALL    CCHKF
000C04 4C04 C8              11      RET Z
000C05 4C05 FE2E             7      CP  '.'
000C07 4C07 2008            12      JR  NZ,FILE12
000C09 4C09 32F9F2          13      LD  (FNAME),A   ;Parent directory(..)
000C0C 4C0C 32FAF2          13      LD  (FNAME+1),A
000C0F 4C0F 3E20             7      LD  A,020H
       4C11                     FILE12:
000C11 4C11 FE2A             7      CP  '*'
000C13 4C13 280A            12      JR  Z,FILE10
000C15 4C15 77               7      LD  (HL),A
000C16 4C16 23               6      INC HL
000C17 4C17 10E8            13      DJNZ    FILE4L
000C19 4C19 C9              10      RET
                                
       4C1A                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000C1A 4C1A CD1F4C          17      CALL    FILE10
000C1D 4C1D 18D5            12      JR  FILE3
                                
       4C1F                     FILE10:
000C1F 4C1F 3E3F             7      LD  A,'?'
000C21 4C21 1808            12      JR  FILL_MEMORY
       4C23                     FILEI:              ;名前＋拡張子をスペースで初期化
000C23 4C23 3E20             7      LD  A,020H
000C25 4C25 01000B          10      LD  BC,11*256   ;C=0にしておく
000C28 4C28 21F9F2          10      LD  HL,FNAME
       4C2B                     FILL_MEMORY:            ;HLからBバイトAで埋める
000C2B 4C2B 77               7      LD  (HL),A
000C2C 4C2C 23               6      INC HL
000C2D 4C2D 10FC            13      DJNZ    FILL_MEMORY
000C2F 4C2F C9              10      RET
                                
       4C30                     CCHKF:
000C30 4C30 7B               4      LD  A,E
000C31 4C31 B7               4      OR  A
000C32 4C32 C8              11      RET Z
000C33 4C33 DD7E00          19      LD  A,(IX+0)
000C36 4C36 CD3D4C          17      CALL    CCHK2
000C39 4C39 C8              11      RET Z
000C3A 4C3A C3A04C          10      JP  FKAN
                                
       4C3D                     CCHK2:
000C3D 4C3D 0C               4      INC C
000C3E 4C3E 0D               4      DEC C
000C3F 4C3F C0              11      RET NZ
       4C40                     CCHK3:              ;ZF=1 で使えない文字
000C40 4C40 FE2B             7      CP  '+'
000C42 4C42 C8              11      RET Z
000C43 4C43 FE2C             7      CP  ','
000C45 4C45 C8              11      RET Z
000C46 4C46 FE2F             7      CP  '/'
000C48 4C48 C8              11      RET Z
000C49 4C49 FE3A             7      CP  ':'
000C4B 4C4B C8              11      RET Z
000C4C 4C4C FE3B             7      CP  ';'
000C4E 4C4E C8              11      RET Z
000C4F 4C4F FE3D             7      CP  '='
000C51 4C51 C8              11      RET Z
000C52 4C52 FE5C             7      CP  05CH    ;\
000C54 4C54 C8              11      RET Z
000C55 4C55 FE1F             7      CP  01FH
000C57 4C57 D0              11      RET NC
000C58 4C58 BF               4      CP  A       ;Z=1
000C59 4C59 C9              10      RET
                                
       4C5A                     SS1:
000C5A 4C5A 13               6      INC DE
       4C5B                     SPCUT:              ;スペースをカット
000C5B 4C5B 1A               7      LD  A,(DE)
000C5C 4C5C FE20             7      CP  020H
000C5E 4C5E 28FA            12      JR  Z,SS1
000C60 4C60 C9              10      RET
                                
       4C61                     SCREOF1:
000C61 4C61 13               6      INC DE
       4C62                     SPCUTEX:            ;スペース改行などをカット
000C62 4C62 1A               7      LD  A,(DE)
000C63 4C63 FE20             7      CP  020H
000C65 4C65 28FA            12      JR  Z,SCREOF1
000C67 4C67 FE0D             7      CP  00DH
000C69 4C69 28F6            12      JR  Z,SCREOF1
000C6B 4C6B FE0A             7      CP  00AH
000C6D 4C6D 28F2            12      JR  Z,SCREOF1
000C6F 4C6F FE1A             7      CP  01AH
000C71 4C71 28EE            12      JR  Z,SCREOF1
000C73 4C73 C9              10      RET
                                
       4C74                     GETNUM:
000C74 4C74 210000          10      LD  HL,0
       4C77                     GETNUM1:
000C77 4C77 1A               7      LD  A,(DE)
000C78 4C78 13               6      INC DE
000C79 4C79 D630             7      SUB '0'
000C7B 4C7B D8              11      RET C
000C7C 4C7C FE0A             7      CP  10
000C7E 4C7E D0              11      RET NC
000C7F 4C7F 4D               4      LD  C,L
000C80 4C80 44               4      LD  B,H
000C81 4C81 29              11      ADD HL,HL   ;*2
000C82 4C82 29              11      ADD HL,HL   ;*4
000C83 4C83 09              11      ADD HL,BC   ;*5
000C84 4C84 29              11      ADD HL,HL   ;*10
000C85 4C85 4F               4      LD  C,A
000C86 4C86 0600             7      LD  B,0
000C88 4C88 09              11      ADD HL,BC
000C89 4C89 18EC            12      JR  GETNUM1
                                
       4C8B                     SEARCH_END:
000C8B 4C8B 7E               7      LD  A,(HL)
       4C8C                     SEARCH_END1:
000C8C 4C8C 23               6      INC HL
000C8D 4C8D B7               4      OR  A
000C8E 4C8E C8              11      RET Z
000C8F 4C8F FE3A             7      CP  ':'
000C91 4C91 20F8            12      JR  NZ,SEARCH_END
000C93 4C93 7E               7      LD  A,(HL)
000C94 4C94 FE3A             7      CP  ':'
000C96 4C96 28F4            12      JR  Z,SEARCH_END1
000C98 4C98 C9              10      RET
                                
       4C99                     FKANC:
000C99 4C99 CB41             8      BIT 0,C
000C9B 4C9B CCBE4C          17      CALL    Z,CAP2
000C9E 4C9E 1803            12      JR  FKANX
       4CA0                     FKAN:           ;漢字チェック
000CA0 4CA0 DD23            10      INC IX
000CA2 4CA2 1D               4      DEC E
       4CA3                     FKANX:
000CA3 4CA3 CB41             8      BIT 0,C
000CA5 4CA5 CB81             8      RES 0,C
000CA7 4CA7 C0              11      RET NZ
000CA8 4CA8 FE80             7      CP  080H
000CAA 4CAA D8              11      RET C
000CAB 4CAB FEA0             7      CP  0A0H
000CAD 4CAD 3803            12      JR  C,FKAN1
000CAF 4CAF FEE0             7      CP  0E0H
000CB1 4CB1 D8              11      RET C
       4CB2                     FKAN1:
000CB2 4CB2 0C               4      INC C
000CB3 4CB3 A7               4      AND A
000CB4 4CB4 C9              10      RET
                                
       4CB5                     CAP:
000CB5 4CB5 FE61             7      CP  'a'
000CB7 4CB7 D8              11      RET C
000CB8 4CB8 FE7B             7      CP  'z'+1
000CBA 4CBA D0              11      RET NC
000CBB 4CBB D620             7      SUB 020H
000CBD 4CBD C9              10      RET
       4CBE                     CAP2:
000CBE 4CBE CDB54C          17      CALL    CAP
       4CC1                     CAP3:               ;
000CC1 4CC1 FE05             7      CP  5
000CC3 4CC3 2803            12      JR  Z,CAP4
000CC5 4CC5 FE21             7      CP  021H
000CC7 4CC7 C9              10      RET
       4CC8                     CAP4:
000CC8 4CC8 3EE5             7      LD  A,0E5H
000CCA 4CCA C9              10      RET
                                
       4CCB                     ROM_OPEN:
000CCB 4CCB CDAD53          17      CALL    GET_DISK_BANK_FDRV
                                
000CCE 4CCE CD294F          17      CALL    GET_DIR_DAT
000CD1 4CD1 D5              11      PUSH    DE
000CD2 4CD2 CDE74C          17      CALL    FILESE
000CD5 4CD5 D1              10      POP DE
000CD6 4CD6 3F               4      CCF
000CD7 4CD7 D8              11      RET C
000CD8 4CD8 22EDF2          16      LD  (DIRENT1),HL
000CDB 4CDB E5              11      PUSH    HL
000CDC 4CDC 210000          10      LD  HL,0
000CDF 4CDF 22CAF2          16      LD  (RR_LOW),HL
000CE2 4CE2 22CCF2          16      LD  (RR_HIGH),HL
000CE5 4CE5 E1              10      POP HL
000CE6 4CE6 C9              10      RET
                                
       4CE7                     FILESE:
       4CE7                     FILESE0:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000CE7 4CE7 7E               7      LD  A,(HL)
                                #endif
000CE8 4CE8 B7               4      OR  A
000CE9 4CE9 C8              11      RET Z       ;END:ZF=1 CF=0
000CEA 4CEA FEE5             7      CP  0E5H
000CEC 4CEC 280D            12      JR  Z,FILESE1
000CEE 4CEE 11F9F2          10      LD  DE,FNAME
000CF1 4CF1 E5              11      PUSH    HL
000CF2 4CF2 CD384D          17      CALL    CPFILE
000CF5 4CF5 CC594D          17      CALL    Z,CPFILE2
000CF8 4CF8 E1              10      POP HL
000CF9 4CF9 37               4      SCF
000CFA 4CFA C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4CFB                     FILESE1:
000CFB 4CFB CD034D          17      CALL    FNEXT
000CFE 4CFE 20E7            12      JR  NZ,FILESE0
000D00 4D00 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000D02 4D02 C9              10      RET
                                
       4D03                     FNEXT:
000D03 4D03 112000          10      LD  DE,020H
000D06 4D06 19              11      ADD HL,DE
000D07 4D07 ED5BF6F2        20      LD  DE,(_CDX)
000D0B 4D0B 7A               4      LD  A,D
000D0C 4D0C B3               4      OR  E
000D0D 4D0D 2019            12      JR  NZ,FNEXT_SUBDIR
000D0F 4D0F 0D               4      DEC C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
       4D10                     CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
000D10 4D10 F5              11      PUSH    AF      ;※フラグを保存する必要あり
000D11 4D11 CB7C             8      BIT 7,H
000D13 4D13 2811            12      JR  Z,CHECK_DIR_PAGE1
000D15 4D15 7C               4      LD  A,H
000D16 4D16 D620             7      SUB 020H
000D18 4D18 67               4      LD  H,A
000D19 4D19 3AEFF2          13      LD  A,(_DIR_BANK)
000D1C 4D1C 3C               4      INC A
000D1D 4D1D 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D20 4D20 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D23 4D23 32EFF2          13      LD  (_DIR_BANK),A
       4D26                     CHECK_DIR_PAGE1:
000D26 4D26 F1              10      POP AF
                                #endif
000D27 4D27 C9              10      RET
                                
       4D28                     FNEXT_SUBDIR:           ;サブディレクトリ
000D28 4D28 0D               4      DEC C
000D29 4D29 C0              11      RET NZ
                                
000D2A 4D2A ED5BF6F2        20      LD  DE,(_CDX)
000D2E 4D2E CD604E          17      CALL    GNCL
000D31 4D31 EB               4      EX  DE,HL
000D32 4D32 22F6F2          16      LD  (_CDX),HL
000D35 4D35 C3654F          10      JP  GET_SUBDIR
                                
       4D38                     CPFILE:
000D38 4D38 C5              11      PUSH    BC
000D39 4D39 01000B          10      LD  BC,00B00H
       4D3C                     CPSTR1:
000D3C 4D3C 1A               7      LD  A,(DE)
000D3D 4D3D FE3F             7      CP  '?'     ;Wild card
000D3F 4D3F 2812            12      JR  Z,CPSTR2
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000D41 4D41 7E               7      LD  A,(HL)
                                #endif
000D42 4D42 CD994C          17      CALL    FKANC
000D45 4D45 E5              11      PUSH    HL
000D46 4D46 67               4      LD  H,A
000D47 4D47 1A               7      LD  A,(DE)
000D48 4D48 CB01             8      RLC C
000D4A 4D4A CD994C          17      CALL    FKANC
000D4D 4D4D CB09             8      RRC C
000D4F 4D4F BC               4      CP  H       ;CP (HL),(DE)
000D50 4D50 E1              10      POP HL
000D51 4D51 2004            12      JR  NZ,CPSTR3
       4D53                     CPSTR2:
000D53 4D53 13               6      INC DE
000D54 4D54 23               6      INC HL
000D55 4D55 10E5            13      DJNZ    CPSTR1
       4D57                     CPSTR3:
000D57 4D57 C1              10      POP BC
000D58 4D58 C9              10      RET
                                
       4D59                     CPFILE2:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000D59 4D59 7E               7      LD  A,(HL)
                                #endif
000D5A 4D5A E608             7      AND 008H    ;~0F7H
000D5C 4D5C C9              10      RET
                                
       4D5D                     RBX1:
000D5D 4D5D E5              11      PUSH    HL      ;Record byte
                                
000D5E 4D5E ED5BCAF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000D62 4D62 3ACDF2          13      LD  A,(RR_HIGH+1)
000D65 4D65 4F               4      LD  C,A
                                
000D66 4D66 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001CH
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    CALL    RDSLT_ROM
                                    EX  DE,HL       ;AHL=File size
                                    POP DE
                                #else
000D69 4D69 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D6C 4D6C 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D6F 4D6F FD2AEDF2        20      LD  IY,(DIRENT1)
000D73 4D73 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000D76 4D76 FD661D          19      LD  H,(IY+01DH)
000D79 4D79 FD7E1E          19      LD  A,(IY+01EH)
                                #endif
                                
000D7C 4D7C A7               4      AND A
000D7D 4D7D ED52            15      SBC HL,DE
000D7F 4D7F 99               4      SBC A,C
000D80 4D80 D1              10      POP DE
                                
000D81 4D81 D8              11      RET C
000D82 4D82 4F               4      LD  C,A
000D83 4D83 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000D84 4D84 B2               4      OR  D
000D85 4D85 B3               4      OR  E
000D86 4D86 C0              11      RET NZ
000D87 4D87 37               4      SCF
000D88 4D88 C9              10      RET
                                
       4D89                     RBX2:
000D89 4D89 ED4BCBF2        20      LD  BC,(RR_LOW+1)
000D8D 4D8D CD114E          17      CALL    RWXR
000D90 4D90 3AC7F2          13      LD  A,(CLSZ_H)
000D93 4D93 3D               4      DEC A
000D94 4D94 E5              11      PUSH    HL
000D95 4D95 2ACAF2          16      LD  HL,(RR_LOW)
000D98 4D98 A4               4      AND H
000D99 4D99 B5               4      OR  L
000D9A 4D9A E1              10      POP HL
000D9B 4D9B C9              10      RET
                                
       4D9C                     RBXA:
000D9C 4D9C D5              11      PUSH    DE
000D9D 4D9D CD834E          17      CALL    CLUST
000DA0 4DA0 ED53D2F2        20      LD  (_DTPS),DE
000DA4 4DA4 D1              10      POP DE
000DA5 4DA5 CD604E          17      CALL    GNCL
000DA8 4DA8 D8              11      RET C
000DA9 4DA9 ED53CEF2        20      LD  (_CLPS),DE
                                
000DAD 4DAD ED4BCAF2        20      LD  BC,(RR_LOW)
000DB1 4DB1 2AC6F2          16      LD  HL,(CLSZ)
000DB4 4DB4 7C               4      LD  A,H
000DB5 4DB5 3D               4      DEC A
000DB6 4DB6 A0               4      AND B
000DB7 4DB7 47               4      LD  B,A
000DB8 4DB8 ED42            15      SBC HL,BC       ;remaining cluster
                                
000DBA 4DBA ED5BF0F2        20      LD  DE,(LEFTX)
000DBE 4DBE ED52            15      SBC HL,DE       ;CP HL,DE
000DC0 4DC0 19              11      ADD HL,DE
000DC1 4DC1 3801            12      JR  C,RBXA1
000DC3 4DC3 EB               4      EX  DE,HL
       4DC4                     RBXA1:
000DC4 4DC4 3AC4F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
000DC7 4DC7 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000DCA 4DCA 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000DCD 4DCD E5              11      PUSH    HL
000DCE 4DCE 2AD2F2          16      LD  HL,(_DTPS)
000DD1 4DD1 09              11      ADD HL,BC
000DD2 4DD2 ED5BE7F2        20      LD  DE,(DTAX)
000DD6 4DD6 C1              10      POP BC
000DD7 4DD7 C9              10      RET
                                
       4DD8                     RBXB:
000DD8 4DD8 2AE7F2          16      LD  HL,(DTAX)
000DDB 4DDB ED5BCEF2        20      LD  DE,(_CLPS)
000DDF 4DDF 3AF1F2          13      LD  A,(LEFTX+1)
000DE2 4DE2 47               4      LD  B,A
000DE3 4DE3 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4DE6                     RBXB1:
000DE6 4DE6 1F               4      RRA     ;->CF
000DE7 4DE7 3804            12      JR  C,RBXB2
000DE9 4DE9 CB38             8      SRL B   ;B=B/2
000DEB 4DEB 18F9            12      JR  RBXB1
       4DED                     RBXB2:
000DED 4DED 78               4      LD  A,B
000DEE 4DEE B7               4      OR  A
000DEF 4DEF C9              10      RET
                                
       4DF0                     RBXC:
000DF0 4DF0 ED4BF0F2        20      LD  BC,(LEFTX)
000DF4 4DF4 3AC7F2          13      LD  A,(CLSZ_H)
000DF7 4DF7 3D               4      DEC A
000DF8 4DF8 A0               4      AND B
000DF9 4DF9 47               4      LD  B,A
000DFA 4DFA B1               4      OR  C
000DFB 4DFB C9              10      RET
                                
       4DFC                     RBXEND:
000DFC 4DFC ED5BD0F2        20      LD  DE,(_LEFT)
000E00 4E00 2ACAF2          16      LD  HL,(RR_LOW)
000E03 4E03 3ACDF2          13      LD  A,(RR_HIGH+1)
000E06 4E06 19              11      ADD HL,DE
000E07 4E07 CE00             7      ADC A,0
000E09 4E09 22CAF2          16      LD  (RR_LOW),HL
000E0C 4E0C 32CDF2          13      LD  (RR_HIGH+1),A
000E0F 4E0F EB               4      EX  DE,HL       ;HL=Read byte
000E10 4E10 C9              10      RET 
                                
       4E11                     RWXR:
000E11 4E11 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4E14                     L_RWX:
000E14 4E14 1F               4      RRA     ;->CF
000E15 4E15 3806            12      JR  C,E_RWX
000E17 4E17 CB38             8      SRL B   ;BC=BC/2
000E19 4E19 CB19             8      RR  C   ;
000E1B 4E1B 18F7            12      JR  L_RWX
       4E1D                     E_RWX:
000E1D 4E1D 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
                                    PUSH    HL
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    POP HL
                                #else
000E20 4E20 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000E23 4E23 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000E26 4E26 FD2AEDF2        20      LD  IY,(DIRENT1)
000E2A 4E2A FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000E2D 4E2D FD561B          19      LD  D,(IY+01BH)
                                #endif
000E30 4E30 CDAD53          17      CALL    GET_DISK_BANK_FDRV
       4E33                     RWX1:
000E33 4E33 ED53CEF2        20      LD  (_CLPS),DE
000E37 4E37 7A               4      LD  A,D
000E38 4E38 B3               4      OR  E
000E39 4E39 37               4      SCF
000E3A 4E3A C8              11      RET Z
                                
000E3B 4E3B 78               4      LD  A,B
000E3C 4E3C B1               4      OR  C
000E3D 4E3D C8              11      RET Z
                                
000E3E 4E3E CD604E          17      CALL    GNCL
000E41 4E41 D8              11      RET C
000E42 4E42 0B               6      DEC BC
000E43 4E43 CDC24E          17      CALL    ENDCL
000E46 4E46 38EB            12      JR  C,RWX1
000E48 4E48 37               4      SCF
000E49 4E49 C9              10      RET
                                
       4E4A                     NCL3:
000E4A 4E4A CDAD53          17      CALL    GET_DISK_BANK_FDRV
000E4D 4E4D 6B               4      LD  L,E
000E4E 4E4E 62               4      LD  H,D
000E4F 4E4F CB3C             8      SRL H
000E51 4E51 CB1D             8      RR  L
000E53 4E53 1F               4      RRA
000E54 4E54 19              11      ADD HL,DE
000E55 4E55 010060          10      LD  BC,BANK1_ADR
000E58 4E58 09              11      ADD HL,BC
000E59 4E59 ED4BC8F2        20      LD  BC,(SECSZ)
000E5D 4E5D 09              11      ADD HL,BC
000E5E 4E5E 17               4      RLA
000E5F 4E5F C9              10      RET
                                
       4E60                     GNCL:
000E60 4E60 7A               4      LD  A,D
000E61 4E61 B3               4      OR  E
000E62 4E62 37               4      SCF
000E63 4E63 C8              11      RET Z
000E64 4E64 C5              11      PUSH    BC
000E65 4E65 E5              11      PUSH    HL
000E66 4E66 CD4A4E          17      CALL    NCL3
000E69 4E69 3809            12      JR  C,GNC1
000E6B 4E6B 5E               7      LD  E,(HL)
000E6C 4E6C 23               6      INC HL
000E6D 4E6D 7E               7      LD  A,(HL)
000E6E 4E6E E60F             7      AND 00FH
000E70 4E70 57               4      LD  D,A
000E71 4E71 E1              10      POP HL
000E72 4E72 C1              10      POP BC
000E73 4E73 C9              10      RET
       4E74                     GNC1:
000E74 4E74 7E               7      LD  A,(HL)
000E75 4E75 23               6      INC HL
000E76 4E76 56               7      LD  D,(HL)
000E77 4E77 0604             7      LD  B,4
       4E79                     GNC1L:
000E79 4E79 CB3A             8      SRL D
000E7B 4E7B 1F               4      RRA
000E7C 4E7C 10FB            13      DJNZ    GNC1L
                                
000E7E 4E7E 5F               4      LD  E,A
000E7F 4E7F E1              10      POP HL
000E80 4E80 C1              10      POP BC
000E81 4E81 A7               4      AND A
000E82 4E82 C9              10      RET
                                
       4E83                     CLUST:
000E83 4E83 EB               4      EX  DE,HL
       4E84                     CLUST_HL:
000E84 4E84 2B               6      DEC HL
000E85 4E85 2B               6      DEC HL
000E86 4E86 C5              11      PUSH    BC
000E87 4E87 3AC7F2          13      LD  A,(CLSZ_H)
000E8A 4E8A CDDD53          17      CALL    MUL_AHL
                                
000E8D 4E8D CD464F          17      CALL    GET_DIR_POS
000E90 4E90 4F               4      LD  C,A
000E91 4E91 0600             7      LD  B,0
000E93 4E93 09              11      ADD HL,BC
                                
000E94 4E94 ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
000E98 4E98 CB38             8      SRL B
000E9A 4E9A CB19             8      RR  C           ;/2
000E9C 4E9C CB38             8      SRL B
000E9E 4E9E CB19             8      RR  C           ;/4
000EA0 4EA0 CB38             8      SRL B
000EA2 4EA2 CB19             8      RR  C           ;/8
000EA4 4EA4 09              11      ADD HL,BC
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  A,L
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    JR  NC,CLUST2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
000EA5 4EA5 4D               4      LD  C,L     ;C=読み出し元
000EA6 4EA6 29              11      ADD HL,HL   ;64KB→32KB
000EA7 4EA7 29              11      ADD HL,HL   ;32KB→16KB
000EA8 4EA8 29              11      ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
000EA9 4EA9 CDAD53          17      CALL    GET_DISK_BANK_FDRV
000EAC 4EAC 84               4      ADD A,H
000EAD 4EAD 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000EB0 4EB0 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000EB3 4EB3 32C4F2          13      LD  (_BANK),A
000EB6 4EB6 69               4      LD  L,C     ;C=読み出し元
000EB7 4EB7 3E1F             7      LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
000EB9 4EB9 A5               4      AND L
                                #endif
       4EBA                     CLUST2:
000EBA 4EBA C660             7      ADD A,high BANK1_ADR
000EBC 4EBC 67               4      LD  H,A
000EBD 4EBD 2E00             7      LD  L,0
000EBF 4EBF EB               4      EX  DE,HL
000EC0 4EC0 C1              10      POP BC
000EC1 4EC1 C9              10      RET
                                
       4EC2                     ENDCL:
000EC2 4EC2 7A               4      LD  A,D ;END CLUSTER
000EC3 4EC3 FE0F             7      CP  00FH    ;FAT12の最大値
000EC5 4EC5 C0              11      RET NZ
000EC6 4EC6 7B               4      LD  A,E
000EC7 4EC7 FEF7             7      CP  0F7H
000EC9 4EC9 C9              10      RET
                                
       4ECA                     RB_READ:
000ECA 4ECA AF               4      XOR A   ;HLA = HL*128
000ECB 4ECB CB3C             8      SRL H
000ECD 4ECD CB1D             8      RR  L
000ECF 4ECF 1F               4      RRA
000ED0 4ED0 32CAF2          13      LD  (RR_LOW),A
000ED3 4ED3 22CBF2          16      LD  (RR_MID),HL
000ED6 4ED6 218000          10      LD  HL,128
                                
000ED9 4ED9 CDAB4A          17      CALL    ROM_READ
000EDC 4EDC C9              10      RET
                                
       4EDD                     GETSEQ:
000EDD 4EDD FD6E20          19      LD  L,(IY+32)
000EE0 4EE0 FD660C          19      LD  H,(IY+12)
                                
000EE3 4EE3 CB25             8      SLA L
                                
000EE5 4EE5 CB3C             8      SRL H
000EE7 4EE7 CB1D             8      RR  L
000EE9 4EE9 C9              10      RET
                                
       4EEA                     SETSEQ:
000EEA 4EEA F5              11      PUSH    AF
000EEB 4EEB 3ACAF2          13      LD  A,(RR_LOW)
000EEE 4EEE 2ACBF2          16      LD  HL,(RR_MID)
                                
000EF1 4EF1 CD084F          17      CALL    SSQ1
                                
000EF4 4EF4 29              11      ADD HL,HL
000EF5 4EF5 CB3D             8      SRL L
000EF7 4EF7 FD7520          19      LD  (IY+32),L
000EFA 4EFA FD740C          19      LD  (IY+12),H
000EFD 4EFD F1              10      POP AF
000EFE 4EFE C9              10      RET
                                
       4EFF                     GETSIZE:
000EFF 4EFF FD7E10          19      LD  A,(IY+16)
000F02 4F02 FD6E11          19      LD  L,(IY+17)
000F05 4F05 FD6612          19      LD  H,(IY+18)
       4F08                     SSQ1:
000F08 4F08 87               4      ADD A,A
000F09 4F09 ED6A            15      ADC HL,HL
000F0B 4F0B B7               4      OR  A
000F0C 4F0C C8              11      RET Z
000F0D 4F0D 23               6      INC HL
000F0E 4F0E C9              10      RET
                                
       4F0F                     SET_FCB:
000F0F 4F0F D5              11      PUSH    DE
000F10 4F10 FDE1            14      POP IY
000F12 4F12 FD7E1C          19      LD  A,(IY+28)
000F15 4F15 FEFF             7      CP  0FFH
000F17 4F17 200C            12      JR  NZ,POPAF_SCF_FF_RET
000F19 4F19 E5              11      PUSH    HL
000F1A 4F1A FD6E1A          19      LD  L,(IY+26)
000F1D 4F1D FD661B          19      LD  H,(IY+27)
000F20 4F20 22CEF2          16      LD  (_CLPS),HL
000F23 4F23 E1              10      POP HL
000F24 4F24 C9              10      RET
                                
       4F25                     POPAF_SCF_FF_RET:
000F25 4F25 F1              10      POP AF
000F26 4F26 37               4      SCF
000F27 4F27 9F               4      SBC A,A
000F28 4F28 C9              10      RET
                                
       4F29                     GET_DIR_DAT:
000F29 4F29 2AF6F2          16      LD  HL,(_CDX)
000F2C 4F2C 7C               4      LD  A,H
000F2D 4F2D B5               4      OR  L
000F2E 4F2E 2035            12      JR  NZ,GET_SUBDIR
000F30 4F30 CD464F          17      CALL    GET_DIR_POS
000F33 4F33 C660             7      ADD A,high BANK1_ADR
000F35 4F35 2E00             7      LD  L,0
000F37 4F37 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
000F38 4F38 CD104D          17      CALL    CHECK_DIR_PAGE
                                #endif
000F3B 4F3B 3AC5F2          13      LD  A,(_BANK1)
000F3E 4F3E 32EFF2          13      LD  (_DIR_BANK),A
                                
000F41 4F41 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000F44 4F44 4F               4      LD  C,A
000F45 4F45 C9              10      RET
                                
       4F46                     GET_DIR_POS:                ;ルートディレクトリ
000F46 4F46 CDAD53          17      CALL    GET_DISK_BANK_FDRV
000F49 4F49 32C5F2          13      LD  (_BANK1),A
000F4C 4F4C 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000F4F 4F4F 47               4      LD  B,A
000F50 4F50 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000F53 4F53 4F               4      LD  C,A
000F54 4F54 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4F57                     GET_DIR_POS1:
000F57 4F57 81               4      ADD A,C
000F58 4F58 10FD            13      DJNZ    GET_DIR_POS1
                                
000F5A 4F5A ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
000F5E 4F5E 37               4      SCF     ;無限ループ回避
       4F5F                     L_MDP:
000F5F 4F5F CB18             8      RR  B   ;->CF
000F61 4F61 D8              11      RET C
000F62 4F62 87               4      ADD A,A
000F63 4F63 18FA            12      JR  L_MDP
                                
       4F65                     GET_SUBDIR:             ;サブディレクトリ
000F65 4F65 CD844E          17      CALL    CLUST_HL
000F68 4F68 EB               4      EX  DE,HL
000F69 4F69 3AC4F2          13      LD  A,(_BANK)
000F6C 4F6C 32EFF2          13      LD  (_DIR_BANK),A
000F6F 4F6F 3AC7F2          13      LD  A,(CLSZ_H)
000F72 4F72 87               4      ADD A,A     ;*2
000F73 4F73 87               4      ADD A,A     ;*4
000F74 4F74 87               4      ADD A,A     ;*8
000F75 4F75 4F               4      LD  C,A
000F76 4F76 C9              10      RET
                                
       4F77                     STATEMENT:
000F77 4F77 11CA51          10      LD  DE,STR_CHDIR
000F7A 4F7A CDB051          17      CALL    CPPROCNM
000F7D 4F7D 2812            12      JR  Z,_CHDIR
000F7F 4F7F 11D051          10      LD  DE,STR_CHDRV
000F82 4F82 CDB051          17      CALL    CPPROCNM
000F85 4F85 281C            12      JR  Z,_CHDRV
000F87 4F87 11D651          10      LD  DE,STR_RAMDISK
000F8A 4F8A CDB051          17      CALL    CPPROCNM
000F8D 4F8D 2829            12      JR  Z,_RAMDISK
000F8F 4F8F 37               4      SCF
000F90 4F90 C9              10      RET
       4F91                     _CHDIR:
000F91 4F91 7E               7      LD  A,(HL)
000F92 4F92 FE28             7      CP  '('
000F94 4F94 37               4      SCF
000F95 4F95 C0              11      RET NZ
000F96 4F96 CD5948          17      CALL    INIT_PARAM
000F99 4F99 CD4C4B          17      CALL    FILE_B
000F9C 4F9C CDCC4F          17      CALL    ROM_CD
000F9F 4F9F D0              11      RET NC
000FA0 4FA0 C30047          10      JP  ERROR_FILE_NOT_FOUND
                                
       4FA3                     _CHDRV:
000FA3 4FA3 7E               7      LD  A,(HL)
000FA4 4FA4 FE28             7      CP  '('
000FA6 4FA6 37               4      SCF
000FA7 4FA7 C0              11      RET NZ
000FA8 4FA8 CD5948          17      CALL    INIT_PARAM
000FAB 4FAB E5              11      PUSH    HL
000FAC 4FAC CD4C4B          17      CALL    FILE_B
000FAF 4FAF E1              10      POP HL
000FB0 4FB0 23               6      INC HL
000FB1 4FB1 3AF8F2          13      LD  A,(FDRV)
000FB4 4FB4 3D               4      DEC A
000FB5 4FB5 C38356          10      JP  _SYS0EX1
                                
       4FB8                     _RAMDISK:
000FB8 4FB8 7E               7      LD  A,(HL)
000FB9 4FB9 FE28             7      CP  '('
000FBB 4FBB 37               4      SCF
000FBC 4FBC C0              11      RET NZ
000FBD 4FBD 23               6      INC HL
000FBE 4FBE DD212F54        14      LD  IX,FRMQNT
000FC2 4FC2 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000FC6 4FC6 CD1C00          17      CALL    _CALSLT
                                ;   LD  A,(HOKVLD)  ;bit0: 拡張 BIOSの存在
                                ;   CPL
                                ;   AND 1
                                ;   LD  A,D
                                ;   OR  E
                                ;   JP  NZ,ERROR_INTERNAL_ERROR
                                ;   PUSH    HL      ;EXTBIOもDISK BIOSで初期化してそう
                                ;   XOR A
                                ;   LD  DE,0401H    ;D=マッパサポートルチン(4) E=機能番号(1)
                                ;   CALL    EXTBIO
                                ;   POP HL
                                ;   OR  A
                                ;   JP  Z,ERROR_INTERNAL_ERROR
000FC9 4FC9 23               6      INC HL
000FCA 4FCA AF               4      XOR A
000FCB 4FCB C9              10      RET
                                
       4FCC                     ROM_CD:
000FCC 4FCC 3AF9F2          13      LD  A,(FNAME)
000FCF 4FCF FE20             7      CP  020H
000FD1 4FD1 2822            12      JR  Z,CD1
000FD3 4FD3 CDCB4C          17      CALL    ROM_OPEN
000FD6 4FD6 D8              11      RET C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
000FD7 4FD7 FD2AEDF2        20      LD  IY,(DIRENT1)
000FDB 4FDB FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
000FDF 4FDF CA0047          10      JP  Z,ERROR_FILE_NOT_FOUND
000FE2 4FE2 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000FE5 4FE5 FD661B          19      LD  H,(IY+01BH)
                                #endif
       4FE8                     CD2:
000FE8 4FE8 22EBF2          16      LD  (_CD),HL
000FEB 4FEB 2AF4F2          16      LD  HL,(PARAM1)
       4FEE                     CD_SKIP:
000FEE 4FEE 7E               7      LD  A,(HL)
000FEF 4FEF 23               6      INC HL
000FF0 4FF0 FE21             7      CP  021H
000FF2 4FF2 38FA            12      JR  C,CD_SKIP
000FF4 4FF4 C9              10      RET
       4FF5                     CD1:
000FF5 4FF5 2AF6F2          16      LD  HL,(_CDX)
000FF8 4FF8 18EE            12      JR  CD2
                                
       4FFA                     GET_BASIC_FCB:
000FFA 4FFA D5              11      PUSH    DE
000FFB 4FFB 23               6      INC HL  ;+1
000FFC 4FFC 5E               7      LD  E,(HL)  ;FCB[1]
000FFD 4FFD 23               6      INC HL  ;+2
000FFE 4FFE 56               7      LD  D,(HL)  ;FCB[2]
000FFF 4FFF 23               6      INC HL  ;+3
001000 5000 ED53EDF2        20      LD  (DIRENT1),DE
                                            ;FCB[3] backup char
001004 5004 23               6      INC HL  ;+4
                                            ;FCB[4]
001005 5005 23               6      INC HL  ;+5
001006 5006 7E               7      LD  A,(HL)  ;FCB[5]
001007 5007 23               6      INC HL  ;+6
001008 5008 32EFF2          13      LD  (_DIR_BANK),A
00100B 500B 5E               7      LD  E,(HL)  ;FCB[6]
00100C 500C 23               6      INC HL  ;+7
00100D 500D 56               7      LD  D,(HL)  ;FCB[7]
00100E 500E 23               6      INC HL  ;+8
00100F 500F ED53CAF2        20      LD  (RR_LOW),DE
001013 5013 7E               7      LD  A,(HL)  ;FCB[8]
001014 5014 23               6      INC HL  ;+9
001015 5015 32CCF2          13      LD  (RR_HIGH),A
001018 5018 22D4F2          16      LD  (_DTA),HL   ;FCB[9]
00101B 501B D1              10      POP DE
00101C 501C C9              10      RET
                                
       501D                     SET_BASIC_FCB:
00101D 501D E5              11      PUSH    HL
00101E 501E 2A64F8          16      LD  HL,(PTRFIL)
001021 5021 23               6      INC HL  ;+1
001022 5022 D5              11      PUSH    DE
001023 5023 ED5BEDF2        20      LD  DE,(DIRENT1)
001027 5027 73               7      LD  (HL),E  ;FCB[1]
001028 5028 23               6      INC HL  ;+2
001029 5029 72               7      LD  (HL),D  ;FCB[2]
00102A 502A 23               6      INC HL  ;+3
00102B 502B 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
00102C 502C 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
00102D 502D 23               6      INC HL  ;+5
00102E 502E 3AEFF2          13      LD  A,(_DIR_BANK)
001031 5031 77               7      LD  (HL),A  ;FCB[5]
001032 5032 23               6      INC HL  ;+6
001033 5033 ED5BCAF2        20      LD  DE,(RR_LOW)
001037 5037 73               7      LD  (HL),E  ;FCB[6]
001038 5038 23               6      INC HL  ;+7
001039 5039 72               7      LD  (HL),D  ;FCB[7]
00103A 503A 23               6      INC HL  ;+8
00103B 503B 3ACCF2          13      LD  A,(RR_HIGH)
00103E 503E 77               7      LD  (HL),A  ;FCB[8]
00103F 503F D1              10      POP DE
001040 5040 E1              10      POP HL
001041 5041 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_18:BACKUP
                                ;in
                                ;   C : backup charactor
                                ;   HL: FBC pointer
                                ;out
       5042                     DEVICE_18_BACKUP:
001042 5042 D5              11      PUSH    DE
001043 5043 E5              11      PUSH    HL
001044 5044 110300          10      LD  DE,3
001047 5047 19              11      ADD HL,DE
001048 5048 71               7      LD  (HL),C
001049 5049 E1              10      POP HL
00104A 504A D1              10      POP DE
00104B 504B C9              10      RET
                                
       504C                     DEVICE_CHECK:
00104C 504C 3A8AFD          13      LD  A,(PROCNM+1)
00104F 504F B7               4      OR  A
001050 5050 C8              11      RET Z
001051 5051 11DE51          10      LD  DE,STR_ROM
001054 5054 CDB051          17      CALL    CPPROCNM
001057 5057 2802            12      JR  Z,DEVICE_OK
001059 5059 37               4      SCF
00105A 505A C9              10      RET
       505B                     DEVICE_OK:
00105B 505B AF               4      XOR A
00105C 505C C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファ
                                
       505D                     DEVICE_0_OPEN:
00105D 505D 7B               4      LD  A,E
00105E 505E FE02             7      CP  2       ;FOR OUTPUT
001060 5060 281B            12      JR  Z,OPEN2
001062 5062 D5              11      PUSH    DE
001063 5063 E5              11      push    hl
                                ;
001064 5064 3E01             7      LD  A,1     ;ドライブA
001066 5066 32F8F2          13      LD  (FDRV),A
001069 5069 2166F8          10      LD  HL,FILNAM
00106C 506C 11F9F2          10      LD  DE,FNAME
00106F 506F 010B00          10      LD  BC,8+3
001072 5072 CD0158          17      CALL    INIT_FILE1
001075 5075 CDCB4C          17      CALL    ROM_OPEN
001078 5078 DA0047          10      JP  C,ERROR_FILE_NOT_FOUND
00107B 507B E1              10      pop hl
00107C 507C D1              10      POP DE
       507D                     OPEN2:
00107D 507D 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
001080 5080 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
001081 5081 AF               4      XOR A
001082 5082 32F0F2          13      LD  (LEFTX),A
001085 5085 CD1D50          17      CALL    SET_BASIC_FCB
001088 5088 7B               4      ld  a,e
001089 5089 FE08             7      cp  8
00108B 508B 3F               4      ccf
00108C 508C C9              10      ret
                                
       508D                     DEVICE_2_CLOSE:
00108D 508D AF               4      XOR A
                                ;   LD  (HL),A
00108E 508E 6F               4      LD  L,A
00108F 508F 67               4      LD  H,A
001090 5090 2264F8          16      LD  (PTRFIL),HL
001093 5093 C9              10      RET
                                
       5094                     DEVICE_ENTRY:
001094 5094 FE08             7      CP  8
001096 5096 2826            12      JR  Z,DEVICE_8_SIN
001098 5098 3C               4      INC A
001099 5099 28B1            12      JR  Z,DEVICE_CHECK:
00109B 509B 3D               4      DEC A
00109C 509C 28BF            12      JR  Z,DEVICE_0_OPEN
00109E 509E FE0E             7      CP  14
0010A0 50A0 2860            12      JR  Z,DEVICE_14_EOF
0010A2 50A2 FE04             7      CP  4
0010A4 50A4 2834            12      JR  Z,DEVICE_4_RANDOM
0010A6 50A6 FE0A             7      CP  10
0010A8 50A8 2850            12      JR  Z,DEVICE_10_LOC
0010AA 50AA FE0C             7      CP  12
0010AC 50AC 2878            12      JR  Z,DEVICE_12_LOF
0010AE 50AE FE02             7      CP  2
0010B0 50B0 2890            12      JR  Z,DEVICE_18_BACKUP  
0010B2 50B2 FE02             7      CP  2
0010B4 50B4 28D7            12      JR  Z,DEVICE_2_CLOSE
0010B6 50B6 FE06             7      CP  6
0010B8 50B8 2802            12      JR  Z,DEVICE_6_SOUT
0010BA 50BA 37               4      SCF
0010BB 50BB C9              10      RET
                                
       50BC                     DEVICE_6_SOUT:
0010BC 50BC AF               4      XOR A
0010BD 50BD C9              10      RET
                                
       50BE                     DEVICE_8_SIN:
0010BE 50BE CDFA4F          17      CALL    GET_BASIC_FCB
0010C1 50C1 210100          10      LD  HL,1
0010C4 50C4 CDAB4A          17      CALL    ROM_READ
0010C7 50C7 7C               4      LD  A,H
0010C8 50C8 B5               4      OR  L
0010C9 50C9 280D            12      JR  Z,CCF_RET
0010CB 50CB 2AD4F2          16      LD  HL,(_DTA)
0010CE 50CE 7E               7      LD  A,(HL)
0010CF 50CF F5              11      PUSH    AF
0010D0 50D0 CD1D50          17      CALL    SET_BASIC_FCB
0010D3 50D3 F1              10      POP AF
0010D4 50D4 FE0A             7      CP  00AH
0010D6 50D6 C8              11      RET Z   ;ZF=separate
                                ;   CP  01AH
                                ;   JR  Z,SCF_RET
0010D7 50D7 37               4      SCF     ;
       50D8                     CCF_RET:
0010D8 50D8 3F               4      CCF     ;ZF=0 CF=0にしたい
0010D9 50D9 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_4:RANDOM
                                ;in
                                ;   A : 4
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
       50DA                     DEVICE_4_RANDOM:
0010DA 50DA D5              11      PUSH    DE
0010DB 50DB CDFA4F          17      CALL    GET_BASIC_FCB
0010DE 50DE DDE5            15      PUSH    IX
0010E0 50E0 DD218A2F        14      LD  IX,FRCINT
0010E4 50E4 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0010E8 50E8 CDB0F2          17      CALL    CAL_MP
0010EB 50EB DDE1            14      POP IX
0010ED 50ED 2AF8F7          16      LD  HL,(DACDAT)
0010F0 50F0 22CAF2          16      LD  (RR_LOW),HL
0010F3 50F3 AF               4      XOR A
0010F4 50F4 CD1D50          17      CALL    SET_BASIC_FCB
0010F7 50F7 D1              10      POP DE
0010F8 50F8 AF               4      XOR A
0010F9 50F9 C9              10      RET
                                
                                ;FUNC_10:LOC
                                ;in
                                ;   A : 10
                                ;out
                                ;   DAC    : value of received bytes
                                ;   VALTYP : DAC type
       50FA                     DEVICE_10_LOC:
0010FA 50FA CDFA4F          17      CALL    GET_BASIC_FCB
0010FD 50FD 2ACAF2          16      LD  HL,(RR_LOW)
001100 5100 183D            12      JR  RETURN_TYPE8_AHL
                                
                                ;--------------------------------------
                                ;FUNC_14:EOF
                                ;in
                                ;   A : 14
                                ;out
                                ;   DAC    : value of EOF value (EOF=-1)
                                ;   VALTYP : DAC type
       5102                     DEVICE_14_EOF:
001102 5102 CDFA4F          17      CALL    GET_BASIC_FCB
001105 5105 CD5D4D          17      CALL    RBX1
001108 5108 3810            12      JR  C,DEVICE_14_EOF1
00110A 510A 210100          10      LD  HL,1
00110D 510D CDAB4A          17      CALL    ROM_READ
001110 5110 2AD4F2          16      LD  HL,(_DTA)
001113 5113 7E               7      LD  A,(HL)
001114 5114 FE1A             7      CP  01AH
001116 5116 37               4      SCF
001117 5117 2801            12      JR  Z,DEVICE_14_EOF1
001119 5119 3F               4      CCF
       511A                     DEVICE_14_EOF1:
00111A 511A 9F               4      SBC A,A
00111B 511B 6F               4      LD  L,A
00111C 511C 67               4      LD  H,A
       511D                     return_type2_hl:
00111D 511D 22F8F7          16      ld  (DACDAT),hl
001120 5120 3E02             7      ld  a,2
001122 5122 3263F6          13      ld  (VALTYP),a
001125 5125 C9              10      ret
                                
                                ;--------------------------------------
                                ;FUNC_16:FPOS
                                ;in
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
                                ;   illegal function call
                                
                                ;--------------------------------------
                                ;FUNC_12:LOF
                                ;in
                                ;   A : 12
                                ;out
                                ;   DAC    : value of LOC+RSIQLN
                                ;   VALTYP : DAC type
       5126                     DEVICE_12_LOF:
001126 5126 CDFA4F          17      CALL    GET_BASIC_FCB
                                
001129 5129 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001CH
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    CALL    RDSLT_ROM
                                    EX  DE,HL       ;AHL=File size
                                    POP DE
                                #else
00112C 512C 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
00112F 512F 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
001132 5132 FD2AEDF2        20      LD  IY,(DIRENT1)
001136 5136 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
001139 5139 FD661D          19      LD  H,(IY+01DH)
00113C 513C FD7E1E          19      LD  A,(IY+01EH)
                                #endif
       513F                     RETURN_TYPE8_AHL:
00113F 513F B7               4      OR  A
001140 5140 2004            12      JR  NZ,RT8AHL1
001142 5142 CB7C             8      BIT 7,H
001144 5144 28D7            12      JR  Z,return_type2_hl
       5146                     RT8AHL1:
001146 5146 E5              11      PUSH    HL
001147 5147 29              11      ADD HL,HL
001148 5148 8F               4      ADC A,A
001149 5149 32F8F7          13      LD  (DACDAT),A
00114C 514C 3E00             7      LD  A,0
00114E 514E 8F               4      ADC A,A
00114F 514F 32F9F7          13      LD  (DACDAT+1),A
                                
001152 5152 3E02             7      LD  A,2
001154 5154 3263F6          13      LD  (VALTYP),A
001157 5157 DD213A30        14      LD  IX,FRCDBL
00115B 515B FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00115F 515F CDB0F2          17      CALL    CAL_MP
                                
001162 5162 21A851          10      LD  HL,DBL32768
001165 5165 1147F8          10      LD  DE,ARG
001168 5168 010800          10      LD  BC,8
00116B 516B EDB0                    LDIR
                                
00116D 516D DD21E627        14      LD  IX,DECMUL
001171 5171 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001175 5175 CDB0F2          17      CALL    CAL_MP
                                
001178 5178 21F6F7          10      LD  HL,DAC
00117B 517B 1147F8          10      LD  DE,ARG
00117E 517E 010800          10      LD  BC,8
001181 5181 EDB0                    LDIR
                                
001183 5183 E1              10      POP HL
001184 5184 22F8F7          16      LD  (DACDAT),HL
                                
001187 5187 3E02             7      LD  A,2
001189 5189 3263F6          13      LD  (VALTYP),A
00118C 518C DD213A30        14      LD  IX,FRCDBL
001190 5190 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001194 5194 CDB0F2          17      CALL    CAL_MP
                                
001197 5197 DD219A26        14      LD  IX,DECADD
00119B 519B FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00119F 519F CDB0F2          17      CALL    CAL_MP
                                
0011A2 51A2 3E08             7      LD  A,8
0011A4 51A4 3263F6          13      LD  (VALTYP),A
0011A7 51A7 C9              10      RET
                                
       51A8                     DBL32768:
0011A8 51A8 4532768000000000        DB  045H,032H,076H,080H,0,0,0,0
                                
       51B0                     CPPROCNM:
0011B0 51B0 E5              11      PUSH    HL
0011B1 51B1 2189FD          10      LD  HL,PROCNM
       51B4                     CPPROCNM1:
0011B4 51B4 1A               7      LD  A,(DE)
0011B5 51B5 13               6      INC DE
0011B6 51B6 BE               7      CP  (HL)
0011B7 51B7 23               6      INC HL
0011B8 51B8 2003            12      JR  NZ,CPPROCNM2
0011BA 51BA B7               4      OR  A
0011BB 51BB 20F7            12      JR  NZ,CPPROCNM1
       51BD                     CPPROCNM2:
0011BD 51BD E1              10      POP HL
0011BE 51BE C9              10      RET
                                
       51BF                     WILDCARD:
0011BF 51BF 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       51CA                     STR_CHDIR:
0011CA 51CA 434844495200            DB  "CHDIR",0
       51D0                     STR_CHDRV:
0011D0 51D0 434844525600            DB  "CHDRV",0
       51D6                     STR_RAMDISK:
0011D6 51D6 52414D4449534B00        DB  "RAMDISK",0
       51DE                     STR_ROM:
0011DE 51DE 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       51E2                     ERROR_WRITE_PROTECTED:
0011E2 51E2 3E00             7      LD  A,0     ;Write protected
0011E4 51E4 C9              10      RET
       51E5                     DISKIO:
0011E5 51E5 38FB            12      JR  C,ERROR_WRITE_PROTECTED
0011E7 51E7 48               4      LD  C,B
0011E8 51E8 CDB753          17      CALL    GET_DISK_BANK
       51EB                     SETMAP1:        
0011EB 51EB E5              11      PUSH    HL
       51EC                     DISKIO1:
0011EC 51EC C5              11      PUSH    BC      ;B=残りのセクタ数
0011ED 51ED D5              11      PUSH    DE      ;DE=セクタ番号
0011EE 51EE F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
0011EF 51EF EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
0011F0 51F0 F5              11      PUSH    AF
0011F1 51F1 3AC9F2          13      LD  A,(SECSZ_H)
0011F4 51F4 CDDD53          17      CALL    MUL_AHL
0011F7 51F7 F1              10      POP AF
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  A,L
                                    PUSH    BC
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    POP BC
                                    JR  NC,DISKIO2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
0011F8 51F8 4D               4      LD  C,L     ;C=読み出し元
0011F9 51F9 29              11      ADD HL,HL       ;64KB→32KB
0011FA 51FA 29              11      ADD HL,HL       ;32KB→16KB
0011FB 51FB 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
0011FC 51FC 84               4      ADD A,H
0011FD 51FD 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
001200 5200 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
001203 5203 32C4F2          13      LD  (_BANK),A
001206 5206 79               4      LD  A,C     ;C=読み出し元
001207 5207 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       5209                     DISKIO2:
001209 5209 C660             7      ADD A,high BANK1_ADR
00120B 520B 67               4      LD  H,A
00120C 520C ED4BC8F2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
001210 5210 69               4      LD  L,C     ;C=0
001211 5211 CD2145          17      CALL    ROM_LDIR
001214 5214 EB               4      EX  DE,HL
001215 5215 F1              10      POP AF
001216 5216 D1              10      POP DE
001217 5217 13               6      INC DE
001218 5218 C1              10      POP BC
001219 5219 10D1            13      DJNZ    DISKIO1
00121B 521B 41               4      LD  B,C
                                
00121C 521C E1              10      POP HL
00121D 521D AF               4      XOR A
                                
00121E 521E FB               4      EI
00121F 521F C9              10      RET
                                
       5220                     DSKCHG:
001220 5220 CD5952          17      CALL    IS_BPB
001223 5223 3824            12      JR  C,NOTREADY
001225 5225 3A23FB          13      LD  A,(DRVTBL+2)
001228 5228 B7               4      OR  A
001229 5229 201A            12      JR  NZ,DSKCHG1
00122B 522B 3A21FB          13      LD  A,(DRVTBL)
00122E 522E FE02             7      CP  2
001230 5230 2013            12      JR  NZ,DSKCHG1
001232 5232 CD5952          17      CALL    IS_BPB
001235 5235 300E            12      JR  NC,DSKCHG1
001237 5237 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
001239 5239 3221FB          13      LD  (DRVTBL),A
00123C 523C 3223FB          13      LD  (DRVTBL+2),A
00123F 523F 3A48F3          13      LD  A,(MASTERS)
001242 5242 3224FB          13      LD  (DRVTBL+3),A
       5245                     DSKCHG1:
001245 5245 AF               4      XOR A
001246 5246 0601             7      LD  B,1
001248 5248 C9              10      RET
       5249                     NOTREADY:
001249 5249 3E02             7      LD  A,2
00124B 524B 37               4      SCF
00124C 524C C9              10      RET
                                
       524D                     NO_BPB:
00124D 524D E1              10      POP HL
00124E 524E 23               6      INC HL
00124F 524F 11E353          10      LD  DE,DPB2DD
001252 5252 011200          10      LD  BC,DPB2DD_E-DPB2DD
001255 5255 EDB0                    LDIR
001257 5257 AF               4      XOR A
001258 5258 C9              10      RET
                                
       5259                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
001259 5259 CDB753          17      CALL    GET_DISK_BANK
                                
00125C 525C 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
00125F 525F FE01             7      CP  1
001261 5261 D8              11      RET C
                                
001262 5262 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
001265 5265 C6FF             7      ADD A,0FFH
001267 5267 D8              11      RET C
                                
001268 5268 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       526B                     IS_BPB1:
00126B 526B FE01             7      CP  1
00126D 526D C8              11      RET Z
00126E 526E FE02             7      CP  2
001270 5270 C8              11      RET Z
001271 5271 FE04             7      CP  4
001273 5273 C8              11      RET Z
001274 5274 37               4      SCF
001275 5275 C9              10      RET
                                
       5276                     GETDPB:
001276 5276 E5              11      PUSH    HL
001277 5277 CDB753          17      CALL    GET_DISK_BANK
                                
00127A 527A 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
00127D 527D B7               4      OR  A
00127E 527E 28CD            12      JR  Z,NO_BPB
001280 5280 DDE1            14      POP IX
001282 5282 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
001285 5285 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
001288 5288 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
00128B 528B 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
00128E 528E DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
001291 5291 87               4      ADD A,A
001292 5292 87               4      ADD A,A
001293 5293 87               4      ADD A,A
001294 5294 3D               4      DEC A
001295 5295 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
001298 5298 06FF             7      LD  B,-1
00129A 529A A7               4      AND A           ;無限ループ阻止
       529B                     GETDPB1:
00129B 529B 04               4      INC B
00129C 529C 1F               4      RRA
00129D 529D 38FC            12      JR  C,GETDPB1
00129F 529F DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
0012A2 52A2 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0012A5 52A5 3D               4      DEC A
0012A6 52A6 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
0012A9 52A9 A7               4      AND A           ;無限ループ阻止
0012AA 52AA 06FF             7      LD  B,-1
       52AC                     GETDPB2:
0012AC 52AC 04               4      INC B
0012AD 52AD 1F               4      RRA
0012AE 52AE 38FC            12      JR  C,GETDPB2
0012B0 52B0 04               4      INC B
0012B1 52B1 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
0012B4 52B4 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
0012B7 52B7 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
0012BA 52BA DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
0012BD 52BD 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
0012C0 52C0 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
0012C3 52C3 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
0012C6 52C6 DD770B          19      LD  (IX+11),A       ;MAXENT
                                
0012C9 52C9 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
0012CD 52CD DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
0012D0 52D0 DD460A          19      LD  B,(IX+10)       ;FATCNT
0012D3 52D3 210000          10      LD  HL,0
       52D6                     GETDPB3:
0012D6 52D6 19              11      ADD HL,DE
0012D7 52D7 10FD            13      DJNZ    GETDPB3
       52D9                     GETDPB4:
0012D9 52D9 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
0012DC 52DC DD5609          19      LD  D,(IX+9)        ;FIRFAT
0012DF 52DF 19              11      ADD HL,DE
0012E0 52E0 DD7511          19      LD  (IX+17),L       ;FIRDIR
0012E3 52E3 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
0012E6 52E6 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0012E9 52E9 87               4      ADD A,A
0012EA 52EA 87               4      ADD A,A
0012EB 52EB DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       52EE                     GETDPB5:
0012EE 52EE CB3B             8      SRL E
0012F0 52F0 1F               4      RRA
0012F1 52F1 30FB            12      JR  NC,GETDPB5
0012F3 52F3 1600             7      LD  D,0
0012F5 52F5 19              11      ADD HL,DE
0012F6 52F6 DD750C          19      LD  (IX+12),L       ;FIRREC
0012F9 52F9 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
0012FC 52FC 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
0012FF 52FF DD5E0C          19      LD  E,(IX+12)       ;FIRREC
001302 5302 DD560D          19      LD  D,(IX+13)       ;FIRREC
001305 5305 A7               4      AND A
001306 5306 ED52            15      SBC HL,DE
                                
001308 5308 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
00130B 530B 3C               4      INC A
00130C 530C 37               4      SCF             ;無限ループ阻止
       530D                     GETDPB6:
00130D 530D 1F               4      RRA
00130E 530E 3806            12      JR  C,GETDPB7
001310 5310 CB3C             8      SRL H
001312 5312 CB1D             8      RR  L
001314 5314 18F7            12      JR  GETDPB6
       5316                     GETDPB7:
001316 5316 23               6      INC HL
001317 5317 DD750E          19      LD  (IX+14),L       ;MAXCLUS
00131A 531A DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       531D                     GETDPBD1:
00131D 531D DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001320 5320 E6FC             7      AND 0FCH
001322 5322 C8              11      RET Z
                                
001323 5323 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
001327 5327 37               4      SCF
001328 5328 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
00132C 532C DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
00132F 532F DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
001333 5333 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
001337 5337 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
00133B 533B DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
00133F 533F DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
001343 5343 DDCB1126        23      SLA (IX+17)         ;FIRDIR
001347 5347 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
00134B 534B DD6E11          19      LD  L,(IX+17)       ;FIRDIR
00134E 534E DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
001351 5351 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001354 5354 87               4      ADD A,A
001355 5355 87               4      ADD A,A
001356 5356 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       5359                     GETDPBD5:
001359 5359 CB3B             8      SRL E
00135B 535B 1F               4      RRA
00135C 535C 30FB            12      JR  NC,GETDPBD5
00135E 535E 1600             7      LD  D,0
001360 5360 19              11      ADD HL,DE
001361 5361 DD750C          19      LD  (IX+12),L       ;FIRREC
001364 5364 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001367 5367 18B4            12      JR  GETDPBD1
                                
       5369                     CHOICE:
001369 5369 210000          10      LD  HL,0
00136C 536C C9              10      RET
                                
       536D                     DSKFMT:
00136D 536D AF               4      XOR A
00136E 536E 37               4      SCF
       536F                     DSKSTP:
00136F 536F C9              10      RET
                                
       5370                     BASENT:
001370 5370 2A74F6          16      LD  HL,(STKTOP)
001373 5373 3A40F3          13      LD  A,(REBOOT)
001376 5376 C6FF             7      ADD A,0FFH
001378 5378 3811            12      JR  C,REBOOT1
00137A 537A 21F553          10      LD  HL,AUTOEXEC
00137D 537D 11F8F2          10      LD  DE,FDRV
001380 5380 010C00          10      LD  BC,1+8+3
001383 5383 EDB0                    LDIR
001385 5385 CDCB4C          17      CALL    ROM_OPEN
001388 5388 D44A46          17      CALL    NC,ROM_LOAD1
       538B                     REBOOT1:
00138B 538B 210154          10      LD  HL,CMD_RUN
00138E 538E 111FF4          10      LD  DE,KBUF
001391 5391 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
001394 5394 D5              11      PUSH    DE
001395 5395 EDB0                    LDIR
001397 5397 3004            12      JR  NC,REBOOT2
001399 5399 AF               4      XOR A
00139A 539A 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       539D                     REBOOT2:
00139D 539D E1              10      POP HL
00139E 539E FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0013A2 53A2 DD210146        14      LD  IX,NEWSTT
0013A6 53A6 C31C00          10      JP  _CALSLT
                                
       53A9                     GETSLT:
0013A9 53A9 3A22FB          13      LD  A,(DRVTBL+1)
0013AC 53AC C9              10      RET
                                
       53AD                     GET_DISK_BANK_FDRV:
0013AD 53AD 3AF8F2          13      LD  A,(FDRV)
0013B0 53B0 D601             7      SUB 1
0013B2 53B2 3003            12      JR  NC,GET_DISK_BANK
0013B4 53B4 3AEAF2          13      LD  A,(_DVSW)
       53B7                     GET_DISK_BANK:
0013B7 53B7 FE07             7      CP  7       ;H:
0013B9 53B9 2801            12      JR  Z,SET_DISK_BANK_A
0013BB 53BB B7               4      OR  A       ;A=DRIVE
       53BC                     SET_DISK_BANK_A:
0013BC 53BC 3E01             7      LD  A,DISK_BANK
0013BE 53BE 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
0013C0 53C0 3AE9F2          13      LD  A,(B_DRIVE)
                                #endif
       53C3                     SET_DISK_BANK:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0013C3 53C3 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0013C6 53C6 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0013C9 53C9 F5              11      PUSH    AF
0013CA 53CA E5              11      PUSH    HL
0013CB 53CB 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
0013CE 53CE 22C8F2          16      LD  (SECSZ),HL
0013D1 53D1 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0013D4 53D4 CDDD53          17      CALL    MUL_AHL
0013D7 53D7 22C6F2          16      LD  (CLSZ),HL
0013DA 53DA E1              10      POP HL
0013DB 53DB F1              10      POP AF
0013DC 53DC C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       53DD                     MUL_AHL:
0013DD 53DD 37               4      SCF     ;無限ループ回避
       53DE                     MUL_AHL1:
0013DE 53DE 1F               4      RRA     ;->CF
0013DF 53DF D8              11      RET C
0013E0 53E0 29              11      ADD HL,HL
0013E1 53E1 18FB            12      JR  MUL_AHL1
                                
       53E3                     DPB2DD:
0013E3 53E3 F9                      DB  0F9H    ;MEDIA
0013E4 53E4 0002                    DW  00200H  ;SECSIZ
0013E6 53E6 0F                      DB  00FH    ;DIRMSK
0013E7 53E7 04                      DB  004H    ;DIRSHFT
0013E8 53E8 01                      DB  001H    ;CLUSMSK
0013E9 53E9 02                      DB  002H    ;CLUSSHFT
0013EA 53EA 0100                    DW  00001H  ;FIRFAT
0013EC 53EC 02                      DB  002H    ;FATCNT
0013ED 53ED 70                      DB  070H    ;MAXENT
0013EE 53EE 0E00                    DW  0000EH  ;FIRREC
0013F0 53F0 CA02                    DW  002CAH  ;MAXCLUS
0013F2 53F2 03                      DB  003H    ;FATSIZ
0013F3 53F3 0700                    DW  0007H   ;FIRDIR
       53F5                     DPB2DD_E:
                                
       53F5                     AUTOEXEC:
0013F5 53F5 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       5401                     CMD_RUN:
001401 5401 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
001407 5407 80F2                    DW  NEW_HIMEM
       5409                     CMD_CLEAR_E:
001409 5409 3A8A00                  DB  03AH,08AH,0         ;RUN
       540C                     CMD_RUN_E:
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       540C                     POP_HL_ERROR:
00140C 540C E1              10      POP     HL
       540D                     _ERROR:
00140D 540D 0600             7      LD  B,0
00140F 540F A7               4      AND A
001410 5410 C9              10      RET
                                
       5411                     ROM_BDOS:
001411 5411 E5              11      PUSH    HL
001412 5412 79               4      LD  A,C
001413 5413 87               4      ADD A,A
001414 5414 38F7            12      JR  C,_ERROR
001416 5416 6F               4      LD  L,A
001417 5417 265F             7      LD  H,high STABLE
001419 5419 7E               7      LD  A,(HL)
00141A 541A 2C               4      INC L
00141B 541B 66               7      LD  H,(HL)
00141C 541C 6F               4      LD  L,A
00141D 541D E3              19      EX  (SP),HL
00141E 541E 79               4      LD  A,C
00141F 541F C9              10      RET
                                
       5420                     _PRINT:
       5420                     PRINT:
001420 5420 7B               4      LD  A,E
001421 5421 1803            12      JR  MSG_A
                                
       5423                     _SYS01:     ;(BDOS)コンソール入力
001423 5423 CDA854          17      CALL    _SYS07
       5426                     MSG_A:
001426 5426 FE03             7      CP  3
001428 5428 2814            12      JR  Z,MSG_BR
       542A                     MSGA1:
00142A 542A F5              11      PUSH    AF
00142B 542B C5              11      PUSH    BC
00142C 542C D5              11      PUSH    DE
00142D 542D E5              11      PUSH    HL
00142E 542E DDE5            15      PUSH    IX
001430 5430 DD21A200        14      LD  IX,CHPUT
001434 5434 CD0B44          17      CALL    CALSLT_R
001437 5437 DDE1            14      POP IX
001439 5439 E1              10      POP HL
00143A 543A D1              10      POP DE
00143B 543B C1              10      POP BC
       543C                     MSGA2:
00143C 543C F1              10      POP AF
00143D 543D C9              10      RET
       543E                     MSG_BR:
00143E 543E F5              11      PUSH    AF
00143F 543F 3ADDF3          13      LD  A,(CSRX)
001442 5442 FE02             7      CP  2
001444 5444 38F6            12      JR  C,MSGA2
001446 5446 F1              10      POP AF
       5447                     MSG_CR:
001447 5447 F5              11      PUSH    AF
001448 5448 3E0D             7      LD  A,00DH
00144A 544A CD2A54          17      CALL    MSGA1
00144D 544D 3E0A             7      LD  A,00AH
00144F 544F CD2A54          17      CALL    MSGA1
001452 5452 F1              10      POP AF
001453 5453 C9              10      RET
                                
       5454                     _SYS02:     ;(BDOS)コンソール出力
001454 5454 CD6F54          17      CALL    BREAK
001457 5457 1805            12      JR  PRINTX
                                
       5459                     _SYS06:     ;(BDOS)コンソール直接入出力
001459 5459 7B               4      LD  A,E
00145A 545A 3C               4      INC A
00145B 545B CABC54          10      JP  Z,_INKEY
       545E                     PRINTX:
00145E 545E C32054          10      JP  _PRINT
                                
       5461                     _SYS08:     ;(BDOS)エコーなしコンソール入力
001461 5461 CDA854          17      CALL    _SYS07
001464 5464 FE03             7      CP  3
001466 5466 CC6F54          17      CALL    Z,_BREAK
001469 5469 FE13             7      CP  013H        ;CTRL+S
00146B 546B C0              11      RET NZ
       546C                     PAUSE:
00146C 546C CD8654          17      CALL    KEYBC
                                
       546F                     _BREAK:
       546F                     BREAK:
00146F 546F F5              11      PUSH    AF
001470 5470 C5              11      PUSH    BC
001471 5471 D5              11      PUSH    DE
001472 5472 E5              11      PUSH    HL
001473 5473 DDE5            15      PUSH    IX
001475 5475 DD21B700        14      LD  IX,BREAKX
001479 5479 CD0B44          17      CALL    CALSLT_R
00147C 547C DDE1            14      POP IX
00147E 547E E1              10      POP HL
00147F 547F D1              10      POP DE
001480 5480 C1              10      POP BC
001481 5481 DC6F54          17      CALL    C,_BREAK
001484 5484 F1              10      POP AF
001485 5485 C9              10      RET
       5486                     KEYBC:
001486 5486 F5              11      PUSH    AF
001487 5487 C5              11      PUSH    BC
001488 5488 D5              11      PUSH    DE
001489 5489 E5              11      PUSH    HL
00148A 548A DDE5            15      PUSH    IX
00148C 548C DD215601        14      LD  IX,KILBUF
001490 5490 CD0B44          17      CALL    CALSLT_R
001493 5493 DDE1            14      POP IX
001495 5495 E1              10      POP HL
001496 5496 D1              10      POP DE
001497 5497 C1              10      POP BC
001498 5498 F1              10      POP AF
001499 5499 C9              10      RET
                                
       549A                     _SYS09:     ;(BDOS)文字列出力
00149A 549A D5              11      PUSH    DE
       549B                     _SX09:
00149B 549B 1A               7      LD  A,(DE)
00149C 549C 13               6      INC DE
00149D 549D FE24             7      CP  '$'
00149F 549F 2805            12      JR  Z,POPDE_RET
0014A1 54A1 CD2654          17      CALL    MSG_A
0014A4 54A4 18F5            12      JR  _SX09
       54A6                     POPDE_RET:
0014A6 54A6 D1              10      POP DE
0014A7 54A7 C9              10      RET
                                
       54A8                     _SYS07:
       54A8                     FLGET:
0014A8 54A8 C5              11      PUSH    BC
0014A9 54A9 D5              11      PUSH    DE
0014AA 54AA E5              11      PUSH    HL
0014AB 54AB DDE5            15      PUSH    IX
0014AD 54AD DD219F00        14      LD  IX,CHGET
0014B1 54B1 CD0B44          17      CALL    CALSLT_R
0014B4 54B4 DDE1            14      POP IX
0014B6 54B6 E1              10      POP HL
0014B7 54B7 D1              10      POP DE
0014B8 54B8 C1              10      POP BC
0014B9 54B9 FE03             7      CP  3
0014BB 54BB C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       54BC                     _INKEY:
       54BC                     INKEY:
0014BC 54BC CD5655          17      CALL    CPM_CONST
0014BF 54BF C8              11      RET Z
0014C0 54C0 18E6            12      JR  FLGET
                                
       54C2                     _SYS0A:     ;(BDOS)文字列入力
0014C2 54C2 C5              11      PUSH    BC
0014C3 54C3 E5              11      PUSH    HL
0014C4 54C4 D5              11      PUSH    DE
0014C5 54C5 CDEE54          17      CALL    GETL
0014C8 54C8 111FF4          10      LD  DE,KBUF
0014CB 54CB E1              10      POP HL
0014CC 54CC E5              11      PUSH    HL
0014CD 54CD 0E00             7      LD  C,0
0014CF 54CF 3004            12      JR  NC,SAX0
0014D1 54D1 23               6      INC HL
0014D2 54D2 23               6      INC HL
0014D3 54D3 1808            12      JR  SAX4
       54D5                     SAX0:
0014D5 54D5 46               7      LD  B,(HL)
0014D6 54D6 23               6      INC HL
       54D7                     SAX1:
0014D7 54D7 23               6      INC HL
0014D8 54D8 1A               7      LD  A,(DE)
0014D9 54D9 13               6      INC DE
0014DA 54DA B7               4      OR  A
0014DB 54DB 2004            12      JR  NZ,SAX2
       54DD                     SAX4:
0014DD 54DD 360D            10      LD  (HL),00DH
0014DF 54DF 1804            12      JR  SAX3
       54E1                     SAX2:
0014E1 54E1 77               7      LD  (HL),A
0014E2 54E2 0C               4      INC C
0014E3 54E3 10F2            13      DJNZ    SAX1
       54E5                     SAX3:
0014E5 54E5 D1              10      POP DE
0014E6 54E6 79               4      LD  A,C
0014E7 54E7 13               6      INC DE
0014E8 54E8 12               7      LD  (DE),A
0014E9 54E9 1B               6      DEC DE
0014EA 54EA E1              10      POP HL
0014EB 54EB C1              10      POP BC
0014EC 54EC A7               4      AND A
0014ED 54ED C9              10      RET
       54EE                     GETL:
0014EE 54EE DDE5            15      PUSH    IX
0014F0 54F0 FDE5            15      PUSH    IY
                                
0014F2 54F2 2ADCF3          16      LD  HL,(CSRY)
0014F5 54F5 22CAFB          16      LD  (FSTPOS),HL
       54F8                     GETL1:
0014F8 54F8 CD6154          17      CALL    _SYS08
0014FB 54FB FE09             7      CP  9
0014FD 54FD 2008            12      JR  NZ,GETL1V
0014FF 54FF 211FF4          10      LD  HL,KBUF
001502 5502 CDA244          17      CALL    MSX
001505 5505 18F1            12      JR  GETL1
       5507                     GETL1V:
001507 5507 5F               4      LD  E,A
001508 5508 FE08             7      CP  8
00150A 550A CC0356          17      CALL    Z,CTRL02
00150D 550D FE20             7      CP  020H
00150F 550F D42F56          17      CALL    NC,INSERT
001512 5512 CD2A54          17      CALL    MSGA1
                                
001515 5515 7B               4      LD  A,E
001516 5516 FE0D             7      CP  00DH
001518 5518 20DE            12      JR  NZ,GETL1
                                
00151A 551A 111FF4          10      LD  DE,KBUF
00151D 551D 3AB0F3          13      LD  A,(LINLEN)
001520 5520 47               4      LD  B,A
001521 5521 CD1358          17      CALL    ZERO_MEMORY_DE
                                
001524 5524 2ACAFB          16      LD  HL,(FSTPOS)
001527 5527 3ADCF3          13      LD  A,(CSRY)
00152A 552A 6F               4      LD  L,A
00152B 552B E5              11      PUSH    HL
00152C 552C CD6056          17      CALL    LOC0
00152F 552F 4D               4      LD  C,L
001530 5530 44               4      LD  B,H
001531 5531 E1              10      POP HL
001532 5532 3AB0F3          13      LD  A,(LINLEN)
001535 5535 94               4      SUB H
001536 5536 3D               4      DEC A
001537 5537 5F               4      LD  E,A
001538 5538 211FF4          10      LD  HL,KBUF
       553B                     GETL2:
00153B 553B CDF355          17      CALL    _SCRN
00153E 553E 03               6      INC BC
00153F 553F 77               7      LD  (HL),A
001540 5540 23               6      INC HL
001541 5541 1D               4      DEC E
001542 5542 20F7            12      JR  NZ,GETL2
001544 5544 CD4754          17      CALL    MSG_CR
                                
001547 5547 FDE1            14      POP IY
001549 5549 DDE1            14      POP IX
       554B                     GETL3:
00154B 554B 2B               6      DEC HL
00154C 554C 7E               7      LD  A,(HL)
00154D 554D FE21             7      CP  021H
00154F 554F D0              11      RET NC
001550 5550 3600            10      LD  (HL),0
001552 5552 15               4      DEC D
001553 5553 20F6            12      JR  NZ,GETL3
001555 5555 C9              10      RET
                                
       5556                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       5556                     CONSTX:
       5556                     CPM_CONST:
001556 5556 C5              11      PUSH    BC
001557 5557 D5              11      PUSH    DE
001558 5558 E5              11      PUSH    HL
001559 5559 DDE5            15      PUSH    IX
00155B 555B DD219C00        14      LD  IX,CHSNS
00155F 555F CD0B44          17      CALL    CALSLT_R
001562 5562 DDE1            14      POP IX
001564 5564 E1              10      POP HL
001565 5565 D1              10      POP DE
001566 5566 C1              10      POP BC
001567 5567 C9              10      RET
                                
       5568                     _SYS2A:     ;(BDOS)日付の獲得
001568 5568 0E0B             7      LD  C,11        ;年/Year→HL
00156A 556A CDA955          17      CALL    RDCLK_BCD
00156D 556D 6F               4      LD  L,A
00156E 556E 2600             7      LD  H,0
001570 5570 3AF8FA          13      LD  A,(EXBRSA)
001573 5573 B7               4      OR  A
001574 5574 2804            12      JR  Z,SX2A1
001576 5576 11BC07          10      LD  DE,1980     ;1980年～2079年
001579 5579 19              11      ADD HL,DE
       557A                     SX2A1:
00157A 557A 0E09             7      LD  C,9     ;月/Month→D
00157C 557C CDA955          17      CALL    RDCLK_BCD
00157F 557F 57               4      LD  D,A
                                
001580 5580 0E07             7      LD  C,7     ;日/Day→E
001582 5582 CDA955          17      CALL    RDCLK_BCD
001585 5585 5F               4      LD  E,A
                                
001586 5586 0E06             7      LD  C,6     ;曜日/Week→A
       5588                     RDCLK:
001588 5588 DDE5            15      PUSH    IX
00158A 558A DD21F501        14      LD  IX,REDCLK
       558E                     WRCLK1:
00158E 558E 3AF8FA          13      LD  A,(EXBRSA)
001591 5591 B7               4      OR  A
001592 5592 280A            12      JR  Z,RDCLK1    ;MSX1
001594 5594 FDE5            15      PUSH    IY
001596 5596 FD67             9      LD  IYH,A
001598 5598 78               4      LD  A,B
001599 5599 CD1C00          17      CALL    _CALSLT
00159C 559C FDE1            14      POP IY
       559E                     RDCLK1:
00159E 559E DDE1            14      POP IX
0015A0 55A0 C9              10      RET
       55A1                     WRCLK:
0015A1 55A1 DDE5            15      PUSH    IX
0015A3 55A3 DD21F901        14      LD  IX,WRTCLK
0015A7 55A7 18E5            12      JR  WRCLK1
                                
       55A9                     RDCLK_BCD:
0015A9 55A9 CD8855          17      CALL    RDCLK       ;1の位
0015AC 55AC 47               4      LD  B,A
0015AD 55AD 0C               4      INC C
0015AE 55AE CD8855          17      CALL    RDCLK       ;10の位
0015B1 55B1 87               4      ADD A,A     ;*2
0015B2 55B2 4F               4      LD  C,A
0015B3 55B3 87               4      ADD A,A     ;*4
0015B4 55B4 87               4      ADD A,A     ;*8
0015B5 55B5 81               4      ADD A,C     ;*10(8+2)
0015B6 55B6 80               4      ADD A,B     ;1の位
0015B7 55B7 C9              10      RET
                                
       55B8                     _SYS2C:     ;(BDOS)時刻の獲得
0015B8 55B8 011501          10      LD  BC,00115H       ;12時間計/24時間計の設定を24時間計に
0015BB 55BB CDA155          17      CALL    WRCLK
0015BE 55BE 0E04             7      LD  C,4     ;H=時/Hour
0015C0 55C0 CDA955          17      CALL    RDCLK_BCD
0015C3 55C3 67               4      LD  H,A
0015C4 55C4 0E02             7      LD  C,2     ;L=分/Minute
0015C6 55C6 CDA955          17      CALL    RDCLK_BCD
0015C9 55C9 6F               4      LD  L,A
0015CA 55CA 0E00             7      LD  C,0     ;D=秒/Second
0015CC 55CC CDA955          17      CALL    RDCLK_BCD
0015CF 55CF 57               4      LD  D,A
0015D0 55D0 AF               4      XOR A       ;E=1/100秒
0015D1 55D1 5F               4      LD  E,A
0015D2 55D2 C9              10      RET
                                
       55D3                     POS:
0015D3 55D3 F5              11      PUSH    AF
0015D4 55D4 2ADCF3          16      LD  HL,(CSRY)
0015D7 55D7 7D               4      LD  A,L
0015D8 55D8 6C               4      LD  L,H
0015D9 55D9 67               4      LD  H,A
0015DA 55DA 2C               4      INC L
0015DB 55DB 24               4      INC H
0015DC 55DC F1              10      POP AF
0015DD 55DD C9              10      RET
                                
       55DE                     LOC:
0015DE 55DE F5              11      PUSH    AF
0015DF 55DF E5              11      PUSH    HL
0015E0 55E0 7D               4      LD  A,L
0015E1 55E1 6C               4      LD  L,H
0015E2 55E2 67               4      LD  H,A
0015E3 55E3 2D               4      DEC L
0015E4 55E4 25               4      DEC H
0015E5 55E5 DDE5            15      PUSH    IX
0015E7 55E7 DD21C600        14      LD  IX,POSIT
0015EB 55EB CD0B44          17      CALL    CALSLT_R
0015EE 55EE DDE1            14      POP IX
0015F0 55F0 E1              10      POP HL
0015F1 55F1 F1              10      POP AF
0015F2 55F2 C9              10      RET
                                
       55F3                     _SCRN:
       55F3                     SCRN:
0015F3 55F3 E5              11      PUSH    HL
0015F4 55F4 DDE5            15      PUSH    IX
                                
0015F6 55F6 69               4      LD  L,C
0015F7 55F7 60               4      LD  H,B
0015F8 55F8 DD214A00        14      LD  IX,RDVRM
0015FC 55FC CD0B44          17      CALL    CALSLT_R
                                
0015FF 55FF DDE1            14      POP IX
001601 5601 E1              10      POP HL
001602 5602 C9              10      RET
                                
       5603                     CTRL02:
001603 5603 F5              11      PUSH    AF
001604 5604 D5              11      PUSH    DE
001605 5605 2ADCF3          16      LD  HL,(CSRY)
001608 5608 3AB0F3          13      LD  A,(LINLEN)
00160B 560B 4F               4      LD  C,A
00160C 560C 94               4      SUB H   ;CSRX
00160D 560D C602             7      ADD A,2
00160F 560F 47               4      LD  B,A ;カーソルより右の文字数
001610 5610 61               4      LD  H,C ;LINLEN
001611 5611 C5              11      PUSH    BC
001612 5612 CD6056          17      CALL    LOC0
001615 5615 C1              10      POP BC
                                
001616 5616 1620             7      LD  D,020H
       5618                     C8X1:
001618 5618 DD214A00        14      LD  IX,RDVRM
00161C 561C CD0B44          17      CALL    CALSLT_R
00161F 561F 4F               4      LD  C,A
001620 5620 7A               4      LD  A,D
001621 5621 DD214D00        14      LD  IX,WRTVRM
001625 5625 CD0B44          17      CALL    CALSLT_R
001628 5628 2B               6      DEC HL
001629 5629 51               4      LD  D,C
00162A 562A 10EC            13      DJNZ    C8X1
00162C 562C D1              10      POP DE
00162D 562D F1              10      POP AF
00162E 562E C9              10      RET
                                
       562F                     INSERT:
00162F 562F F5              11      PUSH    AF
001630 5630 D5              11      PUSH    DE
001631 5631 2ADCF3          16      LD  HL,(CSRY)
001634 5634 3AB0F3          13      LD  A,(LINLEN)
001637 5637 4F               4      LD  C,A
001638 5638 94               4      SUB H   ;CSRX
001639 5639 3C               4      INC A
00163A 563A 47               4      LD  B,A ;カーソルより右の文字数
00163B 563B C5              11      PUSH    BC
00163C 563C CD6056          17      CALL    LOC0
00163F 563F C1              10      POP BC
                                
001640 5640 1620             7      LD  D,020H
       5642                     INS1:
001642 5642 DD214A00        14      LD  IX,RDVRM
001646 5646 CD0B44          17      CALL    CALSLT_R
001649 5649 4F               4      LD  C,A
00164A 564A 7A               4      LD  A,D
00164B 564B DD214D00        14      LD  IX,WRTVRM
00164F 564F CD0B44          17      CALL    CALSLT_R
001652 5652 23               6      INC HL
001653 5653 51               4      LD  D,C
001654 5654 10EC            13      DJNZ    INS1
001656 5656 D1              10      POP DE
001657 5657 F1              10      POP AF
001658 5658 C9              10      RET
                                
       5659                     CONOUT1:
001659 5659 59               4      LD  E,C
00165A 565A C32054          10      JP  _PRINT
                                
       565D                     GETVRAM:
00165D 565D 2ADCF3          16      LD  HL,(CSRY)
       5660                     LOC0:
001660 5660 2D               4      DEC L
001661 5661 25               4      DEC H
001662 5662 4C               4      LD  C,H ;CSRX-1
001663 5663 5D               4      LD  E,L ;CSRY-1
       5664                     LOC1:
001664 5664 3AB0F3          13      LD  A,(LINLEN)
001667 5667 67               4      LD  H,A
001668 5668 1600             7      LD  D,0
00166A 566A 6A               4      LD  L,D ;0
00166B 566B 0608             7      LD  B,8
       566D                     LOC2:
00166D 566D 29              11      ADD HL,HL
00166E 566E 3001            12      JR  NC,LOC3
001670 5670 19              11      ADD HL,DE
       5671                     LOC3:
001671 5671 10FA            13      DJNZ    LOC2
001673 5673 09              11      ADD HL,BC
001674 5674 C9              10      RET
                                
       5675                     _SYS0C:     ;(BDOS)バージョン番号の獲得
001675 5675 212200          10      LD  HL,00022H
001678 5678 AF               4      XOR A
001679 5679 7D               4      LD  A,L
00167A 567A C9              10      RET
                                
       567B                     _SYS0D:     ;(BDOS)ディスク・リセット
00167B 567B 218000          10      LD  HL,00080H
00167E 567E 22D4F2          16      LD  (_DTA),HL
001681 5681 C9              10      RET
                                
       5682                     _SYS0E:     ;(BDOS)カレントドライブの設定
001682 5682 7B               4      LD  A,E
       5683                     _SYS0EX1:
001683 5683 FE08             7      CP  8
001685 5685 3F               4      CCF
001686 5686 D8              11      RET C
001687 5687 32EAF2          13      LD  (_DVSW),A
00168A 568A C9              10      RET
                                
       568B                     _SYS0F:     ;(BDOS)ファイルのオープン
00168B 568B D5              11      PUSH    DE
00168C 568C FDE1            14      POP IY
00168E 568E CDFA57          17      CALL    INIT_FILE
001691 5691 CDCB4C          17      CALL    ROM_OPEN
001694 5694 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
001696 5696 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
00169A 569A FDE5            15      PUSH    IY
00169C 569C D1              10      POP DE
00169D 569D 13               6      INC DE
00169E 569E 010B00          10      LD  BC,11
0016A1 56A1 EDB0                    LDIR
                                ;               Attribute
0016A3 56A3 7E               7      LD  A,(HL)
0016A4 56A4 FD770D          19      LD  (IY+13),A
                                ;               TIME
0016A7 56A7 110B00          10      LD  DE,11
0016AA 56AA 19              11      ADD HL,DE
0016AB 56AB 7E               7      LD  A,(HL)
0016AC 56AC 23               6      INC HL
0016AD 56AD FD7716          19      LD  (IY+22),A
0016B0 56B0 7E               7      LD  A,(HL)
0016B1 56B1 23               6      INC HL
0016B2 56B2 FD7717          19      LD  (IY+23),A
                                ;               DATE
0016B5 56B5 7E               7      LD  A,(HL)
0016B6 56B6 23               6      INC HL
0016B7 56B7 FD7714          19      LD  (IY+20),A
0016BA 56BA 7E               7      LD  A,(HL)
0016BB 56BB 23               6      INC HL
0016BC 56BC FD7715          19      LD  (IY+21),A
                                ;               First cluster
0016BF 56BF 7E               7      LD  A,(HL)
0016C0 56C0 23               6      INC HL
0016C1 56C1 FD771A          19      LD  (IY+26),A
0016C4 56C4 7E               7      LD  A,(HL)
0016C5 56C5 23               6      INC HL
0016C6 56C6 FD771B          19      LD  (IY+27),A
                                ;               SIZE
0016C9 56C9 7E               7      LD  A,(HL)
0016CA 56CA 23               6      INC HL
0016CB 56CB FD7710          19      LD  (IY+16),A
0016CE 56CE 7E               7      LD  A,(HL)
0016CF 56CF 23               6      INC HL
0016D0 56D0 FD7711          19      LD  (IY+17),A
0016D3 56D3 7E               7      LD  A,(HL)
0016D4 56D4 23               6      INC HL
0016D5 56D5 FD7712          19      LD  (IY+18),A
0016D8 56D8 7E               7      LD  A,(HL)
0016D9 56D9 FD7713          19      LD  (IY+19),A
0016DC 56DC AF               4      XOR A
0016DD 56DD FD770C          19      LD  (IY+12),A
0016E0 56E0 C9              10      RET
                                
       56E1                     _SYS10:     ;(BDOS)ファイルのクローズ
0016E1 56E1 AF               4      XOR A
0016E2 56E2 C9              10      RET
                                
       56E3                     S11X1:
0016E3 56E3 FD7119          19      LD  (IY+25),C       ;RootEntCnt
0016E6 56E6 FD750E          19      LD  (IY+14),L
0016E9 56E9 FD740F          19      LD  (IY+15),H
       56EC                     SCF_FF_RET:
0016EC 56EC 37               4      SCF
0016ED 56ED 9F               4      SBC A,A
0016EE 56EE C9              10      RET
                                
       56EF                     _SYS11:     ;(BDOS)最初のファイルの検索
0016EF 56EF ED53D7F2        20      LD  (_FCB),DE
0016F3 56F3 D5              11      PUSH    DE
0016F4 56F4 FDE1            14      POP IY
0016F6 56F6 CDFA57          17      CALL    INIT_FILE
0016F9 56F9 CD294F          17      CALL    GET_DIR_DAT
       56FC                     S12X1:
0016FC 56FC CDE74C          17      CALL    FILESE
0016FF 56FF 30E2            12      JR  NC,S11X1
001701 5701 0D               4      DEC C
001702 5702 FD7119          19      LD  (IY+25),C       ;RootEntCnt
001705 5705 FDCB0D66        20      BIT 4,(IY+13)
001709 5709 2809            12      JR  Z,S12X2
00170B 570B E5              11      PUSH    HL
00170C 570C DDE1            14      POP IX
00170E 570E DDCB0E66        20      BIT 4,(IX+1+13)
001712 5712 28E8            12      JR  Z,S12X1
       5714                     S12X2:
001714 5714 012000          10      LD  BC,32
001717 5717 ED5BD4F2        20      LD  DE,(_DTA)
00171B 571B AF               4      XOR A
00171C 571C 12               7      LD  (DE),A      ;ドライブ番号
00171D 571D 13               6      INC DE
00171E 571E EDB0                    LDIR            ;ディレクトリエントリ
001720 5720 FD750E          19      LD  (IY+14),L
001723 5723 FD740F          19      LD  (IY+15),H
001726 5726 C9              10      RET
                                
       5727                     _SYS12:
001727 5727 FD2AD7F2        20      LD  IY,(_FCB)
00172B 572B FDE5            15      PUSH    IY
00172D 572D D1              10      POP DE
00172E 572E CDFA57          17      CALL    INIT_FILE
                                
001731 5731 FD6E0E          19      LD  L,(IY+14)
001734 5734 FD660F          19      LD  H,(IY+15)
001737 5737 FD4E19          19      LD  C,(IY+25)
00173A 573A 18C0            12      JR  S12X1
                                
       573C                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
00173C 573C CD0F4F          17      CALL    SET_FCB
00173F 573F CDDD4E          17      CALL    GETSEQ
001742 5742 CDCA4E          17      CALL    RB_READ
001745 5745 E5              11      PUSH    HL
001746 5746 CDEA4E          17      CALL    SETSEQ
001749 5749 E1              10      POP HL
       574A                     SREAD:
00174A 574A C601             7      ADD A,001H
00174C 574C D8              11      RET C
                                
00174D 574D 7D               4      LD  A,L
00174E 574E D601             7      SUB 001H
001750 5750 9F               4      SBC A,A
001751 5751 E603             7      AND 3
001753 5753 1F               4      RRA
001754 5754 C9              10      RET
                                
       5755                     _SYS18:     ;(BDOS)ログインベクトルの獲得
001755 5755 218300          10      LD  HL,00083H
001758 5758 AF               4      XOR A
001759 5759 C9              10      RET
                                
       575A                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
00175A 575A 3AEAF2          13      LD  A,(_DVSW)
00175D 575D A7               4      AND A
00175E 575E C9              10      RET
                                
       575F                     _SYS1A:     ;(BDOS)DTAの設定
00175F 575F ED53D4F2        20      LD  (_DTA),DE
001763 5763 AF               4      XOR A
001764 5764 C9              10      RET
                                
       5765                     _SYS1B:     ;(BDOS)ディスク情報の獲得
001765 5765 010002          10      LD  BC,512
001768 5768 11C302          10      LD  DE,707
00176B 576B 210000          10      LD  HL,0
00176E 576E DD21D9F2        14      LD  IX,_BUF
001772 5772 FD21D9F2        14      LD  IY,_BUF
001776 5776 FD3600F9        19      LD  (IY+0),0F9H
00177A 577A 3E02             7      LD  A,2
00177C 577C C9              10      RET
                                
       577D                     _SYS21:     ;(BDOS)ランダムな読み出し
00177D 577D CD0F4F          17      CALL    SET_FCB
                                
001780 5780 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001783 5783 FD6622          19      LD  H,(IY+34)
                                
001786 5786 CDCA4E          17      CALL    RB_READ
001789 5789 18BF            12      JR  SREAD
                                
       578B                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
00178B 578B CD8B56          17      CALL    _SYS0F
00178E 578E D8              11      RET C
                                
00178F 578F D5              11      PUSH    DE      ;EX DE,IY
001790 5790 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001792 5792 CDFF4E          17      CALL    GETSIZE
       5795                     _S24X1:
001795 5795 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001798 5798 FD7422          19      LD  (IY+34),H
00179B 579B FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
00179F 579F FDE3            23      EX  (SP),IY     ;
0017A1 57A1 D1              10      POP DE      ;
                                
0017A2 57A2 AF               4      XOR A
0017A3 57A3 C9              10      RET
                                
       57A4                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
0017A4 57A4 E5              11      PUSH    HL
0017A5 57A5 D5              11      PUSH    DE      ;EX DE,IY
0017A6 57A6 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0017A8 57A8 CDDD4E          17      CALL    GETSEQ
0017AB 57AB 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       57AD                     _SYS27:     ;(BDOS)ランダムブロック読み込み
0017AD 57AD CD0F4F          17      CALL    SET_FCB
0017B0 57B0 E5              11      PUSH    HL
0017B1 57B1 FD6E21          19      LD  L,(IY+33)
0017B4 57B4 FD6622          19      LD  H,(IY+34)
0017B7 57B7 22CAF2          16      LD  (RR_LOW),HL
0017BA 57BA FD6E23          19      LD  L,(IY+35)
0017BD 57BD FD6624          19      LD  H,(IY+36)
0017C0 57C0 22CCF2          16      LD  (RR_HIGH),HL
0017C3 57C3 E1              10      POP HL
0017C4 57C4 CDAB4A          17      CALL    ROM_READ
0017C7 57C7 ED5BCAF2        20      LD  DE,(RR_LOW)
0017CB 57CB FD7321          19      LD  (IY+33),E
0017CE 57CE FD7222          19      LD  (IY+34),D
0017D1 57D1 ED5BCCF2        20      LD  DE,(RR_HIGH)
0017D5 57D5 FD7323          19      LD  (IY+35),E
0017D8 57D8 FD7224          19      LD  (IY+36),D
0017DB 57DB 9F               4      SBC A,A
0017DC 57DC C9              10      RET
                                
       57DD                     _SYS2F:
0017DD 57DD 44               4      LD  B,H
0017DE 57DE 2AD4F2          16      LD  HL,(_DTA)
0017E1 57E1 C3E551          10      JP  DISKIO
                                
       57E4                     _SYS5A:
0017E4 57E4 0600             7      LD  B,0
0017E6 57E6 D5              11      PUSH    DE
0017E7 57E7 DDE1            14      POP IX
       57E9                     _SX5A1:
0017E9 57E9 1A               7      LD  A,(DE)
0017EA 57EA B7               4      OR  A
0017EB 57EB 2804            12      JR  Z,_SX5A2
0017ED 57ED 13               6      INC DE
0017EE 57EE 04               4      INC B
0017EF 57EF 18F8            12      JR  _SX5A1
                                
       57F1                     _SX5A2:
0017F1 57F1 78               4      LD  A,B
0017F2 57F2 CD764B          17      CALL    FILE_BDOS
0017F5 57F5 CDCC4F          17      CALL    ROM_CD
0017F8 57F8 9F               4      SBC A,A
0017F9 57F9 C9              10      RET
                                
       57FA                     INIT_FILE:
0017FA 57FA EB               4      EX  DE,HL
0017FB 57FB 11F8F2          10      LD  DE,FDRV
0017FE 57FE 010C00          10      LD  BC,1+8+3
       5801                     INIT_FILE1:
001801 5801 EDB0                    LDIR
001803 5803 CDAD53          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
001806 5806 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
001809 5809 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
00180C 580C 2AEBF2          16      LD  HL,(_CD)
00180F 580F 22F6F2          16      LD  (_CDX),HL           ;カレントディレクトリ
001812 5812 C9              10      RET
                                
       5813                     ZERO_MEMORY_DE:
001813 5813 AF               4      XOR A
       5814                     FILL_MEMORY_DE:
001814 5814 12               7      LD  (DE),A
001815 5815 13               6      INC DE
001816 5816 10FC            13      DJNZ    FILL_MEMORY_DE
001818 5818 C9              10      RET
                                
001819 5819                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 0D54235454540D54        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 0D540D545954A854        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 61549A54C2545655        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
001F18 5F18 75567B5682568B56        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 E156EF5627570D54        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 3C570D540D540D54        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 55575A575F576557        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 0D547D570D548B57        DW  _ERROR,_SYS21,_ERROR,_SYS23
001F48 5F48 A4570D540D54AD57        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 0D540D5468550D54        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 B8550D540D54DD57        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 0D540D54E4570D54        DW  _ERROR,_ERROR,_SYS5A,_ERROR
001FB8 5FB8 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 0D540D540D540D54        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
