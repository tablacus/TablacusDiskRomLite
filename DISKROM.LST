                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       42B2                     CRUNCH  EQU 042B2H
       4C64                     FRMEVL  EQU 04C64H
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
                                ;PTRFIL EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
                                ;FILNAM EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
                                ;RSTMP  EQU 0FB03H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FEDA                     H_STKE  EQU 0FEDAH
                                
       FF43                     H_GONE  EQU 0FF43H
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                
       F0E9                     ISC EQU 0F0E9H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
[EOF:DEF.ASM:UTF_8]
                                
                                ;USE_RAM_BLOAD_S    EQU 1   ;先頭のコメントを外すとBLOAD,SでRAMを使う
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C3124B          10      JP  DISKIO
000013 4013 C3494B          10      JP  DSKCHG
000016 4016 C39F4B          10      JP  GETDPB
000019 4019 C3924C          10      JP  CHOICE
00001C 401C C3964C          10      JP  DSKFMT
00001F 401F C3984C          10      JP  DSKSTP
000022 4022 C3994C          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C3964C          10      JP  DSKFMT
000029 4029 C3984C          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3A04C          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.1.4.1",0
            204449534B20524F    
            4D204C6974652076    
            302E312E342E3100    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 0180FF          10      LD  BC,-00080H
000109 4109 2A72F6          16      LD  HL,(MEMSIZ)
00010C 410C 09              11      ADD HL,BC
00010D 410D 2272F6          16      LD  (MEMSIZ),HL
000110 4110 2A74F6          16      LD  HL,(STKTOP)
000113 4113 09              11      ADD HL,BC
000114 4114 2274F6          16      LD  (STKTOP),HL
000117 4117 2180F0          10      LD  HL,0F080H
00011A 411A 1100F0          10      LD  DE,0F000H
00011D 411D 012000          10      LD  BC,00020H
000120 4120 EDB0                    LDIR
000122 4122 2180FF          10      LD  HL,-00080H
000125 4125 39              11      ADD HL,SP
000126 4126 2257F1          16      LD  (BASSTK),HL
000129 4129 ED7B57F1        20      LD  SP,(BASSTK)
                                
00012D 412D 3EFF             7      LD  A,0FFH
00012F 412F 3299FD          13      LD  (DEVICE),A
                                
000132 4132 3E01             7      LD  A,1
000134 4134 3221FB          13      LD  (DRVTBL),A
                                
000137 4137 AF               4      XOR A
000138 4138 3242F1          13      LD  (_DVSW),A
                                
00013B 413B 21ED42          10      LD  HL,AT_ISC
00013E 413E 11E9F0          10      LD  DE,ISC
000141 4141 017400          10      LD  BC,ISC_E-ISC
000144 4144 EDB0                    LDIR
                                    
000146 4146 3EC3             7      LD  A,0C3H      ;JP
000148 4148 3243FF          13      LD  (H_GONE),A
00014B 414B 327DF3          13      LD  (BDOS),A
00014E 414E 326BF3          13      LD  (RAMUSE),A
000151 4151 3268F3          13      LD  (ROMUSE),A
000154 4154 21E9F0          10      LD  HL,REPLACE_COMMAND
000157 4157 2244FF          16      LD  (H_GONE+1),HL
00015A 415A 2131F3          10      LD  HL,H_BDOS
00015D 415D 227EF3          16      LD  (BDOS+1),HL
000160 4160 2110F1          10      LD  HL,RAMUSE1
000163 4163 226CF3          16      LD  (RAMUSE+1),HL
000166 4166 210BF1          10      LD  HL,ROMUSE1
000169 4169 2269F3          16      LD  (ROMUSE+1),HL
                                
00016C 416C 3E                      DB  03EH
00016D 416D F7              12      RST 30H
00016E 416E 3271FE          13      LD  (H_BINS),A
000171 4171 3276FE          13      LD  (H_BINL),A
000174 4174 327BFE          13      LD  (H_FILE),A
000177 4177 3231F3          13      LD  (H_BDOS),A
00017A 417A 32DAFE          13      LD  (H_STKE),A
00017D 417D 32A7FF          13      LD  (H_PHYD),A
                                
000180 4180 CD3542          17      CALL    GTSL1_
000183 4183 32FCF0          13      LD  (ROM_SLT),A
000186 4186 3272FE          13      LD  (H_BINS+1),A
000189 4189 3277FE          13      LD  (H_BINL+1),A
00018C 418C 327CFE          13      LD  (H_FILE+1),A
00018F 418F 3232F3          13      LD  (H_BDOS+1),A
000192 4192 32DBFE          13      LD  (H_STKE+1),A
000195 4195 32A8FF          13      LD  (H_PHYD+1),A
000198 4198 3222FB          13      LD  (DRVTBL+1),A
00019B 419B 3248F3          13      LD  (MASTERS),A
                                
00019E 419E 211145          10      LD  HL,ROM_LOAD
0001A1 41A1 2273FE          16      LD  (H_BINS+2),HL
0001A4 41A4 212C46          10      LD  HL,ROM_RUN
0001A7 41A7 2278FE          16      LD  (H_BINL+2),HL
0001AA 41AA 213946          10      LD  HL,ROM_FILES
0001AD 41AD 227DFE          16      LD  (H_FILE+2),HL
0001B0 41B0 21E94C          10      LD  HL,ROM_BDOS
0001B3 41B3 2233F3          16      LD  (H_BDOS+2),HL
0001B6 41B6 218B43          10      LD  HL,ROM_STKE
0001B9 41B9 22DCFE          16      LD  (H_STKE+2),HL
0001BC 41BC 21124B          10      LD  HL,DISKIO
0001BF 41BF 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001C2 41C2 3E                      DB  03EH
0001C3 41C3 C9              10      RET
0001C4 41C4 327FFE          13      LD  (H_FILE+4),A
0001C7 41C7 3275FE          13      LD  (H_BINS+4),A
0001CA 41CA 327AFE          13      LD  (H_BINL+4),A
0001CD 41CD 3235F3          13      LD  (H_BDOS+4),A
0001D0 41D0 32DEFE          13      LD  (H_STKE+4),A
0001D3 41D3 32ABFF          13      LD  (H_PHYD+4),A
                                
                                #if exists USE_NORMAL_32K_ROM
                                #else
0001D6 41D6 AF               4      XOR A
0001D7 41D7 320068          13      LD  (BANK1_SEL),A
0001DA 41DA 3A0060          13      LD  A,(BANK1_ADR)
0001DD 41DD FE41             7      CP  'A'
0001DF 41DF 2043            12      JR  NZ,NOT_8K_BANK
0001E1 41E1 3E01             7      LD  A,DISK_BANK
0001E3 41E3 320068          13      LD  (BANK1_SEL),A
                                #endif
0001E6 41E6 CD3801          17      CALL    RSLREG      ;read primary slot #
0001E9 41E9 07               4      RLCA
0001EA 41EA 07               4      RLCA
0001EB 41EB F5              11      PUSH    AF
0001EC 41EC CD3A42          17      CALL    GTSL2_
0001EF 41EF 3244F3          13      LD  (RAMAD3),A
0001F2 41F2 F1              10      POP AF  
0001F3 41F3 CD3A42          17      CALL    GTSL2_
0001F6 41F6 3243F3          13      LD  (RAMAD2),A
       41F9                     RAMCHK2:
0001F9 41F9 3A44F3          13      LD  A,(RAMAD3)
0001FC 41FC 2640             7      LD  H,040H
0001FE 41FE CD5142          17      CALL    CHK_RAM
000201 4201 3242F3          13      LD  (RAMAD1),A
       4204                     RAMCHK1:
000204 4204 3A44F3          13      LD  A,(RAMAD3)
000207 4207 2600             7      LD  H,00H
000209 4209 CD5142          17      CALL    CHK_RAM
00020C 420C 3241F3          13      LD  (RAMAD0),A
       420F                     RAMCHK0:
00020F 420F 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
000212 4212 010F00          10      LD  BC,0000FH       ;切り上げ
000215 4215 09              11      ADD HL,BC
000216 4216 7D               4      LD  A,L
                                
000217 4217 0604             7      LD  B,4
       4219                     B_DRIVE1:
000219 4219 CB3C             8      SRL H
00021B 421B 1F               4      RRA
00021C 421C 10FB            13      DJNZ    B_DRIVE1
                                
00021E 421E C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000220 4220 3241F1          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
000223 4223 C9              10      RET
                                
       4224                     NOT_8K_BANK:
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K等)
000224 4224 21D943          10      LD  HL,MSG_ERROR_ROM_MODE
000227 4227 CD6443          17      CALL    MSX
00022A 422A FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00022E 422E DD219F00        14      LD  IX,CHGET
000232 4232 C31C00          10      JP  _CALSLT
                                
       4235                     GTSL1_:             ;自分のいるスロットを知る
000235 4235 CD3801          17      CALL    RSLREG      ;read primary slot #
000238 4238 0F               4      RRCA
000239 4239 0F               4      RRCA
       423A                     GTSL2_:
00023A 423A E603             7      AND 3       ;[A]=000000PP
00023C 423C 5F               4      LD  E,A     ;[E]=000000PP
00023D 423D 21C1FC          10      LD  HL,EXPTBL
000240 4240 85               4      ADD A,L     ;桁上りは無い
000241 4241 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000242 4242 7B               4      LD  A,E     ;[A]=000000PP
000243 4243 CB7E            13      BIT 7,(HL)
000245 4245 C8              11      RET Z
000246 4246 7D               4      LD  A,L     ;point to SLTTBL entry
000247 4247 C604             7      ADD A,4     ;桁上りは無い
000249 4249 6F               4      LD  L,A
00024A 424A 7E               7      LD  A,(HL)      ;get currently expansion slot register
00024B 424B E60C             7      AND 00CH        ;[A] = 0000SS00
00024D 424D B3               4      OR  E       ;[A] = 0000SSPP
00024E 424E F680             7      OR  080H        ;[A] = 1000SSPP
000250 4250 C9              10      RET
       4251                     GTSL1_E:
                                
       4251                     CHK_RAM:
000251 4251 E5              11      PUSH    HL
000252 4252 CDA642          17      CALL    CHK_RAM0
000255 4255 E1              10      POP HL
000256 4256 C8              11      RET Z
000257 4257 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
00025A 425A E680             7      AND 080H
00025C 425C CD7D42          17      CALL    CHK_RAM_SLT
00025F 425F C8              11      RET Z
000260 4260 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000263 4263 E680             7      AND 080H
000265 4265 C601             7      ADD A,1
000267 4267 CD7D42          17      CALL    CHK_RAM_SLT
00026A 426A C8              11      RET Z
00026B 426B 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00026E 426E E680             7      AND 080H
000270 4270 C602             7      ADD A,2
000272 4272 CD7D42          17      CALL    CHK_RAM_SLT
000275 4275 C8              11      RET Z
000276 4276 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000279 4279 E680             7      AND 080H
00027B 427B C603             7      ADD A,3
       427D                     CHK_RAM_SLT:
00027D 427D E5              11      PUSH    HL
00027E 427E CDA642          17      CALL    CHK_RAM0        ;スロット#X or X-0
000281 4281 E1              10      POP HL
000282 4282 C8              11      RET Z
000283 4283 CB79             8      BIT 7,C
000285 4285 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000287 4287 79               4      LD  A,C
000288 4288 C604             7      ADD A,4         ;スロット#X-1
00028A 428A E5              11      PUSH    HL
00028B 428B CDA642          17      CALL    CHK_RAM0
00028E 428E E1              10      POP HL
00028F 428F C8              11      RET Z
000290 4290 79               4      LD  A,C
000291 4291 C604             7      ADD A,4         ;スロット#X-2
000293 4293 E5              11      PUSH    HL
000294 4294 CDA642          17      CALL    CHK_RAM0
000297 4297 E1              10      POP HL
000298 4298 C8              11      RET Z
000299 4299 79               4      LD  A,C
00029A 429A C604             7      ADD A,4         ;スロット#X-3
00029C 429C E5              11      PUSH    HL
00029D 429D CDA642          17      CALL    CHK_RAM0
0002A0 42A0 E1              10      POP HL
       42A1                     CHK_RAM_E:
0002A1 42A1 AF               4      XOR A
0002A2 42A2 3C               4      INC A           ;ZF=0にする
0002A3 42A3 3E00             7      LD  A,0
0002A5 42A5 C9              10      RET
                                
       42A6                     CHK_RAM0:
0002A6 42A6 4F               4      LD  C,A
0002A7 42A7 3AFCF0          13      LD  A,(ROM_SLT)
0002AA 42AA B9               4      CP  C
0002AB 42AB 28F4            12      JR  Z,CHK_RAM_E
0002AD 42AD 2E00             7      LD  L,0
       42AF                     CHK_RAM1:
0002AF 42AF 79               4      LD  A,C
0002B0 42B0 DD210C00        14      LD  IX,_RDSLT
0002B4 42B4 CDE142          17      CALL    CALSLT_R
0002B7 42B7 C6E5             7      ADD A,0E5H
0002B9 42B9 47               4      LD  B,A
0002BA 42BA 5F               4      LD  E,A
0002BB 42BB 79               4      LD  A,C
0002BC 42BC DD211400        14      LD  IX,_WRSLT
0002C0 42C0 CDE142          17      CALL    CALSLT_R
0002C3 42C3 79               4      LD  A,C
0002C4 42C4 DD210C00        14      LD  IX,_RDSLT
0002C8 42C8 CDE142          17      CALL    CALSLT_R
0002CB 42CB B8               4      CP  B
0002CC 42CC C0              11      RET NZ
0002CD 42CD D6E5             7      SUB 0E5H
0002CF 42CF 79               4      LD  A,C
0002D0 42D0 5F               4      LD  E,A
0002D1 42D1 DD211400        14      LD  IX,_WRSLT
0002D5 42D5 CDE142          17      CALL    CALSLT_R
0002D8 42D8 24               4      INC H
0002D9 42D9 7D               4      LD  A,L
0002DA 42DA C604             7      ADD A,4
0002DC 42DC 6F               4      LD  L,A
0002DD 42DD 20D0            12      JR  NZ,CHK_RAM1
0002DF 42DF 79               4      LD  A,C     ;ZF=1のハズ
0002E0 42E0 C9              10      RET
                                
       42E1                     CALSLT_R:
0002E1 42E1 C5              11      PUSH    BC
0002E2 42E2 E5              11      PUSH    HL
0002E3 42E3 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0002E7 42E7 CD1C00          17      CALL    _CALSLT
0002EA 42EA E1              10      POP HL
0002EB 42EB C1              10      POP BC
0002EC 42EC C9              10      RET
                                
       42ED                     AT_ISC:
0002ED F0E9                         ORG ISC,AT_ISC-RUN
       F0E9                     REPLACE_COMMAND:
0002ED F0E9 FEB7             7      CP  0B7H            ;FILES
0002EF F0EB CC7BFE          17      CALL    Z,H_FILE
0002F2 F0EE FEB5             7      CP  0B5H            ;LOAD
0002F4 F0F0 CA71FE          10      JP  Z,H_BINS
0002F7 F0F3 FE8A             7      CP  08AH            ;RUN
0002F9 F0F5 CA76FE          10      JP  Z,H_BINL
0002FC F0F8 FECF             7      CP  0CFH            ;BLOAD
0002FE F0FA C0              11      RET NZ
       F0FB                     FIX_BLOAD:
0002FF F0FB F7              12      RST 30H
       F0FC                     ROM_SLT:
000300 F0FC 00                      DB  0
000301 F0FD 6E45                    DW  ROM_BLOAD
000303 F0FF F5              11      PUSH    AF
000304 F100 E5              11      PUSH    HL
000305 F101 CD0AF1          17      CALL    BLOAD_RET
       F102                     SWC_BLOAD   EQU $-2
000308 F104 E1              10      POP HL
000309 F105 F1              10      POP AF
00030A F106 FECF             7      CP  0CFH            ;BLOAD
       F108                     SWC_BLOAD_M:
00030C F108 28DF            12      JR  Z,REPLACE_COMMAND
       F10A                     BLOAD_RET:
00030E F10A C9              10      RET
       F10B                     ROMUSE1:
00030F F10B 3AFCF0          13      LD  A,(ROM_SLT)
000312 F10E 1803            12      JR  ROMUSE2
       F110                     RAMUSE1:
000314 F110 3A42F3          13      LD  A,(RAMAD1)
       F113                     ROMUSE2:
000317 F113 DD212400        14      LD  IX,_ENASLT
00031B F117 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00031F F11B C31C00          10      JP  _CALSLT
                                
       F11E                     _RESULT:
000322 F11E 00                      DB  0
       F11F                     _BANK:
000323 F11F 00                      DB  0
       F120                     CLSZ:               ;クラスタサイズ
000324 F120 0004                    DW  1024
       F121                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F122                     SECSZ:              ;セクタサイズ
000326 F122 0002                    DW  512
       F123                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F124                     RR_LOW:
000328 F124 0000                    DW  0
       F125                     RR_MID  EQU $-1
       F126                     RR_HIGH:
00032A F126 0000                    DW  0
       F128                     _CLPS:
00032C F128 0000                    DW  0
       F12A                     _LEFT:
00032E F12A 0000                    DW  0
       F12C                     _DTPS:
000330 F12C 0000                    DW  0
       F12E                     _DTA:
000332 F12E 0000                    DW  0
                                #if exists USE_RAM_BLOAD_S
                                #else
       F130                     FLG_LDIR:
000334 F130 00                      DB  0
                                #endif
                                ;   BDOS
000335 F131 F7              12      RST 30H
000336 F132 00                      DB  0
000337 F133 E94C                    DW  ROM_BDOS
000339 F135 C9              10      RET 
       F136                     _FCB:
00033A F136 0000                    DW  0
       F138                     _BUF:
00033C F138 00                      DB  0
       F139                     _BUF_ST:
00033D F139 0000                    DW  0
       F13B                     _BUF_EN:
00033F F13B 0000                    DW  0
       F13D                     _BUF_EX:
000341 F13D 0000                    DW  0
                                
       F13F                     DTAX:
000343 F13F 0000                    DW  0
       F141                     B_DRIVE:
000345 F141 00                      DB  0
       F142                     _DVSW:
000346 F142 00                      DB  0
       F143                     FCBX:
000347 F143 0000                    DW  0
       F145                     LEFTX:
000349 F145 0000                    DW  0
       F147                     PARAM0:
00034B F147 0000                    DW  0
       F149                     PARAM1:
00034D F149 0000                    DW  0
       F14B                     FDRV:
00034F F14B 00                      DB  0
       F14C                     FNAME:
000350 F14C                         DS  8+3
                                
       F157                     BASSTK:
00035B F157 0000                    DW  0
       F159                     _HL:
00035D F159 0000                    DW  0
       F15B                     _SP:
00035F F15B 0000                    DW  0
                                
       F15D                     ISC_E:
000361 4361                         ORG $$+RUN          ;$DEPHASE
                                
       4361                     MSX1:
000361 4361 CD024D          17      CALL    MSGA1
       4364                     MSX:
000364 4364 7E               7      LD  A,(HL)
000365 4365 23               6      INC HL
000366 4366 B7               4      OR  A
000367 4367 20F8            12      JR  NZ,MSX1
000369 4369 C9              10      RET
                                
       436A                     PRTHX:
00036A 436A F5              11      PUSH    AF
00036B 436B 07               4      RLCA
00036C 436C 07               4      RLCA
00036D 436D 07               4      RLCA
00036E 436E 07               4      RLCA
00036F 436F CD7343          17      CALL    PRTA2
000372 4372 F1              10      POP AF
       4373                     PRTA2:
000373 4373 CD7943          17      CALL    ASC
000376 4376 C3FE4C          10      JP  MSG_A
                                    
       4379                     ASC:
000379 4379 E60F             7      AND $0F
00037B 437B F630             7      OR  $30
00037D 437D FE3A             7      CP  $3A
00037F 437F D8              11      RET C
000380 4380 C607             7      ADD A,7
000382 4382 C9              10      RET
                                
       4383                     MSN:
000383 4383 7E               7      LD  A,(HL)
000384 4384 23               6      INC HL
000385 4385 CDFE4C          17      CALL    MSG_A
000388 4388 10F9            13      DJNZ    MSN
00038A 438A C9              10      RET
                                
       438B                     ROM_STKE:
00038B 438B 3E                      DB  03EH
00038C 438C C9              10      RET
00038D 438D 32DAFE          13      LD  (H_STKE),A
000390 4390 E5              11      PUSH    HL
000391 4391 D5              11      PUSH    DE
000392 4392 C5              11      PUSH    BC
000393 4393 181D            12      JR  BASAUTO
                                
000395 4395 AF               4      XOR A
000396 4396 5F               4      LD  E,A
000397 4397 57               4      LD  D,A
000398 4398 0601             7      LD  B,1
00039A 439A 2100C0          10      LD  HL,0C000H
00039D 439D CD124B          17      CALL    DISKIO
                                
0003A0 43A0 ED7357F1        20      LD  (BASSTK),SP
0003A4 43A4 116BF3          10      LD  DE,RAMUSE
0003A7 43A7 AF               4      XOR A
0003A8 43A8 CD1EC0          17      CALL    0C01EH
0003AB 43AB 116BF3          10      LD  DE,RAMUSE
0003AE 43AE 37               4      SCF
0003AF 43AF CD1EC0          17      CALL    0C01EH
       43B2                     BASAUTO:
0003B2 43B2 21F443          10      LD  HL,AUTOEXEC
0003B5 43B5 114BF1          10      LD  DE,FDRV
0003B8 43B8 010C00          10      LD  BC,1+8+3
0003BB 43BB EDB0                    LDIR
0003BD 43BD CD9748          17      CALL    ROM_OPEN
0003C0 43C0 3813            12      JR  C,RSTKEE
0003C2 43C2 210044          10      LD  HL,RUN_AUTOEXEC
0003C5 43C5 11F0FB          10      LD  DE,KEYBUF
0003C8 43C8 ED53FAF3        20      LD  (GETPNT),DE
0003CC 43CC 011300          10      LD  BC,RUN_AUTOEXEC_E-RUN_AUTOEXEC
0003CF 43CF EDB0                    LDIR
0003D1 43D1 ED53F8F3        20      LD  (PUTPNT),DE
       43D5                     RSTKEE:
0003D5 43D5 C1              10      POP BC
0003D6 43D6 D1              10      POP DE
0003D7 43D7 E1              10      POP HL
0003D8 43D8 C9              10      RET
                                
       43D9                     MSG_ERROR_ROM_MODE:
0003D9 43D9 41534349492D384B        DB  "ASCII-8K/Konami-8K only!",13,10
            2F4B6F6E616D692D    
            384B206F6E6C7921    
            0D0A                
       43F3                     NULL:
0003F3 43F3 00                      DB  0
                                
       43F4                     AUTOEXEC:
0003F4 43F4 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       4400                     RUN_AUTOEXEC:
000400 4400 52554E2022415554        DB  'RUN "AUTOEXEC.BAS"',00DH
            4F455845432E4241    
            53220D              
                                ;   DB  'LOAD "AUTOEXEC.BAS"',00DH  ;テスト用
       4413                     RUN_AUTOEXEC_E:
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       4413                     ROM_LDIR:
                                #if exists USE_RAM_BLOAD_S
                                #else
000413 4413 3A30F1          13      LD  A,(FLG_LDIR)
000416 4416 B7               4      OR  A
000417 4417 2008            12      JR  NZ,ROM_LDIRVM
                                #endif
000419 4419 CB7A             8      BIT 7,D
00041B 441B CA3344          10      JP  Z,ROM_LDIRSLT
                                
                                #if exists USE_NORMAL_32K_ROM
                                    LD  (_SP),SP
                                    LD  SP,DRVTBL
                                LDIR1:
                                    LD  A,B
                                    OR  C
                                    JR  Z,LDIRE
                                
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                LDIR2:
                                    LD  A,D
                                    CP  0C0H
                                    JR  NC,LDIR4
                                
                                    PUSH    BC
                                    PUSH    DE
                                    LD  DE,BUF
                                
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIR3
                                    LD  BC,00100H
                                LDIR3:
                                    PUSH    BC
                                    LDIR
                                    LD  (_HL),HL
                                
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                
                                    LD  HL,BUF
                                    POP BC
                                    POP DE
                                    LDIR
                                
                                    LD  HL,(_HL)
                                    POP BC
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIRE
                                    DEC B
                                    JR  LDIR1
                                LDIR4:
                                #endif
00041E 441E EDB0                    LDIR
                                
                                #if exists USE_NORMAL_32K_ROM
                                LDIRE:
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    LD  SP,(_SP)
                                #endif
000420 4420 C9              10      RET
                                
       4421                     ROM_LDIRVM:
                                #if exists USE_NORMAL_32K_ROM
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
000421 4421 C5              11      PUSH    BC
000422 4422 D5              11      PUSH    DE
000423 4423 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000427 4427 DD215C00        14      LD  IX,LDIRVM
00042B 442B CD1C00          17      CALL    _CALSLT
                                #if exists USE_NORMAL_32K_ROM
                                    LD  H,080H
                                    LD  A,(RAMAD2)
                                    CALL    _ENASLT
                                #endif
00042E 442E E1              10      POP HL
00042F 442F C1              10      POP BC
000430 4430 09              11      ADD HL,BC
000431 4431 EB               4      EX  DE,HL
000432 4432 C9              10      RET
                                
       4433                     ROM_LDIRSLT:
000433 4433 EB               4      EX  DE,HL
       4434                     RLDIRSLT1:
000434 4434 1A               7      LD  A,(DE)
000435 4435 13               6      INC DE
000436 4436 C5              11      PUSH    BC
000437 4437 D5              11      PUSH    DE
000438 4438 E5              11      PUSH    HL
000439 4439 5F               4      LD  E,A
00043A 443A 3A42F3          13      LD  A,(RAMAD1)
00043D 443D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000441 4441 DD211400        14      LD  IX,_WRSLT
000445 4445 CD1C00          17      CALL    _CALSLT
000448 4448 E1              10      POP HL
000449 4449 D1              10      POP DE
00044A 444A C1              10      POP BC
00044B 444B EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00044D 444D EA3444          10      JP  PE,RLDIRSLT1
000450 4450 EB               4      EX  DE,HL
000451 4451 C9              10      RET
                                
       4452                     END_OF_LINE:
000452 4452 215EF5          10      LD  HL,BUF
       4455                     EOL1:
000455 4455 7E               7      LD  A,(HL)
000456 4456 C8              11      RET Z
000457 4457 FE0D             7      CP  00DH
000459 4459 2807            12      JR  Z,EOLE
00045B 445B FE0A             7      CP  00AH
00045D 445D 2803            12      JR  Z,EOLE
00045F 445F 23               6      INC HL
000460 4460 18F3            12      JR  EOL1
       4462                     EOLE:
000462 4462 3600            10      LD  (HL),0
000464 4464 23               6      INC HL
000465 4465 7E               7      LD  A,(HL)
000466 4466 FE0A             7      CP  00AH
000468 4468 C0              11      RET NZ
000469 4469 23               6      INC HL
00046A 446A C9              10      RET
                                
       446B                     ROM_LOAD_ASCII:
00046B 446B 210000          10      LD  HL,0
00046E 446E 2239F1          16      LD  (_BUF_ST),HL    ;読み出し位置
000471 4471 2A76F6          16      LD  HL,(TXTTAB)
000474 4474 223BF1          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
000477 4477 215EF5          10      LD  HL,BUF
00047A 447A 222EF1          16      LD  (_DTA),HL
       447D                     RLOAD_A1:
00047D 447D 2A39F1          16      LD  HL,(_BUF_ST)
000480 4480 2224F1          16      LD  (RR_LOW),HL
000483 4483 210201          10      LD  HL,258
000486 4486 CDB746          17      CALL    ROM_READ
000489 4489 7C               4      LD  A,H
00048A 448A B5               4      OR  L
00048B 448B 2877            12      JR  Z,RLOAD_AEND
00048D 448D 015EF5          10      LD  BC,BUF
000490 4490 09              11      ADD HL,BC
000491 4491 3600            10      LD  (HL),0
000493 4493 CD5244          17      CALL    END_OF_LINE
000496 4496 015EF5          10      LD  BC,BUF
000499 4499 A7               4      AND A
00049A 449A ED42            15      SBC HL,BC
00049C 449C 2810            12      JR  Z,RLOAD_A2
00049E 449E 4D               4      LD  C,L
00049F 449F 44               4      LD  B,H
0004A0 44A0 ED5B39F1        20      LD  DE,(_BUF_ST)
0004A4 44A4 19              11      ADD HL,DE
0004A5 44A5 2239F1          16      LD  (_BUF_ST),HL
0004A8 44A8 3A5EF5          13      LD  A,(BUF)
0004AB 44AB B7               4      OR  A
0004AC 44AC 28CF            12      JR  Z,RLOAD_A1
       44AE                     RLOAD_A2:
0004AE 44AE 115EF5          10      LD  DE,BUF
0004B1 44B1 CD2E48          17      CALL    SPCUTEX
0004B4 44B4 1A               7      LD  A,(DE)
0004B5 44B5 B7               4      OR  A
0004B6 44B6 284C            12      JR  Z,RLOAD_AEND
0004B8 44B8 CD4048          17      CALL    GETNUM
0004BB 44BB 7C               4      LD  A,H
0004BC 44BC B5               4      OR  L
0004BD 44BD CA5B45          10      JP  Z,ERROR_DIRECT_IN_FILE
0004C0 44C0 DD2A3BF1        20      LD  IX,(_BUF_EN)
0004C4 44C4 DD7502          19      LD  (IX+2),L
0004C7 44C7 DD7403          19      LD  (IX+3),H
                                
0004CA 44CA CD2748          17      CALL    SPCUT
0004CD 44CD EB               4      EX  DE,HL
0004CE 44CE DDE5            15      PUSH    IX
0004D0 44D0 DD21B242        14      LD  IX,CRUNCH
0004D4 44D4 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0004D8 44D8 CD1C00          17      CALL    _CALSLT
0004DB 44DB DDE1            14      POP IX
0004DD 44DD EB               4      EX  DE,HL
0004DE 44DE 111FF4          10      LD  DE,KBUF
0004E1 44E1 37               4      SCF
0004E2 44E2 ED52            15      SBC HL,DE
0004E4 44E4 2875            12      JR  Z,ERROR_DIRECT_IN_FILE
0004E6 44E6 3873            12      JR  C,ERROR_DIRECT_IN_FILE
0004E8 44E8 4D               4      LD  C,L
0004E9 44E9 44               4      LD  B,H
0004EA 44EA 2A3BF1          16      LD  HL,(_BUF_EN)
0004ED 44ED 110400          10      LD  DE,4
0004F0 44F0 19              11      ADD HL,DE
0004F1 44F1 111FF4          10      LD  DE,KBUF
                                
0004F4 44F4 EB               4      EX  DE,HL
0004F5 44F5 EDB0                    LDIR
0004F7 44F7 EB               4      EX  DE,HL
                                
0004F8 44F8 DD7500          19      LD  (IX+0),L
0004FB 44FB DD7401          19      LD  (IX+1),H
0004FE 44FE 223BF1          16      LD  (_BUF_EN),HL
000501 4501 C37D44          10      JP  RLOAD_A1
                                
       4504                     RLOAD_AEND:
000504 4504 2A3BF1          16      LD  HL,(_BUF_EN)
000507 4507 AF               4      XOR A
000508 4508 77               7      LD  (HL),A
000509 4509 23               6      INC HL
00050A 450A 77               7      LD  (HL),A
00050B 450B 23               6      INC HL
00050C 450C 223BF1          16      LD  (_BUF_EN),HL
00050F 450F 1833            12      JR  RLOAD_END1
                                
       4511                     ROM_LOAD:
000511 4511 CD8C46          17      CALL    INIT_PARAM
000514 4514 CD5747          17      CALL    FILE_B
000517 4517 CD9748          17      CALL    ROM_OPEN
00051A 451A 3845            12      JR  C,ERROR_FILE_NOT_FOUND
                                
00051C 451C 2138F1          10      LD  HL,_BUF
00051F 451F 222EF1          16      LD  (_DTA),HL
000522 4522 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
000525 4525 CDB746          17      CALL    ROM_READ
000528 4528 3A38F1          13      LD  A,(_BUF)
00052B 452B 3C               4      INC A
00052C 452C C26B44          10      JP  NZ,ROM_LOAD_ASCII
00052F 452F 2A76F6          16      LD  HL,(TXTTAB)
000532 4532 222EF1          16      LD  (_DTA),HL
000535 4535 EB               4      EX  DE,HL
000536 4536 2100FF          10      LD  HL,-256
000539 4539 39              11      ADD HL,SP
00053A 453A ED52            15      SBC HL,DE
00053C 453C CDB746          17      CALL    ROM_READ
00053F 453F ED5B2EF1        20      LD  DE,(_DTA)
000543 4543 19              11      ADD HL,DE
       4544                     RLOAD_END1:
000544 4544 22C2F6          16      LD  (VARTAB),HL
000547 4547 22C4F6          16      LD  (ARYTAB),HL
00054A 454A 22C6F6          16      LD  (STREND),HL
                                
00054D 454D AF               4      XOR A
00054E 454E 213BF1          10      LD  HL,_BUF+3
000551 4551 77               7      LD  (HL),A
000552 4552 2B               6      DEC HL
000553 4553 77               7      LD  (HL),A
000554 4554 2B               6      DEC HL
000555 4555 77               7      LD  (HL),A
000556 4556 2B               6      DEC HL
000557 4557 3E8F             7      LD  A,08FH          ;REM
000559 4559 77               7      LD  (HL),A
00055A 455A C9              10      RET
                                
       455B                     ERROR_DIRECT_IN_FILE:
00055B 455B 1E39             7      LD  E,57            ;Direct statement in file
00055D 455D 01                      DB  1           ;LD BC,
       455E                     ERROR_FILE_NOT_OPEN:
00055E 455E 1E3B             7      LD  E,59            ;File not OPEN
000560 4560 01                      DB  1           ;LD BC,
       4561                     ERROR_FILE_NOT_FOUND:
000561 4561 1E35             7      LD  E,53            ;File not found
       4563                     ERROR:
000563 4563 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000567 4567 DD216F40        14      LD  IX,ERRHAND
00056B 456B C31C00          10      JP  _CALSLT
                                
       456E                     ROM_BLOAD:
00056E 456E CD8C46          17      CALL    INIT_PARAM
000571 4571 CD5747          17      CALL    FILE_B
000574 4574 CD9748          17      CALL    ROM_OPEN
000577 4577 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000579 4579 2138F1          10      LD  HL,_BUF
00057C 457C 222EF1          16      LD  (_DTA),HL
00057F 457F 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
000582 4582 CDB746          17      CALL    ROM_READ
000585 4585 3A38F1          13      LD  A,(_BUF)
000588 4588 FEFE             7      CP  0FEH
00058A 458A 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
00058C 458C 210AF1          10      LD  HL,BLOAD_RET
00058F 458F 2202F1          16      LD  (SWC_BLOAD),HL
                                
000592 4592 2A49F1          16      LD  HL,(PARAM1)
000595 4595 7E               7      LD  A,(HL)
000596 4596 FE2C             7      CP  ','
000598 4598 2048            12      JR  NZ,RBREAD_MEM
00059A 459A 23               6      INC HL
00059B 459B 7E               7      LD  A,(HL)
00059C 459C CD8148          17      CALL    CAP
00059F 459F 32BEFC          13      LD  (RUNBNF),A
       45A2                     RBOS1:
0005A2 45A2 7E               7      LD  A,(HL)
0005A3 45A3 23               6      INC HL
0005A4 45A4 B7               4      OR  A
0005A5 45A5 282F            12      JR  Z,RBREAD_OSE
0005A7 45A7 FE3A             7      CP  ':'
0005A9 45A9 282B            12      JR  Z,RBREAD_OSE
0005AB 45AB FE2C             7      CP  ','     ;次のパラメータを探す
0005AD 45AD 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
0005AF 45AF 2249F1          16      LD  (PARAM1),HL
0005B2 45B2 7E               7      LD  A,(HL)
0005B3 45B3 B7               4      OR  A
0005B4 45B4 2820            12      JR  Z,RBREAD_OSE
0005B6 45B6 DD21644C        14      LD  IX,FRMEVL
0005BA 45BA FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0005BE 45BE CD1C00          17      CALL    _CALSLT
0005C1 45C1 2249F1          16      LD  (PARAM1),HL
0005C4 45C4 3A63F6          13      LD  A,(VALTYP)
0005C7 45C7 FE02             7      CP  2
0005C9 45C9 200B            12      JR  NZ,RBREAD_OSE
0005CB 45CB 2A39F1          16      LD  HL,(_BUF_ST)
0005CE 45CE ED5BF8F7        20      LD  DE,(DACDAT)
0005D2 45D2 19              11      ADD HL,DE
0005D3 45D3 2239F1          16      LD  (_BUF_ST),HL
       45D6                     RBREAD_OSE:
0005D6 45D6 3ABEFC          13      LD  A,(RUNBNF)
0005D9 45D9 FE53             7      CP  'S'
                                #if exists USE_RAM_BLOAD_S
                                    JR  Z,ROM_BLOAD_SCREEN
                                #else
0005DB 45DB 2005            12      JR  NZ,RBREAD_MEM
0005DD 45DD 3E01             7      LD  A,1
0005DF 45DF 3230F1          13      LD  (FLG_LDIR),A
                                #endif
       45E2                     RBREAD_MEM:
0005E2 45E2 2A39F1          16      LD  HL,(_BUF_ST)
0005E5 45E5 22BFFC          16      LD  (SAVENT),HL
0005E8 45E8 222EF1          16      LD  (_DTA),HL
0005EB 45EB 21FFFF          10      LD  HL,0FFFFH
0005EE 45EE CDB746          17      CALL    ROM_READ
0005F1 45F1 3ABEFC          13      LD  A,(RUNBNF)
0005F4 45F4 FE52             7      CP  'R'
0005F6 45F6 2006            12      JR  NZ,RBREAD1
0005F8 45F8 2A3DF1          16      LD  HL,(_BUF_EX)
0005FB 45FB 2202F1          16      LD  (SWC_BLOAD),HL
       45FE                     RBREAD1:
       45FE                     ROM_NEXT:
0005FE 45FE 2A49F1          16      LD  HL,(PARAM1)
000601 4601 7E               7      LD  A,(HL)
000602 4602 2B               6      DEC HL
000603 4603 B7               4      OR  A
000604 4604 2805            12      JR  Z,RN1
000606 4606 FE3A             7      CP  ':'
000608 4608 2801            12      JR  Z,RN1
00060A 460A 23               6      INC HL
       460B                     RN1:
00060B 460B 5D               4      LD  E,L
00060C 460C 54               4      LD  D,H
                                
00060D 460D CD5748          17      CALL    SEARCH_END
000610 4610 B7               4      OR  A
000611 4611 2815            12      JR  Z,REM
                                                    ;マルチステートメントの処理
000613 4613 7E               7      LD  A,(HL)
                                
000614 4614 FEB5             7      CP  0B5H            ;LOAD
000616 4616 CA1145          10      JP  Z,ROM_LOAD
000619 4619 FE8A             7      CP  08AH            ;RUN
00061B 461B 280F            12      JR  Z,ROM_RUN
00061D 461D FEB7             7      CP  0B7H            ;FILES
00061F 461F 2818            12      JR  Z,ROM_FILES
000621 4621 3E28             7      LD  A,028H          ;JR Z,
000623 4623 3208F1          13      LD  (SWC_BLOAD_M),A
000626 4626 7E               7      LD  A,(HL)
000627 4627 C9              10      RET
                                
       4628                     REM:
000628 4628 EB               4      EX  DE,HL
000629 4629 3E8F             7      LD  A,08FH          ;REM
00062B 462B C9              10      RET
                                
                                #if exists USE_RAM_BLOAD_S
                                ROM_BLOAD_SCREEN:
                                    LD  HL,(STREND)
                                    LD  (_DTA),HL
                                    EX  DE,HL
                                    LD  HL,-512
                                    ADD HL,SP
                                    XOR A
                                    SBC HL,DE
                                    JR  NC,RBS0
                                    LD  HL,BUF
                                    LD  (_DTA),HL
                                    LD  L,A ;0
                                    LD  H,A ;0
                                RBS0:
                                    INC H
                                    LD  (_BUF_EN),HL
                                RBS1:
                                    LD  HL,(_BUF_EN)
                                    CALL    ROM_READ
                                    LD  A,H
                                    OR  L
                                    JR  Z,ROM_NEXT
                                
                                    PUSH    HL
                                    LD  C,L
                                    LD  B,H
                                    LD  HL,(_DTA)   ;転送元
                                    LD  DE,(_BUF_ST)    ;転送先
                                
                                    LD  IY,(EXPTBL-1)   ;メインROMスロット
                                    LD  IX,LDIRVM
                                    CALL    _CALSLT
                                
                                    LD  HL,(_BUF_ST)
                                    POP DE
                                    ADD HL,DE
                                    LD  (_BUF_ST),HL
                                    JR  RBS1
                                #endif
                                
       462C                     ROM_RUN:
00062C 462C 23               6      INC HL
00062D 462D 7E               7      LD  A,(HL)
00062E 462E 2B               6      DEC HL
00062F 462F B7               4      OR  A
000630 4630 2803            12      JR  Z,ROM_RUN1
000632 4632 CD1145          17      CALL    ROM_LOAD
       4635                     ROM_RUN1:
000635 4635 3E8A             7      LD  A,08AH          ;RUN
000637 4637 77               7      LD  (HL),A
000638 4638 C9              10      RET
                                
       4639                     ROM_FILES:
000639 4639 CD8C46          17      CALL    INIT_PARAM
00063C 463C CD5747          17      CALL    FILE_B
00063F 463F CDA44C          17      CALL    GET_DISK_BANK_FDRV
000642 4642 320068          13      LD  (BANK1_SEL),A
000645 4645 3A4CF1          13      LD  A,(FNAME)
000648 4648 FE21             7      CP  021H
00064A 464A 3005            12      JR  NC,RFILES0
00064C 464C 060B             7      LD  B,11
00064E 464E CDEB47          17      CALL    FILE10
       4651                     RFILES0:
000651 4651 CDD34A          17      CALL    GET_DIR_DAT
       4654                     RFILES1:
000654 4654 CDB348          17      CALL    FILESE
000657 4657 302E            12      JR  NC,RFILES_NOT_MATCH
       4659                     RFILES_DISP:
000659 4659 E5              11      PUSH    HL
00065A 465A 0608             7      LD  B,8
00065C 465C CD8343          17      CALL    MSN
00065F 465F 3E2E             7      LD  A,'.'
000661 4661 CDFE4C          17      CALL    MSG_A
000664 4664 0603             7      LD  B,3
000666 4666 CD8343          17      CALL    MSN
000669 4669 3ADDF3          13      LD  A,(CSRX)
00066C 466C 47               4      LD  B,A
00066D 466D 3AB0F3          13      LD  A,(LINLEN)
000670 4670 90               4      SUB B
000671 4671 FE0C             7      CP  12
000673 4673 3009            12      JR  NC,RFILES2
000675 4675 3E0D             7      LD  A,00DH      ;改行
000677 4677 CDFE4C          17      CALL    MSG_A
00067A 467A 3E0A             7      LD  A,00AH
00067C 467C 1802            12      JR  RFILES3
       467E                     RFILES2:
00067E 467E 3E20             7      LD  A,020H
       4680                     RFILES3:
000680 4680 CDFE4C          17      CALL    MSG_A
000683 4683 E1              10      POP HL
000684 4684 CDCF48          17      CALL    FNEXT
       4687                     RFILES_NOT_MATCH:
000687 4687 20CB            12      JR  NZ,RFILES1
000689 4689 C3FE45          10      JP  ROM_NEXT
                                
       468C                     INIT_PARAM:
00068C 468C 2247F1          16      LD  (PARAM0),HL
00068F 468F 2249F1          16      LD  (PARAM1),HL
000692 4692 EB               4      EX  DE,HL
000693 4693 AF               4      XOR A
                                #if exists USE_RAM_BLOAD_S
                                #else
000694 4694 3230F1          13      LD  (FLG_LDIR),A
                                #endif
000697 4697 32BEFC          13      LD  (RUNBNF),A
00069A 469A 3263F6          13      LD  (VALTYP),A
00069D 469D 13               6      INC DE
00069E 469E CD2748          17      CALL    SPCUT
0006A1 46A1 1A               7      LD  A,(DE)
0006A2 46A2 B7               4      OR  A
0006A3 46A3 C8              11      RET Z
0006A4 46A4 FE3A             7      CP  ':'
0006A6 46A6 C8              11      RET Z
0006A7 46A7 EB               4      EX  DE,HL
0006A8 46A8 DD21644C        14      LD  IX,FRMEVL
0006AC 46AC FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0006B0 46B0 CD1C00          17      CALL    _CALSLT
0006B3 46B3 2249F1          16      LD  (PARAM1),HL
0006B6 46B6 C9              10      RET
                                
       46B7                     ROM_READ:
0006B7 46B7 E5              11      PUSH    HL
0006B8 46B8 D5              11      PUSH    DE
0006B9 46B9 C5              11      PUSH    BC
0006BA 46BA FDE5            15      PUSH    IY
0006BC 46BC 2245F1          16      LD  (LEFTX),HL
0006BF 46BF 2A2EF1          16      LD  HL,(_DTA)
0006C2 46C2 223FF1          16      LD  (DTAX),HL
0006C5 46C5 2A45F1          16      LD  HL,(LEFTX)
                                
0006C8 46C8 CD0F49          17      CALL    RBX1
0006CB 46CB 3870            12      JR  C,RBRERR1
0006CD 46CD 79               4      LD  A,C
0006CE 46CE EB               4      EX  DE,HL
0006CF 46CF ED52            15      SBC HL,DE       ;CP 0HL,CDE
0006D1 46D1 19              11      ADD HL,DE
0006D2 46D2 DE00             7      SBC A,000H
0006D4 46D4 3801            12      JR  C,RBR1
0006D6 46D6 EB               4      EX  DE,HL
       46D7                     RBR1:
0006D7 46D7 9F               4      SBC A,A
0006D8 46D8 E601             7      AND 1
0006DA 46DA 321EF1          13      LD  (_RESULT),A
0006DD 46DD 7C               4      LD  A,H
0006DE 46DE B5               4      OR  L
0006DF 46DF CA3347          10      JP  Z,RBREND0
                                
0006E2 46E2 222AF1          16      LD  (_LEFT),HL  ;Read record byte
0006E5 46E5 2245F1          16      LD  (LEFTX),HL
                                
0006E8 46E8 CD3549          17      CALL    RBX2
0006EB 46EB 281A            12      JR  Z,RBRB
                                                ;先頭の端数
0006ED 46ED CD4849          17      CALL    RBXA
0006F0 46F0 DA4947          10      JP  C,RBRERR
0006F3 46F3 C5              11      PUSH    BC
0006F4 46F4 CD1344          17      CALL    ROM_LDIR
0006F7 46F7 ED533FF1        20      LD  (DTAX),DE
0006FB 46FB 2A45F1          16      LD  HL,(LEFTX)
0006FE 46FE D1              10      POP DE
0006FF 46FF A7               4      AND A
000700 4700 ED52            15      SBC HL,DE
000702 4702 2245F1          16      LD  (LEFTX),HL
000705 4705 2829            12      JR  Z,RBREND
                                
       4707                     RBRB:
000707 4707 CD8149          17      CALL    RBXB
00070A 470A 2818            12      JR  Z,RBRC
       470C                     RBRB1:
00070C 470C C5              11      PUSH    BC
00070D 470D D5              11      PUSH    DE
00070E 470E CD264A          17      CALL    CLUST
000711 4711 EB               4      EX  DE,HL
000712 4712 ED4B20F1        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000716 4716 CD1344          17      CALL    ROM_LDIR
000719 4719 EB               4      EX  DE,HL
00071A 471A D1              10      POP DE
00071B 471B C1              10      POP BC
00071C 471C CD034A          17      CALL    GNCL
00071F 471F DA4947          10      JP  C,RBRERR
000722 4722 10E8            13      DJNZ    RBRB1
       4724                     RBRC:
000724 4724 CD9949          17      CALL    RBXC
000727 4727 2807            12      JR  Z,RBREND
                                
000729 4729 CD264A          17      CALL    CLUST
00072C 472C EB               4      EX  DE,HL
00072D 472D CD1344          17      CALL    ROM_LDIR
       4730                     RBREND:
000730 4730 CDA549          17      CALL    RBXEND
       4733                     RBREND0:
000733 4733 FDE1            14      POP IY
000735 4735 C1              10      POP BC
000736 4736 D1              10      POP DE
000737 4737 F1              10      POP AF  ;(HL)
000738 4738 AF               4      XOR A
000739 4739 3A1EF1          13      LD  A,(_RESULT)
00073C 473C C9              10      RET
                                
       473D                     RBRERR1:
00073D 473D 3E01             7      LD  A,001H
       473F                     RBRERR2:
00073F 473F FDE1            14      POP IY
000741 4741 C1              10      POP BC
000742 4742 D1              10      POP DE
000743 4743 E1              10      POP HL
000744 4744 37               4      SCF
000745 4745 210000          10      LD  HL,0
000748 4748 C9              10      RET
       4749                     RBRERR:
000749 4749 3EFF             7      LD  A,0FFH
00074B 474B 18F2            12      JR  RBRERR2
                                
       474D                     FILE_DD:
00074D 474D 3E                      DB  03EH
00074E 474E C9              10      RET
00074F 474F 3208F1          13      LD  (SWC_BLOAD_M),A
000752 4752 2A47F1          16      LD  HL,(PARAM0)
000755 4755 7E               7      LD  A,(HL)
000756 4756 C9              10      RET
       4757                     FILE_B:
000757 4757 AF               4      XOR A
000758 4758 324BF1          13      LD  (FDRV),A
00075B 475B 1E00             7      LD  E,0
00075D 475D 3A63F6          13      LD  A,(VALTYP)
000760 4760 FE03             7      CP  3       ;string
000762 4762 2044            12      JR  NZ,FILED
                                
000764 4764 DD21D067        14      LD  IX,FRESTR
000768 4768 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00076C 476C CD1C00          17      CALL    _CALSLT
00076F 476F E5              11      PUSH    HL
000770 4770 DDE1            14      POP IX
                                
000772 4772 DD5E00          19      LD  E,(IX+0)
000775 4775 DD7E01          19      LD  A,(IX+1)
000778 4778 DD5602          19      LD  D,(IX+2)
00077B 477B DD62             9      LD  IXH,D
00077D 477D DD6F             9      LD  IXL,A
00077F 477F 7B               4      LD  A,E
000780 4780 FE04             7      CP  4
000782 4782 3808            12      JR  C,FILEB1
000784 4784 DD7E03          19      LD  A,(IX+3)
000787 4787 FE3A             7      CP  ':'
000789 4789 28C2            12      JR  Z,FILE_DD
00078B 478B 7B               4      LD  A,E
       478C                     FILEB1:
00078C 478C FE02             7      CP  2
00078E 478E 3818            12      JR  C,FILED
000790 4790 DD7E01          19      LD  A,(IX+1)
000793 4793 FE3A             7      CP  ':'
000795 4795 2011            12      JR  NZ,DEVI1
000797 4797 DD7E00          19      LD  A,(IX+0)        ;DRIVE
00079A 479A CD8148          17      CALL    CAP
00079D 479D D640             7      SUB '@'
00079F 479F DD23            10      INC IX
0007A1 47A1 DD23            10      INC IX
0007A3 47A3 1D               4      DEC E
0007A4 47A4 1D               4      DEC E
0007A5 47A5 324BF1          13      LD  (FDRV),A
       47A8                     DEVI1:
                                
       47A8                     FILED:
0007A8 47A8 CDEF47          17      CALL    FILEI
0007AB 47AB 214CF1          10      LD  HL,FNAME
                                
0007AE 47AE 0608             7      LD  B,8
       47B0                     FILE2:
0007B0 47B0 CDFC47          17      CALL    CCHKF
0007B3 47B3 C8              11      RET Z
0007B4 47B4 FE2A             7      CP  '*'
0007B6 47B6 282E            12      JR  Z,FILE9
0007B8 47B8 FE2E             7      CP  '.'
0007BA 47BA 280C            12      JR  Z,FILE4
0007BC 47BC 77               7      LD  (HL),A
0007BD 47BD 23               6      INC HL
0007BE 47BE 10F0            13      DJNZ    FILE2
                                
       47C0                     FILE3:
0007C0 47C0 CDFC47          17      CALL    CCHKF
0007C3 47C3 C8              11      RET Z
0007C4 47C4 FE2E             7      CP  '.'
0007C6 47C6 20F8            12      JR  NZ,FILE3
                                
       47C8                     FILE4:
0007C8 47C8 2154F1          10      LD  HL,FNAME+8
0007CB 47CB 0603             7      LD  B,3
                                
       47CD                     FILE4L:
0007CD 47CD CDFC47          17      CALL    CCHKF
0007D0 47D0 C8              11      RET Z
0007D1 47D1 FE2E             7      CP  '.'
0007D3 47D3 2008            12      JR  NZ,FILE12
0007D5 47D5 324CF1          13      LD  (FNAME),A   ;Parent directory(..)
0007D8 47D8 324DF1          13      LD  (FNAME+1),A
0007DB 47DB 3E20             7      LD  A,020H
       47DD                     FILE12:
0007DD 47DD FE2A             7      CP  '*'
0007DF 47DF 280A            12      JR  Z,FILE10
0007E1 47E1 77               7      LD  (HL),A
0007E2 47E2 23               6      INC HL
0007E3 47E3 10E8            13      DJNZ    FILE4L
0007E5 47E5 C9              10      RET
                                
       47E6                     FILE9:              ;名前の*処理、名前の残りを?で埋める
0007E6 47E6 CDEB47          17      CALL    FILE10
0007E9 47E9 18D5            12      JR  FILE3
                                
       47EB                     FILE10:
0007EB 47EB 3E3F             7      LD  A,'?'
0007ED 47ED 1808            12      JR  FILL_MEMORY
       47EF                     FILEI:              ;名前＋拡張子をスペースで初期化
0007EF 47EF 3E20             7      LD  A,020H
0007F1 47F1 01000B          10      LD  BC,11*256   ;C=0にしておく
0007F4 47F4 214CF1          10      LD  HL,FNAME
       47F7                     FILL_MEMORY:            ;HLからBバイトAで埋める
0007F7 47F7 77               7      LD  (HL),A
0007F8 47F8 23               6      INC HL
0007F9 47F9 10FC            13      DJNZ    FILL_MEMORY
0007FB 47FB C9              10      RET
                                
       47FC                     CCHKF:
0007FC 47FC 7B               4      LD  A,E
0007FD 47FD B7               4      OR  A
0007FE 47FE C8              11      RET Z
0007FF 47FF DD7E00          19      LD  A,(IX+0)
000802 4802 CD0948          17      CALL    CCHK2
000805 4805 C8              11      RET Z
000806 4806 C36C48          10      JP  FKAN
                                
       4809                     CCHK2:
000809 4809 0C               4      INC C
00080A 480A 0D               4      DEC C
00080B 480B C0              11      RET NZ
       480C                     CCHK3:              ;ZF=1 で使えない文字
00080C 480C FE2B             7      CP  '+'
00080E 480E C8              11      RET Z
00080F 480F FE2C             7      CP  ','
000811 4811 C8              11      RET Z
000812 4812 FE2F             7      CP  '/'
000814 4814 C8              11      RET Z
000815 4815 FE3A             7      CP  ':'
000817 4817 C8              11      RET Z
000818 4818 FE3B             7      CP  ';'
00081A 481A C8              11      RET Z
00081B 481B FE3D             7      CP  '='
00081D 481D C8              11      RET Z
00081E 481E FE5C             7      CP  05CH    ;\
000820 4820 C8              11      RET Z
000821 4821 FE1F             7      CP  01FH
000823 4823 D0              11      RET NC
000824 4824 BF               4      CP  A       ;Z=1
000825 4825 C9              10      RET
                                
       4826                     SS1:
000826 4826 13               6      INC DE
       4827                     SPCUT:              ;スペースをカット
000827 4827 1A               7      LD  A,(DE)
000828 4828 FE20             7      CP  020H
00082A 482A 28FA            12      JR  Z,SS1
00082C 482C C9              10      RET
                                
       482D                     SCREOF1:
00082D 482D 13               6      INC DE
       482E                     SPCUTEX:            ;スペース改行などをカット
00082E 482E 1A               7      LD  A,(DE)
00082F 482F FE20             7      CP  020H
000831 4831 28FA            12      JR  Z,SCREOF1
000833 4833 FE0D             7      CP  00DH
000835 4835 28F6            12      JR  Z,SCREOF1
000837 4837 FE0A             7      CP  00AH
000839 4839 28F2            12      JR  Z,SCREOF1
00083B 483B FE1A             7      CP  01AH
00083D 483D 28EE            12      JR  Z,SCREOF1
00083F 483F C9              10      RET
                                
       4840                     GETNUM:
000840 4840 210000          10      LD  HL,0
       4843                     GETNUM1:
000843 4843 1A               7      LD  A,(DE)
000844 4844 13               6      INC DE
000845 4845 D630             7      SUB '0'
000847 4847 D8              11      RET C
000848 4848 FE0A             7      CP  10
00084A 484A D0              11      RET NC
00084B 484B 4D               4      LD  C,L
00084C 484C 44               4      LD  B,H
00084D 484D 29              11      ADD HL,HL   ;*2
00084E 484E 29              11      ADD HL,HL   ;*4
00084F 484F 09              11      ADD HL,BC   ;*5
000850 4850 29              11      ADD HL,HL   ;*10
000851 4851 4F               4      LD  C,A
000852 4852 0600             7      LD  B,0
000854 4854 09              11      ADD HL,BC
000855 4855 18EC            12      JR  GETNUM1
                                
       4857                     SEARCH_END:
000857 4857 7E               7      LD  A,(HL)
       4858                     SEARCH_END1:
000858 4858 23               6      INC HL
000859 4859 B7               4      OR  A
00085A 485A C8              11      RET Z
00085B 485B FE3A             7      CP  ':'
00085D 485D 20F8            12      JR  NZ,SEARCH_END
00085F 485F 7E               7      LD  A,(HL)
000860 4860 FE3A             7      CP  ':'
000862 4862 28F4            12      JR  Z,SEARCH_END1
000864 4864 C9              10      RET
                                
       4865                     FKANC:
000865 4865 CB41             8      BIT 0,C
000867 4867 CC8A48          17      CALL    Z,CAP2
00086A 486A 1803            12      JR  FKANX
       486C                     FKAN:           ;漢字チェック
00086C 486C DD23            10      INC IX
00086E 486E 1D               4      DEC E
       486F                     FKANX:
00086F 486F CB41             8      BIT 0,C
000871 4871 CB81             8      RES 0,C
000873 4873 C0              11      RET NZ
000874 4874 FE80             7      CP  080H
000876 4876 D8              11      RET C
000877 4877 FEA0             7      CP  0A0H
000879 4879 3803            12      JR  C,FKAN1
00087B 487B FEE0             7      CP  0E0H
00087D 487D D8              11      RET C
       487E                     FKAN1:
00087E 487E 0C               4      INC C
00087F 487F A7               4      AND A
000880 4880 C9              10      RET
                                
       4881                     CAP:
000881 4881 FE61             7      CP  'a'
000883 4883 D8              11      RET C
000884 4884 FE7B             7      CP  'z'+1
000886 4886 D0              11      RET NC
000887 4887 D620             7      SUB 020H
000889 4889 C9              10      RET
       488A                     CAP2:
00088A 488A CD8148          17      CALL    CAP
       488D                     CAP3:               ;
00088D 488D FE05             7      CP  5
00088F 488F 2803            12      JR  Z,CAP4
000891 4891 FE21             7      CP  021H
000893 4893 C9              10      RET
       4894                     CAP4:
000894 4894 3EE5             7      LD  A,0E5H
000896 4896 C9              10      RET
                                
       4897                     ROM_OPEN:
000897 4897 CDA44C          17      CALL    GET_DISK_BANK_FDRV
                                
00089A 489A CDD34A          17      CALL    GET_DIR_DAT
00089D 489D D5              11      PUSH    DE
00089E 489E CDB348          17      CALL    FILESE
0008A1 48A1 D1              10      POP DE
0008A2 48A2 3F               4      CCF
0008A3 48A3 D8              11      RET C
0008A4 48A4 2243F1          16      LD  (FCBX),HL
0008A7 48A7 E5              11      PUSH    HL
0008A8 48A8 210000          10      LD  HL,0
0008AB 48AB 2224F1          16      LD  (RR_LOW),HL
0008AE 48AE 2226F1          16      LD  (RR_HIGH),HL
0008B1 48B1 E1              10      POP HL
0008B2 48B2 C9              10      RET
                                
       48B3                     FILESE:
0008B3 48B3 7E               7      LD  A,(HL)
0008B4 48B4 B7               4      OR  A
0008B5 48B5 C8              11      RET Z       ;END:ZF=1 CF=0
0008B6 48B6 FEE5             7      CP  0E5H
0008B8 48B8 280D            12      JR  Z,FILESE1
0008BA 48BA 114CF1          10      LD  DE,FNAME
0008BD 48BD E5              11      PUSH    HL
0008BE 48BE CDE948          17      CALL    CPFILE
0008C1 48C1 CC0A49          17      CALL    Z,CPFILE2
0008C4 48C4 E1              10      POP HL
0008C5 48C5 37               4      SCF
0008C6 48C6 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       48C7                     FILESE1:
0008C7 48C7 CDCF48          17      CALL    FNEXT
0008CA 48CA 20E7            12      JR  NZ,FILESE
       48CC                     ZF0_CF0_AFF_RET:
0008CC 48CC F6FF             7      OR  0FFH        ;ZF=0 CF=0
0008CE 48CE C9              10      RET
                                
       48CF                     FNEXT:
0008CF 48CF 112000          10      LD  DE,020H
0008D2 48D2 19              11      ADD HL,DE
0008D3 48D3 0D               4      DEC C
                                #if exists USE_NORMAL_32K_ROM
                                #else
       48D4                     CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
0008D4 48D4 F5              11      PUSH    AF
0008D5 48D5 CB7C             8      BIT 7,H
0008D7 48D7 280E            12      JR  Z,CHECK_DIR_PAGE1
0008D9 48D9 7C               4      LD  A,H
0008DA 48DA D620             7      SUB 020H
0008DC 48DC 67               4      LD  H,A
0008DD 48DD 3A1FF1          13      LD  A,(_BANK)
0008E0 48E0 3C               4      INC A
0008E1 48E1 320068          13      LD  (BANK1_SEL),A
0008E4 48E4 321FF1          13      LD  (_BANK),A
       48E7                     CHECK_DIR_PAGE1:
0008E7 48E7 F1              10      POP AF
                                #endif
0008E8 48E8 C9              10      RET
                                
       48E9                     CPFILE:
0008E9 48E9 C5              11      PUSH    BC
0008EA 48EA 01000B          10      LD  BC,00B00H
       48ED                     CPSTR1:
0008ED 48ED 1A               7      LD  A,(DE)
0008EE 48EE FE3F             7      CP  '?'     ;Wild card
0008F0 48F0 2812            12      JR  Z,CPSTR2
0008F2 48F2 7E               7      LD  A,(HL)
0008F3 48F3 CD6548          17      CALL    FKANC
0008F6 48F6 E5              11      PUSH    HL
0008F7 48F7 67               4      LD  H,A
0008F8 48F8 1A               7      LD  A,(DE)
0008F9 48F9 CB01             4      RLC C
0008FB 48FB CD6548          17      CALL    FKANC
0008FE 48FE CB09             4      RRC C
000900 4900 BC               4      CP  H       ;CP (HL),(DE)
000901 4901 E1              10      POP HL
000902 4902 2004            12      JR  NZ,CPSTR3
       4904                     CPSTR2:
000904 4904 13               6      INC DE
000905 4905 23               6      INC HL
000906 4906 10E5            13      DJNZ    CPSTR1
       4908                     CPSTR3:
000908 4908 C1              10      POP BC
000909 4909 C9              10      RET
                                
       490A                     CPFILE2:
                                ;   LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
                                ;   OR  0E1H
00090A 490A 3EE1             7      LD  A,0E1H
00090C 490C 2F               4      CPL
00090D 490D A6               7      AND (HL)
00090E 490E C9              10      RET
                                
       490F                     RBX1:
00090F 490F E5              11      PUSH    HL      ;Record byte
                                
000910 4910 ED5B24F1        20      LD  DE,(RR_LOW) ;CDE=Random record
000914 4914 3A27F1          13      LD  A,(RR_HIGH+1)
000917 4917 4F               4      LD  C,A
                                
000918 4918 CDA44C          17      CALL    GET_DISK_BANK_FDRV
                                
00091B 491B FD2A43F1        20      LD  IY,(FCBX)
00091F 491F FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000922 4922 FD661D          19      LD  H,(IY+01DH)
000925 4925 FD7E1E          19      LD  A,(IY+01EH)
                                
000928 4928 A7               4      AND A
000929 4929 ED52            15      SBC HL,DE
00092B 492B 99               4      SBC A,C
00092C 492C D1              10      POP DE
                                
00092D 492D D8              11      RET C
00092E 492E 4F               4      LD  C,A
00092F 492F EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000930 4930 B2               4      OR  D
000931 4931 B3               4      OR  E
000932 4932 C0              11      RET NZ
000933 4933 37               4      SCF
000934 4934 C9              10      RET
                                
       4935                     RBX2:
000935 4935 ED4B25F1        20      LD  BC,(RR_LOW+1)
000939 4939 CDBA49          17      CALL    RWXR
00093C 493C 3A21F1          13      LD  A,(CLSZ_H)
00093F 493F 3D               4      DEC A
000940 4940 E5              11      PUSH    HL
000941 4941 2A24F1          16      LD  HL,(RR_LOW)
000944 4944 A4               4      AND H
000945 4945 B5               4      OR  L
000946 4946 E1              10      POP HL
000947 4947 C9              10      RET
                                
       4948                     RBXA:
000948 4948 D5              11      PUSH    DE
000949 4949 CD264A          17      CALL    CLUST
00094C 494C ED532CF1        20      LD  (_DTPS),DE
000950 4950 D1              10      POP DE
000951 4951 CD034A          17      CALL    GNCL
000954 4954 D8              11      RET C
000955 4955 ED5328F1        20      LD  (_CLPS),DE
                                
000959 4959 ED4B24F1        20      LD  BC,(RR_LOW)
00095D 495D 2A20F1          16      LD  HL,(CLSZ)
000960 4960 7C               4      LD  A,H
000961 4961 3D               4      DEC A
000962 4962 A0               4      AND B
000963 4963 47               4      LD  B,A
000964 4964 ED42            15      SBC HL,BC       ;remaining cluster
                                
000966 4966 ED5B45F1        20      LD  DE,(LEFTX)
00096A 496A ED52            15      SBC HL,DE       ;CP HL,DE
00096C 496C 19              11      ADD HL,DE
00096D 496D 3801            12      JR  C,RBXA1
00096F 496F EB               4      EX  DE,HL
       4970                     RBXA1:
000970 4970 3A1FF1          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
000973 4973 320068          13      LD  (BANK1_SEL),A   ;ASCII-8K/Konami-8K共通で使える
000976 4976 E5              11      PUSH    HL
000977 4977 2A2CF1          16      LD  HL,(_DTPS)
00097A 497A 09              11      ADD HL,BC
00097B 497B ED5B3FF1        20      LD  DE,(DTAX)
00097F 497F C1              10      POP BC
000980 4980 C9              10      RET
                                
       4981                     RBXB:
000981 4981 2A3FF1          16      LD  HL,(DTAX)
000984 4984 ED5B28F1        20      LD  DE,(_CLPS)
000988 4988 3A46F1          13      LD  A,(LEFTX+1)
00098B 498B 47               4      LD  B,A
00098C 498C 3A21F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       498F                     RBXB1:
00098F 498F 1F               4      RRA     ;->CF
000990 4990 3804            12      JR  C,RBXB2
000992 4992 CB38             8      SRL B   ;B=B/2
000994 4994 18F9            12      JR  RBXB1
       4996                     RBXB2:
000996 4996 78               4      LD  A,B
000997 4997 B7               4      OR  A
000998 4998 C9              10      RET
                                
       4999                     RBXC:
000999 4999 ED4B45F1        20      LD  BC,(LEFTX)
00099D 499D 3A21F1          13      LD  A,(CLSZ_H)
0009A0 49A0 3D               4      DEC A
0009A1 49A1 A0               4      AND B
0009A2 49A2 47               4      LD  B,A
0009A3 49A3 B1               4      OR  C
0009A4 49A4 C9              10      RET
                                
       49A5                     RBXEND:
0009A5 49A5 ED5B2AF1        20      LD  DE,(_LEFT)
0009A9 49A9 2A24F1          16      LD  HL,(RR_LOW)
0009AC 49AC 3A27F1          13      LD  A,(RR_HIGH+1)
0009AF 49AF 19              11      ADD HL,DE
0009B0 49B0 CE00             7      ADC A,0
0009B2 49B2 2224F1          16      LD  (RR_LOW),HL
0009B5 49B5 3227F1          13      LD  (RR_HIGH+1),A
0009B8 49B8 EB               4      EX  DE,HL       ;HL=Read byte
0009B9 49B9 C9              10      RET 
                                
       49BA                     RWXR:
0009BA 49BA 3A21F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       49BD                     L_RWX:
0009BD 49BD 1F               4      RRA     ;->CF
0009BE 49BE 3806            12      JR  C,E_RWX
0009C0 49C0 CB38             8      SRL B   ;BC=BC/2
0009C2 49C2 CB19             8      RR  C   ;
0009C4 49C4 18F7            12      JR  L_RWX
       49C6                     E_RWX:
0009C6 49C6 CDA44C          17      CALL    GET_DISK_BANK_FDRV
                                
0009C9 49C9 FD2A43F1        20      LD  IY,(FCBX)
0009CD 49CD FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
0009D0 49D0 FD561B          19      LD  D,(IY+01BH)
       49D3                     RWX1:
0009D3 49D3 ED5328F1        20      LD  (_CLPS),DE
0009D7 49D7 7A               4      LD  A,D
0009D8 49D8 B3               4      OR  E
0009D9 49D9 37               4      SCF
0009DA 49DA C8              11      RET Z
                                
0009DB 49DB 78               4      LD  A,B
0009DC 49DC B1               4      OR  C
0009DD 49DD C8              11      RET Z
                                
0009DE 49DE CD034A          17      CALL    GNCL
0009E1 49E1 D8              11      RET C
0009E2 49E2 0B               6      DEC BC
0009E3 49E3 CD6C4A          17      CALL    ENDCL
0009E6 49E6 38EB            12      JR  C,RWX1
0009E8 49E8 37               4      SCF
0009E9 49E9 C9              10      RET
                                
       49EA                     NCL3:
0009EA 49EA CDA44C          17      CALL    GET_DISK_BANK_FDRV
0009ED 49ED 320068          13      LD  (BANK1_SEL),A
0009F0 49F0 6B               4      LD  L,E
0009F1 49F1 62               4      LD  H,D
0009F2 49F2 CB3C             8      SRL H
0009F4 49F4 CB1D             8      RR  L
0009F6 49F6 1F               4      RRA
0009F7 49F7 19              11      ADD HL,DE
0009F8 49F8 010060          10      LD  BC,BANK1_ADR
0009FB 49FB 09              11      ADD HL,BC
0009FC 49FC ED4B22F1        20      LD  BC,(SECSZ)
000A00 4A00 09              11      ADD HL,BC
000A01 4A01 17               4      RLA
000A02 4A02 C9              10      RET
                                
       4A03                     GNCL:
000A03 4A03 7A               4      LD  A,D
000A04 4A04 B3               4      OR  E
000A05 4A05 37               4      SCF
000A06 4A06 C8              11      RET Z
000A07 4A07 C5              11      PUSH    BC
000A08 4A08 E5              11      PUSH    HL
000A09 4A09 CDEA49          17      CALL    NCL3
000A0C 4A0C 3809            12      JR  C,GNC1
000A0E 4A0E 5E               7      LD  E,(HL)
000A0F 4A0F 23               6      INC HL
000A10 4A10 7E               7      LD  A,(HL)
000A11 4A11 E60F             7      AND 00FH
000A13 4A13 57               4      LD  D,A
000A14 4A14 E1              10      POP HL
000A15 4A15 C1              10      POP BC
000A16 4A16 C9              10      RET
       4A17                     GNC1:
000A17 4A17 7E               7      LD  A,(HL)
000A18 4A18 23               6      INC HL
000A19 4A19 56               7      LD  D,(HL)
000A1A 4A1A 0604             7      LD  B,4
       4A1C                     GNC1L:
000A1C 4A1C CB3A             8      SRL D
000A1E 4A1E 1F               4      RRA
000A1F 4A1F 10FB            13      DJNZ    GNC1L
                                
000A21 4A21 5F               4      LD  E,A
000A22 4A22 E1              10      POP HL
000A23 4A23 C1              10      POP BC
000A24 4A24 A7               4      AND A
000A25 4A25 C9              10      RET
                                
       4A26                     CLUST:
000A26 4A26 EB               4      EX  DE,HL
000A27 4A27 C5              11      PUSH    BC
000A28 4A28 3A21F1          13      LD  A,(CLSZ_H)
000A2B 4A2B CDCD4C          17      CALL    MUL_AHL
                                
000A2E 4A2E CDE34A          17      CALL    GET_DIR_POS
000A31 4A31 4F               4      LD  C,A
000A32 4A32 0600             7      LD  B,0
000A34 4A34 09              11      ADD HL,BC
                                
000A35 4A35 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000A38 4A38 0F               4      RRCA
000A39 4A39 0F               4      RRCA
000A3A 4A3A 0F               4      RRCA
000A3B 4A3B 0F               4      RRCA
000A3C 4A3C 4F               4      LD  C,A
                                
000A3D 4A3D 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000A40 4A40 FE02             7      CP  2
000A42 4A42 280C            12      JR  Z,CLUST1
000A44 4A44 CB01             4      RLC C
000A46 4A46 0D               4      DEC C
000A47 4A47 3A0C60          13      LD  A,(BANK1_ADR+11+1)  ;BPB_BytsPerSec High    
000A4A 4A4A FE02             7      CP  2
000A4C 4A4C 2002            12      JR  NZ,CLUST1
000A4E 4A4E 0D               4      DEC C
000A4F 4A4F 0D               4      DEC C
       4A50                     CLUST1:
000A50 4A50 0D               4      DEC C
000A51 4A51 09              11      ADD HL,BC
                                
                                #if exists USE_NORMAL_32K_ROM
                                    LD  A,L
                                #else
000A52 4A52 E5              11      PUSH    HL
000A53 4A53 29              11      ADD HL,HL   ;*2
000A54 4A54 29              11      ADD HL,HL   ;*4
000A55 4A55 29              11      ADD HL,HL   ;*8
000A56 4A56 CDA44C          17      CALL    GET_DISK_BANK_FDRV
000A59 4A59 84               4      ADD A,H
000A5A 4A5A 320068          13      LD  (BANK1_SEL),A
000A5D 4A5D 321FF1          13      LD  (_BANK),A
000A60 4A60 E1              10      POP HL
000A61 4A61 3E1F             7      LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
000A63 4A63 A5               4      AND L
                                #endif
000A64 4A64 C660             7      ADD A,high BANK1_ADR
000A66 4A66 67               4      LD  H,A
000A67 4A67 2E00             7      LD  L,0
000A69 4A69 EB               4      EX  DE,HL
000A6A 4A6A C1              10      POP BC
000A6B 4A6B C9              10      RET
                                
       4A6C                     ENDCL:
000A6C 4A6C 7A               4      LD  A,D ;END CLUSTER
000A6D 4A6D FE0F             7      CP  00FH    ;FAT12の最大値
000A6F 4A6F C0              11      RET NZ
000A70 4A70 7B               4      LD  A,E
000A71 4A71 FEF7             7      CP  0F7H
000A73 4A73 C9              10      RET
                                
       4A74                     RB_READ:
000A74 4A74 AF               4      XOR A   ;HLA = HL*128
000A75 4A75 CB3C             8      SRL H
000A77 4A77 CB1D             8      RR  L
000A79 4A79 1F               4      RRA
000A7A 4A7A 3224F1          13      LD  (RR_LOW),A
000A7D 4A7D 2225F1          16      LD  (RR_MID),HL
000A80 4A80 218000          10      LD  HL,128
                                
000A83 4A83 CDB746          17      CALL    ROM_READ
000A86 4A86 C9              10      RET
                                
       4A87                     GETSEQ:
000A87 4A87 FD6E20          19      LD  L,(IY+32)
000A8A 4A8A FD660C          19      LD  H,(IY+12)
                                
000A8D 4A8D CB25             8      SLA L
                                
000A8F 4A8F CB3C             8      SRL H
000A91 4A91 CB1D             8      RR  L
000A93 4A93 C9              10      RET
                                
       4A94                     SETSEQ:
000A94 4A94 F5              11      PUSH    AF
000A95 4A95 3A24F1          13      LD  A,(RR_LOW)
000A98 4A98 2A25F1          16      LD  HL,(RR_MID)
                                
000A9B 4A9B CDB24A          17      CALL    SSQ1
                                
000A9E 4A9E 29              11      ADD HL,HL
000A9F 4A9F CB3D             8      SRL L
000AA1 4AA1 FD7520          19      LD  (IY+32),L
000AA4 4AA4 FD740C          19      LD  (IY+12),H
000AA7 4AA7 F1              10      POP AF
000AA8 4AA8 C9              10      RET
                                
       4AA9                     GETSIZE:
000AA9 4AA9 FD7E10          19      LD  A,(IY+16)
000AAC 4AAC FD6E11          19      LD  L,(IY+17)
000AAF 4AAF FD6612          19      LD  H,(IY+18)
       4AB2                     SSQ1:
000AB2 4AB2 87               4      ADD A,A
000AB3 4AB3 ED6A            15      ADC HL,HL
000AB5 4AB5 B7               4      OR  A
000AB6 4AB6 C8              11      RET Z
000AB7 4AB7 23               6      INC HL
000AB8 4AB8 C9              10      RET
                                
       4AB9                     SET_FCB:
000AB9 4AB9 D5              11      PUSH    DE
000ABA 4ABA FDE1            14      POP IY
000ABC 4ABC FD7E1C          19      LD  A,(IY+28)
000ABF 4ABF FEFF             7      CP  0FFH
000AC1 4AC1 200C            12      JR  NZ,POPAF_SCF_FF_RET
000AC3 4AC3 E5              11      PUSH    HL
000AC4 4AC4 FD6E1A          19      LD  L,(IY+26)
000AC7 4AC7 FD661B          19      LD  H,(IY+27)
000ACA 4ACA 2228F1          16      LD  (_CLPS),HL
000ACD 4ACD E1              10      POP HL
000ACE 4ACE C9              10      RET
                                
       4ACF                     POPAF_SCF_FF_RET:
000ACF 4ACF F1              10      POP AF
000AD0 4AD0 37               4      SCF
000AD1 4AD1 9F               4      SBC A,A
000AD2 4AD2 C9              10      RET
                                
       4AD3                     GET_DIR_DAT:
000AD3 4AD3 CDE34A          17      CALL    GET_DIR_POS
000AD6 4AD6 C660             7      ADD A,high BANK1_ADR
000AD8 4AD8 2E00             7      LD  L,0
000ADA 4ADA 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_NORMAL_32K_ROM
                                #else
000ADB 4ADB CDD448          17      CALL    CHECK_DIR_PAGE
                                #endif
000ADE 4ADE 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000AE1 4AE1 4F               4      LD  C,A
000AE2 4AE2 C9              10      RET
                                
       4AE3                     GET_DIR_POS:
000AE3 4AE3 CDA44C          17      CALL    GET_DISK_BANK_FDRV
000AE6 4AE6 320068          13      LD  (BANK1_SEL),A
000AE9 4AE9 321FF1          13      LD  (_BANK),A
000AEC 4AEC 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000AEF 4AEF 47               4      LD  B,A
000AF0 4AF0 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000AF3 4AF3 4F               4      LD  C,A
000AF4 4AF4 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4AF7                     GET_DIR_POS1:
000AF7 4AF7 81               4      ADD A,C
000AF8 4AF8 10FD            13      DJNZ    GET_DIR_POS1
                                
000AFA 4AFA ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec 
       4AFE                     L_MDP:
000AFE 4AFE CB18             8      RR  B   ;->CF
000B00 4B00 D8              11      RET C
000B01 4B01 87               4      ADD A,A
000B02 4B02 18FA            12      JR  L_MDP
                                
       4B04                     WILDCARD:
000B04 4B04 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4B0F                     ERROR_WRITE_PROTECTED:
000B0F 4B0F 3E00             7      LD  A,0     ;Write protected
000B11 4B11 C9              10      RET
       4B12                     DISKIO:
000B12 4B12 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000B14 4B14 48               4      LD  C,B
000B15 4B15 CDAE4C          17      CALL    GET_DISK_BANK
       4B18                     SETMAP1:        
000B18 4B18 E5              11      PUSH    HL
       4B19                     DISKIO1:
000B19 4B19 C5              11      PUSH    BC      ;B=残りのセクタ数
000B1A 4B1A D5              11      PUSH    DE      ;DE=セクタ番号
000B1B 4B1B F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
000B1C 4B1C EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
000B1D 4B1D F5              11      PUSH    AF
000B1E 4B1E 3A23F1          13      LD  A,(SECSZ_H)
000B21 4B21 CDCD4C          17      CALL    MUL_AHL
000B24 4B24 F1              10      POP AF
000B25 4B25 4D               4      LD  C,L     ;C=読み出し元
000B26 4B26 29              11      ADD HL,HL       ;64KB→32KB
000B27 4B27 29              11      ADD HL,HL       ;32KB→16KB
000B28 4B28 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
000B29 4B29 84               4      ADD A,H
000B2A 4B2A 320068          13      LD  (BANK1_SEL),A   ;ASCII-8K/Konami-8K共通で使える
000B2D 4B2D 321FF1          13      LD  (_BANK),A
000B30 4B30 79               4      LD  A,C     ;C=読み出し元
000B31 4B31 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
000B33 4B33 C660             7      ADD A,high BANK1_ADR
000B35 4B35 67               4      LD  H,A
000B36 4B36 ED4B22F1        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
000B3A 4B3A 69               4      LD  L,C     ;C=0
000B3B 4B3B EDB0                    LDIR
000B3D 4B3D EB               4      EX  DE,HL
000B3E 4B3E F1              10      POP AF
000B3F 4B3F D1              10      POP DE
000B40 4B40 13               6      INC DE
000B41 4B41 C1              10      POP BC
000B42 4B42 10D5            13      DJNZ    DISKIO1
000B44 4B44 41               4      LD  B,C
                                
000B45 4B45 E1              10      POP HL
000B46 4B46 AF               4      XOR A
000B47 4B47 FB               4      EI
000B48 4B48 C9              10      RET
                                
       4B49                     DSKCHG:
000B49 4B49 CD824B          17      CALL    IS_BPB
000B4C 4B4C 3824            12      JR  C,NOTREADY
000B4E 4B4E 3A23FB          13      LD  A,(DRVTBL+2)
000B51 4B51 B7               4      OR  A
000B52 4B52 201A            12      JR  NZ,DSKCHG1
000B54 4B54 3A21FB          13      LD  A,(DRVTBL)
000B57 4B57 FE02             7      CP  2
000B59 4B59 2013            12      JR  NZ,DSKCHG1
000B5B 4B5B CD824B          17      CALL    IS_BPB
000B5E 4B5E 300E            12      JR  NC,DSKCHG1
000B60 4B60 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000B62 4B62 3221FB          13      LD  (DRVTBL),A
000B65 4B65 3223FB          13      LD  (DRVTBL+2),A
000B68 4B68 3A48F3          13      LD  A,(MASTERS)
000B6B 4B6B 3224FB          13      LD  (DRVTBL+3),A
       4B6E                     DSKCHG1:
000B6E 4B6E AF               4      XOR A
000B6F 4B6F 0601             7      LD  B,1
000B71 4B71 C9              10      RET
       4B72                     NOTREADY:
000B72 4B72 3E02             7      LD  A,2
000B74 4B74 37               4      SCF
000B75 4B75 C9              10      RET
                                
       4B76                     NO_BPB:
000B76 4B76 E1              10      POP HL
000B77 4B77 23               6      INC HL
000B78 4B78 11D24C          10      LD  DE,DPB2DD
000B7B 4B7B 011200          10      LD  BC,DPB2DD_E-DPB2DD
000B7E 4B7E EDB0                    LDIR
000B80 4B80 AF               4      XOR A
000B81 4B81 C9              10      RET
                                
       4B82                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000B82 4B82 CDAE4C          17      CALL    GET_DISK_BANK
                                
000B85 4B85 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000B88 4B88 FE01             7      CP  1
000B8A 4B8A D8              11      RET C
                                
000B8B 4B8B 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000B8E 4B8E C6FF             7      ADD A,0FFH
000B90 4B90 D8              11      RET C
                                
000B91 4B91 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
000B94 4B94 FE01             7      CP  1
000B96 4B96 C8              11      RET Z
000B97 4B97 FE02             7      CP  2
000B99 4B99 C8              11      RET Z
000B9A 4B9A FE04             7      CP  4
000B9C 4B9C C8              11      RET Z
000B9D 4B9D 37               4      SCF
000B9E 4B9E C9              10      RET
                                
       4B9F                     GETDPB:
000B9F 4B9F E5              11      PUSH    HL
000BA0 4BA0 CDAE4C          17      CALL    GET_DISK_BANK
                                
000BA3 4BA3 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000BA6 4BA6 B7               4      OR  A
000BA7 4BA7 28CD            12      JR  Z,NO_BPB
000BA9 4BA9 DDE1            14      POP IX
000BAB 4BAB DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000BAE 4BAE 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000BB1 4BB1 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000BB4 4BB4 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000BB7 4BB7 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000BBA 4BBA 87               4      ADD A,A
000BBB 4BBB 87               4      ADD A,A
000BBC 4BBC 87               4      ADD A,A
000BBD 4BBD 3D               4      DEC A
000BBE 4BBE DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000BC1 4BC1 06FF             7      LD  B,-1
000BC3 4BC3 A7               4      AND A           ;無限ループ阻止
       4BC4                     GETDPB1:
000BC4 4BC4 04               4      INC B
000BC5 4BC5 1F               4      RRA
000BC6 4BC6 38FC            12      JR  C,GETDPB1
000BC8 4BC8 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000BCB 4BCB 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000BCE 4BCE 3D               4      DEC A
000BCF 4BCF DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000BD2 4BD2 A7               4      AND A           ;無限ループ阻止
000BD3 4BD3 06FF             7      LD  B,-1
       4BD5                     GETDPB2:
000BD5 4BD5 04               4      INC B
000BD6 4BD6 1F               4      RRA
000BD7 4BD7 38FC            12      JR  C,GETDPB2
000BD9 4BD9 04               4      INC B
000BDA 4BDA DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000BDD 4BDD 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
000BE0 4BE0 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
000BE3 4BE3 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
000BE6 4BE6 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
000BE9 4BE9 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000BEC 4BEC 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
000BEF 4BEF DD770B          19      LD  (IX+11),A       ;FATCNT
                                
000BF2 4BF2 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
000BF6 4BF6 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
000BF9 4BF9 DD460A          19      LD  B,(IX+10)       ;FATCNT
000BFC 4BFC 210000          10      LD  HL,0
       4BFF                     GETDPB3:
000BFF 4BFF 19              11      ADD HL,DE
000C00 4C00 10FD            13      DJNZ    GETDPB3
       4C02                     GETDPB4:
000C02 4C02 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
000C05 4C05 DD5609          19      LD  D,(IX+9)        ;FIRFAT
000C08 4C08 19              11      ADD HL,DE
000C09 4C09 DD7511          19      LD  (IX+17),L       ;FIRDIR
000C0C 4C0C DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000C0F 4C0F DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000C12 4C12 87               4      ADD A,A
000C13 4C13 87               4      ADD A,A
000C14 4C14 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4C17                     GETDPB5:
000C17 4C17 CB3B             8      SRL E
000C19 4C19 1F               4      RRA
000C1A 4C1A 30FB            12      JR  NC,GETDPB5
000C1C 4C1C 1600             7      LD  D,0
000C1E 4C1E 19              11      ADD HL,DE
000C1F 4C1F DD750C          19      LD  (IX+12),L       ;FIRREC
000C22 4C22 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000C25 4C25 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
000C28 4C28 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
000C2B 4C2B DD560D          19      LD  D,(IX+13)       ;FIRREC
000C2E 4C2E A7               4      AND A
000C2F 4C2F ED52            15      SBC HL,DE
                                
000C31 4C31 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
000C34 4C34 3C               4      INC A
000C35 4C35 37               4      SCF             ;無限ループ阻止
       4C36                     GETDPB6:
000C36 4C36 1F               4      RRA
000C37 4C37 3806            12      JR  C,GETDPB7
000C39 4C39 CB3C             8      SRL H
000C3B 4C3B CB1D             8      RR  L
000C3D 4C3D 18F7            12      JR  GETDPB6
       4C3F                     GETDPB7:
000C3F 4C3F 23               6      INC HL
000C40 4C40 DD750E          19      LD  (IX+14),L       ;MAXCLUS
000C43 4C43 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       4C46                     GETDPBD1:
000C46 4C46 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000C49 4C49 E6FC             7      AND 0FCH
000C4B 4C4B C8              11      RET Z
                                
000C4C 4C4C DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
000C50 4C50 37               4      SCF
000C51 4C51 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
000C55 4C55 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
000C58 4C58 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
000C5C 4C5C DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
000C60 4C60 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
000C64 4C64 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
000C68 4C68 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
000C6C 4C6C DDCB1126        23      SLA (IX+17)         ;FIRDIR
000C70 4C70 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
000C74 4C74 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
000C77 4C77 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
000C7A 4C7A DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000C7D 4C7D 87               4      ADD A,A
000C7E 4C7E 87               4      ADD A,A
000C7F 4C7F DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4C82                     GETDPBD5:
000C82 4C82 CB3B             8      SRL E
000C84 4C84 1F               4      RRA
000C85 4C85 30FB            12      JR  NC,GETDPBD5
000C87 4C87 1600             7      LD  D,0
000C89 4C89 19              11      ADD HL,DE
000C8A 4C8A DD750C          19      LD  (IX+12),L       ;FIRREC
000C8D 4C8D DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000C90 4C90 18B4            12      JR  GETDPBD1
                                
       4C92                     CHOICE:
000C92 4C92 210000          10      LD  HL,0
000C95 4C95 C9              10      RET
                                
       4C96                     DSKFMT:
000C96 4C96 AF               4      XOR A
000C97 4C97 37               4      SCF
       4C98                     DSKSTP:
000C98 4C98 C9              10      RET
                                
       4C99                     BASENT:
000C99 4C99 ED7B57F1        20      LD  SP,(BASSTK)
000C9D 4C9D C3B243          10      JP  BASAUTO
                                
       4CA0                     GETSLT:
000CA0 4CA0 3A22FB          13      LD  A,(DRVTBL+1)
000CA3 4CA3 C9              10      RET
                                
       4CA4                     GET_DISK_BANK_FDRV:
000CA4 4CA4 3A4BF1          13      LD  A,(FDRV)
000CA7 4CA7 D601             7      SUB 1
000CA9 4CA9 3003            12      JR  NC,GET_DISK_BANK
000CAB 4CAB 3A42F1          13      LD  A,(_DVSW)
       4CAE                     GET_DISK_BANK:
000CAE 4CAE B7               4      OR  A       ;A=DRIVE
000CAF 4CAF 3E01             7      LD  A,DISK_BANK
000CB1 4CB1 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
000CB3 4CB3 3A41F1          13      LD  A,(B_DRIVE)
                                #endif
       4CB6                     SET_DISK_BANK:
000CB6 4CB6 320068          13      LD  (BANK1_SEL),A
000CB9 4CB9 F5              11      PUSH    AF
000CBA 4CBA E5              11      PUSH    HL
000CBB 4CBB 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
000CBE 4CBE 2222F1          16      LD  (SECSZ),HL
000CC1 4CC1 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000CC4 4CC4 CDCD4C          17      CALL    MUL_AHL
000CC7 4CC7 2220F1          16      LD  (CLSZ),HL
000CCA 4CCA E1              10      POP HL
000CCB 4CCB F1              10      POP AF
000CCC 4CCC C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)
       4CCD                     MUL_AHL:
000CCD 4CCD 1F               4      RRA     ;->CF
000CCE 4CCE D8              11      RET C
000CCF 4CCF 29              11      ADD HL,HL
000CD0 4CD0 18FB            12      JR  MUL_AHL
                                
       4CD2                     DPB2DD:
000CD2 4CD2 F9                      DB  0F9H    ;MEDIA
000CD3 4CD3 0002                    DW  00200H  ;SECSIZ
000CD5 4CD5 0F                      DB  00FH    ;DIRMSK
000CD6 4CD6 04                      DB  004H    ;DIRSHFT
000CD7 4CD7 01                      DB  001H    ;CLUSMSK
000CD8 4CD8 02                      DB  002H    ;CLUSSHFT
000CD9 4CD9 0100                    DW  00001H  ;FIRFAT
000CDB 4CDB 02                      DB  002H    ;FATCNT
000CDC 4CDC 70                      DB  070H    ;MAXENT
000CDD 4CDD 0E00                    DW  0000EH  ;FIRREC
000CDF 4CDF CA02                    DW  002CAH  ;MAXCLUS
000CE1 4CE1 03                      DB  003H    ;FATSIZ
000CE2 4CE2 0700                    DW  0007H   ;FIRDIR
       4CE4                     DPB2DD_E:
                                
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       4CE4                     POP_HL_ERROR:
000CE4 4CE4 E1              10      POP     HL
       4CE5                     _ERROR:
000CE5 4CE5 0600             7      LD  B,0
000CE7 4CE7 A7               4      AND A
000CE8 4CE8 C9              10      RET
                                
       4CE9                     ROM_BDOS:
000CE9 4CE9 E5              11      PUSH    HL
000CEA 4CEA 79               4      LD  A,C
000CEB 4CEB 87               4      ADD A,A
000CEC 4CEC 38F7            12      JR  C,_ERROR
000CEE 4CEE 6F               4      LD  L,A
000CEF 4CEF 265F             7      LD  H,high STABLE
000CF1 4CF1 7E               7      LD  A,(HL)
000CF2 4CF2 2C               4      INC L
000CF3 4CF3 66               7      LD  H,(HL)
000CF4 4CF4 6F               4      LD  L,A
000CF5 4CF5 E3              19      EX  (SP),HL
000CF6 4CF6 79               4      LD  A,C
000CF7 4CF7 C9              10      RET
                                
       4CF8                     _PRINT:
       4CF8                     PRINT:
000CF8 4CF8 7B               4      LD  A,E
000CF9 4CF9 1803            12      JR  MSG_A
                                
       4CFB                     _SYS01:     ;(BDOS)コンソール入力
000CFB 4CFB CD724D          17      CALL    _SYS07
       4CFE                     MSG_A:
000CFE 4CFE FE03             7      CP  3
000D00 4D00 2814            12      JR  Z,MSG_BR
       4D02                     MSGA1:
000D02 4D02 F5              11      PUSH    AF
000D03 4D03 C5              11      PUSH    BC
000D04 4D04 D5              11      PUSH    DE
000D05 4D05 E5              11      PUSH    HL
000D06 4D06 DDE5            15      PUSH    IX
000D08 4D08 DD21A200        14      LD  IX,CHPUT
000D0C 4D0C CDE142          17      CALL    CALSLT_R
000D0F 4D0F DDE1            14      POP IX
000D11 4D11 E1              10      POP HL
000D12 4D12 D1              10      POP DE
000D13 4D13 C1              10      POP BC
       4D14                     MSGA2:
000D14 4D14 F1              10      POP AF
000D15 4D15 C9              10      RET
       4D16                     MSG_BR:
000D16 4D16 F5              11      PUSH    AF
000D17 4D17 3ADDF3          13      LD  A,(CSRX)
000D1A 4D1A FE02             7      CP  2
000D1C 4D1C 38F6            12      JR  C,MSGA2
000D1E 4D1E F1              10      POP AF
       4D1F                     MSG_CR:
000D1F 4D1F F5              11      PUSH    AF
000D20 4D20 3E0D             7      LD  A,00DH
000D22 4D22 CD024D          17      CALL    MSGA1
000D25 4D25 3E0A             7      LD  A,00AH
000D27 4D27 CD024D          17      CALL    MSGA1
000D2A 4D2A F1              10      POP AF
000D2B 4D2B C9              10      RET
                                
       4D2C                     _SYS02:     ;(BDOS)コンソール出力
000D2C 4D2C CD474D          17      CALL    BREAK
000D2F 4D2F 1805            12      JR  PRINTX
                                
       4D31                     _SYS06:     ;(BDOS)コンソール直接入出力
000D31 4D31 7B               4      LD  A,E
000D32 4D32 3C               4      INC A
000D33 4D33 CA864D          10      JP  Z,_INKEY
       4D36                     PRINTX:
000D36 4D36 C3F84C          10      JP  _PRINT
                                
       4D39                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000D39 4D39 CD724D          17      CALL    _SYS07
000D3C 4D3C FE03             7      CP  3
000D3E 4D3E CC474D          17      CALL    Z,_BREAK
000D41 4D41 FE13             7      CP  013H        ;CTRL+S
000D43 4D43 C0              11      RET NZ
       4D44                     PAUSE:
000D44 4D44 CD5E4D          17      CALL    KEYBC
                                
       4D47                     _BREAK:
       4D47                     BREAK:
000D47 4D47 F5              11      PUSH    AF
000D48 4D48 C5              11      PUSH    BC
000D49 4D49 D5              11      PUSH    DE
000D4A 4D4A E5              11      PUSH    HL
000D4B 4D4B DDE5            15      PUSH    IX
000D4D 4D4D DD21B700        14      LD  IX,BREAKX
000D51 4D51 CDE142          17      CALL    CALSLT_R
000D54 4D54 DDE1            14      POP IX
000D56 4D56 E1              10      POP HL
000D57 4D57 D1              10      POP DE
000D58 4D58 C1              10      POP BC
000D59 4D59 DC474D          17      CALL    C,_BREAK
000D5C 4D5C F1              10      POP AF
000D5D 4D5D C9              10      RET
       4D5E                     KEYBC:
000D5E 4D5E F5              11      PUSH    AF
000D5F 4D5F C5              11      PUSH    BC
000D60 4D60 D5              11      PUSH    DE
000D61 4D61 E5              11      PUSH    HL
000D62 4D62 DDE5            15      PUSH    IX
000D64 4D64 DD215601        14      LD  IX,KILBUF
000D68 4D68 CDE142          17      CALL    CALSLT_R
000D6B 4D6B DDE1            14      POP IX
000D6D 4D6D E1              10      POP HL
000D6E 4D6E D1              10      POP DE
000D6F 4D6F C1              10      POP BC
000D70 4D70 F1              10      POP AF
000D71 4D71 C9              10      RET
                                
       4D72                     _SYS07:
       4D72                     FLGET:
000D72 4D72 C5              11      PUSH    BC
000D73 4D73 D5              11      PUSH    DE
000D74 4D74 E5              11      PUSH    HL
000D75 4D75 DDE5            15      PUSH    IX
000D77 4D77 DD219F00        14      LD  IX,CHGET
000D7B 4D7B CDE142          17      CALL    CALSLT_R
000D7E 4D7E DDE1            14      POP IX
000D80 4D80 E1              10      POP HL
000D81 4D81 D1              10      POP DE
000D82 4D82 C1              10      POP BC
000D83 4D83 FE03             7      CP  3
000D85 4D85 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       4D86                     _INKEY:
       4D86                     INKEY:
000D86 4D86 CD204E          17      CALL    CPM_CONST
000D89 4D89 C8              11      RET Z
000D8A 4D8A 18E6            12      JR  FLGET
                                
       4D8C                     _SYS0A:     ;(BDOS)文字列入力
000D8C 4D8C C5              11      PUSH    BC
000D8D 4D8D E5              11      PUSH    HL
000D8E 4D8E D5              11      PUSH    DE
000D8F 4D8F CDB84D          17      CALL    GETL
000D92 4D92 111FF4          10      LD  DE,KBUF
000D95 4D95 E1              10      POP HL
000D96 4D96 E5              11      PUSH    HL
000D97 4D97 0E00             7      LD  C,0
000D99 4D99 3004            12      JR  NC,SAX0
000D9B 4D9B 23               6      INC HL
000D9C 4D9C 23               6      INC HL
000D9D 4D9D 1808            12      JR  SAX4
       4D9F                     SAX0:
000D9F 4D9F 46               7      LD  B,(HL)
000DA0 4DA0 23               6      INC HL
       4DA1                     SAX1:
000DA1 4DA1 23               6      INC HL
000DA2 4DA2 1A               7      LD  A,(DE)
000DA3 4DA3 13               6      INC DE
000DA4 4DA4 B7               4      OR  A
000DA5 4DA5 2004            12      JR  NZ,SAX2
       4DA7                     SAX4:
000DA7 4DA7 360D            10      LD  (HL),00DH
000DA9 4DA9 1804            12      JR  SAX3
       4DAB                     SAX2:
000DAB 4DAB 77               7      LD  (HL),A
000DAC 4DAC 0C               4      INC C
000DAD 4DAD 10F2            13      DJNZ    SAX1
       4DAF                     SAX3:
000DAF 4DAF D1              10      POP DE
000DB0 4DB0 79               4      LD  A,C
000DB1 4DB1 13               6      INC DE
000DB2 4DB2 12               7      LD  (DE),A
000DB3 4DB3 1B               6      DEC DE
000DB4 4DB4 E1              10      POP HL
000DB5 4DB5 C1              10      POP BC
000DB6 4DB6 A7               4      AND A
000DB7 4DB7 C9              10      RET
       4DB8                     GETL:
000DB8 4DB8 DDE5            15      PUSH    IX
000DBA 4DBA FDE5            15      PUSH    IY
                                
000DBC 4DBC 2ADCF3          16      LD  HL,(CSRY)
000DBF 4DBF 22CAFB          16      LD  (FSTPOS),HL
       4DC2                     GETL1:
000DC2 4DC2 CD394D          17      CALL    _SYS08
000DC5 4DC5 FE09             7      CP  9
000DC7 4DC7 2008            12      JR  NZ,GETL1V
000DC9 4DC9 211FF4          10      LD  HL,KBUF
000DCC 4DCC CD6443          17      CALL    MSX
000DCF 4DCF 18F1            12      JR  GETL1
       4DD1                     GETL1V:
000DD1 4DD1 5F               4      LD  E,A
000DD2 4DD2 FE08             7      CP  8
000DD4 4DD4 CC6E4E          17      CALL    Z,CTRL02
000DD7 4DD7 FE20             7      CP  020H
000DD9 4DD9 D49A4E          17      CALL    NC,INSERT
000DDC 4DDC CD024D          17      CALL    MSGA1
                                
000DDF 4DDF 7B               4      LD  A,E
000DE0 4DE0 FE0D             7      CP  00DH
000DE2 4DE2 20DE            12      JR  NZ,GETL1
                                
000DE4 4DE4 111FF4          10      LD  DE,KBUF
000DE7 4DE7 3AB0F3          13      LD  A,(LINLEN)
000DEA 4DEA 47               4      LD  B,A
000DEB 4DEB CD4A50          17      CALL    ZERO_MEMORY_DE
                                
000DEE 4DEE 2ACAFB          16      LD  HL,(FSTPOS)
000DF1 4DF1 3ADCF3          13      LD  A,(CSRY)
000DF4 4DF4 6F               4      LD  L,A
000DF5 4DF5 E5              11      PUSH    HL
000DF6 4DF6 CDCB4E          17      CALL    LOC0
000DF9 4DF9 4D               4      LD  C,L
000DFA 4DFA 44               4      LD  B,H
000DFB 4DFB E1              10      POP HL
000DFC 4DFC 3AB0F3          13      LD  A,(LINLEN)
000DFF 4DFF 94               4      SUB H
000E00 4E00 3D               4      DEC A
000E01 4E01 5F               4      LD  E,A
000E02 4E02 211FF4          10      LD  HL,KBUF
       4E05                     GETL2:
000E05 4E05 CD5E4E          17      CALL    _SCRN
000E08 4E08 03               6      INC BC
000E09 4E09 77               7      LD  (HL),A
000E0A 4E0A 23               6      INC HL
000E0B 4E0B 1D               4      DEC E
000E0C 4E0C 20F7            12      JR  NZ,GETL2
000E0E 4E0E CD1F4D          17      CALL    MSG_CR
                                
000E11 4E11 FDE1            14      POP IY
000E13 4E13 DDE1            14      POP IX
       4E15                     GETL3:
000E15 4E15 2B               6      DEC HL
000E16 4E16 7E               7      LD  A,(HL)
000E17 4E17 FE21             7      CP  021H
000E19 4E19 D0              11      RET NC
000E1A 4E1A 3600            10      LD  (HL),0
000E1C 4E1C 15               4      DEC D
000E1D 4E1D 20F6            12      JR  NZ,GETL3
000E1F 4E1F C9              10      RET
                                
       4E20                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       4E20                     CONSTX:
       4E20                     CPM_CONST:
000E20 4E20 C5              11      PUSH    BC
000E21 4E21 D5              11      PUSH    DE
000E22 4E22 E5              11      PUSH    HL
000E23 4E23 DDE5            15      PUSH    IX
000E25 4E25 DD219C00        14      LD  IX,CHSNS
000E29 4E29 CDE142          17      CALL    CALSLT_R
000E2C 4E2C DDE1            14      POP IX
000E2E 4E2E E1              10      POP HL
000E2F 4E2F D1              10      POP DE
000E30 4E30 C1              10      POP BC
000E31 4E31 C9              10      RET
                                
       4E32                     _SYS2A:     ;(BDOS)日付の獲得
000E32 4E32 AF               4      XOR A
000E33 4E33 57               4      LD  D,A
000E34 4E34 5F               4      LD  E,A
000E35 4E35 67               4      LD  H,A
000E36 4E36 6F               4      LD  L,A
000E37 4E37 C9              10      RET
                                
       4E38                     _SYS2C:     ;(BDOS)時刻の獲得
000E38 4E38 AF               4      XOR A
000E39 4E39 57               4      LD  D,A
000E3A 4E3A 5F               4      LD  E,A
000E3B 4E3B 67               4      LD  H,A
000E3C 4E3C 6F               4      LD  L,A
000E3D 4E3D C9              10      RET
                                
       4E3E                     POS:
000E3E 4E3E F5              11      PUSH    AF
000E3F 4E3F 2ADCF3          16      LD  HL,(CSRY)
000E42 4E42 7D               4      LD  A,L
000E43 4E43 6C               4      LD  L,H
000E44 4E44 67               4      LD  H,A
000E45 4E45 2C               4      INC L
000E46 4E46 24               4      INC H
000E47 4E47 F1              10      POP AF
000E48 4E48 C9              10      RET
                                
       4E49                     LOC:
000E49 4E49 F5              11      PUSH    AF
000E4A 4E4A E5              11      PUSH    HL
000E4B 4E4B 7D               4      LD  A,L
000E4C 4E4C 6C               4      LD  L,H
000E4D 4E4D 67               4      LD  H,A
000E4E 4E4E 2D               4      DEC L
000E4F 4E4F 25               4      DEC H
000E50 4E50 DDE5            15      PUSH    IX
000E52 4E52 DD21C600        14      LD  IX,POSIT
000E56 4E56 CDE142          17      CALL    CALSLT_R
000E59 4E59 DDE1            14      POP IX
000E5B 4E5B E1              10      POP HL
000E5C 4E5C F1              10      POP AF
000E5D 4E5D C9              10      RET
                                
       4E5E                     _SCRN:
       4E5E                     SCRN:
000E5E 4E5E E5              11      PUSH    HL
000E5F 4E5F DDE5            15      PUSH    IX
                                
000E61 4E61 69               4      LD  L,C
000E62 4E62 60               4      LD  H,B
000E63 4E63 DD214A00        14      LD  IX,RDVRM
000E67 4E67 CDE142          17      CALL    CALSLT_R
                                
000E6A 4E6A DDE1            14      POP IX
000E6C 4E6C E1              10      POP HL
000E6D 4E6D C9              10      RET
                                
       4E6E                     CTRL02:
000E6E 4E6E F5              11      PUSH    AF
000E6F 4E6F D5              11      PUSH    DE
000E70 4E70 2ADCF3          16      LD  HL,(CSRY)
000E73 4E73 3AB0F3          13      LD  A,(LINLEN)
000E76 4E76 4F               4      LD  C,A
000E77 4E77 94               4      SUB H   ;CSRX
000E78 4E78 C602             7      ADD A,2
000E7A 4E7A 47               4      LD  B,A ;カーソルより右の文字数
000E7B 4E7B 61               4      LD  H,C ;LINLEN
000E7C 4E7C C5              11      PUSH    BC
000E7D 4E7D CDCB4E          17      CALL    LOC0
000E80 4E80 C1              10      POP BC
                                
000E81 4E81 1620             7      LD  D,020H
       4E83                     C8X1:
000E83 4E83 DD214A00        14      LD  IX,RDVRM
000E87 4E87 CDE142          17      CALL    CALSLT_R
000E8A 4E8A 4F               4      LD  C,A
000E8B 4E8B 7A               4      LD  A,D
000E8C 4E8C DD214D00        14      LD  IX,WRTVRM
000E90 4E90 CDE142          17      CALL    CALSLT_R
000E93 4E93 2B               6      DEC HL
000E94 4E94 51               4      LD  D,C
000E95 4E95 10EC            13      DJNZ    C8X1
000E97 4E97 D1              10      POP DE
000E98 4E98 F1              10      POP AF
000E99 4E99 C9              10      RET
                                
       4E9A                     INSERT:
000E9A 4E9A F5              11      PUSH    AF
000E9B 4E9B D5              11      PUSH    DE
000E9C 4E9C 2ADCF3          16      LD  HL,(CSRY)
000E9F 4E9F 3AB0F3          13      LD  A,(LINLEN)
000EA2 4EA2 4F               4      LD  C,A
000EA3 4EA3 94               4      SUB H   ;CSRX
000EA4 4EA4 3C               4      INC A
000EA5 4EA5 47               4      LD  B,A ;カーソルより右の文字数
000EA6 4EA6 C5              11      PUSH    BC
000EA7 4EA7 CDCB4E          17      CALL    LOC0
000EAA 4EAA C1              10      POP BC
                                
000EAB 4EAB 1620             7      LD  D,020H
       4EAD                     INS1:
000EAD 4EAD DD214A00        14      LD  IX,RDVRM
000EB1 4EB1 CDE142          17      CALL    CALSLT_R
000EB4 4EB4 4F               4      LD  C,A
000EB5 4EB5 7A               4      LD  A,D
000EB6 4EB6 DD214D00        14      LD  IX,WRTVRM
000EBA 4EBA CDE142          17      CALL    CALSLT_R
000EBD 4EBD 23               6      INC HL
000EBE 4EBE 51               4      LD  D,C
000EBF 4EBF 10EC            13      DJNZ    INS1
000EC1 4EC1 D1              10      POP DE
000EC2 4EC2 F1              10      POP AF
000EC3 4EC3 C9              10      RET
                                
       4EC4                     CONOUT1:
000EC4 4EC4 59               4      LD  E,C
000EC5 4EC5 C3F84C          10      JP  _PRINT
                                
       4EC8                     GETVRAM:
000EC8 4EC8 2ADCF3          16      LD  HL,(CSRY)
       4ECB                     LOC0:
000ECB 4ECB 2D               4      DEC L
000ECC 4ECC 25               4      DEC H
000ECD 4ECD 4C               4      LD  C,H ;CSRX-1
000ECE 4ECE 5D               4      LD  E,L ;CSRY-1
       4ECF                     LOC1:
000ECF 4ECF 3AB0F3          13      LD  A,(LINLEN)
000ED2 4ED2 67               4      LD  H,A
000ED3 4ED3 1600             7      LD  D,0
000ED5 4ED5 6A               4      LD  L,D ;0
000ED6 4ED6 0608             7      LD  B,8
       4ED8                     LOC2:
000ED8 4ED8 29              11      ADD HL,HL
000ED9 4ED9 3001            12      JR  NC,LOC3
000EDB 4EDB 19              11      ADD HL,DE
       4EDC                     LOC3:
000EDC 4EDC 10FA            13      DJNZ    LOC2
000EDE 4EDE 09              11      ADD HL,BC
000EDF 4EDF C9              10      RET
                                
       4EE0                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000EE0 4EE0 212200          10      LD  HL,00022H
000EE3 4EE3 AF               4      XOR A
000EE4 4EE4 7D               4      LD  A,L
000EE5 4EE5 C9              10      RET
                                
       4EE6                     _SYS0D:     ;(BDOS)ディスク・リセット
000EE6 4EE6 218000          10      LD  HL,00080H
000EE9 4EE9 222EF1          16      LD  (_DTA),HL
000EEC 4EEC C9              10      RET
                                
       4EED                     _SYS0E:     ;(BDOS)カレントドライブの設定
000EED 4EED 3242F1          13      LD  (_DVSW),A
000EF0 4EF0 C9              10      RET
                                
       4EF1                     _SYS0F:     ;(BDOS)ファイルのオープン
000EF1 4EF1 D5              11      PUSH    DE
000EF2 4EF2 FDE1            14      POP IY
000EF4 4EF4 CD3A50          17      CALL    INIT_FILE
000EF7 4EF7 CD9748          17      CALL    ROM_OPEN
000EFA 4EFA 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
000EFC 4EFC FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
000F00 4F00 FDE5            15      PUSH    IY
000F02 4F02 D1              10      POP DE
000F03 4F03 13               6      INC DE
000F04 4F04 010B00          10      LD  BC,11
000F07 4F07 EDB0                    LDIR
                                ;               Attribute
000F09 4F09 7E               7      LD  A,(HL)
000F0A 4F0A FD770D          19      LD  (IY+13),A
                                ;               TIME
000F0D 4F0D 110B00          10      LD  DE,11
000F10 4F10 19              11      ADD HL,DE
000F11 4F11 7E               7      LD  A,(HL)
000F12 4F12 23               6      INC HL
000F13 4F13 FD7716          19      LD  (IY+22),A
000F16 4F16 7E               7      LD  A,(HL)
000F17 4F17 23               6      INC HL
000F18 4F18 FD7717          19      LD  (IY+23),A
                                ;               DATE
000F1B 4F1B 7E               7      LD  A,(HL)
000F1C 4F1C 23               6      INC HL
000F1D 4F1D FD7714          19      LD  (IY+20),A
000F20 4F20 7E               7      LD  A,(HL)
000F21 4F21 23               6      INC HL
000F22 4F22 FD7715          19      LD  (IY+21),A
                                ;               First cluster
000F25 4F25 7E               7      LD  A,(HL)
000F26 4F26 23               6      INC HL
000F27 4F27 FD771A          19      LD  (IY+26),A
000F2A 4F2A 7E               7      LD  A,(HL)
000F2B 4F2B 23               6      INC HL
000F2C 4F2C FD771B          19      LD  (IY+27),A
                                ;               SIZE
000F2F 4F2F 7E               7      LD  A,(HL)
000F30 4F30 23               6      INC HL
000F31 4F31 FD7710          19      LD  (IY+16),A
000F34 4F34 7E               7      LD  A,(HL)
000F35 4F35 23               6      INC HL
000F36 4F36 FD7711          19      LD  (IY+17),A
000F39 4F39 7E               7      LD  A,(HL)
000F3A 4F3A 23               6      INC HL
000F3B 4F3B FD7712          19      LD  (IY+18),A
000F3E 4F3E 7E               7      LD  A,(HL)
000F3F 4F3F FD7713          19      LD  (IY+19),A
000F42 4F42 AF               4      XOR A
000F43 4F43 FD770C          19      LD  (IY+12),A
000F46 4F46 C9              10      RET
                                
       4F47                     _SYS10:     ;(BDOS)ファイルのクローズ
000F47 4F47 AF               4      XOR A
000F48 4F48 C9              10      RET
                                
       4F49                     S11X1:
000F49 4F49 FD7119          19      LD  (IY+25),C       ;RootEntCnt
000F4C 4F4C FD750E          19      LD  (IY+14),L
000F4F 4F4F FD740F          19      LD  (IY+15),H
       4F52                     SCF_FF_RET:
000F52 4F52 37               4      SCF
000F53 4F53 9F               4      SBC A,A
000F54 4F54 C9              10      RET
                                
       4F55                     _SYS11:     ;(BDOS)最初のファイルの検索
000F55 4F55 ED5336F1        20      LD  (_FCB),DE
000F59 4F59 D5              11      PUSH    DE
000F5A 4F5A FDE1            14      POP IY
000F5C 4F5C CD3A50          17      CALL    INIT_FILE
000F5F 4F5F CDD34A          17      CALL    GET_DIR_DAT
       4F62                     S12X1:
000F62 4F62 CDB348          17      CALL    FILESE
000F65 4F65 30E2            12      JR  NC,S11X1
000F67 4F67 0D               4      DEC C
000F68 4F68 FD7119          19      LD  (IY+25),C       ;RootEntCnt
000F6B 4F6B 012000          10      LD  BC,32
000F6E 4F6E ED5B2EF1        20      LD  DE,(_DTA)
000F72 4F72 AF               4      XOR A
000F73 4F73 12               7      LD  (DE),A      ;ドライブ番号
000F74 4F74 13               6      INC DE
000F75 4F75 EDB0                    LDIR            ;ディレクトリエントリ
000F77 4F77 FD750E          19      LD  (IY+14),L
000F7A 4F7A FD740F          19      LD  (IY+15),H
000F7D 4F7D C9              10      RET
                                
       4F7E                     _SYS12:
000F7E 4F7E FD2A36F1        20      LD  IY,(_FCB)
000F82 4F82 FDE5            15      PUSH    IY
000F84 4F84 D1              10      POP DE
000F85 4F85 CD3A50          17      CALL    INIT_FILE
                                
000F88 4F88 FD6E0E          19      LD  L,(IY+14)
000F8B 4F8B FD660F          19      LD  H,(IY+15)
000F8E 4F8E FD4E19          19      LD  C,(IY+25)
000F91 4F91 18CF            12      JR  S12X1
                                
       4F93                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000F93 4F93 CDB94A          17      CALL    SET_FCB
000F96 4F96 CD874A          17      CALL    GETSEQ
000F99 4F99 CD744A          17      CALL    RB_READ
000F9C 4F9C E5              11      PUSH    HL
000F9D 4F9D CD944A          17      CALL    SETSEQ
000FA0 4FA0 E1              10      POP HL
       4FA1                     SREAD:
000FA1 4FA1 C601             7      ADD A,001H
000FA3 4FA3 D8              11      RET C
                                
000FA4 4FA4 7D               4      LD  A,L
000FA5 4FA5 D601             7      SUB 001H
000FA7 4FA7 9F               4      SBC A,A
000FA8 4FA8 E603             7      AND 3
000FAA 4FAA 1F               4      RRA
000FAB 4FAB C9              10      RET
                                
       4FAC                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000FAC 4FAC 210100          10      LD  HL,00001H
000FAF 4FAF AF               4      XOR A
000FB0 4FB0 C9              10      RET
                                
       4FB1                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000FB1 4FB1 3A42F1          13      LD  A,(_DVSW)
000FB4 4FB4 C9              10      RET
                                
       4FB5                     _SYS1A:     ;(BDOS)DTAの設定
000FB5 4FB5 ED532EF1        20      LD  (_DTA),DE
000FB9 4FB9 AF               4      XOR A
000FBA 4FBA C9              10      RET
                                
       4FBB                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000FBB 4FBB 010002          10      LD  BC,512
000FBE 4FBE 11C302          10      LD  DE,707
000FC1 4FC1 210000          10      LD  HL,0
000FC4 4FC4 DD2138F1        14      LD  IX,_BUF
000FC8 4FC8 FD2138F1        14      LD  IY,_BUF
000FCC 4FCC FD3600F9        19      LD  (IY+0),0F9H
000FD0 4FD0 3E02             7      LD  A,2
000FD2 4FD2 C9              10      RET
                                
       4FD3                     _SYS21:     ;(BDOS)ランダムな読み出し
000FD3 4FD3 CDB94A          17      CALL    SET_FCB
                                
000FD6 4FD6 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
000FD9 4FD9 FD6622          19      LD  H,(IY+34)
                                
000FDC 4FDC CD744A          17      CALL    RB_READ
000FDF 4FDF 18C0            12      JR  SREAD
                                
       4FE1                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
000FE1 4FE1 CDF14E          17      CALL    _SYS0F
000FE4 4FE4 D8              11      RET C
                                
000FE5 4FE5 D5              11      PUSH    DE      ;EX DE,IY
000FE6 4FE6 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000FE8 4FE8 CDA94A          17      CALL    GETSIZE
       4FEB                     _S24X1:
000FEB 4FEB FD7521          19      LD  (IY+33),L   ;(FCB)Random record
000FEE 4FEE FD7422          19      LD  (IY+34),H
000FF1 4FF1 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000FF5 4FF5 FDE3            23      EX  (SP),IY     ;
000FF7 4FF7 D1              10      POP DE      ;
                                
000FF8 4FF8 AF               4      XOR A
000FF9 4FF9 C9              10      RET
                                
       4FFA                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
000FFA 4FFA E5              11      PUSH    HL
000FFB 4FFB D5              11      PUSH    DE      ;EX DE,IY
000FFC 4FFC FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000FFE 4FFE CD874A          17      CALL    GETSEQ
001001 5001 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       5003                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001003 5003 CDB94A          17      CALL    SET_FCB
001006 5006 E5              11      PUSH    HL
001007 5007 FD6E21          19      LD  L,(IY+33)
00100A 500A FD6622          19      LD  H,(IY+34)
00100D 500D 2224F1          16      LD  (RR_LOW),HL
001010 5010 FD6E23          19      LD  L,(IY+35)
001013 5013 FD6624          19      LD  H,(IY+36)
001016 5016 2226F1          16      LD  (RR_HIGH),HL
001019 5019 E1              10      POP HL
00101A 501A CDB746          17      CALL    ROM_READ
00101D 501D ED5B24F1        20      LD  DE,(RR_LOW)
001021 5021 FD7321          19      LD  (IY+33),E
001024 5024 FD7222          19      LD  (IY+34),D
001027 5027 ED5B26F1        20      LD  DE,(RR_HIGH)
00102B 502B FD7323          19      LD  (IY+35),E
00102E 502E FD7224          19      LD  (IY+36),D
001031 5031 9F               4      SBC A,A
001032 5032 C9              10      RET
                                
       5033                     _SYS2F:
001033 5033 44               4      LD  B,H
001034 5034 2A2EF1          16      LD  HL,(_DTA)
001037 5037 C3124B          10      JP  DISKIO
                                
       503A                     INIT_FILE:
00103A 503A EB               4      EX  DE,HL
00103B 503B 114BF1          10      LD  DE,FDRV
00103E 503E 010C00          10      LD  BC,1+8+3
001041 5041 EDB0                    LDIR
001043 5043 CDA44C          17      CALL    GET_DISK_BANK_FDRV
001046 5046 320068          13      LD  (BANK1_SEL),A
001049 5049 C9              10      RET
                                
       504A                     ZERO_MEMORY_DE:
00104A 504A AF               4      XOR A
       504B                     FILL_MEMORY_DE:
00104B 504B 12               7      LD  (DE),A
00104C 504C 13               6      INC DE
00104D 504D 10FC            13      DJNZ    FILL_MEMORY_DE
00104F 504F C9              10      RET
                                
001050 5050                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 E54CFB4C2C4DE54C        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 E54CE54C314D724D        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 394DE54C8C4D204E        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 E04EE64EED4EF14E        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 474F554F7E4FE54C        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 934FE54CE54CE54C        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 AC4FB14FB54FBB4F        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 E54CE54CE54CE14F        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 FA4FE54CE54C0350        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 E54CE54C324EE54C        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 384EE54CE54C3350        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB8 5FB8 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 E54CE54CE54CE54C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
