                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       42B2                     CRUNCH  EQU 042B2H
       4C64                     FRMEVL  EQU 04C64H
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
                                ;PTRFIL EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
                                ;FILNAM EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
                                ;RSTMP  EQU 0FB03H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FEDA                     H_STKE  EQU 0FEDAH
                                
       FF43                     H_GONE  EQU 0FF43H
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                
       F0E9                     ISC EQU 0F0E9H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
[EOF:DEF.ASM:UTF_8]
                                
                                ;USE_RAM_BLOAD_S    EQU 1   ;先頭のコメントを外すとBLOAD,SでRAMを使う
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C3F34A          10      JP  DISKIO
000013 4013 C32A4B          10      JP  DSKCHG
000016 4016 C3804B          10      JP  GETDPB
000019 4019 C3654C          10      JP  CHOICE
00001C 401C C3694C          10      JP  DSKFMT
00001F 401F C36B4C          10      JP  DSKSTP
000022 4022 C36C4C          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C3694C          10      JP  DSKFMT
000029 4029 C36B4C          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3734C          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.1.3.0",0
            204449534B20524F    
            4D204C6974652076    
            302E312E332E3000    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 0180FF          10      LD  BC,-00080H
000109 4109 2A72F6          16      LD  HL,(MEMSIZ)
00010C 410C 09              11      ADD HL,BC
00010D 410D 2272F6          16      LD  (MEMSIZ),HL
000110 4110 2A74F6          16      LD  HL,(STKTOP)
000113 4113 09              11      ADD HL,BC
000114 4114 2274F6          16      LD  (STKTOP),HL
000117 4117 2180F0          10      LD  HL,0F080H
00011A 411A 1100F0          10      LD  DE,0F000H
00011D 411D 012000          10      LD  BC,00020H
000120 4120 EDB0                    LDIR
000122 4122 2180FF          10      LD  HL,-00080H
000125 4125 39              11      ADD HL,SP
000126 4126 2257F1          16      LD  (BASSTK),HL
000129 4129 ED7B57F1        20      LD  SP,(BASSTK)
                                
00012D 412D 3EFF             7      LD  A,0FFH
00012F 412F 3299FD          13      LD  (DEVICE),A
                                
000132 4132 3E01             7      LD  A,1
000134 4134 3221FB          13      LD  (DRVTBL),A
                                
000137 4137 AF               4      XOR A
000138 4138 3242F1          13      LD  (_DVSW),A
                                
00013B 413B 21ED42          10      LD  HL,AT_ISC
00013E 413E 11E9F0          10      LD  DE,ISC
000141 4141 017000          10      LD  BC,ISC_E-ISC
000144 4144 EDB0                    LDIR
                                    
000146 4146 3EC3             7      LD  A,0C3H      ;JP
000148 4148 3243FF          13      LD  (H_GONE),A
00014B 414B 327DF3          13      LD  (BDOS),A
00014E 414E 326BF3          13      LD  (RAMUSE),A
000151 4151 3268F3          13      LD  (ROMUSE),A
000154 4154 21E9F0          10      LD  HL,REPLACE_COMMAND
000157 4157 2244FF          16      LD  (H_GONE+1),HL
00015A 415A 2131F3          10      LD  HL,H_BDOS
00015D 415D 227EF3          16      LD  (BDOS+1),HL
000160 4160 2110F1          10      LD  HL,RAMUSE1
000163 4163 226CF3          16      LD  (RAMUSE+1),HL
000166 4166 210BF1          10      LD  HL,ROMUSE1
000169 4169 2269F3          16      LD  (ROMUSE+1),HL
                                
00016C 416C 3E                      DB  03EH
00016D 416D F7              12      RST 30H
00016E 416E 3271FE          13      LD  (H_BINS),A
000171 4171 3276FE          13      LD  (H_BINL),A
000174 4174 327BFE          13      LD  (H_FILE),A
000177 4177 3231F3          13      LD  (H_BDOS),A
00017A 417A 32DAFE          13      LD  (H_STKE),A
00017D 417D 32A7FF          13      LD  (H_PHYD),A
                                
000180 4180 CD3542          17      CALL    GTSL1_
000183 4183 32FCF0          13      LD  (ROM_SLT),A
000186 4186 3272FE          13      LD  (H_BINS+1),A
000189 4189 3277FE          13      LD  (H_BINL+1),A
00018C 418C 327CFE          13      LD  (H_FILE+1),A
00018F 418F 3232F3          13      LD  (H_BDOS+1),A
000192 4192 32DBFE          13      LD  (H_STKE+1),A
000195 4195 32A8FF          13      LD  (H_PHYD+1),A
000198 4198 3222FB          13      LD  (DRVTBL+1),A
00019B 419B 3248F3          13      LD  (MASTERS),A
                                
00019E 419E 210C45          10      LD  HL,ROM_LOAD
0001A1 41A1 2273FE          16      LD  (H_BINS+2),HL
0001A4 41A4 212746          10      LD  HL,ROM_RUN
0001A7 41A7 2278FE          16      LD  (H_BINL+2),HL
0001AA 41AA 213446          10      LD  HL,ROM_FILES
0001AD 41AD 227DFE          16      LD  (H_FILE+2),HL
0001B0 41B0 21BC4C          10      LD  HL,ROM_BDOS
0001B3 41B3 2233F3          16      LD  (H_BDOS+2),HL
0001B6 41B6 218743          10      LD  HL,ROM_STKE
0001B9 41B9 22DCFE          16      LD  (H_STKE+2),HL
0001BC 41BC 21F34A          10      LD  HL,DISKIO
0001BF 41BF 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001C2 41C2 3E                      DB  03EH
0001C3 41C3 C9              10      RET
0001C4 41C4 327FFE          13      LD  (H_FILE+4),A
0001C7 41C7 3275FE          13      LD  (H_BINS+4),A
0001CA 41CA 327AFE          13      LD  (H_BINL+4),A
0001CD 41CD 3235F3          13      LD  (H_BDOS+4),A
0001D0 41D0 32DEFE          13      LD  (H_STKE+4),A
0001D3 41D3 32ABFF          13      LD  (H_PHYD+4),A
                                
0001D6 41D6 AF               4      XOR A
0001D7 41D7 320068          13      LD  (BANK1_SEL),A
0001DA 41DA 3A0060          13      LD  A,(BANK1_ADR)
0001DD 41DD FE41             7      CP  'A'
0001DF 41DF 2043            12      JR  NZ,NOT_8K_BANK
0001E1 41E1 3E01             7      LD  A,DISK_BANK
0001E3 41E3 320068          13      LD  (BANK1_SEL),A
                                
0001E6 41E6 CD3801          17      CALL    RSLREG      ;read primary slot #
0001E9 41E9 07               4      RLCA
0001EA 41EA 07               4      RLCA
0001EB 41EB F5              11      PUSH    AF
0001EC 41EC CD3A42          17      CALL    GTSL2_
0001EF 41EF 3244F3          13      LD  (RAMAD3),A
0001F2 41F2 F1              10      POP AF  
0001F3 41F3 CD3A42          17      CALL    GTSL2_
0001F6 41F6 3243F3          13      LD  (RAMAD2),A
       41F9                     RAMCHK2:
0001F9 41F9 3A44F3          13      LD  A,(RAMAD3)
0001FC 41FC 2640             7      LD  H,040H
0001FE 41FE CD5142          17      CALL    CHK_RAM
000201 4201 3242F3          13      LD  (RAMAD1),A
       4204                     RAMCHK1:
000204 4204 3A44F3          13      LD  A,(RAMAD3)
000207 4207 2600             7      LD  H,00H
000209 4209 CD5142          17      CALL    CHK_RAM
00020C 420C 3241F3          13      LD  (RAMAD0),A
       420F                     RAMCHK0:
00020F 420F 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
000212 4212 010F00          10      LD  BC,0000FH       ;切り上げ
000215 4215 09              11      ADD HL,BC
000216 4216 7D               4      LD  A,L
                                
000217 4217 0604             7      LD  B,4
       4219                     B_DRIVE1:
000219 4219 CB3C             8      SRL H
00021B 421B 1F               4      RRA
00021C 421C 10FB            13      DJNZ    B_DRIVE1
                                
00021E 421E C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000220 4220 3241F1          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
000223 4223 C9              10      RET
                                
       4224                     NOT_8K_BANK:
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K等)
000224 4224 21D543          10      LD  HL,MSG_ERROR_ROM_MODE
000227 4227 CD6043          17      CALL    MSX
00022A 422A FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
00022E 422E DD219F00        14      LD  IX,CHGET
000232 4232 C31C00          10      JP  _CALSLT
                                
       4235                     GTSL1_:             ;自分のいるスロットを知る
000235 4235 CD3801          17      CALL    RSLREG      ;read primary slot #
000238 4238 0F               4      RRCA
000239 4239 0F               4      RRCA
       423A                     GTSL2_:
00023A 423A E603             7      AND 3       ;[A]=000000PP
00023C 423C 5F               4      LD  E,A     ;[E]=000000PP
00023D 423D 21C1FC          10      LD  HL,EXPTBL
000240 4240 85               4      ADD A,L     ;桁上りは無い
000241 4241 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000242 4242 7B               4      LD  A,E     ;[A]=000000PP
000243 4243 CB7E            13      BIT 7,(HL)
000245 4245 C8              11      RET Z
000246 4246 7D               4      LD  A,L     ;point to SLTTBL entry
000247 4247 C604             7      ADD A,4     ;桁上りは無い
000249 4249 6F               4      LD  L,A
00024A 424A 7E               7      LD  A,(HL)      ;get currently expansion slot register
00024B 424B E60C             7      AND 00CH        ;[A] = 0000SS00
00024D 424D B3               4      OR  E       ;[A] = 0000SSPP
00024E 424E F680             7      OR  080H        ;[A] = 1000SSPP
000250 4250 C9              10      RET
       4251                     GTSL1_E:
                                
       4251                     CHK_RAM:
000251 4251 E5              11      PUSH    HL
000252 4252 CDA642          17      CALL    CHK_RAM0
000255 4255 E1              10      POP HL
000256 4256 C8              11      RET Z
000257 4257 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
00025A 425A E680             7      AND 080H
00025C 425C CD7D42          17      CALL    CHK_RAM_SLT
00025F 425F C8              11      RET Z
000260 4260 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000263 4263 E680             7      AND 080H
000265 4265 C601             7      ADD A,1
000267 4267 CD7D42          17      CALL    CHK_RAM_SLT
00026A 426A C8              11      RET Z
00026B 426B 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00026E 426E E680             7      AND 080H
000270 4270 C602             7      ADD A,2
000272 4272 CD7D42          17      CALL    CHK_RAM_SLT
000275 4275 C8              11      RET Z
000276 4276 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000279 4279 E680             7      AND 080H
00027B 427B C603             7      ADD A,3
       427D                     CHK_RAM_SLT:
00027D 427D E5              11      PUSH    HL
00027E 427E CDA642          17      CALL    CHK_RAM0        ;スロット#X or X-0
000281 4281 E1              10      POP HL
000282 4282 C8              11      RET Z
000283 4283 CB79             8      BIT 7,C
000285 4285 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000287 4287 79               4      LD  A,C
000288 4288 C604             7      ADD A,4         ;スロット#X-1
00028A 428A E5              11      PUSH    HL
00028B 428B CDA642          17      CALL    CHK_RAM0
00028E 428E E1              10      POP HL
00028F 428F C8              11      RET Z
000290 4290 79               4      LD  A,C
000291 4291 C604             7      ADD A,4         ;スロット#X-2
000293 4293 E5              11      PUSH    HL
000294 4294 CDA642          17      CALL    CHK_RAM0
000297 4297 E1              10      POP HL
000298 4298 C8              11      RET Z
000299 4299 79               4      LD  A,C
00029A 429A C604             7      ADD A,4         ;スロット#X-3
00029C 429C E5              11      PUSH    HL
00029D 429D CDA642          17      CALL    CHK_RAM0
0002A0 42A0 E1              10      POP HL
       42A1                     CHK_RAM_E:
0002A1 42A1 AF               4      XOR A
0002A2 42A2 3C               4      INC A           ;ZF=0にする
0002A3 42A3 3E00             7      LD  A,0
0002A5 42A5 C9              10      RET
                                
       42A6                     CHK_RAM0:
0002A6 42A6 4F               4      LD  C,A
0002A7 42A7 3AFCF0          13      LD  A,(ROM_SLT)
0002AA 42AA B9               4      CP  C
0002AB 42AB 28F4            12      JR  Z,CHK_RAM_E
0002AD 42AD 2E00             7      LD  L,0
       42AF                     CHK_RAM1:
0002AF 42AF 79               4      LD  A,C
0002B0 42B0 DD210C00        14      LD  IX,_RDSLT
0002B4 42B4 CDE142          17      CALL    CALSLT_R
0002B7 42B7 C6E5             7      ADD A,0E5H
0002B9 42B9 47               4      LD  B,A
0002BA 42BA 5F               4      LD  E,A
0002BB 42BB 79               4      LD  A,C
0002BC 42BC DD211400        14      LD  IX,_WRSLT
0002C0 42C0 CDE142          17      CALL    CALSLT_R
0002C3 42C3 79               4      LD  A,C
0002C4 42C4 DD210C00        14      LD  IX,_RDSLT
0002C8 42C8 CDE142          17      CALL    CALSLT_R
0002CB 42CB B8               4      CP  B
0002CC 42CC C0              11      RET NZ
0002CD 42CD D6E5             7      SUB 0E5H
0002CF 42CF 79               4      LD  A,C
0002D0 42D0 5F               4      LD  E,A
0002D1 42D1 DD211400        14      LD  IX,_WRSLT
0002D5 42D5 CDE142          17      CALL    CALSLT_R
0002D8 42D8 24               4      INC H
0002D9 42D9 7D               4      LD  A,L
0002DA 42DA C604             7      ADD A,4
0002DC 42DC 6F               4      LD  L,A
0002DD 42DD 20D0            12      JR  NZ,CHK_RAM1
0002DF 42DF 79               4      LD  A,C     ;ZF=1のハズ
0002E0 42E0 C9              10      RET
                                
       42E1                     CALSLT_R:
0002E1 42E1 C5              11      PUSH    BC
0002E2 42E2 E5              11      PUSH    HL
0002E3 42E3 FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
0002E7 42E7 CD1C00          17      CALL    _CALSLT
0002EA 42EA E1              10      POP HL
0002EB 42EB C1              10      POP BC
0002EC 42EC C9              10      RET
                                
       42ED                     AT_ISC:
0002ED F0E9                         ORG ISC,AT_ISC-RUN
       F0E9                     REPLACE_COMMAND:
0002ED F0E9 FEB7             7      CP  0B7H            ;FILES
0002EF F0EB CC7BFE          17      CALL    Z,H_FILE
0002F2 F0EE FEB5             7      CP  0B5H            ;LOAD
0002F4 F0F0 CA71FE          10      JP  Z,H_BINS
0002F7 F0F3 FE8A             7      CP  08AH            ;RUN
0002F9 F0F5 CA76FE          10      JP  Z,H_BINL
0002FC F0F8 FECF             7      CP  0CFH            ;BLOAD
0002FE F0FA C0              11      RET NZ
       F0FB                     FIX_BLOAD:
0002FF F0FB F7              12      RST 30H
       F0FC                     ROM_SLT:
000300 F0FC 00                      DB  0
000301 F0FD 6945                    DW  ROM_BLOAD
000303 F0FF F5              11      PUSH    AF
000304 F100 E5              11      PUSH    HL
000305 F101 CD0AF1          17      CALL    BLOAD_RET
       F102                     SWC_BLOAD   EQU $-2
000308 F104 E1              10      POP HL
000309 F105 F1              10      POP AF
00030A F106 FECF             7      CP  0CFH            ;BLOAD
       F108                     SWC_BLOAD_M:
00030C F108 28DF            12      JR  Z,REPLACE_COMMAND
       F10A                     BLOAD_RET:
00030E F10A C9              10      RET
       F10B                     ROMUSE1:
00030F F10B 3AFCF0          13      LD  A,(ROM_SLT)
000312 F10E 1803            12      JR  ROMUSE2
       F110                     RAMUSE1:
000314 F110 3A42F3          13      LD  A,(RAMAD1)
       F113                     ROMUSE2:
000317 F113 DD212400        14      LD  IX,_ENASLT
00031B F117 FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
00031F F11B C31C00          10      JP  _CALSLT
                                
       F11E                     _RESULT:
000322 F11E 00                      DB  0
       F11F                     _BANK:
000323 F11F 00                      DB  0
       F120                     CLSZ:               ;クラスタサイズ
000324 F120 0004                    DW  1024
       F121                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F122                     SECSZ:              ;セクタサイズ
000326 F122 0002                    DW  512
       F123                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F124                     RR_LOW:
000328 F124 0000                    DW  0
       F125                     RR_MID  EQU $-1
       F126                     RR_HIGH:
00032A F126 0000                    DW  0
       F128                     _CLPS:
00032C F128 0000                    DW  0
       F12A                     _LEFT:
00032E F12A 0000                    DW  0
       F12C                     _DTPS:
000330 F12C 0000                    DW  0
       F12E                     _DTA:
000332 F12E 0000                    DW  0
                                #if exists USE_RAM_BLOAD_S
                                #else
       F130                     FLG_LDIR:
000334 F130 00                      DB  0
                                #endif
                                ;   BDOS
000335 F131 F7              12      RST 30H
000336 F132 00                      DB  0
000337 F133 BC4C                    DW  ROM_BDOS
000339 F135 C9              10      RET 
       F136                     _FCB:
00033A F136 0000                    DW  0
       F138                     _BUF:
00033C F138 00                      DB  0
       F139                     _BUF_ST:
00033D F139 0000                    DW  0
       F13B                     _BUF_EN:
00033F F13B 0000                    DW  0
       F13D                     _BUF_EX:
000341 F13D 0000                    DW  0
                                
       F13F                     DTAX:
000343 F13F 0000                    DW  0
       F141                     B_DRIVE:
000345 F141 00                      DB  0
       F142                     _DVSW:
000346 F142 00                      DB  0
       F143                     FCBX:
000347 F143 0000                    DW  0
       F145                     LEFTX:
000349 F145 0000                    DW  0
       F147                     PARAM0:
00034B F147 0000                    DW  0
       F149                     PARAM1:
00034D F149 0000                    DW  0
       F14B                     FDRV:
00034F F14B 00                      DB  0
       F14C                     FNAME:
000350 F14C                         DS  8+3
                                
00035B F157 0000                BASSTK  DW  0
                                
       F159                     ISC_E:
00035D 435D                         ORG $$+RUN          ;$DEPHASE
                                
       435D                     MSX1:
00035D 435D CDD54C          17      CALL    MSGA1
       4360                     MSX:
000360 4360 7E               7      LD  A,(HL)
000361 4361 23               6      INC HL
000362 4362 B7               4      OR  A
000363 4363 20F8            12      JR  NZ,MSX1
000365 4365 C9              10      RET
                                
       4366                     PRTHX:
000366 4366 F5              11      PUSH    AF
000367 4367 07               4      RLCA
000368 4368 07               4      RLCA
000369 4369 07               4      RLCA
00036A 436A 07               4      RLCA
00036B 436B CD6F43          17      CALL    PRTA2
00036E 436E F1              10      POP AF
       436F                     PRTA2:
00036F 436F CD7543          17      CALL    ASC
000372 4372 C3D14C          10      JP  MSG_A
                                    
       4375                     ASC:
000375 4375 E60F             7      AND $0F
000377 4377 F630             7      OR  $30
000379 4379 FE3A             7      CP  $3A
00037B 437B D8              11      RET C
00037C 437C C607             7      ADD A,7
00037E 437E C9              10      RET
                                
       437F                     MSN:
00037F 437F 7E               7      LD  A,(HL)
000380 4380 23               6      INC HL
000381 4381 CDD14C          17      CALL    MSG_A
000384 4384 10F9            13      DJNZ    MSN
000386 4386 C9              10      RET
                                
       4387                     ROM_STKE:
000387 4387 3E                      DB  03EH
000388 4388 C9              10      RET
000389 4389 32DAFE          13      LD  (H_STKE),A
00038C 438C E5              11      PUSH    HL
00038D 438D D5              11      PUSH    DE
00038E 438E C5              11      PUSH    BC
00038F 438F 181D            12      JR  BASAUTO
                                
000391 4391 AF               4      XOR A
000392 4392 5F               4      LD  E,A
000393 4393 57               4      LD  D,A
000394 4394 0601             7      LD  B,1
000396 4396 2100C0          10      LD  HL,0C000H
000399 4399 CDF34A          17      CALL    DISKIO
                                
00039C 439C ED7357F1        20      LD  (BASSTK),SP
0003A0 43A0 116BF3          10      LD  DE,RAMUSE
0003A3 43A3 AF               4      XOR A
0003A4 43A4 CD1EC0          17      CALL    0C01EH
0003A7 43A7 116BF3          10      LD  DE,RAMUSE
0003AA 43AA 37               4      SCF
0003AB 43AB CD1EC0          17      CALL    0C01EH
       43AE                     BASAUTO:
0003AE 43AE 21F043          10      LD  HL,AUTOEXEC
0003B1 43B1 114BF1          10      LD  DE,FDRV
0003B4 43B4 010C00          10      LD  BC,1+8+3
0003B7 43B7 EDB0                    LDIR
0003B9 43B9 CD9248          17      CALL    ROM_OPEN
0003BC 43BC 3813            12      JR  C,RSTKEE
0003BE 43BE 21FC43          10      LD  HL,RUN_AUTOEXEC
0003C1 43C1 11F0FB          10      LD  DE,KEYBUF
0003C4 43C4 ED53FAF3        20      LD  (GETPNT),DE
0003C8 43C8 011300          10      LD  BC,RUN_AUTOEXEC_E-RUN_AUTOEXEC
0003CB 43CB EDB0                    LDIR
0003CD 43CD ED53F8F3        20      LD  (PUTPNT),DE
       43D1                     RSTKEE:
0003D1 43D1 C1              10      POP BC
0003D2 43D2 D1              10      POP DE
0003D3 43D3 E1              10      POP HL
0003D4 43D4 C9              10      RET
                                
       43D5                     MSG_ERROR_ROM_MODE:
0003D5 43D5 41534349492D384B        DB  "ASCII-8K/Konami-8K only!",13,10
            2F4B6F6E616D692D    
            384B206F6E6C7921    
            0D0A                
       43EF                     NULL:
0003EF 43EF 00                      DB  0
                                
       43F0                     AUTOEXEC:
0003F0 43F0 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       43FC                     RUN_AUTOEXEC:
0003FC 43FC 52554E2022415554        DB  'RUN "AUTOEXEC.BAS"',00DH
            4F455845432E4241    
            53220D              
                                ;   DB  'LOAD "AUTOEXEC.BAS"',00DH  ;テスト用
       440F                     RUN_AUTOEXEC_E:
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       440F                     ROM_LDIR:
                                #if exists USE_RAM_BLOAD_S
                                #else
00040F 440F 3A30F1          13      LD  A,(FLG_LDIR)
000412 4412 B7               4      OR  A
000413 4413 2007            12      JR  NZ,ROM_LDIRVM
                                #endif
000415 4415 CB7A             8      BIT 7,D
000417 4417 2815            12      JR  Z,ROM_LDIRSLT
000419 4419 EDB0                    LDIR
00041B 441B C9              10      RET
                                
                                #if exists USE_RAM_BLOAD_S
                                #else
       441C                     ROM_LDIRVM:
00041C 441C C5              11      PUSH    BC
00041D 441D D5              11      PUSH    DE
00041E 441E FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
000422 4422 DD215C00        14      LD  IX,LDIRVM
000426 4426 CD1C00          17      CALL    _CALSLT
000429 4429 E1              10      POP HL
00042A 442A C1              10      POP BC
00042B 442B 09              11      ADD HL,BC
00042C 442C EB               4      EX  DE,HL
00042D 442D C9              10      RET
                                #endif
                                
       442E                     ROM_LDIRSLT:
00042E 442E EB               4      EX  DE,HL
       442F                     RLDIRSLT1:
00042F 442F 1A               7      LD  A,(DE)
000430 4430 13               6      INC DE
000431 4431 C5              11      PUSH    BC
000432 4432 D5              11      PUSH    DE
000433 4433 E5              11      PUSH    HL
000434 4434 5F               4      LD  E,A
000435 4435 3A42F3          13      LD  A,(RAMAD1)
000438 4438 FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
00043C 443C DD211400        14      LD  IX,_WRSLT
000440 4440 CD1C00          17      CALL    _CALSLT
000443 4443 E1              10      POP HL
000444 4444 D1              10      POP DE
000445 4445 C1              10      POP BC
000446 4446 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
000448 4448 EA2F44          10      JP  PE,RLDIRSLT1
00044B 444B EB               4      EX  DE,HL
00044C 444C C9              10      RET
                                
       444D                     END_OF_LINE:
00044D 444D 215EF5          10      LD  HL,BUF
       4450                     EOL1:
000450 4450 7E               7      LD  A,(HL)
000451 4451 C8              11      RET Z
000452 4452 FE0D             7      CP  00DH
000454 4454 2807            12      JR  Z,EOLE
000456 4456 FE0A             7      CP  00AH
000458 4458 2803            12      JR  Z,EOLE
00045A 445A 23               6      INC HL
00045B 445B 18F3            12      JR  EOL1
       445D                     EOLE:
00045D 445D 3600            10      LD  (HL),0
00045F 445F 23               6      INC HL
000460 4460 7E               7      LD  A,(HL)
000461 4461 FE0A             7      CP  00AH
000463 4463 C0              11      RET NZ
000464 4464 23               6      INC HL
000465 4465 C9              10      RET
                                
       4466                     ROM_LOAD_ASCII:
000466 4466 210000          10      LD  HL,0
000469 4469 2239F1          16      LD  (_BUF_ST),HL    ;読み出し位置
00046C 446C 2A76F6          16      LD  HL,(TXTTAB)
00046F 446F 223BF1          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
000472 4472 215EF5          10      LD  HL,BUF
000475 4475 222EF1          16      LD  (_DTA),HL
       4478                     RLOAD_A1:
000478 4478 2A39F1          16      LD  HL,(_BUF_ST)
00047B 447B 2224F1          16      LD  (RR_LOW),HL
00047E 447E 210201          10      LD  HL,258
000481 4481 CDB246          17      CALL    ROM_READ
000484 4484 7C               4      LD  A,H
000485 4485 B5               4      OR  L
000486 4486 2877            12      JR  Z,RLOAD_AEND
000488 4488 015EF5          10      LD  BC,BUF
00048B 448B 09              11      ADD HL,BC
00048C 448C 3600            10      LD  (HL),0
00048E 448E CD4D44          17      CALL    END_OF_LINE
000491 4491 015EF5          10      LD  BC,BUF
000494 4494 A7               4      AND A
000495 4495 ED42            15      SBC HL,BC
000497 4497 2810            12      JR  Z,RLOAD_A2
000499 4499 4D               4      LD  C,L
00049A 449A 44               4      LD  B,H
00049B 449B ED5B39F1        20      LD  DE,(_BUF_ST)
00049F 449F 19              11      ADD HL,DE
0004A0 44A0 2239F1          16      LD  (_BUF_ST),HL
0004A3 44A3 3A5EF5          13      LD  A,(BUF)
0004A6 44A6 B7               4      OR  A
0004A7 44A7 28CF            12      JR  Z,RLOAD_A1
       44A9                     RLOAD_A2:
0004A9 44A9 115EF5          10      LD  DE,BUF
0004AC 44AC CD2948          17      CALL    SPCUTEX
0004AF 44AF 1A               7      LD  A,(DE)
0004B0 44B0 B7               4      OR  A
0004B1 44B1 284C            12      JR  Z,RLOAD_AEND
0004B3 44B3 CD3B48          17      CALL    GETNUM
0004B6 44B6 7C               4      LD  A,H
0004B7 44B7 B5               4      OR  L
0004B8 44B8 CA5645          10      JP  Z,ERROR_DIRECT_IN_FILE
0004BB 44BB DD2A3BF1        20      LD  IX,(_BUF_EN)
0004BF 44BF DD7502          19      LD  (IX+2),L
0004C2 44C2 DD7403          19      LD  (IX+3),H
                                
0004C5 44C5 CD2248          17      CALL    SPCUT
0004C8 44C8 EB               4      EX  DE,HL
0004C9 44C9 DDE5            15      PUSH    IX
0004CB 44CB DD21B242        14      LD  IX,CRUNCH
0004CF 44CF FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
0004D3 44D3 CD1C00          17      CALL    _CALSLT
0004D6 44D6 DDE1            14      POP IX
0004D8 44D8 EB               4      EX  DE,HL
0004D9 44D9 111FF4          10      LD  DE,KBUF
0004DC 44DC 37               4      SCF
0004DD 44DD ED52            15      SBC HL,DE
0004DF 44DF 2875            12      JR  Z,ERROR_DIRECT_IN_FILE
0004E1 44E1 3873            12      JR  C,ERROR_DIRECT_IN_FILE
0004E3 44E3 4D               4      LD  C,L
0004E4 44E4 44               4      LD  B,H
0004E5 44E5 2A3BF1          16      LD  HL,(_BUF_EN)
0004E8 44E8 110400          10      LD  DE,4
0004EB 44EB 19              11      ADD HL,DE
0004EC 44EC 111FF4          10      LD  DE,KBUF
                                
0004EF 44EF EB               4      EX  DE,HL
0004F0 44F0 EDB0                    LDIR
0004F2 44F2 EB               4      EX  DE,HL
                                
0004F3 44F3 DD7500          19      LD  (IX+0),L
0004F6 44F6 DD7401          19      LD  (IX+1),H
0004F9 44F9 223BF1          16      LD  (_BUF_EN),HL
0004FC 44FC C37844          10      JP  RLOAD_A1
                                
       44FF                     RLOAD_AEND:
0004FF 44FF 2A3BF1          16      LD  HL,(_BUF_EN)
000502 4502 AF               4      XOR A
000503 4503 77               7      LD  (HL),A
000504 4504 23               6      INC HL
000505 4505 77               7      LD  (HL),A
000506 4506 23               6      INC HL
000507 4507 223BF1          16      LD  (_BUF_EN),HL
00050A 450A 1833            12      JR  RLOAD_END1
                                
       450C                     ROM_LOAD:
00050C 450C CD8746          17      CALL    INIT_PARAM
00050F 450F CD5247          17      CALL    FILE_B
000512 4512 CD9248          17      CALL    ROM_OPEN
000515 4515 3845            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000517 4517 2138F1          10      LD  HL,_BUF
00051A 451A 222EF1          16      LD  (_DTA),HL
00051D 451D 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
000520 4520 CDB246          17      CALL    ROM_READ
000523 4523 3A38F1          13      LD  A,(_BUF)
000526 4526 3C               4      INC A
000527 4527 C26644          10      JP  NZ,ROM_LOAD_ASCII
00052A 452A 2A76F6          16      LD  HL,(TXTTAB)
00052D 452D 222EF1          16      LD  (_DTA),HL
000530 4530 EB               4      EX  DE,HL
000531 4531 2100FF          10      LD  HL,-256
000534 4534 39              11      ADD HL,SP
000535 4535 ED52            15      SBC HL,DE
000537 4537 CDB246          17      CALL    ROM_READ
00053A 453A ED5B2EF1        20      LD  DE,(_DTA)
00053E 453E 19              11      ADD HL,DE
       453F                     RLOAD_END1:
00053F 453F 22C2F6          16      LD  (VARTAB),HL
000542 4542 22C4F6          16      LD  (ARYTAB),HL
000545 4545 22C6F6          16      LD  (STREND),HL
                                
000548 4548 AF               4      XOR A
000549 4549 213BF1          10      LD  HL,_BUF+3
00054C 454C 77               7      LD  (HL),A
00054D 454D 2B               6      DEC HL
00054E 454E 77               7      LD  (HL),A
00054F 454F 2B               6      DEC HL
000550 4550 77               7      LD  (HL),A
000551 4551 2B               6      DEC HL
000552 4552 3E8F             7      LD  A,08FH          ;REM
000554 4554 77               7      LD  (HL),A
000555 4555 C9              10      RET
                                
       4556                     ERROR_DIRECT_IN_FILE:
000556 4556 1E39             7      LD  E,57            ;Direct statement in file
000558 4558 01                      DB  1           ;LD BC,
       4559                     ERROR_FILE_NOT_OPEN:
000559 4559 1E3B             7      LD  E,59            ;File not OPEN
00055B 455B 01                      DB  1           ;LD BC,
       455C                     ERROR_FILE_NOT_FOUND:
00055C 455C 1E35             7      LD  E,53            ;File not found
       455E                     ERROR:
00055E 455E FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
000562 4562 DD216F40        14      LD  IX,ERRHAND
000566 4566 C31C00          10      JP  _CALSLT
                                
       4569                     ROM_BLOAD:
000569 4569 CD8746          17      CALL    INIT_PARAM
00056C 456C CD5247          17      CALL    FILE_B
00056F 456F CD9248          17      CALL    ROM_OPEN
000572 4572 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000574 4574 2138F1          10      LD  HL,_BUF
000577 4577 222EF1          16      LD  (_DTA),HL
00057A 457A 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
00057D 457D CDB246          17      CALL    ROM_READ
000580 4580 3A38F1          13      LD  A,(_BUF)
000583 4583 FEFE             7      CP  0FEH
000585 4585 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
000587 4587 210AF1          10      LD  HL,BLOAD_RET
00058A 458A 2202F1          16      LD  (SWC_BLOAD),HL
                                
00058D 458D 2A49F1          16      LD  HL,(PARAM1)
000590 4590 7E               7      LD  A,(HL)
000591 4591 FE2C             7      CP  ','
000593 4593 2048            12      JR  NZ,RBREAD_MEM
000595 4595 23               6      INC HL
000596 4596 7E               7      LD  A,(HL)
000597 4597 CD7C48          17      CALL    CAP
00059A 459A 32BEFC          13      LD  (RUNBNF),A
       459D                     RBOS1:
00059D 459D 7E               7      LD  A,(HL)
00059E 459E 23               6      INC HL
00059F 459F B7               4      OR  A
0005A0 45A0 282F            12      JR  Z,RBREAD_OSE
0005A2 45A2 FE3A             7      CP  ':'
0005A4 45A4 282B            12      JR  Z,RBREAD_OSE
0005A6 45A6 FE2C             7      CP  ','     ;次のパラメータを探す
0005A8 45A8 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
0005AA 45AA 2249F1          16      LD  (PARAM1),HL
0005AD 45AD 7E               7      LD  A,(HL)
0005AE 45AE B7               4      OR  A
0005AF 45AF 2820            12      JR  Z,RBREAD_OSE
0005B1 45B1 DD21644C        14      LD  IX,FRMEVL
0005B5 45B5 FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
0005B9 45B9 CD1C00          17      CALL    _CALSLT
0005BC 45BC 2249F1          16      LD  (PARAM1),HL
0005BF 45BF 3A63F6          13      LD  A,(VALTYP)
0005C2 45C2 FE02             7      CP  2
0005C4 45C4 200B            12      JR  NZ,RBREAD_OSE
0005C6 45C6 2A39F1          16      LD  HL,(_BUF_ST)
0005C9 45C9 ED5BF8F7        20      LD  DE,(DACDAT)
0005CD 45CD 19              11      ADD HL,DE
0005CE 45CE 2239F1          16      LD  (_BUF_ST),HL
       45D1                     RBREAD_OSE:
0005D1 45D1 3ABEFC          13      LD  A,(RUNBNF)
0005D4 45D4 FE53             7      CP  'S'
                                #if exists USE_RAM_BLOAD_S
                                    JR  Z,ROM_BLOAD_SCREEN
                                #else
0005D6 45D6 2005            12      JR  NZ,RBREAD_MEM
0005D8 45D8 3E01             7      LD  A,1
0005DA 45DA 3230F1          13      LD  (FLG_LDIR),A
                                #endif
       45DD                     RBREAD_MEM:
0005DD 45DD 2A39F1          16      LD  HL,(_BUF_ST)
0005E0 45E0 22BFFC          16      LD  (SAVENT),HL
0005E3 45E3 222EF1          16      LD  (_DTA),HL
0005E6 45E6 21FFFF          10      LD  HL,0FFFFH
0005E9 45E9 CDB246          17      CALL    ROM_READ
0005EC 45EC 3ABEFC          13      LD  A,(RUNBNF)
0005EF 45EF FE52             7      CP  'R'
0005F1 45F1 2006            12      JR  NZ,RBREAD1
0005F3 45F3 2A3DF1          16      LD  HL,(_BUF_EX)
0005F6 45F6 2202F1          16      LD  (SWC_BLOAD),HL
       45F9                     RBREAD1:
       45F9                     ROM_NEXT:
0005F9 45F9 2A49F1          16      LD  HL,(PARAM1)
0005FC 45FC 7E               7      LD  A,(HL)
0005FD 45FD 2B               6      DEC HL
0005FE 45FE B7               4      OR  A
0005FF 45FF 2805            12      JR  Z,RN1
000601 4601 FE3A             7      CP  ':'
000603 4603 2801            12      JR  Z,RN1
000605 4605 23               6      INC HL
       4606                     RN1:
000606 4606 5D               4      LD  E,L
000607 4607 54               4      LD  D,H
                                
000608 4608 CD5248          17      CALL    SEARCH_END
00060B 460B B7               4      OR  A
00060C 460C 2815            12      JR  Z,REM
                                                    ;マルチステートメントの処理
00060E 460E 7E               7      LD  A,(HL)
                                
00060F 460F FEB5             7      CP  0B5H            ;LOAD
000611 4611 CA0C45          10      JP  Z,ROM_LOAD
000614 4614 FE8A             7      CP  08AH            ;RUN
000616 4616 280F            12      JR  Z,ROM_RUN
000618 4618 FEB7             7      CP  0B7H            ;FILES
00061A 461A 2818            12      JR  Z,ROM_FILES
00061C 461C 3E28             7      LD  A,028H          ;JR Z,
00061E 461E 3208F1          13      LD  (SWC_BLOAD_M),A
000621 4621 7E               7      LD  A,(HL)
000622 4622 C9              10      RET
                                
       4623                     REM:
000623 4623 EB               4      EX  DE,HL
000624 4624 3E8F             7      LD  A,08FH          ;REM
000626 4626 C9              10      RET
                                
                                #if exists USE_RAM_BLOAD_S
                                ROM_BLOAD_SCREEN:
                                    LD  HL,(STREND)
                                    LD  (_DTA),HL
                                    EX  DE,HL
                                    LD  HL,-512
                                    ADD HL,SP
                                    XOR A
                                    SBC HL,DE
                                    JR  NC,RBS0
                                    LD  HL,BUF
                                    LD  (_DTA),HL
                                    LD  L,A ;0
                                    LD  H,A ;0
                                RBS0:
                                    INC H
                                    LD  (_BUF_EN),HL
                                RBS1:
                                    LD  HL,(_BUF_EN)
                                    CALL    ROM_READ
                                    LD  A,H
                                    OR  L
                                    JR  Z,ROM_NEXT
                                
                                    PUSH    HL
                                    LD  C,L
                                    LD  B,H
                                    LD  HL,(_DTA)   ;転送元
                                    LD  DE,(_BUF_ST)    ;転送先
                                
                                    LD  IY,(EXPTBL) ;メインROMスロット
                                    LD  IX,LDIRVM
                                    CALL    _CALSLT
                                
                                    LD  HL,(_BUF_ST)
                                    POP DE
                                    ADD HL,DE
                                    LD  (_BUF_ST),HL
                                    JR  RBS1
                                #endif
                                
       4627                     ROM_RUN:
000627 4627 23               6      INC HL
000628 4628 7E               7      LD  A,(HL)
000629 4629 2B               6      DEC HL
00062A 462A B7               4      OR  A
00062B 462B 2803            12      JR  Z,ROM_RUN1
00062D 462D CD0C45          17      CALL    ROM_LOAD
       4630                     ROM_RUN1:
000630 4630 3E8A             7      LD  A,08AH          ;RUN
000632 4632 77               7      LD  (HL),A
000633 4633 C9              10      RET
                                
       4634                     ROM_FILES:
000634 4634 CD8746          17      CALL    INIT_PARAM
000637 4637 CD5247          17      CALL    FILE_B
00063A 463A CD774C          17      CALL    GET_DISK_BANK_FDRV
00063D 463D 320068          13      LD  (BANK1_SEL),A
000640 4640 3A4CF1          13      LD  A,(FNAME)
000643 4643 FE21             7      CP  021H
000645 4645 3005            12      JR  NC,RFILES0
000647 4647 060B             7      LD  B,11
000649 4649 CDE647          17      CALL    FILE10
       464C                     RFILES0:
00064C 464C CDBA4A          17      CALL    GET_DIR_DAT
       464F                     RFILES1:
00064F 464F CDAE48          17      CALL    FILESE
000652 4652 302E            12      JR  NC,RFILES_NOT_MATCH
       4654                     RFILES_DISP:
000654 4654 E5              11      PUSH    HL
000655 4655 0608             7      LD  B,8
000657 4657 CD7F43          17      CALL    MSN
00065A 465A 3E2E             7      LD  A,'.'
00065C 465C CDD14C          17      CALL    MSG_A
00065F 465F 0603             7      LD  B,3
000661 4661 CD7F43          17      CALL    MSN
000664 4664 3ADDF3          13      LD  A,(CSRX)
000667 4667 47               4      LD  B,A
000668 4668 3AB0F3          13      LD  A,(LINLEN)
00066B 466B 90               4      SUB B
00066C 466C FE0C             7      CP  12
00066E 466E 3009            12      JR  NC,RFILES2
000670 4670 3E0D             7      LD  A,00DH      ;改行
000672 4672 CDD14C          17      CALL    MSG_A
000675 4675 3E0A             7      LD  A,00AH
000677 4677 1802            12      JR  RFILES3
       4679                     RFILES2:
000679 4679 3E20             7      LD  A,020H
       467B                     RFILES3:
00067B 467B CDD14C          17      CALL    MSG_A
00067E 467E E1              10      POP HL
00067F 467F CDCA48          17      CALL    FNEXT
       4682                     RFILES_NOT_MATCH:
000682 4682 20CB            12      JR  NZ,RFILES1
000684 4684 C3F945          10      JP  ROM_NEXT
                                
       4687                     INIT_PARAM:
000687 4687 2247F1          16      LD  (PARAM0),HL
00068A 468A 2249F1          16      LD  (PARAM1),HL
00068D 468D EB               4      EX  DE,HL
00068E 468E AF               4      XOR A
                                #if exists USE_RAM_BLOAD_S
                                #else
00068F 468F 3230F1          13      LD  (FLG_LDIR),A
                                #endif
000692 4692 32BEFC          13      LD  (RUNBNF),A
000695 4695 3263F6          13      LD  (VALTYP),A
000698 4698 13               6      INC DE
000699 4699 CD2248          17      CALL    SPCUT
00069C 469C 1A               7      LD  A,(DE)
00069D 469D B7               4      OR  A
00069E 469E C8              11      RET Z
00069F 469F FE3A             7      CP  ':'
0006A1 46A1 C8              11      RET Z
0006A2 46A2 EB               4      EX  DE,HL
0006A3 46A3 DD21644C        14      LD  IX,FRMEVL
0006A7 46A7 FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
0006AB 46AB CD1C00          17      CALL    _CALSLT
0006AE 46AE 2249F1          16      LD  (PARAM1),HL
0006B1 46B1 C9              10      RET
                                
       46B2                     ROM_READ:
0006B2 46B2 E5              11      PUSH    HL
0006B3 46B3 D5              11      PUSH    DE
0006B4 46B4 C5              11      PUSH    BC
0006B5 46B5 FDE5            15      PUSH    IY
0006B7 46B7 2245F1          16      LD  (LEFTX),HL
0006BA 46BA 2A2EF1          16      LD  HL,(_DTA)
0006BD 46BD 223FF1          16      LD  (DTAX),HL
0006C0 46C0 2A45F1          16      LD  HL,(LEFTX)
                                
0006C3 46C3 CDF648          17      CALL    RBX1
0006C6 46C6 3870            12      JR  C,RBRERR1
0006C8 46C8 79               4      LD  A,C
0006C9 46C9 EB               4      EX  DE,HL
0006CA 46CA ED52            15      SBC HL,DE       ;CP 0HL,CDE
0006CC 46CC 19              11      ADD HL,DE
0006CD 46CD DE00             7      SBC A,000H
0006CF 46CF 3801            12      JR  C,RBR1
0006D1 46D1 EB               4      EX  DE,HL
       46D2                     RBR1:
0006D2 46D2 9F               4      SBC A,A
0006D3 46D3 E601             7      AND 1
0006D5 46D5 321EF1          13      LD  (_RESULT),A
0006D8 46D8 7C               4      LD  A,H
0006D9 46D9 B5               4      OR  L
0006DA 46DA CA2E47          10      JP  Z,RBREND0
                                
0006DD 46DD 222AF1          16      LD  (_LEFT),HL  ;Read record byte
0006E0 46E0 2245F1          16      LD  (LEFTX),HL
                                
0006E3 46E3 CD1C49          17      CALL    RBX2
0006E6 46E6 281A            12      JR  Z,RBRB
                                                ;先頭の端数
0006E8 46E8 CD2F49          17      CALL    RBXA
0006EB 46EB DA4447          10      JP  C,RBRERR
0006EE 46EE C5              11      PUSH    BC
0006EF 46EF CD0F44          17      CALL    ROM_LDIR
0006F2 46F2 ED533FF1        20      LD  (DTAX),DE
0006F6 46F6 2A45F1          16      LD  HL,(LEFTX)
0006F9 46F9 D1              10      POP DE
0006FA 46FA A7               4      AND A
0006FB 46FB ED52            15      SBC HL,DE
0006FD 46FD 2245F1          16      LD  (LEFTX),HL
000700 4700 2829            12      JR  Z,RBREND
                                
       4702                     RBRB:
000702 4702 CD6849          17      CALL    RBXB
000705 4705 2818            12      JR  Z,RBRC
       4707                     RBRB1:
000707 4707 C5              11      PUSH    BC
000708 4708 D5              11      PUSH    DE
000709 4709 CD0D4A          17      CALL    CLUST
00070C 470C EB               4      EX  DE,HL
00070D 470D ED4B20F1        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000711 4711 CD0F44          17      CALL    ROM_LDIR
000714 4714 EB               4      EX  DE,HL
000715 4715 D1              10      POP DE
000716 4716 C1              10      POP BC
000717 4717 CDEA49          17      CALL    GNCL
00071A 471A DA4447          10      JP  C,RBRERR
00071D 471D 10E8            13      DJNZ    RBRB1
       471F                     RBRC:
00071F 471F CD8049          17      CALL    RBXC
000722 4722 2807            12      JR  Z,RBREND
                                
000724 4724 CD0D4A          17      CALL    CLUST
000727 4727 EB               4      EX  DE,HL
000728 4728 CD0F44          17      CALL    ROM_LDIR
       472B                     RBREND:
00072B 472B CD8C49          17      CALL    RBXEND
       472E                     RBREND0:
00072E 472E FDE1            14      POP IY
000730 4730 C1              10      POP BC
000731 4731 D1              10      POP DE
000732 4732 F1              10      POP AF  ;(HL)
000733 4733 AF               4      XOR A
000734 4734 3A1EF1          13      LD  A,(_RESULT)
000737 4737 C9              10      RET
                                
       4738                     RBRERR1:
000738 4738 3E01             7      LD  A,001H
       473A                     RBRERR2:
00073A 473A FDE1            14      POP IY
00073C 473C C1              10      POP BC
00073D 473D D1              10      POP DE
00073E 473E E1              10      POP HL
00073F 473F 37               4      SCF
000740 4740 210000          10      LD  HL,0
000743 4743 C9              10      RET
       4744                     RBRERR:
000744 4744 3EFF             7      LD  A,0FFH
000746 4746 18F2            12      JR  RBRERR2
                                
       4748                     FILE_DD:
000748 4748 3E                      DB  03EH
000749 4749 C9              10      RET
00074A 474A 3208F1          13      LD  (SWC_BLOAD_M),A
00074D 474D 2A47F1          16      LD  HL,(PARAM0)
000750 4750 7E               7      LD  A,(HL)
000751 4751 C9              10      RET
       4752                     FILE_B:
000752 4752 AF               4      XOR A
000753 4753 324BF1          13      LD  (FDRV),A
000756 4756 1E00             7      LD  E,0
000758 4758 3A63F6          13      LD  A,(VALTYP)
00075B 475B FE03             7      CP  3       ;string
00075D 475D 2044            12      JR  NZ,FILED
                                
00075F 475F DD21D067        14      LD  IX,FRESTR
000763 4763 FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
000767 4767 CD1C00          17      CALL    _CALSLT
00076A 476A E5              11      PUSH    HL
00076B 476B DDE1            14      POP IX
                                
00076D 476D DD5E00          19      LD  E,(IX+0)
000770 4770 DD7E01          19      LD  A,(IX+1)
000773 4773 DD5602          19      LD  D,(IX+2)
000776 4776 DD62             9      LD  IXH,D
000778 4778 DD6F             9      LD  IXL,A
00077A 477A 7B               4      LD  A,E
00077B 477B FE04             7      CP  4
00077D 477D 3808            12      JR  C,FILEB1
00077F 477F DD7E03          19      LD  A,(IX+3)
000782 4782 FE3A             7      CP  ':'
000784 4784 28C2            12      JR  Z,FILE_DD
000786 4786 7B               4      LD  A,E
       4787                     FILEB1:
000787 4787 FE02             7      CP  2
000789 4789 3818            12      JR  C,FILED
00078B 478B DD7E01          19      LD  A,(IX+1)
00078E 478E FE3A             7      CP  ':'
000790 4790 2011            12      JR  NZ,DEVI1
000792 4792 DD7E00          19      LD  A,(IX+0)        ;DRIVE
000795 4795 CD7C48          17      CALL    CAP
000798 4798 D640             7      SUB '@'
00079A 479A DD23            10      INC IX
00079C 479C DD23            10      INC IX
00079E 479E 1D               4      DEC E
00079F 479F 1D               4      DEC E
0007A0 47A0 324BF1          13      LD  (FDRV),A
       47A3                     DEVI1:
                                
       47A3                     FILED:
0007A3 47A3 CDEA47          17      CALL    FILEI
0007A6 47A6 214CF1          10      LD  HL,FNAME
                                
0007A9 47A9 0608             7      LD  B,8
       47AB                     FILE2:
0007AB 47AB CDF747          17      CALL    CCHKF
0007AE 47AE C8              11      RET Z
0007AF 47AF FE2A             7      CP  '*'
0007B1 47B1 282E            12      JR  Z,FILE9
0007B3 47B3 FE2E             7      CP  '.'
0007B5 47B5 280C            12      JR  Z,FILE4
0007B7 47B7 77               7      LD  (HL),A
0007B8 47B8 23               6      INC HL
0007B9 47B9 10F0            13      DJNZ    FILE2
                                
       47BB                     FILE3:
0007BB 47BB CDF747          17      CALL    CCHKF
0007BE 47BE C8              11      RET Z
0007BF 47BF FE2E             7      CP  '.'
0007C1 47C1 20F8            12      JR  NZ,FILE3
                                
       47C3                     FILE4:
0007C3 47C3 2154F1          10      LD  HL,FNAME+8
0007C6 47C6 0603             7      LD  B,3
                                
       47C8                     FILE4L:
0007C8 47C8 CDF747          17      CALL    CCHKF
0007CB 47CB C8              11      RET Z
0007CC 47CC FE2E             7      CP  '.'
0007CE 47CE 2008            12      JR  NZ,FILE12
0007D0 47D0 324CF1          13      LD  (FNAME),A   ;Parent directory(..)
0007D3 47D3 324DF1          13      LD  (FNAME+1),A
0007D6 47D6 3E20             7      LD  A,020H
       47D8                     FILE12:
0007D8 47D8 FE2A             7      CP  '*'
0007DA 47DA 280A            12      JR  Z,FILE10
0007DC 47DC 77               7      LD  (HL),A
0007DD 47DD 23               6      INC HL
0007DE 47DE 10E8            13      DJNZ    FILE4L
0007E0 47E0 C9              10      RET
                                
       47E1                     FILE9:              ;名前の*処理、名前の残りを?で埋める
0007E1 47E1 CDE647          17      CALL    FILE10
0007E4 47E4 18D5            12      JR  FILE3
                                
       47E6                     FILE10:
0007E6 47E6 3E3F             7      LD  A,'?'
0007E8 47E8 1808            12      JR  FILL_MEMORY
       47EA                     FILEI:              ;名前＋拡張子をスペースで初期化
0007EA 47EA 3E20             7      LD  A,020H
0007EC 47EC 01000B          10      LD  BC,11*256   ;C=0にしておく
0007EF 47EF 214CF1          10      LD  HL,FNAME
       47F2                     FILL_MEMORY:            ;HLからBバイトAで埋める
0007F2 47F2 77               7      LD  (HL),A
0007F3 47F3 23               6      INC HL
0007F4 47F4 10FC            13      DJNZ    FILL_MEMORY
0007F6 47F6 C9              10      RET
                                
       47F7                     CCHKF:
0007F7 47F7 7B               4      LD  A,E
0007F8 47F8 B7               4      OR  A
0007F9 47F9 C8              11      RET Z
0007FA 47FA DD7E00          19      LD  A,(IX+0)
0007FD 47FD CD0448          17      CALL    CCHK2
000800 4800 C8              11      RET Z
000801 4801 C36748          10      JP  FKAN
                                
       4804                     CCHK2:
000804 4804 0C               4      INC C
000805 4805 0D               4      DEC C
000806 4806 C0              11      RET NZ
       4807                     CCHK3:              ;ZF=1 で使えない文字
000807 4807 FE2B             7      CP  '+'
000809 4809 C8              11      RET Z
00080A 480A FE2C             7      CP  ','
00080C 480C C8              11      RET Z
00080D 480D FE2F             7      CP  '/'
00080F 480F C8              11      RET Z
000810 4810 FE3A             7      CP  ':'
000812 4812 C8              11      RET Z
000813 4813 FE3B             7      CP  ';'
000815 4815 C8              11      RET Z
000816 4816 FE3D             7      CP  '='
000818 4818 C8              11      RET Z
000819 4819 FE5C             7      CP  05CH    ;\
00081B 481B C8              11      RET Z
00081C 481C FE1F             7      CP  01FH
00081E 481E D0              11      RET NC
00081F 481F BF               4      CP  A       ;Z=1
000820 4820 C9              10      RET
                                
       4821                     SS1:
000821 4821 13               6      INC DE
       4822                     SPCUT:              ;スペースをカット
000822 4822 1A               7      LD  A,(DE)
000823 4823 FE20             7      CP  020H
000825 4825 28FA            12      JR  Z,SS1
000827 4827 C9              10      RET
                                
       4828                     SCREOF1:
000828 4828 13               6      INC DE
       4829                     SPCUTEX:            ;スペース改行などをカット
000829 4829 1A               7      LD  A,(DE)
00082A 482A FE20             7      CP  020H
00082C 482C 28FA            12      JR  Z,SCREOF1
00082E 482E FE0D             7      CP  00DH
000830 4830 28F6            12      JR  Z,SCREOF1
000832 4832 FE0A             7      CP  00AH
000834 4834 28F2            12      JR  Z,SCREOF1
000836 4836 FE1A             7      CP  01AH
000838 4838 28EE            12      JR  Z,SCREOF1
00083A 483A C9              10      RET
                                
       483B                     GETNUM:
00083B 483B 210000          10      LD  HL,0
       483E                     GETNUM1:
00083E 483E 1A               7      LD  A,(DE)
00083F 483F 13               6      INC DE
000840 4840 D630             7      SUB '0'
000842 4842 D8              11      RET C
000843 4843 FE0A             7      CP  10
000845 4845 D0              11      RET NC
000846 4846 4D               4      LD  C,L
000847 4847 44               4      LD  B,H
000848 4848 29              11      ADD HL,HL   ;*2
000849 4849 29              11      ADD HL,HL   ;*4
00084A 484A 09              11      ADD HL,BC   ;*5
00084B 484B 29              11      ADD HL,HL   ;*10
00084C 484C 4F               4      LD  C,A
00084D 484D 0600             7      LD  B,0
00084F 484F 09              11      ADD HL,BC
000850 4850 18EC            12      JR  GETNUM1
                                
       4852                     SEARCH_END:
000852 4852 7E               7      LD  A,(HL)
       4853                     SEARCH_END1:
000853 4853 23               6      INC HL
000854 4854 B7               4      OR  A
000855 4855 C8              11      RET Z
000856 4856 FE3A             7      CP  ':'
000858 4858 20F8            12      JR  NZ,SEARCH_END
00085A 485A 7E               7      LD  A,(HL)
00085B 485B FE3A             7      CP  ':'
00085D 485D 28F4            12      JR  Z,SEARCH_END1
00085F 485F C9              10      RET
                                
       4860                     FKANC:
000860 4860 CB41             8      BIT 0,C
000862 4862 CC8548          17      CALL    Z,CAP2
000865 4865 1803            12      JR  FKANX
       4867                     FKAN:           ;漢字チェック
000867 4867 DD23            10      INC IX
000869 4869 1D               4      DEC E
       486A                     FKANX:
00086A 486A CB41             8      BIT 0,C
00086C 486C CB81             8      RES 0,C
00086E 486E C0              11      RET NZ
00086F 486F FE80             7      CP  080H
000871 4871 D8              11      RET C
000872 4872 FEA0             7      CP  0A0H
000874 4874 3803            12      JR  C,FKAN1
000876 4876 FEE0             7      CP  0E0H
000878 4878 D8              11      RET C
       4879                     FKAN1:
000879 4879 0C               4      INC C
00087A 487A A7               4      AND A
00087B 487B C9              10      RET
                                
       487C                     CAP:
00087C 487C FE61             7      CP  'a'
00087E 487E D8              11      RET C
00087F 487F FE7B             7      CP  'z'+1
000881 4881 D0              11      RET NC
000882 4882 D620             7      SUB 020H
000884 4884 C9              10      RET
       4885                     CAP2:
000885 4885 CD7C48          17      CALL    CAP
       4888                     CAP3:               ;
000888 4888 FE05             7      CP  5
00088A 488A 2803            12      JR  Z,CAP4
00088C 488C FE21             7      CP  021H
00088E 488E C9              10      RET
       488F                     CAP4:
00088F 488F 3EE5             7      LD  A,0E5H
000891 4891 C9              10      RET
                                
       4892                     ROM_OPEN:
000892 4892 CD774C          17      CALL    GET_DISK_BANK_FDRV
                                
000895 4895 CDBA4A          17      CALL    GET_DIR_DAT
000898 4898 D5              11      PUSH    DE
000899 4899 CDAE48          17      CALL    FILESE
00089C 489C D1              10      POP DE
00089D 489D 3F               4      CCF
00089E 489E D8              11      RET C
00089F 489F 2243F1          16      LD  (FCBX),HL
0008A2 48A2 E5              11      PUSH    HL
0008A3 48A3 210000          10      LD  HL,0
0008A6 48A6 2224F1          16      LD  (RR_LOW),HL
0008A9 48A9 2226F1          16      LD  (RR_HIGH),HL
0008AC 48AC E1              10      POP HL
0008AD 48AD C9              10      RET
                                
       48AE                     FILESE:
0008AE 48AE 7E               7      LD  A,(HL)
0008AF 48AF B7               4      OR  A
0008B0 48B0 C8              11      RET Z       ;END:ZF=1 CF=0
0008B1 48B1 FEE5             7      CP  0E5H
0008B3 48B3 280D            12      JR  Z,FILESE1
0008B5 48B5 114CF1          10      LD  DE,FNAME
0008B8 48B8 E5              11      PUSH    HL
0008B9 48B9 CDD048          17      CALL    CPFILE
0008BC 48BC CCF148          17      CALL    Z,CPFILE2
0008BF 48BF E1              10      POP HL
0008C0 48C0 37               4      SCF
0008C1 48C1 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       48C2                     FILESE1:
0008C2 48C2 CDCA48          17      CALL    FNEXT
0008C5 48C5 20E7            12      JR  NZ,FILESE
       48C7                     ZF0_CF0_AFF_RET:
0008C7 48C7 F6FF             7      OR  0FFH        ;ZF=0 CF=0
0008C9 48C9 C9              10      RET
                                
       48CA                     FNEXT:
                                ;   PUSH    HL
                                ;   LD  HL,_FILEN
                                ;   INC (HL)
                                ;   POP HL
0008CA 48CA 112000          10      LD  DE,020H
0008CD 48CD 19              11      ADD HL,DE
0008CE 48CE 0D               4      DEC C
0008CF 48CF C9              10      RET
                                
       48D0                     CPFILE:
0008D0 48D0 C5              11      PUSH    BC
0008D1 48D1 01000B          10      LD  BC,00B00H
       48D4                     CPSTR1:
0008D4 48D4 1A               7      LD  A,(DE)
0008D5 48D5 FE3F             7      CP  '?'     ;Wild card
0008D7 48D7 2812            12      JR  Z,CPSTR2
0008D9 48D9 7E               7      LD  A,(HL)
0008DA 48DA CD6048          17      CALL    FKANC
0008DD 48DD E5              11      PUSH    HL
0008DE 48DE 67               4      LD  H,A
0008DF 48DF 1A               7      LD  A,(DE)
0008E0 48E0 CB01             4      RLC C
0008E2 48E2 CD6048          17      CALL    FKANC
0008E5 48E5 CB09             4      RRC C
0008E7 48E7 BC               4      CP  H       ;CP (HL),(DE)
0008E8 48E8 E1              10      POP HL
0008E9 48E9 2004            12      JR  NZ,CPSTR3
       48EB                     CPSTR2:
0008EB 48EB 13               6      INC DE
0008EC 48EC 23               6      INC HL
0008ED 48ED 10E5            13      DJNZ    CPSTR1
       48EF                     CPSTR3:
0008EF 48EF C1              10      POP BC
0008F0 48F0 C9              10      RET
                                
       48F1                     CPFILE2:
                                ;   LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
                                ;   OR  0E1H
0008F1 48F1 3EE1             7      LD  A,0E1H
0008F3 48F3 2F               4      CPL
0008F4 48F4 A6               7      AND (HL)
0008F5 48F5 C9              10      RET
                                
       48F6                     RBX1:
0008F6 48F6 E5              11      PUSH    HL      ;Record byte
                                
0008F7 48F7 ED5B24F1        20      LD  DE,(RR_LOW) ;CDE=Random record
0008FB 48FB 3A27F1          13      LD  A,(RR_HIGH+1)
0008FE 48FE 4F               4      LD  C,A
                                
0008FF 48FF CD774C          17      CALL    GET_DISK_BANK_FDRV
                                
000902 4902 FD2A43F1        20      LD  IY,(FCBX)
000906 4906 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000909 4909 FD661D          19      LD  H,(IY+01DH)
00090C 490C FD7E1E          19      LD  A,(IY+01EH)
                                
00090F 490F A7               4      AND A
000910 4910 ED52            15      SBC HL,DE
000912 4912 99               4      SBC A,C
000913 4913 D1              10      POP DE
                                
000914 4914 D8              11      RET C
000915 4915 4F               4      LD  C,A
000916 4916 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000917 4917 B2               4      OR  D
000918 4918 B3               4      OR  E
000919 4919 C0              11      RET NZ
00091A 491A 37               4      SCF
00091B 491B C9              10      RET
                                
       491C                     RBX2:
00091C 491C ED4B25F1        20      LD  BC,(RR_LOW+1)
000920 4920 CDA149          17      CALL    RWXR
000923 4923 3A21F1          13      LD  A,(CLSZ_H)
000926 4926 3D               4      DEC A
000927 4927 E5              11      PUSH    HL
000928 4928 2A24F1          16      LD  HL,(RR_LOW)
00092B 492B A4               4      AND H
00092C 492C B5               4      OR  L
00092D 492D E1              10      POP HL
00092E 492E C9              10      RET
                                
       492F                     RBXA:
00092F 492F D5              11      PUSH    DE
000930 4930 CD0D4A          17      CALL    CLUST
000933 4933 ED532CF1        20      LD  (_DTPS),DE
000937 4937 D1              10      POP DE
000938 4938 CDEA49          17      CALL    GNCL
00093B 493B D8              11      RET C
00093C 493C ED5328F1        20      LD  (_CLPS),DE
                                
000940 4940 ED4B24F1        20      LD  BC,(RR_LOW)
000944 4944 2A20F1          16      LD  HL,(CLSZ)
000947 4947 7C               4      LD  A,H
000948 4948 3D               4      DEC A
000949 4949 A0               4      AND B
00094A 494A 47               4      LD  B,A
00094B 494B ED42            15      SBC HL,BC       ;remaining cluster
                                
00094D 494D ED5B45F1        20      LD  DE,(LEFTX)
000951 4951 ED52            15      SBC HL,DE       ;CP HL,DE
000953 4953 19              11      ADD HL,DE
000954 4954 3801            12      JR  C,RBXA1
000956 4956 EB               4      EX  DE,HL
       4957                     RBXA1:
000957 4957 3A1FF1          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
00095A 495A 320068          13      LD  (BANK1_SEL),A   ;ASCII-8K/Konami-8K共通で使える
00095D 495D E5              11      PUSH    HL
00095E 495E 2A2CF1          16      LD  HL,(_DTPS)
000961 4961 09              11      ADD HL,BC
000962 4962 ED5B3FF1        20      LD  DE,(DTAX)
000966 4966 C1              10      POP BC
000967 4967 C9              10      RET
                                
       4968                     RBXB:
000968 4968 2A3FF1          16      LD  HL,(DTAX)
00096B 496B ED5B28F1        20      LD  DE,(_CLPS)
00096F 496F 3A46F1          13      LD  A,(LEFTX+1)
000972 4972 47               4      LD  B,A
000973 4973 3A21F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4976                     RBXB1:
000976 4976 1F               4      RRA     ;->CF
000977 4977 3804            12      JR  C,RBXB2
000979 4979 CB38             8      SRL B   ;B=B/2
00097B 497B 18F9            12      JR  RBXB1
       497D                     RBXB2:
00097D 497D 78               4      LD  A,B
00097E 497E B7               4      OR  A
00097F 497F C9              10      RET
                                
       4980                     RBXC:
000980 4980 ED4B45F1        20      LD  BC,(LEFTX)
000984 4984 3A21F1          13      LD  A,(CLSZ_H)
000987 4987 3D               4      DEC A
000988 4988 A0               4      AND B
000989 4989 47               4      LD  B,A
00098A 498A B1               4      OR  C
00098B 498B C9              10      RET
                                
       498C                     RBXEND:
00098C 498C ED5B2AF1        20      LD  DE,(_LEFT)
000990 4990 2A24F1          16      LD  HL,(RR_LOW)
000993 4993 3A27F1          13      LD  A,(RR_HIGH+1)
000996 4996 19              11      ADD HL,DE
000997 4997 CE00             7      ADC A,0
000999 4999 2224F1          16      LD  (RR_LOW),HL
00099C 499C 3227F1          13      LD  (RR_HIGH+1),A
00099F 499F EB               4      EX  DE,HL       ;HL=Read byte
0009A0 49A0 C9              10      RET 
                                
       49A1                     RWXR:
0009A1 49A1 3A21F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       49A4                     L_RWX:
0009A4 49A4 1F               4      RRA     ;->CF
0009A5 49A5 3806            12      JR  C,E_RWX
0009A7 49A7 CB38             8      SRL B   ;BC=BC/2
0009A9 49A9 CB19             8      RR  C   ;
0009AB 49AB 18F7            12      JR  L_RWX
       49AD                     E_RWX:
0009AD 49AD CD774C          17      CALL    GET_DISK_BANK_FDRV
                                
0009B0 49B0 FD2A43F1        20      LD  IY,(FCBX)
0009B4 49B4 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
0009B7 49B7 FD561B          19      LD  D,(IY+01BH)
       49BA                     RWX1:
0009BA 49BA ED5328F1        20      LD  (_CLPS),DE
0009BE 49BE 7A               4      LD  A,D
0009BF 49BF B3               4      OR  E
0009C0 49C0 37               4      SCF
0009C1 49C1 C8              11      RET Z
                                
0009C2 49C2 78               4      LD  A,B
0009C3 49C3 B1               4      OR  C
0009C4 49C4 C8              11      RET Z
                                
0009C5 49C5 CDEA49          17      CALL    GNCL
0009C8 49C8 D8              11      RET C
0009C9 49C9 0B               6      DEC BC
0009CA 49CA CD534A          17      CALL    ENDCL
0009CD 49CD 38EB            12      JR  C,RWX1
0009CF 49CF 37               4      SCF
0009D0 49D0 C9              10      RET
                                
       49D1                     NCL3:
0009D1 49D1 CD774C          17      CALL    GET_DISK_BANK_FDRV
0009D4 49D4 320068          13      LD  (BANK1_SEL),A
0009D7 49D7 6B               4      LD  L,E
0009D8 49D8 62               4      LD  H,D
0009D9 49D9 CB3C             8      SRL H
0009DB 49DB CB1D             8      RR  L
0009DD 49DD 1F               4      RRA
0009DE 49DE 19              11      ADD HL,DE
0009DF 49DF 010060          10      LD  BC,BANK1_ADR
0009E2 49E2 09              11      ADD HL,BC
0009E3 49E3 ED4B22F1        20      LD  BC,(SECSZ)
0009E7 49E7 09              11      ADD HL,BC
0009E8 49E8 17               4      RLA
0009E9 49E9 C9              10      RET
                                
       49EA                     GNCL:
0009EA 49EA 7A               4      LD  A,D
0009EB 49EB B3               4      OR  E
0009EC 49EC 37               4      SCF
0009ED 49ED C8              11      RET Z
0009EE 49EE C5              11      PUSH    BC
0009EF 49EF E5              11      PUSH    HL
0009F0 49F0 CDD149          17      CALL    NCL3
0009F3 49F3 3809            12      JR  C,GNC1
0009F5 49F5 5E               7      LD  E,(HL)
0009F6 49F6 23               6      INC HL
0009F7 49F7 7E               7      LD  A,(HL)
0009F8 49F8 E60F             7      AND 00FH
0009FA 49FA 57               4      LD  D,A
0009FB 49FB E1              10      POP HL
0009FC 49FC C1              10      POP BC
0009FD 49FD C9              10      RET
       49FE                     GNC1:
0009FE 49FE 7E               7      LD  A,(HL)
0009FF 49FF 23               6      INC HL
000A00 4A00 56               7      LD  D,(HL)
000A01 4A01 0604             7      LD  B,4
       4A03                     GNC1L:
000A03 4A03 CB3A             8      SRL D
000A05 4A05 1F               4      RRA
000A06 4A06 10FB            13      DJNZ    GNC1L
                                
000A08 4A08 5F               4      LD  E,A
000A09 4A09 E1              10      POP HL
000A0A 4A0A C1              10      POP BC
000A0B 4A0B A7               4      AND A
000A0C 4A0C C9              10      RET
                                
       4A0D                     CLUST:
000A0D 4A0D EB               4      EX  DE,HL
000A0E 4A0E C5              11      PUSH    BC
000A0F 4A0F 3A21F1          13      LD  A,(CLSZ_H)
000A12 4A12 CDA04C          17      CALL    MUL_AHL
                                
000A15 4A15 CDC74A          17      CALL    GET_DIR_POS
000A18 4A18 4F               4      LD  C,A
000A19 4A19 0600             7      LD  B,0
000A1B 4A1B 09              11      ADD HL,BC
                                
000A1C 4A1C 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000A1F 4A1F 0F               4      RRCA
000A20 4A20 0F               4      RRCA
000A21 4A21 0F               4      RRCA
000A22 4A22 0F               4      RRCA
000A23 4A23 4F               4      LD  C,A
                                
000A24 4A24 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000A27 4A27 FE02             7      CP  2
000A29 4A29 280C            12      JR  Z,CLUST1
000A2B 4A2B CB01             4      RLC C
000A2D 4A2D 0D               4      DEC C
000A2E 4A2E 3A0C60          13      LD  A,(BANK1_ADR+11+1)  ;BPB_BytsPerSec High    
000A31 4A31 FE02             7      CP  2
000A33 4A33 2002            12      JR  NZ,CLUST1
000A35 4A35 0D               4      DEC C
000A36 4A36 0D               4      DEC C
       4A37                     CLUST1:
000A37 4A37 0D               4      DEC C
000A38 4A38 09              11      ADD HL,BC
                                
000A39 4A39 E5              11      PUSH    HL
000A3A 4A3A 29              11      ADD HL,HL   ;*2
000A3B 4A3B 29              11      ADD HL,HL   ;*4
000A3C 4A3C 29              11      ADD HL,HL   ;*8
000A3D 4A3D CD774C          17      CALL    GET_DISK_BANK_FDRV
000A40 4A40 84               4      ADD A,H
000A41 4A41 320068          13      LD  (BANK1_SEL),A
000A44 4A44 321FF1          13      LD  (_BANK),A
000A47 4A47 E1              10      POP HL
000A48 4A48 3E1F             7      LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
000A4A 4A4A A5               4      AND L
000A4B 4A4B C660             7      ADD A,high BANK1_ADR
000A4D 4A4D 67               4      LD  H,A
000A4E 4A4E 2E00             7      LD  L,0
000A50 4A50 EB               4      EX  DE,HL
000A51 4A51 C1              10      POP BC
000A52 4A52 C9              10      RET
                                
       4A53                     ENDCL:
000A53 4A53 7A               4      LD  A,D ;END CLUSTER
000A54 4A54 FE0F             7      CP  00FH    ;FAT12の最大値
000A56 4A56 C0              11      RET NZ
000A57 4A57 7B               4      LD  A,E
000A58 4A58 FEF7             7      CP  0F7H
000A5A 4A5A C9              10      RET
                                
       4A5B                     RB_READ:
000A5B 4A5B AF               4      XOR A   ;HLA = HL*128
000A5C 4A5C CB3C             8      SRL H
000A5E 4A5E CB1D             8      RR  L
000A60 4A60 1F               4      RRA
000A61 4A61 3224F1          13      LD  (RR_LOW),A
000A64 4A64 2225F1          16      LD  (RR_MID),HL
000A67 4A67 218000          10      LD  HL,128
                                
000A6A 4A6A CDB246          17      CALL    ROM_READ
000A6D 4A6D C9              10      RET
                                
       4A6E                     GETSEQ:
000A6E 4A6E FD6E20          19      LD  L,(IY+32)
000A71 4A71 FD660C          19      LD  H,(IY+12)
                                
000A74 4A74 CB25             8      SLA L
                                
000A76 4A76 CB3C             8      SRL H
000A78 4A78 CB1D             8      RR  L
000A7A 4A7A C9              10      RET
                                
       4A7B                     SETSEQ:
000A7B 4A7B F5              11      PUSH    AF
000A7C 4A7C 3A24F1          13      LD  A,(RR_LOW)
000A7F 4A7F 2A25F1          16      LD  HL,(RR_MID)
                                
000A82 4A82 CD994A          17      CALL    SSQ1
                                
000A85 4A85 29              11      ADD HL,HL
000A86 4A86 CB3D             8      SRL L
000A88 4A88 FD7520          19      LD  (IY+32),L
000A8B 4A8B FD740C          19      LD  (IY+12),H
000A8E 4A8E F1              10      POP AF
000A8F 4A8F C9              10      RET
                                
       4A90                     GETSIZE:
000A90 4A90 FD7E10          19      LD  A,(IY+16)
000A93 4A93 FD6E11          19      LD  L,(IY+17)
000A96 4A96 FD6612          19      LD  H,(IY+18)
       4A99                     SSQ1:
000A99 4A99 87               4      ADD A,A
000A9A 4A9A ED6A            15      ADC HL,HL
000A9C 4A9C B7               4      OR  A
000A9D 4A9D C8              11      RET Z
000A9E 4A9E 23               6      INC HL
000A9F 4A9F C9              10      RET
                                
       4AA0                     SET_FCB:
000AA0 4AA0 D5              11      PUSH    DE
000AA1 4AA1 FDE1            14      POP IY
000AA3 4AA3 FD7E1C          19      LD  A,(IY+28)
000AA6 4AA6 FEFF             7      CP  0FFH
000AA8 4AA8 200C            12      JR  NZ,POPAF_SCF_FF_RET
000AAA 4AAA E5              11      PUSH    HL
000AAB 4AAB FD6E1A          19      LD  L,(IY+26)
000AAE 4AAE FD661B          19      LD  H,(IY+27)
000AB1 4AB1 2228F1          16      LD  (_CLPS),HL
000AB4 4AB4 E1              10      POP HL
000AB5 4AB5 C9              10      RET
                                
       4AB6                     POPAF_SCF_FF_RET:
000AB6 4AB6 F1              10      POP AF
000AB7 4AB7 37               4      SCF
000AB8 4AB8 9F               4      SBC A,A
000AB9 4AB9 C9              10      RET
                                
       4ABA                     GET_DIR_DAT:
000ABA 4ABA CDC74A          17      CALL    GET_DIR_POS
000ABD 4ABD C660             7      ADD A,high BANK1_ADR
000ABF 4ABF 2E00             7      LD  L,0
000AC1 4AC1 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
000AC2 4AC2 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000AC5 4AC5 4F               4      LD  C,A
000AC6 4AC6 C9              10      RET
                                
       4AC7                     GET_DIR_POS:
000AC7 4AC7 CD774C          17      CALL    GET_DISK_BANK_FDRV
000ACA 4ACA 320068          13      LD  (BANK1_SEL),A
000ACD 4ACD 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000AD0 4AD0 47               4      LD  B,A
000AD1 4AD1 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000AD4 4AD4 4F               4      LD  C,A
000AD5 4AD5 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4AD8                     GET_DIR_POS1:
000AD8 4AD8 81               4      ADD A,C
000AD9 4AD9 10FD            13      DJNZ    GET_DIR_POS1
                                
000ADB 4ADB ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec 
       4ADF                     L_MDP:
000ADF 4ADF CB18             8      RR  B   ;->CF
000AE1 4AE1 D8              11      RET C
000AE2 4AE2 87               4      ADD A,A
000AE3 4AE3 18FA            12      JR  L_MDP
                                
       4AE5                     WILDCARD:
000AE5 4AE5 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4AF0                     ERROR_WRITE_PROTECTED:
000AF0 4AF0 3E00             7      LD  A,0     ;Write protected
000AF2 4AF2 C9              10      RET
       4AF3                     DISKIO:
000AF3 4AF3 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000AF5 4AF5 48               4      LD  C,B
000AF6 4AF6 CD814C          17      CALL    GET_DISK_BANK
       4AF9                     SETMAP1:        
000AF9 4AF9 E5              11      PUSH    HL
       4AFA                     DISKIO1:
000AFA 4AFA C5              11      PUSH    BC      ;B=残りのセクタ数
000AFB 4AFB D5              11      PUSH    DE      ;DE=セクタ番号
000AFC 4AFC F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
000AFD 4AFD EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
000AFE 4AFE F5              11      PUSH    AF
000AFF 4AFF 3A23F1          13      LD  A,(SECSZ_H)
000B02 4B02 CDA04C          17      CALL    MUL_AHL
000B05 4B05 F1              10      POP AF
000B06 4B06 4D               4      LD  C,L     ;C=読み出し元
000B07 4B07 29              11      ADD HL,HL       ;64KB→32KB
000B08 4B08 29              11      ADD HL,HL       ;32KB→16KB
000B09 4B09 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
000B0A 4B0A 84               4      ADD A,H
000B0B 4B0B 320068          13      LD  (BANK1_SEL),A   ;ASCII-8K/Konami-8K共通で使える
000B0E 4B0E 321FF1          13      LD  (_BANK),A
000B11 4B11 79               4      LD  A,C     ;C=読み出し元
000B12 4B12 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
000B14 4B14 C660             7      ADD A,high BANK1_ADR
000B16 4B16 67               4      LD  H,A
000B17 4B17 ED4B22F1        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
000B1B 4B1B 69               4      LD  L,C     ;C=0
000B1C 4B1C EDB0                    LDIR
000B1E 4B1E EB               4      EX  DE,HL
000B1F 4B1F F1              10      POP AF
000B20 4B20 D1              10      POP DE
000B21 4B21 13               6      INC DE
000B22 4B22 C1              10      POP BC
000B23 4B23 10D5            13      DJNZ    DISKIO1
000B25 4B25 41               4      LD  B,C
                                
000B26 4B26 E1              10      POP HL
000B27 4B27 AF               4      XOR A
000B28 4B28 FB               4      EI
000B29 4B29 C9              10      RET
                                
       4B2A                     DSKCHG:
000B2A 4B2A CD634B          17      CALL    IS_BPB
000B2D 4B2D 3824            12      JR  C,NOTREADY
000B2F 4B2F 3A23FB          13      LD  A,(DRVTBL+2)
000B32 4B32 B7               4      OR  A
000B33 4B33 201A            12      JR  NZ,DSKCHG1
000B35 4B35 3A21FB          13      LD  A,(DRVTBL)
000B38 4B38 FE02             7      CP  2
000B3A 4B3A 2013            12      JR  NZ,DSKCHG1
000B3C 4B3C CD634B          17      CALL    IS_BPB
000B3F 4B3F 300E            12      JR  NC,DSKCHG1
000B41 4B41 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000B43 4B43 3221FB          13      LD  (DRVTBL),A
000B46 4B46 3223FB          13      LD  (DRVTBL+2),A
000B49 4B49 3A48F3          13      LD  A,(MASTERS)
000B4C 4B4C 3224FB          13      LD  (DRVTBL+3),A
       4B4F                     DSKCHG1:
000B4F 4B4F AF               4      XOR A
000B50 4B50 0601             7      LD  B,1
000B52 4B52 C9              10      RET
       4B53                     NOTREADY:
000B53 4B53 3E02             7      LD  A,2
000B55 4B55 37               4      SCF
000B56 4B56 C9              10      RET
                                
       4B57                     NO_BPB:
000B57 4B57 E1              10      POP HL
000B58 4B58 23               6      INC HL
000B59 4B59 11A54C          10      LD  DE,DPB2DD
000B5C 4B5C 011200          10      LD  BC,DPB2DD_E-DPB2DD
000B5F 4B5F EDB0                    LDIR
000B61 4B61 AF               4      XOR A
000B62 4B62 C9              10      RET
                                
       4B63                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000B63 4B63 CD814C          17      CALL    GET_DISK_BANK
                                
000B66 4B66 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000B69 4B69 FE01             7      CP  1
000B6B 4B6B D8              11      RET C
                                
000B6C 4B6C 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000B6F 4B6F C6FF             7      ADD A,0FFH
000B71 4B71 D8              11      RET C
                                
000B72 4B72 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
000B75 4B75 FE01             7      CP  1
000B77 4B77 C8              11      RET Z
000B78 4B78 FE02             7      CP  2
000B7A 4B7A C8              11      RET Z
000B7B 4B7B FE04             7      CP  4
000B7D 4B7D C8              11      RET Z
000B7E 4B7E 37               4      SCF
000B7F 4B7F C9              10      RET
                                
       4B80                     GETDPB:
000B80 4B80 E5              11      PUSH    HL
000B81 4B81 CD814C          17      CALL    GET_DISK_BANK
                                
000B84 4B84 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000B87 4B87 B7               4      OR  A
000B88 4B88 28CD            12      JR  Z,NO_BPB
000B8A 4B8A DDE1            14      POP IX
000B8C 4B8C DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000B8F 4B8F 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000B92 4B92 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000B95 4B95 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000B98 4B98 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000B9B 4B9B 87               4      ADD A,A
000B9C 4B9C 87               4      ADD A,A
000B9D 4B9D 87               4      ADD A,A
000B9E 4B9E 3D               4      DEC A
000B9F 4B9F DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000BA2 4BA2 06FF             7      LD  B,-1
000BA4 4BA4 A7               4      AND A           ;無限ループ阻止
       4BA5                     GETDPB1:
000BA5 4BA5 04               4      INC B
000BA6 4BA6 1F               4      RRA
000BA7 4BA7 38FC            12      JR  C,GETDPB1
000BA9 4BA9 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000BAC 4BAC 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000BAF 4BAF 3D               4      DEC A
000BB0 4BB0 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000BB3 4BB3 A7               4      AND A           ;無限ループ阻止
000BB4 4BB4 06FF             7      LD  B,-1
       4BB6                     GETDPB2:
000BB6 4BB6 04               4      INC B
000BB7 4BB7 1F               4      RRA
000BB8 4BB8 38FC            12      JR  C,GETDPB2
000BBA 4BBA 04               4      INC B
000BBB 4BBB DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000BBE 4BBE 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
000BC1 4BC1 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
000BC4 4BC4 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
000BC7 4BC7 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
000BCA 4BCA DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000BCD 4BCD 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
000BD0 4BD0 DD770B          19      LD  (IX+11),A       ;FATCNT
                                
000BD3 4BD3 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
000BD7 4BD7 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
000BDA 4BDA DD460A          19      LD  B,(IX+10)       ;FATCNT
000BDD 4BDD 210000          10      LD  HL,0
       4BE0                     GETDPB3:
000BE0 4BE0 19              11      ADD HL,DE
000BE1 4BE1 10FD            13      DJNZ    GETDPB3
       4BE3                     GETDPB4:
000BE3 4BE3 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
000BE6 4BE6 DD5609          19      LD  D,(IX+9)        ;FIRFAT
000BE9 4BE9 19              11      ADD HL,DE
000BEA 4BEA DD7511          19      LD  (IX+17),L       ;FIRDIR
000BED 4BED DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000BF0 4BF0 3E08             7      LD  A,2*4           ;SECSIZ HIGH
000BF2 4BF2 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4BF5                     GETDPB5:
000BF5 4BF5 CB3B             8      SRL E
000BF7 4BF7 1F               4      RRA
000BF8 4BF8 30FB            12      JR  NC,GETDPB5
000BFA 4BFA 1600             7      LD  D,0
000BFC 4BFC 19              11      ADD HL,DE
000BFD 4BFD DD750C          19      LD  (IX+12),L       ;FIRREC
000C00 4C00 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000C03 4C03 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
000C06 4C06 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
000C09 4C09 DD560D          19      LD  D,(IX+13)       ;FIRREC
000C0C 4C0C A7               4      AND A
000C0D 4C0D ED52            15      SBC HL,DE
                                
000C0F 4C0F DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
000C12 4C12 3C               4      INC A
000C13 4C13 37               4      SCF             ;無限ループ阻止
       4C14                     GETDPB6:
000C14 4C14 1F               4      RRA
000C15 4C15 3806            12      JR  C,GETDPB7
000C17 4C17 CB3C             8      SRL H
000C19 4C19 CB1D             8      RR  L
000C1B 4C1B 18F7            12      JR  GETDPB6
       4C1D                     GETDPB7:
000C1D 4C1D 23               6      INC HL
000C1E 4C1E DD750E          19      LD  (IX+14),L       ;MAXCLUS
000C21 4C21 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       4C24                     GETDPBD1:
000C24 4C24 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000C27 4C27 E6FC             7      AND 0FCH
000C29 4C29 C8              11      RET Z
                                
000C2A 4C2A DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
000C2E 4C2E 37               4      SCF
000C2F 4C2F DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
000C33 4C33 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
000C36 4C36 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
000C3A 4C3A DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
000C3E 4C3E DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
000C42 4C42 DDCB1126        23      SLA (IX+17)         ;FIRDIR
000C46 4C46 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
000C4A 4C4A DD6E11          19      LD  L,(IX+17)       ;FIRDIR
000C4D 4C4D DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
000C50 4C50 3E08             7      LD  A,2*4           ;SECSIZ HIGH
000C52 4C52 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4C55                     GETDPBD5:
000C55 4C55 CB3B             8      SRL E
000C57 4C57 1F               4      RRA
000C58 4C58 30FB            12      JR  NC,GETDPBD5
000C5A 4C5A 1600             7      LD  D,0
000C5C 4C5C 19              11      ADD HL,DE
000C5D 4C5D DD750C          19      LD  (IX+12),L       ;FIRREC
000C60 4C60 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000C63 4C63 18BF            12      JR  GETDPBD1
                                
       4C65                     CHOICE:
000C65 4C65 210000          10      LD  HL,0
000C68 4C68 C9              10      RET
                                
       4C69                     DSKFMT:
000C69 4C69 AF               4      XOR A
000C6A 4C6A 37               4      SCF
       4C6B                     DSKSTP:
000C6B 4C6B C9              10      RET
                                
       4C6C                     BASENT:
000C6C 4C6C ED7B57F1        20      LD  SP,(BASSTK)
000C70 4C70 C3AE43          10      JP  BASAUTO
                                
       4C73                     GETSLT:
000C73 4C73 3A22FB          13      LD  A,(DRVTBL+1)
000C76 4C76 C9              10      RET
                                
       4C77                     GET_DISK_BANK_FDRV:
000C77 4C77 3A4BF1          13      LD  A,(FDRV)
000C7A 4C7A D601             7      SUB 1
000C7C 4C7C 3003            12      JR  NC,GET_DISK_BANK
000C7E 4C7E 3A42F1          13      LD  A,(_DVSW)
       4C81                     GET_DISK_BANK:
000C81 4C81 B7               4      OR  A       ;A=DRIVE
000C82 4C82 3E01             7      LD  A,DISK_BANK
000C84 4C84 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
000C86 4C86 3A41F1          13      LD  A,(B_DRIVE)
                                #endif
       4C89                     SET_DISK_BANK:
000C89 4C89 320068          13      LD  (BANK1_SEL),A
000C8C 4C8C F5              11      PUSH    AF
000C8D 4C8D E5              11      PUSH    HL
000C8E 4C8E 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
000C91 4C91 2222F1          16      LD  (SECSZ),HL
000C94 4C94 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000C97 4C97 CDA04C          17      CALL    MUL_AHL
000C9A 4C9A 2220F1          16      LD  (CLSZ),HL
000C9D 4C9D E1              10      POP HL
000C9E 4C9E F1              10      POP AF
000C9F 4C9F C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)
       4CA0                     MUL_AHL:
000CA0 4CA0 1F               4      RRA     ;->CF
000CA1 4CA1 D8              11      RET C
000CA2 4CA2 29              11      ADD HL,HL
000CA3 4CA3 18FB            12      JR  MUL_AHL
                                
       4CA5                     DPB2DD:
000CA5 4CA5 F9                      DB  0F9H    ;MEDIA
000CA6 4CA6 0002                    DW  00200H  ;SECSIZ
000CA8 4CA8 0F                      DB  00FH    ;DIRMSK
000CA9 4CA9 04                      DB  004H    ;DIRSHFT
000CAA 4CAA 01                      DB  001H    ;CLUSMSK
000CAB 4CAB 02                      DB  002H    ;CLUSSHFT
000CAC 4CAC 0100                    DW  00001H  ;FIRFAT
000CAE 4CAE 02                      DB  002H    ;FATCNT
000CAF 4CAF 70                      DB  070H    ;MAXENT
000CB0 4CB0 0E00                    DW  0000EH  ;FIRREC
000CB2 4CB2 CA02                    DW  002CAH  ;MAXCLUS
000CB4 4CB4 03                      DB  003H    ;FATSIZ
000CB5 4CB5 0700                    DW  0007H   ;FIRDIR
       4CB7                     DPB2DD_E:
                                
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       4CB7                     POP_HL_ERROR:
000CB7 4CB7 E1              10      POP     HL
       4CB8                     _ERROR:
000CB8 4CB8 0600             7      LD  B,0
000CBA 4CBA A7               4      AND A
000CBB 4CBB C9              10      RET
                                
       4CBC                     ROM_BDOS:
000CBC 4CBC E5              11      PUSH    HL
000CBD 4CBD 79               4      LD  A,C
000CBE 4CBE 87               4      ADD A,A
000CBF 4CBF 38F7            12      JR  C,_ERROR
000CC1 4CC1 6F               4      LD  L,A
000CC2 4CC2 265F             7      LD  H,high STABLE
000CC4 4CC4 7E               7      LD  A,(HL)
000CC5 4CC5 2C               4      INC L
000CC6 4CC6 66               7      LD  H,(HL)
000CC7 4CC7 6F               4      LD  L,A
000CC8 4CC8 E3              19      EX  (SP),HL
000CC9 4CC9 79               4      LD  A,C
000CCA 4CCA C9              10      RET
                                
       4CCB                     _PRINT:
       4CCB                     PRINT:
000CCB 4CCB 7B               4      LD  A,E
000CCC 4CCC 1803            12      JR  MSG_A
                                
       4CCE                     _SYS01:     ;(BDOS)コンソール入力
000CCE 4CCE CD454D          17      CALL    _SYS07
       4CD1                     MSG_A:
000CD1 4CD1 FE03             7      CP  3
000CD3 4CD3 2814            12      JR  Z,MSG_BR
       4CD5                     MSGA1:
000CD5 4CD5 F5              11      PUSH    AF
000CD6 4CD6 C5              11      PUSH    BC
000CD7 4CD7 D5              11      PUSH    DE
000CD8 4CD8 E5              11      PUSH    HL
000CD9 4CD9 DDE5            15      PUSH    IX
000CDB 4CDB DD21A200        14      LD  IX,CHPUT
000CDF 4CDF CDE142          17      CALL    CALSLT_R
000CE2 4CE2 DDE1            14      POP IX
000CE4 4CE4 E1              10      POP HL
000CE5 4CE5 D1              10      POP DE
000CE6 4CE6 C1              10      POP BC
       4CE7                     MSGA2:
000CE7 4CE7 F1              10      POP AF
000CE8 4CE8 C9              10      RET
       4CE9                     MSG_BR:
000CE9 4CE9 F5              11      PUSH    AF
000CEA 4CEA 3ADDF3          13      LD  A,(CSRX)
000CED 4CED FE02             7      CP  2
000CEF 4CEF 38F6            12      JR  C,MSGA2
000CF1 4CF1 F1              10      POP AF
       4CF2                     MSG_CR:
000CF2 4CF2 F5              11      PUSH    AF
000CF3 4CF3 3E0D             7      LD  A,00DH
000CF5 4CF5 CDD54C          17      CALL    MSGA1
000CF8 4CF8 3E0A             7      LD  A,00AH
000CFA 4CFA CDD54C          17      CALL    MSGA1
000CFD 4CFD F1              10      POP AF
000CFE 4CFE C9              10      RET
                                
       4CFF                     _SYS02:     ;(BDOS)コンソール出力
000CFF 4CFF CD1A4D          17      CALL    BREAK
000D02 4D02 1805            12      JR  PRINTX
                                
       4D04                     _SYS06:     ;(BDOS)コンソール直接入出力
000D04 4D04 7B               4      LD  A,E
000D05 4D05 3C               4      INC A
000D06 4D06 CA594D          10      JP  Z,_INKEY
       4D09                     PRINTX:
000D09 4D09 C3CB4C          10      JP  _PRINT
                                
       4D0C                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000D0C 4D0C CD454D          17      CALL    _SYS07
000D0F 4D0F FE03             7      CP  3
000D11 4D11 CC1A4D          17      CALL    Z,_BREAK
000D14 4D14 FE13             7      CP  013H        ;CTRL+S
000D16 4D16 C0              11      RET NZ
       4D17                     PAUSE:
000D17 4D17 CD314D          17      CALL    KEYBC
                                
       4D1A                     _BREAK:
       4D1A                     BREAK:
000D1A 4D1A F5              11      PUSH    AF
000D1B 4D1B C5              11      PUSH    BC
000D1C 4D1C D5              11      PUSH    DE
000D1D 4D1D E5              11      PUSH    HL
000D1E 4D1E DDE5            15      PUSH    IX
000D20 4D20 DD21B700        14      LD  IX,BREAKX
000D24 4D24 CDE142          17      CALL    CALSLT_R
000D27 4D27 DDE1            14      POP IX
000D29 4D29 E1              10      POP HL
000D2A 4D2A D1              10      POP DE
000D2B 4D2B C1              10      POP BC
000D2C 4D2C DC1A4D          17      CALL    C,_BREAK
000D2F 4D2F F1              10      POP AF
000D30 4D30 C9              10      RET
       4D31                     KEYBC:
000D31 4D31 F5              11      PUSH    AF
000D32 4D32 C5              11      PUSH    BC
000D33 4D33 D5              11      PUSH    DE
000D34 4D34 E5              11      PUSH    HL
000D35 4D35 DDE5            15      PUSH    IX
000D37 4D37 DD215601        14      LD  IX,KILBUF
000D3B 4D3B CDE142          17      CALL    CALSLT_R
000D3E 4D3E DDE1            14      POP IX
000D40 4D40 E1              10      POP HL
000D41 4D41 D1              10      POP DE
000D42 4D42 C1              10      POP BC
000D43 4D43 F1              10      POP AF
000D44 4D44 C9              10      RET
                                
       4D45                     _SYS07:
       4D45                     FLGET:
000D45 4D45 C5              11      PUSH    BC
000D46 4D46 D5              11      PUSH    DE
000D47 4D47 E5              11      PUSH    HL
000D48 4D48 DDE5            15      PUSH    IX
000D4A 4D4A DD219F00        14      LD  IX,CHGET
000D4E 4D4E CDE142          17      CALL    CALSLT_R
000D51 4D51 DDE1            14      POP IX
000D53 4D53 E1              10      POP HL
000D54 4D54 D1              10      POP DE
000D55 4D55 C1              10      POP BC
000D56 4D56 FE03             7      CP  3
000D58 4D58 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       4D59                     _INKEY:
       4D59                     INKEY:
000D59 4D59 CDF34D          17      CALL    CPM_CONST
000D5C 4D5C C8              11      RET Z
000D5D 4D5D 18E6            12      JR  FLGET
                                
       4D5F                     _SYS0A:     ;(BDOS)文字列入力
000D5F 4D5F C5              11      PUSH    BC
000D60 4D60 E5              11      PUSH    HL
000D61 4D61 D5              11      PUSH    DE
000D62 4D62 CD8B4D          17      CALL    GETL
000D65 4D65 111FF4          10      LD  DE,KBUF
000D68 4D68 E1              10      POP HL
000D69 4D69 E5              11      PUSH    HL
000D6A 4D6A 0E00             7      LD  C,0
000D6C 4D6C 3004            12      JR  NC,SAX0
000D6E 4D6E 23               6      INC HL
000D6F 4D6F 23               6      INC HL
000D70 4D70 1808            12      JR  SAX4
       4D72                     SAX0:
000D72 4D72 46               7      LD  B,(HL)
000D73 4D73 23               6      INC HL
       4D74                     SAX1:
000D74 4D74 23               6      INC HL
000D75 4D75 1A               7      LD  A,(DE)
000D76 4D76 13               6      INC DE
000D77 4D77 B7               4      OR  A
000D78 4D78 2004            12      JR  NZ,SAX2
       4D7A                     SAX4:
000D7A 4D7A 360D            10      LD  (HL),00DH
000D7C 4D7C 1804            12      JR  SAX3
       4D7E                     SAX2:
000D7E 4D7E 77               7      LD  (HL),A
000D7F 4D7F 0C               4      INC C
000D80 4D80 10F2            13      DJNZ    SAX1
       4D82                     SAX3:
000D82 4D82 D1              10      POP DE
000D83 4D83 79               4      LD  A,C
000D84 4D84 13               6      INC DE
000D85 4D85 12               7      LD  (DE),A
000D86 4D86 1B               6      DEC DE
000D87 4D87 E1              10      POP HL
000D88 4D88 C1              10      POP BC
000D89 4D89 A7               4      AND A
000D8A 4D8A C9              10      RET
       4D8B                     GETL:
000D8B 4D8B DDE5            15      PUSH    IX
000D8D 4D8D FDE5            15      PUSH    IY
                                
000D8F 4D8F 2ADCF3          16      LD  HL,(CSRY)
000D92 4D92 22CAFB          16      LD  (FSTPOS),HL
       4D95                     GETL1:
000D95 4D95 CD0C4D          17      CALL    _SYS08
000D98 4D98 FE09             7      CP  9
000D9A 4D9A 2008            12      JR  NZ,GETL1V
000D9C 4D9C 211FF4          10      LD  HL,KBUF
000D9F 4D9F CD6043          17      CALL    MSX
000DA2 4DA2 18F1            12      JR  GETL1
       4DA4                     GETL1V:
000DA4 4DA4 5F               4      LD  E,A
000DA5 4DA5 FE08             7      CP  8
000DA7 4DA7 CC414E          17      CALL    Z,CTRL02
000DAA 4DAA FE20             7      CP  020H
000DAC 4DAC D46D4E          17      CALL    NC,INSERT
000DAF 4DAF CDD54C          17      CALL    MSGA1
                                
000DB2 4DB2 7B               4      LD  A,E
000DB3 4DB3 FE0D             7      CP  00DH
000DB5 4DB5 20DE            12      JR  NZ,GETL1
                                
000DB7 4DB7 111FF4          10      LD  DE,KBUF
000DBA 4DBA 3AB0F3          13      LD  A,(LINLEN)
000DBD 4DBD 47               4      LD  B,A
000DBE 4DBE CD1D50          17      CALL    ZERO_MEMORY_DE
                                
000DC1 4DC1 2ACAFB          16      LD  HL,(FSTPOS)
000DC4 4DC4 3ADCF3          13      LD  A,(CSRY)
000DC7 4DC7 6F               4      LD  L,A
000DC8 4DC8 E5              11      PUSH    HL
000DC9 4DC9 CD9E4E          17      CALL    LOC0
000DCC 4DCC 4D               4      LD  C,L
000DCD 4DCD 44               4      LD  B,H
000DCE 4DCE E1              10      POP HL
000DCF 4DCF 3AB0F3          13      LD  A,(LINLEN)
000DD2 4DD2 94               4      SUB H
000DD3 4DD3 3D               4      DEC A
000DD4 4DD4 5F               4      LD  E,A
000DD5 4DD5 211FF4          10      LD  HL,KBUF
       4DD8                     GETL2:
000DD8 4DD8 CD314E          17      CALL    _SCRN
000DDB 4DDB 03               6      INC BC
000DDC 4DDC 77               7      LD  (HL),A
000DDD 4DDD 23               6      INC HL
000DDE 4DDE 1D               4      DEC E
000DDF 4DDF 20F7            12      JR  NZ,GETL2
000DE1 4DE1 CDF24C          17      CALL    MSG_CR
                                
000DE4 4DE4 FDE1            14      POP IY
000DE6 4DE6 DDE1            14      POP IX
       4DE8                     GETL3:
000DE8 4DE8 2B               6      DEC HL
000DE9 4DE9 7E               7      LD  A,(HL)
000DEA 4DEA FE21             7      CP  021H
000DEC 4DEC D0              11      RET NC
000DED 4DED 3600            10      LD  (HL),0
000DEF 4DEF 15               4      DEC D
000DF0 4DF0 20F6            12      JR  NZ,GETL3
000DF2 4DF2 C9              10      RET
                                
       4DF3                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       4DF3                     CONSTX:
       4DF3                     CPM_CONST:
000DF3 4DF3 C5              11      PUSH    BC
000DF4 4DF4 D5              11      PUSH    DE
000DF5 4DF5 E5              11      PUSH    HL
000DF6 4DF6 DDE5            15      PUSH    IX
000DF8 4DF8 DD219C00        14      LD  IX,CHSNS
000DFC 4DFC CDE142          17      CALL    CALSLT_R
000DFF 4DFF DDE1            14      POP IX
000E01 4E01 E1              10      POP HL
000E02 4E02 D1              10      POP DE
000E03 4E03 C1              10      POP BC
000E04 4E04 C9              10      RET
                                
       4E05                     _SYS2A:     ;(BDOS)日付の獲得
000E05 4E05 AF               4      XOR A
000E06 4E06 57               4      LD  D,A
000E07 4E07 5F               4      LD  E,A
000E08 4E08 67               4      LD  H,A
000E09 4E09 6F               4      LD  L,A
000E0A 4E0A C9              10      RET
                                
       4E0B                     _SYS2C:     ;(BDOS)時刻の獲得
000E0B 4E0B AF               4      XOR A
000E0C 4E0C 57               4      LD  D,A
000E0D 4E0D 5F               4      LD  E,A
000E0E 4E0E 67               4      LD  H,A
000E0F 4E0F 6F               4      LD  L,A
000E10 4E10 C9              10      RET
                                
       4E11                     POS:
000E11 4E11 F5              11      PUSH    AF
000E12 4E12 2ADCF3          16      LD  HL,(CSRY)
000E15 4E15 7D               4      LD  A,L
000E16 4E16 6C               4      LD  L,H
000E17 4E17 67               4      LD  H,A
000E18 4E18 2C               4      INC L
000E19 4E19 24               4      INC H
000E1A 4E1A F1              10      POP AF
000E1B 4E1B C9              10      RET
                                
       4E1C                     LOC:
000E1C 4E1C F5              11      PUSH    AF
000E1D 4E1D E5              11      PUSH    HL
000E1E 4E1E 7D               4      LD  A,L
000E1F 4E1F 6C               4      LD  L,H
000E20 4E20 67               4      LD  H,A
000E21 4E21 2D               4      DEC L
000E22 4E22 25               4      DEC H
000E23 4E23 DDE5            15      PUSH    IX
000E25 4E25 DD21C600        14      LD  IX,POSIT
000E29 4E29 CDE142          17      CALL    CALSLT_R
000E2C 4E2C DDE1            14      POP IX
000E2E 4E2E E1              10      POP HL
000E2F 4E2F F1              10      POP AF
000E30 4E30 C9              10      RET
                                
       4E31                     _SCRN:
       4E31                     SCRN:
000E31 4E31 E5              11      PUSH    HL
000E32 4E32 DDE5            15      PUSH    IX
                                
000E34 4E34 69               4      LD  L,C
000E35 4E35 60               4      LD  H,B
000E36 4E36 DD214A00        14      LD  IX,RDVRM
000E3A 4E3A CDE142          17      CALL    CALSLT_R
                                
000E3D 4E3D DDE1            14      POP IX
000E3F 4E3F E1              10      POP HL
000E40 4E40 C9              10      RET
                                
       4E41                     CTRL02:
000E41 4E41 F5              11      PUSH    AF
000E42 4E42 D5              11      PUSH    DE
000E43 4E43 2ADCF3          16      LD  HL,(CSRY)
000E46 4E46 3AB0F3          13      LD  A,(LINLEN)
000E49 4E49 4F               4      LD  C,A
000E4A 4E4A 94               4      SUB H   ;CSRX
000E4B 4E4B C602             7      ADD A,2
000E4D 4E4D 47               4      LD  B,A ;カーソルより右の文字数
000E4E 4E4E 61               4      LD  H,C ;LINLEN
000E4F 4E4F C5              11      PUSH    BC
000E50 4E50 CD9E4E          17      CALL    LOC0
000E53 4E53 C1              10      POP BC
                                
000E54 4E54 1620             7      LD  D,020H
       4E56                     C8X1:
000E56 4E56 DD214A00        14      LD  IX,RDVRM
000E5A 4E5A CDE142          17      CALL    CALSLT_R
000E5D 4E5D 4F               4      LD  C,A
000E5E 4E5E 7A               4      LD  A,D
000E5F 4E5F DD214D00        14      LD  IX,WRTVRM
000E63 4E63 CDE142          17      CALL    CALSLT_R
000E66 4E66 2B               6      DEC HL
000E67 4E67 51               4      LD  D,C
000E68 4E68 10EC            13      DJNZ    C8X1
000E6A 4E6A D1              10      POP DE
000E6B 4E6B F1              10      POP AF
000E6C 4E6C C9              10      RET
                                
       4E6D                     INSERT:
000E6D 4E6D F5              11      PUSH    AF
000E6E 4E6E D5              11      PUSH    DE
000E6F 4E6F 2ADCF3          16      LD  HL,(CSRY)
000E72 4E72 3AB0F3          13      LD  A,(LINLEN)
000E75 4E75 4F               4      LD  C,A
000E76 4E76 94               4      SUB H   ;CSRX
000E77 4E77 3C               4      INC A
000E78 4E78 47               4      LD  B,A ;カーソルより右の文字数
000E79 4E79 C5              11      PUSH    BC
000E7A 4E7A CD9E4E          17      CALL    LOC0
000E7D 4E7D C1              10      POP BC
                                
000E7E 4E7E 1620             7      LD  D,020H
       4E80                     INS1:
000E80 4E80 DD214A00        14      LD  IX,RDVRM
000E84 4E84 CDE142          17      CALL    CALSLT_R
000E87 4E87 4F               4      LD  C,A
000E88 4E88 7A               4      LD  A,D
000E89 4E89 DD214D00        14      LD  IX,WRTVRM
000E8D 4E8D CDE142          17      CALL    CALSLT_R
000E90 4E90 23               6      INC HL
000E91 4E91 51               4      LD  D,C
000E92 4E92 10EC            13      DJNZ    INS1
000E94 4E94 D1              10      POP DE
000E95 4E95 F1              10      POP AF
000E96 4E96 C9              10      RET
                                
       4E97                     CONOUT1:
000E97 4E97 59               4      LD  E,C
000E98 4E98 C3CB4C          10      JP  _PRINT
                                
       4E9B                     GETVRAM:
000E9B 4E9B 2ADCF3          16      LD  HL,(CSRY)
       4E9E                     LOC0:
000E9E 4E9E 2D               4      DEC L
000E9F 4E9F 25               4      DEC H
000EA0 4EA0 4C               4      LD  C,H ;CSRX-1
000EA1 4EA1 5D               4      LD  E,L ;CSRY-1
       4EA2                     LOC1:
000EA2 4EA2 3AB0F3          13      LD  A,(LINLEN)
000EA5 4EA5 67               4      LD  H,A
000EA6 4EA6 1600             7      LD  D,0
000EA8 4EA8 6A               4      LD  L,D ;0
000EA9 4EA9 0608             7      LD  B,8
       4EAB                     LOC2:
000EAB 4EAB 29              11      ADD HL,HL
000EAC 4EAC 3001            12      JR  NC,LOC3
000EAE 4EAE 19              11      ADD HL,DE
       4EAF                     LOC3:
000EAF 4EAF 10FA            13      DJNZ    LOC2
000EB1 4EB1 09              11      ADD HL,BC
000EB2 4EB2 C9              10      RET
                                
       4EB3                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000EB3 4EB3 212200          10      LD  HL,00022H
000EB6 4EB6 AF               4      XOR A
000EB7 4EB7 7D               4      LD  A,L
000EB8 4EB8 C9              10      RET
                                
       4EB9                     _SYS0D:     ;(BDOS)ディスク・リセット
000EB9 4EB9 218000          10      LD  HL,00080H
000EBC 4EBC 222EF1          16      LD  (_DTA),HL
000EBF 4EBF C9              10      RET
                                
       4EC0                     _SYS0E:     ;(BDOS)カレントドライブの設定
000EC0 4EC0 3242F1          13      LD  (_DVSW),A
000EC3 4EC3 C9              10      RET
                                
       4EC4                     _SYS0F:     ;(BDOS)ファイルのオープン
000EC4 4EC4 D5              11      PUSH    DE
000EC5 4EC5 FDE1            14      POP IY
000EC7 4EC7 CD0D50          17      CALL    INIT_FILE
000ECA 4ECA CD9248          17      CALL    ROM_OPEN
000ECD 4ECD 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
000ECF 4ECF FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
000ED3 4ED3 FDE5            15      PUSH    IY
000ED5 4ED5 D1              10      POP DE
000ED6 4ED6 13               6      INC DE
000ED7 4ED7 010B00          10      LD  BC,11
000EDA 4EDA EDB0                    LDIR
                                ;               Attribute
000EDC 4EDC 7E               7      LD  A,(HL)
000EDD 4EDD FD770D          19      LD  (IY+13),A
                                ;               TIME
000EE0 4EE0 110B00          10      LD  DE,11
000EE3 4EE3 19              11      ADD HL,DE
000EE4 4EE4 7E               7      LD  A,(HL)
000EE5 4EE5 23               6      INC HL
000EE6 4EE6 FD7716          19      LD  (IY+22),A
000EE9 4EE9 7E               7      LD  A,(HL)
000EEA 4EEA 23               6      INC HL
000EEB 4EEB FD7717          19      LD  (IY+23),A
                                ;               DATE
000EEE 4EEE 7E               7      LD  A,(HL)
000EEF 4EEF 23               6      INC HL
000EF0 4EF0 FD7714          19      LD  (IY+20),A
000EF3 4EF3 7E               7      LD  A,(HL)
000EF4 4EF4 23               6      INC HL
000EF5 4EF5 FD7715          19      LD  (IY+21),A
                                ;               First cluster
000EF8 4EF8 7E               7      LD  A,(HL)
000EF9 4EF9 23               6      INC HL
000EFA 4EFA FD771A          19      LD  (IY+26),A
000EFD 4EFD 7E               7      LD  A,(HL)
000EFE 4EFE 23               6      INC HL
000EFF 4EFF FD771B          19      LD  (IY+27),A
                                ;               SIZE
000F02 4F02 7E               7      LD  A,(HL)
000F03 4F03 23               6      INC HL
000F04 4F04 FD7710          19      LD  (IY+16),A
000F07 4F07 7E               7      LD  A,(HL)
000F08 4F08 23               6      INC HL
000F09 4F09 FD7711          19      LD  (IY+17),A
000F0C 4F0C 7E               7      LD  A,(HL)
000F0D 4F0D 23               6      INC HL
000F0E 4F0E FD7712          19      LD  (IY+18),A
000F11 4F11 7E               7      LD  A,(HL)
000F12 4F12 FD7713          19      LD  (IY+19),A
000F15 4F15 AF               4      XOR A
000F16 4F16 FD770C          19      LD  (IY+12),A
000F19 4F19 C9              10      RET
                                
       4F1A                     _SYS10:     ;(BDOS)ファイルのクローズ
000F1A 4F1A AF               4      XOR A
000F1B 4F1B C9              10      RET
                                
       4F1C                     S11X1:
000F1C 4F1C FD7119          19      LD  (IY+25),C       ;RootEntCnt
000F1F 4F1F FD750E          19      LD  (IY+14),L
000F22 4F22 FD740F          19      LD  (IY+15),H
       4F25                     SCF_FF_RET:
000F25 4F25 37               4      SCF
000F26 4F26 9F               4      SBC A,A
000F27 4F27 C9              10      RET
                                
       4F28                     _SYS11:     ;(BDOS)最初のファイルの検索
000F28 4F28 ED5336F1        20      LD  (_FCB),DE
000F2C 4F2C D5              11      PUSH    DE
000F2D 4F2D FDE1            14      POP IY
000F2F 4F2F CD0D50          17      CALL    INIT_FILE
000F32 4F32 CDBA4A          17      CALL    GET_DIR_DAT
       4F35                     S12X1:
000F35 4F35 CDAE48          17      CALL    FILESE
000F38 4F38 30E2            12      JR  NC,S11X1
000F3A 4F3A 0D               4      DEC C
000F3B 4F3B FD7119          19      LD  (IY+25),C       ;RootEntCnt
000F3E 4F3E 012000          10      LD  BC,32
000F41 4F41 ED5B2EF1        20      LD  DE,(_DTA)
000F45 4F45 AF               4      XOR A
000F46 4F46 12               7      LD  (DE),A      ;ドライブ番号
000F47 4F47 13               6      INC DE
000F48 4F48 EDB0                    LDIR            ;ディレクトリエントリ
000F4A 4F4A FD750E          19      LD  (IY+14),L
000F4D 4F4D FD740F          19      LD  (IY+15),H
000F50 4F50 C9              10      RET
                                
       4F51                     _SYS12:
000F51 4F51 FD2A36F1        20      LD  IY,(_FCB)
000F55 4F55 FDE5            15      PUSH    IY
000F57 4F57 D1              10      POP DE
000F58 4F58 CD0D50          17      CALL    INIT_FILE
                                
000F5B 4F5B FD6E0E          19      LD  L,(IY+14)
000F5E 4F5E FD660F          19      LD  H,(IY+15)
000F61 4F61 FD4E19          19      LD  C,(IY+25)
000F64 4F64 18CF            12      JR  S12X1
                                
       4F66                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000F66 4F66 CDA04A          17      CALL    SET_FCB
000F69 4F69 CD6E4A          17      CALL    GETSEQ
000F6C 4F6C CD5B4A          17      CALL    RB_READ
000F6F 4F6F E5              11      PUSH    HL
000F70 4F70 CD7B4A          17      CALL    SETSEQ
000F73 4F73 E1              10      POP HL
       4F74                     SREAD:
000F74 4F74 C601             7      ADD A,001H
000F76 4F76 D8              11      RET C
                                
000F77 4F77 7D               4      LD  A,L
000F78 4F78 D601             7      SUB 001H
000F7A 4F7A 9F               4      SBC A,A
000F7B 4F7B E603             7      AND 3
000F7D 4F7D 1F               4      RRA
000F7E 4F7E C9              10      RET
                                
       4F7F                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000F7F 4F7F 210100          10      LD  HL,00001H
000F82 4F82 AF               4      XOR A
000F83 4F83 C9              10      RET
                                
       4F84                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000F84 4F84 3A42F1          13      LD  A,(_DVSW)
000F87 4F87 C9              10      RET
                                
       4F88                     _SYS1A:     ;(BDOS)DTAの設定
000F88 4F88 ED532EF1        20      LD  (_DTA),DE
000F8C 4F8C AF               4      XOR A
000F8D 4F8D C9              10      RET
                                
       4F8E                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000F8E 4F8E 010002          10      LD  BC,512
000F91 4F91 11C302          10      LD  DE,707
000F94 4F94 210000          10      LD  HL,0
000F97 4F97 DD2138F1        14      LD  IX,_BUF
000F9B 4F9B FD2138F1        14      LD  IY,_BUF
000F9F 4F9F FD3600F9        19      LD  (IY+0),0F9H
000FA3 4FA3 3E02             7      LD  A,2
000FA5 4FA5 C9              10      RET
                                
       4FA6                     _SYS21:     ;(BDOS)ランダムな読み出し
000FA6 4FA6 CDA04A          17      CALL    SET_FCB
                                
000FA9 4FA9 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
000FAC 4FAC FD6622          19      LD  H,(IY+34)
                                
000FAF 4FAF CD5B4A          17      CALL    RB_READ
000FB2 4FB2 18C0            12      JR  SREAD
                                
       4FB4                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
000FB4 4FB4 CDC44E          17      CALL    _SYS0F
000FB7 4FB7 D8              11      RET C
                                
000FB8 4FB8 D5              11      PUSH    DE      ;EX DE,IY
000FB9 4FB9 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000FBB 4FBB CD904A          17      CALL    GETSIZE
       4FBE                     _S24X1:
000FBE 4FBE FD7521          19      LD  (IY+33),L   ;(FCB)Random record
000FC1 4FC1 FD7422          19      LD  (IY+34),H
000FC4 4FC4 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000FC8 4FC8 FDE3            23      EX  (SP),IY     ;
000FCA 4FCA D1              10      POP DE      ;
                                
000FCB 4FCB AF               4      XOR A
000FCC 4FCC C9              10      RET
                                
       4FCD                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
000FCD 4FCD E5              11      PUSH    HL
000FCE 4FCE D5              11      PUSH    DE      ;EX DE,IY
000FCF 4FCF FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000FD1 4FD1 CD6E4A          17      CALL    GETSEQ
000FD4 4FD4 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       4FD6                     _SYS27:     ;(BDOS)ランダムブロック読み込み
000FD6 4FD6 CDA04A          17      CALL    SET_FCB
000FD9 4FD9 E5              11      PUSH    HL
000FDA 4FDA FD6E21          19      LD  L,(IY+33)
000FDD 4FDD FD6622          19      LD  H,(IY+34)
000FE0 4FE0 2224F1          16      LD  (RR_LOW),HL
000FE3 4FE3 FD6E23          19      LD  L,(IY+35)
000FE6 4FE6 FD6624          19      LD  H,(IY+36)
000FE9 4FE9 2226F1          16      LD  (RR_HIGH),HL
000FEC 4FEC E1              10      POP HL
000FED 4FED CDB246          17      CALL    ROM_READ
000FF0 4FF0 ED5B24F1        20      LD  DE,(RR_LOW)
000FF4 4FF4 FD7321          19      LD  (IY+33),E
000FF7 4FF7 FD7222          19      LD  (IY+34),D
000FFA 4FFA ED5B26F1        20      LD  DE,(RR_HIGH)
000FFE 4FFE FD7323          19      LD  (IY+35),E
001001 5001 FD7224          19      LD  (IY+36),D
001004 5004 9F               4      SBC A,A
001005 5005 C9              10      RET
                                
       5006                     _SYS2F:
001006 5006 44               4      LD  B,H
001007 5007 2A2EF1          16      LD  HL,(_DTA)
00100A 500A C3F34A          10      JP  DISKIO
                                
       500D                     INIT_FILE:
00100D 500D EB               4      EX  DE,HL
00100E 500E 114BF1          10      LD  DE,FDRV
001011 5011 010C00          10      LD  BC,1+8+3
001014 5014 EDB0                    LDIR
001016 5016 CD774C          17      CALL    GET_DISK_BANK_FDRV
001019 5019 320068          13      LD  (BANK1_SEL),A
00101C 501C C9              10      RET
                                
       501D                     ZERO_MEMORY_DE:
00101D 501D AF               4      XOR A
       501E                     FILL_MEMORY_DE:
00101E 501E 12               7      LD  (DE),A
00101F 501F 13               6      INC DE
001020 5020 10FC            13      DJNZ    FILL_MEMORY_DE
001022 5022 C9              10      RET
                                
001023 5023                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 B84CCE4CFF4CB84C        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 B84CB84C044D454D        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 0C4DB84C5F4DF34D        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 B34EB94EC04EC44E        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 1A4F284F514FB84C        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 664FB84CB84CB84C        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 7F4F844F884F8E4F        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 B84CB84CB84CB44F        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 CD4FB84CB84CD64F        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 B84CB84C054EB84C        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 0B4EB84CB84C0650        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB8 5FB8 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 B84CB84CB84CB84C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
