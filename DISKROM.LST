                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
                                ;PTRFIL EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
                                ;FILNAM EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FDDB                     H_PINL  EQU 0FDDBH
                                
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;ASCII-16K
       6000                     ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
       7000                     ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                            ;KONAMI-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;KONAMI-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                
       F280                     ISC EQU 0F280H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
[EOF:DEF.ASM:UTF_8]
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM    ; Main program execution address.
000004 4004 D84D                    DW  STATEMENT   ; STATEMENT
000006 4006 424E                    DW  DEVICE1     ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C3794E          10      JP  DISKIO
000013 4013 C3B44E          10      JP  DSKCHG
000016 4016 C30A4F          10      JP  GETDPB
000019 4019 C3FD4F          10      JP  CHOICE
00001C 401C C30150          10      JP  DSKFMT
00001F 401F C30350          10      JP  DSKSTP
000022 4022 C30450          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C30150          10      JP  DSKFMT
000029 4029 C30350          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C34050          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.2.0.5",0
            204449534B20524F    
            4D204C6974652076    
            302E322E302E3500    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 214BFC          10      LD  HL,HIMEM+1
000109 4109 35              11      DEC (HL)
00010A 410A 2173F6          10      LD  HL,MEMSIZ+1
00010D 410D 35              11      DEC (HL)
00010E 410E 2175F6          10      LD  HL,STKTOP+1
000111 4111 35              11      DEC (HL)
000112 4112 2A74F6          16      LD  HL,(STKTOP)
000115 4115 5D               4      LD  E,L
000116 4116 54               4      LD  D,H
000117 4117 24               4      INC H
000118 4118 012000          10      LD  BC,00020H
00011B 411B EDB8                    LDDR
00011D 411D 2100FF          10      LD  HL,-00100H
000120 4120 39              11      ADD HL,SP
000121 4121 22F9F2          16      LD  (_SP),HL
000124 4124 ED7BF9F2        20      LD  SP,(_SP)
                                
000128 4128 3EFF             7      LD  A,0FFH
00012A 412A 3299FD          13      LD  (DEVICE),A
                                
00012D 412D 3E01             7      LD  A,1
00012F 412F 3221FB          13      LD  (DRVTBL),A
                                
000132 4132 AF               4      XOR A
000133 4133 32DDF2          13      LD  (_DVSW),A
                                
000136 4136 210243          10      LD  HL,AT_ISC
000139 4139 1180F2          10      LD  DE,ISC
00013C 413C 017B00          10      LD  BC,ISC_E-ISC
00013F 413F EDB0                    LDIR
                                    
000141 4141 3EC3             7      LD  A,0C3H      ;JP
000143 4143 3243FF          13      LD  (H_GONE),A
000146 4146 327DF3          13      LD  (BDOS),A
000149 4149 326BF3          13      LD  (RAMUSE),A
00014C 414C 3268F3          13      LD  (ROMUSE),A
00014F 414F 2180F2          10      LD  HL,REPLACE_COMMAND
000152 4152 2244FF          16      LD  (H_GONE+1),HL
000155 4155 2131F3          10      LD  HL,H_BDOS
000158 4158 227EF3          16      LD  (BDOS+1),HL
00015B 415B 21B0F2          10      LD  HL,RAMUSE1
00015E 415E 226CF3          16      LD  (RAMUSE+1),HL
000161 4161 21ABF2          10      LD  HL,ROMUSE1
000164 4164 2269F3          16      LD  (ROMUSE+1),HL
                                
000167 4167 3E                      DB  03EH
000168 4168 F7              12      RST 30H
000169 4169 3271FE          13      LD  (H_BINS),A
00016C 416C 3276FE          13      LD  (H_BINL),A
00016F 416F 327BFE          13      LD  (H_FILE),A
000172 4172 3231F3          13      LD  (H_BDOS),A
000175 4175 32DBFD          13      LD  (H_PINL),A
000178 4178 32A7FF          13      LD  (H_PHYD),A
                                
00017B 417B CD4242          17      CALL    GTSL1_
00017E 417E 3297F2          13      LD  (ROM_SLT),A
000181 4181 32A7F2          13      LD  (ROM_SLT_COPY),A
000184 4184 3272FE          13      LD  (H_BINS+1),A
000187 4187 3277FE          13      LD  (H_BINL+1),A
00018A 418A 327CFE          13      LD  (H_FILE+1),A
00018D 418D 3232F3          13      LD  (H_BDOS+1),A
000190 4190 32DCFD          13      LD  (H_PINL+1),A
000193 4193 32A8FF          13      LD  (H_PHYD+1),A
000196 4196 3222FB          13      LD  (DRVTBL+1),A
000199 4199 3248F3          13      LD  (MASTERS),A
                                
00019C 419C 210E45          10      LD  HL,ROM_LOAD
00019F 419F 2273FE          16      LD  (H_BINS+2),HL
0001A2 41A2 214346          10      LD  HL,ROM_RUN
0001A5 41A5 2278FE          16      LD  (H_BINL+2),HL
0001A8 41A8 215046          10      LD  HL,ROM_FILES
0001AB 41AB 227DFE          16      LD  (H_FILE+2),HL
0001AE 41AE 219C50          10      LD  HL,ROM_BDOS
0001B1 41B1 2233F3          16      LD  (H_BDOS+2),HL
0001B4 41B4 21A743          10      LD  HL,ROM_BOOT
0001B7 41B7 22DDFD          16      LD  (H_PINL+2),HL
0001BA 41BA 21794E          10      LD  HL,DISKIO
0001BD 41BD 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001C0 41C0 3E                      DB  03EH
0001C1 41C1 C9              10      RET
0001C2 41C2 327FFE          13      LD  (H_FILE+4),A
0001C5 41C5 3275FE          13      LD  (H_BINS+4),A
0001C8 41C8 327AFE          13      LD  (H_BINL+4),A
0001CB 41CB 3235F3          13      LD  (H_BDOS+4),A
0001CE 41CE 32DFFD          13      LD  (H_PINL+4),A
0001D1 41D1 32ABFF          13      LD  (H_PHYD+4),A
                                
0001D4 41D4 AF               4      XOR A
0001D5 41D5 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001D8 41D8 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0001DB 41DB 3A0060          13      LD  A,(BANK1_ADR)
0001DE 41DE FE41             7      CP  'A'
                                #if exists USE_NORMAL_32K_ROM
                                    JR  Z,NOT_BANK_TYPE
                                    LD  A,DISK_BANK
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0001E0 41E0 204F            12      JR  NZ,NOT_BANK_TYPE
0001E2 41E2 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001E5 41E5 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001E8 41E8 CD3801          17      CALL    RSLREG      ;read primary slot #
0001EB 41EB 07               4      RLCA
0001EC 41EC 07               4      RLCA
0001ED 41ED F5              11      PUSH    AF
0001EE 41EE 1605             7      LD  D,4+1
0001F0 41F0 CD4942          17      CALL    GTSL2_
0001F3 41F3 3244F3          13      LD  (RAMAD3),A
0001F6 41F6 F1              10      POP AF
0001F7 41F7 07               4      RLCA
0001F8 41F8 07               4      RLCA
0001F9 41F9 1603             7      LD  D,2+1
0001FB 41FB CD4942          17      CALL    GTSL2_
0001FE 41FE 2680             7      LD  H,080H
000200 4200 CD6642          17      CALL    CHK_RAM
000203 4203 3243F3          13      LD  (RAMAD2),A
       4206                     RAMCHK2:
000206 4206 3A44F3          13      LD  A,(RAMAD3)
000209 4209 2640             7      LD  H,040H
00020B 420B CD6642          17      CALL    CHK_RAM
00020E 420E 3242F3          13      LD  (RAMAD1),A
       4211                     RAMCHK1:
000211 4211 3A44F3          13      LD  A,(RAMAD3)
000214 4214 2600             7      LD  H,00H
000216 4216 CD6642          17      CALL    CHK_RAM
000219 4219 3241F3          13      LD  (RAMAD0),A
       421C                     RAMCHK0:
00021C 421C 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
00021F 421F 010F00          10      LD  BC,0000FH       ;切り上げ
000222 4222 09              11      ADD HL,BC
000223 4223 7D               4      LD  A,L
                                
000224 4224 0604             7      LD  B,4
       4226                     B_DRIVE1:
000226 4226 CB3C             8      SRL H
000228 4228 1F               4      RRA
000229 4229 10FB            13      DJNZ    B_DRIVE1
                                
00022B 422B C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
00022D 422D 32DCF2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
000230 4230 C9              10      RET
                                
       4231                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
000231 4231 21E543          10      LD  HL,MSG_ERROR_ROM_MODE
000234 4234 CD8043          17      CALL    MSX
000237 4237 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00023B 423B DD219F00        14      LD  IX,CHGET
00023F 423F C31C00          10      JP  _CALSLT
                                
       4242                     GTSL1_:             ;自分のいるスロットを知る
000242 4242 CD3801          17      CALL    RSLREG      ;read primary slot #
000245 4245 0F               4      RRCA
000246 4246 0F               4      RRCA
000247 4247 1601             7      LD  D,1
       4249                     GTSL2_:
000249 4249 E603             7      AND 3       ;[A]=000000PP
00024B 424B 5F               4      LD  E,A     ;[E]=000000PP
00024C 424C 21C1FC          10      LD  HL,EXPTBL
00024F 424F 85               4      ADD A,L     ;桁上りは無い
000250 4250 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000251 4251 7B               4      LD  A,E     ;[A]=000000PP
000252 4252 CB7E            13      BIT 7,(HL)
000254 4254 C8              11      RET Z
000255 4255 7D               4      LD  A,L     ;point to SLTTBL entry
000256 4256 C604             7      ADD A,4     ;桁上りは無い
000258 4258 6F               4      LD  L,A
000259 4259 7E               7      LD  A,(HL)      ;get currently expansion slot register
       425A                     GTSL3_:
00025A 425A 15               4      DEC D
00025B 425B 2803            12      JR  Z,GTSL4_:
00025D 425D 0F               4      RRCA
00025E 425E 18FA            12      JR  GTSL3_:
       4260                     GTSL4_:
000260 4260 E60C             7      AND 00CH        ;[A] = 0000SS00
000262 4262 B3               4      OR  E       ;[A] = 0000SSPP
000263 4263 F680             7      OR  080H        ;[A] = 1000SSPP
000265 4265 C9              10      RET
                                
       4266                     CHK_RAM:
000266 4266 E5              11      PUSH    HL
000267 4267 CDBB42          17      CALL    CHK_RAM0
00026A 426A E1              10      POP HL
00026B 426B C8              11      RET Z
00026C 426C 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
00026F 426F E680             7      AND 080H
000271 4271 CD9242          17      CALL    CHK_RAM_SLT
000274 4274 C8              11      RET Z
000275 4275 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000278 4278 E680             7      AND 080H
00027A 427A C601             7      ADD A,1
00027C 427C CD9242          17      CALL    CHK_RAM_SLT
00027F 427F C8              11      RET Z
000280 4280 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000283 4283 E680             7      AND 080H
000285 4285 C602             7      ADD A,2
000287 4287 CD9242          17      CALL    CHK_RAM_SLT
00028A 428A C8              11      RET Z
00028B 428B 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
00028E 428E E680             7      AND 080H
000290 4290 C603             7      ADD A,3
       4292                     CHK_RAM_SLT:
000292 4292 E5              11      PUSH    HL
000293 4293 CDBB42          17      CALL    CHK_RAM0        ;スロット#X or X-0
000296 4296 E1              10      POP HL
000297 4297 C8              11      RET Z
000298 4298 CB79             8      BIT 7,C
00029A 429A 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
00029C 429C 79               4      LD  A,C
00029D 429D C604             7      ADD A,4*1           ;スロット#X-1
00029F 429F E5              11      PUSH    HL
0002A0 42A0 CDBB42          17      CALL    CHK_RAM0
0002A3 42A3 E1              10      POP HL
0002A4 42A4 C8              11      RET Z
0002A5 42A5 79               4      LD  A,C
0002A6 42A6 C608             7      ADD A,4*2           ;スロット#X-2
0002A8 42A8 E5              11      PUSH    HL
0002A9 42A9 CDBB42          17      CALL    CHK_RAM0
0002AC 42AC E1              10      POP HL
0002AD 42AD C8              11      RET Z
0002AE 42AE 79               4      LD  A,C
0002AF 42AF C60C             7      ADD A,4*3           ;スロット#X-3
0002B1 42B1 E5              11      PUSH    HL
0002B2 42B2 CDBB42          17      CALL    CHK_RAM0
0002B5 42B5 E1              10      POP HL
       42B6                     CHK_RAM_E:
0002B6 42B6 AF               4      XOR A
0002B7 42B7 3C               4      INC A           ;ZF=0にする
0002B8 42B8 3E00             7      LD  A,0
0002BA 42BA C9              10      RET
                                
       42BB                     CHK_RAM0:
0002BB 42BB 4F               4      LD  C,A
0002BC 42BC 3A97F2          13      LD  A,(ROM_SLT)
0002BF 42BF B9               4      CP  C
0002C0 42C0 28F4            12      JR  Z,CHK_RAM_E
0002C2 42C2 2E00             7      LD  L,0
       42C4                     CHK_RAM1:
0002C4 42C4 79               4      LD  A,C
0002C5 42C5 DD210C00        14      LD  IX,_RDSLT
0002C9 42C9 CDF642          17      CALL    CALSLT_R
0002CC 42CC C6E5             7      ADD A,0E5H
0002CE 42CE 47               4      LD  B,A
0002CF 42CF 5F               4      LD  E,A
0002D0 42D0 79               4      LD  A,C
0002D1 42D1 DD211400        14      LD  IX,_WRSLT
0002D5 42D5 CDF642          17      CALL    CALSLT_R
0002D8 42D8 79               4      LD  A,C
0002D9 42D9 DD210C00        14      LD  IX,_RDSLT
0002DD 42DD CDF642          17      CALL    CALSLT_R
0002E0 42E0 B8               4      CP  B
0002E1 42E1 C0              11      RET NZ
0002E2 42E2 D6E5             7      SUB 0E5H
0002E4 42E4 79               4      LD  A,C
0002E5 42E5 5F               4      LD  E,A
0002E6 42E6 DD211400        14      LD  IX,_WRSLT
0002EA 42EA CDF642          17      CALL    CALSLT_R
0002ED 42ED 24               4      INC H
0002EE 42EE 7D               4      LD  A,L
0002EF 42EF C604             7      ADD A,4
0002F1 42F1 6F               4      LD  L,A
0002F2 42F2 20D0            12      JR  NZ,CHK_RAM1
0002F4 42F4 79               4      LD  A,C     ;ZF=1のハズ
0002F5 42F5 C9              10      RET
                                
       42F6                     CALSLT_R:
0002F6 42F6 C5              11      PUSH    BC
0002F7 42F7 E5              11      PUSH    HL
0002F8 42F8 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0002FC 42FC CD1C00          17      CALL    _CALSLT
0002FF 42FF E1              10      POP HL
000300 4300 C1              10      POP BC
000301 4301 C9              10      RET
                                
       4302                     AT_ISC:
000302 F280                         ORG ISC,AT_ISC-RUN
       F280                     REPLACE_COMMAND:
000302 F280 FEB7             7      CP  0B7H            ;FILES
000304 F282 CC7BFE          17      CALL    Z,H_FILE
000307 F285 FEB5             7      CP  0B5H            ;LOAD
000309 F287 CA71FE          10      JP  Z,H_BINS
00030C F28A FE8A             7      CP  08AH            ;RUN
00030E F28C CA76FE          10      JP  Z,H_BINL
000311 F28F FED6             7      CP  0D6H            ;COPY
000313 F291 2813            12      JR  Z,FIX_COPY
000315 F293 FECF             7      CP  0CFH            ;BLOAD
000317 F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
000318 F296 F7              12      RST 30H
       F297                     ROM_SLT:
000319 F297 00                      DB  0
00031A F298 7945                    DW  ROM_BLOAD
00031C F29A F5              11      PUSH    AF
00031D F29B E5              11      PUSH    HL
00031E F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
000321 F29F E1              10      POP HL
000322 F2A0 F1              10      POP AF
000323 F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
000325 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
000327 F2A5 C9              10      RET
       F2A6                     FIX_COPY:
000328 F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
000329 F2A7 00                      DB  0
00032A F2A8 DF46                    DW  ROM_COPY
00032C F2AA C9              10      RET
       F2AB                     ROMUSE1:
00032D F2AB 3A97F2          13      LD  A,(ROM_SLT)
000330 F2AE 1803            12      JR  ROMUSE2
       F2B0                     RAMUSE1:
000332 F2B0 3A42F3          13      LD  A,(RAMAD1)
       F2B3                     ROMUSE2:
000335 F2B3 C32400          10      JP  _ENASLT
                                
       F2B6                     _RESULT:
000338 F2B6 00                      DB  0
       F2B7                     _BANK:
000339 F2B7 00                      DB  0
       F2B8                     _BANK1:
00033A F2B8 00                      DB  0
       F2B9                     CLSZ:               ;クラスタサイズ
00033B F2B9 0004                    DW  1024
       F2BA                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2BB                     SECSZ:              ;セクタサイズ
00033D F2BB 0002                    DW  512
       F2BC                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2BD                     RR_LOW:
00033F F2BD 0000                    DW  0
       F2BE                     RR_MID  EQU $-1
       F2BF                     RR_HIGH:
000341 F2BF 0000                    DW  0
       F2C1                     _CLPS:
000343 F2C1 0000                    DW  0
       F2C3                     _LEFT:
000345 F2C3 0000                    DW  0
       F2C5                     _DTPS:
000347 F2C5 0000                    DW  0
       F2C7                     _DTA:
000349 F2C7 0000                    DW  0
       F2C9                     FLG_LDIR:
00034B F2C9 00                      DB  0
       F2CA                     _FCB:
00034C F2CA 0000                    DW  0
       F2CC                     _BUF:
       F2CC                     _BUF_LO:        ;LOGICAL OPERATION
00034E F2CC 00                      DB  0
       F2CD                     _BUF_ST:
00034F F2CD 0000                    DW  0
       F2CF                     _BUF_EN:
000351 F2CF 0000                    DW  0
       F2D1                     _BUF_EX:
       F2D1                     _BUF_W:
000353 F2D1 0000                    DW  0
       F2D3                     _BUF_H:
000355 F2D3 0000                    DW  0
       F2D5                     _BUF_X:
000357 F2D5 0000                    DW  0
       F2D7                     _BUF_Y:
000359 F2D7 00                      DB  0
       F2D8                     _BUF_P:
00035A F2D8 00                      DB  0
       F2D9                     _BUF_O:
00035B F2D9 00                      DB  0
       F2DA                     DTAX:
00035C F2DA 0000                    DW  0
       F2DC                     B_DRIVE:
00035E F2DC 00                      DB  0
       F2DD                     _DVSW:          ;カレントドライブ
00035F F2DD 00                      DB  0
       F2DE                     _CD:            ;カレントディレクトリ
000360 F2DE 0000                    DW  0
       F2E0                     DIRENT1:
000362 F2E0 0000                    DW  0
       F2E2                     _DIR_BANK:
000364 F2E2 00                      DB  0
       F2E3                     LEFTX:
000365 F2E3 0000                    DW  0
       F2E5                     PARAM0:
000367 F2E5 0000                    DW  0
       F2E7                     PARAM1:
000369 F2E7 0000                    DW  0
       F2E9                     _CDX:
00036B F2E9 0000                    DW  0
       F2EB                     FDRV:
00036D F2EB 00                      DB  0
       F2EC                     FNAME:
00036E F2EC                         DS  8+3
       F2F7                     _HL:
000379 F2F7 0000                    DW  0
       F2F9                     _SP:
00037B F2F9 0000                    DW  0
                                
       F2FB                     ISC_E:
00037D 437D                         ORG $$+RUN          ;$DEPHASE
                                
       437D                     MSX1:
00037D 437D CDB550          17      CALL    MSGA1
       4380                     MSX:
000380 4380 7E               7      LD  A,(HL)
000381 4381 23               6      INC HL
000382 4382 B7               4      OR  A
000383 4383 20F8            12      JR  NZ,MSX1
000385 4385 C9              10      RET
                                
       4386                     PRTHX:
000386 4386 F5              11      PUSH    AF
000387 4387 07               4      RLCA
000388 4388 07               4      RLCA
000389 4389 07               4      RLCA
00038A 438A 07               4      RLCA
00038B 438B CD8F43          17      CALL    PRTA2
00038E 438E F1              10      POP AF
       438F                     PRTA2:
00038F 438F CD9543          17      CALL    ASC
000392 4392 C3B150          10      JP  MSG_A
                                    
       4395                     ASC:
000395 4395 E60F             7      AND $0F
000397 4397 F630             7      OR  $30
000399 4399 FE3A             7      CP  $3A
00039B 439B D8              11      RET C
00039C 439C C607             7      ADD A,7
00039E 439E C9              10      RET
                                
       439F                     MSN:
00039F 439F 7E               7      LD  A,(HL)
0003A0 43A0 23               6      INC HL
0003A1 43A1 CDB150          17      CALL    MSG_A
0003A4 43A4 10F9            13      DJNZ    MSN
0003A6 43A6 C9              10      RET
                                
       43A7                     ROM_BOOT:
0003A7 43A7 3E                      DB  03EH
0003A8 43A8 C9              10      RET
0003A9 43A9 32DBFD          13      LD  (H_PINL),A
0003AC 43AC 3ACAFF          13      LD  A,(EXTBIO)
0003AF 43AF FEF7             7      CP  0F7H        ;RST 30H
0003B1 43B1 2805            12      JR  Z,EXTBIO_OK
0003B3 43B3 3E                      DB  03EH
0003B4 43B4 C9              10      RET
0003B5 43B5 32CAFF          13      LD  (EXTBIO),A
       43B8                     EXTBIO_OK:
0003B8 43B8 210B44          10      LD  HL,DELOK
0003BB 43BB CD8043          17      CALL    MSX
                                
0003BE 43BE AF               4      XOR A
0003BF 43BF 3240F3          13      LD  (REBOOT),A
0003C2 43C2 2A48FC          16      LD  HL,(BOTTOM)
0003C5 43C5 110040          10      LD  DE,16384
0003C8 43C8 19              11      ADD HL,DE
0003C9 43C9 3817            12      JR  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
0003CB 43CB 57               4      LD  D,A
0003CC 43CC 0601             7      LD  B,1
0003CE 43CE 2100C0          10      LD  HL,0C000H
0003D1 43D1 CD794E          17      CALL    DISKIO
                                
0003D4 43D4 116BF3          10      LD  DE,RAMUSE
0003D7 43D7 AF               4      XOR A
0003D8 43D8 CD1EC0          17      CALL    0C01EH
0003DB 43DB 116BF3          10      LD  DE,RAMUSE
0003DE 43DE 37               4      SCF
0003DF 43DF CD1EC0          17      CALL    0C01EH
       43E2                     BOOT1:
0003E2 43E2 C30450          10      JP  BASENT
                                
       43E5                     MSG_ERROR_ROM_MODE:
                                #if exists USE_NORMAL_32K_ROM
                                    DB  "Normal ROM/ASCII-16K only!",13,10
                                #else
0003E5 43E5 41534349492D384B        DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
            2F4B6F6E616D692D    
            384B2F4B6F6E616D    
            692D534343206F6E    
            6C79210D0A          
                                #endif
       440A                     NULL:
00040A 440A 00                      DB  0
       440B                     DELOK:
00040B 440B 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       440F                     ROM_LDIR:
00040F 440F 3AC9F2          13      LD  A,(FLG_LDIR)
000412 4412 B7               4      OR  A
000413 4413 2008            12      JR  NZ,ROM_LDIRVM
000415 4415 CB7A             8      BIT 7,D
000417 4417 CA2F44          10      JP  Z,ROM_LDIRSLT
                                #if exists USE_NORMAL_32K_ROM
                                LDIRA:
                                    DI
                                    LD  (_SP),SP
                                    LD  SP,DRVTBL
                                LDIR1:
                                    LD  A,B
                                    OR  C
                                    JR  Z,LDIRE
                                
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                LDIR2:
                                    LD  A,D
                                    CP  0C0H
                                    JR  NC,LDIR4
                                
                                    PUSH    BC
                                    PUSH    DE
                                    LD  DE,BUF
                                
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIR3
                                    LD  BC,00100H
                                LDIR3:
                                    PUSH    BC
                                    LDIR
                                    LD  (_HL),HL
                                
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                
                                    POP BC
                                    POP DE
                                    LD  HL,BUF
                                    LDIR
                                
                                    LD  HL,(_HL)
                                    POP BC
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIRE
                                    DEC B
                                    JR  LDIR1
                                LDIR4:
                                #endif
00041A 441A EDB0                    LDIR
                                
                                #if exists USE_NORMAL_32K_ROM
                                LDIRE2:
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                LDIRE:
                                    LD  SP,(_SP)
                                    EI
                                #endif
00041C 441C C9              10      RET
                                
       441D                     ROM_LDIRVM:
                                #if exists USE_NORMAL_32K_ROM
                                    DI
                                    LD  (_SP),SP
                                    LD  SP,DRVTBL
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
00041D 441D C5              11      PUSH    BC
00041E 441E D5              11      PUSH    DE
00041F 441F FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000423 4423 DD215C00        14      LD  IX,LDIRVM
000427 4427 CD1C00          17      CALL    _CALSLT
00042A 442A E1              10      POP HL
00042B 442B C1              10      POP BC
00042C 442C 09              11      ADD HL,BC
00042D 442D EB               4      EX  DE,HL
                                #if exists USE_NORMAL_32K_ROM
                                    JR  LDIRE2
                                #else
00042E 442E C9              10      RET
                                #endif
                                
       442F                     ROM_LDIRSLT:
                                #if exists USE_NORMAL_32K_ROM
                                    DI
                                    LD  (_SP),SP
                                    LD  SP,DRVTBL
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
       442F                     ROM_LDIRSLT1:
00042F 442F EB               4      EX  DE,HL
       4430                     RLDIRSLT1:
000430 4430 1A               7      LD  A,(DE)
000431 4431 13               6      INC DE
000432 4432 C5              11      PUSH    BC
000433 4433 D5              11      PUSH    DE
000434 4434 E5              11      PUSH    HL
000435 4435 5F               4      LD  E,A
                                
000436 4436 0141F3          10      LD  BC,RAMAD0
000439 4439 7C               4      LD  A,H
00043A 443A 07               4      RLCA
00043B 443B 07               4      RLCA
00043C 443C E603             7      AND 3
00043E 443E 81               4      ADD A,C
00043F 443F 4F               4      LD  C,A
000440 4440 0A               7      LD  A,(BC)
       4441                     RLDIRSLT2:
000441 4441 CD1400          17      CALL    _WRSLT
000444 4444 08               4      EX  AF,AF'
000445 4445 E1              10      POP HL
000446 4446 D1              10      POP DE
000447 4447 C1              10      POP BC
000448 4448 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00044A 444A EA3044          10      JP  PE,RLDIRSLT1
00044D 444D EB               4      EX  DE,HL
                                #if exists USE_NORMAL_32K_ROM
                                    JR  LDIRE2
                                #else
00044E 444E C9              10      RET
                                #endif
                                
       444F                     END_OF_LINE:
00044F 444F 215EF5          10      LD  HL,BUF
       4452                     EOL1:
000452 4452 7E               7      LD  A,(HL)
000453 4453 C8              11      RET Z
000454 4454 FE0D             7      CP  00DH
000456 4456 2807            12      JR  Z,EOLE
000458 4458 FE0A             7      CP  00AH
00045A 445A 2803            12      JR  Z,EOLE
00045C 445C 23               6      INC HL
00045D 445D 18F3            12      JR  EOL1
       445F                     EOLE:
00045F 445F 3600            10      LD  (HL),0
000461 4461 23               6      INC HL
000462 4462 7E               7      LD  A,(HL)
000463 4463 FE0A             7      CP  00AH
000465 4465 C0              11      RET NZ
000466 4466 23               6      INC HL
000467 4467 C9              10      RET
                                
       4468                     ROM_LOAD_ASCII:
000468 4468 210000          10      LD  HL,0
00046B 446B 22CDF2          16      LD  (_BUF_ST),HL    ;読み出し位置
00046E 446E 2A76F6          16      LD  HL,(TXTTAB)
000471 4471 22CFF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
000474 4474 215EF5          10      LD  HL,BUF
000477 4477 22C7F2          16      LD  (_DTA),HL
       447A                     RLOAD_A1:
00047A 447A 2ACDF2          16      LD  HL,(_BUF_ST)
00047D 447D 22BDF2          16      LD  (RR_LOW),HL
000480 4480 210201          10      LD  HL,258
000483 4483 CDFE48          17      CALL    ROM_READ
000486 4486 7C               4      LD  A,H
000487 4487 B5               4      OR  L
000488 4488 2877            12      JR  Z,RLOAD_AEND
00048A 448A 015EF5          10      LD  BC,BUF
00048D 448D 09              11      ADD HL,BC
00048E 448E 3600            10      LD  (HL),0
000490 4490 CD4F44          17      CALL    END_OF_LINE
000493 4493 015EF5          10      LD  BC,BUF
000496 4496 A7               4      AND A
000497 4497 ED42            15      SBC HL,BC
000499 4499 2810            12      JR  Z,RLOAD_A2
00049B 449B 4D               4      LD  C,L
00049C 449C 44               4      LD  B,H
00049D 449D ED5BCDF2        20      LD  DE,(_BUF_ST)
0004A1 44A1 19              11      ADD HL,DE
0004A2 44A2 22CDF2          16      LD  (_BUF_ST),HL
0004A5 44A5 3A5EF5          13      LD  A,(BUF)
0004A8 44A8 B7               4      OR  A
0004A9 44A9 28CF            12      JR  Z,RLOAD_A1
       44AB                     RLOAD_A2:
0004AB 44AB 115EF5          10      LD  DE,BUF
0004AE 44AE CDB54A          17      CALL    SPCUTEX
0004B1 44B1 1A               7      LD  A,(DE)
0004B2 44B2 B7               4      OR  A
0004B3 44B3 284C            12      JR  Z,RLOAD_AEND
0004B5 44B5 CDC74A          17      CALL    GETNUM
0004B8 44B8 7C               4      LD  A,H
0004B9 44B9 B5               4      OR  L
0004BA 44BA CA6045          10      JP  Z,ERROR_DIRECT_IN_FILE
0004BD 44BD DD2ACFF2        20      LD  IX,(_BUF_EN)
0004C1 44C1 DD7502          19      LD  (IX+2),L
0004C4 44C4 DD7403          19      LD  (IX+3),H
                                
0004C7 44C7 CDAE4A          17      CALL    SPCUT
0004CA 44CA EB               4      EX  DE,HL
0004CB 44CB DDE5            15      PUSH    IX
0004CD 44CD DD21B242        14      LD  IX,CRUNCH
0004D1 44D1 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0004D5 44D5 CD1C00          17      CALL    _CALSLT
0004D8 44D8 DDE1            14      POP IX
0004DA 44DA EB               4      EX  DE,HL
0004DB 44DB 111FF4          10      LD  DE,KBUF
0004DE 44DE 37               4      SCF
0004DF 44DF ED52            15      SBC HL,DE
0004E1 44E1 287D            12      JR  Z,ERROR_DIRECT_IN_FILE
0004E3 44E3 387B            12      JR  C,ERROR_DIRECT_IN_FILE
0004E5 44E5 4D               4      LD  C,L
0004E6 44E6 44               4      LD  B,H
0004E7 44E7 2ACFF2          16      LD  HL,(_BUF_EN)
0004EA 44EA 110400          10      LD  DE,4
0004ED 44ED 19              11      ADD HL,DE
0004EE 44EE 111FF4          10      LD  DE,KBUF
                                
0004F1 44F1 EB               4      EX  DE,HL
0004F2 44F2 EDB0                    LDIR
0004F4 44F4 EB               4      EX  DE,HL
                                
0004F5 44F5 DD7500          19      LD  (IX+0),L
0004F8 44F8 DD7401          19      LD  (IX+1),H
0004FB 44FB 22CFF2          16      LD  (_BUF_EN),HL
0004FE 44FE C37A44          10      JP  RLOAD_A1
                                
       4501                     RLOAD_AEND:
000501 4501 2ACFF2          16      LD  HL,(_BUF_EN)
000504 4504 AF               4      XOR A
000505 4505 77               7      LD  (HL),A
000506 4506 23               6      INC HL
000507 4507 77               7      LD  (HL),A
000508 4508 23               6      INC HL
000509 4509 22CFF2          16      LD  (_BUF_EN),HL
00050C 450C 183B            12      JR  RLOAD_END1
                                
       450E                     ROM_LOAD:
00050E 450E CDA946          17      CALL    INIT_PARAM
000511 4511 CD9F49          17      CALL    FILE_B
000514 4514 3AECF2          13      LD  A,(FNAME)
000517 4517 FE20             7      CP  020H
000519 4519 CA9A49          10      JP  Z,ROM_ORG
                                
00051C 451C CD1E4B          17      CALL    ROM_OPEN
00051F 451F 384B            12      JR  C,ERROR_FILE_NOT_FOUND
       4521                     ROM_LOAD1:
000521 4521 21CCF2          10      LD  HL,_BUF
000524 4524 22C7F2          16      LD  (_DTA),HL
000527 4527 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
00052A 452A CDFE48          17      CALL    ROM_READ
00052D 452D 3ACCF2          13      LD  A,(_BUF)
000530 4530 3C               4      INC A
000531 4531 C26844          10      JP  NZ,ROM_LOAD_ASCII
000534 4534 2A76F6          16      LD  HL,(TXTTAB)
000537 4537 22C7F2          16      LD  (_DTA),HL
00053A 453A EB               4      EX  DE,HL
00053B 453B 2100FF          10      LD  HL,-256
00053E 453E 39              11      ADD HL,SP
00053F 453F ED52            15      SBC HL,DE
000541 4541 CDFE48          17      CALL    ROM_READ
000544 4544 ED5BC7F2        20      LD  DE,(_DTA)
000548 4548 19              11      ADD HL,DE
       4549                     RLOAD_END1:
000549 4549 22C2F6          16      LD  (VARTAB),HL
00054C 454C 22C4F6          16      LD  (ARYTAB),HL
00054F 454F 22C6F6          16      LD  (STREND),HL
                                
000552 4552 AF               4      XOR A
000553 4553 21CFF2          10      LD  HL,_BUF+3
000556 4556 77               7      LD  (HL),A
000557 4557 2B               6      DEC HL
000558 4558 77               7      LD  (HL),A
000559 4559 2B               6      DEC HL
00055A 455A 77               7      LD  (HL),A
00055B 455B 2B               6      DEC HL
00055C 455C 3E8F             7      LD  A,08FH          ;REM
00055E 455E 77               7      LD  (HL),A
00055F 455F C9              10      RET
                                
       4560                     ERROR_DIRECT_IN_FILE:
000560 4560 1E39             7      LD  E,57            ;Direct statement in file
000562 4562 01                      DB  1           ;LD BC,
       4563                     ERROR_DEVICE_IO_ERROR:
000563 4563 1E13             7      LD  E,19            ;Device I/O error
000565 4565 01                      DB  1           ;LD BC,
       4566                     ERROR_INTERNAL_ERROR:
000566 4566 1E33             7      LD  E,51            ;Internal error
000568 4568 01                      DB  1           ;LD BC,
       4569                     ERROR_FILE_NOT_OPEN:
000569 4569 1E3B             7      LD  E,59            ;File not OPEN
00056B 456B 01                      DB  1           ;LD BC,
       456C                     ERROR_FILE_NOT_FOUND:
00056C 456C 1E35             7      LD  E,53            ;File not found
       456E                     ERROR:
00056E 456E FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000572 4572 DD216F40        14      LD  IX,ERRHAND
000576 4576 C31C00          10      JP  _CALSLT
                                
       4579                     ROM_BLOAD:
000579 4579 CDA946          17      CALL    INIT_PARAM
00057C 457C CD9F49          17      CALL    FILE_B
00057F 457F CD1E4B          17      CALL    ROM_OPEN
000582 4582 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000584 4584 21CCF2          10      LD  HL,_BUF
000587 4587 22C7F2          16      LD  (_DTA),HL
00058A 458A 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
00058D 458D CDFE48          17      CALL    ROM_READ
000590 4590 3ACCF2          13      LD  A,(_BUF)
000593 4593 FEFE             7      CP  0FEH
000595 4595 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
000597 4597 21A5F2          10      LD  HL,BLOAD_RET
00059A 459A 229DF2          16      LD  (SWC_BLOAD),HL
                                
00059D 459D 2AE7F2          16      LD  HL,(PARAM1)
0005A0 45A0 7E               7      LD  A,(HL)
0005A1 45A1 FE2C             7      CP  ','
0005A3 45A3 2048            12      JR  NZ,RBREAD_MEM
0005A5 45A5 23               6      INC HL
0005A6 45A6 7E               7      LD  A,(HL)
0005A7 45A7 CD084B          17      CALL    CAP
0005AA 45AA 32BEFC          13      LD  (RUNBNF),A
       45AD                     RBOS1:
0005AD 45AD 7E               7      LD  A,(HL)
0005AE 45AE 23               6      INC HL
0005AF 45AF B7               4      OR  A
0005B0 45B0 282F            12      JR  Z,RBREAD_OSE
0005B2 45B2 FE3A             7      CP  ':'
0005B4 45B4 282B            12      JR  Z,RBREAD_OSE
0005B6 45B6 FE2C             7      CP  ','     ;次のパラメータを探す
0005B8 45B8 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
0005BA 45BA 22E7F2          16      LD  (PARAM1),HL
0005BD 45BD 7E               7      LD  A,(HL)
0005BE 45BE B7               4      OR  A
0005BF 45BF 2820            12      JR  Z,RBREAD_OSE
0005C1 45C1 DD21644C        14      LD  IX,FRMEVL
0005C5 45C5 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0005C9 45C9 CD1C00          17      CALL    _CALSLT
0005CC 45CC 22E7F2          16      LD  (PARAM1),HL
0005CF 45CF 3A63F6          13      LD  A,(VALTYP)
0005D2 45D2 FE02             7      CP  2
0005D4 45D4 200B            12      JR  NZ,RBREAD_OSE
0005D6 45D6 2ACDF2          16      LD  HL,(_BUF_ST)
0005D9 45D9 ED5BF8F7        20      LD  DE,(DACDAT)
0005DD 45DD 19              11      ADD HL,DE
0005DE 45DE 22CDF2          16      LD  (_BUF_ST),HL
       45E1                     RBREAD_OSE:
0005E1 45E1 3ABEFC          13      LD  A,(RUNBNF)
0005E4 45E4 FE53             7      CP  'S'
0005E6 45E6 2005            12      JR  NZ,RBREAD_MEM
0005E8 45E8 3E01             7      LD  A,1
0005EA 45EA 32C9F2          13      LD  (FLG_LDIR),A
       45ED                     RBREAD_MEM:
0005ED 45ED 2ACDF2          16      LD  HL,(_BUF_ST)
0005F0 45F0 22BFFC          16      LD  (SAVENT),HL
0005F3 45F3 22C7F2          16      LD  (_DTA),HL
0005F6 45F6 21FFFF          10      LD  HL,0FFFFH
0005F9 45F9 CDFE48          17      CALL    ROM_READ
0005FC 45FC 3ABEFC          13      LD  A,(RUNBNF)
0005FF 45FF FE52             7      CP  'R'
000601 4601 2006            12      JR  NZ,RBREAD1
000603 4603 2AD1F2          16      LD  HL,(_BUF_EX)
000606 4606 229DF2          16      LD  (SWC_BLOAD),HL
       4609                     RBREAD1:
       4609                     ROM_NEXT:
000609 4609 2AE7F2          16      LD  HL,(PARAM1)
00060C 460C 7E               7      LD  A,(HL)
00060D 460D 2B               6      DEC HL
00060E 460E B7               4      OR  A
00060F 460F 2805            12      JR  Z,RN1
000611 4611 FE3A             7      CP  ':'
000613 4613 2801            12      JR  Z,RN1
000615 4615 23               6      INC HL
       4616                     RN1:
000616 4616 5D               4      LD  E,L
000617 4617 54               4      LD  D,H
                                
000618 4618 CDDE4A          17      CALL    SEARCH_END
00061B 461B B7               4      OR  A
00061C 461C 2821            12      JR  Z,REM
       461E                     RN3:                    ;マルチステートメントの処理
00061E 461E 7E               7      LD  A,(HL)
                                
00061F 461F FEB5             7      CP  0B5H            ;LOAD
000621 4621 CA0E45          10      JP  Z,ROM_LOAD
000624 4624 FE8A             7      CP  08AH            ;RUN
000626 4626 281B            12      JR  Z,ROM_RUN
000628 4628 FEB7             7      CP  0B7H            ;FILES
00062A 462A 2824            12      JR  Z,ROM_FILES
00062C 462C FED6             7      CP  0D6H            ;COPY
00062E 462E CADF46          10      JP  Z,ROM_COPY
000631 4631 FE20             7      CP  020H
000633 4633 2807            12      JR  Z,RN_SP
                                
000635 4635 3E28             7      LD  A,028H          ;JR Z,
000637 4637 32A3F2          13      LD  (SWC_BLOAD_M),A
00063A 463A 7E               7      LD  A,(HL)
00063B 463B C9              10      RET
       463C                     RN_SP:
00063C 463C 23               6      INC HL
00063D 463D 18DF            12      JR  RN3
                                
       463F                     REM:
00063F 463F EB               4      EX  DE,HL
000640 4640 3E8F             7      LD  A,08FH          ;REM
000642 4642 C9              10      RET
                                
       4643                     ROM_RUN:
000643 4643 23               6      INC HL
000644 4644 7E               7      LD  A,(HL)
000645 4645 2B               6      DEC HL
000646 4646 B7               4      OR  A
000647 4647 2803            12      JR  Z,ROM_RUN1
000649 4649 CD0E45          17      CALL    ROM_LOAD
       464C                     ROM_RUN1:
00064C 464C 3E8A             7      LD  A,08AH          ;RUN
00064E 464E 77               7      LD  (HL),A
00064F 464F C9              10      RET
                                
       4650                     ROM_FILES:
000650 4650 CDA946          17      CALL    INIT_PARAM
000653 4653 CD9F49          17      CALL    FILE_B
000656 4656 CD4450          17      CALL    GET_DISK_BANK_FDRV
000659 4659 3ABCF2          13      LD  A,(SECSZ_H)
00065C 465C CDFF4E          17      CALL    IS_BPB1
00065F 465F DA6345          10      JP  C,ERROR_DEVICE_IO_ERROR
000662 4662 3AECF2          13      LD  A,(FNAME)
000665 4665 FE21             7      CP  021H
000667 4667 3005            12      JR  NC,RFILES0
000669 4669 060B             7      LD  B,11
00066B 466B CD724A          17      CALL    FILE10
       466E                     RFILES0:
00066E 466E CD8B4D          17      CALL    GET_DIR_DAT
       4671                     RFILES1:
000671 4671 CD3A4B          17      CALL    FILESE
000674 4674 302E            12      JR  NC,RFILES_NOT_MATCH
       4676                     RFILES_DISP:
000676 4676 E5              11      PUSH    HL
000677 4677 0608             7      LD  B,8
000679 4679 CD9F43          17      CALL    MSN
00067C 467C 3E2E             7      LD  A,'.'
00067E 467E CDB150          17      CALL    MSG_A
000681 4681 0603             7      LD  B,3
000683 4683 CD9F43          17      CALL    MSN
000686 4686 3ADDF3          13      LD  A,(CSRX)
000689 4689 47               4      LD  B,A
00068A 468A 3AB0F3          13      LD  A,(LINLEN)
00068D 468D 90               4      SUB B
00068E 468E FE0C             7      CP  12
000690 4690 3009            12      JR  NC,RFILES2
000692 4692 3E0D             7      LD  A,00DH      ;改行
000694 4694 CDB150          17      CALL    MSG_A
000697 4697 3E0A             7      LD  A,00AH
000699 4699 1802            12      JR  RFILES3
       469B                     RFILES2:
00069B 469B 3E20             7      LD  A,020H
       469D                     RFILES3:
00069D 469D CDB150          17      CALL    MSG_A
0006A0 46A0 E1              10      POP HL
0006A1 46A1 CD564B          17      CALL    FNEXT
       46A4                     RFILES_NOT_MATCH:
0006A4 46A4 20CB            12      JR  NZ,RFILES1
0006A6 46A6 C30946          10      JP  ROM_NEXT
                                
       46A9                     INIT_PARAM:
0006A9 46A9 22E5F2          16      LD  (PARAM0),HL
0006AC 46AC 22E7F2          16      LD  (PARAM1),HL
0006AF 46AF EB               4      EX  DE,HL
0006B0 46B0 AF               4      XOR A
0006B1 46B1 32C9F2          13      LD  (FLG_LDIR),A
0006B4 46B4 32BEFC          13      LD  (RUNBNF),A
0006B7 46B7 3263F6          13      LD  (VALTYP),A
0006BA 46BA E5              11      PUSH    HL
0006BB 46BB 2ADEF2          16      LD  HL,(_CD)
0006BE 46BE 22E9F2          16      LD  (_CDX),HL
0006C1 46C1 E1              10      POP HL
0006C2 46C2 13               6      INC DE
0006C3 46C3 CDAE4A          17      CALL    SPCUT
0006C6 46C6 1A               7      LD  A,(DE)
0006C7 46C7 B7               4      OR  A
0006C8 46C8 C8              11      RET Z
0006C9 46C9 FE3A             7      CP  ':'
0006CB 46CB C8              11      RET Z
0006CC 46CC FE28             7      CP  '('
0006CE 46CE C8              11      RET Z
0006CF 46CF EB               4      EX  DE,HL
0006D0 46D0 DD21644C        14      LD  IX,FRMEVL
0006D4 46D4 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0006D8 46D8 CD1C00          17      CALL    _CALSLT
0006DB 46DB 22E7F2          16      LD  (PARAM1),HL
0006DE 46DE C9              10      RET
                                
       46DF                     ROM_COPY:
0006DF 46DF CDA946          17      CALL    INIT_PARAM
0006E2 46E2 3A63F6          13      LD  A,(VALTYP)
0006E5 46E5 FE03             7      CP  3       ;string
0006E7 46E7 C29A49          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
0006EA 46EA CD9F49          17      CALL    FILE_B
0006ED 46ED CD1E4B          17      CALL    ROM_OPEN
0006F0 46F0 DA6C45          10      JP  C,ERROR_FILE_NOT_FOUND
                                
0006F3 46F3 21D1F2          10      LD  HL,_BUF_W
0006F6 46F6 22C7F2          16      LD  (_DTA),HL
0006F9 46F9 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
0006FC 46FC CDFE48          17      CALL    ROM_READ
                                
0006FF 46FF AF               4      XOR A
000700 4700 32CCF2          13      LD  (_BUF_LO),A     ;PSET
000703 4703 32D9F2          13      LD  (_BUF_O),A      ;向き
                                
000706 4706 2AE7F2          16      LD  HL,(PARAM1)
       4709                     RCP_PARAM1:
000709 4709 7E               7      LD  A,(HL)
00070A 470A 23               6      INC HL
00070B 470B B7               4      OR  A
00070C 470C CA9A49          10      JP  Z,ROM_ORG
00070F 470F FE3A             7      CP  ':'
000711 4711 CA9A49          10      JP  Z,ROM_ORG
000714 4714 FE2C             7      CP  ','
000716 4716 2012            12      JR  NZ,RCP_PARAM1_
                                
000718 4718 DD212F54        14      LD  IX,FRMQNT
00071C 471C FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000720 4720 CD1C00          17      CALL    _CALSLT
000723 4723 7B               4      LD  A,E
000724 4724 87               4      ADD A,A
000725 4725 87               4      ADD A,A
000726 4726 32D9F2          13      LD  (_BUF_O),A
000729 4729 7E               7      LD  A,(HL)
       472A                     RCP_PARAM1_:
00072A 472A FE28             7      CP  '('
00072C 472C 20DB            12      JR  NZ,RCP_PARAM1
                                
00072E 472E DD212F54        14      LD  IX,FRMQNT
000732 4732 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000736 4736 CD1C00          17      CALL    _CALSLT
                                
000739 4739 ED53D5F2        20      LD  (_BUF_X),DE
                                
       473D                     RCP_PARAM2:
00073D 473D 23               6      INC HL
00073E 473E 7E               7      LD  A,(HL)
00073F 473F FE20             7      CP  020H
000741 4741 28FA            12      JR  Z,RCP_PARAM2
000743 4743 FE2C             7      CP  ','
000745 4745 28F6            12      JR  Z,RCP_PARAM2
                                
000747 4747 DD212F54        14      LD  IX,FRMQNT
00074B 474B FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00074F 474F CD1C00          17      CALL    _CALSLT
                                
000752 4752 3AF6FA          13      LD  A,(ACPAGE)
000755 4755 57               4      LD  D,A
000756 4756 ED53D7F2        20      LD  (_BUF_Y),DE
       475A                     RCP_PARAM3:
00075A 475A 23               6      INC HL
00075B 475B 7E               7      LD  A,(HL)
00075C 475C FE20             7      CP  020H
00075E 475E 28FA            12      JR  Z,RCP_PARAM3
000760 4760 FE29             7      CP  ')'
000762 4762 28F6            12      JR  Z,RCP_PARAM3
000764 4764 FE2C             7      CP  ','
000766 4766 2033            12      JR  NZ,RCP_ST
                                
000768 4768 23               6      INC HL
000769 4769 DD212F54        14      LD  IX,FRMQNT
00076D 476D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000771 4771 CD1C00          17      CALL    _CALSLT
                                
000774 4774 7B               4      LD  A,E
000775 4775 32D8F2          13      LD  (_BUF_P),A
                                
       4778                     RCP_PARAM4:
000778 4778 7E               7      LD  A,(HL)
000779 4779 23               6      INC HL
00077A 477A FE20             7      CP  020H
00077C 477C 28FA            12      JR  Z,RCP_PARAM4
                                
00077E 477E FE2C             7      CP  ','
000780 4780 2019            12      JR  NZ,RCP_ST
                                
000782 4782 7E               7      LD  A,(HL)
000783 4783 0604             7      LD  B,4
000785 4785 FEC3             7      CP  0C3H        ;PRESET
000787 4787 280E            12      JR  Z,RCP_LO
000789 4789 05               4      DEC B       ;3
00078A 478A D6F8             7      SUB 0F8H        ;XOR
00078C 478C 2809            12      JR  Z,RCP_LO
00078E 478E 05               4      DEC B       ;2
00078F 478F 3C               4      INC A       ;OR
000790 4790 2805            12      JR  Z,RCP_LO
000792 4792 05               4      DEC B       ;1
000793 4793 3C               4      INC A       ;AND
000794 4794 2801            12      JR  Z,RCP_LO
000796 4796 05               4      DEC B       ;0
                                                ;PSET
       4797                     RCP_LO:
000797 4797 78               4      LD  A,B
000798 4798 32CCF2          13      LD  (_BUF_LO),A
       479B                     RCP_ST:
00079B 479B 2AC6F6          16      LD  HL,(STREND)
00079E 479E 22C7F2          16      LD  (_DTA),HL
0007A1 47A1 EB               4      EX  DE,HL
0007A2 47A2 2100FE          10      LD  HL,-512
0007A5 47A5 39              11      ADD HL,SP
0007A6 47A6 AF               4      XOR A
0007A7 47A7 ED52            15      SBC HL,DE
0007A9 47A9 3008            12      JR  NC,RCP0
0007AB 47AB 215EF5          10      LD  HL,BUF
0007AE 47AE 22C7F2          16      LD  (_DTA),HL
0007B1 47B1 6F               4      LD  L,A ;0
0007B2 47B2 67               4      LD  H,A ;0
       47B3                     RCP0:
0007B3 47B3 24               4      INC H
0007B4 47B4 22CFF2          16      LD  (_BUF_EN),HL
       47B7                     RCP1:
0007B7 47B7 F3               4      DI
0007B8 47B8 CD8C48          17      CALL    WAIT_VDP
                                
0007BB 47BB 3A0700          13      LD  A,(WRVDP)
0007BE 47BE 4F               4      LD  C,A
0007BF 47BF 0C               4      INC C       ;C := PORT#1's address(WR)
0007C0 47C0 3E24             7      LD  A,36
0007C2 47C2 ED79            12      OUT (C),A
0007C4 47C4 3E91             7      LD  A,080H+17
0007C6 47C6 ED79            12      OUT (C),A       ;R#17 := 36
                                
0007C8 47C8 0C               4      INC C
0007C9 47C9 0C               4      INC C       ;C := PORT#3's address(WR)
0007CA 47CA 2AD5F2          16      LD  HL,(_BUF_X)
0007CD 47CD ED69            12      OUT (C),L       ;R#36 DX
0007CF 47CF ED61            12      OUT (C),H       ;R#37
0007D1 47D1 2AD7F2          16      LD  HL,(_BUF_Y)
0007D4 47D4 ED69            12      OUT (C),L       ;R#38 DY
0007D6 47D6 ED61            12      OUT (C),H       ;R#39
0007D8 47D8 2AD1F2          16      LD  HL,(_BUF_W)
0007DB 47DB ED69            12      OUT (C),L       ;R#40 NX
0007DD 47DD ED61            12      OUT (C),H       ;R#41
0007DF 47DF 2AD3F2          16      LD  HL,(_BUF_H)
0007E2 47E2 ED69            12      OUT (C),L       ;R#42 NY
0007E4 47E4 ED61            12      OUT (C),H       ;R#43
                                
0007E6 47E6 DD2AAFFC        20      LD  IX,(SCRMOD)
0007EA 47EA 3ACCF2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0007ED 47ED B7               4      OR  A
0007EE 47EE 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
0007F0 47F0 DD7D             9      LD  A,IXL
0007F2 47F2 FE08             7      CP  8
0007F4 47F4 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
0007F6 47F6 FE06             7      CP  6
0007F8 47F8 2AD5F2          16      LD  HL,(_BUF_X)
0007FB 47FB 3AD1F2          13      LD  A,(_BUF_W)
0007FE 47FE 2005            12      JR  NZ,SCR57
000800 4800 B5               4      OR  L       ;スクリーン6
000801 4801 E603             7      AND 3
000803 4803 200D            12      JR  NZ,USE_LMMC
       4805                     SCR57:              ;スクリーン5,7
000805 4805 B5               4      OR  L
000806 4806 E601             7      AND 1
000808 4808 2008            12      JR  NZ,USE_LMMC
       480A                     USE_HMMC:
00080A 480A DD2E08          10      LD  IXL,8
       480D                     USE_HMMC8:
00080D 480D 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
00080F 480F 32CCF2          13      LD  (_BUF_LO),A
       4812                     USE_LMMC:
000812 4812 110000          10      LD  DE,0
000815 4815 06FF             7      LD  B,-1
000817 4817 CDB748          17      CALL    GET_PIXEL
00081A 481A ED79            12      OUT (C),A       ;R#44 first DATA
00081C 481C 3AD9F2          13      LD  A,(_BUF_O)
00081F 481F ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
000821 4821 3ACCF2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000824 4824 F6B0             7      OR  0B0H        ;R#46 LMMC command
000826 4826 ED79            12      OUT (C),A
                                
000828 4828 FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
00082A 482A 0D               4      DEC C
00082B 482B 0D               4      DEC C       ;C := PORT#1's address(WR)
00082C 482C 3EAC             7      LD  A,080H+44
00082E 482E ED79            12      OUT (C),A
000830 4830 3E91             7      LD  A,080H+17
000832 4832 ED79            12      OUT (C),A       ;R#17 := 44
                                
000834 4834 3A0600          13      LD  A,(RDVDP)
000837 4837 3C               4      INC A
000838 4838 FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
00083A 483A 3E02             7      LD  A,2
00083C 483C ED79            12      OUT (C),A
00083E 483E 3E8F             7      LD  A,08FH
000840 4840 ED79            12      OUT (C),A
000842 4842 3ACCF2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000845 4845 E640             7      AND 040H
000847 4847 201C            12      JR  NZ,LOOP_HMMC
       4849                     LOOP_COPY:
000849 4849 CDB748          17      CALL    GET_PIXEL
00084C 484C 08               4      EX  AF,AF'
00084D 484D FD4C             9      LD  C,IYH
       484F                     LOOP_COPY1:
00084F 484F ED78            12      IN  A,(C)
000851 4851 0F               4      RRCA            ;RRCAではサインフラグは変化しない
000852 4852 300A            12      JR  NC,EXIT_COPY    ;check CE bit
000854 4854 F24F48          10      JP  P,LOOP_COPY1    ;check TR bit
000857 4857 08               4      EX  AF,AF'
000858 4858 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
00085A 485A ED79            12      OUT (C),A
00085C 485C 18EB            12      JR  LOOP_COPY
                                
       485E                     EXIT_COPY:
00085E 485E CD9448          17      CALL    GET_STATUS_0
000861 4861 FB               4      EI
000862 4862 C30946          10      JP  ROM_NEXT
                                
       4865                     LOOP_HMMC:
000865 4865 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000867 4867 43               4      LD  B,E
000868 4868 7B               4      LD  A,E
000869 4869 B7               4      OR  A
00086A 486A 2802            12      JR  Z,LOOP_HMMC1
00086C 486C EDB3                    OTIR
       486E                     LOOP_HMMC1:
00086E 486E 14               4      INC D
       486F                     LOOP_HMMC2:
00086F 486F 15               4      DEC D
000870 4870 2805            12      JR  Z,LOOP_HMMC3
000872 4872 EDB3                    OTIR
000874 4874 C36F48          10      JP  LOOP_HMMC2
       4877                     LOOP_HMMC3:
000877 4877 ED78            12      IN  A,(C)
000879 4879 0F               4      RRCA
00087A 487A 30E2            12      JR  NC,EXIT_COPY    ;check CE bit
00087C 487C 2ACFF2          16      LD  HL,(_BUF_EN)
00087F 487F CDFE48          17      CALL    ROM_READ
000882 4882 EB               4      EX  DE,HL
000883 4883 2AC7F2          16      LD  HL,(_DTA)
000886 4886 7A               4      LD  A,D
000887 4887 B3               4      OR  E
000888 4888 20DB            12      JR  NZ,LOOP_HMMC
00088A 488A 18C3            12      JR  LOOP_COPY1
                                    
       488C                     WAIT_VDP:
00088C 488C 3E02             7      LD  A,2
00088E 488E CD9548          17      CALL    GET_STATUS
000891 4891 0F               4      RRCA
000892 4892 38F8            12      JR  C,WAIT_VDP
       4894                     GET_STATUS_0:
000894 4894 AF               4      XOR A
       4895                     GET_STATUS:
000895 4895 C5              11      PUSH    BC
000896 4896 ED4B0600        20      LD  BC,(RDVDP)
00089A 489A 0C               4      INC C
00089B 489B ED79            12      OUT (C),A
00089D 489D 3E8F             7      LD  A,08FH
00089F 489F ED79            12      OUT (C),A
0008A1 48A1 ED78            12      IN  A,(C)
0008A3 48A3 C1              10      POP BC
0008A4 48A4 C9              10      RET
                                
       48A5                     GET_PIXEL256:
0008A5 48A5 7A               4      LD  A,D
0008A6 48A6 B3               4      OR  E
0008A7 48A7 200A            12      JR  NZ,GET_PIXEL1
0008A9 48A9 2ACFF2          16      LD  HL,(_BUF_EN)
0008AC 48AC CDFE48          17      CALL    ROM_READ
0008AF 48AF EB               4      EX  DE,HL
0008B0 48B0 2AC7F2          16      LD  HL,(_DTA)
       48B3                     GET_PIXEL1:
0008B3 48B3 7E               7      LD  A,(HL)
0008B4 48B4 23               6      INC HL
0008B5 48B5 1B               6      DEC DE
0008B6 48B6 C9              10      RET
                                
       48B7                     GET_PIXEL:
0008B7 48B7 04               4      INC B
0008B8 48B8 DD7D             9      LD  A,IXL
0008BA 48BA FE08             7      CP  8
0008BC 48BC 28E7            12      JR  Z,GET_PIXEL256
0008BE 48BE FE06             7      CP  6
0008C0 48C0 282E            12      JR  Z,GET_PIXEL4
                                
0008C2 48C2 CB40             8      BIT 0,B
0008C4 48C4 20ED            12      JR  NZ,GET_PIXEL1
                                
0008C6 48C6 7A               4      LD  A,D
0008C7 48C7 B3               4      OR  E
0008C8 48C8 200A            12      JR  NZ,GET_PIXEL2
                                
0008CA 48CA 2ACFF2          16      LD  HL,(_BUF_EN)
0008CD 48CD CDFE48          17      CALL    ROM_READ
0008D0 48D0 EB               4      EX  DE,HL
0008D1 48D1 2AC7F2          16      LD  HL,(_DTA)
                                
       48D4                     GET_PIXEL2:
0008D4 48D4 7E               7      LD  A,(HL)
0008D5 48D5 0F               4      RRCA
0008D6 48D6 0F               4      RRCA
0008D7 48D7 0F               4      RRCA
0008D8 48D8 0F               4      RRCA
0008D9 48D9 C9              10      RET
                                
       48DA                     GET_PIXEL3:
0008DA 48DA 7A               4      LD  A,D
0008DB 48DB B3               4      OR  E
0008DC 48DC 200A            12      JR  NZ,GET_PIXEL5
                                
0008DE 48DE 2ACFF2          16      LD  HL,(_BUF_EN)
0008E1 48E1 CDFE48          17      CALL    ROM_READ
0008E4 48E4 EB               4      EX  DE,HL
0008E5 48E5 2AC7F2          16      LD  HL,(_DTA)
       48E8                     GET_PIXEL5:
0008E8 48E8 7E               7      LD  A,(HL)
0008E9 48E9 0F               4      RRCA
0008EA 48EA 0F               4      RRCA
0008EB 48EB 0F               4      RRCA
0008EC 48EC 0F               4      RRCA
0008ED 48ED 0F               4      RRCA
0008EE 48EE 0F               4      RRCA
0008EF 48EF C9              10      RET
                                
       48F0                     GET_PIXEL4:
0008F0 48F0 78               4      LD  A,B
0008F1 48F1 E603             7      AND 3   ;+0
0008F3 48F3 28E5            12      JR  Z,GET_PIXEL3
0008F5 48F5 3D               4      DEC A   ;+1
0008F6 48F6 28DC            12      JR  Z,GET_PIXEL2
0008F8 48F8 3D               4      DEC A   ;+2
0008F9 48F9 7E               7      LD  A,(HL)
0008FA 48FA C0              11      RET NZ
0008FB 48FB 0F               4      RRCA        ;+3
0008FC 48FC 0F               4      RRCA
0008FD 48FD C9              10      RET
                                
       48FE                     ROM_READ:
0008FE 48FE E5              11      PUSH    HL
0008FF 48FF D5              11      PUSH    DE
000900 4900 C5              11      PUSH    BC
000901 4901 FDE5            15      PUSH    IY
000903 4903 22E3F2          16      LD  (LEFTX),HL
000906 4906 2AC7F2          16      LD  HL,(_DTA)
000909 4909 22DAF2          16      LD  (DTAX),HL
00090C 490C 2AE3F2          16      LD  HL,(LEFTX)
                                
00090F 490F CDB14B          17      CALL    RBX1
000912 4912 3870            12      JR  C,RBRERR1
000914 4914 79               4      LD  A,C
000915 4915 EB               4      EX  DE,HL
000916 4916 ED52            15      SBC HL,DE       ;CP 0HL,CDE
000918 4918 19              11      ADD HL,DE
000919 4919 DE00             7      SBC A,000H
00091B 491B 3801            12      JR  C,RBR1
00091D 491D EB               4      EX  DE,HL
       491E                     RBR1:
00091E 491E 9F               4      SBC A,A
00091F 491F E601             7      AND 1
000921 4921 32B6F2          13      LD  (_RESULT),A
000924 4924 7C               4      LD  A,H
000925 4925 B5               4      OR  L
000926 4926 CA7A49          10      JP  Z,RBREND0
                                
000929 4929 22C3F2          16      LD  (_LEFT),HL  ;Read record byte
00092C 492C 22E3F2          16      LD  (LEFTX),HL
                                
00092F 492F CDDD4B          17      CALL    RBX2
000932 4932 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000934 4934 CDF04B          17      CALL    RBXA
000937 4937 DA9049          10      JP  C,RBRERR
00093A 493A C5              11      PUSH    BC
00093B 493B CD0F44          17      CALL    ROM_LDIR
00093E 493E ED53DAF2        20      LD  (DTAX),DE
000942 4942 2AE3F2          16      LD  HL,(LEFTX)
000945 4945 D1              10      POP DE
000946 4946 A7               4      AND A
000947 4947 ED52            15      SBC HL,DE
000949 4949 22E3F2          16      LD  (LEFTX),HL
00094C 494C 2829            12      JR  Z,RBREND
                                
       494E                     RBRB:
00094E 494E CD2C4C          17      CALL    RBXB
000951 4951 2818            12      JR  Z,RBRC
       4953                     RBRB1:
000953 4953 C5              11      PUSH    BC
000954 4954 D5              11      PUSH    DE
000955 4955 CDD74C          17      CALL    CLUST
000958 4958 EB               4      EX  DE,HL
000959 4959 ED4BB9F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
00095D 495D CD0F44          17      CALL    ROM_LDIR
000960 4960 EB               4      EX  DE,HL
000961 4961 D1              10      POP DE
000962 4962 C1              10      POP BC
000963 4963 CDB44C          17      CALL    GNCL
000966 4966 DA9049          10      JP  C,RBRERR
000969 4969 10E8            13      DJNZ    RBRB1
       496B                     RBRC:
00096B 496B CD444C          17      CALL    RBXC
00096E 496E 2807            12      JR  Z,RBREND
                                
000970 4970 CDD74C          17      CALL    CLUST
000973 4973 EB               4      EX  DE,HL
000974 4974 CD0F44          17      CALL    ROM_LDIR
       4977                     RBREND:
000977 4977 CD504C          17      CALL    RBXEND
       497A                     RBREND0:
00097A 497A FDE1            14      POP IY
00097C 497C C1              10      POP BC
00097D 497D D1              10      POP DE
00097E 497E F1              10      POP AF  ;(HL)
00097F 497F AF               4      XOR A
000980 4980 3AB6F2          13      LD  A,(_RESULT)
000983 4983 C9              10      RET
                                
       4984                     RBRERR1:
000984 4984 3E01             7      LD  A,001H
       4986                     RBRERR2:
000986 4986 FDE1            14      POP IY
000988 4988 C1              10      POP BC
000989 4989 D1              10      POP DE
00098A 498A E1              10      POP HL
00098B 498B 37               4      SCF
00098C 498C 210000          10      LD  HL,0
00098F 498F C9              10      RET
       4990                     RBRERR:
000990 4990 3EFF             7      LD  A,0FFH
000992 4992 18F2            12      JR  RBRERR2
                                
       4994                     FILE_DD:
000994 4994 E1              10      POP HL
000995 4995 3E                      DB  03EH
000996 4996 C9              10      RET
000997 4997 32A3F2          13      LD  (SWC_BLOAD_M),A
       499A                     ROM_ORG:
00099A 499A 2AE5F2          16      LD  HL,(PARAM0)
00099D 499D 7E               7      LD  A,(HL)
00099E 499E C9              10      RET
       499F                     FILE_B:
00099F 499F AF               4      XOR A
0009A0 49A0 32EBF2          13      LD  (FDRV),A
0009A3 49A3 1E00             7      LD  E,0
0009A5 49A5 3A63F6          13      LD  A,(VALTYP)
0009A8 49A8 FE03             7      CP  3       ;string
0009AA 49AA C22F4A          10      JP  NZ,FILED
                                
0009AD 49AD DD21D067        14      LD  IX,FRESTR
0009B1 49B1 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009B5 49B5 CD1C00          17      CALL    _CALSLT
0009B8 49B8 E5              11      PUSH    HL
0009B9 49B9 DDE1            14      POP IX
                                
0009BB 49BB DD5E00          19      LD  E,(IX+0)
0009BE 49BE DD7E01          19      LD  A,(IX+1)
0009C1 49C1 DD5602          19      LD  D,(IX+2)
0009C4 49C4 DD62             9      LD  IXH,D
0009C6 49C6 DD6F             9      LD  IXL,A
0009C8 49C8 7B               4      LD  A,E
       49C9                     FILE_BDOS:
0009C9 49C9 FE04             7      CP  4
0009CB 49CB 3808            12      JR  C,FILEB1
0009CD 49CD DD7E03          19      LD  A,(IX+3)
0009D0 49D0 FE3A             7      CP  ':'
0009D2 49D2 28C0            12      JR  Z,FILE_DD
0009D4 49D4 7B               4      LD  A,E
       49D5                     FILEB1:
0009D5 49D5 FE02             7      CP  2
0009D7 49D7 3818            12      JR  C,DEVI1
0009D9 49D9 DD7E01          19      LD  A,(IX+1)
0009DC 49DC FE3A             7      CP  ':'
0009DE 49DE 2011            12      JR  NZ,DEVI1
0009E0 49E0 DD7E00          19      LD  A,(IX+0)        ;DRIVE
0009E3 49E3 CD084B          17      CALL    CAP
0009E6 49E6 D640             7      SUB '@'
0009E8 49E8 DD23            10      INC IX
0009EA 49EA DD23            10      INC IX
0009EC 49EC 1D               4      DEC E
0009ED 49ED 1D               4      DEC E
0009EE 49EE 32EBF2          13      LD  (FDRV),A
       49F1                     DEVI1:
0009F1 49F1 DD7E00          19      LD  A,(IX+0)
0009F4 49F4 D65C             7      SUB 05CH        ;\
0009F6 49F6 2008            12      JR  NZ,NOROOT
0009F8 49F8 6F               4      LD  L,A
0009F9 49F9 67               4      LD  H,A
0009FA 49FA 22E9F2          16      LD  (_CDX),HL
0009FD 49FD DD23            10      INC IX
0009FF 49FF 1D               4      DEC E
       4A00                     NOROOT:
                                
       4A00                     SETDIR:
000A00 4A00 CD2F4A          17      CALL    FILED
000A03 4A03 DD7E00          19      LD  A,(IX+0)
000A06 4A06 FE5C             7      CP  05CH        ;\
000A08 4A08 C0              11      RET NZ
000A09 4A09 DD23            10      INC IX
000A0B 4A0B 1D               4      DEC E
000A0C 4A0C 3AECF2          13      LD  A,(FNAME)
000A0F 4A0F FE20             7      CP  020H        ;. の処理
000A11 4A11 28ED            12      JR  Z,SETDIR
                                
000A13 4A13 CD1E4B          17      CALL    ROM_OPEN
000A16 4A16 B7               4      OR  A
000A17 4A17 C0              11      RET NZ
                                
000A18 4A18 FD2AE0F2        20      LD  IY,(DIRENT1)
000A1C 4A1C FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
000A20 4A20 C8              11      RET Z
000A21 4A21 CD764A          17      CALL    FILEI
000A24 4A24 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000A27 4A27 FD661B          19      LD  H,(IY+01BH)
000A2A 4A2A 22E9F2          16      LD  (_CDX),HL
000A2D 4A2D 18D1            12      JR  SETDIR
                                
       4A2F                     FILED:
000A2F 4A2F CD764A          17      CALL    FILEI
000A32 4A32 21ECF2          10      LD  HL,FNAME
                                
000A35 4A35 0608             7      LD  B,8
       4A37                     FILE2:
000A37 4A37 CD834A          17      CALL    CCHKF
000A3A 4A3A C8              11      RET Z
000A3B 4A3B FE2A             7      CP  '*'
000A3D 4A3D 282E            12      JR  Z,FILE9
000A3F 4A3F FE2E             7      CP  '.'
000A41 4A41 280C            12      JR  Z,FILE4
000A43 4A43 77               7      LD  (HL),A
000A44 4A44 23               6      INC HL
000A45 4A45 10F0            13      DJNZ    FILE2
                                
       4A47                     FILE3:
000A47 4A47 CD834A          17      CALL    CCHKF
000A4A 4A4A C8              11      RET Z
000A4B 4A4B FE2E             7      CP  '.'
000A4D 4A4D 20F8            12      JR  NZ,FILE3
                                
       4A4F                     FILE4:
000A4F 4A4F 21F4F2          10      LD  HL,FNAME+8
000A52 4A52 0603             7      LD  B,3
                                
       4A54                     FILE4L:
000A54 4A54 CD834A          17      CALL    CCHKF
000A57 4A57 C8              11      RET Z
000A58 4A58 FE2E             7      CP  '.'
000A5A 4A5A 2008            12      JR  NZ,FILE12
000A5C 4A5C 32ECF2          13      LD  (FNAME),A   ;Parent directory(..)
000A5F 4A5F 32EDF2          13      LD  (FNAME+1),A
000A62 4A62 3E20             7      LD  A,020H
       4A64                     FILE12:
000A64 4A64 FE2A             7      CP  '*'
000A66 4A66 280A            12      JR  Z,FILE10
000A68 4A68 77               7      LD  (HL),A
000A69 4A69 23               6      INC HL
000A6A 4A6A 10E8            13      DJNZ    FILE4L
000A6C 4A6C C9              10      RET
                                
       4A6D                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000A6D 4A6D CD724A          17      CALL    FILE10
000A70 4A70 18D5            12      JR  FILE3
                                
       4A72                     FILE10:
000A72 4A72 3E3F             7      LD  A,'?'
000A74 4A74 1808            12      JR  FILL_MEMORY
       4A76                     FILEI:              ;名前＋拡張子をスペースで初期化
000A76 4A76 3E20             7      LD  A,020H
000A78 4A78 01000B          10      LD  BC,11*256   ;C=0にしておく
000A7B 4A7B 21ECF2          10      LD  HL,FNAME
       4A7E                     FILL_MEMORY:            ;HLからBバイトAで埋める
000A7E 4A7E 77               7      LD  (HL),A
000A7F 4A7F 23               6      INC HL
000A80 4A80 10FC            13      DJNZ    FILL_MEMORY
000A82 4A82 C9              10      RET
                                
       4A83                     CCHKF:
000A83 4A83 7B               4      LD  A,E
000A84 4A84 B7               4      OR  A
000A85 4A85 C8              11      RET Z
000A86 4A86 DD7E00          19      LD  A,(IX+0)
000A89 4A89 CD904A          17      CALL    CCHK2
000A8C 4A8C C8              11      RET Z
000A8D 4A8D C3F34A          10      JP  FKAN
                                
       4A90                     CCHK2:
000A90 4A90 0C               4      INC C
000A91 4A91 0D               4      DEC C
000A92 4A92 C0              11      RET NZ
       4A93                     CCHK3:              ;ZF=1 で使えない文字
000A93 4A93 FE2B             7      CP  '+'
000A95 4A95 C8              11      RET Z
000A96 4A96 FE2C             7      CP  ','
000A98 4A98 C8              11      RET Z
000A99 4A99 FE2F             7      CP  '/'
000A9B 4A9B C8              11      RET Z
000A9C 4A9C FE3A             7      CP  ':'
000A9E 4A9E C8              11      RET Z
000A9F 4A9F FE3B             7      CP  ';'
000AA1 4AA1 C8              11      RET Z
000AA2 4AA2 FE3D             7      CP  '='
000AA4 4AA4 C8              11      RET Z
000AA5 4AA5 FE5C             7      CP  05CH    ;\
000AA7 4AA7 C8              11      RET Z
000AA8 4AA8 FE1F             7      CP  01FH
000AAA 4AAA D0              11      RET NC
000AAB 4AAB BF               4      CP  A       ;Z=1
000AAC 4AAC C9              10      RET
                                
       4AAD                     SS1:
000AAD 4AAD 13               6      INC DE
       4AAE                     SPCUT:              ;スペースをカット
000AAE 4AAE 1A               7      LD  A,(DE)
000AAF 4AAF FE20             7      CP  020H
000AB1 4AB1 28FA            12      JR  Z,SS1
000AB3 4AB3 C9              10      RET
                                
       4AB4                     SCREOF1:
000AB4 4AB4 13               6      INC DE
       4AB5                     SPCUTEX:            ;スペース改行などをカット
000AB5 4AB5 1A               7      LD  A,(DE)
000AB6 4AB6 FE20             7      CP  020H
000AB8 4AB8 28FA            12      JR  Z,SCREOF1
000ABA 4ABA FE0D             7      CP  00DH
000ABC 4ABC 28F6            12      JR  Z,SCREOF1
000ABE 4ABE FE0A             7      CP  00AH
000AC0 4AC0 28F2            12      JR  Z,SCREOF1
000AC2 4AC2 FE1A             7      CP  01AH
000AC4 4AC4 28EE            12      JR  Z,SCREOF1
000AC6 4AC6 C9              10      RET
                                
       4AC7                     GETNUM:
000AC7 4AC7 210000          10      LD  HL,0
       4ACA                     GETNUM1:
000ACA 4ACA 1A               7      LD  A,(DE)
000ACB 4ACB 13               6      INC DE
000ACC 4ACC D630             7      SUB '0'
000ACE 4ACE D8              11      RET C
000ACF 4ACF FE0A             7      CP  10
000AD1 4AD1 D0              11      RET NC
000AD2 4AD2 4D               4      LD  C,L
000AD3 4AD3 44               4      LD  B,H
000AD4 4AD4 29              11      ADD HL,HL   ;*2
000AD5 4AD5 29              11      ADD HL,HL   ;*4
000AD6 4AD6 09              11      ADD HL,BC   ;*5
000AD7 4AD7 29              11      ADD HL,HL   ;*10
000AD8 4AD8 4F               4      LD  C,A
000AD9 4AD9 0600             7      LD  B,0
000ADB 4ADB 09              11      ADD HL,BC
000ADC 4ADC 18EC            12      JR  GETNUM1
                                
       4ADE                     SEARCH_END:
000ADE 4ADE 7E               7      LD  A,(HL)
       4ADF                     SEARCH_END1:
000ADF 4ADF 23               6      INC HL
000AE0 4AE0 B7               4      OR  A
000AE1 4AE1 C8              11      RET Z
000AE2 4AE2 FE3A             7      CP  ':'
000AE4 4AE4 20F8            12      JR  NZ,SEARCH_END
000AE6 4AE6 7E               7      LD  A,(HL)
000AE7 4AE7 FE3A             7      CP  ':'
000AE9 4AE9 28F4            12      JR  Z,SEARCH_END1
000AEB 4AEB C9              10      RET
                                
       4AEC                     FKANC:
000AEC 4AEC CB41             8      BIT 0,C
000AEE 4AEE CC114B          17      CALL    Z,CAP2
000AF1 4AF1 1803            12      JR  FKANX
       4AF3                     FKAN:           ;漢字チェック
000AF3 4AF3 DD23            10      INC IX
000AF5 4AF5 1D               4      DEC E
       4AF6                     FKANX:
000AF6 4AF6 CB41             8      BIT 0,C
000AF8 4AF8 CB81             8      RES 0,C
000AFA 4AFA C0              11      RET NZ
000AFB 4AFB FE80             7      CP  080H
000AFD 4AFD D8              11      RET C
000AFE 4AFE FEA0             7      CP  0A0H
000B00 4B00 3803            12      JR  C,FKAN1
000B02 4B02 FEE0             7      CP  0E0H
000B04 4B04 D8              11      RET C
       4B05                     FKAN1:
000B05 4B05 0C               4      INC C
000B06 4B06 A7               4      AND A
000B07 4B07 C9              10      RET
                                
       4B08                     CAP:
000B08 4B08 FE61             7      CP  'a'
000B0A 4B0A D8              11      RET C
000B0B 4B0B FE7B             7      CP  'z'+1
000B0D 4B0D D0              11      RET NC
000B0E 4B0E D620             7      SUB 020H
000B10 4B10 C9              10      RET
       4B11                     CAP2:
000B11 4B11 CD084B          17      CALL    CAP
       4B14                     CAP3:               ;
000B14 4B14 FE05             7      CP  5
000B16 4B16 2803            12      JR  Z,CAP4
000B18 4B18 FE21             7      CP  021H
000B1A 4B1A C9              10      RET
       4B1B                     CAP4:
000B1B 4B1B 3EE5             7      LD  A,0E5H
000B1D 4B1D C9              10      RET
                                
       4B1E                     ROM_OPEN:
000B1E 4B1E CD4450          17      CALL    GET_DISK_BANK_FDRV
                                
000B21 4B21 CD8B4D          17      CALL    GET_DIR_DAT
000B24 4B24 D5              11      PUSH    DE
000B25 4B25 CD3A4B          17      CALL    FILESE
000B28 4B28 D1              10      POP DE
000B29 4B29 3F               4      CCF
000B2A 4B2A D8              11      RET C
000B2B 4B2B 22E0F2          16      LD  (DIRENT1),HL
000B2E 4B2E E5              11      PUSH    HL
000B2F 4B2F 210000          10      LD  HL,0
000B32 4B32 22BDF2          16      LD  (RR_LOW),HL
000B35 4B35 22BFF2          16      LD  (RR_HIGH),HL
000B38 4B38 E1              10      POP HL
000B39 4B39 C9              10      RET
                                
       4B3A                     FILESE:
000B3A 4B3A 7E               7      LD  A,(HL)
000B3B 4B3B B7               4      OR  A
000B3C 4B3C C8              11      RET Z       ;END:ZF=1 CF=0
000B3D 4B3D FEE5             7      CP  0E5H
000B3F 4B3F 280D            12      JR  Z,FILESE1
000B41 4B41 11ECF2          10      LD  DE,FNAME
000B44 4B44 E5              11      PUSH    HL
000B45 4B45 CD8B4B          17      CALL    CPFILE
000B48 4B48 CCAC4B          17      CALL    Z,CPFILE2
000B4B 4B4B E1              10      POP HL
000B4C 4B4C 37               4      SCF
000B4D 4B4D C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4B4E                     FILESE1:
000B4E 4B4E CD564B          17      CALL    FNEXT
000B51 4B51 20E7            12      JR  NZ,FILESE
000B53 4B53 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000B55 4B55 C9              10      RET
                                
       4B56                     FNEXT:
000B56 4B56 112000          10      LD  DE,020H
000B59 4B59 19              11      ADD HL,DE
000B5A 4B5A ED5BE9F2        20      LD  DE,(_CDX)
000B5E 4B5E 7A               4      LD  A,D
000B5F 4B5F B3               4      OR  E
000B60 4B60 2019            12      JR  NZ,FNEXT_SUBDIR
000B62 4B62 0D               4      DEC C
                                #if exists USE_NORMAL_32K_ROM
                                #else
       4B63                     CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
000B63 4B63 F5              11      PUSH    AF      ;※フラグを保存する必要あり
000B64 4B64 CB7C             8      BIT 7,H
000B66 4B66 2811            12      JR  Z,CHECK_DIR_PAGE1
000B68 4B68 7C               4      LD  A,H
000B69 4B69 D620             7      SUB 020H
000B6B 4B6B 67               4      LD  H,A
000B6C 4B6C 3AE2F2          13      LD  A,(_DIR_BANK)
000B6F 4B6F 3C               4      INC A
000B70 4B70 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000B73 4B73 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000B76 4B76 32E2F2          13      LD  (_DIR_BANK),A
       4B79                     CHECK_DIR_PAGE1:
000B79 4B79 F1              10      POP AF
                                #endif
000B7A 4B7A C9              10      RET
                                
       4B7B                     FNEXT_SUBDIR:           ;サブディレクトリ
000B7B 4B7B 0D               4      DEC C
000B7C 4B7C C0              11      RET NZ
                                
000B7D 4B7D ED5BE9F2        20      LD  DE,(_CDX)
000B81 4B81 CDB44C          17      CALL    GNCL
000B84 4B84 EB               4      EX  DE,HL
000B85 4B85 22E9F2          16      LD  (_CDX),HL
000B88 4B88 C3C64D          10      JP  GET_SUBDIR
                                
       4B8B                     CPFILE:
000B8B 4B8B C5              11      PUSH    BC
000B8C 4B8C 01000B          10      LD  BC,00B00H
       4B8F                     CPSTR1:
000B8F 4B8F 1A               7      LD  A,(DE)
000B90 4B90 FE3F             7      CP  '?'     ;Wild card
000B92 4B92 2812            12      JR  Z,CPSTR2
000B94 4B94 7E               7      LD  A,(HL)
000B95 4B95 CDEC4A          17      CALL    FKANC
000B98 4B98 E5              11      PUSH    HL
000B99 4B99 67               4      LD  H,A
000B9A 4B9A 1A               7      LD  A,(DE)
000B9B 4B9B CB01             4      RLC C
000B9D 4B9D CDEC4A          17      CALL    FKANC
000BA0 4BA0 CB09             4      RRC C
000BA2 4BA2 BC               4      CP  H       ;CP (HL),(DE)
000BA3 4BA3 E1              10      POP HL
000BA4 4BA4 2004            12      JR  NZ,CPSTR3
       4BA6                     CPSTR2:
000BA6 4BA6 13               6      INC DE
000BA7 4BA7 23               6      INC HL
000BA8 4BA8 10E5            13      DJNZ    CPSTR1
       4BAA                     CPSTR3:
000BAA 4BAA C1              10      POP BC
000BAB 4BAB C9              10      RET
                                
       4BAC                     CPFILE2:
                                ;   LD  A,0E1H
000BAC 4BAC 3EF1             7      LD  A,0F1H
000BAE 4BAE 2F               4      CPL
000BAF 4BAF A6               7      AND (HL)
000BB0 4BB0 C9              10      RET
                                
       4BB1                     RBX1:
000BB1 4BB1 E5              11      PUSH    HL      ;Record byte
                                
000BB2 4BB2 ED5BBDF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000BB6 4BB6 3AC0F2          13      LD  A,(RR_HIGH+1)
000BB9 4BB9 4F               4      LD  C,A
                                
000BBA 4BBA 3AE2F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_NORMAL_32K_ROM
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
000BBD 4BBD 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000BC0 4BC0 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000BC3 4BC3 FD2AE0F2        20      LD  IY,(DIRENT1)
000BC7 4BC7 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000BCA 4BCA FD661D          19      LD  H,(IY+01DH)
000BCD 4BCD FD7E1E          19      LD  A,(IY+01EH)
                                
000BD0 4BD0 A7               4      AND A
000BD1 4BD1 ED52            15      SBC HL,DE
000BD3 4BD3 99               4      SBC A,C
000BD4 4BD4 D1              10      POP DE
                                
000BD5 4BD5 D8              11      RET C
000BD6 4BD6 4F               4      LD  C,A
000BD7 4BD7 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000BD8 4BD8 B2               4      OR  D
000BD9 4BD9 B3               4      OR  E
000BDA 4BDA C0              11      RET NZ
000BDB 4BDB 37               4      SCF
000BDC 4BDC C9              10      RET
                                
       4BDD                     RBX2:
000BDD 4BDD ED4BBEF2        20      LD  BC,(RR_LOW+1)
000BE1 4BE1 CD654C          17      CALL    RWXR
000BE4 4BE4 3ABAF2          13      LD  A,(CLSZ_H)
000BE7 4BE7 3D               4      DEC A
000BE8 4BE8 E5              11      PUSH    HL
000BE9 4BE9 2ABDF2          16      LD  HL,(RR_LOW)
000BEC 4BEC A4               4      AND H
000BED 4BED B5               4      OR  L
000BEE 4BEE E1              10      POP HL
000BEF 4BEF C9              10      RET
                                
       4BF0                     RBXA:
000BF0 4BF0 D5              11      PUSH    DE
000BF1 4BF1 CDD74C          17      CALL    CLUST
000BF4 4BF4 ED53C5F2        20      LD  (_DTPS),DE
000BF8 4BF8 D1              10      POP DE
000BF9 4BF9 CDB44C          17      CALL    GNCL
000BFC 4BFC D8              11      RET C
000BFD 4BFD ED53C1F2        20      LD  (_CLPS),DE
                                
000C01 4C01 ED4BBDF2        20      LD  BC,(RR_LOW)
000C05 4C05 2AB9F2          16      LD  HL,(CLSZ)
000C08 4C08 7C               4      LD  A,H
000C09 4C09 3D               4      DEC A
000C0A 4C0A A0               4      AND B
000C0B 4C0B 47               4      LD  B,A
000C0C 4C0C ED42            15      SBC HL,BC       ;remaining cluster
                                
000C0E 4C0E ED5BE3F2        20      LD  DE,(LEFTX)
000C12 4C12 ED52            15      SBC HL,DE       ;CP HL,DE
000C14 4C14 19              11      ADD HL,DE
000C15 4C15 3801            12      JR  C,RBXA1
000C17 4C17 EB               4      EX  DE,HL
       4C18                     RBXA1:
000C18 4C18 3AB7F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_NORMAL_32K_ROM
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
000C1B 4C1B 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C1E 4C1E 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000C21 4C21 E5              11      PUSH    HL
000C22 4C22 2AC5F2          16      LD  HL,(_DTPS)
000C25 4C25 09              11      ADD HL,BC
000C26 4C26 ED5BDAF2        20      LD  DE,(DTAX)
000C2A 4C2A C1              10      POP BC
000C2B 4C2B C9              10      RET
                                
       4C2C                     RBXB:
000C2C 4C2C 2ADAF2          16      LD  HL,(DTAX)
000C2F 4C2F ED5BC1F2        20      LD  DE,(_CLPS)
000C33 4C33 3AE4F2          13      LD  A,(LEFTX+1)
000C36 4C36 47               4      LD  B,A
000C37 4C37 3ABAF2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4C3A                     RBXB1:
000C3A 4C3A 1F               4      RRA     ;->CF
000C3B 4C3B 3804            12      JR  C,RBXB2
000C3D 4C3D CB38             8      SRL B   ;B=B/2
000C3F 4C3F 18F9            12      JR  RBXB1
       4C41                     RBXB2:
000C41 4C41 78               4      LD  A,B
000C42 4C42 B7               4      OR  A
000C43 4C43 C9              10      RET
                                
       4C44                     RBXC:
000C44 4C44 ED4BE3F2        20      LD  BC,(LEFTX)
000C48 4C48 3ABAF2          13      LD  A,(CLSZ_H)
000C4B 4C4B 3D               4      DEC A
000C4C 4C4C A0               4      AND B
000C4D 4C4D 47               4      LD  B,A
000C4E 4C4E B1               4      OR  C
000C4F 4C4F C9              10      RET
                                
       4C50                     RBXEND:
000C50 4C50 ED5BC3F2        20      LD  DE,(_LEFT)
000C54 4C54 2ABDF2          16      LD  HL,(RR_LOW)
000C57 4C57 3AC0F2          13      LD  A,(RR_HIGH+1)
000C5A 4C5A 19              11      ADD HL,DE
000C5B 4C5B CE00             7      ADC A,0
000C5D 4C5D 22BDF2          16      LD  (RR_LOW),HL
000C60 4C60 32C0F2          13      LD  (RR_HIGH+1),A
000C63 4C63 EB               4      EX  DE,HL       ;HL=Read byte
000C64 4C64 C9              10      RET 
                                
       4C65                     RWXR:
000C65 4C65 3ABAF2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4C68                     L_RWX:
000C68 4C68 1F               4      RRA     ;->CF
000C69 4C69 3806            12      JR  C,E_RWX
000C6B 4C6B CB38             8      SRL B   ;BC=BC/2
000C6D 4C6D CB19             8      RR  C   ;
000C6F 4C6F 18F7            12      JR  L_RWX
       4C71                     E_RWX:
000C71 4C71 3AE2F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_NORMAL_32K_ROM
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
000C74 4C74 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C77 4C77 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000C7A 4C7A FD2AE0F2        20      LD  IY,(DIRENT1)
000C7E 4C7E FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000C81 4C81 FD561B          19      LD  D,(IY+01BH)
000C84 4C84 CD4450          17      CALL    GET_DISK_BANK_FDRV
       4C87                     RWX1:
000C87 4C87 ED53C1F2        20      LD  (_CLPS),DE
000C8B 4C8B 7A               4      LD  A,D
000C8C 4C8C B3               4      OR  E
000C8D 4C8D 37               4      SCF
000C8E 4C8E C8              11      RET Z
                                
000C8F 4C8F 78               4      LD  A,B
000C90 4C90 B1               4      OR  C
000C91 4C91 C8              11      RET Z
                                
000C92 4C92 CDB44C          17      CALL    GNCL
000C95 4C95 D8              11      RET C
000C96 4C96 0B               6      DEC BC
000C97 4C97 CD244D          17      CALL    ENDCL
000C9A 4C9A 38EB            12      JR  C,RWX1
000C9C 4C9C 37               4      SCF
000C9D 4C9D C9              10      RET
                                
       4C9E                     NCL3:
000C9E 4C9E CD4450          17      CALL    GET_DISK_BANK_FDRV
000CA1 4CA1 6B               4      LD  L,E
000CA2 4CA2 62               4      LD  H,D
000CA3 4CA3 CB3C             8      SRL H
000CA5 4CA5 CB1D             8      RR  L
000CA7 4CA7 1F               4      RRA
000CA8 4CA8 19              11      ADD HL,DE
000CA9 4CA9 010060          10      LD  BC,BANK1_ADR
000CAC 4CAC 09              11      ADD HL,BC
000CAD 4CAD ED4BBBF2        20      LD  BC,(SECSZ)
000CB1 4CB1 09              11      ADD HL,BC
000CB2 4CB2 17               4      RLA
000CB3 4CB3 C9              10      RET
                                
       4CB4                     GNCL:
000CB4 4CB4 7A               4      LD  A,D
000CB5 4CB5 B3               4      OR  E
000CB6 4CB6 37               4      SCF
000CB7 4CB7 C8              11      RET Z
000CB8 4CB8 C5              11      PUSH    BC
000CB9 4CB9 E5              11      PUSH    HL
000CBA 4CBA CD9E4C          17      CALL    NCL3
000CBD 4CBD 3809            12      JR  C,GNC1
000CBF 4CBF 5E               7      LD  E,(HL)
000CC0 4CC0 23               6      INC HL
000CC1 4CC1 7E               7      LD  A,(HL)
000CC2 4CC2 E60F             7      AND 00FH
000CC4 4CC4 57               4      LD  D,A
000CC5 4CC5 E1              10      POP HL
000CC6 4CC6 C1              10      POP BC
000CC7 4CC7 C9              10      RET
       4CC8                     GNC1:
000CC8 4CC8 7E               7      LD  A,(HL)
000CC9 4CC9 23               6      INC HL
000CCA 4CCA 56               7      LD  D,(HL)
000CCB 4CCB 0604             7      LD  B,4
       4CCD                     GNC1L:
000CCD 4CCD CB3A             8      SRL D
000CCF 4CCF 1F               4      RRA
000CD0 4CD0 10FB            13      DJNZ    GNC1L
                                
000CD2 4CD2 5F               4      LD  E,A
000CD3 4CD3 E1              10      POP HL
000CD4 4CD4 C1              10      POP BC
000CD5 4CD5 A7               4      AND A
000CD6 4CD6 C9              10      RET
                                
       4CD7                     CLUST:
000CD7 4CD7 EB               4      EX  DE,HL
       4CD8                     CLUST_HL:
000CD8 4CD8 C5              11      PUSH    BC
000CD9 4CD9 3ABAF2          13      LD  A,(CLSZ_H)
000CDC 4CDC CD7050          17      CALL    MUL_AHL
                                
000CDF 4CDF CDA84D          17      CALL    GET_DIR_POS
000CE2 4CE2 4F               4      LD  C,A
000CE3 4CE3 0600             7      LD  B,0
000CE5 4CE5 09              11      ADD HL,BC
                                
000CE6 4CE6 3A1260          13      LD  A,(BANK1_ADR+17+1)  ;BPB_RootEntCnt High
000CE9 4CE9 1F               4      RRA
000CEA 4CEA 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000CED 4CED 1F               4      RRA
000CEE 4CEE 0F               4      RRCA
000CEF 4CEF 0F               4      RRCA
000CF0 4CF0 0F               4      RRCA
000CF1 4CF1 4F               4      LD  C,A
                                
000CF2 4CF2 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000CF5 4CF5 FE02             7      CP  2
000CF7 4CF7 280C            12      JR  Z,CLUST1
000CF9 4CF9 CB01             4      RLC C
000CFB 4CFB 0D               4      DEC C
000CFC 4CFC 3A0C60          13      LD  A,(BANK1_ADR+11+1)  ;BPB_BytsPerSec High    
000CFF 4CFF FE02             7      CP  2
000D01 4D01 2002            12      JR  NZ,CLUST1
000D03 4D03 0D               4      DEC C
000D04 4D04 0D               4      DEC C
       4D05                     CLUST1:
000D05 4D05 0D               4      DEC C
000D06 4D06 09              11      ADD HL,BC
                                
                                #if exists USE_NORMAL_32K_ROM
                                    LD  A,L
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    JR  NC,CLUST2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
000D07 4D07 4D               4      LD  C,L     ;C=読み出し元
000D08 4D08 29              11      ADD HL,HL   ;64KB→32KB
000D09 4D09 29              11      ADD HL,HL   ;32KB→16KB
000D0A 4D0A 29              11      ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
000D0B 4D0B CD4450          17      CALL    GET_DISK_BANK_FDRV
000D0E 4D0E 84               4      ADD A,H
000D0F 4D0F 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D12 4D12 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D15 4D15 32B7F2          13      LD  (_BANK),A
000D18 4D18 69               4      LD  L,C     ;C=読み出し元
000D19 4D19 3E1F             7      LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
000D1B 4D1B A5               4      AND L
                                #endif
       4D1C                     CLUST2:
000D1C 4D1C C660             7      ADD A,high BANK1_ADR
000D1E 4D1E 67               4      LD  H,A
000D1F 4D1F 2E00             7      LD  L,0
000D21 4D21 EB               4      EX  DE,HL
000D22 4D22 C1              10      POP BC
000D23 4D23 C9              10      RET
                                
       4D24                     ENDCL:
000D24 4D24 7A               4      LD  A,D ;END CLUSTER
000D25 4D25 FE0F             7      CP  00FH    ;FAT12の最大値
000D27 4D27 C0              11      RET NZ
000D28 4D28 7B               4      LD  A,E
000D29 4D29 FEF7             7      CP  0F7H
000D2B 4D2B C9              10      RET
                                
       4D2C                     RB_READ:
000D2C 4D2C AF               4      XOR A   ;HLA = HL*128
000D2D 4D2D CB3C             8      SRL H
000D2F 4D2F CB1D             8      RR  L
000D31 4D31 1F               4      RRA
000D32 4D32 32BDF2          13      LD  (RR_LOW),A
000D35 4D35 22BEF2          16      LD  (RR_MID),HL
000D38 4D38 218000          10      LD  HL,128
                                
000D3B 4D3B CDFE48          17      CALL    ROM_READ
000D3E 4D3E C9              10      RET
                                
       4D3F                     GETSEQ:
000D3F 4D3F FD6E20          19      LD  L,(IY+32)
000D42 4D42 FD660C          19      LD  H,(IY+12)
                                
000D45 4D45 CB25             8      SLA L
                                
000D47 4D47 CB3C             8      SRL H
000D49 4D49 CB1D             8      RR  L
000D4B 4D4B C9              10      RET
                                
       4D4C                     SETSEQ:
000D4C 4D4C F5              11      PUSH    AF
000D4D 4D4D 3ABDF2          13      LD  A,(RR_LOW)
000D50 4D50 2ABEF2          16      LD  HL,(RR_MID)
                                
000D53 4D53 CD6A4D          17      CALL    SSQ1
                                
000D56 4D56 29              11      ADD HL,HL
000D57 4D57 CB3D             8      SRL L
000D59 4D59 FD7520          19      LD  (IY+32),L
000D5C 4D5C FD740C          19      LD  (IY+12),H
000D5F 4D5F F1              10      POP AF
000D60 4D60 C9              10      RET
                                
       4D61                     GETSIZE:
000D61 4D61 FD7E10          19      LD  A,(IY+16)
000D64 4D64 FD6E11          19      LD  L,(IY+17)
000D67 4D67 FD6612          19      LD  H,(IY+18)
       4D6A                     SSQ1:
000D6A 4D6A 87               4      ADD A,A
000D6B 4D6B ED6A            15      ADC HL,HL
000D6D 4D6D B7               4      OR  A
000D6E 4D6E C8              11      RET Z
000D6F 4D6F 23               6      INC HL
000D70 4D70 C9              10      RET
                                
       4D71                     SET_FCB:
000D71 4D71 D5              11      PUSH    DE
000D72 4D72 FDE1            14      POP IY
000D74 4D74 FD7E1C          19      LD  A,(IY+28)
000D77 4D77 FEFF             7      CP  0FFH
000D79 4D79 200C            12      JR  NZ,POPAF_SCF_FF_RET
000D7B 4D7B E5              11      PUSH    HL
000D7C 4D7C FD6E1A          19      LD  L,(IY+26)
000D7F 4D7F FD661B          19      LD  H,(IY+27)
000D82 4D82 22C1F2          16      LD  (_CLPS),HL
000D85 4D85 E1              10      POP HL
000D86 4D86 C9              10      RET
                                
       4D87                     POPAF_SCF_FF_RET:
000D87 4D87 F1              10      POP AF
000D88 4D88 37               4      SCF
000D89 4D89 9F               4      SBC A,A
000D8A 4D8A C9              10      RET
                                
       4D8B                     GET_DIR_DAT:
000D8B 4D8B 2AE9F2          16      LD  HL,(_CDX)
000D8E 4D8E 7C               4      LD  A,H
000D8F 4D8F B5               4      OR  L
000D90 4D90 2034            12      JR  NZ,GET_SUBDIR
000D92 4D92 CDA84D          17      CALL    GET_DIR_POS
000D95 4D95 C660             7      ADD A,high BANK1_ADR
000D97 4D97 2E00             7      LD  L,0
000D99 4D99 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_NORMAL_32K_ROM
                                #else
000D9A 4D9A CD634B          17      CALL    CHECK_DIR_PAGE
                                #endif
000D9D 4D9D 3AB8F2          13      LD  A,(_BANK1)
000DA0 4DA0 32E2F2          13      LD  (_DIR_BANK),A
                                
000DA3 4DA3 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000DA6 4DA6 4F               4      LD  C,A
000DA7 4DA7 C9              10      RET
                                
       4DA8                     GET_DIR_POS:                ;ルートディレクトリ
000DA8 4DA8 CD4450          17      CALL    GET_DISK_BANK_FDRV
000DAB 4DAB 32B8F2          13      LD  (_BANK1),A
000DAE 4DAE 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000DB1 4DB1 47               4      LD  B,A
000DB2 4DB2 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000DB5 4DB5 4F               4      LD  C,A
000DB6 4DB6 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4DB9                     GET_DIR_POS1:
000DB9 4DB9 81               4      ADD A,C
000DBA 4DBA 10FD            13      DJNZ    GET_DIR_POS1
                                
000DBC 4DBC ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec 
       4DC0                     L_MDP:
000DC0 4DC0 CB18             8      RR  B   ;->CF
000DC2 4DC2 D8              11      RET C
000DC3 4DC3 87               4      ADD A,A
000DC4 4DC4 18FA            12      JR  L_MDP
                                
       4DC6                     GET_SUBDIR:             ;サブディレクトリ
000DC6 4DC6 CDD84C          17      CALL    CLUST_HL
000DC9 4DC9 EB               4      EX  DE,HL
000DCA 4DCA 3AB7F2          13      LD  A,(_BANK)
000DCD 4DCD 32E2F2          13      LD  (_DIR_BANK),A
000DD0 4DD0 3ABAF2          13      LD  A,(CLSZ_H)
000DD3 4DD3 87               4      ADD A,A     ;*2
000DD4 4DD4 87               4      ADD A,A     ;*4
000DD5 4DD5 87               4      ADD A,A     ;*8
000DD6 4DD6 4F               4      LD  C,A
000DD7 4DD7 C9              10      RET
                                
       4DD8                     STATEMENT:
000DD8 4DD8 11664E          10      LD  DE,STR_CHDIR
000DDB 4DDB CD4C4E          17      CALL    CPPROCNM
000DDE 4DDE 280A            12      JR  Z,_CHDIR
000DE0 4DE0 116C4E          10      LD  DE,STR_RAMDISK
000DE3 4DE3 CD4C4E          17      CALL    CPPROCNM
000DE6 4DE6 2814            12      JR  Z,_RAMDISK
000DE8 4DE8 37               4      SCF
000DE9 4DE9 C9              10      RET
       4DEA                     _CHDIR:
000DEA 4DEA 7E               7      LD  A,(HL)
000DEB 4DEB FE28             7      CP  '('
000DED 4DED 37               4      SCF
000DEE 4DEE C0              11      RET NZ
000DEF 4DEF CDA946          17      CALL    INIT_PARAM
000DF2 4DF2 CD9F49          17      CALL    FILE_B
000DF5 4DF5 CD144E          17      CALL    ROM_CD
000DF8 4DF8 DA6C45          10      JP  C,ERROR_FILE_NOT_FOUND
000DFB 4DFB C9              10      RET
                                
       4DFC                     _RAMDISK:
000DFC 4DFC 7E               7      LD  A,(HL)
000DFD 4DFD FE28             7      CP  '('
000DFF 4DFF 37               4      SCF
000E00 4E00 C0              11      RET NZ
000E01 4E01 23               6      INC HL
000E02 4E02 DD212F54        14      LD  IX,FRMQNT
000E06 4E06 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000E0A 4E0A CD1C00          17      CALL    _CALSLT
                                ;   LD  A,(HOKVLD)  ;bit0: 拡張 BIOSの存在
                                ;   CPL
                                ;   AND 1
000E0D 4E0D 7A               4      LD  A,D
000E0E 4E0E B3               4      OR  E
000E0F 4E0F C26645          10      JP  NZ,ERROR_INTERNAL_ERROR
                                ;   PUSH    HL      ;EXTBIOもDISK BIOSで初期化してそう
                                ;   LD  A,0     ;すでにA=0になっている
                                ;   LD  DE,0401H    ;D=マッパサポートルチン(4) E=機能番号(1)
                                ;   CALL    EXTBIO
                                ;   POP HL
                                ;   OR  A
                                ;   JP  Z,ERROR_INTERNAL_ERROR
000E12 4E12 23               6      INC HL
000E13 4E13 C9              10      RET
                                
       4E14                     ROM_CD:
000E14 4E14 3AECF2          13      LD  A,(FNAME)
000E17 4E17 FE20             7      CP  020H
000E19 4E19 2822            12      JR  Z,CD1
000E1B 4E1B CD1E4B          17      CALL    ROM_OPEN
000E1E 4E1E D8              11      RET C
000E1F 4E1F FD2AE0F2        20      LD  IY,(DIRENT1)
000E23 4E23 FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
000E27 4E27 CA6C45          10      JP  Z,ERROR_FILE_NOT_FOUND
000E2A 4E2A FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000E2D 4E2D FD661B          19      LD  H,(IY+01BH)
       4E30                     CD2:
000E30 4E30 22DEF2          16      LD  (_CD),HL
000E33 4E33 2AE7F2          16      LD  HL,(PARAM1)
       4E36                     CD_SKIP:
000E36 4E36 7E               7      LD  A,(HL)
000E37 4E37 23               6      INC HL
000E38 4E38 FE21             7      CP  021H
000E3A 4E3A 38FA            12      JR  C,CD_SKIP
000E3C 4E3C C9              10      RET
       4E3D                     CD1:
000E3D 4E3D 2AE9F2          16      LD  HL,(_CDX)
000E40 4E40 18EE            12      JR  CD2
                                
       4E42                     DEVICE1:
000E42 4E42 11744E          10      LD  DE,STR_A
000E45 4E45 CD4C4E          17      CALL    CPPROCNM
000E48 4E48 37               4      SCF
000E49 4E49 C0              11      RET NZ
000E4A 4E4A AF               4      XOR A
000E4B 4E4B C9              10      RET
                                
       4E4C                     CPPROCNM:
000E4C 4E4C E5              11      PUSH    HL
000E4D 4E4D 2189FD          10      LD  HL,PROCNM
       4E50                     CPPROCNM1:
000E50 4E50 1A               7      LD  A,(DE)
000E51 4E51 13               6      INC DE
000E52 4E52 BE               7      CP  (HL)
000E53 4E53 23               6      INC HL
000E54 4E54 2003            12      JR  NZ,CPPROCNM2
000E56 4E56 B7               4      OR  A
000E57 4E57 20F7            12      JR  NZ,CPPROCNM1
       4E59                     CPPROCNM2:
000E59 4E59 E1              10      POP HL
000E5A 4E5A C9              10      RET
                                
       4E5B                     WILDCARD:
000E5B 4E5B 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       4E66                     STR_CHDIR:
000E66 4E66 434844495200            DB  "CHDIR",0
       4E6C                     STR_RAMDISK:
000E6C 4E6C 52414D4449534B00        DB  "RAMDISK",0
       4E74                     STR_A:
000E74 4E74 4100                    DB  "A",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4E76                     ERROR_WRITE_PROTECTED:
000E76 4E76 3E00             7      LD  A,0     ;Write protected
000E78 4E78 C9              10      RET
       4E79                     DISKIO:
000E79 4E79 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000E7B 4E7B 48               4      LD  C,B
000E7C 4E7C CD4E50          17      CALL    GET_DISK_BANK
       4E7F                     SETMAP1:        
000E7F 4E7F E5              11      PUSH    HL
       4E80                     DISKIO1:
000E80 4E80 C5              11      PUSH    BC      ;B=残りのセクタ数
000E81 4E81 D5              11      PUSH    DE      ;DE=セクタ番号
000E82 4E82 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
000E83 4E83 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
000E84 4E84 F5              11      PUSH    AF
000E85 4E85 3ABCF2          13      LD  A,(SECSZ_H)
000E88 4E88 CD7050          17      CALL    MUL_AHL
000E8B 4E8B F1              10      POP AF
                                #if exists USE_NORMAL_32K_ROM
                                    LD  A,L
                                    PUSH    BC
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    POP BC
                                    JR  NC,DISKIO2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
000E8C 4E8C 4D               4      LD  C,L     ;C=読み出し元
000E8D 4E8D 29              11      ADD HL,HL       ;64KB→32KB
000E8E 4E8E 29              11      ADD HL,HL       ;32KB→16KB
000E8F 4E8F 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
000E90 4E90 84               4      ADD A,H
000E91 4E91 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000E94 4E94 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000E97 4E97 32B7F2          13      LD  (_BANK),A
000E9A 4E9A 79               4      LD  A,C     ;C=読み出し元
000E9B 4E9B E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       4E9D                     DISKIO2:
000E9D 4E9D C660             7      ADD A,high BANK1_ADR
000E9F 4E9F 67               4      LD  H,A
000EA0 4EA0 ED4BBBF2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
000EA4 4EA4 69               4      LD  L,C     ;C=0
000EA5 4EA5 CD0F44          17      CALL    ROM_LDIR
000EA8 4EA8 EB               4      EX  DE,HL
000EA9 4EA9 F1              10      POP AF
000EAA 4EAA D1              10      POP DE
000EAB 4EAB 13               6      INC DE
000EAC 4EAC C1              10      POP BC
000EAD 4EAD 10D1            13      DJNZ    DISKIO1
000EAF 4EAF 41               4      LD  B,C
                                
000EB0 4EB0 E1              10      POP HL
000EB1 4EB1 AF               4      XOR A
                                
000EB2 4EB2 FB               4      EI
000EB3 4EB3 C9              10      RET
                                
       4EB4                     DSKCHG:
000EB4 4EB4 CDED4E          17      CALL    IS_BPB
000EB7 4EB7 3824            12      JR  C,NOTREADY
000EB9 4EB9 3A23FB          13      LD  A,(DRVTBL+2)
000EBC 4EBC B7               4      OR  A
000EBD 4EBD 201A            12      JR  NZ,DSKCHG1
000EBF 4EBF 3A21FB          13      LD  A,(DRVTBL)
000EC2 4EC2 FE02             7      CP  2
000EC4 4EC4 2013            12      JR  NZ,DSKCHG1
000EC6 4EC6 CDED4E          17      CALL    IS_BPB
000EC9 4EC9 300E            12      JR  NC,DSKCHG1
000ECB 4ECB 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000ECD 4ECD 3221FB          13      LD  (DRVTBL),A
000ED0 4ED0 3223FB          13      LD  (DRVTBL+2),A
000ED3 4ED3 3A48F3          13      LD  A,(MASTERS)
000ED6 4ED6 3224FB          13      LD  (DRVTBL+3),A
       4ED9                     DSKCHG1:
000ED9 4ED9 AF               4      XOR A
000EDA 4EDA 0601             7      LD  B,1
000EDC 4EDC C9              10      RET
       4EDD                     NOTREADY:
000EDD 4EDD 3E02             7      LD  A,2
000EDF 4EDF 37               4      SCF
000EE0 4EE0 C9              10      RET
                                
       4EE1                     NO_BPB:
000EE1 4EE1 E1              10      POP HL
000EE2 4EE2 23               6      INC HL
000EE3 4EE3 117650          10      LD  DE,DPB2DD
000EE6 4EE6 011200          10      LD  BC,DPB2DD_E-DPB2DD
000EE9 4EE9 EDB0                    LDIR
000EEB 4EEB AF               4      XOR A
000EEC 4EEC C9              10      RET
                                
       4EED                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000EED 4EED CD4E50          17      CALL    GET_DISK_BANK
                                
000EF0 4EF0 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000EF3 4EF3 FE01             7      CP  1
000EF5 4EF5 D8              11      RET C
                                
000EF6 4EF6 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000EF9 4EF9 C6FF             7      ADD A,0FFH
000EFB 4EFB D8              11      RET C
                                
000EFC 4EFC 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       4EFF                     IS_BPB1:
000EFF 4EFF FE01             7      CP  1
000F01 4F01 C8              11      RET Z
000F02 4F02 FE02             7      CP  2
000F04 4F04 C8              11      RET Z
000F05 4F05 FE04             7      CP  4
000F07 4F07 C8              11      RET Z
000F08 4F08 37               4      SCF
000F09 4F09 C9              10      RET
                                
       4F0A                     GETDPB:
000F0A 4F0A E5              11      PUSH    HL
000F0B 4F0B CD4E50          17      CALL    GET_DISK_BANK
                                
000F0E 4F0E 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000F11 4F11 B7               4      OR  A
000F12 4F12 28CD            12      JR  Z,NO_BPB
000F14 4F14 DDE1            14      POP IX
000F16 4F16 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000F19 4F19 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000F1C 4F1C DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000F1F 4F1F 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000F22 4F22 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000F25 4F25 87               4      ADD A,A
000F26 4F26 87               4      ADD A,A
000F27 4F27 87               4      ADD A,A
000F28 4F28 3D               4      DEC A
000F29 4F29 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000F2C 4F2C 06FF             7      LD  B,-1
000F2E 4F2E A7               4      AND A           ;無限ループ阻止
       4F2F                     GETDPB1:
000F2F 4F2F 04               4      INC B
000F30 4F30 1F               4      RRA
000F31 4F31 38FC            12      JR  C,GETDPB1
000F33 4F33 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000F36 4F36 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000F39 4F39 3D               4      DEC A
000F3A 4F3A DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000F3D 4F3D A7               4      AND A           ;無限ループ阻止
000F3E 4F3E 06FF             7      LD  B,-1
       4F40                     GETDPB2:
000F40 4F40 04               4      INC B
000F41 4F41 1F               4      RRA
000F42 4F42 38FC            12      JR  C,GETDPB2
000F44 4F44 04               4      INC B
000F45 4F45 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000F48 4F48 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
000F4B 4F4B DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
000F4E 4F4E DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
000F51 4F51 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
000F54 4F54 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000F57 4F57 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
000F5A 4F5A DD770B          19      LD  (IX+11),A       ;MAXENT
                                
000F5D 4F5D ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
000F61 4F61 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
000F64 4F64 DD460A          19      LD  B,(IX+10)       ;FATCNT
000F67 4F67 210000          10      LD  HL,0
       4F6A                     GETDPB3:
000F6A 4F6A 19              11      ADD HL,DE
000F6B 4F6B 10FD            13      DJNZ    GETDPB3
       4F6D                     GETDPB4:
000F6D 4F6D DD5E08          19      LD  E,(IX+8)        ;FIRFAT
000F70 4F70 DD5609          19      LD  D,(IX+9)        ;FIRFAT
000F73 4F73 19              11      ADD HL,DE
000F74 4F74 DD7511          19      LD  (IX+17),L       ;FIRDIR
000F77 4F77 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000F7A 4F7A DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000F7D 4F7D 87               4      ADD A,A
000F7E 4F7E 87               4      ADD A,A
000F7F 4F7F DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4F82                     GETDPB5:
000F82 4F82 CB3B             8      SRL E
000F84 4F84 1F               4      RRA
000F85 4F85 30FB            12      JR  NC,GETDPB5
000F87 4F87 1600             7      LD  D,0
000F89 4F89 19              11      ADD HL,DE
000F8A 4F8A DD750C          19      LD  (IX+12),L       ;FIRREC
000F8D 4F8D DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000F90 4F90 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
000F93 4F93 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
000F96 4F96 DD560D          19      LD  D,(IX+13)       ;FIRREC
000F99 4F99 A7               4      AND A
000F9A 4F9A ED52            15      SBC HL,DE
                                
000F9C 4F9C DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
000F9F 4F9F 3C               4      INC A
000FA0 4FA0 37               4      SCF             ;無限ループ阻止
       4FA1                     GETDPB6:
000FA1 4FA1 1F               4      RRA
000FA2 4FA2 3806            12      JR  C,GETDPB7
000FA4 4FA4 CB3C             8      SRL H
000FA6 4FA6 CB1D             8      RR  L
000FA8 4FA8 18F7            12      JR  GETDPB6
       4FAA                     GETDPB7:
000FAA 4FAA 23               6      INC HL
000FAB 4FAB DD750E          19      LD  (IX+14),L       ;MAXCLUS
000FAE 4FAE DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       4FB1                     GETDPBD1:
000FB1 4FB1 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000FB4 4FB4 E6FC             7      AND 0FCH
000FB6 4FB6 C8              11      RET Z
                                
000FB7 4FB7 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
000FBB 4FBB 37               4      SCF
000FBC 4FBC DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
000FC0 4FC0 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
000FC3 4FC3 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
000FC7 4FC7 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
000FCB 4FCB DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
000FCF 4FCF DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
000FD3 4FD3 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
000FD7 4FD7 DDCB1126        23      SLA (IX+17)         ;FIRDIR
000FDB 4FDB DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
000FDF 4FDF DD6E11          19      LD  L,(IX+17)       ;FIRDIR
000FE2 4FE2 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
000FE5 4FE5 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000FE8 4FE8 87               4      ADD A,A
000FE9 4FE9 87               4      ADD A,A
000FEA 4FEA DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4FED                     GETDPBD5:
000FED 4FED CB3B             8      SRL E
000FEF 4FEF 1F               4      RRA
000FF0 4FF0 30FB            12      JR  NC,GETDPBD5
000FF2 4FF2 1600             7      LD  D,0
000FF4 4FF4 19              11      ADD HL,DE
000FF5 4FF5 DD750C          19      LD  (IX+12),L       ;FIRREC
000FF8 4FF8 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000FFB 4FFB 18B4            12      JR  GETDPBD1
                                
       4FFD                     CHOICE:
000FFD 4FFD 210000          10      LD  HL,0
001000 5000 C9              10      RET
                                
       5001                     DSKFMT:
001001 5001 AF               4      XOR A
001002 5002 37               4      SCF
       5003                     DSKSTP:
001003 5003 C9              10      RET
                                
       5004                     BASENT:
001004 5004 3A40F3          13      LD  A,(REBOOT)
001007 5007 B7               4      OR  A
001008 5008 202B            12      JR  NZ,REBOOT1
00100A 500A 218850          10      LD  HL,AUTOEXEC
00100D 500D 11EBF2          10      LD  DE,FDRV
001010 5010 010C00          10      LD  BC,1+8+3
001013 5013 EDB0                    LDIR
001015 5015 CD1E4B          17      CALL    ROM_OPEN
001018 5018 381B            12      JR  C,REBOOT1
00101A 501A CD2145          17      CALL    ROM_LOAD1
00101D 501D 219450          10      LD  HL,CMD_RUN
001020 5020 111FF4          10      LD  DE,KBUF
001023 5023 D5              11      PUSH    DE
001024 5024 010300          10      LD  BC,3
001027 5027 EDB0                    LDIR
001029 5029 E1              10      POP HL
00102A 502A FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00102E 502E DD210146        14      LD  IX,NEWSTT
001032 5032 CD1C00          17      CALL    _CALSLT
       5035                     REBOOT1:
001035 5035 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
001039 5039 DD219B40        14      LD  IX,READYR
00103D 503D C31C00          10      JP  _CALSLT
                                
       5040                     GETSLT:
001040 5040 3A22FB          13      LD  A,(DRVTBL+1)
001043 5043 C9              10      RET
                                
       5044                     GET_DISK_BANK_FDRV:
001044 5044 3AEBF2          13      LD  A,(FDRV)
001047 5047 D601             7      SUB 1
001049 5049 3003            12      JR  NC,GET_DISK_BANK
00104B 504B 3ADDF2          13      LD  A,(_DVSW)
       504E                     GET_DISK_BANK:
00104E 504E B7               4      OR  A       ;A=DRIVE
00104F 504F 3E01             7      LD  A,DISK_BANK
001051 5051 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
001053 5053 3ADCF2          13      LD  A,(B_DRIVE)
                                #endif
       5056                     SET_DISK_BANK:
                                #if exists USE_NORMAL_32K_ROM
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
001056 5056 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
001059 5059 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
00105C 505C F5              11      PUSH    AF
00105D 505D E5              11      PUSH    HL
00105E 505E 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
001061 5061 22BBF2          16      LD  (SECSZ),HL
001064 5064 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
001067 5067 CD7050          17      CALL    MUL_AHL
00106A 506A 22B9F2          16      LD  (CLSZ),HL
00106D 506D E1              10      POP HL
00106E 506E F1              10      POP AF
00106F 506F C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       5070                     MUL_AHL:
001070 5070 37               4      SCF     ;無限ループ回避
       5071                     MUL_AHL1:
001071 5071 1F               4      RRA     ;->CF
001072 5072 D8              11      RET C
001073 5073 29              11      ADD HL,HL
001074 5074 18FB            12      JR  MUL_AHL1
                                
       5076                     DPB2DD:
001076 5076 F9                      DB  0F9H    ;MEDIA
001077 5077 0002                    DW  00200H  ;SECSIZ
001079 5079 0F                      DB  00FH    ;DIRMSK
00107A 507A 04                      DB  004H    ;DIRSHFT
00107B 507B 01                      DB  001H    ;CLUSMSK
00107C 507C 02                      DB  002H    ;CLUSSHFT
00107D 507D 0100                    DW  00001H  ;FIRFAT
00107F 507F 02                      DB  002H    ;FATCNT
001080 5080 70                      DB  070H    ;MAXENT
001081 5081 0E00                    DW  0000EH  ;FIRREC
001083 5083 CA02                    DW  002CAH  ;MAXCLUS
001085 5085 03                      DB  003H    ;FATSIZ
001086 5086 0700                    DW  0007H   ;FIRDIR
       5088                     DPB2DD_E:
                                
       5088                     AUTOEXEC:
001088 5088 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       5094                     CMD_RUN:
001094 5094 3A8A00                  DB  03AH,08AH,0
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       5097                     POP_HL_ERROR:
001097 5097 E1              10      POP     HL
       5098                     _ERROR:
001098 5098 0600             7      LD  B,0
00109A 509A A7               4      AND A
00109B 509B C9              10      RET
                                
       509C                     ROM_BDOS:
00109C 509C E5              11      PUSH    HL
00109D 509D 79               4      LD  A,C
00109E 509E 87               4      ADD A,A
00109F 509F 38F7            12      JR  C,_ERROR
0010A1 50A1 6F               4      LD  L,A
0010A2 50A2 265F             7      LD  H,high STABLE
0010A4 50A4 7E               7      LD  A,(HL)
0010A5 50A5 2C               4      INC L
0010A6 50A6 66               7      LD  H,(HL)
0010A7 50A7 6F               4      LD  L,A
0010A8 50A8 E3              19      EX  (SP),HL
0010A9 50A9 79               4      LD  A,C
0010AA 50AA C9              10      RET
                                
       50AB                     _PRINT:
       50AB                     PRINT:
0010AB 50AB 7B               4      LD  A,E
0010AC 50AC 1803            12      JR  MSG_A
                                
       50AE                     _SYS01:     ;(BDOS)コンソール入力
0010AE 50AE CD2551          17      CALL    _SYS07
       50B1                     MSG_A:
0010B1 50B1 FE03             7      CP  3
0010B3 50B3 2814            12      JR  Z,MSG_BR
       50B5                     MSGA1:
0010B5 50B5 F5              11      PUSH    AF
0010B6 50B6 C5              11      PUSH    BC
0010B7 50B7 D5              11      PUSH    DE
0010B8 50B8 E5              11      PUSH    HL
0010B9 50B9 DDE5            15      PUSH    IX
0010BB 50BB DD21A200        14      LD  IX,CHPUT
0010BF 50BF CDF642          17      CALL    CALSLT_R
0010C2 50C2 DDE1            14      POP IX
0010C4 50C4 E1              10      POP HL
0010C5 50C5 D1              10      POP DE
0010C6 50C6 C1              10      POP BC
       50C7                     MSGA2:
0010C7 50C7 F1              10      POP AF
0010C8 50C8 C9              10      RET
       50C9                     MSG_BR:
0010C9 50C9 F5              11      PUSH    AF
0010CA 50CA 3ADDF3          13      LD  A,(CSRX)
0010CD 50CD FE02             7      CP  2
0010CF 50CF 38F6            12      JR  C,MSGA2
0010D1 50D1 F1              10      POP AF
       50D2                     MSG_CR:
0010D2 50D2 F5              11      PUSH    AF
0010D3 50D3 3E0D             7      LD  A,00DH
0010D5 50D5 CDB550          17      CALL    MSGA1
0010D8 50D8 3E0A             7      LD  A,00AH
0010DA 50DA CDB550          17      CALL    MSGA1
0010DD 50DD F1              10      POP AF
0010DE 50DE C9              10      RET
                                
       50DF                     _SYS02:     ;(BDOS)コンソール出力
0010DF 50DF CDFA50          17      CALL    BREAK
0010E2 50E2 1805            12      JR  PRINTX
                                
       50E4                     _SYS06:     ;(BDOS)コンソール直接入出力
0010E4 50E4 7B               4      LD  A,E
0010E5 50E5 3C               4      INC A
0010E6 50E6 CA3951          10      JP  Z,_INKEY
       50E9                     PRINTX:
0010E9 50E9 C3AB50          10      JP  _PRINT
                                
       50EC                     _SYS08:     ;(BDOS)エコーなしコンソール入力
0010EC 50EC CD2551          17      CALL    _SYS07
0010EF 50EF FE03             7      CP  3
0010F1 50F1 CCFA50          17      CALL    Z,_BREAK
0010F4 50F4 FE13             7      CP  013H        ;CTRL+S
0010F6 50F6 C0              11      RET NZ
       50F7                     PAUSE:
0010F7 50F7 CD1151          17      CALL    KEYBC
                                
       50FA                     _BREAK:
       50FA                     BREAK:
0010FA 50FA F5              11      PUSH    AF
0010FB 50FB C5              11      PUSH    BC
0010FC 50FC D5              11      PUSH    DE
0010FD 50FD E5              11      PUSH    HL
0010FE 50FE DDE5            15      PUSH    IX
001100 5100 DD21B700        14      LD  IX,BREAKX
001104 5104 CDF642          17      CALL    CALSLT_R
001107 5107 DDE1            14      POP IX
001109 5109 E1              10      POP HL
00110A 510A D1              10      POP DE
00110B 510B C1              10      POP BC
00110C 510C DCFA50          17      CALL    C,_BREAK
00110F 510F F1              10      POP AF
001110 5110 C9              10      RET
       5111                     KEYBC:
001111 5111 F5              11      PUSH    AF
001112 5112 C5              11      PUSH    BC
001113 5113 D5              11      PUSH    DE
001114 5114 E5              11      PUSH    HL
001115 5115 DDE5            15      PUSH    IX
001117 5117 DD215601        14      LD  IX,KILBUF
00111B 511B CDF642          17      CALL    CALSLT_R
00111E 511E DDE1            14      POP IX
001120 5120 E1              10      POP HL
001121 5121 D1              10      POP DE
001122 5122 C1              10      POP BC
001123 5123 F1              10      POP AF
001124 5124 C9              10      RET
                                
       5125                     _SYS07:
       5125                     FLGET:
001125 5125 C5              11      PUSH    BC
001126 5126 D5              11      PUSH    DE
001127 5127 E5              11      PUSH    HL
001128 5128 DDE5            15      PUSH    IX
00112A 512A DD219F00        14      LD  IX,CHGET
00112E 512E CDF642          17      CALL    CALSLT_R
001131 5131 DDE1            14      POP IX
001133 5133 E1              10      POP HL
001134 5134 D1              10      POP DE
001135 5135 C1              10      POP BC
001136 5136 FE03             7      CP  3
001138 5138 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       5139                     _INKEY:
       5139                     INKEY:
001139 5139 CDD351          17      CALL    CPM_CONST
00113C 513C C8              11      RET Z
00113D 513D 18E6            12      JR  FLGET
                                
       513F                     _SYS0A:     ;(BDOS)文字列入力
00113F 513F C5              11      PUSH    BC
001140 5140 E5              11      PUSH    HL
001141 5141 D5              11      PUSH    DE
001142 5142 CD6B51          17      CALL    GETL
001145 5145 111FF4          10      LD  DE,KBUF
001148 5148 E1              10      POP HL
001149 5149 E5              11      PUSH    HL
00114A 514A 0E00             7      LD  C,0
00114C 514C 3004            12      JR  NC,SAX0
00114E 514E 23               6      INC HL
00114F 514F 23               6      INC HL
001150 5150 1808            12      JR  SAX4
       5152                     SAX0:
001152 5152 46               7      LD  B,(HL)
001153 5153 23               6      INC HL
       5154                     SAX1:
001154 5154 23               6      INC HL
001155 5155 1A               7      LD  A,(DE)
001156 5156 13               6      INC DE
001157 5157 B7               4      OR  A
001158 5158 2004            12      JR  NZ,SAX2
       515A                     SAX4:
00115A 515A 360D            10      LD  (HL),00DH
00115C 515C 1804            12      JR  SAX3
       515E                     SAX2:
00115E 515E 77               7      LD  (HL),A
00115F 515F 0C               4      INC C
001160 5160 10F2            13      DJNZ    SAX1
       5162                     SAX3:
001162 5162 D1              10      POP DE
001163 5163 79               4      LD  A,C
001164 5164 13               6      INC DE
001165 5165 12               7      LD  (DE),A
001166 5166 1B               6      DEC DE
001167 5167 E1              10      POP HL
001168 5168 C1              10      POP BC
001169 5169 A7               4      AND A
00116A 516A C9              10      RET
       516B                     GETL:
00116B 516B DDE5            15      PUSH    IX
00116D 516D FDE5            15      PUSH    IY
                                
00116F 516F 2ADCF3          16      LD  HL,(CSRY)
001172 5172 22CAFB          16      LD  (FSTPOS),HL
       5175                     GETL1:
001175 5175 CDEC50          17      CALL    _SYS08
001178 5178 FE09             7      CP  9
00117A 517A 2008            12      JR  NZ,GETL1V
00117C 517C 211FF4          10      LD  HL,KBUF
00117F 517F CD8043          17      CALL    MSX
001182 5182 18F1            12      JR  GETL1
       5184                     GETL1V:
001184 5184 5F               4      LD  E,A
001185 5185 FE08             7      CP  8
001187 5187 CC2152          17      CALL    Z,CTRL02
00118A 518A FE20             7      CP  020H
00118C 518C D44D52          17      CALL    NC,INSERT
00118F 518F CDB550          17      CALL    MSGA1
                                
001192 5192 7B               4      LD  A,E
001193 5193 FE0D             7      CP  00DH
001195 5195 20DE            12      JR  NZ,GETL1
                                
001197 5197 111FF4          10      LD  DE,KBUF
00119A 519A 3AB0F3          13      LD  A,(LINLEN)
00119D 519D 47               4      LD  B,A
00119E 519E CD2F54          17      CALL    ZERO_MEMORY_DE
                                
0011A1 51A1 2ACAFB          16      LD  HL,(FSTPOS)
0011A4 51A4 3ADCF3          13      LD  A,(CSRY)
0011A7 51A7 6F               4      LD  L,A
0011A8 51A8 E5              11      PUSH    HL
0011A9 51A9 CD7E52          17      CALL    LOC0
0011AC 51AC 4D               4      LD  C,L
0011AD 51AD 44               4      LD  B,H
0011AE 51AE E1              10      POP HL
0011AF 51AF 3AB0F3          13      LD  A,(LINLEN)
0011B2 51B2 94               4      SUB H
0011B3 51B3 3D               4      DEC A
0011B4 51B4 5F               4      LD  E,A
0011B5 51B5 211FF4          10      LD  HL,KBUF
       51B8                     GETL2:
0011B8 51B8 CD1152          17      CALL    _SCRN
0011BB 51BB 03               6      INC BC
0011BC 51BC 77               7      LD  (HL),A
0011BD 51BD 23               6      INC HL
0011BE 51BE 1D               4      DEC E
0011BF 51BF 20F7            12      JR  NZ,GETL2
0011C1 51C1 CDD250          17      CALL    MSG_CR
                                
0011C4 51C4 FDE1            14      POP IY
0011C6 51C6 DDE1            14      POP IX
       51C8                     GETL3:
0011C8 51C8 2B               6      DEC HL
0011C9 51C9 7E               7      LD  A,(HL)
0011CA 51CA FE21             7      CP  021H
0011CC 51CC D0              11      RET NC
0011CD 51CD 3600            10      LD  (HL),0
0011CF 51CF 15               4      DEC D
0011D0 51D0 20F6            12      JR  NZ,GETL3
0011D2 51D2 C9              10      RET
                                
       51D3                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       51D3                     CONSTX:
       51D3                     CPM_CONST:
0011D3 51D3 C5              11      PUSH    BC
0011D4 51D4 D5              11      PUSH    DE
0011D5 51D5 E5              11      PUSH    HL
0011D6 51D6 DDE5            15      PUSH    IX
0011D8 51D8 DD219C00        14      LD  IX,CHSNS
0011DC 51DC CDF642          17      CALL    CALSLT_R
0011DF 51DF DDE1            14      POP IX
0011E1 51E1 E1              10      POP HL
0011E2 51E2 D1              10      POP DE
0011E3 51E3 C1              10      POP BC
0011E4 51E4 C9              10      RET
                                
       51E5                     _SYS2A:     ;(BDOS)日付の獲得
0011E5 51E5 AF               4      XOR A
0011E6 51E6 57               4      LD  D,A
0011E7 51E7 5F               4      LD  E,A
0011E8 51E8 67               4      LD  H,A
0011E9 51E9 6F               4      LD  L,A
0011EA 51EA C9              10      RET
                                
       51EB                     _SYS2C:     ;(BDOS)時刻の獲得
0011EB 51EB AF               4      XOR A
0011EC 51EC 57               4      LD  D,A
0011ED 51ED 5F               4      LD  E,A
0011EE 51EE 67               4      LD  H,A
0011EF 51EF 6F               4      LD  L,A
0011F0 51F0 C9              10      RET
                                
       51F1                     POS:
0011F1 51F1 F5              11      PUSH    AF
0011F2 51F2 2ADCF3          16      LD  HL,(CSRY)
0011F5 51F5 7D               4      LD  A,L
0011F6 51F6 6C               4      LD  L,H
0011F7 51F7 67               4      LD  H,A
0011F8 51F8 2C               4      INC L
0011F9 51F9 24               4      INC H
0011FA 51FA F1              10      POP AF
0011FB 51FB C9              10      RET
                                
       51FC                     LOC:
0011FC 51FC F5              11      PUSH    AF
0011FD 51FD E5              11      PUSH    HL
0011FE 51FE 7D               4      LD  A,L
0011FF 51FF 6C               4      LD  L,H
001200 5200 67               4      LD  H,A
001201 5201 2D               4      DEC L
001202 5202 25               4      DEC H
001203 5203 DDE5            15      PUSH    IX
001205 5205 DD21C600        14      LD  IX,POSIT
001209 5209 CDF642          17      CALL    CALSLT_R
00120C 520C DDE1            14      POP IX
00120E 520E E1              10      POP HL
00120F 520F F1              10      POP AF
001210 5210 C9              10      RET
                                
       5211                     _SCRN:
       5211                     SCRN:
001211 5211 E5              11      PUSH    HL
001212 5212 DDE5            15      PUSH    IX
                                
001214 5214 69               4      LD  L,C
001215 5215 60               4      LD  H,B
001216 5216 DD214A00        14      LD  IX,RDVRM
00121A 521A CDF642          17      CALL    CALSLT_R
                                
00121D 521D DDE1            14      POP IX
00121F 521F E1              10      POP HL
001220 5220 C9              10      RET
                                
       5221                     CTRL02:
001221 5221 F5              11      PUSH    AF
001222 5222 D5              11      PUSH    DE
001223 5223 2ADCF3          16      LD  HL,(CSRY)
001226 5226 3AB0F3          13      LD  A,(LINLEN)
001229 5229 4F               4      LD  C,A
00122A 522A 94               4      SUB H   ;CSRX
00122B 522B C602             7      ADD A,2
00122D 522D 47               4      LD  B,A ;カーソルより右の文字数
00122E 522E 61               4      LD  H,C ;LINLEN
00122F 522F C5              11      PUSH    BC
001230 5230 CD7E52          17      CALL    LOC0
001233 5233 C1              10      POP BC
                                
001234 5234 1620             7      LD  D,020H
       5236                     C8X1:
001236 5236 DD214A00        14      LD  IX,RDVRM
00123A 523A CDF642          17      CALL    CALSLT_R
00123D 523D 4F               4      LD  C,A
00123E 523E 7A               4      LD  A,D
00123F 523F DD214D00        14      LD  IX,WRTVRM
001243 5243 CDF642          17      CALL    CALSLT_R
001246 5246 2B               6      DEC HL
001247 5247 51               4      LD  D,C
001248 5248 10EC            13      DJNZ    C8X1
00124A 524A D1              10      POP DE
00124B 524B F1              10      POP AF
00124C 524C C9              10      RET
                                
       524D                     INSERT:
00124D 524D F5              11      PUSH    AF
00124E 524E D5              11      PUSH    DE
00124F 524F 2ADCF3          16      LD  HL,(CSRY)
001252 5252 3AB0F3          13      LD  A,(LINLEN)
001255 5255 4F               4      LD  C,A
001256 5256 94               4      SUB H   ;CSRX
001257 5257 3C               4      INC A
001258 5258 47               4      LD  B,A ;カーソルより右の文字数
001259 5259 C5              11      PUSH    BC
00125A 525A CD7E52          17      CALL    LOC0
00125D 525D C1              10      POP BC
                                
00125E 525E 1620             7      LD  D,020H
       5260                     INS1:
001260 5260 DD214A00        14      LD  IX,RDVRM
001264 5264 CDF642          17      CALL    CALSLT_R
001267 5267 4F               4      LD  C,A
001268 5268 7A               4      LD  A,D
001269 5269 DD214D00        14      LD  IX,WRTVRM
00126D 526D CDF642          17      CALL    CALSLT_R
001270 5270 23               6      INC HL
001271 5271 51               4      LD  D,C
001272 5272 10EC            13      DJNZ    INS1
001274 5274 D1              10      POP DE
001275 5275 F1              10      POP AF
001276 5276 C9              10      RET
                                
       5277                     CONOUT1:
001277 5277 59               4      LD  E,C
001278 5278 C3AB50          10      JP  _PRINT
                                
       527B                     GETVRAM:
00127B 527B 2ADCF3          16      LD  HL,(CSRY)
       527E                     LOC0:
00127E 527E 2D               4      DEC L
00127F 527F 25               4      DEC H
001280 5280 4C               4      LD  C,H ;CSRX-1
001281 5281 5D               4      LD  E,L ;CSRY-1
       5282                     LOC1:
001282 5282 3AB0F3          13      LD  A,(LINLEN)
001285 5285 67               4      LD  H,A
001286 5286 1600             7      LD  D,0
001288 5288 6A               4      LD  L,D ;0
001289 5289 0608             7      LD  B,8
       528B                     LOC2:
00128B 528B 29              11      ADD HL,HL
00128C 528C 3001            12      JR  NC,LOC3
00128E 528E 19              11      ADD HL,DE
       528F                     LOC3:
00128F 528F 10FA            13      DJNZ    LOC2
001291 5291 09              11      ADD HL,BC
001292 5292 C9              10      RET
                                
       5293                     _SYS0C:     ;(BDOS)バージョン番号の獲得
001293 5293 212200          10      LD  HL,00022H
001296 5296 AF               4      XOR A
001297 5297 7D               4      LD  A,L
001298 5298 C9              10      RET
                                
       5299                     _SYS0D:     ;(BDOS)ディスク・リセット
001299 5299 218000          10      LD  HL,00080H
00129C 529C 22C7F2          16      LD  (_DTA),HL
00129F 529F C9              10      RET
                                
       52A0                     _SYS0E:     ;(BDOS)カレントドライブの設定
0012A0 52A0 7B               4      LD  A,E
0012A1 52A1 FE02             7      CP  2
0012A3 52A3 D0              11      RET NC
0012A4 52A4 32DDF2          13      LD  (_DVSW),A
0012A7 52A7 C9              10      RET
                                
       52A8                     _SYS0F:     ;(BDOS)ファイルのオープン
0012A8 52A8 D5              11      PUSH    DE
0012A9 52A9 FDE1            14      POP IY
0012AB 52AB CD1654          17      CALL    INIT_FILE
0012AE 52AE CD1E4B          17      CALL    ROM_OPEN
0012B1 52B1 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
0012B3 52B3 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
0012B7 52B7 FDE5            15      PUSH    IY
0012B9 52B9 D1              10      POP DE
0012BA 52BA 13               6      INC DE
0012BB 52BB 010B00          10      LD  BC,11
0012BE 52BE EDB0                    LDIR
                                ;               Attribute
0012C0 52C0 7E               7      LD  A,(HL)
0012C1 52C1 FD770D          19      LD  (IY+13),A
                                ;               TIME
0012C4 52C4 110B00          10      LD  DE,11
0012C7 52C7 19              11      ADD HL,DE
0012C8 52C8 7E               7      LD  A,(HL)
0012C9 52C9 23               6      INC HL
0012CA 52CA FD7716          19      LD  (IY+22),A
0012CD 52CD 7E               7      LD  A,(HL)
0012CE 52CE 23               6      INC HL
0012CF 52CF FD7717          19      LD  (IY+23),A
                                ;               DATE
0012D2 52D2 7E               7      LD  A,(HL)
0012D3 52D3 23               6      INC HL
0012D4 52D4 FD7714          19      LD  (IY+20),A
0012D7 52D7 7E               7      LD  A,(HL)
0012D8 52D8 23               6      INC HL
0012D9 52D9 FD7715          19      LD  (IY+21),A
                                ;               First cluster
0012DC 52DC 7E               7      LD  A,(HL)
0012DD 52DD 23               6      INC HL
0012DE 52DE FD771A          19      LD  (IY+26),A
0012E1 52E1 7E               7      LD  A,(HL)
0012E2 52E2 23               6      INC HL
0012E3 52E3 FD771B          19      LD  (IY+27),A
                                ;               SIZE
0012E6 52E6 7E               7      LD  A,(HL)
0012E7 52E7 23               6      INC HL
0012E8 52E8 FD7710          19      LD  (IY+16),A
0012EB 52EB 7E               7      LD  A,(HL)
0012EC 52EC 23               6      INC HL
0012ED 52ED FD7711          19      LD  (IY+17),A
0012F0 52F0 7E               7      LD  A,(HL)
0012F1 52F1 23               6      INC HL
0012F2 52F2 FD7712          19      LD  (IY+18),A
0012F5 52F5 7E               7      LD  A,(HL)
0012F6 52F6 FD7713          19      LD  (IY+19),A
0012F9 52F9 AF               4      XOR A
0012FA 52FA FD770C          19      LD  (IY+12),A
0012FD 52FD C9              10      RET
                                
       52FE                     _SYS10:     ;(BDOS)ファイルのクローズ
0012FE 52FE AF               4      XOR A
0012FF 52FF C9              10      RET
                                
       5300                     S11X1:
001300 5300 FD7119          19      LD  (IY+25),C       ;RootEntCnt
001303 5303 FD750E          19      LD  (IY+14),L
001306 5306 FD740F          19      LD  (IY+15),H
       5309                     SCF_FF_RET:
001309 5309 37               4      SCF
00130A 530A 9F               4      SBC A,A
00130B 530B C9              10      RET
                                
       530C                     _SYS11:     ;(BDOS)最初のファイルの検索
00130C 530C ED53CAF2        20      LD  (_FCB),DE
001310 5310 D5              11      PUSH    DE
001311 5311 FDE1            14      POP IY
001313 5313 CD1654          17      CALL    INIT_FILE
001316 5316 CD8B4D          17      CALL    GET_DIR_DAT
       5319                     S12X1:
001319 5319 CD3A4B          17      CALL    FILESE
00131C 531C 30E2            12      JR  NC,S11X1
00131E 531E 0D               4      DEC C
00131F 531F FD7119          19      LD  (IY+25),C       ;RootEntCnt
001322 5322 FDCB0D66        20      BIT 4,(IY+13)
001326 5326 2809            12      JR  Z,S12X2
001328 5328 E5              11      PUSH    HL
001329 5329 DDE1            14      POP IX
00132B 532B DDCB0E66        20      BIT 4,(IX+1+13)
00132F 532F 28E8            12      JR  Z,S12X1
       5331                     S12X2:
001331 5331 012000          10      LD  BC,32
001334 5334 ED5BC7F2        20      LD  DE,(_DTA)
001338 5338 AF               4      XOR A
001339 5339 12               7      LD  (DE),A      ;ドライブ番号
00133A 533A 13               6      INC DE
00133B 533B EDB0                    LDIR            ;ディレクトリエントリ
00133D 533D FD750E          19      LD  (IY+14),L
001340 5340 FD740F          19      LD  (IY+15),H
001343 5343 C9              10      RET
                                
       5344                     _SYS12:
001344 5344 FD2ACAF2        20      LD  IY,(_FCB)
001348 5348 FDE5            15      PUSH    IY
00134A 534A D1              10      POP DE
00134B 534B CD1654          17      CALL    INIT_FILE
                                
00134E 534E FD6E0E          19      LD  L,(IY+14)
001351 5351 FD660F          19      LD  H,(IY+15)
001354 5354 FD4E19          19      LD  C,(IY+25)
001357 5357 18C0            12      JR  S12X1
                                
       5359                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
001359 5359 CD714D          17      CALL    SET_FCB
00135C 535C CD3F4D          17      CALL    GETSEQ
00135F 535F CD2C4D          17      CALL    RB_READ
001362 5362 E5              11      PUSH    HL
001363 5363 CD4C4D          17      CALL    SETSEQ
001366 5366 E1              10      POP HL
       5367                     SREAD:
001367 5367 C601             7      ADD A,001H
001369 5369 D8              11      RET C
                                
00136A 536A 7D               4      LD  A,L
00136B 536B D601             7      SUB 001H
00136D 536D 9F               4      SBC A,A
00136E 536E E603             7      AND 3
001370 5370 1F               4      RRA
001371 5371 C9              10      RET
                                
       5372                     _SYS18:     ;(BDOS)ログインベクトルの獲得
001372 5372 210100          10      LD  HL,00001H
001375 5375 AF               4      XOR A
001376 5376 C9              10      RET
                                
       5377                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
001377 5377 3ADDF2          13      LD  A,(_DVSW)
00137A 537A C9              10      RET
                                
       537B                     _SYS1A:     ;(BDOS)DTAの設定
00137B 537B ED53C7F2        20      LD  (_DTA),DE
00137F 537F AF               4      XOR A
001380 5380 C9              10      RET
                                
       5381                     _SYS1B:     ;(BDOS)ディスク情報の獲得
001381 5381 010002          10      LD  BC,512
001384 5384 11C302          10      LD  DE,707
001387 5387 210000          10      LD  HL,0
00138A 538A DD21CCF2        14      LD  IX,_BUF
00138E 538E FD21CCF2        14      LD  IY,_BUF
001392 5392 FD3600F9        19      LD  (IY+0),0F9H
001396 5396 3E02             7      LD  A,2
001398 5398 C9              10      RET
                                
       5399                     _SYS21:     ;(BDOS)ランダムな読み出し
001399 5399 CD714D          17      CALL    SET_FCB
                                
00139C 539C FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
00139F 539F FD6622          19      LD  H,(IY+34)
                                
0013A2 53A2 CD2C4D          17      CALL    RB_READ
0013A5 53A5 18C0            12      JR  SREAD
                                
       53A7                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
0013A7 53A7 CDA852          17      CALL    _SYS0F
0013AA 53AA D8              11      RET C
                                
0013AB 53AB D5              11      PUSH    DE      ;EX DE,IY
0013AC 53AC FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0013AE 53AE CD614D          17      CALL    GETSIZE
       53B1                     _S24X1:
0013B1 53B1 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
0013B4 53B4 FD7422          19      LD  (IY+34),H
0013B7 53B7 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
0013BB 53BB FDE3            23      EX  (SP),IY     ;
0013BD 53BD D1              10      POP DE      ;
                                
0013BE 53BE AF               4      XOR A
0013BF 53BF C9              10      RET
                                
       53C0                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
0013C0 53C0 E5              11      PUSH    HL
0013C1 53C1 D5              11      PUSH    DE      ;EX DE,IY
0013C2 53C2 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0013C4 53C4 CD3F4D          17      CALL    GETSEQ
0013C7 53C7 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       53C9                     _SYS27:     ;(BDOS)ランダムブロック読み込み
0013C9 53C9 CD714D          17      CALL    SET_FCB
0013CC 53CC E5              11      PUSH    HL
0013CD 53CD FD6E21          19      LD  L,(IY+33)
0013D0 53D0 FD6622          19      LD  H,(IY+34)
0013D3 53D3 22BDF2          16      LD  (RR_LOW),HL
0013D6 53D6 FD6E23          19      LD  L,(IY+35)
0013D9 53D9 FD6624          19      LD  H,(IY+36)
0013DC 53DC 22BFF2          16      LD  (RR_HIGH),HL
0013DF 53DF E1              10      POP HL
0013E0 53E0 CDFE48          17      CALL    ROM_READ
0013E3 53E3 ED5BBDF2        20      LD  DE,(RR_LOW)
0013E7 53E7 FD7321          19      LD  (IY+33),E
0013EA 53EA FD7222          19      LD  (IY+34),D
0013ED 53ED ED5BBFF2        20      LD  DE,(RR_HIGH)
0013F1 53F1 FD7323          19      LD  (IY+35),E
0013F4 53F4 FD7224          19      LD  (IY+36),D
0013F7 53F7 9F               4      SBC A,A
0013F8 53F8 C9              10      RET
                                
       53F9                     _SYS2F:
0013F9 53F9 44               4      LD  B,H
0013FA 53FA 2AC7F2          16      LD  HL,(_DTA)
0013FD 53FD C3794E          10      JP  DISKIO
                                
       5400                     _SYS5A:
001400 5400 0600             7      LD  B,0
001402 5402 D5              11      PUSH    DE
001403 5403 DDE1            14      POP IX
       5405                     _SX5A1:
001405 5405 1A               7      LD  A,(DE)
001406 5406 B7               4      OR  A
001407 5407 2804            12      JR  Z,_SX5A2
001409 5409 13               6      INC DE
00140A 540A 04               4      INC B
00140B 540B 18F8            12      JR  _SX5A1
                                
       540D                     _SX5A2:
00140D 540D 78               4      LD  A,B
00140E 540E CDC949          17      CALL    FILE_BDOS
001411 5411 CD144E          17      CALL    ROM_CD
001414 5414 9F               4      SBC A,A
001415 5415 C9              10      RET
                                
       5416                     INIT_FILE:
001416 5416 EB               4      EX  DE,HL
001417 5417 11EBF2          10      LD  DE,FDRV
00141A 541A 010C00          10      LD  BC,1+8+3
00141D 541D EDB0                    LDIR
00141F 541F CD4450          17      CALL    GET_DISK_BANK_FDRV
001422 5422 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
001425 5425 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
001428 5428 2ADEF2          16      LD  HL,(_CD)
00142B 542B 22E9F2          16      LD  (_CDX),HL           ;カレントディレクトリ
00142E 542E C9              10      RET
                                
       542F                     ZERO_MEMORY_DE:
00142F 542F AF               4      XOR A
       5430                     FILL_MEMORY_DE:
001430 5430 12               7      LD  (DE),A
001431 5431 13               6      INC DE
001432 5432 10FC            13      DJNZ    FILL_MEMORY_DE
001434 5434 C9              10      RET
                                
001435 5435                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 9850AE50DF509850        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 98509850E4502551        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 EC5098503F51D351        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 93529952A052A852        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 FE520C5344539850        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 5953985098509850        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 725377537B538153        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 985098509850A753        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 C05398509850C953        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 98509850E5519850        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 EB5198509850F953        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 9850985000549850        DW  _ERROR,_ERROR,_SYS5A,_ERROR
001FB8 5FB8 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 9850985098509850        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
