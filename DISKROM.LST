                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FDDB                     H_PINL  EQU 0FDDBH
                                
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                            ;ASCII-16K
                                ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
                                ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
       F280                     ISC EQU 0F280H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F280                     SP32    EQU 0F280H
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM    ; Main program execution address.
000004 4004 564E                    DW  STATEMENT   ; STATEMENT
000006 4006 6F4F                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C3FA4F          10      JP  DISKIO
000013 4013 C33550          10      JP  DSKCHG
000016 4016 C38B50          10      JP  GETDPB
000019 4019 C37E51          10      JP  CHOICE
00001C 401C C38251          10      JP  DSKFMT
00001F 401F C38451          10      JP  DSKSTP
000022 4022 C38551          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C38251          10      JP  DSKFMT
000029 4029 C38451          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3BE51          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.4.2.0",0
            204449534B20524F    
            4D204C6974652076    
            302E342E322E3000    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 AF               4      XOR A
000107 4107 2100F3          10      LD  HL,0F300H
00010A 410A 0668             7      LD  B,068H
00010C 410C CD0A4B          17      CALL    FILL_MEMORY
                                
00010F 410F 3E01             7      LD  A,1
000111 4111 3221FB          13      LD  (DRVTBL),A
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  HL,(STKTOP) ;起動時の空き容量表示の為
                                    LD  BC,-00140H
                                    ADD HL,BC
                                    LD  (STKTOP),HL
                                #else
000114 4114 2175F6          10      LD  HL,STKTOP+1 ;起動時の空き容量表示の為
000117 4117 35              11      DEC (HL)
                                #endif
                                
000118 4118 AF               4      XOR A
000119 4119 32DDF2          13      LD  (_DVSW),A
00011C 411C 3D               4      DEC A       ;0FFH
00011D 411D 3299FD          13      LD  (DEVICE),A
                                
000120 4120 21E042          10      LD  HL,AT_ISC
000123 4123 1180F2          10      LD  DE,ISC
000126 4126 017B00          10      LD  BC,ISC_E-ISC
000129 4129 EDB0                    LDIR
                                    
00012B 412B 3EC3             7      LD  A,0C3H      ;JP
00012D 412D 3243FF          13      LD  (H_GONE),A
000130 4130 327DF3          13      LD  (BDOS),A
000133 4133 326BF3          13      LD  (RAMUSE),A
000136 4136 3268F3          13      LD  (ROMUSE),A
000139 4139 2180F2          10      LD  HL,REPLACE_COMMAND
00013C 413C 2244FF          16      LD  (H_GONE+1),HL
00013F 413F 2131F3          10      LD  HL,H_BDOS
000142 4142 227EF3          16      LD  (BDOS+1),HL
000145 4145 21B0F2          10      LD  HL,RAMUSE1
000148 4148 226CF3          16      LD  (RAMUSE+1),HL
00014B 414B 21ABF2          10      LD  HL,ROMUSE1
00014E 414E 2269F3          16      LD  (ROMUSE+1),HL
                                
000151 4151 3E                      DB  03EH
000152 4152 F7              12      RST 30H
000153 4153 3271FE          13      LD  (H_BINS),A
000156 4156 3276FE          13      LD  (H_BINL),A
000159 4159 327BFE          13      LD  (H_FILE),A
00015C 415C 3231F3          13      LD  (H_BDOS),A
00015F 415F 32DBFD          13      LD  (H_PINL),A
000162 4162 32A7FF          13      LD  (H_PHYD),A
                                
000165 4165 CD2C42          17      CALL    GTSL1_
000168 4168 3297F2          13      LD  (ROM_SLT),A
00016B 416B 32A7F2          13      LD  (ROM_SLT_COPY),A
00016E 416E 3272FE          13      LD  (H_BINS+1),A
000171 4171 3277FE          13      LD  (H_BINL+1),A
000174 4174 327CFE          13      LD  (H_FILE+1),A
000177 4177 3232F3          13      LD  (H_BDOS+1),A
00017A 417A 32DCFD          13      LD  (H_PINL+1),A
00017D 417D 32A8FF          13      LD  (H_PHYD+1),A
000180 4180 3222FB          13      LD  (DRVTBL+1),A
000183 4183 3248F3          13      LD  (MASTERS),A
                                
000186 4186 210D45          10      LD  HL,ROM_LOAD
000189 4189 2273FE          16      LD  (H_BINS+2),HL
00018C 418C 21BE46          10      LD  HL,ROM_RUN
00018F 418F 2278FE          16      LD  (H_BINL+2),HL
000192 4192 21CC46          10      LD  HL,ROM_FILES
000195 4195 227DFE          16      LD  (H_FILE+2),HL
000198 4198 212652          10      LD  HL,ROM_BDOS
00019B 419B 2233F3          16      LD  (H_BDOS+2),HL
00019E 419E 219643          10      LD  HL,ROM_BOOT
0001A1 41A1 22DDFD          16      LD  (H_PINL+2),HL
0001A4 41A4 21FA4F          10      LD  HL,DISKIO
0001A7 41A7 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001AA 41AA 3E                      DB  03EH
0001AB 41AB C9              10      RET
0001AC 41AC 327FFE          13      LD  (H_FILE+4),A
0001AF 41AF 3275FE          13      LD  (H_BINS+4),A
0001B2 41B2 327AFE          13      LD  (H_BINL+4),A
0001B5 41B5 3235F3          13      LD  (H_BDOS+4),A
0001B8 41B8 32DFFD          13      LD  (H_PINL+4),A
0001BB 41BB 32ABFF          13      LD  (H_PHYD+4),A
                                
0001BE 41BE AF               4      XOR A
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0001BF 41BF 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001C2 41C2 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001C5 41C5 3A0060          13      LD  A,(BANK1_ADR)
0001C8 41C8 FE41             7      CP  'A'
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JR  Z,NOT_BANK_TYPE
                                    LD  A,DISK_BANK
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0001CA 41CA 204F            12      JR  NZ,NOT_BANK_TYPE
0001CC 41CC 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001CF 41CF 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001D2 41D2 CD3801          17      CALL    RSLREG      ;read primary slot #
0001D5 41D5 07               4      RLCA
0001D6 41D6 07               4      RLCA
0001D7 41D7 F5              11      PUSH    AF
0001D8 41D8 1605             7      LD  D,4+1
0001DA 41DA CD3342          17      CALL    GTSL2_
0001DD 41DD 3244F3          13      LD  (RAMAD3),A
0001E0 41E0 F1              10      POP AF
0001E1 41E1 07               4      RLCA
0001E2 41E2 07               4      RLCA
0001E3 41E3 1603             7      LD  D,2+1
0001E5 41E5 CD3342          17      CALL    GTSL2_
0001E8 41E8 2680             7      LD  H,080H
0001EA 41EA CD5042          17      CALL    CHK_RAM
0001ED 41ED 3243F3          13      LD  (RAMAD2),A
       41F0                     RAMCHK2:
0001F0 41F0 3A44F3          13      LD  A,(RAMAD3)
0001F3 41F3 2640             7      LD  H,040H
0001F5 41F5 CD5042          17      CALL    CHK_RAM
0001F8 41F8 3242F3          13      LD  (RAMAD1),A
       41FB                     RAMCHK1:
0001FB 41FB 3A44F3          13      LD  A,(RAMAD3)
0001FE 41FE 2600             7      LD  H,00H
000200 4200 CD5042          17      CALL    CHK_RAM
000203 4203 3241F3          13      LD  (RAMAD0),A
       4206                     RAMCHK0:
000206 4206 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
000209 4209 010F00          10      LD  BC,0000FH       ;切り上げ
00020C 420C 09              11      ADD HL,BC
00020D 420D 7D               4      LD  A,L
                                
00020E 420E 0604             7      LD  B,4
       4210                     B_DRIVE1:
000210 4210 CB3C             8      SRL H
000212 4212 1F               4      RRA
000213 4213 10FB            13      DJNZ    B_DRIVE1
                                
000215 4215 C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000217 4217 32DCF2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
00021A 421A C9              10      RET
                                
       421B                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
00021B 421B 21D943          10      LD  HL,MSG_ERROR_ROM_MODE
00021E 421E CD5E43          17      CALL    MSX
000221 4221 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000225 4225 DD219F00        14      LD  IX,CHGET
000229 4229 C31C00          10      JP  _CALSLT
                                
       422C                     GTSL1_:             ;自分のいるスロットを知る
00022C 422C CD3801          17      CALL    RSLREG      ;read primary slot #
00022F 422F 0F               4      RRCA
000230 4230 0F               4      RRCA
000231 4231 1601             7      LD  D,1
       4233                     GTSL2_:
000233 4233 E603             7      AND 3       ;[A]=000000PP
000235 4235 5F               4      LD  E,A     ;[E]=000000PP
000236 4236 21C1FC          10      LD  HL,EXPTBL
000239 4239 85               4      ADD A,L     ;桁上りは無い
00023A 423A 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
00023B 423B 7B               4      LD  A,E     ;[A]=000000PP
00023C 423C CB7E            13      BIT 7,(HL)
00023E 423E C8              11      RET Z
00023F 423F 7D               4      LD  A,L     ;point to SLTTBL entry
000240 4240 C604             7      ADD A,4     ;桁上りは無い
000242 4242 6F               4      LD  L,A
000243 4243 7E               7      LD  A,(HL)      ;get currently expansion slot register
       4244                     GTSL3_:
000244 4244 15               4      DEC D
000245 4245 2803            12      JR  Z,GTSL4_:
000247 4247 0F               4      RRCA
000248 4248 18FA            12      JR  GTSL3_:
       424A                     GTSL4_:
00024A 424A E60C             7      AND 00CH        ;[A] = 0000SS00
00024C 424C B3               4      OR  E       ;[A] = 0000SSPP
00024D 424D F680             7      OR  080H        ;[A] = 1000SSPP
00024F 424F C9              10      RET
                                
       4250                     CHK_RAM:
000250 4250 E5              11      PUSH    HL
000251 4251 CDA542          17      CALL    CHK_RAM0
000254 4254 E1              10      POP HL
000255 4255 C8              11      RET Z
000256 4256 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000259 4259 E680             7      AND 080H
00025B 425B CD7C42          17      CALL    CHK_RAM_SLT
00025E 425E C8              11      RET Z
00025F 425F 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000262 4262 E680             7      AND 080H
000264 4264 C601             7      ADD A,1
000266 4266 CD7C42          17      CALL    CHK_RAM_SLT
000269 4269 C8              11      RET Z
00026A 426A 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00026D 426D E680             7      AND 080H
00026F 426F C602             7      ADD A,2
000271 4271 CD7C42          17      CALL    CHK_RAM_SLT
000274 4274 C8              11      RET Z
000275 4275 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000278 4278 E680             7      AND 080H
00027A 427A C603             7      ADD A,3
       427C                     CHK_RAM_SLT:
00027C 427C E5              11      PUSH    HL
00027D 427D CDA542          17      CALL    CHK_RAM0        ;スロット#X or X-0
000280 4280 E1              10      POP HL
000281 4281 C8              11      RET Z
000282 4282 CB79             8      BIT 7,C
000284 4284 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000286 4286 79               4      LD  A,C
000287 4287 C604             7      ADD A,4*1           ;スロット#X-1
000289 4289 E5              11      PUSH    HL
00028A 428A CDA542          17      CALL    CHK_RAM0
00028D 428D E1              10      POP HL
00028E 428E C8              11      RET Z
00028F 428F 79               4      LD  A,C
000290 4290 C608             7      ADD A,4*2           ;スロット#X-2
000292 4292 E5              11      PUSH    HL
000293 4293 CDA542          17      CALL    CHK_RAM0
000296 4296 E1              10      POP HL
000297 4297 C8              11      RET Z
000298 4298 79               4      LD  A,C
000299 4299 C60C             7      ADD A,4*3           ;スロット#X-3
00029B 429B E5              11      PUSH    HL
00029C 429C CDA542          17      CALL    CHK_RAM0
00029F 429F E1              10      POP HL
       42A0                     CHK_RAM_E:
0002A0 42A0 AF               4      XOR A
0002A1 42A1 3C               4      INC A           ;ZF=0にする
0002A2 42A2 3E00             7      LD  A,0
0002A4 42A4 C9              10      RET
                                
       42A5                     CHK_RAM0:
0002A5 42A5 4F               4      LD  C,A
0002A6 42A6 3A97F2          13      LD  A,(ROM_SLT)
0002A9 42A9 B9               4      CP  C
0002AA 42AA 28F4            12      JR  Z,CHK_RAM_E
0002AC 42AC 2E00             7      LD  L,0
       42AE                     CHK_RAM1:
0002AE 42AE 79               4      LD  A,C
0002AF 42AF CD8E43          17      CALL    RDSLTX
0002B2 42B2 C6E5             7      ADD A,0E5H
0002B4 42B4 47               4      LD  B,A
0002B5 42B5 5F               4      LD  E,A
0002B6 42B6 79               4      LD  A,C
0002B7 42B7 C5              11      PUSH    BC
0002B8 42B8 CD1400          17      CALL    _WRSLT
0002BB 42BB C1              10      POP BC
0002BC 42BC 79               4      LD  A,C
0002BD 42BD CD8E43          17      CALL    RDSLTX
0002C0 42C0 B8               4      CP  B
0002C1 42C1 C0              11      RET NZ
0002C2 42C2 D6E5             7      SUB 0E5H
0002C4 42C4 79               4      LD  A,C
0002C5 42C5 5F               4      LD  E,A
0002C6 42C6 C5              11      PUSH    BC
0002C7 42C7 CD1400          17      CALL    _WRSLT
0002CA 42CA C1              10      POP BC
0002CB 42CB 24               4      INC H
0002CC 42CC 7D               4      LD  A,L
0002CD 42CD C604             7      ADD A,4
0002CF 42CF 6F               4      LD  L,A
0002D0 42D0 20DC            12      JR  NZ,CHK_RAM1
0002D2 42D2 79               4      LD  A,C     ;ZF=1のハズ
0002D3 42D3 C9              10      RET
                                
       42D4                     CALSLT_R:
0002D4 42D4 C5              11      PUSH    BC
0002D5 42D5 E5              11      PUSH    HL
0002D6 42D6 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0002DA 42DA CD1C00          17      CALL    _CALSLT
0002DD 42DD E1              10      POP HL
0002DE 42DE C1              10      POP BC
0002DF 42DF C9              10      RET
                                
       42E0                     AT_ISC:
0002E0 F280                         ORG ISC,AT_ISC-RUN
       F280                     REPLACE_COMMAND:
0002E0 F280 FEB7             7      CP  0B7H            ;FILES
0002E2 F282 CC7BFE          17      CALL    Z,H_FILE
0002E5 F285 FEB5             7      CP  0B5H            ;LOAD
0002E7 F287 CA71FE          10      JP  Z,H_BINS
0002EA F28A FE8A             7      CP  08AH            ;RUN
0002EC F28C CA76FE          10      JP  Z,H_BINL
0002EF F28F FED6             7      CP  0D6H            ;COPY
0002F1 F291 2813            12      JR  Z,FIX_COPY
0002F3 F293 FECF             7      CP  0CFH            ;BLOAD
0002F5 F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
0002F6 F296 F7              12      RST 30H
       F297                     ROM_SLT:
0002F7 F297 00                      DB  0
0002F8 F298 EF45                    DW  ROM_BLOAD
0002FA F29A F5              11      PUSH    AF
0002FB F29B E5              11      PUSH    HL
0002FC F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
0002FF F29F E1              10      POP HL
000300 F2A0 F1              10      POP AF
000301 F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
000303 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
000305 F2A5 C9              10      RET
       F2A6                     FIX_COPY:
000306 F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
000307 F2A7 00                      DB  0
000308 F2A8 6A47                    DW  ROM_COPY
00030A F2AA C9              10      RET
       F2AB                     ROMUSE1:
00030B F2AB 3A97F2          13      LD  A,(ROM_SLT)
00030E F2AE 1803            12      JR  ROMUSE2
       F2B0                     RAMUSE1:
000310 F2B0 3A42F3          13      LD  A,(RAMAD1)
       F2B3                     ROMUSE2:
000313 F2B3 C32400          10      JP  _ENASLT
                                
       F2B6                     _RESULT:
000316 F2B6 00                      DB  0
       F2B7                     _BANK:
000317 F2B7 00                      DB  0
       F2B8                     _BANK1:
000318 F2B8 00                      DB  0
       F2B9                     CLSZ:               ;クラスタサイズ
000319 F2B9 0004                    DW  1024
       F2BA                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2BB                     SECSZ:              ;セクタサイズ
00031B F2BB 0002                    DW  512
       F2BC                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2BD                     RR_LOW:
00031D F2BD 0000                    DW  0
       F2BE                     RR_MID  EQU $-1
       F2BF                     RR_HIGH:
00031F F2BF 0000                    DW  0
       F2C1                     _CLPS:
000321 F2C1 0000                    DW  0
       F2C3                     _LEFT:
000323 F2C3 0000                    DW  0
       F2C5                     _DTPS:
000325 F2C5 0000                    DW  0
       F2C7                     _DTA:
000327 F2C7 0000                    DW  0
       F2C9                     FLG_LDIR:
000329 F2C9 00                      DB  0
       F2CA                     _FCB:
00032A F2CA 0000                    DW  0
       F2CC                     _BUF:
       F2CC                     _BUF_LO:        ;LOGICAL OPERATION
00032C F2CC 00                      DB  0
       F2CD                     _BUF_ST:
00032D F2CD 0000                    DW  0
       F2CF                     _BUF_EN:
00032F F2CF 0000                    DW  0
       F2D1                     _BUF_EX:
       F2D1                     _BUF_W:
000331 F2D1 0000                    DW  0
       F2D3                     _BUF_H:
000333 F2D3 0000                    DW  0
       F2D5                     _BUF_X:
000335 F2D5 0000                    DW  0
       F2D7                     _BUF_Y:
000337 F2D7 00                      DB  0
       F2D8                     _BUF_P:
000338 F2D8 00                      DB  0
       F2D9                     _BUF_O:
000339 F2D9 00                      DB  0
       F2DA                     DTAX:
00033A F2DA 0000                    DW  0
       F2DC                     B_DRIVE:
00033C F2DC 00                      DB  0
       F2DD                     _DVSW:          ;カレントドライブ
00033D F2DD 00                      DB  0
       F2DE                     _CD:            ;カレントディレクトリ
00033E F2DE 0000                    DW  0
       F2E0                     DIRENT1:
000340 F2E0 0000                    DW  0
       F2E2                     _DIR_BANK:
000342 F2E2 00                      DB  0
       F2E3                     LEFTX:
000343 F2E3 0000                    DW  0
       F2E5                     PARAM0:
000345 F2E5 0000                    DW  0
       F2E7                     PARAM1:
000347 F2E7 0000                    DW  0
       F2E9                     _CDX:
000349 F2E9 0000                    DW  0
       F2EB                     FDRV:
00034B F2EB 00                      DB  0
       F2EC                     FNAME:
00034C F2EC                         DS  8+3
       F2F7                     _HL:
000357 F2F7 0000                    DW  0
       F2F9                     _SP:
000359 F2F9 0000                    DW  0
       F2FA                     _SP_H   EQU $-1
       F2FB                     ISC_E:
00035B 435B                         ORG $$+RUN          ;$DEPHASE
                                
       435B                     MSX1:
00035B 435B CD3F52          17      CALL    MSGA1
       435E                     MSX:
00035E 435E 7E               7      LD  A,(HL)
00035F 435F 23               6      INC HL
000360 4360 B7               4      OR  A
000361 4361 20F8            12      JR  NZ,MSX1
000363 4363 C9              10      RET
                                
       4364                     PRTHX:
000364 4364 F5              11      PUSH    AF
000365 4365 07               4      RLCA
000366 4366 07               4      RLCA
000367 4367 07               4      RLCA
000368 4368 07               4      RLCA
000369 4369 CD6D43          17      CALL    PRTA2
00036C 436C F1              10      POP AF
       436D                     PRTA2:
00036D 436D CD7343          17      CALL    ASC
000370 4370 C33B52          10      JP  MSG_A
                                    
       4373                     ASC:
000373 4373 E60F             7      AND $0F
000375 4375 F630             7      OR  $30
000377 4377 FE3A             7      CP  $3A
000379 4379 D8              11      RET C
00037A 437A C607             7      ADD A,7
00037C 437C C9              10      RET
                                
       437D                     MSN:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
00037D 437D 7E               7      LD  A,(HL)
                                #endif
00037E 437E 23               6      INC HL
00037F 437F CD3B52          17      CALL    MSG_A
000382 4382 10F9            13      DJNZ    MSN
000384 4384 C9              10      RET
                                
       4385                     RDSLT_ROM3:
000385 4385 7E               7      LD  A,(HL)
000386 4386 C9              10      RET
       4387                     RDSLT_ROM:
000387 4387 CB7C             8      BIT 7,H
000389 4389 28FA            12      JR  Z,RDSLT_ROM3
       438B                     RDSLT_ROM2:
00038B 438B 3A97F2          13      LD  A,(ROM_SLT)
       438E                     RDSLTX:
00038E 438E C5              11      PUSH    BC
00038F 438F D5              11      PUSH    DE
000390 4390 CD0C00          17      CALL    _RDSLT
000393 4393 D1              10      POP DE
000394 4394 C1              10      POP BC
000395 4395 C9              10      RET
                                
       4396                     ROM_BOOT:
000396 4396 3E                      DB  03EH
000397 4397 C9              10      RET
000398 4398 32DBFD          13      LD  (H_PINL),A
00039B 439B 3ACAFF          13      LD  A,(EXTBIO)
00039E 439E FEF7             7      CP  0F7H        ;RST 30H
0003A0 43A0 280A            12      JR  Z,EXTBIO_OK
0003A2 43A2 3E                      DB  03EH
0003A3 43A3 C9              10      RET
0003A4 43A4 21CAFF          10      LD  HL,EXTBIO
0003A7 43A7 061D             7      LD  B,29
0003A9 43A9 CD0A4B          17      CALL    FILL_MEMORY
       43AC                     EXTBIO_OK:
0003AC 43AC 21FF43          10      LD  HL,DELOK
0003AF 43AF CD5E43          17      CALL    MSX
                                
0003B2 43B2 AF               4      XOR A
0003B3 43B3 3240F3          13      LD  (REBOOT),A
0003B6 43B6 2A48FC          16      LD  HL,(BOTTOM)
0003B9 43B9 110040          10      LD  DE,16384
0003BC 43BC 19              11      ADD HL,DE
0003BD 43BD 3817            12      JR  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
0003BF 43BF 57               4      LD  D,A
0003C0 43C0 0601             7      LD  B,1
0003C2 43C2 2100C0          10      LD  HL,0C000H
0003C5 43C5 CDFA4F          17      CALL    DISKIO
                                
0003C8 43C8 116BF3          10      LD  DE,RAMUSE
0003CB 43CB AF               4      XOR A
0003CC 43CC CD1EC0          17      CALL    0C01EH
0003CF 43CF 116BF3          10      LD  DE,RAMUSE
0003D2 43D2 37               4      SCF
0003D3 43D3 CD1EC0          17      CALL    0C01EH
       43D6                     BOOT1:
0003D6 43D6 C38551          10      JP  BASENT
                                
       43D9                     MSG_ERROR_ROM_MODE:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DB  "Normal ROM/ASCII-16K only!",13,10
                                #else
0003D9 43D9 41534349492D384B        DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
            2F4B6F6E616D692D    
            384B2F4B6F6E616D    
            692D534343206F6E    
            6C79210D0A          
                                #endif
       43FE                     NULL:
0003FE 43FE 00                      DB  0
       43FF                     DELOK:
0003FF 43FF 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       4403                     ROM_LDIR:
000403 4403 3AC9F2          13      LD  A,(FLG_LDIR)
000406 4406 B7               4      OR  A
000407 4407 2008            12      JR  NZ,ROM_LDIRVM
000409 4409 CB7A             8      BIT 7,D
00040B 440B CA2344          10      JP  Z,ROM_LDIRSLT
                                #if exists USE_MORMAL32K_OR_ASCII16
                                LDIRA:
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ1
                                    LD  SP,SP32
                                SPJ1:
                                LDIR1:
                                    LD  A,B
                                    OR  C
                                    JR  Z,LDIRE
                                
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                LDIR2:
                                    LD  A,D
                                    CP  0C0H
                                    JR  NC,LDIR4
                                
                                    PUSH    BC
                                    PUSH    DE
                                    LD  DE,BUF
                                
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIR3
                                    LD  BC,00100H
                                LDIR3:
                                    PUSH    BC
                                    LDIR
                                    LD  (_HL),HL
                                
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                
                                    POP BC
                                    POP DE
                                    LD  HL,BUF
                                    LDIR
                                
                                    LD  HL,(_HL)
                                    POP BC
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIRE
                                    DEC B
                                    JR  LDIR1
                                LDIR4:
                                #endif
00040E 440E EDB0                    LDIR
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                LDIRE2:
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                LDIRE:
                                    LD  SP,(_SP)
                                #endif
000410 4410 C9              10      RET
                                
       4411                     ROM_LDIRVM:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ2
                                    LD  SP,SP32
                                SPJ2:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
000411 4411 C5              11      PUSH    BC
000412 4412 D5              11      PUSH    DE
000413 4413 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000417 4417 DD215C00        14      LD  IX,LDIRVM
00041B 441B CD1C00          17      CALL    _CALSLT
00041E 441E E1              10      POP HL
00041F 441F C1              10      POP BC
000420 4420 09              11      ADD HL,BC
000421 4421 EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JR  LDIRE2
                                #else
000422 4422 C9              10      RET
                                #endif
                                
       4423                     ROM_LDIRSLT:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ3
                                    LD  SP,SP32
                                SPJ3:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
       4423                     ROM_LDIRSLT1:
000423 4423 EB               4      EX  DE,HL
       4424                     RLDIRSLT1:
000424 4424 CB7C             8      BIT 7,H
000426 4426 201F            12      JR  NZ,RLDIRSLT_EXIT
000428 4428 1A               7      LD  A,(DE)
000429 4429 13               6      INC DE
00042A 442A C5              11      PUSH    BC
00042B 442B D5              11      PUSH    DE
00042C 442C E5              11      PUSH    HL
00042D 442D 5F               4      LD  E,A
                                
00042E 442E 0141F3          10      LD  BC,RAMAD0
000431 4431 7C               4      LD  A,H
000432 4432 07               4      RLCA
000433 4433 07               4      RLCA
000434 4434 E603             7      AND 3
000436 4436 81               4      ADD A,C
000437 4437 4F               4      LD  C,A
000438 4438 0A               7      LD  A,(BC)
       4439                     RLDIRSLT2:
000439 4439 CD1400          17      CALL    _WRSLT
00043C 443C 08               4      EX  AF,AF'
00043D 443D E1              10      POP HL
00043E 443E D1              10      POP DE
00043F 443F C1              10      POP BC
000440 4440 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
000442 4442 EA2444          10      JP  PE,RLDIRSLT1
000445 4445 EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JP  LDIRE2
                                RLDIRSLT_EXIT:
                                    EX  DE,HL
                                    JP  LDIR1
                                #else
000446 4446 C9              10      RET
       4447                     RLDIRSLT_EXIT:
000447 4447 EB               4      EX  DE,HL
000448 4448 EDB0                    LDIR
00044A 444A C9              10      RET
                                #endif
                                
       444B                     END_OF_LINE:
00044B 444B 215EF5          10      LD  HL,BUF
       444E                     EOL1:
00044E 444E 7E               7      LD  A,(HL)
00044F 444F C8              11      RET Z
000450 4450 FE0D             7      CP  00DH
000452 4452 2807            12      JR  Z,EOLE
000454 4454 FE0A             7      CP  00AH
000456 4456 2803            12      JR  Z,EOLE
000458 4458 23               6      INC HL
000459 4459 18F3            12      JR  EOL1
       445B                     EOLE:
00045B 445B 3600            10      LD  (HL),0
00045D 445D 23               6      INC HL
00045E 445E 7E               7      LD  A,(HL)
00045F 445F FE0A             7      CP  00AH
000461 4461 C0              11      RET NZ
000462 4462 23               6      INC HL
000463 4463 C9              10      RET
                                
       4464                     ROM_LOAD_ASCII:
000464 4464 210000          10      LD  HL,0
000467 4467 22CDF2          16      LD  (_BUF_ST),HL    ;読み出し位置
00046A 446A 2A76F6          16      LD  HL,(TXTTAB)
00046D 446D 22CFF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
000470 4470 215EF5          10      LD  HL,BUF
000473 4473 22C7F2          16      LD  (_DTA),HL
       4476                     RLOAD_A1:
000476 4476 2ACDF2          16      LD  HL,(_BUF_ST)
000479 4479 22BDF2          16      LD  (RR_LOW),HL
00047C 447C 210201          10      LD  HL,258
00047F 447F CD8A49          17      CALL    ROM_READ
000482 4482 7C               4      LD  A,H
000483 4483 B5               4      OR  L
000484 4484 2879            12      JR  Z,RLOAD_AEND
000486 4486 015EF5          10      LD  BC,BUF
000489 4489 09              11      ADD HL,BC
00048A 448A 3600            10      LD  (HL),0
00048C 448C CD4B44          17      CALL    END_OF_LINE
00048F 448F 015EF5          10      LD  BC,BUF
000492 4492 A7               4      AND A
000493 4493 ED42            15      SBC HL,BC
000495 4495 2810            12      JR  Z,RLOAD_A2
000497 4497 4D               4      LD  C,L
000498 4498 44               4      LD  B,H
000499 4499 ED5BCDF2        20      LD  DE,(_BUF_ST)
00049D 449D 19              11      ADD HL,DE
00049E 449E 22CDF2          16      LD  (_BUF_ST),HL
0004A1 44A1 3A5EF5          13      LD  A,(BUF)
0004A4 44A4 B7               4      OR  A
0004A5 44A5 28CF            12      JR  Z,RLOAD_A1
       44A7                     RLOAD_A2:
0004A7 44A7 115EF5          10      LD  DE,BUF
0004AA 44AA CD414B          17      CALL    SPCUTEX
0004AD 44AD 1A               7      LD  A,(DE)
0004AE 44AE B7               4      OR  A
0004AF 44AF 284E            12      JR  Z,RLOAD_AEND
0004B1 44B1 CD534B          17      CALL    GETNUM
0004B4 44B4 7C               4      LD  A,H
0004B5 44B5 B5               4      OR  L
0004B6 44B6 CAD645          10      JP  Z,ERROR_DIRECT_IN_FILE
0004B9 44B9 DD2ACFF2        20      LD  IX,(_BUF_EN)
0004BD 44BD DD7502          19      LD  (IX+2),L
0004C0 44C0 DD7403          19      LD  (IX+3),H
                                
0004C3 44C3 CD3A4B          17      CALL    SPCUT
0004C6 44C6 EB               4      EX  DE,HL
0004C7 44C7 DDE5            15      PUSH    IX
0004C9 44C9 DD21B242        14      LD  IX,CRUNCH
0004CD 44CD FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0004D1 44D1 CD1C00          17      CALL    _CALSLT
0004D4 44D4 DDE1            14      POP IX
0004D6 44D6 EB               4      EX  DE,HL
0004D7 44D7 111FF4          10      LD  DE,KBUF
0004DA 44DA 37               4      SCF
0004DB 44DB ED52            15      SBC HL,DE
0004DD 44DD CAD645          10      JP  Z,ERROR_DIRECT_IN_FILE
0004E0 44E0 DAD645          10      JP  C,ERROR_DIRECT_IN_FILE
0004E3 44E3 4D               4      LD  C,L
0004E4 44E4 44               4      LD  B,H
0004E5 44E5 2ACFF2          16      LD  HL,(_BUF_EN)
0004E8 44E8 110400          10      LD  DE,4
0004EB 44EB 19              11      ADD HL,DE
0004EC 44EC 111FF4          10      LD  DE,KBUF
                                
0004EF 44EF EB               4      EX  DE,HL
0004F0 44F0 EDB0                    LDIR
0004F2 44F2 EB               4      EX  DE,HL
                                
0004F3 44F3 DD7500          19      LD  (IX+0),L
0004F6 44F6 DD7401          19      LD  (IX+1),H
0004F9 44F9 22CFF2          16      LD  (_BUF_EN),HL
0004FC 44FC C37644          10      JP  RLOAD_A1
                                
       44FF                     RLOAD_AEND:
0004FF 44FF 2ACFF2          16      LD  HL,(_BUF_EN)
000502 4502 AF               4      XOR A
000503 4503 77               7      LD  (HL),A
000504 4504 23               6      INC HL
000505 4505 77               7      LD  (HL),A
000506 4506 23               6      INC HL
000507 4507 22CFF2          16      LD  (_BUF_EN),HL
00050A 450A C39945          10      JP  RLOAD_END1
                                
       450D                     ROM_LOAD:
00050D 450D CD3847          17      CALL    INIT_PARAM
000510 4510 7E               7      LD  A,(HL)
000511 4511 FE2C             7      CP  ','
000513 4513 2003            12      JR  NZ,ROM_LOAD0
000515 4515 23               6      INC HL
000516 4516 7E               7      LD  A,(HL)
000517 4517 2B               6      DEC HL
       4518                     ROM_LOAD0:
000518 4518 32BEFC          13      LD  (RUNBNF),A
00051B 451B CD2B4A          17      CALL    FILE_B
00051E 451E 3AECF2          13      LD  A,(FNAME)
000521 4521 FE20             7      CP  020H
000523 4523 CA264A          10      JP  Z,ROM_ORG
                                
000526 4526 CDAA4B          17      CALL    ROM_OPEN
000529 4529 DAE245          10      JP  C,ERROR_FILE_NOT_FOUND
       452C                     ROM_LOAD1:
00052C 452C 21CCF2          10      LD  HL,_BUF
00052F 452F 22C7F2          16      LD  (_DTA),HL
000532 4532 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
000535 4535 CD8A49          17      CALL    ROM_READ
000538 4538 3ACCF2          13      LD  A,(_BUF)
00053B 453B 3C               4      INC A
00053C 453C C26444          10      JP  NZ,ROM_LOAD_ASCII
00053F 453F 2A76F6          16      LD  HL,(TXTTAB)
000542 4542 22C7F2          16      LD  (_DTA),HL
000545 4545 EB               4      EX  DE,HL
000546 4546 2100FF          10      LD  HL,-256
000549 4549 39              11      ADD HL,SP
00054A 454A ED52            15      SBC HL,DE
00054C 454C CD8A49          17      CALL    ROM_READ
00054F 454F ED5BC7F2        20      LD  DE,(_DTA)
000553 4553 19              11      ADD HL,DE
000554 4554 E5              11      PUSH    HL
000555 4555 2A76F6          16      LD  HL,(TXTTAB)
       4558                     ROM_LOAD2:          ;リンクポインタをFIX
000558 4558 E5              11      PUSH    HL
000559 4559 DDE1            14      POP IX
00055B 455B 7E               7      LD  A,(HL)      ;リンクポインタL
00055C 455C 23               6      INC HL
00055D 455D B6               7      OR  (HL)        ;リンクポインタH
00055E 455E 23               6      INC HL
00055F 455F 2837            12      JR  Z,RLOAD_END0
000561 4561 23               6      INC HL      ;行番号
000562 4562 23               6      INC HL      ;行番号
       4563                     ROM_LOAD3:
000563 4563 7E               7      LD  A,(HL)
000564 4564 23               6      INC HL
000565 4565 FE0B             7      CP  00BH        ;8進数(&O)
000567 4567 2822            12      JR  Z,INC_HL2
000569 4569 FE0C             7      CP  00CH        ;16進数(&H)
00056B 456B 281E            12      JR  Z,INC_HL2
00056D 456D FE0D             7      CP  00DH        ;行番号(RUN後)
00056F 456F 281A            12      JR  Z,INC_HL2
000571 4571 FE0E             7      CP  00EH        ;行番号(RUN前)
000573 4573 2816            12      JR  Z,INC_HL2
000575 4575 FE0F             7      CP  00FH        ;10～255の整数(%)
000577 4577 2813            12      JR  Z,INC_HL1
000579 4579 FE1C             7      CP  01CH        ;256～65535の整数(%)
00057B 457B 280E            12      JR  Z,INC_HL2
00057D 457D FE1D             7      CP  01DH        ;単精度実数(!)
00057F 457F 2808            12      JR  Z,INC_HL4
000581 4581 FE1F             7      CP  01FH        ;倍制度実数(#)
000583 4583 2008            12      JR  NZ,INC_HL0
000585 4585 23               6      INC HL
000586 4586 23               6      INC HL
000587 4587 23               6      INC HL
000588 4588 23               6      INC HL
       4589                     INC_HL4:
000589 4589 23               6      INC HL
00058A 458A 23               6      INC HL
       458B                     INC_HL2:
00058B 458B 23               6      INC HL
       458C                     INC_HL1:
00058C 458C 23               6      INC HL
       458D                     INC_HL0:
00058D 458D B7               4      OR  A
00058E 458E 20D3            12      JR  NZ,ROM_LOAD3
000590 4590 DD7500          19      LD  (IX+0),L
000593 4593 DD7401          19      LD  (IX+1),H
000596 4596 18C0            12      JR  ROM_LOAD2
       4598                     RLOAD_END0:
000598 4598 E1              10      POP HL
       4599                     RLOAD_END1:
000599 4599 22C2F6          16      LD  (VARTAB),HL
00059C 459C 22C4F6          16      LD  (ARYTAB),HL
00059F 459F 22C6F6          16      LD  (STREND),HL
                                
0005A2 45A2 3ABEFC          13      LD  A,(RUNBNF)
0005A5 45A5 CD944B          17      CALL    CAP
0005A8 45A8 FE52             7      CP  'R'
0005AA 45AA 280E            12      JR  Z,RLOAD_END2
0005AC 45AC AF               4      XOR A
0005AD 45AD 21CFF2          10      LD  HL,_BUF+3
0005B0 45B0 77               7      LD  (HL),A      ;3
0005B1 45B1 2B               6      DEC HL
0005B2 45B2 77               7      LD  (HL),A      ;2
0005B3 45B3 2B               6      DEC HL
0005B4 45B4 77               7      LD  (HL),A      ;1
0005B5 45B5 2B               6      DEC HL
0005B6 45B6 3E8F             7      LD  A,08FH      ;REM
0005B8 45B8 77               7      LD  (HL),A      ;0
0005B9 45B9 C9              10      RET
       45BA                     RLOAD_END2:
0005BA 45BA D5              11      PUSH    DE
0005BB 45BB ED5B76F6        20      LD  DE,(TXTTAB)
0005BF 45BF 1B               6      DEC DE
0005C0 45C0 AF               4      XOR A
0005C1 45C1 21D2F2          10      LD  HL,_BUF+6
0005C4 45C4 77               7      LD  (HL),A      ;6
0005C5 45C5 2B               6      DEC HL
0005C6 45C6 77               7      LD  (HL),A      ;5
0005C7 45C7 2B               6      DEC HL
0005C8 45C8 77               7      LD  (HL),A      ;4
0005C9 45C9 2B               6      DEC HL
0005CA 45CA 72               7      LD  (HL),D      ;3 行番号H
0005CB 45CB 2B               6      DEC HL
0005CC 45CC 73               7      LD  (HL),E      ;2 行番号L
0005CD 45CD 2B               6      DEC HL
0005CE 45CE 360D            10      LD  (HL),00DH   ;1 行番号(RUN後)
0005D0 45D0 2B               6      DEC HL
0005D1 45D1 3E89             7      LD  A,089H      ;GOTO
0005D3 45D3 77               7      LD  (HL),A      ;0
0005D4 45D4 D1              10      POP DE
0005D5 45D5 C9              10      RET
                                
       45D6                     ERROR_DIRECT_IN_FILE:
0005D6 45D6 1E39             7      LD  E,57            ;Direct statement in file
0005D8 45D8 01                      DB  1           ;LD BC,
       45D9                     ERROR_DEVICE_IO_ERROR:
0005D9 45D9 1E13             7      LD  E,19            ;Device I/O error
0005DB 45DB 01                      DB  1           ;LD BC,
       45DC                     ERROR_INTERNAL_ERROR:
0005DC 45DC 1E33             7      LD  E,51            ;Internal error
0005DE 45DE 01                      DB  1           ;LD BC,
       45DF                     ERROR_FILE_NOT_OPEN:
0005DF 45DF 1E3B             7      LD  E,59            ;File not OPEN
0005E1 45E1 01                      DB  1           ;LD BC,
       45E2                     ERROR_FILE_NOT_FOUND:
0005E2 45E2 1E35             7      LD  E,53            ;File not found
       45E4                     ERROR:
0005E4 45E4 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0005E8 45E8 DD216F40        14      LD  IX,ERRHAND
0005EC 45EC C31C00          10      JP  _CALSLT
                                
       45EF                     ROM_BLOAD:
0005EF 45EF CD3847          17      CALL    INIT_PARAM
0005F2 45F2 CD2B4A          17      CALL    FILE_B
0005F5 45F5 CDAA4B          17      CALL    ROM_OPEN
0005F8 45F8 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
0005FA 45FA 21CCF2          10      LD  HL,_BUF
0005FD 45FD 22C7F2          16      LD  (_DTA),HL
000600 4600 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
000603 4603 CD8A49          17      CALL    ROM_READ
000606 4606 3ACCF2          13      LD  A,(_BUF)
000609 4609 FEFE             7      CP  0FEH
00060B 460B 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
00060D 460D 21A5F2          10      LD  HL,BLOAD_RET
000610 4610 229DF2          16      LD  (SWC_BLOAD),HL
                                
000613 4613 2AE7F2          16      LD  HL,(PARAM1)
000616 4616 7E               7      LD  A,(HL)
000617 4617 FE2C             7      CP  ','
000619 4619 2049            12      JR  NZ,RBREAD_MEM
00061B 461B 23               6      INC HL
00061C 461C 7E               7      LD  A,(HL)
00061D 461D CD944B          17      CALL    CAP
000620 4620 32BEFC          13      LD  (RUNBNF),A
000623 4623 FE52             7      CP  'R'     ;R,Sスイッチじゃ無い場合はオフセット値として処理する
000625 4625 2808            12      JR  Z,RBOS1
000627 4627 FE53             7      CP  'S'
000629 4629 2804            12      JR  Z,RBOS1
00062B 462B FE2C             7      CP  ','
00062D 462D 200D            12      JR  NZ,RBOS2
       462F                     RBOS1:
00062F 462F 7E               7      LD  A,(HL)
000630 4630 23               6      INC HL
000631 4631 B7               4      OR  A
000632 4632 2824            12      JR  Z,RBREAD_OSE
000634 4634 FE3A             7      CP  ':'
000636 4636 2820            12      JR  Z,RBREAD_OSE
000638 4638 FE2C             7      CP  ','     ;次のパラメータを探す
00063A 463A 20F3            12      JR  NZ,RBOS1
       463C                     RBOS2:              ;オフセット
00063C 463C 22E7F2          16      LD  (PARAM1),HL
00063F 463F 7E               7      LD  A,(HL)
000640 4640 B7               4      OR  A
000641 4641 2815            12      JR  Z,RBREAD_OSE
000643 4643 DD212F54        14      LD  IX,FRMQNT
000647 4647 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00064B 464B CD1C00          17      CALL    _CALSLT
00064E 464E 22E7F2          16      LD  (PARAM1),HL
000651 4651 2ACDF2          16      LD  HL,(_BUF_ST)
000654 4654 19              11      ADD HL,DE
000655 4655 22CDF2          16      LD  (_BUF_ST),HL
       4658                     RBREAD_OSE:
000658 4658 3ABEFC          13      LD  A,(RUNBNF)
00065B 465B FE53             7      CP  'S'
00065D 465D 2005            12      JR  NZ,RBREAD_MEM
00065F 465F 3E01             7      LD  A,1
000661 4661 32C9F2          13      LD  (FLG_LDIR),A
       4664                     RBREAD_MEM:
000664 4664 2ACDF2          16      LD  HL,(_BUF_ST)
000667 4667 22BFFC          16      LD  (SAVENT),HL
00066A 466A 22C7F2          16      LD  (_DTA),HL
00066D 466D 21FFFF          10      LD  HL,0FFFFH
000670 4670 CD8A49          17      CALL    ROM_READ
000673 4673 AF               4      XOR A
000674 4674 32C9F2          13      LD  (FLG_LDIR),A
000677 4677 3ABEFC          13      LD  A,(RUNBNF)
00067A 467A FE52             7      CP  'R'
00067C 467C 2006            12      JR  NZ,RBREAD1
00067E 467E 2AD1F2          16      LD  HL,(_BUF_EX)
000681 4681 229DF2          16      LD  (SWC_BLOAD),HL
       4684                     RBREAD1:
       4684                     ROM_NEXT:
000684 4684 2AE7F2          16      LD  HL,(PARAM1)
000687 4687 7E               7      LD  A,(HL)
000688 4688 2B               6      DEC HL
000689 4689 B7               4      OR  A
00068A 468A 2805            12      JR  Z,ROM_NEXT1
00068C 468C FE3A             7      CP  ':'
00068E 468E 2801            12      JR  Z,ROM_NEXT1
000690 4690 23               6      INC HL
       4691                     ROM_NEXT1:
000691 4691 5D               4      LD  E,L
000692 4692 54               4      LD  D,H
                                
000693 4693 CD6A4B          17      CALL    SEARCH_END
000696 4696 B7               4      OR  A
000697 4697 2821            12      JR  Z,REM
       4699                     RN3:                    ;マルチステートメントの処理
000699 4699 7E               7      LD  A,(HL)
                                
00069A 469A FEB5             7      CP  0B5H            ;LOAD
00069C 469C CA0D45          10      JP  Z,ROM_LOAD
00069F 469F FE8A             7      CP  08AH            ;RUN
0006A1 46A1 281B            12      JR  Z,ROM_RUN
0006A3 46A3 FEB7             7      CP  0B7H            ;FILES
0006A5 46A5 2825            12      JR  Z,ROM_FILES
0006A7 46A7 FED6             7      CP  0D6H            ;COPY
0006A9 46A9 CA6A47          10      JP  Z,ROM_COPY
0006AC 46AC FE20             7      CP  020H
0006AE 46AE 2807            12      JR  Z,RN_SP
                                
0006B0 46B0 3E28             7      LD  A,028H          ;JR Z,
0006B2 46B2 32A3F2          13      LD  (SWC_BLOAD_M),A
0006B5 46B5 7E               7      LD  A,(HL)
0006B6 46B6 C9              10      RET
       46B7                     RN_SP:
0006B7 46B7 23               6      INC HL
0006B8 46B8 18DF            12      JR  RN3
                                
       46BA                     REM:
0006BA 46BA EB               4      EX  DE,HL
0006BB 46BB 3E8F             7      LD  A,08FH          ;REM
0006BD 46BD C9              10      RET
                                
       46BE                     ROM_RUN:
0006BE 46BE 23               6      INC HL
0006BF 46BF 7E               7      LD  A,(HL)
0006C0 46C0 2B               6      DEC HL
0006C1 46C1 B7               4      OR  A
0006C2 46C2 C40D45          17      CALL    NZ,ROM_LOAD
0006C5 46C5 FE8F             7      CP  08FH            ;REM
0006C7 46C7 3E8A             7      LD  A,08AH          ;RUN
0006C9 46C9 C0              11      RET NZ
0006CA 46CA 77               7      LD  (HL),A
0006CB 46CB C9              10      RET
                                
       46CC                     ROM_FILES:
0006CC 46CC CD3847          17      CALL    INIT_PARAM
0006CF 46CF CD2B4A          17      CALL    FILE_B
0006D2 46D2 CDC251          17      CALL    GET_DISK_BANK_FDRV
0006D5 46D5 3ABCF2          13      LD  A,(SECSZ_H)
0006D8 46D8 CD8050          17      CALL    IS_BPB1
0006DB 46DB DAD945          10      JP  C,ERROR_DEVICE_IO_ERROR
0006DE 46DE 3AECF2          13      LD  A,(FNAME)
0006E1 46E1 FE21             7      CP  021H
0006E3 46E3 3005            12      JR  NC,RFILES0
0006E5 46E5 060B             7      LD  B,11
0006E7 46E7 CDFE4A          17      CALL    FILE10
       46EA                     RFILES0:
0006EA 46EA CD084E          17      CALL    GET_DIR_DAT
       46ED                     RFILES1:
0006ED 46ED CDC64B          17      CALL    FILESE
0006F0 46F0 3041            12      JR  NC,RFILES_NOT_MATCH
       46F2                     RFILES_DISP:
0006F2 46F2 E5              11      PUSH    HL
0006F3 46F3 110B00          10      LD  DE,0000BH   ;属性
0006F6 46F6 19              11      ADD HL,DE
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
0006F7 46F7 7E               7      LD  A,(HL)
                                #endif
0006F8 46F8 E1              10      POP HL
0006F9 46F9 CB4F             8      BIT 1,A     ;不可視属性
0006FB 46FB 2033            12      JR  NZ,RFILES_NEXT
0006FD 46FD E5              11      PUSH    HL
0006FE 46FE 0608             7      LD  B,8
000700 4700 CD7D43          17      CALL    MSN
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000703 4703 7E               7      LD  A,(HL)
                                #endif
000704 4704 FE20             7      CP  020H
000706 4706 F5              11      PUSH    AF
000707 4707 3E2E             7      LD  A,'.'
000709 4709 C43B52          17      CALL    NZ,MSG_A
00070C 470C 0603             7      LD  B,3
00070E 470E CD7D43          17      CALL    MSN
000711 4711 F1              10      POP AF
000712 4712 CC3B52          17      CALL    Z,MSG_A
000715 4715 3ADDF3          13      LD  A,(CSRX)
000718 4718 47               4      LD  B,A
000719 4719 3AB0F3          13      LD  A,(LINLEN)
00071C 471C 90               4      SUB B
00071D 471D FE0C             7      CP  12
00071F 471F 3009            12      JR  NC,RFILES2
000721 4721 3E0D             7      LD  A,00DH      ;改行
000723 4723 CD3B52          17      CALL    MSG_A
000726 4726 3E0A             7      LD  A,00AH
000728 4728 1802            12      JR  RFILES3
       472A                     RFILES2:
00072A 472A 3E20             7      LD  A,020H
       472C                     RFILES3:
00072C 472C CD3B52          17      CALL    MSG_A
00072F 472F E1              10      POP HL
       4730                     RFILES_NEXT:
000730 4730 CDE24B          17      CALL    FNEXT
       4733                     RFILES_NOT_MATCH:
000733 4733 20B8            12      JR  NZ,RFILES1
000735 4735 C38446          10      JP  ROM_NEXT
                                
       4738                     INIT_PARAM:
000738 4738 22E5F2          16      LD  (PARAM0),HL
00073B 473B 22E7F2          16      LD  (PARAM1),HL
00073E 473E EB               4      EX  DE,HL
00073F 473F 32BEFC          13      LD  (RUNBNF),A
000742 4742 3263F6          13      LD  (VALTYP),A
000745 4745 E5              11      PUSH    HL
000746 4746 2ADEF2          16      LD  HL,(_CD)
000749 4749 22E9F2          16      LD  (_CDX),HL
00074C 474C E1              10      POP HL
00074D 474D 13               6      INC DE
00074E 474E CD3A4B          17      CALL    SPCUT
000751 4751 1A               7      LD  A,(DE)
000752 4752 B7               4      OR  A
000753 4753 C8              11      RET Z
000754 4754 FE3A             7      CP  ':'
000756 4756 C8              11      RET Z
000757 4757 FE28             7      CP  '('
000759 4759 C8              11      RET Z
00075A 475A EB               4      EX  DE,HL
00075B 475B DD21644C        14      LD  IX,FRMEVL
00075F 475F FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000763 4763 CD1C00          17      CALL    _CALSLT
000766 4766 22E7F2          16      LD  (PARAM1),HL
000769 4769 C9              10      RET
                                
       476A                     ROM_COPY:
00076A 476A CD3847          17      CALL    INIT_PARAM
00076D 476D 3A63F6          13      LD  A,(VALTYP)
000770 4770 FE03             7      CP  3       ;string
000772 4772 C2264A          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
000775 4775 CD2B4A          17      CALL    FILE_B
000778 4778 CDAA4B          17      CALL    ROM_OPEN
00077B 477B DAE245          10      JP  C,ERROR_FILE_NOT_FOUND
                                
00077E 477E 21D1F2          10      LD  HL,_BUF_W
000781 4781 22C7F2          16      LD  (_DTA),HL
000784 4784 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
000787 4787 CD8A49          17      CALL    ROM_READ
                                
00078A 478A AF               4      XOR A
00078B 478B 32CCF2          13      LD  (_BUF_LO),A     ;PSET
00078E 478E 32D9F2          13      LD  (_BUF_O),A      ;向き
                                
000791 4791 2AE7F2          16      LD  HL,(PARAM1)
       4794                     RCP_PARAM1:
000794 4794 7E               7      LD  A,(HL)
000795 4795 23               6      INC HL
000796 4796 B7               4      OR  A
000797 4797 CA9146          10      JP  Z,ROM_NEXT1
00079A 479A FE3A             7      CP  ':'
00079C 479C CA9146          10      JP  Z,ROM_NEXT1
00079F 479F FE2C             7      CP  ','
0007A1 47A1 2012            12      JR  NZ,RCP_PARAM1_
                                
0007A3 47A3 DD212F54        14      LD  IX,FRMQNT
0007A7 47A7 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007AB 47AB CD1C00          17      CALL    _CALSLT
0007AE 47AE 7B               4      LD  A,E
0007AF 47AF 87               4      ADD A,A
0007B0 47B0 87               4      ADD A,A
0007B1 47B1 32D9F2          13      LD  (_BUF_O),A
0007B4 47B4 7E               7      LD  A,(HL)
       47B5                     RCP_PARAM1_:
0007B5 47B5 FE28             7      CP  '('
0007B7 47B7 20DB            12      JR  NZ,RCP_PARAM1
0007B9 47B9 DD212F54        14      LD  IX,FRMQNT
0007BD 47BD FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007C1 47C1 CD1C00          17      CALL    _CALSLT
                                
0007C4 47C4 ED53D5F2        20      LD  (_BUF_X),DE
                                
       47C8                     RCP_PARAM2:
0007C8 47C8 23               6      INC HL
0007C9 47C9 7E               7      LD  A,(HL)
0007CA 47CA FE20             7      CP  020H
0007CC 47CC 28FA            12      JR  Z,RCP_PARAM2
0007CE 47CE FE2C             7      CP  ','
0007D0 47D0 28F6            12      JR  Z,RCP_PARAM2
                                
0007D2 47D2 DD212F54        14      LD  IX,FRMQNT
0007D6 47D6 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007DA 47DA CD1C00          17      CALL    _CALSLT
                                
0007DD 47DD 3AF6FA          13      LD  A,(ACPAGE)
0007E0 47E0 57               4      LD  D,A
0007E1 47E1 ED53D7F2        20      LD  (_BUF_Y),DE
       47E5                     RCP_PARAM3:
0007E5 47E5 23               6      INC HL
0007E6 47E6 7E               7      LD  A,(HL)
0007E7 47E7 FE20             7      CP  020H
0007E9 47E9 28FA            12      JR  Z,RCP_PARAM3
0007EB 47EB FE29             7      CP  ')'
0007ED 47ED 28F6            12      JR  Z,RCP_PARAM3
0007EF 47EF FE2C             7      CP  ','
0007F1 47F1 2033            12      JR  NZ,RCP_ST
                                
0007F3 47F3 23               6      INC HL
0007F4 47F4 DD212F54        14      LD  IX,FRMQNT
0007F8 47F8 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007FC 47FC CD1C00          17      CALL    _CALSLT
                                
0007FF 47FF 7B               4      LD  A,E
000800 4800 32D8F2          13      LD  (_BUF_P),A
                                
       4803                     RCP_PARAM4:
000803 4803 7E               7      LD  A,(HL)
000804 4804 23               6      INC HL
000805 4805 FE20             7      CP  020H
000807 4807 28FA            12      JR  Z,RCP_PARAM4
                                
000809 4809 FE2C             7      CP  ','
00080B 480B 2019            12      JR  NZ,RCP_ST
                                
00080D 480D 7E               7      LD  A,(HL)
00080E 480E 0604             7      LD  B,4
000810 4810 FEC3             7      CP  0C3H        ;PRESET
000812 4812 280E            12      JR  Z,RCP_LO
000814 4814 05               4      DEC B       ;3
000815 4815 D6F8             7      SUB 0F8H        ;XOR
000817 4817 2809            12      JR  Z,RCP_LO
000819 4819 05               4      DEC B       ;2
00081A 481A 3C               4      INC A       ;OR
00081B 481B 2805            12      JR  Z,RCP_LO
00081D 481D 05               4      DEC B       ;1
00081E 481E 3C               4      INC A       ;AND
00081F 481F 2801            12      JR  Z,RCP_LO
000821 4821 05               4      DEC B       ;0
                                                ;PSET
       4822                     RCP_LO:
000822 4822 78               4      LD  A,B
000823 4823 32CCF2          13      LD  (_BUF_LO),A
       4826                     RCP_ST:
000826 4826 2AC6F6          16      LD  HL,(STREND)
000829 4829 22C7F2          16      LD  (_DTA),HL
00082C 482C EB               4      EX  DE,HL
00082D 482D 2100FE          10      LD  HL,-512
000830 4830 39              11      ADD HL,SP
000831 4831 AF               4      XOR A
000832 4832 ED52            15      SBC HL,DE
000834 4834 3008            12      JR  NC,RCP0
000836 4836 215EF5          10      LD  HL,BUF
000839 4839 22C7F2          16      LD  (_DTA),HL
00083C 483C 6F               4      LD  L,A ;0
00083D 483D 67               4      LD  H,A ;0
       483E                     RCP0:
00083E 483E 24               4      INC H
00083F 483F 22CFF2          16      LD  (_BUF_EN),HL
       4842                     RCP1:
000842 4842 F3               4      DI
000843 4843 CD1849          17      CALL    WAIT_VDP
                                
000846 4846 3A0700          13      LD  A,(WRVDP)
000849 4849 4F               4      LD  C,A
00084A 484A 0C               4      INC C       ;C := PORT#1's address(WR)
00084B 484B 3E24             7      LD  A,36
00084D 484D ED79            12      OUT (C),A
00084F 484F 3E91             7      LD  A,080H+17
000851 4851 ED79            12      OUT (C),A       ;R#17 := 36
                                
000853 4853 0C               4      INC C
000854 4854 0C               4      INC C       ;C := PORT#3's address(WR)
000855 4855 2AD5F2          16      LD  HL,(_BUF_X)
000858 4858 ED69            12      OUT (C),L       ;R#36 DX
00085A 485A ED61            12      OUT (C),H       ;R#37
00085C 485C 2AD7F2          16      LD  HL,(_BUF_Y)
00085F 485F ED69            12      OUT (C),L       ;R#38 DY
000861 4861 ED61            12      OUT (C),H       ;R#39
000863 4863 2AD1F2          16      LD  HL,(_BUF_W)
000866 4866 ED69            12      OUT (C),L       ;R#40 NX
000868 4868 ED61            12      OUT (C),H       ;R#41
00086A 486A 2AD3F2          16      LD  HL,(_BUF_H)
00086D 486D ED69            12      OUT (C),L       ;R#42 NY
00086F 486F ED61            12      OUT (C),H       ;R#43
                                
000871 4871 DD2AAFFC        20      LD  IX,(SCRMOD)
000875 4875 3ACCF2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000878 4878 B7               4      OR  A
000879 4879 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
00087B 487B DD7D             9      LD  A,IXL
00087D 487D FE08             7      CP  8
00087F 487F 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
000881 4881 FE06             7      CP  6
000883 4883 2AD5F2          16      LD  HL,(_BUF_X)
000886 4886 3AD1F2          13      LD  A,(_BUF_W)
000889 4889 2005            12      JR  NZ,SCR57
00088B 488B B5               4      OR  L       ;スクリーン6
00088C 488C E603             7      AND 3
00088E 488E 200D            12      JR  NZ,USE_LMMC
       4890                     SCR57:              ;スクリーン5,7
000890 4890 B5               4      OR  L
000891 4891 E601             7      AND 1
000893 4893 2008            12      JR  NZ,USE_LMMC
       4895                     USE_HMMC:
000895 4895 DD2E08          10      LD  IXL,8
       4898                     USE_HMMC8:
000898 4898 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
00089A 489A 32CCF2          13      LD  (_BUF_LO),A
       489D                     USE_LMMC:
00089D 489D 110000          10      LD  DE,0
0008A0 48A0 06FF             7      LD  B,-1
0008A2 48A2 CD4349          17      CALL    GET_PIXEL
0008A5 48A5 ED79            12      OUT (C),A       ;R#44 first DATA
0008A7 48A7 3AD9F2          13      LD  A,(_BUF_O)
0008AA 48AA ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
0008AC 48AC 3ACCF2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0008AF 48AF F6B0             7      OR  0B0H        ;R#46 LMMC command
0008B1 48B1 ED79            12      OUT (C),A
                                
0008B3 48B3 FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
0008B5 48B5 0D               4      DEC C
0008B6 48B6 0D               4      DEC C       ;C := PORT#1's address(WR)
0008B7 48B7 3EAC             7      LD  A,080H+44
0008B9 48B9 ED79            12      OUT (C),A
0008BB 48BB 3E91             7      LD  A,080H+17
0008BD 48BD ED79            12      OUT (C),A       ;R#17 := 44
                                
0008BF 48BF 3A0600          13      LD  A,(RDVDP)
0008C2 48C2 3C               4      INC A
0008C3 48C3 FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
0008C5 48C5 3E02             7      LD  A,2
0008C7 48C7 ED79            12      OUT (C),A
0008C9 48C9 3E8F             7      LD  A,08FH
0008CB 48CB ED79            12      OUT (C),A
0008CD 48CD 3ACCF2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0008D0 48D0 E640             7      AND 040H
0008D2 48D2 201C            12      JR  NZ,LOOP_HMMC
       48D4                     LOOP_COPY:
0008D4 48D4 CD4349          17      CALL    GET_PIXEL
0008D7 48D7 08               4      EX  AF,AF'
0008D8 48D8 FD4C             9      LD  C,IYH
       48DA                     LOOP_COPY1:
0008DA 48DA ED78            12      IN  A,(C)
0008DC 48DC 0F               4      RRCA            ;RRCAではサインフラグは変化しない
0008DD 48DD 300A            12      JR  NC,EXIT_COPY    ;check CE bit
0008DF 48DF F2DA48          10      JP  P,LOOP_COPY1    ;check TR bit
0008E2 48E2 08               4      EX  AF,AF'
0008E3 48E3 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
0008E5 48E5 ED79            12      OUT (C),A
0008E7 48E7 18EB            12      JR  LOOP_COPY
                                
       48E9                     EXIT_COPY:
0008E9 48E9 CD2049          17      CALL    GET_STATUS_0
0008EC 48EC FB               4      EI
0008ED 48ED C38446          10      JP  ROM_NEXT
                                
       48F0                     LOOP_HMMC:
0008F0 48F0 F3               4      DI          ;必要
0008F1 48F1 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
0008F3 48F3 43               4      LD  B,E
0008F4 48F4 7B               4      LD  A,E
0008F5 48F5 B7               4      OR  A
0008F6 48F6 2802            12      JR  Z,LOOP_HMMC1
0008F8 48F8 EDB3                    OTIR
       48FA                     LOOP_HMMC1:
0008FA 48FA 14               4      INC D
       48FB                     LOOP_HMMC2:
0008FB 48FB 15               4      DEC D
0008FC 48FC 2805            12      JR  Z,LOOP_HMMC3
0008FE 48FE EDB3                    OTIR
000900 4900 C3FB48          10      JP  LOOP_HMMC2
       4903                     LOOP_HMMC3:
000903 4903 ED78            12      IN  A,(C)
000905 4905 0F               4      RRCA
000906 4906 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
000908 4908 2ACFF2          16      LD  HL,(_BUF_EN)
00090B 490B CD8A49          17      CALL    ROM_READ
00090E 490E EB               4      EX  DE,HL
00090F 490F 2AC7F2          16      LD  HL,(_DTA)
000912 4912 7A               4      LD  A,D
000913 4913 B3               4      OR  E
000914 4914 20DA            12      JR  NZ,LOOP_HMMC
000916 4916 18C2            12      JR  LOOP_COPY1
                                    
       4918                     WAIT_VDP:
000918 4918 3E02             7      LD  A,2
00091A 491A CD2149          17      CALL    GET_STATUS
00091D 491D 0F               4      RRCA
00091E 491E 38F8            12      JR  C,WAIT_VDP
       4920                     GET_STATUS_0:
000920 4920 AF               4      XOR A
       4921                     GET_STATUS:
000921 4921 C5              11      PUSH    BC
000922 4922 ED4B0600        20      LD  BC,(RDVDP)
000926 4926 0C               4      INC C
000927 4927 ED79            12      OUT (C),A
000929 4929 3E8F             7      LD  A,08FH
00092B 492B ED79            12      OUT (C),A
00092D 492D ED78            12      IN  A,(C)
00092F 492F C1              10      POP BC
000930 4930 C9              10      RET
                                
       4931                     GET_PIXEL256:
000931 4931 7A               4      LD  A,D
000932 4932 B3               4      OR  E
000933 4933 200A            12      JR  NZ,GET_PIXEL1
000935 4935 2ACFF2          16      LD  HL,(_BUF_EN)
000938 4938 CD8A49          17      CALL    ROM_READ
00093B 493B EB               4      EX  DE,HL
00093C 493C 2AC7F2          16      LD  HL,(_DTA)
       493F                     GET_PIXEL1:
00093F 493F 7E               7      LD  A,(HL)
000940 4940 23               6      INC HL
000941 4941 1B               6      DEC DE
000942 4942 C9              10      RET
                                
       4943                     GET_PIXEL:
000943 4943 DD7D             9      LD  A,IXL
000945 4945 FE08             7      CP  8
000947 4947 28E8            12      JR  Z,GET_PIXEL256
000949 4949 04               4      INC B
00094A 494A FE06             7      CP  6
00094C 494C 282E            12      JR  Z,GET_PIXEL4
                                
00094E 494E CB40             8      BIT 0,B
000950 4950 20ED            12      JR  NZ,GET_PIXEL1
                                
000952 4952 7A               4      LD  A,D
000953 4953 B3               4      OR  E
000954 4954 200A            12      JR  NZ,GET_PIXEL2
                                
000956 4956 2ACFF2          16      LD  HL,(_BUF_EN)
000959 4959 CD8A49          17      CALL    ROM_READ
00095C 495C EB               4      EX  DE,HL
00095D 495D 2AC7F2          16      LD  HL,(_DTA)
                                
       4960                     GET_PIXEL2:
000960 4960 7E               7      LD  A,(HL)
000961 4961 0F               4      RRCA
000962 4962 0F               4      RRCA
000963 4963 0F               4      RRCA
000964 4964 0F               4      RRCA
000965 4965 C9              10      RET
                                
       4966                     GET_PIXEL3:
000966 4966 7A               4      LD  A,D
000967 4967 B3               4      OR  E
000968 4968 200A            12      JR  NZ,GET_PIXEL5
                                
00096A 496A 2ACFF2          16      LD  HL,(_BUF_EN)
00096D 496D CD8A49          17      CALL    ROM_READ
000970 4970 EB               4      EX  DE,HL
000971 4971 2AC7F2          16      LD  HL,(_DTA)
       4974                     GET_PIXEL5:
000974 4974 7E               7      LD  A,(HL)
000975 4975 0F               4      RRCA
000976 4976 0F               4      RRCA
000977 4977 0F               4      RRCA
000978 4978 0F               4      RRCA
000979 4979 0F               4      RRCA
00097A 497A 0F               4      RRCA
00097B 497B C9              10      RET
                                
       497C                     GET_PIXEL4:
00097C 497C 78               4      LD  A,B
00097D 497D E603             7      AND 3   ;+0
00097F 497F 28E5            12      JR  Z,GET_PIXEL3
000981 4981 3D               4      DEC A   ;+1
000982 4982 28DC            12      JR  Z,GET_PIXEL2
000984 4984 3D               4      DEC A   ;+2
000985 4985 7E               7      LD  A,(HL)
000986 4986 C0              11      RET NZ
000987 4987 0F               4      RRCA        ;+3
000988 4988 0F               4      RRCA
000989 4989 C9              10      RET
                                
       498A                     ROM_READ:
00098A 498A E5              11      PUSH    HL
00098B 498B D5              11      PUSH    DE
00098C 498C C5              11      PUSH    BC
00098D 498D FDE5            15      PUSH    IY
00098F 498F 22E3F2          16      LD  (LEFTX),HL
000992 4992 2AC7F2          16      LD  HL,(_DTA)
000995 4995 22DAF2          16      LD  (DTAX),HL
000998 4998 2AE3F2          16      LD  HL,(LEFTX)
                                
00099B 499B CD3C4C          17      CALL    RBX1
00099E 499E 3870            12      JR  C,RBRERR1
0009A0 49A0 79               4      LD  A,C
0009A1 49A1 EB               4      EX  DE,HL
0009A2 49A2 ED52            15      SBC HL,DE       ;CP 0HL,CDE
0009A4 49A4 19              11      ADD HL,DE
0009A5 49A5 DE00             7      SBC A,000H
0009A7 49A7 3801            12      JR  C,RBR1
0009A9 49A9 EB               4      EX  DE,HL
       49AA                     RBR1:
0009AA 49AA 9F               4      SBC A,A
0009AB 49AB E601             7      AND 1
0009AD 49AD 32B6F2          13      LD  (_RESULT),A
0009B0 49B0 7C               4      LD  A,H
0009B1 49B1 B5               4      OR  L
0009B2 49B2 CA064A          10      JP  Z,RBREND0
                                
0009B5 49B5 22C3F2          16      LD  (_LEFT),HL  ;Read record byte
0009B8 49B8 22E3F2          16      LD  (LEFTX),HL
                                
0009BB 49BB CD684C          17      CALL    RBX2
0009BE 49BE 281A            12      JR  Z,RBRB
                                                ;先頭の端数
0009C0 49C0 CD7B4C          17      CALL    RBXA
0009C3 49C3 DA1C4A          10      JP  C,RBRERR
0009C6 49C6 C5              11      PUSH    BC
0009C7 49C7 CD0344          17      CALL    ROM_LDIR
0009CA 49CA ED53DAF2        20      LD  (DTAX),DE
0009CE 49CE 2AE3F2          16      LD  HL,(LEFTX)
0009D1 49D1 D1              10      POP DE
0009D2 49D2 A7               4      AND A
0009D3 49D3 ED52            15      SBC HL,DE
0009D5 49D5 22E3F2          16      LD  (LEFTX),HL
0009D8 49D8 2829            12      JR  Z,RBREND
                                
       49DA                     RBRB:
0009DA 49DA CDB74C          17      CALL    RBXB
0009DD 49DD 2818            12      JR  Z,RBRC
       49DF                     RBRB1:
0009DF 49DF C5              11      PUSH    BC
0009E0 49E0 D5              11      PUSH    DE
0009E1 49E1 CD624D          17      CALL    CLUST
0009E4 49E4 EB               4      EX  DE,HL
0009E5 49E5 ED4BB9F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
0009E9 49E9 CD0344          17      CALL    ROM_LDIR
0009EC 49EC EB               4      EX  DE,HL
0009ED 49ED D1              10      POP DE
0009EE 49EE C1              10      POP BC
0009EF 49EF CD3F4D          17      CALL    GNCL
0009F2 49F2 DA1C4A          10      JP  C,RBRERR
0009F5 49F5 10E8            13      DJNZ    RBRB1
       49F7                     RBRC:
0009F7 49F7 CDCF4C          17      CALL    RBXC
0009FA 49FA 2807            12      JR  Z,RBREND
                                
0009FC 49FC CD624D          17      CALL    CLUST
0009FF 49FF EB               4      EX  DE,HL
000A00 4A00 CD0344          17      CALL    ROM_LDIR
       4A03                     RBREND:
000A03 4A03 CDDB4C          17      CALL    RBXEND
       4A06                     RBREND0:
000A06 4A06 FDE1            14      POP IY
000A08 4A08 C1              10      POP BC
000A09 4A09 D1              10      POP DE
000A0A 4A0A F1              10      POP AF  ;(HL)
000A0B 4A0B AF               4      XOR A
000A0C 4A0C 3AB6F2          13      LD  A,(_RESULT)
000A0F 4A0F C9              10      RET
                                
       4A10                     RBRERR1:
000A10 4A10 3E01             7      LD  A,001H
       4A12                     RBRERR2:
000A12 4A12 FDE1            14      POP IY
000A14 4A14 C1              10      POP BC
000A15 4A15 D1              10      POP DE
000A16 4A16 E1              10      POP HL
000A17 4A17 37               4      SCF
000A18 4A18 210000          10      LD  HL,0
000A1B 4A1B C9              10      RET
       4A1C                     RBRERR:
000A1C 4A1C 3EFF             7      LD  A,0FFH
000A1E 4A1E 18F2            12      JR  RBRERR2
                                
       4A20                     FILE_DD:
000A20 4A20 E1              10      POP HL
000A21 4A21 3E                      DB  03EH
000A22 4A22 C9              10      RET
000A23 4A23 32A3F2          13      LD  (SWC_BLOAD_M),A
       4A26                     ROM_ORG:
000A26 4A26 2AE5F2          16      LD  HL,(PARAM0)
000A29 4A29 7E               7      LD  A,(HL)
000A2A 4A2A C9              10      RET
       4A2B                     FILE_B:
000A2B 4A2B AF               4      XOR A
000A2C 4A2C 32EBF2          13      LD  (FDRV),A
000A2F 4A2F 1E00             7      LD  E,0
000A31 4A31 3A63F6          13      LD  A,(VALTYP)
000A34 4A34 FE03             7      CP  3       ;string
000A36 4A36 C2BB4A          10      JP  NZ,FILED
                                
000A39 4A39 DD21D067        14      LD  IX,FRESTR
000A3D 4A3D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000A41 4A41 CD1C00          17      CALL    _CALSLT
000A44 4A44 E5              11      PUSH    HL
000A45 4A45 DDE1            14      POP IX
                                
000A47 4A47 DD5E00          19      LD  E,(IX+0)
000A4A 4A4A DD7E01          19      LD  A,(IX+1)
000A4D 4A4D DD5602          19      LD  D,(IX+2)
000A50 4A50 DD62             9      LD  IXH,D
000A52 4A52 DD6F             9      LD  IXL,A
000A54 4A54 7B               4      LD  A,E
       4A55                     FILE_BDOS:
000A55 4A55 FE04             7      CP  4
000A57 4A57 3808            12      JR  C,FILEB1
000A59 4A59 DD7E03          19      LD  A,(IX+3)
000A5C 4A5C FE3A             7      CP  ':'
000A5E 4A5E 28C0            12      JR  Z,FILE_DD
000A60 4A60 7B               4      LD  A,E
       4A61                     FILEB1:
000A61 4A61 FE02             7      CP  2
000A63 4A63 3818            12      JR  C,DEVI1
000A65 4A65 DD7E01          19      LD  A,(IX+1)
000A68 4A68 FE3A             7      CP  ':'
000A6A 4A6A 2011            12      JR  NZ,DEVI1
000A6C 4A6C DD7E00          19      LD  A,(IX+0)        ;DRIVE
000A6F 4A6F CD944B          17      CALL    CAP
000A72 4A72 D640             7      SUB '@'
000A74 4A74 DD23            10      INC IX
000A76 4A76 DD23            10      INC IX
000A78 4A78 1D               4      DEC E
000A79 4A79 1D               4      DEC E
000A7A 4A7A 32EBF2          13      LD  (FDRV),A
       4A7D                     DEVI1:
000A7D 4A7D DD7E00          19      LD  A,(IX+0)
000A80 4A80 D65C             7      SUB 05CH        ;\
000A82 4A82 2008            12      JR  NZ,NOROOT
000A84 4A84 6F               4      LD  L,A
000A85 4A85 67               4      LD  H,A
000A86 4A86 22E9F2          16      LD  (_CDX),HL
000A89 4A89 DD23            10      INC IX
000A8B 4A8B 1D               4      DEC E
       4A8C                     NOROOT:
                                
       4A8C                     SETDIR:
000A8C 4A8C CDBB4A          17      CALL    FILED
000A8F 4A8F DD7E00          19      LD  A,(IX+0)
000A92 4A92 FE5C             7      CP  05CH        ;\
000A94 4A94 C0              11      RET NZ
000A95 4A95 DD23            10      INC IX
000A97 4A97 1D               4      DEC E
000A98 4A98 3AECF2          13      LD  A,(FNAME)
000A9B 4A9B FE20             7      CP  020H        ;. の処理
000A9D 4A9D 28ED            12      JR  Z,SETDIR
                                
000A9F 4A9F CDAA4B          17      CALL    ROM_OPEN
000AA2 4AA2 B7               4      OR  A
000AA3 4AA3 C0              11      RET NZ
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                #else
000AA4 4AA4 FD2AE0F2        20      LD  IY,(DIRENT1)
000AA8 4AA8 FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000AAC 4AAC C8              11      RET Z
000AAD 4AAD CD024B          17      CALL    FILEI
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
000AB0 4AB0 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000AB3 4AB3 FD661B          19      LD  H,(IY+01BH)
                                #endif
000AB6 4AB6 22E9F2          16      LD  (_CDX),HL
000AB9 4AB9 18D1            12      JR  SETDIR
                                
       4ABB                     FILED:
000ABB 4ABB CD024B          17      CALL    FILEI
000ABE 4ABE 21ECF2          10      LD  HL,FNAME
                                
000AC1 4AC1 0608             7      LD  B,8
       4AC3                     FILE2:
000AC3 4AC3 CD0F4B          17      CALL    CCHKF
000AC6 4AC6 C8              11      RET Z
000AC7 4AC7 FE2A             7      CP  '*'
000AC9 4AC9 282E            12      JR  Z,FILE9
000ACB 4ACB FE2E             7      CP  '.'
000ACD 4ACD 280C            12      JR  Z,FILE4
000ACF 4ACF 77               7      LD  (HL),A
000AD0 4AD0 23               6      INC HL
000AD1 4AD1 10F0            13      DJNZ    FILE2
                                
       4AD3                     FILE3:
000AD3 4AD3 CD0F4B          17      CALL    CCHKF
000AD6 4AD6 C8              11      RET Z
000AD7 4AD7 FE2E             7      CP  '.'
000AD9 4AD9 20F8            12      JR  NZ,FILE3
                                
       4ADB                     FILE4:
000ADB 4ADB 21F4F2          10      LD  HL,FNAME+8
000ADE 4ADE 0603             7      LD  B,3
                                
       4AE0                     FILE4L:
000AE0 4AE0 CD0F4B          17      CALL    CCHKF
000AE3 4AE3 C8              11      RET Z
000AE4 4AE4 FE2E             7      CP  '.'
000AE6 4AE6 2008            12      JR  NZ,FILE12
000AE8 4AE8 32ECF2          13      LD  (FNAME),A   ;Parent directory(..)
000AEB 4AEB 32EDF2          13      LD  (FNAME+1),A
000AEE 4AEE 3E20             7      LD  A,020H
       4AF0                     FILE12:
000AF0 4AF0 FE2A             7      CP  '*'
000AF2 4AF2 280A            12      JR  Z,FILE10
000AF4 4AF4 77               7      LD  (HL),A
000AF5 4AF5 23               6      INC HL
000AF6 4AF6 10E8            13      DJNZ    FILE4L
000AF8 4AF8 C9              10      RET
                                
       4AF9                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000AF9 4AF9 CDFE4A          17      CALL    FILE10
000AFC 4AFC 18D5            12      JR  FILE3
                                
       4AFE                     FILE10:
000AFE 4AFE 3E3F             7      LD  A,'?'
000B00 4B00 1808            12      JR  FILL_MEMORY
       4B02                     FILEI:              ;名前＋拡張子をスペースで初期化
000B02 4B02 3E20             7      LD  A,020H
000B04 4B04 01000B          10      LD  BC,11*256   ;C=0にしておく
000B07 4B07 21ECF2          10      LD  HL,FNAME
       4B0A                     FILL_MEMORY:            ;HLからBバイトAで埋める
000B0A 4B0A 77               7      LD  (HL),A
000B0B 4B0B 23               6      INC HL
000B0C 4B0C 10FC            13      DJNZ    FILL_MEMORY
000B0E 4B0E C9              10      RET
                                
       4B0F                     CCHKF:
000B0F 4B0F 7B               4      LD  A,E
000B10 4B10 B7               4      OR  A
000B11 4B11 C8              11      RET Z
000B12 4B12 DD7E00          19      LD  A,(IX+0)
000B15 4B15 CD1C4B          17      CALL    CCHK2
000B18 4B18 C8              11      RET Z
000B19 4B19 C37F4B          10      JP  FKAN
                                
       4B1C                     CCHK2:
000B1C 4B1C 0C               4      INC C
000B1D 4B1D 0D               4      DEC C
000B1E 4B1E C0              11      RET NZ
       4B1F                     CCHK3:              ;ZF=1 で使えない文字
000B1F 4B1F FE2B             7      CP  '+'
000B21 4B21 C8              11      RET Z
000B22 4B22 FE2C             7      CP  ','
000B24 4B24 C8              11      RET Z
000B25 4B25 FE2F             7      CP  '/'
000B27 4B27 C8              11      RET Z
000B28 4B28 FE3A             7      CP  ':'
000B2A 4B2A C8              11      RET Z
000B2B 4B2B FE3B             7      CP  ';'
000B2D 4B2D C8              11      RET Z
000B2E 4B2E FE3D             7      CP  '='
000B30 4B30 C8              11      RET Z
000B31 4B31 FE5C             7      CP  05CH    ;\
000B33 4B33 C8              11      RET Z
000B34 4B34 FE1F             7      CP  01FH
000B36 4B36 D0              11      RET NC
000B37 4B37 BF               4      CP  A       ;Z=1
000B38 4B38 C9              10      RET
                                
       4B39                     SS1:
000B39 4B39 13               6      INC DE
       4B3A                     SPCUT:              ;スペースをカット
000B3A 4B3A 1A               7      LD  A,(DE)
000B3B 4B3B FE20             7      CP  020H
000B3D 4B3D 28FA            12      JR  Z,SS1
000B3F 4B3F C9              10      RET
                                
       4B40                     SCREOF1:
000B40 4B40 13               6      INC DE
       4B41                     SPCUTEX:            ;スペース改行などをカット
000B41 4B41 1A               7      LD  A,(DE)
000B42 4B42 FE20             7      CP  020H
000B44 4B44 28FA            12      JR  Z,SCREOF1
000B46 4B46 FE0D             7      CP  00DH
000B48 4B48 28F6            12      JR  Z,SCREOF1
000B4A 4B4A FE0A             7      CP  00AH
000B4C 4B4C 28F2            12      JR  Z,SCREOF1
000B4E 4B4E FE1A             7      CP  01AH
000B50 4B50 28EE            12      JR  Z,SCREOF1
000B52 4B52 C9              10      RET
                                
       4B53                     GETNUM:
000B53 4B53 210000          10      LD  HL,0
       4B56                     GETNUM1:
000B56 4B56 1A               7      LD  A,(DE)
000B57 4B57 13               6      INC DE
000B58 4B58 D630             7      SUB '0'
000B5A 4B5A D8              11      RET C
000B5B 4B5B FE0A             7      CP  10
000B5D 4B5D D0              11      RET NC
000B5E 4B5E 4D               4      LD  C,L
000B5F 4B5F 44               4      LD  B,H
000B60 4B60 29              11      ADD HL,HL   ;*2
000B61 4B61 29              11      ADD HL,HL   ;*4
000B62 4B62 09              11      ADD HL,BC   ;*5
000B63 4B63 29              11      ADD HL,HL   ;*10
000B64 4B64 4F               4      LD  C,A
000B65 4B65 0600             7      LD  B,0
000B67 4B67 09              11      ADD HL,BC
000B68 4B68 18EC            12      JR  GETNUM1
                                
       4B6A                     SEARCH_END:
000B6A 4B6A 7E               7      LD  A,(HL)
       4B6B                     SEARCH_END1:
000B6B 4B6B 23               6      INC HL
000B6C 4B6C B7               4      OR  A
000B6D 4B6D C8              11      RET Z
000B6E 4B6E FE3A             7      CP  ':'
000B70 4B70 20F8            12      JR  NZ,SEARCH_END
000B72 4B72 7E               7      LD  A,(HL)
000B73 4B73 FE3A             7      CP  ':'
000B75 4B75 28F4            12      JR  Z,SEARCH_END1
000B77 4B77 C9              10      RET
                                
       4B78                     FKANC:
000B78 4B78 CB41             8      BIT 0,C
000B7A 4B7A CC9D4B          17      CALL    Z,CAP2
000B7D 4B7D 1803            12      JR  FKANX
       4B7F                     FKAN:           ;漢字チェック
000B7F 4B7F DD23            10      INC IX
000B81 4B81 1D               4      DEC E
       4B82                     FKANX:
000B82 4B82 CB41             8      BIT 0,C
000B84 4B84 CB81             8      RES 0,C
000B86 4B86 C0              11      RET NZ
000B87 4B87 FE80             7      CP  080H
000B89 4B89 D8              11      RET C
000B8A 4B8A FEA0             7      CP  0A0H
000B8C 4B8C 3803            12      JR  C,FKAN1
000B8E 4B8E FEE0             7      CP  0E0H
000B90 4B90 D8              11      RET C
       4B91                     FKAN1:
000B91 4B91 0C               4      INC C
000B92 4B92 A7               4      AND A
000B93 4B93 C9              10      RET
                                
       4B94                     CAP:
000B94 4B94 FE61             7      CP  'a'
000B96 4B96 D8              11      RET C
000B97 4B97 FE7B             7      CP  'z'+1
000B99 4B99 D0              11      RET NC
000B9A 4B9A D620             7      SUB 020H
000B9C 4B9C C9              10      RET
       4B9D                     CAP2:
000B9D 4B9D CD944B          17      CALL    CAP
       4BA0                     CAP3:               ;
000BA0 4BA0 FE05             7      CP  5
000BA2 4BA2 2803            12      JR  Z,CAP4
000BA4 4BA4 FE21             7      CP  021H
000BA6 4BA6 C9              10      RET
       4BA7                     CAP4:
000BA7 4BA7 3EE5             7      LD  A,0E5H
000BA9 4BA9 C9              10      RET
                                
       4BAA                     ROM_OPEN:
000BAA 4BAA CDC251          17      CALL    GET_DISK_BANK_FDRV
                                
000BAD 4BAD CD084E          17      CALL    GET_DIR_DAT
000BB0 4BB0 D5              11      PUSH    DE
000BB1 4BB1 CDC64B          17      CALL    FILESE
000BB4 4BB4 D1              10      POP DE
000BB5 4BB5 3F               4      CCF
000BB6 4BB6 D8              11      RET C
000BB7 4BB7 22E0F2          16      LD  (DIRENT1),HL
000BBA 4BBA E5              11      PUSH    HL
000BBB 4BBB 210000          10      LD  HL,0
000BBE 4BBE 22BDF2          16      LD  (RR_LOW),HL
000BC1 4BC1 22BFF2          16      LD  (RR_HIGH),HL
000BC4 4BC4 E1              10      POP HL
000BC5 4BC5 C9              10      RET
                                
       4BC6                     FILESE:
       4BC6                     FILESE0:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000BC6 4BC6 7E               7      LD  A,(HL)
                                #endif
000BC7 4BC7 B7               4      OR  A
000BC8 4BC8 C8              11      RET Z       ;END:ZF=1 CF=0
000BC9 4BC9 FEE5             7      CP  0E5H
000BCB 4BCB 280D            12      JR  Z,FILESE1
000BCD 4BCD 11ECF2          10      LD  DE,FNAME
000BD0 4BD0 E5              11      PUSH    HL
000BD1 4BD1 CD174C          17      CALL    CPFILE
000BD4 4BD4 CC384C          17      CALL    Z,CPFILE2
000BD7 4BD7 E1              10      POP HL
000BD8 4BD8 37               4      SCF
000BD9 4BD9 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4BDA                     FILESE1:
000BDA 4BDA CDE24B          17      CALL    FNEXT
000BDD 4BDD 20E7            12      JR  NZ,FILESE0
000BDF 4BDF F6FF             7      OR  0FFH        ;ZF=0 CF=0
000BE1 4BE1 C9              10      RET
                                
       4BE2                     FNEXT:
000BE2 4BE2 112000          10      LD  DE,020H
000BE5 4BE5 19              11      ADD HL,DE
000BE6 4BE6 ED5BE9F2        20      LD  DE,(_CDX)
000BEA 4BEA 7A               4      LD  A,D
000BEB 4BEB B3               4      OR  E
000BEC 4BEC 2019            12      JR  NZ,FNEXT_SUBDIR
000BEE 4BEE 0D               4      DEC C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
       4BEF                     CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
000BEF 4BEF F5              11      PUSH    AF      ;※フラグを保存する必要あり
000BF0 4BF0 CB7C             8      BIT 7,H
000BF2 4BF2 2811            12      JR  Z,CHECK_DIR_PAGE1
000BF4 4BF4 7C               4      LD  A,H
000BF5 4BF5 D620             7      SUB 020H
000BF7 4BF7 67               4      LD  H,A
000BF8 4BF8 3AE2F2          13      LD  A,(_DIR_BANK)
000BFB 4BFB 3C               4      INC A
000BFC 4BFC 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000BFF 4BFF 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000C02 4C02 32E2F2          13      LD  (_DIR_BANK),A
       4C05                     CHECK_DIR_PAGE1:
000C05 4C05 F1              10      POP AF
                                #endif
000C06 4C06 C9              10      RET
                                
       4C07                     FNEXT_SUBDIR:           ;サブディレクトリ
000C07 4C07 0D               4      DEC C
000C08 4C08 C0              11      RET NZ
                                
000C09 4C09 ED5BE9F2        20      LD  DE,(_CDX)
000C0D 4C0D CD3F4D          17      CALL    GNCL
000C10 4C10 EB               4      EX  DE,HL
000C11 4C11 22E9F2          16      LD  (_CDX),HL
000C14 4C14 C3444E          10      JP  GET_SUBDIR
                                
       4C17                     CPFILE:
000C17 4C17 C5              11      PUSH    BC
000C18 4C18 01000B          10      LD  BC,00B00H
       4C1B                     CPSTR1:
000C1B 4C1B 1A               7      LD  A,(DE)
000C1C 4C1C FE3F             7      CP  '?'     ;Wild card
000C1E 4C1E 2812            12      JR  Z,CPSTR2
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000C20 4C20 7E               7      LD  A,(HL)
                                #endif
000C21 4C21 CD784B          17      CALL    FKANC
000C24 4C24 E5              11      PUSH    HL
000C25 4C25 67               4      LD  H,A
000C26 4C26 1A               7      LD  A,(DE)
000C27 4C27 CB01             4      RLC C
000C29 4C29 CD784B          17      CALL    FKANC
000C2C 4C2C CB09             4      RRC C
000C2E 4C2E BC               4      CP  H       ;CP (HL),(DE)
000C2F 4C2F E1              10      POP HL
000C30 4C30 2004            12      JR  NZ,CPSTR3
       4C32                     CPSTR2:
000C32 4C32 13               6      INC DE
000C33 4C33 23               6      INC HL
000C34 4C34 10E5            13      DJNZ    CPSTR1
       4C36                     CPSTR3:
000C36 4C36 C1              10      POP BC
000C37 4C37 C9              10      RET
                                
       4C38                     CPFILE2:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000C38 4C38 7E               7      LD  A,(HL)
                                #endif
000C39 4C39 E608             7      AND 008H    ;~0F7H
000C3B 4C3B C9              10      RET
                                
       4C3C                     RBX1:
000C3C 4C3C E5              11      PUSH    HL      ;Record byte
                                
000C3D 4C3D ED5BBDF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000C41 4C41 3AC0F2          13      LD  A,(RR_HIGH+1)
000C44 4C44 4F               4      LD  C,A
                                
000C45 4C45 3AE2F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001CH
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    CALL    RDSLT_ROM
                                    EX  DE,HL       ;AHL=File size
                                    POP DE
                                #else
000C48 4C48 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C4B 4C4B 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000C4E 4C4E FD2AE0F2        20      LD  IY,(DIRENT1)
000C52 4C52 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000C55 4C55 FD661D          19      LD  H,(IY+01DH)
000C58 4C58 FD7E1E          19      LD  A,(IY+01EH)
                                #endif
                                
000C5B 4C5B A7               4      AND A
000C5C 4C5C ED52            15      SBC HL,DE
000C5E 4C5E 99               4      SBC A,C
000C5F 4C5F D1              10      POP DE
                                
000C60 4C60 D8              11      RET C
000C61 4C61 4F               4      LD  C,A
000C62 4C62 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000C63 4C63 B2               4      OR  D
000C64 4C64 B3               4      OR  E
000C65 4C65 C0              11      RET NZ
000C66 4C66 37               4      SCF
000C67 4C67 C9              10      RET
                                
       4C68                     RBX2:
000C68 4C68 ED4BBEF2        20      LD  BC,(RR_LOW+1)
000C6C 4C6C CDF04C          17      CALL    RWXR
000C6F 4C6F 3ABAF2          13      LD  A,(CLSZ_H)
000C72 4C72 3D               4      DEC A
000C73 4C73 E5              11      PUSH    HL
000C74 4C74 2ABDF2          16      LD  HL,(RR_LOW)
000C77 4C77 A4               4      AND H
000C78 4C78 B5               4      OR  L
000C79 4C79 E1              10      POP HL
000C7A 4C7A C9              10      RET
                                
       4C7B                     RBXA:
000C7B 4C7B D5              11      PUSH    DE
000C7C 4C7C CD624D          17      CALL    CLUST
000C7F 4C7F ED53C5F2        20      LD  (_DTPS),DE
000C83 4C83 D1              10      POP DE
000C84 4C84 CD3F4D          17      CALL    GNCL
000C87 4C87 D8              11      RET C
000C88 4C88 ED53C1F2        20      LD  (_CLPS),DE
                                
000C8C 4C8C ED4BBDF2        20      LD  BC,(RR_LOW)
000C90 4C90 2AB9F2          16      LD  HL,(CLSZ)
000C93 4C93 7C               4      LD  A,H
000C94 4C94 3D               4      DEC A
000C95 4C95 A0               4      AND B
000C96 4C96 47               4      LD  B,A
000C97 4C97 ED42            15      SBC HL,BC       ;remaining cluster
                                
000C99 4C99 ED5BE3F2        20      LD  DE,(LEFTX)
000C9D 4C9D ED52            15      SBC HL,DE       ;CP HL,DE
000C9F 4C9F 19              11      ADD HL,DE
000CA0 4CA0 3801            12      JR  C,RBXA1
000CA2 4CA2 EB               4      EX  DE,HL
       4CA3                     RBXA1:
000CA3 4CA3 3AB7F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
000CA6 4CA6 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000CA9 4CA9 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000CAC 4CAC E5              11      PUSH    HL
000CAD 4CAD 2AC5F2          16      LD  HL,(_DTPS)
000CB0 4CB0 09              11      ADD HL,BC
000CB1 4CB1 ED5BDAF2        20      LD  DE,(DTAX)
000CB5 4CB5 C1              10      POP BC
000CB6 4CB6 C9              10      RET
                                
       4CB7                     RBXB:
000CB7 4CB7 2ADAF2          16      LD  HL,(DTAX)
000CBA 4CBA ED5BC1F2        20      LD  DE,(_CLPS)
000CBE 4CBE 3AE4F2          13      LD  A,(LEFTX+1)
000CC1 4CC1 47               4      LD  B,A
000CC2 4CC2 3ABAF2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4CC5                     RBXB1:
000CC5 4CC5 1F               4      RRA     ;->CF
000CC6 4CC6 3804            12      JR  C,RBXB2
000CC8 4CC8 CB38             8      SRL B   ;B=B/2
000CCA 4CCA 18F9            12      JR  RBXB1
       4CCC                     RBXB2:
000CCC 4CCC 78               4      LD  A,B
000CCD 4CCD B7               4      OR  A
000CCE 4CCE C9              10      RET
                                
       4CCF                     RBXC:
000CCF 4CCF ED4BE3F2        20      LD  BC,(LEFTX)
000CD3 4CD3 3ABAF2          13      LD  A,(CLSZ_H)
000CD6 4CD6 3D               4      DEC A
000CD7 4CD7 A0               4      AND B
000CD8 4CD8 47               4      LD  B,A
000CD9 4CD9 B1               4      OR  C
000CDA 4CDA C9              10      RET
                                
       4CDB                     RBXEND:
000CDB 4CDB ED5BC3F2        20      LD  DE,(_LEFT)
000CDF 4CDF 2ABDF2          16      LD  HL,(RR_LOW)
000CE2 4CE2 3AC0F2          13      LD  A,(RR_HIGH+1)
000CE5 4CE5 19              11      ADD HL,DE
000CE6 4CE6 CE00             7      ADC A,0
000CE8 4CE8 22BDF2          16      LD  (RR_LOW),HL
000CEB 4CEB 32C0F2          13      LD  (RR_HIGH+1),A
000CEE 4CEE EB               4      EX  DE,HL       ;HL=Read byte
000CEF 4CEF C9              10      RET 
                                
       4CF0                     RWXR:
000CF0 4CF0 3ABAF2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4CF3                     L_RWX:
000CF3 4CF3 1F               4      RRA     ;->CF
000CF4 4CF4 3806            12      JR  C,E_RWX
000CF6 4CF6 CB38             8      SRL B   ;BC=BC/2
000CF8 4CF8 CB19             8      RR  C   ;
000CFA 4CFA 18F7            12      JR  L_RWX
       4CFC                     E_RWX:
000CFC 4CFC 3AE2F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
                                    PUSH    HL
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    POP HL
                                #else
000CFF 4CFF 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D02 4D02 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D05 4D05 FD2AE0F2        20      LD  IY,(DIRENT1)
000D09 4D09 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000D0C 4D0C FD561B          19      LD  D,(IY+01BH)
                                #endif
000D0F 4D0F CDC251          17      CALL    GET_DISK_BANK_FDRV
       4D12                     RWX1:
000D12 4D12 ED53C1F2        20      LD  (_CLPS),DE
000D16 4D16 7A               4      LD  A,D
000D17 4D17 B3               4      OR  E
000D18 4D18 37               4      SCF
000D19 4D19 C8              11      RET Z
                                
000D1A 4D1A 78               4      LD  A,B
000D1B 4D1B B1               4      OR  C
000D1C 4D1C C8              11      RET Z
                                
000D1D 4D1D CD3F4D          17      CALL    GNCL
000D20 4D20 D8              11      RET C
000D21 4D21 0B               6      DEC BC
000D22 4D22 CDA14D          17      CALL    ENDCL
000D25 4D25 38EB            12      JR  C,RWX1
000D27 4D27 37               4      SCF
000D28 4D28 C9              10      RET
                                
       4D29                     NCL3:
000D29 4D29 CDC251          17      CALL    GET_DISK_BANK_FDRV
000D2C 4D2C 6B               4      LD  L,E
000D2D 4D2D 62               4      LD  H,D
000D2E 4D2E CB3C             8      SRL H
000D30 4D30 CB1D             8      RR  L
000D32 4D32 1F               4      RRA
000D33 4D33 19              11      ADD HL,DE
000D34 4D34 010060          10      LD  BC,BANK1_ADR
000D37 4D37 09              11      ADD HL,BC
000D38 4D38 ED4BBBF2        20      LD  BC,(SECSZ)
000D3C 4D3C 09              11      ADD HL,BC
000D3D 4D3D 17               4      RLA
000D3E 4D3E C9              10      RET
                                
       4D3F                     GNCL:
000D3F 4D3F 7A               4      LD  A,D
000D40 4D40 B3               4      OR  E
000D41 4D41 37               4      SCF
000D42 4D42 C8              11      RET Z
000D43 4D43 C5              11      PUSH    BC
000D44 4D44 E5              11      PUSH    HL
000D45 4D45 CD294D          17      CALL    NCL3
000D48 4D48 3809            12      JR  C,GNC1
000D4A 4D4A 5E               7      LD  E,(HL)
000D4B 4D4B 23               6      INC HL
000D4C 4D4C 7E               7      LD  A,(HL)
000D4D 4D4D E60F             7      AND 00FH
000D4F 4D4F 57               4      LD  D,A
000D50 4D50 E1              10      POP HL
000D51 4D51 C1              10      POP BC
000D52 4D52 C9              10      RET
       4D53                     GNC1:
000D53 4D53 7E               7      LD  A,(HL)
000D54 4D54 23               6      INC HL
000D55 4D55 56               7      LD  D,(HL)
000D56 4D56 0604             7      LD  B,4
       4D58                     GNC1L:
000D58 4D58 CB3A             8      SRL D
000D5A 4D5A 1F               4      RRA
000D5B 4D5B 10FB            13      DJNZ    GNC1L
                                
000D5D 4D5D 5F               4      LD  E,A
000D5E 4D5E E1              10      POP HL
000D5F 4D5F C1              10      POP BC
000D60 4D60 A7               4      AND A
000D61 4D61 C9              10      RET
                                
       4D62                     CLUST:
000D62 4D62 EB               4      EX  DE,HL
       4D63                     CLUST_HL:
000D63 4D63 2B               6      DEC HL
000D64 4D64 2B               6      DEC HL
000D65 4D65 C5              11      PUSH    BC
000D66 4D66 3ABAF2          13      LD  A,(CLSZ_H)
000D69 4D69 CDF251          17      CALL    MUL_AHL
                                
000D6C 4D6C CD254E          17      CALL    GET_DIR_POS
000D6F 4D6F 4F               4      LD  C,A
000D70 4D70 0600             7      LD  B,0
000D72 4D72 09              11      ADD HL,BC
                                
000D73 4D73 ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
000D77 4D77 CB38             8      SRL B
000D79 4D79 CB19             8      RR  C           ;/2
000D7B 4D7B CB38             8      SRL B
000D7D 4D7D CB19             8      RR  C           ;/4
000D7F 4D7F CB38             8      SRL B
000D81 4D81 CB19             8      RR  C           ;/8
000D83 4D83 09              11      ADD HL,BC
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  A,L
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    JR  NC,CLUST2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
000D84 4D84 4D               4      LD  C,L     ;C=読み出し元
000D85 4D85 29              11      ADD HL,HL   ;64KB→32KB
000D86 4D86 29              11      ADD HL,HL   ;32KB→16KB
000D87 4D87 29              11      ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
000D88 4D88 CDC251          17      CALL    GET_DISK_BANK_FDRV
000D8B 4D8B 84               4      ADD A,H
000D8C 4D8C 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D8F 4D8F 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D92 4D92 32B7F2          13      LD  (_BANK),A
000D95 4D95 69               4      LD  L,C     ;C=読み出し元
000D96 4D96 3E1F             7      LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
000D98 4D98 A5               4      AND L
                                #endif
       4D99                     CLUST2:
000D99 4D99 C660             7      ADD A,high BANK1_ADR
000D9B 4D9B 67               4      LD  H,A
000D9C 4D9C 2E00             7      LD  L,0
000D9E 4D9E EB               4      EX  DE,HL
000D9F 4D9F C1              10      POP BC
000DA0 4DA0 C9              10      RET
                                
       4DA1                     ENDCL:
000DA1 4DA1 7A               4      LD  A,D ;END CLUSTER
000DA2 4DA2 FE0F             7      CP  00FH    ;FAT12の最大値
000DA4 4DA4 C0              11      RET NZ
000DA5 4DA5 7B               4      LD  A,E
000DA6 4DA6 FEF7             7      CP  0F7H
000DA8 4DA8 C9              10      RET
                                
       4DA9                     RB_READ:
000DA9 4DA9 AF               4      XOR A   ;HLA = HL*128
000DAA 4DAA CB3C             8      SRL H
000DAC 4DAC CB1D             8      RR  L
000DAE 4DAE 1F               4      RRA
000DAF 4DAF 32BDF2          13      LD  (RR_LOW),A
000DB2 4DB2 22BEF2          16      LD  (RR_MID),HL
000DB5 4DB5 218000          10      LD  HL,128
                                
000DB8 4DB8 CD8A49          17      CALL    ROM_READ
000DBB 4DBB C9              10      RET
                                
       4DBC                     GETSEQ:
000DBC 4DBC FD6E20          19      LD  L,(IY+32)
000DBF 4DBF FD660C          19      LD  H,(IY+12)
                                
000DC2 4DC2 CB25             8      SLA L
                                
000DC4 4DC4 CB3C             8      SRL H
000DC6 4DC6 CB1D             8      RR  L
000DC8 4DC8 C9              10      RET
                                
       4DC9                     SETSEQ:
000DC9 4DC9 F5              11      PUSH    AF
000DCA 4DCA 3ABDF2          13      LD  A,(RR_LOW)
000DCD 4DCD 2ABEF2          16      LD  HL,(RR_MID)
                                
000DD0 4DD0 CDE74D          17      CALL    SSQ1
                                
000DD3 4DD3 29              11      ADD HL,HL
000DD4 4DD4 CB3D             8      SRL L
000DD6 4DD6 FD7520          19      LD  (IY+32),L
000DD9 4DD9 FD740C          19      LD  (IY+12),H
000DDC 4DDC F1              10      POP AF
000DDD 4DDD C9              10      RET
                                
       4DDE                     GETSIZE:
000DDE 4DDE FD7E10          19      LD  A,(IY+16)
000DE1 4DE1 FD6E11          19      LD  L,(IY+17)
000DE4 4DE4 FD6612          19      LD  H,(IY+18)
       4DE7                     SSQ1:
000DE7 4DE7 87               4      ADD A,A
000DE8 4DE8 ED6A            15      ADC HL,HL
000DEA 4DEA B7               4      OR  A
000DEB 4DEB C8              11      RET Z
000DEC 4DEC 23               6      INC HL
000DED 4DED C9              10      RET
                                
       4DEE                     SET_FCB:
000DEE 4DEE D5              11      PUSH    DE
000DEF 4DEF FDE1            14      POP IY
000DF1 4DF1 FD7E1C          19      LD  A,(IY+28)
000DF4 4DF4 FEFF             7      CP  0FFH
000DF6 4DF6 200C            12      JR  NZ,POPAF_SCF_FF_RET
000DF8 4DF8 E5              11      PUSH    HL
000DF9 4DF9 FD6E1A          19      LD  L,(IY+26)
000DFC 4DFC FD661B          19      LD  H,(IY+27)
000DFF 4DFF 22C1F2          16      LD  (_CLPS),HL
000E02 4E02 E1              10      POP HL
000E03 4E03 C9              10      RET
                                
       4E04                     POPAF_SCF_FF_RET:
000E04 4E04 F1              10      POP AF
000E05 4E05 37               4      SCF
000E06 4E06 9F               4      SBC A,A
000E07 4E07 C9              10      RET
                                
       4E08                     GET_DIR_DAT:
000E08 4E08 2AE9F2          16      LD  HL,(_CDX)
000E0B 4E0B 7C               4      LD  A,H
000E0C 4E0C B5               4      OR  L
000E0D 4E0D 2035            12      JR  NZ,GET_SUBDIR
000E0F 4E0F CD254E          17      CALL    GET_DIR_POS
000E12 4E12 C660             7      ADD A,high BANK1_ADR
000E14 4E14 2E00             7      LD  L,0
000E16 4E16 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
000E17 4E17 CDEF4B          17      CALL    CHECK_DIR_PAGE
                                #endif
000E1A 4E1A 3AB8F2          13      LD  A,(_BANK1)
000E1D 4E1D 32E2F2          13      LD  (_DIR_BANK),A
                                
000E20 4E20 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000E23 4E23 4F               4      LD  C,A
000E24 4E24 C9              10      RET
                                
       4E25                     GET_DIR_POS:                ;ルートディレクトリ
000E25 4E25 CDC251          17      CALL    GET_DISK_BANK_FDRV
000E28 4E28 32B8F2          13      LD  (_BANK1),A
000E2B 4E2B 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000E2E 4E2E 47               4      LD  B,A
000E2F 4E2F 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000E32 4E32 4F               4      LD  C,A
000E33 4E33 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4E36                     GET_DIR_POS1:
000E36 4E36 81               4      ADD A,C
000E37 4E37 10FD            13      DJNZ    GET_DIR_POS1
                                
000E39 4E39 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
000E3D 4E3D 37               4      SCF     ;無限ループ回避
       4E3E                     L_MDP:
000E3E 4E3E CB18             8      RR  B   ;->CF
000E40 4E40 D8              11      RET C
000E41 4E41 87               4      ADD A,A
000E42 4E42 18FA            12      JR  L_MDP
                                
       4E44                     GET_SUBDIR:             ;サブディレクトリ
000E44 4E44 CD634D          17      CALL    CLUST_HL
000E47 4E47 EB               4      EX  DE,HL
000E48 4E48 3AB7F2          13      LD  A,(_BANK)
000E4B 4E4B 32E2F2          13      LD  (_DIR_BANK),A
000E4E 4E4E 3ABAF2          13      LD  A,(CLSZ_H)
000E51 4E51 87               4      ADD A,A     ;*2
000E52 4E52 87               4      ADD A,A     ;*4
000E53 4E53 87               4      ADD A,A     ;*8
000E54 4E54 4F               4      LD  C,A
000E55 4E55 C9              10      RET
                                
       4E56                     STATEMENT:
000E56 4E56 11DF4F          10      LD  DE,STR_CHDIR
000E59 4E59 CDC54F          17      CALL    CPPROCNM
000E5C 4E5C 2812            12      JR  Z,_CHDIR
000E5E 4E5E 11E54F          10      LD  DE,STR_CHDRV
000E61 4E61 CDC54F          17      CALL    CPPROCNM
000E64 4E64 281C            12      JR  Z,_CHDRV
000E66 4E66 11EB4F          10      LD  DE,STR_RAMDISK
000E69 4E69 CDC54F          17      CALL    CPPROCNM
000E6C 4E6C 2829            12      JR  Z,_RAMDISK
000E6E 4E6E 37               4      SCF
000E6F 4E6F C9              10      RET
       4E70                     _CHDIR:
000E70 4E70 7E               7      LD  A,(HL)
000E71 4E71 FE28             7      CP  '('
000E73 4E73 37               4      SCF
000E74 4E74 C0              11      RET NZ
000E75 4E75 CD3847          17      CALL    INIT_PARAM
000E78 4E78 CD2B4A          17      CALL    FILE_B
000E7B 4E7B CDAB4E          17      CALL    ROM_CD
000E7E 4E7E D0              11      RET NC
000E7F 4E7F C3E245          10      JP  ERROR_FILE_NOT_FOUND
                                
       4E82                     _CHDRV:
000E82 4E82 7E               7      LD  A,(HL)
000E83 4E83 FE28             7      CP  '('
000E85 4E85 37               4      SCF
000E86 4E86 C0              11      RET NZ
000E87 4E87 CD3847          17      CALL    INIT_PARAM
000E8A 4E8A E5              11      PUSH    HL
000E8B 4E8B CD2B4A          17      CALL    FILE_B
000E8E 4E8E E1              10      POP HL
000E8F 4E8F 23               6      INC HL
000E90 4E90 3AEBF2          13      LD  A,(FDRV)
000E93 4E93 3D               4      DEC A
000E94 4E94 C32B54          10      JP  _SYS0EX1
                                
       4E97                     _RAMDISK:
000E97 4E97 7E               7      LD  A,(HL)
000E98 4E98 FE28             7      CP  '('
000E9A 4E9A 37               4      SCF
000E9B 4E9B C0              11      RET NZ
000E9C 4E9C 23               6      INC HL
000E9D 4E9D DD212F54        14      LD  IX,FRMQNT
000EA1 4EA1 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000EA5 4EA5 CD1C00          17      CALL    _CALSLT
                                ;   LD  A,(HOKVLD)  ;bit0: 拡張 BIOSの存在
                                ;   CPL
                                ;   AND 1
                                ;   LD  A,D
                                ;   OR  E
                                ;   JP  NZ,ERROR_INTERNAL_ERROR
                                ;   PUSH    HL      ;EXTBIOもDISK BIOSで初期化してそう
                                ;   XOR A
                                ;   LD  DE,0401H    ;D=マッパサポートルチン(4) E=機能番号(1)
                                ;   CALL    EXTBIO
                                ;   POP HL
                                ;   OR  A
                                ;   JP  Z,ERROR_INTERNAL_ERROR
000EA8 4EA8 23               6      INC HL
000EA9 4EA9 AF               4      XOR A
000EAA 4EAA C9              10      RET
                                
       4EAB                     ROM_CD:
000EAB 4EAB 3AECF2          13      LD  A,(FNAME)
000EAE 4EAE FE20             7      CP  020H
000EB0 4EB0 2822            12      JR  Z,CD1
000EB2 4EB2 CDAA4B          17      CALL    ROM_OPEN
000EB5 4EB5 D8              11      RET C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
000EB6 4EB6 FD2AE0F2        20      LD  IY,(DIRENT1)
000EBA 4EBA FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
000EBE 4EBE CAE245          10      JP  Z,ERROR_FILE_NOT_FOUND
000EC1 4EC1 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000EC4 4EC4 FD661B          19      LD  H,(IY+01BH)
                                #endif
       4EC7                     CD2:
000EC7 4EC7 22DEF2          16      LD  (_CD),HL
000ECA 4ECA 2AE7F2          16      LD  HL,(PARAM1)
       4ECD                     CD_SKIP:
000ECD 4ECD 7E               7      LD  A,(HL)
000ECE 4ECE 23               6      INC HL
000ECF 4ECF FE21             7      CP  021H
000ED1 4ED1 38FA            12      JR  C,CD_SKIP
000ED3 4ED3 C9              10      RET
       4ED4                     CD1:
000ED4 4ED4 2AE9F2          16      LD  HL,(_CDX)
000ED7 4ED7 18EE            12      JR  CD2
                                
       4ED9                     GET_BASIC_FCB:
000ED9 4ED9 D5              11      PUSH    DE
000EDA 4EDA 23               6      INC HL  ;+1
000EDB 4EDB 5E               7      LD  E,(HL)  ;FCB[1]
000EDC 4EDC 23               6      INC HL  ;+2
000EDD 4EDD 56               7      LD  D,(HL)  ;FCB[2]
000EDE 4EDE 23               6      INC HL  ;+3
000EDF 4EDF ED53E0F2        20      LD  (DIRENT1),DE
                                            ;FCB[3]
000EE3 4EE3 23               6      INC HL  ;+4
                                            ;FCB[4]
000EE4 4EE4 23               6      INC HL  ;+5
000EE5 4EE5 7E               7      LD  A,(HL)  ;FCB[5]
000EE6 4EE6 23               6      INC HL  ;+6
000EE7 4EE7 32E2F2          13      LD  (_DIR_BANK),A
000EEA 4EEA 5E               7      LD  E,(HL)  ;FCB[6]
000EEB 4EEB 23               6      INC HL  ;+7
000EEC 4EEC 56               7      LD  D,(HL)  ;FCB[7]
000EED 4EED 23               6      INC HL  ;+8
000EEE 4EEE ED53BDF2        20      LD  (RR_LOW),DE
000EF2 4EF2 7E               7      LD  A,(HL)  ;FCB[8]
000EF3 4EF3 23               6      INC HL  ;+9
000EF4 4EF4 32BFF2          13      LD  (RR_HIGH),A
000EF7 4EF7 7E               7      LD  A,(HL)  ;FCB[9]
000EF8 4EF8 23               6      INC HL  ;+10
000EF9 4EF9 22C7F2          16      LD  (_DTA),HL   ;FCB[10]
000EFC 4EFC D1              10      POP DE
000EFD 4EFD C9              10      RET
                                
       4EFE                     SET_BASIC_FCB:
000EFE 4EFE E5              11      PUSH    HL
000EFF 4EFF 2A64F8          16      LD  HL,(PTRFIL)
000F02 4F02 23               6      INC HL  ;+1
000F03 4F03 D5              11      PUSH    DE
000F04 4F04 ED5BE0F2        20      LD  DE,(DIRENT1)
000F08 4F08 73               7      LD  (HL),E  ;FCB[1]
000F09 4F09 23               6      INC HL  ;+2
000F0A 4F0A 72               7      LD  (HL),D  ;FCB[2]
000F0B 4F0B 23               6      INC HL  ;+3
000F0C 4F0C AF               4      XOR A
000F0D 4F0D 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
000F0E 4F0E 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
000F0F 4F0F 23               6      INC HL  ;+5
000F10 4F10 3AE2F2          13      LD  A,(_DIR_BANK)
000F13 4F13 77               7      LD  (HL),A  ;FCB[5]
000F14 4F14 23               6      INC HL  ;+6
000F15 4F15 ED5BBDF2        20      LD  DE,(RR_LOW)
000F19 4F19 73               7      LD  (HL),E  ;FCB[6]
000F1A 4F1A 23               6      INC HL  ;+7
000F1B 4F1B 72               7      LD  (HL),D  ;FCB[7]
000F1C 4F1C 23               6      INC HL  ;+8
000F1D 4F1D 3ABFF2          13      LD  A,(RR_HIGH)
000F20 4F20 77               7      LD  (HL),A  ;FCB[8]
000F21 4F21 23               6      INC HL  ;+9
000F22 4F22 3600            10      LD  (HL),0  ;FCB[9]
000F24 4F24 D1              10      POP DE
000F25 4F25 E1              10      POP HL
000F26 4F26 C9              10      RET
                                
       4F27                     DEVICE_CHECK:
000F27 4F27 23               6      INC HL
000F28 4F28 7E               7      LD  A,(HL)
000F29 4F29 2B               6      DEC HL
000F2A 4F2A B7               4      OR  A
000F2B 4F2B C8              11      RET Z
000F2C 4F2C 11F34F          10      LD  DE,STR_ROM
000F2F 4F2F CDC54F          17      CALL    CPPROCNM
000F32 4F32 2802            12      JR  Z,DEVICE_OK
000F34 4F34 37               4      SCF
000F35 4F35 C9              10      RET
       4F36                     DEVICE_OK:
000F36 4F36 AF               4      XOR A
000F37 4F37 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファインデックス
                                ; +10: バッファ
                                
       4F38                     DEVICE_0_OPEN:
000F38 4F38 7B               4      LD  A,E
000F39 4F39 FE02             7      CP  2       ;FOR OUTPUT
000F3B 4F3B 281B            12      JR  Z,OPEN2
000F3D 4F3D D5              11      PUSH    DE
000F3E 4F3E E5              11      push    hl
                                ;
000F3F 4F3F 3E01             7      LD  A,1     ;ドライブA
000F41 4F41 32EBF2          13      LD  (FDRV),A
000F44 4F44 2166F8          10      LD  HL,FILNAM
000F47 4F47 11ECF2          10      LD  DE,FNAME
000F4A 4F4A 010B00          10      LD  BC,8+3
000F4D 4F4D CDA855          17      CALL    INIT_FILE1
000F50 4F50 CDAA4B          17      CALL    ROM_OPEN
000F53 4F53 DAE245          10      JP  C,ERROR_FILE_NOT_FOUND
000F56 4F56 E1              10      pop hl
000F57 4F57 D1              10      POP DE
       4F58                     OPEN2:
000F58 4F58 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
000F5B 4F5B 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
000F5C 4F5C AF               4      XOR A
000F5D 4F5D 32E3F2          13      LD  (LEFTX),A
000F60 4F60 CDFE4E          17      CALL    SET_BASIC_FCB
000F63 4F63 7B               4      ld  a,e
000F64 4F64 FE08             7      cp  8
000F66 4F66 3F               4      ccf
000F67 4F67 C9              10      ret
                                
       4F68                     DEVICE_2_CLOSE:
000F68 4F68 AF               4      XOR A
                                ;   LD  (HL),A
000F69 4F69 6F               4      LD  L,A
000F6A 4F6A 67               4      LD  H,A
000F6B 4F6B 2264F8          16      LD  (PTRFIL),HL
000F6E 4F6E C9              10      RET
                                
       4F6F                     DEVICE_ENTRY:
000F6F 4F6F FE08             7      CP  8
000F71 4F71 2812            12      JR  Z,DEVICE_8_SIN
000F73 4F73 3C               4      INC A
000F74 4F74 28B1            12      JR  Z,DEVICE_CHECK:
000F76 4F76 3D               4      DEC A
000F77 4F77 28BF            12      JR  Z,DEVICE_0_OPEN
000F79 4F79 FE02             7      CP  2
000F7B 4F7B 28EB            12      JR  Z,DEVICE_2_CLOSE
000F7D 4F7D FE06             7      CP  6
000F7F 4F7F 2802            12      JR  Z,DEVICE_6_SOUT
000F81 4F81 37               4      SCF
000F82 4F82 C9              10      RET
                                
       4F83                     DEVICE_6_SOUT:
000F83 4F83 AF               4      XOR A
000F84 4F84 C9              10      RET
                                
       4F85                     DEVICE_8_SIN:
000F85 4F85 CDD94E          17      CALL    GET_BASIC_FCB
000F88 4F88 E67F             7      AND 127
000F8A 4F8A 281D            12      JR  Z,SIN_READ_DISK
000F8C 4F8C 2AC7F2          16      LD  HL,(_DTA)
000F8F 4F8F 2B               6      DEC HL
000F90 4F90 34              11      INC (HL)
000F91 4F91 3C               4      INC A   ;(INC HL)
000F92 4F92 85               4      ADD A,L ;ADD HL,A
000F93 4F93 6F               4      LD  L,A ;
000F94 4F94 8C               4      ADC A,H ;
000F95 4F95 95               4      SUB L   ;
000F96 4F96 67               4      LD  H,A ;
       4F97                     SIN_READ1:
000F97 4F97 7E               7      LD  A,(HL)
000F98 4F98 FE0A             7      CP  00AH
000F9A 4F9A C8              11      RET Z   ;ZF=separate
000F9B 4F9B FE1A             7      CP  01AH
000F9D 4F9D 2803            12      JR  Z,SIN_EOF
000F9F 4F9F 37               4      SCF
000FA0 4FA0 3F               4      CCF     ;ZF=0 CF=0にしたい
000FA1 4FA1 C9              10      RET
       4FA2                     SIN_EOF:
000FA2 4FA2 2AC7F2          16      LD  HL,(_DTA)
000FA5 4FA5 2B               6      DEC HL
000FA6 4FA6 35              11      DEC (HL)
       4FA7                     SCF_RET:
000FA7 4FA7 37               4      SCF
000FA8 4FA8 C9              10      RET
                                
       4FA9                     SIN_READ_DISK:
000FA9 4FA9 218000          10      LD  HL,128
000FAC 4FAC CD8A49          17      CALL    ROM_READ
000FAF 4FAF CDFE4E          17      CALL    SET_BASIC_FCB
000FB2 4FB2 7C               4      LD  A,H
000FB3 4FB3 B5               4      OR  L
000FB4 4FB4 28F1            12      JR  Z,SCF_RET
000FB6 4FB6 ED5BC7F2        20      LD  DE,(_DTA)
000FBA 4FBA 19              11      ADD HL,DE
000FBB 4FBB 361A            10      LD  (HL),01AH
000FBD 4FBD 2AC7F2          16      LD  HL,(_DTA)
000FC0 4FC0 2B               6      DEC HL
000FC1 4FC1 34              11      INC (HL)
000FC2 4FC2 23               6      INC HL
000FC3 4FC3 18D2            12      JR  SIN_READ1
                                
       4FC5                     CPPROCNM:
000FC5 4FC5 E5              11      PUSH    HL
000FC6 4FC6 2189FD          10      LD  HL,PROCNM
       4FC9                     CPPROCNM1:
000FC9 4FC9 1A               7      LD  A,(DE)
000FCA 4FCA 13               6      INC DE
000FCB 4FCB BE               7      CP  (HL)
000FCC 4FCC 23               6      INC HL
000FCD 4FCD 2003            12      JR  NZ,CPPROCNM2
000FCF 4FCF B7               4      OR  A
000FD0 4FD0 20F7            12      JR  NZ,CPPROCNM1
       4FD2                     CPPROCNM2:
000FD2 4FD2 E1              10      POP HL
000FD3 4FD3 C9              10      RET
                                
       4FD4                     WILDCARD:
000FD4 4FD4 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       4FDF                     STR_CHDIR:
000FDF 4FDF 434844495200            DB  "CHDIR",0
       4FE5                     STR_CHDRV:
000FE5 4FE5 434844525600            DB  "CHDRV",0
       4FEB                     STR_RAMDISK:
000FEB 4FEB 52414D4449534B00        DB  "RAMDISK",0
       4FF3                     STR_ROM:
000FF3 4FF3 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4FF7                     ERROR_WRITE_PROTECTED:
000FF7 4FF7 3E00             7      LD  A,0     ;Write protected
000FF9 4FF9 C9              10      RET
       4FFA                     DISKIO:
000FFA 4FFA 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000FFC 4FFC 48               4      LD  C,B
000FFD 4FFD CDCC51          17      CALL    GET_DISK_BANK
       5000                     SETMAP1:        
001000 5000 E5              11      PUSH    HL
       5001                     DISKIO1:
001001 5001 C5              11      PUSH    BC      ;B=残りのセクタ数
001002 5002 D5              11      PUSH    DE      ;DE=セクタ番号
001003 5003 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
001004 5004 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
001005 5005 F5              11      PUSH    AF
001006 5006 3ABCF2          13      LD  A,(SECSZ_H)
001009 5009 CDF251          17      CALL    MUL_AHL
00100C 500C F1              10      POP AF
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  A,L
                                    PUSH    BC
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    POP BC
                                    JR  NC,DISKIO2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
00100D 500D 4D               4      LD  C,L     ;C=読み出し元
00100E 500E 29              11      ADD HL,HL       ;64KB→32KB
00100F 500F 29              11      ADD HL,HL       ;32KB→16KB
001010 5010 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
001011 5011 84               4      ADD A,H
001012 5012 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
001015 5015 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
001018 5018 32B7F2          13      LD  (_BANK),A
00101B 501B 79               4      LD  A,C     ;C=読み出し元
00101C 501C E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       501E                     DISKIO2:
00101E 501E C660             7      ADD A,high BANK1_ADR
001020 5020 67               4      LD  H,A
001021 5021 ED4BBBF2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
001025 5025 69               4      LD  L,C     ;C=0
001026 5026 CD0344          17      CALL    ROM_LDIR
001029 5029 EB               4      EX  DE,HL
00102A 502A F1              10      POP AF
00102B 502B D1              10      POP DE
00102C 502C 13               6      INC DE
00102D 502D C1              10      POP BC
00102E 502E 10D1            13      DJNZ    DISKIO1
001030 5030 41               4      LD  B,C
                                
001031 5031 E1              10      POP HL
001032 5032 AF               4      XOR A
                                
001033 5033 FB               4      EI
001034 5034 C9              10      RET
                                
       5035                     DSKCHG:
001035 5035 CD6E50          17      CALL    IS_BPB
001038 5038 3824            12      JR  C,NOTREADY
00103A 503A 3A23FB          13      LD  A,(DRVTBL+2)
00103D 503D B7               4      OR  A
00103E 503E 201A            12      JR  NZ,DSKCHG1
001040 5040 3A21FB          13      LD  A,(DRVTBL)
001043 5043 FE02             7      CP  2
001045 5045 2013            12      JR  NZ,DSKCHG1
001047 5047 CD6E50          17      CALL    IS_BPB
00104A 504A 300E            12      JR  NC,DSKCHG1
00104C 504C 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
00104E 504E 3221FB          13      LD  (DRVTBL),A
001051 5051 3223FB          13      LD  (DRVTBL+2),A
001054 5054 3A48F3          13      LD  A,(MASTERS)
001057 5057 3224FB          13      LD  (DRVTBL+3),A
       505A                     DSKCHG1:
00105A 505A AF               4      XOR A
00105B 505B 0601             7      LD  B,1
00105D 505D C9              10      RET
       505E                     NOTREADY:
00105E 505E 3E02             7      LD  A,2
001060 5060 37               4      SCF
001061 5061 C9              10      RET
                                
       5062                     NO_BPB:
001062 5062 E1              10      POP HL
001063 5063 23               6      INC HL
001064 5064 11F851          10      LD  DE,DPB2DD
001067 5067 011200          10      LD  BC,DPB2DD_E-DPB2DD
00106A 506A EDB0                    LDIR
00106C 506C AF               4      XOR A
00106D 506D C9              10      RET
                                
       506E                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
00106E 506E CDCC51          17      CALL    GET_DISK_BANK
                                
001071 5071 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
001074 5074 FE01             7      CP  1
001076 5076 D8              11      RET C
                                
001077 5077 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
00107A 507A C6FF             7      ADD A,0FFH
00107C 507C D8              11      RET C
                                
00107D 507D 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       5080                     IS_BPB1:
001080 5080 FE01             7      CP  1
001082 5082 C8              11      RET Z
001083 5083 FE02             7      CP  2
001085 5085 C8              11      RET Z
001086 5086 FE04             7      CP  4
001088 5088 C8              11      RET Z
001089 5089 37               4      SCF
00108A 508A C9              10      RET
                                
       508B                     GETDPB:
00108B 508B E5              11      PUSH    HL
00108C 508C CDCC51          17      CALL    GET_DISK_BANK
                                
00108F 508F 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
001092 5092 B7               4      OR  A
001093 5093 28CD            12      JR  Z,NO_BPB
001095 5095 DDE1            14      POP IX
001097 5097 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
00109A 509A 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
00109D 509D DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
0010A0 50A0 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
0010A3 50A3 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
0010A6 50A6 87               4      ADD A,A
0010A7 50A7 87               4      ADD A,A
0010A8 50A8 87               4      ADD A,A
0010A9 50A9 3D               4      DEC A
0010AA 50AA DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
0010AD 50AD 06FF             7      LD  B,-1
0010AF 50AF A7               4      AND A           ;無限ループ阻止
       50B0                     GETDPB1:
0010B0 50B0 04               4      INC B
0010B1 50B1 1F               4      RRA
0010B2 50B2 38FC            12      JR  C,GETDPB1
0010B4 50B4 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
0010B7 50B7 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0010BA 50BA 3D               4      DEC A
0010BB 50BB DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
0010BE 50BE A7               4      AND A           ;無限ループ阻止
0010BF 50BF 06FF             7      LD  B,-1
       50C1                     GETDPB2:
0010C1 50C1 04               4      INC B
0010C2 50C2 1F               4      RRA
0010C3 50C3 38FC            12      JR  C,GETDPB2
0010C5 50C5 04               4      INC B
0010C6 50C6 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
0010C9 50C9 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
0010CC 50CC DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
0010CF 50CF DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
0010D2 50D2 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
0010D5 50D5 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
0010D8 50D8 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
0010DB 50DB DD770B          19      LD  (IX+11),A       ;MAXENT
                                
0010DE 50DE ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
0010E2 50E2 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
0010E5 50E5 DD460A          19      LD  B,(IX+10)       ;FATCNT
0010E8 50E8 210000          10      LD  HL,0
       50EB                     GETDPB3:
0010EB 50EB 19              11      ADD HL,DE
0010EC 50EC 10FD            13      DJNZ    GETDPB3
       50EE                     GETDPB4:
0010EE 50EE DD5E08          19      LD  E,(IX+8)        ;FIRFAT
0010F1 50F1 DD5609          19      LD  D,(IX+9)        ;FIRFAT
0010F4 50F4 19              11      ADD HL,DE
0010F5 50F5 DD7511          19      LD  (IX+17),L       ;FIRDIR
0010F8 50F8 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
0010FB 50FB DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0010FE 50FE 87               4      ADD A,A
0010FF 50FF 87               4      ADD A,A
001100 5100 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       5103                     GETDPB5:
001103 5103 CB3B             8      SRL E
001105 5105 1F               4      RRA
001106 5106 30FB            12      JR  NC,GETDPB5
001108 5108 1600             7      LD  D,0
00110A 510A 19              11      ADD HL,DE
00110B 510B DD750C          19      LD  (IX+12),L       ;FIRREC
00110E 510E DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001111 5111 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
001114 5114 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
001117 5117 DD560D          19      LD  D,(IX+13)       ;FIRREC
00111A 511A A7               4      AND A
00111B 511B ED52            15      SBC HL,DE
                                
00111D 511D DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
001120 5120 3C               4      INC A
001121 5121 37               4      SCF             ;無限ループ阻止
       5122                     GETDPB6:
001122 5122 1F               4      RRA
001123 5123 3806            12      JR  C,GETDPB7
001125 5125 CB3C             8      SRL H
001127 5127 CB1D             8      RR  L
001129 5129 18F7            12      JR  GETDPB6
       512B                     GETDPB7:
00112B 512B 23               6      INC HL
00112C 512C DD750E          19      LD  (IX+14),L       ;MAXCLUS
00112F 512F DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       5132                     GETDPBD1:
001132 5132 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001135 5135 E6FC             7      AND 0FCH
001137 5137 C8              11      RET Z
                                
001138 5138 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
00113C 513C 37               4      SCF
00113D 513D DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
001141 5141 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
001144 5144 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
001148 5148 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
00114C 514C DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
001150 5150 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
001154 5154 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
001158 5158 DDCB1126        23      SLA (IX+17)         ;FIRDIR
00115C 515C DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
001160 5160 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
001163 5163 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
001166 5166 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001169 5169 87               4      ADD A,A
00116A 516A 87               4      ADD A,A
00116B 516B DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       516E                     GETDPBD5:
00116E 516E CB3B             8      SRL E
001170 5170 1F               4      RRA
001171 5171 30FB            12      JR  NC,GETDPBD5
001173 5173 1600             7      LD  D,0
001175 5175 19              11      ADD HL,DE
001176 5176 DD750C          19      LD  (IX+12),L       ;FIRREC
001179 5179 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
00117C 517C 18B4            12      JR  GETDPBD1
                                
       517E                     CHOICE:
00117E 517E 210000          10      LD  HL,0
001181 5181 C9              10      RET
                                
       5182                     DSKFMT:
001182 5182 AF               4      XOR A
001183 5183 37               4      SCF
       5184                     DSKSTP:
001184 5184 C9              10      RET
                                
       5185                     BASENT:
001185 5185 2A74F6          16      LD  HL,(STKTOP)
001188 5188 3A40F3          13      LD  A,(REBOOT)
00118B 518B C6FF             7      ADD A,0FFH
00118D 518D 3811            12      JR  C,REBOOT1
00118F 518F 210A52          10      LD  HL,AUTOEXEC
001192 5192 11EBF2          10      LD  DE,FDRV
001195 5195 010C00          10      LD  BC,1+8+3
001198 5198 EDB0                    LDIR
00119A 519A CDAA4B          17      CALL    ROM_OPEN
00119D 519D D42C45          17      CALL    NC,ROM_LOAD1
       51A0                     REBOOT1:
0011A0 51A0 211652          10      LD  HL,CMD_RUN
0011A3 51A3 111FF4          10      LD  DE,KBUF
0011A6 51A6 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
0011A9 51A9 D5              11      PUSH    DE
0011AA 51AA EDB0                    LDIR
0011AC 51AC 3004            12      JR  NC,REBOOT2
0011AE 51AE AF               4      XOR A
0011AF 51AF 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       51B2                     REBOOT2:
0011B2 51B2 E1              10      POP HL
0011B3 51B3 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0011B7 51B7 DD210146        14      LD  IX,NEWSTT
0011BB 51BB C31C00          10      JP  _CALSLT
                                
       51BE                     GETSLT:
0011BE 51BE 3A22FB          13      LD  A,(DRVTBL+1)
0011C1 51C1 C9              10      RET
                                
       51C2                     GET_DISK_BANK_FDRV:
0011C2 51C2 3AEBF2          13      LD  A,(FDRV)
0011C5 51C5 D601             7      SUB 1
0011C7 51C7 3003            12      JR  NC,GET_DISK_BANK
0011C9 51C9 3ADDF2          13      LD  A,(_DVSW)
       51CC                     GET_DISK_BANK:
0011CC 51CC FE07             7      CP  7       ;H:
0011CE 51CE 2801            12      JR  Z,SET_DISK_BANK_A
0011D0 51D0 B7               4      OR  A       ;A=DRIVE
       51D1                     SET_DISK_BANK_A:
0011D1 51D1 3E01             7      LD  A,DISK_BANK
0011D3 51D3 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
0011D5 51D5 3ADCF2          13      LD  A,(B_DRIVE)
                                #endif
       51D8                     SET_DISK_BANK:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0011D8 51D8 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0011DB 51DB 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0011DE 51DE F5              11      PUSH    AF
0011DF 51DF E5              11      PUSH    HL
0011E0 51E0 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
0011E3 51E3 22BBF2          16      LD  (SECSZ),HL
0011E6 51E6 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0011E9 51E9 CDF251          17      CALL    MUL_AHL
0011EC 51EC 22B9F2          16      LD  (CLSZ),HL
0011EF 51EF E1              10      POP HL
0011F0 51F0 F1              10      POP AF
0011F1 51F1 C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       51F2                     MUL_AHL:
0011F2 51F2 37               4      SCF     ;無限ループ回避
       51F3                     MUL_AHL1:
0011F3 51F3 1F               4      RRA     ;->CF
0011F4 51F4 D8              11      RET C
0011F5 51F5 29              11      ADD HL,HL
0011F6 51F6 18FB            12      JR  MUL_AHL1
                                
       51F8                     DPB2DD:
0011F8 51F8 F9                      DB  0F9H    ;MEDIA
0011F9 51F9 0002                    DW  00200H  ;SECSIZ
0011FB 51FB 0F                      DB  00FH    ;DIRMSK
0011FC 51FC 04                      DB  004H    ;DIRSHFT
0011FD 51FD 01                      DB  001H    ;CLUSMSK
0011FE 51FE 02                      DB  002H    ;CLUSSHFT
0011FF 51FF 0100                    DW  00001H  ;FIRFAT
001201 5201 02                      DB  002H    ;FATCNT
001202 5202 70                      DB  070H    ;MAXENT
001203 5203 0E00                    DW  0000EH  ;FIRREC
001205 5205 CA02                    DW  002CAH  ;MAXCLUS
001207 5207 03                      DB  003H    ;FATSIZ
001208 5208 0700                    DW  0007H   ;FIRDIR
       520A                     DPB2DD_E:
                                
       520A                     AUTOEXEC:
00120A 520A 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       5216                     CMD_RUN:
001216 5216 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DW  0F280H
                                #else
00121C 521C 40F2                    DW  0F240H
                                #endif
       521E                     CMD_CLEAR_E:
00121E 521E 3A8A00                  DB  03AH,08AH,0         ;RUN
       5221                     CMD_RUN_E:
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       5221                     POP_HL_ERROR:
001221 5221 E1              10      POP     HL
       5222                     _ERROR:
001222 5222 0600             7      LD  B,0
001224 5224 A7               4      AND A
001225 5225 C9              10      RET
                                
       5226                     ROM_BDOS:
001226 5226 E5              11      PUSH    HL
001227 5227 79               4      LD  A,C
001228 5228 87               4      ADD A,A
001229 5229 38F7            12      JR  C,_ERROR
00122B 522B 6F               4      LD  L,A
00122C 522C 265F             7      LD  H,high STABLE
00122E 522E 7E               7      LD  A,(HL)
00122F 522F 2C               4      INC L
001230 5230 66               7      LD  H,(HL)
001231 5231 6F               4      LD  L,A
001232 5232 E3              19      EX  (SP),HL
001233 5233 79               4      LD  A,C
001234 5234 C9              10      RET
                                
       5235                     _PRINT:
       5235                     PRINT:
001235 5235 7B               4      LD  A,E
001236 5236 1803            12      JR  MSG_A
                                
       5238                     _SYS01:     ;(BDOS)コンソール入力
001238 5238 CDAF52          17      CALL    _SYS07
       523B                     MSG_A:
00123B 523B FE03             7      CP  3
00123D 523D 2814            12      JR  Z,MSG_BR
       523F                     MSGA1:
00123F 523F F5              11      PUSH    AF
001240 5240 C5              11      PUSH    BC
001241 5241 D5              11      PUSH    DE
001242 5242 E5              11      PUSH    HL
001243 5243 DDE5            15      PUSH    IX
001245 5245 DD21A200        14      LD  IX,CHPUT
001249 5249 CDD442          17      CALL    CALSLT_R
00124C 524C DDE1            14      POP IX
00124E 524E E1              10      POP HL
00124F 524F D1              10      POP DE
001250 5250 C1              10      POP BC
       5251                     MSGA2:
001251 5251 F1              10      POP AF
001252 5252 C9              10      RET
       5253                     MSG_BR:
001253 5253 F5              11      PUSH    AF
001254 5254 3ADDF3          13      LD  A,(CSRX)
001257 5257 FE02             7      CP  2
001259 5259 38F6            12      JR  C,MSGA2
00125B 525B F1              10      POP AF
       525C                     MSG_CR:
00125C 525C F5              11      PUSH    AF
00125D 525D 3E0D             7      LD  A,00DH
00125F 525F CD3F52          17      CALL    MSGA1
001262 5262 3E0A             7      LD  A,00AH
001264 5264 CD3F52          17      CALL    MSGA1
001267 5267 F1              10      POP AF
001268 5268 C9              10      RET
                                
       5269                     _SYS02:     ;(BDOS)コンソール出力
001269 5269 CD8452          17      CALL    BREAK
00126C 526C 1805            12      JR  PRINTX
                                
       526E                     _SYS06:     ;(BDOS)コンソール直接入出力
00126E 526E 7B               4      LD  A,E
00126F 526F 3C               4      INC A
001270 5270 CAC352          10      JP  Z,_INKEY
       5273                     PRINTX:
001273 5273 C33552          10      JP  _PRINT
                                
       5276                     _SYS08:     ;(BDOS)エコーなしコンソール入力
001276 5276 CDAF52          17      CALL    _SYS07
001279 5279 FE03             7      CP  3
00127B 527B CC8452          17      CALL    Z,_BREAK
00127E 527E FE13             7      CP  013H        ;CTRL+S
001280 5280 C0              11      RET NZ
       5281                     PAUSE:
001281 5281 CD9B52          17      CALL    KEYBC
                                
       5284                     _BREAK:
       5284                     BREAK:
001284 5284 F5              11      PUSH    AF
001285 5285 C5              11      PUSH    BC
001286 5286 D5              11      PUSH    DE
001287 5287 E5              11      PUSH    HL
001288 5288 DDE5            15      PUSH    IX
00128A 528A DD21B700        14      LD  IX,BREAKX
00128E 528E CDD442          17      CALL    CALSLT_R
001291 5291 DDE1            14      POP IX
001293 5293 E1              10      POP HL
001294 5294 D1              10      POP DE
001295 5295 C1              10      POP BC
001296 5296 DC8452          17      CALL    C,_BREAK
001299 5299 F1              10      POP AF
00129A 529A C9              10      RET
       529B                     KEYBC:
00129B 529B F5              11      PUSH    AF
00129C 529C C5              11      PUSH    BC
00129D 529D D5              11      PUSH    DE
00129E 529E E5              11      PUSH    HL
00129F 529F DDE5            15      PUSH    IX
0012A1 52A1 DD215601        14      LD  IX,KILBUF
0012A5 52A5 CDD442          17      CALL    CALSLT_R
0012A8 52A8 DDE1            14      POP IX
0012AA 52AA E1              10      POP HL
0012AB 52AB D1              10      POP DE
0012AC 52AC C1              10      POP BC
0012AD 52AD F1              10      POP AF
0012AE 52AE C9              10      RET
                                
       52AF                     _SYS07:
       52AF                     FLGET:
0012AF 52AF C5              11      PUSH    BC
0012B0 52B0 D5              11      PUSH    DE
0012B1 52B1 E5              11      PUSH    HL
0012B2 52B2 DDE5            15      PUSH    IX
0012B4 52B4 DD219F00        14      LD  IX,CHGET
0012B8 52B8 CDD442          17      CALL    CALSLT_R
0012BB 52BB DDE1            14      POP IX
0012BD 52BD E1              10      POP HL
0012BE 52BE D1              10      POP DE
0012BF 52BF C1              10      POP BC
0012C0 52C0 FE03             7      CP  3
0012C2 52C2 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       52C3                     _INKEY:
       52C3                     INKEY:
0012C3 52C3 CD5D53          17      CALL    CPM_CONST
0012C6 52C6 C8              11      RET Z
0012C7 52C7 18E6            12      JR  FLGET
                                
       52C9                     _SYS0A:     ;(BDOS)文字列入力
0012C9 52C9 C5              11      PUSH    BC
0012CA 52CA E5              11      PUSH    HL
0012CB 52CB D5              11      PUSH    DE
0012CC 52CC CDF552          17      CALL    GETL
0012CF 52CF 111FF4          10      LD  DE,KBUF
0012D2 52D2 E1              10      POP HL
0012D3 52D3 E5              11      PUSH    HL
0012D4 52D4 0E00             7      LD  C,0
0012D6 52D6 3004            12      JR  NC,SAX0
0012D8 52D8 23               6      INC HL
0012D9 52D9 23               6      INC HL
0012DA 52DA 1808            12      JR  SAX4
       52DC                     SAX0:
0012DC 52DC 46               7      LD  B,(HL)
0012DD 52DD 23               6      INC HL
       52DE                     SAX1:
0012DE 52DE 23               6      INC HL
0012DF 52DF 1A               7      LD  A,(DE)
0012E0 52E0 13               6      INC DE
0012E1 52E1 B7               4      OR  A
0012E2 52E2 2004            12      JR  NZ,SAX2
       52E4                     SAX4:
0012E4 52E4 360D            10      LD  (HL),00DH
0012E6 52E6 1804            12      JR  SAX3
       52E8                     SAX2:
0012E8 52E8 77               7      LD  (HL),A
0012E9 52E9 0C               4      INC C
0012EA 52EA 10F2            13      DJNZ    SAX1
       52EC                     SAX3:
0012EC 52EC D1              10      POP DE
0012ED 52ED 79               4      LD  A,C
0012EE 52EE 13               6      INC DE
0012EF 52EF 12               7      LD  (DE),A
0012F0 52F0 1B               6      DEC DE
0012F1 52F1 E1              10      POP HL
0012F2 52F2 C1              10      POP BC
0012F3 52F3 A7               4      AND A
0012F4 52F4 C9              10      RET
       52F5                     GETL:
0012F5 52F5 DDE5            15      PUSH    IX
0012F7 52F7 FDE5            15      PUSH    IY
                                
0012F9 52F9 2ADCF3          16      LD  HL,(CSRY)
0012FC 52FC 22CAFB          16      LD  (FSTPOS),HL
       52FF                     GETL1:
0012FF 52FF CD7652          17      CALL    _SYS08
001302 5302 FE09             7      CP  9
001304 5304 2008            12      JR  NZ,GETL1V
001306 5306 211FF4          10      LD  HL,KBUF
001309 5309 CD5E43          17      CALL    MSX
00130C 530C 18F1            12      JR  GETL1
       530E                     GETL1V:
00130E 530E 5F               4      LD  E,A
00130F 530F FE08             7      CP  8
001311 5311 CCAB53          17      CALL    Z,CTRL02
001314 5314 FE20             7      CP  020H
001316 5316 D4D753          17      CALL    NC,INSERT
001319 5319 CD3F52          17      CALL    MSGA1
                                
00131C 531C 7B               4      LD  A,E
00131D 531D FE0D             7      CP  00DH
00131F 531F 20DE            12      JR  NZ,GETL1
                                
001321 5321 111FF4          10      LD  DE,KBUF
001324 5324 3AB0F3          13      LD  A,(LINLEN)
001327 5327 47               4      LD  B,A
001328 5328 CDBA55          17      CALL    ZERO_MEMORY_DE
                                
00132B 532B 2ACAFB          16      LD  HL,(FSTPOS)
00132E 532E 3ADCF3          13      LD  A,(CSRY)
001331 5331 6F               4      LD  L,A
001332 5332 E5              11      PUSH    HL
001333 5333 CD0854          17      CALL    LOC0
001336 5336 4D               4      LD  C,L
001337 5337 44               4      LD  B,H
001338 5338 E1              10      POP HL
001339 5339 3AB0F3          13      LD  A,(LINLEN)
00133C 533C 94               4      SUB H
00133D 533D 3D               4      DEC A
00133E 533E 5F               4      LD  E,A
00133F 533F 211FF4          10      LD  HL,KBUF
       5342                     GETL2:
001342 5342 CD9B53          17      CALL    _SCRN
001345 5345 03               6      INC BC
001346 5346 77               7      LD  (HL),A
001347 5347 23               6      INC HL
001348 5348 1D               4      DEC E
001349 5349 20F7            12      JR  NZ,GETL2
00134B 534B CD5C52          17      CALL    MSG_CR
                                
00134E 534E FDE1            14      POP IY
001350 5350 DDE1            14      POP IX
       5352                     GETL3:
001352 5352 2B               6      DEC HL
001353 5353 7E               7      LD  A,(HL)
001354 5354 FE21             7      CP  021H
001356 5356 D0              11      RET NC
001357 5357 3600            10      LD  (HL),0
001359 5359 15               4      DEC D
00135A 535A 20F6            12      JR  NZ,GETL3
00135C 535C C9              10      RET
                                
       535D                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       535D                     CONSTX:
       535D                     CPM_CONST:
00135D 535D C5              11      PUSH    BC
00135E 535E D5              11      PUSH    DE
00135F 535F E5              11      PUSH    HL
001360 5360 DDE5            15      PUSH    IX
001362 5362 DD219C00        14      LD  IX,CHSNS
001366 5366 CDD442          17      CALL    CALSLT_R
001369 5369 DDE1            14      POP IX
00136B 536B E1              10      POP HL
00136C 536C D1              10      POP DE
00136D 536D C1              10      POP BC
00136E 536E C9              10      RET
                                
       536F                     _SYS2A:     ;(BDOS)日付の獲得
00136F 536F AF               4      XOR A
001370 5370 57               4      LD  D,A
001371 5371 5F               4      LD  E,A
001372 5372 67               4      LD  H,A
001373 5373 6F               4      LD  L,A
001374 5374 C9              10      RET
                                
       5375                     _SYS2C:     ;(BDOS)時刻の獲得
001375 5375 AF               4      XOR A
001376 5376 57               4      LD  D,A
001377 5377 5F               4      LD  E,A
001378 5378 67               4      LD  H,A
001379 5379 6F               4      LD  L,A
00137A 537A C9              10      RET
                                
       537B                     POS:
00137B 537B F5              11      PUSH    AF
00137C 537C 2ADCF3          16      LD  HL,(CSRY)
00137F 537F 7D               4      LD  A,L
001380 5380 6C               4      LD  L,H
001381 5381 67               4      LD  H,A
001382 5382 2C               4      INC L
001383 5383 24               4      INC H
001384 5384 F1              10      POP AF
001385 5385 C9              10      RET
                                
       5386                     LOC:
001386 5386 F5              11      PUSH    AF
001387 5387 E5              11      PUSH    HL
001388 5388 7D               4      LD  A,L
001389 5389 6C               4      LD  L,H
00138A 538A 67               4      LD  H,A
00138B 538B 2D               4      DEC L
00138C 538C 25               4      DEC H
00138D 538D DDE5            15      PUSH    IX
00138F 538F DD21C600        14      LD  IX,POSIT
001393 5393 CDD442          17      CALL    CALSLT_R
001396 5396 DDE1            14      POP IX
001398 5398 E1              10      POP HL
001399 5399 F1              10      POP AF
00139A 539A C9              10      RET
                                
       539B                     _SCRN:
       539B                     SCRN:
00139B 539B E5              11      PUSH    HL
00139C 539C DDE5            15      PUSH    IX
                                
00139E 539E 69               4      LD  L,C
00139F 539F 60               4      LD  H,B
0013A0 53A0 DD214A00        14      LD  IX,RDVRM
0013A4 53A4 CDD442          17      CALL    CALSLT_R
                                
0013A7 53A7 DDE1            14      POP IX
0013A9 53A9 E1              10      POP HL
0013AA 53AA C9              10      RET
                                
       53AB                     CTRL02:
0013AB 53AB F5              11      PUSH    AF
0013AC 53AC D5              11      PUSH    DE
0013AD 53AD 2ADCF3          16      LD  HL,(CSRY)
0013B0 53B0 3AB0F3          13      LD  A,(LINLEN)
0013B3 53B3 4F               4      LD  C,A
0013B4 53B4 94               4      SUB H   ;CSRX
0013B5 53B5 C602             7      ADD A,2
0013B7 53B7 47               4      LD  B,A ;カーソルより右の文字数
0013B8 53B8 61               4      LD  H,C ;LINLEN
0013B9 53B9 C5              11      PUSH    BC
0013BA 53BA CD0854          17      CALL    LOC0
0013BD 53BD C1              10      POP BC
                                
0013BE 53BE 1620             7      LD  D,020H
       53C0                     C8X1:
0013C0 53C0 DD214A00        14      LD  IX,RDVRM
0013C4 53C4 CDD442          17      CALL    CALSLT_R
0013C7 53C7 4F               4      LD  C,A
0013C8 53C8 7A               4      LD  A,D
0013C9 53C9 DD214D00        14      LD  IX,WRTVRM
0013CD 53CD CDD442          17      CALL    CALSLT_R
0013D0 53D0 2B               6      DEC HL
0013D1 53D1 51               4      LD  D,C
0013D2 53D2 10EC            13      DJNZ    C8X1
0013D4 53D4 D1              10      POP DE
0013D5 53D5 F1              10      POP AF
0013D6 53D6 C9              10      RET
                                
       53D7                     INSERT:
0013D7 53D7 F5              11      PUSH    AF
0013D8 53D8 D5              11      PUSH    DE
0013D9 53D9 2ADCF3          16      LD  HL,(CSRY)
0013DC 53DC 3AB0F3          13      LD  A,(LINLEN)
0013DF 53DF 4F               4      LD  C,A
0013E0 53E0 94               4      SUB H   ;CSRX
0013E1 53E1 3C               4      INC A
0013E2 53E2 47               4      LD  B,A ;カーソルより右の文字数
0013E3 53E3 C5              11      PUSH    BC
0013E4 53E4 CD0854          17      CALL    LOC0
0013E7 53E7 C1              10      POP BC
                                
0013E8 53E8 1620             7      LD  D,020H
       53EA                     INS1:
0013EA 53EA DD214A00        14      LD  IX,RDVRM
0013EE 53EE CDD442          17      CALL    CALSLT_R
0013F1 53F1 4F               4      LD  C,A
0013F2 53F2 7A               4      LD  A,D
0013F3 53F3 DD214D00        14      LD  IX,WRTVRM
0013F7 53F7 CDD442          17      CALL    CALSLT_R
0013FA 53FA 23               6      INC HL
0013FB 53FB 51               4      LD  D,C
0013FC 53FC 10EC            13      DJNZ    INS1
0013FE 53FE D1              10      POP DE
0013FF 53FF F1              10      POP AF
001400 5400 C9              10      RET
                                
       5401                     CONOUT1:
001401 5401 59               4      LD  E,C
001402 5402 C33552          10      JP  _PRINT
                                
       5405                     GETVRAM:
001405 5405 2ADCF3          16      LD  HL,(CSRY)
       5408                     LOC0:
001408 5408 2D               4      DEC L
001409 5409 25               4      DEC H
00140A 540A 4C               4      LD  C,H ;CSRX-1
00140B 540B 5D               4      LD  E,L ;CSRY-1
       540C                     LOC1:
00140C 540C 3AB0F3          13      LD  A,(LINLEN)
00140F 540F 67               4      LD  H,A
001410 5410 1600             7      LD  D,0
001412 5412 6A               4      LD  L,D ;0
001413 5413 0608             7      LD  B,8
       5415                     LOC2:
001415 5415 29              11      ADD HL,HL
001416 5416 3001            12      JR  NC,LOC3
001418 5418 19              11      ADD HL,DE
       5419                     LOC3:
001419 5419 10FA            13      DJNZ    LOC2
00141B 541B 09              11      ADD HL,BC
00141C 541C C9              10      RET
                                
       541D                     _SYS0C:     ;(BDOS)バージョン番号の獲得
00141D 541D 212200          10      LD  HL,00022H
001420 5420 AF               4      XOR A
001421 5421 7D               4      LD  A,L
001422 5422 C9              10      RET
                                
       5423                     _SYS0D:     ;(BDOS)ディスク・リセット
001423 5423 218000          10      LD  HL,00080H
001426 5426 22C7F2          16      LD  (_DTA),HL
001429 5429 C9              10      RET
                                
       542A                     _SYS0E:     ;(BDOS)カレントドライブの設定
00142A 542A 7B               4      LD  A,E
       542B                     _SYS0EX1:
00142B 542B FE08             7      CP  8
00142D 542D 3F               4      CCF
00142E 542E D8              11      RET C
00142F 542F 32DDF2          13      LD  (_DVSW),A
001432 5432 C9              10      RET
                                
       5433                     _SYS0F:     ;(BDOS)ファイルのオープン
001433 5433 D5              11      PUSH    DE
001434 5434 FDE1            14      POP IY
001436 5436 CDA155          17      CALL    INIT_FILE
001439 5439 CDAA4B          17      CALL    ROM_OPEN
00143C 543C 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
00143E 543E FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
001442 5442 FDE5            15      PUSH    IY
001444 5444 D1              10      POP DE
001445 5445 13               6      INC DE
001446 5446 010B00          10      LD  BC,11
001449 5449 EDB0                    LDIR
                                ;               Attribute
00144B 544B 7E               7      LD  A,(HL)
00144C 544C FD770D          19      LD  (IY+13),A
                                ;               TIME
00144F 544F 110B00          10      LD  DE,11
001452 5452 19              11      ADD HL,DE
001453 5453 7E               7      LD  A,(HL)
001454 5454 23               6      INC HL
001455 5455 FD7716          19      LD  (IY+22),A
001458 5458 7E               7      LD  A,(HL)
001459 5459 23               6      INC HL
00145A 545A FD7717          19      LD  (IY+23),A
                                ;               DATE
00145D 545D 7E               7      LD  A,(HL)
00145E 545E 23               6      INC HL
00145F 545F FD7714          19      LD  (IY+20),A
001462 5462 7E               7      LD  A,(HL)
001463 5463 23               6      INC HL
001464 5464 FD7715          19      LD  (IY+21),A
                                ;               First cluster
001467 5467 7E               7      LD  A,(HL)
001468 5468 23               6      INC HL
001469 5469 FD771A          19      LD  (IY+26),A
00146C 546C 7E               7      LD  A,(HL)
00146D 546D 23               6      INC HL
00146E 546E FD771B          19      LD  (IY+27),A
                                ;               SIZE
001471 5471 7E               7      LD  A,(HL)
001472 5472 23               6      INC HL
001473 5473 FD7710          19      LD  (IY+16),A
001476 5476 7E               7      LD  A,(HL)
001477 5477 23               6      INC HL
001478 5478 FD7711          19      LD  (IY+17),A
00147B 547B 7E               7      LD  A,(HL)
00147C 547C 23               6      INC HL
00147D 547D FD7712          19      LD  (IY+18),A
001480 5480 7E               7      LD  A,(HL)
001481 5481 FD7713          19      LD  (IY+19),A
001484 5484 AF               4      XOR A
001485 5485 FD770C          19      LD  (IY+12),A
001488 5488 C9              10      RET
                                
       5489                     _SYS10:     ;(BDOS)ファイルのクローズ
001489 5489 AF               4      XOR A
00148A 548A C9              10      RET
                                
       548B                     S11X1:
00148B 548B FD7119          19      LD  (IY+25),C       ;RootEntCnt
00148E 548E FD750E          19      LD  (IY+14),L
001491 5491 FD740F          19      LD  (IY+15),H
       5494                     SCF_FF_RET:
001494 5494 37               4      SCF
001495 5495 9F               4      SBC A,A
001496 5496 C9              10      RET
                                
       5497                     _SYS11:     ;(BDOS)最初のファイルの検索
001497 5497 ED53CAF2        20      LD  (_FCB),DE
00149B 549B D5              11      PUSH    DE
00149C 549C FDE1            14      POP IY
00149E 549E CDA155          17      CALL    INIT_FILE
0014A1 54A1 CD084E          17      CALL    GET_DIR_DAT
       54A4                     S12X1:
0014A4 54A4 CDC64B          17      CALL    FILESE
0014A7 54A7 30E2            12      JR  NC,S11X1
0014A9 54A9 0D               4      DEC C
0014AA 54AA FD7119          19      LD  (IY+25),C       ;RootEntCnt
0014AD 54AD FDCB0D66        20      BIT 4,(IY+13)
0014B1 54B1 2809            12      JR  Z,S12X2
0014B3 54B3 E5              11      PUSH    HL
0014B4 54B4 DDE1            14      POP IX
0014B6 54B6 DDCB0E66        20      BIT 4,(IX+1+13)
0014BA 54BA 28E8            12      JR  Z,S12X1
       54BC                     S12X2:
0014BC 54BC 012000          10      LD  BC,32
0014BF 54BF ED5BC7F2        20      LD  DE,(_DTA)
0014C3 54C3 AF               4      XOR A
0014C4 54C4 12               7      LD  (DE),A      ;ドライブ番号
0014C5 54C5 13               6      INC DE
0014C6 54C6 EDB0                    LDIR            ;ディレクトリエントリ
0014C8 54C8 FD750E          19      LD  (IY+14),L
0014CB 54CB FD740F          19      LD  (IY+15),H
0014CE 54CE C9              10      RET
                                
       54CF                     _SYS12:
0014CF 54CF FD2ACAF2        20      LD  IY,(_FCB)
0014D3 54D3 FDE5            15      PUSH    IY
0014D5 54D5 D1              10      POP DE
0014D6 54D6 CDA155          17      CALL    INIT_FILE
                                
0014D9 54D9 FD6E0E          19      LD  L,(IY+14)
0014DC 54DC FD660F          19      LD  H,(IY+15)
0014DF 54DF FD4E19          19      LD  C,(IY+25)
0014E2 54E2 18C0            12      JR  S12X1
                                
       54E4                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0014E4 54E4 CDEE4D          17      CALL    SET_FCB
0014E7 54E7 CDBC4D          17      CALL    GETSEQ
0014EA 54EA CDA94D          17      CALL    RB_READ
0014ED 54ED E5              11      PUSH    HL
0014EE 54EE CDC94D          17      CALL    SETSEQ
0014F1 54F1 E1              10      POP HL
       54F2                     SREAD:
0014F2 54F2 C601             7      ADD A,001H
0014F4 54F4 D8              11      RET C
                                
0014F5 54F5 7D               4      LD  A,L
0014F6 54F6 D601             7      SUB 001H
0014F8 54F8 9F               4      SBC A,A
0014F9 54F9 E603             7      AND 3
0014FB 54FB 1F               4      RRA
0014FC 54FC C9              10      RET
                                
       54FD                     _SYS18:     ;(BDOS)ログインベクトルの獲得
0014FD 54FD 210100          10      LD  HL,00001H
001500 5500 AF               4      XOR A
001501 5501 C9              10      RET
                                
       5502                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
001502 5502 3ADDF2          13      LD  A,(_DVSW)
001505 5505 C9              10      RET
                                
       5506                     _SYS1A:     ;(BDOS)DTAの設定
001506 5506 ED53C7F2        20      LD  (_DTA),DE
00150A 550A AF               4      XOR A
00150B 550B C9              10      RET
                                
       550C                     _SYS1B:     ;(BDOS)ディスク情報の獲得
00150C 550C 010002          10      LD  BC,512
00150F 550F 11C302          10      LD  DE,707
001512 5512 210000          10      LD  HL,0
001515 5515 DD21CCF2        14      LD  IX,_BUF
001519 5519 FD21CCF2        14      LD  IY,_BUF
00151D 551D FD3600F9        19      LD  (IY+0),0F9H
001521 5521 3E02             7      LD  A,2
001523 5523 C9              10      RET
                                
       5524                     _SYS21:     ;(BDOS)ランダムな読み出し
001524 5524 CDEE4D          17      CALL    SET_FCB
                                
001527 5527 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
00152A 552A FD6622          19      LD  H,(IY+34)
                                
00152D 552D CDA94D          17      CALL    RB_READ
001530 5530 18C0            12      JR  SREAD
                                
       5532                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
001532 5532 CD3354          17      CALL    _SYS0F
001535 5535 D8              11      RET C
                                
001536 5536 D5              11      PUSH    DE      ;EX DE,IY
001537 5537 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001539 5539 CDDE4D          17      CALL    GETSIZE
       553C                     _S24X1:
00153C 553C FD7521          19      LD  (IY+33),L   ;(FCB)Random record
00153F 553F FD7422          19      LD  (IY+34),H
001542 5542 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
001546 5546 FDE3            23      EX  (SP),IY     ;
001548 5548 D1              10      POP DE      ;
                                
001549 5549 AF               4      XOR A
00154A 554A C9              10      RET
                                
       554B                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
00154B 554B E5              11      PUSH    HL
00154C 554C D5              11      PUSH    DE      ;EX DE,IY
00154D 554D FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00154F 554F CDBC4D          17      CALL    GETSEQ
001552 5552 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       5554                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001554 5554 CDEE4D          17      CALL    SET_FCB
001557 5557 E5              11      PUSH    HL
001558 5558 FD6E21          19      LD  L,(IY+33)
00155B 555B FD6622          19      LD  H,(IY+34)
00155E 555E 22BDF2          16      LD  (RR_LOW),HL
001561 5561 FD6E23          19      LD  L,(IY+35)
001564 5564 FD6624          19      LD  H,(IY+36)
001567 5567 22BFF2          16      LD  (RR_HIGH),HL
00156A 556A E1              10      POP HL
00156B 556B CD8A49          17      CALL    ROM_READ
00156E 556E ED5BBDF2        20      LD  DE,(RR_LOW)
001572 5572 FD7321          19      LD  (IY+33),E
001575 5575 FD7222          19      LD  (IY+34),D
001578 5578 ED5BBFF2        20      LD  DE,(RR_HIGH)
00157C 557C FD7323          19      LD  (IY+35),E
00157F 557F FD7224          19      LD  (IY+36),D
001582 5582 9F               4      SBC A,A
001583 5583 C9              10      RET
                                
       5584                     _SYS2F:
001584 5584 44               4      LD  B,H
001585 5585 2AC7F2          16      LD  HL,(_DTA)
001588 5588 C3FA4F          10      JP  DISKIO
                                
       558B                     _SYS5A:
00158B 558B 0600             7      LD  B,0
00158D 558D D5              11      PUSH    DE
00158E 558E DDE1            14      POP IX
       5590                     _SX5A1:
001590 5590 1A               7      LD  A,(DE)
001591 5591 B7               4      OR  A
001592 5592 2804            12      JR  Z,_SX5A2
001594 5594 13               6      INC DE
001595 5595 04               4      INC B
001596 5596 18F8            12      JR  _SX5A1
                                
       5598                     _SX5A2:
001598 5598 78               4      LD  A,B
001599 5599 CD554A          17      CALL    FILE_BDOS
00159C 559C CDAB4E          17      CALL    ROM_CD
00159F 559F 9F               4      SBC A,A
0015A0 55A0 C9              10      RET
                                
       55A1                     INIT_FILE:
0015A1 55A1 EB               4      EX  DE,HL
0015A2 55A2 11EBF2          10      LD  DE,FDRV
0015A5 55A5 010C00          10      LD  BC,1+8+3
       55A8                     INIT_FILE1:
0015A8 55A8 EDB0                    LDIR
0015AA 55AA CDC251          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0015AD 55AD 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0015B0 55B0 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0015B3 55B3 2ADEF2          16      LD  HL,(_CD)
0015B6 55B6 22E9F2          16      LD  (_CDX),HL           ;カレントディレクトリ
0015B9 55B9 C9              10      RET
                                
       55BA                     ZERO_MEMORY_DE:
0015BA 55BA AF               4      XOR A
       55BB                     FILL_MEMORY_DE:
0015BB 55BB 12               7      LD  (DE),A
0015BC 55BC 13               6      INC DE
0015BD 55BD 10FC            13      DJNZ    FILL_MEMORY_DE
0015BF 55BF C9              10      RET
                                
0015C0 55C0                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 2252385269522252        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 225222526E52AF52        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 76522252C9525D53        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 1D5423542A543354        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 89549754CF542252        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 E454225222522252        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 FD54025506550C55        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 2252225222523255        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 4B55225222525455        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 225222526F532252        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 7553225222528455        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 225222528B552252        DW  _ERROR,_ERROR,_SYS5A,_ERROR
001FB8 5FB8 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 2252225222522252        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
