                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       42B2                     CRUNCH  EQU 042B2H
       4C64                     FRMEVL  EQU 04C64H
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
                                ;PTRFIL EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
                                ;FILNAM EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
                                ;RSTMP  EQU 0FB03H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FEDA                     H_STKE  EQU 0FEDAH
                                
       FF43                     H_GONE  EQU 0FF43H
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                
       F0E9                     ISC EQU 0F0E9H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       6200                     _FATBF  EQU BANK1_ADR+512       ;FATの先頭
                                
       F7F8                     DACDAT  EQU DAC+2
[EOF:DEF.ASM:UTF_8]
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C3C24A          10      JP  DISKIO
000013 4013 C3F14A          10      JP  DSKCHG
000016 4016 C3474B          10      JP  GETDPB
000019 4019 C32F4C          10      JP  CHOICE
00001C 401C C3334C          10      JP  DSKFMT
00001F 401F C3354C          10      JP  DSKSTP
000022 4022 C3364C          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C3334C          10      JP  DSKFMT
000029 4029 C3354C          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C33D4C          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.1.2.1",0
            204449534B20524F    
            4D204C6974652076    
            302E312E322E3100    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 0180FF          10      LD  BC,-00080H
000109 4109 2A72F6          16      LD  HL,(MEMSIZ)
00010C 410C 09              11      ADD HL,BC
00010D 410D 2272F6          16      LD  (MEMSIZ),HL
000110 4110 2A74F6          16      LD  HL,(STKTOP)
000113 4113 09              11      ADD HL,BC
000114 4114 2274F6          16      LD  (STKTOP),HL
000117 4117 2180F0          10      LD  HL,0F080H
00011A 411A 1100F0          10      LD  DE,0F000H
00011D 411D 012000          10      LD  BC,00020H
000120 4120 EDB0                    LDIR
000122 4122 2180FF          10      LD  HL,-00080H
000125 4125 39              11      ADD HL,SP
000126 4126 2253F1          16      LD  (BASSTK),HL
000129 4129 ED7B53F1        20      LD  SP,(BASSTK)
                                
00012D 412D 3EFF             7      LD  A,0FFH
00012F 412F 3299FD          13      LD  (DEVICE),A
                                
000132 4132 3E01             7      LD  A,1
000134 4134 3221FB          13      LD  (DRVTBL),A
                                
000137 4137 AF               4      XOR A
000138 4138 323EF1          13      LD  (_DVSW),A
                                
00013B 413B 21ED42          10      LD  HL,AT_ISC
00013E 413E 11E9F0          10      LD  DE,ISC
000141 4141 016C00          10      LD  BC,ISC_E-ISC
000144 4144 EDB0                    LDIR
                                    
000146 4146 3EC3             7      LD  A,0C3H      ;JP
000148 4148 3243FF          13      LD  (H_GONE),A
00014B 414B 327DF3          13      LD  (BDOS),A
00014E 414E 326BF3          13      LD  (RAMUSE),A
000151 4151 3268F3          13      LD  (ROMUSE),A
000154 4154 21E9F0          10      LD  HL,REPLACE_COMMAND
000157 4157 2244FF          16      LD  (H_GONE+1),HL
00015A 415A 2131F3          10      LD  HL,H_BDOS
00015D 415D 227EF3          16      LD  (BDOS+1),HL
000160 4160 2110F1          10      LD  HL,RAMUSE1
000163 4163 226CF3          16      LD  (RAMUSE+1),HL
000166 4166 210BF1          10      LD  HL,ROMUSE1
000169 4169 2269F3          16      LD  (ROMUSE+1),HL
                                
00016C 416C 3E                      DB  03EH
00016D 416D F7              12      RST 30H
00016E 416E 3271FE          13      LD  (H_BINS),A
000171 4171 3276FE          13      LD  (H_BINL),A
000174 4174 327BFE          13      LD  (H_FILE),A
000177 4177 3231F3          13      LD  (H_BDOS),A
00017A 417A 32DAFE          13      LD  (H_STKE),A
00017D 417D 32A7FF          13      LD  (H_PHYD),A
                                
000180 4180 CD3542          17      CALL    GTSL1_
000183 4183 32FCF0          13      LD  (ROM_SLT),A
000186 4186 3272FE          13      LD  (H_BINS+1),A
000189 4189 3277FE          13      LD  (H_BINL+1),A
00018C 418C 327CFE          13      LD  (H_FILE+1),A
00018F 418F 3232F3          13      LD  (H_BDOS+1),A
000192 4192 32DBFE          13      LD  (H_STKE+1),A
000195 4195 32A8FF          13      LD  (H_PHYD+1),A
000198 4198 3222FB          13      LD  (DRVTBL+1),A
00019B 419B 3248F3          13      LD  (MASTERS),A
                                
00019E 419E 210845          10      LD  HL,ROM_LOAD
0001A1 41A1 2273FE          16      LD  (H_BINS+2),HL
0001A4 41A4 212346          10      LD  HL,ROM_RUN
0001A7 41A7 2278FE          16      LD  (H_BINL+2),HL
0001AA 41AA 213046          10      LD  HL,ROM_FILES
0001AD 41AD 227DFE          16      LD  (H_FILE+2),HL
0001B0 41B0 216A4C          10      LD  HL,ROM_BDOS
0001B3 41B3 2233F3          16      LD  (H_BDOS+2),HL
0001B6 41B6 218343          10      LD  HL,ROM_STKE
0001B9 41B9 22DCFE          16      LD  (H_STKE+2),HL
0001BC 41BC 21C24A          10      LD  HL,DISKIO
0001BF 41BF 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001C2 41C2 3E                      DB  03EH
0001C3 41C3 C9              10      RET
0001C4 41C4 327FFE          13      LD  (H_FILE+4),A
0001C7 41C7 3275FE          13      LD  (H_BINS+4),A
0001CA 41CA 327AFE          13      LD  (H_BINL+4),A
0001CD 41CD 3235F3          13      LD  (H_BDOS+4),A
0001D0 41D0 32DEFE          13      LD  (H_STKE+4),A
0001D3 41D3 32ABFF          13      LD  (H_PHYD+4),A
                                
0001D6 41D6 AF               4      XOR A
0001D7 41D7 320068          13      LD  (BANK1_SEL),A
0001DA 41DA 3A0060          13      LD  A,(BANK1_ADR)
0001DD 41DD FE41             7      CP  'A'
0001DF 41DF 2043            12      JR  NZ,NOT_8K_BANK
0001E1 41E1 3E01             7      LD  A,DISK_BANK
0001E3 41E3 320068          13      LD  (BANK1_SEL),A
                                
0001E6 41E6 CD3801          17      CALL    RSLREG      ;read primary slot #
0001E9 41E9 07               4      RLCA
0001EA 41EA 07               4      RLCA
0001EB 41EB F5              11      PUSH    AF
0001EC 41EC CD3A42          17      CALL    GTSL2_
0001EF 41EF 3244F3          13      LD  (RAMAD3),A
0001F2 41F2 F1              10      POP AF  
0001F3 41F3 CD3A42          17      CALL    GTSL2_
0001F6 41F6 3243F3          13      LD  (RAMAD2),A
       41F9                     RAMCHK2:
0001F9 41F9 3A44F3          13      LD  A,(RAMAD3)
0001FC 41FC 2640             7      LD  H,040H
0001FE 41FE CD5142          17      CALL    CHK_RAM
000201 4201 3242F3          13      LD  (RAMAD1),A
       4204                     RAMCHK1:
000204 4204 3A44F3          13      LD  A,(RAMAD3)
000207 4207 2600             7      LD  H,00H
000209 4209 CD5142          17      CALL    CHK_RAM
00020C 420C 3241F3          13      LD  (RAMAD0),A
       420F                     RAMCHK0:
00020F 420F 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
000212 4212 010F00          10      LD  BC,0000FH       ;切り上げ
000215 4215 09              11      ADD HL,BC
000216 4216 7D               4      LD  A,L
                                
000217 4217 0604             7      LD  B,4
       4219                     B_DRIVE1:
000219 4219 CB3C             8      SRL H
00021B 421B 1F               4      RRA
00021C 421C 10FB            13      DJNZ    B_DRIVE1
                                
00021E 421E C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000220 4220 323DF1          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
000223 4223 C9              10      RET
                                
       4224                     NOT_8K_BANK:
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K等)
000224 4224 21D143          10      LD  HL,MSG_ERROR_ROM_MODE
000227 4227 CD5C43          17      CALL    MSX
00022A 422A FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
00022E 422E DD219F00        14      LD  IX,CHGET
000232 4232 C31C00          10      JP  _CALSLT
                                
       4235                     GTSL1_:             ;自分のいるスロットを知る
000235 4235 CD3801          17      CALL    RSLREG      ;read primary slot #
000238 4238 0F               4      RRCA
000239 4239 0F               4      RRCA
       423A                     GTSL2_:
00023A 423A E603             7      AND 3       ;[A]=000000PP
00023C 423C 5F               4      LD  E,A     ;[E]=000000PP
00023D 423D 21C1FC          10      LD  HL,EXPTBL
000240 4240 85               4      ADD A,L     ;桁上りは無い
000241 4241 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000242 4242 7B               4      LD  A,E     ;[A]=000000PP
000243 4243 CB7E            13      BIT 7,(HL)
000245 4245 C8              11      RET Z
000246 4246 7D               4      LD  A,L     ;point to SLTTBL entry
000247 4247 C604             7      ADD A,4     ;桁上りは無い
000249 4249 6F               4      LD  L,A
00024A 424A 7E               7      LD  A,(HL)      ;get currently expansion slot register
00024B 424B E60C             7      AND 00CH        ;[A] = 0000SS00
00024D 424D B3               4      OR  E       ;[A] = 0000SSPP
00024E 424E F680             7      OR  080H        ;[A] = 1000SSPP
000250 4250 C9              10      RET
       4251                     GTSL1_E:
                                
       4251                     CHK_RAM:
000251 4251 E5              11      PUSH    HL
000252 4252 CDA642          17      CALL    CHK_RAM0
000255 4255 E1              10      POP HL
000256 4256 C8              11      RET Z
000257 4257 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
00025A 425A E680             7      AND 080H
00025C 425C CD7D42          17      CALL    CHK_RAM_SLT
00025F 425F C8              11      RET Z
000260 4260 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000263 4263 E680             7      AND 080H
000265 4265 C601             7      ADD A,1
000267 4267 CD7D42          17      CALL    CHK_RAM_SLT
00026A 426A C8              11      RET Z
00026B 426B 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00026E 426E E680             7      AND 080H
000270 4270 C602             7      ADD A,2
000272 4272 CD7D42          17      CALL    CHK_RAM_SLT
000275 4275 C8              11      RET Z
000276 4276 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000279 4279 E680             7      AND 080H
00027B 427B C603             7      ADD A,3
       427D                     CHK_RAM_SLT:
00027D 427D E5              11      PUSH    HL
00027E 427E CDA642          17      CALL    CHK_RAM0        ;スロット#X or X-0
000281 4281 E1              10      POP HL
000282 4282 C8              11      RET Z
000283 4283 CB79             8      BIT 7,C
000285 4285 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000287 4287 79               4      LD  A,C
000288 4288 C604             7      ADD A,4         ;スロット#X-1
00028A 428A E5              11      PUSH    HL
00028B 428B CDA642          17      CALL    CHK_RAM0
00028E 428E E1              10      POP HL
00028F 428F C8              11      RET Z
000290 4290 79               4      LD  A,C
000291 4291 C604             7      ADD A,4         ;スロット#X-2
000293 4293 E5              11      PUSH    HL
000294 4294 CDA642          17      CALL    CHK_RAM0
000297 4297 E1              10      POP HL
000298 4298 C8              11      RET Z
000299 4299 79               4      LD  A,C
00029A 429A C604             7      ADD A,4         ;スロット#X-3
00029C 429C E5              11      PUSH    HL
00029D 429D CDA642          17      CALL    CHK_RAM0
0002A0 42A0 E1              10      POP HL
       42A1                     CHK_RAM_E:
0002A1 42A1 AF               4      XOR A
0002A2 42A2 3C               4      INC A           ;ZF=0にする
0002A3 42A3 3E00             7      LD  A,0
0002A5 42A5 C9              10      RET
                                
       42A6                     CHK_RAM0:
0002A6 42A6 4F               4      LD  C,A
0002A7 42A7 3AFCF0          13      LD  A,(ROM_SLT)
0002AA 42AA B9               4      CP  C
0002AB 42AB 28F4            12      JR  Z,CHK_RAM_E
0002AD 42AD 2E00             7      LD  L,0
       42AF                     CHK_RAM1:
0002AF 42AF 79               4      LD  A,C
0002B0 42B0 DD210C00        14      LD  IX,_RDSLT
0002B4 42B4 CDE142          17      CALL    CALSLT_R
0002B7 42B7 C6E5             7      ADD A,0E5H
0002B9 42B9 47               4      LD  B,A
0002BA 42BA 5F               4      LD  E,A
0002BB 42BB 79               4      LD  A,C
0002BC 42BC DD211400        14      LD  IX,_WRSLT
0002C0 42C0 CDE142          17      CALL    CALSLT_R
0002C3 42C3 79               4      LD  A,C
0002C4 42C4 DD210C00        14      LD  IX,_RDSLT
0002C8 42C8 CDE142          17      CALL    CALSLT_R
0002CB 42CB B8               4      CP  B
0002CC 42CC C0              11      RET NZ
0002CD 42CD D6E5             7      SUB 0E5H
0002CF 42CF 79               4      LD  A,C
0002D0 42D0 5F               4      LD  E,A
0002D1 42D1 DD211400        14      LD  IX,_WRSLT
0002D5 42D5 CDE142          17      CALL    CALSLT_R
0002D8 42D8 24               4      INC H
0002D9 42D9 7D               4      LD  A,L
0002DA 42DA C604             7      ADD A,4
0002DC 42DC 6F               4      LD  L,A
0002DD 42DD 20D0            12      JR  NZ,CHK_RAM1
0002DF 42DF 79               4      LD  A,C     ;ZF=1のハズ
0002E0 42E0 C9              10      RET
                                
       42E1                     CALSLT_R:
0002E1 42E1 C5              11      PUSH    BC
0002E2 42E2 E5              11      PUSH    HL
0002E3 42E3 FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
0002E7 42E7 CD1C00          17      CALL    _CALSLT
0002EA 42EA E1              10      POP HL
0002EB 42EB C1              10      POP BC
0002EC 42EC C9              10      RET
                                
       42ED                     AT_ISC:
0002ED F0E9                         ORG ISC,AT_ISC-RUN
       F0E9                     REPLACE_COMMAND:
0002ED F0E9 FEB7             7      CP  0B7H            ;FILES
0002EF F0EB CC7BFE          17      CALL    Z,H_FILE
0002F2 F0EE FEB5             7      CP  0B5H            ;LOAD
0002F4 F0F0 CA71FE          10      JP  Z,H_BINS
0002F7 F0F3 FE8A             7      CP  08AH            ;RUN
0002F9 F0F5 CA76FE          10      JP  Z,H_BINL
0002FC F0F8 FECF             7      CP  0CFH            ;BLOAD
0002FE F0FA C0              11      RET NZ
       F0FB                     FIX_BLOAD:
0002FF F0FB F7              12      RST 30H
       F0FC                     ROM_SLT:
000300 F0FC 00                      DB  0
000301 F0FD 6545                    DW  ROM_BLOAD
000303 F0FF F5              11      PUSH    AF
000304 F100 E5              11      PUSH    HL
000305 F101 CD0AF1          17      CALL    BLOAD_RET
       F102                     SWC_BLOAD   EQU $-2
000308 F104 E1              10      POP HL
000309 F105 F1              10      POP AF
00030A F106 FECF             7      CP  0CFH            ;BLOAD
       F108                     SWC_BLOAD_M:
00030C F108 28DF            12      JR  Z,REPLACE_COMMAND
       F10A                     BLOAD_RET:
00030E F10A C9              10      RET
       F10B                     ROMUSE1:
00030F F10B 3AFCF0          13      LD  A,(ROM_SLT)
000312 F10E 1803            12      JR  ROMUSE2
       F110                     RAMUSE1:
000314 F110 3A42F3          13      LD  A,(RAMAD1)
       F113                     ROMUSE2:
000317 F113 DD212400        14      LD  IX,_ENASLT
00031B F117 FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
00031F F11B C31C00          10      JP  _CALSLT
                                
       F11E                     _RESULT:
000322 F11E 00                      DB  0
       F11F                     _BANK:
000323 F11F 00                      DB  0
       F120                     RR_LOW:
000324 F120 0000                    DW  0
       F121                     RR_MID  EQU $-1
       F122                     RR_HIGH:
000326 F122 0000                    DW  0
       F124                     _CLPS:
000328 F124 0000                    DW  0
       F126                     _LEFT:
00032A F126 0000                    DW  0
       F128                     _DTPS:
00032C F128 0000                    DW  0
       F12A                     _DTA:
00032E F12A 0000                    DW  0
       F12C                     FLG_LDIR:
000330 F12C 00                      DB  0
                                ;   BDOS
000331 F12D F7              12      RST 30H
000332 F12E 00                      DB  0
000333 F12F 6A4C                    DW  ROM_BDOS
000335 F131 C9              10      RET 
       F132                     _FCB:
000336 F132 0000                    DW  0
       F134                     _BUF:
000338 F134 00                      DB  0
       F135                     _BUF_ST:
000339 F135 0000                    DW  0
       F137                     _BUF_EN:
00033B F137 0000                    DW  0
       F139                     _BUF_EX:
00033D F139 0000                    DW  0
                                
       F13B                     DTAX:
00033F F13B 0000                    DW  0
       F13D                     B_DRIVE:
000341 F13D 00                      DB  0
       F13E                     _DVSW:
000342 F13E 00                      DB  0
       F13F                     FCBX:
000343 F13F 0000                    DW  0
       F141                     LEFTX:
000345 F141 0000                    DW  0
       F143                     PARAM0:
000347 F143 0000                    DW  0
       F145                     PARAM1:
000349 F145 0000                    DW  0
       F147                     FDRV:
00034B F147 00                      DB  0
       F148                     FNAME:
00034C F148                         DS  8+3
                                
000357 F153 0000                BASSTK  DW  0
                                
       F155                     ISC_E:
000359 4359                         ORG $$+RUN          ;$DEPHASE
                                
       4359                     MSX1:
000359 4359 CD834C          17      CALL    MSGA1
       435C                     MSX:
00035C 435C 7E               7      LD  A,(HL)
00035D 435D 23               6      INC HL
00035E 435E B7               4      OR  A
00035F 435F 20F8            12      JR  NZ,MSX1
000361 4361 C9              10      RET
                                
       4362                     PRTHX:
000362 4362 F5              11      PUSH    AF
000363 4363 07               4      RLCA
000364 4364 07               4      RLCA
000365 4365 07               4      RLCA
000366 4366 07               4      RLCA
000367 4367 CD6B43          17      CALL    PRTA2
00036A 436A F1              10      POP AF
       436B                     PRTA2:
00036B 436B CD7143          17      CALL    ASC
00036E 436E C37F4C          10      JP  MSG_A
                                    
       4371                     ASC:
000371 4371 E60F             7      AND $0F
000373 4373 F630             7      OR  $30
000375 4375 FE3A             7      CP  $3A
000377 4377 D8              11      RET C
000378 4378 C607             7      ADD A,7
00037A 437A C9              10      RET
                                
       437B                     MSN:
00037B 437B 7E               7      LD  A,(HL)
00037C 437C 23               6      INC HL
00037D 437D CD7F4C          17      CALL    MSG_A
000380 4380 10F9            13      DJNZ    MSN
000382 4382 C9              10      RET
                                
       4383                     ROM_STKE:
000383 4383 3E                      DB  03EH
000384 4384 C9              10      RET
000385 4385 32DAFE          13      LD  (H_STKE),A
000388 4388 E5              11      PUSH    HL
000389 4389 D5              11      PUSH    DE
00038A 438A C5              11      PUSH    BC
00038B 438B 181D            12      JR  BASAUTO
                                
00038D 438D AF               4      XOR A
00038E 438E 5F               4      LD  E,A
00038F 438F 57               4      LD  D,A
000390 4390 0601             7      LD  B,1
000392 4392 2100C0          10      LD  HL,0C000H
000395 4395 CDC24A          17      CALL    DISKIO
                                
000398 4398 ED7353F1        20      LD  (BASSTK),SP
00039C 439C 116BF3          10      LD  DE,RAMUSE
00039F 439F AF               4      XOR A
0003A0 43A0 CD1EC0          17      CALL    0C01EH
0003A3 43A3 116BF3          10      LD  DE,RAMUSE
0003A6 43A6 37               4      SCF
0003A7 43A7 CD1EC0          17      CALL    0C01EH
       43AA                     BASAUTO:
0003AA 43AA 21EC43          10      LD  HL,AUTOEXEC
0003AD 43AD 1147F1          10      LD  DE,FDRV
0003B0 43B0 010C00          10      LD  BC,1+8+3
0003B3 43B3 EDB0                    LDIR
0003B5 43B5 CD8A48          17      CALL    ROM_OPEN
0003B8 43B8 3813            12      JR  C,RSTKEE
0003BA 43BA 21F843          10      LD  HL,RUN_AUTOEXEC
0003BD 43BD 11F0FB          10      LD  DE,KEYBUF
0003C0 43C0 ED53FAF3        20      LD  (GETPNT),DE
0003C4 43C4 011300          10      LD  BC,RUN_AUTOEXEC_E-RUN_AUTOEXEC
0003C7 43C7 EDB0                    LDIR
0003C9 43C9 ED53F8F3        20      LD  (PUTPNT),DE
       43CD                     RSTKEE:
0003CD 43CD C1              10      POP BC
0003CE 43CE D1              10      POP DE
0003CF 43CF E1              10      POP HL
0003D0 43D0 C9              10      RET
                                
       43D1                     MSG_ERROR_ROM_MODE:
0003D1 43D1 41534349492D384B        DB  "ASCII-8K/Konami-8K only!",13,10
            2F4B6F6E616D692D    
            384B206F6E6C7921    
            0D0A                
       43EB                     NULL:
0003EB 43EB 00                      DB  0
                                
       43EC                     AUTOEXEC:
0003EC 43EC 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       43F8                     RUN_AUTOEXEC:
0003F8 43F8 52554E2022415554        DB  'RUN "AUTOEXEC.BAS"',00DH
            4F455845432E4241    
            53220D              
                                ;   DB  'LOAD "AUTOEXEC.BAS"',00DH  ;テスト用
       440B                     RUN_AUTOEXEC_E:
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       440B                     ROM_LDIR:
00040B 440B 3A2CF1          13      LD  A,(FLG_LDIR)
00040E 440E B7               4      OR  A
00040F 440F 2007            12      JR  NZ,ROM_LDIRVM
000411 4411 CB7A             8      BIT 7,D
000413 4413 2815            12      JR  Z,ROM_LDIRSLT
000415 4415 EDB0                    LDIR
000417 4417 C9              10      RET
                                
       4418                     ROM_LDIRVM:
000418 4418 C5              11      PUSH    BC
000419 4419 D5              11      PUSH    DE
00041A 441A FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
00041E 441E DD215C00        14      LD  IX,LDIRVM
000422 4422 CD1C00          17      CALL    _CALSLT
000425 4425 E1              10      POP HL
000426 4426 C1              10      POP BC
000427 4427 09              11      ADD HL,BC
000428 4428 EB               4      EX  DE,HL
000429 4429 C9              10      RET
                                
       442A                     ROM_LDIRSLT:
00042A 442A EB               4      EX  DE,HL
       442B                     RLDIRSLT1:
00042B 442B 1A               7      LD  A,(DE)
00042C 442C 13               6      INC DE
00042D 442D C5              11      PUSH    BC
00042E 442E D5              11      PUSH    DE
00042F 442F E5              11      PUSH    HL
000430 4430 5F               4      LD  E,A
000431 4431 3A42F3          13      LD  A,(RAMAD1)
000434 4434 FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
000438 4438 DD211400        14      LD  IX,_WRSLT
00043C 443C CD1C00          17      CALL    _CALSLT
00043F 443F E1              10      POP HL
000440 4440 D1              10      POP DE
000441 4441 C1              10      POP BC
000442 4442 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
000444 4444 EA2B44          10      JP  PE,RLDIRSLT1
000447 4447 EB               4      EX  DE,HL
000448 4448 C9              10      RET
                                
       4449                     END_OF_LINE:
000449 4449 215EF5          10      LD  HL,BUF
       444C                     EOL1:
00044C 444C 7E               7      LD  A,(HL)
00044D 444D C8              11      RET Z
00044E 444E FE0D             7      CP  00DH
000450 4450 2807            12      JR  Z,EOLE
000452 4452 FE0A             7      CP  00AH
000454 4454 2803            12      JR  Z,EOLE
000456 4456 23               6      INC HL
000457 4457 18F3            12      JR  EOL1
       4459                     EOLE:
000459 4459 3600            10      LD  (HL),0
00045B 445B 23               6      INC HL
00045C 445C 7E               7      LD  A,(HL)
00045D 445D FE0A             7      CP  00AH
00045F 445F C0              11      RET NZ
000460 4460 23               6      INC HL
000461 4461 C9              10      RET
                                
       4462                     ROM_LOAD_ASCII:
000462 4462 210000          10      LD  HL,0
000465 4465 2235F1          16      LD  (_BUF_ST),HL    ;読み出し位置
000468 4468 2A76F6          16      LD  HL,(TXTTAB)
00046B 446B 2237F1          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
00046E 446E 215EF5          10      LD  HL,BUF
000471 4471 222AF1          16      LD  (_DTA),HL
       4474                     RLOAD_A1:
000474 4474 2A35F1          16      LD  HL,(_BUF_ST)
000477 4477 2220F1          16      LD  (RR_LOW),HL
00047A 447A 210201          10      LD  HL,258
00047D 447D CDAB46          17      CALL    ROM_READ
000480 4480 7C               4      LD  A,H
000481 4481 B5               4      OR  L
000482 4482 2877            12      JR  Z,RLOAD_AEND
000484 4484 015EF5          10      LD  BC,BUF
000487 4487 09              11      ADD HL,BC
000488 4488 3600            10      LD  (HL),0
00048A 448A CD4944          17      CALL    END_OF_LINE
00048D 448D 015EF5          10      LD  BC,BUF
000490 4490 A7               4      AND A
000491 4491 ED42            15      SBC HL,BC
000493 4493 2810            12      JR  Z,RLOAD_A2
000495 4495 4D               4      LD  C,L
000496 4496 44               4      LD  B,H
000497 4497 ED5B35F1        20      LD  DE,(_BUF_ST)
00049B 449B 19              11      ADD HL,DE
00049C 449C 2235F1          16      LD  (_BUF_ST),HL
00049F 449F 3A5EF5          13      LD  A,(BUF)
0004A2 44A2 B7               4      OR  A
0004A3 44A3 28CF            12      JR  Z,RLOAD_A1
       44A5                     RLOAD_A2:
0004A5 44A5 115EF5          10      LD  DE,BUF
0004A8 44A8 CD2148          17      CALL    SPCUTEX
0004AB 44AB 1A               7      LD  A,(DE)
0004AC 44AC B7               4      OR  A
0004AD 44AD 284C            12      JR  Z,RLOAD_AEND
0004AF 44AF CD3348          17      CALL    GETNUM
0004B2 44B2 7C               4      LD  A,H
0004B3 44B3 B5               4      OR  L
0004B4 44B4 CA5245          10      JP  Z,ERROR_DIRECT_IN_FILE
0004B7 44B7 DD2A37F1        20      LD  IX,(_BUF_EN)
0004BB 44BB DD7502          19      LD  (IX+2),L
0004BE 44BE DD7403          19      LD  (IX+3),H
                                
0004C1 44C1 CD1A48          17      CALL    SPCUT
0004C4 44C4 EB               4      EX  DE,HL
0004C5 44C5 DDE5            15      PUSH    IX
0004C7 44C7 DD21B242        14      LD  IX,CRUNCH
0004CB 44CB FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
0004CF 44CF CD1C00          17      CALL    _CALSLT
0004D2 44D2 DDE1            14      POP IX
0004D4 44D4 EB               4      EX  DE,HL
0004D5 44D5 111FF4          10      LD  DE,KBUF
0004D8 44D8 37               4      SCF
0004D9 44D9 ED52            15      SBC HL,DE
0004DB 44DB 2875            12      JR  Z,ERROR_DIRECT_IN_FILE
0004DD 44DD 3873            12      JR  C,ERROR_DIRECT_IN_FILE
0004DF 44DF 4D               4      LD  C,L
0004E0 44E0 44               4      LD  B,H
0004E1 44E1 2A37F1          16      LD  HL,(_BUF_EN)
0004E4 44E4 110400          10      LD  DE,4
0004E7 44E7 19              11      ADD HL,DE
0004E8 44E8 111FF4          10      LD  DE,KBUF
                                
0004EB 44EB EB               4      EX  DE,HL
0004EC 44EC EDB0                    LDIR
0004EE 44EE EB               4      EX  DE,HL
                                
0004EF 44EF DD7500          19      LD  (IX+0),L
0004F2 44F2 DD7401          19      LD  (IX+1),H
0004F5 44F5 2237F1          16      LD  (_BUF_EN),HL
0004F8 44F8 C37444          10      JP  RLOAD_A1
                                
       44FB                     RLOAD_AEND:
0004FB 44FB 2A37F1          16      LD  HL,(_BUF_EN)
0004FE 44FE AF               4      XOR A
0004FF 44FF 77               7      LD  (HL),A
000500 4500 23               6      INC HL
000501 4501 77               7      LD  (HL),A
000502 4502 23               6      INC HL
000503 4503 2237F1          16      LD  (_BUF_EN),HL
000506 4506 1833            12      JR  RLOAD_END1
                                
       4508                     ROM_LOAD:
000508 4508 CD8346          17      CALL    INIT_PARAM
00050B 450B CD4A47          17      CALL    FILE_B
00050E 450E CD8A48          17      CALL    ROM_OPEN
000511 4511 3845            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000513 4513 2134F1          10      LD  HL,_BUF
000516 4516 222AF1          16      LD  (_DTA),HL
000519 4519 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
00051C 451C CDAB46          17      CALL    ROM_READ
00051F 451F 3A34F1          13      LD  A,(_BUF)
000522 4522 3C               4      INC A
000523 4523 C26244          10      JP  NZ,ROM_LOAD_ASCII
000526 4526 2A76F6          16      LD  HL,(TXTTAB)
000529 4529 222AF1          16      LD  (_DTA),HL
00052C 452C EB               4      EX  DE,HL
00052D 452D 2100FF          10      LD  HL,-256
000530 4530 39              11      ADD HL,SP
000531 4531 ED52            15      SBC HL,DE
000533 4533 CDAB46          17      CALL    ROM_READ
000536 4536 ED5B2AF1        20      LD  DE,(_DTA)
00053A 453A 19              11      ADD HL,DE
       453B                     RLOAD_END1:
00053B 453B 22C2F6          16      LD  (VARTAB),HL
00053E 453E 22C4F6          16      LD  (ARYTAB),HL
000541 4541 22C6F6          16      LD  (STREND),HL
                                
000544 4544 AF               4      XOR A
000545 4545 2137F1          10      LD  HL,_BUF+3
000548 4548 77               7      LD  (HL),A
000549 4549 2B               6      DEC HL
00054A 454A 77               7      LD  (HL),A
00054B 454B 2B               6      DEC HL
00054C 454C 77               7      LD  (HL),A
00054D 454D 2B               6      DEC HL
00054E 454E 3E8F             7      LD  A,08FH          ;REM
000550 4550 77               7      LD  (HL),A
000551 4551 C9              10      RET
                                
       4552                     ERROR_DIRECT_IN_FILE:
000552 4552 1E39             7      LD  E,57            ;Direct statement in file
000554 4554 01                      DB  1           ;LD BC,
       4555                     ERROR_FILE_NOT_OPEN:
000555 4555 1E3B             7      LD  E,59            ;File not OPEN
000557 4557 01                      DB  1           ;LD BC,
       4558                     ERROR_FILE_NOT_FOUND:
000558 4558 1E35             7      LD  E,53            ;File not found
       455A                     ERROR:
00055A 455A FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
00055E 455E DD216F40        14      LD  IX,ERRHAND
000562 4562 C31C00          10      JP  _CALSLT
                                
       4565                     ROM_BLOAD:
000565 4565 CD8346          17      CALL    INIT_PARAM
000568 4568 CD4A47          17      CALL    FILE_B
00056B 456B CD8A48          17      CALL    ROM_OPEN
00056E 456E 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000570 4570 2134F1          10      LD  HL,_BUF
000573 4573 222AF1          16      LD  (_DTA),HL
000576 4576 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
000579 4579 CDAB46          17      CALL    ROM_READ
00057C 457C 3A34F1          13      LD  A,(_BUF)
00057F 457F FEFE             7      CP  0FEH
000581 4581 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
000583 4583 210AF1          10      LD  HL,BLOAD_RET
000586 4586 2202F1          16      LD  (SWC_BLOAD),HL
                                
000589 4589 2A45F1          16      LD  HL,(PARAM1)
00058C 458C 7E               7      LD  A,(HL)
00058D 458D FE2C             7      CP  ','
00058F 458F 2048            12      JR  NZ,RBREAD_MEM
000591 4591 23               6      INC HL
000592 4592 7E               7      LD  A,(HL)
000593 4593 CD7448          17      CALL    CAP
000596 4596 32BEFC          13      LD  (RUNBNF),A
       4599                     RBOS1:
000599 4599 7E               7      LD  A,(HL)
00059A 459A 23               6      INC HL
00059B 459B B7               4      OR  A
00059C 459C 282F            12      JR  Z,RBREAD_OSE
00059E 459E FE3A             7      CP  ':'
0005A0 45A0 282B            12      JR  Z,RBREAD_OSE
0005A2 45A2 FE2C             7      CP  ','     ;次のパラメータを探す
0005A4 45A4 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
0005A6 45A6 2245F1          16      LD  (PARAM1),HL
0005A9 45A9 7E               7      LD  A,(HL)
0005AA 45AA B7               4      OR  A
0005AB 45AB 2820            12      JR  Z,RBREAD_OSE
0005AD 45AD DD21644C        14      LD  IX,FRMEVL
0005B1 45B1 FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
0005B5 45B5 CD1C00          17      CALL    _CALSLT
0005B8 45B8 2245F1          16      LD  (PARAM1),HL
0005BB 45BB 3A63F6          13      LD  A,(VALTYP)
0005BE 45BE FE02             7      CP  2
0005C0 45C0 200B            12      JR  NZ,RBREAD_OSE
0005C2 45C2 2A35F1          16      LD  HL,(_BUF_ST)
0005C5 45C5 ED5BF8F7        20      LD  DE,(DACDAT)
0005C9 45C9 19              11      ADD HL,DE
0005CA 45CA 2235F1          16      LD  (_BUF_ST),HL
       45CD                     RBREAD_OSE:
0005CD 45CD 3ABEFC          13      LD  A,(RUNBNF)
0005D0 45D0 FE53             7      CP  'S'
0005D2 45D2 2005            12      JR  NZ,RBREAD_MEM
0005D4 45D4 3E01             7      LD  A,1
0005D6 45D6 322CF1          13      LD  (FLG_LDIR),A
       45D9                     RBREAD_MEM:
0005D9 45D9 2A35F1          16      LD  HL,(_BUF_ST)
0005DC 45DC 22BFFC          16      LD  (SAVENT),HL
0005DF 45DF 222AF1          16      LD  (_DTA),HL
0005E2 45E2 21FFFF          10      LD  HL,0FFFFH
0005E5 45E5 CDAB46          17      CALL    ROM_READ
0005E8 45E8 3ABEFC          13      LD  A,(RUNBNF)
0005EB 45EB FE52             7      CP  'R'
0005ED 45ED 2006            12      JR  NZ,RBREAD1
0005EF 45EF 2A39F1          16      LD  HL,(_BUF_EX)
0005F2 45F2 2202F1          16      LD  (SWC_BLOAD),HL
       45F5                     RBREAD1:
       45F5                     ROM_NEXT:
0005F5 45F5 2A45F1          16      LD  HL,(PARAM1)
0005F8 45F8 7E               7      LD  A,(HL)
0005F9 45F9 2B               6      DEC HL
0005FA 45FA B7               4      OR  A
0005FB 45FB 2805            12      JR  Z,RN1
0005FD 45FD FE3A             7      CP  ':'
0005FF 45FF 2801            12      JR  Z,RN1
000601 4601 23               6      INC HL
       4602                     RN1:
000602 4602 5D               4      LD  E,L
000603 4603 54               4      LD  D,H
                                
000604 4604 CD4A48          17      CALL    SEARCH_END
000607 4607 B7               4      OR  A
000608 4608 2815            12      JR  Z,REM
                                                    ;マルチステートメントの処理
00060A 460A 7E               7      LD  A,(HL)
                                
00060B 460B FEB5             7      CP  0B5H            ;LOAD
00060D 460D CA0845          10      JP  Z,ROM_LOAD
000610 4610 FE8A             7      CP  08AH            ;RUN
000612 4612 280F            12      JR  Z,ROM_RUN
000614 4614 FEB7             7      CP  0B7H            ;FILES
000616 4616 2818            12      JR  Z,ROM_FILES
000618 4618 3E28             7      LD  A,028H          ;JR Z,
00061A 461A 3208F1          13      LD  (SWC_BLOAD_M),A
00061D 461D 7E               7      LD  A,(HL)
00061E 461E C9              10      RET
                                
       461F                     REM:
00061F 461F EB               4      EX  DE,HL
000620 4620 3E8F             7      LD  A,08FH          ;REM
000622 4622 C9              10      RET
                                
       4623                     ROM_RUN:
000623 4623 23               6      INC HL
000624 4624 7E               7      LD  A,(HL)
000625 4625 2B               6      DEC HL
000626 4626 B7               4      OR  A
000627 4627 2803            12      JR  Z,ROM_RUN1
000629 4629 CD0845          17      CALL    ROM_LOAD
       462C                     ROM_RUN1:
00062C 462C 3E8A             7      LD  A,08AH          ;RUN
00062E 462E 77               7      LD  (HL),A
00062F 462F C9              10      RET
                                
       4630                     ROM_FILES:
000630 4630 CD8346          17      CALL    INIT_PARAM
000633 4633 CD4A47          17      CALL    FILE_B
000636 4636 CD414C          17      CALL    GET_DISK_BANK_FDRV
000639 4639 320068          13      LD  (BANK1_SEL),A
00063C 463C 3A48F1          13      LD  A,(FNAME)
00063F 463F FE21             7      CP  021H
000641 4641 3005            12      JR  NC,RFILES0
000643 4643 060B             7      LD  B,11
000645 4645 CDDE47          17      CALL    FILE10
       4648                     RFILES0:
000648 4648 CD914A          17      CALL    GET_DIR_DAT
       464B                     RFILES1:
00064B 464B CDA948          17      CALL    FILESE
00064E 464E 302E            12      JR  NC,RFILES_NOT_MATCH
       4650                     RFILES_DISP:
000650 4650 E5              11      PUSH    HL
000651 4651 0608             7      LD  B,8
000653 4653 CD7B43          17      CALL    MSN
000656 4656 3E2E             7      LD  A,'.'
000658 4658 CD7F4C          17      CALL    MSG_A
00065B 465B 0603             7      LD  B,3
00065D 465D CD7B43          17      CALL    MSN
000660 4660 3ADDF3          13      LD  A,(CSRX)
000663 4663 47               4      LD  B,A
000664 4664 3AB0F3          13      LD  A,(LINLEN)
000667 4667 90               4      SUB B
000668 4668 FE0C             7      CP  12
00066A 466A 3009            12      JR  NC,RFILES2
00066C 466C 3E0D             7      LD  A,00DH      ;改行
00066E 466E CD7F4C          17      CALL    MSG_A
000671 4671 3E0A             7      LD  A,00AH
000673 4673 1802            12      JR  RFILES3
       4675                     RFILES2:
000675 4675 3E20             7      LD  A,020H
       4677                     RFILES3:
000677 4677 CD7F4C          17      CALL    MSG_A
00067A 467A E1              10      POP HL
00067B 467B CDC548          17      CALL    FNEXT
       467E                     RFILES_NOT_MATCH:
00067E 467E 20CB            12      JR  NZ,RFILES1
000680 4680 C3F545          10      JP  ROM_NEXT
                                
       4683                     INIT_PARAM:
000683 4683 2243F1          16      LD  (PARAM0),HL
000686 4686 EB               4      EX  DE,HL
000687 4687 AF               4      XOR A
000688 4688 322CF1          13      LD  (FLG_LDIR),A
00068B 468B 32BEFC          13      LD  (RUNBNF),A
00068E 468E 3263F6          13      LD  (VALTYP),A
000691 4691 13               6      INC DE
000692 4692 CD1A48          17      CALL    SPCUT
000695 4695 1A               7      LD  A,(DE)
000696 4696 B7               4      OR  A
000697 4697 C8              11      RET Z
000698 4698 FE3A             7      CP  ':'
00069A 469A C8              11      RET Z
00069B 469B EB               4      EX  DE,HL
00069C 469C DD21644C        14      LD  IX,FRMEVL
0006A0 46A0 FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
0006A4 46A4 CD1C00          17      CALL    _CALSLT
0006A7 46A7 2245F1          16      LD  (PARAM1),HL
0006AA 46AA C9              10      RET
                                
       46AB                     ROM_READ:
0006AB 46AB E5              11      PUSH    HL
0006AC 46AC D5              11      PUSH    DE
0006AD 46AD C5              11      PUSH    BC
0006AE 46AE FDE5            15      PUSH    IY
0006B0 46B0 2241F1          16      LD  (LEFTX),HL
0006B3 46B3 2A2AF1          16      LD  HL,(_DTA)
0006B6 46B6 223BF1          16      LD  (DTAX),HL
0006B9 46B9 2A41F1          16      LD  HL,(LEFTX)
                                
0006BC 46BC CDF148          17      CALL    RBX1
0006BF 46BF 386F            12      JR  C,RBRERR1
0006C1 46C1 79               4      LD  A,C
0006C2 46C2 EB               4      EX  DE,HL
0006C3 46C3 ED52            15      SBC HL,DE       ;CP 0HL,CDE
0006C5 46C5 19              11      ADD HL,DE
0006C6 46C6 DE00             7      SBC A,000H
0006C8 46C8 3801            12      JR  C,RBR1
0006CA 46CA EB               4      EX  DE,HL
       46CB                     RBR1:
0006CB 46CB 9F               4      SBC A,A
0006CC 46CC E601             7      AND 1
0006CE 46CE 321EF1          13      LD  (_RESULT),A
0006D1 46D1 7C               4      LD  A,H
0006D2 46D2 B5               4      OR  L
0006D3 46D3 CA2647          10      JP  Z,RBREND0
                                
0006D6 46D6 2226F1          16      LD  (_LEFT),HL  ;Read record byte
0006D9 46D9 2241F1          16      LD  (LEFTX),HL
                                
0006DC 46DC CD1A49          17      CALL    RBX2
0006DF 46DF 281A            12      JR  Z,RBRB
                                                ;先頭の端数
0006E1 46E1 CD2B49          17      CALL    RBXA
0006E4 46E4 DA3C47          10      JP  C,RBRERR
0006E7 46E7 C5              11      PUSH    BC
0006E8 46E8 CD0B44          17      CALL    ROM_LDIR
0006EB 46EB ED533BF1        20      LD  (DTAX),DE
0006EF 46EF 2A41F1          16      LD  HL,(LEFTX)
0006F2 46F2 D1              10      POP DE
0006F3 46F3 A7               4      AND A
0006F4 46F4 ED52            15      SBC HL,DE
0006F6 46F6 2241F1          16      LD  (LEFTX),HL
0006F9 46F9 2828            12      JR  Z,RBREND
                                
       46FB                     RBRB:
0006FB 46FB CD6449          17      CALL    RBXB
0006FE 46FE 2817            12      JR  Z,RBRC
       4700                     RBRB1:
000700 4700 C5              11      PUSH    BC
000701 4701 D5              11      PUSH    DE
000702 4702 CDF949          17      CALL    CLUST
000705 4705 EB               4      EX  DE,HL
000706 4706 010004          10      LD  BC,1024     ;1クラスタのサイズ
000709 4709 CD0B44          17      CALL    ROM_LDIR
00070C 470C EB               4      EX  DE,HL
00070D 470D D1              10      POP DE
00070E 470E C1              10      POP BC
00070F 470F CDD649          17      CALL    GNCL
000712 4712 DA3C47          10      JP  C,RBRERR
000715 4715 10E9            13      DJNZ    RBRB1
       4717                     RBRC:
000717 4717 CD7449          17      CALL    RBXC
00071A 471A 2807            12      JR  Z,RBREND
                                
00071C 471C CDF949          17      CALL    CLUST
00071F 471F EB               4      EX  DE,HL
000720 4720 CD0B44          17      CALL    ROM_LDIR
       4723                     RBREND:
000723 4723 CD7E49          17      CALL    RBXEND
       4726                     RBREND0:
000726 4726 FDE1            14      POP IY
000728 4728 C1              10      POP BC
000729 4729 D1              10      POP DE
00072A 472A F1              10      POP AF  ;(HL)
00072B 472B AF               4      XOR A
00072C 472C 3A1EF1          13      LD  A,(_RESULT)
00072F 472F C9              10      RET
                                
       4730                     RBRERR1:
000730 4730 3E01             7      LD  A,001H
       4732                     RBRERR2:
000732 4732 FDE1            14      POP IY
000734 4734 C1              10      POP BC
000735 4735 D1              10      POP DE
000736 4736 E1              10      POP HL
000737 4737 37               4      SCF
000738 4738 210000          10      LD  HL,0
00073B 473B C9              10      RET
       473C                     RBRERR:
00073C 473C 3EFF             7      LD  A,0FFH
00073E 473E 18F2            12      JR  RBRERR2
                                
       4740                     FILE_DD:
000740 4740 3E                      DB  03EH
000741 4741 C9              10      RET
000742 4742 3208F1          13      LD  (SWC_BLOAD_M),A
000745 4745 2A43F1          16      LD  HL,(PARAM0)
000748 4748 7E               7      LD  A,(HL)
000749 4749 C9              10      RET
       474A                     FILE_B:
00074A 474A AF               4      XOR A
00074B 474B 3247F1          13      LD  (FDRV),A
00074E 474E 1E00             7      LD  E,0
000750 4750 3A63F6          13      LD  A,(VALTYP)
000753 4753 FE03             7      CP  3       ;string
000755 4755 2044            12      JR  NZ,FILED
                                
000757 4757 DD21D067        14      LD  IX,FRESTR
00075B 475B FD2AC1FC        20      LD  IY,(EXPTBL)     ;メインROMスロット
00075F 475F CD1C00          17      CALL    _CALSLT
000762 4762 E5              11      PUSH    HL
000763 4763 DDE1            14      POP IX
                                
000765 4765 DD5E00          19      LD  E,(IX+0)
000768 4768 DD7E01          19      LD  A,(IX+1)
00076B 476B DD5602          19      LD  D,(IX+2)
00076E 476E DD62             9      LD  IXH,D
000770 4770 DD6F             9      LD  IXL,A
000772 4772 7B               4      LD  A,E
000773 4773 FE04             7      CP  4
000775 4775 3808            12      JR  C,FILEB1
000777 4777 DD7E03          19      LD  A,(IX+3)
00077A 477A FE3A             7      CP  ':'
00077C 477C 28C2            12      JR  Z,FILE_DD
00077E 477E 7B               4      LD  A,E
       477F                     FILEB1:
00077F 477F FE02             7      CP  2
000781 4781 3818            12      JR  C,FILED
000783 4783 DD7E01          19      LD  A,(IX+1)
000786 4786 FE3A             7      CP  ':'
000788 4788 2011            12      JR  NZ,DEVI1
00078A 478A DD7E00          19      LD  A,(IX+0)        ;DRIVE
00078D 478D CD7448          17      CALL    CAP
000790 4790 D640             7      SUB '@'
000792 4792 DD23            10      INC IX
000794 4794 DD23            10      INC IX
000796 4796 1D               4      DEC E
000797 4797 1D               4      DEC E
000798 4798 3247F1          13      LD  (FDRV),A
       479B                     DEVI1:
                                
       479B                     FILED:
00079B 479B CDE247          17      CALL    FILEI
00079E 479E 2148F1          10      LD  HL,FNAME
                                
0007A1 47A1 0608             7      LD  B,8
       47A3                     FILE2:
0007A3 47A3 CDEF47          17      CALL    CCHKF
0007A6 47A6 C8              11      RET Z
0007A7 47A7 FE2A             7      CP  '*'
0007A9 47A9 282E            12      JR  Z,FILE9
0007AB 47AB FE2E             7      CP  '.'
0007AD 47AD 280C            12      JR  Z,FILE4
0007AF 47AF 77               7      LD  (HL),A
0007B0 47B0 23               6      INC HL
0007B1 47B1 10F0            13      DJNZ    FILE2
                                
       47B3                     FILE3:
0007B3 47B3 CDEF47          17      CALL    CCHKF
0007B6 47B6 C8              11      RET Z
0007B7 47B7 FE2E             7      CP  '.'
0007B9 47B9 20F8            12      JR  NZ,FILE3
                                
       47BB                     FILE4:
0007BB 47BB 2150F1          10      LD  HL,FNAME+8
0007BE 47BE 0603             7      LD  B,3
                                
       47C0                     FILE4L:
0007C0 47C0 CDEF47          17      CALL    CCHKF
0007C3 47C3 C8              11      RET Z
0007C4 47C4 FE2E             7      CP  '.'
0007C6 47C6 2008            12      JR  NZ,FILE12
0007C8 47C8 3248F1          13      LD  (FNAME),A   ;Parent directory(..)
0007CB 47CB 3249F1          13      LD  (FNAME+1),A
0007CE 47CE 3E20             7      LD  A,020H
       47D0                     FILE12:
0007D0 47D0 FE2A             7      CP  '*'
0007D2 47D2 280A            12      JR  Z,FILE10
0007D4 47D4 77               7      LD  (HL),A
0007D5 47D5 23               6      INC HL
0007D6 47D6 10E8            13      DJNZ    FILE4L
0007D8 47D8 C9              10      RET
                                
       47D9                     FILE9:              ;名前の*処理、名前の残りを?で埋める
0007D9 47D9 CDDE47          17      CALL    FILE10
0007DC 47DC 18D5            12      JR  FILE3
                                
       47DE                     FILE10:
0007DE 47DE 3E3F             7      LD  A,'?'
0007E0 47E0 1808            12      JR  FILL_MEMORY
       47E2                     FILEI:              ;名前＋拡張子をスペースで初期化
0007E2 47E2 3E20             7      LD  A,020H
0007E4 47E4 01000B          10      LD  BC,11*256   ;C=0にしておく
0007E7 47E7 2148F1          10      LD  HL,FNAME
       47EA                     FILL_MEMORY:            ;HLからBバイトAで埋める
0007EA 47EA 77               7      LD  (HL),A
0007EB 47EB 23               6      INC HL
0007EC 47EC 10FC            13      DJNZ    FILL_MEMORY
0007EE 47EE C9              10      RET
                                
       47EF                     CCHKF:
0007EF 47EF 7B               4      LD  A,E
0007F0 47F0 B7               4      OR  A
0007F1 47F1 C8              11      RET Z
0007F2 47F2 DD7E00          19      LD  A,(IX+0)
0007F5 47F5 CDFC47          17      CALL    CCHK2
0007F8 47F8 C8              11      RET Z
0007F9 47F9 C35F48          10      JP  FKAN
                                
       47FC                     CCHK2:
0007FC 47FC 0C               4      INC C
0007FD 47FD 0D               4      DEC C
0007FE 47FE C0              11      RET NZ
       47FF                     CCHK3:              ;ZF=1 で使えない文字
0007FF 47FF FE2B             7      CP  '+'
000801 4801 C8              11      RET Z
000802 4802 FE2C             7      CP  ','
000804 4804 C8              11      RET Z
000805 4805 FE2F             7      CP  '/'
000807 4807 C8              11      RET Z
000808 4808 FE3A             7      CP  ':'
00080A 480A C8              11      RET Z
00080B 480B FE3B             7      CP  ';'
00080D 480D C8              11      RET Z
00080E 480E FE3D             7      CP  '='
000810 4810 C8              11      RET Z
000811 4811 FE5C             7      CP  05CH    ;\
000813 4813 C8              11      RET Z
000814 4814 FE1F             7      CP  01FH
000816 4816 D0              11      RET NC
000817 4817 BF               4      CP  A       ;Z=1
000818 4818 C9              10      RET
                                
       4819                     SS1:
000819 4819 13               6      INC DE
       481A                     SPCUT:              ;スペースをカット
00081A 481A 1A               7      LD  A,(DE)
00081B 481B FE20             7      CP  020H
00081D 481D 28FA            12      JR  Z,SS1
00081F 481F C9              10      RET
                                
       4820                     SCREOF1:
000820 4820 13               6      INC DE
       4821                     SPCUTEX:            ;スペース改行などをカット
000821 4821 1A               7      LD  A,(DE)
000822 4822 FE20             7      CP  020H
000824 4824 28FA            12      JR  Z,SCREOF1
000826 4826 FE0D             7      CP  00DH
000828 4828 28F6            12      JR  Z,SCREOF1
00082A 482A FE0A             7      CP  00AH
00082C 482C 28F2            12      JR  Z,SCREOF1
00082E 482E FE1A             7      CP  01AH
000830 4830 28EE            12      JR  Z,SCREOF1
000832 4832 C9              10      RET
                                
       4833                     GETNUM:
000833 4833 210000          10      LD  HL,0
       4836                     GETNUM1:
000836 4836 1A               7      LD  A,(DE)
000837 4837 13               6      INC DE
000838 4838 D630             7      SUB '0'
00083A 483A D8              11      RET C
00083B 483B FE0A             7      CP  10
00083D 483D D0              11      RET NC
00083E 483E 4D               4      LD  C,L
00083F 483F 44               4      LD  B,H
000840 4840 29              11      ADD HL,HL   ;*2
000841 4841 29              11      ADD HL,HL   ;*4
000842 4842 09              11      ADD HL,BC   ;*5
000843 4843 29              11      ADD HL,HL   ;*10
000844 4844 4F               4      LD  C,A
000845 4845 0600             7      LD  B,0
000847 4847 09              11      ADD HL,BC
000848 4848 18EC            12      JR  GETNUM1
                                
       484A                     SEARCH_END:
00084A 484A 7E               7      LD  A,(HL)
       484B                     SEARCH_END1:
00084B 484B 23               6      INC HL
00084C 484C B7               4      OR  A
00084D 484D C8              11      RET Z
00084E 484E FE3A             7      CP  ':'
000850 4850 20F8            12      JR  NZ,SEARCH_END
000852 4852 7E               7      LD  A,(HL)
000853 4853 FE3A             7      CP  ':'
000855 4855 28F4            12      JR  Z,SEARCH_END1
000857 4857 C9              10      RET
                                
       4858                     FKANC:
000858 4858 CB41             8      BIT 0,C
00085A 485A CC7D48          17      CALL    Z,CAP2
00085D 485D 1803            12      JR  FKANX
       485F                     FKAN:           ;漢字チェック
00085F 485F DD23            10      INC IX
000861 4861 1D               4      DEC E
       4862                     FKANX:
000862 4862 CB41             8      BIT 0,C
000864 4864 CB81             8      RES 0,C
000866 4866 C0              11      RET NZ
000867 4867 FE80             7      CP  080H
000869 4869 D8              11      RET C
00086A 486A FEA0             7      CP  0A0H
00086C 486C 3803            12      JR  C,FKAN1
00086E 486E FEE0             7      CP  0E0H
000870 4870 D8              11      RET C
       4871                     FKAN1:
000871 4871 0C               4      INC C
000872 4872 A7               4      AND A
000873 4873 C9              10      RET
                                
       4874                     CAP:
000874 4874 FE61             7      CP  'a'
000876 4876 D8              11      RET C
000877 4877 FE7B             7      CP  'z'+1
000879 4879 D0              11      RET NC
00087A 487A D620             7      SUB 020H
00087C 487C C9              10      RET
       487D                     CAP2:
00087D 487D CD7448          17      CALL    CAP
       4880                     CAP3:               ;
000880 4880 FE05             7      CP  5
000882 4882 2803            12      JR  Z,CAP4
000884 4884 FE21             7      CP  021H
000886 4886 C9              10      RET
       4887                     CAP4:
000887 4887 3EE5             7      LD  A,0E5H
000889 4889 C9              10      RET
                                
       488A                     ROM_OPEN:
00088A 488A CD414C          17      CALL    GET_DISK_BANK_FDRV
00088D 488D 320068          13      LD  (BANK1_SEL),A
                                
000890 4890 CD914A          17      CALL    GET_DIR_DAT
000893 4893 D5              11      PUSH    DE
000894 4894 CDA948          17      CALL    FILESE
000897 4897 D1              10      POP DE
000898 4898 3F               4      CCF
000899 4899 D8              11      RET C
00089A 489A 223FF1          16      LD  (FCBX),HL
00089D 489D E5              11      PUSH    HL
00089E 489E 210000          10      LD  HL,0
0008A1 48A1 2220F1          16      LD  (RR_LOW),HL
0008A4 48A4 2222F1          16      LD  (RR_HIGH),HL
0008A7 48A7 E1              10      POP HL
0008A8 48A8 C9              10      RET
                                
       48A9                     FILESE:
0008A9 48A9 7E               7      LD  A,(HL)
0008AA 48AA B7               4      OR  A
0008AB 48AB C8              11      RET Z       ;END:ZF=1 CF=0
0008AC 48AC FEE5             7      CP  0E5H
0008AE 48AE 280D            12      JR  Z,FILESE1
0008B0 48B0 1148F1          10      LD  DE,FNAME
0008B3 48B3 E5              11      PUSH    HL
0008B4 48B4 CDCB48          17      CALL    CPFILE
0008B7 48B7 CCEC48          17      CALL    Z,CPFILE2
0008BA 48BA E1              10      POP HL
0008BB 48BB 37               4      SCF
0008BC 48BC C8              11      RET Z       ;!!!:(ZF=1) CF=1
       48BD                     FILESE1:
0008BD 48BD CDC548          17      CALL    FNEXT
0008C0 48C0 20E7            12      JR  NZ,FILESE
       48C2                     ZF0_CF0_AFF_RET:
0008C2 48C2 F6FF             7      OR  0FFH        ;ZF=0 CF=0
0008C4 48C4 C9              10      RET
                                
       48C5                     FNEXT:
                                ;   PUSH    HL
                                ;   LD  HL,_FILEN
                                ;   INC (HL)
                                ;   POP HL
0008C5 48C5 112000          10      LD  DE,020H
0008C8 48C8 19              11      ADD HL,DE
0008C9 48C9 0D               4      DEC C
0008CA 48CA C9              10      RET
                                
       48CB                     CPFILE:
0008CB 48CB C5              11      PUSH    BC
0008CC 48CC 01000B          10      LD  BC,00B00H
       48CF                     CPSTR1:
0008CF 48CF 1A               7      LD  A,(DE)
0008D0 48D0 FE3F             7      CP  '?'     ;Wild card
0008D2 48D2 2812            12      JR  Z,CPSTR2
0008D4 48D4 7E               7      LD  A,(HL)
0008D5 48D5 CD5848          17      CALL    FKANC
0008D8 48D8 E5              11      PUSH    HL
0008D9 48D9 67               4      LD  H,A
0008DA 48DA 1A               7      LD  A,(DE)
0008DB 48DB CB01             4      RLC C
0008DD 48DD CD5848          17      CALL    FKANC
0008E0 48E0 CB09             4      RRC C
0008E2 48E2 BC               4      CP  H       ;CP (HL),(DE)
0008E3 48E3 E1              10      POP HL
0008E4 48E4 2004            12      JR  NZ,CPSTR3
       48E6                     CPSTR2:
0008E6 48E6 13               6      INC DE
0008E7 48E7 23               6      INC HL
0008E8 48E8 10E5            13      DJNZ    CPSTR1
       48EA                     CPSTR3:
0008EA 48EA C1              10      POP BC
0008EB 48EB C9              10      RET
                                
       48EC                     CPFILE2:
                                ;   LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
                                ;   OR  0E1H
0008EC 48EC 3EE1             7      LD  A,0E1H
0008EE 48EE 2F               4      CPL
0008EF 48EF A6               7      AND (HL)
0008F0 48F0 C9              10      RET
                                
       48F1                     RBX1:
0008F1 48F1 E5              11      PUSH    HL      ;Record byte
                                
0008F2 48F2 ED5B20F1        20      LD  DE,(RR_LOW) ;CDE=Random record
0008F6 48F6 3A23F1          13      LD  A,(RR_HIGH+1)
0008F9 48F9 4F               4      LD  C,A
                                
0008FA 48FA CD414C          17      CALL    GET_DISK_BANK_FDRV
0008FD 48FD 320068          13      LD  (BANK1_SEL),A
                                
000900 4900 FD2A3FF1        20      LD  IY,(FCBX)
000904 4904 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000907 4907 FD661D          19      LD  H,(IY+01DH)
00090A 490A FD7E1E          19      LD  A,(IY+01EH)
                                
00090D 490D A7               4      AND A
00090E 490E ED52            15      SBC HL,DE
000910 4910 99               4      SBC A,C
000911 4911 D1              10      POP DE
                                
000912 4912 D8              11      RET C
000913 4913 4F               4      LD  C,A
000914 4914 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000915 4915 B2               4      OR  D
000916 4916 B3               4      OR  E
000917 4917 C0              11      RET NZ
000918 4918 37               4      SCF
000919 4919 C9              10      RET
                                
       491A                     RBX2:
00091A 491A ED4B21F1        20      LD  BC,(RR_LOW+1)
00091E 491E CD9349          17      CALL    RWXR
000921 4921 3E03             7      LD  A,3     ;ooo 1
000923 4923 E5              11      PUSH    HL
000924 4924 2A20F1          16      LD  HL,(RR_LOW)
000927 4927 A4               4      AND H
000928 4928 B5               4      OR  L
000929 4929 E1              10      POP HL
00092A 492A C9              10      RET
                                
       492B                     RBXA:
00092B 492B D5              11      PUSH    DE
00092C 492C CDF949          17      CALL    CLUST
00092F 492F ED5328F1        20      LD  (_DTPS),DE
000933 4933 D1              10      POP DE
000934 4934 CDD649          17      CALL    GNCL
000937 4937 D8              11      RET C
000938 4938 ED5324F1        20      LD  (_CLPS),DE
                                
00093C 493C ED4B20F1        20      LD  BC,(RR_LOW)
000940 4940 3E03             7      LD  A,3     ;ooo 1
000942 4942 A0               4      AND B
000943 4943 47               4      LD  B,A
000944 4944 210004          10  IBM7:   LD  HL,1024     ;ooo 512
000947 4947 ED42            15      SBC HL,BC       ;remaining cluster
                                
000949 4949 ED5B41F1        20      LD  DE,(LEFTX)
00094D 494D ED52            15      SBC HL,DE       ;CP HL,DE
00094F 494F 19              11      ADD HL,DE
000950 4950 3801            12      JR  C,RBXA1
000952 4952 EB               4      EX  DE,HL
       4953                     RBXA1:
000953 4953 3A1FF1          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
000956 4956 320068          13      LD  (BANK1_SEL),A   ;ASCII-8K/Konami-8K共通で使える
000959 4959 E5              11      PUSH    HL
00095A 495A 2A28F1          16      LD  HL,(_DTPS)
00095D 495D 09              11      ADD HL,BC
00095E 495E ED5B3BF1        20      LD  DE,(DTAX)
000962 4962 C1              10      POP BC
000963 4963 C9              10      RET
                                
       4964                     RBXB:
000964 4964 2A3BF1          16      LD  HL,(DTAX)
000967 4967 ED5B24F1        20      LD  DE,(_CLPS)
00096B 496B 3A42F1          13      LD  A,(LEFTX+1)
00096E 496E CB3F             8      SRL A
000970 4970 CB3F             8  IBM8:   SRL A       ;ooo
000972 4972 47               4      LD  B,A
000973 4973 C9              10      RET
                                
       4974                     RBXC:
000974 4974 ED4B41F1        20      LD  BC,(LEFTX)
000978 4978 3E03             7      LD  A,3     ;ooo 1
00097A 497A A0               4      AND B
00097B 497B 47               4      LD  B,A
00097C 497C B1               4      OR  C
00097D 497D C9              10      RET
                                
       497E                     RBXEND:
00097E 497E ED5B26F1        20      LD  DE,(_LEFT)
000982 4982 2A20F1          16      LD  HL,(RR_LOW)
000985 4985 3A23F1          13      LD  A,(RR_HIGH+1)
000988 4988 19              11      ADD HL,DE
000989 4989 CE00             7      ADC A,0
00098B 498B 2220F1          16      LD  (RR_LOW),HL
00098E 498E 3223F1          13      LD  (RR_HIGH+1),A
000991 4991 EB               4      EX  DE,HL       ;HL=Read byte
000992 4992 C9              10      RET 
                                
       4993                     RWXR:
000993 4993 CB38             8      SRL B
000995 4995 CB19             8      RR  C
000997 4997 CB38             8  IBM4:   SRL B   ;ooo
000999 4999 CB19             8      RR  C
                                
00099B 499B CD414C          17      CALL    GET_DISK_BANK_FDRV
00099E 499E 320068          13      LD  (BANK1_SEL),A
                                
0009A1 49A1 FD2A3FF1        20      LD  IY,(FCBX)
0009A5 49A5 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
0009A8 49A8 FD561B          19      LD  D,(IY+01BH)
       49AB                     RWX1:
0009AB 49AB ED5324F1        20      LD  (_CLPS),DE
0009AF 49AF 7A               4      LD  A,D
0009B0 49B0 B3               4      OR  E
0009B1 49B1 37               4      SCF
0009B2 49B2 C8              11      RET Z
                                
0009B3 49B3 78               4      LD  A,B
0009B4 49B4 B1               4      OR  C
0009B5 49B5 C8              11      RET Z
                                
0009B6 49B6 CDD649          17      CALL    GNCL
0009B9 49B9 D8              11      RET C
0009BA 49BA 0B               6      DEC BC
0009BB 49BB CD2A4A          17      CALL    ENDCL
0009BE 49BE 38EB            12      JR  C,RWX1
0009C0 49C0 37               4      SCF
0009C1 49C1 C9              10      RET
                                
       49C2                     NCL3:
0009C2 49C2 CD414C          17      CALL    GET_DISK_BANK_FDRV
0009C5 49C5 320068          13      LD  (BANK1_SEL),A
0009C8 49C8 6B               4      LD  L,E
0009C9 49C9 62               4      LD  H,D
0009CA 49CA CB3C             8      SRL H
0009CC 49CC CB1D             8      RR  L
0009CE 49CE 1F               4      RRA
0009CF 49CF 010062          10      LD  BC,_FATBF
0009D2 49D2 19              11      ADD HL,DE
0009D3 49D3 09              11      ADD HL,BC
0009D4 49D4 17               4      RLA
0009D5 49D5 C9              10      RET
                                
       49D6                     GNCL:
0009D6 49D6 7A               4      LD  A,D
0009D7 49D7 B3               4      OR  E
0009D8 49D8 37               4      SCF
0009D9 49D9 C8              11      RET Z
0009DA 49DA C5              11      PUSH    BC
0009DB 49DB E5              11      PUSH    HL
0009DC 49DC CDC249          17      CALL    NCL3
0009DF 49DF 3809            12      JR  C,GNC1
0009E1 49E1 5E               7      LD  E,(HL)
0009E2 49E2 23               6      INC HL
0009E3 49E3 7E               7      LD  A,(HL)
0009E4 49E4 E60F             7      AND 00FH
0009E6 49E6 57               4      LD  D,A
0009E7 49E7 E1              10      POP HL
0009E8 49E8 C1              10      POP BC
0009E9 49E9 C9              10      RET
       49EA                     GNC1:
0009EA 49EA 7E               7      LD  A,(HL)
0009EB 49EB 23               6      INC HL
0009EC 49EC 56               7      LD  D,(HL)
0009ED 49ED 0604             7      LD  B,4
       49EF                     GNC1L:
0009EF 49EF CB3A             8      SRL D
0009F1 49F1 1F               4      RRA
0009F2 49F2 10FB            13      DJNZ    GNC1L
                                
0009F4 49F4 5F               4      LD  E,A
0009F5 49F5 E1              10      POP HL
0009F6 49F6 C1              10      POP BC
0009F7 49F7 A7               4      AND A
0009F8 49F8 C9              10      RET
                                
       49F9                     CLUST:
0009F9 49F9 EB               4      EX  DE,HL
0009FA 49FA C5              11      PUSH    BC
0009FB 49FB CD9F4A          17      CALL    GET_DIR_POS
0009FE 49FE 87               4      ADD A,A
0009FF 49FF 3D               4      DEC A
000A00 4A00 4F               4      LD  C,A
000A01 4A01 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000A04 4A04 0F               4      RRCA
000A05 4A05 0F               4      RRCA
000A06 4A06 0F               4      RRCA
000A07 4A07 0F               4      RRCA
000A08 4A08 81               4      ADD A,C
000A09 4A09 C1              10      POP BC
000A0A 4A0A 29              11      ADD HL,HL   ;*2
000A0B 4A0B 29              11      ADD HL,HL   ;*4
000A0C 4A0C 85               4      ADD A,L
000A0D 4A0D 6F               4      LD  L,A
000A0E 4A0E 8C               4      ADC A,H
000A0F 4A0F 95               4      SUB L
000A10 4A10 67               4      LD  H,A
000A11 4A11 E5              11      PUSH    HL
000A12 4A12 29              11      ADD HL,HL
000A13 4A13 29              11      ADD HL,HL
000A14 4A14 29              11      ADD HL,HL
000A15 4A15 CD414C          17      CALL    GET_DISK_BANK_FDRV
000A18 4A18 84               4      ADD A,H
000A19 4A19 320068          13      LD  (BANK1_SEL),A
000A1C 4A1C 321FF1          13      LD  (_BANK),A
000A1F 4A1F E1              10      POP HL
000A20 4A20 3E1F             7      LD  A,01FH
000A22 4A22 A5               4      AND L
000A23 4A23 C660             7      ADD A,high BANK1_ADR
000A25 4A25 67               4      LD  H,A
000A26 4A26 2E00             7      LD  L,0
000A28 4A28 EB               4      EX  DE,HL
000A29 4A29 C9              10      RET
                                
       4A2A                     ENDCL:
000A2A 4A2A 7A               4      LD  A,D ;END CLUSTER
000A2B 4A2B FE0F             7      CP  00FH    ;FAT12の最大値
000A2D 4A2D C0              11      RET NZ
000A2E 4A2E 7B               4      LD  A,E
000A2F 4A2F FEF7             7      CP  0F7H
000A31 4A31 C9              10      RET
                                
       4A32                     RB_READ:
000A32 4A32 AF               4      XOR A   ;HLA = HL*128
000A33 4A33 CB3C             8      SRL H
000A35 4A35 CB1D             8      RR  L
000A37 4A37 1F               4      RRA
000A38 4A38 3220F1          13      LD  (RR_LOW),A
000A3B 4A3B 2221F1          16      LD  (RR_MID),HL
000A3E 4A3E 218000          10      LD  HL,128
                                
000A41 4A41 CDAB46          17      CALL    ROM_READ
000A44 4A44 C9              10      RET
                                
       4A45                     GETSEQ:
000A45 4A45 FD6E20          19      LD  L,(IY+32)
000A48 4A48 FD660C          19      LD  H,(IY+12)
                                
000A4B 4A4B CB25             8      SLA L
                                
000A4D 4A4D CB3C             8      SRL H
000A4F 4A4F CB1D             8      RR  L
000A51 4A51 C9              10      RET
                                
       4A52                     SETSEQ:
000A52 4A52 F5              11      PUSH    AF
000A53 4A53 3A20F1          13      LD  A,(RR_LOW)
000A56 4A56 2A21F1          16      LD  HL,(RR_MID)
                                
000A59 4A59 CD704A          17      CALL    SSQ1
                                
000A5C 4A5C 29              11      ADD HL,HL
000A5D 4A5D CB3D             8      SRL L
000A5F 4A5F FD7520          19      LD  (IY+32),L
000A62 4A62 FD740C          19      LD  (IY+12),H
000A65 4A65 F1              10      POP AF
000A66 4A66 C9              10      RET
                                
       4A67                     GETSIZE:
000A67 4A67 FD7E10          19      LD  A,(IY+16)
000A6A 4A6A FD6E11          19      LD  L,(IY+17)
000A6D 4A6D FD6612          19      LD  H,(IY+18)
       4A70                     SSQ1:
000A70 4A70 87               4      ADD A,A
000A71 4A71 ED6A            15      ADC HL,HL
000A73 4A73 B7               4      OR  A
000A74 4A74 C8              11      RET Z
000A75 4A75 23               6      INC HL
000A76 4A76 C9              10      RET
                                
       4A77                     SET_FCB:
000A77 4A77 D5              11      PUSH    DE
000A78 4A78 FDE1            14      POP IY
000A7A 4A7A FD7E1C          19      LD  A,(IY+28)
000A7D 4A7D FEFF             7      CP  0FFH
000A7F 4A7F 200C            12      JR  NZ,POPAF_SCF_FF_RET
000A81 4A81 E5              11      PUSH    HL
000A82 4A82 FD6E1A          19      LD  L,(IY+26)
000A85 4A85 FD661B          19      LD  H,(IY+27)
000A88 4A88 2224F1          16      LD  (_CLPS),HL
000A8B 4A8B E1              10      POP HL
000A8C 4A8C C9              10      RET
                                
       4A8D                     POPAF_SCF_FF_RET:
000A8D 4A8D F1              10      POP AF
000A8E 4A8E 37               4      SCF
000A8F 4A8F 9F               4      SBC A,A
000A90 4A90 C9              10      RET
                                
       4A91                     GET_DIR_DAT:
000A91 4A91 CD9F4A          17      CALL    GET_DIR_POS
000A94 4A94 87               4      ADD A,A         ;*2
000A95 4A95 C660             7      ADD A,high BANK1_ADR
000A97 4A97 2E00             7      LD  L,0
000A99 4A99 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*512
000A9A 4A9A 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000A9D 4A9D 4F               4      LD  C,A
000A9E 4A9E C9              10      RET
                                
       4A9F                     GET_DIR_POS:
000A9F 4A9F CD414C          17      CALL    GET_DISK_BANK_FDRV
000AA2 4AA2 320068          13      LD  (BANK1_SEL),A
000AA5 4AA5 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000AA8 4AA8 47               4      LD  B,A
000AA9 4AA9 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000AAC 4AAC 4F               4      LD  C,A
000AAD 4AAD 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4AB0                     GET_DIR_POS1:
000AB0 4AB0 81               4      ADD A,C
000AB1 4AB1 10FD            13      DJNZ    GET_DIR_POS1
000AB3 4AB3 C9              10      RET
                                
       4AB4                     WILDCARD:
000AB4 4AB4 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4ABF                     ERROR_WRITE_PROTECTED:
000ABF 4ABF 3E00             7      LD  A,0     ;Write protected
000AC1 4AC1 C9              10      RET
       4AC2                     DISKIO:
000AC2 4AC2 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000AC4 4AC4 48               4      LD  C,B
000AC5 4AC5 CD4B4C          17      CALL    GET_DISK_BANK
       4AC8                     SETMAP1:        
000AC8 4AC8 E5              11      PUSH    HL
       4AC9                     DISKIO1:
000AC9 4AC9 C5              11      PUSH    BC      ;B=残りのセクタ数
000ACA 4ACA D5              11      PUSH    DE      ;DE=セクタ番号
000ACB 4ACB F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
000ACC 4ACC EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
000ACD 4ACD 29              11      ADD HL,HL
000ACE 4ACE 4D               4      LD  C,L     ;C=読み出し元(セクタ番号*2)※1セクタ512バイトなので倍にしておく
000ACF 4ACF 29              11      ADD HL,HL       ;64KB→32KB
000AD0 4AD0 29              11      ADD HL,HL       ;32KB→16KB
000AD1 4AD1 29              11      ADD HL,HL       ;16KB→8KB
000AD2 4AD2 84               4      ADD A,H
000AD3 4AD3 320068          13      LD  (BANK1_SEL),A   ;ASCII-8K/Konami-8K共通で使える
000AD6 4AD6 321FF1          13      LD  (_BANK),A
000AD9 4AD9 79               4      LD  A,C     ;C=読み出し元
000ADA 4ADA E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F/16K:3F)
000ADC 4ADC C660             7      ADD A,high BANK1_ADR
000ADE 4ADE 67               4      LD  H,A
000ADF 4ADF 010002          10      LD  BC,00200H   ;BCは読み出すセクタサイズ(512バイト)
000AE2 4AE2 69               4      LD  L,C     ;C=0
000AE3 4AE3 EDB0                    LDIR
000AE5 4AE5 EB               4      EX  DE,HL
000AE6 4AE6 F1              10      POP AF
000AE7 4AE7 D1              10      POP DE
000AE8 4AE8 13               6      INC DE
000AE9 4AE9 C1              10      POP BC
000AEA 4AEA 10DD            13      DJNZ    DISKIO1
000AEC 4AEC 41               4      LD  B,C
                                
000AED 4AED E1              10      POP HL
000AEE 4AEE AF               4      XOR A
000AEF 4AEF FB               4      EI
000AF0 4AF0 C9              10      RET
                                
       4AF1                     DSKCHG:
000AF1 4AF1 CD2A4B          17      CALL    IS_BPB
000AF4 4AF4 3824            12      JR  C,NOTREADY
000AF6 4AF6 3A23FB          13      LD  A,(DRVTBL+2)
000AF9 4AF9 B7               4      OR  A
000AFA 4AFA 201A            12      JR  NZ,DSKCHG1
000AFC 4AFC 3A21FB          13      LD  A,(DRVTBL)
000AFF 4AFF FE02             7      CP  2
000B01 4B01 2013            12      JR  NZ,DSKCHG1
000B03 4B03 CD2A4B          17      CALL    IS_BPB
000B06 4B06 300E            12      JR  NC,DSKCHG1
000B08 4B08 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000B0A 4B0A 3221FB          13      LD  (DRVTBL),A
000B0D 4B0D 3223FB          13      LD  (DRVTBL+2),A
000B10 4B10 3A48F3          13      LD  A,(MASTERS)
000B13 4B13 3224FB          13      LD  (DRVTBL+3),A
       4B16                     DSKCHG1:
000B16 4B16 AF               4      XOR A
000B17 4B17 0601             7      LD  B,1
000B19 4B19 C9              10      RET
       4B1A                     NOTREADY:
000B1A 4B1A 3E02             7      LD  A,2
000B1C 4B1C 37               4      SCF
000B1D 4B1D C9              10      RET
                                
       4B1E                     NO_BPB:
000B1E 4B1E E1              10      POP HL
000B1F 4B1F 23               6      INC HL
000B20 4B20 11534C          10      LD  DE,DPB2DD
000B23 4B23 011200          10      LD  BC,DPB2DD_E-DPB2DD
000B26 4B26 EDB0                    LDIR
000B28 4B28 AF               4      XOR A
000B29 4B29 C9              10      RET
                                
       4B2A                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000B2A 4B2A CD4B4C          17      CALL    GET_DISK_BANK
000B2D 4B2D 320068          13      LD  (BANK1_SEL),A
                                
000B30 4B30 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000B33 4B33 FE01             7      CP  1
000B35 4B35 D8              11      RET C
                                
000B36 4B36 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000B39 4B39 C6FF             7      ADD A,0FFH
000B3B 4B3B D8              11      RET C
                                
000B3C 4B3C 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
000B3F 4B3F FE02             7      CP  2
000B41 4B41 C8              11      RET Z
000B42 4B42 FE04             7      CP  4
000B44 4B44 C8              11      RET Z
000B45 4B45 37               4      SCF
000B46 4B46 C9              10      RET
                                
       4B47                     GETDPB:
000B47 4B47 E5              11      PUSH    HL
000B48 4B48 CD4B4C          17      CALL    GET_DISK_BANK
000B4B 4B4B 320068          13      LD  (BANK1_SEL),A
                                
000B4E 4B4E 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000B51 4B51 B7               4      OR  A
000B52 4B52 28CA            12      JR  Z,NO_BPB
000B54 4B54 DDE1            14      POP IX
000B56 4B56 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000B59 4B59 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000B5C 4B5C DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000B5F 4B5F 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000B62 4B62 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000B65 4B65 87               4      ADD A,A
000B66 4B66 87               4      ADD A,A
000B67 4B67 87               4      ADD A,A
000B68 4B68 3D               4      DEC A
000B69 4B69 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000B6C 4B6C 06FF             7      LD  B,-1
000B6E 4B6E A7               4      AND A           ;無限ループ阻止
       4B6F                     GETDPB1:
000B6F 4B6F 04               4      INC B
000B70 4B70 1F               4      RRA
000B71 4B71 38FC            12      JR  C,GETDPB1
000B73 4B73 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000B76 4B76 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus 
000B79 4B79 3D               4      DEC A
000B7A 4B7A DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000B7D 4B7D A7               4      AND A           ;無限ループ阻止
000B7E 4B7E 06FF             7      LD  B,-1
       4B80                     GETDPB2:
000B80 4B80 04               4      INC B
000B81 4B81 1F               4      RRA
000B82 4B82 38FC            12      JR  C,GETDPB2
000B84 4B84 04               4      INC B
000B85 4B85 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000B88 4B88 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
000B8B 4B8B DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
000B8E 4B8E DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
000B91 4B91 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
000B94 4B94 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000B97 4B97 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
000B9A 4B9A DD770B          19      LD  (IX+11),A       ;FATCNT
                                
000B9D 4B9D ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
000BA1 4BA1 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
000BA4 4BA4 DD460A          19      LD  B,(IX+10)       ;FATCNT
000BA7 4BA7 210000          10      LD  HL,0
       4BAA                     GETDPB3:
000BAA 4BAA 19              11      ADD HL,DE
000BAB 4BAB 10FD            13      DJNZ    GETDPB3
       4BAD                     GETDPB4:
000BAD 4BAD DD5E08          19      LD  E,(IX+8)        ;FIRFAT
000BB0 4BB0 DD5609          19      LD  D,(IX+9)        ;FIRFAT
000BB3 4BB3 19              11      ADD HL,DE
000BB4 4BB4 DD7511          19      LD  (IX+17),L       ;FIRDIR
000BB7 4BB7 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000BBA 4BBA 3E08             7      LD  A,2*4           ;SECSIZ HIGH
000BBC 4BBC DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4BBF                     GETDPB5:
000BBF 4BBF CB3B             8      SRL E
000BC1 4BC1 1F               4      RRA
000BC2 4BC2 30FB            12      JR  NC,GETDPB5
000BC4 4BC4 1600             7      LD  D,0
000BC6 4BC6 19              11      ADD HL,DE
000BC7 4BC7 DD750C          19      LD  (IX+12),L       ;FIRREC
000BCA 4BCA DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000BCD 4BCD 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
000BD0 4BD0 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
000BD3 4BD3 DD560D          19      LD  D,(IX+13)       ;FIRREC
000BD6 4BD6 A7               4      AND A
000BD7 4BD7 ED52            15      SBC HL,DE
                                
000BD9 4BD9 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
000BDC 4BDC 3C               4      INC A
000BDD 4BDD 37               4      SCF             ;無限ループ阻止
       4BDE                     GETDPB6:
000BDE 4BDE 1F               4      RRA
000BDF 4BDF 3806            12      JR  C,GETDPB7
000BE1 4BE1 CB3C             8      SRL H
000BE3 4BE3 CB1D             8      RR  L
000BE5 4BE5 18F7            12      JR  GETDPB6
       4BE7                     GETDPB7:
000BE7 4BE7 23               6      INC HL
000BE8 4BE8 DD750E          19      LD  (IX+14),L       ;MAXCLUS
000BEB 4BEB DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       4BEE                     GETDPBD1:
000BEE 4BEE DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000BF1 4BF1 E6FC             7      AND 0FCH
000BF3 4BF3 C8              11      RET Z
                                
000BF4 4BF4 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
000BF8 4BF8 37               4      SCF
000BF9 4BF9 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
000BFD 4BFD DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
000C00 4C00 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
000C04 4C04 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
000C08 4C08 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
000C0C 4C0C DDCB1126        23      SLA (IX+17)         ;FIRDIR
000C10 4C10 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
000C14 4C14 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
000C17 4C17 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
000C1A 4C1A 3E08             7      LD  A,2*4           ;SECSIZ HIGH
000C1C 4C1C DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4C1F                     GETDPBD5:
000C1F 4C1F CB3B             8      SRL E
000C21 4C21 1F               4      RRA
000C22 4C22 30FB            12      JR  NC,GETDPBD5
000C24 4C24 1600             7      LD  D,0
000C26 4C26 19              11      ADD HL,DE
000C27 4C27 DD750C          19      LD  (IX+12),L       ;FIRREC
000C2A 4C2A DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000C2D 4C2D 18BF            12      JR  GETDPBD1
                                
       4C2F                     CHOICE:
000C2F 4C2F 210000          10      LD  HL,0
000C32 4C32 C9              10      RET
                                
       4C33                     DSKFMT:
000C33 4C33 AF               4      XOR A
000C34 4C34 37               4      SCF
       4C35                     DSKSTP:
000C35 4C35 C9              10      RET
                                
       4C36                     BASENT:
000C36 4C36 ED7B53F1        20      LD  SP,(BASSTK)
000C3A 4C3A C3AA43          10      JP  BASAUTO
                                
       4C3D                     GETSLT:
000C3D 4C3D 3A22FB          13      LD  A,(DRVTBL+1)
000C40 4C40 C9              10      RET
                                
       4C41                     GET_DISK_BANK_FDRV:
000C41 4C41 3A47F1          13      LD  A,(FDRV)
000C44 4C44 D601             7      SUB 1
000C46 4C46 3003            12      JR  NC,GET_DISK_BANK
000C48 4C48 3A3EF1          13      LD  A,(_DVSW)
       4C4B                     GET_DISK_BANK:
000C4B 4C4B B7               4      OR  A       ;A=DRIVE
000C4C 4C4C 3E01             7      LD  A,DISK_BANK
000C4E 4C4E C8              11      RET Z
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
000C4F 4C4F 3A3DF1          13      LD  A,(B_DRIVE)
                                #endif
000C52 4C52 C9              10      RET
                                
       4C53                     DPB2DD:
000C53 4C53 F9                      DB  0F9H    ;MEDIA
000C54 4C54 0002                    DW  00200H  ;SECSIZ
000C56 4C56 0F                      DB  00FH    ;DIRMSK
000C57 4C57 04                      DB  004H    ;DIRSHFT
000C58 4C58 01                      DB  001H    ;CLUSMSK
000C59 4C59 02                      DB  002H    ;CLUSSHFT
000C5A 4C5A 0100                    DW  00001H  ;FIRFAT
000C5C 4C5C 02                      DB  002H    ;FATCNT
000C5D 4C5D 70                      DB  070H    ;MAXENT
000C5E 4C5E 0E00                    DW  0000EH  ;FIRREC
000C60 4C60 CA02                    DW  002CAH  ;MAXCLUS
000C62 4C62 03                      DB  003H    ;FATSIZ
000C63 4C63 0700                    DW  0007H   ;FIRDIR
       4C65                     DPB2DD_E:
                                
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       4C65                     POP_HL_ERROR:
000C65 4C65 E1              10      POP     HL
       4C66                     _ERROR:
000C66 4C66 0600             7      LD  B,0
000C68 4C68 A7               4      AND A
000C69 4C69 C9              10      RET
                                
       4C6A                     ROM_BDOS:
000C6A 4C6A E5              11      PUSH    HL
000C6B 4C6B 79               4      LD  A,C
000C6C 4C6C 87               4      ADD A,A
000C6D 4C6D 38F7            12      JR  C,_ERROR
000C6F 4C6F 6F               4      LD  L,A
000C70 4C70 265F             7      LD  H,high STABLE
000C72 4C72 7E               7      LD  A,(HL)
000C73 4C73 2C               4      INC L
000C74 4C74 66               7      LD  H,(HL)
000C75 4C75 6F               4      LD  L,A
000C76 4C76 E3              19      EX  (SP),HL
000C77 4C77 79               4      LD  A,C
000C78 4C78 C9              10      RET
                                
       4C79                     _PRINT:
       4C79                     PRINT:
000C79 4C79 7B               4      LD  A,E
000C7A 4C7A 1803            12      JR  MSG_A
                                
       4C7C                     _SYS01:     ;(BDOS)コンソール入力
000C7C 4C7C CDF34C          17      CALL    _SYS07
       4C7F                     MSG_A:
000C7F 4C7F FE03             7      CP  3
000C81 4C81 2814            12      JR  Z,MSG_BR
       4C83                     MSGA1:
000C83 4C83 F5              11      PUSH    AF
000C84 4C84 C5              11      PUSH    BC
000C85 4C85 D5              11      PUSH    DE
000C86 4C86 E5              11      PUSH    HL
000C87 4C87 DDE5            15      PUSH    IX
000C89 4C89 DD21A200        14      LD  IX,CHPUT
000C8D 4C8D CDE142          17      CALL    CALSLT_R
000C90 4C90 DDE1            14      POP IX
000C92 4C92 E1              10      POP HL
000C93 4C93 D1              10      POP DE
000C94 4C94 C1              10      POP BC
       4C95                     MSGA2:
000C95 4C95 F1              10      POP AF
000C96 4C96 C9              10      RET
       4C97                     MSG_BR:
000C97 4C97 F5              11      PUSH    AF
000C98 4C98 3ADDF3          13      LD  A,(CSRX)
000C9B 4C9B FE02             7      CP  2
000C9D 4C9D 38F6            12      JR  C,MSGA2
000C9F 4C9F F1              10      POP AF
       4CA0                     MSG_CR:
000CA0 4CA0 F5              11      PUSH    AF
000CA1 4CA1 3E0D             7      LD  A,00DH
000CA3 4CA3 CD834C          17      CALL    MSGA1
000CA6 4CA6 3E0A             7      LD  A,00AH
000CA8 4CA8 CD834C          17      CALL    MSGA1
000CAB 4CAB F1              10      POP AF
000CAC 4CAC C9              10      RET
                                
       4CAD                     _SYS02:     ;(BDOS)コンソール出力
000CAD 4CAD CDC84C          17      CALL    BREAK
000CB0 4CB0 1805            12      JR  PRINTX
                                
       4CB2                     _SYS06:     ;(BDOS)コンソール直接入出力
000CB2 4CB2 7B               4      LD  A,E
000CB3 4CB3 3C               4      INC A
000CB4 4CB4 CA074D          10      JP  Z,_INKEY
       4CB7                     PRINTX:
000CB7 4CB7 C3794C          10      JP  _PRINT
                                
       4CBA                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000CBA 4CBA CDF34C          17      CALL    _SYS07
000CBD 4CBD FE03             7      CP  3
000CBF 4CBF CCC84C          17      CALL    Z,_BREAK
000CC2 4CC2 FE13             7      CP  013H        ;CTRL+S
000CC4 4CC4 C0              11      RET NZ
       4CC5                     PAUSE:
000CC5 4CC5 CDDF4C          17      CALL    KEYBC
                                
       4CC8                     _BREAK:
       4CC8                     BREAK:
000CC8 4CC8 F5              11      PUSH    AF
000CC9 4CC9 C5              11      PUSH    BC
000CCA 4CCA D5              11      PUSH    DE
000CCB 4CCB E5              11      PUSH    HL
000CCC 4CCC DDE5            15      PUSH    IX
000CCE 4CCE DD21B700        14      LD  IX,BREAKX
000CD2 4CD2 CDE142          17      CALL    CALSLT_R
000CD5 4CD5 DDE1            14      POP IX
000CD7 4CD7 E1              10      POP HL
000CD8 4CD8 D1              10      POP DE
000CD9 4CD9 C1              10      POP BC
000CDA 4CDA DCC84C          17      CALL    C,_BREAK
000CDD 4CDD F1              10      POP AF
000CDE 4CDE C9              10      RET
       4CDF                     KEYBC:
000CDF 4CDF F5              11      PUSH    AF
000CE0 4CE0 C5              11      PUSH    BC
000CE1 4CE1 D5              11      PUSH    DE
000CE2 4CE2 E5              11      PUSH    HL
000CE3 4CE3 DDE5            15      PUSH    IX
000CE5 4CE5 DD215601        14      LD  IX,KILBUF
000CE9 4CE9 CDE142          17      CALL    CALSLT_R
000CEC 4CEC DDE1            14      POP IX
000CEE 4CEE E1              10      POP HL
000CEF 4CEF D1              10      POP DE
000CF0 4CF0 C1              10      POP BC
000CF1 4CF1 F1              10      POP AF
000CF2 4CF2 C9              10      RET
                                
       4CF3                     _SYS07:
       4CF3                     FLGET:
000CF3 4CF3 C5              11      PUSH    BC
000CF4 4CF4 D5              11      PUSH    DE
000CF5 4CF5 E5              11      PUSH    HL
000CF6 4CF6 DDE5            15      PUSH    IX
000CF8 4CF8 DD219F00        14      LD  IX,CHGET
000CFC 4CFC CDE142          17      CALL    CALSLT_R
000CFF 4CFF DDE1            14      POP IX
000D01 4D01 E1              10      POP HL
000D02 4D02 D1              10      POP DE
000D03 4D03 C1              10      POP BC
000D04 4D04 FE03             7      CP  3
000D06 4D06 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       4D07                     _INKEY:
       4D07                     INKEY:
000D07 4D07 CDA14D          17      CALL    CPM_CONST
000D0A 4D0A C8              11      RET Z
000D0B 4D0B 18E6            12      JR  FLGET
                                
       4D0D                     _SYS0A:     ;(BDOS)文字列入力
000D0D 4D0D C5              11      PUSH    BC
000D0E 4D0E E5              11      PUSH    HL
000D0F 4D0F D5              11      PUSH    DE
000D10 4D10 CD394D          17      CALL    GETL
000D13 4D13 111FF4          10      LD  DE,KBUF
000D16 4D16 E1              10      POP HL
000D17 4D17 E5              11      PUSH    HL
000D18 4D18 0E00             7      LD  C,0
000D1A 4D1A 3004            12      JR  NC,SAX0
000D1C 4D1C 23               6      INC HL
000D1D 4D1D 23               6      INC HL
000D1E 4D1E 1808            12      JR  SAX4
       4D20                     SAX0:
000D20 4D20 46               7      LD  B,(HL)
000D21 4D21 23               6      INC HL
       4D22                     SAX1:
000D22 4D22 23               6      INC HL
000D23 4D23 1A               7      LD  A,(DE)
000D24 4D24 13               6      INC DE
000D25 4D25 B7               4      OR  A
000D26 4D26 2004            12      JR  NZ,SAX2
       4D28                     SAX4:
000D28 4D28 360D            10      LD  (HL),00DH
000D2A 4D2A 1804            12      JR  SAX3
       4D2C                     SAX2:
000D2C 4D2C 77               7      LD  (HL),A
000D2D 4D2D 0C               4      INC C
000D2E 4D2E 10F2            13      DJNZ    SAX1
       4D30                     SAX3:
000D30 4D30 D1              10      POP DE
000D31 4D31 79               4      LD  A,C
000D32 4D32 13               6      INC DE
000D33 4D33 12               7      LD  (DE),A
000D34 4D34 1B               6      DEC DE
000D35 4D35 E1              10      POP HL
000D36 4D36 C1              10      POP BC
000D37 4D37 A7               4      AND A
000D38 4D38 C9              10      RET
       4D39                     GETL:
000D39 4D39 DDE5            15      PUSH    IX
000D3B 4D3B FDE5            15      PUSH    IY
                                
000D3D 4D3D 2ADCF3          16      LD  HL,(CSRY)
000D40 4D40 22CAFB          16      LD  (FSTPOS),HL
       4D43                     GETL1:
000D43 4D43 CDBA4C          17      CALL    _SYS08
000D46 4D46 FE09             7      CP  9
000D48 4D48 2008            12      JR  NZ,GETL1V
000D4A 4D4A 211FF4          10      LD  HL,KBUF
000D4D 4D4D CD5C43          17      CALL    MSX
000D50 4D50 18F1            12      JR  GETL1
       4D52                     GETL1V:
000D52 4D52 5F               4      LD  E,A
000D53 4D53 FE08             7      CP  8
000D55 4D55 CCEF4D          17      CALL    Z,CTRL02
000D58 4D58 FE20             7      CP  020H
000D5A 4D5A D41B4E          17      CALL    NC,INSERT
000D5D 4D5D CD834C          17      CALL    MSGA1
                                
000D60 4D60 7B               4      LD  A,E
000D61 4D61 FE0D             7      CP  00DH
000D63 4D63 20DE            12      JR  NZ,GETL1
                                
000D65 4D65 111FF4          10      LD  DE,KBUF
000D68 4D68 3AB0F3          13      LD  A,(LINLEN)
000D6B 4D6B 47               4      LD  B,A
000D6C 4D6C CDCB4F          17      CALL    ZERO_MEMORY_DE
                                
000D6F 4D6F 2ACAFB          16      LD  HL,(FSTPOS)
000D72 4D72 3ADCF3          13      LD  A,(CSRY)
000D75 4D75 6F               4      LD  L,A
000D76 4D76 E5              11      PUSH    HL
000D77 4D77 CD4C4E          17      CALL    LOC0
000D7A 4D7A 4D               4      LD  C,L
000D7B 4D7B 44               4      LD  B,H
000D7C 4D7C E1              10      POP HL
000D7D 4D7D 3AB0F3          13      LD  A,(LINLEN)
000D80 4D80 94               4      SUB H
000D81 4D81 3D               4      DEC A
000D82 4D82 5F               4      LD  E,A
000D83 4D83 211FF4          10      LD  HL,KBUF
       4D86                     GETL2:
000D86 4D86 CDDF4D          17      CALL    _SCRN
000D89 4D89 03               6      INC BC
000D8A 4D8A 77               7      LD  (HL),A
000D8B 4D8B 23               6      INC HL
000D8C 4D8C 1D               4      DEC E
000D8D 4D8D 20F7            12      JR  NZ,GETL2
000D8F 4D8F CDA04C          17      CALL    MSG_CR
                                
000D92 4D92 FDE1            14      POP IY
000D94 4D94 DDE1            14      POP IX
       4D96                     GETL3:
000D96 4D96 2B               6      DEC HL
000D97 4D97 7E               7      LD  A,(HL)
000D98 4D98 FE21             7      CP  021H
000D9A 4D9A D0              11      RET NC
000D9B 4D9B 3600            10      LD  (HL),0
000D9D 4D9D 15               4      DEC D
000D9E 4D9E 20F6            12      JR  NZ,GETL3
000DA0 4DA0 C9              10      RET
                                
       4DA1                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       4DA1                     CONSTX:
       4DA1                     CPM_CONST:
000DA1 4DA1 C5              11      PUSH    BC
000DA2 4DA2 D5              11      PUSH    DE
000DA3 4DA3 E5              11      PUSH    HL
000DA4 4DA4 DDE5            15      PUSH    IX
000DA6 4DA6 DD219C00        14      LD  IX,CHSNS
000DAA 4DAA CDE142          17      CALL    CALSLT_R
000DAD 4DAD DDE1            14      POP IX
000DAF 4DAF E1              10      POP HL
000DB0 4DB0 D1              10      POP DE
000DB1 4DB1 C1              10      POP BC
000DB2 4DB2 C9              10      RET
                                
       4DB3                     _SYS2A:     ;(BDOS)日付の獲得
000DB3 4DB3 AF               4      XOR A
000DB4 4DB4 57               4      LD  D,A
000DB5 4DB5 5F               4      LD  E,A
000DB6 4DB6 67               4      LD  H,A
000DB7 4DB7 6F               4      LD  L,A
000DB8 4DB8 C9              10      RET
                                
       4DB9                     _SYS2C:     ;(BDOS)時刻の獲得
000DB9 4DB9 AF               4      XOR A
000DBA 4DBA 57               4      LD  D,A
000DBB 4DBB 5F               4      LD  E,A
000DBC 4DBC 67               4      LD  H,A
000DBD 4DBD 6F               4      LD  L,A
000DBE 4DBE C9              10      RET
                                
       4DBF                     POS:
000DBF 4DBF F5              11      PUSH    AF
000DC0 4DC0 2ADCF3          16      LD  HL,(CSRY)
000DC3 4DC3 7D               4      LD  A,L
000DC4 4DC4 6C               4      LD  L,H
000DC5 4DC5 67               4      LD  H,A
000DC6 4DC6 2C               4      INC L
000DC7 4DC7 24               4      INC H
000DC8 4DC8 F1              10      POP AF
000DC9 4DC9 C9              10      RET
                                
       4DCA                     LOC:
000DCA 4DCA F5              11      PUSH    AF
000DCB 4DCB E5              11      PUSH    HL
000DCC 4DCC 7D               4      LD  A,L
000DCD 4DCD 6C               4      LD  L,H
000DCE 4DCE 67               4      LD  H,A
000DCF 4DCF 2D               4      DEC L
000DD0 4DD0 25               4      DEC H
000DD1 4DD1 DDE5            15      PUSH    IX
000DD3 4DD3 DD21C600        14      LD  IX,POSIT
000DD7 4DD7 CDE142          17      CALL    CALSLT_R
000DDA 4DDA DDE1            14      POP IX
000DDC 4DDC E1              10      POP HL
000DDD 4DDD F1              10      POP AF
000DDE 4DDE C9              10      RET
                                
       4DDF                     _SCRN:
       4DDF                     SCRN:
000DDF 4DDF E5              11      PUSH    HL
000DE0 4DE0 DDE5            15      PUSH    IX
                                
000DE2 4DE2 69               4      LD  L,C
000DE3 4DE3 60               4      LD  H,B
000DE4 4DE4 DD214A00        14      LD  IX,RDVRM
000DE8 4DE8 CDE142          17      CALL    CALSLT_R
                                
000DEB 4DEB DDE1            14      POP IX
000DED 4DED E1              10      POP HL
000DEE 4DEE C9              10      RET
                                
       4DEF                     CTRL02:
000DEF 4DEF F5              11      PUSH    AF
000DF0 4DF0 D5              11      PUSH    DE
000DF1 4DF1 2ADCF3          16      LD  HL,(CSRY)
000DF4 4DF4 3AB0F3          13      LD  A,(LINLEN)
000DF7 4DF7 4F               4      LD  C,A
000DF8 4DF8 94               4      SUB H   ;CSRX
000DF9 4DF9 C602             7      ADD A,2
000DFB 4DFB 47               4      LD  B,A ;カーソルより右の文字数
000DFC 4DFC 61               4      LD  H,C ;LINLEN
000DFD 4DFD C5              11      PUSH    BC
000DFE 4DFE CD4C4E          17      CALL    LOC0
000E01 4E01 C1              10      POP BC
                                
000E02 4E02 1620             7      LD  D,020H
       4E04                     C8X1:
000E04 4E04 DD214A00        14      LD  IX,RDVRM
000E08 4E08 CDE142          17      CALL    CALSLT_R
000E0B 4E0B 4F               4      LD  C,A
000E0C 4E0C 7A               4      LD  A,D
000E0D 4E0D DD214D00        14      LD  IX,WRTVRM
000E11 4E11 CDE142          17      CALL    CALSLT_R
000E14 4E14 2B               6      DEC HL
000E15 4E15 51               4      LD  D,C
000E16 4E16 10EC            13      DJNZ    C8X1
000E18 4E18 D1              10      POP DE
000E19 4E19 F1              10      POP AF
000E1A 4E1A C9              10      RET
                                
       4E1B                     INSERT:
000E1B 4E1B F5              11      PUSH    AF
000E1C 4E1C D5              11      PUSH    DE
000E1D 4E1D 2ADCF3          16      LD  HL,(CSRY)
000E20 4E20 3AB0F3          13      LD  A,(LINLEN)
000E23 4E23 4F               4      LD  C,A
000E24 4E24 94               4      SUB H   ;CSRX
000E25 4E25 3C               4      INC A
000E26 4E26 47               4      LD  B,A ;カーソルより右の文字数
000E27 4E27 C5              11      PUSH    BC
000E28 4E28 CD4C4E          17      CALL    LOC0
000E2B 4E2B C1              10      POP BC
                                
000E2C 4E2C 1620             7      LD  D,020H
       4E2E                     INS1:
000E2E 4E2E DD214A00        14      LD  IX,RDVRM
000E32 4E32 CDE142          17      CALL    CALSLT_R
000E35 4E35 4F               4      LD  C,A
000E36 4E36 7A               4      LD  A,D
000E37 4E37 DD214D00        14      LD  IX,WRTVRM
000E3B 4E3B CDE142          17      CALL    CALSLT_R
000E3E 4E3E 23               6      INC HL
000E3F 4E3F 51               4      LD  D,C
000E40 4E40 10EC            13      DJNZ    INS1
000E42 4E42 D1              10      POP DE
000E43 4E43 F1              10      POP AF
000E44 4E44 C9              10      RET
                                
       4E45                     CONOUT1:
000E45 4E45 59               4      LD  E,C
000E46 4E46 C3794C          10      JP  _PRINT
                                
       4E49                     GETVRAM:
000E49 4E49 2ADCF3          16      LD  HL,(CSRY)
       4E4C                     LOC0:
000E4C 4E4C 2D               4      DEC L
000E4D 4E4D 25               4      DEC H
000E4E 4E4E 4C               4      LD  C,H ;CSRX-1
000E4F 4E4F 5D               4      LD  E,L ;CSRY-1
       4E50                     LOC1:
000E50 4E50 3AB0F3          13      LD  A,(LINLEN)
000E53 4E53 67               4      LD  H,A
000E54 4E54 1600             7      LD  D,0
000E56 4E56 6A               4      LD  L,D ;0
000E57 4E57 0608             7      LD  B,8
       4E59                     LOC2:
000E59 4E59 29              11      ADD HL,HL
000E5A 4E5A 3001            12      JR  NC,LOC3
000E5C 4E5C 19              11      ADD HL,DE
       4E5D                     LOC3:
000E5D 4E5D 10FA            13      DJNZ    LOC2
000E5F 4E5F 09              11      ADD HL,BC
000E60 4E60 C9              10      RET
                                
       4E61                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000E61 4E61 212200          10      LD  HL,00022H
000E64 4E64 AF               4      XOR A
000E65 4E65 7D               4      LD  A,L
000E66 4E66 C9              10      RET
                                
       4E67                     _SYS0D:     ;(BDOS)ディスク・リセット
000E67 4E67 218000          10      LD  HL,00080H
000E6A 4E6A 222AF1          16      LD  (_DTA),HL
000E6D 4E6D C9              10      RET
                                
       4E6E                     _SYS0E:     ;(BDOS)カレントドライブの設定
000E6E 4E6E 323EF1          13      LD  (_DVSW),A
000E71 4E71 C9              10      RET
                                
       4E72                     _SYS0F:     ;(BDOS)ファイルのオープン
000E72 4E72 D5              11      PUSH    DE
000E73 4E73 FDE1            14      POP IY
000E75 4E75 CDBB4F          17      CALL    INIT_FILE
000E78 4E78 CD8A48          17      CALL    ROM_OPEN
000E7B 4E7B 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
000E7D 4E7D FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
000E81 4E81 FDE5            15      PUSH    IY
000E83 4E83 D1              10      POP DE
000E84 4E84 13               6      INC DE
000E85 4E85 010B00          10      LD  BC,11
000E88 4E88 EDB0                    LDIR
                                ;               Attribute
000E8A 4E8A 7E               7      LD  A,(HL)
000E8B 4E8B FD770D          19      LD  (IY+13),A
                                ;               TIME
000E8E 4E8E 110B00          10      LD  DE,11
000E91 4E91 19              11      ADD HL,DE
000E92 4E92 7E               7      LD  A,(HL)
000E93 4E93 23               6      INC HL
000E94 4E94 FD7716          19      LD  (IY+22),A
000E97 4E97 7E               7      LD  A,(HL)
000E98 4E98 23               6      INC HL
000E99 4E99 FD7717          19      LD  (IY+23),A
                                ;               DATE
000E9C 4E9C 7E               7      LD  A,(HL)
000E9D 4E9D 23               6      INC HL
000E9E 4E9E FD7714          19      LD  (IY+20),A
000EA1 4EA1 7E               7      LD  A,(HL)
000EA2 4EA2 23               6      INC HL
000EA3 4EA3 FD7715          19      LD  (IY+21),A
                                ;               First cluster
000EA6 4EA6 7E               7      LD  A,(HL)
000EA7 4EA7 23               6      INC HL
000EA8 4EA8 FD771A          19      LD  (IY+26),A
000EAB 4EAB 7E               7      LD  A,(HL)
000EAC 4EAC 23               6      INC HL
000EAD 4EAD FD771B          19      LD  (IY+27),A
                                ;               SIZE
000EB0 4EB0 7E               7      LD  A,(HL)
000EB1 4EB1 23               6      INC HL
000EB2 4EB2 FD7710          19      LD  (IY+16),A
000EB5 4EB5 7E               7      LD  A,(HL)
000EB6 4EB6 23               6      INC HL
000EB7 4EB7 FD7711          19      LD  (IY+17),A
000EBA 4EBA 7E               7      LD  A,(HL)
000EBB 4EBB 23               6      INC HL
000EBC 4EBC FD7712          19      LD  (IY+18),A
000EBF 4EBF 7E               7      LD  A,(HL)
000EC0 4EC0 FD7713          19      LD  (IY+19),A
000EC3 4EC3 AF               4      XOR A
000EC4 4EC4 FD770C          19      LD  (IY+12),A
000EC7 4EC7 C9              10      RET
                                
       4EC8                     _SYS10:     ;(BDOS)ファイルのクローズ
000EC8 4EC8 AF               4      XOR A
000EC9 4EC9 C9              10      RET
                                
       4ECA                     S11X1:
000ECA 4ECA FD7119          19      LD  (IY+25),C       ;RootEntCnt
000ECD 4ECD FD750E          19      LD  (IY+14),L
000ED0 4ED0 FD740F          19      LD  (IY+15),H
       4ED3                     SCF_FF_RET:
000ED3 4ED3 37               4      SCF
000ED4 4ED4 9F               4      SBC A,A
000ED5 4ED5 C9              10      RET
                                
       4ED6                     _SYS11:     ;(BDOS)最初のファイルの検索
000ED6 4ED6 ED5332F1        20      LD  (_FCB),DE
000EDA 4EDA D5              11      PUSH    DE
000EDB 4EDB FDE1            14      POP IY
000EDD 4EDD CDBB4F          17      CALL    INIT_FILE
000EE0 4EE0 CD914A          17      CALL    GET_DIR_DAT
       4EE3                     S12X1:
000EE3 4EE3 CDA948          17      CALL    FILESE
000EE6 4EE6 30E2            12      JR  NC,S11X1
000EE8 4EE8 0D               4      DEC C
000EE9 4EE9 FD7119          19      LD  (IY+25),C       ;RootEntCnt
000EEC 4EEC 012000          10      LD  BC,32
000EEF 4EEF ED5B2AF1        20      LD  DE,(_DTA)
000EF3 4EF3 AF               4      XOR A
000EF4 4EF4 12               7      LD  (DE),A      ;ドライブ番号
000EF5 4EF5 13               6      INC DE
000EF6 4EF6 EDB0                    LDIR            ;ディレクトリエントリ
000EF8 4EF8 FD750E          19      LD  (IY+14),L
000EFB 4EFB FD740F          19      LD  (IY+15),H
000EFE 4EFE C9              10      RET
                                
       4EFF                     _SYS12:
000EFF 4EFF FD2A32F1        20      LD  IY,(_FCB)
000F03 4F03 FDE5            15      PUSH    IY
000F05 4F05 D1              10      POP DE
000F06 4F06 CDBB4F          17      CALL    INIT_FILE
                                
000F09 4F09 FD6E0E          19      LD  L,(IY+14)
000F0C 4F0C FD660F          19      LD  H,(IY+15)
000F0F 4F0F FD4E19          19      LD  C,(IY+25)
000F12 4F12 18CF            12      JR  S12X1
                                
       4F14                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000F14 4F14 CD774A          17      CALL    SET_FCB
000F17 4F17 CD454A          17      CALL    GETSEQ
000F1A 4F1A CD324A          17      CALL    RB_READ
000F1D 4F1D E5              11      PUSH    HL
000F1E 4F1E CD524A          17      CALL    SETSEQ
000F21 4F21 E1              10      POP HL
       4F22                     SREAD:
000F22 4F22 C601             7      ADD A,001H
000F24 4F24 D8              11      RET C
                                
000F25 4F25 7D               4      LD  A,L
000F26 4F26 D601             7      SUB 001H
000F28 4F28 9F               4      SBC A,A
000F29 4F29 E603             7      AND 3
000F2B 4F2B 1F               4      RRA
000F2C 4F2C C9              10      RET
                                
       4F2D                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000F2D 4F2D 210100          10      LD  HL,00001H
000F30 4F30 AF               4      XOR A
000F31 4F31 C9              10      RET
                                
       4F32                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000F32 4F32 3A3EF1          13      LD  A,(_DVSW)
000F35 4F35 C9              10      RET
                                
       4F36                     _SYS1A:     ;(BDOS)DTAの設定
000F36 4F36 ED532AF1        20      LD  (_DTA),DE
000F3A 4F3A AF               4      XOR A
000F3B 4F3B C9              10      RET
                                
       4F3C                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000F3C 4F3C 010002          10      LD  BC,512
000F3F 4F3F 11C302          10      LD  DE,707
000F42 4F42 210000          10      LD  HL,0
000F45 4F45 DD2134F1        14      LD  IX,_BUF
000F49 4F49 FD2134F1        14      LD  IY,_BUF
000F4D 4F4D FD3600F9        19      LD  (IY+0),0F9H
000F51 4F51 3E02             7      LD  A,2
000F53 4F53 C9              10      RET
                                
       4F54                     _SYS21:     ;(BDOS)ランダムな読み出し
000F54 4F54 CD774A          17      CALL    SET_FCB
                                
000F57 4F57 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
000F5A 4F5A FD6622          19      LD  H,(IY+34)
                                
000F5D 4F5D CD324A          17      CALL    RB_READ
000F60 4F60 18C0            12      JR  SREAD
                                
       4F62                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
000F62 4F62 CD724E          17      CALL    _SYS0F
000F65 4F65 D8              11      RET C
                                
000F66 4F66 D5              11      PUSH    DE      ;EX DE,IY
000F67 4F67 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000F69 4F69 CD674A          17      CALL    GETSIZE
       4F6C                     _S24X1:
000F6C 4F6C FD7521          19      LD  (IY+33),L   ;(FCB)Random record
000F6F 4F6F FD7422          19      LD  (IY+34),H
000F72 4F72 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000F76 4F76 FDE3            23      EX  (SP),IY     ;
000F78 4F78 D1              10      POP DE      ;
                                
000F79 4F79 AF               4      XOR A
000F7A 4F7A C9              10      RET
                                
       4F7B                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
000F7B 4F7B E5              11      PUSH    HL
000F7C 4F7C D5              11      PUSH    DE      ;EX DE,IY
000F7D 4F7D FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000F7F 4F7F CD454A          17      CALL    GETSEQ
000F82 4F82 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       4F84                     _SYS27:     ;(BDOS)ランダムブロック読み込み
000F84 4F84 CD774A          17      CALL    SET_FCB
000F87 4F87 E5              11      PUSH    HL
000F88 4F88 FD6E21          19      LD  L,(IY+33)
000F8B 4F8B FD6622          19      LD  H,(IY+34)
000F8E 4F8E 2220F1          16      LD  (RR_LOW),HL
000F91 4F91 FD6E23          19      LD  L,(IY+35)
000F94 4F94 FD6624          19      LD  H,(IY+36)
000F97 4F97 2222F1          16      LD  (RR_HIGH),HL
000F9A 4F9A E1              10      POP HL
000F9B 4F9B CDAB46          17      CALL    ROM_READ
000F9E 4F9E ED5B20F1        20      LD  DE,(RR_LOW)
000FA2 4FA2 FD7321          19      LD  (IY+33),E
000FA5 4FA5 FD7222          19      LD  (IY+34),D
000FA8 4FA8 ED5B22F1        20      LD  DE,(RR_HIGH)
000FAC 4FAC FD7323          19      LD  (IY+35),E
000FAF 4FAF FD7224          19      LD  (IY+36),D
000FB2 4FB2 9F               4      SBC A,A
000FB3 4FB3 C9              10      RET
                                
       4FB4                     _SYS2F:
000FB4 4FB4 44               4      LD  B,H
000FB5 4FB5 2A2AF1          16      LD  HL,(_DTA)
000FB8 4FB8 C3C24A          10      JP  DISKIO
                                
       4FBB                     INIT_FILE:
000FBB 4FBB EB               4      EX  DE,HL
000FBC 4FBC 1147F1          10      LD  DE,FDRV
000FBF 4FBF 010C00          10      LD  BC,1+8+3
000FC2 4FC2 EDB0                    LDIR
000FC4 4FC4 CD414C          17      CALL    GET_DISK_BANK_FDRV
000FC7 4FC7 320068          13      LD  (BANK1_SEL),A
000FCA 4FCA C9              10      RET
                                
       4FCB                     ZERO_MEMORY_DE:
000FCB 4FCB AF               4      XOR A
       4FCC                     FILL_MEMORY_DE:
000FCC 4FCC 12               7      LD  (DE),A
000FCD 4FCD 13               6      INC DE
000FCE 4FCE 10FC            13      DJNZ    FILL_MEMORY_DE
000FD0 4FD0 C9              10      RET
                                
000FD1 4FD1                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 664C7C4CAD4C664C        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 664C664CB24CF34C        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 BA4C664C0D4DA14D        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 614E674E6E4E724E        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 C84ED64EFF4E664C        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 144F664C664C664C        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 2D4F324F364F3C4F        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 664C664C664C624F        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 7B4F664C664C844F        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 664C664CB34D664C        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 B94D664C664CB44F        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB8 5FB8 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 664C664C664C664C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
