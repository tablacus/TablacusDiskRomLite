                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       42B2                     CRUNCH  EQU 042B2H
       4C64                     FRMEVL  EQU 04C64H
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
                                ;PTRFIL EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
                                ;FILNAM EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
                                ;RSTMP  EQU 0FB03H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FEDA                     H_STKE  EQU 0FEDAH
                                
       FF43                     H_GONE  EQU 0FF43H
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                
       F0E9                     ISC EQU 0F0E9H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
[EOF:DEF.ASM:UTF_8]
                                
                                ;USE_RAM_BLOAD_S    EQU 1   ;先頭のコメントを外すとBLOAD,SでRAMを使う
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C3F54A          10      JP  DISKIO
000013 4013 C32C4B          10      JP  DSKCHG
000016 4016 C3824B          10      JP  GETDPB
000019 4019 C3674C          10      JP  CHOICE
00001C 401C C36B4C          10      JP  DSKFMT
00001F 401F C36D4C          10      JP  DSKSTP
000022 4022 C36E4C          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C36B4C          10      JP  DSKFMT
000029 4029 C36D4C          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3754C          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.1.4.0",0
            204449534B20524F    
            4D204C6974652076    
            302E312E342E3000    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 0180FF          10      LD  BC,-00080H
000109 4109 2A72F6          16      LD  HL,(MEMSIZ)
00010C 410C 09              11      ADD HL,BC
00010D 410D 2272F6          16      LD  (MEMSIZ),HL
000110 4110 2A74F6          16      LD  HL,(STKTOP)
000113 4113 09              11      ADD HL,BC
000114 4114 2274F6          16      LD  (STKTOP),HL
000117 4117 2180F0          10      LD  HL,0F080H
00011A 411A 1100F0          10      LD  DE,0F000H
00011D 411D 012000          10      LD  BC,00020H
000120 4120 EDB0                    LDIR
000122 4122 2180FF          10      LD  HL,-00080H
000125 4125 39              11      ADD HL,SP
000126 4126 2257F1          16      LD  (BASSTK),HL
000129 4129 ED7B57F1        20      LD  SP,(BASSTK)
                                
00012D 412D 3EFF             7      LD  A,0FFH
00012F 412F 3299FD          13      LD  (DEVICE),A
                                
000132 4132 3E01             7      LD  A,1
000134 4134 3221FB          13      LD  (DRVTBL),A
                                
000137 4137 AF               4      XOR A
000138 4138 3242F1          13      LD  (_DVSW),A
                                
00013B 413B 21ED42          10      LD  HL,AT_ISC
00013E 413E 11E9F0          10      LD  DE,ISC
000141 4141 017200          10      LD  BC,ISC_E-ISC
000144 4144 EDB0                    LDIR
                                    
000146 4146 3EC3             7      LD  A,0C3H      ;JP
000148 4148 3243FF          13      LD  (H_GONE),A
00014B 414B 327DF3          13      LD  (BDOS),A
00014E 414E 326BF3          13      LD  (RAMUSE),A
000151 4151 3268F3          13      LD  (ROMUSE),A
000154 4154 21E9F0          10      LD  HL,REPLACE_COMMAND
000157 4157 2244FF          16      LD  (H_GONE+1),HL
00015A 415A 2131F3          10      LD  HL,H_BDOS
00015D 415D 227EF3          16      LD  (BDOS+1),HL
000160 4160 2110F1          10      LD  HL,RAMUSE1
000163 4163 226CF3          16      LD  (RAMUSE+1),HL
000166 4166 210BF1          10      LD  HL,ROMUSE1
000169 4169 2269F3          16      LD  (ROMUSE+1),HL
                                
00016C 416C 3E                      DB  03EH
00016D 416D F7              12      RST 30H
00016E 416E 3271FE          13      LD  (H_BINS),A
000171 4171 3276FE          13      LD  (H_BINL),A
000174 4174 327BFE          13      LD  (H_FILE),A
000177 4177 3231F3          13      LD  (H_BDOS),A
00017A 417A 32DAFE          13      LD  (H_STKE),A
00017D 417D 32A7FF          13      LD  (H_PHYD),A
                                
000180 4180 CD3542          17      CALL    GTSL1_
000183 4183 32FCF0          13      LD  (ROM_SLT),A
000186 4186 3272FE          13      LD  (H_BINS+1),A
000189 4189 3277FE          13      LD  (H_BINL+1),A
00018C 418C 327CFE          13      LD  (H_FILE+1),A
00018F 418F 3232F3          13      LD  (H_BDOS+1),A
000192 4192 32DBFE          13      LD  (H_STKE+1),A
000195 4195 32A8FF          13      LD  (H_PHYD+1),A
000198 4198 3222FB          13      LD  (DRVTBL+1),A
00019B 419B 3248F3          13      LD  (MASTERS),A
                                
00019E 419E 210E45          10      LD  HL,ROM_LOAD
0001A1 41A1 2273FE          16      LD  (H_BINS+2),HL
0001A4 41A4 212946          10      LD  HL,ROM_RUN
0001A7 41A7 2278FE          16      LD  (H_BINL+2),HL
0001AA 41AA 213646          10      LD  HL,ROM_FILES
0001AD 41AD 227DFE          16      LD  (H_FILE+2),HL
0001B0 41B0 21BE4C          10      LD  HL,ROM_BDOS
0001B3 41B3 2233F3          16      LD  (H_BDOS+2),HL
0001B6 41B6 218943          10      LD  HL,ROM_STKE
0001B9 41B9 22DCFE          16      LD  (H_STKE+2),HL
0001BC 41BC 21F54A          10      LD  HL,DISKIO
0001BF 41BF 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001C2 41C2 3E                      DB  03EH
0001C3 41C3 C9              10      RET
0001C4 41C4 327FFE          13      LD  (H_FILE+4),A
0001C7 41C7 3275FE          13      LD  (H_BINS+4),A
0001CA 41CA 327AFE          13      LD  (H_BINL+4),A
0001CD 41CD 3235F3          13      LD  (H_BDOS+4),A
0001D0 41D0 32DEFE          13      LD  (H_STKE+4),A
0001D3 41D3 32ABFF          13      LD  (H_PHYD+4),A
                                
                                #if exists USE_NORMAL_32K_ROM
                                #else
0001D6 41D6 AF               4      XOR A
0001D7 41D7 320068          13      LD  (BANK1_SEL),A
0001DA 41DA 3A0060          13      LD  A,(BANK1_ADR)
0001DD 41DD FE41             7      CP  'A'
0001DF 41DF 2043            12      JR  NZ,NOT_8K_BANK
0001E1 41E1 3E01             7      LD  A,DISK_BANK
0001E3 41E3 320068          13      LD  (BANK1_SEL),A
                                #endif
0001E6 41E6 CD3801          17      CALL    RSLREG      ;read primary slot #
0001E9 41E9 07               4      RLCA
0001EA 41EA 07               4      RLCA
0001EB 41EB F5              11      PUSH    AF
0001EC 41EC CD3A42          17      CALL    GTSL2_
0001EF 41EF 3244F3          13      LD  (RAMAD3),A
0001F2 41F2 F1              10      POP AF  
0001F3 41F3 CD3A42          17      CALL    GTSL2_
0001F6 41F6 3243F3          13      LD  (RAMAD2),A
       41F9                     RAMCHK2:
0001F9 41F9 3A44F3          13      LD  A,(RAMAD3)
0001FC 41FC 2640             7      LD  H,040H
0001FE 41FE CD5142          17      CALL    CHK_RAM
000201 4201 3242F3          13      LD  (RAMAD1),A
       4204                     RAMCHK1:
000204 4204 3A44F3          13      LD  A,(RAMAD3)
000207 4207 2600             7      LD  H,00H
000209 4209 CD5142          17      CALL    CHK_RAM
00020C 420C 3241F3          13      LD  (RAMAD0),A
       420F                     RAMCHK0:
00020F 420F 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
000212 4212 010F00          10      LD  BC,0000FH       ;切り上げ
000215 4215 09              11      ADD HL,BC
000216 4216 7D               4      LD  A,L
                                
000217 4217 0604             7      LD  B,4
       4219                     B_DRIVE1:
000219 4219 CB3C             8      SRL H
00021B 421B 1F               4      RRA
00021C 421C 10FB            13      DJNZ    B_DRIVE1
                                
00021E 421E C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000220 4220 3241F1          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
000223 4223 C9              10      RET
                                
       4224                     NOT_8K_BANK:
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K等)
000224 4224 21D743          10      LD  HL,MSG_ERROR_ROM_MODE
000227 4227 CD6243          17      CALL    MSX
00022A 422A FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00022E 422E DD219F00        14      LD  IX,CHGET
000232 4232 C31C00          10      JP  _CALSLT
                                
       4235                     GTSL1_:             ;自分のいるスロットを知る
000235 4235 CD3801          17      CALL    RSLREG      ;read primary slot #
000238 4238 0F               4      RRCA
000239 4239 0F               4      RRCA
       423A                     GTSL2_:
00023A 423A E603             7      AND 3       ;[A]=000000PP
00023C 423C 5F               4      LD  E,A     ;[E]=000000PP
00023D 423D 21C1FC          10      LD  HL,EXPTBL
000240 4240 85               4      ADD A,L     ;桁上りは無い
000241 4241 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000242 4242 7B               4      LD  A,E     ;[A]=000000PP
000243 4243 CB7E            13      BIT 7,(HL)
000245 4245 C8              11      RET Z
000246 4246 7D               4      LD  A,L     ;point to SLTTBL entry
000247 4247 C604             7      ADD A,4     ;桁上りは無い
000249 4249 6F               4      LD  L,A
00024A 424A 7E               7      LD  A,(HL)      ;get currently expansion slot register
00024B 424B E60C             7      AND 00CH        ;[A] = 0000SS00
00024D 424D B3               4      OR  E       ;[A] = 0000SSPP
00024E 424E F680             7      OR  080H        ;[A] = 1000SSPP
000250 4250 C9              10      RET
       4251                     GTSL1_E:
                                
       4251                     CHK_RAM:
000251 4251 E5              11      PUSH    HL
000252 4252 CDA642          17      CALL    CHK_RAM0
000255 4255 E1              10      POP HL
000256 4256 C8              11      RET Z
000257 4257 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
00025A 425A E680             7      AND 080H
00025C 425C CD7D42          17      CALL    CHK_RAM_SLT
00025F 425F C8              11      RET Z
000260 4260 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000263 4263 E680             7      AND 080H
000265 4265 C601             7      ADD A,1
000267 4267 CD7D42          17      CALL    CHK_RAM_SLT
00026A 426A C8              11      RET Z
00026B 426B 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00026E 426E E680             7      AND 080H
000270 4270 C602             7      ADD A,2
000272 4272 CD7D42          17      CALL    CHK_RAM_SLT
000275 4275 C8              11      RET Z
000276 4276 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000279 4279 E680             7      AND 080H
00027B 427B C603             7      ADD A,3
       427D                     CHK_RAM_SLT:
00027D 427D E5              11      PUSH    HL
00027E 427E CDA642          17      CALL    CHK_RAM0        ;スロット#X or X-0
000281 4281 E1              10      POP HL
000282 4282 C8              11      RET Z
000283 4283 CB79             8      BIT 7,C
000285 4285 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000287 4287 79               4      LD  A,C
000288 4288 C604             7      ADD A,4         ;スロット#X-1
00028A 428A E5              11      PUSH    HL
00028B 428B CDA642          17      CALL    CHK_RAM0
00028E 428E E1              10      POP HL
00028F 428F C8              11      RET Z
000290 4290 79               4      LD  A,C
000291 4291 C604             7      ADD A,4         ;スロット#X-2
000293 4293 E5              11      PUSH    HL
000294 4294 CDA642          17      CALL    CHK_RAM0
000297 4297 E1              10      POP HL
000298 4298 C8              11      RET Z
000299 4299 79               4      LD  A,C
00029A 429A C604             7      ADD A,4         ;スロット#X-3
00029C 429C E5              11      PUSH    HL
00029D 429D CDA642          17      CALL    CHK_RAM0
0002A0 42A0 E1              10      POP HL
       42A1                     CHK_RAM_E:
0002A1 42A1 AF               4      XOR A
0002A2 42A2 3C               4      INC A           ;ZF=0にする
0002A3 42A3 3E00             7      LD  A,0
0002A5 42A5 C9              10      RET
                                
       42A6                     CHK_RAM0:
0002A6 42A6 4F               4      LD  C,A
0002A7 42A7 3AFCF0          13      LD  A,(ROM_SLT)
0002AA 42AA B9               4      CP  C
0002AB 42AB 28F4            12      JR  Z,CHK_RAM_E
0002AD 42AD 2E00             7      LD  L,0
       42AF                     CHK_RAM1:
0002AF 42AF 79               4      LD  A,C
0002B0 42B0 DD210C00        14      LD  IX,_RDSLT
0002B4 42B4 CDE142          17      CALL    CALSLT_R
0002B7 42B7 C6E5             7      ADD A,0E5H
0002B9 42B9 47               4      LD  B,A
0002BA 42BA 5F               4      LD  E,A
0002BB 42BB 79               4      LD  A,C
0002BC 42BC DD211400        14      LD  IX,_WRSLT
0002C0 42C0 CDE142          17      CALL    CALSLT_R
0002C3 42C3 79               4      LD  A,C
0002C4 42C4 DD210C00        14      LD  IX,_RDSLT
0002C8 42C8 CDE142          17      CALL    CALSLT_R
0002CB 42CB B8               4      CP  B
0002CC 42CC C0              11      RET NZ
0002CD 42CD D6E5             7      SUB 0E5H
0002CF 42CF 79               4      LD  A,C
0002D0 42D0 5F               4      LD  E,A
0002D1 42D1 DD211400        14      LD  IX,_WRSLT
0002D5 42D5 CDE142          17      CALL    CALSLT_R
0002D8 42D8 24               4      INC H
0002D9 42D9 7D               4      LD  A,L
0002DA 42DA C604             7      ADD A,4
0002DC 42DC 6F               4      LD  L,A
0002DD 42DD 20D0            12      JR  NZ,CHK_RAM1
0002DF 42DF 79               4      LD  A,C     ;ZF=1のハズ
0002E0 42E0 C9              10      RET
                                
       42E1                     CALSLT_R:
0002E1 42E1 C5              11      PUSH    BC
0002E2 42E2 E5              11      PUSH    HL
0002E3 42E3 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0002E7 42E7 CD1C00          17      CALL    _CALSLT
0002EA 42EA E1              10      POP HL
0002EB 42EB C1              10      POP BC
0002EC 42EC C9              10      RET
                                
       42ED                     AT_ISC:
0002ED F0E9                         ORG ISC,AT_ISC-RUN
       F0E9                     REPLACE_COMMAND:
0002ED F0E9 FEB7             7      CP  0B7H            ;FILES
0002EF F0EB CC7BFE          17      CALL    Z,H_FILE
0002F2 F0EE FEB5             7      CP  0B5H            ;LOAD
0002F4 F0F0 CA71FE          10      JP  Z,H_BINS
0002F7 F0F3 FE8A             7      CP  08AH            ;RUN
0002F9 F0F5 CA76FE          10      JP  Z,H_BINL
0002FC F0F8 FECF             7      CP  0CFH            ;BLOAD
0002FE F0FA C0              11      RET NZ
       F0FB                     FIX_BLOAD:
0002FF F0FB F7              12      RST 30H
       F0FC                     ROM_SLT:
000300 F0FC 00                      DB  0
000301 F0FD 6B45                    DW  ROM_BLOAD
000303 F0FF F5              11      PUSH    AF
000304 F100 E5              11      PUSH    HL
000305 F101 CD0AF1          17      CALL    BLOAD_RET
       F102                     SWC_BLOAD   EQU $-2
000308 F104 E1              10      POP HL
000309 F105 F1              10      POP AF
00030A F106 FECF             7      CP  0CFH            ;BLOAD
       F108                     SWC_BLOAD_M:
00030C F108 28DF            12      JR  Z,REPLACE_COMMAND
       F10A                     BLOAD_RET:
00030E F10A C9              10      RET
       F10B                     ROMUSE1:
00030F F10B 3AFCF0          13      LD  A,(ROM_SLT)
000312 F10E 1803            12      JR  ROMUSE2
       F110                     RAMUSE1:
000314 F110 3A42F3          13      LD  A,(RAMAD1)
       F113                     ROMUSE2:
000317 F113 DD212400        14      LD  IX,_ENASLT
00031B F117 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00031F F11B C31C00          10      JP  _CALSLT
                                
       F11E                     _RESULT:
000322 F11E 00                      DB  0
       F11F                     _BANK:
000323 F11F 00                      DB  0
       F120                     CLSZ:               ;クラスタサイズ
000324 F120 0004                    DW  1024
       F121                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F122                     SECSZ:              ;セクタサイズ
000326 F122 0002                    DW  512
       F123                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F124                     RR_LOW:
000328 F124 0000                    DW  0
       F125                     RR_MID  EQU $-1
       F126                     RR_HIGH:
00032A F126 0000                    DW  0
       F128                     _CLPS:
00032C F128 0000                    DW  0
       F12A                     _LEFT:
00032E F12A 0000                    DW  0
       F12C                     _DTPS:
000330 F12C 0000                    DW  0
       F12E                     _DTA:
000332 F12E 0000                    DW  0
                                #if exists USE_RAM_BLOAD_S
                                #else
       F130                     FLG_LDIR:
000334 F130 00                      DB  0
                                #endif
                                ;   BDOS
000335 F131 F7              12      RST 30H
000336 F132 00                      DB  0
000337 F133 BE4C                    DW  ROM_BDOS
000339 F135 C9              10      RET 
       F136                     _FCB:
00033A F136 0000                    DW  0
       F138                     _BUF:
00033C F138 00                      DB  0
       F139                     _BUF_ST:
00033D F139 0000                    DW  0
       F13B                     _BUF_EN:
00033F F13B 0000                    DW  0
       F13D                     _BUF_EX:
000341 F13D 0000                    DW  0
                                
       F13F                     DTAX:
000343 F13F 0000                    DW  0
       F141                     B_DRIVE:
000345 F141 00                      DB  0
       F142                     _DVSW:
000346 F142 00                      DB  0
       F143                     FCBX:
000347 F143 0000                    DW  0
       F145                     LEFTX:
000349 F145 0000                    DW  0
       F147                     PARAM0:
00034B F147 0000                    DW  0
       F149                     PARAM1:
00034D F149 0000                    DW  0
       F14B                     FDRV:
00034F F14B 00                      DB  0
       F14C                     FNAME:
000350 F14C                         DS  8+3
                                
       F157                     BASSTK:
00035B F157 0000                    DW  0
       F159                     _HL:
00035D F159 0000                    DW  0
                                
       F15B                     ISC_E:
00035F 435F                         ORG $$+RUN          ;$DEPHASE
                                
       435F                     MSX1:
00035F 435F CDD74C          17      CALL    MSGA1
       4362                     MSX:
000362 4362 7E               7      LD  A,(HL)
000363 4363 23               6      INC HL
000364 4364 B7               4      OR  A
000365 4365 20F8            12      JR  NZ,MSX1
000367 4367 C9              10      RET
                                
       4368                     PRTHX:
000368 4368 F5              11      PUSH    AF
000369 4369 07               4      RLCA
00036A 436A 07               4      RLCA
00036B 436B 07               4      RLCA
00036C 436C 07               4      RLCA
00036D 436D CD7143          17      CALL    PRTA2
000370 4370 F1              10      POP AF
       4371                     PRTA2:
000371 4371 CD7743          17      CALL    ASC
000374 4374 C3D34C          10      JP  MSG_A
                                    
       4377                     ASC:
000377 4377 E60F             7      AND $0F
000379 4379 F630             7      OR  $30
00037B 437B FE3A             7      CP  $3A
00037D 437D D8              11      RET C
00037E 437E C607             7      ADD A,7
000380 4380 C9              10      RET
                                
       4381                     MSN:
000381 4381 7E               7      LD  A,(HL)
000382 4382 23               6      INC HL
000383 4383 CDD34C          17      CALL    MSG_A
000386 4386 10F9            13      DJNZ    MSN
000388 4388 C9              10      RET
                                
       4389                     ROM_STKE:
000389 4389 3E                      DB  03EH
00038A 438A C9              10      RET
00038B 438B 32DAFE          13      LD  (H_STKE),A
00038E 438E E5              11      PUSH    HL
00038F 438F D5              11      PUSH    DE
000390 4390 C5              11      PUSH    BC
000391 4391 181D            12      JR  BASAUTO
                                
000393 4393 AF               4      XOR A
000394 4394 5F               4      LD  E,A
000395 4395 57               4      LD  D,A
000396 4396 0601             7      LD  B,1
000398 4398 2100C0          10      LD  HL,0C000H
00039B 439B CDF54A          17      CALL    DISKIO
                                
00039E 439E ED7357F1        20      LD  (BASSTK),SP
0003A2 43A2 116BF3          10      LD  DE,RAMUSE
0003A5 43A5 AF               4      XOR A
0003A6 43A6 CD1EC0          17      CALL    0C01EH
0003A9 43A9 116BF3          10      LD  DE,RAMUSE
0003AC 43AC 37               4      SCF
0003AD 43AD CD1EC0          17      CALL    0C01EH
       43B0                     BASAUTO:
0003B0 43B0 21F243          10      LD  HL,AUTOEXEC
0003B3 43B3 114BF1          10      LD  DE,FDRV
0003B6 43B6 010C00          10      LD  BC,1+8+3
0003B9 43B9 EDB0                    LDIR
0003BB 43BB CD9448          17      CALL    ROM_OPEN
0003BE 43BE 3813            12      JR  C,RSTKEE
0003C0 43C0 21FE43          10      LD  HL,RUN_AUTOEXEC
0003C3 43C3 11F0FB          10      LD  DE,KEYBUF
0003C6 43C6 ED53FAF3        20      LD  (GETPNT),DE
0003CA 43CA 011300          10      LD  BC,RUN_AUTOEXEC_E-RUN_AUTOEXEC
0003CD 43CD EDB0                    LDIR
0003CF 43CF ED53F8F3        20      LD  (PUTPNT),DE
       43D3                     RSTKEE:
0003D3 43D3 C1              10      POP BC
0003D4 43D4 D1              10      POP DE
0003D5 43D5 E1              10      POP HL
0003D6 43D6 C9              10      RET
                                
       43D7                     MSG_ERROR_ROM_MODE:
0003D7 43D7 41534349492D384B        DB  "ASCII-8K/Konami-8K only!",13,10
            2F4B6F6E616D692D    
            384B206F6E6C7921    
            0D0A                
       43F1                     NULL:
0003F1 43F1 00                      DB  0
                                
       43F2                     AUTOEXEC:
0003F2 43F2 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       43FE                     RUN_AUTOEXEC:
0003FE 43FE 52554E2022415554        DB  'RUN "AUTOEXEC.BAS"',00DH
            4F455845432E4241    
            53220D              
                                ;   DB  'LOAD "AUTOEXEC.BAS"',00DH  ;テスト用
       4411                     RUN_AUTOEXEC_E:
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       4411                     ROM_LDIR:
                                #if exists USE_RAM_BLOAD_S
                                #else
000411 4411 3A30F1          13      LD  A,(FLG_LDIR)
000414 4414 B7               4      OR  A
000415 4415 2007            12      JR  NZ,ROM_LDIRVM
                                #endif
000417 4417 CB7A             8      BIT 7,D
000419 4419 2815            12      JR  Z,ROM_LDIRSLT
                                
                                #if exists USE_NORMAL_32K_ROM
                                LDIR1:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                LDIR2:
                                    LD  A,H
                                    CP  0C0H
                                    JR  NC,LDIR4
                                
                                    LD  A,B
                                    OR  C
                                    JR  Z,LDIRE
                                
                                    PUSH    BC
                                    PUSH    DE
                                    LD  DE,BUF
                                
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIR3
                                    LD  BC,00100H
                                LDIR3:
                                    PUSH    BC
                                    LDIR
                                    LD  (_HL),HL
                                
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                
                                    LD  HL,BUF
                                    POP BC
                                    POP DE
                                    LDIR
                                
                                    LD  HL,(_HL)
                                    POP BC
                                    LD  A,B
                                    OR  A
                                    RET Z
                                    DEC B
                                    JR  LDIR1
                                LDIR4:
                                #endif
00041B 441B EDB0                    LDIR
                                
                                #if exists USE_NORMAL_32K_ROM
                                LDIRE:
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                #endif
00041D 441D C9              10      RET
                                
       441E                     ROM_LDIRVM:
                                #if exists USE_NORMAL_32K_ROM
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
00041E 441E C5              11      PUSH    BC
00041F 441F D5              11      PUSH    DE
000420 4420 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000424 4424 DD215C00        14      LD  IX,LDIRVM
000428 4428 CD1C00          17      CALL    _CALSLT
                                #if exists USE_NORMAL_32K_ROM
                                    LD  H,080H
                                    LD  A,(RAMAD2)
                                    CALL    _ENASLT
                                #endif
00042B 442B E1              10      POP HL
00042C 442C C1              10      POP BC
00042D 442D 09              11      ADD HL,BC
00042E 442E EB               4      EX  DE,HL
00042F 442F C9              10      RET
                                
       4430                     ROM_LDIRSLT:
000430 4430 EB               4      EX  DE,HL
       4431                     RLDIRSLT1:
000431 4431 1A               7      LD  A,(DE)
000432 4432 13               6      INC DE
000433 4433 C5              11      PUSH    BC
000434 4434 D5              11      PUSH    DE
000435 4435 E5              11      PUSH    HL
000436 4436 5F               4      LD  E,A
000437 4437 3A42F3          13      LD  A,(RAMAD1)
00043A 443A FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00043E 443E DD211400        14      LD  IX,_WRSLT
000442 4442 CD1C00          17      CALL    _CALSLT
000445 4445 E1              10      POP HL
000446 4446 D1              10      POP DE
000447 4447 C1              10      POP BC
000448 4448 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00044A 444A EA3144          10      JP  PE,RLDIRSLT1
00044D 444D EB               4      EX  DE,HL
00044E 444E C9              10      RET
                                
       444F                     END_OF_LINE:
00044F 444F 215EF5          10      LD  HL,BUF
       4452                     EOL1:
000452 4452 7E               7      LD  A,(HL)
000453 4453 C8              11      RET Z
000454 4454 FE0D             7      CP  00DH
000456 4456 2807            12      JR  Z,EOLE
000458 4458 FE0A             7      CP  00AH
00045A 445A 2803            12      JR  Z,EOLE
00045C 445C 23               6      INC HL
00045D 445D 18F3            12      JR  EOL1
       445F                     EOLE:
00045F 445F 3600            10      LD  (HL),0
000461 4461 23               6      INC HL
000462 4462 7E               7      LD  A,(HL)
000463 4463 FE0A             7      CP  00AH
000465 4465 C0              11      RET NZ
000466 4466 23               6      INC HL
000467 4467 C9              10      RET
                                
       4468                     ROM_LOAD_ASCII:
000468 4468 210000          10      LD  HL,0
00046B 446B 2239F1          16      LD  (_BUF_ST),HL    ;読み出し位置
00046E 446E 2A76F6          16      LD  HL,(TXTTAB)
000471 4471 223BF1          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
000474 4474 215EF5          10      LD  HL,BUF
000477 4477 222EF1          16      LD  (_DTA),HL
       447A                     RLOAD_A1:
00047A 447A 2A39F1          16      LD  HL,(_BUF_ST)
00047D 447D 2224F1          16      LD  (RR_LOW),HL
000480 4480 210201          10      LD  HL,258
000483 4483 CDB446          17      CALL    ROM_READ
000486 4486 7C               4      LD  A,H
000487 4487 B5               4      OR  L
000488 4488 2877            12      JR  Z,RLOAD_AEND
00048A 448A 015EF5          10      LD  BC,BUF
00048D 448D 09              11      ADD HL,BC
00048E 448E 3600            10      LD  (HL),0
000490 4490 CD4F44          17      CALL    END_OF_LINE
000493 4493 015EF5          10      LD  BC,BUF
000496 4496 A7               4      AND A
000497 4497 ED42            15      SBC HL,BC
000499 4499 2810            12      JR  Z,RLOAD_A2
00049B 449B 4D               4      LD  C,L
00049C 449C 44               4      LD  B,H
00049D 449D ED5B39F1        20      LD  DE,(_BUF_ST)
0004A1 44A1 19              11      ADD HL,DE
0004A2 44A2 2239F1          16      LD  (_BUF_ST),HL
0004A5 44A5 3A5EF5          13      LD  A,(BUF)
0004A8 44A8 B7               4      OR  A
0004A9 44A9 28CF            12      JR  Z,RLOAD_A1
       44AB                     RLOAD_A2:
0004AB 44AB 115EF5          10      LD  DE,BUF
0004AE 44AE CD2B48          17      CALL    SPCUTEX
0004B1 44B1 1A               7      LD  A,(DE)
0004B2 44B2 B7               4      OR  A
0004B3 44B3 284C            12      JR  Z,RLOAD_AEND
0004B5 44B5 CD3D48          17      CALL    GETNUM
0004B8 44B8 7C               4      LD  A,H
0004B9 44B9 B5               4      OR  L
0004BA 44BA CA5845          10      JP  Z,ERROR_DIRECT_IN_FILE
0004BD 44BD DD2A3BF1        20      LD  IX,(_BUF_EN)
0004C1 44C1 DD7502          19      LD  (IX+2),L
0004C4 44C4 DD7403          19      LD  (IX+3),H
                                
0004C7 44C7 CD2448          17      CALL    SPCUT
0004CA 44CA EB               4      EX  DE,HL
0004CB 44CB DDE5            15      PUSH    IX
0004CD 44CD DD21B242        14      LD  IX,CRUNCH
0004D1 44D1 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0004D5 44D5 CD1C00          17      CALL    _CALSLT
0004D8 44D8 DDE1            14      POP IX
0004DA 44DA EB               4      EX  DE,HL
0004DB 44DB 111FF4          10      LD  DE,KBUF
0004DE 44DE 37               4      SCF
0004DF 44DF ED52            15      SBC HL,DE
0004E1 44E1 2875            12      JR  Z,ERROR_DIRECT_IN_FILE
0004E3 44E3 3873            12      JR  C,ERROR_DIRECT_IN_FILE
0004E5 44E5 4D               4      LD  C,L
0004E6 44E6 44               4      LD  B,H
0004E7 44E7 2A3BF1          16      LD  HL,(_BUF_EN)
0004EA 44EA 110400          10      LD  DE,4
0004ED 44ED 19              11      ADD HL,DE
0004EE 44EE 111FF4          10      LD  DE,KBUF
                                
0004F1 44F1 EB               4      EX  DE,HL
0004F2 44F2 EDB0                    LDIR
0004F4 44F4 EB               4      EX  DE,HL
                                
0004F5 44F5 DD7500          19      LD  (IX+0),L
0004F8 44F8 DD7401          19      LD  (IX+1),H
0004FB 44FB 223BF1          16      LD  (_BUF_EN),HL
0004FE 44FE C37A44          10      JP  RLOAD_A1
                                
       4501                     RLOAD_AEND:
000501 4501 2A3BF1          16      LD  HL,(_BUF_EN)
000504 4504 AF               4      XOR A
000505 4505 77               7      LD  (HL),A
000506 4506 23               6      INC HL
000507 4507 77               7      LD  (HL),A
000508 4508 23               6      INC HL
000509 4509 223BF1          16      LD  (_BUF_EN),HL
00050C 450C 1833            12      JR  RLOAD_END1
                                
       450E                     ROM_LOAD:
00050E 450E CD8946          17      CALL    INIT_PARAM
000511 4511 CD5447          17      CALL    FILE_B
000514 4514 CD9448          17      CALL    ROM_OPEN
000517 4517 3845            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000519 4519 2138F1          10      LD  HL,_BUF
00051C 451C 222EF1          16      LD  (_DTA),HL
00051F 451F 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
000522 4522 CDB446          17      CALL    ROM_READ
000525 4525 3A38F1          13      LD  A,(_BUF)
000528 4528 3C               4      INC A
000529 4529 C26844          10      JP  NZ,ROM_LOAD_ASCII
00052C 452C 2A76F6          16      LD  HL,(TXTTAB)
00052F 452F 222EF1          16      LD  (_DTA),HL
000532 4532 EB               4      EX  DE,HL
000533 4533 2100FF          10      LD  HL,-256
000536 4536 39              11      ADD HL,SP
000537 4537 ED52            15      SBC HL,DE
000539 4539 CDB446          17      CALL    ROM_READ
00053C 453C ED5B2EF1        20      LD  DE,(_DTA)
000540 4540 19              11      ADD HL,DE
       4541                     RLOAD_END1:
000541 4541 22C2F6          16      LD  (VARTAB),HL
000544 4544 22C4F6          16      LD  (ARYTAB),HL
000547 4547 22C6F6          16      LD  (STREND),HL
                                
00054A 454A AF               4      XOR A
00054B 454B 213BF1          10      LD  HL,_BUF+3
00054E 454E 77               7      LD  (HL),A
00054F 454F 2B               6      DEC HL
000550 4550 77               7      LD  (HL),A
000551 4551 2B               6      DEC HL
000552 4552 77               7      LD  (HL),A
000553 4553 2B               6      DEC HL
000554 4554 3E8F             7      LD  A,08FH          ;REM
000556 4556 77               7      LD  (HL),A
000557 4557 C9              10      RET
                                
       4558                     ERROR_DIRECT_IN_FILE:
000558 4558 1E39             7      LD  E,57            ;Direct statement in file
00055A 455A 01                      DB  1           ;LD BC,
       455B                     ERROR_FILE_NOT_OPEN:
00055B 455B 1E3B             7      LD  E,59            ;File not OPEN
00055D 455D 01                      DB  1           ;LD BC,
       455E                     ERROR_FILE_NOT_FOUND:
00055E 455E 1E35             7      LD  E,53            ;File not found
       4560                     ERROR:
000560 4560 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000564 4564 DD216F40        14      LD  IX,ERRHAND
000568 4568 C31C00          10      JP  _CALSLT
                                
       456B                     ROM_BLOAD:
00056B 456B CD8946          17      CALL    INIT_PARAM
00056E 456E CD5447          17      CALL    FILE_B
000571 4571 CD9448          17      CALL    ROM_OPEN
000574 4574 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000576 4576 2138F1          10      LD  HL,_BUF
000579 4579 222EF1          16      LD  (_DTA),HL
00057C 457C 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
00057F 457F CDB446          17      CALL    ROM_READ
000582 4582 3A38F1          13      LD  A,(_BUF)
000585 4585 FEFE             7      CP  0FEH
000587 4587 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
000589 4589 210AF1          10      LD  HL,BLOAD_RET
00058C 458C 2202F1          16      LD  (SWC_BLOAD),HL
                                
00058F 458F 2A49F1          16      LD  HL,(PARAM1)
000592 4592 7E               7      LD  A,(HL)
000593 4593 FE2C             7      CP  ','
000595 4595 2048            12      JR  NZ,RBREAD_MEM
000597 4597 23               6      INC HL
000598 4598 7E               7      LD  A,(HL)
000599 4599 CD7E48          17      CALL    CAP
00059C 459C 32BEFC          13      LD  (RUNBNF),A
       459F                     RBOS1:
00059F 459F 7E               7      LD  A,(HL)
0005A0 45A0 23               6      INC HL
0005A1 45A1 B7               4      OR  A
0005A2 45A2 282F            12      JR  Z,RBREAD_OSE
0005A4 45A4 FE3A             7      CP  ':'
0005A6 45A6 282B            12      JR  Z,RBREAD_OSE
0005A8 45A8 FE2C             7      CP  ','     ;次のパラメータを探す
0005AA 45AA 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
0005AC 45AC 2249F1          16      LD  (PARAM1),HL
0005AF 45AF 7E               7      LD  A,(HL)
0005B0 45B0 B7               4      OR  A
0005B1 45B1 2820            12      JR  Z,RBREAD_OSE
0005B3 45B3 DD21644C        14      LD  IX,FRMEVL
0005B7 45B7 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0005BB 45BB CD1C00          17      CALL    _CALSLT
0005BE 45BE 2249F1          16      LD  (PARAM1),HL
0005C1 45C1 3A63F6          13      LD  A,(VALTYP)
0005C4 45C4 FE02             7      CP  2
0005C6 45C6 200B            12      JR  NZ,RBREAD_OSE
0005C8 45C8 2A39F1          16      LD  HL,(_BUF_ST)
0005CB 45CB ED5BF8F7        20      LD  DE,(DACDAT)
0005CF 45CF 19              11      ADD HL,DE
0005D0 45D0 2239F1          16      LD  (_BUF_ST),HL
       45D3                     RBREAD_OSE:
0005D3 45D3 3ABEFC          13      LD  A,(RUNBNF)
0005D6 45D6 FE53             7      CP  'S'
                                #if exists USE_RAM_BLOAD_S
                                    JR  Z,ROM_BLOAD_SCREEN
                                #else
0005D8 45D8 2005            12      JR  NZ,RBREAD_MEM
0005DA 45DA 3E01             7      LD  A,1
0005DC 45DC 3230F1          13      LD  (FLG_LDIR),A
                                #endif
       45DF                     RBREAD_MEM:
0005DF 45DF 2A39F1          16      LD  HL,(_BUF_ST)
0005E2 45E2 22BFFC          16      LD  (SAVENT),HL
0005E5 45E5 222EF1          16      LD  (_DTA),HL
0005E8 45E8 21FFFF          10      LD  HL,0FFFFH
0005EB 45EB CDB446          17      CALL    ROM_READ
0005EE 45EE 3ABEFC          13      LD  A,(RUNBNF)
0005F1 45F1 FE52             7      CP  'R'
0005F3 45F3 2006            12      JR  NZ,RBREAD1
0005F5 45F5 2A3DF1          16      LD  HL,(_BUF_EX)
0005F8 45F8 2202F1          16      LD  (SWC_BLOAD),HL
       45FB                     RBREAD1:
       45FB                     ROM_NEXT:
0005FB 45FB 2A49F1          16      LD  HL,(PARAM1)
0005FE 45FE 7E               7      LD  A,(HL)
0005FF 45FF 2B               6      DEC HL
000600 4600 B7               4      OR  A
000601 4601 2805            12      JR  Z,RN1
000603 4603 FE3A             7      CP  ':'
000605 4605 2801            12      JR  Z,RN1
000607 4607 23               6      INC HL
       4608                     RN1:
000608 4608 5D               4      LD  E,L
000609 4609 54               4      LD  D,H
                                
00060A 460A CD5448          17      CALL    SEARCH_END
00060D 460D B7               4      OR  A
00060E 460E 2815            12      JR  Z,REM
                                                    ;マルチステートメントの処理
000610 4610 7E               7      LD  A,(HL)
                                
000611 4611 FEB5             7      CP  0B5H            ;LOAD
000613 4613 CA0E45          10      JP  Z,ROM_LOAD
000616 4616 FE8A             7      CP  08AH            ;RUN
000618 4618 280F            12      JR  Z,ROM_RUN
00061A 461A FEB7             7      CP  0B7H            ;FILES
00061C 461C 2818            12      JR  Z,ROM_FILES
00061E 461E 3E28             7      LD  A,028H          ;JR Z,
000620 4620 3208F1          13      LD  (SWC_BLOAD_M),A
000623 4623 7E               7      LD  A,(HL)
000624 4624 C9              10      RET
                                
       4625                     REM:
000625 4625 EB               4      EX  DE,HL
000626 4626 3E8F             7      LD  A,08FH          ;REM
000628 4628 C9              10      RET
                                
                                #if exists USE_RAM_BLOAD_S
                                ROM_BLOAD_SCREEN:
                                    LD  HL,(STREND)
                                    LD  (_DTA),HL
                                    EX  DE,HL
                                    LD  HL,-512
                                    ADD HL,SP
                                    XOR A
                                    SBC HL,DE
                                    JR  NC,RBS0
                                    LD  HL,BUF
                                    LD  (_DTA),HL
                                    LD  L,A ;0
                                    LD  H,A ;0
                                RBS0:
                                    INC H
                                    LD  (_BUF_EN),HL
                                RBS1:
                                    LD  HL,(_BUF_EN)
                                    CALL    ROM_READ
                                    LD  A,H
                                    OR  L
                                    JR  Z,ROM_NEXT
                                
                                    PUSH    HL
                                    LD  C,L
                                    LD  B,H
                                    LD  HL,(_DTA)   ;転送元
                                    LD  DE,(_BUF_ST)    ;転送先
                                
                                    LD  IY,(EXPTBL-1)   ;メインROMスロット
                                    LD  IX,LDIRVM
                                    CALL    _CALSLT
                                
                                    LD  HL,(_BUF_ST)
                                    POP DE
                                    ADD HL,DE
                                    LD  (_BUF_ST),HL
                                    JR  RBS1
                                #endif
                                
       4629                     ROM_RUN:
000629 4629 23               6      INC HL
00062A 462A 7E               7      LD  A,(HL)
00062B 462B 2B               6      DEC HL
00062C 462C B7               4      OR  A
00062D 462D 2803            12      JR  Z,ROM_RUN1
00062F 462F CD0E45          17      CALL    ROM_LOAD
       4632                     ROM_RUN1:
000632 4632 3E8A             7      LD  A,08AH          ;RUN
000634 4634 77               7      LD  (HL),A
000635 4635 C9              10      RET
                                
       4636                     ROM_FILES:
000636 4636 CD8946          17      CALL    INIT_PARAM
000639 4639 CD5447          17      CALL    FILE_B
00063C 463C CD794C          17      CALL    GET_DISK_BANK_FDRV
00063F 463F 320068          13      LD  (BANK1_SEL),A
000642 4642 3A4CF1          13      LD  A,(FNAME)
000645 4645 FE21             7      CP  021H
000647 4647 3005            12      JR  NC,RFILES0
000649 4649 060B             7      LD  B,11
00064B 464B CDE847          17      CALL    FILE10
       464E                     RFILES0:
00064E 464E CDBC4A          17      CALL    GET_DIR_DAT
       4651                     RFILES1:
000651 4651 CDB048          17      CALL    FILESE
000654 4654 302E            12      JR  NC,RFILES_NOT_MATCH
       4656                     RFILES_DISP:
000656 4656 E5              11      PUSH    HL
000657 4657 0608             7      LD  B,8
000659 4659 CD8143          17      CALL    MSN
00065C 465C 3E2E             7      LD  A,'.'
00065E 465E CDD34C          17      CALL    MSG_A
000661 4661 0603             7      LD  B,3
000663 4663 CD8143          17      CALL    MSN
000666 4666 3ADDF3          13      LD  A,(CSRX)
000669 4669 47               4      LD  B,A
00066A 466A 3AB0F3          13      LD  A,(LINLEN)
00066D 466D 90               4      SUB B
00066E 466E FE0C             7      CP  12
000670 4670 3009            12      JR  NC,RFILES2
000672 4672 3E0D             7      LD  A,00DH      ;改行
000674 4674 CDD34C          17      CALL    MSG_A
000677 4677 3E0A             7      LD  A,00AH
000679 4679 1802            12      JR  RFILES3
       467B                     RFILES2:
00067B 467B 3E20             7      LD  A,020H
       467D                     RFILES3:
00067D 467D CDD34C          17      CALL    MSG_A
000680 4680 E1              10      POP HL
000681 4681 CDCC48          17      CALL    FNEXT
       4684                     RFILES_NOT_MATCH:
000684 4684 20CB            12      JR  NZ,RFILES1
000686 4686 C3FB45          10      JP  ROM_NEXT
                                
       4689                     INIT_PARAM:
000689 4689 2247F1          16      LD  (PARAM0),HL
00068C 468C 2249F1          16      LD  (PARAM1),HL
00068F 468F EB               4      EX  DE,HL
000690 4690 AF               4      XOR A
                                #if exists USE_RAM_BLOAD_S
                                #else
000691 4691 3230F1          13      LD  (FLG_LDIR),A
                                #endif
000694 4694 32BEFC          13      LD  (RUNBNF),A
000697 4697 3263F6          13      LD  (VALTYP),A
00069A 469A 13               6      INC DE
00069B 469B CD2448          17      CALL    SPCUT
00069E 469E 1A               7      LD  A,(DE)
00069F 469F B7               4      OR  A
0006A0 46A0 C8              11      RET Z
0006A1 46A1 FE3A             7      CP  ':'
0006A3 46A3 C8              11      RET Z
0006A4 46A4 EB               4      EX  DE,HL
0006A5 46A5 DD21644C        14      LD  IX,FRMEVL
0006A9 46A9 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0006AD 46AD CD1C00          17      CALL    _CALSLT
0006B0 46B0 2249F1          16      LD  (PARAM1),HL
0006B3 46B3 C9              10      RET
                                
       46B4                     ROM_READ:
0006B4 46B4 E5              11      PUSH    HL
0006B5 46B5 D5              11      PUSH    DE
0006B6 46B6 C5              11      PUSH    BC
0006B7 46B7 FDE5            15      PUSH    IY
0006B9 46B9 2245F1          16      LD  (LEFTX),HL
0006BC 46BC 2A2EF1          16      LD  HL,(_DTA)
0006BF 46BF 223FF1          16      LD  (DTAX),HL
0006C2 46C2 2A45F1          16      LD  HL,(LEFTX)
                                
0006C5 46C5 CDF848          17      CALL    RBX1
0006C8 46C8 3870            12      JR  C,RBRERR1
0006CA 46CA 79               4      LD  A,C
0006CB 46CB EB               4      EX  DE,HL
0006CC 46CC ED52            15      SBC HL,DE       ;CP 0HL,CDE
0006CE 46CE 19              11      ADD HL,DE
0006CF 46CF DE00             7      SBC A,000H
0006D1 46D1 3801            12      JR  C,RBR1
0006D3 46D3 EB               4      EX  DE,HL
       46D4                     RBR1:
0006D4 46D4 9F               4      SBC A,A
0006D5 46D5 E601             7      AND 1
0006D7 46D7 321EF1          13      LD  (_RESULT),A
0006DA 46DA 7C               4      LD  A,H
0006DB 46DB B5               4      OR  L
0006DC 46DC CA3047          10      JP  Z,RBREND0
                                
0006DF 46DF 222AF1          16      LD  (_LEFT),HL  ;Read record byte
0006E2 46E2 2245F1          16      LD  (LEFTX),HL
                                
0006E5 46E5 CD1E49          17      CALL    RBX2
0006E8 46E8 281A            12      JR  Z,RBRB
                                                ;先頭の端数
0006EA 46EA CD3149          17      CALL    RBXA
0006ED 46ED DA4647          10      JP  C,RBRERR
0006F0 46F0 C5              11      PUSH    BC
0006F1 46F1 CD1144          17      CALL    ROM_LDIR
0006F4 46F4 ED533FF1        20      LD  (DTAX),DE
0006F8 46F8 2A45F1          16      LD  HL,(LEFTX)
0006FB 46FB D1              10      POP DE
0006FC 46FC A7               4      AND A
0006FD 46FD ED52            15      SBC HL,DE
0006FF 46FF 2245F1          16      LD  (LEFTX),HL
000702 4702 2829            12      JR  Z,RBREND
                                
       4704                     RBRB:
000704 4704 CD6A49          17      CALL    RBXB
000707 4707 2818            12      JR  Z,RBRC
       4709                     RBRB1:
000709 4709 C5              11      PUSH    BC
00070A 470A D5              11      PUSH    DE
00070B 470B CD0F4A          17      CALL    CLUST
00070E 470E EB               4      EX  DE,HL
00070F 470F ED4B20F1        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000713 4713 CD1144          17      CALL    ROM_LDIR
000716 4716 EB               4      EX  DE,HL
000717 4717 D1              10      POP DE
000718 4718 C1              10      POP BC
000719 4719 CDEC49          17      CALL    GNCL
00071C 471C DA4647          10      JP  C,RBRERR
00071F 471F 10E8            13      DJNZ    RBRB1
       4721                     RBRC:
000721 4721 CD8249          17      CALL    RBXC
000724 4724 2807            12      JR  Z,RBREND
                                
000726 4726 CD0F4A          17      CALL    CLUST
000729 4729 EB               4      EX  DE,HL
00072A 472A CD1144          17      CALL    ROM_LDIR
       472D                     RBREND:
00072D 472D CD8E49          17      CALL    RBXEND
       4730                     RBREND0:
000730 4730 FDE1            14      POP IY
000732 4732 C1              10      POP BC
000733 4733 D1              10      POP DE
000734 4734 F1              10      POP AF  ;(HL)
000735 4735 AF               4      XOR A
000736 4736 3A1EF1          13      LD  A,(_RESULT)
000739 4739 C9              10      RET
                                
       473A                     RBRERR1:
00073A 473A 3E01             7      LD  A,001H
       473C                     RBRERR2:
00073C 473C FDE1            14      POP IY
00073E 473E C1              10      POP BC
00073F 473F D1              10      POP DE
000740 4740 E1              10      POP HL
000741 4741 37               4      SCF
000742 4742 210000          10      LD  HL,0
000745 4745 C9              10      RET
       4746                     RBRERR:
000746 4746 3EFF             7      LD  A,0FFH
000748 4748 18F2            12      JR  RBRERR2
                                
       474A                     FILE_DD:
00074A 474A 3E                      DB  03EH
00074B 474B C9              10      RET
00074C 474C 3208F1          13      LD  (SWC_BLOAD_M),A
00074F 474F 2A47F1          16      LD  HL,(PARAM0)
000752 4752 7E               7      LD  A,(HL)
000753 4753 C9              10      RET
       4754                     FILE_B:
000754 4754 AF               4      XOR A
000755 4755 324BF1          13      LD  (FDRV),A
000758 4758 1E00             7      LD  E,0
00075A 475A 3A63F6          13      LD  A,(VALTYP)
00075D 475D FE03             7      CP  3       ;string
00075F 475F 2044            12      JR  NZ,FILED
                                
000761 4761 DD21D067        14      LD  IX,FRESTR
000765 4765 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000769 4769 CD1C00          17      CALL    _CALSLT
00076C 476C E5              11      PUSH    HL
00076D 476D DDE1            14      POP IX
                                
00076F 476F DD5E00          19      LD  E,(IX+0)
000772 4772 DD7E01          19      LD  A,(IX+1)
000775 4775 DD5602          19      LD  D,(IX+2)
000778 4778 DD62             9      LD  IXH,D
00077A 477A DD6F             9      LD  IXL,A
00077C 477C 7B               4      LD  A,E
00077D 477D FE04             7      CP  4
00077F 477F 3808            12      JR  C,FILEB1
000781 4781 DD7E03          19      LD  A,(IX+3)
000784 4784 FE3A             7      CP  ':'
000786 4786 28C2            12      JR  Z,FILE_DD
000788 4788 7B               4      LD  A,E
       4789                     FILEB1:
000789 4789 FE02             7      CP  2
00078B 478B 3818            12      JR  C,FILED
00078D 478D DD7E01          19      LD  A,(IX+1)
000790 4790 FE3A             7      CP  ':'
000792 4792 2011            12      JR  NZ,DEVI1
000794 4794 DD7E00          19      LD  A,(IX+0)        ;DRIVE
000797 4797 CD7E48          17      CALL    CAP
00079A 479A D640             7      SUB '@'
00079C 479C DD23            10      INC IX
00079E 479E DD23            10      INC IX
0007A0 47A0 1D               4      DEC E
0007A1 47A1 1D               4      DEC E
0007A2 47A2 324BF1          13      LD  (FDRV),A
       47A5                     DEVI1:
                                
       47A5                     FILED:
0007A5 47A5 CDEC47          17      CALL    FILEI
0007A8 47A8 214CF1          10      LD  HL,FNAME
                                
0007AB 47AB 0608             7      LD  B,8
       47AD                     FILE2:
0007AD 47AD CDF947          17      CALL    CCHKF
0007B0 47B0 C8              11      RET Z
0007B1 47B1 FE2A             7      CP  '*'
0007B3 47B3 282E            12      JR  Z,FILE9
0007B5 47B5 FE2E             7      CP  '.'
0007B7 47B7 280C            12      JR  Z,FILE4
0007B9 47B9 77               7      LD  (HL),A
0007BA 47BA 23               6      INC HL
0007BB 47BB 10F0            13      DJNZ    FILE2
                                
       47BD                     FILE3:
0007BD 47BD CDF947          17      CALL    CCHKF
0007C0 47C0 C8              11      RET Z
0007C1 47C1 FE2E             7      CP  '.'
0007C3 47C3 20F8            12      JR  NZ,FILE3
                                
       47C5                     FILE4:
0007C5 47C5 2154F1          10      LD  HL,FNAME+8
0007C8 47C8 0603             7      LD  B,3
                                
       47CA                     FILE4L:
0007CA 47CA CDF947          17      CALL    CCHKF
0007CD 47CD C8              11      RET Z
0007CE 47CE FE2E             7      CP  '.'
0007D0 47D0 2008            12      JR  NZ,FILE12
0007D2 47D2 324CF1          13      LD  (FNAME),A   ;Parent directory(..)
0007D5 47D5 324DF1          13      LD  (FNAME+1),A
0007D8 47D8 3E20             7      LD  A,020H
       47DA                     FILE12:
0007DA 47DA FE2A             7      CP  '*'
0007DC 47DC 280A            12      JR  Z,FILE10
0007DE 47DE 77               7      LD  (HL),A
0007DF 47DF 23               6      INC HL
0007E0 47E0 10E8            13      DJNZ    FILE4L
0007E2 47E2 C9              10      RET
                                
       47E3                     FILE9:              ;名前の*処理、名前の残りを?で埋める
0007E3 47E3 CDE847          17      CALL    FILE10
0007E6 47E6 18D5            12      JR  FILE3
                                
       47E8                     FILE10:
0007E8 47E8 3E3F             7      LD  A,'?'
0007EA 47EA 1808            12      JR  FILL_MEMORY
       47EC                     FILEI:              ;名前＋拡張子をスペースで初期化
0007EC 47EC 3E20             7      LD  A,020H
0007EE 47EE 01000B          10      LD  BC,11*256   ;C=0にしておく
0007F1 47F1 214CF1          10      LD  HL,FNAME
       47F4                     FILL_MEMORY:            ;HLからBバイトAで埋める
0007F4 47F4 77               7      LD  (HL),A
0007F5 47F5 23               6      INC HL
0007F6 47F6 10FC            13      DJNZ    FILL_MEMORY
0007F8 47F8 C9              10      RET
                                
       47F9                     CCHKF:
0007F9 47F9 7B               4      LD  A,E
0007FA 47FA B7               4      OR  A
0007FB 47FB C8              11      RET Z
0007FC 47FC DD7E00          19      LD  A,(IX+0)
0007FF 47FF CD0648          17      CALL    CCHK2
000802 4802 C8              11      RET Z
000803 4803 C36948          10      JP  FKAN
                                
       4806                     CCHK2:
000806 4806 0C               4      INC C
000807 4807 0D               4      DEC C
000808 4808 C0              11      RET NZ
       4809                     CCHK3:              ;ZF=1 で使えない文字
000809 4809 FE2B             7      CP  '+'
00080B 480B C8              11      RET Z
00080C 480C FE2C             7      CP  ','
00080E 480E C8              11      RET Z
00080F 480F FE2F             7      CP  '/'
000811 4811 C8              11      RET Z
000812 4812 FE3A             7      CP  ':'
000814 4814 C8              11      RET Z
000815 4815 FE3B             7      CP  ';'
000817 4817 C8              11      RET Z
000818 4818 FE3D             7      CP  '='
00081A 481A C8              11      RET Z
00081B 481B FE5C             7      CP  05CH    ;\
00081D 481D C8              11      RET Z
00081E 481E FE1F             7      CP  01FH
000820 4820 D0              11      RET NC
000821 4821 BF               4      CP  A       ;Z=1
000822 4822 C9              10      RET
                                
       4823                     SS1:
000823 4823 13               6      INC DE
       4824                     SPCUT:              ;スペースをカット
000824 4824 1A               7      LD  A,(DE)
000825 4825 FE20             7      CP  020H
000827 4827 28FA            12      JR  Z,SS1
000829 4829 C9              10      RET
                                
       482A                     SCREOF1:
00082A 482A 13               6      INC DE
       482B                     SPCUTEX:            ;スペース改行などをカット
00082B 482B 1A               7      LD  A,(DE)
00082C 482C FE20             7      CP  020H
00082E 482E 28FA            12      JR  Z,SCREOF1
000830 4830 FE0D             7      CP  00DH
000832 4832 28F6            12      JR  Z,SCREOF1
000834 4834 FE0A             7      CP  00AH
000836 4836 28F2            12      JR  Z,SCREOF1
000838 4838 FE1A             7      CP  01AH
00083A 483A 28EE            12      JR  Z,SCREOF1
00083C 483C C9              10      RET
                                
       483D                     GETNUM:
00083D 483D 210000          10      LD  HL,0
       4840                     GETNUM1:
000840 4840 1A               7      LD  A,(DE)
000841 4841 13               6      INC DE
000842 4842 D630             7      SUB '0'
000844 4844 D8              11      RET C
000845 4845 FE0A             7      CP  10
000847 4847 D0              11      RET NC
000848 4848 4D               4      LD  C,L
000849 4849 44               4      LD  B,H
00084A 484A 29              11      ADD HL,HL   ;*2
00084B 484B 29              11      ADD HL,HL   ;*4
00084C 484C 09              11      ADD HL,BC   ;*5
00084D 484D 29              11      ADD HL,HL   ;*10
00084E 484E 4F               4      LD  C,A
00084F 484F 0600             7      LD  B,0
000851 4851 09              11      ADD HL,BC
000852 4852 18EC            12      JR  GETNUM1
                                
       4854                     SEARCH_END:
000854 4854 7E               7      LD  A,(HL)
       4855                     SEARCH_END1:
000855 4855 23               6      INC HL
000856 4856 B7               4      OR  A
000857 4857 C8              11      RET Z
000858 4858 FE3A             7      CP  ':'
00085A 485A 20F8            12      JR  NZ,SEARCH_END
00085C 485C 7E               7      LD  A,(HL)
00085D 485D FE3A             7      CP  ':'
00085F 485F 28F4            12      JR  Z,SEARCH_END1
000861 4861 C9              10      RET
                                
       4862                     FKANC:
000862 4862 CB41             8      BIT 0,C
000864 4864 CC8748          17      CALL    Z,CAP2
000867 4867 1803            12      JR  FKANX
       4869                     FKAN:           ;漢字チェック
000869 4869 DD23            10      INC IX
00086B 486B 1D               4      DEC E
       486C                     FKANX:
00086C 486C CB41             8      BIT 0,C
00086E 486E CB81             8      RES 0,C
000870 4870 C0              11      RET NZ
000871 4871 FE80             7      CP  080H
000873 4873 D8              11      RET C
000874 4874 FEA0             7      CP  0A0H
000876 4876 3803            12      JR  C,FKAN1
000878 4878 FEE0             7      CP  0E0H
00087A 487A D8              11      RET C
       487B                     FKAN1:
00087B 487B 0C               4      INC C
00087C 487C A7               4      AND A
00087D 487D C9              10      RET
                                
       487E                     CAP:
00087E 487E FE61             7      CP  'a'
000880 4880 D8              11      RET C
000881 4881 FE7B             7      CP  'z'+1
000883 4883 D0              11      RET NC
000884 4884 D620             7      SUB 020H
000886 4886 C9              10      RET
       4887                     CAP2:
000887 4887 CD7E48          17      CALL    CAP
       488A                     CAP3:               ;
00088A 488A FE05             7      CP  5
00088C 488C 2803            12      JR  Z,CAP4
00088E 488E FE21             7      CP  021H
000890 4890 C9              10      RET
       4891                     CAP4:
000891 4891 3EE5             7      LD  A,0E5H
000893 4893 C9              10      RET
                                
       4894                     ROM_OPEN:
000894 4894 CD794C          17      CALL    GET_DISK_BANK_FDRV
                                
000897 4897 CDBC4A          17      CALL    GET_DIR_DAT
00089A 489A D5              11      PUSH    DE
00089B 489B CDB048          17      CALL    FILESE
00089E 489E D1              10      POP DE
00089F 489F 3F               4      CCF
0008A0 48A0 D8              11      RET C
0008A1 48A1 2243F1          16      LD  (FCBX),HL
0008A4 48A4 E5              11      PUSH    HL
0008A5 48A5 210000          10      LD  HL,0
0008A8 48A8 2224F1          16      LD  (RR_LOW),HL
0008AB 48AB 2226F1          16      LD  (RR_HIGH),HL
0008AE 48AE E1              10      POP HL
0008AF 48AF C9              10      RET
                                
       48B0                     FILESE:
0008B0 48B0 7E               7      LD  A,(HL)
0008B1 48B1 B7               4      OR  A
0008B2 48B2 C8              11      RET Z       ;END:ZF=1 CF=0
0008B3 48B3 FEE5             7      CP  0E5H
0008B5 48B5 280D            12      JR  Z,FILESE1
0008B7 48B7 114CF1          10      LD  DE,FNAME
0008BA 48BA E5              11      PUSH    HL
0008BB 48BB CDD248          17      CALL    CPFILE
0008BE 48BE CCF348          17      CALL    Z,CPFILE2
0008C1 48C1 E1              10      POP HL
0008C2 48C2 37               4      SCF
0008C3 48C3 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       48C4                     FILESE1:
0008C4 48C4 CDCC48          17      CALL    FNEXT
0008C7 48C7 20E7            12      JR  NZ,FILESE
       48C9                     ZF0_CF0_AFF_RET:
0008C9 48C9 F6FF             7      OR  0FFH        ;ZF=0 CF=0
0008CB 48CB C9              10      RET
                                
       48CC                     FNEXT:
                                ;   PUSH    HL
                                ;   LD  HL,_FILEN
                                ;   INC (HL)
                                ;   POP HL
0008CC 48CC 112000          10      LD  DE,020H
0008CF 48CF 19              11      ADD HL,DE
0008D0 48D0 0D               4      DEC C
0008D1 48D1 C9              10      RET
                                
       48D2                     CPFILE:
0008D2 48D2 C5              11      PUSH    BC
0008D3 48D3 01000B          10      LD  BC,00B00H
       48D6                     CPSTR1:
0008D6 48D6 1A               7      LD  A,(DE)
0008D7 48D7 FE3F             7      CP  '?'     ;Wild card
0008D9 48D9 2812            12      JR  Z,CPSTR2
0008DB 48DB 7E               7      LD  A,(HL)
0008DC 48DC CD6248          17      CALL    FKANC
0008DF 48DF E5              11      PUSH    HL
0008E0 48E0 67               4      LD  H,A
0008E1 48E1 1A               7      LD  A,(DE)
0008E2 48E2 CB01             4      RLC C
0008E4 48E4 CD6248          17      CALL    FKANC
0008E7 48E7 CB09             4      RRC C
0008E9 48E9 BC               4      CP  H       ;CP (HL),(DE)
0008EA 48EA E1              10      POP HL
0008EB 48EB 2004            12      JR  NZ,CPSTR3
       48ED                     CPSTR2:
0008ED 48ED 13               6      INC DE
0008EE 48EE 23               6      INC HL
0008EF 48EF 10E5            13      DJNZ    CPSTR1
       48F1                     CPSTR3:
0008F1 48F1 C1              10      POP BC
0008F2 48F2 C9              10      RET
                                
       48F3                     CPFILE2:
                                ;   LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
                                ;   OR  0E1H
0008F3 48F3 3EE1             7      LD  A,0E1H
0008F5 48F5 2F               4      CPL
0008F6 48F6 A6               7      AND (HL)
0008F7 48F7 C9              10      RET
                                
       48F8                     RBX1:
0008F8 48F8 E5              11      PUSH    HL      ;Record byte
                                
0008F9 48F9 ED5B24F1        20      LD  DE,(RR_LOW) ;CDE=Random record
0008FD 48FD 3A27F1          13      LD  A,(RR_HIGH+1)
000900 4900 4F               4      LD  C,A
                                
000901 4901 CD794C          17      CALL    GET_DISK_BANK_FDRV
                                
000904 4904 FD2A43F1        20      LD  IY,(FCBX)
000908 4908 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
00090B 490B FD661D          19      LD  H,(IY+01DH)
00090E 490E FD7E1E          19      LD  A,(IY+01EH)
                                
000911 4911 A7               4      AND A
000912 4912 ED52            15      SBC HL,DE
000914 4914 99               4      SBC A,C
000915 4915 D1              10      POP DE
                                
000916 4916 D8              11      RET C
000917 4917 4F               4      LD  C,A
000918 4918 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000919 4919 B2               4      OR  D
00091A 491A B3               4      OR  E
00091B 491B C0              11      RET NZ
00091C 491C 37               4      SCF
00091D 491D C9              10      RET
                                
       491E                     RBX2:
00091E 491E ED4B25F1        20      LD  BC,(RR_LOW+1)
000922 4922 CDA349          17      CALL    RWXR
000925 4925 3A21F1          13      LD  A,(CLSZ_H)
000928 4928 3D               4      DEC A
000929 4929 E5              11      PUSH    HL
00092A 492A 2A24F1          16      LD  HL,(RR_LOW)
00092D 492D A4               4      AND H
00092E 492E B5               4      OR  L
00092F 492F E1              10      POP HL
000930 4930 C9              10      RET
                                
       4931                     RBXA:
000931 4931 D5              11      PUSH    DE
000932 4932 CD0F4A          17      CALL    CLUST
000935 4935 ED532CF1        20      LD  (_DTPS),DE
000939 4939 D1              10      POP DE
00093A 493A CDEC49          17      CALL    GNCL
00093D 493D D8              11      RET C
00093E 493E ED5328F1        20      LD  (_CLPS),DE
                                
000942 4942 ED4B24F1        20      LD  BC,(RR_LOW)
000946 4946 2A20F1          16      LD  HL,(CLSZ)
000949 4949 7C               4      LD  A,H
00094A 494A 3D               4      DEC A
00094B 494B A0               4      AND B
00094C 494C 47               4      LD  B,A
00094D 494D ED42            15      SBC HL,BC       ;remaining cluster
                                
00094F 494F ED5B45F1        20      LD  DE,(LEFTX)
000953 4953 ED52            15      SBC HL,DE       ;CP HL,DE
000955 4955 19              11      ADD HL,DE
000956 4956 3801            12      JR  C,RBXA1
000958 4958 EB               4      EX  DE,HL
       4959                     RBXA1:
000959 4959 3A1FF1          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
00095C 495C 320068          13      LD  (BANK1_SEL),A   ;ASCII-8K/Konami-8K共通で使える
00095F 495F E5              11      PUSH    HL
000960 4960 2A2CF1          16      LD  HL,(_DTPS)
000963 4963 09              11      ADD HL,BC
000964 4964 ED5B3FF1        20      LD  DE,(DTAX)
000968 4968 C1              10      POP BC
000969 4969 C9              10      RET
                                
       496A                     RBXB:
00096A 496A 2A3FF1          16      LD  HL,(DTAX)
00096D 496D ED5B28F1        20      LD  DE,(_CLPS)
000971 4971 3A46F1          13      LD  A,(LEFTX+1)
000974 4974 47               4      LD  B,A
000975 4975 3A21F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4978                     RBXB1:
000978 4978 1F               4      RRA     ;->CF
000979 4979 3804            12      JR  C,RBXB2
00097B 497B CB38             8      SRL B   ;B=B/2
00097D 497D 18F9            12      JR  RBXB1
       497F                     RBXB2:
00097F 497F 78               4      LD  A,B
000980 4980 B7               4      OR  A
000981 4981 C9              10      RET
                                
       4982                     RBXC:
000982 4982 ED4B45F1        20      LD  BC,(LEFTX)
000986 4986 3A21F1          13      LD  A,(CLSZ_H)
000989 4989 3D               4      DEC A
00098A 498A A0               4      AND B
00098B 498B 47               4      LD  B,A
00098C 498C B1               4      OR  C
00098D 498D C9              10      RET
                                
       498E                     RBXEND:
00098E 498E ED5B2AF1        20      LD  DE,(_LEFT)
000992 4992 2A24F1          16      LD  HL,(RR_LOW)
000995 4995 3A27F1          13      LD  A,(RR_HIGH+1)
000998 4998 19              11      ADD HL,DE
000999 4999 CE00             7      ADC A,0
00099B 499B 2224F1          16      LD  (RR_LOW),HL
00099E 499E 3227F1          13      LD  (RR_HIGH+1),A
0009A1 49A1 EB               4      EX  DE,HL       ;HL=Read byte
0009A2 49A2 C9              10      RET 
                                
       49A3                     RWXR:
0009A3 49A3 3A21F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       49A6                     L_RWX:
0009A6 49A6 1F               4      RRA     ;->CF
0009A7 49A7 3806            12      JR  C,E_RWX
0009A9 49A9 CB38             8      SRL B   ;BC=BC/2
0009AB 49AB CB19             8      RR  C   ;
0009AD 49AD 18F7            12      JR  L_RWX
       49AF                     E_RWX:
0009AF 49AF CD794C          17      CALL    GET_DISK_BANK_FDRV
                                
0009B2 49B2 FD2A43F1        20      LD  IY,(FCBX)
0009B6 49B6 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
0009B9 49B9 FD561B          19      LD  D,(IY+01BH)
       49BC                     RWX1:
0009BC 49BC ED5328F1        20      LD  (_CLPS),DE
0009C0 49C0 7A               4      LD  A,D
0009C1 49C1 B3               4      OR  E
0009C2 49C2 37               4      SCF
0009C3 49C3 C8              11      RET Z
                                
0009C4 49C4 78               4      LD  A,B
0009C5 49C5 B1               4      OR  C
0009C6 49C6 C8              11      RET Z
                                
0009C7 49C7 CDEC49          17      CALL    GNCL
0009CA 49CA D8              11      RET C
0009CB 49CB 0B               6      DEC BC
0009CC 49CC CD554A          17      CALL    ENDCL
0009CF 49CF 38EB            12      JR  C,RWX1
0009D1 49D1 37               4      SCF
0009D2 49D2 C9              10      RET
                                
       49D3                     NCL3:
0009D3 49D3 CD794C          17      CALL    GET_DISK_BANK_FDRV
0009D6 49D6 320068          13      LD  (BANK1_SEL),A
0009D9 49D9 6B               4      LD  L,E
0009DA 49DA 62               4      LD  H,D
0009DB 49DB CB3C             8      SRL H
0009DD 49DD CB1D             8      RR  L
0009DF 49DF 1F               4      RRA
0009E0 49E0 19              11      ADD HL,DE
0009E1 49E1 010060          10      LD  BC,BANK1_ADR
0009E4 49E4 09              11      ADD HL,BC
0009E5 49E5 ED4B22F1        20      LD  BC,(SECSZ)
0009E9 49E9 09              11      ADD HL,BC
0009EA 49EA 17               4      RLA
0009EB 49EB C9              10      RET
                                
       49EC                     GNCL:
0009EC 49EC 7A               4      LD  A,D
0009ED 49ED B3               4      OR  E
0009EE 49EE 37               4      SCF
0009EF 49EF C8              11      RET Z
0009F0 49F0 C5              11      PUSH    BC
0009F1 49F1 E5              11      PUSH    HL
0009F2 49F2 CDD349          17      CALL    NCL3
0009F5 49F5 3809            12      JR  C,GNC1
0009F7 49F7 5E               7      LD  E,(HL)
0009F8 49F8 23               6      INC HL
0009F9 49F9 7E               7      LD  A,(HL)
0009FA 49FA E60F             7      AND 00FH
0009FC 49FC 57               4      LD  D,A
0009FD 49FD E1              10      POP HL
0009FE 49FE C1              10      POP BC
0009FF 49FF C9              10      RET
       4A00                     GNC1:
000A00 4A00 7E               7      LD  A,(HL)
000A01 4A01 23               6      INC HL
000A02 4A02 56               7      LD  D,(HL)
000A03 4A03 0604             7      LD  B,4
       4A05                     GNC1L:
000A05 4A05 CB3A             8      SRL D
000A07 4A07 1F               4      RRA
000A08 4A08 10FB            13      DJNZ    GNC1L
                                
000A0A 4A0A 5F               4      LD  E,A
000A0B 4A0B E1              10      POP HL
000A0C 4A0C C1              10      POP BC
000A0D 4A0D A7               4      AND A
000A0E 4A0E C9              10      RET
                                
       4A0F                     CLUST:
000A0F 4A0F EB               4      EX  DE,HL
000A10 4A10 C5              11      PUSH    BC
000A11 4A11 3A21F1          13      LD  A,(CLSZ_H)
000A14 4A14 CDA24C          17      CALL    MUL_AHL
                                
000A17 4A17 CDC94A          17      CALL    GET_DIR_POS
000A1A 4A1A 4F               4      LD  C,A
000A1B 4A1B 0600             7      LD  B,0
000A1D 4A1D 09              11      ADD HL,BC
                                
000A1E 4A1E 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000A21 4A21 0F               4      RRCA
000A22 4A22 0F               4      RRCA
000A23 4A23 0F               4      RRCA
000A24 4A24 0F               4      RRCA
000A25 4A25 4F               4      LD  C,A
                                
000A26 4A26 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000A29 4A29 FE02             7      CP  2
000A2B 4A2B 280C            12      JR  Z,CLUST1
000A2D 4A2D CB01             4      RLC C
000A2F 4A2F 0D               4      DEC C
000A30 4A30 3A0C60          13      LD  A,(BANK1_ADR+11+1)  ;BPB_BytsPerSec High    
000A33 4A33 FE02             7      CP  2
000A35 4A35 2002            12      JR  NZ,CLUST1
000A37 4A37 0D               4      DEC C
000A38 4A38 0D               4      DEC C
       4A39                     CLUST1:
000A39 4A39 0D               4      DEC C
000A3A 4A3A 09              11      ADD HL,BC
                                
                                #if exists USE_NORMAL_32K_ROM
                                    LD  A,L
                                #else
000A3B 4A3B E5              11      PUSH    HL
000A3C 4A3C 29              11      ADD HL,HL   ;*2
000A3D 4A3D 29              11      ADD HL,HL   ;*4
000A3E 4A3E 29              11      ADD HL,HL   ;*8
000A3F 4A3F CD794C          17      CALL    GET_DISK_BANK_FDRV
000A42 4A42 84               4      ADD A,H
000A43 4A43 320068          13      LD  (BANK1_SEL),A
000A46 4A46 321FF1          13      LD  (_BANK),A
000A49 4A49 E1              10      POP HL
000A4A 4A4A 3E1F             7      LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
000A4C 4A4C A5               4      AND L
                                #endif
000A4D 4A4D C660             7      ADD A,high BANK1_ADR
000A4F 4A4F 67               4      LD  H,A
000A50 4A50 2E00             7      LD  L,0
000A52 4A52 EB               4      EX  DE,HL
000A53 4A53 C1              10      POP BC
000A54 4A54 C9              10      RET
                                
       4A55                     ENDCL:
000A55 4A55 7A               4      LD  A,D ;END CLUSTER
000A56 4A56 FE0F             7      CP  00FH    ;FAT12の最大値
000A58 4A58 C0              11      RET NZ
000A59 4A59 7B               4      LD  A,E
000A5A 4A5A FEF7             7      CP  0F7H
000A5C 4A5C C9              10      RET
                                
       4A5D                     RB_READ:
000A5D 4A5D AF               4      XOR A   ;HLA = HL*128
000A5E 4A5E CB3C             8      SRL H
000A60 4A60 CB1D             8      RR  L
000A62 4A62 1F               4      RRA
000A63 4A63 3224F1          13      LD  (RR_LOW),A
000A66 4A66 2225F1          16      LD  (RR_MID),HL
000A69 4A69 218000          10      LD  HL,128
                                
000A6C 4A6C CDB446          17      CALL    ROM_READ
000A6F 4A6F C9              10      RET
                                
       4A70                     GETSEQ:
000A70 4A70 FD6E20          19      LD  L,(IY+32)
000A73 4A73 FD660C          19      LD  H,(IY+12)
                                
000A76 4A76 CB25             8      SLA L
                                
000A78 4A78 CB3C             8      SRL H
000A7A 4A7A CB1D             8      RR  L
000A7C 4A7C C9              10      RET
                                
       4A7D                     SETSEQ:
000A7D 4A7D F5              11      PUSH    AF
000A7E 4A7E 3A24F1          13      LD  A,(RR_LOW)
000A81 4A81 2A25F1          16      LD  HL,(RR_MID)
                                
000A84 4A84 CD9B4A          17      CALL    SSQ1
                                
000A87 4A87 29              11      ADD HL,HL
000A88 4A88 CB3D             8      SRL L
000A8A 4A8A FD7520          19      LD  (IY+32),L
000A8D 4A8D FD740C          19      LD  (IY+12),H
000A90 4A90 F1              10      POP AF
000A91 4A91 C9              10      RET
                                
       4A92                     GETSIZE:
000A92 4A92 FD7E10          19      LD  A,(IY+16)
000A95 4A95 FD6E11          19      LD  L,(IY+17)
000A98 4A98 FD6612          19      LD  H,(IY+18)
       4A9B                     SSQ1:
000A9B 4A9B 87               4      ADD A,A
000A9C 4A9C ED6A            15      ADC HL,HL
000A9E 4A9E B7               4      OR  A
000A9F 4A9F C8              11      RET Z
000AA0 4AA0 23               6      INC HL
000AA1 4AA1 C9              10      RET
                                
       4AA2                     SET_FCB:
000AA2 4AA2 D5              11      PUSH    DE
000AA3 4AA3 FDE1            14      POP IY
000AA5 4AA5 FD7E1C          19      LD  A,(IY+28)
000AA8 4AA8 FEFF             7      CP  0FFH
000AAA 4AAA 200C            12      JR  NZ,POPAF_SCF_FF_RET
000AAC 4AAC E5              11      PUSH    HL
000AAD 4AAD FD6E1A          19      LD  L,(IY+26)
000AB0 4AB0 FD661B          19      LD  H,(IY+27)
000AB3 4AB3 2228F1          16      LD  (_CLPS),HL
000AB6 4AB6 E1              10      POP HL
000AB7 4AB7 C9              10      RET
                                
       4AB8                     POPAF_SCF_FF_RET:
000AB8 4AB8 F1              10      POP AF
000AB9 4AB9 37               4      SCF
000ABA 4ABA 9F               4      SBC A,A
000ABB 4ABB C9              10      RET
                                
       4ABC                     GET_DIR_DAT:
000ABC 4ABC CDC94A          17      CALL    GET_DIR_POS
000ABF 4ABF C660             7      ADD A,high BANK1_ADR
000AC1 4AC1 2E00             7      LD  L,0
000AC3 4AC3 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
000AC4 4AC4 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000AC7 4AC7 4F               4      LD  C,A
000AC8 4AC8 C9              10      RET
                                
       4AC9                     GET_DIR_POS:
000AC9 4AC9 CD794C          17      CALL    GET_DISK_BANK_FDRV
000ACC 4ACC 320068          13      LD  (BANK1_SEL),A
000ACF 4ACF 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000AD2 4AD2 47               4      LD  B,A
000AD3 4AD3 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000AD6 4AD6 4F               4      LD  C,A
000AD7 4AD7 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4ADA                     GET_DIR_POS1:
000ADA 4ADA 81               4      ADD A,C
000ADB 4ADB 10FD            13      DJNZ    GET_DIR_POS1
                                
000ADD 4ADD ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec 
       4AE1                     L_MDP:
000AE1 4AE1 CB18             8      RR  B   ;->CF
000AE3 4AE3 D8              11      RET C
000AE4 4AE4 87               4      ADD A,A
000AE5 4AE5 18FA            12      JR  L_MDP
                                
       4AE7                     WILDCARD:
000AE7 4AE7 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4AF2                     ERROR_WRITE_PROTECTED:
000AF2 4AF2 3E00             7      LD  A,0     ;Write protected
000AF4 4AF4 C9              10      RET
       4AF5                     DISKIO:
000AF5 4AF5 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000AF7 4AF7 48               4      LD  C,B
000AF8 4AF8 CD834C          17      CALL    GET_DISK_BANK
       4AFB                     SETMAP1:        
000AFB 4AFB E5              11      PUSH    HL
       4AFC                     DISKIO1:
000AFC 4AFC C5              11      PUSH    BC      ;B=残りのセクタ数
000AFD 4AFD D5              11      PUSH    DE      ;DE=セクタ番号
000AFE 4AFE F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
000AFF 4AFF EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
000B00 4B00 F5              11      PUSH    AF
000B01 4B01 3A23F1          13      LD  A,(SECSZ_H)
000B04 4B04 CDA24C          17      CALL    MUL_AHL
000B07 4B07 F1              10      POP AF
000B08 4B08 4D               4      LD  C,L     ;C=読み出し元
000B09 4B09 29              11      ADD HL,HL       ;64KB→32KB
000B0A 4B0A 29              11      ADD HL,HL       ;32KB→16KB
000B0B 4B0B 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
000B0C 4B0C 84               4      ADD A,H
000B0D 4B0D 320068          13      LD  (BANK1_SEL),A   ;ASCII-8K/Konami-8K共通で使える
000B10 4B10 321FF1          13      LD  (_BANK),A
000B13 4B13 79               4      LD  A,C     ;C=読み出し元
000B14 4B14 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
000B16 4B16 C660             7      ADD A,high BANK1_ADR
000B18 4B18 67               4      LD  H,A
000B19 4B19 ED4B22F1        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
000B1D 4B1D 69               4      LD  L,C     ;C=0
000B1E 4B1E EDB0                    LDIR
000B20 4B20 EB               4      EX  DE,HL
000B21 4B21 F1              10      POP AF
000B22 4B22 D1              10      POP DE
000B23 4B23 13               6      INC DE
000B24 4B24 C1              10      POP BC
000B25 4B25 10D5            13      DJNZ    DISKIO1
000B27 4B27 41               4      LD  B,C
                                
000B28 4B28 E1              10      POP HL
000B29 4B29 AF               4      XOR A
000B2A 4B2A FB               4      EI
000B2B 4B2B C9              10      RET
                                
       4B2C                     DSKCHG:
000B2C 4B2C CD654B          17      CALL    IS_BPB
000B2F 4B2F 3824            12      JR  C,NOTREADY
000B31 4B31 3A23FB          13      LD  A,(DRVTBL+2)
000B34 4B34 B7               4      OR  A
000B35 4B35 201A            12      JR  NZ,DSKCHG1
000B37 4B37 3A21FB          13      LD  A,(DRVTBL)
000B3A 4B3A FE02             7      CP  2
000B3C 4B3C 2013            12      JR  NZ,DSKCHG1
000B3E 4B3E CD654B          17      CALL    IS_BPB
000B41 4B41 300E            12      JR  NC,DSKCHG1
000B43 4B43 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000B45 4B45 3221FB          13      LD  (DRVTBL),A
000B48 4B48 3223FB          13      LD  (DRVTBL+2),A
000B4B 4B4B 3A48F3          13      LD  A,(MASTERS)
000B4E 4B4E 3224FB          13      LD  (DRVTBL+3),A
       4B51                     DSKCHG1:
000B51 4B51 AF               4      XOR A
000B52 4B52 0601             7      LD  B,1
000B54 4B54 C9              10      RET
       4B55                     NOTREADY:
000B55 4B55 3E02             7      LD  A,2
000B57 4B57 37               4      SCF
000B58 4B58 C9              10      RET
                                
       4B59                     NO_BPB:
000B59 4B59 E1              10      POP HL
000B5A 4B5A 23               6      INC HL
000B5B 4B5B 11A74C          10      LD  DE,DPB2DD
000B5E 4B5E 011200          10      LD  BC,DPB2DD_E-DPB2DD
000B61 4B61 EDB0                    LDIR
000B63 4B63 AF               4      XOR A
000B64 4B64 C9              10      RET
                                
       4B65                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000B65 4B65 CD834C          17      CALL    GET_DISK_BANK
                                
000B68 4B68 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000B6B 4B6B FE01             7      CP  1
000B6D 4B6D D8              11      RET C
                                
000B6E 4B6E 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000B71 4B71 C6FF             7      ADD A,0FFH
000B73 4B73 D8              11      RET C
                                
000B74 4B74 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
000B77 4B77 FE01             7      CP  1
000B79 4B79 C8              11      RET Z
000B7A 4B7A FE02             7      CP  2
000B7C 4B7C C8              11      RET Z
000B7D 4B7D FE04             7      CP  4
000B7F 4B7F C8              11      RET Z
000B80 4B80 37               4      SCF
000B81 4B81 C9              10      RET
                                
       4B82                     GETDPB:
000B82 4B82 E5              11      PUSH    HL
000B83 4B83 CD834C          17      CALL    GET_DISK_BANK
                                
000B86 4B86 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000B89 4B89 B7               4      OR  A
000B8A 4B8A 28CD            12      JR  Z,NO_BPB
000B8C 4B8C DDE1            14      POP IX
000B8E 4B8E DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000B91 4B91 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000B94 4B94 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000B97 4B97 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000B9A 4B9A DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000B9D 4B9D 87               4      ADD A,A
000B9E 4B9E 87               4      ADD A,A
000B9F 4B9F 87               4      ADD A,A
000BA0 4BA0 3D               4      DEC A
000BA1 4BA1 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000BA4 4BA4 06FF             7      LD  B,-1
000BA6 4BA6 A7               4      AND A           ;無限ループ阻止
       4BA7                     GETDPB1:
000BA7 4BA7 04               4      INC B
000BA8 4BA8 1F               4      RRA
000BA9 4BA9 38FC            12      JR  C,GETDPB1
000BAB 4BAB DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000BAE 4BAE 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000BB1 4BB1 3D               4      DEC A
000BB2 4BB2 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000BB5 4BB5 A7               4      AND A           ;無限ループ阻止
000BB6 4BB6 06FF             7      LD  B,-1
       4BB8                     GETDPB2:
000BB8 4BB8 04               4      INC B
000BB9 4BB9 1F               4      RRA
000BBA 4BBA 38FC            12      JR  C,GETDPB2
000BBC 4BBC 04               4      INC B
000BBD 4BBD DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000BC0 4BC0 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
000BC3 4BC3 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
000BC6 4BC6 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
000BC9 4BC9 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
000BCC 4BCC DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000BCF 4BCF 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
000BD2 4BD2 DD770B          19      LD  (IX+11),A       ;FATCNT
                                
000BD5 4BD5 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
000BD9 4BD9 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
000BDC 4BDC DD460A          19      LD  B,(IX+10)       ;FATCNT
000BDF 4BDF 210000          10      LD  HL,0
       4BE2                     GETDPB3:
000BE2 4BE2 19              11      ADD HL,DE
000BE3 4BE3 10FD            13      DJNZ    GETDPB3
       4BE5                     GETDPB4:
000BE5 4BE5 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
000BE8 4BE8 DD5609          19      LD  D,(IX+9)        ;FIRFAT
000BEB 4BEB 19              11      ADD HL,DE
000BEC 4BEC DD7511          19      LD  (IX+17),L       ;FIRDIR
000BEF 4BEF DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000BF2 4BF2 3E08             7      LD  A,2*4           ;SECSIZ HIGH
000BF4 4BF4 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4BF7                     GETDPB5:
000BF7 4BF7 CB3B             8      SRL E
000BF9 4BF9 1F               4      RRA
000BFA 4BFA 30FB            12      JR  NC,GETDPB5
000BFC 4BFC 1600             7      LD  D,0
000BFE 4BFE 19              11      ADD HL,DE
000BFF 4BFF DD750C          19      LD  (IX+12),L       ;FIRREC
000C02 4C02 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000C05 4C05 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
000C08 4C08 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
000C0B 4C0B DD560D          19      LD  D,(IX+13)       ;FIRREC
000C0E 4C0E A7               4      AND A
000C0F 4C0F ED52            15      SBC HL,DE
                                
000C11 4C11 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
000C14 4C14 3C               4      INC A
000C15 4C15 37               4      SCF             ;無限ループ阻止
       4C16                     GETDPB6:
000C16 4C16 1F               4      RRA
000C17 4C17 3806            12      JR  C,GETDPB7
000C19 4C19 CB3C             8      SRL H
000C1B 4C1B CB1D             8      RR  L
000C1D 4C1D 18F7            12      JR  GETDPB6
       4C1F                     GETDPB7:
000C1F 4C1F 23               6      INC HL
000C20 4C20 DD750E          19      LD  (IX+14),L       ;MAXCLUS
000C23 4C23 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       4C26                     GETDPBD1:
000C26 4C26 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000C29 4C29 E6FC             7      AND 0FCH
000C2B 4C2B C8              11      RET Z
                                
000C2C 4C2C DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
000C30 4C30 37               4      SCF
000C31 4C31 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
000C35 4C35 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
000C38 4C38 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
000C3C 4C3C DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
000C40 4C40 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
000C44 4C44 DDCB1126        23      SLA (IX+17)         ;FIRDIR
000C48 4C48 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
000C4C 4C4C DD6E11          19      LD  L,(IX+17)       ;FIRDIR
000C4F 4C4F DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
000C52 4C52 3E08             7      LD  A,2*4           ;SECSIZ HIGH
000C54 4C54 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4C57                     GETDPBD5:
000C57 4C57 CB3B             8      SRL E
000C59 4C59 1F               4      RRA
000C5A 4C5A 30FB            12      JR  NC,GETDPBD5
000C5C 4C5C 1600             7      LD  D,0
000C5E 4C5E 19              11      ADD HL,DE
000C5F 4C5F DD750C          19      LD  (IX+12),L       ;FIRREC
000C62 4C62 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000C65 4C65 18BF            12      JR  GETDPBD1
                                
       4C67                     CHOICE:
000C67 4C67 210000          10      LD  HL,0
000C6A 4C6A C9              10      RET
                                
       4C6B                     DSKFMT:
000C6B 4C6B AF               4      XOR A
000C6C 4C6C 37               4      SCF
       4C6D                     DSKSTP:
000C6D 4C6D C9              10      RET
                                
       4C6E                     BASENT:
000C6E 4C6E ED7B57F1        20      LD  SP,(BASSTK)
000C72 4C72 C3B043          10      JP  BASAUTO
                                
       4C75                     GETSLT:
000C75 4C75 3A22FB          13      LD  A,(DRVTBL+1)
000C78 4C78 C9              10      RET
                                
       4C79                     GET_DISK_BANK_FDRV:
000C79 4C79 3A4BF1          13      LD  A,(FDRV)
000C7C 4C7C D601             7      SUB 1
000C7E 4C7E 3003            12      JR  NC,GET_DISK_BANK
000C80 4C80 3A42F1          13      LD  A,(_DVSW)
       4C83                     GET_DISK_BANK:
000C83 4C83 B7               4      OR  A       ;A=DRIVE
000C84 4C84 3E01             7      LD  A,DISK_BANK
000C86 4C86 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
000C88 4C88 3A41F1          13      LD  A,(B_DRIVE)
                                #endif
       4C8B                     SET_DISK_BANK:
000C8B 4C8B 320068          13      LD  (BANK1_SEL),A
000C8E 4C8E F5              11      PUSH    AF
000C8F 4C8F E5              11      PUSH    HL
000C90 4C90 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
000C93 4C93 2222F1          16      LD  (SECSZ),HL
000C96 4C96 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000C99 4C99 CDA24C          17      CALL    MUL_AHL
000C9C 4C9C 2220F1          16      LD  (CLSZ),HL
000C9F 4C9F E1              10      POP HL
000CA0 4CA0 F1              10      POP AF
000CA1 4CA1 C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)
       4CA2                     MUL_AHL:
000CA2 4CA2 1F               4      RRA     ;->CF
000CA3 4CA3 D8              11      RET C
000CA4 4CA4 29              11      ADD HL,HL
000CA5 4CA5 18FB            12      JR  MUL_AHL
                                
       4CA7                     DPB2DD:
000CA7 4CA7 F9                      DB  0F9H    ;MEDIA
000CA8 4CA8 0002                    DW  00200H  ;SECSIZ
000CAA 4CAA 0F                      DB  00FH    ;DIRMSK
000CAB 4CAB 04                      DB  004H    ;DIRSHFT
000CAC 4CAC 01                      DB  001H    ;CLUSMSK
000CAD 4CAD 02                      DB  002H    ;CLUSSHFT
000CAE 4CAE 0100                    DW  00001H  ;FIRFAT
000CB0 4CB0 02                      DB  002H    ;FATCNT
000CB1 4CB1 70                      DB  070H    ;MAXENT
000CB2 4CB2 0E00                    DW  0000EH  ;FIRREC
000CB4 4CB4 CA02                    DW  002CAH  ;MAXCLUS
000CB6 4CB6 03                      DB  003H    ;FATSIZ
000CB7 4CB7 0700                    DW  0007H   ;FIRDIR
       4CB9                     DPB2DD_E:
                                
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       4CB9                     POP_HL_ERROR:
000CB9 4CB9 E1              10      POP     HL
       4CBA                     _ERROR:
000CBA 4CBA 0600             7      LD  B,0
000CBC 4CBC A7               4      AND A
000CBD 4CBD C9              10      RET
                                
       4CBE                     ROM_BDOS:
000CBE 4CBE E5              11      PUSH    HL
000CBF 4CBF 79               4      LD  A,C
000CC0 4CC0 87               4      ADD A,A
000CC1 4CC1 38F7            12      JR  C,_ERROR
000CC3 4CC3 6F               4      LD  L,A
000CC4 4CC4 265F             7      LD  H,high STABLE
000CC6 4CC6 7E               7      LD  A,(HL)
000CC7 4CC7 2C               4      INC L
000CC8 4CC8 66               7      LD  H,(HL)
000CC9 4CC9 6F               4      LD  L,A
000CCA 4CCA E3              19      EX  (SP),HL
000CCB 4CCB 79               4      LD  A,C
000CCC 4CCC C9              10      RET
                                
       4CCD                     _PRINT:
       4CCD                     PRINT:
000CCD 4CCD 7B               4      LD  A,E
000CCE 4CCE 1803            12      JR  MSG_A
                                
       4CD0                     _SYS01:     ;(BDOS)コンソール入力
000CD0 4CD0 CD474D          17      CALL    _SYS07
       4CD3                     MSG_A:
000CD3 4CD3 FE03             7      CP  3
000CD5 4CD5 2814            12      JR  Z,MSG_BR
       4CD7                     MSGA1:
000CD7 4CD7 F5              11      PUSH    AF
000CD8 4CD8 C5              11      PUSH    BC
000CD9 4CD9 D5              11      PUSH    DE
000CDA 4CDA E5              11      PUSH    HL
000CDB 4CDB DDE5            15      PUSH    IX
000CDD 4CDD DD21A200        14      LD  IX,CHPUT
000CE1 4CE1 CDE142          17      CALL    CALSLT_R
000CE4 4CE4 DDE1            14      POP IX
000CE6 4CE6 E1              10      POP HL
000CE7 4CE7 D1              10      POP DE
000CE8 4CE8 C1              10      POP BC
       4CE9                     MSGA2:
000CE9 4CE9 F1              10      POP AF
000CEA 4CEA C9              10      RET
       4CEB                     MSG_BR:
000CEB 4CEB F5              11      PUSH    AF
000CEC 4CEC 3ADDF3          13      LD  A,(CSRX)
000CEF 4CEF FE02             7      CP  2
000CF1 4CF1 38F6            12      JR  C,MSGA2
000CF3 4CF3 F1              10      POP AF
       4CF4                     MSG_CR:
000CF4 4CF4 F5              11      PUSH    AF
000CF5 4CF5 3E0D             7      LD  A,00DH
000CF7 4CF7 CDD74C          17      CALL    MSGA1
000CFA 4CFA 3E0A             7      LD  A,00AH
000CFC 4CFC CDD74C          17      CALL    MSGA1
000CFF 4CFF F1              10      POP AF
000D00 4D00 C9              10      RET
                                
       4D01                     _SYS02:     ;(BDOS)コンソール出力
000D01 4D01 CD1C4D          17      CALL    BREAK
000D04 4D04 1805            12      JR  PRINTX
                                
       4D06                     _SYS06:     ;(BDOS)コンソール直接入出力
000D06 4D06 7B               4      LD  A,E
000D07 4D07 3C               4      INC A
000D08 4D08 CA5B4D          10      JP  Z,_INKEY
       4D0B                     PRINTX:
000D0B 4D0B C3CD4C          10      JP  _PRINT
                                
       4D0E                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000D0E 4D0E CD474D          17      CALL    _SYS07
000D11 4D11 FE03             7      CP  3
000D13 4D13 CC1C4D          17      CALL    Z,_BREAK
000D16 4D16 FE13             7      CP  013H        ;CTRL+S
000D18 4D18 C0              11      RET NZ
       4D19                     PAUSE:
000D19 4D19 CD334D          17      CALL    KEYBC
                                
       4D1C                     _BREAK:
       4D1C                     BREAK:
000D1C 4D1C F5              11      PUSH    AF
000D1D 4D1D C5              11      PUSH    BC
000D1E 4D1E D5              11      PUSH    DE
000D1F 4D1F E5              11      PUSH    HL
000D20 4D20 DDE5            15      PUSH    IX
000D22 4D22 DD21B700        14      LD  IX,BREAKX
000D26 4D26 CDE142          17      CALL    CALSLT_R
000D29 4D29 DDE1            14      POP IX
000D2B 4D2B E1              10      POP HL
000D2C 4D2C D1              10      POP DE
000D2D 4D2D C1              10      POP BC
000D2E 4D2E DC1C4D          17      CALL    C,_BREAK
000D31 4D31 F1              10      POP AF
000D32 4D32 C9              10      RET
       4D33                     KEYBC:
000D33 4D33 F5              11      PUSH    AF
000D34 4D34 C5              11      PUSH    BC
000D35 4D35 D5              11      PUSH    DE
000D36 4D36 E5              11      PUSH    HL
000D37 4D37 DDE5            15      PUSH    IX
000D39 4D39 DD215601        14      LD  IX,KILBUF
000D3D 4D3D CDE142          17      CALL    CALSLT_R
000D40 4D40 DDE1            14      POP IX
000D42 4D42 E1              10      POP HL
000D43 4D43 D1              10      POP DE
000D44 4D44 C1              10      POP BC
000D45 4D45 F1              10      POP AF
000D46 4D46 C9              10      RET
                                
       4D47                     _SYS07:
       4D47                     FLGET:
000D47 4D47 C5              11      PUSH    BC
000D48 4D48 D5              11      PUSH    DE
000D49 4D49 E5              11      PUSH    HL
000D4A 4D4A DDE5            15      PUSH    IX
000D4C 4D4C DD219F00        14      LD  IX,CHGET
000D50 4D50 CDE142          17      CALL    CALSLT_R
000D53 4D53 DDE1            14      POP IX
000D55 4D55 E1              10      POP HL
000D56 4D56 D1              10      POP DE
000D57 4D57 C1              10      POP BC
000D58 4D58 FE03             7      CP  3
000D5A 4D5A C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       4D5B                     _INKEY:
       4D5B                     INKEY:
000D5B 4D5B CDF54D          17      CALL    CPM_CONST
000D5E 4D5E C8              11      RET Z
000D5F 4D5F 18E6            12      JR  FLGET
                                
       4D61                     _SYS0A:     ;(BDOS)文字列入力
000D61 4D61 C5              11      PUSH    BC
000D62 4D62 E5              11      PUSH    HL
000D63 4D63 D5              11      PUSH    DE
000D64 4D64 CD8D4D          17      CALL    GETL
000D67 4D67 111FF4          10      LD  DE,KBUF
000D6A 4D6A E1              10      POP HL
000D6B 4D6B E5              11      PUSH    HL
000D6C 4D6C 0E00             7      LD  C,0
000D6E 4D6E 3004            12      JR  NC,SAX0
000D70 4D70 23               6      INC HL
000D71 4D71 23               6      INC HL
000D72 4D72 1808            12      JR  SAX4
       4D74                     SAX0:
000D74 4D74 46               7      LD  B,(HL)
000D75 4D75 23               6      INC HL
       4D76                     SAX1:
000D76 4D76 23               6      INC HL
000D77 4D77 1A               7      LD  A,(DE)
000D78 4D78 13               6      INC DE
000D79 4D79 B7               4      OR  A
000D7A 4D7A 2004            12      JR  NZ,SAX2
       4D7C                     SAX4:
000D7C 4D7C 360D            10      LD  (HL),00DH
000D7E 4D7E 1804            12      JR  SAX3
       4D80                     SAX2:
000D80 4D80 77               7      LD  (HL),A
000D81 4D81 0C               4      INC C
000D82 4D82 10F2            13      DJNZ    SAX1
       4D84                     SAX3:
000D84 4D84 D1              10      POP DE
000D85 4D85 79               4      LD  A,C
000D86 4D86 13               6      INC DE
000D87 4D87 12               7      LD  (DE),A
000D88 4D88 1B               6      DEC DE
000D89 4D89 E1              10      POP HL
000D8A 4D8A C1              10      POP BC
000D8B 4D8B A7               4      AND A
000D8C 4D8C C9              10      RET
       4D8D                     GETL:
000D8D 4D8D DDE5            15      PUSH    IX
000D8F 4D8F FDE5            15      PUSH    IY
                                
000D91 4D91 2ADCF3          16      LD  HL,(CSRY)
000D94 4D94 22CAFB          16      LD  (FSTPOS),HL
       4D97                     GETL1:
000D97 4D97 CD0E4D          17      CALL    _SYS08
000D9A 4D9A FE09             7      CP  9
000D9C 4D9C 2008            12      JR  NZ,GETL1V
000D9E 4D9E 211FF4          10      LD  HL,KBUF
000DA1 4DA1 CD6243          17      CALL    MSX
000DA4 4DA4 18F1            12      JR  GETL1
       4DA6                     GETL1V:
000DA6 4DA6 5F               4      LD  E,A
000DA7 4DA7 FE08             7      CP  8
000DA9 4DA9 CC434E          17      CALL    Z,CTRL02
000DAC 4DAC FE20             7      CP  020H
000DAE 4DAE D46F4E          17      CALL    NC,INSERT
000DB1 4DB1 CDD74C          17      CALL    MSGA1
                                
000DB4 4DB4 7B               4      LD  A,E
000DB5 4DB5 FE0D             7      CP  00DH
000DB7 4DB7 20DE            12      JR  NZ,GETL1
                                
000DB9 4DB9 111FF4          10      LD  DE,KBUF
000DBC 4DBC 3AB0F3          13      LD  A,(LINLEN)
000DBF 4DBF 47               4      LD  B,A
000DC0 4DC0 CD1F50          17      CALL    ZERO_MEMORY_DE
                                
000DC3 4DC3 2ACAFB          16      LD  HL,(FSTPOS)
000DC6 4DC6 3ADCF3          13      LD  A,(CSRY)
000DC9 4DC9 6F               4      LD  L,A
000DCA 4DCA E5              11      PUSH    HL
000DCB 4DCB CDA04E          17      CALL    LOC0
000DCE 4DCE 4D               4      LD  C,L
000DCF 4DCF 44               4      LD  B,H
000DD0 4DD0 E1              10      POP HL
000DD1 4DD1 3AB0F3          13      LD  A,(LINLEN)
000DD4 4DD4 94               4      SUB H
000DD5 4DD5 3D               4      DEC A
000DD6 4DD6 5F               4      LD  E,A
000DD7 4DD7 211FF4          10      LD  HL,KBUF
       4DDA                     GETL2:
000DDA 4DDA CD334E          17      CALL    _SCRN
000DDD 4DDD 03               6      INC BC
000DDE 4DDE 77               7      LD  (HL),A
000DDF 4DDF 23               6      INC HL
000DE0 4DE0 1D               4      DEC E
000DE1 4DE1 20F7            12      JR  NZ,GETL2
000DE3 4DE3 CDF44C          17      CALL    MSG_CR
                                
000DE6 4DE6 FDE1            14      POP IY
000DE8 4DE8 DDE1            14      POP IX
       4DEA                     GETL3:
000DEA 4DEA 2B               6      DEC HL
000DEB 4DEB 7E               7      LD  A,(HL)
000DEC 4DEC FE21             7      CP  021H
000DEE 4DEE D0              11      RET NC
000DEF 4DEF 3600            10      LD  (HL),0
000DF1 4DF1 15               4      DEC D
000DF2 4DF2 20F6            12      JR  NZ,GETL3
000DF4 4DF4 C9              10      RET
                                
       4DF5                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       4DF5                     CONSTX:
       4DF5                     CPM_CONST:
000DF5 4DF5 C5              11      PUSH    BC
000DF6 4DF6 D5              11      PUSH    DE
000DF7 4DF7 E5              11      PUSH    HL
000DF8 4DF8 DDE5            15      PUSH    IX
000DFA 4DFA DD219C00        14      LD  IX,CHSNS
000DFE 4DFE CDE142          17      CALL    CALSLT_R
000E01 4E01 DDE1            14      POP IX
000E03 4E03 E1              10      POP HL
000E04 4E04 D1              10      POP DE
000E05 4E05 C1              10      POP BC
000E06 4E06 C9              10      RET
                                
       4E07                     _SYS2A:     ;(BDOS)日付の獲得
000E07 4E07 AF               4      XOR A
000E08 4E08 57               4      LD  D,A
000E09 4E09 5F               4      LD  E,A
000E0A 4E0A 67               4      LD  H,A
000E0B 4E0B 6F               4      LD  L,A
000E0C 4E0C C9              10      RET
                                
       4E0D                     _SYS2C:     ;(BDOS)時刻の獲得
000E0D 4E0D AF               4      XOR A
000E0E 4E0E 57               4      LD  D,A
000E0F 4E0F 5F               4      LD  E,A
000E10 4E10 67               4      LD  H,A
000E11 4E11 6F               4      LD  L,A
000E12 4E12 C9              10      RET
                                
       4E13                     POS:
000E13 4E13 F5              11      PUSH    AF
000E14 4E14 2ADCF3          16      LD  HL,(CSRY)
000E17 4E17 7D               4      LD  A,L
000E18 4E18 6C               4      LD  L,H
000E19 4E19 67               4      LD  H,A
000E1A 4E1A 2C               4      INC L
000E1B 4E1B 24               4      INC H
000E1C 4E1C F1              10      POP AF
000E1D 4E1D C9              10      RET
                                
       4E1E                     LOC:
000E1E 4E1E F5              11      PUSH    AF
000E1F 4E1F E5              11      PUSH    HL
000E20 4E20 7D               4      LD  A,L
000E21 4E21 6C               4      LD  L,H
000E22 4E22 67               4      LD  H,A
000E23 4E23 2D               4      DEC L
000E24 4E24 25               4      DEC H
000E25 4E25 DDE5            15      PUSH    IX
000E27 4E27 DD21C600        14      LD  IX,POSIT
000E2B 4E2B CDE142          17      CALL    CALSLT_R
000E2E 4E2E DDE1            14      POP IX
000E30 4E30 E1              10      POP HL
000E31 4E31 F1              10      POP AF
000E32 4E32 C9              10      RET
                                
       4E33                     _SCRN:
       4E33                     SCRN:
000E33 4E33 E5              11      PUSH    HL
000E34 4E34 DDE5            15      PUSH    IX
                                
000E36 4E36 69               4      LD  L,C
000E37 4E37 60               4      LD  H,B
000E38 4E38 DD214A00        14      LD  IX,RDVRM
000E3C 4E3C CDE142          17      CALL    CALSLT_R
                                
000E3F 4E3F DDE1            14      POP IX
000E41 4E41 E1              10      POP HL
000E42 4E42 C9              10      RET
                                
       4E43                     CTRL02:
000E43 4E43 F5              11      PUSH    AF
000E44 4E44 D5              11      PUSH    DE
000E45 4E45 2ADCF3          16      LD  HL,(CSRY)
000E48 4E48 3AB0F3          13      LD  A,(LINLEN)
000E4B 4E4B 4F               4      LD  C,A
000E4C 4E4C 94               4      SUB H   ;CSRX
000E4D 4E4D C602             7      ADD A,2
000E4F 4E4F 47               4      LD  B,A ;カーソルより右の文字数
000E50 4E50 61               4      LD  H,C ;LINLEN
000E51 4E51 C5              11      PUSH    BC
000E52 4E52 CDA04E          17      CALL    LOC0
000E55 4E55 C1              10      POP BC
                                
000E56 4E56 1620             7      LD  D,020H
       4E58                     C8X1:
000E58 4E58 DD214A00        14      LD  IX,RDVRM
000E5C 4E5C CDE142          17      CALL    CALSLT_R
000E5F 4E5F 4F               4      LD  C,A
000E60 4E60 7A               4      LD  A,D
000E61 4E61 DD214D00        14      LD  IX,WRTVRM
000E65 4E65 CDE142          17      CALL    CALSLT_R
000E68 4E68 2B               6      DEC HL
000E69 4E69 51               4      LD  D,C
000E6A 4E6A 10EC            13      DJNZ    C8X1
000E6C 4E6C D1              10      POP DE
000E6D 4E6D F1              10      POP AF
000E6E 4E6E C9              10      RET
                                
       4E6F                     INSERT:
000E6F 4E6F F5              11      PUSH    AF
000E70 4E70 D5              11      PUSH    DE
000E71 4E71 2ADCF3          16      LD  HL,(CSRY)
000E74 4E74 3AB0F3          13      LD  A,(LINLEN)
000E77 4E77 4F               4      LD  C,A
000E78 4E78 94               4      SUB H   ;CSRX
000E79 4E79 3C               4      INC A
000E7A 4E7A 47               4      LD  B,A ;カーソルより右の文字数
000E7B 4E7B C5              11      PUSH    BC
000E7C 4E7C CDA04E          17      CALL    LOC0
000E7F 4E7F C1              10      POP BC
                                
000E80 4E80 1620             7      LD  D,020H
       4E82                     INS1:
000E82 4E82 DD214A00        14      LD  IX,RDVRM
000E86 4E86 CDE142          17      CALL    CALSLT_R
000E89 4E89 4F               4      LD  C,A
000E8A 4E8A 7A               4      LD  A,D
000E8B 4E8B DD214D00        14      LD  IX,WRTVRM
000E8F 4E8F CDE142          17      CALL    CALSLT_R
000E92 4E92 23               6      INC HL
000E93 4E93 51               4      LD  D,C
000E94 4E94 10EC            13      DJNZ    INS1
000E96 4E96 D1              10      POP DE
000E97 4E97 F1              10      POP AF
000E98 4E98 C9              10      RET
                                
       4E99                     CONOUT1:
000E99 4E99 59               4      LD  E,C
000E9A 4E9A C3CD4C          10      JP  _PRINT
                                
       4E9D                     GETVRAM:
000E9D 4E9D 2ADCF3          16      LD  HL,(CSRY)
       4EA0                     LOC0:
000EA0 4EA0 2D               4      DEC L
000EA1 4EA1 25               4      DEC H
000EA2 4EA2 4C               4      LD  C,H ;CSRX-1
000EA3 4EA3 5D               4      LD  E,L ;CSRY-1
       4EA4                     LOC1:
000EA4 4EA4 3AB0F3          13      LD  A,(LINLEN)
000EA7 4EA7 67               4      LD  H,A
000EA8 4EA8 1600             7      LD  D,0
000EAA 4EAA 6A               4      LD  L,D ;0
000EAB 4EAB 0608             7      LD  B,8
       4EAD                     LOC2:
000EAD 4EAD 29              11      ADD HL,HL
000EAE 4EAE 3001            12      JR  NC,LOC3
000EB0 4EB0 19              11      ADD HL,DE
       4EB1                     LOC3:
000EB1 4EB1 10FA            13      DJNZ    LOC2
000EB3 4EB3 09              11      ADD HL,BC
000EB4 4EB4 C9              10      RET
                                
       4EB5                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000EB5 4EB5 212200          10      LD  HL,00022H
000EB8 4EB8 AF               4      XOR A
000EB9 4EB9 7D               4      LD  A,L
000EBA 4EBA C9              10      RET
                                
       4EBB                     _SYS0D:     ;(BDOS)ディスク・リセット
000EBB 4EBB 218000          10      LD  HL,00080H
000EBE 4EBE 222EF1          16      LD  (_DTA),HL
000EC1 4EC1 C9              10      RET
                                
       4EC2                     _SYS0E:     ;(BDOS)カレントドライブの設定
000EC2 4EC2 3242F1          13      LD  (_DVSW),A
000EC5 4EC5 C9              10      RET
                                
       4EC6                     _SYS0F:     ;(BDOS)ファイルのオープン
000EC6 4EC6 D5              11      PUSH    DE
000EC7 4EC7 FDE1            14      POP IY
000EC9 4EC9 CD0F50          17      CALL    INIT_FILE
000ECC 4ECC CD9448          17      CALL    ROM_OPEN
000ECF 4ECF 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
000ED1 4ED1 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
000ED5 4ED5 FDE5            15      PUSH    IY
000ED7 4ED7 D1              10      POP DE
000ED8 4ED8 13               6      INC DE
000ED9 4ED9 010B00          10      LD  BC,11
000EDC 4EDC EDB0                    LDIR
                                ;               Attribute
000EDE 4EDE 7E               7      LD  A,(HL)
000EDF 4EDF FD770D          19      LD  (IY+13),A
                                ;               TIME
000EE2 4EE2 110B00          10      LD  DE,11
000EE5 4EE5 19              11      ADD HL,DE
000EE6 4EE6 7E               7      LD  A,(HL)
000EE7 4EE7 23               6      INC HL
000EE8 4EE8 FD7716          19      LD  (IY+22),A
000EEB 4EEB 7E               7      LD  A,(HL)
000EEC 4EEC 23               6      INC HL
000EED 4EED FD7717          19      LD  (IY+23),A
                                ;               DATE
000EF0 4EF0 7E               7      LD  A,(HL)
000EF1 4EF1 23               6      INC HL
000EF2 4EF2 FD7714          19      LD  (IY+20),A
000EF5 4EF5 7E               7      LD  A,(HL)
000EF6 4EF6 23               6      INC HL
000EF7 4EF7 FD7715          19      LD  (IY+21),A
                                ;               First cluster
000EFA 4EFA 7E               7      LD  A,(HL)
000EFB 4EFB 23               6      INC HL
000EFC 4EFC FD771A          19      LD  (IY+26),A
000EFF 4EFF 7E               7      LD  A,(HL)
000F00 4F00 23               6      INC HL
000F01 4F01 FD771B          19      LD  (IY+27),A
                                ;               SIZE
000F04 4F04 7E               7      LD  A,(HL)
000F05 4F05 23               6      INC HL
000F06 4F06 FD7710          19      LD  (IY+16),A
000F09 4F09 7E               7      LD  A,(HL)
000F0A 4F0A 23               6      INC HL
000F0B 4F0B FD7711          19      LD  (IY+17),A
000F0E 4F0E 7E               7      LD  A,(HL)
000F0F 4F0F 23               6      INC HL
000F10 4F10 FD7712          19      LD  (IY+18),A
000F13 4F13 7E               7      LD  A,(HL)
000F14 4F14 FD7713          19      LD  (IY+19),A
000F17 4F17 AF               4      XOR A
000F18 4F18 FD770C          19      LD  (IY+12),A
000F1B 4F1B C9              10      RET
                                
       4F1C                     _SYS10:     ;(BDOS)ファイルのクローズ
000F1C 4F1C AF               4      XOR A
000F1D 4F1D C9              10      RET
                                
       4F1E                     S11X1:
000F1E 4F1E FD7119          19      LD  (IY+25),C       ;RootEntCnt
000F21 4F21 FD750E          19      LD  (IY+14),L
000F24 4F24 FD740F          19      LD  (IY+15),H
       4F27                     SCF_FF_RET:
000F27 4F27 37               4      SCF
000F28 4F28 9F               4      SBC A,A
000F29 4F29 C9              10      RET
                                
       4F2A                     _SYS11:     ;(BDOS)最初のファイルの検索
000F2A 4F2A ED5336F1        20      LD  (_FCB),DE
000F2E 4F2E D5              11      PUSH    DE
000F2F 4F2F FDE1            14      POP IY
000F31 4F31 CD0F50          17      CALL    INIT_FILE
000F34 4F34 CDBC4A          17      CALL    GET_DIR_DAT
       4F37                     S12X1:
000F37 4F37 CDB048          17      CALL    FILESE
000F3A 4F3A 30E2            12      JR  NC,S11X1
000F3C 4F3C 0D               4      DEC C
000F3D 4F3D FD7119          19      LD  (IY+25),C       ;RootEntCnt
000F40 4F40 012000          10      LD  BC,32
000F43 4F43 ED5B2EF1        20      LD  DE,(_DTA)
000F47 4F47 AF               4      XOR A
000F48 4F48 12               7      LD  (DE),A      ;ドライブ番号
000F49 4F49 13               6      INC DE
000F4A 4F4A EDB0                    LDIR            ;ディレクトリエントリ
000F4C 4F4C FD750E          19      LD  (IY+14),L
000F4F 4F4F FD740F          19      LD  (IY+15),H
000F52 4F52 C9              10      RET
                                
       4F53                     _SYS12:
000F53 4F53 FD2A36F1        20      LD  IY,(_FCB)
000F57 4F57 FDE5            15      PUSH    IY
000F59 4F59 D1              10      POP DE
000F5A 4F5A CD0F50          17      CALL    INIT_FILE
                                
000F5D 4F5D FD6E0E          19      LD  L,(IY+14)
000F60 4F60 FD660F          19      LD  H,(IY+15)
000F63 4F63 FD4E19          19      LD  C,(IY+25)
000F66 4F66 18CF            12      JR  S12X1
                                
       4F68                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000F68 4F68 CDA24A          17      CALL    SET_FCB
000F6B 4F6B CD704A          17      CALL    GETSEQ
000F6E 4F6E CD5D4A          17      CALL    RB_READ
000F71 4F71 E5              11      PUSH    HL
000F72 4F72 CD7D4A          17      CALL    SETSEQ
000F75 4F75 E1              10      POP HL
       4F76                     SREAD:
000F76 4F76 C601             7      ADD A,001H
000F78 4F78 D8              11      RET C
                                
000F79 4F79 7D               4      LD  A,L
000F7A 4F7A D601             7      SUB 001H
000F7C 4F7C 9F               4      SBC A,A
000F7D 4F7D E603             7      AND 3
000F7F 4F7F 1F               4      RRA
000F80 4F80 C9              10      RET
                                
       4F81                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000F81 4F81 210100          10      LD  HL,00001H
000F84 4F84 AF               4      XOR A
000F85 4F85 C9              10      RET
                                
       4F86                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000F86 4F86 3A42F1          13      LD  A,(_DVSW)
000F89 4F89 C9              10      RET
                                
       4F8A                     _SYS1A:     ;(BDOS)DTAの設定
000F8A 4F8A ED532EF1        20      LD  (_DTA),DE
000F8E 4F8E AF               4      XOR A
000F8F 4F8F C9              10      RET
                                
       4F90                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000F90 4F90 010002          10      LD  BC,512
000F93 4F93 11C302          10      LD  DE,707
000F96 4F96 210000          10      LD  HL,0
000F99 4F99 DD2138F1        14      LD  IX,_BUF
000F9D 4F9D FD2138F1        14      LD  IY,_BUF
000FA1 4FA1 FD3600F9        19      LD  (IY+0),0F9H
000FA5 4FA5 3E02             7      LD  A,2
000FA7 4FA7 C9              10      RET
                                
       4FA8                     _SYS21:     ;(BDOS)ランダムな読み出し
000FA8 4FA8 CDA24A          17      CALL    SET_FCB
                                
000FAB 4FAB FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
000FAE 4FAE FD6622          19      LD  H,(IY+34)
                                
000FB1 4FB1 CD5D4A          17      CALL    RB_READ
000FB4 4FB4 18C0            12      JR  SREAD
                                
       4FB6                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
000FB6 4FB6 CDC64E          17      CALL    _SYS0F
000FB9 4FB9 D8              11      RET C
                                
000FBA 4FBA D5              11      PUSH    DE      ;EX DE,IY
000FBB 4FBB FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000FBD 4FBD CD924A          17      CALL    GETSIZE
       4FC0                     _S24X1:
000FC0 4FC0 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
000FC3 4FC3 FD7422          19      LD  (IY+34),H
000FC6 4FC6 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000FCA 4FCA FDE3            23      EX  (SP),IY     ;
000FCC 4FCC D1              10      POP DE      ;
                                
000FCD 4FCD AF               4      XOR A
000FCE 4FCE C9              10      RET
                                
       4FCF                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
000FCF 4FCF E5              11      PUSH    HL
000FD0 4FD0 D5              11      PUSH    DE      ;EX DE,IY
000FD1 4FD1 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000FD3 4FD3 CD704A          17      CALL    GETSEQ
000FD6 4FD6 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       4FD8                     _SYS27:     ;(BDOS)ランダムブロック読み込み
000FD8 4FD8 CDA24A          17      CALL    SET_FCB
000FDB 4FDB E5              11      PUSH    HL
000FDC 4FDC FD6E21          19      LD  L,(IY+33)
000FDF 4FDF FD6622          19      LD  H,(IY+34)
000FE2 4FE2 2224F1          16      LD  (RR_LOW),HL
000FE5 4FE5 FD6E23          19      LD  L,(IY+35)
000FE8 4FE8 FD6624          19      LD  H,(IY+36)
000FEB 4FEB 2226F1          16      LD  (RR_HIGH),HL
000FEE 4FEE E1              10      POP HL
000FEF 4FEF CDB446          17      CALL    ROM_READ
000FF2 4FF2 ED5B24F1        20      LD  DE,(RR_LOW)
000FF6 4FF6 FD7321          19      LD  (IY+33),E
000FF9 4FF9 FD7222          19      LD  (IY+34),D
000FFC 4FFC ED5B26F1        20      LD  DE,(RR_HIGH)
001000 5000 FD7323          19      LD  (IY+35),E
001003 5003 FD7224          19      LD  (IY+36),D
001006 5006 9F               4      SBC A,A
001007 5007 C9              10      RET
                                
       5008                     _SYS2F:
001008 5008 44               4      LD  B,H
001009 5009 2A2EF1          16      LD  HL,(_DTA)
00100C 500C C3F54A          10      JP  DISKIO
                                
       500F                     INIT_FILE:
00100F 500F EB               4      EX  DE,HL
001010 5010 114BF1          10      LD  DE,FDRV
001013 5013 010C00          10      LD  BC,1+8+3
001016 5016 EDB0                    LDIR
001018 5018 CD794C          17      CALL    GET_DISK_BANK_FDRV
00101B 501B 320068          13      LD  (BANK1_SEL),A
00101E 501E C9              10      RET
                                
       501F                     ZERO_MEMORY_DE:
00101F 501F AF               4      XOR A
       5020                     FILL_MEMORY_DE:
001020 5020 12               7      LD  (DE),A
001021 5021 13               6      INC DE
001022 5022 10FC            13      DJNZ    FILL_MEMORY_DE
001024 5024 C9              10      RET
                                
001025 5025                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 BA4CD04C014DBA4C        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 BA4CBA4C064D474D        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 0E4DBA4C614DF54D        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 B54EBB4EC24EC64E        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 1C4F2A4F534FBA4C        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 684FBA4CBA4CBA4C        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 814F864F8A4F904F        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 BA4CBA4CBA4CB64F        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 CF4FBA4CBA4CD84F        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 BA4CBA4C074EBA4C        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 0D4EBA4CBA4C0850        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB8 5FB8 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 BA4CBA4CBA4CBA4C        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
