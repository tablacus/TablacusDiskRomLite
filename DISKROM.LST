                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       42B2                     CRUNCH  EQU 042B2H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
                                ;PTRFIL EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
                                ;FILNAM EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
                                ;RSTMP  EQU 0FB03H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FEDA                     H_STKE  EQU 0FEDAH
                                
       FF43                     H_GONE  EQU 0FF43H
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;KONAMI-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                
       F0E9                     ISC EQU 0F0E9H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
[EOF:DEF.ASM:UTF_8]
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C3864D          10      JP  DISKIO
000013 4013 C3C04D          10      JP  DSKCHG
000016 4016 C3164E          10      JP  GETDPB
000019 4019 C3094F          10      JP  CHOICE
00001C 401C C30D4F          10      JP  DSKFMT
00001F 401F C30F4F          10      JP  DSKSTP
000022 4022 C3104F          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C30D4F          10      JP  DSKFMT
000029 4029 C30F4F          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3174F          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.1.5.3",0
            204449534B20524F    
            4D204C6974652076    
            302E312E352E3300    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 0180FF          10      LD  BC,-00080H
000109 4109 2A72F6          16      LD  HL,(MEMSIZ)
00010C 410C 09              11      ADD HL,BC
00010D 410D 2272F6          16      LD  (MEMSIZ),HL
000110 4110 2A74F6          16      LD  HL,(STKTOP)
000113 4113 09              11      ADD HL,BC
000114 4114 2274F6          16      LD  (STKTOP),HL
000117 4117 2180F0          10      LD  HL,0F080H
00011A 411A 1100F0          10      LD  DE,0F000H
00011D 411D 012000          10      LD  BC,00020H
000120 4120 EDB0                    LDIR
000122 4122 2180FF          10      LD  HL,-00080H
000125 4125 39              11      ADD HL,SP
000126 4126 225FF1          16      LD  (BASSTK),HL
000129 4129 ED7B5FF1        20      LD  SP,(BASSTK)
                                
00012D 412D 3EFF             7      LD  A,0FFH
00012F 412F 3299FD          13      LD  (DEVICE),A
                                
000132 4132 3E01             7      LD  A,1
000134 4134 3221FB          13      LD  (DRVTBL),A
                                
000137 4137 AF               4      XOR A
000138 4138 324AF1          13      LD  (_DVSW),A
                                
00013B 413B 210943          10      LD  HL,AT_ISC
00013E 413E 11E9F0          10      LD  DE,ISC
000141 4141 017C00          10      LD  BC,ISC_E-ISC
000144 4144 EDB0                    LDIR
                                    
000146 4146 3EC3             7      LD  A,0C3H      ;JP
000148 4148 3243FF          13      LD  (H_GONE),A
00014B 414B 327DF3          13      LD  (BDOS),A
00014E 414E 326BF3          13      LD  (RAMUSE),A
000151 4151 3268F3          13      LD  (ROMUSE),A
000154 4154 21E9F0          10      LD  HL,REPLACE_COMMAND
000157 4157 2244FF          16      LD  (H_GONE+1),HL
00015A 415A 2131F3          10      LD  HL,H_BDOS
00015D 415D 227EF3          16      LD  (BDOS+1),HL
000160 4160 2119F1          10      LD  HL,RAMUSE1
000163 4163 226CF3          16      LD  (RAMUSE+1),HL
000166 4166 2114F1          10      LD  HL,ROMUSE1
000169 4169 2269F3          16      LD  (ROMUSE+1),HL
                                
00016C 416C 3E                      DB  03EH
00016D 416D F7              12      RST 30H
00016E 416E 3271FE          13      LD  (H_BINS),A
000171 4171 3276FE          13      LD  (H_BINL),A
000174 4174 327BFE          13      LD  (H_FILE),A
000177 4177 3231F3          13      LD  (H_BDOS),A
00017A 417A 32DAFE          13      LD  (H_STKE),A
00017D 417D 32A7FF          13      LD  (H_PHYD),A
                                
000180 4180 CD4942          17      CALL    GTSL1_
000183 4183 3200F1          13      LD  (ROM_SLT),A
000186 4186 3210F1          13      LD  (ROM_SLT_COPY),A
000189 4189 3272FE          13      LD  (H_BINS+1),A
00018C 418C 3277FE          13      LD  (H_BINL+1),A
00018F 418F 327CFE          13      LD  (H_FILE+1),A
000192 4192 3232F3          13      LD  (H_BDOS+1),A
000195 4195 32DBFE          13      LD  (H_STKE+1),A
000198 4198 32A8FF          13      LD  (H_PHYD+1),A
00019B 419B 3222FB          13      LD  (DRVTBL+1),A
00019E 419E 3248F3          13      LD  (MASTERS),A
                                
0001A1 41A1 214045          10      LD  HL,ROM_LOAD
0001A4 41A4 2273FE          16      LD  (H_BINS+2),HL
0001A7 41A7 216F46          10      LD  HL,ROM_RUN
0001AA 41AA 2278FE          16      LD  (H_BINL+2),HL
0001AD 41AD 217C46          10      LD  HL,ROM_FILES
0001B0 41B0 227DFE          16      LD  (H_FILE+2),HL
0001B3 41B3 21634F          10      LD  HL,ROM_BDOS
0001B6 41B6 2233F3          16      LD  (H_BDOS+2),HL
0001B9 41B9 21AF43          10      LD  HL,ROM_STKE
0001BC 41BC 22DCFE          16      LD  (H_STKE+2),HL
0001BF 41BF 21864D          10      LD  HL,DISKIO
0001C2 41C2 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001C5 41C5 3E                      DB  03EH
0001C6 41C6 C9              10      RET
0001C7 41C7 327FFE          13      LD  (H_FILE+4),A
0001CA 41CA 3275FE          13      LD  (H_BINS+4),A
0001CD 41CD 327AFE          13      LD  (H_BINL+4),A
0001D0 41D0 3235F3          13      LD  (H_BDOS+4),A
0001D3 41D3 32DEFE          13      LD  (H_STKE+4),A
0001D6 41D6 32ABFF          13      LD  (H_PHYD+4),A
                                
                                #if exists USE_NORMAL_32K_ROM
                                #else
0001D9 41D9 AF               4      XOR A
0001DA 41DA 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001DD 41DD 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0001E0 41E0 3A0060          13      LD  A,(BANK1_ADR)
0001E3 41E3 FE41             7      CP  'A'
0001E5 41E5 2051            12      JR  NZ,NOT_8K_BANK
0001E7 41E7 3E01             7      LD  A,DISK_BANK
0001E9 41E9 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001EC 41EC 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001EF 41EF CD3801          17      CALL    RSLREG      ;read primary slot #
0001F2 41F2 07               4      RLCA
0001F3 41F3 07               4      RLCA
0001F4 41F4 F5              11      PUSH    AF
0001F5 41F5 1605             7      LD  D,4+1
0001F7 41F7 CD5042          17      CALL    GTSL2_
0001FA 41FA 3244F3          13      LD  (RAMAD3),A
0001FD 41FD F1              10      POP AF
0001FE 41FE 07               4      RLCA
0001FF 41FF 07               4      RLCA
000200 4200 1603             7      LD  D,2+1
000202 4202 CD5042          17      CALL    GTSL2_
000205 4205 2680             7      LD  H,080H
000207 4207 CD6D42          17      CALL    CHK_RAM
00020A 420A 3243F3          13      LD  (RAMAD2),A
       420D                     RAMCHK2:
00020D 420D 3A44F3          13      LD  A,(RAMAD3)
000210 4210 2640             7      LD  H,040H
000212 4212 CD6D42          17      CALL    CHK_RAM
000215 4215 3242F3          13      LD  (RAMAD1),A
       4218                     RAMCHK1:
000218 4218 3A44F3          13      LD  A,(RAMAD3)
00021B 421B 2600             7      LD  H,00H
00021D 421D CD6D42          17      CALL    CHK_RAM
000220 4220 3241F3          13      LD  (RAMAD0),A
       4223                     RAMCHK0:
000223 4223 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
000226 4226 010F00          10      LD  BC,0000FH       ;切り上げ
000229 4229 09              11      ADD HL,BC
00022A 422A 7D               4      LD  A,L
                                
00022B 422B 0604             7      LD  B,4
       422D                     B_DRIVE1:
00022D 422D CB3C             8      SRL H
00022F 422F 1F               4      RRA
000230 4230 10FB            13      DJNZ    B_DRIVE1
                                
000232 4232 C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000234 4234 3249F1          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
000237 4237 C9              10      RET
                                
       4238                     NOT_8K_BANK:
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K等)
000238 4238 21FD43          10      LD  HL,MSG_ERROR_ROM_MODE
00023B 423B CD8843          17      CALL    MSX
00023E 423E FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000242 4242 DD219F00        14      LD  IX,CHGET
000246 4246 C31C00          10      JP  _CALSLT
                                
       4249                     GTSL1_:             ;自分のいるスロットを知る
000249 4249 CD3801          17      CALL    RSLREG      ;read primary slot #
00024C 424C 0F               4      RRCA
00024D 424D 0F               4      RRCA
00024E 424E 1601             7      LD  D,1
       4250                     GTSL2_:
000250 4250 E603             7      AND 3       ;[A]=000000PP
000252 4252 5F               4      LD  E,A     ;[E]=000000PP
000253 4253 21C1FC          10      LD  HL,EXPTBL
000256 4256 85               4      ADD A,L     ;桁上りは無い
000257 4257 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000258 4258 7B               4      LD  A,E     ;[A]=000000PP
000259 4259 CB7E            13      BIT 7,(HL)
00025B 425B C8              11      RET Z
00025C 425C 7D               4      LD  A,L     ;point to SLTTBL entry
00025D 425D C604             7      ADD A,4     ;桁上りは無い
00025F 425F 6F               4      LD  L,A
000260 4260 7E               7      LD  A,(HL)      ;get currently expansion slot register
       4261                     GTSL3_:
000261 4261 15               4      DEC D
000262 4262 2803            12      JR  Z,GTSL4_:
000264 4264 0F               4      RRCA
000265 4265 18FA            12      JR  GTSL3_:
       4267                     GTSL4_:
000267 4267 E60C             7      AND 00CH        ;[A] = 0000SS00
000269 4269 B3               4      OR  E       ;[A] = 0000SSPP
00026A 426A F680             7      OR  080H        ;[A] = 1000SSPP
00026C 426C C9              10      RET
                                
       426D                     CHK_RAM:
00026D 426D E5              11      PUSH    HL
00026E 426E CDC242          17      CALL    CHK_RAM0
000271 4271 E1              10      POP HL
000272 4272 C8              11      RET Z
000273 4273 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000276 4276 E680             7      AND 080H
000278 4278 CD9942          17      CALL    CHK_RAM_SLT
00027B 427B C8              11      RET Z
00027C 427C 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
00027F 427F E680             7      AND 080H
000281 4281 C601             7      ADD A,1
000283 4283 CD9942          17      CALL    CHK_RAM_SLT
000286 4286 C8              11      RET Z
000287 4287 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00028A 428A E680             7      AND 080H
00028C 428C C602             7      ADD A,2
00028E 428E CD9942          17      CALL    CHK_RAM_SLT
000291 4291 C8              11      RET Z
000292 4292 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000295 4295 E680             7      AND 080H
000297 4297 C603             7      ADD A,3
       4299                     CHK_RAM_SLT:
000299 4299 E5              11      PUSH    HL
00029A 429A CDC242          17      CALL    CHK_RAM0        ;スロット#X or X-0
00029D 429D E1              10      POP HL
00029E 429E C8              11      RET Z
00029F 429F CB79             8      BIT 7,C
0002A1 42A1 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
0002A3 42A3 79               4      LD  A,C
0002A4 42A4 C604             7      ADD A,4*1           ;スロット#X-1
0002A6 42A6 E5              11      PUSH    HL
0002A7 42A7 CDC242          17      CALL    CHK_RAM0
0002AA 42AA E1              10      POP HL
0002AB 42AB C8              11      RET Z
0002AC 42AC 79               4      LD  A,C
0002AD 42AD C608             7      ADD A,4*2           ;スロット#X-2
0002AF 42AF E5              11      PUSH    HL
0002B0 42B0 CDC242          17      CALL    CHK_RAM0
0002B3 42B3 E1              10      POP HL
0002B4 42B4 C8              11      RET Z
0002B5 42B5 79               4      LD  A,C
0002B6 42B6 C60C             7      ADD A,4*3           ;スロット#X-3
0002B8 42B8 E5              11      PUSH    HL
0002B9 42B9 CDC242          17      CALL    CHK_RAM0
0002BC 42BC E1              10      POP HL
       42BD                     CHK_RAM_E:
0002BD 42BD AF               4      XOR A
0002BE 42BE 3C               4      INC A           ;ZF=0にする
0002BF 42BF 3E00             7      LD  A,0
0002C1 42C1 C9              10      RET
                                
       42C2                     CHK_RAM0:
0002C2 42C2 4F               4      LD  C,A
0002C3 42C3 3A00F1          13      LD  A,(ROM_SLT)
0002C6 42C6 B9               4      CP  C
0002C7 42C7 28F4            12      JR  Z,CHK_RAM_E
0002C9 42C9 2E00             7      LD  L,0
       42CB                     CHK_RAM1:
0002CB 42CB 79               4      LD  A,C
0002CC 42CC DD210C00        14      LD  IX,_RDSLT
0002D0 42D0 CDFD42          17      CALL    CALSLT_R
0002D3 42D3 C6E5             7      ADD A,0E5H
0002D5 42D5 47               4      LD  B,A
0002D6 42D6 5F               4      LD  E,A
0002D7 42D7 79               4      LD  A,C
0002D8 42D8 DD211400        14      LD  IX,_WRSLT
0002DC 42DC CDFD42          17      CALL    CALSLT_R
0002DF 42DF 79               4      LD  A,C
0002E0 42E0 DD210C00        14      LD  IX,_RDSLT
0002E4 42E4 CDFD42          17      CALL    CALSLT_R
0002E7 42E7 B8               4      CP  B
0002E8 42E8 C0              11      RET NZ
0002E9 42E9 D6E5             7      SUB 0E5H
0002EB 42EB 79               4      LD  A,C
0002EC 42EC 5F               4      LD  E,A
0002ED 42ED DD211400        14      LD  IX,_WRSLT
0002F1 42F1 CDFD42          17      CALL    CALSLT_R
0002F4 42F4 24               4      INC H
0002F5 42F5 7D               4      LD  A,L
0002F6 42F6 C604             7      ADD A,4
0002F8 42F8 6F               4      LD  L,A
0002F9 42F9 20D0            12      JR  NZ,CHK_RAM1
0002FB 42FB 79               4      LD  A,C     ;ZF=1のハズ
0002FC 42FC C9              10      RET
                                
       42FD                     CALSLT_R:
0002FD 42FD C5              11      PUSH    BC
0002FE 42FE E5              11      PUSH    HL
0002FF 42FF FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000303 4303 CD1C00          17      CALL    _CALSLT
000306 4306 E1              10      POP HL
000307 4307 C1              10      POP BC
000308 4308 C9              10      RET
                                
       4309                     AT_ISC:
000309 F0E9                         ORG ISC,AT_ISC-RUN
       F0E9                     REPLACE_COMMAND:
000309 F0E9 FEB7             7      CP  0B7H            ;FILES
00030B F0EB CC7BFE          17      CALL    Z,H_FILE
00030E F0EE FEB5             7      CP  0B5H            ;LOAD
000310 F0F0 CA71FE          10      JP  Z,H_BINS
000313 F0F3 FE8A             7      CP  08AH            ;RUN
000315 F0F5 CA76FE          10      JP  Z,H_BINL
000318 F0F8 FED6             7      CP  0D6H            ;COPY
00031A F0FA 2813            12      JR  Z,FIX_COPY
00031C F0FC FECF             7      CP  0CFH            ;BLOAD
00031E F0FE C0              11      RET NZ
       F0FF                     FIX_BLOAD:
00031F F0FF F7              12      RST 30H
       F100                     ROM_SLT:
000320 F100 00                      DB  0
000321 F101 A545                    DW  ROM_BLOAD
000323 F103 F5              11      PUSH    AF
000324 F104 E5              11      PUSH    HL
000325 F105 CD0EF1          17      CALL    BLOAD_RET
       F106                     SWC_BLOAD   EQU $-2
000328 F108 E1              10      POP HL
000329 F109 F1              10      POP AF
00032A F10A FECF             7      CP  0CFH            ;BLOAD
       F10C                     SWC_BLOAD_M:
00032C F10C 28DB            12      JR  Z,REPLACE_COMMAND
       F10E                     BLOAD_RET:
00032E F10E C9              10      RET
       F10F                     FIX_COPY:
00032F F10F F7              12      RST 30H
       F110                     ROM_SLT_COPY:
000330 F110 00                      DB  0
000331 F111 0147                    DW  ROM_COPY
000333 F113 C9              10      RET
       F114                     ROMUSE1:
000334 F114 3A00F1          13      LD  A,(ROM_SLT)
000337 F117 1803            12      JR  ROMUSE2
       F119                     RAMUSE1:
000339 F119 3A42F3          13      LD  A,(RAMAD1)
       F11C                     ROMUSE2:
00033C F11C C32400          10      JP  _ENASLT
                                
       F11F                     _RESULT:
00033F F11F 00                      DB  0
       F120                     _BANK:
000340 F120 00                      DB  0
       F121                     CLSZ:               ;クラスタサイズ
000341 F121 0004                    DW  1024
       F122                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F123                     SECSZ:              ;セクタサイズ
000343 F123 0002                    DW  512
       F124                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F125                     RR_LOW:
000345 F125 0000                    DW  0
       F126                     RR_MID  EQU $-1
       F127                     RR_HIGH:
000347 F127 0000                    DW  0
       F129                     _CLPS:
000349 F129 0000                    DW  0
       F12B                     _LEFT:
00034B F12B 0000                    DW  0
       F12D                     _DTPS:
00034D F12D 0000                    DW  0
       F12F                     _DTA:
00034F F12F 0000                    DW  0
       F131                     FLG_LDIR:
000351 F131 00                      DB  0
                                
                                ;   BDOS
000352 F132 F7              12      RST 30H
000353 F133 00                      DB  0
000354 F134 634F                    DW  ROM_BDOS
000356 F136 C9              10      RET 
       F137                     _FCB:
000357 F137 0000                    DW  0
       F139                     _BUF:
       F139                     _BUF_LO:        ;LOGICAL OPERATION
000359 F139 00                      DB  0
       F13A                     _BUF_ST:
00035A F13A 0000                    DW  0
       F13C                     _BUF_EN:
00035C F13C 0000                    DW  0
       F13E                     _BUF_EX:
       F13E                     _BUF_W:
00035E F13E 0000                    DW  0
       F140                     _BUF_H:
000360 F140 0000                    DW  0
       F142                     _BUF_X:
000362 F142 0000                    DW  0
       F144                     _BUF_Y:
000364 F144 00                      DB  0
       F145                     _BUF_P:
000365 F145 00                      DB  0
       F146                     _BUF_O:
000366 F146 00                      DB  0
       F147                     DTAX:
000367 F147 0000                    DW  0
       F149                     B_DRIVE:
000369 F149 00                      DB  0
       F14A                     _DVSW:
00036A F14A 00                      DB  0
       F14B                     FCBX:
00036B F14B 0000                    DW  0
       F14D                     LEFTX:
00036D F14D 0000                    DW  0
       F14F                     PARAM0:
00036F F14F 0000                    DW  0
       F151                     PARAM1:
000371 F151 0000                    DW  0
       F153                     FDRV:
000373 F153 00                      DB  0
       F154                     FNAME:
000374 F154                         DS  8+3
                                
       F15F                     BASSTK:
00037F F15F 0000                    DW  0
       F161                     _HL:
000381 F161 0000                    DW  0
       F163                     _SP:
000383 F163 0000                    DW  0
                                
       F165                     ISC_E:
000385 4385                         ORG $$+RUN          ;$DEPHASE
                                
       4385                     MSX1:
000385 4385 CD7C4F          17      CALL    MSGA1
       4388                     MSX:
000388 4388 7E               7      LD  A,(HL)
000389 4389 23               6      INC HL
00038A 438A B7               4      OR  A
00038B 438B 20F8            12      JR  NZ,MSX1
00038D 438D C9              10      RET
                                
       438E                     PRTHX:
00038E 438E F5              11      PUSH    AF
00038F 438F 07               4      RLCA
000390 4390 07               4      RLCA
000391 4391 07               4      RLCA
000392 4392 07               4      RLCA
000393 4393 CD9743          17      CALL    PRTA2
000396 4396 F1              10      POP AF
       4397                     PRTA2:
000397 4397 CD9D43          17      CALL    ASC
00039A 439A C3784F          10      JP  MSG_A
                                    
       439D                     ASC:
00039D 439D E60F             7      AND $0F
00039F 439F F630             7      OR  $30
0003A1 43A1 FE3A             7      CP  $3A
0003A3 43A3 D8              11      RET C
0003A4 43A4 C607             7      ADD A,7
0003A6 43A6 C9              10      RET
                                
       43A7                     MSN:
0003A7 43A7 7E               7      LD  A,(HL)
0003A8 43A8 23               6      INC HL
0003A9 43A9 CD784F          17      CALL    MSG_A
0003AC 43AC 10F9            13      DJNZ    MSN
0003AE 43AE C9              10      RET
                                
       43AF                     ROM_STKE:
0003AF 43AF 3E                      DB  03EH
0003B0 43B0 C9              10      RET
0003B1 43B1 32DAFE          13      LD  (H_STKE),A
0003B4 43B4 E5              11      PUSH    HL
0003B5 43B5 D5              11      PUSH    DE
0003B6 43B6 C5              11      PUSH    BC
0003B7 43B7 181D            12      JR  BASAUTO
                                
0003B9 43B9 AF               4      XOR A
0003BA 43BA 5F               4      LD  E,A
0003BB 43BB 57               4      LD  D,A
0003BC 43BC 0601             7      LD  B,1
0003BE 43BE 2100C0          10      LD  HL,0C000H
0003C1 43C1 CD864D          17      CALL    DISKIO
                                
0003C4 43C4 ED735FF1        20      LD  (BASSTK),SP
0003C8 43C8 116BF3          10      LD  DE,RAMUSE
0003CB 43CB AF               4      XOR A
0003CC 43CC CD1EC0          17      CALL    0C01EH
0003CF 43CF 116BF3          10      LD  DE,RAMUSE
0003D2 43D2 37               4      SCF
0003D3 43D3 CD1EC0          17      CALL    0C01EH
       43D6                     BASAUTO:
0003D6 43D6 212344          10      LD  HL,AUTOEXEC
0003D9 43D9 1153F1          10      LD  DE,FDRV
0003DC 43DC 010C00          10      LD  BC,1+8+3
0003DF 43DF EDB0                    LDIR
0003E1 43E1 CDFC4A          17      CALL    ROM_OPEN
0003E4 43E4 3813            12      JR  C,RSTKEE
0003E6 43E6 212F44          10      LD  HL,RUN_AUTOEXEC
0003E9 43E9 11F0FB          10      LD  DE,KEYBUF
0003EC 43EC ED53FAF3        20      LD  (GETPNT),DE
0003F0 43F0 011300          10      LD  BC,RUN_AUTOEXEC_E-RUN_AUTOEXEC
0003F3 43F3 EDB0                    LDIR
0003F5 43F5 ED53F8F3        20      LD  (PUTPNT),DE
       43F9                     RSTKEE:
0003F9 43F9 C1              10      POP BC
0003FA 43FA D1              10      POP DE
0003FB 43FB E1              10      POP HL
0003FC 43FC C9              10      RET
                                
       43FD                     MSG_ERROR_ROM_MODE:
0003FD 43FD 41534349492D384B        DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
            2F4B6F6E616D692D    
            384B2F4B6F6E616D    
            692D534343206F6E    
            6C79210D0A          
       4422                     NULL:
000422 4422 00                      DB  0
                                
       4423                     AUTOEXEC:
000423 4423 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       442F                     RUN_AUTOEXEC:
00042F 442F 52554E2022415554        DB  'RUN "AUTOEXEC.BAS"',00DH
            4F455845432E4241    
            53220D              
                                ;   DB  'LOAD "AUTOEXEC.BAS"',00DH  ;テスト用
       4442                     RUN_AUTOEXEC_E:
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       4442                     ROM_LDIR:
000442 4442 3A31F1          13      LD  A,(FLG_LDIR)
000445 4445 B7               4      OR  A
000446 4446 2008            12      JR  NZ,ROM_LDIRVM
000448 4448 CB7A             8      BIT 7,D
00044A 444A CA6244          10      JP  Z,ROM_LDIRSLT
                                
                                #if exists USE_NORMAL_32K_ROM
                                    LD  (_SP),SP
                                    LD  SP,DRVTBL
                                LDIR1:
                                    LD  A,B
                                    OR  C
                                    JR  Z,LDIRE
                                
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                LDIR2:
                                    LD  A,D
                                    CP  0C0H
                                    JR  NC,LDIR4
                                
                                    PUSH    BC
                                    PUSH    DE
                                    LD  DE,BUF
                                
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIR3
                                    LD  BC,00100H
                                LDIR3:
                                    PUSH    BC
                                    LDIR
                                    LD  (_HL),HL
                                
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                
                                    LD  HL,BUF
                                    POP BC
                                    POP DE
                                    LDIR
                                
                                    LD  HL,(_HL)
                                    POP BC
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIRE
                                    DEC B
                                    JR  LDIR1
                                LDIR4:
                                #endif
00044D 444D EDB0                    LDIR
                                
                                #if exists USE_NORMAL_32K_ROM
                                LDIRE:
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    LD  SP,(_SP)
                                #endif
00044F 444F C9              10      RET
                                
       4450                     ROM_LDIRVM:
                                #if exists USE_NORMAL_32K_ROM
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
000450 4450 C5              11      PUSH    BC
000451 4451 D5              11      PUSH    DE
000452 4452 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000456 4456 DD215C00        14      LD  IX,LDIRVM
00045A 445A CD1C00          17      CALL    _CALSLT
                                #if exists USE_NORMAL_32K_ROM
                                    LD  H,080H
                                    LD  A,(RAMAD2)
                                    CALL    _ENASLT
                                #endif
00045D 445D E1              10      POP HL
00045E 445E C1              10      POP BC
00045F 445F 09              11      ADD HL,BC
000460 4460 EB               4      EX  DE,HL
000461 4461 C9              10      RET
                                
       4462                     ROM_LDIRSLT:
000462 4462 EB               4      EX  DE,HL
       4463                     RLDIRSLT1:
000463 4463 1A               7      LD  A,(DE)
000464 4464 13               6      INC DE
000465 4465 C5              11      PUSH    BC
000466 4466 D5              11      PUSH    DE
000467 4467 E5              11      PUSH    HL
000468 4468 5F               4      LD  E,A
000469 4469 3A42F3          13      LD  A,(RAMAD1)
00046C 446C FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000470 4470 DD211400        14      LD  IX,_WRSLT
000474 4474 CD1C00          17      CALL    _CALSLT
000477 4477 E1              10      POP HL
000478 4478 D1              10      POP DE
000479 4479 C1              10      POP BC
00047A 447A EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00047C 447C EA6344          10      JP  PE,RLDIRSLT1
00047F 447F EB               4      EX  DE,HL
000480 4480 C9              10      RET
                                
       4481                     END_OF_LINE:
000481 4481 215EF5          10      LD  HL,BUF
       4484                     EOL1:
000484 4484 7E               7      LD  A,(HL)
000485 4485 C8              11      RET Z
000486 4486 FE0D             7      CP  00DH
000488 4488 2807            12      JR  Z,EOLE
00048A 448A FE0A             7      CP  00AH
00048C 448C 2803            12      JR  Z,EOLE
00048E 448E 23               6      INC HL
00048F 448F 18F3            12      JR  EOL1
       4491                     EOLE:
000491 4491 3600            10      LD  (HL),0
000493 4493 23               6      INC HL
000494 4494 7E               7      LD  A,(HL)
000495 4495 FE0A             7      CP  00AH
000497 4497 C0              11      RET NZ
000498 4498 23               6      INC HL
000499 4499 C9              10      RET
                                
       449A                     ROM_LOAD_ASCII:
00049A 449A 210000          10      LD  HL,0
00049D 449D 223AF1          16      LD  (_BUF_ST),HL    ;読み出し位置
0004A0 44A0 2A76F6          16      LD  HL,(TXTTAB)
0004A3 44A3 223CF1          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
0004A6 44A6 215EF5          10      LD  HL,BUF
0004A9 44A9 222FF1          16      LD  (_DTA),HL
       44AC                     RLOAD_A1:
0004AC 44AC 2A3AF1          16      LD  HL,(_BUF_ST)
0004AF 44AF 2225F1          16      LD  (RR_LOW),HL
0004B2 44B2 210201          10      LD  HL,258
0004B5 44B5 CD1C49          17      CALL    ROM_READ
0004B8 44B8 7C               4      LD  A,H
0004B9 44B9 B5               4      OR  L
0004BA 44BA 2877            12      JR  Z,RLOAD_AEND
0004BC 44BC 015EF5          10      LD  BC,BUF
0004BF 44BF 09              11      ADD HL,BC
0004C0 44C0 3600            10      LD  (HL),0
0004C2 44C2 CD8144          17      CALL    END_OF_LINE
0004C5 44C5 015EF5          10      LD  BC,BUF
0004C8 44C8 A7               4      AND A
0004C9 44C9 ED42            15      SBC HL,BC
0004CB 44CB 2810            12      JR  Z,RLOAD_A2
0004CD 44CD 4D               4      LD  C,L
0004CE 44CE 44               4      LD  B,H
0004CF 44CF ED5B3AF1        20      LD  DE,(_BUF_ST)
0004D3 44D3 19              11      ADD HL,DE
0004D4 44D4 223AF1          16      LD  (_BUF_ST),HL
0004D7 44D7 3A5EF5          13      LD  A,(BUF)
0004DA 44DA B7               4      OR  A
0004DB 44DB 28CF            12      JR  Z,RLOAD_A1
       44DD                     RLOAD_A2:
0004DD 44DD 115EF5          10      LD  DE,BUF
0004E0 44E0 CD934A          17      CALL    SPCUTEX
0004E3 44E3 1A               7      LD  A,(DE)
0004E4 44E4 B7               4      OR  A
0004E5 44E5 284C            12      JR  Z,RLOAD_AEND
0004E7 44E7 CDA54A          17      CALL    GETNUM
0004EA 44EA 7C               4      LD  A,H
0004EB 44EB B5               4      OR  L
0004EC 44EC CA9245          10      JP  Z,ERROR_DIRECT_IN_FILE
0004EF 44EF DD2A3CF1        20      LD  IX,(_BUF_EN)
0004F3 44F3 DD7502          19      LD  (IX+2),L
0004F6 44F6 DD7403          19      LD  (IX+3),H
                                
0004F9 44F9 CD8C4A          17      CALL    SPCUT
0004FC 44FC EB               4      EX  DE,HL
0004FD 44FD DDE5            15      PUSH    IX
0004FF 44FF DD21B242        14      LD  IX,CRUNCH
000503 4503 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000507 4507 CD1C00          17      CALL    _CALSLT
00050A 450A DDE1            14      POP IX
00050C 450C EB               4      EX  DE,HL
00050D 450D 111FF4          10      LD  DE,KBUF
000510 4510 37               4      SCF
000511 4511 ED52            15      SBC HL,DE
000513 4513 287D            12      JR  Z,ERROR_DIRECT_IN_FILE
000515 4515 387B            12      JR  C,ERROR_DIRECT_IN_FILE
000517 4517 4D               4      LD  C,L
000518 4518 44               4      LD  B,H
000519 4519 2A3CF1          16      LD  HL,(_BUF_EN)
00051C 451C 110400          10      LD  DE,4
00051F 451F 19              11      ADD HL,DE
000520 4520 111FF4          10      LD  DE,KBUF
                                
000523 4523 EB               4      EX  DE,HL
000524 4524 EDB0                    LDIR
000526 4526 EB               4      EX  DE,HL
                                
000527 4527 DD7500          19      LD  (IX+0),L
00052A 452A DD7401          19      LD  (IX+1),H
00052D 452D 223CF1          16      LD  (_BUF_EN),HL
000530 4530 C3AC44          10      JP  RLOAD_A1
                                
       4533                     RLOAD_AEND:
000533 4533 2A3CF1          16      LD  HL,(_BUF_EN)
000536 4536 AF               4      XOR A
000537 4537 77               7      LD  (HL),A
000538 4538 23               6      INC HL
000539 4539 77               7      LD  (HL),A
00053A 453A 23               6      INC HL
00053B 453B 223CF1          16      LD  (_BUF_EN),HL
00053E 453E 183B            12      JR  RLOAD_END1
                                
       4540                     ROM_LOAD:
000540 4540 CDD246          17      CALL    INIT_PARAM
000543 4543 CDBC49          17      CALL    FILE_B
000546 4546 3A54F1          13      LD  A,(FNAME)
000549 4549 FE20             7      CP  020H
00054B 454B CAB749          10      JP  Z,ROM_ORG
                                
00054E 454E CDFC4A          17      CALL    ROM_OPEN
000551 4551 3845            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000553 4553 2139F1          10      LD  HL,_BUF
000556 4556 222FF1          16      LD  (_DTA),HL
000559 4559 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
00055C 455C CD1C49          17      CALL    ROM_READ
00055F 455F 3A39F1          13      LD  A,(_BUF)
000562 4562 3C               4      INC A
000563 4563 C29A44          10      JP  NZ,ROM_LOAD_ASCII
000566 4566 2A76F6          16      LD  HL,(TXTTAB)
000569 4569 222FF1          16      LD  (_DTA),HL
00056C 456C EB               4      EX  DE,HL
00056D 456D 2100FF          10      LD  HL,-256
000570 4570 39              11      ADD HL,SP
000571 4571 ED52            15      SBC HL,DE
000573 4573 CD1C49          17      CALL    ROM_READ
000576 4576 ED5B2FF1        20      LD  DE,(_DTA)
00057A 457A 19              11      ADD HL,DE
       457B                     RLOAD_END1:
00057B 457B 22C2F6          16      LD  (VARTAB),HL
00057E 457E 22C4F6          16      LD  (ARYTAB),HL
000581 4581 22C6F6          16      LD  (STREND),HL
                                
000584 4584 AF               4      XOR A
000585 4585 213CF1          10      LD  HL,_BUF+3
000588 4588 77               7      LD  (HL),A
000589 4589 2B               6      DEC HL
00058A 458A 77               7      LD  (HL),A
00058B 458B 2B               6      DEC HL
00058C 458C 77               7      LD  (HL),A
00058D 458D 2B               6      DEC HL
00058E 458E 3E8F             7      LD  A,08FH          ;REM
000590 4590 77               7      LD  (HL),A
000591 4591 C9              10      RET
                                
       4592                     ERROR_DIRECT_IN_FILE:
000592 4592 1E39             7      LD  E,57            ;Direct statement in file
000594 4594 01                      DB  1           ;LD BC,
       4595                     ERROR_FILE_NOT_OPEN:
000595 4595 1E3B             7      LD  E,59            ;File not OPEN
000597 4597 01                      DB  1           ;LD BC,
       4598                     ERROR_FILE_NOT_FOUND:
000598 4598 1E35             7      LD  E,53            ;File not found
       459A                     ERROR:
00059A 459A FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00059E 459E DD216F40        14      LD  IX,ERRHAND
0005A2 45A2 C31C00          10      JP  _CALSLT
                                
       45A5                     ROM_BLOAD:
0005A5 45A5 CDD246          17      CALL    INIT_PARAM
0005A8 45A8 CDBC49          17      CALL    FILE_B
0005AB 45AB CDFC4A          17      CALL    ROM_OPEN
0005AE 45AE 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
0005B0 45B0 2139F1          10      LD  HL,_BUF
0005B3 45B3 222FF1          16      LD  (_DTA),HL
0005B6 45B6 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
0005B9 45B9 CD1C49          17      CALL    ROM_READ
0005BC 45BC 3A39F1          13      LD  A,(_BUF)
0005BF 45BF FEFE             7      CP  0FEH
0005C1 45C1 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
0005C3 45C3 210EF1          10      LD  HL,BLOAD_RET
0005C6 45C6 2206F1          16      LD  (SWC_BLOAD),HL
                                
0005C9 45C9 2A51F1          16      LD  HL,(PARAM1)
0005CC 45CC 7E               7      LD  A,(HL)
0005CD 45CD FE2C             7      CP  ','
0005CF 45CF 2048            12      JR  NZ,RBREAD_MEM
0005D1 45D1 23               6      INC HL
0005D2 45D2 7E               7      LD  A,(HL)
0005D3 45D3 CDE64A          17      CALL    CAP
0005D6 45D6 32BEFC          13      LD  (RUNBNF),A
       45D9                     RBOS1:
0005D9 45D9 7E               7      LD  A,(HL)
0005DA 45DA 23               6      INC HL
0005DB 45DB B7               4      OR  A
0005DC 45DC 282F            12      JR  Z,RBREAD_OSE
0005DE 45DE FE3A             7      CP  ':'
0005E0 45E0 282B            12      JR  Z,RBREAD_OSE
0005E2 45E2 FE2C             7      CP  ','     ;次のパラメータを探す
0005E4 45E4 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
0005E6 45E6 2251F1          16      LD  (PARAM1),HL
0005E9 45E9 7E               7      LD  A,(HL)
0005EA 45EA B7               4      OR  A
0005EB 45EB 2820            12      JR  Z,RBREAD_OSE
0005ED 45ED DD21644C        14      LD  IX,FRMEVL
0005F1 45F1 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0005F5 45F5 CD1C00          17      CALL    _CALSLT
0005F8 45F8 2251F1          16      LD  (PARAM1),HL
0005FB 45FB 3A63F6          13      LD  A,(VALTYP)
0005FE 45FE FE02             7      CP  2
000600 4600 200B            12      JR  NZ,RBREAD_OSE
000602 4602 2A3AF1          16      LD  HL,(_BUF_ST)
000605 4605 ED5BF8F7        20      LD  DE,(DACDAT)
000609 4609 19              11      ADD HL,DE
00060A 460A 223AF1          16      LD  (_BUF_ST),HL
       460D                     RBREAD_OSE:
00060D 460D 3ABEFC          13      LD  A,(RUNBNF)
000610 4610 FE53             7      CP  'S'
000612 4612 2005            12      JR  NZ,RBREAD_MEM
000614 4614 3E01             7      LD  A,1
000616 4616 3231F1          13      LD  (FLG_LDIR),A
       4619                     RBREAD_MEM:
000619 4619 2A3AF1          16      LD  HL,(_BUF_ST)
00061C 461C 22BFFC          16      LD  (SAVENT),HL
00061F 461F 222FF1          16      LD  (_DTA),HL
000622 4622 21FFFF          10      LD  HL,0FFFFH
000625 4625 CD1C49          17      CALL    ROM_READ
000628 4628 3ABEFC          13      LD  A,(RUNBNF)
00062B 462B FE52             7      CP  'R'
00062D 462D 2006            12      JR  NZ,RBREAD1
00062F 462F 2A3EF1          16      LD  HL,(_BUF_EX)
000632 4632 2206F1          16      LD  (SWC_BLOAD),HL
       4635                     RBREAD1:
       4635                     ROM_NEXT:
000635 4635 2A51F1          16      LD  HL,(PARAM1)
000638 4638 7E               7      LD  A,(HL)
000639 4639 2B               6      DEC HL
00063A 463A B7               4      OR  A
00063B 463B 2805            12      JR  Z,RN1
00063D 463D FE3A             7      CP  ':'
00063F 463F 2801            12      JR  Z,RN1
000641 4641 23               6      INC HL
       4642                     RN1:
000642 4642 5D               4      LD  E,L
000643 4643 54               4      LD  D,H
                                
000644 4644 CDBC4A          17      CALL    SEARCH_END
000647 4647 B7               4      OR  A
000648 4648 2821            12      JR  Z,REM
       464A                     RN3:                    ;マルチステートメントの処理
00064A 464A 7E               7      LD  A,(HL)
                                
00064B 464B FEB5             7      CP  0B5H            ;LOAD
00064D 464D CA4045          10      JP  Z,ROM_LOAD
000650 4650 FE8A             7      CP  08AH            ;RUN
000652 4652 281B            12      JR  Z,ROM_RUN
000654 4654 FEB7             7      CP  0B7H            ;FILES
000656 4656 2824            12      JR  Z,ROM_FILES
000658 4658 FED6             7      CP  0D6H            ;COPY
00065A 465A CA0147          10      JP  Z,ROM_COPY
00065D 465D FE20             7      CP  020H
00065F 465F 2807            12      JR  Z,RN_SP
                                
000661 4661 3E28             7      LD  A,028H          ;JR Z,
000663 4663 320CF1          13      LD  (SWC_BLOAD_M),A
000666 4666 7E               7      LD  A,(HL)
000667 4667 C9              10      RET
       4668                     RN_SP:
000668 4668 23               6      INC HL
000669 4669 18DF            12      JR  RN3
                                
       466B                     REM:
00066B 466B EB               4      EX  DE,HL
00066C 466C 3E8F             7      LD  A,08FH          ;REM
00066E 466E C9              10      RET
                                
       466F                     ROM_RUN:
00066F 466F 23               6      INC HL
000670 4670 7E               7      LD  A,(HL)
000671 4671 2B               6      DEC HL
000672 4672 B7               4      OR  A
000673 4673 2803            12      JR  Z,ROM_RUN1
000675 4675 CD4045          17      CALL    ROM_LOAD
       4678                     ROM_RUN1:
000678 4678 3E8A             7      LD  A,08AH          ;RUN
00067A 467A 77               7      LD  (HL),A
00067B 467B C9              10      RET
                                
       467C                     ROM_FILES:
00067C 467C CDD246          17      CALL    INIT_PARAM
00067F 467F CDBC49          17      CALL    FILE_B
000682 4682 CD1B4F          17      CALL    GET_DISK_BANK_FDRV
000685 4685 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000688 4688 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
00068B 468B 3A54F1          13      LD  A,(FNAME)
00068E 468E FE21             7      CP  021H
000690 4690 3005            12      JR  NC,RFILES0
000692 4692 060B             7      LD  B,11
000694 4694 CD504A          17      CALL    FILE10
       4697                     RFILES0:
000697 4697 CD444D          17      CALL    GET_DIR_DAT
       469A                     RFILES1:
00069A 469A CD184B          17      CALL    FILESE
00069D 469D 302E            12      JR  NC,RFILES_NOT_MATCH
       469F                     RFILES_DISP:
00069F 469F E5              11      PUSH    HL
0006A0 46A0 0608             7      LD  B,8
0006A2 46A2 CDA743          17      CALL    MSN
0006A5 46A5 3E2E             7      LD  A,'.'
0006A7 46A7 CD784F          17      CALL    MSG_A
0006AA 46AA 0603             7      LD  B,3
0006AC 46AC CDA743          17      CALL    MSN
0006AF 46AF 3ADDF3          13      LD  A,(CSRX)
0006B2 46B2 47               4      LD  B,A
0006B3 46B3 3AB0F3          13      LD  A,(LINLEN)
0006B6 46B6 90               4      SUB B
0006B7 46B7 FE0C             7      CP  12
0006B9 46B9 3009            12      JR  NC,RFILES2
0006BB 46BB 3E0D             7      LD  A,00DH      ;改行
0006BD 46BD CD784F          17      CALL    MSG_A
0006C0 46C0 3E0A             7      LD  A,00AH
0006C2 46C2 1802            12      JR  RFILES3
       46C4                     RFILES2:
0006C4 46C4 3E20             7      LD  A,020H
       46C6                     RFILES3:
0006C6 46C6 CD784F          17      CALL    MSG_A
0006C9 46C9 E1              10      POP HL
0006CA 46CA CD344B          17      CALL    FNEXT
       46CD                     RFILES_NOT_MATCH:
0006CD 46CD 20CB            12      JR  NZ,RFILES1
0006CF 46CF C33546          10      JP  ROM_NEXT
                                
       46D2                     INIT_PARAM:
0006D2 46D2 224FF1          16      LD  (PARAM0),HL
0006D5 46D5 2251F1          16      LD  (PARAM1),HL
0006D8 46D8 EB               4      EX  DE,HL
0006D9 46D9 AF               4      XOR A
0006DA 46DA 3231F1          13      LD  (FLG_LDIR),A
0006DD 46DD 32BEFC          13      LD  (RUNBNF),A
0006E0 46E0 3263F6          13      LD  (VALTYP),A
0006E3 46E3 13               6      INC DE
0006E4 46E4 CD8C4A          17      CALL    SPCUT
0006E7 46E7 1A               7      LD  A,(DE)
0006E8 46E8 B7               4      OR  A
0006E9 46E9 C8              11      RET Z
0006EA 46EA FE3A             7      CP  ':'
0006EC 46EC C8              11      RET Z
0006ED 46ED FE28             7      CP  '('
0006EF 46EF C8              11      RET Z
0006F0 46F0 EB               4      EX  DE,HL
0006F1 46F1 DD21644C        14      LD  IX,FRMEVL
0006F5 46F5 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0006F9 46F9 CD1C00          17      CALL    _CALSLT
0006FC 46FC 2251F1          16      LD  (PARAM1),HL
0006FF 46FF C9              10      RET
                                
000700 4700 00               4      NOP
       4701                     ROM_COPY:
000701 4701 CDD246          17      CALL    INIT_PARAM
000704 4704 3A63F6          13      LD  A,(VALTYP)
000707 4707 FE03             7      CP  3       ;string
000709 4709 C2B749          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
00070C 470C CDBC49          17      CALL    FILE_B
00070F 470F CDFC4A          17      CALL    ROM_OPEN
000712 4712 DA9845          10      JP  C,ERROR_FILE_NOT_FOUND
                                
000715 4715 213EF1          10      LD  HL,_BUF_W
000718 4718 222FF1          16      LD  (_DTA),HL
00071B 471B 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
00071E 471E CD1C49          17      CALL    ROM_READ
                                
000721 4721 AF               4      XOR A
000722 4722 3239F1          13      LD  (_BUF_LO),A     ;PSET
000725 4725 3246F1          13      LD  (_BUF_O),A      ;向き
                                
000728 4728 2A51F1          16      LD  HL,(PARAM1)
       472B                     RCP_PARAM1:
00072B 472B 7E               7      LD  A,(HL)
00072C 472C 23               6      INC HL
00072D 472D B7               4      OR  A
00072E 472E CAB749          10      JP  Z,ROM_ORG
000731 4731 FE3A             7      CP  ':'
000733 4733 CAB749          10      JP  Z,ROM_ORG
000736 4736 FE2C             7      CP  ','
000738 4738 2012            12      JR  NZ,RCP_PARAM1_
                                
00073A 473A DD212F54        14      LD  IX,FRMQNT
00073E 473E FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000742 4742 CD1C00          17      CALL    _CALSLT
000745 4745 7B               4      LD  A,E
000746 4746 87               4      ADD A,A
000747 4747 87               4      ADD A,A
000748 4748 3246F1          13      LD  (_BUF_O),A
00074B 474B 7E               7      LD  A,(HL)
       474C                     RCP_PARAM1_:
00074C 474C FE28             7      CP  '('
00074E 474E 20DB            12      JR  NZ,RCP_PARAM1
                                
000750 4750 DD212F54        14      LD  IX,FRMQNT
000754 4754 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000758 4758 CD1C00          17      CALL    _CALSLT
                                
00075B 475B ED5342F1        20      LD  (_BUF_X),DE
                                
       475F                     RCP_PARAM2:
00075F 475F 23               6      INC HL
000760 4760 7E               7      LD  A,(HL)
000761 4761 FE20             7      CP  020H
000763 4763 28FA            12      JR  Z,RCP_PARAM2
000765 4765 FE2C             7      CP  ','
000767 4767 28F6            12      JR  Z,RCP_PARAM2
                                
000769 4769 DD212F54        14      LD  IX,FRMQNT
00076D 476D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000771 4771 CD1C00          17      CALL    _CALSLT
                                
000774 4774 ED5344F1        20      LD  (_BUF_Y),DE
       4778                     RCP_PARAM3:
000778 4778 23               6      INC HL
000779 4779 7E               7      LD  A,(HL)
00077A 477A FE20             7      CP  020H
00077C 477C 28FA            12      JR  Z,RCP_PARAM3
00077E 477E FE29             7      CP  ')'
000780 4780 28F6            12      JR  Z,RCP_PARAM3
000782 4782 FE2C             7      CP  ','
000784 4784 2033            12      JR  NZ,RCP_ST
                                
000786 4786 23               6      INC HL
000787 4787 DD212F54        14      LD  IX,FRMQNT
00078B 478B FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00078F 478F CD1C00          17      CALL    _CALSLT
                                
000792 4792 7B               4      LD  A,E
000793 4793 3245F1          13      LD  (_BUF_P),A
                                
       4796                     RCP_PARAM4:
000796 4796 7E               7      LD  A,(HL)
000797 4797 23               6      INC HL
000798 4798 FE20             7      CP  020H
00079A 479A 28FA            12      JR  Z,RCP_PARAM4
                                
00079C 479C FE2C             7      CP  ','
00079E 479E 2019            12      JR  NZ,RCP_ST
                                
0007A0 47A0 7E               7      LD  A,(HL)
0007A1 47A1 0604             7      LD  B,4
0007A3 47A3 FEC3             7      CP  0C3H        ;PRESET
0007A5 47A5 280E            12      JR  Z,RCP_LO
0007A7 47A7 05               4      DEC B       ;3
0007A8 47A8 D6F8             7      SUB 0F8H        ;XOR
0007AA 47AA 2809            12      JR  Z,RCP_LO
0007AC 47AC 05               4      DEC B       ;2
0007AD 47AD 3C               4      INC A       ;OR
0007AE 47AE 2805            12      JR  Z,RCP_LO
0007B0 47B0 05               4      DEC B       ;1
0007B1 47B1 3C               4      INC A       ;AND
0007B2 47B2 2801            12      JR  Z,RCP_LO
0007B4 47B4 05               4      DEC B       ;0
                                                ;PSET
       47B5                     RCP_LO:
0007B5 47B5 78               4      LD  A,B
0007B6 47B6 3239F1          13      LD  (_BUF_LO),A
       47B9                     RCP_ST:
0007B9 47B9 2AC6F6          16      LD  HL,(STREND)
0007BC 47BC 222FF1          16      LD  (_DTA),HL
0007BF 47BF EB               4      EX  DE,HL
0007C0 47C0 2100FE          10      LD  HL,-512
0007C3 47C3 39              11      ADD HL,SP
0007C4 47C4 AF               4      XOR A
0007C5 47C5 ED52            15      SBC HL,DE
0007C7 47C7 3008            12      JR  NC,RCP0
0007C9 47C9 215EF5          10      LD  HL,BUF
0007CC 47CC 222FF1          16      LD  (_DTA),HL
0007CF 47CF 6F               4      LD  L,A ;0
0007D0 47D0 67               4      LD  H,A ;0
       47D1                     RCP0:
0007D1 47D1 24               4      INC H
0007D2 47D2 223CF1          16      LD  (_BUF_EN),HL
       47D5                     RCP1:
0007D5 47D5 F3               4      DI
0007D6 47D6 CDAA48          17      CALL    WAIT_VDP
                                
0007D9 47D9 3A0700          13      LD  A,(WRVDP)
0007DC 47DC 4F               4      LD  C,A
0007DD 47DD 0C               4      INC C       ;C := PORT#1's address(WR)
0007DE 47DE 3E24             7      LD  A,36
0007E0 47E0 ED79            12      OUT (C),A
0007E2 47E2 3E91             7      LD  A,080H+17
0007E4 47E4 ED79            12      OUT (C),A       ;R#17 := 36
                                
0007E6 47E6 0C               4      INC C
0007E7 47E7 0C               4      INC C       ;C := PORT#3's address(WR)
0007E8 47E8 2A42F1          16      LD  HL,(_BUF_X)
0007EB 47EB ED69            12      OUT (C),L       ;R#36 DX
0007ED 47ED ED61            12      OUT (C),H       ;R#37
0007EF 47EF 2A44F1          16      LD  HL,(_BUF_Y)
0007F2 47F2 ED69            12      OUT (C),L       ;R#38 DY
0007F4 47F4 ED61            12      OUT (C),H       ;R#39
0007F6 47F6 2A3EF1          16      LD  HL,(_BUF_W)
0007F9 47F9 ED69            12      OUT (C),L       ;R#40 NX
0007FB 47FB ED61            12      OUT (C),H       ;R#41
0007FD 47FD 2A40F1          16      LD  HL,(_BUF_H)
000800 4800 ED69            12      OUT (C),L       ;R#42 NY
000802 4802 ED61            12      OUT (C),H       ;R#43
                                
000804 4804 DD2AAFFC        20      LD  IX,(SCRMOD)
000808 4808 3A39F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00080B 480B B7               4      OR  A
00080C 480C 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
00080E 480E DD7D             9      LD  A,IXL
000810 4810 FE08             7      CP  8
000812 4812 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
000814 4814 FE06             7      CP  6
000816 4816 2A42F1          16      LD  HL,(_BUF_X)
000819 4819 3A3EF1          13      LD  A,(_BUF_W)
00081C 481C 2005            12      JR  NZ,SCR57
00081E 481E B5               4      OR  L       ;スクリーン6
00081F 481F E603             7      AND 3
000821 4821 200D            12      JR  NZ,USE_LMMC
       4823                     SCR57:              ;スクリーン5,7
000823 4823 B5               4      OR  L
000824 4824 E601             7      AND 1
000826 4826 2008            12      JR  NZ,USE_LMMC
       4828                     USE_HMMC:
000828 4828 DD2E08          10      LD  IXL,8
       482B                     USE_HMMC8:
00082B 482B 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
00082D 482D 3239F1          13      LD  (_BUF_LO),A
       4830                     USE_LMMC:
000830 4830 110000          10      LD  DE,0
000833 4833 06FF             7      LD  B,-1
000835 4835 CDD548          17      CALL    GET_PIXEL
000838 4838 ED79            12      OUT (C),A       ;R#44 first DATA
00083A 483A 3A46F1          13      LD  A,(_BUF_O)
00083D 483D ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
00083F 483F 3A39F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000842 4842 F6B0             7      OR  0B0H        ;R#46 LMMC command
000844 4844 ED79            12      OUT (C),A
                                
000846 4846 FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
000848 4848 0D               4      DEC C
000849 4849 0D               4      DEC C       ;C := PORT#1's address(WR)
00084A 484A 3EAC             7      LD  A,080H+44
00084C 484C ED79            12      OUT (C),A
00084E 484E 3E91             7      LD  A,080H+17
000850 4850 ED79            12      OUT (C),A       ;R#17 := 44
                                
000852 4852 3A0600          13      LD  A,(RDVDP)
000855 4855 3C               4      INC A
000856 4856 FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
000858 4858 3E02             7      LD  A,2
00085A 485A ED79            12      OUT (C),A
00085C 485C 3E8F             7      LD  A,08FH
00085E 485E ED79            12      OUT (C),A
000860 4860 3A39F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000863 4863 E640             7      AND 040H
000865 4865 201C            12      JR  NZ,LOOP_HMMC
       4867                     LOOP_COPY:
000867 4867 CDD548          17      CALL    GET_PIXEL
00086A 486A 08               4      EX  AF,AF'
00086B 486B FD4C             9      LD  C,IYH
       486D                     LOOP_COPY1:
00086D 486D ED78            12      IN  A,(C)
00086F 486F 0F               4      RRCA            ;RRCAではサインフラグは変化しない
000870 4870 300A            12      JR  NC,EXIT_COPY    ;check CE bit
000872 4872 F26D48          10      JP  P,LOOP_COPY1    ;check TR bit
000875 4875 08               4      EX  AF,AF'
000876 4876 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000878 4878 ED79            12      OUT (C),A
00087A 487A 18EB            12      JR  LOOP_COPY
                                
       487C                     EXIT_COPY:
00087C 487C CDB248          17      CALL    GET_STATUS_0
00087F 487F FB               4      EI
000880 4880 C33546          10      JP  ROM_NEXT
                                
       4883                     LOOP_HMMC:
000883 4883 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000885 4885 43               4      LD  B,E
000886 4886 7B               4      LD  A,E
000887 4887 B7               4      OR  A
000888 4888 2802            12      JR  Z,LOOP_HMMC1
00088A 488A EDB3                    OTIR
       488C                     LOOP_HMMC1:
00088C 488C 14               4      INC D
       488D                     LOOP_HMMC2:
00088D 488D 15               4      DEC D
00088E 488E 2805            12      JR  Z,LOOP_HMMC3
000890 4890 EDB3                    OTIR
000892 4892 C38D48          10      JP  LOOP_HMMC2
       4895                     LOOP_HMMC3:
000895 4895 ED78            12      IN  A,(C)
000897 4897 0F               4      RRCA
000898 4898 30E2            12      JR  NC,EXIT_COPY    ;check CE bit
00089A 489A 2A3CF1          16      LD  HL,(_BUF_EN)
00089D 489D CD1C49          17      CALL    ROM_READ
0008A0 48A0 EB               4      EX  DE,HL
0008A1 48A1 2A2FF1          16      LD  HL,(_DTA)
0008A4 48A4 7A               4      LD  A,D
0008A5 48A5 B3               4      OR  E
0008A6 48A6 20DB            12      JR  NZ,LOOP_HMMC
0008A8 48A8 18C3            12      JR  LOOP_COPY1
                                    
       48AA                     WAIT_VDP:
0008AA 48AA 3E02             7      LD  A,2
0008AC 48AC CDB348          17      CALL    GET_STATUS
0008AF 48AF 0F               4      RRCA
0008B0 48B0 38F8            12      JR  C,WAIT_VDP
       48B2                     GET_STATUS_0:
0008B2 48B2 AF               4      XOR A
       48B3                     GET_STATUS:
0008B3 48B3 C5              11      PUSH    BC
0008B4 48B4 ED4B0600        20      LD  BC,(RDVDP)
0008B8 48B8 0C               4      INC C
0008B9 48B9 ED79            12      OUT (C),A
0008BB 48BB 3E8F             7      LD  A,08FH
0008BD 48BD ED79            12      OUT (C),A
0008BF 48BF ED78            12      IN  A,(C)
0008C1 48C1 C1              10      POP BC
0008C2 48C2 C9              10      RET
                                
       48C3                     GET_PIXEL256:
0008C3 48C3 7A               4      LD  A,D
0008C4 48C4 B3               4      OR  E
0008C5 48C5 200A            12      JR  NZ,GET_PIXEL1
0008C7 48C7 2A3CF1          16      LD  HL,(_BUF_EN)
0008CA 48CA CD1C49          17      CALL    ROM_READ
0008CD 48CD EB               4      EX  DE,HL
0008CE 48CE 2A2FF1          16      LD  HL,(_DTA)
       48D1                     GET_PIXEL1:
0008D1 48D1 7E               7      LD  A,(HL)
0008D2 48D2 23               6      INC HL
0008D3 48D3 1B               6      DEC DE
0008D4 48D4 C9              10      RET
                                
       48D5                     GET_PIXEL:
0008D5 48D5 04               4      INC B
0008D6 48D6 DD7D             9      LD  A,IXL
0008D8 48D8 FE08             7      CP  8
0008DA 48DA 28E7            12      JR  Z,GET_PIXEL256
0008DC 48DC FE06             7      CP  6
0008DE 48DE 282E            12      JR  Z,GET_PIXEL4
                                
0008E0 48E0 CB40             8      BIT 0,B
0008E2 48E2 200E            12      JR  NZ,GET_PIXEL2
                                
0008E4 48E4 7A               4      LD  A,D
0008E5 48E5 B3               4      OR  E
0008E6 48E6 20E9            12      JR  NZ,GET_PIXEL1
                                
0008E8 48E8 2A3CF1          16      LD  HL,(_BUF_EN)
0008EB 48EB CD1C49          17      CALL    ROM_READ
0008EE 48EE EB               4      EX  DE,HL
0008EF 48EF 2A2FF1          16      LD  HL,(_DTA)
                                
       48F2                     GET_PIXEL2:
0008F2 48F2 7E               7      LD  A,(HL)
0008F3 48F3 0F               4      RRCA
0008F4 48F4 0F               4      RRCA
0008F5 48F5 0F               4      RRCA
0008F6 48F6 0F               4      RRCA
0008F7 48F7 C9              10      RET
                                
       48F8                     GET_PIXEL3:
0008F8 48F8 7A               4      LD  A,D
0008F9 48F9 B3               4      OR  E
0008FA 48FA 200A            12      JR  NZ,GET_PIXEL5
                                
0008FC 48FC 2A3CF1          16      LD  HL,(_BUF_EN)
0008FF 48FF CD1C49          17      CALL    ROM_READ
000902 4902 EB               4      EX  DE,HL
000903 4903 2A2FF1          16      LD  HL,(_DTA)
       4906                     GET_PIXEL5:
000906 4906 7E               7      LD  A,(HL)
000907 4907 0F               4      RRCA
000908 4908 0F               4      RRCA
000909 4909 0F               4      RRCA
00090A 490A 0F               4      RRCA
00090B 490B 0F               4      RRCA
00090C 490C 0F               4      RRCA
00090D 490D C9              10      RET
                                
       490E                     GET_PIXEL4:
00090E 490E 78               4      LD  A,B
00090F 490F E603             7      AND 3   ;+0
000911 4911 28E5            12      JR  Z,GET_PIXEL3
000913 4913 3D               4      DEC A   ;+1
000914 4914 28DC            12      JR  Z,GET_PIXEL2
000916 4916 3D               4      DEC A   ;+2
000917 4917 7E               7      LD  A,(HL)
000918 4918 C0              11      RET NZ
000919 4919 0F               4      RRCA        ;+3
00091A 491A 0F               4      RRCA
00091B 491B C9              10      RET
                                
       491C                     ROM_READ:
00091C 491C E5              11      PUSH    HL
00091D 491D D5              11      PUSH    DE
00091E 491E C5              11      PUSH    BC
00091F 491F FDE5            15      PUSH    IY
000921 4921 224DF1          16      LD  (LEFTX),HL
000924 4924 2A2FF1          16      LD  HL,(_DTA)
000927 4927 2247F1          16      LD  (DTAX),HL
00092A 492A 2A4DF1          16      LD  HL,(LEFTX)
                                
00092D 492D CD774B          17      CALL    RBX1
000930 4930 3870            12      JR  C,RBRERR1
000932 4932 79               4      LD  A,C
000933 4933 EB               4      EX  DE,HL
000934 4934 ED52            15      SBC HL,DE       ;CP 0HL,CDE
000936 4936 19              11      ADD HL,DE
000937 4937 DE00             7      SBC A,000H
000939 4939 3801            12      JR  C,RBR1
00093B 493B EB               4      EX  DE,HL
       493C                     RBR1:
00093C 493C 9F               4      SBC A,A
00093D 493D E601             7      AND 1
00093F 493F 321FF1          13      LD  (_RESULT),A
000942 4942 7C               4      LD  A,H
000943 4943 B5               4      OR  L
000944 4944 CA9849          10      JP  Z,RBREND0
                                
000947 4947 222BF1          16      LD  (_LEFT),HL  ;Read record byte
00094A 494A 224DF1          16      LD  (LEFTX),HL
                                
00094D 494D CD9D4B          17      CALL    RBX2
000950 4950 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000952 4952 CDB04B          17      CALL    RBXA
000955 4955 DAAE49          10      JP  C,RBRERR
000958 4958 C5              11      PUSH    BC
000959 4959 CD4244          17      CALL    ROM_LDIR
00095C 495C ED5347F1        20      LD  (DTAX),DE
000960 4960 2A4DF1          16      LD  HL,(LEFTX)
000963 4963 D1              10      POP DE
000964 4964 A7               4      AND A
000965 4965 ED52            15      SBC HL,DE
000967 4967 224DF1          16      LD  (LEFTX),HL
00096A 496A 2829            12      JR  Z,RBREND
                                
       496C                     RBRB:
00096C 496C CDEC4B          17      CALL    RBXB
00096F 496F 2818            12      JR  Z,RBRC
       4971                     RBRB1:
000971 4971 C5              11      PUSH    BC
000972 4972 D5              11      PUSH    DE
000973 4973 CD944C          17      CALL    CLUST
000976 4976 EB               4      EX  DE,HL
000977 4977 ED4B21F1        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
00097B 497B CD4244          17      CALL    ROM_LDIR
00097E 497E EB               4      EX  DE,HL
00097F 497F D1              10      POP DE
000980 4980 C1              10      POP BC
000981 4981 CD714C          17      CALL    GNCL
000984 4984 DAAE49          10      JP  C,RBRERR
000987 4987 10E8            13      DJNZ    RBRB1
       4989                     RBRC:
000989 4989 CD044C          17      CALL    RBXC
00098C 498C 2807            12      JR  Z,RBREND
                                
00098E 498E CD944C          17      CALL    CLUST
000991 4991 EB               4      EX  DE,HL
000992 4992 CD4244          17      CALL    ROM_LDIR
       4995                     RBREND:
000995 4995 CD104C          17      CALL    RBXEND
       4998                     RBREND0:
000998 4998 FDE1            14      POP IY
00099A 499A C1              10      POP BC
00099B 499B D1              10      POP DE
00099C 499C F1              10      POP AF  ;(HL)
00099D 499D AF               4      XOR A
00099E 499E 3A1FF1          13      LD  A,(_RESULT)
0009A1 49A1 C9              10      RET
                                
       49A2                     RBRERR1:
0009A2 49A2 3E01             7      LD  A,001H
       49A4                     RBRERR2:
0009A4 49A4 FDE1            14      POP IY
0009A6 49A6 C1              10      POP BC
0009A7 49A7 D1              10      POP DE
0009A8 49A8 E1              10      POP HL
0009A9 49A9 37               4      SCF
0009AA 49AA 210000          10      LD  HL,0
0009AD 49AD C9              10      RET
       49AE                     RBRERR:
0009AE 49AE 3EFF             7      LD  A,0FFH
0009B0 49B0 18F2            12      JR  RBRERR2
                                
       49B2                     FILE_DD:
0009B2 49B2 3E                      DB  03EH
0009B3 49B3 C9              10      RET
0009B4 49B4 320CF1          13      LD  (SWC_BLOAD_M),A
       49B7                     ROM_ORG:
0009B7 49B7 2A4FF1          16      LD  HL,(PARAM0)
0009BA 49BA 7E               7      LD  A,(HL)
0009BB 49BB C9              10      RET
       49BC                     FILE_B:
0009BC 49BC AF               4      XOR A
0009BD 49BD 3253F1          13      LD  (FDRV),A
0009C0 49C0 1E00             7      LD  E,0
0009C2 49C2 3A63F6          13      LD  A,(VALTYP)
0009C5 49C5 FE03             7      CP  3       ;string
0009C7 49C7 2044            12      JR  NZ,FILED
                                
0009C9 49C9 DD21D067        14      LD  IX,FRESTR
0009CD 49CD FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009D1 49D1 CD1C00          17      CALL    _CALSLT
0009D4 49D4 E5              11      PUSH    HL
0009D5 49D5 DDE1            14      POP IX
                                
0009D7 49D7 DD5E00          19      LD  E,(IX+0)
0009DA 49DA DD7E01          19      LD  A,(IX+1)
0009DD 49DD DD5602          19      LD  D,(IX+2)
0009E0 49E0 DD62             9      LD  IXH,D
0009E2 49E2 DD6F             9      LD  IXL,A
0009E4 49E4 7B               4      LD  A,E
0009E5 49E5 FE04             7      CP  4
0009E7 49E7 3808            12      JR  C,FILEB1
0009E9 49E9 DD7E03          19      LD  A,(IX+3)
0009EC 49EC FE3A             7      CP  ':'
0009EE 49EE 28C2            12      JR  Z,FILE_DD
0009F0 49F0 7B               4      LD  A,E
       49F1                     FILEB1:
0009F1 49F1 FE02             7      CP  2
0009F3 49F3 3818            12      JR  C,FILED
0009F5 49F5 DD7E01          19      LD  A,(IX+1)
0009F8 49F8 FE3A             7      CP  ':'
0009FA 49FA 2011            12      JR  NZ,DEVI1
0009FC 49FC DD7E00          19      LD  A,(IX+0)        ;DRIVE
0009FF 49FF CDE64A          17      CALL    CAP
000A02 4A02 D640             7      SUB '@'
000A04 4A04 DD23            10      INC IX
000A06 4A06 DD23            10      INC IX
000A08 4A08 1D               4      DEC E
000A09 4A09 1D               4      DEC E
000A0A 4A0A 3253F1          13      LD  (FDRV),A
       4A0D                     DEVI1:
                                
       4A0D                     FILED:
000A0D 4A0D CD544A          17      CALL    FILEI
000A10 4A10 2154F1          10      LD  HL,FNAME
                                
000A13 4A13 0608             7      LD  B,8
       4A15                     FILE2:
000A15 4A15 CD614A          17      CALL    CCHKF
000A18 4A18 C8              11      RET Z
000A19 4A19 FE2A             7      CP  '*'
000A1B 4A1B 282E            12      JR  Z,FILE9
000A1D 4A1D FE2E             7      CP  '.'
000A1F 4A1F 280C            12      JR  Z,FILE4
000A21 4A21 77               7      LD  (HL),A
000A22 4A22 23               6      INC HL
000A23 4A23 10F0            13      DJNZ    FILE2
                                
       4A25                     FILE3:
000A25 4A25 CD614A          17      CALL    CCHKF
000A28 4A28 C8              11      RET Z
000A29 4A29 FE2E             7      CP  '.'
000A2B 4A2B 20F8            12      JR  NZ,FILE3
                                
       4A2D                     FILE4:
000A2D 4A2D 215CF1          10      LD  HL,FNAME+8
000A30 4A30 0603             7      LD  B,3
                                
       4A32                     FILE4L:
000A32 4A32 CD614A          17      CALL    CCHKF
000A35 4A35 C8              11      RET Z
000A36 4A36 FE2E             7      CP  '.'
000A38 4A38 2008            12      JR  NZ,FILE12
000A3A 4A3A 3254F1          13      LD  (FNAME),A   ;Parent directory(..)
000A3D 4A3D 3255F1          13      LD  (FNAME+1),A
000A40 4A40 3E20             7      LD  A,020H
       4A42                     FILE12:
000A42 4A42 FE2A             7      CP  '*'
000A44 4A44 280A            12      JR  Z,FILE10
000A46 4A46 77               7      LD  (HL),A
000A47 4A47 23               6      INC HL
000A48 4A48 10E8            13      DJNZ    FILE4L
000A4A 4A4A C9              10      RET
                                
       4A4B                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000A4B 4A4B CD504A          17      CALL    FILE10
000A4E 4A4E 18D5            12      JR  FILE3
                                
       4A50                     FILE10:
000A50 4A50 3E3F             7      LD  A,'?'
000A52 4A52 1808            12      JR  FILL_MEMORY
       4A54                     FILEI:              ;名前＋拡張子をスペースで初期化
000A54 4A54 3E20             7      LD  A,020H
000A56 4A56 01000B          10      LD  BC,11*256   ;C=0にしておく
000A59 4A59 2154F1          10      LD  HL,FNAME
       4A5C                     FILL_MEMORY:            ;HLからBバイトAで埋める
000A5C 4A5C 77               7      LD  (HL),A
000A5D 4A5D 23               6      INC HL
000A5E 4A5E 10FC            13      DJNZ    FILL_MEMORY
000A60 4A60 C9              10      RET
                                
       4A61                     CCHKF:
000A61 4A61 7B               4      LD  A,E
000A62 4A62 B7               4      OR  A
000A63 4A63 C8              11      RET Z
000A64 4A64 DD7E00          19      LD  A,(IX+0)
000A67 4A67 CD6E4A          17      CALL    CCHK2
000A6A 4A6A C8              11      RET Z
000A6B 4A6B C3D14A          10      JP  FKAN
                                
       4A6E                     CCHK2:
000A6E 4A6E 0C               4      INC C
000A6F 4A6F 0D               4      DEC C
000A70 4A70 C0              11      RET NZ
       4A71                     CCHK3:              ;ZF=1 で使えない文字
000A71 4A71 FE2B             7      CP  '+'
000A73 4A73 C8              11      RET Z
000A74 4A74 FE2C             7      CP  ','
000A76 4A76 C8              11      RET Z
000A77 4A77 FE2F             7      CP  '/'
000A79 4A79 C8              11      RET Z
000A7A 4A7A FE3A             7      CP  ':'
000A7C 4A7C C8              11      RET Z
000A7D 4A7D FE3B             7      CP  ';'
000A7F 4A7F C8              11      RET Z
000A80 4A80 FE3D             7      CP  '='
000A82 4A82 C8              11      RET Z
000A83 4A83 FE5C             7      CP  05CH    ;\
000A85 4A85 C8              11      RET Z
000A86 4A86 FE1F             7      CP  01FH
000A88 4A88 D0              11      RET NC
000A89 4A89 BF               4      CP  A       ;Z=1
000A8A 4A8A C9              10      RET
                                
       4A8B                     SS1:
000A8B 4A8B 13               6      INC DE
       4A8C                     SPCUT:              ;スペースをカット
000A8C 4A8C 1A               7      LD  A,(DE)
000A8D 4A8D FE20             7      CP  020H
000A8F 4A8F 28FA            12      JR  Z,SS1
000A91 4A91 C9              10      RET
                                
       4A92                     SCREOF1:
000A92 4A92 13               6      INC DE
       4A93                     SPCUTEX:            ;スペース改行などをカット
000A93 4A93 1A               7      LD  A,(DE)
000A94 4A94 FE20             7      CP  020H
000A96 4A96 28FA            12      JR  Z,SCREOF1
000A98 4A98 FE0D             7      CP  00DH
000A9A 4A9A 28F6            12      JR  Z,SCREOF1
000A9C 4A9C FE0A             7      CP  00AH
000A9E 4A9E 28F2            12      JR  Z,SCREOF1
000AA0 4AA0 FE1A             7      CP  01AH
000AA2 4AA2 28EE            12      JR  Z,SCREOF1
000AA4 4AA4 C9              10      RET
                                
       4AA5                     GETNUM:
000AA5 4AA5 210000          10      LD  HL,0
       4AA8                     GETNUM1:
000AA8 4AA8 1A               7      LD  A,(DE)
000AA9 4AA9 13               6      INC DE
000AAA 4AAA D630             7      SUB '0'
000AAC 4AAC D8              11      RET C
000AAD 4AAD FE0A             7      CP  10
000AAF 4AAF D0              11      RET NC
000AB0 4AB0 4D               4      LD  C,L
000AB1 4AB1 44               4      LD  B,H
000AB2 4AB2 29              11      ADD HL,HL   ;*2
000AB3 4AB3 29              11      ADD HL,HL   ;*4
000AB4 4AB4 09              11      ADD HL,BC   ;*5
000AB5 4AB5 29              11      ADD HL,HL   ;*10
000AB6 4AB6 4F               4      LD  C,A
000AB7 4AB7 0600             7      LD  B,0
000AB9 4AB9 09              11      ADD HL,BC
000ABA 4ABA 18EC            12      JR  GETNUM1
                                
       4ABC                     SEARCH_END:
000ABC 4ABC 7E               7      LD  A,(HL)
       4ABD                     SEARCH_END1:
000ABD 4ABD 23               6      INC HL
000ABE 4ABE B7               4      OR  A
000ABF 4ABF C8              11      RET Z
000AC0 4AC0 FE3A             7      CP  ':'
000AC2 4AC2 20F8            12      JR  NZ,SEARCH_END
000AC4 4AC4 7E               7      LD  A,(HL)
000AC5 4AC5 FE3A             7      CP  ':'
000AC7 4AC7 28F4            12      JR  Z,SEARCH_END1
000AC9 4AC9 C9              10      RET
                                
       4ACA                     FKANC:
000ACA 4ACA CB41             8      BIT 0,C
000ACC 4ACC CCEF4A          17      CALL    Z,CAP2
000ACF 4ACF 1803            12      JR  FKANX
       4AD1                     FKAN:           ;漢字チェック
000AD1 4AD1 DD23            10      INC IX
000AD3 4AD3 1D               4      DEC E
       4AD4                     FKANX:
000AD4 4AD4 CB41             8      BIT 0,C
000AD6 4AD6 CB81             8      RES 0,C
000AD8 4AD8 C0              11      RET NZ
000AD9 4AD9 FE80             7      CP  080H
000ADB 4ADB D8              11      RET C
000ADC 4ADC FEA0             7      CP  0A0H
000ADE 4ADE 3803            12      JR  C,FKAN1
000AE0 4AE0 FEE0             7      CP  0E0H
000AE2 4AE2 D8              11      RET C
       4AE3                     FKAN1:
000AE3 4AE3 0C               4      INC C
000AE4 4AE4 A7               4      AND A
000AE5 4AE5 C9              10      RET
                                
       4AE6                     CAP:
000AE6 4AE6 FE61             7      CP  'a'
000AE8 4AE8 D8              11      RET C
000AE9 4AE9 FE7B             7      CP  'z'+1
000AEB 4AEB D0              11      RET NC
000AEC 4AEC D620             7      SUB 020H
000AEE 4AEE C9              10      RET
       4AEF                     CAP2:
000AEF 4AEF CDE64A          17      CALL    CAP
       4AF2                     CAP3:               ;
000AF2 4AF2 FE05             7      CP  5
000AF4 4AF4 2803            12      JR  Z,CAP4
000AF6 4AF6 FE21             7      CP  021H
000AF8 4AF8 C9              10      RET
       4AF9                     CAP4:
000AF9 4AF9 3EE5             7      LD  A,0E5H
000AFB 4AFB C9              10      RET
                                
       4AFC                     ROM_OPEN:
000AFC 4AFC CD1B4F          17      CALL    GET_DISK_BANK_FDRV
                                
000AFF 4AFF CD444D          17      CALL    GET_DIR_DAT
000B02 4B02 D5              11      PUSH    DE
000B03 4B03 CD184B          17      CALL    FILESE
000B06 4B06 D1              10      POP DE
000B07 4B07 3F               4      CCF
000B08 4B08 D8              11      RET C
000B09 4B09 224BF1          16      LD  (FCBX),HL
000B0C 4B0C E5              11      PUSH    HL
000B0D 4B0D 210000          10      LD  HL,0
000B10 4B10 2225F1          16      LD  (RR_LOW),HL
000B13 4B13 2227F1          16      LD  (RR_HIGH),HL
000B16 4B16 E1              10      POP HL
000B17 4B17 C9              10      RET
                                
       4B18                     FILESE:
000B18 4B18 7E               7      LD  A,(HL)
000B19 4B19 B7               4      OR  A
000B1A 4B1A C8              11      RET Z       ;END:ZF=1 CF=0
000B1B 4B1B FEE5             7      CP  0E5H
000B1D 4B1D 280D            12      JR  Z,FILESE1
000B1F 4B1F 1154F1          10      LD  DE,FNAME
000B22 4B22 E5              11      PUSH    HL
000B23 4B23 CD514B          17      CALL    CPFILE
000B26 4B26 CC724B          17      CALL    Z,CPFILE2
000B29 4B29 E1              10      POP HL
000B2A 4B2A 37               4      SCF
000B2B 4B2B C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4B2C                     FILESE1:
000B2C 4B2C CD344B          17      CALL    FNEXT
000B2F 4B2F 20E7            12      JR  NZ,FILESE
       4B31                     ZF0_CF0_AFF_RET:
000B31 4B31 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000B33 4B33 C9              10      RET
                                
       4B34                     FNEXT:
000B34 4B34 112000          10      LD  DE,020H
000B37 4B37 19              11      ADD HL,DE
000B38 4B38 0D               4      DEC C
                                #if exists USE_NORMAL_32K_ROM
                                #else
       4B39                     CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
000B39 4B39 F5              11      PUSH    AF
000B3A 4B3A CB7C             8      BIT 7,H
000B3C 4B3C 2811            12      JR  Z,CHECK_DIR_PAGE1
000B3E 4B3E 7C               4      LD  A,H
000B3F 4B3F D620             7      SUB 020H
000B41 4B41 67               4      LD  H,A
000B42 4B42 3A20F1          13      LD  A,(_BANK)
000B45 4B45 3C               4      INC A
000B46 4B46 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000B49 4B49 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000B4C 4B4C 3220F1          13      LD  (_BANK),A
       4B4F                     CHECK_DIR_PAGE1:
000B4F 4B4F F1              10      POP AF
                                #endif
000B50 4B50 C9              10      RET
                                
       4B51                     CPFILE:
000B51 4B51 C5              11      PUSH    BC
000B52 4B52 01000B          10      LD  BC,00B00H
       4B55                     CPSTR1:
000B55 4B55 1A               7      LD  A,(DE)
000B56 4B56 FE3F             7      CP  '?'     ;Wild card
000B58 4B58 2812            12      JR  Z,CPSTR2
000B5A 4B5A 7E               7      LD  A,(HL)
000B5B 4B5B CDCA4A          17      CALL    FKANC
000B5E 4B5E E5              11      PUSH    HL
000B5F 4B5F 67               4      LD  H,A
000B60 4B60 1A               7      LD  A,(DE)
000B61 4B61 CB01             4      RLC C
000B63 4B63 CDCA4A          17      CALL    FKANC
000B66 4B66 CB09             4      RRC C
000B68 4B68 BC               4      CP  H       ;CP (HL),(DE)
000B69 4B69 E1              10      POP HL
000B6A 4B6A 2004            12      JR  NZ,CPSTR3
       4B6C                     CPSTR2:
000B6C 4B6C 13               6      INC DE
000B6D 4B6D 23               6      INC HL
000B6E 4B6E 10E5            13      DJNZ    CPSTR1
       4B70                     CPSTR3:
000B70 4B70 C1              10      POP BC
000B71 4B71 C9              10      RET
                                
       4B72                     CPFILE2:
                                ;   LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
                                ;   OR  0E1H
000B72 4B72 3EE1             7      LD  A,0E1H
000B74 4B74 2F               4      CPL
000B75 4B75 A6               7      AND (HL)
000B76 4B76 C9              10      RET
                                
       4B77                     RBX1:
000B77 4B77 E5              11      PUSH    HL      ;Record byte
                                
000B78 4B78 ED5B25F1        20      LD  DE,(RR_LOW) ;CDE=Random record
000B7C 4B7C 3A28F1          13      LD  A,(RR_HIGH+1)
000B7F 4B7F 4F               4      LD  C,A
                                
000B80 4B80 CD1B4F          17      CALL    GET_DISK_BANK_FDRV
                                
000B83 4B83 FD2A4BF1        20      LD  IY,(FCBX)
000B87 4B87 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000B8A 4B8A FD661D          19      LD  H,(IY+01DH)
000B8D 4B8D FD7E1E          19      LD  A,(IY+01EH)
                                
000B90 4B90 A7               4      AND A
000B91 4B91 ED52            15      SBC HL,DE
000B93 4B93 99               4      SBC A,C
000B94 4B94 D1              10      POP DE
                                
000B95 4B95 D8              11      RET C
000B96 4B96 4F               4      LD  C,A
000B97 4B97 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000B98 4B98 B2               4      OR  D
000B99 4B99 B3               4      OR  E
000B9A 4B9A C0              11      RET NZ
000B9B 4B9B 37               4      SCF
000B9C 4B9C C9              10      RET
                                
       4B9D                     RBX2:
000B9D 4B9D ED4B26F1        20      LD  BC,(RR_LOW+1)
000BA1 4BA1 CD254C          17      CALL    RWXR
000BA4 4BA4 3A22F1          13      LD  A,(CLSZ_H)
000BA7 4BA7 3D               4      DEC A
000BA8 4BA8 E5              11      PUSH    HL
000BA9 4BA9 2A25F1          16      LD  HL,(RR_LOW)
000BAC 4BAC A4               4      AND H
000BAD 4BAD B5               4      OR  L
000BAE 4BAE E1              10      POP HL
000BAF 4BAF C9              10      RET
                                
       4BB0                     RBXA:
000BB0 4BB0 D5              11      PUSH    DE
000BB1 4BB1 CD944C          17      CALL    CLUST
000BB4 4BB4 ED532DF1        20      LD  (_DTPS),DE
000BB8 4BB8 D1              10      POP DE
000BB9 4BB9 CD714C          17      CALL    GNCL
000BBC 4BBC D8              11      RET C
000BBD 4BBD ED5329F1        20      LD  (_CLPS),DE
                                
000BC1 4BC1 ED4B25F1        20      LD  BC,(RR_LOW)
000BC5 4BC5 2A21F1          16      LD  HL,(CLSZ)
000BC8 4BC8 7C               4      LD  A,H
000BC9 4BC9 3D               4      DEC A
000BCA 4BCA A0               4      AND B
000BCB 4BCB 47               4      LD  B,A
000BCC 4BCC ED42            15      SBC HL,BC       ;remaining cluster
                                
000BCE 4BCE ED5B4DF1        20      LD  DE,(LEFTX)
000BD2 4BD2 ED52            15      SBC HL,DE       ;CP HL,DE
000BD4 4BD4 19              11      ADD HL,DE
000BD5 4BD5 3801            12      JR  C,RBXA1
000BD7 4BD7 EB               4      EX  DE,HL
       4BD8                     RBXA1:
000BD8 4BD8 3A20F1          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
000BDB 4BDB 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000BDE 4BDE 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000BE1 4BE1 E5              11      PUSH    HL
000BE2 4BE2 2A2DF1          16      LD  HL,(_DTPS)
000BE5 4BE5 09              11      ADD HL,BC
000BE6 4BE6 ED5B47F1        20      LD  DE,(DTAX)
000BEA 4BEA C1              10      POP BC
000BEB 4BEB C9              10      RET
                                
       4BEC                     RBXB:
000BEC 4BEC 2A47F1          16      LD  HL,(DTAX)
000BEF 4BEF ED5B29F1        20      LD  DE,(_CLPS)
000BF3 4BF3 3A4EF1          13      LD  A,(LEFTX+1)
000BF6 4BF6 47               4      LD  B,A
000BF7 4BF7 3A22F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4BFA                     RBXB1:
000BFA 4BFA 1F               4      RRA     ;->CF
000BFB 4BFB 3804            12      JR  C,RBXB2
000BFD 4BFD CB38             8      SRL B   ;B=B/2
000BFF 4BFF 18F9            12      JR  RBXB1
       4C01                     RBXB2:
000C01 4C01 78               4      LD  A,B
000C02 4C02 B7               4      OR  A
000C03 4C03 C9              10      RET
                                
       4C04                     RBXC:
000C04 4C04 ED4B4DF1        20      LD  BC,(LEFTX)
000C08 4C08 3A22F1          13      LD  A,(CLSZ_H)
000C0B 4C0B 3D               4      DEC A
000C0C 4C0C A0               4      AND B
000C0D 4C0D 47               4      LD  B,A
000C0E 4C0E B1               4      OR  C
000C0F 4C0F C9              10      RET
                                
       4C10                     RBXEND:
000C10 4C10 ED5B2BF1        20      LD  DE,(_LEFT)
000C14 4C14 2A25F1          16      LD  HL,(RR_LOW)
000C17 4C17 3A28F1          13      LD  A,(RR_HIGH+1)
000C1A 4C1A 19              11      ADD HL,DE
000C1B 4C1B CE00             7      ADC A,0
000C1D 4C1D 2225F1          16      LD  (RR_LOW),HL
000C20 4C20 3228F1          13      LD  (RR_HIGH+1),A
000C23 4C23 EB               4      EX  DE,HL       ;HL=Read byte
000C24 4C24 C9              10      RET 
                                
       4C25                     RWXR:
000C25 4C25 3A22F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4C28                     L_RWX:
000C28 4C28 1F               4      RRA     ;->CF
000C29 4C29 3806            12      JR  C,E_RWX
000C2B 4C2B CB38             8      SRL B   ;BC=BC/2
000C2D 4C2D CB19             8      RR  C   ;
000C2F 4C2F 18F7            12      JR  L_RWX
       4C31                     E_RWX:
000C31 4C31 CD1B4F          17      CALL    GET_DISK_BANK_FDRV
                                
000C34 4C34 FD2A4BF1        20      LD  IY,(FCBX)
000C38 4C38 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000C3B 4C3B FD561B          19      LD  D,(IY+01BH)
       4C3E                     RWX1:
000C3E 4C3E ED5329F1        20      LD  (_CLPS),DE
000C42 4C42 7A               4      LD  A,D
000C43 4C43 B3               4      OR  E
000C44 4C44 37               4      SCF
000C45 4C45 C8              11      RET Z
                                
000C46 4C46 78               4      LD  A,B
000C47 4C47 B1               4      OR  C
000C48 4C48 C8              11      RET Z
                                
000C49 4C49 CD714C          17      CALL    GNCL
000C4C 4C4C D8              11      RET C
000C4D 4C4D 0B               6      DEC BC
000C4E 4C4E CDDD4C          17      CALL    ENDCL
000C51 4C51 38EB            12      JR  C,RWX1
000C53 4C53 37               4      SCF
000C54 4C54 C9              10      RET
                                
       4C55                     NCL3:
000C55 4C55 CD1B4F          17      CALL    GET_DISK_BANK_FDRV
000C58 4C58 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C5B 4C5B 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000C5E 4C5E 6B               4      LD  L,E
000C5F 4C5F 62               4      LD  H,D
000C60 4C60 CB3C             8      SRL H
000C62 4C62 CB1D             8      RR  L
000C64 4C64 1F               4      RRA
000C65 4C65 19              11      ADD HL,DE
000C66 4C66 010060          10      LD  BC,BANK1_ADR
000C69 4C69 09              11      ADD HL,BC
000C6A 4C6A ED4B23F1        20      LD  BC,(SECSZ)
000C6E 4C6E 09              11      ADD HL,BC
000C6F 4C6F 17               4      RLA
000C70 4C70 C9              10      RET
                                
       4C71                     GNCL:
000C71 4C71 7A               4      LD  A,D
000C72 4C72 B3               4      OR  E
000C73 4C73 37               4      SCF
000C74 4C74 C8              11      RET Z
000C75 4C75 C5              11      PUSH    BC
000C76 4C76 E5              11      PUSH    HL
000C77 4C77 CD554C          17      CALL    NCL3
000C7A 4C7A 3809            12      JR  C,GNC1
000C7C 4C7C 5E               7      LD  E,(HL)
000C7D 4C7D 23               6      INC HL
000C7E 4C7E 7E               7      LD  A,(HL)
000C7F 4C7F E60F             7      AND 00FH
000C81 4C81 57               4      LD  D,A
000C82 4C82 E1              10      POP HL
000C83 4C83 C1              10      POP BC
000C84 4C84 C9              10      RET
       4C85                     GNC1:
000C85 4C85 7E               7      LD  A,(HL)
000C86 4C86 23               6      INC HL
000C87 4C87 56               7      LD  D,(HL)
000C88 4C88 0604             7      LD  B,4
       4C8A                     GNC1L:
000C8A 4C8A CB3A             8      SRL D
000C8C 4C8C 1F               4      RRA
000C8D 4C8D 10FB            13      DJNZ    GNC1L
                                
000C8F 4C8F 5F               4      LD  E,A
000C90 4C90 E1              10      POP HL
000C91 4C91 C1              10      POP BC
000C92 4C92 A7               4      AND A
000C93 4C93 C9              10      RET
                                
       4C94                     CLUST:
000C94 4C94 EB               4      EX  DE,HL
000C95 4C95 C5              11      PUSH    BC
000C96 4C96 3A22F1          13      LD  A,(CLSZ_H)
000C99 4C99 CD474F          17      CALL    MUL_AHL
                                
000C9C 4C9C CD544D          17      CALL    GET_DIR_POS
000C9F 4C9F 4F               4      LD  C,A
000CA0 4CA0 0600             7      LD  B,0
000CA2 4CA2 09              11      ADD HL,BC
                                
000CA3 4CA3 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000CA6 4CA6 0F               4      RRCA
000CA7 4CA7 0F               4      RRCA
000CA8 4CA8 0F               4      RRCA
000CA9 4CA9 0F               4      RRCA
000CAA 4CAA 4F               4      LD  C,A
                                
000CAB 4CAB 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000CAE 4CAE FE02             7      CP  2
000CB0 4CB0 280C            12      JR  Z,CLUST1
000CB2 4CB2 CB01             4      RLC C
000CB4 4CB4 0D               4      DEC C
000CB5 4CB5 3A0C60          13      LD  A,(BANK1_ADR+11+1)  ;BPB_BytsPerSec High    
000CB8 4CB8 FE02             7      CP  2
000CBA 4CBA 2002            12      JR  NZ,CLUST1
000CBC 4CBC 0D               4      DEC C
000CBD 4CBD 0D               4      DEC C
       4CBE                     CLUST1:
000CBE 4CBE 0D               4      DEC C
000CBF 4CBF 09              11      ADD HL,BC
                                
                                #if exists USE_NORMAL_32K_ROM
                                    LD  A,L
                                #else
000CC0 4CC0 E5              11      PUSH    HL
000CC1 4CC1 29              11      ADD HL,HL   ;*2
000CC2 4CC2 29              11      ADD HL,HL   ;*4
000CC3 4CC3 29              11      ADD HL,HL   ;*8
000CC4 4CC4 CD1B4F          17      CALL    GET_DISK_BANK_FDRV
000CC7 4CC7 84               4      ADD A,H
000CC8 4CC8 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000CCB 4CCB 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000CCE 4CCE 3220F1          13      LD  (_BANK),A
000CD1 4CD1 E1              10      POP HL
000CD2 4CD2 3E1F             7      LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
000CD4 4CD4 A5               4      AND L
                                #endif
000CD5 4CD5 C660             7      ADD A,high BANK1_ADR
000CD7 4CD7 67               4      LD  H,A
000CD8 4CD8 2E00             7      LD  L,0
000CDA 4CDA EB               4      EX  DE,HL
000CDB 4CDB C1              10      POP BC
000CDC 4CDC C9              10      RET
                                
       4CDD                     ENDCL:
000CDD 4CDD 7A               4      LD  A,D ;END CLUSTER
000CDE 4CDE FE0F             7      CP  00FH    ;FAT12の最大値
000CE0 4CE0 C0              11      RET NZ
000CE1 4CE1 7B               4      LD  A,E
000CE2 4CE2 FEF7             7      CP  0F7H
000CE4 4CE4 C9              10      RET
                                
       4CE5                     RB_READ:
000CE5 4CE5 AF               4      XOR A   ;HLA = HL*128
000CE6 4CE6 CB3C             8      SRL H
000CE8 4CE8 CB1D             8      RR  L
000CEA 4CEA 1F               4      RRA
000CEB 4CEB 3225F1          13      LD  (RR_LOW),A
000CEE 4CEE 2226F1          16      LD  (RR_MID),HL
000CF1 4CF1 218000          10      LD  HL,128
                                
000CF4 4CF4 CD1C49          17      CALL    ROM_READ
000CF7 4CF7 C9              10      RET
                                
       4CF8                     GETSEQ:
000CF8 4CF8 FD6E20          19      LD  L,(IY+32)
000CFB 4CFB FD660C          19      LD  H,(IY+12)
                                
000CFE 4CFE CB25             8      SLA L
                                
000D00 4D00 CB3C             8      SRL H
000D02 4D02 CB1D             8      RR  L
000D04 4D04 C9              10      RET
                                
       4D05                     SETSEQ:
000D05 4D05 F5              11      PUSH    AF
000D06 4D06 3A25F1          13      LD  A,(RR_LOW)
000D09 4D09 2A26F1          16      LD  HL,(RR_MID)
                                
000D0C 4D0C CD234D          17      CALL    SSQ1
                                
000D0F 4D0F 29              11      ADD HL,HL
000D10 4D10 CB3D             8      SRL L
000D12 4D12 FD7520          19      LD  (IY+32),L
000D15 4D15 FD740C          19      LD  (IY+12),H
000D18 4D18 F1              10      POP AF
000D19 4D19 C9              10      RET
                                
       4D1A                     GETSIZE:
000D1A 4D1A FD7E10          19      LD  A,(IY+16)
000D1D 4D1D FD6E11          19      LD  L,(IY+17)
000D20 4D20 FD6612          19      LD  H,(IY+18)
       4D23                     SSQ1:
000D23 4D23 87               4      ADD A,A
000D24 4D24 ED6A            15      ADC HL,HL
000D26 4D26 B7               4      OR  A
000D27 4D27 C8              11      RET Z
000D28 4D28 23               6      INC HL
000D29 4D29 C9              10      RET
                                
       4D2A                     SET_FCB:
000D2A 4D2A D5              11      PUSH    DE
000D2B 4D2B FDE1            14      POP IY
000D2D 4D2D FD7E1C          19      LD  A,(IY+28)
000D30 4D30 FEFF             7      CP  0FFH
000D32 4D32 200C            12      JR  NZ,POPAF_SCF_FF_RET
000D34 4D34 E5              11      PUSH    HL
000D35 4D35 FD6E1A          19      LD  L,(IY+26)
000D38 4D38 FD661B          19      LD  H,(IY+27)
000D3B 4D3B 2229F1          16      LD  (_CLPS),HL
000D3E 4D3E E1              10      POP HL
000D3F 4D3F C9              10      RET
                                
       4D40                     POPAF_SCF_FF_RET:
000D40 4D40 F1              10      POP AF
000D41 4D41 37               4      SCF
000D42 4D42 9F               4      SBC A,A
000D43 4D43 C9              10      RET
                                
       4D44                     GET_DIR_DAT:
000D44 4D44 CD544D          17      CALL    GET_DIR_POS
000D47 4D47 C660             7      ADD A,high BANK1_ADR
000D49 4D49 2E00             7      LD  L,0
000D4B 4D4B 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_NORMAL_32K_ROM
                                #else
000D4C 4D4C CD394B          17      CALL    CHECK_DIR_PAGE
                                #endif
000D4F 4D4F 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000D52 4D52 4F               4      LD  C,A
000D53 4D53 C9              10      RET
                                
       4D54                     GET_DIR_POS:
000D54 4D54 CD1B4F          17      CALL    GET_DISK_BANK_FDRV
000D57 4D57 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D5A 4D5A 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D5D 4D5D 3220F1          13      LD  (_BANK),A
000D60 4D60 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000D63 4D63 47               4      LD  B,A
000D64 4D64 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000D67 4D67 4F               4      LD  C,A
000D68 4D68 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4D6B                     GET_DIR_POS1:
000D6B 4D6B 81               4      ADD A,C
000D6C 4D6C 10FD            13      DJNZ    GET_DIR_POS1
                                
000D6E 4D6E ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec 
       4D72                     L_MDP:
000D72 4D72 CB18             8      RR  B   ;->CF
000D74 4D74 D8              11      RET C
000D75 4D75 87               4      ADD A,A
000D76 4D76 18FA            12      JR  L_MDP
                                
       4D78                     WILDCARD:
000D78 4D78 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4D83                     ERROR_WRITE_PROTECTED:
000D83 4D83 3E00             7      LD  A,0     ;Write protected
000D85 4D85 C9              10      RET
       4D86                     DISKIO:
000D86 4D86 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000D88 4D88 48               4      LD  C,B
000D89 4D89 CD254F          17      CALL    GET_DISK_BANK
       4D8C                     SETMAP1:        
000D8C 4D8C E5              11      PUSH    HL
       4D8D                     DISKIO1:
000D8D 4D8D C5              11      PUSH    BC      ;B=残りのセクタ数
000D8E 4D8E D5              11      PUSH    DE      ;DE=セクタ番号
000D8F 4D8F F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
000D90 4D90 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
000D91 4D91 F5              11      PUSH    AF
000D92 4D92 3A24F1          13      LD  A,(SECSZ_H)
000D95 4D95 CD474F          17      CALL    MUL_AHL
000D98 4D98 F1              10      POP AF
000D99 4D99 4D               4      LD  C,L     ;C=読み出し元
000D9A 4D9A 29              11      ADD HL,HL       ;64KB→32KB
000D9B 4D9B 29              11      ADD HL,HL       ;32KB→16KB
000D9C 4D9C 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
000D9D 4D9D 84               4      ADD A,H
000D9E 4D9E 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000DA1 4DA1 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000DA4 4DA4 3220F1          13      LD  (_BANK),A
000DA7 4DA7 79               4      LD  A,C     ;C=読み出し元
000DA8 4DA8 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
000DAA 4DAA C660             7      ADD A,high BANK1_ADR
000DAC 4DAC 67               4      LD  H,A
000DAD 4DAD ED4B23F1        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
000DB1 4DB1 69               4      LD  L,C     ;C=0
000DB2 4DB2 EDB0                    LDIR
000DB4 4DB4 EB               4      EX  DE,HL
000DB5 4DB5 F1              10      POP AF
000DB6 4DB6 D1              10      POP DE
000DB7 4DB7 13               6      INC DE
000DB8 4DB8 C1              10      POP BC
000DB9 4DB9 10D2            13      DJNZ    DISKIO1
000DBB 4DBB 41               4      LD  B,C
                                
000DBC 4DBC E1              10      POP HL
000DBD 4DBD AF               4      XOR A
000DBE 4DBE FB               4      EI
000DBF 4DBF C9              10      RET
                                
       4DC0                     DSKCHG:
000DC0 4DC0 CDF94D          17      CALL    IS_BPB
000DC3 4DC3 3824            12      JR  C,NOTREADY
000DC5 4DC5 3A23FB          13      LD  A,(DRVTBL+2)
000DC8 4DC8 B7               4      OR  A
000DC9 4DC9 201A            12      JR  NZ,DSKCHG1
000DCB 4DCB 3A21FB          13      LD  A,(DRVTBL)
000DCE 4DCE FE02             7      CP  2
000DD0 4DD0 2013            12      JR  NZ,DSKCHG1
000DD2 4DD2 CDF94D          17      CALL    IS_BPB
000DD5 4DD5 300E            12      JR  NC,DSKCHG1
000DD7 4DD7 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000DD9 4DD9 3221FB          13      LD  (DRVTBL),A
000DDC 4DDC 3223FB          13      LD  (DRVTBL+2),A
000DDF 4DDF 3A48F3          13      LD  A,(MASTERS)
000DE2 4DE2 3224FB          13      LD  (DRVTBL+3),A
       4DE5                     DSKCHG1:
000DE5 4DE5 AF               4      XOR A
000DE6 4DE6 0601             7      LD  B,1
000DE8 4DE8 C9              10      RET
       4DE9                     NOTREADY:
000DE9 4DE9 3E02             7      LD  A,2
000DEB 4DEB 37               4      SCF
000DEC 4DEC C9              10      RET
                                
       4DED                     NO_BPB:
000DED 4DED E1              10      POP HL
000DEE 4DEE 23               6      INC HL
000DEF 4DEF 114C4F          10      LD  DE,DPB2DD
000DF2 4DF2 011200          10      LD  BC,DPB2DD_E-DPB2DD
000DF5 4DF5 EDB0                    LDIR
000DF7 4DF7 AF               4      XOR A
000DF8 4DF8 C9              10      RET
                                
       4DF9                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000DF9 4DF9 CD254F          17      CALL    GET_DISK_BANK
                                
000DFC 4DFC 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000DFF 4DFF FE01             7      CP  1
000E01 4E01 D8              11      RET C
                                
000E02 4E02 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000E05 4E05 C6FF             7      ADD A,0FFH
000E07 4E07 D8              11      RET C
                                
000E08 4E08 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
000E0B 4E0B FE01             7      CP  1
000E0D 4E0D C8              11      RET Z
000E0E 4E0E FE02             7      CP  2
000E10 4E10 C8              11      RET Z
000E11 4E11 FE04             7      CP  4
000E13 4E13 C8              11      RET Z
000E14 4E14 37               4      SCF
000E15 4E15 C9              10      RET
                                
       4E16                     GETDPB:
000E16 4E16 E5              11      PUSH    HL
000E17 4E17 CD254F          17      CALL    GET_DISK_BANK
                                
000E1A 4E1A 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000E1D 4E1D B7               4      OR  A
000E1E 4E1E 28CD            12      JR  Z,NO_BPB
000E20 4E20 DDE1            14      POP IX
000E22 4E22 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000E25 4E25 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000E28 4E28 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000E2B 4E2B 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000E2E 4E2E DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000E31 4E31 87               4      ADD A,A
000E32 4E32 87               4      ADD A,A
000E33 4E33 87               4      ADD A,A
000E34 4E34 3D               4      DEC A
000E35 4E35 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000E38 4E38 06FF             7      LD  B,-1
000E3A 4E3A A7               4      AND A           ;無限ループ阻止
       4E3B                     GETDPB1:
000E3B 4E3B 04               4      INC B
000E3C 4E3C 1F               4      RRA
000E3D 4E3D 38FC            12      JR  C,GETDPB1
000E3F 4E3F DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000E42 4E42 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000E45 4E45 3D               4      DEC A
000E46 4E46 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000E49 4E49 A7               4      AND A           ;無限ループ阻止
000E4A 4E4A 06FF             7      LD  B,-1
       4E4C                     GETDPB2:
000E4C 4E4C 04               4      INC B
000E4D 4E4D 1F               4      RRA
000E4E 4E4E 38FC            12      JR  C,GETDPB2
000E50 4E50 04               4      INC B
000E51 4E51 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000E54 4E54 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
000E57 4E57 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
000E5A 4E5A DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
000E5D 4E5D 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
000E60 4E60 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000E63 4E63 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
000E66 4E66 DD770B          19      LD  (IX+11),A       ;FATCNT
                                
000E69 4E69 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
000E6D 4E6D DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
000E70 4E70 DD460A          19      LD  B,(IX+10)       ;FATCNT
000E73 4E73 210000          10      LD  HL,0
       4E76                     GETDPB3:
000E76 4E76 19              11      ADD HL,DE
000E77 4E77 10FD            13      DJNZ    GETDPB3
       4E79                     GETDPB4:
000E79 4E79 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
000E7C 4E7C DD5609          19      LD  D,(IX+9)        ;FIRFAT
000E7F 4E7F 19              11      ADD HL,DE
000E80 4E80 DD7511          19      LD  (IX+17),L       ;FIRDIR
000E83 4E83 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000E86 4E86 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000E89 4E89 87               4      ADD A,A
000E8A 4E8A 87               4      ADD A,A
000E8B 4E8B DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4E8E                     GETDPB5:
000E8E 4E8E CB3B             8      SRL E
000E90 4E90 1F               4      RRA
000E91 4E91 30FB            12      JR  NC,GETDPB5
000E93 4E93 1600             7      LD  D,0
000E95 4E95 19              11      ADD HL,DE
000E96 4E96 DD750C          19      LD  (IX+12),L       ;FIRREC
000E99 4E99 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000E9C 4E9C 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
000E9F 4E9F DD5E0C          19      LD  E,(IX+12)       ;FIRREC
000EA2 4EA2 DD560D          19      LD  D,(IX+13)       ;FIRREC
000EA5 4EA5 A7               4      AND A
000EA6 4EA6 ED52            15      SBC HL,DE
                                
000EA8 4EA8 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
000EAB 4EAB 3C               4      INC A
000EAC 4EAC 37               4      SCF             ;無限ループ阻止
       4EAD                     GETDPB6:
000EAD 4EAD 1F               4      RRA
000EAE 4EAE 3806            12      JR  C,GETDPB7
000EB0 4EB0 CB3C             8      SRL H
000EB2 4EB2 CB1D             8      RR  L
000EB4 4EB4 18F7            12      JR  GETDPB6
       4EB6                     GETDPB7:
000EB6 4EB6 23               6      INC HL
000EB7 4EB7 DD750E          19      LD  (IX+14),L       ;MAXCLUS
000EBA 4EBA DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       4EBD                     GETDPBD1:
000EBD 4EBD DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000EC0 4EC0 E6FC             7      AND 0FCH
000EC2 4EC2 C8              11      RET Z
                                
000EC3 4EC3 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
000EC7 4EC7 37               4      SCF
000EC8 4EC8 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
000ECC 4ECC DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
000ECF 4ECF DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
000ED3 4ED3 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
000ED7 4ED7 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
000EDB 4EDB DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
000EDF 4EDF DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
000EE3 4EE3 DDCB1126        23      SLA (IX+17)         ;FIRDIR
000EE7 4EE7 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
000EEB 4EEB DD6E11          19      LD  L,(IX+17)       ;FIRDIR
000EEE 4EEE DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
000EF1 4EF1 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000EF4 4EF4 87               4      ADD A,A
000EF5 4EF5 87               4      ADD A,A
000EF6 4EF6 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4EF9                     GETDPBD5:
000EF9 4EF9 CB3B             8      SRL E
000EFB 4EFB 1F               4      RRA
000EFC 4EFC 30FB            12      JR  NC,GETDPBD5
000EFE 4EFE 1600             7      LD  D,0
000F00 4F00 19              11      ADD HL,DE
000F01 4F01 DD750C          19      LD  (IX+12),L       ;FIRREC
000F04 4F04 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000F07 4F07 18B4            12      JR  GETDPBD1
                                
       4F09                     CHOICE:
000F09 4F09 210000          10      LD  HL,0
000F0C 4F0C C9              10      RET
                                
       4F0D                     DSKFMT:
000F0D 4F0D AF               4      XOR A
000F0E 4F0E 37               4      SCF
       4F0F                     DSKSTP:
000F0F 4F0F C9              10      RET
                                
       4F10                     BASENT:
000F10 4F10 ED7B5FF1        20      LD  SP,(BASSTK)
000F14 4F14 C3D643          10      JP  BASAUTO
                                
       4F17                     GETSLT:
000F17 4F17 3A22FB          13      LD  A,(DRVTBL+1)
000F1A 4F1A C9              10      RET
                                
       4F1B                     GET_DISK_BANK_FDRV:
000F1B 4F1B 3A53F1          13      LD  A,(FDRV)
000F1E 4F1E D601             7      SUB 1
000F20 4F20 3003            12      JR  NC,GET_DISK_BANK
000F22 4F22 3A4AF1          13      LD  A,(_DVSW)
       4F25                     GET_DISK_BANK:
000F25 4F25 B7               4      OR  A       ;A=DRIVE
000F26 4F26 3E01             7      LD  A,DISK_BANK
000F28 4F28 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
000F2A 4F2A 3A49F1          13      LD  A,(B_DRIVE)
                                #endif
       4F2D                     SET_DISK_BANK:
000F2D 4F2D 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000F30 4F30 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000F33 4F33 F5              11      PUSH    AF
000F34 4F34 E5              11      PUSH    HL
000F35 4F35 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
000F38 4F38 2223F1          16      LD  (SECSZ),HL
000F3B 4F3B 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000F3E 4F3E CD474F          17      CALL    MUL_AHL
000F41 4F41 2221F1          16      LD  (CLSZ),HL
000F44 4F44 E1              10      POP HL
000F45 4F45 F1              10      POP AF
000F46 4F46 C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)
       4F47                     MUL_AHL:
000F47 4F47 1F               4      RRA     ;->CF
000F48 4F48 D8              11      RET C
000F49 4F49 29              11      ADD HL,HL
000F4A 4F4A 18FB            12      JR  MUL_AHL
                                
       4F4C                     DPB2DD:
000F4C 4F4C F9                      DB  0F9H    ;MEDIA
000F4D 4F4D 0002                    DW  00200H  ;SECSIZ
000F4F 4F4F 0F                      DB  00FH    ;DIRMSK
000F50 4F50 04                      DB  004H    ;DIRSHFT
000F51 4F51 01                      DB  001H    ;CLUSMSK
000F52 4F52 02                      DB  002H    ;CLUSSHFT
000F53 4F53 0100                    DW  00001H  ;FIRFAT
000F55 4F55 02                      DB  002H    ;FATCNT
000F56 4F56 70                      DB  070H    ;MAXENT
000F57 4F57 0E00                    DW  0000EH  ;FIRREC
000F59 4F59 CA02                    DW  002CAH  ;MAXCLUS
000F5B 4F5B 03                      DB  003H    ;FATSIZ
000F5C 4F5C 0700                    DW  0007H   ;FIRDIR
       4F5E                     DPB2DD_E:
                                
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       4F5E                     POP_HL_ERROR:
000F5E 4F5E E1              10      POP     HL
       4F5F                     _ERROR:
000F5F 4F5F 0600             7      LD  B,0
000F61 4F61 A7               4      AND A
000F62 4F62 C9              10      RET
                                
       4F63                     ROM_BDOS:
000F63 4F63 E5              11      PUSH    HL
000F64 4F64 79               4      LD  A,C
000F65 4F65 87               4      ADD A,A
000F66 4F66 38F7            12      JR  C,_ERROR
000F68 4F68 6F               4      LD  L,A
000F69 4F69 265F             7      LD  H,high STABLE
000F6B 4F6B 7E               7      LD  A,(HL)
000F6C 4F6C 2C               4      INC L
000F6D 4F6D 66               7      LD  H,(HL)
000F6E 4F6E 6F               4      LD  L,A
000F6F 4F6F E3              19      EX  (SP),HL
000F70 4F70 79               4      LD  A,C
000F71 4F71 C9              10      RET
                                
       4F72                     _PRINT:
       4F72                     PRINT:
000F72 4F72 7B               4      LD  A,E
000F73 4F73 1803            12      JR  MSG_A
                                
       4F75                     _SYS01:     ;(BDOS)コンソール入力
000F75 4F75 CDEC4F          17      CALL    _SYS07
       4F78                     MSG_A:
000F78 4F78 FE03             7      CP  3
000F7A 4F7A 2814            12      JR  Z,MSG_BR
       4F7C                     MSGA1:
000F7C 4F7C F5              11      PUSH    AF
000F7D 4F7D C5              11      PUSH    BC
000F7E 4F7E D5              11      PUSH    DE
000F7F 4F7F E5              11      PUSH    HL
000F80 4F80 DDE5            15      PUSH    IX
000F82 4F82 DD21A200        14      LD  IX,CHPUT
000F86 4F86 CDFD42          17      CALL    CALSLT_R
000F89 4F89 DDE1            14      POP IX
000F8B 4F8B E1              10      POP HL
000F8C 4F8C D1              10      POP DE
000F8D 4F8D C1              10      POP BC
       4F8E                     MSGA2:
000F8E 4F8E F1              10      POP AF
000F8F 4F8F C9              10      RET
       4F90                     MSG_BR:
000F90 4F90 F5              11      PUSH    AF
000F91 4F91 3ADDF3          13      LD  A,(CSRX)
000F94 4F94 FE02             7      CP  2
000F96 4F96 38F6            12      JR  C,MSGA2
000F98 4F98 F1              10      POP AF
       4F99                     MSG_CR:
000F99 4F99 F5              11      PUSH    AF
000F9A 4F9A 3E0D             7      LD  A,00DH
000F9C 4F9C CD7C4F          17      CALL    MSGA1
000F9F 4F9F 3E0A             7      LD  A,00AH
000FA1 4FA1 CD7C4F          17      CALL    MSGA1
000FA4 4FA4 F1              10      POP AF
000FA5 4FA5 C9              10      RET
                                
       4FA6                     _SYS02:     ;(BDOS)コンソール出力
000FA6 4FA6 CDC14F          17      CALL    BREAK
000FA9 4FA9 1805            12      JR  PRINTX
                                
       4FAB                     _SYS06:     ;(BDOS)コンソール直接入出力
000FAB 4FAB 7B               4      LD  A,E
000FAC 4FAC 3C               4      INC A
000FAD 4FAD CA0050          10      JP  Z,_INKEY
       4FB0                     PRINTX:
000FB0 4FB0 C3724F          10      JP  _PRINT
                                
       4FB3                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000FB3 4FB3 CDEC4F          17      CALL    _SYS07
000FB6 4FB6 FE03             7      CP  3
000FB8 4FB8 CCC14F          17      CALL    Z,_BREAK
000FBB 4FBB FE13             7      CP  013H        ;CTRL+S
000FBD 4FBD C0              11      RET NZ
       4FBE                     PAUSE:
000FBE 4FBE CDD84F          17      CALL    KEYBC
                                
       4FC1                     _BREAK:
       4FC1                     BREAK:
000FC1 4FC1 F5              11      PUSH    AF
000FC2 4FC2 C5              11      PUSH    BC
000FC3 4FC3 D5              11      PUSH    DE
000FC4 4FC4 E5              11      PUSH    HL
000FC5 4FC5 DDE5            15      PUSH    IX
000FC7 4FC7 DD21B700        14      LD  IX,BREAKX
000FCB 4FCB CDFD42          17      CALL    CALSLT_R
000FCE 4FCE DDE1            14      POP IX
000FD0 4FD0 E1              10      POP HL
000FD1 4FD1 D1              10      POP DE
000FD2 4FD2 C1              10      POP BC
000FD3 4FD3 DCC14F          17      CALL    C,_BREAK
000FD6 4FD6 F1              10      POP AF
000FD7 4FD7 C9              10      RET
       4FD8                     KEYBC:
000FD8 4FD8 F5              11      PUSH    AF
000FD9 4FD9 C5              11      PUSH    BC
000FDA 4FDA D5              11      PUSH    DE
000FDB 4FDB E5              11      PUSH    HL
000FDC 4FDC DDE5            15      PUSH    IX
000FDE 4FDE DD215601        14      LD  IX,KILBUF
000FE2 4FE2 CDFD42          17      CALL    CALSLT_R
000FE5 4FE5 DDE1            14      POP IX
000FE7 4FE7 E1              10      POP HL
000FE8 4FE8 D1              10      POP DE
000FE9 4FE9 C1              10      POP BC
000FEA 4FEA F1              10      POP AF
000FEB 4FEB C9              10      RET
                                
       4FEC                     _SYS07:
       4FEC                     FLGET:
000FEC 4FEC C5              11      PUSH    BC
000FED 4FED D5              11      PUSH    DE
000FEE 4FEE E5              11      PUSH    HL
000FEF 4FEF DDE5            15      PUSH    IX
000FF1 4FF1 DD219F00        14      LD  IX,CHGET
000FF5 4FF5 CDFD42          17      CALL    CALSLT_R
000FF8 4FF8 DDE1            14      POP IX
000FFA 4FFA E1              10      POP HL
000FFB 4FFB D1              10      POP DE
000FFC 4FFC C1              10      POP BC
000FFD 4FFD FE03             7      CP  3
000FFF 4FFF C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       5000                     _INKEY:
       5000                     INKEY:
001000 5000 CD9A50          17      CALL    CPM_CONST
001003 5003 C8              11      RET Z
001004 5004 18E6            12      JR  FLGET
                                
       5006                     _SYS0A:     ;(BDOS)文字列入力
001006 5006 C5              11      PUSH    BC
001007 5007 E5              11      PUSH    HL
001008 5008 D5              11      PUSH    DE
001009 5009 CD3250          17      CALL    GETL
00100C 500C 111FF4          10      LD  DE,KBUF
00100F 500F E1              10      POP HL
001010 5010 E5              11      PUSH    HL
001011 5011 0E00             7      LD  C,0
001013 5013 3004            12      JR  NC,SAX0
001015 5015 23               6      INC HL
001016 5016 23               6      INC HL
001017 5017 1808            12      JR  SAX4
       5019                     SAX0:
001019 5019 46               7      LD  B,(HL)
00101A 501A 23               6      INC HL
       501B                     SAX1:
00101B 501B 23               6      INC HL
00101C 501C 1A               7      LD  A,(DE)
00101D 501D 13               6      INC DE
00101E 501E B7               4      OR  A
00101F 501F 2004            12      JR  NZ,SAX2
       5021                     SAX4:
001021 5021 360D            10      LD  (HL),00DH
001023 5023 1804            12      JR  SAX3
       5025                     SAX2:
001025 5025 77               7      LD  (HL),A
001026 5026 0C               4      INC C
001027 5027 10F2            13      DJNZ    SAX1
       5029                     SAX3:
001029 5029 D1              10      POP DE
00102A 502A 79               4      LD  A,C
00102B 502B 13               6      INC DE
00102C 502C 12               7      LD  (DE),A
00102D 502D 1B               6      DEC DE
00102E 502E E1              10      POP HL
00102F 502F C1              10      POP BC
001030 5030 A7               4      AND A
001031 5031 C9              10      RET
       5032                     GETL:
001032 5032 DDE5            15      PUSH    IX
001034 5034 FDE5            15      PUSH    IY
                                
001036 5036 2ADCF3          16      LD  HL,(CSRY)
001039 5039 22CAFB          16      LD  (FSTPOS),HL
       503C                     GETL1:
00103C 503C CDB34F          17      CALL    _SYS08
00103F 503F FE09             7      CP  9
001041 5041 2008            12      JR  NZ,GETL1V
001043 5043 211FF4          10      LD  HL,KBUF
001046 5046 CD8843          17      CALL    MSX
001049 5049 18F1            12      JR  GETL1
       504B                     GETL1V:
00104B 504B 5F               4      LD  E,A
00104C 504C FE08             7      CP  8
00104E 504E CCE850          17      CALL    Z,CTRL02
001051 5051 FE20             7      CP  020H
001053 5053 D41451          17      CALL    NC,INSERT
001056 5056 CD7C4F          17      CALL    MSGA1
                                
001059 5059 7B               4      LD  A,E
00105A 505A FE0D             7      CP  00DH
00105C 505C 20DE            12      JR  NZ,GETL1
                                
00105E 505E 111FF4          10      LD  DE,KBUF
001061 5061 3AB0F3          13      LD  A,(LINLEN)
001064 5064 47               4      LD  B,A
001065 5065 CDC752          17      CALL    ZERO_MEMORY_DE
                                
001068 5068 2ACAFB          16      LD  HL,(FSTPOS)
00106B 506B 3ADCF3          13      LD  A,(CSRY)
00106E 506E 6F               4      LD  L,A
00106F 506F E5              11      PUSH    HL
001070 5070 CD4551          17      CALL    LOC0
001073 5073 4D               4      LD  C,L
001074 5074 44               4      LD  B,H
001075 5075 E1              10      POP HL
001076 5076 3AB0F3          13      LD  A,(LINLEN)
001079 5079 94               4      SUB H
00107A 507A 3D               4      DEC A
00107B 507B 5F               4      LD  E,A
00107C 507C 211FF4          10      LD  HL,KBUF
       507F                     GETL2:
00107F 507F CDD850          17      CALL    _SCRN
001082 5082 03               6      INC BC
001083 5083 77               7      LD  (HL),A
001084 5084 23               6      INC HL
001085 5085 1D               4      DEC E
001086 5086 20F7            12      JR  NZ,GETL2
001088 5088 CD994F          17      CALL    MSG_CR
                                
00108B 508B FDE1            14      POP IY
00108D 508D DDE1            14      POP IX
       508F                     GETL3:
00108F 508F 2B               6      DEC HL
001090 5090 7E               7      LD  A,(HL)
001091 5091 FE21             7      CP  021H
001093 5093 D0              11      RET NC
001094 5094 3600            10      LD  (HL),0
001096 5096 15               4      DEC D
001097 5097 20F6            12      JR  NZ,GETL3
001099 5099 C9              10      RET
                                
       509A                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       509A                     CONSTX:
       509A                     CPM_CONST:
00109A 509A C5              11      PUSH    BC
00109B 509B D5              11      PUSH    DE
00109C 509C E5              11      PUSH    HL
00109D 509D DDE5            15      PUSH    IX
00109F 509F DD219C00        14      LD  IX,CHSNS
0010A3 50A3 CDFD42          17      CALL    CALSLT_R
0010A6 50A6 DDE1            14      POP IX
0010A8 50A8 E1              10      POP HL
0010A9 50A9 D1              10      POP DE
0010AA 50AA C1              10      POP BC
0010AB 50AB C9              10      RET
                                
       50AC                     _SYS2A:     ;(BDOS)日付の獲得
0010AC 50AC AF               4      XOR A
0010AD 50AD 57               4      LD  D,A
0010AE 50AE 5F               4      LD  E,A
0010AF 50AF 67               4      LD  H,A
0010B0 50B0 6F               4      LD  L,A
0010B1 50B1 C9              10      RET
                                
       50B2                     _SYS2C:     ;(BDOS)時刻の獲得
0010B2 50B2 AF               4      XOR A
0010B3 50B3 57               4      LD  D,A
0010B4 50B4 5F               4      LD  E,A
0010B5 50B5 67               4      LD  H,A
0010B6 50B6 6F               4      LD  L,A
0010B7 50B7 C9              10      RET
                                
       50B8                     POS:
0010B8 50B8 F5              11      PUSH    AF
0010B9 50B9 2ADCF3          16      LD  HL,(CSRY)
0010BC 50BC 7D               4      LD  A,L
0010BD 50BD 6C               4      LD  L,H
0010BE 50BE 67               4      LD  H,A
0010BF 50BF 2C               4      INC L
0010C0 50C0 24               4      INC H
0010C1 50C1 F1              10      POP AF
0010C2 50C2 C9              10      RET
                                
       50C3                     LOC:
0010C3 50C3 F5              11      PUSH    AF
0010C4 50C4 E5              11      PUSH    HL
0010C5 50C5 7D               4      LD  A,L
0010C6 50C6 6C               4      LD  L,H
0010C7 50C7 67               4      LD  H,A
0010C8 50C8 2D               4      DEC L
0010C9 50C9 25               4      DEC H
0010CA 50CA DDE5            15      PUSH    IX
0010CC 50CC DD21C600        14      LD  IX,POSIT
0010D0 50D0 CDFD42          17      CALL    CALSLT_R
0010D3 50D3 DDE1            14      POP IX
0010D5 50D5 E1              10      POP HL
0010D6 50D6 F1              10      POP AF
0010D7 50D7 C9              10      RET
                                
       50D8                     _SCRN:
       50D8                     SCRN:
0010D8 50D8 E5              11      PUSH    HL
0010D9 50D9 DDE5            15      PUSH    IX
                                
0010DB 50DB 69               4      LD  L,C
0010DC 50DC 60               4      LD  H,B
0010DD 50DD DD214A00        14      LD  IX,RDVRM
0010E1 50E1 CDFD42          17      CALL    CALSLT_R
                                
0010E4 50E4 DDE1            14      POP IX
0010E6 50E6 E1              10      POP HL
0010E7 50E7 C9              10      RET
                                
       50E8                     CTRL02:
0010E8 50E8 F5              11      PUSH    AF
0010E9 50E9 D5              11      PUSH    DE
0010EA 50EA 2ADCF3          16      LD  HL,(CSRY)
0010ED 50ED 3AB0F3          13      LD  A,(LINLEN)
0010F0 50F0 4F               4      LD  C,A
0010F1 50F1 94               4      SUB H   ;CSRX
0010F2 50F2 C602             7      ADD A,2
0010F4 50F4 47               4      LD  B,A ;カーソルより右の文字数
0010F5 50F5 61               4      LD  H,C ;LINLEN
0010F6 50F6 C5              11      PUSH    BC
0010F7 50F7 CD4551          17      CALL    LOC0
0010FA 50FA C1              10      POP BC
                                
0010FB 50FB 1620             7      LD  D,020H
       50FD                     C8X1:
0010FD 50FD DD214A00        14      LD  IX,RDVRM
001101 5101 CDFD42          17      CALL    CALSLT_R
001104 5104 4F               4      LD  C,A
001105 5105 7A               4      LD  A,D
001106 5106 DD214D00        14      LD  IX,WRTVRM
00110A 510A CDFD42          17      CALL    CALSLT_R
00110D 510D 2B               6      DEC HL
00110E 510E 51               4      LD  D,C
00110F 510F 10EC            13      DJNZ    C8X1
001111 5111 D1              10      POP DE
001112 5112 F1              10      POP AF
001113 5113 C9              10      RET
                                
       5114                     INSERT:
001114 5114 F5              11      PUSH    AF
001115 5115 D5              11      PUSH    DE
001116 5116 2ADCF3          16      LD  HL,(CSRY)
001119 5119 3AB0F3          13      LD  A,(LINLEN)
00111C 511C 4F               4      LD  C,A
00111D 511D 94               4      SUB H   ;CSRX
00111E 511E 3C               4      INC A
00111F 511F 47               4      LD  B,A ;カーソルより右の文字数
001120 5120 C5              11      PUSH    BC
001121 5121 CD4551          17      CALL    LOC0
001124 5124 C1              10      POP BC
                                
001125 5125 1620             7      LD  D,020H
       5127                     INS1:
001127 5127 DD214A00        14      LD  IX,RDVRM
00112B 512B CDFD42          17      CALL    CALSLT_R
00112E 512E 4F               4      LD  C,A
00112F 512F 7A               4      LD  A,D
001130 5130 DD214D00        14      LD  IX,WRTVRM
001134 5134 CDFD42          17      CALL    CALSLT_R
001137 5137 23               6      INC HL
001138 5138 51               4      LD  D,C
001139 5139 10EC            13      DJNZ    INS1
00113B 513B D1              10      POP DE
00113C 513C F1              10      POP AF
00113D 513D C9              10      RET
                                
       513E                     CONOUT1:
00113E 513E 59               4      LD  E,C
00113F 513F C3724F          10      JP  _PRINT
                                
       5142                     GETVRAM:
001142 5142 2ADCF3          16      LD  HL,(CSRY)
       5145                     LOC0:
001145 5145 2D               4      DEC L
001146 5146 25               4      DEC H
001147 5147 4C               4      LD  C,H ;CSRX-1
001148 5148 5D               4      LD  E,L ;CSRY-1
       5149                     LOC1:
001149 5149 3AB0F3          13      LD  A,(LINLEN)
00114C 514C 67               4      LD  H,A
00114D 514D 1600             7      LD  D,0
00114F 514F 6A               4      LD  L,D ;0
001150 5150 0608             7      LD  B,8
       5152                     LOC2:
001152 5152 29              11      ADD HL,HL
001153 5153 3001            12      JR  NC,LOC3
001155 5155 19              11      ADD HL,DE
       5156                     LOC3:
001156 5156 10FA            13      DJNZ    LOC2
001158 5158 09              11      ADD HL,BC
001159 5159 C9              10      RET
                                
       515A                     _SYS0C:     ;(BDOS)バージョン番号の獲得
00115A 515A 212200          10      LD  HL,00022H
00115D 515D AF               4      XOR A
00115E 515E 7D               4      LD  A,L
00115F 515F C9              10      RET
                                
       5160                     _SYS0D:     ;(BDOS)ディスク・リセット
001160 5160 218000          10      LD  HL,00080H
001163 5163 222FF1          16      LD  (_DTA),HL
001166 5166 C9              10      RET
                                
       5167                     _SYS0E:     ;(BDOS)カレントドライブの設定
001167 5167 324AF1          13      LD  (_DVSW),A
00116A 516A C9              10      RET
                                
       516B                     _SYS0F:     ;(BDOS)ファイルのオープン
00116B 516B D5              11      PUSH    DE
00116C 516C FDE1            14      POP IY
00116E 516E CDB452          17      CALL    INIT_FILE
001171 5171 CDFC4A          17      CALL    ROM_OPEN
001174 5174 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
001176 5176 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
00117A 517A FDE5            15      PUSH    IY
00117C 517C D1              10      POP DE
00117D 517D 13               6      INC DE
00117E 517E 010B00          10      LD  BC,11
001181 5181 EDB0                    LDIR
                                ;               Attribute
001183 5183 7E               7      LD  A,(HL)
001184 5184 FD770D          19      LD  (IY+13),A
                                ;               TIME
001187 5187 110B00          10      LD  DE,11
00118A 518A 19              11      ADD HL,DE
00118B 518B 7E               7      LD  A,(HL)
00118C 518C 23               6      INC HL
00118D 518D FD7716          19      LD  (IY+22),A
001190 5190 7E               7      LD  A,(HL)
001191 5191 23               6      INC HL
001192 5192 FD7717          19      LD  (IY+23),A
                                ;               DATE
001195 5195 7E               7      LD  A,(HL)
001196 5196 23               6      INC HL
001197 5197 FD7714          19      LD  (IY+20),A
00119A 519A 7E               7      LD  A,(HL)
00119B 519B 23               6      INC HL
00119C 519C FD7715          19      LD  (IY+21),A
                                ;               First cluster
00119F 519F 7E               7      LD  A,(HL)
0011A0 51A0 23               6      INC HL
0011A1 51A1 FD771A          19      LD  (IY+26),A
0011A4 51A4 7E               7      LD  A,(HL)
0011A5 51A5 23               6      INC HL
0011A6 51A6 FD771B          19      LD  (IY+27),A
                                ;               SIZE
0011A9 51A9 7E               7      LD  A,(HL)
0011AA 51AA 23               6      INC HL
0011AB 51AB FD7710          19      LD  (IY+16),A
0011AE 51AE 7E               7      LD  A,(HL)
0011AF 51AF 23               6      INC HL
0011B0 51B0 FD7711          19      LD  (IY+17),A
0011B3 51B3 7E               7      LD  A,(HL)
0011B4 51B4 23               6      INC HL
0011B5 51B5 FD7712          19      LD  (IY+18),A
0011B8 51B8 7E               7      LD  A,(HL)
0011B9 51B9 FD7713          19      LD  (IY+19),A
0011BC 51BC AF               4      XOR A
0011BD 51BD FD770C          19      LD  (IY+12),A
0011C0 51C0 C9              10      RET
                                
       51C1                     _SYS10:     ;(BDOS)ファイルのクローズ
0011C1 51C1 AF               4      XOR A
0011C2 51C2 C9              10      RET
                                
       51C3                     S11X1:
0011C3 51C3 FD7119          19      LD  (IY+25),C       ;RootEntCnt
0011C6 51C6 FD750E          19      LD  (IY+14),L
0011C9 51C9 FD740F          19      LD  (IY+15),H
       51CC                     SCF_FF_RET:
0011CC 51CC 37               4      SCF
0011CD 51CD 9F               4      SBC A,A
0011CE 51CE C9              10      RET
                                
       51CF                     _SYS11:     ;(BDOS)最初のファイルの検索
0011CF 51CF ED5337F1        20      LD  (_FCB),DE
0011D3 51D3 D5              11      PUSH    DE
0011D4 51D4 FDE1            14      POP IY
0011D6 51D6 CDB452          17      CALL    INIT_FILE
0011D9 51D9 CD444D          17      CALL    GET_DIR_DAT
       51DC                     S12X1:
0011DC 51DC CD184B          17      CALL    FILESE
0011DF 51DF 30E2            12      JR  NC,S11X1
0011E1 51E1 0D               4      DEC C
0011E2 51E2 FD7119          19      LD  (IY+25),C       ;RootEntCnt
0011E5 51E5 012000          10      LD  BC,32
0011E8 51E8 ED5B2FF1        20      LD  DE,(_DTA)
0011EC 51EC AF               4      XOR A
0011ED 51ED 12               7      LD  (DE),A      ;ドライブ番号
0011EE 51EE 13               6      INC DE
0011EF 51EF EDB0                    LDIR            ;ディレクトリエントリ
0011F1 51F1 FD750E          19      LD  (IY+14),L
0011F4 51F4 FD740F          19      LD  (IY+15),H
0011F7 51F7 C9              10      RET
                                
       51F8                     _SYS12:
0011F8 51F8 FD2A37F1        20      LD  IY,(_FCB)
0011FC 51FC FDE5            15      PUSH    IY
0011FE 51FE D1              10      POP DE
0011FF 51FF CDB452          17      CALL    INIT_FILE
                                
001202 5202 FD6E0E          19      LD  L,(IY+14)
001205 5205 FD660F          19      LD  H,(IY+15)
001208 5208 FD4E19          19      LD  C,(IY+25)
00120B 520B 18CF            12      JR  S12X1
                                
       520D                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
00120D 520D CD2A4D          17      CALL    SET_FCB
001210 5210 CDF84C          17      CALL    GETSEQ
001213 5213 CDE54C          17      CALL    RB_READ
001216 5216 E5              11      PUSH    HL
001217 5217 CD054D          17      CALL    SETSEQ
00121A 521A E1              10      POP HL
       521B                     SREAD:
00121B 521B C601             7      ADD A,001H
00121D 521D D8              11      RET C
                                
00121E 521E 7D               4      LD  A,L
00121F 521F D601             7      SUB 001H
001221 5221 9F               4      SBC A,A
001222 5222 E603             7      AND 3
001224 5224 1F               4      RRA
001225 5225 C9              10      RET
                                
       5226                     _SYS18:     ;(BDOS)ログインベクトルの獲得
001226 5226 210100          10      LD  HL,00001H
001229 5229 AF               4      XOR A
00122A 522A C9              10      RET
                                
       522B                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
00122B 522B 3A4AF1          13      LD  A,(_DVSW)
00122E 522E C9              10      RET
                                
       522F                     _SYS1A:     ;(BDOS)DTAの設定
00122F 522F ED532FF1        20      LD  (_DTA),DE
001233 5233 AF               4      XOR A
001234 5234 C9              10      RET
                                
       5235                     _SYS1B:     ;(BDOS)ディスク情報の獲得
001235 5235 010002          10      LD  BC,512
001238 5238 11C302          10      LD  DE,707
00123B 523B 210000          10      LD  HL,0
00123E 523E DD2139F1        14      LD  IX,_BUF
001242 5242 FD2139F1        14      LD  IY,_BUF
001246 5246 FD3600F9        19      LD  (IY+0),0F9H
00124A 524A 3E02             7      LD  A,2
00124C 524C C9              10      RET
                                
       524D                     _SYS21:     ;(BDOS)ランダムな読み出し
00124D 524D CD2A4D          17      CALL    SET_FCB
                                
001250 5250 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001253 5253 FD6622          19      LD  H,(IY+34)
                                
001256 5256 CDE54C          17      CALL    RB_READ
001259 5259 18C0            12      JR  SREAD
                                
       525B                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
00125B 525B CD6B51          17      CALL    _SYS0F
00125E 525E D8              11      RET C
                                
00125F 525F D5              11      PUSH    DE      ;EX DE,IY
001260 5260 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001262 5262 CD1A4D          17      CALL    GETSIZE
       5265                     _S24X1:
001265 5265 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001268 5268 FD7422          19      LD  (IY+34),H
00126B 526B FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
00126F 526F FDE3            23      EX  (SP),IY     ;
001271 5271 D1              10      POP DE      ;
                                
001272 5272 AF               4      XOR A
001273 5273 C9              10      RET
                                
       5274                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
001274 5274 E5              11      PUSH    HL
001275 5275 D5              11      PUSH    DE      ;EX DE,IY
001276 5276 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001278 5278 CDF84C          17      CALL    GETSEQ
00127B 527B 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       527D                     _SYS27:     ;(BDOS)ランダムブロック読み込み
00127D 527D CD2A4D          17      CALL    SET_FCB
001280 5280 E5              11      PUSH    HL
001281 5281 FD6E21          19      LD  L,(IY+33)
001284 5284 FD6622          19      LD  H,(IY+34)
001287 5287 2225F1          16      LD  (RR_LOW),HL
00128A 528A FD6E23          19      LD  L,(IY+35)
00128D 528D FD6624          19      LD  H,(IY+36)
001290 5290 2227F1          16      LD  (RR_HIGH),HL
001293 5293 E1              10      POP HL
001294 5294 CD1C49          17      CALL    ROM_READ
001297 5297 ED5B25F1        20      LD  DE,(RR_LOW)
00129B 529B FD7321          19      LD  (IY+33),E
00129E 529E FD7222          19      LD  (IY+34),D
0012A1 52A1 ED5B27F1        20      LD  DE,(RR_HIGH)
0012A5 52A5 FD7323          19      LD  (IY+35),E
0012A8 52A8 FD7224          19      LD  (IY+36),D
0012AB 52AB 9F               4      SBC A,A
0012AC 52AC C9              10      RET
                                
       52AD                     _SYS2F:
0012AD 52AD 44               4      LD  B,H
0012AE 52AE 2A2FF1          16      LD  HL,(_DTA)
0012B1 52B1 C3864D          10      JP  DISKIO
                                
       52B4                     INIT_FILE:
0012B4 52B4 EB               4      EX  DE,HL
0012B5 52B5 1153F1          10      LD  DE,FDRV
0012B8 52B8 010C00          10      LD  BC,1+8+3
0012BB 52BB EDB0                    LDIR
0012BD 52BD CD1B4F          17      CALL    GET_DISK_BANK_FDRV
0012C0 52C0 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0012C3 52C3 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0012C6 52C6 C9              10      RET
                                
       52C7                     ZERO_MEMORY_DE:
0012C7 52C7 AF               4      XOR A
       52C8                     FILL_MEMORY_DE:
0012C8 52C8 12               7      LD  (DE),A
0012C9 52C9 13               6      INC DE
0012CA 52CA 10FC            13      DJNZ    FILL_MEMORY_DE
0012CC 52CC C9              10      RET
                                
0012CD 52CD                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 5F4F754FA64F5F4F        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 5F4F5F4FAB4FEC4F        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 B34F5F4F06509A50        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 5A51605167516B51        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 C151CF51F8515F4F        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 0D525F4F5F4F5F4F        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 26522B522F523552        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 5F4F5F4F5F4F5B52        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 74525F4F5F4F7D52        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 5F4F5F4FAC505F4F        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 B2505F4F5F4FAD52        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB8 5FB8 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 5F4F5F4F5F4F5F4F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
