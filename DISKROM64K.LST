                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
       0001                     _RAM64K     EQU 1   ;メインRAM 64KB使用可能
                                
                                    INCLUDE "DISKROM.ASM"
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00AE                     PLININ  EQU 000AEH
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
       0159                     CALBAS  EQU 00159H
       01F5                     REDCLK  EQU 001F5H  ;SUB
       01F9                     WRTCLK  EQU 001F9H  ;SUB
                                
       269A                     DECADD  EQU 0269AH
       27E6                     DECMUL  EQU 027E6H
       2F8A                     FRCINT  EQU 02F8AH
                                
       303A                     FRCDBL  EQU 0303AH
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
       7D17                     ST_BAS  EQU 07D17H
                                
       F323                     DISKVE  EQU 0F323H
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F398                     JP_IX   EQU 0F398H
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F847                     ARG EQU 0F847H
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
       FAF8                     EXBRSA  EQU 0FAF8H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBB1                     BASROM  EQU 0FBB1H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCC5                     SLTTBL  EQU 0FCC5H
       FCC9                     SLTATR  EQU 0FCC9H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
       FD99                     DEVICE  EQU 0FD99H
                                
       FDDB                     H_PINL  EQU 0FDDBH
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       C000                     FD_BOOT_START   EQU 0C000H
       C01E                     FD_BOOT_EXEC    EQU 0C01EH
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                            ;ASCII-16K
                                ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
                                ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
                                
       EF80                     ISC EQU 0EF80H
       F280                     ISCB    EQU 0F280H
                                
       EF80                     NEW_HIMEM   EQU ISC
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F55D                     SPBUF   EQU KBUF+318    ;ページ3にスタックがない場合はKBUFを一時的に使う
                                
       003B                     ENASUB  EQU 0003BH
       F55E                     SYS1B_DPB   EQU BUF
       F571                     SYS1B_FAT   EQU SYS1B_DPB+19
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0042                    DW  INIT_ROM    ; Main program execution address.
000004 4004 6E4F                    DW  STATEMENT   ; STATEMENT
000006 4006 A250                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C3F851          10      JP  DISKIO
000013 4013 C33B52          10      JP  DSKCHG
000016 4016 C39152          10      JP  GETDPB
000019 4019 C38453          10      JP  CHOICE
00001C 401C C38853          10      JP  DSKFMT
00001F 401F C38A53          10      JP  DSKSTP
000022 4022 C38B53          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C38853          10      JP  DSKFMT
000029 4029 C38A53          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3F553          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite"
            204449534B20524F    
            4D204C697465        
000096 4096                         ALIGN   32
0000A0 40A0 76302E372E302E30        DB  "v0.7.0.0"
0000A8 40A8                         ALIGN   32
       40C0                     MSG_ERROR_ROM_MODE:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DB  "Normal ROM/ASCII-16K only!",13,10
                                #else
0000C0 40C0 41534349492D384B        DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
            2F4B6F6E616D692D    
            384B2F4B6F6E616D    
            692D534343206F6E    
            6C79210D0A          
                                #endif
0001BD 41BD                         ORG 041BDH
0001BD 41BD C9              10      RET
                                
                                    ;MBR_Partition1 (2DDのデータ)
0001BE 41BE 00                      DB  0       ;ブートフラグ
0001BF 41BF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001C2 41C2 01                      DB  1       ;識別子(FAT12)
0001C3 41C3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001C6 41C6 10000000                DW  16,0        ;パーティションの最初のセクタ番号(LBA方式)
0001CA 41CA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                    ;MBR_Partition2 (2DDのデータ)
0001CE 41CE 00                      DB  0       ;ブートフラグ
0001CF 41CF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001D2 41D2 01                      DB  1       ;識別子(FAT12)
0001D3 41D3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001D6 41D6 B0050000                DW  16+1440,0   ;パーティションの最初のセクタ番号(LBA方式)
0001DA 41DA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                #endif
                                
0001FE 41FE                         ORG 041FEH
0001FE 41FE 55AA                    DB  055H,0AAH   ;MBR_Sig
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4200                     INIT_ROM:
000200 4200 AF               4      XOR A
000201 4201 2100F3          10      LD  HL,0F300H
000204 4204 0668             7      LD  B,068H
000206 4206 CD224C          17      CALL    FILL_MEMORY
                                
000209 4209 3E01             7      LD  A,1
00020B 420B 3221FB          13      LD  (DRVTBL),A
                                
00020E 420E 2A4AFC          16      LD  HL,(HIMEM)
000211 4211 1180EF          10      LD  DE,NEW_HIMEM
000214 4214 A7               4      AND A
000215 4215 ED52            15      SBC HL,DE
000217 4217 3820            12      JR  C,INIT1
000219 4219 EB               4      EX  DE,HL
00021A 421A 2A74F6          16      LD  HL,(STKTOP)
00021D 421D ED52            15      SBC HL,DE
00021F 421F 2274F6          16      LD  (STKTOP),HL ;起動時の空き容量表示の為
000222 4222 F9               6      LD  SP,HL
000223 4223 2A72F6          16      LD  HL,(MEMSIZ)
000226 4226 ED52            15      SBC HL,DE
000228 4228 2272F6          16      LD  (MEMSIZ),HL
00022B 422B 2A9BF6          16      LD  HL,(FRETOP)
00022E 422E ED52            15      SBC HL,DE
000230 4230 229BF6          16      LD  (FRETOP),HL
000233 4233 2180EF          10      LD  HL,NEW_HIMEM
000236 4236 224AFC          16      LD  (HIMEM),HL
       4239                     INIT1:
000239 4239 AF               4      XOR A
00023A 423A 32EAF2          13      LD  (_DVSW),A
00023D 423D 3D               4      DEC A       ;0FFH
00023E 423E 3299FD          13      LD  (DEVICE),A
                                
                                #if exists _RAM64K
000241 4241 21575A          10      LD  HL,AT_ISC
000244 4244 1180EF          10      LD  DE,ISC
000247 4247 014B01          10      LD  BC,ISC_E-ISC
00024A 424A EDB0                    LDIR
                                #endif
00024C 424C 21A25B          10      LD  HL,AT_ISCB
00024F 424F 1180F2          10      LD  DE,ISCB
000252 4252 018900          10      LD  BC,ISCB_E-ISCB
000255 4255 EDB0                    LDIR
000257 4257 2AB1F6          16      LD  HL,(SAVSTK)
00025A 425A 224BF3          16      LD  (0F34BH),HL
                                
00025D 425D 3EC3             7      LD  A,0C3H      ;JP
00025F 425F 3243FF          13      LD  (H_GONE),A
000262 4262 327DF3          13      LD  (BDOS),A
000265 4265 326BF3          13      LD  (RAMUSE),A
000268 4268 3268F3          13      LD  (ROMUSE),A
00026B 426B 2180F2          10      LD  HL,REPLACE_COMMAND
00026E 426E 2244FF          16      LD  (H_GONE+1),HL
000271 4271 2131F3          10      LD  HL,H_BDOS
000274 4274 227EF3          16      LD  (BDOS+1),HL
000277 4277 21ABF2          10      LD  HL,RAMUSE1
00027A 427A 226CF3          16      LD  (RAMUSE+1),HL
00027D 427D 21BBF2          10      LD  HL,ROMUSE1
000280 4280 2269F3          16      LD  (ROMUSE+1),HL
                                
000283 4283 3E                      DB  03EH
000284 4284 F7              12      RST 30H
000285 4285 3271FE          13      LD  (H_BINS),A
000288 4288 3276FE          13      LD  (H_BINL),A
00028B 428B 327BFE          13      LD  (H_FILE),A
00028E 428E 3231F3          13      LD  (H_BDOS),A
000291 4291 32A7FF          13      LD  (H_PHYD),A
                                
000294 4294 CD1844          17      CALL    GTSL1_
000297 4297 3297F2          13      LD  (ROM_SLT),A
00029A 429A 32A7F2          13      LD  (ROM_SLT_COPY),A
00029D 429D 3272FE          13      LD  (H_BINS+1),A
0002A0 42A0 3277FE          13      LD  (H_BINL+1),A
0002A3 42A3 327CFE          13      LD  (H_FILE+1),A
0002A6 42A6 3232F3          13      LD  (H_BDOS+1),A
0002A9 42A9 32A8FF          13      LD  (H_PHYD+1),A
0002AC 42AC 3222FB          13      LD  (DRVTBL+1),A
0002AF 42AF 3248F3          13      LD  (MASTERS),A
0002B2 42B2 212246          10      LD  HL,ROM_LOAD
0002B5 42B5 2273FE          16      LD  (H_BINS+2),HL
0002B8 42B8 21D647          10      LD  HL,ROM_RUN
0002BB 42BB 2278FE          16      LD  (H_BINL+2),HL
0002BE 42BE 21E447          10      LD  HL,ROM_FILES
0002C1 42C1 227DFE          16      LD  (H_FILE+2),HL
0002C4 42C4 216554          10      LD  HL,ROM_BDOS
0002C7 42C7 2233F3          16      LD  (H_BDOS+2),HL
0002CA 42CA 21F851          10      LD  HL,DISKIO
0002CD 42CD 22A9FF          16      LD  (H_PHYD+2),HL
                                
0002D0 42D0 3E                      DB  03EH
0002D1 42D1 C9              10      RET
0002D2 42D2 327FFE          13      LD  (H_FILE+4),A
0002D5 42D5 3275FE          13      LD  (H_BINS+4),A
0002D8 42D8 327AFE          13      LD  (H_BINL+4),A
0002DB 42DB 3235F3          13      LD  (H_BDOS+4),A
0002DE 42DE 32DFFD          13      LD  (H_PINL+4),A
0002E1 42E1 32ABFF          13      LD  (H_PHYD+4),A
                                
0002E4 42E4 AF               4      XOR A
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK0_SEL),A       ;似非RAM対策でバンク0を設定
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0002E5 42E5 320060          13      LD  (BANK0_SEL),A           ;似非RAM対策でバンク0を設定
0002E8 42E8 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0002EB 42EB 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0002EE 42EE 3A0060          13      LD  A,(BANK1_ADR)
0002F1 42F1 FE41             7      CP  'A'
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JP  Z,NOT_BANK_TYPE
                                    LD  A,DISK_BANK
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0002F3 42F3 C20744          10      JP  NZ,NOT_BANK_TYPE
0002F6 42F6 3E01             7      LD  A,DISK_BANK
0002F8 42F8 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0002FB 42FB 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0002FE 42FE CD3801          17      CALL    RSLREG      ;read primary slot #
000301 4301 07               4      RLCA
000302 4302 07               4      RLCA
000303 4303 F5              11      PUSH    AF
000304 4304 1605             7      LD  D,4+1
000306 4306 CD1F44          17      CALL    GTSL2_
000309 4309 3244F3          13      LD  (RAMAD3),A
00030C 430C F1              10      POP AF
00030D 430D 07               4      RLCA
00030E 430E 07               4      RLCA
00030F 430F 1603             7      LD  D,2+1
000311 4311 CD1F44          17      CALL    GTSL2_
000314 4314 2680             7      LD  H,080H
000316 4316 CD3C44          17      CALL    CHK_RAM
000319 4319 3243F3          13      LD  (RAMAD2),A
       431C                     RAMCHK2:
00031C 431C 3A44F3          13      LD  A,(RAMAD3)
00031F 431F 2640             7      LD  H,040H
000321 4321 CD3C44          17      CALL    CHK_RAM
000324 4324 3242F3          13      LD  (RAMAD1),A
       4327                     RAMCHK1:
000327 4327 3A44F3          13      LD  A,(RAMAD3)
00032A 432A 2600             7      LD  H,00H
00032C 432C CD3C44          17      CALL    CHK_RAM
00032F 432F 3241F3          13      LD  (RAMAD0),A
       4332                     RAMCHK0:
000332 4332 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16
000335 4335 010F00          10      LD  BC,0000FH       ;切り上げ
000338 4338 09              11      ADD HL,BC
000339 4339 7D               4      LD  A,L
                                
00033A 433A 0604             7      LD  B,4
       433C                     B_DRIVE1:
00033C 433C CB3C             8      SRL H
00033E 433E 1F               4      RRA
00033F 433F 10FB            13      DJNZ    B_DRIVE1
                                
000341 4341 C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000343 4343 32E9F2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
                                    ;拡張スロットの選択を設定する
000346 4346 3A97F2          13      LD  A,(ROM_SLT)
000349 4349 57               4      LD  D,A
00034A 434A E60C             7      AND 00CH
00034C 434C 5F               4      LD  E,A
00034D 434D 7A               4      LD  A,D
00034E 434E E603             7      AND 3
000350 4350 87               4      ADD A,A
000351 4351 87               4      ADD A,A
000352 4352 87               4      ADD A,A
000353 4353 37               4      SCF
000354 4354 8F               4      ADC A,A
000355 4355 B3               4      OR  E
000356 4356 5F               4      LD  E,A
000357 4357 1600             7      LD  D,0
000359 4359 21C9FC          10      LD  HL,SLTATR
00035C 435C 19              11      ADD HL,DE
00035D 435D 3660            10      LD  (HL),060H
                                
00035F 435F 3E01             7      LD  A,1
000361 4361 CD7452          17      CALL    IS_BPB
000364 4364 9F               4      SBC A,A
000365 4365 E602             7      AND 2
000367 4367 EE03             7      XOR 3
000369 4369 32F0F2          13      LD  (_LVECTOR),A
                                    ;CTRL+STOPを抑制する
00036C 436C 3E01             7      LD  A,1
00036E 436E 32B1FB          13      LD  (BASROM),A
                                
000371 4371 3ACAFF          13      LD  A,(EXTBIO)
000374 4374 FEF7             7      CP  0F7H        ;RST 30H
000376 4376 280A            12      JR  Z,EXTBIO_OK
000378 4378 3E                      DB  03EH
000379 4379 C9              10      RET
00037A 437A 21CAFF          10      LD  HL,EXTBIO
00037D 437D 061D             7      LD  B,29
00037F 437F CD224C          17      CALL    FILL_MEMORY
       4382                     EXTBIO_OK:
000382 4382 210745          10      LD  HL,DELOK
000385 4385 CDCF44          17      CALL    MSX
                                
000388 4388 AF               4      XOR A
000389 4389 3240F3          13      LD  (REBOOT),A
00038C 438C 2A48FC          16      LD  HL,(BOTTOM)
00038F 438F 110040          10      LD  DE,16384
000392 4392 19              11      ADD HL,DE
000393 4393 DA0444          10      JP  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
000396 4396 57               4      LD  D,A
000397 4397 0601             7      LD  B,1
000399 4399 2100C0          10      LD  HL,FD_BOOT_START
00039C 439C CDF851          17      CALL    DISKIO
                                
00039F 439F 1168F3          10      LD  DE,ROMUSE
0003A2 43A2 2123F3          10      LD  HL,DISKVE
0003A5 43A5 AF               4      XOR A
0003A6 43A6 CD1EC0          17      CALL    FD_BOOT_EXEC
                                #if exists _RAM64K
                                                ;64K版の場合はページ0をRAMに切り替えRAM側にインタースロットコールを入れる
0003A9 43A9 3A41F3          13      LD  A,(RAMAD0)  ;ページ0をRAMに切り替える
0003AC 43AC CD095A          17      CALL    ENASLT_00H
                                
0003AF 43AF AF               4      XOR A
0003B0 43B0 47               4      LD  B,A
0003B1 43B1 67               4      LD  H,A
0003B2 43B2 6F               4      LD  L,A
0003B3 43B3 CD224C          17      CALL    FILL_MEMORY
                                
0003B6 43B6 3EC3             7      LD  A,0C3H      ;JP
                                                ;インタースロットコール
0003B8 43B8 2192F0          10      LD  HL,RDSLT
0003BB 43BB 320C00          13      LD  (_RDSLT),A
0003BE 43BE 220D00          16      LD  (_RDSLT+1),HL
                                
0003C1 43C1 21A0F0          10      LD  HL,WRSLT
0003C4 43C4 321400          13      LD  (_WRSLT),A
0003C7 43C7 221500          16      LD  (_WRSLT+1),HL
                                
0003CA 43CA 2151F0          10      LD  HL,CALSLT
0003CD 43CD 321C00          13      LD  (_CALSLT),A
0003D0 43D0 221D00          16      LD  (_CALSLT+1),HL
                                
0003D3 43D3 2180EF          10      LD  HL,ENASLT
0003D6 43D6 322400          13      LD  (_ENASLT),A
0003D9 43D9 222500          16      LD  (_ENASLT+1),HL
                                
0003DC 43DC 2141F0          10      LD  HL,CALLF
0003DF 43DF 323000          13      LD  (_CALLF),A
0003E2 43E2 223100          16      LD  (_CALLF+1),HL
                                                ;割り込み
0003E5 43E5 21ACF0          10      LD  HL,INT38H
0003E8 43E8 323800          13      LD  (00038H),A
0003EB 43EB 223900          16      LD  (00038H+1),HL
                                                ;インタースロットコールの補助
0003EE 43EE 21475A          10      LD  HL,AT_3B
0003F1 43F1 113B00          10      LD  DE,ENASUB
0003F4 43F4 011000          10      LD  BC,AT_3B_E-AT_3B
0003F7 43F7 EDB0                    LDIR
                                #endif
0003F9 43F9 1168F3          10      LD  DE,ROMUSE
0003FC 43FC 2123F3          10      LD  HL,DISKVE
0003FF 43FF AF               4      XOR A
000400 4400 37               4      SCF
000401 4401 CD1EC0          17      CALL    FD_BOOT_EXEC
       4404                     BOOT1:
000404 4404 C38B53          10      JP  BASENT
                                
       4407                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
000407 4407 21C040          10      LD  HL,MSG_ERROR_ROM_MODE
00040A 440A CDCF44          17      CALL    MSX
00040D 440D FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000411 4411 DD219F00        14      LD  IX,CHGET
000415 4415 C31C00          10      JP  _CALSLT
                                
       4418                     GTSL1_:             ;自分のいるスロットを知る
000418 4418 CD3801          17      CALL    RSLREG      ;read primary slot #
00041B 441B 0F               4      RRCA
00041C 441C 0F               4      RRCA
00041D 441D 1601             7      LD  D,1
       441F                     GTSL2_:
00041F 441F E603             7      AND 3       ;[A]=000000PP
000421 4421 5F               4      LD  E,A     ;[E]=000000PP
000422 4422 21C1FC          10      LD  HL,EXPTBL
000425 4425 85               4      ADD A,L     ;桁上りは無い
000426 4426 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000427 4427 7B               4      LD  A,E     ;[A]=000000PP
000428 4428 CB7E            13      BIT 7,(HL)
00042A 442A C8              11      RET Z
00042B 442B 7D               4      LD  A,L     ;point to SLTTBL entry
00042C 442C C604             7      ADD A,4     ;桁上りは無い
00042E 442E 6F               4      LD  L,A
00042F 442F 7E               7      LD  A,(HL)      ;get currently expansion slot register
       4430                     GTSL3_:
000430 4430 15               4      DEC D
000431 4431 2803            12      JR  Z,GTSL4_:
000433 4433 0F               4      RRCA
000434 4434 18FA            12      JR  GTSL3_:
       4436                     GTSL4_:
000436 4436 E60C             7      AND 00CH        ;[A] = 0000SS00
000438 4438 B3               4      OR  E       ;[A] = 0000SSPP
000439 4439 F680             7      OR  080H        ;[A] = 1000SSPP
00043B 443B C9              10      RET
                                
       443C                     CHK_RAM:
00043C 443C E5              11      PUSH    HL
00043D 443D CD9144          17      CALL    CHK_RAM0
000440 4440 E1              10      POP HL
000441 4441 C8              11      RET Z
000442 4442 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000445 4445 E680             7      AND 080H
000447 4447 CD6844          17      CALL    CHK_RAM_SLT
00044A 444A C8              11      RET Z
00044B 444B 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
00044E 444E E680             7      AND 080H
000450 4450 C601             7      ADD A,1
000452 4452 CD6844          17      CALL    CHK_RAM_SLT
000455 4455 C8              11      RET Z
000456 4456 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000459 4459 E680             7      AND 080H
00045B 445B C602             7      ADD A,2
00045D 445D CD6844          17      CALL    CHK_RAM_SLT
000460 4460 C8              11      RET Z
000461 4461 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000464 4464 E680             7      AND 080H
000466 4466 C603             7      ADD A,3
       4468                     CHK_RAM_SLT:
000468 4468 E5              11      PUSH    HL
000469 4469 CD9144          17      CALL    CHK_RAM0        ;スロット#X or X-0
00046C 446C E1              10      POP HL
00046D 446D C8              11      RET Z
00046E 446E CB79             8      BIT 7,C
000470 4470 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000472 4472 79               4      LD  A,C
000473 4473 C604             7      ADD A,4*1           ;スロット#X-1
000475 4475 E5              11      PUSH    HL
000476 4476 CD9144          17      CALL    CHK_RAM0
000479 4479 E1              10      POP HL
00047A 447A C8              11      RET Z
00047B 447B 79               4      LD  A,C
00047C 447C C608             7      ADD A,4*2           ;スロット#X-2
00047E 447E E5              11      PUSH    HL
00047F 447F CD9144          17      CALL    CHK_RAM0
000482 4482 E1              10      POP HL
000483 4483 C8              11      RET Z
000484 4484 79               4      LD  A,C
000485 4485 C60C             7      ADD A,4*3           ;スロット#X-3
000487 4487 E5              11      PUSH    HL
000488 4488 CD9144          17      CALL    CHK_RAM0
00048B 448B E1              10      POP HL
       448C                     CHK_RAM_E:
00048C 448C AF               4      XOR A
00048D 448D 3C               4      INC A           ;ZF=0にする
00048E 448E 3E00             7      LD  A,0
000490 4490 C9              10      RET
                                
       4491                     CHK_RAM0:
000491 4491 4F               4      LD  C,A
000492 4492 3A97F2          13      LD  A,(ROM_SLT)
000495 4495 B9               4      CP  C
000496 4496 28F4            12      JR  Z,CHK_RAM_E
000498 4498 2E00             7      LD  L,0
       449A                     CHK_RAM1:
00049A 449A 79               4      LD  A,C
00049B 449B CDFF44          17      CALL    RDSLTX
00049E 449E C6E5             7      ADD A,0E5H
0004A0 44A0 47               4      LD  B,A
0004A1 44A1 5F               4      LD  E,A
0004A2 44A2 79               4      LD  A,C
0004A3 44A3 C5              11      PUSH    BC
0004A4 44A4 CD1400          17      CALL    _WRSLT
0004A7 44A7 C1              10      POP BC
0004A8 44A8 79               4      LD  A,C
0004A9 44A9 CDFF44          17      CALL    RDSLTX
0004AC 44AC B8               4      CP  B
0004AD 44AD C0              11      RET NZ
0004AE 44AE D6E5             7      SUB 0E5H
0004B0 44B0 79               4      LD  A,C
0004B1 44B1 5F               4      LD  E,A
0004B2 44B2 C5              11      PUSH    BC
0004B3 44B3 CD1400          17      CALL    _WRSLT
0004B6 44B6 C1              10      POP BC
0004B7 44B7 24               4      INC H
0004B8 44B8 7D               4      LD  A,L
0004B9 44B9 C604             7      ADD A,4
0004BB 44BB 6F               4      LD  L,A
0004BC 44BC 20DC            12      JR  NZ,CHK_RAM1
0004BE 44BE 79               4      LD  A,C     ;ZF=1のハズ
0004BF 44BF C9              10      RET
                                
       44C0                     CALSLT_R:
0004C0 44C0 C5              11      PUSH    BC
0004C1 44C1 E5              11      PUSH    HL
0004C2 44C2 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0004C6 44C6 CD1C00          17      CALL    _CALSLT
0004C9 44C9 E1              10      POP HL
0004CA 44CA C1              10      POP BC
0004CB 44CB C9              10      RET
                                
       44CC                     MSX1:
0004CC 44CC CD7E54          17      CALL    MSGA1
       44CF                     MSX:
0004CF 44CF 7E               7      LD  A,(HL)
0004D0 44D0 23               6      INC HL
0004D1 44D1 B7               4      OR  A
0004D2 44D2 20F8            12      JR  NZ,MSX1
0004D4 44D4 C9              10      RET
                                
       44D5                     PRTHX:
0004D5 44D5 F5              11      PUSH    AF
0004D6 44D6 07               4      RLCA
0004D7 44D7 07               4      RLCA
0004D8 44D8 07               4      RLCA
0004D9 44D9 07               4      RLCA
0004DA 44DA CDDE44          17      CALL    PRTA2
0004DD 44DD F1              10      POP AF
       44DE                     PRTA2:
0004DE 44DE CDE444          17      CALL    ASC
0004E1 44E1 C37A54          10      JP  MSG_A
                                
       44E4                     ASC:
0004E4 44E4 E60F             7      AND $0F
0004E6 44E6 F630             7      OR  $30
0004E8 44E8 FE3A             7      CP  $3A
0004EA 44EA D8              11      RET C
0004EB 44EB C607             7      ADD A,7
0004ED 44ED C9              10      RET
                                
       44EE                     MSN:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
0004EE 44EE 7E               7      LD  A,(HL)
                                #endif
0004EF 44EF 23               6      INC HL
0004F0 44F0 CD7A54          17      CALL    MSG_A
0004F3 44F3 10F9            13      DJNZ    MSN
0004F5 44F5 C9              10      RET
                                
       44F6                     RDSLT_ROM3:
0004F6 44F6 7E               7      LD  A,(HL)
0004F7 44F7 C9              10      RET
       44F8                     RDSLT_ROM:
0004F8 44F8 CB7C             8      BIT 7,H
0004FA 44FA 28FA            12      JR  Z,RDSLT_ROM3
       44FC                     RDSLT_ROM2:
0004FC 44FC 3A97F2          13      LD  A,(ROM_SLT)
       44FF                     RDSLTX:
0004FF 44FF C5              11      PUSH    BC
000500 4500 D5              11      PUSH    DE
000501 4501 CD0C00          17      CALL    _RDSLT
000504 4504 D1              10      POP DE
000505 4505 C1              10      POP BC
000506 4506 C9              10      RET
                                
       4507                     DELOK:
000507 4507 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       450B                     ROM_LDIR:
00050B 450B 3AD6F2          13      LD  A,(FLG_LDIR)
00050E 450E B7               4      OR  A
00050F 450F 2008            12      JR  NZ,ROM_LDIRVM
000511 4511 CB7A             8      BIT 7,D
000513 4513 CA2B45          10      JP  Z,ROM_LDIRSLT
                                #if exists USE_MORMAL32K_OR_ASCII16
                                LDIRA:
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ1
                                    LD  SP,SPBUF
                                SPJ1:
                                LDIR1:
                                    LD  A,B
                                    OR  C
                                    JR  Z,LDIRE
                                
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                LDIR2:
                                    LD  A,D
                                    CP  0C0H
                                    JR  NC,LDIR4
                                
                                    PUSH    BC
                                    PUSH    DE
                                    LD  DE,BUF
                                
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIR3
                                    LD  BC,00100H
                                LDIR3:
                                    PUSH    BC
                                    LDIR
                                    LD  (_HL),HL
                                
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                
                                    POP BC
                                    POP DE
                                    LD  HL,BUF
                                    LDIR
                                
                                    LD  HL,(_HL)
                                    POP BC
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIRE
                                    DEC B
                                    JR  LDIR1
                                LDIR4:
                                #endif
000516 4516 EDB0                    LDIR
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                LDIRE2:
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                LDIRE:
                                    LD  SP,(_SP)
                                #endif
000518 4518 C9              10      RET
                                
       4519                     ROM_LDIRVM:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ2
                                    LD  SP,SPBUF
                                SPJ2:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
000519 4519 C5              11      PUSH    BC
00051A 451A D5              11      PUSH    DE
00051B 451B FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00051F 451F DD215C00        14      LD  IX,LDIRVM
000523 4523 CD1C00          17      CALL    _CALSLT
000526 4526 E1              10      POP HL
000527 4527 C1              10      POP BC
000528 4528 09              11      ADD HL,BC
000529 4529 EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JR  LDIRE2
                                #else
00052A 452A C9              10      RET
                                #endif
                                
       452B                     ROM_LDIRSLT:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ3
                                    LD  SP,SPBUF
                                SPJ3:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
       452B                     ROM_LDIRSLT1:
00052B 452B EB               4      EX  DE,HL
       452C                     RLDIRSLT1:
00052C 452C CB7C             8      BIT 7,H
00052E 452E 202C            12      JR  NZ,RLDIRSLT_EXIT
000530 4530 1A               7      LD  A,(DE)
000531 4531 13               6      INC DE
000532 4532 D5              11      PUSH    DE
000533 4533 5F               4      LD  E,A
000534 4534 CB74             8      BIT 6,H
000536 4536 200A            12      JR  NZ,RLDIRSLT2
000538 4538 3A0000          13      LD  A,(0000H)
00053B 453B FEF3             7      CP  0F3H        ;0000H が DI じゃない場合は RAM とみなす
00053D 453D 2803            12      JR  Z,RLDIRSLT2
00053F 453F 73               7      LD  (HL),E
000540 4540 1812            12      JR  RLDIRSLT3
       4542                     RLDIRSLT2:
000542 4542 C5              11      PUSH    BC
000543 4543 E5              11      PUSH    HL
000544 4544 0141F3          10      LD  BC,RAMAD0
000547 4547 7C               4      LD  A,H
000548 4548 07               4      RLCA
000549 4549 07               4      RLCA
00054A 454A E603             7      AND 3
00054C 454C 81               4      ADD A,C
00054D 454D 4F               4      LD  C,A
00054E 454E 0A               7      LD  A,(BC)
00054F 454F CD1400          17      CALL    _WRSLT
000552 4552 E1              10      POP HL
000553 4553 C1              10      POP BC
       4554                     RLDIRSLT3:
000554 4554 D1              10      POP DE
000555 4555 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
000557 4557 EA2C45          10      JP  PE,RLDIRSLT1
00055A 455A EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JP  LDIRE2
                                RLDIRSLT_EXIT:
                                    EX  DE,HL
                                    JP  LDIR1
                                #else
00055B 455B C9              10      RET
       455C                     RLDIRSLT_EXIT:
00055C 455C EB               4      EX  DE,HL
00055D 455D EDB0                    LDIR
00055F 455F C9              10      RET
                                #endif
                                
       4560                     END_OF_LINE:
000560 4560 215EF5          10      LD  HL,BUF
       4563                     EOL1:
000563 4563 7E               7      LD  A,(HL)
000564 4564 C8              11      RET Z
000565 4565 FE0D             7      CP  00DH
000567 4567 2807            12      JR  Z,EOLE
000569 4569 FE0A             7      CP  00AH
00056B 456B 2803            12      JR  Z,EOLE
00056D 456D 23               6      INC HL
00056E 456E 18F3            12      JR  EOL1
       4570                     EOLE:
000570 4570 3600            10      LD  (HL),0
000572 4572 23               6      INC HL
000573 4573 7E               7      LD  A,(HL)
000574 4574 FE0A             7      CP  00AH
000576 4576 C0              11      RET NZ
000577 4577 23               6      INC HL
000578 4578 C9              10      RET
                                
       4579                     ROM_LOAD_ASCII:
000579 4579 210000          10      LD  HL,0
00057C 457C 22DAF2          16      LD  (_BUF_ST),HL    ;読み出し位置
00057F 457F 2A76F6          16      LD  HL,(TXTTAB)
000582 4582 22DCF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
000585 4585 215EF5          10      LD  HL,BUF
000588 4588 22D4F2          16      LD  (_DTA),HL
       458B                     RLOAD_A1:
00058B 458B 2ADAF2          16      LD  HL,(_BUF_ST)
00058E 458E 22CAF2          16      LD  (RR_LOW),HL
000591 4591 210201          10      LD  HL,258
000594 4594 CDA24A          17      CALL    ROM_READ
000597 4597 7C               4      LD  A,H
000598 4598 B5               4      OR  L
000599 4599 2879            12      JR  Z,RLOAD_AEND
00059B 459B 015EF5          10      LD  BC,BUF
00059E 459E 09              11      ADD HL,BC
00059F 459F 3600            10      LD  (HL),0
0005A1 45A1 CD6045          17      CALL    END_OF_LINE
0005A4 45A4 015EF5          10      LD  BC,BUF
0005A7 45A7 A7               4      AND A
0005A8 45A8 ED42            15      SBC HL,BC
0005AA 45AA 2810            12      JR  Z,RLOAD_A2
0005AC 45AC 4D               4      LD  C,L
0005AD 45AD 44               4      LD  B,H
0005AE 45AE ED5BDAF2        20      LD  DE,(_BUF_ST)
0005B2 45B2 19              11      ADD HL,DE
0005B3 45B3 22DAF2          16      LD  (_BUF_ST),HL
0005B6 45B6 3A5EF5          13      LD  A,(BUF)
0005B9 45B9 B7               4      OR  A
0005BA 45BA 28CF            12      JR  Z,RLOAD_A1
       45BC                     RLOAD_A2:
0005BC 45BC 115EF5          10      LD  DE,BUF
0005BF 45BF CD594C          17      CALL    SPCUTEX
0005C2 45C2 1A               7      LD  A,(DE)
0005C3 45C3 B7               4      OR  A
0005C4 45C4 284E            12      JR  Z,RLOAD_AEND
0005C6 45C6 CD6B4C          17      CALL    GETNUM
0005C9 45C9 7C               4      LD  A,H
0005CA 45CA B5               4      OR  L
0005CB 45CB CAEB46          10      JP  Z,ERROR_DIRECT_IN_FILE
0005CE 45CE DD2ADCF2        20      LD  IX,(_BUF_EN)
0005D2 45D2 DD7502          19      LD  (IX+2),L
0005D5 45D5 DD7403          19      LD  (IX+3),H
                                
0005D8 45D8 CD524C          17      CALL    SPCUT
0005DB 45DB EB               4      EX  DE,HL
0005DC 45DC DDE5            15      PUSH    IX
0005DE 45DE DD21B242        14      LD  IX,CRUNCH
0005E2 45E2 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0005E6 45E6 CD1C00          17      CALL    _CALSLT
0005E9 45E9 DDE1            14      POP IX
0005EB 45EB EB               4      EX  DE,HL
0005EC 45EC 111FF4          10      LD  DE,KBUF
0005EF 45EF 37               4      SCF
0005F0 45F0 ED52            15      SBC HL,DE
0005F2 45F2 CAEB46          10      JP  Z,ERROR_DIRECT_IN_FILE
0005F5 45F5 DAEB46          10      JP  C,ERROR_DIRECT_IN_FILE
0005F8 45F8 4D               4      LD  C,L
0005F9 45F9 44               4      LD  B,H
0005FA 45FA 2ADCF2          16      LD  HL,(_BUF_EN)
0005FD 45FD 110400          10      LD  DE,4
000600 4600 19              11      ADD HL,DE
000601 4601 111FF4          10      LD  DE,KBUF
                                
000604 4604 EB               4      EX  DE,HL
000605 4605 EDB0                    LDIR
000607 4607 EB               4      EX  DE,HL
                                
000608 4608 DD7500          19      LD  (IX+0),L
00060B 460B DD7401          19      LD  (IX+1),H
00060E 460E 22DCF2          16      LD  (_BUF_EN),HL
000611 4611 C38B45          10      JP  RLOAD_A1
                                
       4614                     RLOAD_AEND:
000614 4614 2ADCF2          16      LD  HL,(_BUF_EN)
000617 4617 AF               4      XOR A
000618 4618 77               7      LD  (HL),A
000619 4619 23               6      INC HL
00061A 461A 77               7      LD  (HL),A
00061B 461B 23               6      INC HL
00061C 461C 22DCF2          16      LD  (_BUF_EN),HL
00061F 461F C3AE46          10      JP  RLOAD_END1
                                
       4622                     ROM_LOAD:
000622 4622 CD5048          17      CALL    INIT_PARAM
000625 4625 7E               7      LD  A,(HL)
000626 4626 FE2C             7      CP  ','
000628 4628 2003            12      JR  NZ,ROM_LOAD0
00062A 462A 23               6      INC HL
00062B 462B 7E               7      LD  A,(HL)
00062C 462C 2B               6      DEC HL
       462D                     ROM_LOAD0:
00062D 462D 32BEFC          13      LD  (RUNBNF),A
000630 4630 CD434B          17      CALL    FILE_B
000633 4633 3AFAF2          13      LD  A,(FNAME)
000636 4636 FE20             7      CP  020H
000638 4638 CA3E4B          10      JP  Z,ROM_ORG
                                
00063B 463B CDC24C          17      CALL    ROM_OPEN
00063E 463E DAF746          10      JP  C,ERROR_FILE_NOT_FOUND
       4641                     ROM_LOAD1:
000641 4641 21D9F2          10      LD  HL,_BUF
000644 4644 22D4F2          16      LD  (_DTA),HL
000647 4647 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
00064A 464A CDA24A          17      CALL    ROM_READ
00064D 464D 3AD9F2          13      LD  A,(_BUF)
000650 4650 3C               4      INC A
000651 4651 C27945          10      JP  NZ,ROM_LOAD_ASCII
000654 4654 2A76F6          16      LD  HL,(TXTTAB)
000657 4657 22D4F2          16      LD  (_DTA),HL
00065A 465A EB               4      EX  DE,HL
00065B 465B 2100FF          10      LD  HL,-256
00065E 465E 39              11      ADD HL,SP
00065F 465F ED52            15      SBC HL,DE
000661 4661 CDA24A          17      CALL    ROM_READ
000664 4664 ED5BD4F2        20      LD  DE,(_DTA)
000668 4668 19              11      ADD HL,DE
000669 4669 E5              11      PUSH    HL
00066A 466A 2A76F6          16      LD  HL,(TXTTAB)
       466D                     ROM_LOAD2:          ;リンクポインタをFIX
00066D 466D E5              11      PUSH    HL
00066E 466E DDE1            14      POP IX
000670 4670 7E               7      LD  A,(HL)      ;リンクポインタL
000671 4671 23               6      INC HL
000672 4672 B6               7      OR  (HL)        ;リンクポインタH
000673 4673 23               6      INC HL
000674 4674 2837            12      JR  Z,RLOAD_END0
000676 4676 23               6      INC HL      ;行番号
000677 4677 23               6      INC HL      ;行番号
       4678                     ROM_LOAD3:
000678 4678 7E               7      LD  A,(HL)
000679 4679 23               6      INC HL
00067A 467A FE0B             7      CP  00BH        ;8進数(&O)
00067C 467C 2822            12      JR  Z,INC_HL2
00067E 467E FE0C             7      CP  00CH        ;16進数(&H)
000680 4680 281E            12      JR  Z,INC_HL2
000682 4682 FE0D             7      CP  00DH        ;行番号(RUN後)
000684 4684 281A            12      JR  Z,INC_HL2
000686 4686 FE0E             7      CP  00EH        ;行番号(RUN前)
000688 4688 2816            12      JR  Z,INC_HL2
00068A 468A FE0F             7      CP  00FH        ;10～255の整数(%)
00068C 468C 2813            12      JR  Z,INC_HL1
00068E 468E FE1C             7      CP  01CH        ;256～65535の整数(%)
000690 4690 280E            12      JR  Z,INC_HL2
000692 4692 FE1D             7      CP  01DH        ;単精度実数(!)
000694 4694 2808            12      JR  Z,INC_HL4
000696 4696 FE1F             7      CP  01FH        ;倍制度実数(#)
000698 4698 2008            12      JR  NZ,INC_HL0
00069A 469A 23               6      INC HL
00069B 469B 23               6      INC HL
00069C 469C 23               6      INC HL
00069D 469D 23               6      INC HL
       469E                     INC_HL4:
00069E 469E 23               6      INC HL
00069F 469F 23               6      INC HL
       46A0                     INC_HL2:
0006A0 46A0 23               6      INC HL
       46A1                     INC_HL1:
0006A1 46A1 23               6      INC HL
       46A2                     INC_HL0:
0006A2 46A2 B7               4      OR  A
0006A3 46A3 20D3            12      JR  NZ,ROM_LOAD3
0006A5 46A5 DD7500          19      LD  (IX+0),L
0006A8 46A8 DD7401          19      LD  (IX+1),H
0006AB 46AB 18C0            12      JR  ROM_LOAD2
       46AD                     RLOAD_END0:
0006AD 46AD E1              10      POP HL
       46AE                     RLOAD_END1:
0006AE 46AE 22C2F6          16      LD  (VARTAB),HL
0006B1 46B1 22C4F6          16      LD  (ARYTAB),HL
0006B4 46B4 22C6F6          16      LD  (STREND),HL
                                
0006B7 46B7 3ABEFC          13      LD  A,(RUNBNF)
0006BA 46BA CDAC4C          17      CALL    CAP
0006BD 46BD FE52             7      CP  'R'
0006BF 46BF 280E            12      JR  Z,RLOAD_END2
0006C1 46C1 AF               4      XOR A
0006C2 46C2 21DCF2          10      LD  HL,_BUF+3
0006C5 46C5 77               7      LD  (HL),A      ;3
0006C6 46C6 2B               6      DEC HL
0006C7 46C7 77               7      LD  (HL),A      ;2
0006C8 46C8 2B               6      DEC HL
0006C9 46C9 77               7      LD  (HL),A      ;1
0006CA 46CA 2B               6      DEC HL
0006CB 46CB 3E8F             7      LD  A,08FH      ;REM
0006CD 46CD 77               7      LD  (HL),A      ;0
0006CE 46CE C9              10      RET
       46CF                     RLOAD_END2:
0006CF 46CF D5              11      PUSH    DE
0006D0 46D0 ED5B76F6        20      LD  DE,(TXTTAB)
0006D4 46D4 1B               6      DEC DE
0006D5 46D5 AF               4      XOR A
0006D6 46D6 21DFF2          10      LD  HL,_BUF+6
0006D9 46D9 77               7      LD  (HL),A      ;6
0006DA 46DA 2B               6      DEC HL
0006DB 46DB 77               7      LD  (HL),A      ;5
0006DC 46DC 2B               6      DEC HL
0006DD 46DD 77               7      LD  (HL),A      ;4
0006DE 46DE 2B               6      DEC HL
0006DF 46DF 72               7      LD  (HL),D      ;3 行番号H
0006E0 46E0 2B               6      DEC HL
0006E1 46E1 73               7      LD  (HL),E      ;2 行番号L
0006E2 46E2 2B               6      DEC HL
0006E3 46E3 360D            10      LD  (HL),00DH   ;1 行番号(RUN後)
0006E5 46E5 2B               6      DEC HL
0006E6 46E6 3E89             7      LD  A,089H      ;GOTO
0006E8 46E8 77               7      LD  (HL),A      ;0
0006E9 46E9 D1              10      POP DE
0006EA 46EA C9              10      RET
                                
       46EB                     ERROR_DIRECT_IN_FILE:
0006EB 46EB 1E39             7      LD  E,57            ;Direct statement in file
0006ED 46ED 01                      DB  1           ;LD BC,
       46EE                     ERROR_DEVICE_IO_ERROR:
0006EE 46EE 1E13             7      LD  E,19            ;Device I/O error
0006F0 46F0 01                      DB  1           ;LD BC,
       46F1                     ERROR_INTERNAL_ERROR:
0006F1 46F1 1E33             7      LD  E,51            ;Internal error
0006F3 46F3 01                      DB  1           ;LD BC,
       46F4                     ERROR_FILE_NOT_OPEN:
0006F4 46F4 1E3B             7      LD  E,59            ;File not OPEN
0006F6 46F6 01                      DB  1           ;LD BC,
       46F7                     ERROR_FILE_NOT_FOUND:
0006F7 46F7 1E35             7      LD  E,53            ;File not found
       46F9                     ERROR:
0006F9 46F9 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0006FD 46FD DD216F40        14      LD  IX,ERRHAND
000701 4701 C31C00          10      JP  _CALSLT
                                
       4704                     ROM_BLOAD:
000704 4704 CD5048          17      CALL    INIT_PARAM
000707 4707 CD434B          17      CALL    FILE_B
00070A 470A CDC24C          17      CALL    ROM_OPEN
00070D 470D 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
00070F 470F 21D9F2          10      LD  HL,_BUF
000712 4712 22D4F2          16      LD  (_DTA),HL
000715 4715 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
000718 4718 CDA24A          17      CALL    ROM_READ
00071B 471B 3AD9F2          13      LD  A,(_BUF)
00071E 471E FEFE             7      CP  0FEH
000720 4720 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
000722 4722 21A5F2          10      LD  HL,BLOAD_RET
000725 4725 229DF2          16      LD  (SWC_BLOAD),HL
                                
000728 4728 2AF5F2          16      LD  HL,(PARAM1)
00072B 472B 7E               7      LD  A,(HL)
00072C 472C FE2C             7      CP  ','
00072E 472E 204C            12      JR  NZ,RBREAD_MEM
000730 4730 23               6      INC HL
000731 4731 7E               7      LD  A,(HL)
000732 4732 CDAC4C          17      CALL    CAP
000735 4735 32BEFC          13      LD  (RUNBNF),A
000738 4738 FE52             7      CP  'R'     ;R,Sスイッチじゃ無い場合はオフセット値として処理する
00073A 473A 2808            12      JR  Z,RBOS1
00073C 473C FE53             7      CP  'S'
00073E 473E 2804            12      JR  Z,RBOS1
000740 4740 FE2C             7      CP  ','
000742 4742 200D            12      JR  NZ,RBOS2
       4744                     RBOS1:
000744 4744 7E               7      LD  A,(HL)
000745 4745 23               6      INC HL
000746 4746 B7               4      OR  A
000747 4747 2824            12      JR  Z,RBREAD_OSE
000749 4749 FE3A             7      CP  ':'
00074B 474B 2820            12      JR  Z,RBREAD_OSE
00074D 474D FE2C             7      CP  ','     ;次のパラメータを探す
00074F 474F 20F3            12      JR  NZ,RBOS1
       4751                     RBOS2:              ;オフセット
000751 4751 22F5F2          16      LD  (PARAM1),HL
000754 4754 7E               7      LD  A,(HL)
000755 4755 B7               4      OR  A
000756 4756 2815            12      JR  Z,RBREAD_OSE
000758 4758 DD212F54        14      LD  IX,FRMQNT
00075C 475C FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000760 4760 CD1C00          17      CALL    _CALSLT
000763 4763 22F5F2          16      LD  (PARAM1),HL
000766 4766 2ADAF2          16      LD  HL,(_BUF_ST)
000769 4769 19              11      ADD HL,DE
00076A 476A 22DAF2          16      LD  (_BUF_ST),HL
       476D                     RBREAD_OSE:
00076D 476D 3ABEFC          13      LD  A,(RUNBNF)
000770 4770 FE53             7      CP  'S'
000772 4772 2008            12      JR  NZ,RBREAD_MEM
000774 4774 CD304A          17      CALL    WAIT_VDP
000777 4777 3E01             7      LD  A,1
000779 4779 32D6F2          13      LD  (FLG_LDIR),A
       477C                     RBREAD_MEM:
00077C 477C 2ADAF2          16      LD  HL,(_BUF_ST)
00077F 477F 22BFFC          16      LD  (SAVENT),HL
000782 4782 22D4F2          16      LD  (_DTA),HL
000785 4785 21FFFF          10      LD  HL,0FFFFH
000788 4788 CDA24A          17      CALL    ROM_READ
00078B 478B AF               4      XOR A
00078C 478C 32D6F2          13      LD  (FLG_LDIR),A
00078F 478F 3ABEFC          13      LD  A,(RUNBNF)
000792 4792 FE52             7      CP  'R'
000794 4794 2006            12      JR  NZ,RBREAD1
000796 4796 2ADEF2          16      LD  HL,(_BUF_EX)
000799 4799 229DF2          16      LD  (SWC_BLOAD),HL
       479C                     RBREAD1:
       479C                     ROM_NEXT:
00079C 479C 2AF5F2          16      LD  HL,(PARAM1)
00079F 479F 7E               7      LD  A,(HL)
0007A0 47A0 2B               6      DEC HL
0007A1 47A1 B7               4      OR  A
0007A2 47A2 2805            12      JR  Z,ROM_NEXT1
0007A4 47A4 FE3A             7      CP  ':'
0007A6 47A6 2801            12      JR  Z,ROM_NEXT1
0007A8 47A8 23               6      INC HL
       47A9                     ROM_NEXT1:
0007A9 47A9 5D               4      LD  E,L
0007AA 47AA 54               4      LD  D,H
                                
0007AB 47AB CD824C          17      CALL    SEARCH_END
0007AE 47AE B7               4      OR  A
0007AF 47AF 2821            12      JR  Z,REM
       47B1                     RN3:                    ;マルチステートメントの処理
0007B1 47B1 7E               7      LD  A,(HL)
                                
0007B2 47B2 FEB5             7      CP  0B5H            ;LOAD
0007B4 47B4 CA2246          10      JP  Z,ROM_LOAD
0007B7 47B7 FE8A             7      CP  08AH            ;RUN
0007B9 47B9 281B            12      JR  Z,ROM_RUN
0007BB 47BB FEB7             7      CP  0B7H            ;FILES
0007BD 47BD 2825            12      JR  Z,ROM_FILES
0007BF 47BF FED6             7      CP  0D6H            ;COPY
0007C1 47C1 CA8248          10      JP  Z,ROM_COPY
0007C4 47C4 FE20             7      CP  020H
0007C6 47C6 2807            12      JR  Z,RN_SP
                                
0007C8 47C8 3E28             7      LD  A,028H          ;JR Z,
0007CA 47CA 32A3F2          13      LD  (SWC_BLOAD_M),A
0007CD 47CD 7E               7      LD  A,(HL)
0007CE 47CE C9              10      RET
       47CF                     RN_SP:
0007CF 47CF 23               6      INC HL
0007D0 47D0 18DF            12      JR  RN3
                                
       47D2                     REM:
0007D2 47D2 EB               4      EX  DE,HL
0007D3 47D3 3E8F             7      LD  A,08FH          ;REM
0007D5 47D5 C9              10      RET
                                
       47D6                     ROM_RUN:
0007D6 47D6 23               6      INC HL
0007D7 47D7 7E               7      LD  A,(HL)
0007D8 47D8 2B               6      DEC HL
0007D9 47D9 B7               4      OR  A
0007DA 47DA C42246          17      CALL    NZ,ROM_LOAD
0007DD 47DD FE8F             7      CP  08FH            ;REM
0007DF 47DF 3E8A             7      LD  A,08AH          ;RUN
0007E1 47E1 C0              11      RET NZ
0007E2 47E2 77               7      LD  (HL),A
0007E3 47E3 C9              10      RET
                                
       47E4                     ROM_FILES:
0007E4 47E4 CD5048          17      CALL    INIT_PARAM
0007E7 47E7 CD434B          17      CALL    FILE_B
0007EA 47EA CD0354          17      CALL    GET_DISK_BANK_FDRV
0007ED 47ED 3AC9F2          13      LD  A,(SECSZ_H)
0007F0 47F0 CD8652          17      CALL    IS_BPB1
0007F3 47F3 DAEE46          10      JP  C,ERROR_DEVICE_IO_ERROR
0007F6 47F6 3AFAF2          13      LD  A,(FNAME)
0007F9 47F9 FE21             7      CP  021H
0007FB 47FB 3005            12      JR  NC,RFILES0
0007FD 47FD 060B             7      LD  B,11
0007FF 47FF CD164C          17      CALL    FILE10
       4802                     RFILES0:
000802 4802 CD204F          17      CALL    GET_DIR_DAT
       4805                     RFILES1:
000805 4805 CDDE4C          17      CALL    FILESE
000808 4808 3041            12      JR  NC,RFILES_NOT_MATCH
       480A                     RFILES_DISP:
00080A 480A E5              11      PUSH    HL
00080B 480B 110B00          10      LD  DE,0000BH   ;属性
00080E 480E 19              11      ADD HL,DE
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
00080F 480F 7E               7      LD  A,(HL)
                                #endif
000810 4810 E1              10      POP HL
000811 4811 CB4F             8      BIT 1,A     ;不可視属性
000813 4813 2033            12      JR  NZ,RFILES_NEXT
000815 4815 E5              11      PUSH    HL
000816 4816 0608             7      LD  B,8
000818 4818 CDEE44          17      CALL    MSN
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
00081B 481B 7E               7      LD  A,(HL)
                                #endif
00081C 481C FE20             7      CP  020H
00081E 481E F5              11      PUSH    AF
00081F 481F 3E2E             7      LD  A,'.'
000821 4821 C47A54          17      CALL    NZ,MSG_A
000824 4824 0603             7      LD  B,3
000826 4826 CDEE44          17      CALL    MSN
000829 4829 F1              10      POP AF
00082A 482A CC7A54          17      CALL    Z,MSG_A
00082D 482D 3ADDF3          13      LD  A,(CSRX)
000830 4830 47               4      LD  B,A
000831 4831 3AB0F3          13      LD  A,(LINLEN)
000834 4834 90               4      SUB B
000835 4835 FE0C             7      CP  12
000837 4837 3009            12      JR  NC,RFILES2
000839 4839 3E0D             7      LD  A,00DH      ;改行
00083B 483B CD7A54          17      CALL    MSG_A
00083E 483E 3E0A             7      LD  A,00AH
000840 4840 1802            12      JR  RFILES3
       4842                     RFILES2:
000842 4842 3E20             7      LD  A,020H
       4844                     RFILES3:
000844 4844 CD7A54          17      CALL    MSG_A
000847 4847 E1              10      POP HL
       4848                     RFILES_NEXT:
000848 4848 CDFA4C          17      CALL    FNEXT
       484B                     RFILES_NOT_MATCH:
00084B 484B 20B8            12      JR  NZ,RFILES1
00084D 484D C39C47          10      JP  ROM_NEXT
                                
       4850                     INIT_PARAM:
000850 4850 22F3F2          16      LD  (PARAM0),HL
000853 4853 22F5F2          16      LD  (PARAM1),HL
000856 4856 EB               4      EX  DE,HL
000857 4857 32BEFC          13      LD  (RUNBNF),A
00085A 485A 3263F6          13      LD  (VALTYP),A
00085D 485D E5              11      PUSH    HL
00085E 485E 2AEBF2          16      LD  HL,(_CD)
000861 4861 22F7F2          16      LD  (_CDX),HL
000864 4864 E1              10      POP HL
000865 4865 13               6      INC DE
000866 4866 CD524C          17      CALL    SPCUT
000869 4869 1A               7      LD  A,(DE)
00086A 486A B7               4      OR  A
00086B 486B C8              11      RET Z
00086C 486C FE3A             7      CP  ':'
00086E 486E C8              11      RET Z
00086F 486F FE28             7      CP  '('
000871 4871 C8              11      RET Z
000872 4872 EB               4      EX  DE,HL
000873 4873 DD21644C        14      LD  IX,FRMEVL
000877 4877 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00087B 487B CD1C00          17      CALL    _CALSLT
00087E 487E 22F5F2          16      LD  (PARAM1),HL
000881 4881 C9              10      RET
                                
       4882                     ROM_COPY:
000882 4882 CD5048          17      CALL    INIT_PARAM
000885 4885 3A63F6          13      LD  A,(VALTYP)
000888 4888 FE03             7      CP  3       ;string
00088A 488A C23E4B          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
00088D 488D CD434B          17      CALL    FILE_B
000890 4890 CDC24C          17      CALL    ROM_OPEN
000893 4893 DAF746          10      JP  C,ERROR_FILE_NOT_FOUND
                                
000896 4896 21DEF2          10      LD  HL,_BUF_W
000899 4899 22D4F2          16      LD  (_DTA),HL
00089C 489C 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
00089F 489F CDA24A          17      CALL    ROM_READ
                                
0008A2 48A2 AF               4      XOR A
0008A3 48A3 32D9F2          13      LD  (_BUF_LO),A     ;PSET
0008A6 48A6 32E6F2          13      LD  (_BUF_O),A      ;向き
                                
0008A9 48A9 2AF5F2          16      LD  HL,(PARAM1)
       48AC                     RCP_PARAM1:
0008AC 48AC 7E               7      LD  A,(HL)
0008AD 48AD 23               6      INC HL
0008AE 48AE B7               4      OR  A
0008AF 48AF CAA947          10      JP  Z,ROM_NEXT1
0008B2 48B2 FE3A             7      CP  ':'
0008B4 48B4 CAA947          10      JP  Z,ROM_NEXT1
0008B7 48B7 FE2C             7      CP  ','
0008B9 48B9 2012            12      JR  NZ,RCP_PARAM1_
                                
0008BB 48BB DD212F54        14      LD  IX,FRMQNT
0008BF 48BF FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0008C3 48C3 CD1C00          17      CALL    _CALSLT
0008C6 48C6 7B               4      LD  A,E
0008C7 48C7 87               4      ADD A,A
0008C8 48C8 87               4      ADD A,A
0008C9 48C9 32E6F2          13      LD  (_BUF_O),A
0008CC 48CC 7E               7      LD  A,(HL)
       48CD                     RCP_PARAM1_:
0008CD 48CD FE28             7      CP  '('
0008CF 48CF 20DB            12      JR  NZ,RCP_PARAM1
0008D1 48D1 DD212F54        14      LD  IX,FRMQNT
0008D5 48D5 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0008D9 48D9 CD1C00          17      CALL    _CALSLT
                                
0008DC 48DC ED53E2F2        20      LD  (_BUF_X),DE
                                
       48E0                     RCP_PARAM2:
0008E0 48E0 23               6      INC HL
0008E1 48E1 7E               7      LD  A,(HL)
0008E2 48E2 FE20             7      CP  020H
0008E4 48E4 28FA            12      JR  Z,RCP_PARAM2
0008E6 48E6 FE2C             7      CP  ','
0008E8 48E8 28F6            12      JR  Z,RCP_PARAM2
                                
0008EA 48EA DD212F54        14      LD  IX,FRMQNT
0008EE 48EE FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0008F2 48F2 CD1C00          17      CALL    _CALSLT
                                
0008F5 48F5 3AF6FA          13      LD  A,(ACPAGE)
0008F8 48F8 57               4      LD  D,A
0008F9 48F9 ED53E4F2        20      LD  (_BUF_Y),DE
       48FD                     RCP_PARAM3:
0008FD 48FD 23               6      INC HL
0008FE 48FE 7E               7      LD  A,(HL)
0008FF 48FF FE20             7      CP  020H
000901 4901 28FA            12      JR  Z,RCP_PARAM3
000903 4903 FE29             7      CP  ')'
000905 4905 28F6            12      JR  Z,RCP_PARAM3
000907 4907 FE2C             7      CP  ','
000909 4909 2033            12      JR  NZ,RCP_ST
                                
00090B 490B 23               6      INC HL
00090C 490C DD212F54        14      LD  IX,FRMQNT
000910 4910 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000914 4914 CD1C00          17      CALL    _CALSLT
                                
000917 4917 7B               4      LD  A,E
000918 4918 32E5F2          13      LD  (_BUF_P),A
                                
       491B                     RCP_PARAM4:
00091B 491B 7E               7      LD  A,(HL)
00091C 491C 23               6      INC HL
00091D 491D FE20             7      CP  020H
00091F 491F 28FA            12      JR  Z,RCP_PARAM4
                                
000921 4921 FE2C             7      CP  ','
000923 4923 2019            12      JR  NZ,RCP_ST
                                
000925 4925 7E               7      LD  A,(HL)
000926 4926 0604             7      LD  B,4
000928 4928 FEC3             7      CP  0C3H        ;PRESET
00092A 492A 280E            12      JR  Z,RCP_LO
00092C 492C 05               4      DEC B       ;3
00092D 492D D6F8             7      SUB 0F8H        ;XOR
00092F 492F 2809            12      JR  Z,RCP_LO
000931 4931 05               4      DEC B       ;2
000932 4932 3C               4      INC A       ;OR
000933 4933 2805            12      JR  Z,RCP_LO
000935 4935 05               4      DEC B       ;1
000936 4936 3C               4      INC A       ;AND
000937 4937 2801            12      JR  Z,RCP_LO
000939 4939 05               4      DEC B       ;0
                                                ;PSET
       493A                     RCP_LO:
00093A 493A 78               4      LD  A,B
00093B 493B 32D9F2          13      LD  (_BUF_LO),A
       493E                     RCP_ST:
00093E 493E 2AC6F6          16      LD  HL,(STREND)
000941 4941 22D4F2          16      LD  (_DTA),HL
000944 4944 EB               4      EX  DE,HL
000945 4945 2100FE          10      LD  HL,-512
000948 4948 39              11      ADD HL,SP
000949 4949 AF               4      XOR A
00094A 494A ED52            15      SBC HL,DE
00094C 494C 3008            12      JR  NC,RCP0
00094E 494E 215EF5          10      LD  HL,BUF
000951 4951 22D4F2          16      LD  (_DTA),HL
000954 4954 6F               4      LD  L,A ;0
000955 4955 67               4      LD  H,A ;0
       4956                     RCP0:
000956 4956 24               4      INC H
000957 4957 22DCF2          16      LD  (_BUF_EN),HL
       495A                     RCP1:
00095A 495A F3               4      DI
00095B 495B CD304A          17      CALL    WAIT_VDP
                                
00095E 495E 3A0700          13      LD  A,(WRVDP)
000961 4961 4F               4      LD  C,A
000962 4962 0C               4      INC C       ;C := PORT#1's address(WR)
000963 4963 3E24             7      LD  A,36
000965 4965 ED79            12      OUT (C),A
000967 4967 3E91             7      LD  A,080H+17
000969 4969 ED79            12      OUT (C),A       ;R#17 := 36
                                
00096B 496B 0C               4      INC C
00096C 496C 0C               4      INC C       ;C := PORT#3's address(WR)
00096D 496D 2AE2F2          16      LD  HL,(_BUF_X)
000970 4970 ED69            12      OUT (C),L       ;R#36 DX
000972 4972 ED61            12      OUT (C),H       ;R#37
000974 4974 2AE4F2          16      LD  HL,(_BUF_Y)
000977 4977 ED69            12      OUT (C),L       ;R#38 DY
000979 4979 ED61            12      OUT (C),H       ;R#39
00097B 497B 2ADEF2          16      LD  HL,(_BUF_W)
00097E 497E ED69            12      OUT (C),L       ;R#40 NX
000980 4980 ED61            12      OUT (C),H       ;R#41
000982 4982 2AE0F2          16      LD  HL,(_BUF_H)
000985 4985 ED69            12      OUT (C),L       ;R#42 NY
000987 4987 ED61            12      OUT (C),H       ;R#43
                                
000989 4989 DD2AAFFC        20      LD  IX,(SCRMOD)
00098D 498D 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000990 4990 B7               4      OR  A
000991 4991 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000993 4993 DD7D             9      LD  A,IXL
000995 4995 FE08             7      CP  8
000997 4997 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
000999 4999 FE06             7      CP  6
00099B 499B 2AE2F2          16      LD  HL,(_BUF_X)
00099E 499E 3ADEF2          13      LD  A,(_BUF_W)
0009A1 49A1 2005            12      JR  NZ,SCR57
0009A3 49A3 B5               4      OR  L       ;スクリーン6
0009A4 49A4 E603             7      AND 3
0009A6 49A6 200D            12      JR  NZ,USE_LMMC
       49A8                     SCR57:              ;スクリーン5,7
0009A8 49A8 B5               4      OR  L
0009A9 49A9 E601             7      AND 1
0009AB 49AB 2008            12      JR  NZ,USE_LMMC
       49AD                     USE_HMMC:
0009AD 49AD DD2E08          10      LD  IXL,8
       49B0                     USE_HMMC8:
0009B0 49B0 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
0009B2 49B2 32D9F2          13      LD  (_BUF_LO),A
       49B5                     USE_LMMC:
0009B5 49B5 110000          10      LD  DE,0
0009B8 49B8 06FF             7      LD  B,-1
0009BA 49BA CD5B4A          17      CALL    GET_PIXEL
0009BD 49BD ED79            12      OUT (C),A       ;R#44 first DATA
0009BF 49BF 3AE6F2          13      LD  A,(_BUF_O)
0009C2 49C2 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
0009C4 49C4 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0009C7 49C7 F6B0             7      OR  0B0H        ;R#46 LMMC command
0009C9 49C9 ED79            12      OUT (C),A
                                
0009CB 49CB FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
0009CD 49CD 0D               4      DEC C
0009CE 49CE 0D               4      DEC C       ;C := PORT#1's address(WR)
0009CF 49CF 3EAC             7      LD  A,080H+44
0009D1 49D1 ED79            12      OUT (C),A
0009D3 49D3 3E91             7      LD  A,080H+17
0009D5 49D5 ED79            12      OUT (C),A       ;R#17 := 44
                                
0009D7 49D7 3A0600          13      LD  A,(RDVDP)
0009DA 49DA 3C               4      INC A
0009DB 49DB FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
0009DD 49DD 3E02             7      LD  A,2
0009DF 49DF ED79            12      OUT (C),A
0009E1 49E1 3E8F             7      LD  A,08FH
0009E3 49E3 ED79            12      OUT (C),A
0009E5 49E5 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0009E8 49E8 E640             7      AND 040H
0009EA 49EA 201C            12      JR  NZ,LOOP_HMMC
       49EC                     LOOP_COPY:
0009EC 49EC CD5B4A          17      CALL    GET_PIXEL
0009EF 49EF 08               4      EX  AF,AF'
0009F0 49F0 FD4C             9      LD  C,IYH
       49F2                     LOOP_COPY1:
0009F2 49F2 ED78            12      IN  A,(C)
0009F4 49F4 0F               4      RRCA            ;RRCAではサインフラグは変化しない
0009F5 49F5 300A            12      JR  NC,EXIT_COPY    ;check CE bit
0009F7 49F7 F2F249          10      JP  P,LOOP_COPY1    ;check TR bit
0009FA 49FA 08               4      EX  AF,AF'
0009FB 49FB FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
0009FD 49FD ED79            12      OUT (C),A
0009FF 49FF 18EB            12      JR  LOOP_COPY
                                
       4A01                     EXIT_COPY:
000A01 4A01 CD384A          17      CALL    GET_STATUS_0
000A04 4A04 FB               4      EI
000A05 4A05 C39C47          10      JP  ROM_NEXT
                                
       4A08                     LOOP_HMMC:
000A08 4A08 F3               4      DI          ;必要
000A09 4A09 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000A0B 4A0B 43               4      LD  B,E
000A0C 4A0C 7B               4      LD  A,E
000A0D 4A0D B7               4      OR  A
000A0E 4A0E 2802            12      JR  Z,LOOP_HMMC1
000A10 4A10 EDB3                    OTIR
       4A12                     LOOP_HMMC1:
000A12 4A12 14               4      INC D
       4A13                     LOOP_HMMC2:
000A13 4A13 15               4      DEC D
000A14 4A14 2805            12      JR  Z,LOOP_HMMC3
000A16 4A16 EDB3                    OTIR
000A18 4A18 C3134A          10      JP  LOOP_HMMC2
       4A1B                     LOOP_HMMC3:
000A1B 4A1B ED78            12      IN  A,(C)
000A1D 4A1D 0F               4      RRCA
000A1E 4A1E 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
000A20 4A20 2ADCF2          16      LD  HL,(_BUF_EN)
000A23 4A23 CDA24A          17      CALL    ROM_READ
000A26 4A26 EB               4      EX  DE,HL
000A27 4A27 2AD4F2          16      LD  HL,(_DTA)
000A2A 4A2A 7A               4      LD  A,D
000A2B 4A2B B3               4      OR  E
000A2C 4A2C 20DA            12      JR  NZ,LOOP_HMMC
000A2E 4A2E 18C2            12      JR  LOOP_COPY1
                                    
       4A30                     WAIT_VDP:
000A30 4A30 3E02             7      LD  A,2
000A32 4A32 CD394A          17      CALL    GET_STATUS
000A35 4A35 0F               4      RRCA
000A36 4A36 38F8            12      JR  C,WAIT_VDP
       4A38                     GET_STATUS_0:
000A38 4A38 AF               4      XOR A
       4A39                     GET_STATUS:
000A39 4A39 C5              11      PUSH    BC
000A3A 4A3A ED4B0600        20      LD  BC,(RDVDP)
000A3E 4A3E 0C               4      INC C
000A3F 4A3F ED79            12      OUT (C),A
000A41 4A41 3E8F             7      LD  A,08FH
000A43 4A43 ED79            12      OUT (C),A
000A45 4A45 ED78            12      IN  A,(C)
000A47 4A47 C1              10      POP BC
000A48 4A48 C9              10      RET
                                
       4A49                     GET_PIXEL256:
000A49 4A49 7A               4      LD  A,D
000A4A 4A4A B3               4      OR  E
000A4B 4A4B 200A            12      JR  NZ,GET_PIXEL1
000A4D 4A4D 2ADCF2          16      LD  HL,(_BUF_EN)
000A50 4A50 CDA24A          17      CALL    ROM_READ
000A53 4A53 EB               4      EX  DE,HL
000A54 4A54 2AD4F2          16      LD  HL,(_DTA)
       4A57                     GET_PIXEL1:
000A57 4A57 7E               7      LD  A,(HL)
000A58 4A58 23               6      INC HL
000A59 4A59 1B               6      DEC DE
000A5A 4A5A C9              10      RET
                                
       4A5B                     GET_PIXEL:
000A5B 4A5B DD7D             9      LD  A,IXL
000A5D 4A5D FE08             7      CP  8
000A5F 4A5F 28E8            12      JR  Z,GET_PIXEL256
000A61 4A61 04               4      INC B
000A62 4A62 FE06             7      CP  6
000A64 4A64 282E            12      JR  Z,GET_PIXEL4
                                
000A66 4A66 CB40             8      BIT 0,B
000A68 4A68 20ED            12      JR  NZ,GET_PIXEL1
                                
000A6A 4A6A 7A               4      LD  A,D
000A6B 4A6B B3               4      OR  E
000A6C 4A6C 200A            12      JR  NZ,GET_PIXEL2
                                
000A6E 4A6E 2ADCF2          16      LD  HL,(_BUF_EN)
000A71 4A71 CDA24A          17      CALL    ROM_READ
000A74 4A74 EB               4      EX  DE,HL
000A75 4A75 2AD4F2          16      LD  HL,(_DTA)
                                
       4A78                     GET_PIXEL2:
000A78 4A78 7E               7      LD  A,(HL)
000A79 4A79 0F               4      RRCA
000A7A 4A7A 0F               4      RRCA
000A7B 4A7B 0F               4      RRCA
000A7C 4A7C 0F               4      RRCA
000A7D 4A7D C9              10      RET
                                
       4A7E                     GET_PIXEL3:
000A7E 4A7E 7A               4      LD  A,D
000A7F 4A7F B3               4      OR  E
000A80 4A80 200A            12      JR  NZ,GET_PIXEL5
                                
000A82 4A82 2ADCF2          16      LD  HL,(_BUF_EN)
000A85 4A85 CDA24A          17      CALL    ROM_READ
000A88 4A88 EB               4      EX  DE,HL
000A89 4A89 2AD4F2          16      LD  HL,(_DTA)
       4A8C                     GET_PIXEL5:
000A8C 4A8C 7E               7      LD  A,(HL)
000A8D 4A8D 0F               4      RRCA
000A8E 4A8E 0F               4      RRCA
000A8F 4A8F 0F               4      RRCA
000A90 4A90 0F               4      RRCA
000A91 4A91 0F               4      RRCA
000A92 4A92 0F               4      RRCA
000A93 4A93 C9              10      RET
                                
       4A94                     GET_PIXEL4:
000A94 4A94 78               4      LD  A,B
000A95 4A95 E603             7      AND 3   ;+0
000A97 4A97 28E5            12      JR  Z,GET_PIXEL3
000A99 4A99 3D               4      DEC A   ;+1
000A9A 4A9A 28DC            12      JR  Z,GET_PIXEL2
000A9C 4A9C 3D               4      DEC A   ;+2
000A9D 4A9D 7E               7      LD  A,(HL)
000A9E 4A9E C0              11      RET NZ
000A9F 4A9F 0F               4      RRCA        ;+3
000AA0 4AA0 0F               4      RRCA
000AA1 4AA1 C9              10      RET
                                
       4AA2                     ROM_READ:
000AA2 4AA2 E5              11      PUSH    HL
000AA3 4AA3 D5              11      PUSH    DE
000AA4 4AA4 C5              11      PUSH    BC
000AA5 4AA5 FDE5            15      PUSH    IY
000AA7 4AA7 22F1F2          16      LD  (LEFTX),HL
000AAA 4AAA 2AD4F2          16      LD  HL,(_DTA)
000AAD 4AAD 22E7F2          16      LD  (DTAX),HL
000AB0 4AB0 2AF1F2          16      LD  HL,(LEFTX)
                                
000AB3 4AB3 CD544D          17      CALL    RBX1
000AB6 4AB6 3870            12      JR  C,RBRERR1
000AB8 4AB8 79               4      LD  A,C
000AB9 4AB9 EB               4      EX  DE,HL
000ABA 4ABA ED52            15      SBC HL,DE       ;CP 0HL,CDE
000ABC 4ABC 19              11      ADD HL,DE
000ABD 4ABD DE00             7      SBC A,000H
000ABF 4ABF 3801            12      JR  C,RBR1
000AC1 4AC1 EB               4      EX  DE,HL
       4AC2                     RBR1:
000AC2 4AC2 9F               4      SBC A,A
000AC3 4AC3 E601             7      AND 1
000AC5 4AC5 32C3F2          13      LD  (_RESULT),A
000AC8 4AC8 7C               4      LD  A,H
000AC9 4AC9 B5               4      OR  L
000ACA 4ACA CA1E4B          10      JP  Z,RBREND0
                                
000ACD 4ACD 22D0F2          16      LD  (_LEFT),HL  ;Read record byte
000AD0 4AD0 22F1F2          16      LD  (LEFTX),HL
                                
000AD3 4AD3 CD804D          17      CALL    RBX2
000AD6 4AD6 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000AD8 4AD8 CD934D          17      CALL    RBXA
000ADB 4ADB DA344B          10      JP  C,RBRERR
000ADE 4ADE C5              11      PUSH    BC
000ADF 4ADF CD0B45          17      CALL    ROM_LDIR
000AE2 4AE2 ED53E7F2        20      LD  (DTAX),DE
000AE6 4AE6 2AF1F2          16      LD  HL,(LEFTX)
000AE9 4AE9 D1              10      POP DE
000AEA 4AEA A7               4      AND A
000AEB 4AEB ED52            15      SBC HL,DE
000AED 4AED 22F1F2          16      LD  (LEFTX),HL
000AF0 4AF0 2829            12      JR  Z,RBREND
                                
       4AF2                     RBRB:
000AF2 4AF2 CDCF4D          17      CALL    RBXB
000AF5 4AF5 2818            12      JR  Z,RBRC
       4AF7                     RBRB1:
000AF7 4AF7 C5              11      PUSH    BC
000AF8 4AF8 D5              11      PUSH    DE
000AF9 4AF9 CD7A4E          17      CALL    CLUST
000AFC 4AFC EB               4      EX  DE,HL
000AFD 4AFD ED4BC6F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000B01 4B01 CD0B45          17      CALL    ROM_LDIR
000B04 4B04 EB               4      EX  DE,HL
000B05 4B05 D1              10      POP DE
000B06 4B06 C1              10      POP BC
000B07 4B07 CD574E          17      CALL    GNCL
000B0A 4B0A DA344B          10      JP  C,RBRERR
000B0D 4B0D 10E8            13      DJNZ    RBRB1
       4B0F                     RBRC:
000B0F 4B0F CDE74D          17      CALL    RBXC
000B12 4B12 2807            12      JR  Z,RBREND
                                
000B14 4B14 CD7A4E          17      CALL    CLUST
000B17 4B17 EB               4      EX  DE,HL
000B18 4B18 CD0B45          17      CALL    ROM_LDIR
       4B1B                     RBREND:
000B1B 4B1B CDF34D          17      CALL    RBXEND
       4B1E                     RBREND0:
000B1E 4B1E FDE1            14      POP IY
000B20 4B20 C1              10      POP BC
000B21 4B21 D1              10      POP DE
000B22 4B22 F1              10      POP AF  ;(HL)
000B23 4B23 AF               4      XOR A
000B24 4B24 3AC3F2          13      LD  A,(_RESULT)
000B27 4B27 C9              10      RET
                                
       4B28                     RBRERR1:
000B28 4B28 3E01             7      LD  A,001H
       4B2A                     RBRERR2:
000B2A 4B2A FDE1            14      POP IY
000B2C 4B2C C1              10      POP BC
000B2D 4B2D D1              10      POP DE
000B2E 4B2E E1              10      POP HL
000B2F 4B2F 37               4      SCF
000B30 4B30 210000          10      LD  HL,0
000B33 4B33 C9              10      RET
       4B34                     RBRERR:
000B34 4B34 3EFF             7      LD  A,0FFH
000B36 4B36 18F2            12      JR  RBRERR2
                                
       4B38                     FILE_DD:
000B38 4B38 E1              10      POP HL
000B39 4B39 3E                      DB  03EH
000B3A 4B3A C9              10      RET
000B3B 4B3B 32A3F2          13      LD  (SWC_BLOAD_M),A
       4B3E                     ROM_ORG:
000B3E 4B3E 2AF3F2          16      LD  HL,(PARAM0)
000B41 4B41 7E               7      LD  A,(HL)
000B42 4B42 C9              10      RET
       4B43                     FILE_B:
000B43 4B43 AF               4      XOR A
000B44 4B44 32F9F2          13      LD  (FDRV),A
000B47 4B47 1E00             7      LD  E,0
000B49 4B49 3A63F6          13      LD  A,(VALTYP)
000B4C 4B4C FE03             7      CP  3       ;string
000B4E 4B4E C2D34B          10      JP  NZ,FILED
                                
000B51 4B51 DD21D067        14      LD  IX,FRESTR
000B55 4B55 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000B59 4B59 CD1C00          17      CALL    _CALSLT
000B5C 4B5C E5              11      PUSH    HL
000B5D 4B5D DDE1            14      POP IX
                                
000B5F 4B5F DD5E00          19      LD  E,(IX+0)
000B62 4B62 DD7E01          19      LD  A,(IX+1)
000B65 4B65 DD5602          19      LD  D,(IX+2)
000B68 4B68 DD62             9      LD  IXH,D
000B6A 4B6A DD6F             9      LD  IXL,A
000B6C 4B6C 7B               4      LD  A,E
       4B6D                     FILE_BDOS:
000B6D 4B6D FE04             7      CP  4
000B6F 4B6F 3808            12      JR  C,FILEB1
000B71 4B71 DD7E03          19      LD  A,(IX+3)
000B74 4B74 FE3A             7      CP  ':'
000B76 4B76 28C0            12      JR  Z,FILE_DD
000B78 4B78 7B               4      LD  A,E
       4B79                     FILEB1:
000B79 4B79 FE02             7      CP  2
000B7B 4B7B 3818            12      JR  C,DEVI1
000B7D 4B7D DD7E01          19      LD  A,(IX+1)
000B80 4B80 FE3A             7      CP  ':'
000B82 4B82 2011            12      JR  NZ,DEVI1
000B84 4B84 DD7E00          19      LD  A,(IX+0)        ;DRIVE
000B87 4B87 CDAC4C          17      CALL    CAP
000B8A 4B8A D640             7      SUB '@'
000B8C 4B8C DD23            10      INC IX
000B8E 4B8E DD23            10      INC IX
000B90 4B90 1D               4      DEC E
000B91 4B91 1D               4      DEC E
000B92 4B92 32F9F2          13      LD  (FDRV),A
       4B95                     DEVI1:
000B95 4B95 DD7E00          19      LD  A,(IX+0)
000B98 4B98 D65C             7      SUB 05CH        ;\
000B9A 4B9A 2008            12      JR  NZ,NOROOT
000B9C 4B9C 6F               4      LD  L,A
000B9D 4B9D 67               4      LD  H,A
000B9E 4B9E 22F7F2          16      LD  (_CDX),HL
000BA1 4BA1 DD23            10      INC IX
000BA3 4BA3 1D               4      DEC E
       4BA4                     NOROOT:
                                
       4BA4                     SETDIR:
000BA4 4BA4 CDD34B          17      CALL    FILED
000BA7 4BA7 DD7E00          19      LD  A,(IX+0)
000BAA 4BAA FE5C             7      CP  05CH        ;\
000BAC 4BAC C0              11      RET NZ
000BAD 4BAD DD23            10      INC IX
000BAF 4BAF 1D               4      DEC E
000BB0 4BB0 3AFAF2          13      LD  A,(FNAME)
000BB3 4BB3 FE20             7      CP  020H        ;. の処理
000BB5 4BB5 28ED            12      JR  Z,SETDIR
                                
000BB7 4BB7 CDC24C          17      CALL    ROM_OPEN
000BBA 4BBA B7               4      OR  A
000BBB 4BBB C0              11      RET NZ
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                #else
000BBC 4BBC FD2AEDF2        20      LD  IY,(DIRENT1)
000BC0 4BC0 FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000BC4 4BC4 C8              11      RET Z
000BC5 4BC5 CD1A4C          17      CALL    FILEI
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
000BC8 4BC8 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000BCB 4BCB FD661B          19      LD  H,(IY+01BH)
                                #endif
000BCE 4BCE 22F7F2          16      LD  (_CDX),HL
000BD1 4BD1 18D1            12      JR  SETDIR
                                
       4BD3                     FILED:
000BD3 4BD3 CD1A4C          17      CALL    FILEI
000BD6 4BD6 21FAF2          10      LD  HL,FNAME
                                
000BD9 4BD9 0608             7      LD  B,8
       4BDB                     FILE2:
000BDB 4BDB CD274C          17      CALL    CCHKF
000BDE 4BDE C8              11      RET Z
000BDF 4BDF FE2A             7      CP  '*'
000BE1 4BE1 282E            12      JR  Z,FILE9
000BE3 4BE3 FE2E             7      CP  '.'
000BE5 4BE5 280C            12      JR  Z,FILE4
000BE7 4BE7 77               7      LD  (HL),A
000BE8 4BE8 23               6      INC HL
000BE9 4BE9 10F0            13      DJNZ    FILE2
                                
       4BEB                     FILE3:
000BEB 4BEB CD274C          17      CALL    CCHKF
000BEE 4BEE C8              11      RET Z
000BEF 4BEF FE2E             7      CP  '.'
000BF1 4BF1 20F8            12      JR  NZ,FILE3
                                
       4BF3                     FILE4:
000BF3 4BF3 2102F3          10      LD  HL,FNAME+8
000BF6 4BF6 0603             7      LD  B,3
                                
       4BF8                     FILE4L:
000BF8 4BF8 CD274C          17      CALL    CCHKF
000BFB 4BFB C8              11      RET Z
000BFC 4BFC FE2E             7      CP  '.'
000BFE 4BFE 2008            12      JR  NZ,FILE12
000C00 4C00 32FAF2          13      LD  (FNAME),A   ;Parent directory(..)
000C03 4C03 32FBF2          13      LD  (FNAME+1),A
000C06 4C06 3E20             7      LD  A,020H
       4C08                     FILE12:
000C08 4C08 FE2A             7      CP  '*'
000C0A 4C0A 280A            12      JR  Z,FILE10
000C0C 4C0C 77               7      LD  (HL),A
000C0D 4C0D 23               6      INC HL
000C0E 4C0E 10E8            13      DJNZ    FILE4L
000C10 4C10 C9              10      RET
                                
       4C11                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000C11 4C11 CD164C          17      CALL    FILE10
000C14 4C14 18D5            12      JR  FILE3
                                
       4C16                     FILE10:
000C16 4C16 3E3F             7      LD  A,'?'
000C18 4C18 1808            12      JR  FILL_MEMORY
       4C1A                     FILEI:              ;名前＋拡張子をスペースで初期化
000C1A 4C1A 3E20             7      LD  A,020H
000C1C 4C1C 01000B          10      LD  BC,11*256   ;C=0にしておく
000C1F 4C1F 21FAF2          10      LD  HL,FNAME
       4C22                     FILL_MEMORY:            ;HLからBバイトAで埋める
000C22 4C22 77               7      LD  (HL),A
000C23 4C23 23               6      INC HL
000C24 4C24 10FC            13      DJNZ    FILL_MEMORY
000C26 4C26 C9              10      RET
                                
       4C27                     CCHKF:
000C27 4C27 7B               4      LD  A,E
000C28 4C28 B7               4      OR  A
000C29 4C29 C8              11      RET Z
000C2A 4C2A DD7E00          19      LD  A,(IX+0)
000C2D 4C2D CD344C          17      CALL    CCHK2
000C30 4C30 C8              11      RET Z
000C31 4C31 C3974C          10      JP  FKAN
                                
       4C34                     CCHK2:
000C34 4C34 0C               4      INC C
000C35 4C35 0D               4      DEC C
000C36 4C36 C0              11      RET NZ
       4C37                     CCHK3:              ;ZF=1 で使えない文字
000C37 4C37 FE2B             7      CP  '+'
000C39 4C39 C8              11      RET Z
000C3A 4C3A FE2C             7      CP  ','
000C3C 4C3C C8              11      RET Z
000C3D 4C3D FE2F             7      CP  '/'
000C3F 4C3F C8              11      RET Z
000C40 4C40 FE3A             7      CP  ':'
000C42 4C42 C8              11      RET Z
000C43 4C43 FE3B             7      CP  ';'
000C45 4C45 C8              11      RET Z
000C46 4C46 FE3D             7      CP  '='
000C48 4C48 C8              11      RET Z
000C49 4C49 FE5C             7      CP  05CH    ;\
000C4B 4C4B C8              11      RET Z
000C4C 4C4C FE1F             7      CP  01FH
000C4E 4C4E D0              11      RET NC
000C4F 4C4F BF               4      CP  A       ;Z=1
000C50 4C50 C9              10      RET
                                
       4C51                     SS1:
000C51 4C51 13               6      INC DE
       4C52                     SPCUT:              ;スペースをカット
000C52 4C52 1A               7      LD  A,(DE)
000C53 4C53 FE20             7      CP  020H
000C55 4C55 28FA            12      JR  Z,SS1
000C57 4C57 C9              10      RET
                                
       4C58                     SCREOF1:
000C58 4C58 13               6      INC DE
       4C59                     SPCUTEX:            ;スペース改行などをカット
000C59 4C59 1A               7      LD  A,(DE)
000C5A 4C5A FE20             7      CP  020H
000C5C 4C5C 28FA            12      JR  Z,SCREOF1
000C5E 4C5E FE0D             7      CP  00DH
000C60 4C60 28F6            12      JR  Z,SCREOF1
000C62 4C62 FE0A             7      CP  00AH
000C64 4C64 28F2            12      JR  Z,SCREOF1
000C66 4C66 FE1A             7      CP  01AH
000C68 4C68 28EE            12      JR  Z,SCREOF1
000C6A 4C6A C9              10      RET
                                
       4C6B                     GETNUM:
000C6B 4C6B 210000          10      LD  HL,0
       4C6E                     GETNUM1:
000C6E 4C6E 1A               7      LD  A,(DE)
000C6F 4C6F 13               6      INC DE
000C70 4C70 D630             7      SUB '0'
000C72 4C72 D8              11      RET C
000C73 4C73 FE0A             7      CP  10
000C75 4C75 D0              11      RET NC
000C76 4C76 4D               4      LD  C,L
000C77 4C77 44               4      LD  B,H
000C78 4C78 29              11      ADD HL,HL   ;*2
000C79 4C79 29              11      ADD HL,HL   ;*4
000C7A 4C7A 09              11      ADD HL,BC   ;*5
000C7B 4C7B 29              11      ADD HL,HL   ;*10
000C7C 4C7C 4F               4      LD  C,A
000C7D 4C7D 0600             7      LD  B,0
000C7F 4C7F 09              11      ADD HL,BC
000C80 4C80 18EC            12      JR  GETNUM1
                                
       4C82                     SEARCH_END:
000C82 4C82 7E               7      LD  A,(HL)
       4C83                     SEARCH_END1:
000C83 4C83 23               6      INC HL
000C84 4C84 B7               4      OR  A
000C85 4C85 C8              11      RET Z
000C86 4C86 FE3A             7      CP  ':'
000C88 4C88 20F8            12      JR  NZ,SEARCH_END
000C8A 4C8A 7E               7      LD  A,(HL)
000C8B 4C8B FE3A             7      CP  ':'
000C8D 4C8D 28F4            12      JR  Z,SEARCH_END1
000C8F 4C8F C9              10      RET
                                
       4C90                     FKANC:
000C90 4C90 CB41             8      BIT 0,C
000C92 4C92 CCB54C          17      CALL    Z,CAP2
000C95 4C95 1803            12      JR  FKANX
       4C97                     FKAN:           ;漢字チェック
000C97 4C97 DD23            10      INC IX
000C99 4C99 1D               4      DEC E
       4C9A                     FKANX:
000C9A 4C9A CB41             8      BIT 0,C
000C9C 4C9C CB81             8      RES 0,C
000C9E 4C9E C0              11      RET NZ
000C9F 4C9F FE80             7      CP  080H
000CA1 4CA1 D8              11      RET C
000CA2 4CA2 FEA0             7      CP  0A0H
000CA4 4CA4 3803            12      JR  C,FKAN1
000CA6 4CA6 FEE0             7      CP  0E0H
000CA8 4CA8 D8              11      RET C
       4CA9                     FKAN1:
000CA9 4CA9 0C               4      INC C
000CAA 4CAA A7               4      AND A
000CAB 4CAB C9              10      RET
                                
       4CAC                     CAP:
000CAC 4CAC FE61             7      CP  'a'
000CAE 4CAE D8              11      RET C
000CAF 4CAF FE7B             7      CP  'z'+1
000CB1 4CB1 D0              11      RET NC
000CB2 4CB2 D620             7      SUB 020H
000CB4 4CB4 C9              10      RET
       4CB5                     CAP2:
000CB5 4CB5 CDAC4C          17      CALL    CAP
       4CB8                     CAP3:               ;
000CB8 4CB8 FE05             7      CP  5
000CBA 4CBA 2803            12      JR  Z,CAP4
000CBC 4CBC FE21             7      CP  021H
000CBE 4CBE C9              10      RET
       4CBF                     CAP4:
000CBF 4CBF 3EE5             7      LD  A,0E5H
000CC1 4CC1 C9              10      RET
                                
       4CC2                     ROM_OPEN:
000CC2 4CC2 CD0354          17      CALL    GET_DISK_BANK_FDRV
                                
000CC5 4CC5 CD204F          17      CALL    GET_DIR_DAT
000CC8 4CC8 D5              11      PUSH    DE
000CC9 4CC9 CDDE4C          17      CALL    FILESE
000CCC 4CCC D1              10      POP DE
000CCD 4CCD 3F               4      CCF
000CCE 4CCE D8              11      RET C
000CCF 4CCF 22EDF2          16      LD  (DIRENT1),HL
000CD2 4CD2 E5              11      PUSH    HL
000CD3 4CD3 210000          10      LD  HL,0
000CD6 4CD6 22CAF2          16      LD  (RR_LOW),HL
000CD9 4CD9 22CCF2          16      LD  (RR_HIGH),HL
000CDC 4CDC E1              10      POP HL
000CDD 4CDD C9              10      RET
                                
       4CDE                     FILESE:
       4CDE                     FILESE0:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000CDE 4CDE 7E               7      LD  A,(HL)
                                #endif
000CDF 4CDF B7               4      OR  A
000CE0 4CE0 C8              11      RET Z       ;END:ZF=1 CF=0
000CE1 4CE1 FEE5             7      CP  0E5H
000CE3 4CE3 280D            12      JR  Z,FILESE1
000CE5 4CE5 11FAF2          10      LD  DE,FNAME
000CE8 4CE8 E5              11      PUSH    HL
000CE9 4CE9 CD2F4D          17      CALL    CPFILE
000CEC 4CEC CC504D          17      CALL    Z,CPFILE2
000CEF 4CEF E1              10      POP HL
000CF0 4CF0 37               4      SCF
000CF1 4CF1 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4CF2                     FILESE1:
000CF2 4CF2 CDFA4C          17      CALL    FNEXT
000CF5 4CF5 20E7            12      JR  NZ,FILESE0
000CF7 4CF7 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000CF9 4CF9 C9              10      RET
                                
       4CFA                     FNEXT:
000CFA 4CFA 112000          10      LD  DE,020H
000CFD 4CFD 19              11      ADD HL,DE
000CFE 4CFE ED5BF7F2        20      LD  DE,(_CDX)
000D02 4D02 7A               4      LD  A,D
000D03 4D03 B3               4      OR  E
000D04 4D04 2019            12      JR  NZ,FNEXT_SUBDIR
000D06 4D06 0D               4      DEC C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
       4D07                     CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
000D07 4D07 F5              11      PUSH    AF      ;※フラグを保存する必要あり
000D08 4D08 CB7C             8      BIT 7,H
000D0A 4D0A 2811            12      JR  Z,CHECK_DIR_PAGE1
000D0C 4D0C 7C               4      LD  A,H
000D0D 4D0D D620             7      SUB 020H
000D0F 4D0F 67               4      LD  H,A
000D10 4D10 3AEFF2          13      LD  A,(_DIR_BANK)
000D13 4D13 3C               4      INC A
000D14 4D14 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D17 4D17 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D1A 4D1A 32EFF2          13      LD  (_DIR_BANK),A
       4D1D                     CHECK_DIR_PAGE1:
000D1D 4D1D F1              10      POP AF
                                #endif
000D1E 4D1E C9              10      RET
                                
       4D1F                     FNEXT_SUBDIR:           ;サブディレクトリ
000D1F 4D1F 0D               4      DEC C
000D20 4D20 C0              11      RET NZ
                                
000D21 4D21 ED5BF7F2        20      LD  DE,(_CDX)
000D25 4D25 CD574E          17      CALL    GNCL
000D28 4D28 EB               4      EX  DE,HL
000D29 4D29 22F7F2          16      LD  (_CDX),HL
000D2C 4D2C C35C4F          10      JP  GET_SUBDIR
                                
       4D2F                     CPFILE:
000D2F 4D2F C5              11      PUSH    BC
000D30 4D30 01000B          10      LD  BC,00B00H
       4D33                     CPSTR1:
000D33 4D33 1A               7      LD  A,(DE)
000D34 4D34 FE3F             7      CP  '?'     ;Wild card
000D36 4D36 2812            12      JR  Z,CPSTR2
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000D38 4D38 7E               7      LD  A,(HL)
                                #endif
000D39 4D39 CD904C          17      CALL    FKANC
000D3C 4D3C E5              11      PUSH    HL
000D3D 4D3D 67               4      LD  H,A
000D3E 4D3E 1A               7      LD  A,(DE)
000D3F 4D3F CB01             8      RLC C
000D41 4D41 CD904C          17      CALL    FKANC
000D44 4D44 CB09             8      RRC C
000D46 4D46 BC               4      CP  H       ;CP (HL),(DE)
000D47 4D47 E1              10      POP HL
000D48 4D48 2004            12      JR  NZ,CPSTR3
       4D4A                     CPSTR2:
000D4A 4D4A 13               6      INC DE
000D4B 4D4B 23               6      INC HL
000D4C 4D4C 10E5            13      DJNZ    CPSTR1
       4D4E                     CPSTR3:
000D4E 4D4E C1              10      POP BC
000D4F 4D4F C9              10      RET
                                
       4D50                     CPFILE2:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000D50 4D50 7E               7      LD  A,(HL)
                                #endif
000D51 4D51 E608             7      AND 008H    ;~0F7H
000D53 4D53 C9              10      RET
                                
       4D54                     RBX1:
000D54 4D54 E5              11      PUSH    HL      ;Record byte
                                
000D55 4D55 ED5BCAF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000D59 4D59 3ACDF2          13      LD  A,(RR_HIGH+1)
000D5C 4D5C 4F               4      LD  C,A
                                
000D5D 4D5D 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001CH
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    CALL    RDSLT_ROM
                                    EX  DE,HL       ;AHL=File size
                                    POP DE
                                #else
000D60 4D60 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D63 4D63 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D66 4D66 FD2AEDF2        20      LD  IY,(DIRENT1)
000D6A 4D6A FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000D6D 4D6D FD661D          19      LD  H,(IY+01DH)
000D70 4D70 FD7E1E          19      LD  A,(IY+01EH)
                                #endif
                                
000D73 4D73 A7               4      AND A
000D74 4D74 ED52            15      SBC HL,DE
000D76 4D76 99               4      SBC A,C
000D77 4D77 D1              10      POP DE
                                
000D78 4D78 D8              11      RET C
000D79 4D79 4F               4      LD  C,A
000D7A 4D7A EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000D7B 4D7B B2               4      OR  D
000D7C 4D7C B3               4      OR  E
000D7D 4D7D C0              11      RET NZ
000D7E 4D7E 37               4      SCF
000D7F 4D7F C9              10      RET
                                
       4D80                     RBX2:
000D80 4D80 ED4BCBF2        20      LD  BC,(RR_LOW+1)
000D84 4D84 CD084E          17      CALL    RWXR
000D87 4D87 3AC7F2          13      LD  A,(CLSZ_H)
000D8A 4D8A 3D               4      DEC A
000D8B 4D8B E5              11      PUSH    HL
000D8C 4D8C 2ACAF2          16      LD  HL,(RR_LOW)
000D8F 4D8F A4               4      AND H
000D90 4D90 B5               4      OR  L
000D91 4D91 E1              10      POP HL
000D92 4D92 C9              10      RET
                                
       4D93                     RBXA:
000D93 4D93 D5              11      PUSH    DE
000D94 4D94 CD7A4E          17      CALL    CLUST
000D97 4D97 ED53D2F2        20      LD  (_DTPS),DE
000D9B 4D9B D1              10      POP DE
000D9C 4D9C CD574E          17      CALL    GNCL
000D9F 4D9F D8              11      RET C
000DA0 4DA0 ED53CEF2        20      LD  (_CLPS),DE
                                
000DA4 4DA4 ED4BCAF2        20      LD  BC,(RR_LOW)
000DA8 4DA8 2AC6F2          16      LD  HL,(CLSZ)
000DAB 4DAB 7C               4      LD  A,H
000DAC 4DAC 3D               4      DEC A
000DAD 4DAD A0               4      AND B
000DAE 4DAE 47               4      LD  B,A
000DAF 4DAF ED42            15      SBC HL,BC       ;remaining cluster
                                
000DB1 4DB1 ED5BF1F2        20      LD  DE,(LEFTX)
000DB5 4DB5 ED52            15      SBC HL,DE       ;CP HL,DE
000DB7 4DB7 19              11      ADD HL,DE
000DB8 4DB8 3801            12      JR  C,RBXA1
000DBA 4DBA EB               4      EX  DE,HL
       4DBB                     RBXA1:
000DBB 4DBB 3AC4F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
000DBE 4DBE 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000DC1 4DC1 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000DC4 4DC4 E5              11      PUSH    HL
000DC5 4DC5 2AD2F2          16      LD  HL,(_DTPS)
000DC8 4DC8 09              11      ADD HL,BC
000DC9 4DC9 ED5BE7F2        20      LD  DE,(DTAX)
000DCD 4DCD C1              10      POP BC
000DCE 4DCE C9              10      RET
                                
       4DCF                     RBXB:
000DCF 4DCF 2AE7F2          16      LD  HL,(DTAX)
000DD2 4DD2 ED5BCEF2        20      LD  DE,(_CLPS)
000DD6 4DD6 3AF2F2          13      LD  A,(LEFTX+1)
000DD9 4DD9 47               4      LD  B,A
000DDA 4DDA 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4DDD                     RBXB1:
000DDD 4DDD 1F               4      RRA     ;->CF
000DDE 4DDE 3804            12      JR  C,RBXB2
000DE0 4DE0 CB38             8      SRL B   ;B=B/2
000DE2 4DE2 18F9            12      JR  RBXB1
       4DE4                     RBXB2:
000DE4 4DE4 78               4      LD  A,B
000DE5 4DE5 B7               4      OR  A
000DE6 4DE6 C9              10      RET
                                
       4DE7                     RBXC:
000DE7 4DE7 ED4BF1F2        20      LD  BC,(LEFTX)
000DEB 4DEB 3AC7F2          13      LD  A,(CLSZ_H)
000DEE 4DEE 3D               4      DEC A
000DEF 4DEF A0               4      AND B
000DF0 4DF0 47               4      LD  B,A
000DF1 4DF1 B1               4      OR  C
000DF2 4DF2 C9              10      RET
                                
       4DF3                     RBXEND:
000DF3 4DF3 ED5BD0F2        20      LD  DE,(_LEFT)
000DF7 4DF7 2ACAF2          16      LD  HL,(RR_LOW)
000DFA 4DFA 3ACDF2          13      LD  A,(RR_HIGH+1)
000DFD 4DFD 19              11      ADD HL,DE
000DFE 4DFE CE00             7      ADC A,0
000E00 4E00 22CAF2          16      LD  (RR_LOW),HL
000E03 4E03 32CDF2          13      LD  (RR_HIGH+1),A
000E06 4E06 EB               4      EX  DE,HL       ;HL=Read byte
000E07 4E07 C9              10      RET 
                                
       4E08                     RWXR:
000E08 4E08 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4E0B                     L_RWX:
000E0B 4E0B 1F               4      RRA     ;->CF
000E0C 4E0C 3806            12      JR  C,E_RWX
000E0E 4E0E CB38             8      SRL B   ;BC=BC/2
000E10 4E10 CB19             8      RR  C   ;
000E12 4E12 18F7            12      JR  L_RWX
       4E14                     E_RWX:
000E14 4E14 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
                                    PUSH    HL
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    POP HL
                                #else
000E17 4E17 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000E1A 4E1A 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000E1D 4E1D FD2AEDF2        20      LD  IY,(DIRENT1)
000E21 4E21 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000E24 4E24 FD561B          19      LD  D,(IY+01BH)
                                #endif
000E27 4E27 CD0354          17      CALL    GET_DISK_BANK_FDRV
       4E2A                     RWX1:
000E2A 4E2A ED53CEF2        20      LD  (_CLPS),DE
000E2E 4E2E 7A               4      LD  A,D
000E2F 4E2F B3               4      OR  E
000E30 4E30 37               4      SCF
000E31 4E31 C8              11      RET Z
                                
000E32 4E32 78               4      LD  A,B
000E33 4E33 B1               4      OR  C
000E34 4E34 C8              11      RET Z
                                
000E35 4E35 CD574E          17      CALL    GNCL
000E38 4E38 D8              11      RET C
000E39 4E39 0B               6      DEC BC
000E3A 4E3A CDB94E          17      CALL    ENDCL
000E3D 4E3D 38EB            12      JR  C,RWX1
000E3F 4E3F 37               4      SCF
000E40 4E40 C9              10      RET
                                
       4E41                     NCL3:
000E41 4E41 CD0354          17      CALL    GET_DISK_BANK_FDRV
000E44 4E44 6B               4      LD  L,E
000E45 4E45 62               4      LD  H,D
000E46 4E46 CB3C             8      SRL H
000E48 4E48 CB1D             8      RR  L
000E4A 4E4A 1F               4      RRA
000E4B 4E4B 19              11      ADD HL,DE
000E4C 4E4C 010060          10      LD  BC,BANK1_ADR
000E4F 4E4F 09              11      ADD HL,BC
000E50 4E50 ED4BC8F2        20      LD  BC,(SECSZ)
000E54 4E54 09              11      ADD HL,BC
000E55 4E55 17               4      RLA
000E56 4E56 C9              10      RET
                                
       4E57                     GNCL:
000E57 4E57 7A               4      LD  A,D
000E58 4E58 B3               4      OR  E
000E59 4E59 37               4      SCF
000E5A 4E5A C8              11      RET Z
000E5B 4E5B C5              11      PUSH    BC
000E5C 4E5C E5              11      PUSH    HL
000E5D 4E5D CD414E          17      CALL    NCL3
000E60 4E60 3809            12      JR  C,GNC1
000E62 4E62 5E               7      LD  E,(HL)
000E63 4E63 23               6      INC HL
000E64 4E64 7E               7      LD  A,(HL)
000E65 4E65 E60F             7      AND 00FH
000E67 4E67 57               4      LD  D,A
000E68 4E68 E1              10      POP HL
000E69 4E69 C1              10      POP BC
000E6A 4E6A C9              10      RET
       4E6B                     GNC1:
000E6B 4E6B 7E               7      LD  A,(HL)
000E6C 4E6C 23               6      INC HL
000E6D 4E6D 56               7      LD  D,(HL)
000E6E 4E6E 0604             7      LD  B,4
       4E70                     GNC1L:
000E70 4E70 CB3A             8      SRL D
000E72 4E72 1F               4      RRA
000E73 4E73 10FB            13      DJNZ    GNC1L
                                
000E75 4E75 5F               4      LD  E,A
000E76 4E76 E1              10      POP HL
000E77 4E77 C1              10      POP BC
000E78 4E78 A7               4      AND A
000E79 4E79 C9              10      RET
                                
       4E7A                     CLUST:
000E7A 4E7A EB               4      EX  DE,HL
       4E7B                     CLUST_HL:
000E7B 4E7B 2B               6      DEC HL
000E7C 4E7C 2B               6      DEC HL
000E7D 4E7D C5              11      PUSH    BC
000E7E 4E7E 3AC7F2          13      LD  A,(CLSZ_H)
000E81 4E81 CD3354          17      CALL    MUL_AHL
                                
000E84 4E84 CD3D4F          17      CALL    GET_DIR_POS
000E87 4E87 4F               4      LD  C,A
000E88 4E88 0600             7      LD  B,0
000E8A 4E8A 09              11      ADD HL,BC
                                
000E8B 4E8B ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
000E8F 4E8F CB38             8      SRL B
000E91 4E91 CB19             8      RR  C           ;/2
000E93 4E93 CB38             8      SRL B
000E95 4E95 CB19             8      RR  C           ;/4
000E97 4E97 CB38             8      SRL B
000E99 4E99 CB19             8      RR  C           ;/8
000E9B 4E9B 09              11      ADD HL,BC
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  A,L
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    JR  NC,CLUST2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
000E9C 4E9C 4D               4      LD  C,L     ;C=読み出し元
000E9D 4E9D 29              11      ADD HL,HL   ;64KB→32KB
000E9E 4E9E 29              11      ADD HL,HL   ;32KB→16KB
000E9F 4E9F 29              11      ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
000EA0 4EA0 CD0354          17      CALL    GET_DISK_BANK_FDRV
000EA3 4EA3 84               4      ADD A,H
000EA4 4EA4 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000EA7 4EA7 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000EAA 4EAA 32C4F2          13      LD  (_BANK),A
000EAD 4EAD 69               4      LD  L,C     ;C=読み出し元
000EAE 4EAE 3E1F             7      LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
000EB0 4EB0 A5               4      AND L
                                #endif
       4EB1                     CLUST2:
000EB1 4EB1 C660             7      ADD A,high BANK1_ADR
000EB3 4EB3 67               4      LD  H,A
000EB4 4EB4 2E00             7      LD  L,0
000EB6 4EB6 EB               4      EX  DE,HL
000EB7 4EB7 C1              10      POP BC
000EB8 4EB8 C9              10      RET
                                
       4EB9                     ENDCL:
000EB9 4EB9 7A               4      LD  A,D ;END CLUSTER
000EBA 4EBA FE0F             7      CP  00FH    ;FAT12の最大値
000EBC 4EBC C0              11      RET NZ
000EBD 4EBD 7B               4      LD  A,E
000EBE 4EBE FEF7             7      CP  0F7H
000EC0 4EC0 C9              10      RET
                                
       4EC1                     RB_READ:
000EC1 4EC1 AF               4      XOR A   ;HLA = HL*128
000EC2 4EC2 CB3C             8      SRL H
000EC4 4EC4 CB1D             8      RR  L
000EC6 4EC6 1F               4      RRA
000EC7 4EC7 32CAF2          13      LD  (RR_LOW),A
000ECA 4ECA 22CBF2          16      LD  (RR_MID),HL
000ECD 4ECD 218000          10      LD  HL,128
                                
000ED0 4ED0 CDA24A          17      CALL    ROM_READ
000ED3 4ED3 C9              10      RET
                                
       4ED4                     GETSEQ:
000ED4 4ED4 FD6E20          19      LD  L,(IY+32)
000ED7 4ED7 FD660C          19      LD  H,(IY+12)
                                
000EDA 4EDA CB25             8      SLA L
                                
000EDC 4EDC CB3C             8      SRL H
000EDE 4EDE CB1D             8      RR  L
000EE0 4EE0 C9              10      RET
                                
       4EE1                     SETSEQ:
000EE1 4EE1 F5              11      PUSH    AF
000EE2 4EE2 3ACAF2          13      LD  A,(RR_LOW)
000EE5 4EE5 2ACBF2          16      LD  HL,(RR_MID)
                                
000EE8 4EE8 CDFF4E          17      CALL    SSQ1
                                
000EEB 4EEB 29              11      ADD HL,HL
000EEC 4EEC CB3D             8      SRL L
000EEE 4EEE FD7520          19      LD  (IY+32),L
000EF1 4EF1 FD740C          19      LD  (IY+12),H
000EF4 4EF4 F1              10      POP AF
000EF5 4EF5 C9              10      RET
                                
       4EF6                     GETSIZE:
000EF6 4EF6 FD7E10          19      LD  A,(IY+16)
000EF9 4EF9 FD6E11          19      LD  L,(IY+17)
000EFC 4EFC FD6612          19      LD  H,(IY+18)
       4EFF                     SSQ1:
000EFF 4EFF 87               4      ADD A,A
000F00 4F00 ED6A            15      ADC HL,HL
000F02 4F02 B7               4      OR  A
000F03 4F03 C8              11      RET Z
000F04 4F04 23               6      INC HL
000F05 4F05 C9              10      RET
                                
       4F06                     SET_FCB:
000F06 4F06 D5              11      PUSH    DE
000F07 4F07 FDE1            14      POP IY
000F09 4F09 FD7E1C          19      LD  A,(IY+28)
000F0C 4F0C FEFF             7      CP  0FFH
000F0E 4F0E 200C            12      JR  NZ,POPAF_SCF_FF_RET
000F10 4F10 E5              11      PUSH    HL
000F11 4F11 FD6E1A          19      LD  L,(IY+26)
000F14 4F14 FD661B          19      LD  H,(IY+27)
000F17 4F17 22CEF2          16      LD  (_CLPS),HL
000F1A 4F1A E1              10      POP HL
000F1B 4F1B C9              10      RET
                                
       4F1C                     POPAF_SCF_FF_RET:
000F1C 4F1C F1              10      POP AF
000F1D 4F1D 37               4      SCF
000F1E 4F1E 9F               4      SBC A,A
000F1F 4F1F C9              10      RET
                                
       4F20                     GET_DIR_DAT:
000F20 4F20 2AF7F2          16      LD  HL,(_CDX)
000F23 4F23 7C               4      LD  A,H
000F24 4F24 B5               4      OR  L
000F25 4F25 2035            12      JR  NZ,GET_SUBDIR
000F27 4F27 CD3D4F          17      CALL    GET_DIR_POS
000F2A 4F2A C660             7      ADD A,high BANK1_ADR
000F2C 4F2C 2E00             7      LD  L,0
000F2E 4F2E 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
000F2F 4F2F CD074D          17      CALL    CHECK_DIR_PAGE
                                #endif
000F32 4F32 3AC5F2          13      LD  A,(_BANK1)
000F35 4F35 32EFF2          13      LD  (_DIR_BANK),A
                                
000F38 4F38 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000F3B 4F3B 4F               4      LD  C,A
000F3C 4F3C C9              10      RET
                                
       4F3D                     GET_DIR_POS:                ;ルートディレクトリ
000F3D 4F3D CD0354          17      CALL    GET_DISK_BANK_FDRV
000F40 4F40 32C5F2          13      LD  (_BANK1),A
000F43 4F43 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000F46 4F46 47               4      LD  B,A
000F47 4F47 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000F4A 4F4A 4F               4      LD  C,A
000F4B 4F4B 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4F4E                     GET_DIR_POS1:
000F4E 4F4E 81               4      ADD A,C
000F4F 4F4F 10FD            13      DJNZ    GET_DIR_POS1
                                
000F51 4F51 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
000F55 4F55 37               4      SCF     ;無限ループ回避
       4F56                     L_MDP:
000F56 4F56 CB18             8      RR  B   ;->CF
000F58 4F58 D8              11      RET C
000F59 4F59 87               4      ADD A,A
000F5A 4F5A 18FA            12      JR  L_MDP
                                
       4F5C                     GET_SUBDIR:             ;サブディレクトリ
000F5C 4F5C CD7B4E          17      CALL    CLUST_HL
000F5F 4F5F EB               4      EX  DE,HL
000F60 4F60 3AC4F2          13      LD  A,(_BANK)
000F63 4F63 32EFF2          13      LD  (_DIR_BANK),A
000F66 4F66 3AC7F2          13      LD  A,(CLSZ_H)
000F69 4F69 87               4      ADD A,A     ;*2
000F6A 4F6A 87               4      ADD A,A     ;*4
000F6B 4F6B 87               4      ADD A,A     ;*8
000F6C 4F6C 4F               4      LD  C,A
000F6D 4F6D C9              10      RET
                                
       4F6E                     STATEMENT:
000F6E 4F6E 11D851          10      LD  DE,STR_CHDIR
000F71 4F71 CDBE51          17      CALL    CPPROCNM
000F74 4F74 2812            12      JR  Z,_CHDIR
000F76 4F76 11DE51          10      LD  DE,STR_CHDRV
000F79 4F79 CDBE51          17      CALL    CPPROCNM
000F7C 4F7C 281C            12      JR  Z,_CHDRV
000F7E 4F7E 11E451          10      LD  DE,STR_RAMDISK
000F81 4F81 CDBE51          17      CALL    CPPROCNM
000F84 4F84 2829            12      JR  Z,_RAMDISK
000F86 4F86 37               4      SCF
000F87 4F87 C9              10      RET
       4F88                     _CHDIR:
000F88 4F88 7E               7      LD  A,(HL)
000F89 4F89 FE28             7      CP  '('
000F8B 4F8B 37               4      SCF
000F8C 4F8C C0              11      RET NZ
000F8D 4F8D CD5048          17      CALL    INIT_PARAM
000F90 4F90 CD434B          17      CALL    FILE_B
000F93 4F93 CDDA4F          17      CALL    ROM_CD
000F96 4F96 D0              11      RET NC
000F97 4F97 C3F746          10      JP  ERROR_FILE_NOT_FOUND
                                
       4F9A                     _CHDRV:
000F9A 4F9A 7E               7      LD  A,(HL)
000F9B 4F9B FE28             7      CP  '('
000F9D 4F9D 37               4      SCF
000F9E 4F9E C0              11      RET NZ
000F9F 4F9F CD5048          17      CALL    INIT_PARAM
000FA2 4FA2 E5              11      PUSH    HL
000FA3 4FA3 CD434B          17      CALL    FILE_B
000FA6 4FA6 E1              10      POP HL
000FA7 4FA7 23               6      INC HL
000FA8 4FA8 3AF9F2          13      LD  A,(FDRV)
000FAB 4FAB 3D               4      DEC A
000FAC 4FAC C38856          10      JP  _SYS0EX1
                                
       4FAF                     _RAMDISK:
000FAF 4FAF 7E               7      LD  A,(HL)
000FB0 4FB0 FE28             7      CP  '('
000FB2 4FB2 37               4      SCF
000FB3 4FB3 C0              11      RET NZ
000FB4 4FB4 23               6      INC HL
000FB5 4FB5 DD212F54        14      LD  IX,FRMQNT
000FB9 4FB9 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000FBD 4FBD CD1C00          17      CALL    _CALSLT
000FC0 4FC0 E5              11      PUSH    HL
000FC1 4FC1 110F00          10      LD  DE,15       ;切り上げの為
000FC4 4FC4 19              11      ADD HL,DE
000FC5 4FC5 7D               4      LD  A,L
000FC6 4FC6 0604             7      LD  B,4     ;16で割る
       4FC8                     RAMDISK1:
000FC8 4FC8 CB3C             8      SRL H   ;/2
000FCA 4FCA 1F               4      RRA
000FCB 4FCB 10FB            13      DJNZ    RAMDISK1
000FCD 4FCD FEFF             7      CP  0FFH
000FCF 4FCF 2001            12      JR  NZ,RAMDISK2
000FD1 4FD1 3D               4      DEC A
       4FD2                     RAMDISK2:
000FD2 4FD2 47               4      LD  B,A
000FD3 4FD3 CD2858          17      CALL    _SYS68
                                
000FD6 4FD6 E1              10      POP HL
000FD7 4FD7 23               6      INC HL
000FD8 4FD8 AF               4      XOR A
000FD9 4FD9 C9              10      RET
                                
       4FDA                     ROM_CD:
000FDA 4FDA 3AFAF2          13      LD  A,(FNAME)
000FDD 4FDD FE20             7      CP  020H
000FDF 4FDF 2822            12      JR  Z,CD1
000FE1 4FE1 CDC24C          17      CALL    ROM_OPEN
000FE4 4FE4 D8              11      RET C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
000FE5 4FE5 FD2AEDF2        20      LD  IY,(DIRENT1)
000FE9 4FE9 FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
000FED 4FED CAF746          10      JP  Z,ERROR_FILE_NOT_FOUND
000FF0 4FF0 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000FF3 4FF3 FD661B          19      LD  H,(IY+01BH)
                                #endif
       4FF6                     CD2:
000FF6 4FF6 22EBF2          16      LD  (_CD),HL
000FF9 4FF9 2AF5F2          16      LD  HL,(PARAM1)
       4FFC                     CD_SKIP:
000FFC 4FFC 7E               7      LD  A,(HL)
000FFD 4FFD 23               6      INC HL
000FFE 4FFE FE21             7      CP  021H
001000 5000 38FA            12      JR  C,CD_SKIP
001002 5002 C9              10      RET
       5003                     CD1:
001003 5003 2AF7F2          16      LD  HL,(_CDX)
001006 5006 18EE            12      JR  CD2
                                
       5008                     GET_BASIC_FCB:
001008 5008 D5              11      PUSH    DE
001009 5009 23               6      INC HL  ;+1
00100A 500A 5E               7      LD  E,(HL)  ;FCB[1]
00100B 500B 23               6      INC HL  ;+2
00100C 500C 56               7      LD  D,(HL)  ;FCB[2]
00100D 500D 23               6      INC HL  ;+3
00100E 500E ED53EDF2        20      LD  (DIRENT1),DE
                                            ;FCB[3] backup char
001012 5012 23               6      INC HL  ;+4
                                            ;FCB[4]
001013 5013 23               6      INC HL  ;+5
001014 5014 7E               7      LD  A,(HL)  ;FCB[5]
001015 5015 23               6      INC HL  ;+6
001016 5016 32EFF2          13      LD  (_DIR_BANK),A
001019 5019 5E               7      LD  E,(HL)  ;FCB[6]
00101A 501A 23               6      INC HL  ;+7
00101B 501B 56               7      LD  D,(HL)  ;FCB[7]
00101C 501C 23               6      INC HL  ;+8
00101D 501D ED53CAF2        20      LD  (RR_LOW),DE
001021 5021 7E               7      LD  A,(HL)  ;FCB[8]
001022 5022 23               6      INC HL  ;+9
001023 5023 32CCF2          13      LD  (RR_HIGH),A
001026 5026 22D4F2          16      LD  (_DTA),HL   ;FCB[9]
001029 5029 D1              10      POP DE
00102A 502A C9              10      RET
                                
       502B                     SET_BASIC_FCB:
00102B 502B E5              11      PUSH    HL
00102C 502C 2A64F8          16      LD  HL,(PTRFIL)
00102F 502F 23               6      INC HL  ;+1
001030 5030 D5              11      PUSH    DE
001031 5031 ED5BEDF2        20      LD  DE,(DIRENT1)
001035 5035 73               7      LD  (HL),E  ;FCB[1]
001036 5036 23               6      INC HL  ;+2
001037 5037 72               7      LD  (HL),D  ;FCB[2]
001038 5038 23               6      INC HL  ;+3
001039 5039 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
00103A 503A 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
00103B 503B 23               6      INC HL  ;+5
00103C 503C 3AEFF2          13      LD  A,(_DIR_BANK)
00103F 503F 77               7      LD  (HL),A  ;FCB[5]
001040 5040 23               6      INC HL  ;+6
001041 5041 ED5BCAF2        20      LD  DE,(RR_LOW)
001045 5045 73               7      LD  (HL),E  ;FCB[6]
001046 5046 23               6      INC HL  ;+7
001047 5047 72               7      LD  (HL),D  ;FCB[7]
001048 5048 23               6      INC HL  ;+8
001049 5049 3ACCF2          13      LD  A,(RR_HIGH)
00104C 504C 77               7      LD  (HL),A  ;FCB[8]
00104D 504D D1              10      POP DE
00104E 504E E1              10      POP HL
00104F 504F C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_18:BACKUP
                                ;in
                                ;   C : backup charactor
                                ;   HL: FBC pointer
                                ;out
       5050                     DEVICE_18_BACKUP:
001050 5050 D5              11      PUSH    DE
001051 5051 E5              11      PUSH    HL
001052 5052 110300          10      LD  DE,3
001055 5055 19              11      ADD HL,DE
001056 5056 71               7      LD  (HL),C
001057 5057 E1              10      POP HL
001058 5058 D1              10      POP DE
001059 5059 C9              10      RET
                                
       505A                     DEVICE_CHECK:
00105A 505A 3A8AFD          13      LD  A,(PROCNM+1)
00105D 505D B7               4      OR  A
00105E 505E C8              11      RET Z
00105F 505F 11EC51          10      LD  DE,STR_ROM
001062 5062 CDBE51          17      CALL    CPPROCNM
001065 5065 2802            12      JR  Z,DEVICE_OK
001067 5067 37               4      SCF
001068 5068 C9              10      RET
       5069                     DEVICE_OK:
001069 5069 AF               4      XOR A
00106A 506A C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファ
                                
       506B                     DEVICE_0_OPEN:
00106B 506B 7B               4      LD  A,E
00106C 506C FE02             7      CP  2       ;FOR OUTPUT
00106E 506E 281B            12      JR  Z,OPEN2
001070 5070 D5              11      PUSH    DE
001071 5071 E5              11      push    hl
                                ;
001072 5072 3E01             7      LD  A,1     ;ドライブA
001074 5074 32F9F2          13      LD  (FDRV),A
001077 5077 2166F8          10      LD  HL,FILNAM
00107A 507A 11FAF2          10      LD  DE,FNAME
00107D 507D 010B00          10      LD  BC,8+3
001080 5080 CD3C58          17      CALL    INIT_FILE1
001083 5083 CDC24C          17      CALL    ROM_OPEN
001086 5086 DAF746          10      JP  C,ERROR_FILE_NOT_FOUND
001089 5089 E1              10      pop hl
00108A 508A D1              10      POP DE
       508B                     OPEN2:
00108B 508B 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
00108E 508E 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
00108F 508F AF               4      XOR A
001090 5090 32F1F2          13      LD  (LEFTX),A
001093 5093 CD2B50          17      CALL    SET_BASIC_FCB
001096 5096 7B               4      ld  a,e
001097 5097 FE08             7      cp  8
001099 5099 3F               4      ccf
00109A 509A C9              10      ret
                                
       509B                     DEVICE_2_CLOSE:
00109B 509B AF               4      XOR A
                                ;   LD  (HL),A
00109C 509C 6F               4      LD  L,A
00109D 509D 67               4      LD  H,A
00109E 509E 2264F8          16      LD  (PTRFIL),HL
0010A1 50A1 C9              10      RET
                                
       50A2                     DEVICE_ENTRY:
0010A2 50A2 FE08             7      CP  8
0010A4 50A4 2826            12      JR  Z,DEVICE_8_SIN
0010A6 50A6 3C               4      INC A
0010A7 50A7 28B1            12      JR  Z,DEVICE_CHECK:
0010A9 50A9 3D               4      DEC A
0010AA 50AA 28BF            12      JR  Z,DEVICE_0_OPEN
0010AC 50AC FE0E             7      CP  14
0010AE 50AE 2860            12      JR  Z,DEVICE_14_EOF
0010B0 50B0 FE04             7      CP  4
0010B2 50B2 2834            12      JR  Z,DEVICE_4_RANDOM
0010B4 50B4 FE0A             7      CP  10
0010B6 50B6 2850            12      JR  Z,DEVICE_10_LOC
0010B8 50B8 FE0C             7      CP  12
0010BA 50BA 2878            12      JR  Z,DEVICE_12_LOF
0010BC 50BC FE02             7      CP  2
0010BE 50BE 2890            12      JR  Z,DEVICE_18_BACKUP  
0010C0 50C0 FE02             7      CP  2
0010C2 50C2 28D7            12      JR  Z,DEVICE_2_CLOSE
0010C4 50C4 FE06             7      CP  6
0010C6 50C6 2802            12      JR  Z,DEVICE_6_SOUT
0010C8 50C8 37               4      SCF
0010C9 50C9 C9              10      RET
                                
       50CA                     DEVICE_6_SOUT:
0010CA 50CA AF               4      XOR A
0010CB 50CB C9              10      RET
                                
       50CC                     DEVICE_8_SIN:
0010CC 50CC CD0850          17      CALL    GET_BASIC_FCB
0010CF 50CF 210100          10      LD  HL,1
0010D2 50D2 CDA24A          17      CALL    ROM_READ
0010D5 50D5 7C               4      LD  A,H
0010D6 50D6 B5               4      OR  L
0010D7 50D7 280D            12      JR  Z,CCF_RET
0010D9 50D9 2AD4F2          16      LD  HL,(_DTA)
0010DC 50DC 7E               7      LD  A,(HL)
0010DD 50DD F5              11      PUSH    AF
0010DE 50DE CD2B50          17      CALL    SET_BASIC_FCB
0010E1 50E1 F1              10      POP AF
0010E2 50E2 FE0A             7      CP  00AH
0010E4 50E4 C8              11      RET Z   ;ZF=separate
                                ;   CP  01AH
                                ;   JR  Z,SCF_RET
0010E5 50E5 37               4      SCF     ;
       50E6                     CCF_RET:
0010E6 50E6 3F               4      CCF     ;ZF=0 CF=0にしたい
0010E7 50E7 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_4:RANDOM
                                ;in
                                ;   A : 4
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
       50E8                     DEVICE_4_RANDOM:
0010E8 50E8 D5              11      PUSH    DE
0010E9 50E9 CD0850          17      CALL    GET_BASIC_FCB
0010EC 50EC DDE5            15      PUSH    IX
0010EE 50EE DD218A2F        14      LD  IX,FRCINT
0010F2 50F2 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0010F6 50F6 CDB0F2          17      CALL    CAL_MP
0010F9 50F9 DDE1            14      POP IX
0010FB 50FB 2AF8F7          16      LD  HL,(DACDAT)
0010FE 50FE 22CAF2          16      LD  (RR_LOW),HL
001101 5101 AF               4      XOR A
001102 5102 CD2B50          17      CALL    SET_BASIC_FCB
001105 5105 D1              10      POP DE
001106 5106 AF               4      XOR A
001107 5107 C9              10      RET
                                
                                ;FUNC_10:LOC
                                ;in
                                ;   A : 10
                                ;out
                                ;   DAC    : value of received bytes
                                ;   VALTYP : DAC type
       5108                     DEVICE_10_LOC:
001108 5108 CD0850          17      CALL    GET_BASIC_FCB
00110B 510B 2ACAF2          16      LD  HL,(RR_LOW)
00110E 510E 183D            12      JR  RETURN_TYPE8_AHL
                                
                                ;--------------------------------------
                                ;FUNC_14:EOF
                                ;in
                                ;   A : 14
                                ;out
                                ;   DAC    : value of EOF value (EOF=-1)
                                ;   VALTYP : DAC type
       5110                     DEVICE_14_EOF:
001110 5110 CD0850          17      CALL    GET_BASIC_FCB
001113 5113 CD544D          17      CALL    RBX1
001116 5116 3810            12      JR  C,DEVICE_14_EOF1
001118 5118 210100          10      LD  HL,1
00111B 511B CDA24A          17      CALL    ROM_READ
00111E 511E 2AD4F2          16      LD  HL,(_DTA)
001121 5121 7E               7      LD  A,(HL)
001122 5122 FE1A             7      CP  01AH
001124 5124 37               4      SCF
001125 5125 2801            12      JR  Z,DEVICE_14_EOF1
001127 5127 3F               4      CCF
       5128                     DEVICE_14_EOF1:
001128 5128 9F               4      SBC A,A
001129 5129 6F               4      LD  L,A
00112A 512A 67               4      LD  H,A
       512B                     return_type2_hl:
00112B 512B 22F8F7          16      ld  (DACDAT),hl
00112E 512E 3E02             7      ld  a,2
001130 5130 3263F6          13      ld  (VALTYP),a
001133 5133 C9              10      ret
                                
                                ;--------------------------------------
                                ;FUNC_16:FPOS
                                ;in
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
                                ;   illegal function call
                                
                                ;--------------------------------------
                                ;FUNC_12:LOF
                                ;in
                                ;   A : 12
                                ;out
                                ;   DAC    : value of LOC+RSIQLN
                                ;   VALTYP : DAC type
       5134                     DEVICE_12_LOF:
001134 5134 CD0850          17      CALL    GET_BASIC_FCB
                                
001137 5137 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001CH
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    CALL    RDSLT_ROM
                                    EX  DE,HL       ;AHL=File size
                                    POP DE
                                #else
00113A 513A 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
00113D 513D 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
001140 5140 FD2AEDF2        20      LD  IY,(DIRENT1)
001144 5144 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
001147 5147 FD661D          19      LD  H,(IY+01DH)
00114A 514A FD7E1E          19      LD  A,(IY+01EH)
                                #endif
       514D                     RETURN_TYPE8_AHL:
00114D 514D B7               4      OR  A
00114E 514E 2004            12      JR  NZ,RT8AHL1
001150 5150 CB7C             8      BIT 7,H
001152 5152 28D7            12      JR  Z,return_type2_hl
       5154                     RT8AHL1:
001154 5154 E5              11      PUSH    HL
001155 5155 29              11      ADD HL,HL
001156 5156 8F               4      ADC A,A
001157 5157 32F8F7          13      LD  (DACDAT),A
00115A 515A 3E00             7      LD  A,0
00115C 515C 8F               4      ADC A,A
00115D 515D 32F9F7          13      LD  (DACDAT+1),A
                                
001160 5160 3E02             7      LD  A,2
001162 5162 3263F6          13      LD  (VALTYP),A
001165 5165 DD213A30        14      LD  IX,FRCDBL
001169 5169 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00116D 516D CDB0F2          17      CALL    CAL_MP
                                
001170 5170 21B651          10      LD  HL,DBL32768
001173 5173 1147F8          10      LD  DE,ARG
001176 5176 010800          10      LD  BC,8
001179 5179 EDB0                    LDIR
                                
00117B 517B DD21E627        14      LD  IX,DECMUL
00117F 517F FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001183 5183 CDB0F2          17      CALL    CAL_MP
                                
001186 5186 21F6F7          10      LD  HL,DAC
001189 5189 1147F8          10      LD  DE,ARG
00118C 518C 010800          10      LD  BC,8
00118F 518F EDB0                    LDIR
                                
001191 5191 E1              10      POP HL
001192 5192 22F8F7          16      LD  (DACDAT),HL
                                
001195 5195 3E02             7      LD  A,2
001197 5197 3263F6          13      LD  (VALTYP),A
00119A 519A DD213A30        14      LD  IX,FRCDBL
00119E 519E FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0011A2 51A2 CDB0F2          17      CALL    CAL_MP
                                
0011A5 51A5 DD219A26        14      LD  IX,DECADD
0011A9 51A9 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0011AD 51AD CDB0F2          17      CALL    CAL_MP
                                
0011B0 51B0 3E08             7      LD  A,8
0011B2 51B2 3263F6          13      LD  (VALTYP),A
0011B5 51B5 C9              10      RET
                                
       51B6                     DBL32768:
0011B6 51B6 4532768000000000        DB  045H,032H,076H,080H,0,0,0,0
                                
       51BE                     CPPROCNM:
0011BE 51BE E5              11      PUSH    HL
0011BF 51BF 2189FD          10      LD  HL,PROCNM
       51C2                     CPPROCNM1:
0011C2 51C2 1A               7      LD  A,(DE)
0011C3 51C3 13               6      INC DE
0011C4 51C4 BE               7      CP  (HL)
0011C5 51C5 23               6      INC HL
0011C6 51C6 2003            12      JR  NZ,CPPROCNM2
0011C8 51C8 B7               4      OR  A
0011C9 51C9 20F7            12      JR  NZ,CPPROCNM1
       51CB                     CPPROCNM2:
0011CB 51CB E1              10      POP HL
0011CC 51CC C9              10      RET
                                
       51CD                     WILDCARD:
0011CD 51CD 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       51D8                     STR_CHDIR:
0011D8 51D8 434844495200            DB  "CHDIR",0
       51DE                     STR_CHDRV:
0011DE 51DE 434844525600            DB  "CHDRV",0
       51E4                     STR_RAMDISK:
0011E4 51E4 52414D4449534B00        DB  "RAMDISK",0
       51EC                     STR_ROM:
0011EC 51EC 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       51F0                     ERROR_WRITE_PROTECTED:
0011F0 51F0 3E00             7      LD  A,0     ;Write protected
0011F2 51F2 C9              10      RET
       51F3                     ERROR_NOT_READY:
0011F3 51F3 F1              10      POP AF
0011F4 51F4 37               4      SCF
0011F5 51F5 3E02             7      LD  A,2     ;Not ready
0011F7 51F7 C9              10      RET
       51F8                     DISKIO:
0011F8 51F8 38F6            12      JR  C,ERROR_WRITE_PROTECTED
0011FA 51FA 48               4      LD  C,B
0011FB 51FB CD0D54          17      CALL    GET_DISK_BANK
0011FE 51FE F5              11      PUSH    AF
0011FF 51FF 3AC9F2          13      LD  A,(SECSZ_H)
001202 5202 B7               4      OR  A
001203 5203 28EE            12      JR  Z,ERROR_NOT_READY
001205 5205 F1              10      POP AF
       5206                     SETMAP1:
001206 5206 E5              11      PUSH    HL
       5207                     DISKIO1:
001207 5207 C5              11      PUSH    BC      ;B=残りのセクタ数
001208 5208 D5              11      PUSH    DE      ;DE=セクタ番号
001209 5209 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
00120A 520A EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
00120B 520B F5              11      PUSH    AF
00120C 520C 3AC9F2          13      LD  A,(SECSZ_H)
00120F 520F CD3354          17      CALL    MUL_AHL
001212 5212 F1              10      POP AF
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  A,L
                                    PUSH    BC
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    POP BC
                                    JR  NC,DISKIO2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
001213 5213 4D               4      LD  C,L     ;C=読み出し元
001214 5214 29              11      ADD HL,HL       ;64KB→32KB
001215 5215 29              11      ADD HL,HL       ;32KB→16KB
001216 5216 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
001217 5217 84               4      ADD A,H
001218 5218 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
00121B 521B 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
00121E 521E 32C4F2          13      LD  (_BANK),A
001221 5221 79               4      LD  A,C     ;C=読み出し元
001222 5222 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       5224                     DISKIO2:
001224 5224 C660             7      ADD A,high BANK1_ADR
001226 5226 67               4      LD  H,A
001227 5227 ED4BC8F2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
00122B 522B 69               4      LD  L,C     ;C=0
00122C 522C CD0B45          17      CALL    ROM_LDIR
00122F 522F EB               4      EX  DE,HL
001230 5230 F1              10      POP AF
001231 5231 D1              10      POP DE
001232 5232 13               6      INC DE
001233 5233 C1              10      POP BC
001234 5234 10D1            13      DJNZ    DISKIO1
001236 5236 41               4      LD  B,C
                                
001237 5237 E1              10      POP HL
001238 5238 AF               4      XOR A
                                
001239 5239 FB               4      EI
00123A 523A C9              10      RET
                                
       523B                     DSKCHG:
00123B 523B CD7452          17      CALL    IS_BPB
00123E 523E 3824            12      JR  C,NOTREADY
001240 5240 3A23FB          13      LD  A,(DRVTBL+2)
001243 5243 B7               4      OR  A
001244 5244 201A            12      JR  NZ,DSKCHG1
001246 5246 3A21FB          13      LD  A,(DRVTBL)
001249 5249 FE02             7      CP  2
00124B 524B 2013            12      JR  NZ,DSKCHG1
00124D 524D CD7452          17      CALL    IS_BPB
001250 5250 300E            12      JR  NC,DSKCHG1
001252 5252 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
001254 5254 3221FB          13      LD  (DRVTBL),A
001257 5257 3223FB          13      LD  (DRVTBL+2),A
00125A 525A 3A48F3          13      LD  A,(MASTERS)
00125D 525D 3224FB          13      LD  (DRVTBL+3),A
       5260                     DSKCHG1:
001260 5260 AF               4      XOR A
001261 5261 0601             7      LD  B,1
001263 5263 C9              10      RET
       5264                     NOTREADY:
001264 5264 3E02             7      LD  A,2
001266 5266 37               4      SCF
001267 5267 C9              10      RET
                                
       5268                     NO_BPB:
001268 5268 E1              10      POP HL
001269 5269 23               6      INC HL
00126A 526A 113954          10      LD  DE,DPB2DD
00126D 526D 011200          10      LD  BC,DPB2DD_E-DPB2DD
001270 5270 EDB0                    LDIR
001272 5272 AF               4      XOR A
001273 5273 C9              10      RET
                                
       5274                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
001274 5274 CD0D54          17      CALL    GET_DISK_BANK
                                
001277 5277 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
00127A 527A FE01             7      CP  1
00127C 527C D8              11      RET C
                                
00127D 527D 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
001280 5280 C6FF             7      ADD A,0FFH
001282 5282 D8              11      RET C
                                
001283 5283 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       5286                     IS_BPB1:
001286 5286 FE01             7      CP  1
001288 5288 C8              11      RET Z
001289 5289 FE02             7      CP  2
00128B 528B C8              11      RET Z
00128C 528C FE04             7      CP  4
00128E 528E C8              11      RET Z
00128F 528F 37               4      SCF
001290 5290 C9              10      RET
                                
       5291                     GETDPB:
001291 5291 E5              11      PUSH    HL
001292 5292 CD0D54          17      CALL    GET_DISK_BANK
                                
001295 5295 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
001298 5298 B7               4      OR  A
001299 5299 28CD            12      JR  Z,NO_BPB
00129B 529B DDE1            14      POP IX
00129D 529D DD7701          19      LD  (IX+1),A        ;MEDIA
                                
0012A0 52A0 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
0012A3 52A3 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
0012A6 52A6 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
0012A9 52A9 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
0012AC 52AC 87               4      ADD A,A
0012AD 52AD 87               4      ADD A,A
0012AE 52AE 87               4      ADD A,A
0012AF 52AF 3D               4      DEC A
0012B0 52B0 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
0012B3 52B3 06FF             7      LD  B,-1
0012B5 52B5 A7               4      AND A           ;無限ループ阻止
       52B6                     GETDPB1:
0012B6 52B6 04               4      INC B
0012B7 52B7 1F               4      RRA
0012B8 52B8 38FC            12      JR  C,GETDPB1
0012BA 52BA DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
0012BD 52BD 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0012C0 52C0 3D               4      DEC A
0012C1 52C1 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
0012C4 52C4 A7               4      AND A           ;無限ループ阻止
0012C5 52C5 06FF             7      LD  B,-1
       52C7                     GETDPB2:
0012C7 52C7 04               4      INC B
0012C8 52C8 1F               4      RRA
0012C9 52C9 38FC            12      JR  C,GETDPB2
0012CB 52CB 04               4      INC B
0012CC 52CC DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
0012CF 52CF 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt
0012D2 52D2 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
0012D5 52D5 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
0012D8 52D8 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
0012DB 52DB DD770A          19      LD  (IX+10),A       ;FATCNT
                                
0012DE 52DE 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
0012E1 52E1 DD770B          19      LD  (IX+11),A       ;MAXENT
                                
0012E4 52E4 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16
0012E8 52E8 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
0012EB 52EB DD460A          19      LD  B,(IX+10)       ;FATCNT
0012EE 52EE 210000          10      LD  HL,0
       52F1                     GETDPB3:
0012F1 52F1 19              11      ADD HL,DE
0012F2 52F2 10FD            13      DJNZ    GETDPB3
       52F4                     GETDPB4:
0012F4 52F4 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
0012F7 52F7 DD5609          19      LD  D,(IX+9)        ;FIRFAT
0012FA 52FA 19              11      ADD HL,DE
0012FB 52FB DD7511          19      LD  (IX+17),L       ;FIRDIR
0012FE 52FE DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
001301 5301 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001304 5304 87               4      ADD A,A
001305 5305 87               4      ADD A,A
001306 5306 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       5309                     GETDPB5:
001309 5309 CB3B             8      SRL E
00130B 530B 1F               4      RRA
00130C 530C 30FB            12      JR  NC,GETDPB5
00130E 530E 1600             7      LD  D,0
001310 5310 19              11      ADD HL,DE
001311 5311 DD750C          19      LD  (IX+12),L       ;FIRREC
001314 5314 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001317 5317 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16
                                
00131A 531A DD5E0C          19      LD  E,(IX+12)       ;FIRREC
00131D 531D DD560D          19      LD  D,(IX+13)       ;FIRREC
001320 5320 A7               4      AND A
001321 5321 ED52            15      SBC HL,DE
                                
001323 5323 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
001326 5326 3C               4      INC A
001327 5327 37               4      SCF             ;無限ループ阻止
       5328                     GETDPB6:
001328 5328 1F               4      RRA
001329 5329 3806            12      JR  C,GETDPB7
00132B 532B CB3C             8      SRL H
00132D 532D CB1D             8      RR  L
00132F 532F 18F7            12      JR  GETDPB6
       5331                     GETDPB7:
001331 5331 23               6      INC HL
001332 5332 DD750E          19      LD  (IX+14),L       ;MAXCLUS
001335 5335 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       5338                     GETDPBD1:
001338 5338 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
00133B 533B E6FC             7      AND 0FCH
00133D 533D C8              11      RET Z
                                
00133E 533E DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
001342 5342 37               4      SCF
001343 5343 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
001347 5347 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
00134A 534A DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
00134E 534E DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
001352 5352 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
001356 5356 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
00135A 535A DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
00135E 535E DDCB1126        23      SLA (IX+17)         ;FIRDIR
001362 5362 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
001366 5366 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
001369 5369 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
00136C 536C DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
00136F 536F 87               4      ADD A,A
001370 5370 87               4      ADD A,A
001371 5371 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       5374                     GETDPBD5:
001374 5374 CB3B             8      SRL E
001376 5376 1F               4      RRA
001377 5377 30FB            12      JR  NC,GETDPBD5
001379 5379 1600             7      LD  D,0
00137B 537B 19              11      ADD HL,DE
00137C 537C DD750C          19      LD  (IX+12),L       ;FIRREC
00137F 537F DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001382 5382 18B4            12      JR  GETDPBD1
                                
       5384                     CHOICE:
001384 5384 210000          10      LD  HL,0
001387 5387 C9              10      RET
                                
       5388                     DSKFMT:
001388 5388 AF               4      XOR A
001389 5389 37               4      SCF
       538A                     DSKSTP:
00138A 538A C9              10      RET
                                
       538B                     BASENT:
00138B 538B 3E                      DB  03EH
00138C 538C F7              12      RST 30H
00138D 538D 32DBFD          13      LD  (H_PINL),A
001390 5390 3A48F3          13      LD  A,(MASTERS)
001393 5393 32DCFD          13      LD  (H_PINL+1),A
001396 5396 21B253          10      LD  HL,BOOT_BASIC
001399 5399 22DDFD          16      LD  (H_PINL+2),HL
00139C 539C 3E                      DB  03EH
00139D 539D C9              10      RET
00139E 539E 32DFFD          13      LD  (H_PINL+4),A
                                
                                #if exists _RAM64K
0013A1 53A1 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
0013A4 53A4 CD095A          17      CALL    ENASLT_00H
                                #endif
                                    ;BASICを起動する
0013A7 53A7 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0013AB 53AB DD21177D        14      LD  IX,ST_BAS   ;continue start of MSX-BASIC without executing BASIC programs in ROM
0013AF 53AF C35901          10      JP  CALBAS
                                
       53B2                     BOOT_BASIC:
0013B2 53B2 3E                      DB  03EH
0013B3 53B3 C9              10      RET
0013B4 53B4 32DBFD          13      LD  (H_PINL),A
                                
0013B7 53B7 2A74F6          16      LD  HL,(STKTOP)
0013BA 53BA 3A40F3          13      LD  A,(REBOOT)
0013BD 53BD C6FF             7      ADD A,0FFH
0013BF 53BF 3811            12      JR  C,REBOOT1
0013C1 53C1 214B54          10      LD  HL,AUTOEXEC
0013C4 53C4 11F9F2          10      LD  DE,FDRV
0013C7 53C7 010C00          10      LD  BC,1+8+3
0013CA 53CA EDB0                    LDIR
0013CC 53CC CDC24C          17      CALL    ROM_OPEN
0013CF 53CF D44146          17      CALL    NC,ROM_LOAD1
       53D2                     REBOOT1:
0013D2 53D2 3E1E             7      LD  A,01EH
0013D4 53D4 CD7A54          17      CALL    MSG_A
0013D7 53D7 215754          10      LD  HL,CMD_RUN
0013DA 53DA 111FF4          10      LD  DE,KBUF
0013DD 53DD 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
0013E0 53E0 D5              11      PUSH    DE
0013E1 53E1 EDB0                    LDIR
0013E3 53E3 3004            12      JR  NC,REBOOT2
0013E5 53E5 AF               4      XOR A
0013E6 53E6 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       53E9                     REBOOT2:
0013E9 53E9 E1              10      POP HL
0013EA 53EA FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0013EE 53EE DD210146        14      LD  IX,NEWSTT
0013F2 53F2 C31C00          10      JP  _CALSLT
                                
       53F5                     GETSLT:
0013F5 53F5 3A22FB          13      LD  A,(DRVTBL+1)
0013F8 53F8 C9              10      RET
                                
       53F9                     GET_DISK_BANK_H:
0013F9 53F9 3AF0F2          13      LD  A,(_LVECTOR)
0013FC 53FC E680             7      AND 080H
0013FE 53FE 87               4      ADD A,A
0013FF 53FF 3811            12      JR  C,SET_DISK_BANK_A
001401 5401 1816            12      JR  SET_DISK_BANK
       5403                     GET_DISK_BANK_FDRV:
001403 5403 3AF9F2          13      LD  A,(FDRV)
001406 5406 D601             7      SUB 1
001408 5408 3003            12      JR  NC,GET_DISK_BANK
00140A 540A 3AEAF2          13      LD  A,(_DVSW)
       540D                     GET_DISK_BANK:
00140D 540D FE07             7      CP  7       ;H:
00140F 540F 28E8            12      JR  Z,GET_DISK_BANK_H
001411 5411 B7               4      OR  A       ;A=DRIVE
       5412                     SET_DISK_BANK_A:
001412 5412 3E01             7      LD  A,DISK_BANK
001414 5414 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
001416 5416 3AE9F2          13      LD  A,(B_DRIVE)
                                #endif
       5419                     SET_DISK_BANK:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
001419 5419 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
00141C 541C 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
00141F 541F F5              11      PUSH    AF
001420 5420 E5              11      PUSH    HL
001421 5421 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec
001424 5424 22C8F2          16      LD  (SECSZ),HL
001427 5427 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
00142A 542A CD3354          17      CALL    MUL_AHL
00142D 542D 22C6F2          16      LD  (CLSZ),HL
001430 5430 E1              10      POP HL
001431 5431 F1              10      POP AF
001432 5432 C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       5433                     MUL_AHL:
001433 5433 37               4      SCF     ;無限ループ回避
       5434                     MUL_AHL1:
001434 5434 1F               4      RRA     ;->CF
001435 5435 D8              11      RET C
001436 5436 29              11      ADD HL,HL
001437 5437 18FB            12      JR  MUL_AHL1
                                
       5439                     DPB2DD:
001439 5439 F9                      DB  0F9H    ;MEDIA
00143A 543A 0002                    DW  00200H  ;SECSIZ
00143C 543C 0F                      DB  00FH    ;DIRMSK
00143D 543D 04                      DB  004H    ;DIRSHFT
00143E 543E 01                      DB  001H    ;CLUSMSK
00143F 543F 02                      DB  002H    ;CLUSSHFT
001440 5440 0100                    DW  00001H  ;FIRFAT
001442 5442 02                      DB  002H    ;FATCNT
001443 5443 70                      DB  070H    ;MAXENT
001444 5444 0E00                    DW  0000EH  ;FIRREC
001446 5446 CA02                    DW  002CAH  ;MAXCLUS
001448 5448 03                      DB  003H    ;FATSIZ
001449 5449 0700                    DW  0007H   ;FIRDIR
       544B                     DPB2DD_E:
                                
       544B                     AUTOEXEC:
00144B 544B 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       5457                     CMD_RUN:
001457 5457 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
00145D 545D 80EF                    DW  NEW_HIMEM
       545F                     CMD_CLEAR_E:
00145F 545F 3A8A00                  DB  03AH,08AH,0         ;RUN
       5462                     CMD_RUN_E:
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       5462                     _ERROR:
001462 5462 AF               4      XOR A
001463 5463 47               4      LD  B,A
001464 5464 C9              10      RET
                                
       5465                     ROM_BDOS:
001465 5465 E5              11      PUSH    HL
001466 5466 79               4      LD  A,C
001467 5467 87               4      ADD A,A
001468 5468 38F8            12      JR  C,_ERROR
00146A 546A 6F               4      LD  L,A
00146B 546B 2659             7      LD  H,high STABLE
00146D 546D 7E               7      LD  A,(HL)
00146E 546E 2C               4      INC L
00146F 546F 66               7      LD  H,(HL)
001470 5470 6F               4      LD  L,A
001471 5471 E3              19      EX  (SP),HL
001472 5472 79               4      LD  A,C
001473 5473 C9              10      RET
                                
       5474                     _PRINT:
       5474                     PRINT:
001474 5474 7B               4      LD  A,E
001475 5475 1803            12      JR  MSG_A
                                
       5477                     _SYS01:     ;(BDOS)コンソール入力
001477 5477 CDFC54          17      CALL    _SYS07
       547A                     MSG_A:
00147A 547A FE03             7      CP  3
00147C 547C 2814            12      JR  Z,MSG_BR
       547E                     MSGA1:
00147E 547E F5              11      PUSH    AF
00147F 547F C5              11      PUSH    BC
001480 5480 D5              11      PUSH    DE
001481 5481 E5              11      PUSH    HL
001482 5482 DDE5            15      PUSH    IX
001484 5484 DD21A200        14      LD  IX,CHPUT
001488 5488 CDC044          17      CALL    CALSLT_R
00148B 548B DDE1            14      POP IX
00148D 548D E1              10      POP HL
00148E 548E D1              10      POP DE
00148F 548F C1              10      POP BC
       5490                     MSGA2:
001490 5490 F1              10      POP AF
001491 5491 C9              10      RET
       5492                     MSG_BR:
001492 5492 F5              11      PUSH    AF
001493 5493 3ADDF3          13      LD  A,(CSRX)
001496 5496 FE02             7      CP  2
001498 5498 38F6            12      JR  C,MSGA2
00149A 549A F1              10      POP AF
       549B                     MSG_CR:
00149B 549B F5              11      PUSH    AF
00149C 549C 3E0D             7      LD  A,00DH
00149E 549E CD7E54          17      CALL    MSGA1
0014A1 54A1 3E0A             7      LD  A,00AH
0014A3 54A3 CD7E54          17      CALL    MSGA1
0014A6 54A6 F1              10      POP AF
0014A7 54A7 C9              10      RET
                                
       54A8                     _SYS02:     ;(BDOS)コンソール出力
0014A8 54A8 CDC354          17      CALL    BREAK
0014AB 54AB 1805            12      JR  PRINTX
                                
       54AD                     _SYS06:     ;(BDOS)コンソール直接入出力
0014AD 54AD 7B               4      LD  A,E
0014AE 54AE 3C               4      INC A
0014AF 54AF CA1055          10      JP  Z,_INKEY
       54B2                     PRINTX:
0014B2 54B2 C37454          10      JP  _PRINT
                                
       54B5                     _SYS08:     ;(BDOS)エコーなしコンソール入力
0014B5 54B5 CDFC54          17      CALL    _SYS07
0014B8 54B8 FE03             7      CP  3
0014BA 54BA CCC354          17      CALL    Z,_BREAK
0014BD 54BD FE13             7      CP  013H        ;CTRL+S
0014BF 54BF C0              11      RET NZ
       54C0                     PAUSE:
0014C0 54C0 CDDA54          17      CALL    KEYBC
                                
       54C3                     _BREAK:
       54C3                     BREAK:
0014C3 54C3 F5              11      PUSH    AF
0014C4 54C4 C5              11      PUSH    BC
0014C5 54C5 D5              11      PUSH    DE
0014C6 54C6 E5              11      PUSH    HL
0014C7 54C7 DDE5            15      PUSH    IX
0014C9 54C9 DD21B700        14      LD  IX,BREAKX
0014CD 54CD CDC044          17      CALL    CALSLT_R
0014D0 54D0 DDE1            14      POP IX
0014D2 54D2 E1              10      POP HL
0014D3 54D3 D1              10      POP DE
0014D4 54D4 C1              10      POP BC
0014D5 54D5 DCC354          17      CALL    C,_BREAK
0014D8 54D8 F1              10      POP AF
0014D9 54D9 C9              10      RET
       54DA                     KEYBC:
0014DA 54DA F5              11      PUSH    AF
0014DB 54DB C5              11      PUSH    BC
0014DC 54DC D5              11      PUSH    DE
0014DD 54DD E5              11      PUSH    HL
0014DE 54DE DDE5            15      PUSH    IX
0014E0 54E0 DD215601        14      LD  IX,KILBUF
0014E4 54E4 CDC044          17      CALL    CALSLT_R
0014E7 54E7 DDE1            14      POP IX
0014E9 54E9 E1              10      POP HL
0014EA 54EA D1              10      POP DE
0014EB 54EB C1              10      POP BC
0014EC 54EC F1              10      POP AF
0014ED 54ED C9              10      RET
                                
       54EE                     _SYS09:     ;(BDOS)文字列出力
0014EE 54EE D5              11      PUSH    DE
       54EF                     _SX09:
0014EF 54EF 1A               7      LD  A,(DE)
0014F0 54F0 13               6      INC DE
0014F1 54F1 FE24             7      CP  '$'
0014F3 54F3 2805            12      JR  Z,POPDE_RET
0014F5 54F5 CD7A54          17      CALL    MSG_A
0014F8 54F8 18F5            12      JR  _SX09
       54FA                     POPDE_RET:
0014FA 54FA D1              10      POP DE
0014FB 54FB C9              10      RET
                                
       54FC                     _SYS07:
       54FC                     FLGET:
0014FC 54FC C5              11      PUSH    BC
0014FD 54FD D5              11      PUSH    DE
0014FE 54FE E5              11      PUSH    HL
0014FF 54FF DDE5            15      PUSH    IX
001501 5501 DD219F00        14      LD  IX,CHGET
001505 5505 CDC044          17      CALL    CALSLT_R
001508 5508 DDE1            14      POP IX
00150A 550A E1              10      POP HL
00150B 550B D1              10      POP DE
00150C 550C C1              10      POP BC
00150D 550D FE03             7      CP  3
00150F 550F C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       5510                     _INKEY:
       5510                     INKEY:
001510 5510 CD5B55          17      CALL    CPM_CONST
001513 5513 C8              11      RET Z
001514 5514 18E6            12      JR  FLGET
                                
       5516                     _SYS0A:     ;(BDOS)文字列入力
001516 5516 C5              11      PUSH    BC
001517 5517 E5              11      PUSH    HL
001518 5518 D5              11      PUSH    DE
001519 5519 3ADDF3          13      LD  A,(CSRX)
00151C 551C 5F               4      LD  E,A
00151D 551D 1600             7      LD  D,0
00151F 551F D5              11      PUSH    DE
001520 5520 DDE5            15      PUSH    IX
001522 5522 DD21AE00        14      LD  IX,PLININ
001526 5526 CDC044          17      CALL    CALSLT_R
001529 5529 DDE1            14      POP IX
00152B 552B D1              10      POP DE
00152C 552C 215DF5          10      LD  HL,BUF-1
00152F 552F F5              11      PUSH    AF
001530 5530 19              11      ADD HL,DE
001531 5531 F1              10      POP AF
001532 5532 EB               4      EX  DE,HL
001533 5533 E1              10      POP HL
001534 5534 E5              11      PUSH    HL
001535 5535 0E00             7      LD  C,0
001537 5537 3004            12      JR  NC,SAX0
001539 5539 23               6      INC HL
00153A 553A 23               6      INC HL
00153B 553B 1808            12      JR  SAX4
       553D                     SAX0:
00153D 553D 46               7      LD  B,(HL)
00153E 553E 23               6      INC HL
       553F                     SAX1:
00153F 553F 23               6      INC HL
001540 5540 1A               7      LD  A,(DE)
001541 5541 13               6      INC DE
001542 5542 B7               4      OR  A
001543 5543 2004            12      JR  NZ,SAX2
       5545                     SAX4:
001545 5545 360D            10      LD  (HL),00DH
001547 5547 1804            12      JR  SAX3
       5549                     SAX2:
001549 5549 77               7      LD  (HL),A
00154A 554A 0C               4      INC C
00154B 554B 10F2            13      DJNZ    SAX1
       554D                     SAX3:
00154D 554D D1              10      POP DE
00154E 554E 79               4      LD  A,C
00154F 554F 13               6      INC DE
001550 5550 12               7      LD  (DE),A
001551 5551 1B               6      DEC DE
001552 5552 E1              10      POP HL
001553 5553 C1              10      POP BC
001554 5554 3E1E             7      LD  A,01EH
001556 5556 CD7A54          17      CALL    MSG_A
001559 5559 AF               4      XOR A
00155A 555A C9              10      RET
                                
       555B                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       555B                     CONSTX:
       555B                     CPM_CONST:
00155B 555B C5              11      PUSH    BC
00155C 555C D5              11      PUSH    DE
00155D 555D E5              11      PUSH    HL
00155E 555E DDE5            15      PUSH    IX
001560 5560 DD219C00        14      LD  IX,CHSNS
001564 5564 CDC044          17      CALL    CALSLT_R
001567 5567 DDE1            14      POP IX
001569 5569 E1              10      POP HL
00156A 556A D1              10      POP DE
00156B 556B C1              10      POP BC
00156C 556C C9              10      RET
                                
       556D                     _SYS2A:     ;(BDOS)日付の獲得
00156D 556D 0E0B             7      LD  C,11        ;年/Year→HL
00156F 556F CDAE55          17      CALL    RDCLK_BCD
001572 5572 6F               4      LD  L,A
001573 5573 2600             7      LD  H,0
001575 5575 3AF8FA          13      LD  A,(EXBRSA)
001578 5578 B7               4      OR  A
001579 5579 2804            12      JR  Z,SX2A1
00157B 557B 11BC07          10      LD  DE,1980     ;1980年～2079年
00157E 557E 19              11      ADD HL,DE
       557F                     SX2A1:
00157F 557F 0E09             7      LD  C,9     ;月/Month→D
001581 5581 CDAE55          17      CALL    RDCLK_BCD
001584 5584 57               4      LD  D,A
                                
001585 5585 0E07             7      LD  C,7     ;日/Day→E
001587 5587 CDAE55          17      CALL    RDCLK_BCD
00158A 558A 5F               4      LD  E,A
                                
00158B 558B 0E06             7      LD  C,6     ;曜日/Week→A
       558D                     RDCLK:
00158D 558D DDE5            15      PUSH    IX
00158F 558F DD21F501        14      LD  IX,REDCLK
       5593                     WRCLK1:
001593 5593 3AF8FA          13      LD  A,(EXBRSA)
001596 5596 B7               4      OR  A
001597 5597 280A            12      JR  Z,RDCLK1    ;MSX1
001599 5599 FDE5            15      PUSH    IY
00159B 559B FD67             9      LD  IYH,A
00159D 559D 78               4      LD  A,B
00159E 559E CD1C00          17      CALL    _CALSLT
0015A1 55A1 FDE1            14      POP IY
       55A3                     RDCLK1:
0015A3 55A3 DDE1            14      POP IX
0015A5 55A5 C9              10      RET
       55A6                     WRCLK:
0015A6 55A6 DDE5            15      PUSH    IX
0015A8 55A8 DD21F901        14      LD  IX,WRTCLK
0015AC 55AC 18E5            12      JR  WRCLK1
                                
       55AE                     RDCLK_BCD:
0015AE 55AE CD8D55          17      CALL    RDCLK       ;1の位
0015B1 55B1 47               4      LD  B,A
0015B2 55B2 0C               4      INC C
0015B3 55B3 CD8D55          17      CALL    RDCLK       ;10の位
0015B6 55B6 87               4      ADD A,A     ;*2
0015B7 55B7 4F               4      LD  C,A
0015B8 55B8 87               4      ADD A,A     ;*4
0015B9 55B9 87               4      ADD A,A     ;*8
0015BA 55BA 81               4      ADD A,C     ;*10(8+2)
0015BB 55BB 80               4      ADD A,B     ;1の位
0015BC 55BC C9              10      RET
                                
       55BD                     _SYS2C:     ;(BDOS)時刻の獲得
0015BD 55BD 011501          10      LD  BC,00115H       ;12時間計/24時間計の設定を24時間計に
0015C0 55C0 CDA655          17      CALL    WRCLK
0015C3 55C3 0E04             7      LD  C,4     ;H=時/Hour
0015C5 55C5 CDAE55          17      CALL    RDCLK_BCD
0015C8 55C8 67               4      LD  H,A
0015C9 55C9 0E02             7      LD  C,2     ;L=分/Minute
0015CB 55CB CDAE55          17      CALL    RDCLK_BCD
0015CE 55CE 6F               4      LD  L,A
0015CF 55CF 0E00             7      LD  C,0     ;D=秒/Second
0015D1 55D1 CDAE55          17      CALL    RDCLK_BCD
0015D4 55D4 57               4      LD  D,A
0015D5 55D5 AF               4      XOR A       ;E=1/100秒
0015D6 55D6 5F               4      LD  E,A
0015D7 55D7 C9              10      RET
                                
       55D8                     POS:
0015D8 55D8 F5              11      PUSH    AF
0015D9 55D9 2ADCF3          16      LD  HL,(CSRY)
0015DC 55DC 7D               4      LD  A,L
0015DD 55DD 6C               4      LD  L,H
0015DE 55DE 67               4      LD  H,A
0015DF 55DF 2C               4      INC L
0015E0 55E0 24               4      INC H
0015E1 55E1 F1              10      POP AF
0015E2 55E2 C9              10      RET
                                
       55E3                     LOC:
0015E3 55E3 F5              11      PUSH    AF
0015E4 55E4 E5              11      PUSH    HL
0015E5 55E5 7D               4      LD  A,L
0015E6 55E6 6C               4      LD  L,H
0015E7 55E7 67               4      LD  H,A
0015E8 55E8 2D               4      DEC L
0015E9 55E9 25               4      DEC H
0015EA 55EA DDE5            15      PUSH    IX
0015EC 55EC DD21C600        14      LD  IX,POSIT
0015F0 55F0 CDC044          17      CALL    CALSLT_R
0015F3 55F3 DDE1            14      POP IX
0015F5 55F5 E1              10      POP HL
0015F6 55F6 F1              10      POP AF
0015F7 55F7 C9              10      RET
                                
       55F8                     _SCRN:
       55F8                     SCRN:
0015F8 55F8 E5              11      PUSH    HL
0015F9 55F9 DDE5            15      PUSH    IX
                                
0015FB 55FB 69               4      LD  L,C
0015FC 55FC 60               4      LD  H,B
0015FD 55FD DD214A00        14      LD  IX,RDVRM
001601 5601 CDC044          17      CALL    CALSLT_R
                                
001604 5604 DDE1            14      POP IX
001606 5606 E1              10      POP HL
001607 5607 C9              10      RET
                                
       5608                     CTRL02:
001608 5608 F5              11      PUSH    AF
001609 5609 D5              11      PUSH    DE
00160A 560A 2ADCF3          16      LD  HL,(CSRY)
00160D 560D 3AB0F3          13      LD  A,(LINLEN)
001610 5610 4F               4      LD  C,A
001611 5611 94               4      SUB H   ;CSRX
001612 5612 C602             7      ADD A,2
001614 5614 47               4      LD  B,A ;カーソルより右の文字数
001615 5615 61               4      LD  H,C ;LINLEN
001616 5616 C5              11      PUSH    BC
001617 5617 CD6556          17      CALL    LOC0
00161A 561A C1              10      POP BC
                                
00161B 561B 1620             7      LD  D,020H
       561D                     C8X1:
00161D 561D DD214A00        14      LD  IX,RDVRM
001621 5621 CDC044          17      CALL    CALSLT_R
001624 5624 4F               4      LD  C,A
001625 5625 7A               4      LD  A,D
001626 5626 DD214D00        14      LD  IX,WRTVRM
00162A 562A CDC044          17      CALL    CALSLT_R
00162D 562D 2B               6      DEC HL
00162E 562E 51               4      LD  D,C
00162F 562F 10EC            13      DJNZ    C8X1
001631 5631 D1              10      POP DE
001632 5632 F1              10      POP AF
001633 5633 C9              10      RET
                                
       5634                     INSERT:
001634 5634 F5              11      PUSH    AF
001635 5635 D5              11      PUSH    DE
001636 5636 2ADCF3          16      LD  HL,(CSRY)
001639 5639 3AB0F3          13      LD  A,(LINLEN)
00163C 563C 4F               4      LD  C,A
00163D 563D 94               4      SUB H   ;CSRX
00163E 563E 3C               4      INC A
00163F 563F 47               4      LD  B,A ;カーソルより右の文字数
001640 5640 C5              11      PUSH    BC
001641 5641 CD6556          17      CALL    LOC0
001644 5644 C1              10      POP BC
                                
001645 5645 1620             7      LD  D,020H
       5647                     INS1:
001647 5647 DD214A00        14      LD  IX,RDVRM
00164B 564B CDC044          17      CALL    CALSLT_R
00164E 564E 4F               4      LD  C,A
00164F 564F 7A               4      LD  A,D
001650 5650 DD214D00        14      LD  IX,WRTVRM
001654 5654 CDC044          17      CALL    CALSLT_R
001657 5657 23               6      INC HL
001658 5658 51               4      LD  D,C
001659 5659 10EC            13      DJNZ    INS1
00165B 565B D1              10      POP DE
00165C 565C F1              10      POP AF
00165D 565D C9              10      RET
                                
       565E                     CONOUT1:
00165E 565E 59               4      LD  E,C
00165F 565F C37454          10      JP  _PRINT
                                
       5662                     GETVRAM:
001662 5662 2ADCF3          16      LD  HL,(CSRY)
       5665                     LOC0:
001665 5665 2D               4      DEC L
001666 5666 25               4      DEC H
001667 5667 4C               4      LD  C,H ;CSRX-1
001668 5668 5D               4      LD  E,L ;CSRY-1
       5669                     LOC1:
001669 5669 3AB0F3          13      LD  A,(LINLEN)
00166C 566C 67               4      LD  H,A
00166D 566D 1600             7      LD  D,0
00166F 566F 6A               4      LD  L,D ;0
001670 5670 0608             7      LD  B,8
       5672                     LOC2:
001672 5672 29              11      ADD HL,HL
001673 5673 3001            12      JR  NC,LOC3
001675 5675 19              11      ADD HL,DE
       5676                     LOC3:
001676 5676 10FA            13      DJNZ    LOC2
001678 5678 09              11      ADD HL,BC
001679 5679 C9              10      RET
                                
       567A                     _SYS0C:     ;(BDOS)バージョン番号の獲得
00167A 567A 212200          10      LD  HL,00022H
00167D 567D AF               4      XOR A
00167E 567E 7D               4      LD  A,L
00167F 567F C9              10      RET
                                
       5680                     _SYS0D:     ;(BDOS)ディスク・リセット
001680 5680 218000          10      LD  HL,00080H
001683 5683 22D4F2          16      LD  (_DTA),HL
001686 5686 C9              10      RET
                                
       5687                     _SYS0E:     ;(BDOS)カレントドライブの設定
001687 5687 7B               4      LD  A,E
       5688                     _SYS0EX1:
001688 5688 FE08             7      CP  8
00168A 568A 3F               4      CCF
00168B 568B D8              11      RET C
00168C 568C 32EAF2          13      LD  (_DVSW),A
00168F 568F C9              10      RET
                                
       5690                     _SYS0F:     ;(BDOS)ファイルのオープン
001690 5690 D5              11      PUSH    DE
001691 5691 FDE1            14      POP IY
001693 5693 CD3558          17      CALL    INIT_FILE
001696 5696 CDC24C          17      CALL    ROM_OPEN
001699 5699 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
00169B 569B FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
00169F 569F FDE5            15      PUSH    IY
0016A1 56A1 D1              10      POP DE
0016A2 56A2 13               6      INC DE
0016A3 56A3 010B00          10      LD  BC,11
0016A6 56A6 EDB0                    LDIR
                                ;               Attribute
0016A8 56A8 7E               7      LD  A,(HL)
0016A9 56A9 FD770D          19      LD  (IY+13),A
                                ;               TIME
0016AC 56AC 110B00          10      LD  DE,11
0016AF 56AF 19              11      ADD HL,DE
0016B0 56B0 7E               7      LD  A,(HL)
0016B1 56B1 23               6      INC HL
0016B2 56B2 FD7716          19      LD  (IY+22),A
0016B5 56B5 7E               7      LD  A,(HL)
0016B6 56B6 23               6      INC HL
0016B7 56B7 FD7717          19      LD  (IY+23),A
                                ;               DATE
0016BA 56BA 7E               7      LD  A,(HL)
0016BB 56BB 23               6      INC HL
0016BC 56BC FD7714          19      LD  (IY+20),A
0016BF 56BF 7E               7      LD  A,(HL)
0016C0 56C0 23               6      INC HL
0016C1 56C1 FD7715          19      LD  (IY+21),A
                                ;               First cluster
0016C4 56C4 7E               7      LD  A,(HL)
0016C5 56C5 23               6      INC HL
0016C6 56C6 FD771A          19      LD  (IY+26),A
0016C9 56C9 7E               7      LD  A,(HL)
0016CA 56CA 23               6      INC HL
0016CB 56CB FD771B          19      LD  (IY+27),A
                                ;               SIZE
0016CE 56CE 7E               7      LD  A,(HL)
0016CF 56CF 23               6      INC HL
0016D0 56D0 FD7710          19      LD  (IY+16),A
0016D3 56D3 7E               7      LD  A,(HL)
0016D4 56D4 23               6      INC HL
0016D5 56D5 FD7711          19      LD  (IY+17),A
0016D8 56D8 7E               7      LD  A,(HL)
0016D9 56D9 23               6      INC HL
0016DA 56DA FD7712          19      LD  (IY+18),A
0016DD 56DD 7E               7      LD  A,(HL)
0016DE 56DE FD7713          19      LD  (IY+19),A
0016E1 56E1 AF               4      XOR A
0016E2 56E2 FD770C          19      LD  (IY+12),A
0016E5 56E5 C9              10      RET
                                
       56E6                     _SYS10:     ;(BDOS)ファイルのクローズ
0016E6 56E6 AF               4      XOR A
0016E7 56E7 C9              10      RET
                                
       56E8                     S11X1:
0016E8 56E8 FD7119          19      LD  (IY+25),C       ;RootEntCnt
0016EB 56EB FD750E          19      LD  (IY+14),L
0016EE 56EE FD740F          19      LD  (IY+15),H
       56F1                     SCF_FF_RET:
0016F1 56F1 37               4      SCF
0016F2 56F2 9F               4      SBC A,A
0016F3 56F3 C9              10      RET
                                
       56F4                     _SYS11:     ;(BDOS)最初のファイルの検索
0016F4 56F4 ED53D7F2        20      LD  (_FCB),DE
0016F8 56F8 D5              11      PUSH    DE
0016F9 56F9 FDE1            14      POP IY
0016FB 56FB CD3558          17      CALL    INIT_FILE
       56FE                     S12X0:
0016FE 56FE CD204F          17      CALL    GET_DIR_DAT
       5701                     S12X1:
001701 5701 CDDE4C          17      CALL    FILESE
001704 5704 30E2            12      JR  NC,S11X1
001706 5706 0D               4      DEC C
001707 5707 FD7119          19      LD  (IY+25),C       ;RootEntCnt
00170A 570A FDCB0D66        20      BIT 4,(IY+13)
00170E 570E 280A            12      JR  Z,S12X2
001710 5710 E5              11      PUSH    HL
001711 5711 DDE1            14      POP IX
001713 5713 DD7E0B          19      LD  A,(IX+11)
001716 5716 FE0F             7      CP  00FH
001718 5718 28E4            12      JR  Z,S12X0
       571A                     S12X2:
00171A 571A 012000          10      LD  BC,32
00171D 571D ED5BD4F2        20      LD  DE,(_DTA)
001721 5721 AF               4      XOR A
001722 5722 12               7      LD  (DE),A      ;ドライブ番号
001723 5723 13               6      INC DE
001724 5724 EDB0                    LDIR            ;ディレクトリエントリ
001726 5726 FD750E          19      LD  (IY+14),L
001729 5729 FD740F          19      LD  (IY+15),H
00172C 572C C9              10      RET
                                
       572D                     _SYS12:
00172D 572D FD2AD7F2        20      LD  IY,(_FCB)
001731 5731 FDE5            15      PUSH    IY
001733 5733 D1              10      POP DE
001734 5734 CD3558          17      CALL    INIT_FILE
       5737                     S12X3:
001737 5737 FD6E0E          19      LD  L,(IY+14)
00173A 573A FD660F          19      LD  H,(IY+15)
00173D 573D FD4E19          19      LD  C,(IY+25)
001740 5740 18BF            12      JR  S12X1
                                
       5742                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
001742 5742 CD064F          17      CALL    SET_FCB
001745 5745 CDD44E          17      CALL    GETSEQ
001748 5748 CDC14E          17      CALL    RB_READ
00174B 574B E5              11      PUSH    HL
00174C 574C CDE14E          17      CALL    SETSEQ
00174F 574F E1              10      POP HL
       5750                     SREAD:
001750 5750 C601             7      ADD A,001H
001752 5752 D8              11      RET C
                                
001753 5753 7D               4      LD  A,L
001754 5754 D601             7      SUB 001H
001756 5756 9F               4      SBC A,A
001757 5757 E603             7      AND 3
001759 5759 1F               4      RRA
00175A 575A C9              10      RET
                                
       575B                     _SYS18:     ;(BDOS)ログインベクトルの獲得
       575B                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
00175B 575B 2AF0F2          16      LD  HL,(_LVECTOR)
00175E 575E AF               4      XOR A
00175F 575F 67               4      LD  H,A
001760 5760 C9              10      RET
                                
       5761                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
001761 5761 3AEAF2          13      LD  A,(_DVSW)
001764 5764 A7               4      AND A
001765 5765 C9              10      RET
                                
       5766                     _SYS1A:     ;(BDOS)DTAの設定
001766 5766 ED53D4F2        20      LD  (_DTA),DE
00176A 576A AF               4      XOR A
00176B 576B C9              10      RET
                                
       576C                     _SYS1B:     ;(BDOS)ディスク情報の獲得
00176C 576C 7B               4      LD  A,E
00176D 576D D601             7      SUB 1
00176F 576F DC6157          17      CALL    C,_SYS19
001772 5772 5F               4      LD  E,A
001773 5773 CD7452          17      CALL    IS_BPB
001776 5776 3827            12      JR  C,S1B_E
001778 5778 F5              11      PUSH    AF
001779 5779 215EF5          10      LD  HL,SYS1B_DPB
00177C 577C 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
00177F 577F 47               4      LD  B,A
001780 5780 4F               4      LD  C,A
001781 5781 3271F5          13      LD  (SYS1B_FAT),A
001784 5784 7B               4      LD  A,E
001785 5785 CD9152          17      CALL    GETDPB
001788 5788 DD215EF5        14      LD  IX,SYS1B_DPB
00178C 578C FD2171F5        14      LD  IY,SYS1B_FAT
001790 5790 ED4B60F5        20      LD  BC,(SYS1B_DPB+1+1)  ;SECSIZ
001794 5794 ED5B6CF5        20      LD  DE,(SYS1B_DPB+1+13) ;MAXCLUS
001798 5798 1B               6      DEC DE
001799 5799 1B               6      DEC DE
00179A 579A 210000          10      LD  HL,0            ;書き込み不可なので0を返す
00179D 579D F1              10      POP AF
00179E 579E C9              10      RET
       579F                     S1B_E:
00179F 579F 9F               4      SBC A,A
0017A0 57A0 C9              10      RET
                                
       57A1                     _SYS21:     ;(BDOS)ランダムな読み出し
0017A1 57A1 CD064F          17      CALL    SET_FCB
                                
0017A4 57A4 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0017A7 57A7 FD6622          19      LD  H,(IY+34)
                                
0017AA 57AA CDC14E          17      CALL    RB_READ
0017AD 57AD 18A1            12      JR  SREAD
                                
       57AF                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
0017AF 57AF CD9056          17      CALL    _SYS0F
0017B2 57B2 D8              11      RET C
                                
0017B3 57B3 D5              11      PUSH    DE      ;EX DE,IY
0017B4 57B4 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0017B6 57B6 CDF64E          17      CALL    GETSIZE
       57B9                     _S24X1:
0017B9 57B9 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
0017BC 57BC FD7422          19      LD  (IY+34),H
0017BF 57BF FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
0017C3 57C3 FDE3            23      EX  (SP),IY     ;
0017C5 57C5 D1              10      POP DE      ;
                                
0017C6 57C6 AF               4      XOR A
0017C7 57C7 C9              10      RET
                                
       57C8                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
0017C8 57C8 E5              11      PUSH    HL
0017C9 57C9 D5              11      PUSH    DE      ;EX DE,IY
0017CA 57CA FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0017CC 57CC CDD44E          17      CALL    GETSEQ
0017CF 57CF 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       57D1                     _SYS27:     ;(BDOS)ランダムブロック読み込み
0017D1 57D1 CD064F          17      CALL    SET_FCB
0017D4 57D4 E5              11      PUSH    HL
0017D5 57D5 FD6E21          19      LD  L,(IY+33)
0017D8 57D8 FD6622          19      LD  H,(IY+34)
0017DB 57DB 22CAF2          16      LD  (RR_LOW),HL
0017DE 57DE FD6E23          19      LD  L,(IY+35)
0017E1 57E1 FD6624          19      LD  H,(IY+36)
0017E4 57E4 22CCF2          16      LD  (RR_HIGH),HL
0017E7 57E7 E1              10      POP HL
0017E8 57E8 CDA24A          17      CALL    ROM_READ
0017EB 57EB ED5BCAF2        20      LD  DE,(RR_LOW)
0017EF 57EF FD7321          19      LD  (IY+33),E
0017F2 57F2 FD7222          19      LD  (IY+34),D
0017F5 57F5 ED5BCCF2        20      LD  DE,(RR_HIGH)
0017F9 57F9 FD7323          19      LD  (IY+35),E
0017FC 57FC FD7224          19      LD  (IY+36),D
0017FF 57FF 9F               4      SBC A,A
001800 5800 D8              11      RET C
001801 5801 3AC3F2          13      LD  A,(_RESULT)
001804 5804 C9              10      RET
                                
       5805                     _SYS2F:
001805 5805 44               4      LD  B,H
001806 5806 7D               4      LD  A,L
001807 5807 2AD4F2          16      LD  HL,(_DTA)
00180A 580A C3F851          10      JP  DISKIO
                                
       580D                     _SYS5A:
00180D 580D 0600             7      LD  B,0
00180F 580F D5              11      PUSH    DE
001810 5810 DDE1            14      POP IX
       5812                     _SX5A1:
001812 5812 1A               7      LD  A,(DE)
001813 5813 B7               4      OR  A
001814 5814 2804            12      JR  Z,_SX5A2
001816 5816 13               6      INC DE
001817 5817 04               4      INC B
001818 5818 18F8            12      JR  _SX5A1
                                
       581A                     _SX5A2:
00181A 581A 78               4      LD  A,B
00181B 581B CD6D4B          17      CALL    FILE_BDOS
00181E 581E CDDA4F          17      CALL    ROM_CD
001821 5821 9F               4      SBC A,A
001822 5822 C9              10      RET
                                
       5823                     _SYS6F:
001823 5823 016F00          10      LD  BC,006FH
001826 5826 AF               4      XOR A
001827 5827 C9              10      RET
                                
       5828                     _SYS68:
001828 5828 21F0F2          10      LD  HL,_LVECTOR
00182B 582B CBFE            15      SET 7,(HL)
00182D 582D 78               4      LD  A,B
00182E 582E B7               4      OR  A
00182F 582F 3E00             7      LD  A,0
001831 5831 C0              11      RET NZ
001832 5832 CBBE            15      RES 7,(HL)
001834 5834 C9              10      RET 
                                
       5835                     INIT_FILE:
001835 5835 EB               4      EX  DE,HL
001836 5836 11F9F2          10      LD  DE,FDRV
001839 5839 010C00          10      LD  BC,1+8+3
       583C                     INIT_FILE1:
00183C 583C EDB0                    LDIR
00183E 583E CD0354          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
001841 5841 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
001844 5844 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
001847 5847 2AEBF2          16      LD  HL,(_CD)
00184A 584A 22F7F2          16      LD  (_CDX),HL           ;カレントディレクトリ
00184D 584D C9              10      RET
                                
       584E                     ZERO_MEMORY_DE:
00184E 584E AF               4      XOR A
       584F                     FILL_MEMORY_DE:
00184F 584F 12               7      LD  (DE),A
001850 5850 13               6      INC DE
001851 5851 10FC            13      DJNZ    FILL_MEMORY_DE
001853 5853 C9              10      RET
                                
       5854                     LD_A_DE:
001854 5854 1A               7      LD  A,(DE)
001855 5855 CB7A             8      BIT 7,D
001857 5857 C0              11      RET NZ
001858 5858 C5              11      PUSH    BC
001859 5859 D5              11      PUSH    DE
00185A 585A E5              11      PUSH    HL
00185B 585B EB               4      EX  DE,HL
                                
00185C 585C 0141F3          10      LD  BC,RAMAD0
00185F 585F 7C               4      LD  A,H
001860 5860 07               4      RLCA
001861 5861 07               4      RLCA
001862 5862 E603             7      AND 3
001864 5864 81               4      ADD A,C
001865 5865 4F               4      LD  C,A
001866 5866 0A               7      LD  A,(BC)
                                
001867 5867 CD0C00          17      CALL    _RDSLT
00186A 586A E1              10      POP HL
00186B 586B D1              10      POP DE
00186C 586C C1              10      POP BC
00186D 586D C9              10      RET
                                
       56F1                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       56F1                     _SYS13  EQU SCF_FF_RET  ;(BDOS)ファイルの削除
       56F1                     _SYS15  EQU SCF_FF_RET  ;(BDOS)シーケンシャルな書き込み
       56F1                     _SYS16  EQU SCF_FF_RET  ;(BDOS)ファイルの作成
       56F1                     _SYS17  EQU SCF_FF_RET  ;(BDOS)ファイル名の変更
       56F1                     _SYS22  EQU SCF_FF_RET  ;(BDOS)ランダムな書き込み
       56F1                     _SYS26  EQU SCF_FF_RET  ;(BDOS)ランダムブロック書き込み
       56F1                     _SYS28  EQU SCF_FF_RET  ;(BDOS)ランダムな書き込み・その2
                                
       56F1                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       56F1                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       56F1                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       56F1                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
00186E 586E                         ALIGN   256
       5900                     STABLE:
                                ;0
001900 5900 62547754A854F156        DW  _ERROR,_SYS01,_SYS02,_SYS03
001908 5908 62546254AD54FC54        DW  _ERROR,_ERROR,_SYS06,_SYS07
001910 5910 B554EE5416555B55        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
001918 5918 7A56805687569056        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001920 5920 E656F4562D57F156        DW  _SYS10,_SYS11,_SYS12,_SYS13
001928 5928 4257F156F156F156        DW  _SYS14,_SYS15,_SYS16,_SYS17
001930 5930 5B57615766576C57        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001938 5938 62545B5762546254        DW  _ERROR,_SYS1D,_ERROR,_ERROR
                                ;2
001940 5940 6254A157F156AF57        DW  _ERROR,_SYS21,_SYS22,_SYS23
001948 5948 C8576254F156D157        DW  _SYS24,_ERROR,_SYS26,_SYS27
001950 5950 F15662546D55F156        DW  _SYS28,_ERROR,_SYS2A,_SYS2B
001958 5958 BD55F15662540558        DW  _SYS2C,_SYS2D,_ERROR,_SYS2F
                                ;3
001960 5960 6254625462546254        DW  _ERROR,_ERROR,_ERROR,_ERROR
001968 5968 6254625462546254        DW  _ERROR,_ERROR,_ERROR,_ERROR
001970 5970 6254F156F1566254        DW  _ERROR,_SYS39,_SYS3A,_ERROR
001978 5978 6254625462546254        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001980 5980 6254625462546254        DW  _ERROR,_ERROR,_ERROR,_ERROR
001988 5988 6254625462546254        DW  _ERROR,_ERROR,_ERROR,_ERROR
001990 5990 6254625462546254        DW  _ERROR,_ERROR,_ERROR,_ERROR
001998 5998 6254625462546254        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
0019A0 59A0 6254625462546254        DW  _ERROR,_ERROR,_ERROR,_ERROR
0019A8 59A8 6254625462546254        DW  _ERROR,_ERROR,_ERROR,_ERROR
0019B0 59B0 625462540D586254        DW  _ERROR,_ERROR,_SYS5A,_ERROR
0019B8 59B8 6254625462546254        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
0019C0 59C0 6254625462546254        DW  _ERROR,_ERROR,_ERROR,_ERROR
0019C8 59C8 6254625462546254        DW  _ERROR,_ERROR,_ERROR,_ERROR
0019D0 59D0 2858625462546254        DW  _SYS68,_ERROR,_ERROR,_ERROR
0019D8 59D8 6254625462542358        DW  _ERROR,_ERROR,_ERROR,_SYS6F
                                ;7
0019E0 59E0 6254625462546254        DW  _ERROR,_ERROR,_ERROR,_ERROR
0019E8 59E8 6254625462546254        DW  _ERROR,_ERROR,_ERROR,_ERROR
0019F0 59F0 6254625462546254        DW  _ERROR,_ERROR,_ERROR,_ERROR
0019F8 59F8 6254625462546254        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
                                    INCLUDE "SLOT.ASM"
                                #if exists _RAM64K
       5A00                     INT38H_ROM:
001A00 5A00 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
001A03 5A03 CD095A          17      CALL    ENASLT_00H
001A06 5A06 CD3800          17      CALL    00038H
                                ;   JP  ENASLT_00H
                                ;
                                ;ページ0専門のENASLT
                                ;in
                                ;A←スロット
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
                                ; ページ1 に配置
       5A09                     ENASLT_00H:
001A09 5A09 F3               4      DI
001A0A 5A0A D5              11      PUSH    DE
001A0B 5A0B 6F               4      LD  L,A
001A0C 5A0C E603             7      AND 3
001A0E 5A0E 4F               4      LD  C,A
001A0F 5A0F DBA8            11      IN  A,(0A8H)
001A11 5A11 67               4      LD  H,A
001A12 5A12 E6FC             7      AND 0FCH    ;ページ0
001A14 5A14 B1               4      OR  C
001A15 5A15 57               4      LD  D,A ;基本スロット
                                
001A16 5A16 7C               4      LD  A,H
001A17 5A17 E603             7      AND 3
001A19 5A19 CB7D             8      BIT 7,L
001A1B 5A1B CAFAEF          10      JP  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001A1E 5A1E F680             7      OR  080H
001A20 5A20 67               4      LD  H,A
                                            ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001A21 5A21 79               4      LD  A,C
001A22 5A22 0F               4      RRCA
001A23 5A23 0F               4      RRCA
001A24 5A24 4F               4      LD  C,A
001A25 5A25 7A               4      LD  A,D
001A26 5A26 E63F             7      AND 03FH    ;ページ0
001A28 5A28 B1               4      OR  C
001A29 5A29 D3A8            11      OUT (0A8H),A
                                                ;拡張スロットの切り替え
001A2B 5A2B 7D               4      LD  A,L
001A2C 5A2C 0F               4      RRCA
001A2D 5A2D 0F               4      RRCA
001A2E 5A2E E603             7      AND 3
001A30 5A30 4F               4      LD  C,A
                                
001A31 5A31 3AFFFF          13      LD  A,(0FFFFH)
001A34 5A34 2F               4      CPL
001A35 5A35 47               4      LD  B,A
001A36 5A36 E6FC             7      AND 0FCH    ;ページ0
001A38 5A38 B1               4      OR  C
001A39 5A39 32FFFF          13      LD  (0FFFFH),A
                                                ;基本スロットの切り替え
001A3C 5A3C 7A               4      LD  A,D
001A3D 5A3D D3A8            11      OUT (0A8H),A
001A3F 5A3F 78               4      LD  A,B
001A40 5A40 E603             7      AND 3
001A42 5A42 87               4      ADD A,A
001A43 5A43 87               4      ADD A,A
001A44 5A44 C3ECEF          10      JP  WRITE_SLTTBL
                                ;
                                ;   ENASLOTの補助（ページ0・003BH～に配置）
                                ;
       5A47                     AT_3B:              ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001A47 5A47 D3A8            11      OUT (0A8H),A
001A49 5A49 3AFFFF          13      LD  A,(0FFFFH)  ;拡張スロットの切り替え
001A4C 5A4C 2F               4      CPL
001A4D 5A4D 47               4      LD  B,A
001A4E 5A4E A3               4      AND E
001A4F 5A4F B1               4      OR  C
001A50 5A50 32FFFF          13      LD  (0FFFFH),A
                                                ;基本スロットの切り替え
001A53 5A53 7A               4      LD  A,D
001A54 5A54 D3A8            11      OUT (0A8H),A
001A56 5A56 C9              10      RET
       5A57                     AT_3B_E:
                                
       5A57                     AT_ISC:
001A57 EF80                         ORG ISC,AT_ISC-RUN
                                ;
                                ; インタースロットコール
                                ; ページ3 に配置
                                
                                ;
                                ;ENASLT
                                ;in
                                ;A←スロット
                                ;HL←上位2ビットで切り替えるページを指定
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
       EF80                     ENASLT:
001A57 EF80 CB7C             8      BIT 7,H
001A59 EF82 207D            12      JR  NZ,ENASLT1
001A5B EF84 CB74             8      BIT 6,H
001A5D EF86 2032            12      JR  NZ,ENASLT_40H
       EF88                     _ENASLT_00H:
001A5F EF88 E5              11      PUSH    HL
001A60 EF89 210280          10      LD  HL,08002H
001A63 EF8C 39              11      ADD HL,SP
001A64 EF8D E1              10      POP HL
001A65 EF8E 3014            12      JR  NC,_ENASLT_00H_S
       EF90                     ENASLT_SUB:
001A67 EF90 DDE5            15      PUSH    IX
001A69 EF92 DD21095A        14      LD  IX,ENASLT_00H
       EF96                     INT38H_SUB1:
001A6D EF96 FDE5            15      PUSH    IY
001A6F EF98 FD2A96F2        20      LD  IY,(ROM_SLT-1)
001A73 EF9C CD51F0          17      CALL    CALSLT
001A76 EF9F FDE1            14      POP IY
001A78 EFA1 DDE1            14      POP IX
001A7A EFA3 C9              10      RET
       EFA4                     _ENASLT_00H_S:
001A7B EFA4 ED73AFEF        20      LD  (ENASLT_SP1),SP
001A7F EFA8 315DF5          10      LD  SP,SPBUF
001A82 EFAB CD90EF          17      CALL    ENASLT_SUB
001A85 EFAE 310000          10      LD  SP,0
       EFAF                     ENASLT_SP1  EQU $-2
001A88 EFB1 C9              10      RET
                                
       EFB2                     INT38H_SUB:
001A89 EFB2 DDE5            15      PUSH    IX
001A8B EFB4 DD21005A        14      LD  IX,INT38H_ROM
001A8F EFB8 18DC            12      JR  INT38H_SUB1
                                ;
                                ;ページ1専門のENASLT
                                ;in
                                ;A←スロット
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
       EFBA                     ENASLT_40H:
001A91 EFBA F3               4      DI
001A92 EFBB D5              11      PUSH    DE
001A93 EFBC 6F               4      LD  L,A
001A94 EFBD E603             7      AND 3
001A96 EFBF 87               4      ADD A,A
001A97 EFC0 87               4      ADD A,A
001A98 EFC1 4F               4      LD  C,A
001A99 EFC2 DBA8            11      IN  A,(0A8H)
001A9B EFC4 67               4      LD  H,A
001A9C EFC5 E6F3             7      AND 0F3H    ;ページ1
001A9E EFC7 B1               4      OR  C
001A9F EFC8 57               4      LD  D,A ;基本スロットに出力する値
                                
001AA0 EFC9 7C               4      LD  A,H ;切り替えページ
001AA1 EFCA 0F               4      RRCA
001AA2 EFCB 0F               4      RRCA
001AA3 EFCC E603             7      AND 3
001AA5 EFCE CB7D             8      BIT 7,L
001AA7 EFD0 2828            12      JR  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001AA9 EFD2 F680             7      OR  080H
001AAB EFD4 67               4      LD  H,A ;基本スロットに出力する値
                                            ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001AAC EFD5 E603             7      AND 3
001AAE EFD7 0F               4      RRCA
001AAF EFD8 0F               4      RRCA
001AB0 EFD9 4F               4      LD  C,A
                                
001AB1 EFDA 7A               4      LD  A,D ;基本スロットに出力する値
001AB2 EFDB E63F             7      AND 03FH
001AB4 EFDD B1               4      OR  C
001AB5 EFDE 5F               4      LD  E,A ;基本スロットでページ3にスロットを割り当てる
                                
001AB6 EFDF 7D               4      LD  A,L
001AB7 EFE0 E60C             7      AND 00CH    ;ページ1
001AB9 EFE2 4F               4      LD  C,A
                                
001ABA EFE3 7B               4      LD  A,E
001ABB EFE4 1EF3             7      LD  E,0F3H  ;ページ1
001ABD EFE6 CD3B00          17      CALL    ENASUB
                                
001AC0 EFE9 78               4      LD  A,B
001AC1 EFEA E60C             7      AND 00CH
       EFEC                     WRITE_SLTTBL:       ;SLTTBLを書き換える
001AC3 EFEC B4               4      OR  H   ;A=拡張スロット H=基本スロット
001AC4 EFED 4F               4      LD  C,A
                                
001AC5 EFEE 7D               4      LD  A,L
001AC6 EFEF E603             7      AND 3
001AC8 EFF1 C6C5             7      ADD A,LOW SLTTBL
001ACA EFF3 6F               4      LD  L,A
001ACB EFF4 26FC             7      LD  H,HIGH SLTTBL
001ACD EFF6 70               7      LD  (HL),B  ;B:拡張スロットに設定した値
001ACE EFF7 79               4      LD  A,C ;ENASLTする前のスロット情報をAで返す
001ACF EFF8 D1              10      POP DE
001AD0 EFF9 C9              10      RET
                                
       EFFA                     ENASLT_NOEXT:               ;スロットが拡張されていない場合
001AD1 EFFA 5F               4      LD  E,A
001AD2 EFFB 7A               4      LD  A,D
001AD3 EFFC D3A8            11      OUT (0A8H),A
001AD5 EFFE 7B               4      LD  A,E ;ENASLTする前のスロット情報をAで返す
001AD6 EFFF D1              10      POP DE
001AD7 F000 C9              10      RET
                                
       F001                     ENASLT1:
001AD8 F001 CB74             8      BIT 6,H
001ADA F003 C0              11      RET NZ          ;ページ3はスロット切り替え不可
                                ;
                                ;ページ2専門のENASLT
                                ;in
                                ;A←スロット
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
       F004                     ENASLT_80H:
001ADB F004 F3               4      DI
001ADC F005 D5              11      PUSH    DE
001ADD F006 6F               4      LD  L,A
001ADE F007 E603             7      AND 3
001AE0 F009 87               4      ADD A,A
001AE1 F00A 87               4      ADD A,A
001AE2 F00B 87               4      ADD A,A
001AE3 F00C 87               4      ADD A,A
001AE4 F00D 4F               4      LD  C,A
001AE5 F00E DBA8            11      IN  A,(0A8H)
001AE7 F010 67               4      LD  H,A
001AE8 F011 E6CF             7      AND 0CFH    ;ページ2
001AEA F013 B1               4      OR  C
001AEB F014 57               4      LD  D,A ;基本スロット
                                
001AEC F015 7C               4      LD  A,H
001AED F016 0F               4      RRCA
001AEE F017 0F               4      RRCA
001AEF F018 0F               4      RRCA
001AF0 F019 0F               4      RRCA
001AF1 F01A E603             7      AND 3
001AF3 F01C CB7D             8      BIT 7,L
001AF5 F01E 28DA            12      JR  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001AF7 F020 F680             7      OR  080H
001AF9 F022 67               4      LD  H,A
                                            ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001AFA F023 7F               4      LD  A,A
001AFB F024 E603             7      AND 3
001AFD F026 0F               4      RRCA
001AFE F027 0F               4      RRCA
001AFF F028 4F               4      LD  C,A
001B00 F029 7A               4      LD  A,D
001B01 F02A E63F             7      AND 03FH    ;ページ2
001B03 F02C B1               4      OR  C
001B04 F02D 5F               4      LD  E,A
                                
001B05 F02E 7D               4      LD  A,L
001B06 F02F 07               4      RLCA
001B07 F030 07               4      RLCA
001B08 F031 E630             7      AND 030H
001B0A F033 4F               4      LD  C,A
                                
001B0B F034 7B               4      LD  A,E
001B0C F035 1ECF             7      LD  E,0CFH  ;ページ2
001B0E F037 CD3B00          17      CALL    ENASUB
                                
001B11 F03A 78               4      LD  A,B
001B12 F03B E630             7      AND 030H    ;ページ2
001B14 F03D 0F               4      RRCA
001B15 F03E 0F               4      RRCA
001B16 F03F 18AB            12      JR  WRITE_SLTTBL
                                
       F041                     CALLF:
001B18 F041 E3              19      EX  (SP),HL
001B19 F042 F5              11      PUSH    AF
001B1A F043 7E               7      LD  A,(HL)
001B1B F044 FD67             9      LD  IYH,A
001B1D F046 23               6      INC HL
001B1E F047 7E               7      LD  A,(HL)
001B1F F048 DD6F             9      LD  IXL,A
001B21 F04A 23               6      INC HL
001B22 F04B 7E               7      LD  A,(HL)
001B23 F04C DD67             9      LD  IXH,A
001B25 F04E 23               6      INC HL
001B26 F04F F1              10      POP AF
001B27 F050 E3              19      EX  (SP),HL
       F051                     CALSLT:
001B28 F051 08               4      EX  AF,AF'
001B29 F052 F5              11      PUSH    AF      ;裏AFを保存
001B2A F053 F3               4      DI
001B2B F054 E5              11      PUSH    HL
001B2C F055 210280          10      LD  HL,08002H
001B2F F058 39              11      ADD HL,SP
001B30 F059 E1              10      POP HL
001B31 F05A 3008            12      JR  NC,CALSLT_1
001B33 F05C CD73F0          17      CALL    CALSLT_2
       F05F                     CALSLT_E:
001B36 F05F 08               4      EX  AF,AF'
001B37 F060 F1              10      POP AF      ;保存した裏AF
001B38 F061 08               4      EX  AF,AF'
001B39 F062 FB               4      EI
001B3A F063 C9              10      RET
       F064                     CALSLT_1:
001B3B F064 ED736FF0        20      LD  (CSSP),SP
001B3F F068 315DF5          10      LD  SP,SPBUF
001B42 F06B CD73F0          17      CALL    CALSLT_2
001B45 F06E 310000          10      LD  SP,0
       F06F                     CSSP    EQU $-2
001B48 F071 18EC            12      JR  CALSLT_E
                                
       F073                     CALSLT_2:
001B4A F073 E5              11      PUSH    HL
001B4B F074 C5              11      PUSH    BC
001B4C F075 DD7C             9      LD  A,IXH
001B4E F077 67               4      LD  H,A
001B4F F078 FD7C             9      LD  A,IYH
001B51 F07A CD80EF          17      CALL    ENASLT
001B54 F07D C1              10      POP BC
001B55 F07E 6F               4      LD  L,A
001B56 F07F DD7C             9      LD  A,IXH
001B58 F081 67               4      LD  H,A
001B59 F082 E3              19      EX  (SP),HL
001B5A F083 08               4      EX  AF,AF'
001B5B F084 CD98F3          17      CALL    JP_IX
001B5E F087 E3              19      EX  (SP),HL
001B5F F088 C5              11      PUSH    BC
001B60 F089 08               4      EX  AF,AF'
001B61 F08A 7D               4      LD  A,L
001B62 F08B CD80EF          17      CALL    ENASLT
001B65 F08E 08               4      EX  AF,AF'
001B66 F08F C1              10      POP BC
001B67 F090 E1              10      POP HL
001B68 F091 C9              10      RET
                                
       F092                     RDSLT:
001B69 F092 E5              11      PUSH    HL
001B6A F093 CD80EF          17      CALL    ENASLT
001B6D F096 E1              10      POP HL
001B6E F097 46               7      LD  B,(HL)
001B6F F098 C5              11      PUSH    BC
001B70 F099 E5              11      PUSH    HL
001B71 F09A CD80EF          17      CALL    ENASLT
001B74 F09D E1              10      POP HL
001B75 F09E F1              10      POP AF
001B76 F09F C9              10      RET
                                
       F0A0                     WRSLT:
001B77 F0A0 E5              11      PUSH    HL
001B78 F0A1 CD80EF          17      CALL    ENASLT
001B7B F0A4 E1              10      POP HL
001B7C F0A5 73               7      LD  (HL),E
001B7D F0A6 E5              11      PUSH    HL
001B7E F0A7 CD80EF          17      CALL    ENASLT
001B81 F0AA E1              10      POP HL
001B82 F0AB C9              10      RET
                                
       F0AC                     INT38H:
001B83 F0AC F5              11      PUSH    AF
001B84 F0AD C5              11      PUSH    BC
001B85 F0AE E5              11      PUSH    HL
001B86 F0AF 210280          10      LD  HL,08002H
001B89 F0B2 39              11      ADD HL,SP
001B8A F0B3 380E            12      JR  C,INT38H1
001B8C F0B5 ED73C0F0        20      LD  (INTSP),SP  ;スタックポインタ保存
001B90 F0B9 315DF5          10      LD  SP,SPBUF
001B93 F0BC CDB2EF          17      CALL    INT38H_SUB
001B96 F0BF 310000          10      LD  SP,0
       F0C0                     INTSP   EQU $-2
001B99 F0C2 AF               4      XOR A
       F0C3                     INT38H1:
001B9A F0C3 DCB2EF          17      CALL    C,INT38H_SUB
001B9D F0C6 E1              10      POP HL
001B9E F0C7 C1              10      POP BC
001B9F F0C8 F1              10      POP AF
001BA0 F0C9 FB               4      EI
001BA1 F0CA C9              10      RET
                                
       F0CB                     ISC_E:
001BA2 5BA2                         ORG $$+RUN,$$   ;$DEPHASE
                                
                                #endif
       5BA2                     AT_ISCB:
001BA2 F280                         ORG ISCB,AT_ISCB-RUN
                                
       F280                     REPLACE_COMMAND:
001BA2 F280 FEB7             7      CP  0B7H            ;FILES
001BA4 F282 CC7BFE          17      CALL    Z,H_FILE
001BA7 F285 FEB5             7      CP  0B5H            ;LOAD
001BA9 F287 CA71FE          10      JP  Z,H_BINS
001BAC F28A FE8A             7      CP  08AH            ;RUN
001BAE F28C CA76FE          10      JP  Z,H_BINL
001BB1 F28F FED6             7      CP  0D6H            ;COPY
001BB3 F291 2813            12      JR  Z,FIX_COPY
001BB5 F293 FECF             7      CP  0CFH            ;BLOAD
001BB7 F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
001BB8 F296 F7              12      RST 30H
       F297                     ROM_SLT:
001BB9 F297 00                      DB  0
001BBA F298 0447                    DW  ROM_BLOAD
001BBC F29A F5              11      PUSH    AF
001BBD F29B E5              11      PUSH    HL
001BBE F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
001BC1 F29F E1              10      POP HL
001BC2 F2A0 F1              10      POP AF
001BC3 F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
001BC5 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
001BC7 F2A5 C9              10      RET
       F2A6                     FIX_COPY:
001BC8 F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
001BC9 F2A7 00                      DB  0
001BCA F2A8 8248                    DW  ROM_COPY
001BCC F2AA C9              10      RET
       F2AB                     RAMUSE1:
001BCD F2AB 3A42F3          13      LD  A,(RAMAD1)
001BD0 F2AE 180E            12      JR  _ENASLT_40H
       F2B0                     CAL_MP:
001BD2 F2B0 2640             7      LD  H,040H
001BD4 F2B2 3AC1FC          13      LD  A,(EXPTBL)
001BD7 F2B5 CD2400          17      CALL    _ENASLT
001BDA F2B8 CD1C00          17      CALL    _CALSLT
       F2BB                     ROMUSE1:
001BDD F2BB 3A97F2          13      LD  A,(ROM_SLT)
       F2BE                     _ENASLT_40H:
001BE0 F2BE 2640             7      LD  H,040H
001BE2 F2C0 C32400          10      JP  _ENASLT
                                
       F2C3                     _RESULT:
001BE5 F2C3 00                      DB  0
       F2C4                     _BANK:
001BE6 F2C4 00                      DB  0
       F2C5                     _BANK1:
001BE7 F2C5 00                      DB  0
       F2C6                     CLSZ:               ;クラスタサイズ
001BE8 F2C6 0004                    DW  1024
       F2C7                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2C8                     SECSZ:              ;セクタサイズ
001BEA F2C8 0002                    DW  512
       F2C9                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2CA                     RR_LOW:
001BEC F2CA 0000                    DW  0
       F2CB                     RR_MID  EQU $-1
       F2CC                     RR_HIGH:
001BEE F2CC 0000                    DW  0
       F2CE                     _CLPS:
001BF0 F2CE 0000                    DW  0
       F2D0                     _LEFT:
001BF2 F2D0 0000                    DW  0
       F2D2                     _DTPS:
001BF4 F2D2 0000                    DW  0
       F2D4                     _DTA:
001BF6 F2D4 0000                    DW  0
       F2D6                     FLG_LDIR:
001BF8 F2D6 00                      DB  0
       F2D7                     _FCB:
001BF9 F2D7 0000                    DW  0
       F2D9                     _BUF:
       F2D9                     _BUF_LO:        ;LOGICAL OPERATION
001BFB F2D9 00                      DB  0
       F2DA                     _BUF_ST:
001BFC F2DA 0000                    DW  0
       F2DC                     _BUF_EN:
001BFE F2DC 0000                    DW  0
       F2DE                     _BUF_EX:
       F2DE                     _BUF_W:
001C00 F2DE 0000                    DW  0
       F2E0                     _BUF_H:
001C02 F2E0 0000                    DW  0
       F2E2                     _BUF_X:
001C04 F2E2 0000                    DW  0
       F2E4                     _BUF_Y:
001C06 F2E4 00                      DB  0
       F2E5                     _BUF_P:
001C07 F2E5 00                      DB  0
       F2E6                     _BUF_O:
001C08 F2E6 00                      DB  0
       F2E7                     DTAX:
001C09 F2E7 0000                    DW  0
       F2E9                     B_DRIVE:
001C0B F2E9 00                      DB  0
       F2EA                     _DVSW:          ;カレントドライブ
001C0C F2EA 00                      DB  0
       F2EB                     _CD:            ;カレントディレクトリ
001C0D F2EB 0000                    DW  0
       F2ED                     DIRENT1:
001C0F F2ED 0000                    DW  0
       F2EF                     _DIR_BANK:
001C11 F2EF 00                      DB  0
       F2F0                     _LVECTOR:
001C12 F2F0 01                      DB  1
       F2F1                     LEFTX:
001C13 F2F1 0000                    DW  0
       F2F3                     PARAM0:
001C15 F2F3 0000                    DW  0
       F2F5                     PARAM1:
001C17 F2F5 0000                    DW  0
       F2F7                     _CDX:
001C19 F2F7 0000                    DW  0
       F2F9                     FDRV:
001C1B F2F9 00                      DB  0
       F2FA                     FNAME:
001C1C F2FA                         DS  8+3
       F305                     _HL:
001C27 F305 0000                    DW  0
       F307                     _SP:
001C29 F307 0000                    DW  0
       F308                     _SP_H   EQU $-1
                                
       F309                     ISCB_E:
[EOF:SLOT.ASM:UTF_8]
       1C2B                     LAST    EQU $$
001C2B F309                         DS  01FFFH-LAST
001FFF F6DD 00                      DB  0
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
[EOF:DISKROM64K.ASM:UTF_8]
