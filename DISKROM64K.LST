                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
       0001                     _RAM64K     EQU 1   ;メインRAM 64KB使用可能
                                
                                    INCLUDE "DISKROM.ASM"
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       006C                     INITXT  EQU 0006CH
       0078                     SETTXT  EQU 00078H
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00AE                     PLININ  EQU 000AEH
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
       0159                     CALBAS  EQU 00159H
       01F5                     REDCLK  EQU 001F5H  ;SUB
       01F9                     WRTCLK  EQU 001F9H  ;SUB
                                
       269A                     DECADD  EQU 0269AH
       27E6                     DECMUL  EQU 027E6H
       2F8A                     FRCINT  EQU 02F8AH
                                
       303A                     FRCDBL  EQU 0303AH
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
       7D17                     ST_BAS  EQU 07D17H
                                
       F323                     DISKVE  EQU 0F323H
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F398                     JP_IX   EQU 0F398H
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F847                     ARG EQU 0F847H
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
       FAF8                     EXBRSA  EQU 0FAF8H
                                
       FB03                     RSTMP   EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBB1                     BASROM  EQU 0FBB1H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCC5                     SLTTBL  EQU 0FCC5H
       FCC9                     SLTATR  EQU 0FCC9H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
       FD99                     DEVICE  EQU 0FD99H
                                
       FDDB                     H_PINL  EQU 0FDDBH
       FE12                     H_DSKF  EQU 0FE12H
       FE30                     H_MKI   EQU 0FE30H
       FE3F                     H_CVI   EQU 0FE3FH
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       C000                     FD_BOOT_START   EQU 0C000H
       C01E                     FD_BOOT_EXEC    EQU 0C01EH
                                
                                #if exists USE_NORMAL32K_OR_ASCII16
                                            ;ASCII-16K
                                ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
                                ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
       EF40                     ISC EQU 0EF40H
       F280                     ISCB    EQU 0F280H
                                
                                #if exists _RAM64K
       EF40                     NEW_HIMEM   EQU ISC
                                #else
                                NEW_HIMEM   EQU ISCB
                                #endif
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F55D                     SPBUF   EQU KBUF+318    ;ページ3にスタックがない場合はKBUFを一時的に使う
                                
       003B                     ENASUB  EQU 0003BH
       F55E                     SYS1B_DPB   EQU BUF
       F571                     SYS1B_FAT   EQU SYS1B_DPB+19
                                
       FB03                     TMP_DIRENT  EQU RSTMP
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM    ; Main program execution address.
000004 4004 0051                    DW  STATEMENT   ; STATEMENT
000006 4006 3452                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C3E453          10      JP  DISKIO
000013 4013 C32654          10      JP  DSKCHG
000016 4016 C37C54          10      JP  GETDPB
000019 4019 C36F55          10      JP  CHOICE
00001C 401C C37355          10      JP  DSKFMT
00001F 401F C37555          10      JP  DSKSTP
000022 4022 C37655          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C37355          10      JP  DSKFMT
000029 4029 C37555          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3E155          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite"
            204449534B20524F    
            4D204C697465        
000096 4096                         ALIGN   32
0000A0 40A0 76302E372E332E31        DB  "v0.7.3.1"
0000A8 40A8                         ALIGN   32
       40C0                     MSG_ERROR_ROM_MODE:
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    DB  "Normal ROM/ASCII-16K only!",13,10
                                #else
0000C0 40C0 41534349492D384B        DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
            2F4B6F6E616D692D    
            384B2F4B6F6E616D    
            692D534343206F6E    
            6C79210D0A          
                                #endif
000100 4100                         ORG 04100H
       4100                     INIT_ROM:
000100 4100 AF               4      XOR A
000101 4101 2100F3          10      LD  HL,0F300H
000104 4104 0668             7      LD  B,068H
000106 4106 CD494D          17      CALL    FILL_MEMORY
                                
000109 4109 3E01             7      LD  A,1
00010B 410B 3221FB          13      LD  (DRVTBL),A
                                
00010E 410E 2A4AFC          16      LD  HL,(HIMEM)
000111 4111 1140EF          10      LD  DE,NEW_HIMEM
000114 4114 A7               4      AND A
000115 4115 ED52            15      SBC HL,DE
000117 4117 382D            12      JR  C,INIT1
000119 4119 EB               4      EX  DE,HL
00011A 411A 2A74F6          16      LD  HL,(STKTOP)
00011D 411D ED52            15      SBC HL,DE
00011F 411F 2274F6          16      LD  (STKTOP),HL ;起動時の空き容量表示の為
000122 4122 F9               6      LD  SP,HL
000123 4123 2A72F6          16      LD  HL,(MEMSIZ)
000126 4126 7C               4      LD  A,H
000127 4127 B5               4      OR  L
000128 4128 320CF3          13      LD  (IS_BIOS),A
00012B 412B 2006            12      JR  NZ,GENUINE
00012D 412D 2180F1          10      LD  HL,0F180H   ;C-BIOSの場合に補正する
000130 4130 229BF6          16      LD  (FRETOP),HL
       4133                     GENUINE:
000133 4133 ED52            15      SBC HL,DE
000135 4135 2272F6          16      LD  (MEMSIZ),HL
000138 4138 2A9BF6          16      LD  HL,(FRETOP)
00013B 413B ED52            15      SBC HL,DE
00013D 413D 229BF6          16      LD  (FRETOP),HL
000140 4140 2140EF          10      LD  HL,NEW_HIMEM
000143 4143 224AFC          16      LD  (HIMEM),HL
       4146                     INIT1:
000146 4146 AF               4      XOR A
000147 4147 32EAF2          13      LD  (_DVSW),A
00014A 414A 3D               4      DEC A       ;0FFH
00014B 414B 3299FD          13      LD  (DEVICE),A
                                #if exists _RAM64K
00014E 414E 218F5C          10      LD  HL,AT_ISC
000151 4151 1140EF          10      LD  DE,ISC
000154 4154 010E02          10      LD  BC,ISC_E-ISC
000157 4157 EDB0                    LDIR
                                #endif
000159 4159 C30043          10      JP  INIT_300
                                
0001BD 41BD                         ORG 041BDH
0001BD 41BD C9              10      RET
                                
                                    ;MBR_Partition1 (2DDのデータ)
0001BE 41BE 00                      DB  0       ;ブートフラグ
0001BF 41BF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001C2 41C2 01                      DB  1       ;識別子(FAT12)
0001C3 41C3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001C6 41C6 10000000                DW  16,0        ;パーティションの最初のセクタ番号(LBA方式)
0001CA 41CA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
                                #if exists USE_NORMAL32K_OR_ASCII16
                                #else
                                    ;MBR_Partition2 (2DDのデータ)
0001CE 41CE 00                      DB  0       ;ブートフラグ
0001CF 41CF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001D2 41D2 01                      DB  1       ;識別子(FAT12)
0001D3 41D3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001D6 41D6 B0050000                DW  16+1440,0   ;パーティションの最初のセクタ番号(LBA方式)
0001DA 41DA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                #endif
                                
0001FE 41FE                         ORG 041FEH
0001FE 41FE 55AA                    DB  055H,0AAH   ;MBR_Sig
                                
                                    INCLUDE "TABLE.ASM"
       4200                     STABLE:
                                ;0
000200 4200 74568956BA56D059        DW  _ERROR,_SYS01,_SYS02,_SYS03
000208 4208 74567456BF560E57        DW  _ERROR,_ERROR,_SYS06,_SYS07
000210 4210 C75600575A573158        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
000218 4218 505956595D596659        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
000220 4220 CB59D359185AD059        DW  _SYS10,_SYS11,_SYS12,_SYS13
000228 4228 3B5AD059D059D059        DW  _SYS14,_SYS15,_SYS16,_SYS17
000230 4230 545A5A5A5F5A655A        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
000238 4238 7456545A74567456        DW  _ERROR,_SYS1D,_ERROR,_ERROR
                                ;2
000240 4240 74569A5AD059A85A        DW  _ERROR,_SYS21,_SYS22,_SYS23
000248 4248 C15A7456D059CA5A        DW  _SYS24,_ERROR,_SYS26,_SYS27
000250 4250 D059105B4358D059        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
000258 4258 9358D05974562B5B        DW  _SYS2C,_SYS2D,_ERROR,_SYS2F
                                ;3
000260 4260 7456745674567456        DW  _ERROR,_ERROR,_ERROR,_ERROR
000268 4268 7456745674567456        DW  _ERROR,_ERROR,_ERROR,_ERROR
000270 4270 7456D059D0597456        DW  _ERROR,_SYS39,_SYS3A,_ERROR
000278 4278 7456745674567456        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
000280 4280 7456745674567456        DW  _ERROR,_ERROR,_ERROR,_ERROR
000288 4288 7456745674567456        DW  _ERROR,_ERROR,_ERROR,_ERROR
000290 4290 7456745674567456        DW  _ERROR,_ERROR,_ERROR,_ERROR
000298 4298 7456745674567456        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
0002A0 42A0 7456745674567456        DW  _ERROR,_ERROR,_ERROR,_ERROR
0002A8 42A8 7456745674567456        DW  _ERROR,_ERROR,_ERROR,_ERROR
0002B0 42B0 7456335B455B505B        DW  _ERROR,_SYS59,_SYS5A,_SYS5B
0002B8 42B8 5A5B745674567456        DW  _SYS5C,_ERROR,_ERROR,_ERROR
                                ;6
0002C0 42C0 7456745674567456        DW  _ERROR,_ERROR,_ERROR,_ERROR
0002C8 42C8 7456745674567456        DW  _ERROR,_ERROR,_ERROR,_ERROR
0002D0 42D0 975B745674567456        DW  _SYS68,_ERROR,_ERROR,_ERROR
0002D8 42D8 7456745674568F5B        DW  _ERROR,_ERROR,_ERROR,_SYS6F
                                ;7
0002E0 42E0 7456745674567456        DW  _ERROR,_ERROR,_ERROR,_ERROR
0002E8 42E8 7456745674567456        DW  _ERROR,_ERROR,_ERROR,_ERROR
0002F0 42F0 7456745674567456        DW  _ERROR,_ERROR,_ERROR,_ERROR
0002F8 42F8 7456745674567456        DW  _ERROR,_ERROR,_ERROR,_ERROR
[EOF:TABLE.ASM:UTF_8]
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
       4300                     INIT_300:
000300 4300 3A0CF3          13      LD  A,(IS_BIOS)
000303 4303 219D5E          10      LD  HL,AT_ISCB
000306 4306 1180F2          10      LD  DE,ISCB
000309 4309 018D00          10      LD  BC,ISCB_E-ISCB
00030C 430C EDB0                    LDIR
00030E 430E 320CF3          13      LD  (IS_BIOS),A
000311 4311 2AB1F6          16      LD  HL,(SAVSTK)
000314 4314 224BF3          16      LD  (0F34BH),HL
                                
000317 4317 3EC3             7      LD  A,0C3H      ;JP
000319 4319 3243FF          13      LD  (H_GONE),A
00031C 431C 327DF3          13      LD  (BDOS),A
00031F 431F 326BF3          13      LD  (RAMUSE),A
000322 4322 3268F3          13      LD  (ROMUSE),A
000325 4325 2180F2          10      LD  HL,REPLACE_COMMAND
000328 4328 2244FF          16      LD  (H_GONE+1),HL
00032B 432B 2131F3          10      LD  HL,H_BDOS
00032E 432E 227EF3          16      LD  (BDOS+1),HL
000331 4331 21ABF2          10      LD  HL,RAMUSE1
000334 4334 226CF3          16      LD  (RAMUSE+1),HL
000337 4337 21BBF2          10      LD  HL,ROMUSE1
00033A 433A 2269F3          16      LD  (ROMUSE+1),HL
                                
00033D 433D 3E                      DB  03EH
00033E 433E F7              12      RST 30H
00033F 433F 3271FE          13      LD  (H_BINS),A
000342 4342 3276FE          13      LD  (H_BINL),A
000345 4345 327BFE          13      LD  (H_FILE),A
000348 4348 3231F3          13      LD  (H_BDOS),A
00034B 434B 32A7FF          13      LD  (H_PHYD),A
                                
00034E 434E 2640             7      LD  H,040H
000350 4350 CD8F5C          17      CALL    AT_GETSLT
000353 4353 3297F2          13      LD  (ROM_SLT),A
000356 4356 32A7F2          13      LD  (ROM_SLT_COPY),A
000359 4359 3272FE          13      LD  (H_BINS+1),A
00035C 435C 3277FE          13      LD  (H_BINL+1),A
00035F 435F 327CFE          13      LD  (H_FILE+1),A
000362 4362 3232F3          13      LD  (H_BDOS+1),A
000365 4365 32A8FF          13      LD  (H_PHYD+1),A
000368 4368 3222FB          13      LD  (DRVTBL+1),A
00036B 436B 3248F3          13      LD  (MASTERS),A
00036E 436E 213547          10      LD  HL,ROM_LOAD
000371 4371 2273FE          16      LD  (H_BINS+2),HL
000374 4374 21E948          10      LD  HL,ROM_RUN
000377 4377 2278FE          16      LD  (H_BINL+2),HL
00037A 437A 21F748          10      LD  HL,ROM_FILES
00037D 437D 227DFE          16      LD  (H_FILE+2),HL
000380 4380 217756          10      LD  HL,ROM_BDOS
000383 4383 2233F3          16      LD  (H_BDOS+2),HL
000386 4386 21E453          10      LD  HL,DISKIO
000389 4389 22A9FF          16      LD  (H_PHYD+2),HL
                                
00038C 438C 3E                      DB  03EH
00038D 438D C9              10      RET
00038E 438E 327FFE          13      LD  (H_FILE+4),A
000391 4391 3275FE          13      LD  (H_BINS+4),A
000394 4394 327AFE          13      LD  (H_BINL+4),A
000397 4397 3235F3          13      LD  (H_BDOS+4),A
00039A 439A 32DFFD          13      LD  (H_PINL+4),A
00039D 439D 32ABFF          13      LD  (H_PHYD+4),A
                                #if exists _RAM64K
0003A0 43A0 3ECD             7      LD  A,0CDH      ;CALL
0003A2 43A2 3230FE          13      LD  (H_MKI),A
0003A5 43A5 323FFE          13      LD  (H_CVI),A
0003A8 43A8 3212FE          13      LD  (H_DSKF),A
                                
0003AB 43AB 213CF1          10      LD  HL,CALL_RF
0003AE 43AE 2231FE          16      LD  (H_MKI+1),HL
0003B1 43B1 2240FE          16      LD  (H_CVI+1),HL
0003B4 43B4 2213FE          16      LD  (H_DSKF+1),HL
                                
0003B7 43B7 215F53          10      LD  HL,ROM_MKI
0003BA 43BA 2233FE          16      LD  (H_MKI+3),HL
0003BD 43BD 218253          10      LD  HL,ROM_CVI
0003C0 43C0 2242FE          16      LD  (H_CVI+3),HL
0003C3 43C3 21AB53          10      LD  HL,ROM_DSKF
0003C6 43C6 2215FE          16      LD  (H_DSKF+3),HL
                                #endif
0003C9 43C9 AF               4      XOR A
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK0_SEL),A       ;似非RAM対策でバンク0を設定
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0003CA 43CA 320060          13      LD  (BANK0_SEL),A           ;似非RAM対策でバンク0を設定
0003CD 43CD 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0003D0 43D0 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0003D3 43D3 3A0060          13      LD  A,(BANK1_ADR)
0003D6 43D6 FE41             7      CP  'A'
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    JP  Z,NOT_BANK_TYPE
                                    LD  A,DISK_BANK
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0003D8 43D8 C2E644          10      JP  NZ,NOT_BANK_TYPE
0003DB 43DB 3E01             7      LD  A,DISK_BANK
0003DD 43DD 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0003E0 43E0 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0003E3 43E3 26C0             7      LD  H,0C0H
0003E5 43E5 CD8F5C          17      CALL    AT_GETSLT
0003E8 43E8 3244F3          13      LD  (RAMAD3),A
0003EB 43EB 2680             7      LD  H,080H
0003ED 43ED CD8F5C          17      CALL    AT_GETSLT
0003F0 43F0 CDF344          17      CALL    CHK_RAM
0003F3 43F3 3243F3          13      LD  (RAMAD2),A
       43F6                     RAMCHK2:
0003F6 43F6 3A44F3          13      LD  A,(RAMAD3)
0003F9 43F9 2640             7      LD  H,040H
0003FB 43FB CDF344          17      CALL    CHK_RAM
0003FE 43FE 3242F3          13      LD  (RAMAD1),A
       4401                     RAMCHK1:
000401 4401 3A44F3          13      LD  A,(RAMAD3)
000404 4404 2600             7      LD  H,00H
000406 4406 CDF344          17      CALL    CHK_RAM
000409 4409 3241F3          13      LD  (RAMAD0),A
       440C                     RAMCHK0:
00040C 440C 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16
00040F 440F 010F00          10      LD  BC,0000FH       ;切り上げ
000412 4412 09              11      ADD HL,BC
000413 4413 7D               4      LD  A,L
                                
000414 4414 0604             7      LD  B,4
       4416                     B_DRIVE1:
000416 4416 CB3C             8      SRL H
000418 4418 1F               4      RRA
000419 4419 10FB            13      DJNZ    B_DRIVE1
                                
00041B 441B C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
00041D 441D 32E9F2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IX,CHGET
                                    CALL    CALSLT_R
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
                                    ;拡張スロットの選択を設定する
000420 4420 3A97F2          13      LD  A,(ROM_SLT)
000423 4423 57               4      LD  D,A
000424 4424 E60C             7      AND 00CH
000426 4426 5F               4      LD  E,A
000427 4427 7A               4      LD  A,D
000428 4428 E603             7      AND 3
00042A 442A 87               4      ADD A,A
00042B 442B 87               4      ADD A,A
00042C 442C 87               4      ADD A,A
00042D 442D 37               4      SCF
00042E 442E 8F               4      ADC A,A
00042F 442F B3               4      OR  E
000430 4430 5F               4      LD  E,A
000431 4431 1600             7      LD  D,0
000433 4433 21C9FC          10      LD  HL,SLTATR
000436 4436 19              11      ADD HL,DE
000437 4437 3660            10      LD  (HL),060H
                                
000439 4439 3E01             7      LD  A,1
00043B 443B CD5F54          17      CALL    IS_BPB
00043E 443E 9F               4      SBC A,A
00043F 443F E602             7      AND 2
000441 4441 EE03             7      XOR 3
000443 4443 32F2F2          13      LD  (_LVECTOR),A
                                    ;CTRL+STOPを抑制する
000446 4446 3E01             7      LD  A,1
000448 4448 32B1FB          13      LD  (BASROM),A
                                
00044B 444B 3ACAFF          13      LD  A,(EXTBIO)
00044E 444E FEF7             7      CP  0F7H        ;RST 30H
000450 4450 280A            12      JR  Z,EXTBIO_OK
000452 4452 3E                      DB  03EH
000453 4453 C9              10      RET
000454 4454 21CAFF          10      LD  HL,EXTBIO
000457 4457 061D             7      LD  B,29
000459 4459 CD494D          17      CALL    FILL_MEMORY
       445C                     EXTBIO_OK:
00045C 445C AF               4      XOR A
00045D 445D 3240F3          13      LD  (REBOOT),A
000460 4460 2A48FC          16      LD  HL,(BOTTOM)
000463 4463 110040          10      LD  DE,16384
000466 4466 19              11      ADD HL,DE
000467 4467 DAE344          10      JP  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
00046A 446A 57               4      LD  D,A
00046B 446B 0601             7      LD  B,1
00046D 446D 2100C0          10      LD  HL,FD_BOOT_START
000470 4470 CDE453          17      CALL    DISKIO
000473 4473 DA7655          10      JP  C,BASENT
                                
000476 4476 1168F3          10      LD  DE,ROMUSE
000479 4479 2123F3          10      LD  HL,DISKVE
00047C 447C AF               4      XOR A
00047D 447D CD1EC0          17      CALL    FD_BOOT_EXEC
                                #if exists _RAM64K
                                                ;64K版の場合はページ0をRAMに切り替えRAM側にインタースロットコールを入れる
000480 4480 3A41F3          13      LD  A,(RAMAD0)  ;ページ0をRAMに切り替える
000483 4483 CD615C          17      CALL    ENASLT_00H
                                
000486 4486 AF               4      XOR A
000487 4487 47               4      LD  B,A
000488 4488 67               4      LD  H,A
000489 4489 6F               4      LD  L,A
00048A 448A CD494D          17      CALL    FILL_MEMORY
                                
00048D 448D 3EC3             7      LD  A,0C3H      ;JP
                                                ;インタースロットコール
00048F 448F 21CFF0          10      LD  HL,RDSLT
000492 4492 320C00          13      LD  (_RDSLT),A
000495 4495 220D00          16      LD  (_RDSLT+1),HL
                                
000498 4498 21EDF0          10      LD  HL,WRSLT
00049B 449B 321400          13      LD  (_WRSLT),A
00049E 449E 221500          16      LD  (_WRSLT+1),HL
                                
0004A1 44A1 2181F0          10      LD  HL,CALSLT
0004A4 44A4 321C00          13      LD  (_CALSLT),A
0004A7 44A7 221D00          16      LD  (_CALSLT+1),HL
                                
0004AA 44AA 21D9EF          10      LD  HL,ENASLT
0004AD 44AD 322400          13      LD  (_ENASLT),A
0004B0 44B0 222500          16      LD  (_ENASLT+1),HL
                                
0004B3 44B3 2171F0          10      LD  HL,CALLF
0004B6 44B6 323000          13      LD  (_CALLF),A
0004B9 44B9 223100          16      LD  (_CALLF+1),HL
                                                ;割り込み
0004BC 44BC 2109F1          10      LD  HL,INT38H
0004BF 44BF 323800          13      LD  (00038H),A
0004C2 44C2 223900          16      LD  (00038H+1),HL
                                                ;インタースロットコールの補助
0004C5 44C5 217F5C          10      LD  HL,AT_3B
0004C8 44C8 113B00          10      LD  DE,ENASUB
0004CB 44CB 011000          10      LD  BC,AT_3B_E-AT_3B
0004CE 44CE EDB0                    LDIR
                                
0004D0 44D0 2A0D00          16      LD  HL,(_RDSLT+1)
0004D3 44D3 11CFF0          10      LD  DE,RDSLT
0004D6 44D6 AF               4      XOR A
0004D7 44D7 ED52            15      SBC HL,DE
0004D9 44D9 1168F3          10      LD  DE,ROMUSE
0004DC 44DC 2123F3          10      LD  HL,DISKVE
0004DF 44DF 37               4      SCF
0004E0 44E0 CC1EC0          17      CALL    Z,FD_BOOT_EXEC
                                #endif
       44E3                     BOOT1:
0004E3 44E3 C37655          10      JP  BASENT
                                
       44E6                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
0004E6 44E6 21C040          10      LD  HL,MSG_ERROR_ROM_MODE
0004E9 44E9 CD9245          17      CALL    MSX
0004EC 44EC DD219F00        14      LD  IX,CHGET
0004F0 44F0 C37345          10      JP  CALSLT_R
                                
       44F3                     CHK_RAM:
0004F3 44F3 E5              11      PUSH    HL
0004F4 44F4 CD4A45          17      CALL    CHK_RAM0
0004F7 44F7 E1              10      POP HL
0004F8 44F8 C8              11      RET Z
0004F9 44F9 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
0004FC 44FC E680             7      AND 080H
0004FE 44FE CD1F45          17      CALL    CHK_RAM_SLT
000501 4501 C8              11      RET Z
000502 4502 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000505 4505 E680             7      AND 080H
000507 4507 C601             7      ADD A,1
000509 4509 CD1F45          17      CALL    CHK_RAM_SLT
00050C 450C C8              11      RET Z
00050D 450D 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000510 4510 E680             7      AND 080H
000512 4512 C602             7      ADD A,2
000514 4514 CD1F45          17      CALL    CHK_RAM_SLT
000517 4517 C8              11      RET Z
000518 4518 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
00051B 451B E680             7      AND 080H
00051D 451D C603             7      ADD A,3
       451F                     CHK_RAM_SLT:
00051F 451F E5              11      PUSH    HL
000520 4520 CD4A45          17      CALL    CHK_RAM0        ;スロット#X or X-0
000523 4523 E1              10      POP HL
000524 4524 C8              11      RET Z
000525 4525 CB79             8      BIT 7,C
000527 4527 281C            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000529 4529 79               4      LD  A,C
00052A 452A F604             7      OR  4           ;スロット#X-1
00052C 452C E5              11      PUSH    HL
00052D 452D CD4A45          17      CALL    CHK_RAM0
000530 4530 E1              10      POP HL
000531 4531 C8              11      RET Z
000532 4532 79               4      LD  A,C
000533 4533 F60C             7      OR  00CH            ;スロット#X-3
000535 4535 E5              11      PUSH    HL
000536 4536 CD4A45          17      CALL    CHK_RAM0
000539 4539 E1              10      POP HL
00053A 453A C8              11      RET Z
00053B 453B 79               4      LD  A,C
00053C 453C E6F3             7      AND 0F3H            ;スロット#X-2
00053E 453E F608             7      OR  8
000540 4540 E5              11      PUSH    HL
000541 4541 CD4A45          17      CALL    CHK_RAM0
000544 4544 E1              10      POP HL
       4545                     CHK_RAM_E:
000545 4545 AF               4      XOR A
000546 4546 3C               4      INC A           ;ZF=0にする
000547 4547 3E00             7      LD  A,0
000549 4549 C9              10      RET
                                
       454A                     CHK_RAM0:
00054A 454A 4F               4      LD  C,A
00054B 454B 2E00             7      LD  L,0
       454D                     CHK_RAM1:
00054D 454D 79               4      LD  A,C
00054E 454E CDC245          17      CALL    RDSLTX
000551 4551 C6E5             7      ADD A,0E5H
000553 4553 47               4      LD  B,A
000554 4554 5F               4      LD  E,A
000555 4555 79               4      LD  A,C
000556 4556 C5              11      PUSH    BC
000557 4557 CD1400          17      CALL    _WRSLT
00055A 455A C1              10      POP BC
00055B 455B 79               4      LD  A,C
00055C 455C CDC245          17      CALL    RDSLTX
00055F 455F B8               4      CP  B
000560 4560 C0              11      RET NZ
000561 4561 D6E5             7      SUB 0E5H
000563 4563 79               4      LD  A,C
000564 4564 5F               4      LD  E,A
000565 4565 C5              11      PUSH    BC
000566 4566 CD1400          17      CALL    _WRSLT
000569 4569 C1              10      POP BC
00056A 456A 24               4      INC H
00056B 456B 7D               4      LD  A,L
00056C 456C C604             7      ADD A,4
00056E 456E 6F               4      LD  L,A
00056F 456F 20DC            12      JR  NZ,CHK_RAM1
000571 4571 79               4      LD  A,C     ;ZF=1のハズ
000572 4572 C9              10      RET
                                
       4573                     CALSLT_R:
000573 4573 C5              11      PUSH    BC
000574 4574 E5              11      PUSH    HL
000575 4575 F5              11      PUSH    AF
000576 4576 3A0000          13      LD  A,(0000H)
000579 4579 FEF3             7      CP  0F3H        ;0000H が DI の場合はページ0を BIOS ROM とみなす
00057B 457B 280B            12      JR  Z,CALSLT_R2
00057D 457D F1              10      POP AF
00057E 457E FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000582 4582 CD1C00          17      CALL    _CALSLT
000585 4585 E1              10      POP HL
000586 4586 C1              10      POP BC
000587 4587 C9              10      RET
       4588                     CALSLT_R2:
000588 4588 F1              10      POP AF
000589 4589 CD98F3          17      CALL    JP_IX
00058C 458C E1              10      POP HL
00058D 458D C1              10      POP BC
00058E 458E C9              10      RET
                                
       458F                     MSX1:
00058F 458F CD9056          17      CALL    MSGA1
       4592                     MSX:
000592 4592 7E               7      LD  A,(HL)
000593 4593 23               6      INC HL
000594 4594 B7               4      OR  A
000595 4595 20F8            12      JR  NZ,MSX1
000597 4597 C9              10      RET
                                
       4598                     PRTHX:
000598 4598 F5              11      PUSH    AF
000599 4599 07               4      RLCA
00059A 459A 07               4      RLCA
00059B 459B 07               4      RLCA
00059C 459C 07               4      RLCA
00059D 459D CDA145          17      CALL    PRTA2
0005A0 45A0 F1              10      POP AF
       45A1                     PRTA2:
0005A1 45A1 CDA745          17      CALL    ASC
0005A4 45A4 C38C56          10      JP  MSG_A
                                
       45A7                     ASC:
0005A7 45A7 E60F             7      AND 0FH
0005A9 45A9 C630             7      ADD A,'0'
0005AB 45AB FE3A             7      CP  '9'+1
0005AD 45AD D8              11      RET C
0005AE 45AE C607             7      ADD A,7
0005B0 45B0 C9              10      RET
                                
       45B1                     MSN:
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
0005B1 45B1 7E               7      LD  A,(HL)
                                #endif
0005B2 45B2 23               6      INC HL
0005B3 45B3 CD8C56          17      CALL    MSG_A
0005B6 45B6 10F9            13      DJNZ    MSN
0005B8 45B8 C9              10      RET
                                
       45B9                     RDSLT_ROM3:
0005B9 45B9 7E               7      LD  A,(HL)
0005BA 45BA C9              10      RET
       45BB                     RDSLT_ROM:
0005BB 45BB CB7C             8      BIT 7,H
0005BD 45BD 28FA            12      JR  Z,RDSLT_ROM3
       45BF                     RDSLT_ROM2:
0005BF 45BF 3A97F2          13      LD  A,(ROM_SLT)
       45C2                     RDSLTX:
0005C2 45C2 C5              11      PUSH    BC
0005C3 45C3 D5              11      PUSH    DE
0005C4 45C4 CD0C00          17      CALL    _RDSLT
0005C7 45C7 D1              10      POP DE
0005C8 45C8 C1              10      POP BC
0005C9 45C9 C9              10      RET
                                
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
                                ;
                                ;   ディスクからメモリへの転送
                                ;
       45CA                     ROM_LDIR:
0005CA 45CA 3AD6F2          13      LD  A,(FLG_LDIR)
0005CD 45CD B7               4      OR  A
0005CE 45CE 2008            12      JR  NZ,ROM_LDIRVM
0005D0 45D0 CB7A             8      BIT 7,D
0005D2 45D2 CAEA45          10      JP  Z,ROM_LDIRSLT
                                ;
                                ;   ページ2/ページ3
                                ;
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ1
                                    LD  SP,SPBUF
                                SPJ1:
                                LDIR_PAGE2_1:
                                    LD  A,B
                                    OR  C
                                    JR  Z,LDIRE
                                
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                LDIR_PAGE2_2:
                                    BIT 6,D
                                    JR  NZ,LDIR_PAGE2_4
                                
                                    PUSH    BC
                                    PUSH    DE
                                    LD  DE,BUF
                                
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIR_PAGE2_3
                                    LD  BC,00100H       ;B != 0 の場合は256バイトずつ転送
                                LDIR_PAGE2_3:
                                    PUSH    BC
                                    LDIR
                                    LD  (_HL),HL
                                
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                
                                    POP BC
                                    POP DE
                                    LD  HL,BUF
                                    LDIR
                                
                                    LD  HL,(_HL)
                                    POP BC
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIRE
                                    DEC B
                                    JR  LDIR_PAGE2_1
                                LDIR_PAGE2_4:               ;ページ3
                                #endif
0005D5 45D5 EDB0                    LDIR
                                
                                #if exists USE_NORMAL32K_OR_ASCII16
                                LDIRE2:
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                LDIRE:
                                    LD  SP,(_SP)
                                #else
       45D7                     LDIRE2:
                                #endif
0005D7 45D7 C9              10      RET
                                ;
                                ;   ディスクからV-RAMへの転送
                                ;
       45D8                     ROM_LDIRVM:
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ2
                                    LD  SP,SPBUF
                                SPJ2:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
0005D8 45D8 C5              11      PUSH    BC
0005D9 45D9 D5              11      PUSH    DE
0005DA 45DA FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0005DE 45DE DD215C00        14      LD  IX,LDIRVM
0005E2 45E2 CD1C00          17      CALL    _CALSLT
0005E5 45E5 E1              10      POP HL
0005E6 45E6 C1              10      POP BC
0005E7 45E7 09              11      ADD HL,BC
0005E8 45E8 EB               4      EX  DE,HL
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    JR  LDIRE2
                                #else
0005E9 45E9 C9              10      RET
                                #endif
                                ;
                                ;   ページ0/ページ1
                                ;
       45EA                     ROM_LDIRSLT:
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ3
                                    LD  SP,SPBUF
                                SPJ3:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
                                                ;ページ0
0005EA 45EA 3A0000          13      LD  A,(0000H)
0005ED 45ED FEF3             7      CP  0F3H        ;0000H が DI じゃない場合はページ0は RAM とみなす
0005EF 45EF 280A            12      JR  Z,LDIR_PAGE0_SLT
       45F1                     LDIR_PAGE0_1:
0005F1 45F1 CB72             8      BIT 6,D
0005F3 45F3 2022            12      JR  NZ,LDIR_PAGE1
0005F5 45F5 EDA0            16      LDI         ;ページ0 直接転送
0005F7 45F7 EAF145          10      JP  PE,LDIR_PAGE0_1
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    JP  LDIRE2
                                #else
0005FA 45FA C9              10      RET
                                #endif
                                
       45FB                     LDIR_PAGE0_SLT:     ;ページ0 WRSLTを使用
0005FB 45FB EB               4      EX  DE,HL       ;転送方向(DE)→(HL)
       45FC                     LDIR_PAGE0_SLT1:
0005FC 45FC CB74             8      BIT 6,H
0005FE 45FE 2016            12      JR  NZ,LDIR_PAGE1_DEHL
000600 4600 1A               7      LD  A,(DE)
000601 4601 13               6      INC DE
000602 4602 D5              11      PUSH    DE
000603 4603 5F               4      LD  E,A
000604 4604 E5              11      PUSH    HL
000605 4605 C5              11      PUSH    BC
000606 4606 3A41F3          13      LD  A,(RAMAD0)
000609 4609 CD1400          17      CALL    _WRSLT
00060C 460C C1              10      POP BC
00060D 460D E1              10      POP HL
00060E 460E D1              10      POP DE
00060F 460F EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
000611 4611 EAFC45          10      JP  PE,LDIR_PAGE0_SLT1
000614 4614 EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    JP  LDIRE2
                                #else
000615 4615 C9              10      RET
                                #endif
                                
                                #if exists _RAM64K
       4616                     LDIR_PAGE1_DEHL:
000616 4616 EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
       4617                     LDIR_PAGE1:         ;ページ1
000617 4617 78               4      LD  A,B
000618 4618 B1               4      OR  C
000619 4619 CAD745          10      JP  Z,LDIRE2
                                
00061C 461C 7A               4      LD  A,D
00061D 461D FE7F             7      CP  07FH        ;ページ2と被る可能性？($7FXX)
00061F 461F 380F            12      JR  C,LDIR_PAGE1_2
000621 4621 87               4      ADD A,A
000622 4622 DA7046          10      JP  C,LDIR_PAGE2_1  ;ページ2へ
000625 4625 78               4      LD  A,B
000626 4626 B7               4      OR  A
000627 4627 7B               4      LD  A,E
000628 4628 2803            12      JR  Z,LDIR_PAGE1_1
00062A 462A B7               4      OR  A           ;B != 0 の場合は256バイト転送
00062B 462B 2027            12      JR  NZ,LDIR_PAGE1_SLT_HLDE  ;被る
       462D                     LDIR_PAGE1_1:
00062D 462D 81               4      ADD A,C
00062E 462E 3824            12      JR  C,LDIR_PAGE1_SLT_HLDE   ;被る
       4630                     LDIR_PAGE1_2:
000630 4630 C5              11      PUSH    BC
000631 4631 D5              11      PUSH    DE
000632 4632 115EF5          10      LD  DE,BUF
                                
000635 4635 78               4      LD  A,B
000636 4636 B7               4      OR  A
000637 4637 2803            12      JR  Z,LDIR_PAGE1_3
000639 4639 010001          10      LD  BC,00100H       ;B != 0 の場合は256バイトずつ転送
       463C                     LDIR_PAGE1_3:
00063C 463C C5              11      PUSH    BC
00063D 463D EDB0                    LDIR
00063F 463F 22FCF2          16      LD  (_HL),HL
                                
000642 4642 3A42F3          13      LD  A,(RAMAD1)
000645 4645 C329F1          10      JP  LDIR_PAGE1_RAM      ;ページ1をRAMにする処理はページ3にある
       4648                     LDIR_PAGE1_ROM:
000648 4648 2AFCF2          16      LD  HL,(_HL)
00064B 464B C1              10      POP BC
00064C 464C 78               4      LD  A,B
00064D 464D B7               4      OR  A
00064E 464E CAD745          10      JP  Z,LDIRE2
000651 4651 05               4      DEC B
000652 4652 18C3            12      JR  LDIR_PAGE1
                                
       4654                     LDIR_PAGE1_SLT_HLDE:
000654 4654 EB               4      EX  DE,HL       ;転送方向(DE)→(HL)
                                #else
                                LDIR_PAGE1:         ;ページ1 WRSLTを使用
                                LDIR_PAGE1_HLDE:
                                    EX  DE,HL       ;転送方向(DE)→(HL)
                                LDIR_PAGE1_DEHL:
                                #endif
       4655                     LDIR_PAGE1_SLT1:
000655 4655 CB7C             8      BIT 7,H
000657 4657 2016            12      JR  NZ,LDIR_PAGE2_HLDE
000659 4659 1A               7      LD  A,(DE)
00065A 465A 13               6      INC DE
00065B 465B D5              11      PUSH    DE
00065C 465C 5F               4      LD  E,A
00065D 465D E5              11      PUSH    HL
00065E 465E C5              11      PUSH    BC
00065F 465F 3A42F3          13      LD  A,(RAMAD1)
000662 4662 CD1400          17      CALL    _WRSLT
000665 4665 C1              10      POP BC
000666 4666 E1              10      POP HL
000667 4667 D1              10      POP DE
000668 4668 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00066A 466A EA5546          10      JP  PE,LDIR_PAGE1_SLT1
00066D 466D EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    JP  LDIRE2
                                LDIR_PAGE2_HLDE:            ;ページ2
                                    EX  DE,HL       ;転送方向(HL)→(DE)
                                    JP  LDIR_PAGE2_1
                                #else
00066E 466E C9              10      RET
       466F                     LDIR_PAGE2_HLDE:            ;ページ2
00066F 466F EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
       4670                     LDIR_PAGE2_1:
000670 4670 EDB0                    LDIR
000672 4672 C9              10      RET
                                #endif
                                ;
                                ;   BASIC関連
                                ;
       4673                     END_OF_LINE:
000673 4673 215EF5          10      LD  HL,BUF
       4676                     EOL1:
000676 4676 7E               7      LD  A,(HL)
000677 4677 C8              11      RET Z
000678 4678 FE0D             7      CP  00DH
00067A 467A 2807            12      JR  Z,EOLE
00067C 467C FE0A             7      CP  00AH
00067E 467E 2803            12      JR  Z,EOLE
000680 4680 23               6      INC HL
000681 4681 18F3            12      JR  EOL1
       4683                     EOLE:
000683 4683 3600            10      LD  (HL),0
000685 4685 23               6      INC HL
000686 4686 7E               7      LD  A,(HL)
000687 4687 FE0A             7      CP  00AH
000689 4689 C0              11      RET NZ
00068A 468A 23               6      INC HL
00068B 468B C9              10      RET
                                ;
                                ;   アスキー形式のファイルを読み込む
                                ;
       468C                     ROM_LOAD_ASCII:
00068C 468C 210000          10      LD  HL,0
00068F 468F 22DAF2          16      LD  (_BUF_ST),HL    ;読み出し位置
000692 4692 2A76F6          16      LD  HL,(TXTTAB)
000695 4695 22DCF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
000698 4698 215EF5          10      LD  HL,BUF
00069B 469B 22D4F2          16      LD  (_DTA),HL
       469E                     RLOAD_A1:
00069E 469E 2ADAF2          16      LD  HL,(_BUF_ST)
0006A1 46A1 22CAF2          16      LD  (RR_LOW),HL
0006A4 46A4 210201          10      LD  HL,258
0006A7 46A7 CDB84B          17      CALL    ROM_READ
0006AA 46AA 7C               4      LD  A,H
0006AB 46AB B5               4      OR  L
0006AC 46AC 2879            12      JR  Z,RLOAD_AEND
0006AE 46AE 015EF5          10      LD  BC,BUF
0006B1 46B1 09              11      ADD HL,BC
0006B2 46B2 3600            10      LD  (HL),0
0006B4 46B4 CD7346          17      CALL    END_OF_LINE
0006B7 46B7 015EF5          10      LD  BC,BUF
0006BA 46BA A7               4      AND A
0006BB 46BB ED42            15      SBC HL,BC
0006BD 46BD 2810            12      JR  Z,RLOAD_A2
0006BF 46BF 4D               4      LD  C,L
0006C0 46C0 44               4      LD  B,H
0006C1 46C1 ED5BDAF2        20      LD  DE,(_BUF_ST)
0006C5 46C5 19              11      ADD HL,DE
0006C6 46C6 22DAF2          16      LD  (_BUF_ST),HL
0006C9 46C9 3A5EF5          13      LD  A,(BUF)
0006CC 46CC B7               4      OR  A
0006CD 46CD 28CF            12      JR  Z,RLOAD_A1
       46CF                     RLOAD_A2:
0006CF 46CF 115EF5          10      LD  DE,BUF
0006D2 46D2 CD844D          17      CALL    SPCUTEX
0006D5 46D5 1A               7      LD  A,(DE)
0006D6 46D6 B7               4      OR  A
0006D7 46D7 284E            12      JR  Z,RLOAD_AEND
0006D9 46D9 CD964D          17      CALL    GETNUM
0006DC 46DC 7C               4      LD  A,H
0006DD 46DD B5               4      OR  L
0006DE 46DE CAFE47          10      JP  Z,ERROR_DIRECT_IN_FILE
0006E1 46E1 DD2ADCF2        20      LD  IX,(_BUF_EN)
0006E5 46E5 DD7502          19      LD  (IX+2),L
0006E8 46E8 DD7403          19      LD  (IX+3),H
                                
0006EB 46EB CD7D4D          17      CALL    SPCUT
0006EE 46EE EB               4      EX  DE,HL
0006EF 46EF DDE5            15      PUSH    IX
0006F1 46F1 DD21B242        14      LD  IX,CRUNCH
0006F5 46F5 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0006F9 46F9 CD1C00          17      CALL    _CALSLT
0006FC 46FC DDE1            14      POP IX
0006FE 46FE EB               4      EX  DE,HL
0006FF 46FF 111FF4          10      LD  DE,KBUF
000702 4702 37               4      SCF
000703 4703 ED52            15      SBC HL,DE
000705 4705 CAFE47          10      JP  Z,ERROR_DIRECT_IN_FILE
000708 4708 DAFE47          10      JP  C,ERROR_DIRECT_IN_FILE
00070B 470B 4D               4      LD  C,L
00070C 470C 44               4      LD  B,H
00070D 470D 2ADCF2          16      LD  HL,(_BUF_EN)
000710 4710 110400          10      LD  DE,4
000713 4713 19              11      ADD HL,DE
000714 4714 111FF4          10      LD  DE,KBUF
                                
000717 4717 EB               4      EX  DE,HL
000718 4718 EDB0                    LDIR
00071A 471A EB               4      EX  DE,HL
                                
00071B 471B DD7500          19      LD  (IX+0),L
00071E 471E DD7401          19      LD  (IX+1),H
000721 4721 22DCF2          16      LD  (_BUF_EN),HL
000724 4724 C39E46          10      JP  RLOAD_A1
                                
       4727                     RLOAD_AEND:
000727 4727 2ADCF2          16      LD  HL,(_BUF_EN)
00072A 472A AF               4      XOR A
00072B 472B 77               7      LD  (HL),A
00072C 472C 23               6      INC HL
00072D 472D 77               7      LD  (HL),A
00072E 472E 23               6      INC HL
00072F 472F 22DCF2          16      LD  (_BUF_EN),HL
000732 4732 C3C147          10      JP  RLOAD_END1
                                
       4735                     ROM_LOAD:
000735 4735 CD6349          17      CALL    INIT_PARAM
000738 4738 7E               7      LD  A,(HL)
000739 4739 FE2C             7      CP  ','
00073B 473B 2003            12      JR  NZ,ROM_LOAD0
00073D 473D 23               6      INC HL
00073E 473E 7E               7      LD  A,(HL)
00073F 473F 2B               6      DEC HL
       4740                     ROM_LOAD0:
000740 4740 32BEFC          13      LD  (RUNBNF),A
000743 4743 CD594C          17      CALL    FILE_B
000746 4746 3A01F3          13      LD  A,(FNAME)
000749 4749 FE20             7      CP  020H
00074B 474B CA544C          10      JP  Z,ROM_ORG
                                
00074E 474E CDED4D          17      CALL    ROM_OPEN
000751 4751 DA0A48          10      JP  C,ERROR_FILE_NOT_FOUND
       4754                     ROM_LOAD1:
000754 4754 21D9F2          10      LD  HL,_BUF
000757 4757 22D4F2          16      LD  (_DTA),HL
00075A 475A 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
00075D 475D CDB84B          17      CALL    ROM_READ
000760 4760 3AD9F2          13      LD  A,(_BUF)
000763 4763 3C               4      INC A
000764 4764 C28C46          10      JP  NZ,ROM_LOAD_ASCII
000767 4767 2A76F6          16      LD  HL,(TXTTAB)
00076A 476A 22D4F2          16      LD  (_DTA),HL
00076D 476D EB               4      EX  DE,HL
00076E 476E 2100FF          10      LD  HL,-256
000771 4771 39              11      ADD HL,SP
000772 4772 ED52            15      SBC HL,DE
000774 4774 CDB84B          17      CALL    ROM_READ
000777 4777 ED5BD4F2        20      LD  DE,(_DTA)
00077B 477B 19              11      ADD HL,DE
00077C 477C E5              11      PUSH    HL
00077D 477D 2A76F6          16      LD  HL,(TXTTAB)
       4780                     ROM_LOAD2:          ;リンクポインタをFIX
000780 4780 E5              11      PUSH    HL
000781 4781 DDE1            14      POP IX
000783 4783 7E               7      LD  A,(HL)      ;リンクポインタL
000784 4784 23               6      INC HL
000785 4785 B6               7      OR  (HL)        ;リンクポインタH
000786 4786 23               6      INC HL
000787 4787 2837            12      JR  Z,RLOAD_END0
000789 4789 23               6      INC HL      ;行番号
00078A 478A 23               6      INC HL      ;行番号
       478B                     ROM_LOAD3:
00078B 478B 7E               7      LD  A,(HL)
00078C 478C 23               6      INC HL
00078D 478D FE0B             7      CP  00BH        ;8進数(&O)
00078F 478F 2822            12      JR  Z,INC_HL2
000791 4791 FE0C             7      CP  00CH        ;16進数(&H)
000793 4793 281E            12      JR  Z,INC_HL2
000795 4795 FE0D             7      CP  00DH        ;行番号(RUN後)
000797 4797 281A            12      JR  Z,INC_HL2
000799 4799 FE0E             7      CP  00EH        ;行番号(RUN前)
00079B 479B 2816            12      JR  Z,INC_HL2
00079D 479D FE0F             7      CP  00FH        ;10～255の整数(%)
00079F 479F 2813            12      JR  Z,INC_HL1
0007A1 47A1 FE1C             7      CP  01CH        ;256～65535の整数(%)
0007A3 47A3 280E            12      JR  Z,INC_HL2
0007A5 47A5 FE1D             7      CP  01DH        ;単精度実数(!)
0007A7 47A7 2808            12      JR  Z,INC_HL4
0007A9 47A9 FE1F             7      CP  01FH        ;倍制度実数(#)
0007AB 47AB 2008            12      JR  NZ,INC_HL0
0007AD 47AD 23               6      INC HL
0007AE 47AE 23               6      INC HL
0007AF 47AF 23               6      INC HL
0007B0 47B0 23               6      INC HL
       47B1                     INC_HL4:
0007B1 47B1 23               6      INC HL
0007B2 47B2 23               6      INC HL
       47B3                     INC_HL2:
0007B3 47B3 23               6      INC HL
       47B4                     INC_HL1:
0007B4 47B4 23               6      INC HL
       47B5                     INC_HL0:
0007B5 47B5 B7               4      OR  A
0007B6 47B6 20D3            12      JR  NZ,ROM_LOAD3
0007B8 47B8 DD7500          19      LD  (IX+0),L
0007BB 47BB DD7401          19      LD  (IX+1),H
0007BE 47BE 18C0            12      JR  ROM_LOAD2
       47C0                     RLOAD_END0:
0007C0 47C0 E1              10      POP HL
       47C1                     RLOAD_END1:
0007C1 47C1 22C2F6          16      LD  (VARTAB),HL
0007C4 47C4 22C4F6          16      LD  (ARYTAB),HL
0007C7 47C7 22C6F6          16      LD  (STREND),HL
                                
0007CA 47CA 3ABEFC          13      LD  A,(RUNBNF)
0007CD 47CD CDD74D          17      CALL    CAP
0007D0 47D0 FE52             7      CP  'R'
0007D2 47D2 280E            12      JR  Z,RLOAD_END2
0007D4 47D4 AF               4      XOR A
0007D5 47D5 21DCF2          10      LD  HL,_BUF+3
0007D8 47D8 77               7      LD  (HL),A      ;3
0007D9 47D9 2B               6      DEC HL
0007DA 47DA 77               7      LD  (HL),A      ;2
0007DB 47DB 2B               6      DEC HL
0007DC 47DC 77               7      LD  (HL),A      ;1
0007DD 47DD 2B               6      DEC HL
0007DE 47DE 3E8F             7      LD  A,08FH      ;REM
0007E0 47E0 77               7      LD  (HL),A      ;0
0007E1 47E1 C9              10      RET
       47E2                     RLOAD_END2:
0007E2 47E2 D5              11      PUSH    DE
0007E3 47E3 ED5B76F6        20      LD  DE,(TXTTAB)
0007E7 47E7 1B               6      DEC DE
0007E8 47E8 AF               4      XOR A
0007E9 47E9 21DFF2          10      LD  HL,_BUF+6
0007EC 47EC 77               7      LD  (HL),A      ;6
0007ED 47ED 2B               6      DEC HL
0007EE 47EE 77               7      LD  (HL),A      ;5
0007EF 47EF 2B               6      DEC HL
0007F0 47F0 77               7      LD  (HL),A      ;4
0007F1 47F1 2B               6      DEC HL
0007F2 47F2 72               7      LD  (HL),D      ;3 行番号H
0007F3 47F3 2B               6      DEC HL
0007F4 47F4 73               7      LD  (HL),E      ;2 行番号L
0007F5 47F5 2B               6      DEC HL
0007F6 47F6 360D            10      LD  (HL),00DH   ;1 行番号(RUN後)
0007F8 47F8 2B               6      DEC HL
0007F9 47F9 3E89             7      LD  A,089H      ;GOTO
0007FB 47FB 77               7      LD  (HL),A      ;0
0007FC 47FC D1              10      POP DE
0007FD 47FD C9              10      RET
                                
       47FE                     ERROR_DIRECT_IN_FILE:
0007FE 47FE 1E39             7      LD  E,57            ;Direct statement in file
000800 4800 01                      DB  1           ;LD BC,
       4801                     ERROR_DEVICE_IO_ERROR:
000801 4801 1E13             7      LD  E,19            ;Device I/O error
000803 4803 01                      DB  1           ;LD BC,
       4804                     ERROR_INTERNAL_ERROR:
000804 4804 1E33             7      LD  E,51            ;Internal error
000806 4806 01                      DB  1           ;LD BC,
       4807                     ERROR_FILE_NOT_OPEN:
000807 4807 1E3B             7      LD  E,59            ;File not OPEN
000809 4809 01                      DB  1           ;LD BC,
       480A                     ERROR_FILE_NOT_FOUND:
00080A 480A 1E35             7      LD  E,53            ;File not found
       480C                     ERROR:
00080C 480C FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000810 4810 DD216F40        14      LD  IX,ERRHAND
000814 4814 C31C00          10      JP  _CALSLT
                                
       4817                     ROM_BLOAD:
000817 4817 CD6349          17      CALL    INIT_PARAM
00081A 481A CD594C          17      CALL    FILE_B
00081D 481D CDED4D          17      CALL    ROM_OPEN
000820 4820 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000822 4822 21D9F2          10      LD  HL,_BUF
000825 4825 22D4F2          16      LD  (_DTA),HL
000828 4828 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
00082B 482B CDB84B          17      CALL    ROM_READ
00082E 482E 3AD9F2          13      LD  A,(_BUF)
000831 4831 FEFE             7      CP  0FEH
000833 4833 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
000835 4835 21A5F2          10      LD  HL,BLOAD_RET
000838 4838 229DF2          16      LD  (SWC_BLOAD),HL
                                
00083B 483B 2AF7F2          16      LD  HL,(PARAM1)
00083E 483E 7E               7      LD  A,(HL)
00083F 483F FE2C             7      CP  ','
000841 4841 204C            12      JR  NZ,RBREAD_MEM
000843 4843 23               6      INC HL
000844 4844 7E               7      LD  A,(HL)
000845 4845 CDD74D          17      CALL    CAP
000848 4848 32BEFC          13      LD  (RUNBNF),A
00084B 484B FE52             7      CP  'R'     ;R,Sスイッチじゃ無い場合はオフセット値として処理する
00084D 484D 2808            12      JR  Z,RBOS1
00084F 484F FE53             7      CP  'S'
000851 4851 2804            12      JR  Z,RBOS1
000853 4853 FE2C             7      CP  ','
000855 4855 200D            12      JR  NZ,RBOS2
       4857                     RBOS1:
000857 4857 7E               7      LD  A,(HL)
000858 4858 23               6      INC HL
000859 4859 B7               4      OR  A
00085A 485A 2824            12      JR  Z,RBREAD_OSE
00085C 485C FE3A             7      CP  ':'
00085E 485E 2820            12      JR  Z,RBREAD_OSE
000860 4860 FE2C             7      CP  ','     ;次のパラメータを探す
000862 4862 20F3            12      JR  NZ,RBOS1
       4864                     RBOS2:              ;オフセット
000864 4864 22F7F2          16      LD  (PARAM1),HL
000867 4867 7E               7      LD  A,(HL)
000868 4868 B7               4      OR  A
000869 4869 2815            12      JR  Z,RBREAD_OSE
00086B 486B DD212F54        14      LD  IX,FRMQNT
00086F 486F FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000873 4873 CD1C00          17      CALL    _CALSLT
000876 4876 22F7F2          16      LD  (PARAM1),HL
000879 4879 2ADAF2          16      LD  HL,(_BUF_ST)
00087C 487C 19              11      ADD HL,DE
00087D 487D 22DAF2          16      LD  (_BUF_ST),HL
       4880                     RBREAD_OSE:
000880 4880 3ABEFC          13      LD  A,(RUNBNF)
000883 4883 FE53             7      CP  'S'
000885 4885 2008            12      JR  NZ,RBREAD_MEM
000887 4887 CD464B          17      CALL    WAIT_VDP
00088A 488A 3E01             7      LD  A,1
00088C 488C 32D6F2          13      LD  (FLG_LDIR),A
       488F                     RBREAD_MEM:
00088F 488F 2ADAF2          16      LD  HL,(_BUF_ST)
000892 4892 22BFFC          16      LD  (SAVENT),HL
000895 4895 22D4F2          16      LD  (_DTA),HL
000898 4898 21FFFF          10      LD  HL,0FFFFH
00089B 489B CDB84B          17      CALL    ROM_READ
00089E 489E AF               4      XOR A
00089F 489F 32D6F2          13      LD  (FLG_LDIR),A
0008A2 48A2 3ABEFC          13      LD  A,(RUNBNF)
0008A5 48A5 FE52             7      CP  'R'
0008A7 48A7 2006            12      JR  NZ,RBREAD1
0008A9 48A9 2ADEF2          16      LD  HL,(_BUF_EX)
0008AC 48AC 229DF2          16      LD  (SWC_BLOAD),HL
       48AF                     RBREAD1:
       48AF                     ROM_NEXT:
0008AF 48AF 2AF7F2          16      LD  HL,(PARAM1)
0008B2 48B2 7E               7      LD  A,(HL)
0008B3 48B3 2B               6      DEC HL
0008B4 48B4 B7               4      OR  A
0008B5 48B5 2805            12      JR  Z,ROM_NEXT1
0008B7 48B7 FE3A             7      CP  ':'
0008B9 48B9 2801            12      JR  Z,ROM_NEXT1
0008BB 48BB 23               6      INC HL
       48BC                     ROM_NEXT1:
0008BC 48BC 5D               4      LD  E,L
0008BD 48BD 54               4      LD  D,H
                                
0008BE 48BE CDAD4D          17      CALL    SEARCH_END
0008C1 48C1 B7               4      OR  A
0008C2 48C2 2821            12      JR  Z,REM
       48C4                     RN3:                    ;マルチステートメントの処理
0008C4 48C4 7E               7      LD  A,(HL)
                                
0008C5 48C5 FEB5             7      CP  0B5H            ;LOAD
0008C7 48C7 CA3547          10      JP  Z,ROM_LOAD
0008CA 48CA FE8A             7      CP  08AH            ;RUN
0008CC 48CC 281B            12      JR  Z,ROM_RUN
0008CE 48CE FEB7             7      CP  0B7H            ;FILES
0008D0 48D0 2825            12      JR  Z,ROM_FILES
0008D2 48D2 FED6             7      CP  0D6H            ;COPY
0008D4 48D4 CA9849          10      JP  Z,ROM_COPY
0008D7 48D7 FE20             7      CP  020H
0008D9 48D9 2807            12      JR  Z,RN_SP
                                
0008DB 48DB 3E28             7      LD  A,028H          ;JR Z,
0008DD 48DD 32A3F2          13      LD  (SWC_BLOAD_M),A
0008E0 48E0 7E               7      LD  A,(HL)
0008E1 48E1 C9              10      RET
       48E2                     RN_SP:
0008E2 48E2 23               6      INC HL
0008E3 48E3 18DF            12      JR  RN3
                                
       48E5                     REM:
0008E5 48E5 EB               4      EX  DE,HL
0008E6 48E6 3E8F             7      LD  A,08FH          ;REM
0008E8 48E8 C9              10      RET
                                
       48E9                     ROM_RUN:
0008E9 48E9 23               6      INC HL
0008EA 48EA 7E               7      LD  A,(HL)
0008EB 48EB 2B               6      DEC HL
0008EC 48EC B7               4      OR  A
0008ED 48ED C43547          17      CALL    NZ,ROM_LOAD
0008F0 48F0 FE8F             7      CP  08FH            ;REM
0008F2 48F2 3E8A             7      LD  A,08AH          ;RUN
0008F4 48F4 C0              11      RET NZ
0008F5 48F5 77               7      LD  (HL),A
0008F6 48F6 C9              10      RET
                                
       48F7                     ROM_FILES:
0008F7 48F7 CD6349          17      CALL    INIT_PARAM
0008FA 48FA CD594C          17      CALL    FILE_B
0008FD 48FD CD1856          17      CALL    GET_DISK_BANK_FDRV
000900 4900 3AC9F2          13      LD  A,(SECSZ_H)
000903 4903 CD7154          17      CALL    IS_BPB1
000906 4906 DA0148          10      JP  C,ERROR_DEVICE_IO_ERROR
000909 4909 3A01F3          13      LD  A,(FNAME)
00090C 490C FE21             7      CP  021H
00090E 490E 3005            12      JR  NC,RFILES0
000910 4910 060B             7      LD  B,11
000912 4912 CD3D4D          17      CALL    FILE10
       4915                     RFILES0:
000915 4915 CDB250          17      CALL    GET_DIR_DAT
       4918                     RFILES1:
000918 4918 CD614E          17      CALL    FILESE
00091B 491B 3041            12      JR  NC,RFILES_NOT_MATCH
       491D                     RFILES_DISP:
00091D 491D E5              11      PUSH    HL
00091E 491E 110B00          10      LD  DE,0000BH   ;属性
000921 4921 19              11      ADD HL,DE
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000922 4922 7E               7      LD  A,(HL)
                                #endif
000923 4923 E1              10      POP HL
000924 4924 CB4F             8      BIT 1,A     ;不可視属性
000926 4926 2033            12      JR  NZ,RFILES_NEXT
000928 4928 E5              11      PUSH    HL
000929 4929 0608             7      LD  B,8
00092B 492B CDB145          17      CALL    MSN
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
00092E 492E 7E               7      LD  A,(HL)
                                #endif
00092F 492F FE20             7      CP  020H
000931 4931 F5              11      PUSH    AF
000932 4932 3E2E             7      LD  A,'.'
000934 4934 C48C56          17      CALL    NZ,MSG_A
000937 4937 0603             7      LD  B,3
000939 4939 CDB145          17      CALL    MSN
00093C 493C F1              10      POP AF
00093D 493D CC8C56          17      CALL    Z,MSG_A
000940 4940 3ADDF3          13      LD  A,(CSRX)
000943 4943 47               4      LD  B,A
000944 4944 3AB0F3          13      LD  A,(LINLEN)
000947 4947 90               4      SUB B
000948 4948 FE0C             7      CP  12
00094A 494A 3009            12      JR  NC,RFILES2
00094C 494C 3E0D             7      LD  A,00DH      ;改行
00094E 494E CD8C56          17      CALL    MSG_A
000951 4951 3E0A             7      LD  A,00AH
000953 4953 1802            12      JR  RFILES3
       4955                     RFILES2:
000955 4955 3E20             7      LD  A,020H
       4957                     RFILES3:
000957 4957 CD8C56          17      CALL    MSG_A
00095A 495A E1              10      POP HL
       495B                     RFILES_NEXT:
00095B 495B CD7D4E          17      CALL    FNEXT
       495E                     RFILES_NOT_MATCH:
00095E 495E 20B8            12      JR  NZ,RFILES1
000960 4960 C3AF48          10      JP  ROM_NEXT
                                
       4963                     INIT_PARAM:
000963 4963 22F5F2          16      LD  (PARAM0),HL
000966 4966 22F7F2          16      LD  (PARAM1),HL
000969 4969 EB               4      EX  DE,HL
00096A 496A 32BEFC          13      LD  (RUNBNF),A
00096D 496D 3263F6          13      LD  (VALTYP),A
000970 4970 E5              11      PUSH    HL
000971 4971 3AEAF2          13      LD  A,(_DVSW)
000974 4974 CDFA55          17      CALL    GET_CD
000977 4977 22F9F2          16      LD  (_CDX),HL
00097A 497A E1              10      POP HL
00097B 497B 13               6      INC DE
00097C 497C CD7D4D          17      CALL    SPCUT
00097F 497F 1A               7      LD  A,(DE)
000980 4980 B7               4      OR  A
000981 4981 C8              11      RET Z
000982 4982 FE3A             7      CP  ':'
000984 4984 C8              11      RET Z
000985 4985 FE28             7      CP  '('
000987 4987 C8              11      RET Z
000988 4988 EB               4      EX  DE,HL
000989 4989 DD21644C        14      LD  IX,FRMEVL
00098D 498D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000991 4991 CD1C00          17      CALL    _CALSLT
000994 4994 22F7F2          16      LD  (PARAM1),HL
000997 4997 C9              10      RET
                                
       4998                     ROM_COPY:
000998 4998 CD6349          17      CALL    INIT_PARAM
00099B 499B 3A63F6          13      LD  A,(VALTYP)
00099E 499E FE03             7      CP  3       ;string
0009A0 49A0 C2544C          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
0009A3 49A3 CD594C          17      CALL    FILE_B
0009A6 49A6 CDED4D          17      CALL    ROM_OPEN
0009A9 49A9 DA0A48          10      JP  C,ERROR_FILE_NOT_FOUND
                                
0009AC 49AC 21DEF2          10      LD  HL,_BUF_W
0009AF 49AF 22D4F2          16      LD  (_DTA),HL
0009B2 49B2 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
0009B5 49B5 CDB84B          17      CALL    ROM_READ
                                
0009B8 49B8 AF               4      XOR A
0009B9 49B9 32D9F2          13      LD  (_BUF_LO),A     ;PSET
0009BC 49BC 32E6F2          13      LD  (_BUF_O),A      ;向き
                                
0009BF 49BF 2AF7F2          16      LD  HL,(PARAM1)
       49C2                     RCP_PARAM1:
0009C2 49C2 7E               7      LD  A,(HL)
0009C3 49C3 23               6      INC HL
0009C4 49C4 B7               4      OR  A
0009C5 49C5 CABC48          10      JP  Z,ROM_NEXT1
0009C8 49C8 FE3A             7      CP  ':'
0009CA 49CA CABC48          10      JP  Z,ROM_NEXT1
0009CD 49CD FE2C             7      CP  ','
0009CF 49CF 2012            12      JR  NZ,RCP_PARAM1_
                                
0009D1 49D1 DD212F54        14      LD  IX,FRMQNT
0009D5 49D5 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009D9 49D9 CD1C00          17      CALL    _CALSLT
0009DC 49DC 7B               4      LD  A,E
0009DD 49DD 87               4      ADD A,A
0009DE 49DE 87               4      ADD A,A
0009DF 49DF 32E6F2          13      LD  (_BUF_O),A
0009E2 49E2 7E               7      LD  A,(HL)
       49E3                     RCP_PARAM1_:
0009E3 49E3 FE28             7      CP  '('
0009E5 49E5 20DB            12      JR  NZ,RCP_PARAM1
0009E7 49E7 DD212F54        14      LD  IX,FRMQNT
0009EB 49EB FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009EF 49EF CD1C00          17      CALL    _CALSLT
                                
0009F2 49F2 ED53E2F2        20      LD  (_BUF_X),DE
                                
       49F6                     RCP_PARAM2:
0009F6 49F6 23               6      INC HL
0009F7 49F7 7E               7      LD  A,(HL)
0009F8 49F8 FE20             7      CP  020H
0009FA 49FA 28FA            12      JR  Z,RCP_PARAM2
0009FC 49FC FE2C             7      CP  ','
0009FE 49FE 28F6            12      JR  Z,RCP_PARAM2
                                
000A00 4A00 DD212F54        14      LD  IX,FRMQNT
000A04 4A04 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000A08 4A08 CD1C00          17      CALL    _CALSLT
                                
000A0B 4A0B 3AF6FA          13      LD  A,(ACPAGE)
000A0E 4A0E 57               4      LD  D,A
000A0F 4A0F ED53E4F2        20      LD  (_BUF_Y),DE
       4A13                     RCP_PARAM3:
000A13 4A13 23               6      INC HL
000A14 4A14 7E               7      LD  A,(HL)
000A15 4A15 FE20             7      CP  020H
000A17 4A17 28FA            12      JR  Z,RCP_PARAM3
000A19 4A19 FE29             7      CP  ')'
000A1B 4A1B 28F6            12      JR  Z,RCP_PARAM3
000A1D 4A1D FE2C             7      CP  ','
000A1F 4A1F 2033            12      JR  NZ,RCP_ST
                                
000A21 4A21 23               6      INC HL
000A22 4A22 DD212F54        14      LD  IX,FRMQNT
000A26 4A26 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000A2A 4A2A CD1C00          17      CALL    _CALSLT
                                
000A2D 4A2D 7B               4      LD  A,E
000A2E 4A2E 32E5F2          13      LD  (_BUF_P),A
                                
       4A31                     RCP_PARAM4:
000A31 4A31 7E               7      LD  A,(HL)
000A32 4A32 23               6      INC HL
000A33 4A33 FE20             7      CP  020H
000A35 4A35 28FA            12      JR  Z,RCP_PARAM4
                                
000A37 4A37 FE2C             7      CP  ','
000A39 4A39 2019            12      JR  NZ,RCP_ST
                                
000A3B 4A3B 7E               7      LD  A,(HL)
000A3C 4A3C 0604             7      LD  B,4
000A3E 4A3E FEC3             7      CP  0C3H        ;PRESET
000A40 4A40 280E            12      JR  Z,RCP_LO
000A42 4A42 05               4      DEC B       ;3
000A43 4A43 D6F8             7      SUB 0F8H        ;XOR
000A45 4A45 2809            12      JR  Z,RCP_LO
000A47 4A47 05               4      DEC B       ;2
000A48 4A48 3C               4      INC A       ;OR
000A49 4A49 2805            12      JR  Z,RCP_LO
000A4B 4A4B 05               4      DEC B       ;1
000A4C 4A4C 3C               4      INC A       ;AND
000A4D 4A4D 2801            12      JR  Z,RCP_LO
000A4F 4A4F 05               4      DEC B       ;0
                                                ;PSET
       4A50                     RCP_LO:
000A50 4A50 78               4      LD  A,B
000A51 4A51 32D9F2          13      LD  (_BUF_LO),A
       4A54                     RCP_ST:
000A54 4A54 2AC6F6          16      LD  HL,(STREND)
000A57 4A57 22D4F2          16      LD  (_DTA),HL
000A5A 4A5A EB               4      EX  DE,HL
000A5B 4A5B 2100FE          10      LD  HL,-512
000A5E 4A5E 39              11      ADD HL,SP
000A5F 4A5F AF               4      XOR A
000A60 4A60 ED52            15      SBC HL,DE
000A62 4A62 3008            12      JR  NC,RCP0
000A64 4A64 215EF5          10      LD  HL,BUF
000A67 4A67 22D4F2          16      LD  (_DTA),HL
000A6A 4A6A 6F               4      LD  L,A ;0
000A6B 4A6B 67               4      LD  H,A ;0
       4A6C                     RCP0:
000A6C 4A6C 24               4      INC H
000A6D 4A6D 22DCF2          16      LD  (_BUF_EN),HL
       4A70                     RCP1:
000A70 4A70 F3               4      DI
000A71 4A71 CD464B          17      CALL    WAIT_VDP
                                
000A74 4A74 3A0700          13      LD  A,(WRVDP)
000A77 4A77 4F               4      LD  C,A
000A78 4A78 0C               4      INC C       ;C := PORT#1's address(WR)
000A79 4A79 3E24             7      LD  A,36
000A7B 4A7B ED79            12      OUT (C),A
000A7D 4A7D 3E91             7      LD  A,080H+17
000A7F 4A7F ED79            12      OUT (C),A       ;R#17 := 36
                                
000A81 4A81 0C               4      INC C
000A82 4A82 0C               4      INC C       ;C := PORT#3's address(WR)
000A83 4A83 2AE2F2          16      LD  HL,(_BUF_X)
000A86 4A86 ED69            12      OUT (C),L       ;R#36 DX
000A88 4A88 ED61            12      OUT (C),H       ;R#37
000A8A 4A8A 2AE4F2          16      LD  HL,(_BUF_Y)
000A8D 4A8D ED69            12      OUT (C),L       ;R#38 DY
000A8F 4A8F ED61            12      OUT (C),H       ;R#39
000A91 4A91 2ADEF2          16      LD  HL,(_BUF_W)
000A94 4A94 ED69            12      OUT (C),L       ;R#40 NX
000A96 4A96 ED61            12      OUT (C),H       ;R#41
000A98 4A98 2AE0F2          16      LD  HL,(_BUF_H)
000A9B 4A9B ED69            12      OUT (C),L       ;R#42 NY
000A9D 4A9D ED61            12      OUT (C),H       ;R#43
                                
000A9F 4A9F DD2AAFFC        20      LD  IX,(SCRMOD)
000AA3 4AA3 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000AA6 4AA6 B7               4      OR  A
000AA7 4AA7 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000AA9 4AA9 DD7D             9      LD  A,IXL
000AAB 4AAB FE08             7      CP  8
000AAD 4AAD 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
000AAF 4AAF FE06             7      CP  6
000AB1 4AB1 2AE2F2          16      LD  HL,(_BUF_X)
000AB4 4AB4 3ADEF2          13      LD  A,(_BUF_W)
000AB7 4AB7 2005            12      JR  NZ,SCR57
000AB9 4AB9 B5               4      OR  L       ;スクリーン6
000ABA 4ABA E603             7      AND 3
000ABC 4ABC 200D            12      JR  NZ,USE_LMMC
       4ABE                     SCR57:              ;スクリーン5,7
000ABE 4ABE B5               4      OR  L
000ABF 4ABF E601             7      AND 1
000AC1 4AC1 2008            12      JR  NZ,USE_LMMC
       4AC3                     USE_HMMC:
000AC3 4AC3 DD2E08          10      LD  IXL,8
       4AC6                     USE_HMMC8:
000AC6 4AC6 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
000AC8 4AC8 32D9F2          13      LD  (_BUF_LO),A
       4ACB                     USE_LMMC:
000ACB 4ACB 110000          10      LD  DE,0
000ACE 4ACE 06FF             7      LD  B,-1
000AD0 4AD0 CD714B          17      CALL    GET_PIXEL
000AD3 4AD3 ED79            12      OUT (C),A       ;R#44 first DATA
000AD5 4AD5 3AE6F2          13      LD  A,(_BUF_O)
000AD8 4AD8 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
000ADA 4ADA 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000ADD 4ADD F6B0             7      OR  0B0H        ;R#46 LMMC command
000ADF 4ADF ED79            12      OUT (C),A
                                
000AE1 4AE1 FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
000AE3 4AE3 0D               4      DEC C
000AE4 4AE4 0D               4      DEC C       ;C := PORT#1's address(WR)
000AE5 4AE5 3EAC             7      LD  A,080H+44
000AE7 4AE7 ED79            12      OUT (C),A
000AE9 4AE9 3E91             7      LD  A,080H+17
000AEB 4AEB ED79            12      OUT (C),A       ;R#17 := 44
                                
000AED 4AED 3A0600          13      LD  A,(RDVDP)
000AF0 4AF0 3C               4      INC A
000AF1 4AF1 FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
000AF3 4AF3 3E02             7      LD  A,2
000AF5 4AF5 ED79            12      OUT (C),A
000AF7 4AF7 3E8F             7      LD  A,08FH
000AF9 4AF9 ED79            12      OUT (C),A
000AFB 4AFB 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000AFE 4AFE E640             7      AND 040H
000B00 4B00 201C            12      JR  NZ,LOOP_HMMC
       4B02                     LOOP_COPY:
000B02 4B02 CD714B          17      CALL    GET_PIXEL
000B05 4B05 08               4      EX  AF,AF'
000B06 4B06 FD4C             9      LD  C,IYH
       4B08                     LOOP_COPY1:
000B08 4B08 ED78            12      IN  A,(C)
000B0A 4B0A 0F               4      RRCA            ;RRCAではサインフラグは変化しない
000B0B 4B0B 300A            12      JR  NC,EXIT_COPY    ;check CE bit
000B0D 4B0D F2084B          10      JP  P,LOOP_COPY1    ;check TR bit
000B10 4B10 08               4      EX  AF,AF'
000B11 4B11 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000B13 4B13 ED79            12      OUT (C),A
000B15 4B15 18EB            12      JR  LOOP_COPY
                                
       4B17                     EXIT_COPY:
000B17 4B17 CD4E4B          17      CALL    GET_STATUS_0
000B1A 4B1A FB               4      EI
000B1B 4B1B C3AF48          10      JP  ROM_NEXT
                                
       4B1E                     LOOP_HMMC:
000B1E 4B1E F3               4      DI          ;必要
000B1F 4B1F FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000B21 4B21 43               4      LD  B,E
000B22 4B22 7B               4      LD  A,E
000B23 4B23 B7               4      OR  A
000B24 4B24 2802            12      JR  Z,LOOP_HMMC1
000B26 4B26 EDB3                    OTIR
       4B28                     LOOP_HMMC1:
000B28 4B28 14               4      INC D
       4B29                     LOOP_HMMC2:
000B29 4B29 15               4      DEC D
000B2A 4B2A 2805            12      JR  Z,LOOP_HMMC3
000B2C 4B2C EDB3                    OTIR
000B2E 4B2E C3294B          10      JP  LOOP_HMMC2
       4B31                     LOOP_HMMC3:
000B31 4B31 ED78            12      IN  A,(C)
000B33 4B33 0F               4      RRCA
000B34 4B34 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
000B36 4B36 2ADCF2          16      LD  HL,(_BUF_EN)
000B39 4B39 CDB84B          17      CALL    ROM_READ
000B3C 4B3C EB               4      EX  DE,HL
000B3D 4B3D 2AD4F2          16      LD  HL,(_DTA)
000B40 4B40 7A               4      LD  A,D
000B41 4B41 B3               4      OR  E
000B42 4B42 20DA            12      JR  NZ,LOOP_HMMC
000B44 4B44 18C2            12      JR  LOOP_COPY1
                                
       4B46                     WAIT_VDP:
000B46 4B46 3E02             7      LD  A,2
000B48 4B48 CD4F4B          17      CALL    GET_STATUS
000B4B 4B4B 0F               4      RRCA
000B4C 4B4C 38F8            12      JR  C,WAIT_VDP
       4B4E                     GET_STATUS_0:
000B4E 4B4E AF               4      XOR A
       4B4F                     GET_STATUS:
000B4F 4B4F C5              11      PUSH    BC
000B50 4B50 ED4B0600        20      LD  BC,(RDVDP)
000B54 4B54 0C               4      INC C
000B55 4B55 ED79            12      OUT (C),A
000B57 4B57 3E8F             7      LD  A,08FH
000B59 4B59 ED79            12      OUT (C),A
000B5B 4B5B ED78            12      IN  A,(C)
000B5D 4B5D C1              10      POP BC
000B5E 4B5E C9              10      RET
                                
       4B5F                     GET_PIXEL256:
000B5F 4B5F 7A               4      LD  A,D
000B60 4B60 B3               4      OR  E
000B61 4B61 200A            12      JR  NZ,GET_PIXEL1
000B63 4B63 2ADCF2          16      LD  HL,(_BUF_EN)
000B66 4B66 CDB84B          17      CALL    ROM_READ
000B69 4B69 EB               4      EX  DE,HL
000B6A 4B6A 2AD4F2          16      LD  HL,(_DTA)
       4B6D                     GET_PIXEL1:
000B6D 4B6D 7E               7      LD  A,(HL)
000B6E 4B6E 23               6      INC HL
000B6F 4B6F 1B               6      DEC DE
000B70 4B70 C9              10      RET
                                
       4B71                     GET_PIXEL:
000B71 4B71 DD7D             9      LD  A,IXL
000B73 4B73 FE08             7      CP  8
000B75 4B75 28E8            12      JR  Z,GET_PIXEL256
000B77 4B77 04               4      INC B
000B78 4B78 FE06             7      CP  6
000B7A 4B7A 282E            12      JR  Z,GET_PIXEL4
                                
000B7C 4B7C CB40             8      BIT 0,B
000B7E 4B7E 20ED            12      JR  NZ,GET_PIXEL1
                                
000B80 4B80 7A               4      LD  A,D
000B81 4B81 B3               4      OR  E
000B82 4B82 200A            12      JR  NZ,GET_PIXEL2
                                
000B84 4B84 2ADCF2          16      LD  HL,(_BUF_EN)
000B87 4B87 CDB84B          17      CALL    ROM_READ
000B8A 4B8A EB               4      EX  DE,HL
000B8B 4B8B 2AD4F2          16      LD  HL,(_DTA)
                                
       4B8E                     GET_PIXEL2:
000B8E 4B8E 7E               7      LD  A,(HL)
000B8F 4B8F 0F               4      RRCA
000B90 4B90 0F               4      RRCA
000B91 4B91 0F               4      RRCA
000B92 4B92 0F               4      RRCA
000B93 4B93 C9              10      RET
                                
       4B94                     GET_PIXEL3:
000B94 4B94 7A               4      LD  A,D
000B95 4B95 B3               4      OR  E
000B96 4B96 200A            12      JR  NZ,GET_PIXEL5
                                
000B98 4B98 2ADCF2          16      LD  HL,(_BUF_EN)
000B9B 4B9B CDB84B          17      CALL    ROM_READ
000B9E 4B9E EB               4      EX  DE,HL
000B9F 4B9F 2AD4F2          16      LD  HL,(_DTA)
       4BA2                     GET_PIXEL5:
000BA2 4BA2 7E               7      LD  A,(HL)
000BA3 4BA3 0F               4      RRCA
000BA4 4BA4 0F               4      RRCA
000BA5 4BA5 0F               4      RRCA
000BA6 4BA6 0F               4      RRCA
000BA7 4BA7 0F               4      RRCA
000BA8 4BA8 0F               4      RRCA
000BA9 4BA9 C9              10      RET
                                
       4BAA                     GET_PIXEL4:
000BAA 4BAA 78               4      LD  A,B
000BAB 4BAB E603             7      AND 3   ;+0
000BAD 4BAD 28E5            12      JR  Z,GET_PIXEL3
000BAF 4BAF 3D               4      DEC A   ;+1
000BB0 4BB0 28DC            12      JR  Z,GET_PIXEL2
000BB2 4BB2 3D               4      DEC A   ;+2
000BB3 4BB3 7E               7      LD  A,(HL)
000BB4 4BB4 C0              11      RET NZ
000BB5 4BB5 0F               4      RRCA        ;+3
000BB6 4BB6 0F               4      RRCA
000BB7 4BB7 C9              10      RET
                                
       4BB8                     ROM_READ:
000BB8 4BB8 E5              11      PUSH    HL
000BB9 4BB9 D5              11      PUSH    DE
000BBA 4BBA C5              11      PUSH    BC
000BBB 4BBB FDE5            15      PUSH    IY
000BBD 4BBD 22F3F2          16      LD  (LEFTX),HL
000BC0 4BC0 2AD4F2          16      LD  HL,(_DTA)
000BC3 4BC3 22E7F2          16      LD  (DTAX),HL
000BC6 4BC6 2AF3F2          16      LD  HL,(LEFTX)
                                
000BC9 4BC9 CDD74E          17      CALL    RBX1
000BCC 4BCC 3870            12      JR  C,RBRERR1
000BCE 4BCE 79               4      LD  A,C
000BCF 4BCF EB               4      EX  DE,HL
000BD0 4BD0 ED52            15      SBC HL,DE       ;CP 0HL,CDE
000BD2 4BD2 19              11      ADD HL,DE
000BD3 4BD3 DE00             7      SBC A,000H
000BD5 4BD5 3801            12      JR  C,RBR1
000BD7 4BD7 EB               4      EX  DE,HL
       4BD8                     RBR1:
000BD8 4BD8 9F               4      SBC A,A
000BD9 4BD9 E601             7      AND 1
000BDB 4BDB 32C3F2          13      LD  (_RESULT),A
000BDE 4BDE 7C               4      LD  A,H
000BDF 4BDF B5               4      OR  L
000BE0 4BE0 CA344C          10      JP  Z,RBREND0
                                
000BE3 4BE3 22D0F2          16      LD  (_LEFT),HL  ;Read record byte
000BE6 4BE6 22F3F2          16      LD  (LEFTX),HL
                                
000BE9 4BE9 CD034F          17      CALL    RBX2
000BEC 4BEC 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000BEE 4BEE CD164F          17      CALL    RBXA
000BF1 4BF1 DA4A4C          10      JP  C,RBRERR
000BF4 4BF4 C5              11      PUSH    BC
000BF5 4BF5 CDCA45          17      CALL    ROM_LDIR
000BF8 4BF8 ED53E7F2        20      LD  (DTAX),DE
000BFC 4BFC 2AF3F2          16      LD  HL,(LEFTX)
000BFF 4BFF D1              10      POP DE
000C00 4C00 A7               4      AND A
000C01 4C01 ED52            15      SBC HL,DE
000C03 4C03 22F3F2          16      LD  (LEFTX),HL
000C06 4C06 2829            12      JR  Z,RBREND
                                
       4C08                     RBRB:
000C08 4C08 CD524F          17      CALL    RBXB
000C0B 4C0B 2818            12      JR  Z,RBRC
       4C0D                     RBRB1:
000C0D 4C0D C5              11      PUSH    BC
000C0E 4C0E D5              11      PUSH    DE
000C0F 4C0F CDFD4F          17      CALL    CLUST
000C12 4C12 EB               4      EX  DE,HL
000C13 4C13 ED4BC6F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000C17 4C17 CDCA45          17      CALL    ROM_LDIR
000C1A 4C1A EB               4      EX  DE,HL
000C1B 4C1B D1              10      POP DE
000C1C 4C1C C1              10      POP BC
000C1D 4C1D CDDA4F          17      CALL    GNCL
000C20 4C20 DA4A4C          10      JP  C,RBRERR
000C23 4C23 10E8            13      DJNZ    RBRB1
       4C25                     RBRC:
000C25 4C25 CD6A4F          17      CALL    RBXC
000C28 4C28 2807            12      JR  Z,RBREND
                                
000C2A 4C2A CDFD4F          17      CALL    CLUST
000C2D 4C2D EB               4      EX  DE,HL
000C2E 4C2E CDCA45          17      CALL    ROM_LDIR
       4C31                     RBREND:
000C31 4C31 CD764F          17      CALL    RBXEND
       4C34                     RBREND0:
000C34 4C34 FDE1            14      POP IY
000C36 4C36 C1              10      POP BC
000C37 4C37 D1              10      POP DE
000C38 4C38 F1              10      POP AF  ;(HL)
000C39 4C39 AF               4      XOR A
000C3A 4C3A 3AC3F2          13      LD  A,(_RESULT)
000C3D 4C3D C9              10      RET
                                
       4C3E                     RBRERR1:
000C3E 4C3E 3E01             7      LD  A,001H
       4C40                     RBRERR2:
000C40 4C40 FDE1            14      POP IY
000C42 4C42 C1              10      POP BC
000C43 4C43 D1              10      POP DE
000C44 4C44 E1              10      POP HL
000C45 4C45 37               4      SCF
000C46 4C46 210000          10      LD  HL,0
000C49 4C49 C9              10      RET
       4C4A                     RBRERR:
000C4A 4C4A 3EFF             7      LD  A,0FFH
000C4C 4C4C 18F2            12      JR  RBRERR2
                                
       4C4E                     FILE_DD:
000C4E 4C4E E1              10      POP HL
000C4F 4C4F 3E                      DB  03EH
000C50 4C50 C9              10      RET
000C51 4C51 32A3F2          13      LD  (SWC_BLOAD_M),A
       4C54                     ROM_ORG:
000C54 4C54 2AF5F2          16      LD  HL,(PARAM0)
000C57 4C57 7E               7      LD  A,(HL)
000C58 4C58 C9              10      RET
       4C59                     FILE_B:
000C59 4C59 1E00             7      LD  E,0
000C5B 4C5B 3A63F6          13      LD  A,(VALTYP)
000C5E 4C5E FE03             7      CP  3       ;string
000C60 4C60 C2FA4C          10      JP  NZ,FILED
                                
000C63 4C63 DD21D067        14      LD  IX,FRESTR
000C67 4C67 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000C6B 4C6B CD1C00          17      CALL    _CALSLT
000C6E 4C6E E5              11      PUSH    HL
000C6F 4C6F DDE1            14      POP IX
                                
000C71 4C71 DD5E00          19      LD  E,(IX+0)
000C74 4C74 DD7E01          19      LD  A,(IX+1)
000C77 4C77 DD5602          19      LD  D,(IX+2)
000C7A 4C7A DD62             9      LD  IXH,D
000C7C 4C7C DD6F             9      LD  IXL,A
000C7E 4C7E 3E1F             7      LD  A,01FH
000C80 4C80 1802            12      JR  FILE_BAS
       4C82                     FILE_BDOS:
000C82 4C82 3E20             7      LD  A,020H
       4C84                     FILE_BAS:
000C84 4C84 32FBF2          13      LD  (_CHKSP),A
000C87 4C87 AF               4      XOR A
000C88 4C88 3200F3          13      LD  (FDRV),A
000C8B 4C8B 7B               4      LD  A,E
000C8C 4C8C FE04             7      CP  4
000C8E 4C8E 3808            12      JR  C,FILEB1
000C90 4C90 DD7E03          19      LD  A,(IX+3)
000C93 4C93 FE3A             7      CP  ':'
000C95 4C95 28B7            12      JR  Z,FILE_DD
000C97 4C97 7B               4      LD  A,E
       4C98                     FILEB1:
000C98 4C98 FE02             7      CP  2
000C9A 4C9A 3820            12      JR  C,DEVI1
000C9C 4C9C DD7E01          19      LD  A,(IX+1)
000C9F 4C9F FE3A             7      CP  ':'
000CA1 4CA1 2019            12      JR  NZ,DEVI1
000CA3 4CA3 DD7E00          19      LD  A,(IX+0)        ;DRIVE
000CA6 4CA6 CDD74D          17      CALL    CAP
000CA9 4CA9 D640             7      SUB '@'
000CAB 4CAB DD23            10      INC IX
000CAD 4CAD DD23            10      INC IX
000CAF 4CAF 1D               4      DEC E
000CB0 4CB0 1D               4      DEC E
000CB1 4CB1 3200F3          13      LD  (FDRV),A
000CB4 4CB4 F5              11      PUSH    AF
000CB5 4CB5 CDF755          17      CALL    GET_CD_CDRV
000CB8 4CB8 22F9F2          16      LD  (_CDX),HL
000CBB 4CBB E1              10      POP HL
       4CBC                     DEVI1:
000CBC 4CBC DD7E00          19      LD  A,(IX+0)
000CBF 4CBF D65C             7      SUB 05CH        ;\
000CC1 4CC1 2008            12      JR  NZ,NOROOT
000CC3 4CC3 6F               4      LD  L,A
000CC4 4CC4 67               4      LD  H,A
000CC5 4CC5 22F9F2          16      LD  (_CDX),HL
000CC8 4CC8 DD23            10      INC IX
000CCA 4CCA 1D               4      DEC E
       4CCB                     NOROOT:
                                
       4CCB                     SETDIR:
000CCB 4CCB CDFA4C          17      CALL    FILED
000CCE 4CCE DD7E00          19      LD  A,(IX+0)
000CD1 4CD1 FE5C             7      CP  05CH        ;\
000CD3 4CD3 C0              11      RET NZ
000CD4 4CD4 DD23            10      INC IX
000CD6 4CD6 1D               4      DEC E
000CD7 4CD7 3A01F3          13      LD  A,(FNAME)
000CDA 4CDA FE20             7      CP  020H        ;. の処理
000CDC 4CDC 28ED            12      JR  Z,SETDIR
                                
000CDE 4CDE CDED4D          17      CALL    ROM_OPEN
000CE1 4CE1 B7               4      OR  A
000CE2 4CE2 C0              11      RET NZ
                                
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                #else
000CE3 4CE3 FD2AEFF2        20      LD  IY,(DIRENT1)
000CE7 4CE7 FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000CEB 4CEB C8              11      RET Z
000CEC 4CEC CD414D          17      CALL    FILEI
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
000CEF 4CEF FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000CF2 4CF2 FD661B          19      LD  H,(IY+01BH)
                                #endif
000CF5 4CF5 22F9F2          16      LD  (_CDX),HL
000CF8 4CF8 18D1            12      JR  SETDIR
                                
       4CFA                     FILED:
000CFA 4CFA CD414D          17      CALL    FILEI
000CFD 4CFD 2101F3          10      LD  HL,FNAME
                                
000D00 4D00 0608             7      LD  B,8
       4D02                     FILE2:
000D02 4D02 CD4E4D          17      CALL    CCHKF
000D05 4D05 C8              11      RET Z
000D06 4D06 FE2A             7      CP  '*'
000D08 4D08 282E            12      JR  Z,FILE9
000D0A 4D0A FE2E             7      CP  '.'
000D0C 4D0C 280C            12      JR  Z,FILE4
000D0E 4D0E 77               7      LD  (HL),A
000D0F 4D0F 23               6      INC HL
000D10 4D10 10F0            13      DJNZ    FILE2
                                
       4D12                     FILE3:
000D12 4D12 CD4E4D          17      CALL    CCHKF
000D15 4D15 C8              11      RET Z
000D16 4D16 FE2E             7      CP  '.'
000D18 4D18 20F8            12      JR  NZ,FILE3
                                
       4D1A                     FILE4:
000D1A 4D1A 2109F3          10      LD  HL,FNAME+8
000D1D 4D1D 0603             7      LD  B,3
                                
       4D1F                     FILE4L:
000D1F 4D1F CD4E4D          17      CALL    CCHKF
000D22 4D22 C8              11      RET Z
000D23 4D23 FE2E             7      CP  '.'
000D25 4D25 2008            12      JR  NZ,FILE12
000D27 4D27 3201F3          13      LD  (FNAME),A   ;Parent directory(..)
000D2A 4D2A 3202F3          13      LD  (FNAME+1),A
000D2D 4D2D 3E20             7      LD  A,020H
       4D2F                     FILE12:
000D2F 4D2F FE2A             7      CP  '*'
000D31 4D31 280A            12      JR  Z,FILE10
000D33 4D33 77               7      LD  (HL),A
000D34 4D34 23               6      INC HL
000D35 4D35 10E8            13      DJNZ    FILE4L
000D37 4D37 C9              10      RET
                                
       4D38                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000D38 4D38 CD3D4D          17      CALL    FILE10
000D3B 4D3B 18D5            12      JR  FILE3
                                
       4D3D                     FILE10:
000D3D 4D3D 3E3F             7      LD  A,'?'
000D3F 4D3F 1808            12      JR  FILL_MEMORY
       4D41                     FILEI:              ;名前＋拡張子をスペースで初期化
000D41 4D41 3E20             7      LD  A,020H
000D43 4D43 01000B          10      LD  BC,11*256   ;C=0にしておく
000D46 4D46 2101F3          10      LD  HL,FNAME
       4D49                     FILL_MEMORY:            ;HLからBバイトAで埋める
000D49 4D49 77               7      LD  (HL),A
000D4A 4D4A 23               6      INC HL
000D4B 4D4B 10FC            13      DJNZ    FILL_MEMORY
000D4D 4D4D C9              10      RET
                                
       4D4E                     CCHKF:
000D4E 4D4E 7B               4      LD  A,E
000D4F 4D4F B7               4      OR  A
000D50 4D50 C8              11      RET Z
000D51 4D51 DD7E00          19      LD  A,(IX+0)
000D54 4D54 CD5B4D          17      CALL    CCHK2
000D57 4D57 C8              11      RET Z
000D58 4D58 C3C24D          10      JP  FKAN
                                
       4D5B                     CCHK2:
000D5B 4D5B 0C               4      INC C
000D5C 4D5C 0D               4      DEC C
000D5D 4D5D C0              11      RET NZ
       4D5E                     CCHK3:              ;ZF=1 で使えない文字
000D5E 4D5E FE2B             7      CP  '+'
000D60 4D60 C8              11      RET Z
000D61 4D61 FE2C             7      CP  ','
000D63 4D63 C8              11      RET Z
000D64 4D64 FE2F             7      CP  '/'
000D66 4D66 C8              11      RET Z
000D67 4D67 FE3A             7      CP  ':'
000D69 4D69 C8              11      RET Z
000D6A 4D6A FE3B             7      CP  ';'
000D6C 4D6C C8              11      RET Z
000D6D 4D6D FE3D             7      CP  '='
000D6F 4D6F C8              11      RET Z
000D70 4D70 FE5C             7      CP  05CH    ;\
000D72 4D72 C8              11      RET Z
000D73 4D73 E5              11      PUSH    HL
000D74 4D74 2AFBF2          16      LD  HL,(_CHKSP)
000D77 4D77 BD               4      CP  L
000D78 4D78 E1              10      POP HL
000D79 4D79 D0              11      RET NC
000D7A 4D7A BF               4      CP  A       ;Z=1
000D7B 4D7B C9              10      RET
                                
       4D7C                     SS1:
000D7C 4D7C 13               6      INC DE
       4D7D                     SPCUT:              ;スペースをカット
000D7D 4D7D 1A               7      LD  A,(DE)
000D7E 4D7E FE20             7      CP  020H
000D80 4D80 28FA            12      JR  Z,SS1
000D82 4D82 C9              10      RET
                                
       4D83                     SCREOF1:
000D83 4D83 13               6      INC DE
       4D84                     SPCUTEX:            ;スペース改行などをカット
000D84 4D84 1A               7      LD  A,(DE)
000D85 4D85 FE20             7      CP  020H
000D87 4D87 28FA            12      JR  Z,SCREOF1
000D89 4D89 FE0D             7      CP  00DH
000D8B 4D8B 28F6            12      JR  Z,SCREOF1
000D8D 4D8D FE0A             7      CP  00AH
000D8F 4D8F 28F2            12      JR  Z,SCREOF1
000D91 4D91 FE1A             7      CP  01AH
000D93 4D93 28EE            12      JR  Z,SCREOF1
000D95 4D95 C9              10      RET
                                
       4D96                     GETNUM:
000D96 4D96 210000          10      LD  HL,0
       4D99                     GETNUM1:
000D99 4D99 1A               7      LD  A,(DE)
000D9A 4D9A 13               6      INC DE
000D9B 4D9B D630             7      SUB '0'
000D9D 4D9D D8              11      RET C
000D9E 4D9E FE0A             7      CP  10
000DA0 4DA0 D0              11      RET NC
000DA1 4DA1 4D               4      LD  C,L
000DA2 4DA2 44               4      LD  B,H
000DA3 4DA3 29              11      ADD HL,HL   ;*2
000DA4 4DA4 29              11      ADD HL,HL   ;*4
000DA5 4DA5 09              11      ADD HL,BC   ;*5
000DA6 4DA6 29              11      ADD HL,HL   ;*10
000DA7 4DA7 4F               4      LD  C,A
000DA8 4DA8 0600             7      LD  B,0
000DAA 4DAA 09              11      ADD HL,BC
000DAB 4DAB 18EC            12      JR  GETNUM1
                                
       4DAD                     SEARCH_END:
000DAD 4DAD 7E               7      LD  A,(HL)
       4DAE                     SEARCH_END1:
000DAE 4DAE 23               6      INC HL
000DAF 4DAF B7               4      OR  A
000DB0 4DB0 C8              11      RET Z
000DB1 4DB1 FE3A             7      CP  ':'
000DB3 4DB3 20F8            12      JR  NZ,SEARCH_END
000DB5 4DB5 7E               7      LD  A,(HL)
000DB6 4DB6 FE3A             7      CP  ':'
000DB8 4DB8 28F4            12      JR  Z,SEARCH_END1
000DBA 4DBA C9              10      RET
                                
       4DBB                     FKANC:
000DBB 4DBB CB41             8      BIT 0,C
000DBD 4DBD CCE04D          17      CALL    Z,CAP2
000DC0 4DC0 1803            12      JR  FKANX
       4DC2                     FKAN:           ;漢字チェック
000DC2 4DC2 DD23            10      INC IX
000DC4 4DC4 1D               4      DEC E
       4DC5                     FKANX:
000DC5 4DC5 CB41             8      BIT 0,C
000DC7 4DC7 CB81             8      RES 0,C
000DC9 4DC9 C0              11      RET NZ
000DCA 4DCA FE80             7      CP  080H
000DCC 4DCC D8              11      RET C
000DCD 4DCD FEA0             7      CP  0A0H
000DCF 4DCF 3803            12      JR  C,FKAN1
000DD1 4DD1 FEE0             7      CP  0E0H
000DD3 4DD3 D8              11      RET C
       4DD4                     FKAN1:
000DD4 4DD4 0C               4      INC C
000DD5 4DD5 A7               4      AND A
000DD6 4DD6 C9              10      RET
                                
       4DD7                     CAP:
000DD7 4DD7 FE61             7      CP  'a'
000DD9 4DD9 D8              11      RET C
000DDA 4DDA FE7B             7      CP  'z'+1
000DDC 4DDC D0              11      RET NC
000DDD 4DDD D620             7      SUB 020H
000DDF 4DDF C9              10      RET
       4DE0                     CAP2:
000DE0 4DE0 CDD74D          17      CALL    CAP
       4DE3                     CAP3:               ;
000DE3 4DE3 FE05             7      CP  5
000DE5 4DE5 2803            12      JR  Z,CAP4
000DE7 4DE7 FE21             7      CP  021H
000DE9 4DE9 C9              10      RET
       4DEA                     CAP4:
000DEA 4DEA 3EE5             7      LD  A,0E5H
000DEC 4DEC C9              10      RET
                                
       4DED                     ROM_OPEN:
000DED 4DED CD1856          17      CALL    GET_DISK_BANK_FDRV
                                
000DF0 4DF0 CDB250          17      CALL    GET_DIR_DAT
000DF3 4DF3 D5              11      PUSH    DE
000DF4 4DF4 CD614E          17      CALL    FILESE
000DF7 4DF7 D1              10      POP DE
000DF8 4DF8 300F            12      JR  NC,ROM_OPEN_C
       4DFA                     ROM_OPEN_OK:
000DFA 4DFA 22EFF2          16      LD  (DIRENT1),HL
000DFD 4DFD E5              11      PUSH    HL
000DFE 4DFE AF               4      XOR A
000DFF 4DFF 6F               4      LD  L,A
000E00 4E00 67               4      LD  H,A
000E01 4E01 22CAF2          16      LD  (RR_LOW),HL
000E04 4E04 22CCF2          16      LD  (RR_HIGH),HL
000E07 4E07 E1              10      POP HL
000E08 4E08 C9              10      RET
                                
       4E09                     ROM_OPEN_C:         ;#XXXX 形式のサブディスク
000E09 4E09 3A01F3          13      LD  A,(FNAME)
000E0C 4E0C FE23             7      CP  '#'
000E0E 4E0E 37               4      SCF
000E0F 4E0F C0              11      RET NZ
000E10 4E10 D5              11      PUSH    DE
000E11 4E11 2100F3          10      LD  HL,FDRV
000E14 4E14 1103FB          10      LD  DE,TMP_DIRENT
000E17 4E17 010C00          10      LD  BC,1+8+3
000E1A 4E1A EDB0                    LDIR
000E1C 4E1C 0614             7      LD  B,32-(1+8+3)
000E1E 4E1E CDCF5B          17      CALL    ZERO_MEMORY_DE
000E21 4E21 3E10             7      LD  A,010H          ;ディレクトリ属性
000E23 4E23 320EFB          13      LD  (TMP_DIRENT+0000BH),A   ;属性(アトリビュート)
000E26 4E26 3A02F3          13      LD  A,(FNAME+1)
000E29 4E29 CD425C          17      CALL    HEX
000E2C 4E2C 3830            12      JR  C,POPDE_SCF
000E2E 4E2E 87               4      ADD A,A
000E2F 4E2F 87               4      ADD A,A
000E30 4E30 87               4      ADD A,A
000E31 4E31 87               4      ADD A,A
000E32 4E32 5F               4      LD  E,A
000E33 4E33 3A03F3          13      LD  A,(FNAME+2)
000E36 4E36 CD425C          17      CALL    HEX
000E39 4E39 3823            12      JR  C,POPDE_SCF
000E3B 4E3B B3               4      OR  E
000E3C 4E3C 321EFB          13      LD  (TMP_DIRENT+0001BH),A       ;ファイルの先頭クラスタ
000E3F 4E3F 3A04F3          13      LD  A,(FNAME+3)
000E42 4E42 CD425C          17      CALL    HEX
000E45 4E45 3817            12      JR  C,POPDE_SCF
000E47 4E47 87               4      ADD A,A
000E48 4E48 87               4      ADD A,A
000E49 4E49 87               4      ADD A,A
000E4A 4E4A 87               4      ADD A,A
000E4B 4E4B 5F               4      LD  E,A
000E4C 4E4C 3A05F3          13      LD  A,(FNAME+4)
000E4F 4E4F CD425C          17      CALL    HEX
000E52 4E52 380A            12      JR  C,POPDE_SCF
000E54 4E54 B3               4      OR  E
000E55 4E55 321DFB          13      LD  (TMP_DIRENT+0001AH),A       ;ファイルの先頭クラスタ
000E58 4E58 D1              10      POP DE
000E59 4E59 2103FB          10      LD  HL,TMP_DIRENT
000E5C 4E5C 189C            12      JR  ROM_OPEN_OK
       4E5E                     POPDE_SCF:
000E5E 4E5E D1              10      POP DE
000E5F 4E5F 37               4      SCF
000E60 4E60 C9              10      RET
                                
       4E61                     FILESE:
       4E61                     FILESE0:
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000E61 4E61 7E               7      LD  A,(HL)
                                #endif
000E62 4E62 B7               4      OR  A
000E63 4E63 C8              11      RET Z       ;END:ZF=1 CF=0
000E64 4E64 FEE5             7      CP  0E5H
000E66 4E66 280D            12      JR  Z,FILESE1
000E68 4E68 1101F3          10      LD  DE,FNAME
000E6B 4E6B E5              11      PUSH    HL
000E6C 4E6C CDB24E          17      CALL    CPFILE
000E6F 4E6F CCD34E          17      CALL    Z,CPFILE2
000E72 4E72 E1              10      POP HL
000E73 4E73 37               4      SCF
000E74 4E74 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4E75                     FILESE1:
000E75 4E75 CD7D4E          17      CALL    FNEXT
000E78 4E78 20E7            12      JR  NZ,FILESE0
000E7A 4E7A F6FF             7      OR  0FFH        ;ZF=0 CF=0
000E7C 4E7C C9              10      RET
                                
       4E7D                     FNEXT:
000E7D 4E7D 112000          10      LD  DE,020H
000E80 4E80 19              11      ADD HL,DE
000E81 4E81 ED5BF9F2        20      LD  DE,(_CDX)
000E85 4E85 7A               4      LD  A,D
000E86 4E86 B3               4      OR  E
000E87 4E87 2019            12      JR  NZ,FNEXT_SUBDIR
000E89 4E89 0D               4      DEC C
                                #if exists USE_NORMAL32K_OR_ASCII16
                                #else
       4E8A                     CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
000E8A 4E8A F5              11      PUSH    AF      ;※フラグを保存する必要あり
000E8B 4E8B CB7C             8      BIT 7,H
000E8D 4E8D 2811            12      JR  Z,CHECK_DIR_PAGE1
000E8F 4E8F 7C               4      LD  A,H
000E90 4E90 D620             7      SUB 020H
000E92 4E92 67               4      LD  H,A
000E93 4E93 3AF1F2          13      LD  A,(_DIR_BANK)
000E96 4E96 3C               4      INC A
000E97 4E97 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000E9A 4E9A 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000E9D 4E9D 32F1F2          13      LD  (_DIR_BANK),A
       4EA0                     CHECK_DIR_PAGE1:
000EA0 4EA0 F1              10      POP AF
                                #endif
000EA1 4EA1 C9              10      RET
                                
       4EA2                     FNEXT_SUBDIR:           ;サブディレクトリ
000EA2 4EA2 0D               4      DEC C
000EA3 4EA3 C0              11      RET NZ
                                
000EA4 4EA4 ED5BF9F2        20      LD  DE,(_CDX)
000EA8 4EA8 CDDA4F          17      CALL    GNCL
000EAB 4EAB EB               4      EX  DE,HL
000EAC 4EAC 22F9F2          16      LD  (_CDX),HL
000EAF 4EAF C3EE50          10      JP  GET_SUBDIR
                                
       4EB2                     CPFILE:
000EB2 4EB2 C5              11      PUSH    BC
000EB3 4EB3 01000B          10      LD  BC,00B00H
       4EB6                     CPSTR1:
000EB6 4EB6 1A               7      LD  A,(DE)
000EB7 4EB7 FE3F             7      CP  '?'     ;Wild card
000EB9 4EB9 2812            12      JR  Z,CPSTR2
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000EBB 4EBB 7E               7      LD  A,(HL)
                                #endif
000EBC 4EBC CDBB4D          17      CALL    FKANC
000EBF 4EBF E5              11      PUSH    HL
000EC0 4EC0 67               4      LD  H,A
000EC1 4EC1 1A               7      LD  A,(DE)
000EC2 4EC2 CB01             8      RLC C
000EC4 4EC4 CDBB4D          17      CALL    FKANC
000EC7 4EC7 CB09             8      RRC C
000EC9 4EC9 BC               4      CP  H       ;CP (HL),(DE)
000ECA 4ECA E1              10      POP HL
000ECB 4ECB 2004            12      JR  NZ,CPSTR3
       4ECD                     CPSTR2:
000ECD 4ECD 13               6      INC DE
000ECE 4ECE 23               6      INC HL
000ECF 4ECF 10E5            13      DJNZ    CPSTR1
       4ED1                     CPSTR3:
000ED1 4ED1 C1              10      POP BC
000ED2 4ED2 C9              10      RET
                                
       4ED3                     CPFILE2:
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000ED3 4ED3 7E               7      LD  A,(HL)
                                #endif
000ED4 4ED4 E608             7      AND 008H    ;~0F7H
000ED6 4ED6 C9              10      RET
                                
       4ED7                     RBX1:
000ED7 4ED7 E5              11      PUSH    HL      ;Record byte
                                
000ED8 4ED8 ED5BCAF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000EDC 4EDC 3ACDF2          13      LD  A,(RR_HIGH+1)
000EDF 4EDF 4F               4      LD  C,A
                                
000EE0 4EE0 3AF1F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001CH
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    CALL    RDSLT_ROM
                                    EX  DE,HL       ;AHL=File size
                                    POP DE
                                #else
000EE3 4EE3 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000EE6 4EE6 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000EE9 4EE9 FD2AEFF2        20      LD  IY,(DIRENT1)
000EED 4EED FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000EF0 4EF0 FD661D          19      LD  H,(IY+01DH)
000EF3 4EF3 FD7E1E          19      LD  A,(IY+01EH)
                                #endif
                                
000EF6 4EF6 A7               4      AND A
000EF7 4EF7 ED52            15      SBC HL,DE
000EF9 4EF9 99               4      SBC A,C
000EFA 4EFA D1              10      POP DE
                                
000EFB 4EFB D8              11      RET C
000EFC 4EFC 4F               4      LD  C,A
000EFD 4EFD EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000EFE 4EFE B2               4      OR  D
000EFF 4EFF B3               4      OR  E
000F00 4F00 C0              11      RET NZ
000F01 4F01 37               4      SCF
000F02 4F02 C9              10      RET
                                
       4F03                     RBX2:
000F03 4F03 ED4BCBF2        20      LD  BC,(RR_LOW+1)
000F07 4F07 CD8B4F          17      CALL    RWXR
000F0A 4F0A 3AC7F2          13      LD  A,(CLSZ_H)
000F0D 4F0D 3D               4      DEC A
000F0E 4F0E E5              11      PUSH    HL
000F0F 4F0F 2ACAF2          16      LD  HL,(RR_LOW)
000F12 4F12 A4               4      AND H
000F13 4F13 B5               4      OR  L
000F14 4F14 E1              10      POP HL
000F15 4F15 C9              10      RET
                                
       4F16                     RBXA:
000F16 4F16 D5              11      PUSH    DE
000F17 4F17 CDFD4F          17      CALL    CLUST
000F1A 4F1A ED53D2F2        20      LD  (_DTPS),DE
000F1E 4F1E D1              10      POP DE
000F1F 4F1F CDDA4F          17      CALL    GNCL
000F22 4F22 D8              11      RET C
000F23 4F23 ED53CEF2        20      LD  (_CLPS),DE
                                
000F27 4F27 ED4BCAF2        20      LD  BC,(RR_LOW)
000F2B 4F2B 2AC6F2          16      LD  HL,(CLSZ)
000F2E 4F2E 7C               4      LD  A,H
000F2F 4F2F 3D               4      DEC A
000F30 4F30 A0               4      AND B
000F31 4F31 47               4      LD  B,A
000F32 4F32 ED42            15      SBC HL,BC       ;remaining cluster
                                
000F34 4F34 ED5BF3F2        20      LD  DE,(LEFTX)
000F38 4F38 ED52            15      SBC HL,DE       ;CP HL,DE
000F3A 4F3A 19              11      ADD HL,DE
000F3B 4F3B 3801            12      JR  C,RBXA1
000F3D 4F3D EB               4      EX  DE,HL
       4F3E                     RBXA1:
000F3E 4F3E 3AC4F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
000F41 4F41 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000F44 4F44 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000F47 4F47 E5              11      PUSH    HL
000F48 4F48 2AD2F2          16      LD  HL,(_DTPS)
000F4B 4F4B 09              11      ADD HL,BC
000F4C 4F4C ED5BE7F2        20      LD  DE,(DTAX)
000F50 4F50 C1              10      POP BC
000F51 4F51 C9              10      RET
                                
       4F52                     RBXB:
000F52 4F52 2AE7F2          16      LD  HL,(DTAX)
000F55 4F55 ED5BCEF2        20      LD  DE,(_CLPS)
000F59 4F59 3AF4F2          13      LD  A,(LEFTX+1)
000F5C 4F5C 47               4      LD  B,A
000F5D 4F5D 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4F60                     RBXB1:
000F60 4F60 1F               4      RRA     ;->CF
000F61 4F61 3804            12      JR  C,RBXB2
000F63 4F63 CB38             8      SRL B   ;B=B/2
000F65 4F65 18F9            12      JR  RBXB1
       4F67                     RBXB2:
000F67 4F67 78               4      LD  A,B
000F68 4F68 B7               4      OR  A
000F69 4F69 C9              10      RET
                                
       4F6A                     RBXC:
000F6A 4F6A ED4BF3F2        20      LD  BC,(LEFTX)
000F6E 4F6E 3AC7F2          13      LD  A,(CLSZ_H)
000F71 4F71 3D               4      DEC A
000F72 4F72 A0               4      AND B
000F73 4F73 47               4      LD  B,A
000F74 4F74 B1               4      OR  C
000F75 4F75 C9              10      RET
                                
       4F76                     RBXEND:
000F76 4F76 ED5BD0F2        20      LD  DE,(_LEFT)
000F7A 4F7A 2ACAF2          16      LD  HL,(RR_LOW)
000F7D 4F7D 3ACDF2          13      LD  A,(RR_HIGH+1)
000F80 4F80 19              11      ADD HL,DE
000F81 4F81 CE00             7      ADC A,0
000F83 4F83 22CAF2          16      LD  (RR_LOW),HL
000F86 4F86 32CDF2          13      LD  (RR_HIGH+1),A
000F89 4F89 EB               4      EX  DE,HL       ;HL=Read byte
000F8A 4F8A C9              10      RET
                                
       4F8B                     RWXR:
000F8B 4F8B 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4F8E                     L_RWX:
000F8E 4F8E 1F               4      RRA     ;->CF
000F8F 4F8F 3806            12      JR  C,E_RWX
000F91 4F91 CB38             8      SRL B   ;BC=BC/2
000F93 4F93 CB19             8      RR  C   ;
000F95 4F95 18F7            12      JR  L_RWX
       4F97                     E_RWX:
000F97 4F97 3AF1F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
                                    PUSH    HL
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    POP HL
                                #else
000F9A 4F9A 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000F9D 4F9D 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000FA0 4FA0 FD2AEFF2        20      LD  IY,(DIRENT1)
000FA4 4FA4 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000FA7 4FA7 FD561B          19      LD  D,(IY+01BH)
                                #endif
000FAA 4FAA CD1856          17      CALL    GET_DISK_BANK_FDRV
       4FAD                     RWX1:
000FAD 4FAD ED53CEF2        20      LD  (_CLPS),DE
000FB1 4FB1 7A               4      LD  A,D
000FB2 4FB2 B3               4      OR  E
000FB3 4FB3 37               4      SCF
000FB4 4FB4 C8              11      RET Z
                                
000FB5 4FB5 78               4      LD  A,B
000FB6 4FB6 B1               4      OR  C
000FB7 4FB7 C8              11      RET Z
                                
000FB8 4FB8 CDDA4F          17      CALL    GNCL
000FBB 4FBB D8              11      RET C
000FBC 4FBC 0B               6      DEC BC
000FBD 4FBD CD3C50          17      CALL    ENDCL
000FC0 4FC0 38EB            12      JR  C,RWX1
000FC2 4FC2 37               4      SCF
000FC3 4FC3 C9              10      RET
                                
       4FC4                     NCL3:
000FC4 4FC4 CD1856          17      CALL    GET_DISK_BANK_FDRV
000FC7 4FC7 6B               4      LD  L,E
000FC8 4FC8 62               4      LD  H,D
000FC9 4FC9 CB3C             8      SRL H
000FCB 4FCB CB1D             8      RR  L
000FCD 4FCD 1F               4      RRA
000FCE 4FCE 19              11      ADD HL,DE
000FCF 4FCF 010060          10      LD  BC,BANK1_ADR
000FD2 4FD2 09              11      ADD HL,BC
000FD3 4FD3 ED4BC8F2        20      LD  BC,(SECSZ)
000FD7 4FD7 09              11      ADD HL,BC
000FD8 4FD8 17               4      RLA
000FD9 4FD9 C9              10      RET
                                
       4FDA                     GNCL:
000FDA 4FDA 7A               4      LD  A,D
000FDB 4FDB B3               4      OR  E
000FDC 4FDC 37               4      SCF
000FDD 4FDD C8              11      RET Z
000FDE 4FDE C5              11      PUSH    BC
000FDF 4FDF E5              11      PUSH    HL
000FE0 4FE0 CDC44F          17      CALL    NCL3
000FE3 4FE3 3809            12      JR  C,GNC1
000FE5 4FE5 5E               7      LD  E,(HL)
000FE6 4FE6 23               6      INC HL
000FE7 4FE7 7E               7      LD  A,(HL)
000FE8 4FE8 E60F             7      AND 00FH
000FEA 4FEA 57               4      LD  D,A
000FEB 4FEB E1              10      POP HL
000FEC 4FEC C1              10      POP BC
000FED 4FED C9              10      RET
       4FEE                     GNC1:
000FEE 4FEE 7E               7      LD  A,(HL)
000FEF 4FEF 23               6      INC HL
000FF0 4FF0 56               7      LD  D,(HL)
000FF1 4FF1 0604             7      LD  B,4
       4FF3                     GNC1L:
000FF3 4FF3 CB3A             8      SRL D
000FF5 4FF5 1F               4      RRA
000FF6 4FF6 10FB            13      DJNZ    GNC1L
                                
000FF8 4FF8 5F               4      LD  E,A
000FF9 4FF9 E1              10      POP HL
000FFA 4FFA C1              10      POP BC
000FFB 4FFB A7               4      AND A
000FFC 4FFC C9              10      RET
                                
       4FFD                     CLUST:
000FFD 4FFD EB               4      EX  DE,HL
       4FFE                     CLUST_HL:
000FFE 4FFE 2B               6      DEC HL
000FFF 4FFF 2B               6      DEC HL
001000 5000 C5              11      PUSH    BC
001001 5001 3AC7F2          13      LD  A,(CLSZ_H)
001004 5004 CD4156          17      CALL    MUL_AHL
                                
001007 5007 CDCF50          17      CALL    GET_DIR_POS
00100A 500A 4F               4      LD  C,A
00100B 500B 0600             7      LD  B,0
00100D 500D 09              11      ADD HL,BC
                                
00100E 500E ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
001012 5012 CB38             8      SRL B
001014 5014 CB19             8      RR  C           ;/2
001016 5016 CB38             8      SRL B
001018 5018 CB19             8      RR  C           ;/4
00101A 501A CB38             8      SRL B
00101C 501C CB19             8      RR  C           ;/8
00101E 501E 09              11      ADD HL,BC
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    LD  A,L
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    JR  NC,CLUST2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
00101F 501F 4D               4      LD  C,L     ;C=読み出し元
001020 5020 29              11      ADD HL,HL   ;64KB→32KB
001021 5021 29              11      ADD HL,HL   ;32KB→16KB
001022 5022 29              11      ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
001023 5023 CD1856          17      CALL    GET_DISK_BANK_FDRV
001026 5026 84               4      ADD A,H
001027 5027 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
00102A 502A 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
00102D 502D 32C4F2          13      LD  (_BANK),A
001030 5030 69               4      LD  L,C     ;C=読み出し元
001031 5031 3E1F             7      LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
001033 5033 A5               4      AND L
                                #endif
       5034                     CLUST2:
001034 5034 C660             7      ADD A,high BANK1_ADR
001036 5036 67               4      LD  H,A
001037 5037 2E00             7      LD  L,0
001039 5039 EB               4      EX  DE,HL
00103A 503A C1              10      POP BC
00103B 503B C9              10      RET
                                
       503C                     ENDCL:
00103C 503C 7A               4      LD  A,D ;END CLUSTER
00103D 503D FE0F             7      CP  00FH    ;FAT12の最大値
00103F 503F C0              11      RET NZ
001040 5040 7B               4      LD  A,E
001041 5041 FEF7             7      CP  0F7H
001043 5043 C9              10      RET
                                
       5044                     RB_READ:
001044 5044 AF               4      XOR A   ;HLA = HL*128
001045 5045 CB3C             8      SRL H
001047 5047 CB1D             8      RR  L
001049 5049 1F               4      RRA
00104A 504A 32CAF2          13      LD  (RR_LOW),A
00104D 504D 22CBF2          16      LD  (RR_MID),HL
001050 5050 218000          10      LD  HL,128
                                
001053 5053 CDB84B          17      CALL    ROM_READ
001056 5056 C9              10      RET
                                
       5057                     GETSEQ:
001057 5057 FD6E20          19      LD  L,(IY+32)
00105A 505A FD660C          19      LD  H,(IY+12)
                                
00105D 505D CB25             8      SLA L
                                
00105F 505F CB3C             8      SRL H
001061 5061 CB1D             8      RR  L
001063 5063 C9              10      RET
                                
       5064                     SETSEQ:
001064 5064 F5              11      PUSH    AF
001065 5065 3ACAF2          13      LD  A,(RR_LOW)
001068 5068 2ACBF2          16      LD  HL,(RR_MID)
                                
00106B 506B CD8250          17      CALL    SSQ1
                                
00106E 506E 29              11      ADD HL,HL
00106F 506F CB3D             8      SRL L
001071 5071 FD7520          19      LD  (IY+32),L
001074 5074 FD740C          19      LD  (IY+12),H
001077 5077 F1              10      POP AF
001078 5078 C9              10      RET
                                
       5079                     GETSIZE:
001079 5079 FD7E10          19      LD  A,(IY+16)
00107C 507C FD6E11          19      LD  L,(IY+17)
00107F 507F FD6612          19      LD  H,(IY+18)
       5082                     SSQ1:
001082 5082 87               4      ADD A,A
001083 5083 ED6A            15      ADC HL,HL
001085 5085 B7               4      OR  A
001086 5086 C8              11      RET Z
001087 5087 23               6      INC HL
001088 5088 C9              10      RET
                                
       5089                     SET_FCB:
001089 5089 D5              11      PUSH    DE
00108A 508A FDE1            14      POP IY
00108C 508C FD7E1C          19      LD  A,(IY+28)
00108F 508F FEFF             7      CP  0FFH
001091 5091 201B            12      JR  NZ,POPAF_SCF_FF_RET
001093 5093 E5              11      PUSH    HL
001094 5094 FD6E1A          19      LD  L,(IY+26)
001097 5097 FD661B          19      LD  H,(IY+27)
00109A 509A 22CEF2          16      LD  (_CLPS),HL
00109D 509D FD7E1D          19      LD  A,(IY+29)
0010A0 50A0 32F1F2          13      LD  (_DIR_BANK),A
0010A3 50A3 FD6E1E          19      LD  L,(IY+30)
0010A6 50A6 FD661F          19      LD  H,(IY+31)
0010A9 50A9 22EFF2          16      LD  (DIRENT1),HL
0010AC 50AC E1              10      POP HL
0010AD 50AD C9              10      RET
                                
       50AE                     POPAF_SCF_FF_RET:
0010AE 50AE F1              10      POP AF
0010AF 50AF 37               4      SCF
0010B0 50B0 9F               4      SBC A,A
0010B1 50B1 C9              10      RET
                                
       50B2                     GET_DIR_DAT:
0010B2 50B2 2AF9F2          16      LD  HL,(_CDX)
0010B5 50B5 7C               4      LD  A,H
0010B6 50B6 B5               4      OR  L
0010B7 50B7 2035            12      JR  NZ,GET_SUBDIR
0010B9 50B9 CDCF50          17      CALL    GET_DIR_POS
0010BC 50BC C660             7      ADD A,high BANK1_ADR
0010BE 50BE 2E00             7      LD  L,0
0010C0 50C0 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_NORMAL32K_OR_ASCII16
                                #else
0010C1 50C1 CD8A4E          17      CALL    CHECK_DIR_PAGE
                                #endif
0010C4 50C4 3AC5F2          13      LD  A,(_BANK1)
0010C7 50C7 32F1F2          13      LD  (_DIR_BANK),A
                                
0010CA 50CA 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
0010CD 50CD 4F               4      LD  C,A
0010CE 50CE C9              10      RET
                                
       50CF                     GET_DIR_POS:                ;ルートディレクトリ
0010CF 50CF CD1856          17      CALL    GET_DISK_BANK_FDRV
0010D2 50D2 32C5F2          13      LD  (_BANK1),A
0010D5 50D5 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
0010D8 50D8 47               4      LD  B,A
0010D9 50D9 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
0010DC 50DC 4F               4      LD  C,A
0010DD 50DD 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       50E0                     GET_DIR_POS1:
0010E0 50E0 81               4      ADD A,C
0010E1 50E1 10FD            13      DJNZ    GET_DIR_POS1
                                
0010E3 50E3 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
0010E7 50E7 37               4      SCF     ;無限ループ回避
       50E8                     L_MDP:
0010E8 50E8 CB18             8      RR  B   ;->CF
0010EA 50EA D8              11      RET C
0010EB 50EB 87               4      ADD A,A
0010EC 50EC 18FA            12      JR  L_MDP
                                
       50EE                     GET_SUBDIR:             ;サブディレクトリ
0010EE 50EE CDFE4F          17      CALL    CLUST_HL
0010F1 50F1 EB               4      EX  DE,HL
0010F2 50F2 3AC4F2          13      LD  A,(_BANK)
0010F5 50F5 32F1F2          13      LD  (_DIR_BANK),A
0010F8 50F8 3AC7F2          13      LD  A,(CLSZ_H)
0010FB 50FB 87               4      ADD A,A     ;*2
0010FC 50FC 87               4      ADD A,A     ;*4
0010FD 50FD 87               4      ADD A,A     ;*8
0010FE 50FE 4F               4      LD  C,A
0010FF 50FF C9              10      RET
                                
       5100                     STATEMENT:
001100 5100 11C453          10      LD  DE,STR_CHDIR
001103 5103 CD5053          17      CALL    CPPROCNM
001106 5106 2812            12      JR  Z,_CHDIR
001108 5108 11CA53          10      LD  DE,STR_CHDRV
00110B 510B CD5053          17      CALL    CPPROCNM
00110E 510E 281C            12      JR  Z,_CHDRV
001110 5110 11D053          10      LD  DE,STR_RAMDISK
001113 5113 CD5053          17      CALL    CPPROCNM
001116 5116 2829            12      JR  Z,_RAMDISK
001118 5118 37               4      SCF
001119 5119 C9              10      RET
       511A                     _CHDIR:
00111A 511A 7E               7      LD  A,(HL)
00111B 511B FE28             7      CP  '('
00111D 511D 37               4      SCF
00111E 511E C0              11      RET NZ
00111F 511F CD6349          17      CALL    INIT_PARAM
001122 5122 CD594C          17      CALL    FILE_B
001125 5125 CD6C51          17      CALL    ROM_CD
001128 5128 D0              11      RET NC
001129 5129 C30A48          10      JP  ERROR_FILE_NOT_FOUND
                                
       512C                     _CHDRV:
00112C 512C 7E               7      LD  A,(HL)
00112D 512D FE28             7      CP  '('
00112F 512F 37               4      SCF
001130 5130 C0              11      RET NZ
001131 5131 CD6349          17      CALL    INIT_PARAM
001134 5134 E5              11      PUSH    HL
001135 5135 CD594C          17      CALL    FILE_B
001138 5138 E1              10      POP HL
001139 5139 23               6      INC HL
00113A 513A 3A00F3          13      LD  A,(FDRV)
00113D 513D 3D               4      DEC A
00113E 513E C35E59          10      JP  _SYS0EX1
                                
       5141                     _RAMDISK:
001141 5141 7E               7      LD  A,(HL)
001142 5142 FE28             7      CP  '('
001144 5144 37               4      SCF
001145 5145 C0              11      RET NZ
001146 5146 23               6      INC HL
001147 5147 DD212F54        14      LD  IX,FRMQNT
00114B 514B FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00114F 514F CD1C00          17      CALL    _CALSLT
001152 5152 E5              11      PUSH    HL
001153 5153 110F00          10      LD  DE,15       ;切り上げの為
001156 5156 19              11      ADD HL,DE
001157 5157 7D               4      LD  A,L
001158 5158 0604             7      LD  B,4     ;16で割る
       515A                     RAMDISK1:
00115A 515A CB3C             8      SRL H   ;/2
00115C 515C 1F               4      RRA
00115D 515D 10FB            13      DJNZ    RAMDISK1
00115F 515F FEFF             7      CP  0FFH
001161 5161 2001            12      JR  NZ,RAMDISK2
001163 5163 3D               4      DEC A
       5164                     RAMDISK2:
001164 5164 47               4      LD  B,A
001165 5165 CD975B          17      CALL    _SYS68
                                
001168 5168 E1              10      POP HL
001169 5169 23               6      INC HL
00116A 516A AF               4      XOR A
00116B 516B C9              10      RET
                                
       516C                     ROM_CD:
00116C 516C 3A01F3          13      LD  A,(FNAME)
00116F 516F FE20             7      CP  020H
001171 5171 2822            12      JR  Z,CD1
001173 5173 CDED4D          17      CALL    ROM_OPEN
001176 5176 D8              11      RET C
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
001177 5177 FD2AEFF2        20      LD  IY,(DIRENT1)
00117B 517B FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
00117F 517F CA0A48          10      JP  Z,ERROR_FILE_NOT_FOUND
001182 5182 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
001185 5185 FD661B          19      LD  H,(IY+01BH)
                                #endif
       5188                     CD2:
001188 5188 CDE555          17      CALL    SET_CD_FDRV
00118B 518B 2AF7F2          16      LD  HL,(PARAM1)
       518E                     CD_SKIP:
00118E 518E 7E               7      LD  A,(HL)
00118F 518F 23               6      INC HL
001190 5190 FE21             7      CP  021H
001192 5192 38FA            12      JR  C,CD_SKIP
001194 5194 C9              10      RET
       5195                     CD1:
001195 5195 2AF9F2          16      LD  HL,(_CDX)
001198 5198 18EE            12      JR  CD2
                                
       519A                     GET_BASIC_FCB:
00119A 519A D5              11      PUSH    DE
00119B 519B 23               6      INC HL  ;+1
00119C 519C 5E               7      LD  E,(HL)  ;FCB[1]
00119D 519D 23               6      INC HL  ;+2
00119E 519E 56               7      LD  D,(HL)  ;FCB[2]
00119F 519F 23               6      INC HL  ;+3
0011A0 51A0 ED53EFF2        20      LD  (DIRENT1),DE
                                            ;FCB[3] backup char
0011A4 51A4 23               6      INC HL  ;+4
                                            ;FCB[4]
0011A5 51A5 23               6      INC HL  ;+5
0011A6 51A6 7E               7      LD  A,(HL)  ;FCB[5]
0011A7 51A7 23               6      INC HL  ;+6
0011A8 51A8 32F1F2          13      LD  (_DIR_BANK),A
0011AB 51AB 5E               7      LD  E,(HL)  ;FCB[6]
0011AC 51AC 23               6      INC HL  ;+7
0011AD 51AD 56               7      LD  D,(HL)  ;FCB[7]
0011AE 51AE 23               6      INC HL  ;+8
0011AF 51AF ED53CAF2        20      LD  (RR_LOW),DE
0011B3 51B3 7E               7      LD  A,(HL)  ;FCB[8]
0011B4 51B4 23               6      INC HL  ;+9
0011B5 51B5 32CCF2          13      LD  (RR_HIGH),A
0011B8 51B8 22D4F2          16      LD  (_DTA),HL   ;FCB[9]
0011BB 51BB D1              10      POP DE
0011BC 51BC C9              10      RET
                                
       51BD                     SET_BASIC_FCB:
0011BD 51BD E5              11      PUSH    HL
0011BE 51BE 2A64F8          16      LD  HL,(PTRFIL)
0011C1 51C1 23               6      INC HL  ;+1
0011C2 51C2 D5              11      PUSH    DE
0011C3 51C3 ED5BEFF2        20      LD  DE,(DIRENT1)
0011C7 51C7 73               7      LD  (HL),E  ;FCB[1]
0011C8 51C8 23               6      INC HL  ;+2
0011C9 51C9 72               7      LD  (HL),D  ;FCB[2]
0011CA 51CA 23               6      INC HL  ;+3
0011CB 51CB 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
0011CC 51CC 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
0011CD 51CD 23               6      INC HL  ;+5
0011CE 51CE 3AF1F2          13      LD  A,(_DIR_BANK)
0011D1 51D1 77               7      LD  (HL),A  ;FCB[5]
0011D2 51D2 23               6      INC HL  ;+6
0011D3 51D3 ED5BCAF2        20      LD  DE,(RR_LOW)
0011D7 51D7 73               7      LD  (HL),E  ;FCB[6]
0011D8 51D8 23               6      INC HL  ;+7
0011D9 51D9 72               7      LD  (HL),D  ;FCB[7]
0011DA 51DA 23               6      INC HL  ;+8
0011DB 51DB 3ACCF2          13      LD  A,(RR_HIGH)
0011DE 51DE 77               7      LD  (HL),A  ;FCB[8]
0011DF 51DF D1              10      POP DE
0011E0 51E0 E1              10      POP HL
0011E1 51E1 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_18:BACKUP
                                ;in
                                ;   C : backup charactor
                                ;   HL: FBC pointer
                                ;out
       51E2                     DEVICE_18_BACKUP:
0011E2 51E2 D5              11      PUSH    DE
0011E3 51E3 E5              11      PUSH    HL
0011E4 51E4 110300          10      LD  DE,3
0011E7 51E7 19              11      ADD HL,DE
0011E8 51E8 71               7      LD  (HL),C
0011E9 51E9 E1              10      POP HL
0011EA 51EA D1              10      POP DE
0011EB 51EB C9              10      RET
                                
       51EC                     DEVICE_CHECK:
0011EC 51EC 3A8AFD          13      LD  A,(PROCNM+1)
0011EF 51EF B7               4      OR  A
0011F0 51F0 C8              11      RET Z
0011F1 51F1 11D853          10      LD  DE,STR_ROM
0011F4 51F4 CD5053          17      CALL    CPPROCNM
0011F7 51F7 2802            12      JR  Z,DEVICE_OK
0011F9 51F9 37               4      SCF
0011FA 51FA C9              10      RET
       51FB                     DEVICE_OK:
0011FB 51FB AF               4      XOR A
0011FC 51FC C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファ
                                
       51FD                     DEVICE_0_OPEN:
0011FD 51FD 7B               4      LD  A,E
0011FE 51FE FE02             7      CP  2       ;FOR OUTPUT
001200 5200 281B            12      JR  Z,OPEN2
001202 5202 D5              11      PUSH    DE
001203 5203 E5              11      push    hl
                                ;
001204 5204 3E01             7      LD  A,1     ;ドライブA
001206 5206 3200F3          13      LD  (FDRV),A
001209 5209 2166F8          10      LD  HL,FILNAM
00120C 520C 1101F3          10      LD  DE,FNAME
00120F 520F 010B00          10      LD  BC,8+3
001212 5212 CDAB5B          17      CALL    INIT_FILE1
001215 5215 CDED4D          17      CALL    ROM_OPEN
001218 5218 DA0A48          10      JP  C,ERROR_FILE_NOT_FOUND
00121B 521B E1              10      pop hl
00121C 521C D1              10      POP DE
       521D                     OPEN2:
00121D 521D 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
001220 5220 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
001221 5221 AF               4      XOR A
001222 5222 32F3F2          13      LD  (LEFTX),A
001225 5225 CDBD51          17      CALL    SET_BASIC_FCB
001228 5228 7B               4      ld  a,e
001229 5229 FE08             7      cp  8
00122B 522B 3F               4      ccf
00122C 522C C9              10      ret
                                
       522D                     DEVICE_2_CLOSE:
00122D 522D AF               4      XOR A
                                ;   LD  (HL),A
00122E 522E 6F               4      LD  L,A
00122F 522F 67               4      LD  H,A
001230 5230 2264F8          16      LD  (PTRFIL),HL
001233 5233 C9              10      RET
                                
       5234                     DEVICE_ENTRY:
001234 5234 FE08             7      CP  8
001236 5236 2826            12      JR  Z,DEVICE_8_SIN
001238 5238 3C               4      INC A
001239 5239 28B1            12      JR  Z,DEVICE_CHECK:
00123B 523B 3D               4      DEC A
00123C 523C 28BF            12      JR  Z,DEVICE_0_OPEN
00123E 523E FE0E             7      CP  14
001240 5240 2860            12      JR  Z,DEVICE_14_EOF
001242 5242 FE04             7      CP  4
001244 5244 2834            12      JR  Z,DEVICE_4_RANDOM
001246 5246 FE0A             7      CP  10
001248 5248 2850            12      JR  Z,DEVICE_10_LOC
00124A 524A FE0C             7      CP  12
00124C 524C 2878            12      JR  Z,DEVICE_12_LOF
00124E 524E FE02             7      CP  2
001250 5250 2890            12      JR  Z,DEVICE_18_BACKUP
001252 5252 FE02             7      CP  2
001254 5254 28D7            12      JR  Z,DEVICE_2_CLOSE
001256 5256 FE06             7      CP  6
001258 5258 2802            12      JR  Z,DEVICE_6_SOUT
00125A 525A 37               4      SCF
00125B 525B C9              10      RET
                                
       525C                     DEVICE_6_SOUT:
00125C 525C AF               4      XOR A
00125D 525D C9              10      RET
                                
       525E                     DEVICE_8_SIN:
00125E 525E CD9A51          17      CALL    GET_BASIC_FCB
001261 5261 210100          10      LD  HL,1
001264 5264 CDB84B          17      CALL    ROM_READ
001267 5267 7C               4      LD  A,H
001268 5268 B5               4      OR  L
001269 5269 280D            12      JR  Z,CCF_RET
00126B 526B 2AD4F2          16      LD  HL,(_DTA)
00126E 526E 7E               7      LD  A,(HL)
00126F 526F F5              11      PUSH    AF
001270 5270 CDBD51          17      CALL    SET_BASIC_FCB
001273 5273 F1              10      POP AF
001274 5274 FE0A             7      CP  00AH
001276 5276 C8              11      RET Z   ;ZF=separate
                                ;   CP  01AH
                                ;   JR  Z,SCF_RET
001277 5277 37               4      SCF     ;
       5278                     CCF_RET:
001278 5278 3F               4      CCF     ;ZF=0 CF=0にしたい
001279 5279 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_4:RANDOM
                                ;in
                                ;   A : 4
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
       527A                     DEVICE_4_RANDOM:
00127A 527A D5              11      PUSH    DE
00127B 527B CD9A51          17      CALL    GET_BASIC_FCB
00127E 527E DDE5            15      PUSH    IX
001280 5280 DD218A2F        14      LD  IX,FRCINT
001284 5284 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001288 5288 CDB0F2          17      CALL    CAL_MP
00128B 528B DDE1            14      POP IX
00128D 528D 2AF8F7          16      LD  HL,(DACDAT)
001290 5290 22CAF2          16      LD  (RR_LOW),HL
001293 5293 AF               4      XOR A
001294 5294 CDBD51          17      CALL    SET_BASIC_FCB
001297 5297 D1              10      POP DE
001298 5298 AF               4      XOR A
001299 5299 C9              10      RET
                                
                                ;FUNC_10:LOC
                                ;in
                                ;   A : 10
                                ;out
                                ;   DAC    : value of received bytes
                                ;   VALTYP : DAC type
       529A                     DEVICE_10_LOC:
00129A 529A CD9A51          17      CALL    GET_BASIC_FCB
00129D 529D 2ACAF2          16      LD  HL,(RR_LOW)
0012A0 52A0 183D            12      JR  RETURN_TYPE8_AHL
                                
                                ;--------------------------------------
                                ;FUNC_14:EOF
                                ;in
                                ;   A : 14
                                ;out
                                ;   DAC    : value of EOF value (EOF=-1)
                                ;   VALTYP : DAC type
       52A2                     DEVICE_14_EOF:
0012A2 52A2 CD9A51          17      CALL    GET_BASIC_FCB
0012A5 52A5 CDD74E          17      CALL    RBX1
0012A8 52A8 3810            12      JR  C,DEVICE_14_EOF1
0012AA 52AA 210100          10      LD  HL,1
0012AD 52AD CDB84B          17      CALL    ROM_READ
0012B0 52B0 2AD4F2          16      LD  HL,(_DTA)
0012B3 52B3 7E               7      LD  A,(HL)
0012B4 52B4 FE1A             7      CP  01AH
0012B6 52B6 37               4      SCF
0012B7 52B7 2801            12      JR  Z,DEVICE_14_EOF1
0012B9 52B9 3F               4      CCF
       52BA                     DEVICE_14_EOF1:
0012BA 52BA 9F               4      SBC A,A
0012BB 52BB 6F               4      LD  L,A
0012BC 52BC 67               4      LD  H,A
       52BD                     return_type2_hl:
0012BD 52BD 22F8F7          16      ld  (DACDAT),hl
0012C0 52C0 3E02             7      ld  a,2
0012C2 52C2 3263F6          13      ld  (VALTYP),a
0012C5 52C5 C9              10      ret
                                
                                ;--------------------------------------
                                ;FUNC_16:FPOS
                                ;in
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
                                ;   illegal function call
                                
                                ;--------------------------------------
                                ;FUNC_12:LOF
                                ;in
                                ;   A : 12
                                ;out
                                ;   DAC    : value of LOC+RSIQLN
                                ;   VALTYP : DAC type
       52C6                     DEVICE_12_LOF:
0012C6 52C6 CD9A51          17      CALL    GET_BASIC_FCB
                                
0012C9 52C9 3AF1F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001CH
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    CALL    RDSLT_ROM
                                    EX  DE,HL       ;AHL=File size
                                    POP DE
                                #else
0012CC 52CC 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0012CF 52CF 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0012D2 52D2 FD2AEFF2        20      LD  IY,(DIRENT1)
0012D6 52D6 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
0012D9 52D9 FD661D          19      LD  H,(IY+01DH)
0012DC 52DC FD7E1E          19      LD  A,(IY+01EH)
                                #endif
       52DF                     RETURN_TYPE8_AHL:
0012DF 52DF B7               4      OR  A
0012E0 52E0 2004            12      JR  NZ,RT8AHL1
0012E2 52E2 CB7C             8      BIT 7,H
0012E4 52E4 28D7            12      JR  Z,return_type2_hl
       52E6                     RT8AHL1:
0012E6 52E6 E5              11      PUSH    HL
0012E7 52E7 29              11      ADD HL,HL
0012E8 52E8 8F               4      ADC A,A
0012E9 52E9 32F8F7          13      LD  (DACDAT),A
0012EC 52EC 3E00             7      LD  A,0
0012EE 52EE 8F               4      ADC A,A
0012EF 52EF 32F9F7          13      LD  (DACDAT+1),A
                                
0012F2 52F2 3E02             7      LD  A,2
0012F4 52F4 3263F6          13      LD  (VALTYP),A
0012F7 52F7 DD213A30        14      LD  IX,FRCDBL
0012FB 52FB FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0012FF 52FF CDB0F2          17      CALL    CAL_MP
                                
001302 5302 214853          10      LD  HL,DBL32768
001305 5305 1147F8          10      LD  DE,ARG
001308 5308 010800          10      LD  BC,8
00130B 530B EDB0                    LDIR
                                
00130D 530D DD21E627        14      LD  IX,DECMUL
001311 5311 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001315 5315 CDB0F2          17      CALL    CAL_MP
                                
001318 5318 21F6F7          10      LD  HL,DAC
00131B 531B 1147F8          10      LD  DE,ARG
00131E 531E 010800          10      LD  BC,8
001321 5321 EDB0                    LDIR
                                
001323 5323 E1              10      POP HL
001324 5324 22F8F7          16      LD  (DACDAT),HL
                                
001327 5327 3E02             7      LD  A,2
001329 5329 3263F6          13      LD  (VALTYP),A
00132C 532C DD213A30        14      LD  IX,FRCDBL
001330 5330 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001334 5334 CDB0F2          17      CALL    CAL_MP
                                
001337 5337 DD219A26        14      LD  IX,DECADD
00133B 533B FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00133F 533F CDB0F2          17      CALL    CAL_MP
                                
001342 5342 3E08             7      LD  A,8
001344 5344 3263F6          13      LD  (VALTYP),A
001347 5347 C9              10      RET
                                
       5348                     DBL32768:
001348 5348 4532768000000000        DB  045H,032H,076H,080H,0,0,0,0
                                
       5350                     CPPROCNM:
001350 5350 E5              11      PUSH    HL
001351 5351 2189FD          10      LD  HL,PROCNM
       5354                     CPPROCNM1:
001354 5354 1A               7      LD  A,(DE)
001355 5355 13               6      INC DE
001356 5356 BE               7      CP  (HL)
001357 5357 23               6      INC HL
001358 5358 2003            12      JR  NZ,CPPROCNM2
00135A 535A B7               4      OR  A
00135B 535B 20F7            12      JR  NZ,CPPROCNM1
       535D                     CPPROCNM2:
00135D 535D E1              10      POP HL
00135E 535E C9              10      RET
                                
       535F                     ROM_MKI:
00135F 535F 3A63F6          13      LD  A,(VALTYP)
001362 5362 FE02             7      CP  2
001364 5364 37               4      SCF
001365 5365 C0              11      RET NZ
001366 5366 2AF8F7          16      LD  HL,(DACDAT)
001369 5369 2261F5          16      LD  (BUF+3),HL
00136C 536C 325EF5          13      LD  (BUF),A
00136F 536F 2161F5          10      LD  HL,BUF+3
001372 5372 225FF5          16      LD  (BUF+1),HL
001375 5375 215EF5          10      LD  HL,BUF
001378 5378 22F8F7          16      LD  (DACDAT),HL
00137B 537B 3E03             7      LD  A,3
00137D 537D 3263F6          13      LD  (VALTYP),A
001380 5380 A7               4      AND A
001381 5381 C9              10      RET
                                
       5382                     ROM_CVI:
001382 5382 3A63F6          13      LD  A,(VALTYP)
001385 5385 FE03             7      CP  3
001387 5387 37               4      SCF
001388 5388 C0              11      RET NZ
001389 5389 2AF8F7          16      LD  HL,(DACDAT)
00138C 538C 23               6      INC HL
00138D 538D 5E               7      LD  E,(HL)
00138E 538E 23               6      INC HL
00138F 538F 56               7      LD  D,(HL)
001390 5390 EB               4      EX  DE,HL
001391 5391 5E               7      LD  E,(HL)
001392 5392 23               6      INC HL
001393 5393 56               7      LD  D,(HL)
001394 5394 D5              11      PUSH    DE
001395 5395 DD21D067        14      LD  IX,FRESTR
001399 5399 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00139D 539D CD1C00          17      CALL    _CALSLT
0013A0 53A0 E1              10      POP HL
0013A1 53A1 22F8F7          16      LD  (DACDAT),HL
0013A4 53A4 3E02             7      LD  A,2
0013A6 53A6 3263F6          13      LD  (VALTYP),A
0013A9 53A9 A7               4      AND A
0013AA 53AA C9              10      RET
       53AB                     ROM_DSKF:
0013AB 53AB 3A63F6          13      LD  A,(VALTYP)
0013AE 53AE FE02             7      CP  2
0013B0 53B0 37               4      SCF
0013B1 53B1 C0              11      RET NZ
0013B2 53B2 AF               4      XOR A
0013B3 53B3 6F               4      LD  L,A
0013B4 53B4 67               4      LD  H,A
0013B5 53B5 22F8F7          16      LD  (DACDAT),HL
0013B8 53B8 C9              10      RET
                                
       53B9                     WILDCARD:
0013B9 53B9 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       53C4                     STR_CHDIR:
0013C4 53C4 434844495200            DB  "CHDIR",0
       53CA                     STR_CHDRV:
0013CA 53CA 434844525600            DB  "CHDRV",0
       53D0                     STR_RAMDISK:
0013D0 53D0 52414D4449534B00        DB  "RAMDISK",0
       53D8                     STR_ROM:
0013D8 53D8 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       53DC                     ERROR_WRITE_PROTECTED:
0013DC 53DC 3E00             7      LD  A,0     ;Write protected
0013DE 53DE C9              10      RET
       53DF                     ERROR_NOT_READY:
0013DF 53DF F1              10      POP AF
0013E0 53E0 37               4      SCF
0013E1 53E1 3E02             7      LD  A,2     ;Not ready
0013E3 53E3 C9              10      RET
       53E4                     DISKIO:
0013E4 53E4 38F6            12      JR  C,ERROR_WRITE_PROTECTED
0013E6 53E6 48               4      LD  C,B
0013E7 53E7 CD1B56          17      CALL    GET_DISK_BANK
0013EA 53EA F5              11      PUSH    AF
0013EB 53EB 3AC9F2          13      LD  A,(SECSZ_H)
0013EE 53EE B7               4      OR  A
0013EF 53EF 28EE            12      JR  Z,ERROR_NOT_READY
0013F1 53F1 F1              10      POP AF
       53F2                     SETMAP1:
0013F2 53F2 E5              11      PUSH    HL
       53F3                     DISKIO1:
0013F3 53F3 C5              11      PUSH    BC      ;B=残りのセクタ数
0013F4 53F4 D5              11      PUSH    DE      ;DE=セクタ番号
0013F5 53F5 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
0013F6 53F6 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
0013F7 53F7 F5              11      PUSH    AF
0013F8 53F8 3AC9F2          13      LD  A,(SECSZ_H)
0013FB 53FB CD4156          17      CALL    MUL_AHL
0013FE 53FE F1              10      POP AF
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    LD  A,L
                                    PUSH    BC
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    POP BC
                                    JR  NC,DISKIO2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
0013FF 53FF 4D               4      LD  C,L     ;C=読み出し元
001400 5400 29              11      ADD HL,HL       ;64KB→32KB
001401 5401 29              11      ADD HL,HL       ;32KB→16KB
001402 5402 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
001403 5403 84               4      ADD A,H
001404 5404 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
001407 5407 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
00140A 540A 32C4F2          13      LD  (_BANK),A
00140D 540D 79               4      LD  A,C     ;C=読み出し元
00140E 540E E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       5410                     DISKIO2:
001410 5410 C660             7      ADD A,high BANK1_ADR
001412 5412 67               4      LD  H,A
001413 5413 ED4BC8F2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
001417 5417 69               4      LD  L,C     ;C=0
001418 5418 CDCA45          17      CALL    ROM_LDIR
00141B 541B EB               4      EX  DE,HL
00141C 541C F1              10      POP AF
00141D 541D D1              10      POP DE
00141E 541E 13               6      INC DE
00141F 541F C1              10      POP BC
001420 5420 10D1            13      DJNZ    DISKIO1
001422 5422 41               4      LD  B,C
                                
001423 5423 E1              10      POP HL
001424 5424 AF               4      XOR A
001425 5425 C9              10      RET
                                
       5426                     DSKCHG:
001426 5426 CD5F54          17      CALL    IS_BPB
001429 5429 3824            12      JR  C,NOTREADY
00142B 542B 3A23FB          13      LD  A,(DRVTBL+2)
00142E 542E B7               4      OR  A
00142F 542F 201A            12      JR  NZ,DSKCHG1
001431 5431 3A21FB          13      LD  A,(DRVTBL)
001434 5434 FE02             7      CP  2
001436 5436 2013            12      JR  NZ,DSKCHG1
001438 5438 CD5F54          17      CALL    IS_BPB
00143B 543B 300E            12      JR  NC,DSKCHG1
00143D 543D 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
00143F 543F 3221FB          13      LD  (DRVTBL),A
001442 5442 3223FB          13      LD  (DRVTBL+2),A
001445 5445 3A48F3          13      LD  A,(MASTERS)
001448 5448 3224FB          13      LD  (DRVTBL+3),A
       544B                     DSKCHG1:
00144B 544B AF               4      XOR A
00144C 544C 0601             7      LD  B,1
00144E 544E C9              10      RET
       544F                     NOTREADY:
00144F 544F 3E02             7      LD  A,2
001451 5451 37               4      SCF
001452 5452 C9              10      RET
                                
       5453                     NO_BPB:
001453 5453 E1              10      POP HL
001454 5454 23               6      INC HL
001455 5455 114756          10      LD  DE,DPB2DD
001458 5458 011200          10      LD  BC,DPB2DD_E-DPB2DD
00145B 545B EDB0                    LDIR
00145D 545D AF               4      XOR A
00145E 545E C9              10      RET
                                
       545F                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
00145F 545F CD1B56          17      CALL    GET_DISK_BANK
                                
001462 5462 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
001465 5465 FE01             7      CP  1
001467 5467 D8              11      RET C
                                
001468 5468 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
00146B 546B C6FF             7      ADD A,0FFH
00146D 546D D8              11      RET C
                                
00146E 546E 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       5471                     IS_BPB1:
001471 5471 FE01             7      CP  1
001473 5473 C8              11      RET Z
001474 5474 FE02             7      CP  2
001476 5476 C8              11      RET Z
001477 5477 FE04             7      CP  4
001479 5479 C8              11      RET Z
00147A 547A 37               4      SCF
00147B 547B C9              10      RET
                                
       547C                     GETDPB:
00147C 547C E5              11      PUSH    HL
00147D 547D CD1B56          17      CALL    GET_DISK_BANK
                                
001480 5480 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
001483 5483 B7               4      OR  A
001484 5484 28CD            12      JR  Z,NO_BPB
001486 5486 DDE1            14      POP IX
001488 5488 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
00148B 548B 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
00148E 548E DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
001491 5491 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
001494 5494 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
001497 5497 87               4      ADD A,A
001498 5498 87               4      ADD A,A
001499 5499 87               4      ADD A,A
00149A 549A 3D               4      DEC A
00149B 549B DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
00149E 549E 06FF             7      LD  B,-1
0014A0 54A0 A7               4      AND A           ;無限ループ阻止
       54A1                     GETDPB1:
0014A1 54A1 04               4      INC B
0014A2 54A2 1F               4      RRA
0014A3 54A3 38FC            12      JR  C,GETDPB1
0014A5 54A5 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
0014A8 54A8 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0014AB 54AB 3D               4      DEC A
0014AC 54AC DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
0014AF 54AF A7               4      AND A           ;無限ループ阻止
0014B0 54B0 06FF             7      LD  B,-1
       54B2                     GETDPB2:
0014B2 54B2 04               4      INC B
0014B3 54B3 1F               4      RRA
0014B4 54B4 38FC            12      JR  C,GETDPB2
0014B6 54B6 04               4      INC B
0014B7 54B7 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
0014BA 54BA 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt
0014BD 54BD DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
0014C0 54C0 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
0014C3 54C3 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
0014C6 54C6 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
0014C9 54C9 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
0014CC 54CC DD770B          19      LD  (IX+11),A       ;MAXENT
                                
0014CF 54CF ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16
0014D3 54D3 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
0014D6 54D6 DD460A          19      LD  B,(IX+10)       ;FATCNT
0014D9 54D9 210000          10      LD  HL,0
       54DC                     GETDPB3:
0014DC 54DC 19              11      ADD HL,DE
0014DD 54DD 10FD            13      DJNZ    GETDPB3
       54DF                     GETDPB4:
0014DF 54DF DD5E08          19      LD  E,(IX+8)        ;FIRFAT
0014E2 54E2 DD5609          19      LD  D,(IX+9)        ;FIRFAT
0014E5 54E5 19              11      ADD HL,DE
0014E6 54E6 DD7511          19      LD  (IX+17),L       ;FIRDIR
0014E9 54E9 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
0014EC 54EC DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0014EF 54EF 87               4      ADD A,A
0014F0 54F0 87               4      ADD A,A
0014F1 54F1 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       54F4                     GETDPB5:
0014F4 54F4 CB3B             8      SRL E
0014F6 54F6 1F               4      RRA
0014F7 54F7 30FB            12      JR  NC,GETDPB5
0014F9 54F9 1600             7      LD  D,0
0014FB 54FB 19              11      ADD HL,DE
0014FC 54FC DD750C          19      LD  (IX+12),L       ;FIRREC
0014FF 54FF DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001502 5502 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16
                                
001505 5505 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
001508 5508 DD560D          19      LD  D,(IX+13)       ;FIRREC
00150B 550B A7               4      AND A
00150C 550C ED52            15      SBC HL,DE
                                
00150E 550E DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
001511 5511 3C               4      INC A
001512 5512 37               4      SCF             ;無限ループ阻止
       5513                     GETDPB6:
001513 5513 1F               4      RRA
001514 5514 3806            12      JR  C,GETDPB7
001516 5516 CB3C             8      SRL H
001518 5518 CB1D             8      RR  L
00151A 551A 18F7            12      JR  GETDPB6
       551C                     GETDPB7:
00151C 551C 23               6      INC HL
00151D 551D DD750E          19      LD  (IX+14),L       ;MAXCLUS
001520 5520 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       5523                     GETDPBD1:
001523 5523 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001526 5526 E6FC             7      AND 0FCH
001528 5528 C8              11      RET Z
                                
001529 5529 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
00152D 552D 37               4      SCF
00152E 552E DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
001532 5532 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
001535 5535 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
001539 5539 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
00153D 553D DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
001541 5541 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
001545 5545 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
001549 5549 DDCB1126        23      SLA (IX+17)         ;FIRDIR
00154D 554D DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
001551 5551 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
001554 5554 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
001557 5557 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
00155A 555A 87               4      ADD A,A
00155B 555B 87               4      ADD A,A
00155C 555C DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       555F                     GETDPBD5:
00155F 555F CB3B             8      SRL E
001561 5561 1F               4      RRA
001562 5562 30FB            12      JR  NC,GETDPBD5
001564 5564 1600             7      LD  D,0
001566 5566 19              11      ADD HL,DE
001567 5567 DD750C          19      LD  (IX+12),L       ;FIRREC
00156A 556A DD740D          19      LD  (IX+13),H       ;FIRREC
                                
00156D 556D 18B4            12      JR  GETDPBD1
                                
       556F                     CHOICE:
00156F 556F 210000          10      LD  HL,0
001572 5572 C9              10      RET
                                
       5573                     DSKFMT:
001573 5573 AF               4      XOR A
001574 5574 37               4      SCF
       5575                     DSKSTP:
001575 5575 C9              10      RET
                                
       5576                     BASENT:
001576 5576 3E                      DB  03EH
001577 5577 F7              12      RST 30H
001578 5578 32DBFD          13      LD  (H_PINL),A
00157B 557B 3A48F3          13      LD  A,(MASTERS)
00157E 557E 32DCFD          13      LD  (H_PINL+1),A
001581 5581 219D55          10      LD  HL,BOOT_BASIC
001584 5584 22DDFD          16      LD  (H_PINL+2),HL
001587 5587 3E                      DB  03EH
001588 5588 C9              10      RET
001589 5589 32DFFD          13      LD  (H_PINL+4),A
                                
                                #if exists _RAM64K
00158C 558C 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
00158F 558F CD615C          17      CALL    ENASLT_00H
                                #endif
                                    ;BASICを起動する
001592 5592 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
001596 5596 DD21177D        14      LD  IX,ST_BAS   ;continue start of MSX-BASIC without executing BASIC programs in ROM
00159A 559A C35901          10      JP  CALBAS
                                
       559D                     BOOT_BASIC:
00159D 559D 3E                      DB  03EH
00159E 559E C9              10      RET
00159F 559F 32DBFD          13      LD  (H_PINL),A
                                
0015A2 55A2 2A74F6          16      LD  HL,(STKTOP)
0015A5 55A5 3A40F3          13      LD  A,(REBOOT)
0015A8 55A8 C6FF             7      ADD A,0FFH
0015AA 55AA 3811            12      JR  C,REBOOT1
0015AC 55AC 215956          10      LD  HL,AUTOEXEC
0015AF 55AF 1100F3          10      LD  DE,FDRV
0015B2 55B2 010C00          10      LD  BC,1+8+3
0015B5 55B5 EDB0                    LDIR
0015B7 55B7 CDED4D          17      CALL    ROM_OPEN
0015BA 55BA D45447          17      CALL    NC,ROM_LOAD1
       55BD                     REBOOT1:
0015BD 55BD 217056          10      LD  HL,DELOK
0015C0 55C0 CD9245          17      CALL    MSX
0015C3 55C3 216556          10      LD  HL,CMD_RUN
0015C6 55C6 111FF4          10      LD  DE,KBUF
0015C9 55C9 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
0015CC 55CC D5              11      PUSH    DE
0015CD 55CD EDB0                    LDIR
0015CF 55CF 3004            12      JR  NC,REBOOT2
0015D1 55D1 AF               4      XOR A
0015D2 55D2 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       55D5                     REBOOT2:
0015D5 55D5 E1              10      POP HL
0015D6 55D6 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0015DA 55DA DD210146        14      LD  IX,NEWSTT
0015DE 55DE C31C00          10      JP  _CALSLT
                                
       55E1                     GETSLT:
0015E1 55E1 3A22FB          13      LD  A,(DRVTBL+1)
0015E4 55E4 C9              10      RET
                                
       55E5                     SET_CD_FDRV:
0015E5 55E5 3A00F3          13      LD  A,(FDRV)
0015E8 55E8 CD0756          17      CALL    GET_DRIVE
0015EB 55EB FE01             7      CP  1
0015ED 55ED 2804            12      JR  Z,SET_CD_B
0015EF 55EF 22EBF2          16      LD  (_CD_A),HL
0015F2 55F2 C9              10      RET
       55F3                     SET_CD_B:
0015F3 55F3 22EDF2          16      LD  (_CD_B),HL
0015F6 55F6 C9              10      RET
                                
       55F7                     GET_CD_CDRV:
0015F7 55F7 CD0756          17      CALL    GET_DRIVE
       55FA                     GET_CD:
0015FA 55FA FE01             7      CP  1
0015FC 55FC 2AEBF2          16      LD  HL,(_CD_A)
0015FF 55FF C0              11      RET NZ
001600 5600 2AEDF2          16      LD  HL,(_CD_B)
001603 5603 C9              10      RET
                                
       5604                     GET_DRIVE_FDRV:
001604 5604 3A00F3          13      LD  A,(FDRV)
       5607                     GET_DRIVE:
001607 5607 D601             7      SUB 1
001609 5609 D0              11      RET NC
00160A 560A 3AEAF2          13      LD  A,(_DVSW)
00160D 560D C9              10      RET
                                
       560E                     GET_DISK_BANK_H:
00160E 560E 3AF2F2          13      LD  A,(_LVECTOR)
001611 5611 E680             7      AND 080H
001613 5613 87               4      ADD A,A
001614 5614 380A            12      JR  C,SET_DISK_BANK_A
001616 5616 180F            12      JR  SET_DISK_BANK
       5618                     GET_DISK_BANK_FDRV:
001618 5618 CD0456          17      CALL    GET_DRIVE_FDRV
       561B                     GET_DISK_BANK:
00161B 561B FE07             7      CP  7       ;H:
00161D 561D 28EF            12      JR  Z,GET_DISK_BANK_H
00161F 561F B7               4      OR  A       ;A=DRIVE
       5620                     SET_DISK_BANK_A:
001620 5620 3E01             7      LD  A,DISK_BANK
001622 5622 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
001624 5624 3AE9F2          13      LD  A,(B_DRIVE)
                                #endif
       5627                     SET_DISK_BANK:
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
001627 5627 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
00162A 562A 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
00162D 562D F5              11      PUSH    AF
00162E 562E E5              11      PUSH    HL
00162F 562F 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec
001632 5632 22C8F2          16      LD  (SECSZ),HL
001635 5635 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
001638 5638 CD4156          17      CALL    MUL_AHL
00163B 563B 22C6F2          16      LD  (CLSZ),HL
00163E 563E E1              10      POP HL
00163F 563F F1              10      POP AF
001640 5640 C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       5641                     MUL_AHL:
001641 5641 37               4      SCF     ;無限ループ回避
       5642                     MUL_AHL1:
001642 5642 1F               4      RRA     ;->CF
001643 5643 D8              11      RET C
001644 5644 29              11      ADD HL,HL
001645 5645 18FB            12      JR  MUL_AHL1
                                
       5647                     DPB2DD:
001647 5647 F9                      DB  0F9H    ;MEDIA
001648 5648 0002                    DW  00200H  ;SECSIZ
00164A 564A 0F                      DB  00FH    ;DIRMSK
00164B 564B 04                      DB  004H    ;DIRSHFT
00164C 564C 01                      DB  001H    ;CLUSMSK
00164D 564D 02                      DB  002H    ;CLUSSHFT
00164E 564E 0100                    DW  00001H  ;FIRFAT
001650 5650 02                      DB  002H    ;FATCNT
001651 5651 70                      DB  070H    ;MAXENT
001652 5652 0E00                    DW  0000EH  ;FIRREC
001654 5654 CA02                    DW  002CAH  ;MAXCLUS
001656 5656 03                      DB  003H    ;FATSIZ
001657 5657 0700                    DW  0007H   ;FIRDIR
       5659                     DPB2DD_E:
                                
       5659                     AUTOEXEC:
001659 5659 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       5665                     CMD_RUN:
001665 5665 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
00166B 566B 40EF                    DW  NEW_HIMEM
       566D                     CMD_CLEAR_E:
00166D 566D 3A8A00                  DB  03AH,08AH,0         ;RUN
       5670                     CMD_RUN_E:
       5670                     DELOK:
001670 5670 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       5674                     _ERROR:
001674 5674 AF               4      XOR A
001675 5675 47               4      LD  B,A
001676 5676 C9              10      RET
                                
       5677                     ROM_BDOS:
001677 5677 E5              11      PUSH    HL
001678 5678 79               4      LD  A,C
001679 5679 87               4      ADD A,A
00167A 567A 38F8            12      JR  C,_ERROR
00167C 567C 6F               4      LD  L,A
00167D 567D 2642             7      LD  H,high STABLE
00167F 567F 7E               7      LD  A,(HL)
001680 5680 2C               4      INC L
001681 5681 66               7      LD  H,(HL)
001682 5682 6F               4      LD  L,A
001683 5683 E3              19      EX  (SP),HL
001684 5684 79               4      LD  A,C
001685 5685 C9              10      RET
                                
       5686                     _PRINT:
       5686                     PRINT:
001686 5686 7B               4      LD  A,E
001687 5687 1803            12      JR  MSG_A
                                
       5689                     _SYS01:     ;(BDOS)コンソール入力
001689 5689 CD0E57          17      CALL    _SYS07
       568C                     MSG_A:
00168C 568C FE03             7      CP  3
00168E 568E 2814            12      JR  Z,MSG_BR
       5690                     MSGA1:
001690 5690 F5              11      PUSH    AF
001691 5691 C5              11      PUSH    BC
001692 5692 D5              11      PUSH    DE
001693 5693 E5              11      PUSH    HL
001694 5694 DDE5            15      PUSH    IX
001696 5696 DD21A200        14      LD  IX,CHPUT
00169A 569A CD7345          17      CALL    CALSLT_R
00169D 569D DDE1            14      POP IX
00169F 569F E1              10      POP HL
0016A0 56A0 D1              10      POP DE
0016A1 56A1 C1              10      POP BC
       56A2                     MSGA2:
0016A2 56A2 F1              10      POP AF
0016A3 56A3 C9              10      RET
       56A4                     MSG_BR:
0016A4 56A4 F5              11      PUSH    AF
0016A5 56A5 3ADDF3          13      LD  A,(CSRX)
0016A8 56A8 FE02             7      CP  2
0016AA 56AA 38F6            12      JR  C,MSGA2
0016AC 56AC F1              10      POP AF
       56AD                     MSG_CR:
0016AD 56AD F5              11      PUSH    AF
0016AE 56AE 3E0D             7      LD  A,00DH
0016B0 56B0 CD9056          17      CALL    MSGA1
0016B3 56B3 3E0A             7      LD  A,00AH
0016B5 56B5 CD9056          17      CALL    MSGA1
0016B8 56B8 F1              10      POP AF
0016B9 56B9 C9              10      RET
                                
       56BA                     _SYS02:     ;(BDOS)コンソール出力
0016BA 56BA CDD556          17      CALL    BREAK
0016BD 56BD 1805            12      JR  PRINTX
                                
       56BF                     _SYS06:     ;(BDOS)コンソール直接入出力
0016BF 56BF 7B               4      LD  A,E
0016C0 56C0 3C               4      INC A
0016C1 56C1 CA5457          10      JP  Z,_INKEY
       56C4                     PRINTX:
0016C4 56C4 C38656          10      JP  _PRINT
                                
       56C7                     _SYS08:     ;(BDOS)エコーなしコンソール入力
0016C7 56C7 CD0E57          17      CALL    _SYS07
0016CA 56CA FE03             7      CP  3
0016CC 56CC CCD556          17      CALL    Z,_BREAK
0016CF 56CF FE13             7      CP  013H        ;CTRL+S
0016D1 56D1 C0              11      RET NZ
       56D2                     PAUSE:
0016D2 56D2 CDEC56          17      CALL    KEYBC
                                
       56D5                     _BREAK:
       56D5                     BREAK:
0016D5 56D5 F5              11      PUSH    AF
0016D6 56D6 C5              11      PUSH    BC
0016D7 56D7 D5              11      PUSH    DE
0016D8 56D8 E5              11      PUSH    HL
0016D9 56D9 DDE5            15      PUSH    IX
0016DB 56DB DD21B700        14      LD  IX,BREAKX
0016DF 56DF CD7345          17      CALL    CALSLT_R
0016E2 56E2 DDE1            14      POP IX
0016E4 56E4 E1              10      POP HL
0016E5 56E5 D1              10      POP DE
0016E6 56E6 C1              10      POP BC
0016E7 56E7 DCD556          17      CALL    C,_BREAK
0016EA 56EA F1              10      POP AF
0016EB 56EB C9              10      RET
       56EC                     KEYBC:
0016EC 56EC F5              11      PUSH    AF
0016ED 56ED C5              11      PUSH    BC
0016EE 56EE D5              11      PUSH    DE
0016EF 56EF E5              11      PUSH    HL
0016F0 56F0 DDE5            15      PUSH    IX
0016F2 56F2 DD215601        14      LD  IX,KILBUF
0016F6 56F6 CD7345          17      CALL    CALSLT_R
0016F9 56F9 DDE1            14      POP IX
0016FB 56FB E1              10      POP HL
0016FC 56FC D1              10      POP DE
0016FD 56FD C1              10      POP BC
0016FE 56FE F1              10      POP AF
0016FF 56FF C9              10      RET
                                
       5700                     _SYS09:     ;(BDOS)文字列出力
001700 5700 D5              11      PUSH    DE
       5701                     _SX09:
001701 5701 1A               7      LD  A,(DE)
001702 5702 13               6      INC DE
001703 5703 FE24             7      CP  '$'
001705 5705 2805            12      JR  Z,POPDE_RET
001707 5707 CD8C56          17      CALL    MSG_A
00170A 570A 18F5            12      JR  _SX09
       570C                     POPDE_RET:
00170C 570C D1              10      POP DE
00170D 570D C9              10      RET
                                
       570E                     _SYS07:
       570E                     FLGET:
00170E 570E C5              11      PUSH    BC
00170F 570F D5              11      PUSH    DE
001710 5710 E5              11      PUSH    HL
001711 5711 DDE5            15      PUSH    IX
001713 5713 3A0CF3          13      LD  A,(IS_BIOS)
001716 5716 B7               4      OR  A
001717 5717 2018            12      JR  NZ,FLGET_G1
                                
001719 5719 CD3859          17      CALL    GETVRAM
00171C 571C E5              11      PUSH    HL
00171D 571D DD214A00        14      LD  IX,RDVRM
001721 5721 CD7345          17      CALL    CALSLT_R
001724 5724 E1              10      POP HL
001725 5725 F5              11      PUSH    AF
001726 5726 E5              11      PUSH    HL
001727 5727 3EFF             7      LD  A,0FFH
001729 5729 DD214D00        14      LD  IX,WRTVRM
00172D 572D CD7345          17      CALL    CALSLT_R
001730 5730 E1              10      POP HL
       5731                     FLGET_G1:
001731 5731 E5              11      PUSH    HL
001732 5732 DD219F00        14      LD  IX,CHGET
001736 5736 CD7345          17      CALL    CALSLT_R
001739 5739 67               4      LD  H,A
00173A 573A E3              19      EX  (SP),HL
00173B 573B 3A0CF3          13      LD  A,(IS_BIOS)
00173E 573E B7               4      OR  A
00173F 573F 200A            12      JR  NZ,FLGET_G2
001741 5741 C1              10      POP BC
001742 5742 F1              10      POP AF
001743 5743 C5              11      PUSH    BC
001744 5744 DD214D00        14      LD  IX,WRTVRM
001748 5748 CD7345          17      CALL    CALSLT_R
       574B                     FLGET_G2:
00174B 574B F1              10      POP AF
00174C 574C DDE1            14      POP IX
00174E 574E E1              10      POP HL
00174F 574F D1              10      POP DE
001750 5750 C1              10      POP BC
001751 5751 FE03             7      CP  3
001753 5753 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       5754                     _INKEY:
       5754                     INKEY:
001754 5754 CD3158          17      CALL    CPM_CONST
001757 5757 C8              11      RET Z
001758 5758 18B4            12      JR  FLGET
                                
       575A                     _SYS0A:     ;(BDOS)文字列入力
00175A 575A C5              11      PUSH    BC
00175B 575B E5              11      PUSH    HL
00175C 575C D5              11      PUSH    DE
                                
00175D 575D 3A0CF3          13      LD  A,(IS_BIOS)
001760 5760 B7               4      OR  A
001761 5761 2824            12      JR  Z,SX0A_CBIOS
001763 5763 3ADDF3          13      LD  A,(CSRX)
001766 5766 5F               4      LD  E,A
001767 5767 1600             7      LD  D,0
001769 5769 D5              11      PUSH    DE
00176A 576A DDE5            15      PUSH    IX
00176C 576C DD21AE00        14      LD  IX,PLININ
001770 5770 CD7345          17      CALL    CALSLT_R
001773 5773 DDE1            14      POP IX
001775 5775 D1              10      POP DE
001776 5776 215DF5          10      LD  HL,BUF-1
001779 5779 F5              11      PUSH    AF
00177A 577A 19              11      ADD HL,DE
00177B 577B F1              10      POP AF
00177C 577C EB               4      EX  DE,HL
00177D 577D E1              10      POP HL
00177E 577E E5              11      PUSH    HL
00177F 577F 0E00             7      LD  C,0
001781 5781 3014            12      JR  NC,SAX0
001783 5783 23               6      INC HL
001784 5784 23               6      INC HL
001785 5785 1818            12      JR  SAX4
       5787                     SX0A_CBIOS:
001787 5787 CDB557          17      CALL    GETL
00178A 578A 111FF4          10      LD  DE,KBUF
00178D 578D E1              10      POP HL
00178E 578E E5              11      PUSH    HL
00178F 578F 0E00             7      LD  C,0
001791 5791 3004            12      JR  NC,SAX0
001793 5793 23               6      INC HL
001794 5794 23               6      INC HL
001795 5795 1808            12      JR  SAX4
       5797                     SAX0:
001797 5797 46               7      LD  B,(HL)
001798 5798 23               6      INC HL
       5799                     SAX1:
001799 5799 23               6      INC HL
00179A 579A 1A               7      LD  A,(DE)
00179B 579B 13               6      INC DE
00179C 579C B7               4      OR  A
00179D 579D 2004            12      JR  NZ,SAX2
       579F                     SAX4:
00179F 579F 360D            10      LD  (HL),00DH
0017A1 57A1 1804            12      JR  SAX3
       57A3                     SAX2:
0017A3 57A3 77               7      LD  (HL),A
0017A4 57A4 0C               4      INC C
0017A5 57A5 10F2            13      DJNZ    SAX1
       57A7                     SAX3:
0017A7 57A7 D1              10      POP DE
0017A8 57A8 79               4      LD  A,C
0017A9 57A9 13               6      INC DE
0017AA 57AA 12               7      LD  (DE),A
0017AB 57AB 1B               6      DEC DE
0017AC 57AC E1              10      POP HL
0017AD 57AD C1              10      POP BC
0017AE 57AE 3E1E             7      LD  A,01EH
0017B0 57B0 CD8C56          17      CALL    MSG_A
0017B3 57B3 AF               4      XOR A
0017B4 57B4 C9              10      RET
                                ;           ;C-BIOSはPLININが意図通りに動作しないので
       57B5                     GETL:
0017B5 57B5 DDE5            15      PUSH    IX
0017B7 57B7 FDE5            15      PUSH    IY
                                
0017B9 57B9 3AAFFC          13      LD  A,(SCRMOD)
0017BC 57BC B7               4      OR  A
0017BD 57BD 280E            12      JR  Z,GETL0
0017BF 57BF DD216C00        14      LD  IX,INITXT
0017C3 57C3 CD7345          17      CALL    CALSLT_R
0017C6 57C6 DD217800        14      LD  IX,SETTXT
0017CA 57CA CD7345          17      CALL    CALSLT_R
       57CD                     GETL0:
0017CD 57CD 2ADCF3          16      LD  HL,(CSRY)
0017D0 57D0 22CAFB          16      LD  (FSTPOS),HL
       57D3                     GETL1:
0017D3 57D3 CDC756          17      CALL    _SYS08
0017D6 57D6 FE09             7      CP  9
0017D8 57D8 2008            12      JR  NZ,GETL1V
0017DA 57DA 211FF4          10      LD  HL,KBUF
0017DD 57DD CD9245          17      CALL    MSX
0017E0 57E0 18F1            12      JR  GETL1
       57E2                     GETL1V:
0017E2 57E2 5F               4      LD  E,A
0017E3 57E3 FE08             7      CP  8
0017E5 57E5 CCDE58          17      CALL    Z,CTRL02
0017E8 57E8 FE20             7      CP  020H
0017EA 57EA D40A59          17      CALL    NC,INSERT
0017ED 57ED CD9056          17      CALL    MSGA1
                                
0017F0 57F0 7B               4      LD  A,E
0017F1 57F1 FE0D             7      CP  00DH
0017F3 57F3 20DE            12      JR  NZ,GETL1
                                
0017F5 57F5 111FF4          10      LD  DE,KBUF
0017F8 57F8 3AB0F3          13      LD  A,(LINLEN)
0017FB 57FB 47               4      LD  B,A
0017FC 57FC CDCF5B          17      CALL    ZERO_MEMORY_DE
                                
0017FF 57FF 2ACAFB          16      LD  HL,(FSTPOS)
001802 5802 3ADCF3          13      LD  A,(CSRY)
001805 5805 6F               4      LD  L,A
001806 5806 E5              11      PUSH    HL
001807 5807 CD3B59          17      CALL    LOC0
00180A 580A 4D               4      LD  C,L
00180B 580B 44               4      LD  B,H
00180C 580C E1              10      POP HL
00180D 580D 3AB0F3          13      LD  A,(LINLEN)
001810 5810 94               4      SUB H
001811 5811 3D               4      DEC A
001812 5812 5F               4      LD  E,A
001813 5813 211FF4          10      LD  HL,KBUF
       5816                     GETL2:
001816 5816 CDCE58          17      CALL    _SCRN
001819 5819 03               6      INC BC
00181A 581A 77               7      LD  (HL),A
00181B 581B 23               6      INC HL
00181C 581C 1D               4      DEC E
00181D 581D 20F7            12      JR  NZ,GETL2
00181F 581F CDAD56          17      CALL    MSG_CR
                                
001822 5822 FDE1            14      POP IY
001824 5824 DDE1            14      POP IX
       5826                     GETL3:
001826 5826 2B               6      DEC HL
001827 5827 7E               7      LD  A,(HL)
001828 5828 FE21             7      CP  021H
00182A 582A D0              11      RET NC
00182B 582B 3600            10      LD  (HL),0
00182D 582D 15               4      DEC D
00182E 582E 20F6            12      JR  NZ,GETL3
001830 5830 C9              10      RET
                                
       5831                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       5831                     CONSTX:
       5831                     CPM_CONST:
001831 5831 C5              11      PUSH    BC
001832 5832 D5              11      PUSH    DE
001833 5833 E5              11      PUSH    HL
001834 5834 DDE5            15      PUSH    IX
001836 5836 DD219C00        14      LD  IX,CHSNS
00183A 583A CD7345          17      CALL    CALSLT_R
00183D 583D DDE1            14      POP IX
00183F 583F E1              10      POP HL
001840 5840 D1              10      POP DE
001841 5841 C1              10      POP BC
001842 5842 C9              10      RET
                                
       5843                     _SYS2A:     ;(BDOS)日付の獲得
001843 5843 0E0B             7      LD  C,11        ;年/Year→HL
001845 5845 CD8458          17      CALL    RDCLK_BCD
001848 5848 6F               4      LD  L,A
001849 5849 2600             7      LD  H,0
00184B 584B 3AF8FA          13      LD  A,(EXBRSA)
00184E 584E B7               4      OR  A
00184F 584F 2804            12      JR  Z,SX2A1
001851 5851 11BC07          10      LD  DE,1980     ;1980年～2079年
001854 5854 19              11      ADD HL,DE
       5855                     SX2A1:
001855 5855 0E09             7      LD  C,9     ;月/Month→D
001857 5857 CD8458          17      CALL    RDCLK_BCD
00185A 585A 57               4      LD  D,A
                                
00185B 585B 0E07             7      LD  C,7     ;日/Day→E
00185D 585D CD8458          17      CALL    RDCLK_BCD
001860 5860 5F               4      LD  E,A
                                
001861 5861 0E06             7      LD  C,6     ;曜日/Week→A
       5863                     RDCLK:
001863 5863 DDE5            15      PUSH    IX
001865 5865 DD21F501        14      LD  IX,REDCLK
       5869                     WRCLK1:
001869 5869 3AF8FA          13      LD  A,(EXBRSA)
00186C 586C B7               4      OR  A
00186D 586D 280A            12      JR  Z,RDCLK1    ;MSX1
00186F 586F FDE5            15      PUSH    IY
001871 5871 FD67             9      LD  IYH,A
001873 5873 78               4      LD  A,B
001874 5874 CD1C00          17      CALL    _CALSLT
001877 5877 FDE1            14      POP IY
       5879                     RDCLK1:
001879 5879 DDE1            14      POP IX
00187B 587B C9              10      RET
       587C                     WRCLK:
00187C 587C DDE5            15      PUSH    IX
00187E 587E DD21F901        14      LD  IX,WRTCLK
001882 5882 18E5            12      JR  WRCLK1
                                
       5884                     RDCLK_BCD:
001884 5884 CD6358          17      CALL    RDCLK       ;1の位
001887 5887 47               4      LD  B,A
001888 5888 0C               4      INC C
001889 5889 CD6358          17      CALL    RDCLK       ;10の位
00188C 588C 87               4      ADD A,A     ;*2
00188D 588D 4F               4      LD  C,A
00188E 588E 87               4      ADD A,A     ;*4
00188F 588F 87               4      ADD A,A     ;*8
001890 5890 81               4      ADD A,C     ;*10(8+2)
001891 5891 80               4      ADD A,B     ;1の位
001892 5892 C9              10      RET
                                
       5893                     _SYS2C:     ;(BDOS)時刻の獲得
001893 5893 011501          10      LD  BC,00115H       ;12時間計/24時間計の設定を24時間計に
001896 5896 CD7C58          17      CALL    WRCLK
001899 5899 0E04             7      LD  C,4     ;H=時/Hour
00189B 589B CD8458          17      CALL    RDCLK_BCD
00189E 589E 67               4      LD  H,A
00189F 589F 0E02             7      LD  C,2     ;L=分/Minute
0018A1 58A1 CD8458          17      CALL    RDCLK_BCD
0018A4 58A4 6F               4      LD  L,A
0018A5 58A5 0E00             7      LD  C,0     ;D=秒/Second
0018A7 58A7 CD8458          17      CALL    RDCLK_BCD
0018AA 58AA 57               4      LD  D,A
0018AB 58AB AF               4      XOR A       ;E=1/100秒
0018AC 58AC 5F               4      LD  E,A
0018AD 58AD C9              10      RET
                                
       58AE                     POS:
0018AE 58AE F5              11      PUSH    AF
0018AF 58AF 2ADCF3          16      LD  HL,(CSRY)
0018B2 58B2 7D               4      LD  A,L
0018B3 58B3 6C               4      LD  L,H
0018B4 58B4 67               4      LD  H,A
0018B5 58B5 2C               4      INC L
0018B6 58B6 24               4      INC H
0018B7 58B7 F1              10      POP AF
0018B8 58B8 C9              10      RET
                                
       58B9                     LOC:
0018B9 58B9 F5              11      PUSH    AF
0018BA 58BA E5              11      PUSH    HL
0018BB 58BB 7D               4      LD  A,L
0018BC 58BC 6C               4      LD  L,H
0018BD 58BD 67               4      LD  H,A
0018BE 58BE 2D               4      DEC L
0018BF 58BF 25               4      DEC H
0018C0 58C0 DDE5            15      PUSH    IX
0018C2 58C2 DD21C600        14      LD  IX,POSIT
0018C6 58C6 CD7345          17      CALL    CALSLT_R
0018C9 58C9 DDE1            14      POP IX
0018CB 58CB E1              10      POP HL
0018CC 58CC F1              10      POP AF
0018CD 58CD C9              10      RET
                                
       58CE                     _SCRN:
       58CE                     SCRN:
0018CE 58CE E5              11      PUSH    HL
0018CF 58CF DDE5            15      PUSH    IX
                                
0018D1 58D1 69               4      LD  L,C
0018D2 58D2 60               4      LD  H,B
0018D3 58D3 DD214A00        14      LD  IX,RDVRM
0018D7 58D7 CD7345          17      CALL    CALSLT_R
                                
0018DA 58DA DDE1            14      POP IX
0018DC 58DC E1              10      POP HL
0018DD 58DD C9              10      RET
                                
       58DE                     CTRL02:
0018DE 58DE F5              11      PUSH    AF
0018DF 58DF D5              11      PUSH    DE
0018E0 58E0 2ADCF3          16      LD  HL,(CSRY)
0018E3 58E3 3AB0F3          13      LD  A,(LINLEN)
0018E6 58E6 4F               4      LD  C,A
0018E7 58E7 94               4      SUB H   ;CSRX
0018E8 58E8 C602             7      ADD A,2
0018EA 58EA 47               4      LD  B,A ;カーソルより右の文字数
0018EB 58EB 61               4      LD  H,C ;LINLEN
0018EC 58EC C5              11      PUSH    BC
0018ED 58ED CD3B59          17      CALL    LOC0
0018F0 58F0 C1              10      POP BC
                                
0018F1 58F1 1620             7      LD  D,020H
       58F3                     C8X1:
0018F3 58F3 DD214A00        14      LD  IX,RDVRM
0018F7 58F7 CD7345          17      CALL    CALSLT_R
0018FA 58FA 4F               4      LD  C,A
0018FB 58FB 7A               4      LD  A,D
0018FC 58FC DD214D00        14      LD  IX,WRTVRM
001900 5900 CD7345          17      CALL    CALSLT_R
001903 5903 2B               6      DEC HL
001904 5904 51               4      LD  D,C
001905 5905 10EC            13      DJNZ    C8X1
001907 5907 D1              10      POP DE
001908 5908 F1              10      POP AF
001909 5909 C9              10      RET
                                
       590A                     INSERT:
00190A 590A F5              11      PUSH    AF
00190B 590B D5              11      PUSH    DE
00190C 590C 2ADCF3          16      LD  HL,(CSRY)
00190F 590F 3AB0F3          13      LD  A,(LINLEN)
001912 5912 4F               4      LD  C,A
001913 5913 94               4      SUB H   ;CSRX
001914 5914 3C               4      INC A
001915 5915 47               4      LD  B,A ;カーソルより右の文字数
001916 5916 C5              11      PUSH    BC
001917 5917 CD3B59          17      CALL    LOC0
00191A 591A C1              10      POP BC
                                
00191B 591B 1620             7      LD  D,020H
       591D                     INS1:
00191D 591D DD214A00        14      LD  IX,RDVRM
001921 5921 CD7345          17      CALL    CALSLT_R
001924 5924 4F               4      LD  C,A
001925 5925 7A               4      LD  A,D
001926 5926 DD214D00        14      LD  IX,WRTVRM
00192A 592A CD7345          17      CALL    CALSLT_R
00192D 592D 23               6      INC HL
00192E 592E 51               4      LD  D,C
00192F 592F 10EC            13      DJNZ    INS1
001931 5931 D1              10      POP DE
001932 5932 F1              10      POP AF
001933 5933 C9              10      RET
                                
       5934                     CONOUT1:
001934 5934 59               4      LD  E,C
001935 5935 C38656          10      JP  _PRINT
                                
       5938                     GETVRAM:
001938 5938 2ADCF3          16      LD  HL,(CSRY)
       593B                     LOC0:
00193B 593B 2D               4      DEC L
00193C 593C 25               4      DEC H
00193D 593D 4C               4      LD  C,H ;CSRX-1
00193E 593E 5D               4      LD  E,L ;CSRY-1
       593F                     LOC1:
00193F 593F 3AB0F3          13      LD  A,(LINLEN)
001942 5942 67               4      LD  H,A
001943 5943 1600             7      LD  D,0
001945 5945 6A               4      LD  L,D ;0
001946 5946 0608             7      LD  B,8
       5948                     LOC2:
001948 5948 29              11      ADD HL,HL
001949 5949 3001            12      JR  NC,LOC3
00194B 594B 19              11      ADD HL,DE
       594C                     LOC3:
00194C 594C 10FA            13      DJNZ    LOC2
00194E 594E 09              11      ADD HL,BC
00194F 594F C9              10      RET
                                
       5950                     _SYS0C:     ;(BDOS)バージョン番号の獲得
001950 5950 212200          10      LD  HL,00022H
001953 5953 AF               4      XOR A
001954 5954 7D               4      LD  A,L
001955 5955 C9              10      RET
                                
       5956                     _SYS0D:     ;(BDOS)ディスク・リセット
001956 5956 218000          10      LD  HL,00080H
001959 5959 22D4F2          16      LD  (_DTA),HL
00195C 595C C9              10      RET
                                
       595D                     _SYS0E:     ;(BDOS)カレントドライブの設定
00195D 595D 7B               4      LD  A,E
       595E                     _SYS0EX1:
00195E 595E FE08             7      CP  8
001960 5960 3F               4      CCF
001961 5961 D8              11      RET C
001962 5962 32EAF2          13      LD  (_DVSW),A
001965 5965 C9              10      RET
                                
       5966                     _SYS0F:     ;(BDOS)ファイルのオープン
001966 5966 D5              11      PUSH    DE
001967 5967 FDE1            14      POP IY
001969 5969 CDA45B          17      CALL    INIT_FILE
00196C 596C CDED4D          17      CALL    ROM_OPEN
00196F 596F 385F            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
001971 5971 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
001975 5975 FDE5            15      PUSH    IY
001977 5977 D1              10      POP DE
001978 5978 13               6      INC DE
001979 5979 010B00          10      LD  BC,11
00197C 597C EDB0                    LDIR
                                ;               Attribute
00197E 597E 7E               7      LD  A,(HL)
00197F 597F FD770D          19      LD  (IY+13),A
                                ;               TIME
001982 5982 110B00          10      LD  DE,11
001985 5985 19              11      ADD HL,DE
001986 5986 7E               7      LD  A,(HL)
001987 5987 23               6      INC HL
001988 5988 FD7716          19      LD  (IY+22),A
00198B 598B 7E               7      LD  A,(HL)
00198C 598C 23               6      INC HL
00198D 598D FD7717          19      LD  (IY+23),A
                                ;               DATE
001990 5990 7E               7      LD  A,(HL)
001991 5991 23               6      INC HL
001992 5992 FD7714          19      LD  (IY+20),A
001995 5995 7E               7      LD  A,(HL)
001996 5996 23               6      INC HL
001997 5997 FD7715          19      LD  (IY+21),A
                                ;               First cluster
00199A 599A 7E               7      LD  A,(HL)
00199B 599B 23               6      INC HL
00199C 599C FD771A          19      LD  (IY+26),A
00199F 599F 7E               7      LD  A,(HL)
0019A0 59A0 23               6      INC HL
0019A1 59A1 FD771B          19      LD  (IY+27),A
                                ;               SIZE
0019A4 59A4 7E               7      LD  A,(HL)
0019A5 59A5 23               6      INC HL
0019A6 59A6 FD7710          19      LD  (IY+16),A
0019A9 59A9 7E               7      LD  A,(HL)
0019AA 59AA 23               6      INC HL
0019AB 59AB FD7711          19      LD  (IY+17),A
0019AE 59AE 7E               7      LD  A,(HL)
0019AF 59AF 23               6      INC HL
0019B0 59B0 FD7712          19      LD  (IY+18),A
0019B3 59B3 7E               7      LD  A,(HL)
0019B4 59B4 FD7713          19      LD  (IY+19),A
0019B7 59B7 2AEFF2          16      LD  HL,(DIRENT1)
0019BA 59BA FD751E          19      LD  (IY+30),L
0019BD 59BD FD741F          19      LD  (IY+31),H
0019C0 59C0 3AF1F2          13      LD  A,(_DIR_BANK)
0019C3 59C3 FD771D          19      LD  (IY+29),A
0019C6 59C6 AF               4      XOR A
0019C7 59C7 FD770C          19      LD  (IY+12),A
0019CA 59CA C9              10      RET
                                
       59CB                     _SYS10:     ;(BDOS)ファイルのクローズ
0019CB 59CB AF               4      XOR A
0019CC 59CC C9              10      RET
                                
       59CD                     S11X1:
0019CD 59CD FD7119          19      LD  (IY+25),C       ;RootEntCnt
       59D0                     SCF_FF_RET:
0019D0 59D0 37               4      SCF
0019D1 59D1 9F               4      SBC A,A
0019D2 59D2 C9              10      RET
                                
       59D3                     _SYS11:     ;(BDOS)最初のファイルの検索
0019D3 59D3 ED53D7F2        20      LD  (_FCB),DE
0019D7 59D7 D5              11      PUSH    DE
0019D8 59D8 FDE1            14      POP IY
0019DA 59DA CDA45B          17      CALL    INIT_FILE
0019DD 59DD FD361801        19      LD  (IY+24),1
0019E1 59E1 CDB250          17      CALL    GET_DIR_DAT
       59E4                     S12X1:
0019E4 59E4 CD614E          17      CALL    FILESE
0019E7 59E7 FD3418          23      INC (IY+24)
0019EA 59EA 30E1            12      JR  NC,S11X1
0019EC 59EC 0D               4      DEC C
0019ED 59ED FD7119          19      LD  (IY+25),C       ;RootEntCnt
0019F0 59F0 FDCB0D66        20      BIT 4,(IY+13)
0019F4 59F4 280A            12      JR  Z,S12X2
0019F6 59F6 E5              11      PUSH    HL
0019F7 59F7 DDE1            14      POP IX
0019F9 59F9 DD7E0B          19      LD  A,(IX+11)
0019FC 59FC FE0F             7      CP  00FH
0019FE 59FE 2810            12      JR  Z,S11NEXT
       5A00                     S12X2:
001A00 5A00 012000          10      LD  BC,32
001A03 5A03 ED5BD4F2        20      LD  DE,(_DTA)
001A07 5A07 FD7E00          19      LD  A,(IY+0)
001A0A 5A0A 12               7      LD  (DE),A      ;ドライブ番号
001A0B 5A0B 13               6      INC DE
001A0C 5A0C EDB0                    LDIR            ;ディレクトリエントリ
001A0E 5A0E AF               4      XOR A
001A0F 5A0F C9              10      RET
       5A10                     S11NEXT:
001A10 5A10 CD7D4E          17      CALL    FNEXT
001A13 5A13 20CF            12      JR  NZ,S12X1
001A15 5A15 37               4      SCF
001A16 5A16 9F               4      SBC A,A
001A17 5A17 C9              10      RET
                                
       5A18                     _SYS12:
001A18 5A18 FD2AD7F2        20      LD  IY,(_FCB)
001A1C 5A1C FDE5            15      PUSH    IY
001A1E 5A1E D1              10      POP DE
001A1F 5A1F CDA45B          17      CALL    INIT_FILE
       5A22                     S12X3:
001A22 5A22 CDB250          17      CALL    GET_DIR_DAT
001A25 5A25 FD4618          19      LD  B,(IY+24)
       5A28                     S12X4:
001A28 5A28 C5              11      PUSH    BC
001A29 5A29 CD7D4E          17      CALL    FNEXT
001A2C 5A2C C1              10      POP BC
001A2D 5A2D 2807            12      JR  Z,S12X5
001A2F 5A2F 7E               7      LD  A,(HL)
001A30 5A30 FEE5             7      CP  0E5H
001A32 5A32 28F4            12      JR  Z,S12X4
001A34 5A34 10F2            13      DJNZ    S12X4
       5A36                     S12X5:
001A36 5A36 FD4E19          19      LD  C,(IY+25)
001A39 5A39 18A9            12      JR  S12X1
                                
       5A3B                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
001A3B 5A3B CD8950          17      CALL    SET_FCB
001A3E 5A3E CD5750          17      CALL    GETSEQ
001A41 5A41 CD4450          17      CALL    RB_READ
001A44 5A44 E5              11      PUSH    HL
001A45 5A45 CD6450          17      CALL    SETSEQ
001A48 5A48 E1              10      POP HL
       5A49                     SREAD:
001A49 5A49 C601             7      ADD A,001H
001A4B 5A4B D8              11      RET C
                                
001A4C 5A4C 7D               4      LD  A,L
001A4D 5A4D D601             7      SUB 001H
001A4F 5A4F 9F               4      SBC A,A
001A50 5A50 E603             7      AND 3
001A52 5A52 1F               4      RRA
001A53 5A53 C9              10      RET
                                
       5A54                     _SYS18:     ;(BDOS)ログインベクトルの獲得
       5A54                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
001A54 5A54 2AF2F2          16      LD  HL,(_LVECTOR)
001A57 5A57 AF               4      XOR A
001A58 5A58 67               4      LD  H,A
001A59 5A59 C9              10      RET
                                
       5A5A                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
001A5A 5A5A 3AEAF2          13      LD  A,(_DVSW)
001A5D 5A5D A7               4      AND A
001A5E 5A5E C9              10      RET
                                
       5A5F                     _SYS1A:     ;(BDOS)DTAの設定
001A5F 5A5F ED53D4F2        20      LD  (_DTA),DE
001A63 5A63 AF               4      XOR A
001A64 5A64 C9              10      RET
                                
       5A65                     _SYS1B:     ;(BDOS)ディスク情報の獲得
001A65 5A65 7B               4      LD  A,E
001A66 5A66 D601             7      SUB 1
001A68 5A68 DC5A5A          17      CALL    C,_SYS19
001A6B 5A6B 5F               4      LD  E,A
001A6C 5A6C CD5F54          17      CALL    IS_BPB
001A6F 5A6F 3827            12      JR  C,S1B_E
001A71 5A71 F5              11      PUSH    AF
001A72 5A72 215EF5          10      LD  HL,SYS1B_DPB
001A75 5A75 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
001A78 5A78 47               4      LD  B,A
001A79 5A79 4F               4      LD  C,A
001A7A 5A7A 3271F5          13      LD  (SYS1B_FAT),A
001A7D 5A7D 7B               4      LD  A,E
001A7E 5A7E CD7C54          17      CALL    GETDPB
001A81 5A81 DD215EF5        14      LD  IX,SYS1B_DPB
001A85 5A85 FD2171F5        14      LD  IY,SYS1B_FAT
001A89 5A89 ED4B60F5        20      LD  BC,(SYS1B_DPB+1+1)  ;SECSIZ
001A8D 5A8D ED5B6CF5        20      LD  DE,(SYS1B_DPB+1+13) ;MAXCLUS
001A91 5A91 1B               6      DEC DE
001A92 5A92 1B               6      DEC DE
001A93 5A93 210000          10      LD  HL,0            ;書き込み不可なので0を返す
001A96 5A96 F1              10      POP AF
001A97 5A97 C9              10      RET
       5A98                     S1B_E:
001A98 5A98 9F               4      SBC A,A
001A99 5A99 C9              10      RET
                                
       5A9A                     _SYS21:     ;(BDOS)ランダムな読み出し
001A9A 5A9A CD8950          17      CALL    SET_FCB
                                
001A9D 5A9D FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001AA0 5AA0 FD6622          19      LD  H,(IY+34)
                                
001AA3 5AA3 CD4450          17      CALL    RB_READ
001AA6 5AA6 18A1            12      JR  SREAD
                                
       5AA8                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
001AA8 5AA8 CD6659          17      CALL    _SYS0F
001AAB 5AAB D8              11      RET C
                                
001AAC 5AAC D5              11      PUSH    DE      ;EX DE,IY
001AAD 5AAD FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001AAF 5AAF CD7950          17      CALL    GETSIZE
       5AB2                     _S24X1:
001AB2 5AB2 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001AB5 5AB5 FD7422          19      LD  (IY+34),H
001AB8 5AB8 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
001ABC 5ABC FDE3            23      EX  (SP),IY     ;
001ABE 5ABE D1              10      POP DE      ;
                                
001ABF 5ABF AF               4      XOR A
001AC0 5AC0 C9              10      RET
                                
       5AC1                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
001AC1 5AC1 E5              11      PUSH    HL
001AC2 5AC2 D5              11      PUSH    DE      ;EX DE,IY
001AC3 5AC3 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001AC5 5AC5 CD5750          17      CALL    GETSEQ
001AC8 5AC8 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       5ACA                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001ACA 5ACA CD8950          17      CALL    SET_FCB
001ACD 5ACD E5              11      PUSH    HL
001ACE 5ACE FD7E00          19      LD  A,(IY+0)
001AD1 5AD1 3200F3          13      LD  (FDRV),A
001AD4 5AD4 FD7E18          19      LD  A,(IY+24)
001AD7 5AD7 32C4F2          13      LD  (_BANK),A
001ADA 5ADA FD6E21          19      LD  L,(IY+33)
001ADD 5ADD FD6622          19      LD  H,(IY+34)
001AE0 5AE0 22CAF2          16      LD  (RR_LOW),HL
001AE3 5AE3 FD6E23          19      LD  L,(IY+35)
001AE6 5AE6 FD6624          19      LD  H,(IY+36)
001AE9 5AE9 22CCF2          16      LD  (RR_HIGH),HL
001AEC 5AEC E1              10      POP HL
001AED 5AED CDB84B          17      CALL    ROM_READ
001AF0 5AF0 ED5BCAF2        20      LD  DE,(RR_LOW)
001AF4 5AF4 FD7321          19      LD  (IY+33),E
001AF7 5AF7 FD7222          19      LD  (IY+34),D
001AFA 5AFA ED5BCCF2        20      LD  DE,(RR_HIGH)
001AFE 5AFE FD7323          19      LD  (IY+35),E
001B01 5B01 FD7224          19      LD  (IY+36),D
001B04 5B04 3AC4F2          13      LD  A,(_BANK)
001B07 5B07 FD7718          19      LD  (IY+24),A
001B0A 5B0A 9F               4      SBC A,A
001B0B 5B0B D8              11      RET C
001B0C 5B0C 3AC3F2          13      LD  A,(_RESULT)
001B0F 5B0F C9              10      RET
                                
       5B10                     _SYS29:
001B10 5B10 E5              11      PUSH    HL
001B11 5B11 23               6      INC HL
001B12 5B12 CD5A5B          17      CALL    _SYS5C
001B15 5B15 E3              19      EX  (SP),HL
001B16 5B16 79               4      LD  A,C
001B17 5B17 CD145C          17      CALL    LD_HL_A
001B1A 5B1A 010E00          10      LD  BC,14
001B1D 5B1D 09              11      ADD HL,BC
001B1E 5B1E C1              10      POP BC
001B1F 5B1F 03               6      INC BC
001B20 5B20 79               4      LD  A,C
001B21 5B21 CD145C          17      CALL    LD_HL_A
001B24 5B24 23               6      INC HL
001B25 5B25 78               4      LD  A,B
001B26 5B26 CD145C          17      CALL    LD_HL_A
001B29 5B29 AF               4      XOR A
001B2A 5B2A C9              10      RET
                                
       5B2B                     _SYS2F:
001B2B 5B2B 44               4      LD  B,H
001B2C 5B2C 7D               4      LD  A,L
001B2D 5B2D 2AD4F2          16      LD  HL,(_DTA)
001B30 5B30 C3E453          10      JP  DISKIO
                                
       5B33                     _SYS59:     ;(BDOS)カレントディレクトリの取得
001B33 5B33 78               4      LD  A,B
001B34 5B34 CDF755          17      CALL    GET_CD_CDRV
001B37 5B37 7C               4      LD  A,H
001B38 5B38 B5               4      OR  L
001B39 5B39 2808            12      JR  Z,S59E
001B3B 5B3B 3E23             7      LD  A,'#'
001B3D 5B3D 12               7      LD  (DE),A
001B3E 5B3E 13               6      INC DE
001B3F 5B3F CD2E5C          17      CALL    HEXHL
001B42 5B42 AF               4      XOR A
       5B43                     S59E:
001B43 5B43 12               7      LD  (DE),A
001B44 5B44 C9              10      RET
                                
       5B45                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
001B45 5B45 CDDE5B          17      CALL    GET_PARAM_IX
001B48 5B48 CD824C          17      CALL    FILE_BDOS
001B4B 5B4B CD6C51          17      CALL    ROM_CD
001B4E 5B4E 9F               4      SBC A,A
001B4F 5B4F C9              10      RET
                                
       5B50                     _SYS5B:     ;(BDOS)パス名の解析(_PARSE)
001B50 5B50 D5              11      PUSH    DE
001B51 5B51 CDDE5B          17      CALL    GET_PARAM_IX
001B54 5B54 CD824C          17      CALL    FILE_BDOS
001B57 5B57 D1              10      POP DE
001B58 5B58 182C            12      JR  S5B_1
                                
       5B5A                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
001B5A 5B5A CDD65B          17      CALL    SPCUT_SL
001B5D 5B5D D5              11      PUSH    DE
                                
001B5E 5B5E E5              11      PUSH    HL
001B5F 5B5F AF               4      XOR A
001B60 5B60 CDF755          17      CALL    GET_CD_CDRV
001B63 5B63 22F9F2          16      LD  (_CDX),HL
                                
001B66 5B66 CDDE5B          17      CALL    GET_PARAM_IX
001B69 5B69 CD824C          17      CALL    FILE_BDOS
001B6C 5B6C E1              10      POP HL
                                
001B6D 5B6D 060B             7      LD  B,11
001B6F 5B6F 1101F3          10      LD  DE,FNAME
       5B72                     S5C_1:
001B72 5B72 1A               7      LD  A,(DE)
001B73 5B73 13               6      INC DE
001B74 5B74 CD145C          17      CALL    LD_HL_A
001B77 5B77 23               6      INC HL
001B78 5B78 10F8            13      DJNZ    S5C_1
                                
001B7A 5B7A DDE5            15      PUSH    IX
001B7C 5B7C E1              10      POP HL
001B7D 5B7D 115EF5          10      LD  DE,BUF
001B80 5B80 A7               4      AND A
001B81 5B81 ED52            15      SBC HL,DE
001B83 5B83 D1              10      POP DE
001B84 5B84 19              11      ADD HL,DE
001B85 5B85 EB               4      EX  DE,HL
       5B86                     S5B_1:
001B86 5B86 2AF9F2          16      LD  HL,(_CDX)
001B89 5B89 3A00F3          13      LD  A,(FDRV)
001B8C 5B8C 4F               4      LD  C,A
001B8D 5B8D AF               4      XOR A
001B8E 5B8E C9              10      RET
                                
       5B8F                     _SYS6F:
001B8F 5B8F 016F00          10      LD  BC,0006FH
001B92 5B92 11918A          10      LD  DE,08A91H       ;Tablacus Disk ROM Lite 認識コード
001B95 5B95 AF               4      XOR A
001B96 5B96 C9              10      RET
                                
       5B97                     _SYS68:
001B97 5B97 21F2F2          10      LD  HL,_LVECTOR
001B9A 5B9A CBFE            15      SET 7,(HL)
001B9C 5B9C 78               4      LD  A,B
001B9D 5B9D B7               4      OR  A
001B9E 5B9E 3E00             7      LD  A,0
001BA0 5BA0 C0              11      RET NZ
001BA1 5BA1 CBBE            15      RES 7,(HL)
001BA3 5BA3 C9              10      RET
                                
       5BA4                     INIT_FILE:
001BA4 5BA4 EB               4      EX  DE,HL
001BA5 5BA5 1100F3          10      LD  DE,FDRV
001BA8 5BA8 010C00          10      LD  BC,1+8+3
       5BAB                     INIT_FILE1:
001BAB 5BAB EDB0                    LDIR
001BAD 5BAD CD1856          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_NORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
001BB0 5BB0 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
001BB3 5BB3 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
001BB6 5BB6 FD6E0E          19      LD  L,(IY+14)
001BB9 5BB9 FD660F          19      LD  H,(IY+15)
001BBC 5BBC 7C               4      LD  A,H
001BBD 5BBD FE10             7      CP  010H
001BBF 5BBF 3004            12      JR  NC,INIT_FILE1X
001BC1 5BC1 B5               4      OR  L
001BC2 5BC2 2B               6      DEC HL
001BC3 5BC3 2006            12      JR  NZ,INIT_FILE2
       5BC5                     INIT_FILE1X:
001BC5 5BC5 FD7E00          19      LD  A,(IY+0)
001BC8 5BC8 CDF755          17      CALL    GET_CD_CDRV
       5BCB                     INIT_FILE2:
001BCB 5BCB 22F9F2          16      LD  (_CDX),HL           ;カレントディレクトリ
001BCE 5BCE C9              10      RET
                                
       5BCF                     ZERO_MEMORY_DE:
001BCF 5BCF AF               4      XOR A
       5BD0                     FILL_MEMORY_DE:
001BD0 5BD0 12               7      LD  (DE),A
001BD1 5BD1 13               6      INC DE
001BD2 5BD2 10FC            13      DJNZ    FILL_MEMORY_DE
001BD4 5BD4 C9              10      RET
                                
       5BD5                     SS1_SL:
001BD5 5BD5 13               6      INC DE
       5BD6                     SPCUT_SL:               ;スペースをカット
001BD6 5BD6 CDF85B          17      CALL    LD_A_DE
001BD9 5BD9 FE20             7      CP  020H
001BDB 5BDB 28F8            12      JR  Z,SS1_SL
001BDD 5BDD C9              10      RET
                                
       5BDE                     GET_PARAM_IX:
001BDE 5BDE 0600             7      LD  B,0
001BE0 5BE0 215EF5          10      LD  HL,BUF
001BE3 5BE3 E5              11      PUSH    HL
001BE4 5BE4 CDD65B          17      CALL    SPCUT_SL
       5BE7                     GPIX1:
001BE7 5BE7 CDF85B          17      CALL    LD_A_DE
001BEA 5BEA 13               6      INC DE
001BEB 5BEB 77               7      LD  (HL),A
001BEC 5BEC 23               6      INC HL
001BED 5BED B7               4      OR  A
001BEE 5BEE 2804            12      JR  Z,GPIX2
001BF0 5BF0 04               4      INC B
001BF1 5BF1 20F4            12      JR  NZ,GPIX1
001BF3 5BF3 05               4      DEC B
       5BF4                     GPIX2:
001BF4 5BF4 DDE1            14      POP IX
001BF6 5BF6 58               4      LD  E,B
001BF7 5BF7 C9              10      RET
                                
       5BF8                     LD_A_DE:
001BF8 5BF8 1A               7      LD  A,(DE)
001BF9 5BF9 CB7A             8      BIT 7,D
001BFB 5BFB C0              11      RET NZ
001BFC 5BFC C5              11      PUSH    BC
001BFD 5BFD D5              11      PUSH    DE
001BFE 5BFE E5              11      PUSH    HL
001BFF 5BFF EB               4      EX  DE,HL
                                
001C00 5C00 0141F3          10      LD  BC,RAMAD0
001C03 5C03 7C               4      LD  A,H
001C04 5C04 07               4      RLCA
001C05 5C05 07               4      RLCA
001C06 5C06 E603             7      AND 3
001C08 5C08 81               4      ADD A,C
001C09 5C09 4F               4      LD  C,A
001C0A 5C0A 0A               7      LD  A,(BC)
                                
001C0B 5C0B CD0C00          17      CALL    _RDSLT
001C0E 5C0E E1              10      POP HL
001C0F 5C0F D1              10      POP DE
001C10 5C10 C1              10      POP BC
001C11 5C11 C9              10      RET
                                
       5C12                     LD_HL_A_1:
001C12 5C12 77               7      LD  (HL),A
001C13 5C13 C9              10      RET
       5C14                     LD_HL_A:
001C14 5C14 CB7C             8      BIT 7,H
001C16 5C16 20FA            12      JR  NZ,LD_HL_A_1
001C18 5C18 C5              11      PUSH    BC
001C19 5C19 D5              11      PUSH    DE
001C1A 5C1A E5              11      PUSH    HL
                                
001C1B 5C1B 5F               4      LD  E,A
001C1C 5C1C 0141F3          10      LD  BC,RAMAD0
001C1F 5C1F 7C               4      LD  A,H
001C20 5C20 07               4      RLCA
001C21 5C21 07               4      RLCA
001C22 5C22 E603             7      AND 3
001C24 5C24 81               4      ADD A,C
001C25 5C25 4F               4      LD  C,A
001C26 5C26 0A               7      LD  A,(BC)
                                
001C27 5C27 CD1400          17      CALL    _WRSLT
001C2A 5C2A E1              10      POP HL
001C2B 5C2B D1              10      POP DE
001C2C 5C2C C1              10      POP BC
001C2D 5C2D C9              10      RET
                                
       5C2E                     HEXHL:
001C2E 5C2E 7C               4      LD  A,H
001C2F 5C2F CD335C          17      CALL    HEXHX
001C32 5C32 7D               4      LD  A,L
       5C33                     HEXHX:
001C33 5C33 F5              11      PUSH    AF
001C34 5C34 07               4      RLCA
001C35 5C35 07               4      RLCA
001C36 5C36 07               4      RLCA
001C37 5C37 07               4      RLCA
001C38 5C38 CD3C5C          17      CALL    HEXA2
001C3B 5C3B F1              10      POP AF
       5C3C                     HEXA2:
001C3C 5C3C CDA745          17      CALL    ASC
001C3F 5C3F 12               7      LD  (DE),A
001C40 5C40 13               6      INC DE
001C41 5C41 C9              10      RET
                                
       5C42                     HEX:
001C42 5C42 CDD74D          17      CALL    CAP
001C45 5C45 D630             7      SUB '0'
001C47 5C47 D8              11      RET C
001C48 5C48 FE0A             7      CP  10
001C4A 5C4A 3F               4      CCF
001C4B 5C4B D0              11      RET NC
001C4C 5C4C FE11             7      CP  16+1
001C4E 5C4E D8              11      RET C
001C4F 5C4F D607             7      SUB 7
001C51 5C51 FE10             7      CP  10H
001C53 5C53 3F               4      CCF
001C54 5C54 C9              10      RET
                                
       59D0                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       59D0                     _SYS13  EQU SCF_FF_RET  ;(BDOS)ファイルの削除
       59D0                     _SYS15  EQU SCF_FF_RET  ;(BDOS)シーケンシャルな書き込み
       59D0                     _SYS16  EQU SCF_FF_RET  ;(BDOS)ファイルの作成
       59D0                     _SYS17  EQU SCF_FF_RET  ;(BDOS)ファイル名の変更
       59D0                     _SYS22  EQU SCF_FF_RET  ;(BDOS)ランダムな書き込み
       59D0                     _SYS26  EQU SCF_FF_RET  ;(BDOS)ランダムブロック書き込み
       59D0                     _SYS28  EQU SCF_FF_RET  ;(BDOS)ランダムな書き込み・その2
                                
       59D0                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       59D0                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       59D0                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       59D0                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:BDOS.ASM:UTF_8]
                                    INCLUDE "SLOT.ASM"
                                #if exists _RAM64K
       5C55                     INT38H_ROM:
001C55 5C55 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
001C58 5C58 CD615C          17      CALL    ENASLT_00H
001C5B 5C5B CD3800          17      CALL    00038H
001C5E 5C5E 3A41F3          13      LD  A,(RAMAD0)  ;メインRAMに切り替える
                                ;   JP  ENASLT_00H
                                ;
                                ;ページ0専門のENASLT
                                ;in
                                ;A←スロット
                                ;破壊
                                ;ABCHL
                                ;
                                ; ページ1 に配置
       5C61                     ENASLT_00H:
001C61 5C61 F3               4      DI
001C62 5C62 67               4      LD  H,A
001C63 5C63 E603             7      AND 3
001C65 5C65 4F               4      LD  C,A
001C66 5C66 DBA8            11      IN  A,(0A8H)
001C68 5C68 06FC             7      LD  B,0FCH  ;ページ0
001C6A 5C6A A0               4      AND B
001C6B 5C6B B1               4      OR  C
001C6C 5C6C CB7C             8      BIT 7,H
001C6E 5C6E CA51F0          10      JP  Z,ENASLT_NOEXT
                                                ;拡張スロットの処理
001C71 5C71 D5              11      PUSH    DE
001C72 5C72 CD39F0          17      CALL    ENATBL
001C75 5C75 0F               4      RRCA
001C76 5C76 0F               4      RRCA
001C77 5C77 4F               4      LD  C,A
001C78 5C78 7B               4      LD  A,E
001C79 5C79 CD7F5C          17      CALL    AT_3B
001C7C 5C7C 73               7      LD  (HL),E
001C7D 5C7D D1              10      POP DE
001C7E 5C7E C9              10      RET
                                ;
                                ;   ENASLOTの補助（ページ0・003BH～にも配置）
                                ;
       5C7F                     AT_3B:              ;ENASUB 対象の拡張スロットを切り替えるために基本スロットを切り替える
001C7F 5C7F D3A8            11      OUT (0A8H),A
001C81 5C81 3AFFFF          13      LD  A,(0FFFFH)  ;拡張スロットの切り替え
001C84 5C84 2F               4      CPL
001C85 5C85 A0               4      AND B
001C86 5C86 B1               4      OR  C
001C87 5C87 32FFFF          13      LD  (0FFFFH),A
001C8A 5C8A 5F               4      LD  E,A
                                                ;基本スロットの切り替え
001C8B 5C8B 7A               4      LD  A,D
001C8C 5C8C D3A8            11      OUT (0A8H),A
001C8E 5C8E C9              10      RET
       5C8F                     AT_3B_E:
                                
                                #endif
                                
       5C8F                     AT_GETSLT:
       5C8F                     AT_ISC:
001C8F EF40                         ORG ISC,AT_ISC-RUN
                                ;
                                ; インタースロットコール
                                ; ページ3 に配置
                                
                                ;
                                ;   現在のスロットを知る
                                ;in
                                ;HL←上位2ビットで切り替えるページを指定
                                ;out
                                ;A→スロット
                                ;※ROM、RAMの両方のルーチンを使うため絶対番地を使わない
       EF40                     _GETSLT:
001C8F EF40 E5              11      PUSH    HL
001C90 EF41 DBA8            11      IN  A,(0A8H)
                                
001C92 EF43 CB7C             8      BIT 7,H
001C94 EF45 2032            12      JR  NZ,GETSLT_HIGH
001C96 EF47 CB74             8      BIT 6,H
001C98 EF49 21C1FC          10      LD  HL,EXPTBL
001C9B EF4C 201B            12      JR  NZ,GETSLT_40H
       EF4E                     GETSLT_00H:             ;ページ0
001C9D EF4E E603             7      AND 3
001C9F EF50 85               4      ADD A,L
001CA0 EF51 6F               4      LD  L,A
001CA1 EF52 CB7E            13      BIT 7,(HL)
001CA3 EF54 280F            12      JR  Z,GETSLT_1
001CA5 EF56 C604             7      ADD A,SLTTBL-EXPTBL     ;拡張スロットをワークアリアから取得
001CA7 EF58 6F               4      LD  L,A
001CA8 EF59 7E               7      LD  A,(HL)
       EF5A                     GETSLT_3:
001CA9 EF5A 07               4      RLCA
001CAA EF5B 07               4      RLCA
       EF5C                     GETSLT_2:
001CAB EF5C E60C             7      AND 00CH
001CAD EF5E 67               4      LD  H,A
001CAE EF5F 7D               4      LD  A,L
001CAF EF60 D645             7      SUB LOW SLTTBL - 080H
001CB1 EF62 B4               4      OR  H
001CB2 EF63 E1              10      POP HL
001CB3 EF64 C9              10      RET
       EF65                     GETSLT_1:               ;スロットは拡張されていない
001CB4 EF65 D6C1             7      SUB LOW EXPTBL
001CB6 EF67 E1              10      POP HL
001CB7 EF68 C9              10      RET
                                
       EF69                     GETSLT_40H:             ;ページ1
001CB8 EF69 0F               4      RRCA
001CB9 EF6A 0F               4      RRCA
001CBA EF6B E603             7      AND 3
001CBC EF6D 85               4      ADD A,L
001CBD EF6E 6F               4      LD  L,A
001CBE EF6F CB7E            13      BIT 7,(HL)
001CC0 EF71 28F2            12      JR  Z,GETSLT_1
001CC2 EF73 C604             7      ADD A,SLTTBL-EXPTBL
001CC4 EF75 6F               4      LD  L,A
001CC5 EF76 7E               7      LD  A,(HL)
001CC6 EF77 18E3            12      JR  GETSLT_2
                                
       EF79                     GETSLT_HIGH:
001CC8 EF79 CB74             8      BIT 6,H
001CCA EF7B 21C1FC          10      LD  HL,EXPTBL
001CCD EF7E 2014            12      JR  NZ,GETSLT_C0H
       EF80                     GETSLT_80H:             ;ページ2
001CCF EF80 0F               4      RRCA
001CD0 EF81 0F               4      RRCA
001CD1 EF82 0F               4      RRCA
001CD2 EF83 0F               4      RRCA
001CD3 EF84 E603             7      AND 3
001CD5 EF86 85               4      ADD A,L
001CD6 EF87 6F               4      LD  L,A
001CD7 EF88 CB7E            13      BIT 7,(HL)
001CD9 EF8A 28D9            12      JR  Z,GETSLT_1
001CDB EF8C C604             7      ADD A,SLTTBL-EXPTBL
001CDD EF8E 6F               4      LD  L,A
001CDE EF8F 7E               7      LD  A,(HL)
001CDF EF90 0F               4      RRCA
001CE0 EF91 0F               4      RRCA
001CE1 EF92 18C8            12      JR  GETSLT_2
                                
       EF94                     GETSLT_C0H:             ;ページ3
001CE3 EF94 07               4      RLCA
001CE4 EF95 07               4      RLCA
001CE5 EF96 E603             7      AND 3
001CE7 EF98 85               4      ADD A,L
001CE8 EF99 6F               4      LD  L,A
001CE9 EF9A CB7E            13      BIT 7,(HL)
001CEB EF9C 28C7            12      JR  Z,GETSLT_1
001CED EF9E C604             7      ADD A,SLTTBL-EXPTBL
001CEF EFA0 6F               4      LD  L,A
001CF0 EFA1 7E               7      LD  A,(HL)
001CF1 EFA2 07               4      RLCA
001CF2 EFA3 07               4      RLCA
001CF3 EFA4 18B4            12      JR  GETSLT_3
                                
                                #if exists _RAM64K
       EFA6                     SAME_SLOT_00H:          ;ページ0とページ3のスロットが同一
001CF5 EFA6 D3A8            11      OUT (0A8H),A
001CF7 EFA8 3AFFFF          13      LD  A,(0FFFFH)  ;拡張スロットの切り替え
001CFA EFAB 2F               4      CPL
001CFB EFAC E6FC             7      AND 0FCH        ;ページ0マスク
001CFD EFAE B1               4      OR  C
001CFE EFAF 32FFFF          13      LD  (0FFFFH),A
001D01 EFB2 77               7      LD  (HL),A
001D02 EFB3 C9              10      RET
                                
       EFB4                     ENASLT_HIGH:
001D03 EFB4 CB74             8      BIT 6,H
001D05 EFB6 C0              11      RET NZ          ;ページ3はスロット切り替え不可
                                ;
                                ;ページ2専門のENASLT
                                ;in
                                ;A←スロット
                                ;破壊
                                ;ABCHL
                                ;
       EFB7                     ENASLT_80H:
001D06 EFB7 F3               4      DI
001D07 EFB8 6F               4      LD  L,A
001D08 EFB9 E603             7      AND 3
001D0A EFBB 07               4      RLCA
001D0B EFBC 07               4      RLCA
001D0C EFBD 07               4      RLCA
001D0D EFBE 07               4      RLCA
001D0E EFBF 4F               4      LD  C,A
001D0F EFC0 DBA8            11      IN  A,(0A8H)
001D11 EFC2 06CF             7      LD  B,0CFH  ;ページ2マスク
001D13 EFC4 A0               4      AND B
001D14 EFC5 B1               4      OR  C
001D15 EFC6 CB7D             8      BIT 7,L
001D17 EFC8 CA51F0          10      JP  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001D1A EFCB D5              11      PUSH    DE
001D1B EFCC CD2FF0          17      CALL    ENATBL_BIOS_CHECK
001D1E EFCF 07               4      RLCA
001D1F EFD0 07               4      RLCA
001D20 EFD1 4F               4      LD  C,A
001D21 EFD2 7B               4      LD  A,E
001D22 EFD3 CD3B00          17      CALL    ENASUB
001D25 EFD6 73               7      LD  (HL),E
001D26 EFD7 D1              10      POP DE
001D27 EFD8 C9              10      RET
                                ;
                                ;ENASLT
                                ;in
                                ;A←スロット
                                ;HL←上位2ビットで切り替えるページを指定
                                ;破壊
                                ;ABCHL
                                ;
       EFD9                     ENASLT:
001D28 EFD9 CB7C             8      BIT 7,H
001D2A EFDB 20D7            12      JR  NZ,ENASLT_HIGH
001D2C EFDD CB74             8      BIT 6,H
001D2E EFDF 2073            12      JR  NZ,ENASLT_40H
       EFE1                     _ENASLT_00H:
001D30 EFE1 F3               4      DI
001D31 EFE2 67               4      LD  H,A
001D32 EFE3 E603             7      AND 3
001D34 EFE5 4F               4      LD  C,A
001D35 EFE6 DBA8            11      IN  A,(0A8H)
001D37 EFE8 E6FC             7      AND 0FCH    ;ページ0マスク
001D39 EFEA B1               4      OR  C
001D3A EFEB CB7C             8      BIT 7,H
001D3C EFED 2862            12      JR  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001D3E EFEF D5              11      PUSH    DE
001D3F EFF0 44               4      LD  B,H
001D40 EFF1 CD39F0          17      CALL    ENATBL
001D43 EFF4 0F               4      RRCA
001D44 EFF5 0F               4      RRCA
001D45 EFF6 4F               4      LD  C,A
001D46 EFF7 7B               4      LD  A,E
001D47 EFF8 BA               4      CP  D
001D48 EFF9 D1              10      POP DE
001D49 EFFA 28AA            12      JR  Z,SAME_SLOT_00H ;ページ0とページ3のスロットが同一の場合
001D4B EFFC 60               4      LD  H,B
       EFFD                     ENASLT_SUB:
001D4C EFFD 7C               4      LD  A,H     ;ページ3でスロットを指定するためにページ1のROMのルーチンを使う
001D4D EFFE DDE5            15      PUSH    IX
001D4F F000 DD21615C        14      LD  IX,ENASLT_00H
       F004                     INT38H_SUB1:
001D53 F004 FDE5            15      PUSH    IY
001D55 F006 FD2A96F2        20      LD  IY,(ROM_SLT-1)
001D59 F00A CD81F0          17      CALL    CALSLT
001D5C F00D FDE1            14      POP IY
001D5E F00F DDE1            14      POP IX
001D60 F011 C9              10      RET
                                
       F012                     _ENASLT_00H_S:
001D61 F012 ED731DF0        20      LD  (ENASLT_SP1),SP
001D65 F016 315DF5          10      LD  SP,SPBUF
001D68 F019 CDFDEF          17      CALL    ENASLT_SUB
001D6B F01C 310000          10      LD  SP,0
       F01D                     ENASLT_SP1  EQU $-2
001D6E F01F C9              10      RET
                                
       F020                     INT38H_SUB:
001D6F F020 DDE5            15      PUSH    IX
001D71 F022 DD21555C        14      LD  IX,INT38H_ROM
001D75 F026 18DC            12      JR  INT38H_SUB1
                                
       F028                     ENASLT_BIOS:
001D77 F028 D1              10      POP DE
001D78 F029 7D               4      LD  A,L
001D79 F02A CD2400          17      CALL    _ENASLT
001D7C F02D D1              10      POP DE
001D7D F02E C9              10      RET
                                
       F02F                     ENATBL_BIOS_CHECK:
001D7E F02F 57               4      LD  D,A
001D7F F030 3A0000          13      LD  A,(0000H)
001D82 F033 FEF3             7      CP  0F3H    ;0000H が DI の場合はページ0は BIOS とみなす
001D84 F035 28F1            12      JR  Z,ENASLT_BIOS
001D86 F037 65               4      LD  H,L
001D87 F038 7A               4      LD  A,D
       F039                     ENATBL:
001D88 F039 57               4      LD  D,A ;基本スロットに出力する値
                                            ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001D89 F03A 7C               4      LD  A,H
001D8A F03B E603             7      AND 3
001D8C F03D 4F               4      LD  C,A ;C=スロット#
                                
                                    ;スロットテーブル
001D8D F03E 2EC5             7      LD  L,LOW SLTTBL
001D8F F040 85               4      ADD A,L
001D90 F041 6F               4      LD  L,A
                                            ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001D91 F042 79               4      LD  A,C ;C=スロット#
001D92 F043 0F               4      RRCA
001D93 F044 0F               4      RRCA        ;ページ3
001D94 F045 4F               4      LD  C,A
001D95 F046 7A               4      LD  A,D ;基本スロットに出力する値
001D96 F047 E63F             7      AND 03FH    ;ページ3マスク
001D98 F049 B1               4      OR  C
001D99 F04A 5F               4      LD  E,A ;基本スロットでページ3にスロットを割り当てる
001D9A F04B 7C               4      LD  A,H
001D9B F04C E60C             7      AND 00CH
001D9D F04E 26FC             7      LD  H,HIGH SLTTBL
001D9F F050 C9              10      RET
       F051                     ENASLT_NOEXT_00H:
                                
       F051                     ENASLT_NOEXT:               ;スロットが拡張されていない場合
001DA0 F051 D3A8            11      OUT (0A8H),A
001DA2 F053 C9              10      RET
                                
                                ;
                                ;ページ1専門のENASLT
                                ;in
                                ;A←スロット
                                ;破壊
                                ;ABCHL
                                ;
       F054                     ENASLT_40H:
001DA3 F054 F3               4      DI
001DA4 F055 6F               4      LD  L,A
001DA5 F056 E603             7      AND 3
001DA7 F058 07               4      RLCA
001DA8 F059 07               4      RLCA
001DA9 F05A 4F               4      LD  C,A
001DAA F05B DBA8            11      IN  A,(0A8H)
001DAC F05D 06F3             7      LD  B,0F3H  ;ページ1マスク
001DAE F05F A0               4      AND B
001DAF F060 B1               4      OR  C
001DB0 F061 CB7D             8      BIT 7,L
001DB2 F063 28EC            12      JR  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001DB4 F065 D5              11      PUSH    DE
001DB5 F066 CD2FF0          17      CALL    ENATBL_BIOS_CHECK
001DB8 F069 4F               4      LD  C,A
001DB9 F06A 7B               4      LD  A,E
001DBA F06B CD3B00          17      CALL    ENASUB
001DBD F06E 73               7      LD  (HL),E
001DBE F06F D1              10      POP DE
001DBF F070 C9              10      RET
                                
       F071                     CALLF:
001DC0 F071 E3              19      EX  (SP),HL
001DC1 F072 F5              11      PUSH    AF
001DC2 F073 7E               7      LD  A,(HL)
001DC3 F074 FD67             9      LD  IYH,A
001DC5 F076 23               6      INC HL
001DC6 F077 7E               7      LD  A,(HL)
001DC7 F078 DD6F             9      LD  IXL,A
001DC9 F07A 23               6      INC HL
001DCA F07B 7E               7      LD  A,(HL)
001DCB F07C DD67             9      LD  IXH,A
001DCD F07E 23               6      INC HL
001DCE F07F F1              10      POP AF
001DCF F080 E3              19      EX  (SP),HL
       F081                     CALSLT:
001DD0 F081 F3               4      DI
001DD1 F082 08               4      EX  AF,AF'
001DD2 F083 F5              11      PUSH    AF      ;裏AFを保存
001DD3 F084 E5              11      PUSH    HL
001DD4 F085 210280          10      LD  HL,08002H
001DD7 F088 39              11      ADD HL,SP
001DD8 F089 E1              10      POP HL
001DD9 F08A 3007            12      JR  NC,CALSLT_1
001DDB F08C CDA2F0          17      CALL    CALSLT_2
       F08F                     CALSLT_E:
001DDE F08F 08               4      EX  AF,AF'
001DDF F090 F1              10      POP AF      ;保存した裏AF
001DE0 F091 08               4      EX  AF,AF'
001DE1 F092 C9              10      RET
       F093                     CALSLT_1:
001DE2 F093 ED739EF0        20      LD  (CSSP),SP
001DE6 F097 315DF5          10      LD  SP,SPBUF
001DE9 F09A CDA2F0          17      CALL    CALSLT_2
001DEC F09D 310000          10      LD  SP,0
       F09E                     CSSP    EQU $-2
001DEF F0A0 18ED            12      JR  CALSLT_E
                                
       F0A2                     CALSLT_2:
001DF1 F0A2 E5              11      PUSH    HL
001DF2 F0A3 DD7C             9      LD  A,IXH
001DF4 F0A5 67               4      LD  H,A
001DF5 F0A6 CD40EF          17      CALL    _GETSLT
001DF8 F0A9 FDBC            10      CP  IYH
001DFA F0AB 281E            12      JR  Z,CALSLT_3
001DFC F0AD C5              11      PUSH    BC
001DFD F0AE F5              11      PUSH    AF
001DFE F0AF FD7C             9      LD  A,IYH
001E00 F0B1 CDD9EF          17      CALL    ENASLT
001E03 F0B4 F1              10      POP AF
001E04 F0B5 C1              10      POP BC
001E05 F0B6 6F               4      LD  L,A
001E06 F0B7 DD7C             9      LD  A,IXH
001E08 F0B9 67               4      LD  H,A
001E09 F0BA E3              19      EX  (SP),HL
001E0A F0BB 08               4      EX  AF,AF'
001E0B F0BC CD98F3          17      CALL    JP_IX
001E0E F0BF E3              19      EX  (SP),HL
001E0F F0C0 C5              11      PUSH    BC
001E10 F0C1 08               4      EX  AF,AF'
001E11 F0C2 7D               4      LD  A,L
001E12 F0C3 CDD9EF          17      CALL    ENASLT
001E15 F0C6 08               4      EX  AF,AF'
001E16 F0C7 C1              10      POP BC
001E17 F0C8 E1              10      POP HL
001E18 F0C9 FB               4      EI
001E19 F0CA C9              10      RET
                                
       F0CB                     CALSLT_3:
001E1A F0CB E1              10      POP HL
001E1B F0CC 08               4      EX  AF,AF'
001E1C F0CD DDE9             8      JP  (IX)
                                
       F0CF                     RDSLT:
001E1E F0CF F3               4      DI
001E1F F0D0 D5              11      PUSH    DE
001E20 F0D1 57               4      LD  D,A
001E21 F0D2 CD40EF          17      CALL    _GETSLT
001E24 F0D5 BA               4      CP  D
001E25 F0D6 2812            12      JR  Z,RDSLT1
001E27 F0D8 5F               4      LD  E,A
001E28 F0D9 7A               4      LD  A,D
001E29 F0DA E5              11      PUSH    HL
001E2A F0DB CDD9EF          17      CALL    ENASLT
001E2D F0DE E1              10      POP HL
001E2E F0DF 46               7      LD  B,(HL)
001E2F F0E0 C5              11      PUSH    BC
001E30 F0E1 7B               4      LD  A,E
001E31 F0E2 E5              11      PUSH    HL
001E32 F0E3 CDD9EF          17      CALL    ENASLT
001E35 F0E6 E1              10      POP HL
001E36 F0E7 F1              10      POP AF
001E37 F0E8 D1              10      POP DE
001E38 F0E9 C9              10      RET
       F0EA                     RDSLT1:
001E39 F0EA 7E               7      LD  A,(HL)
001E3A F0EB D1              10      POP DE
001E3B F0EC C9              10      RET
                                
       F0ED                     WRSLT:
001E3C F0ED F3               4      DI
001E3D F0EE D5              11      PUSH    DE
001E3E F0EF 57               4      LD  D,A
001E3F F0F0 CD40EF          17      CALL    _GETSLT
001E42 F0F3 BA               4      CP  D
001E43 F0F4 2810            12      JR  Z,WRSLT1
001E45 F0F6 F5              11      PUSH    AF
001E46 F0F7 E5              11      PUSH    HL
001E47 F0F8 7A               4      LD  A,D
001E48 F0F9 CDD9EF          17      CALL    ENASLT
001E4B F0FC E1              10      POP HL
001E4C F0FD 73               7      LD  (HL),E
001E4D F0FE F1              10      POP AF
001E4E F0FF E5              11      PUSH    HL
001E4F F100 CDD9EF          17      CALL    ENASLT
001E52 F103 E1              10      POP HL
001E53 F104 D1              10      POP DE
001E54 F105 C9              10      RET
                                
       F106                     WRSLT1:
001E55 F106 73               7      LD  (HL),E
001E56 F107 D1              10      POP DE
001E57 F108 C9              10      RET
                                
       F109                     INT38H:
001E58 F109 F3               4      DI
001E59 F10A F5              11      PUSH    AF
001E5A F10B C5              11      PUSH    BC
001E5B F10C E5              11      PUSH    HL
001E5C F10D 210280          10      LD  HL,08002H
001E5F F110 39              11      ADD HL,SP
001E60 F111 380E            12      JR  C,INT38H1
001E62 F113 ED731EF1        20      LD  (INTSP),SP  ;スタックポインタ保存
001E66 F117 315DF5          10      LD  SP,SPBUF
001E69 F11A CD20F0          17      CALL    INT38H_SUB
001E6C F11D 310000          10      LD  SP,0
       F11E                     INTSP   EQU $-2
001E6F F120 AF               4      XOR A
       F121                     INT38H1:
001E70 F121 DC20F0          17      CALL    C,INT38H_SUB
001E73 F124 E1              10      POP HL
001E74 F125 C1              10      POP BC
001E75 F126 F1              10      POP AF
001E76 F127 FB               4      EI
001E77 F128 C9              10      RET
                                ;
                                ;   ページ1のディスクの読み込み補助
                                ;
       F129                     LDIR_PAGE1_RAM:
001E78 F129 CD54F0          17      CALL    ENASLT_40H
001E7B F12C C1              10      POP BC
001E7C F12D D1              10      POP DE
001E7D F12E 215EF5          10      LD  HL,BUF
001E80 F131 EDB0                    LDIR
001E82 F133 3A97F2          13      LD  A,(ROM_SLT)
001E85 F136 CD54F0          17      CALL    ENASLT_40H
001E88 F139 C34846          10      JP  LDIR_PAGE1_ROM
                                ;
                                ;   フック関数を呼び出す
                                ;
       F13C                     CALL_RF:
001E8B F13C E1              10      POP HL
001E8C F13D 7E               7      LD  A,(HL)
001E8D F13E DD6F             9      LD  IXL,A
001E8F F140 23               6      INC HL
001E90 F141 7E               7      LD  A,(HL)
001E91 F142 DD67             9      LD  IXH,A
001E93 F144 FD2A96F2        20      LD  IY,(ROM_SLT-1)
001E97 F148 CD1C00          17      CALL    _CALSLT
001E9A F14B D8              11      RET C
001E9B F14C F1              10      POP AF
001E9C F14D C9              10      RET
       F14E                     ISC_E:
                                #endif
001E9D 5E9D                         ORG $$+RUN,$$   ;$DEPHASE
       5E9D                     AT_ISCB:
001E9D F280                         ORG ISCB,AT_ISCB-RUN
                                
       F280                     REPLACE_COMMAND:
001E9D F280 FEB7             7      CP  0B7H            ;FILES
001E9F F282 CC7BFE          17      CALL    Z,H_FILE
001EA2 F285 FEB5             7      CP  0B5H            ;LOAD
001EA4 F287 CA71FE          10      JP  Z,H_BINS
001EA7 F28A FE8A             7      CP  08AH            ;RUN
001EA9 F28C CA76FE          10      JP  Z,H_BINL
001EAC F28F FED6             7      CP  0D6H            ;COPY
001EAE F291 2813            12      JR  Z,FIX_COPY
001EB0 F293 FECF             7      CP  0CFH            ;BLOAD
001EB2 F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
001EB3 F296 F7              12      RST 30H
       F297                     ROM_SLT:
001EB4 F297 00                      DB  0
001EB5 F298 1748                    DW  ROM_BLOAD
001EB7 F29A F5              11      PUSH    AF
001EB8 F29B E5              11      PUSH    HL
001EB9 F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
001EBC F29F E1              10      POP HL
001EBD F2A0 F1              10      POP AF
001EBE F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
001EC0 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
001EC2 F2A5 C9              10      RET
       F2A6                     FIX_COPY:
001EC3 F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
001EC4 F2A7 00                      DB  0
001EC5 F2A8 9849                    DW  ROM_COPY
001EC7 F2AA C9              10      RET
       F2AB                     RAMUSE1:
001EC8 F2AB 3A42F3          13      LD  A,(RAMAD1)
001ECB F2AE 180E            12      JR  _ENASLT_40H
       F2B0                     CAL_MP:
001ECD F2B0 2640             7      LD  H,040H
001ECF F2B2 3AC1FC          13      LD  A,(EXPTBL)
001ED2 F2B5 CD2400          17      CALL    _ENASLT
001ED5 F2B8 CD1C00          17      CALL    _CALSLT
       F2BB                     ROMUSE1:
001ED8 F2BB 3A97F2          13      LD  A,(ROM_SLT)
       F2BE                     _ENASLT_40H:
001EDB F2BE 2640             7      LD  H,040H
001EDD F2C0 C32400          10      JP  _ENASLT
                                
       F2C3                     _RESULT:
001EE0 F2C3 00                      DB  0
       F2C4                     _BANK:
001EE1 F2C4 00                      DB  0
       F2C5                     _BANK1:
001EE2 F2C5 00                      DB  0
       F2C6                     CLSZ:               ;クラスタサイズ
001EE3 F2C6 0004                    DW  1024
       F2C7                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2C8                     SECSZ:              ;セクタサイズ
001EE5 F2C8 0002                    DW  512
       F2C9                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2CA                     RR_LOW:
001EE7 F2CA 0000                    DW  0
       F2CB                     RR_MID  EQU $-1
       F2CC                     RR_HIGH:
001EE9 F2CC 0000                    DW  0
       F2CE                     _CLPS:
001EEB F2CE 0000                    DW  0
       F2D0                     _LEFT:
001EED F2D0 0000                    DW  0
       F2D2                     _DTPS:
001EEF F2D2 0000                    DW  0
       F2D4                     _DTA:
001EF1 F2D4 0000                    DW  0
       F2D6                     FLG_LDIR:
001EF3 F2D6 00                      DB  0
       F2D7                     _FCB:
001EF4 F2D7 0000                    DW  0
       F2D9                     _BUF:
       F2D9                     _BUF_LO:        ;LOGICAL OPERATION
001EF6 F2D9 00                      DB  0
       F2DA                     _BUF_ST:
001EF7 F2DA 0000                    DW  0
       F2DC                     _BUF_EN:
001EF9 F2DC 0000                    DW  0
       F2DE                     _BUF_EX:
       F2DE                     _BUF_W:
001EFB F2DE 0000                    DW  0
       F2E0                     _BUF_H:
001EFD F2E0 0000                    DW  0
       F2E2                     _BUF_X:
001EFF F2E2 0000                    DW  0
       F2E4                     _BUF_Y:
001F01 F2E4 00                      DB  0
       F2E5                     _BUF_P:
001F02 F2E5 00                      DB  0
       F2E6                     _BUF_O:
001F03 F2E6 00                      DB  0
       F2E7                     DTAX:
001F04 F2E7 0000                    DW  0
       F2E9                     B_DRIVE:
001F06 F2E9 00                      DB  0
       F2EA                     _DVSW:          ;カレントドライブ
001F07 F2EA 00                      DB  0
       F2EB                     _CD_A:          ;カレントディレクトリ A:
001F08 F2EB 0000                    DW  0
       F2ED                     _CD_B:          ;カレントディレクトリ B:
001F0A F2ED 0000                    DW  0
       F2EF                     DIRENT1:
001F0C F2EF 0000                    DW  0
       F2F1                     _DIR_BANK:
001F0E F2F1 00                      DB  0
       F2F2                     _LVECTOR:
001F0F F2F2 01                      DB  1
       F2F3                     LEFTX:
001F10 F2F3 0000                    DW  0
       F2F5                     PARAM0:
001F12 F2F5 0000                    DW  0
       F2F7                     PARAM1:
001F14 F2F7 0000                    DW  0
       F2F9                     _CDX:
001F16 F2F9 0000                    DW  0
       F2FB                     _CHKSP:
001F18 F2FB 1F                      DB  01FH
       F2FC                     _HL:
001F19 F2FC 0000                    DW  0
       F2FE                     _SP:
001F1B F2FE 0000                    DW  0
       F2FF                     _SP_H   EQU $-1
       F300                     FDRV:
001F1D F300 00                      DB  0
       F301                     FNAME:
001F1E F301                         DS  8+3
       F30C                     IS_BIOS:            ;C-BIOSの場合は0
001F29 F30C FF                      DB  0FFH
                                
       F30D                     ISCB_E:
[EOF:SLOT.ASM:UTF_8]
       1F2A                     LAST    EQU $$
001F2A F30D                         DS  01FFFH-LAST
001FFF F3E2 00                      DB  0
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
[EOF:DISKROM64K.ASM:UTF_8]
