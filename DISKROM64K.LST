                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
       0001                     _RAM64K     EQU 1   ;メインRAM 64KB使用可能
                                
                                    INCLUDE "DISKROM.ASM"
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00AE                     PLININ  EQU 000AEH
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
       0159                     CALBAS  EQU 00159H
       01F5                     REDCLK  EQU 001F5H  ;SUB
       01F9                     WRTCLK  EQU 001F9H  ;SUB
                                
       269A                     DECADD  EQU 0269AH
       27E6                     DECMUL  EQU 027E6H
       2F8A                     FRCINT  EQU 02F8AH
                                
       303A                     FRCDBL  EQU 0303AH
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
       7D17                     ST_BAS  EQU 07D17H
                                
       F323                     DISKVE  EQU 0F323H
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F398                     JP_IX   EQU 0F398H
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F847                     ARG EQU 0F847H
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
       FAF8                     EXBRSA  EQU 0FAF8H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBB1                     BASROM  EQU 0FBB1H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCC5                     SLTTBL  EQU 0FCC5H
       FCC9                     SLTATR  EQU 0FCC9H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
       FD99                     DEVICE  EQU 0FD99H
                                
       FDDB                     H_PINL  EQU 0FDDBH
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       C000                     FD_BOOT_START   EQU 0C000H
       C01E                     FD_BOOT_EXEC    EQU 0C01EH
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                            ;ASCII-16K
                                ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
                                ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
                                
       EF80                     ISC EQU 0EF80H
       F280                     ISCB    EQU 0F280H
                                
       EF80                     NEW_HIMEM   EQU ISC
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F55D                     SPBUF   EQU KBUF+318    ;ページ3にスタックがない場合はKBUFを一時的に使う
                                
       003B                     ENASUB  EQU 0003BH
       F55E                     SYS1B_DPB   EQU BUF
       F571                     SYS1B_FAT   EQU SYS1B_DPB+19
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0042                    DW  INIT_ROM    ; Main program execution address.
000004 4004 C94F                    DW  STATEMENT   ; STATEMENT
000006 4006 FD50                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C35352          10      JP  DISKIO
000013 4013 C39552          10      JP  DSKCHG
000016 4016 C3EB52          10      JP  GETDPB
000019 4019 C3DE53          10      JP  CHOICE
00001C 401C C3E253          10      JP  DSKFMT
00001F 401F C3E453          10      JP  DSKSTP
000022 4022 C3E553          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C3E253          10      JP  DSKFMT
000029 4029 C3E453          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C35054          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite"
            204449534B20524F    
            4D204C697465        
000096 4096                         ALIGN   32
0000A0 40A0 76302E372E312E30        DB  "v0.7.1.0"
0000A8 40A8                         ALIGN   32
       40C0                     MSG_ERROR_ROM_MODE:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DB  "Normal ROM/ASCII-16K only!",13,10
                                #else
0000C0 40C0 41534349492D384B        DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
            2F4B6F6E616D692D    
            384B2F4B6F6E616D    
            692D534343206F6E    
            6C79210D0A          
                                #endif
0001BD 41BD                         ORG 041BDH
0001BD 41BD C9              10      RET
                                
                                    ;MBR_Partition1 (2DDのデータ)
0001BE 41BE 00                      DB  0       ;ブートフラグ
0001BF 41BF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001C2 41C2 01                      DB  1       ;識別子(FAT12)
0001C3 41C3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001C6 41C6 10000000                DW  16,0        ;パーティションの最初のセクタ番号(LBA方式)
0001CA 41CA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                    ;MBR_Partition2 (2DDのデータ)
0001CE 41CE 00                      DB  0       ;ブートフラグ
0001CF 41CF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001D2 41D2 01                      DB  1       ;識別子(FAT12)
0001D3 41D3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001D6 41D6 B0050000                DW  16+1440,0   ;パーティションの最初のセクタ番号(LBA方式)
0001DA 41DA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                #endif
                                
0001FE 41FE                         ORG 041FEH
0001FE 41FE 55AA                    DB  055H,0AAH   ;MBR_Sig
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4200                     INIT_ROM:
000200 4200 AF               4      XOR A
000201 4201 2100F3          10      LD  HL,0F300H
000204 4204 0668             7      LD  B,068H
000206 4206 CD7D4C          17      CALL    FILL_MEMORY
                                
000209 4209 3E01             7      LD  A,1
00020B 420B 3221FB          13      LD  (DRVTBL),A
                                
00020E 420E 2A4AFC          16      LD  HL,(HIMEM)
000211 4211 1180EF          10      LD  DE,NEW_HIMEM
000214 4214 A7               4      AND A
000215 4215 ED52            15      SBC HL,DE
000217 4217 3820            12      JR  C,INIT1
000219 4219 EB               4      EX  DE,HL
00021A 421A 2A74F6          16      LD  HL,(STKTOP)
00021D 421D ED52            15      SBC HL,DE
00021F 421F 2274F6          16      LD  (STKTOP),HL ;起動時の空き容量表示の為
000222 4222 F9               6      LD  SP,HL
000223 4223 2A72F6          16      LD  HL,(MEMSIZ)
000226 4226 ED52            15      SBC HL,DE
000228 4228 2272F6          16      LD  (MEMSIZ),HL
00022B 422B 2A9BF6          16      LD  HL,(FRETOP)
00022E 422E ED52            15      SBC HL,DE
000230 4230 229BF6          16      LD  (FRETOP),HL
000233 4233 2180EF          10      LD  HL,NEW_HIMEM
000236 4236 224AFC          16      LD  (HIMEM),HL
       4239                     INIT1:
000239 4239 AF               4      XOR A
00023A 423A 32EAF2          13      LD  (_DVSW),A
00023D 423D 3D               4      DEC A       ;0FFH
00023E 423E 3299FD          13      LD  (DEVICE),A
                                
                                #if exists _RAM64K
000241 4241 21575A          10      LD  HL,AT_ISC
000244 4244 1180EF          10      LD  DE,ISC
000247 4247 015B01          10      LD  BC,ISC_E-ISC
00024A 424A EDB0                    LDIR
                                #endif
00024C 424C 21B25B          10      LD  HL,AT_ISCB
00024F 424F 1180F2          10      LD  DE,ISCB
000252 4252 018900          10      LD  BC,ISCB_E-ISCB
000255 4255 EDB0                    LDIR
000257 4257 2AB1F6          16      LD  HL,(SAVSTK)
00025A 425A 224BF3          16      LD  (0F34BH),HL
                                
00025D 425D 3EC3             7      LD  A,0C3H      ;JP
00025F 425F 3243FF          13      LD  (H_GONE),A
000262 4262 327DF3          13      LD  (BDOS),A
000265 4265 326BF3          13      LD  (RAMUSE),A
000268 4268 3268F3          13      LD  (ROMUSE),A
00026B 426B 2180F2          10      LD  HL,REPLACE_COMMAND
00026E 426E 2244FF          16      LD  (H_GONE+1),HL
000271 4271 2131F3          10      LD  HL,H_BDOS
000274 4274 227EF3          16      LD  (BDOS+1),HL
000277 4277 21ABF2          10      LD  HL,RAMUSE1
00027A 427A 226CF3          16      LD  (RAMUSE+1),HL
00027D 427D 21BBF2          10      LD  HL,ROMUSE1
000280 4280 2269F3          16      LD  (ROMUSE+1),HL
                                
000283 4283 3E                      DB  03EH
000284 4284 F7              12      RST 30H
000285 4285 3271FE          13      LD  (H_BINS),A
000288 4288 3276FE          13      LD  (H_BINL),A
00028B 428B 327BFE          13      LD  (H_FILE),A
00028E 428E 3231F3          13      LD  (H_BDOS),A
000291 4291 32A7FF          13      LD  (H_PHYD),A
                                
000294 4294 CD1244          17      CALL    GTSL1_
000297 4297 3297F2          13      LD  (ROM_SLT),A
00029A 429A 32A7F2          13      LD  (ROM_SLT_COPY),A
00029D 429D 3272FE          13      LD  (H_BINS+1),A
0002A0 42A0 3277FE          13      LD  (H_BINL+1),A
0002A3 42A3 327CFE          13      LD  (H_FILE+1),A
0002A6 42A6 3232F3          13      LD  (H_BDOS+1),A
0002A9 42A9 32A8FF          13      LD  (H_PHYD+1),A
0002AC 42AC 3222FB          13      LD  (DRVTBL+1),A
0002AF 42AF 3248F3          13      LD  (MASTERS),A
0002B2 42B2 217D46          10      LD  HL,ROM_LOAD
0002B5 42B5 2273FE          16      LD  (H_BINS+2),HL
0002B8 42B8 213148          10      LD  HL,ROM_RUN
0002BB 42BB 2278FE          16      LD  (H_BINL+2),HL
0002BE 42BE 213F48          10      LD  HL,ROM_FILES
0002C1 42C1 227DFE          16      LD  (H_FILE+2),HL
0002C4 42C4 21C454          10      LD  HL,ROM_BDOS
0002C7 42C7 2233F3          16      LD  (H_BDOS+2),HL
0002CA 42CA 215352          10      LD  HL,DISKIO
0002CD 42CD 22A9FF          16      LD  (H_PHYD+2),HL
                                
0002D0 42D0 3E                      DB  03EH
0002D1 42D1 C9              10      RET
0002D2 42D2 327FFE          13      LD  (H_FILE+4),A
0002D5 42D5 3275FE          13      LD  (H_BINS+4),A
0002D8 42D8 327AFE          13      LD  (H_BINL+4),A
0002DB 42DB 3235F3          13      LD  (H_BDOS+4),A
0002DE 42DE 32DFFD          13      LD  (H_PINL+4),A
0002E1 42E1 32ABFF          13      LD  (H_PHYD+4),A
                                
0002E4 42E4 AF               4      XOR A
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK0_SEL),A       ;似非RAM対策でバンク0を設定
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0002E5 42E5 320060          13      LD  (BANK0_SEL),A           ;似非RAM対策でバンク0を設定
0002E8 42E8 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0002EB 42EB 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0002EE 42EE 3A0060          13      LD  A,(BANK1_ADR)
0002F1 42F1 FE41             7      CP  'A'
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JP  Z,NOT_BANK_TYPE
                                    LD  A,DISK_BANK
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0002F3 42F3 C20144          10      JP  NZ,NOT_BANK_TYPE
0002F6 42F6 3E01             7      LD  A,DISK_BANK
0002F8 42F8 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0002FB 42FB 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0002FE 42FE CD3801          17      CALL    RSLREG      ;read primary slot #
000301 4301 07               4      RLCA
000302 4302 07               4      RLCA
000303 4303 F5              11      PUSH    AF
000304 4304 1605             7      LD  D,4+1
000306 4306 CD1944          17      CALL    GTSL2_
000309 4309 3244F3          13      LD  (RAMAD3),A
00030C 430C F1              10      POP AF
00030D 430D 07               4      RLCA
00030E 430E 07               4      RLCA
00030F 430F 1603             7      LD  D,2+1
000311 4311 CD1944          17      CALL    GTSL2_
000314 4314 2680             7      LD  H,080H
000316 4316 CD3644          17      CALL    CHK_RAM
000319 4319 3243F3          13      LD  (RAMAD2),A
       431C                     RAMCHK2:
00031C 431C 3A44F3          13      LD  A,(RAMAD3)
00031F 431F 2640             7      LD  H,040H
000321 4321 CD3644          17      CALL    CHK_RAM
000324 4324 3242F3          13      LD  (RAMAD1),A
       4327                     RAMCHK1:
000327 4327 3A44F3          13      LD  A,(RAMAD3)
00032A 432A 2600             7      LD  H,00H
00032C 432C CD3644          17      CALL    CHK_RAM
00032F 432F 3241F3          13      LD  (RAMAD0),A
       4332                     RAMCHK0:
000332 4332 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16
000335 4335 010F00          10      LD  BC,0000FH       ;切り上げ
000338 4338 09              11      ADD HL,BC
000339 4339 7D               4      LD  A,L
                                
00033A 433A 0604             7      LD  B,4
       433C                     B_DRIVE1:
00033C 433C CB3C             8      SRL H
00033E 433E 1F               4      RRA
00033F 433F 10FB            13      DJNZ    B_DRIVE1
                                
000341 4341 C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000343 4343 32E9F2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
                                    ;拡張スロットの選択を設定する
000346 4346 3A97F2          13      LD  A,(ROM_SLT)
000349 4349 57               4      LD  D,A
00034A 434A E60C             7      AND 00CH
00034C 434C 5F               4      LD  E,A
00034D 434D 7A               4      LD  A,D
00034E 434E E603             7      AND 3
000350 4350 87               4      ADD A,A
000351 4351 87               4      ADD A,A
000352 4352 87               4      ADD A,A
000353 4353 37               4      SCF
000354 4354 8F               4      ADC A,A
000355 4355 B3               4      OR  E
000356 4356 5F               4      LD  E,A
000357 4357 1600             7      LD  D,0
000359 4359 21C9FC          10      LD  HL,SLTATR
00035C 435C 19              11      ADD HL,DE
00035D 435D 3660            10      LD  (HL),060H
                                
00035F 435F 3E01             7      LD  A,1
000361 4361 CDCE52          17      CALL    IS_BPB
000364 4364 9F               4      SBC A,A
000365 4365 E602             7      AND 2
000367 4367 EE03             7      XOR 3
000369 4369 32F0F2          13      LD  (_LVECTOR),A
                                    ;CTRL+STOPを抑制する
00036C 436C 3E01             7      LD  A,1
00036E 436E 32B1FB          13      LD  (BASROM),A
                                
000371 4371 3ACAFF          13      LD  A,(EXTBIO)
000374 4374 FEF7             7      CP  0F7H        ;RST 30H
000376 4376 280A            12      JR  Z,EXTBIO_OK
000378 4378 3E                      DB  03EH
000379 4379 C9              10      RET
00037A 437A 21CAFF          10      LD  HL,EXTBIO
00037D 437D 061D             7      LD  B,29
00037F 437F CD7D4C          17      CALL    FILL_MEMORY
       4382                     EXTBIO_OK:
000382 4382 AF               4      XOR A
000383 4383 3240F3          13      LD  (REBOOT),A
000386 4386 2A48FC          16      LD  HL,(BOTTOM)
000389 4389 110040          10      LD  DE,16384
00038C 438C 19              11      ADD HL,DE
00038D 438D DAFE43          10      JP  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
000390 4390 57               4      LD  D,A
000391 4391 0601             7      LD  B,1
000393 4393 2100C0          10      LD  HL,FD_BOOT_START
000396 4396 CD5352          17      CALL    DISKIO
                                
000399 4399 1168F3          10      LD  DE,ROMUSE
00039C 439C 2123F3          10      LD  HL,DISKVE
00039F 439F AF               4      XOR A
0003A0 43A0 CD1EC0          17      CALL    FD_BOOT_EXEC
                                #if exists _RAM64K
                                                ;64K版の場合はページ0をRAMに切り替えRAM側にインタースロットコールを入れる
0003A3 43A3 3A41F3          13      LD  A,(RAMAD0)  ;ページ0をRAMに切り替える
0003A6 43A6 CD095A          17      CALL    ENASLT_00H
                                
0003A9 43A9 AF               4      XOR A
0003AA 43AA 47               4      LD  B,A
0003AB 43AB 67               4      LD  H,A
0003AC 43AC 6F               4      LD  L,A
0003AD 43AD CD7D4C          17      CALL    FILL_MEMORY
                                
0003B0 43B0 3EC3             7      LD  A,0C3H      ;JP
                                                ;インタースロットコール
0003B2 43B2 2192F0          10      LD  HL,RDSLT
0003B5 43B5 320C00          13      LD  (_RDSLT),A
0003B8 43B8 220D00          16      LD  (_RDSLT+1),HL
                                
0003BB 43BB 21A0F0          10      LD  HL,WRSLT
0003BE 43BE 321400          13      LD  (_WRSLT),A
0003C1 43C1 221500          16      LD  (_WRSLT+1),HL
                                
0003C4 43C4 2151F0          10      LD  HL,CALSLT
0003C7 43C7 321C00          13      LD  (_CALSLT),A
0003CA 43CA 221D00          16      LD  (_CALSLT+1),HL
                                
0003CD 43CD 2180EF          10      LD  HL,ENASLT
0003D0 43D0 322400          13      LD  (_ENASLT),A
0003D3 43D3 222500          16      LD  (_ENASLT+1),HL
                                
0003D6 43D6 2141F0          10      LD  HL,CALLF
0003D9 43D9 323000          13      LD  (_CALLF),A
0003DC 43DC 223100          16      LD  (_CALLF+1),HL
                                                ;割り込み
0003DF 43DF 21ACF0          10      LD  HL,INT38H
0003E2 43E2 323800          13      LD  (00038H),A
0003E5 43E5 223900          16      LD  (00038H+1),HL
                                                ;インタースロットコールの補助
0003E8 43E8 21475A          10      LD  HL,AT_3B
0003EB 43EB 113B00          10      LD  DE,ENASUB
0003EE 43EE 011000          10      LD  BC,AT_3B_E-AT_3B
0003F1 43F1 EDB0                    LDIR
                                
0003F3 43F3 1168F3          10      LD  DE,ROMUSE
0003F6 43F6 2123F3          10      LD  HL,DISKVE
0003F9 43F9 AF               4      XOR A
0003FA 43FA 37               4      SCF
0003FB 43FB CD1EC0          17      CALL    FD_BOOT_EXEC
                                #endif
       43FE                     BOOT1:
0003FE 43FE C3E553          10      JP  BASENT
                                
       4401                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
000401 4401 21C040          10      LD  HL,MSG_ERROR_ROM_MODE
000404 4404 CDD944          17      CALL    MSX
000407 4407 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00040B 440B DD219F00        14      LD  IX,CHGET
00040F 440F C31C00          10      JP  _CALSLT
                                
       4412                     GTSL1_:             ;自分のいるスロットを知る
000412 4412 CD3801          17      CALL    RSLREG      ;read primary slot #
000415 4415 0F               4      RRCA
000416 4416 0F               4      RRCA
000417 4417 1601             7      LD  D,1
       4419                     GTSL2_:
000419 4419 E603             7      AND 3       ;[A]=000000PP
00041B 441B 5F               4      LD  E,A     ;[E]=000000PP
00041C 441C 21C1FC          10      LD  HL,EXPTBL
00041F 441F 85               4      ADD A,L     ;桁上りは無い
000420 4420 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000421 4421 7B               4      LD  A,E     ;[A]=000000PP
000422 4422 CB7E            13      BIT 7,(HL)
000424 4424 C8              11      RET Z
000425 4425 7D               4      LD  A,L     ;point to SLTTBL entry
000426 4426 C604             7      ADD A,4     ;桁上りは無い
000428 4428 6F               4      LD  L,A
000429 4429 7E               7      LD  A,(HL)      ;get currently expansion slot register
       442A                     GTSL3_:
00042A 442A 15               4      DEC D
00042B 442B 2803            12      JR  Z,GTSL4_:
00042D 442D 0F               4      RRCA
00042E 442E 18FA            12      JR  GTSL3_:
       4430                     GTSL4_:
000430 4430 E60C             7      AND 00CH        ;[A] = 0000SS00
000432 4432 B3               4      OR  E       ;[A] = 0000SSPP
000433 4433 F680             7      OR  080H        ;[A] = 1000SSPP
000435 4435 C9              10      RET
                                
       4436                     CHK_RAM:
000436 4436 E5              11      PUSH    HL
000437 4437 CD8B44          17      CALL    CHK_RAM0
00043A 443A E1              10      POP HL
00043B 443B C8              11      RET Z
00043C 443C 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
00043F 443F E680             7      AND 080H
000441 4441 CD6244          17      CALL    CHK_RAM_SLT
000444 4444 C8              11      RET Z
000445 4445 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000448 4448 E680             7      AND 080H
00044A 444A C601             7      ADD A,1
00044C 444C CD6244          17      CALL    CHK_RAM_SLT
00044F 444F C8              11      RET Z
000450 4450 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000453 4453 E680             7      AND 080H
000455 4455 C602             7      ADD A,2
000457 4457 CD6244          17      CALL    CHK_RAM_SLT
00045A 445A C8              11      RET Z
00045B 445B 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
00045E 445E E680             7      AND 080H
000460 4460 C603             7      ADD A,3
       4462                     CHK_RAM_SLT:
000462 4462 E5              11      PUSH    HL
000463 4463 CD8B44          17      CALL    CHK_RAM0        ;スロット#X or X-0
000466 4466 E1              10      POP HL
000467 4467 C8              11      RET Z
000468 4468 CB79             8      BIT 7,C
00046A 446A 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
00046C 446C 79               4      LD  A,C
00046D 446D C604             7      ADD A,4*1           ;スロット#X-1
00046F 446F E5              11      PUSH    HL
000470 4470 CD8B44          17      CALL    CHK_RAM0
000473 4473 E1              10      POP HL
000474 4474 C8              11      RET Z
000475 4475 79               4      LD  A,C
000476 4476 C608             7      ADD A,4*2           ;スロット#X-2
000478 4478 E5              11      PUSH    HL
000479 4479 CD8B44          17      CALL    CHK_RAM0
00047C 447C E1              10      POP HL
00047D 447D C8              11      RET Z
00047E 447E 79               4      LD  A,C
00047F 447F C60C             7      ADD A,4*3           ;スロット#X-3
000481 4481 E5              11      PUSH    HL
000482 4482 CD8B44          17      CALL    CHK_RAM0
000485 4485 E1              10      POP HL
       4486                     CHK_RAM_E:
000486 4486 AF               4      XOR A
000487 4487 3C               4      INC A           ;ZF=0にする
000488 4488 3E00             7      LD  A,0
00048A 448A C9              10      RET
                                
       448B                     CHK_RAM0:
00048B 448B 4F               4      LD  C,A
00048C 448C 3A97F2          13      LD  A,(ROM_SLT)
00048F 448F B9               4      CP  C
000490 4490 28F4            12      JR  Z,CHK_RAM_E
000492 4492 2E00             7      LD  L,0
       4494                     CHK_RAM1:
000494 4494 79               4      LD  A,C
000495 4495 CD0945          17      CALL    RDSLTX
000498 4498 C6E5             7      ADD A,0E5H
00049A 449A 47               4      LD  B,A
00049B 449B 5F               4      LD  E,A
00049C 449C 79               4      LD  A,C
00049D 449D C5              11      PUSH    BC
00049E 449E CD1400          17      CALL    _WRSLT
0004A1 44A1 C1              10      POP BC
0004A2 44A2 79               4      LD  A,C
0004A3 44A3 CD0945          17      CALL    RDSLTX
0004A6 44A6 B8               4      CP  B
0004A7 44A7 C0              11      RET NZ
0004A8 44A8 D6E5             7      SUB 0E5H
0004AA 44AA 79               4      LD  A,C
0004AB 44AB 5F               4      LD  E,A
0004AC 44AC C5              11      PUSH    BC
0004AD 44AD CD1400          17      CALL    _WRSLT
0004B0 44B0 C1              10      POP BC
0004B1 44B1 24               4      INC H
0004B2 44B2 7D               4      LD  A,L
0004B3 44B3 C604             7      ADD A,4
0004B5 44B5 6F               4      LD  L,A
0004B6 44B6 20DC            12      JR  NZ,CHK_RAM1
0004B8 44B8 79               4      LD  A,C     ;ZF=1のハズ
0004B9 44B9 C9              10      RET
                                
       44BA                     CALSLT_R:
0004BA 44BA C5              11      PUSH    BC
0004BB 44BB E5              11      PUSH    HL
0004BC 44BC F5              11      PUSH    AF
0004BD 44BD 3A0000          13      LD  A,(0000H)
0004C0 44C0 FEF3             7      CP  0F3H        ;0000H が DI の場合はページ0を BIOS ROM とみなす
0004C2 44C2 280B            12      JR  Z,CALSLT_R2
0004C4 44C4 F1              10      POP AF
0004C5 44C5 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0004C9 44C9 CD1C00          17      CALL    _CALSLT
0004CC 44CC E1              10      POP HL
0004CD 44CD C1              10      POP BC
0004CE 44CE C9              10      RET
       44CF                     CALSLT_R2:
0004CF 44CF F1              10      POP AF
0004D0 44D0 CD98F3          17      CALL    JP_IX
0004D3 44D3 E1              10      POP HL
0004D4 44D4 C1              10      POP BC
0004D5 44D5 C9              10      RET
                                
       44D6                     MSX1:
0004D6 44D6 CDDD54          17      CALL    MSGA1
       44D9                     MSX:
0004D9 44D9 7E               7      LD  A,(HL)
0004DA 44DA 23               6      INC HL
0004DB 44DB B7               4      OR  A
0004DC 44DC 20F8            12      JR  NZ,MSX1
0004DE 44DE C9              10      RET
                                
       44DF                     PRTHX:
0004DF 44DF F5              11      PUSH    AF
0004E0 44E0 07               4      RLCA
0004E1 44E1 07               4      RLCA
0004E2 44E2 07               4      RLCA
0004E3 44E3 07               4      RLCA
0004E4 44E4 CDE844          17      CALL    PRTA2
0004E7 44E7 F1              10      POP AF
       44E8                     PRTA2:
0004E8 44E8 CDEE44          17      CALL    ASC
0004EB 44EB C3D954          10      JP  MSG_A
                                
       44EE                     ASC:
0004EE 44EE E60F             7      AND $0F
0004F0 44F0 F630             7      OR  $30
0004F2 44F2 FE3A             7      CP  $3A
0004F4 44F4 D8              11      RET C
0004F5 44F5 C607             7      ADD A,7
0004F7 44F7 C9              10      RET
                                
       44F8                     MSN:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
0004F8 44F8 7E               7      LD  A,(HL)
                                #endif
0004F9 44F9 23               6      INC HL
0004FA 44FA CDD954          17      CALL    MSG_A
0004FD 44FD 10F9            13      DJNZ    MSN
0004FF 44FF C9              10      RET
                                
       4500                     RDSLT_ROM3:
000500 4500 7E               7      LD  A,(HL)
000501 4501 C9              10      RET
       4502                     RDSLT_ROM:
000502 4502 CB7C             8      BIT 7,H
000504 4504 28FA            12      JR  Z,RDSLT_ROM3
       4506                     RDSLT_ROM2:
000506 4506 3A97F2          13      LD  A,(ROM_SLT)
       4509                     RDSLTX:
000509 4509 C5              11      PUSH    BC
00050A 450A D5              11      PUSH    DE
00050B 450B CD0C00          17      CALL    _RDSLT
00050E 450E D1              10      POP DE
00050F 450F C1              10      POP BC
000510 4510 C9              10      RET
                                
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
                                ;
                                ;   ディスクからメモリへの転送
                                ;
       4511                     ROM_LDIR:
000511 4511 3AD6F2          13      LD  A,(FLG_LDIR)
000514 4514 B7               4      OR  A
000515 4515 2008            12      JR  NZ,ROM_LDIRVM
000517 4517 CB7A             8      BIT 7,D
000519 4519 CA3145          10      JP  Z,ROM_LDIRSLT
                                ;
                                ;   ページ2/ページ3
                                ;
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ1
                                    LD  SP,SPBUF
                                SPJ1:
                                LDIR_PAGE2_1:
                                    LD  A,B
                                    OR  C
                                    JR  Z,LDIRE
                                
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                LDIR_PAGE2_2:
                                    BIT 6,D
                                    JR  NZ,LDIR_PAGE2_4
                                
                                    PUSH    BC
                                    PUSH    DE
                                    LD  DE,BUF
                                
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIR_PAGE2_3
                                    LD  BC,00100H       ;B != 0 の場合は256バイトずつ転送
                                LDIR_PAGE2_3:
                                    PUSH    BC
                                    LDIR
                                    LD  (_HL),HL
                                
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                
                                    POP BC
                                    POP DE
                                    LD  HL,BUF
                                    LDIR
                                
                                    LD  HL,(_HL)
                                    POP BC
                                    LD  A,B
                                    OR  A
                                    JR  Z,LDIRE
                                    DEC B
                                    JR  LDIR_PAGE2_1
                                LDIR_PAGE2_4:               ;ページ3
                                #endif
00051C 451C EDB0                    LDIR
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                LDIRE2:
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(RAMAD2)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                LDIRE:
                                    LD  SP,(_SP)
                                #else
       451E                     LDIRE2:
                                #endif
00051E 451E C9              10      RET
                                ;
                                ;   ディスクからV-RAMへの転送
                                ;
       451F                     ROM_LDIRVM:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ2
                                    LD  SP,SPBUF
                                SPJ2:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
00051F 451F C5              11      PUSH    BC
000520 4520 D5              11      PUSH    DE
000521 4521 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000525 4525 DD215C00        14      LD  IX,LDIRVM
000529 4529 CD1C00          17      CALL    _CALSLT
00052C 452C E1              10      POP HL
00052D 452D C1              10      POP BC
00052E 452E 09              11      ADD HL,BC
00052F 452F EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JR  LDIRE2
                                #else
000530 4530 C9              10      RET
                                #endif
                                ;
                                ;   ページ0/ページ1
                                ;
       4531                     ROM_LDIRSLT:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    DI
                                    LD  (_SP),SP
                                    LD  A,(_SP_H)
                                    CP  0C0H
                                    JR  NC,SPJ3
                                    LD  SP,SPBUF
                                SPJ3:
                                    PUSH    BC
                                    PUSH    DE
                                    PUSH    HL
                                    LD  A,(ROM_SLT)
                                    LD  H,080H
                                    CALL    _ENASLT
                                    POP HL
                                    POP DE
                                    POP BC
                                #endif
                                                ;ページ0
000531 4531 3A0000          13      LD  A,(0000H)
000534 4534 FEF3             7      CP  0F3H        ;0000H が DI じゃない場合はページ0は RAM とみなす
000536 4536 280A            12      JR  Z,LDIR_PAGE0_SLT
       4538                     LDIR_PAGE0_1:
000538 4538 CB72             8      BIT 6,D
00053A 453A 2022            12      JR  NZ,LDIR_PAGE1
00053C 453C EDA0            16      LDI         ;ページ0 直接転送
00053E 453E EA3845          10      JP  PE,LDIR_PAGE0_1
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JP  LDIRE2
                                #else
000541 4541 C9              10      RET
                                #endif
                                
       4542                     LDIR_PAGE0_SLT:     ;ページ0 WRSLTを使用
000542 4542 EB               4      EX  DE,HL       ;転送方向(DE)→(HL)
       4543                     LDIR_PAGE0_SLT1:
000543 4543 CB74             8      BIT 6,H
000545 4545 2016            12      JR  NZ,LDIR_PAGE1_DEHL
000547 4547 1A               7      LD  A,(DE)
000548 4548 13               6      INC DE
000549 4549 D5              11      PUSH    DE
00054A 454A 5F               4      LD  E,A
00054B 454B E5              11      PUSH    HL
00054C 454C C5              11      PUSH    BC
00054D 454D 3A41F3          13      LD  A,(RAMAD0)
000550 4550 CD1400          17      CALL    _WRSLT
000553 4553 C1              10      POP BC
000554 4554 E1              10      POP HL
000555 4555 D1              10      POP DE
000556 4556 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
000558 4558 EA4345          10      JP  PE,LDIR_PAGE0_SLT1
00055B 455B EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JP  LDIRE2
                                #else
00055C 455C C9              10      RET
                                #endif
                                
                                #if exists _RAM64K
       455D                     LDIR_PAGE1_DEHL:
00055D 455D EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
       455E                     LDIR_PAGE1:         ;ページ1
00055E 455E 78               4      LD  A,B
00055F 455F B1               4      OR  C
000560 4560 CA1E45          10      JP  Z,LDIRE2
                                
000563 4563 7A               4      LD  A,D
000564 4564 FE7F             7      CP  07FH        ;ページ2と被る可能性？($7FXX)
000566 4566 3810            12      JR  C,LDIR_PAGE1_2
000568 4568 87               4      ADD A,A
000569 4569 DAB845          10      JP  C,LDIR_PAGE2_1  ;ページ2へ
00056C 456C 78               4      LD  A,B
00056D 456D B7               4      OR  A
00056E 456E 2804            12      JR  Z,LDIR_PAGE1_1
000570 4570 7B               4      LD  A,E     ;B != 0 の場合は256バイト転送
000571 4571 B7               4      OR  A
000572 4572 2028            12      JR  NZ,LDIR_PAGE1_SLT_HLDE  ;被る
       4574                     LDIR_PAGE1_1:
000574 4574 7B               4      LD  A,E     ;B == 0 の場合はCバイト転送
000575 4575 81               4      ADD A,C
000576 4576 3824            12      JR  C,LDIR_PAGE1_SLT_HLDE   ;被る
       4578                     LDIR_PAGE1_2:
000578 4578 C5              11      PUSH    BC
000579 4579 D5              11      PUSH    DE
00057A 457A 115EF5          10      LD  DE,BUF
                                
00057D 457D 78               4      LD  A,B
00057E 457E B7               4      OR  A
00057F 457F 2803            12      JR  Z,LDIR_PAGE1_3
000581 4581 010001          10      LD  BC,00100H       ;B != 0 の場合は256バイトずつ転送
       4584                     LDIR_PAGE1_3:
000584 4584 C5              11      PUSH    BC
000585 4585 EDB0                    LDIR
000587 4587 2205F3          16      LD  (_HL),HL
                                
00058A 458A 3A42F3          13      LD  A,(RAMAD1)
00058D 458D C3CBF0          10      JP  LDIR_PAGE1_RAM      ;ページ1をRAMにする処理はページ3にある
       4590                     LDIR_PAGE1_ROM:
000590 4590 2A05F3          16      LD  HL,(_HL)
000593 4593 C1              10      POP BC
000594 4594 78               4      LD  A,B
000595 4595 B7               4      OR  A
000596 4596 CA1E45          10      JP  Z,LDIRE2
000599 4599 05               4      DEC B
00059A 459A 18C2            12      JR  LDIR_PAGE1
                                
       459C                     LDIR_PAGE1_SLT_HLDE:
00059C 459C EB               4      EX  DE,HL       ;転送方向(DE)→(HL)
                                #else
                                LDIR_PAGE1:         ;ページ1 WRSLTを使用
                                LDIR_PAGE1_HLDE:
                                    EX  DE,HL       ;転送方向(DE)→(HL)
                                LDIR_PAGE1_DEHL:
                                #endif
       459D                     LDIR_PAGE1_SLT1:
00059D 459D CB7C             8      BIT 7,H
00059F 459F 2016            12      JR  NZ,LDIR_PAGE2_HLDE
0005A1 45A1 1A               7      LD  A,(DE)
0005A2 45A2 13               6      INC DE
0005A3 45A3 D5              11      PUSH    DE
0005A4 45A4 5F               4      LD  E,A
0005A5 45A5 E5              11      PUSH    HL
0005A6 45A6 C5              11      PUSH    BC
0005A7 45A7 3A42F3          13      LD  A,(RAMAD1)
0005AA 45AA CD1400          17      CALL    _WRSLT
0005AD 45AD C1              10      POP BC
0005AE 45AE E1              10      POP HL
0005AF 45AF D1              10      POP DE
0005B0 45B0 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0005B2 45B2 EA9D45          10      JP  PE,LDIR_PAGE1_SLT1
0005B5 45B5 EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    JP  LDIRE2
                                LDIR_PAGE2_HLDE:            ;ページ2
                                    EX  DE,HL       ;転送方向(HL)→(DE)
                                    JP  LDIR_PAGE2_1
                                #else
0005B6 45B6 C9              10      RET
       45B7                     LDIR_PAGE2_HLDE:            ;ページ2
0005B7 45B7 EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
       45B8                     LDIR_PAGE2_1:
0005B8 45B8 EDB0                    LDIR
0005BA 45BA C9              10      RET
                                #endif
                                ;
                                ;   BASIC関連
                                ;
       45BB                     END_OF_LINE:
0005BB 45BB 215EF5          10      LD  HL,BUF
       45BE                     EOL1:
0005BE 45BE 7E               7      LD  A,(HL)
0005BF 45BF C8              11      RET Z
0005C0 45C0 FE0D             7      CP  00DH
0005C2 45C2 2807            12      JR  Z,EOLE
0005C4 45C4 FE0A             7      CP  00AH
0005C6 45C6 2803            12      JR  Z,EOLE
0005C8 45C8 23               6      INC HL
0005C9 45C9 18F3            12      JR  EOL1
       45CB                     EOLE:
0005CB 45CB 3600            10      LD  (HL),0
0005CD 45CD 23               6      INC HL
0005CE 45CE 7E               7      LD  A,(HL)
0005CF 45CF FE0A             7      CP  00AH
0005D1 45D1 C0              11      RET NZ
0005D2 45D2 23               6      INC HL
0005D3 45D3 C9              10      RET
                                ;
                                ;   アスキー形式のファイルを読み込む
                                ;
       45D4                     ROM_LOAD_ASCII:
0005D4 45D4 210000          10      LD  HL,0
0005D7 45D7 22DAF2          16      LD  (_BUF_ST),HL    ;読み出し位置
0005DA 45DA 2A76F6          16      LD  HL,(TXTTAB)
0005DD 45DD 22DCF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
0005E0 45E0 215EF5          10      LD  HL,BUF
0005E3 45E3 22D4F2          16      LD  (_DTA),HL
       45E6                     RLOAD_A1:
0005E6 45E6 2ADAF2          16      LD  HL,(_BUF_ST)
0005E9 45E9 22CAF2          16      LD  (RR_LOW),HL
0005EC 45EC 210201          10      LD  HL,258
0005EF 45EF CDFD4A          17      CALL    ROM_READ
0005F2 45F2 7C               4      LD  A,H
0005F3 45F3 B5               4      OR  L
0005F4 45F4 2879            12      JR  Z,RLOAD_AEND
0005F6 45F6 015EF5          10      LD  BC,BUF
0005F9 45F9 09              11      ADD HL,BC
0005FA 45FA 3600            10      LD  (HL),0
0005FC 45FC CDBB45          17      CALL    END_OF_LINE
0005FF 45FF 015EF5          10      LD  BC,BUF
000602 4602 A7               4      AND A
000603 4603 ED42            15      SBC HL,BC
000605 4605 2810            12      JR  Z,RLOAD_A2
000607 4607 4D               4      LD  C,L
000608 4608 44               4      LD  B,H
000609 4609 ED5BDAF2        20      LD  DE,(_BUF_ST)
00060D 460D 19              11      ADD HL,DE
00060E 460E 22DAF2          16      LD  (_BUF_ST),HL
000611 4611 3A5EF5          13      LD  A,(BUF)
000614 4614 B7               4      OR  A
000615 4615 28CF            12      JR  Z,RLOAD_A1
       4617                     RLOAD_A2:
000617 4617 115EF5          10      LD  DE,BUF
00061A 461A CDB44C          17      CALL    SPCUTEX
00061D 461D 1A               7      LD  A,(DE)
00061E 461E B7               4      OR  A
00061F 461F 284E            12      JR  Z,RLOAD_AEND
000621 4621 CDC64C          17      CALL    GETNUM
000624 4624 7C               4      LD  A,H
000625 4625 B5               4      OR  L
000626 4626 CA4647          10      JP  Z,ERROR_DIRECT_IN_FILE
000629 4629 DD2ADCF2        20      LD  IX,(_BUF_EN)
00062D 462D DD7502          19      LD  (IX+2),L
000630 4630 DD7403          19      LD  (IX+3),H
                                
000633 4633 CDAD4C          17      CALL    SPCUT
000636 4636 EB               4      EX  DE,HL
000637 4637 DDE5            15      PUSH    IX
000639 4639 DD21B242        14      LD  IX,CRUNCH
00063D 463D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000641 4641 CD1C00          17      CALL    _CALSLT
000644 4644 DDE1            14      POP IX
000646 4646 EB               4      EX  DE,HL
000647 4647 111FF4          10      LD  DE,KBUF
00064A 464A 37               4      SCF
00064B 464B ED52            15      SBC HL,DE
00064D 464D CA4647          10      JP  Z,ERROR_DIRECT_IN_FILE
000650 4650 DA4647          10      JP  C,ERROR_DIRECT_IN_FILE
000653 4653 4D               4      LD  C,L
000654 4654 44               4      LD  B,H
000655 4655 2ADCF2          16      LD  HL,(_BUF_EN)
000658 4658 110400          10      LD  DE,4
00065B 465B 19              11      ADD HL,DE
00065C 465C 111FF4          10      LD  DE,KBUF
                                
00065F 465F EB               4      EX  DE,HL
000660 4660 EDB0                    LDIR
000662 4662 EB               4      EX  DE,HL
                                
000663 4663 DD7500          19      LD  (IX+0),L
000666 4666 DD7401          19      LD  (IX+1),H
000669 4669 22DCF2          16      LD  (_BUF_EN),HL
00066C 466C C3E645          10      JP  RLOAD_A1
                                
       466F                     RLOAD_AEND:
00066F 466F 2ADCF2          16      LD  HL,(_BUF_EN)
000672 4672 AF               4      XOR A
000673 4673 77               7      LD  (HL),A
000674 4674 23               6      INC HL
000675 4675 77               7      LD  (HL),A
000676 4676 23               6      INC HL
000677 4677 22DCF2          16      LD  (_BUF_EN),HL
00067A 467A C30947          10      JP  RLOAD_END1
                                
       467D                     ROM_LOAD:
00067D 467D CDAB48          17      CALL    INIT_PARAM
000680 4680 7E               7      LD  A,(HL)
000681 4681 FE2C             7      CP  ','
000683 4683 2003            12      JR  NZ,ROM_LOAD0
000685 4685 23               6      INC HL
000686 4686 7E               7      LD  A,(HL)
000687 4687 2B               6      DEC HL
       4688                     ROM_LOAD0:
000688 4688 32BEFC          13      LD  (RUNBNF),A
00068B 468B CD9E4B          17      CALL    FILE_B
00068E 468E 3AFAF2          13      LD  A,(FNAME)
000691 4691 FE20             7      CP  020H
000693 4693 CA994B          10      JP  Z,ROM_ORG
                                
000696 4696 CD1D4D          17      CALL    ROM_OPEN
000699 4699 DA5247          10      JP  C,ERROR_FILE_NOT_FOUND
       469C                     ROM_LOAD1:
00069C 469C 21D9F2          10      LD  HL,_BUF
00069F 469F 22D4F2          16      LD  (_DTA),HL
0006A2 46A2 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
0006A5 46A5 CDFD4A          17      CALL    ROM_READ
0006A8 46A8 3AD9F2          13      LD  A,(_BUF)
0006AB 46AB 3C               4      INC A
0006AC 46AC C2D445          10      JP  NZ,ROM_LOAD_ASCII
0006AF 46AF 2A76F6          16      LD  HL,(TXTTAB)
0006B2 46B2 22D4F2          16      LD  (_DTA),HL
0006B5 46B5 EB               4      EX  DE,HL
0006B6 46B6 2100FF          10      LD  HL,-256
0006B9 46B9 39              11      ADD HL,SP
0006BA 46BA ED52            15      SBC HL,DE
0006BC 46BC CDFD4A          17      CALL    ROM_READ
0006BF 46BF ED5BD4F2        20      LD  DE,(_DTA)
0006C3 46C3 19              11      ADD HL,DE
0006C4 46C4 E5              11      PUSH    HL
0006C5 46C5 2A76F6          16      LD  HL,(TXTTAB)
       46C8                     ROM_LOAD2:          ;リンクポインタをFIX
0006C8 46C8 E5              11      PUSH    HL
0006C9 46C9 DDE1            14      POP IX
0006CB 46CB 7E               7      LD  A,(HL)      ;リンクポインタL
0006CC 46CC 23               6      INC HL
0006CD 46CD B6               7      OR  (HL)        ;リンクポインタH
0006CE 46CE 23               6      INC HL
0006CF 46CF 2837            12      JR  Z,RLOAD_END0
0006D1 46D1 23               6      INC HL      ;行番号
0006D2 46D2 23               6      INC HL      ;行番号
       46D3                     ROM_LOAD3:
0006D3 46D3 7E               7      LD  A,(HL)
0006D4 46D4 23               6      INC HL
0006D5 46D5 FE0B             7      CP  00BH        ;8進数(&O)
0006D7 46D7 2822            12      JR  Z,INC_HL2
0006D9 46D9 FE0C             7      CP  00CH        ;16進数(&H)
0006DB 46DB 281E            12      JR  Z,INC_HL2
0006DD 46DD FE0D             7      CP  00DH        ;行番号(RUN後)
0006DF 46DF 281A            12      JR  Z,INC_HL2
0006E1 46E1 FE0E             7      CP  00EH        ;行番号(RUN前)
0006E3 46E3 2816            12      JR  Z,INC_HL2
0006E5 46E5 FE0F             7      CP  00FH        ;10～255の整数(%)
0006E7 46E7 2813            12      JR  Z,INC_HL1
0006E9 46E9 FE1C             7      CP  01CH        ;256～65535の整数(%)
0006EB 46EB 280E            12      JR  Z,INC_HL2
0006ED 46ED FE1D             7      CP  01DH        ;単精度実数(!)
0006EF 46EF 2808            12      JR  Z,INC_HL4
0006F1 46F1 FE1F             7      CP  01FH        ;倍制度実数(#)
0006F3 46F3 2008            12      JR  NZ,INC_HL0
0006F5 46F5 23               6      INC HL
0006F6 46F6 23               6      INC HL
0006F7 46F7 23               6      INC HL
0006F8 46F8 23               6      INC HL
       46F9                     INC_HL4:
0006F9 46F9 23               6      INC HL
0006FA 46FA 23               6      INC HL
       46FB                     INC_HL2:
0006FB 46FB 23               6      INC HL
       46FC                     INC_HL1:
0006FC 46FC 23               6      INC HL
       46FD                     INC_HL0:
0006FD 46FD B7               4      OR  A
0006FE 46FE 20D3            12      JR  NZ,ROM_LOAD3
000700 4700 DD7500          19      LD  (IX+0),L
000703 4703 DD7401          19      LD  (IX+1),H
000706 4706 18C0            12      JR  ROM_LOAD2
       4708                     RLOAD_END0:
000708 4708 E1              10      POP HL
       4709                     RLOAD_END1:
000709 4709 22C2F6          16      LD  (VARTAB),HL
00070C 470C 22C4F6          16      LD  (ARYTAB),HL
00070F 470F 22C6F6          16      LD  (STREND),HL
                                
000712 4712 3ABEFC          13      LD  A,(RUNBNF)
000715 4715 CD074D          17      CALL    CAP
000718 4718 FE52             7      CP  'R'
00071A 471A 280E            12      JR  Z,RLOAD_END2
00071C 471C AF               4      XOR A
00071D 471D 21DCF2          10      LD  HL,_BUF+3
000720 4720 77               7      LD  (HL),A      ;3
000721 4721 2B               6      DEC HL
000722 4722 77               7      LD  (HL),A      ;2
000723 4723 2B               6      DEC HL
000724 4724 77               7      LD  (HL),A      ;1
000725 4725 2B               6      DEC HL
000726 4726 3E8F             7      LD  A,08FH      ;REM
000728 4728 77               7      LD  (HL),A      ;0
000729 4729 C9              10      RET
       472A                     RLOAD_END2:
00072A 472A D5              11      PUSH    DE
00072B 472B ED5B76F6        20      LD  DE,(TXTTAB)
00072F 472F 1B               6      DEC DE
000730 4730 AF               4      XOR A
000731 4731 21DFF2          10      LD  HL,_BUF+6
000734 4734 77               7      LD  (HL),A      ;6
000735 4735 2B               6      DEC HL
000736 4736 77               7      LD  (HL),A      ;5
000737 4737 2B               6      DEC HL
000738 4738 77               7      LD  (HL),A      ;4
000739 4739 2B               6      DEC HL
00073A 473A 72               7      LD  (HL),D      ;3 行番号H
00073B 473B 2B               6      DEC HL
00073C 473C 73               7      LD  (HL),E      ;2 行番号L
00073D 473D 2B               6      DEC HL
00073E 473E 360D            10      LD  (HL),00DH   ;1 行番号(RUN後)
000740 4740 2B               6      DEC HL
000741 4741 3E89             7      LD  A,089H      ;GOTO
000743 4743 77               7      LD  (HL),A      ;0
000744 4744 D1              10      POP DE
000745 4745 C9              10      RET
                                
       4746                     ERROR_DIRECT_IN_FILE:
000746 4746 1E39             7      LD  E,57            ;Direct statement in file
000748 4748 01                      DB  1           ;LD BC,
       4749                     ERROR_DEVICE_IO_ERROR:
000749 4749 1E13             7      LD  E,19            ;Device I/O error
00074B 474B 01                      DB  1           ;LD BC,
       474C                     ERROR_INTERNAL_ERROR:
00074C 474C 1E33             7      LD  E,51            ;Internal error
00074E 474E 01                      DB  1           ;LD BC,
       474F                     ERROR_FILE_NOT_OPEN:
00074F 474F 1E3B             7      LD  E,59            ;File not OPEN
000751 4751 01                      DB  1           ;LD BC,
       4752                     ERROR_FILE_NOT_FOUND:
000752 4752 1E35             7      LD  E,53            ;File not found
       4754                     ERROR:
000754 4754 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000758 4758 DD216F40        14      LD  IX,ERRHAND
00075C 475C C31C00          10      JP  _CALSLT
                                
       475F                     ROM_BLOAD:
00075F 475F CDAB48          17      CALL    INIT_PARAM
000762 4762 CD9E4B          17      CALL    FILE_B
000765 4765 CD1D4D          17      CALL    ROM_OPEN
000768 4768 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
00076A 476A 21D9F2          10      LD  HL,_BUF
00076D 476D 22D4F2          16      LD  (_DTA),HL
000770 4770 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
000773 4773 CDFD4A          17      CALL    ROM_READ
000776 4776 3AD9F2          13      LD  A,(_BUF)
000779 4779 FEFE             7      CP  0FEH
00077B 477B 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
00077D 477D 21A5F2          10      LD  HL,BLOAD_RET
000780 4780 229DF2          16      LD  (SWC_BLOAD),HL
                                
000783 4783 2AF5F2          16      LD  HL,(PARAM1)
000786 4786 7E               7      LD  A,(HL)
000787 4787 FE2C             7      CP  ','
000789 4789 204C            12      JR  NZ,RBREAD_MEM
00078B 478B 23               6      INC HL
00078C 478C 7E               7      LD  A,(HL)
00078D 478D CD074D          17      CALL    CAP
000790 4790 32BEFC          13      LD  (RUNBNF),A
000793 4793 FE52             7      CP  'R'     ;R,Sスイッチじゃ無い場合はオフセット値として処理する
000795 4795 2808            12      JR  Z,RBOS1
000797 4797 FE53             7      CP  'S'
000799 4799 2804            12      JR  Z,RBOS1
00079B 479B FE2C             7      CP  ','
00079D 479D 200D            12      JR  NZ,RBOS2
       479F                     RBOS1:
00079F 479F 7E               7      LD  A,(HL)
0007A0 47A0 23               6      INC HL
0007A1 47A1 B7               4      OR  A
0007A2 47A2 2824            12      JR  Z,RBREAD_OSE
0007A4 47A4 FE3A             7      CP  ':'
0007A6 47A6 2820            12      JR  Z,RBREAD_OSE
0007A8 47A8 FE2C             7      CP  ','     ;次のパラメータを探す
0007AA 47AA 20F3            12      JR  NZ,RBOS1
       47AC                     RBOS2:              ;オフセット
0007AC 47AC 22F5F2          16      LD  (PARAM1),HL
0007AF 47AF 7E               7      LD  A,(HL)
0007B0 47B0 B7               4      OR  A
0007B1 47B1 2815            12      JR  Z,RBREAD_OSE
0007B3 47B3 DD212F54        14      LD  IX,FRMQNT
0007B7 47B7 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007BB 47BB CD1C00          17      CALL    _CALSLT
0007BE 47BE 22F5F2          16      LD  (PARAM1),HL
0007C1 47C1 2ADAF2          16      LD  HL,(_BUF_ST)
0007C4 47C4 19              11      ADD HL,DE
0007C5 47C5 22DAF2          16      LD  (_BUF_ST),HL
       47C8                     RBREAD_OSE:
0007C8 47C8 3ABEFC          13      LD  A,(RUNBNF)
0007CB 47CB FE53             7      CP  'S'
0007CD 47CD 2008            12      JR  NZ,RBREAD_MEM
0007CF 47CF CD8B4A          17      CALL    WAIT_VDP
0007D2 47D2 3E01             7      LD  A,1
0007D4 47D4 32D6F2          13      LD  (FLG_LDIR),A
       47D7                     RBREAD_MEM:
0007D7 47D7 2ADAF2          16      LD  HL,(_BUF_ST)
0007DA 47DA 22BFFC          16      LD  (SAVENT),HL
0007DD 47DD 22D4F2          16      LD  (_DTA),HL
0007E0 47E0 21FFFF          10      LD  HL,0FFFFH
0007E3 47E3 CDFD4A          17      CALL    ROM_READ
0007E6 47E6 AF               4      XOR A
0007E7 47E7 32D6F2          13      LD  (FLG_LDIR),A
0007EA 47EA 3ABEFC          13      LD  A,(RUNBNF)
0007ED 47ED FE52             7      CP  'R'
0007EF 47EF 2006            12      JR  NZ,RBREAD1
0007F1 47F1 2ADEF2          16      LD  HL,(_BUF_EX)
0007F4 47F4 229DF2          16      LD  (SWC_BLOAD),HL
       47F7                     RBREAD1:
       47F7                     ROM_NEXT:
0007F7 47F7 2AF5F2          16      LD  HL,(PARAM1)
0007FA 47FA 7E               7      LD  A,(HL)
0007FB 47FB 2B               6      DEC HL
0007FC 47FC B7               4      OR  A
0007FD 47FD 2805            12      JR  Z,ROM_NEXT1
0007FF 47FF FE3A             7      CP  ':'
000801 4801 2801            12      JR  Z,ROM_NEXT1
000803 4803 23               6      INC HL
       4804                     ROM_NEXT1:
000804 4804 5D               4      LD  E,L
000805 4805 54               4      LD  D,H
                                
000806 4806 CDDD4C          17      CALL    SEARCH_END
000809 4809 B7               4      OR  A
00080A 480A 2821            12      JR  Z,REM
       480C                     RN3:                    ;マルチステートメントの処理
00080C 480C 7E               7      LD  A,(HL)
                                
00080D 480D FEB5             7      CP  0B5H            ;LOAD
00080F 480F CA7D46          10      JP  Z,ROM_LOAD
000812 4812 FE8A             7      CP  08AH            ;RUN
000814 4814 281B            12      JR  Z,ROM_RUN
000816 4816 FEB7             7      CP  0B7H            ;FILES
000818 4818 2825            12      JR  Z,ROM_FILES
00081A 481A FED6             7      CP  0D6H            ;COPY
00081C 481C CADD48          10      JP  Z,ROM_COPY
00081F 481F FE20             7      CP  020H
000821 4821 2807            12      JR  Z,RN_SP
                                
000823 4823 3E28             7      LD  A,028H          ;JR Z,
000825 4825 32A3F2          13      LD  (SWC_BLOAD_M),A
000828 4828 7E               7      LD  A,(HL)
000829 4829 C9              10      RET
       482A                     RN_SP:
00082A 482A 23               6      INC HL
00082B 482B 18DF            12      JR  RN3
                                
       482D                     REM:
00082D 482D EB               4      EX  DE,HL
00082E 482E 3E8F             7      LD  A,08FH          ;REM
000830 4830 C9              10      RET
                                
       4831                     ROM_RUN:
000831 4831 23               6      INC HL
000832 4832 7E               7      LD  A,(HL)
000833 4833 2B               6      DEC HL
000834 4834 B7               4      OR  A
000835 4835 C47D46          17      CALL    NZ,ROM_LOAD
000838 4838 FE8F             7      CP  08FH            ;REM
00083A 483A 3E8A             7      LD  A,08AH          ;RUN
00083C 483C C0              11      RET NZ
00083D 483D 77               7      LD  (HL),A
00083E 483E C9              10      RET
                                
       483F                     ROM_FILES:
00083F 483F CDAB48          17      CALL    INIT_PARAM
000842 4842 CD9E4B          17      CALL    FILE_B
000845 4845 CD5E54          17      CALL    GET_DISK_BANK_FDRV
000848 4848 3AC9F2          13      LD  A,(SECSZ_H)
00084B 484B CDE052          17      CALL    IS_BPB1
00084E 484E DA4947          10      JP  C,ERROR_DEVICE_IO_ERROR
000851 4851 3AFAF2          13      LD  A,(FNAME)
000854 4854 FE21             7      CP  021H
000856 4856 3005            12      JR  NC,RFILES0
000858 4858 060B             7      LD  B,11
00085A 485A CD714C          17      CALL    FILE10
       485D                     RFILES0:
00085D 485D CD7B4F          17      CALL    GET_DIR_DAT
       4860                     RFILES1:
000860 4860 CD394D          17      CALL    FILESE
000863 4863 3041            12      JR  NC,RFILES_NOT_MATCH
       4865                     RFILES_DISP:
000865 4865 E5              11      PUSH    HL
000866 4866 110B00          10      LD  DE,0000BH   ;属性
000869 4869 19              11      ADD HL,DE
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
00086A 486A 7E               7      LD  A,(HL)
                                #endif
00086B 486B E1              10      POP HL
00086C 486C CB4F             8      BIT 1,A     ;不可視属性
00086E 486E 2033            12      JR  NZ,RFILES_NEXT
000870 4870 E5              11      PUSH    HL
000871 4871 0608             7      LD  B,8
000873 4873 CDF844          17      CALL    MSN
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000876 4876 7E               7      LD  A,(HL)
                                #endif
000877 4877 FE20             7      CP  020H
000879 4879 F5              11      PUSH    AF
00087A 487A 3E2E             7      LD  A,'.'
00087C 487C C4D954          17      CALL    NZ,MSG_A
00087F 487F 0603             7      LD  B,3
000881 4881 CDF844          17      CALL    MSN
000884 4884 F1              10      POP AF
000885 4885 CCD954          17      CALL    Z,MSG_A
000888 4888 3ADDF3          13      LD  A,(CSRX)
00088B 488B 47               4      LD  B,A
00088C 488C 3AB0F3          13      LD  A,(LINLEN)
00088F 488F 90               4      SUB B
000890 4890 FE0C             7      CP  12
000892 4892 3009            12      JR  NC,RFILES2
000894 4894 3E0D             7      LD  A,00DH      ;改行
000896 4896 CDD954          17      CALL    MSG_A
000899 4899 3E0A             7      LD  A,00AH
00089B 489B 1802            12      JR  RFILES3
       489D                     RFILES2:
00089D 489D 3E20             7      LD  A,020H
       489F                     RFILES3:
00089F 489F CDD954          17      CALL    MSG_A
0008A2 48A2 E1              10      POP HL
       48A3                     RFILES_NEXT:
0008A3 48A3 CD554D          17      CALL    FNEXT
       48A6                     RFILES_NOT_MATCH:
0008A6 48A6 20B8            12      JR  NZ,RFILES1
0008A8 48A8 C3F747          10      JP  ROM_NEXT
                                
       48AB                     INIT_PARAM:
0008AB 48AB 22F3F2          16      LD  (PARAM0),HL
0008AE 48AE 22F5F2          16      LD  (PARAM1),HL
0008B1 48B1 EB               4      EX  DE,HL
0008B2 48B2 32BEFC          13      LD  (RUNBNF),A
0008B5 48B5 3263F6          13      LD  (VALTYP),A
0008B8 48B8 E5              11      PUSH    HL
0008B9 48B9 2AEBF2          16      LD  HL,(_CD)
0008BC 48BC 22F7F2          16      LD  (_CDX),HL
0008BF 48BF E1              10      POP HL
0008C0 48C0 13               6      INC DE
0008C1 48C1 CDAD4C          17      CALL    SPCUT
0008C4 48C4 1A               7      LD  A,(DE)
0008C5 48C5 B7               4      OR  A
0008C6 48C6 C8              11      RET Z
0008C7 48C7 FE3A             7      CP  ':'
0008C9 48C9 C8              11      RET Z
0008CA 48CA FE28             7      CP  '('
0008CC 48CC C8              11      RET Z
0008CD 48CD EB               4      EX  DE,HL
0008CE 48CE DD21644C        14      LD  IX,FRMEVL
0008D2 48D2 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0008D6 48D6 CD1C00          17      CALL    _CALSLT
0008D9 48D9 22F5F2          16      LD  (PARAM1),HL
0008DC 48DC C9              10      RET
                                
       48DD                     ROM_COPY:
0008DD 48DD CDAB48          17      CALL    INIT_PARAM
0008E0 48E0 3A63F6          13      LD  A,(VALTYP)
0008E3 48E3 FE03             7      CP  3       ;string
0008E5 48E5 C2994B          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
0008E8 48E8 CD9E4B          17      CALL    FILE_B
0008EB 48EB CD1D4D          17      CALL    ROM_OPEN
0008EE 48EE DA5247          10      JP  C,ERROR_FILE_NOT_FOUND
                                
0008F1 48F1 21DEF2          10      LD  HL,_BUF_W
0008F4 48F4 22D4F2          16      LD  (_DTA),HL
0008F7 48F7 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
0008FA 48FA CDFD4A          17      CALL    ROM_READ
                                
0008FD 48FD AF               4      XOR A
0008FE 48FE 32D9F2          13      LD  (_BUF_LO),A     ;PSET
000901 4901 32E6F2          13      LD  (_BUF_O),A      ;向き
                                
000904 4904 2AF5F2          16      LD  HL,(PARAM1)
       4907                     RCP_PARAM1:
000907 4907 7E               7      LD  A,(HL)
000908 4908 23               6      INC HL
000909 4909 B7               4      OR  A
00090A 490A CA0448          10      JP  Z,ROM_NEXT1
00090D 490D FE3A             7      CP  ':'
00090F 490F CA0448          10      JP  Z,ROM_NEXT1
000912 4912 FE2C             7      CP  ','
000914 4914 2012            12      JR  NZ,RCP_PARAM1_
                                
000916 4916 DD212F54        14      LD  IX,FRMQNT
00091A 491A FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00091E 491E CD1C00          17      CALL    _CALSLT
000921 4921 7B               4      LD  A,E
000922 4922 87               4      ADD A,A
000923 4923 87               4      ADD A,A
000924 4924 32E6F2          13      LD  (_BUF_O),A
000927 4927 7E               7      LD  A,(HL)
       4928                     RCP_PARAM1_:
000928 4928 FE28             7      CP  '('
00092A 492A 20DB            12      JR  NZ,RCP_PARAM1
00092C 492C DD212F54        14      LD  IX,FRMQNT
000930 4930 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000934 4934 CD1C00          17      CALL    _CALSLT
                                
000937 4937 ED53E2F2        20      LD  (_BUF_X),DE
                                
       493B                     RCP_PARAM2:
00093B 493B 23               6      INC HL
00093C 493C 7E               7      LD  A,(HL)
00093D 493D FE20             7      CP  020H
00093F 493F 28FA            12      JR  Z,RCP_PARAM2
000941 4941 FE2C             7      CP  ','
000943 4943 28F6            12      JR  Z,RCP_PARAM2
                                
000945 4945 DD212F54        14      LD  IX,FRMQNT
000949 4949 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00094D 494D CD1C00          17      CALL    _CALSLT
                                
000950 4950 3AF6FA          13      LD  A,(ACPAGE)
000953 4953 57               4      LD  D,A
000954 4954 ED53E4F2        20      LD  (_BUF_Y),DE
       4958                     RCP_PARAM3:
000958 4958 23               6      INC HL
000959 4959 7E               7      LD  A,(HL)
00095A 495A FE20             7      CP  020H
00095C 495C 28FA            12      JR  Z,RCP_PARAM3
00095E 495E FE29             7      CP  ')'
000960 4960 28F6            12      JR  Z,RCP_PARAM3
000962 4962 FE2C             7      CP  ','
000964 4964 2033            12      JR  NZ,RCP_ST
                                
000966 4966 23               6      INC HL
000967 4967 DD212F54        14      LD  IX,FRMQNT
00096B 496B FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00096F 496F CD1C00          17      CALL    _CALSLT
                                
000972 4972 7B               4      LD  A,E
000973 4973 32E5F2          13      LD  (_BUF_P),A
                                
       4976                     RCP_PARAM4:
000976 4976 7E               7      LD  A,(HL)
000977 4977 23               6      INC HL
000978 4978 FE20             7      CP  020H
00097A 497A 28FA            12      JR  Z,RCP_PARAM4
                                
00097C 497C FE2C             7      CP  ','
00097E 497E 2019            12      JR  NZ,RCP_ST
                                
000980 4980 7E               7      LD  A,(HL)
000981 4981 0604             7      LD  B,4
000983 4983 FEC3             7      CP  0C3H        ;PRESET
000985 4985 280E            12      JR  Z,RCP_LO
000987 4987 05               4      DEC B       ;3
000988 4988 D6F8             7      SUB 0F8H        ;XOR
00098A 498A 2809            12      JR  Z,RCP_LO
00098C 498C 05               4      DEC B       ;2
00098D 498D 3C               4      INC A       ;OR
00098E 498E 2805            12      JR  Z,RCP_LO
000990 4990 05               4      DEC B       ;1
000991 4991 3C               4      INC A       ;AND
000992 4992 2801            12      JR  Z,RCP_LO
000994 4994 05               4      DEC B       ;0
                                                ;PSET
       4995                     RCP_LO:
000995 4995 78               4      LD  A,B
000996 4996 32D9F2          13      LD  (_BUF_LO),A
       4999                     RCP_ST:
000999 4999 2AC6F6          16      LD  HL,(STREND)
00099C 499C 22D4F2          16      LD  (_DTA),HL
00099F 499F EB               4      EX  DE,HL
0009A0 49A0 2100FE          10      LD  HL,-512
0009A3 49A3 39              11      ADD HL,SP
0009A4 49A4 AF               4      XOR A
0009A5 49A5 ED52            15      SBC HL,DE
0009A7 49A7 3008            12      JR  NC,RCP0
0009A9 49A9 215EF5          10      LD  HL,BUF
0009AC 49AC 22D4F2          16      LD  (_DTA),HL
0009AF 49AF 6F               4      LD  L,A ;0
0009B0 49B0 67               4      LD  H,A ;0
       49B1                     RCP0:
0009B1 49B1 24               4      INC H
0009B2 49B2 22DCF2          16      LD  (_BUF_EN),HL
       49B5                     RCP1:
0009B5 49B5 F3               4      DI
0009B6 49B6 CD8B4A          17      CALL    WAIT_VDP
                                
0009B9 49B9 3A0700          13      LD  A,(WRVDP)
0009BC 49BC 4F               4      LD  C,A
0009BD 49BD 0C               4      INC C       ;C := PORT#1's address(WR)
0009BE 49BE 3E24             7      LD  A,36
0009C0 49C0 ED79            12      OUT (C),A
0009C2 49C2 3E91             7      LD  A,080H+17
0009C4 49C4 ED79            12      OUT (C),A       ;R#17 := 36
                                
0009C6 49C6 0C               4      INC C
0009C7 49C7 0C               4      INC C       ;C := PORT#3's address(WR)
0009C8 49C8 2AE2F2          16      LD  HL,(_BUF_X)
0009CB 49CB ED69            12      OUT (C),L       ;R#36 DX
0009CD 49CD ED61            12      OUT (C),H       ;R#37
0009CF 49CF 2AE4F2          16      LD  HL,(_BUF_Y)
0009D2 49D2 ED69            12      OUT (C),L       ;R#38 DY
0009D4 49D4 ED61            12      OUT (C),H       ;R#39
0009D6 49D6 2ADEF2          16      LD  HL,(_BUF_W)
0009D9 49D9 ED69            12      OUT (C),L       ;R#40 NX
0009DB 49DB ED61            12      OUT (C),H       ;R#41
0009DD 49DD 2AE0F2          16      LD  HL,(_BUF_H)
0009E0 49E0 ED69            12      OUT (C),L       ;R#42 NY
0009E2 49E2 ED61            12      OUT (C),H       ;R#43
                                
0009E4 49E4 DD2AAFFC        20      LD  IX,(SCRMOD)
0009E8 49E8 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0009EB 49EB B7               4      OR  A
0009EC 49EC 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
0009EE 49EE DD7D             9      LD  A,IXL
0009F0 49F0 FE08             7      CP  8
0009F2 49F2 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
0009F4 49F4 FE06             7      CP  6
0009F6 49F6 2AE2F2          16      LD  HL,(_BUF_X)
0009F9 49F9 3ADEF2          13      LD  A,(_BUF_W)
0009FC 49FC 2005            12      JR  NZ,SCR57
0009FE 49FE B5               4      OR  L       ;スクリーン6
0009FF 49FF E603             7      AND 3
000A01 4A01 200D            12      JR  NZ,USE_LMMC
       4A03                     SCR57:              ;スクリーン5,7
000A03 4A03 B5               4      OR  L
000A04 4A04 E601             7      AND 1
000A06 4A06 2008            12      JR  NZ,USE_LMMC
       4A08                     USE_HMMC:
000A08 4A08 DD2E08          10      LD  IXL,8
       4A0B                     USE_HMMC8:
000A0B 4A0B 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
000A0D 4A0D 32D9F2          13      LD  (_BUF_LO),A
       4A10                     USE_LMMC:
000A10 4A10 110000          10      LD  DE,0
000A13 4A13 06FF             7      LD  B,-1
000A15 4A15 CDB64A          17      CALL    GET_PIXEL
000A18 4A18 ED79            12      OUT (C),A       ;R#44 first DATA
000A1A 4A1A 3AE6F2          13      LD  A,(_BUF_O)
000A1D 4A1D ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
000A1F 4A1F 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000A22 4A22 F6B0             7      OR  0B0H        ;R#46 LMMC command
000A24 4A24 ED79            12      OUT (C),A
                                
000A26 4A26 FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
000A28 4A28 0D               4      DEC C
000A29 4A29 0D               4      DEC C       ;C := PORT#1's address(WR)
000A2A 4A2A 3EAC             7      LD  A,080H+44
000A2C 4A2C ED79            12      OUT (C),A
000A2E 4A2E 3E91             7      LD  A,080H+17
000A30 4A30 ED79            12      OUT (C),A       ;R#17 := 44
                                
000A32 4A32 3A0600          13      LD  A,(RDVDP)
000A35 4A35 3C               4      INC A
000A36 4A36 FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
000A38 4A38 3E02             7      LD  A,2
000A3A 4A3A ED79            12      OUT (C),A
000A3C 4A3C 3E8F             7      LD  A,08FH
000A3E 4A3E ED79            12      OUT (C),A
000A40 4A40 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000A43 4A43 E640             7      AND 040H
000A45 4A45 201C            12      JR  NZ,LOOP_HMMC
       4A47                     LOOP_COPY:
000A47 4A47 CDB64A          17      CALL    GET_PIXEL
000A4A 4A4A 08               4      EX  AF,AF'
000A4B 4A4B FD4C             9      LD  C,IYH
       4A4D                     LOOP_COPY1:
000A4D 4A4D ED78            12      IN  A,(C)
000A4F 4A4F 0F               4      RRCA            ;RRCAではサインフラグは変化しない
000A50 4A50 300A            12      JR  NC,EXIT_COPY    ;check CE bit
000A52 4A52 F24D4A          10      JP  P,LOOP_COPY1    ;check TR bit
000A55 4A55 08               4      EX  AF,AF'
000A56 4A56 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000A58 4A58 ED79            12      OUT (C),A
000A5A 4A5A 18EB            12      JR  LOOP_COPY
                                
       4A5C                     EXIT_COPY:
000A5C 4A5C CD934A          17      CALL    GET_STATUS_0
000A5F 4A5F FB               4      EI
000A60 4A60 C3F747          10      JP  ROM_NEXT
                                
       4A63                     LOOP_HMMC:
000A63 4A63 F3               4      DI          ;必要
000A64 4A64 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000A66 4A66 43               4      LD  B,E
000A67 4A67 7B               4      LD  A,E
000A68 4A68 B7               4      OR  A
000A69 4A69 2802            12      JR  Z,LOOP_HMMC1
000A6B 4A6B EDB3                    OTIR
       4A6D                     LOOP_HMMC1:
000A6D 4A6D 14               4      INC D
       4A6E                     LOOP_HMMC2:
000A6E 4A6E 15               4      DEC D
000A6F 4A6F 2805            12      JR  Z,LOOP_HMMC3
000A71 4A71 EDB3                    OTIR
000A73 4A73 C36E4A          10      JP  LOOP_HMMC2
       4A76                     LOOP_HMMC3:
000A76 4A76 ED78            12      IN  A,(C)
000A78 4A78 0F               4      RRCA
000A79 4A79 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
000A7B 4A7B 2ADCF2          16      LD  HL,(_BUF_EN)
000A7E 4A7E CDFD4A          17      CALL    ROM_READ
000A81 4A81 EB               4      EX  DE,HL
000A82 4A82 2AD4F2          16      LD  HL,(_DTA)
000A85 4A85 7A               4      LD  A,D
000A86 4A86 B3               4      OR  E
000A87 4A87 20DA            12      JR  NZ,LOOP_HMMC
000A89 4A89 18C2            12      JR  LOOP_COPY1
                                
       4A8B                     WAIT_VDP:
000A8B 4A8B 3E02             7      LD  A,2
000A8D 4A8D CD944A          17      CALL    GET_STATUS
000A90 4A90 0F               4      RRCA
000A91 4A91 38F8            12      JR  C,WAIT_VDP
       4A93                     GET_STATUS_0:
000A93 4A93 AF               4      XOR A
       4A94                     GET_STATUS:
000A94 4A94 C5              11      PUSH    BC
000A95 4A95 ED4B0600        20      LD  BC,(RDVDP)
000A99 4A99 0C               4      INC C
000A9A 4A9A ED79            12      OUT (C),A
000A9C 4A9C 3E8F             7      LD  A,08FH
000A9E 4A9E ED79            12      OUT (C),A
000AA0 4AA0 ED78            12      IN  A,(C)
000AA2 4AA2 C1              10      POP BC
000AA3 4AA3 C9              10      RET
                                
       4AA4                     GET_PIXEL256:
000AA4 4AA4 7A               4      LD  A,D
000AA5 4AA5 B3               4      OR  E
000AA6 4AA6 200A            12      JR  NZ,GET_PIXEL1
000AA8 4AA8 2ADCF2          16      LD  HL,(_BUF_EN)
000AAB 4AAB CDFD4A          17      CALL    ROM_READ
000AAE 4AAE EB               4      EX  DE,HL
000AAF 4AAF 2AD4F2          16      LD  HL,(_DTA)
       4AB2                     GET_PIXEL1:
000AB2 4AB2 7E               7      LD  A,(HL)
000AB3 4AB3 23               6      INC HL
000AB4 4AB4 1B               6      DEC DE
000AB5 4AB5 C9              10      RET
                                
       4AB6                     GET_PIXEL:
000AB6 4AB6 DD7D             9      LD  A,IXL
000AB8 4AB8 FE08             7      CP  8
000ABA 4ABA 28E8            12      JR  Z,GET_PIXEL256
000ABC 4ABC 04               4      INC B
000ABD 4ABD FE06             7      CP  6
000ABF 4ABF 282E            12      JR  Z,GET_PIXEL4
                                
000AC1 4AC1 CB40             8      BIT 0,B
000AC3 4AC3 20ED            12      JR  NZ,GET_PIXEL1
                                
000AC5 4AC5 7A               4      LD  A,D
000AC6 4AC6 B3               4      OR  E
000AC7 4AC7 200A            12      JR  NZ,GET_PIXEL2
                                
000AC9 4AC9 2ADCF2          16      LD  HL,(_BUF_EN)
000ACC 4ACC CDFD4A          17      CALL    ROM_READ
000ACF 4ACF EB               4      EX  DE,HL
000AD0 4AD0 2AD4F2          16      LD  HL,(_DTA)
                                
       4AD3                     GET_PIXEL2:
000AD3 4AD3 7E               7      LD  A,(HL)
000AD4 4AD4 0F               4      RRCA
000AD5 4AD5 0F               4      RRCA
000AD6 4AD6 0F               4      RRCA
000AD7 4AD7 0F               4      RRCA
000AD8 4AD8 C9              10      RET
                                
       4AD9                     GET_PIXEL3:
000AD9 4AD9 7A               4      LD  A,D
000ADA 4ADA B3               4      OR  E
000ADB 4ADB 200A            12      JR  NZ,GET_PIXEL5
                                
000ADD 4ADD 2ADCF2          16      LD  HL,(_BUF_EN)
000AE0 4AE0 CDFD4A          17      CALL    ROM_READ
000AE3 4AE3 EB               4      EX  DE,HL
000AE4 4AE4 2AD4F2          16      LD  HL,(_DTA)
       4AE7                     GET_PIXEL5:
000AE7 4AE7 7E               7      LD  A,(HL)
000AE8 4AE8 0F               4      RRCA
000AE9 4AE9 0F               4      RRCA
000AEA 4AEA 0F               4      RRCA
000AEB 4AEB 0F               4      RRCA
000AEC 4AEC 0F               4      RRCA
000AED 4AED 0F               4      RRCA
000AEE 4AEE C9              10      RET
                                
       4AEF                     GET_PIXEL4:
000AEF 4AEF 78               4      LD  A,B
000AF0 4AF0 E603             7      AND 3   ;+0
000AF2 4AF2 28E5            12      JR  Z,GET_PIXEL3
000AF4 4AF4 3D               4      DEC A   ;+1
000AF5 4AF5 28DC            12      JR  Z,GET_PIXEL2
000AF7 4AF7 3D               4      DEC A   ;+2
000AF8 4AF8 7E               7      LD  A,(HL)
000AF9 4AF9 C0              11      RET NZ
000AFA 4AFA 0F               4      RRCA        ;+3
000AFB 4AFB 0F               4      RRCA
000AFC 4AFC C9              10      RET
                                
       4AFD                     ROM_READ:
000AFD 4AFD E5              11      PUSH    HL
000AFE 4AFE D5              11      PUSH    DE
000AFF 4AFF C5              11      PUSH    BC
000B00 4B00 FDE5            15      PUSH    IY
000B02 4B02 22F1F2          16      LD  (LEFTX),HL
000B05 4B05 2AD4F2          16      LD  HL,(_DTA)
000B08 4B08 22E7F2          16      LD  (DTAX),HL
000B0B 4B0B 2AF1F2          16      LD  HL,(LEFTX)
                                
000B0E 4B0E CDAF4D          17      CALL    RBX1
000B11 4B11 3870            12      JR  C,RBRERR1
000B13 4B13 79               4      LD  A,C
000B14 4B14 EB               4      EX  DE,HL
000B15 4B15 ED52            15      SBC HL,DE       ;CP 0HL,CDE
000B17 4B17 19              11      ADD HL,DE
000B18 4B18 DE00             7      SBC A,000H
000B1A 4B1A 3801            12      JR  C,RBR1
000B1C 4B1C EB               4      EX  DE,HL
       4B1D                     RBR1:
000B1D 4B1D 9F               4      SBC A,A
000B1E 4B1E E601             7      AND 1
000B20 4B20 32C3F2          13      LD  (_RESULT),A
000B23 4B23 7C               4      LD  A,H
000B24 4B24 B5               4      OR  L
000B25 4B25 CA794B          10      JP  Z,RBREND0
                                
000B28 4B28 22D0F2          16      LD  (_LEFT),HL  ;Read record byte
000B2B 4B2B 22F1F2          16      LD  (LEFTX),HL
                                
000B2E 4B2E CDDB4D          17      CALL    RBX2
000B31 4B31 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000B33 4B33 CDEE4D          17      CALL    RBXA
000B36 4B36 DA8F4B          10      JP  C,RBRERR
000B39 4B39 C5              11      PUSH    BC
000B3A 4B3A CD1145          17      CALL    ROM_LDIR
000B3D 4B3D ED53E7F2        20      LD  (DTAX),DE
000B41 4B41 2AF1F2          16      LD  HL,(LEFTX)
000B44 4B44 D1              10      POP DE
000B45 4B45 A7               4      AND A
000B46 4B46 ED52            15      SBC HL,DE
000B48 4B48 22F1F2          16      LD  (LEFTX),HL
000B4B 4B4B 2829            12      JR  Z,RBREND
                                
       4B4D                     RBRB:
000B4D 4B4D CD2A4E          17      CALL    RBXB
000B50 4B50 2818            12      JR  Z,RBRC
       4B52                     RBRB1:
000B52 4B52 C5              11      PUSH    BC
000B53 4B53 D5              11      PUSH    DE
000B54 4B54 CDD54E          17      CALL    CLUST
000B57 4B57 EB               4      EX  DE,HL
000B58 4B58 ED4BC6F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000B5C 4B5C CD1145          17      CALL    ROM_LDIR
000B5F 4B5F EB               4      EX  DE,HL
000B60 4B60 D1              10      POP DE
000B61 4B61 C1              10      POP BC
000B62 4B62 CDB24E          17      CALL    GNCL
000B65 4B65 DA8F4B          10      JP  C,RBRERR
000B68 4B68 10E8            13      DJNZ    RBRB1
       4B6A                     RBRC:
000B6A 4B6A CD424E          17      CALL    RBXC
000B6D 4B6D 2807            12      JR  Z,RBREND
                                
000B6F 4B6F CDD54E          17      CALL    CLUST
000B72 4B72 EB               4      EX  DE,HL
000B73 4B73 CD1145          17      CALL    ROM_LDIR
       4B76                     RBREND:
000B76 4B76 CD4E4E          17      CALL    RBXEND
       4B79                     RBREND0:
000B79 4B79 FDE1            14      POP IY
000B7B 4B7B C1              10      POP BC
000B7C 4B7C D1              10      POP DE
000B7D 4B7D F1              10      POP AF  ;(HL)
000B7E 4B7E AF               4      XOR A
000B7F 4B7F 3AC3F2          13      LD  A,(_RESULT)
000B82 4B82 C9              10      RET
                                
       4B83                     RBRERR1:
000B83 4B83 3E01             7      LD  A,001H
       4B85                     RBRERR2:
000B85 4B85 FDE1            14      POP IY
000B87 4B87 C1              10      POP BC
000B88 4B88 D1              10      POP DE
000B89 4B89 E1              10      POP HL
000B8A 4B8A 37               4      SCF
000B8B 4B8B 210000          10      LD  HL,0
000B8E 4B8E C9              10      RET
       4B8F                     RBRERR:
000B8F 4B8F 3EFF             7      LD  A,0FFH
000B91 4B91 18F2            12      JR  RBRERR2
                                
       4B93                     FILE_DD:
000B93 4B93 E1              10      POP HL
000B94 4B94 3E                      DB  03EH
000B95 4B95 C9              10      RET
000B96 4B96 32A3F2          13      LD  (SWC_BLOAD_M),A
       4B99                     ROM_ORG:
000B99 4B99 2AF3F2          16      LD  HL,(PARAM0)
000B9C 4B9C 7E               7      LD  A,(HL)
000B9D 4B9D C9              10      RET
       4B9E                     FILE_B:
000B9E 4B9E AF               4      XOR A
000B9F 4B9F 32F9F2          13      LD  (FDRV),A
000BA2 4BA2 1E00             7      LD  E,0
000BA4 4BA4 3A63F6          13      LD  A,(VALTYP)
000BA7 4BA7 FE03             7      CP  3       ;string
000BA9 4BA9 C22E4C          10      JP  NZ,FILED
                                
000BAC 4BAC DD21D067        14      LD  IX,FRESTR
000BB0 4BB0 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000BB4 4BB4 CD1C00          17      CALL    _CALSLT
000BB7 4BB7 E5              11      PUSH    HL
000BB8 4BB8 DDE1            14      POP IX
                                
000BBA 4BBA DD5E00          19      LD  E,(IX+0)
000BBD 4BBD DD7E01          19      LD  A,(IX+1)
000BC0 4BC0 DD5602          19      LD  D,(IX+2)
000BC3 4BC3 DD62             9      LD  IXH,D
000BC5 4BC5 DD6F             9      LD  IXL,A
000BC7 4BC7 7B               4      LD  A,E
       4BC8                     FILE_BDOS:
000BC8 4BC8 FE04             7      CP  4
000BCA 4BCA 3808            12      JR  C,FILEB1
000BCC 4BCC DD7E03          19      LD  A,(IX+3)
000BCF 4BCF FE3A             7      CP  ':'
000BD1 4BD1 28C0            12      JR  Z,FILE_DD
000BD3 4BD3 7B               4      LD  A,E
       4BD4                     FILEB1:
000BD4 4BD4 FE02             7      CP  2
000BD6 4BD6 3818            12      JR  C,DEVI1
000BD8 4BD8 DD7E01          19      LD  A,(IX+1)
000BDB 4BDB FE3A             7      CP  ':'
000BDD 4BDD 2011            12      JR  NZ,DEVI1
000BDF 4BDF DD7E00          19      LD  A,(IX+0)        ;DRIVE
000BE2 4BE2 CD074D          17      CALL    CAP
000BE5 4BE5 D640             7      SUB '@'
000BE7 4BE7 DD23            10      INC IX
000BE9 4BE9 DD23            10      INC IX
000BEB 4BEB 1D               4      DEC E
000BEC 4BEC 1D               4      DEC E
000BED 4BED 32F9F2          13      LD  (FDRV),A
       4BF0                     DEVI1:
000BF0 4BF0 DD7E00          19      LD  A,(IX+0)
000BF3 4BF3 D65C             7      SUB 05CH        ;\
000BF5 4BF5 2008            12      JR  NZ,NOROOT
000BF7 4BF7 6F               4      LD  L,A
000BF8 4BF8 67               4      LD  H,A
000BF9 4BF9 22F7F2          16      LD  (_CDX),HL
000BFC 4BFC DD23            10      INC IX
000BFE 4BFE 1D               4      DEC E
       4BFF                     NOROOT:
                                
       4BFF                     SETDIR:
000BFF 4BFF CD2E4C          17      CALL    FILED
000C02 4C02 DD7E00          19      LD  A,(IX+0)
000C05 4C05 FE5C             7      CP  05CH        ;\
000C07 4C07 C0              11      RET NZ
000C08 4C08 DD23            10      INC IX
000C0A 4C0A 1D               4      DEC E
000C0B 4C0B 3AFAF2          13      LD  A,(FNAME)
000C0E 4C0E FE20             7      CP  020H        ;. の処理
000C10 4C10 28ED            12      JR  Z,SETDIR
                                
000C12 4C12 CD1D4D          17      CALL    ROM_OPEN
000C15 4C15 B7               4      OR  A
000C16 4C16 C0              11      RET NZ
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                #else
000C17 4C17 FD2AEDF2        20      LD  IY,(DIRENT1)
000C1B 4C1B FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000C1F 4C1F C8              11      RET Z
000C20 4C20 CD754C          17      CALL    FILEI
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
000C23 4C23 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000C26 4C26 FD661B          19      LD  H,(IY+01BH)
                                #endif
000C29 4C29 22F7F2          16      LD  (_CDX),HL
000C2C 4C2C 18D1            12      JR  SETDIR
                                
       4C2E                     FILED:
000C2E 4C2E CD754C          17      CALL    FILEI
000C31 4C31 21FAF2          10      LD  HL,FNAME
                                
000C34 4C34 0608             7      LD  B,8
       4C36                     FILE2:
000C36 4C36 CD824C          17      CALL    CCHKF
000C39 4C39 C8              11      RET Z
000C3A 4C3A FE2A             7      CP  '*'
000C3C 4C3C 282E            12      JR  Z,FILE9
000C3E 4C3E FE2E             7      CP  '.'
000C40 4C40 280C            12      JR  Z,FILE4
000C42 4C42 77               7      LD  (HL),A
000C43 4C43 23               6      INC HL
000C44 4C44 10F0            13      DJNZ    FILE2
                                
       4C46                     FILE3:
000C46 4C46 CD824C          17      CALL    CCHKF
000C49 4C49 C8              11      RET Z
000C4A 4C4A FE2E             7      CP  '.'
000C4C 4C4C 20F8            12      JR  NZ,FILE3
                                
       4C4E                     FILE4:
000C4E 4C4E 2102F3          10      LD  HL,FNAME+8
000C51 4C51 0603             7      LD  B,3
                                
       4C53                     FILE4L:
000C53 4C53 CD824C          17      CALL    CCHKF
000C56 4C56 C8              11      RET Z
000C57 4C57 FE2E             7      CP  '.'
000C59 4C59 2008            12      JR  NZ,FILE12
000C5B 4C5B 32FAF2          13      LD  (FNAME),A   ;Parent directory(..)
000C5E 4C5E 32FBF2          13      LD  (FNAME+1),A
000C61 4C61 3E20             7      LD  A,020H
       4C63                     FILE12:
000C63 4C63 FE2A             7      CP  '*'
000C65 4C65 280A            12      JR  Z,FILE10
000C67 4C67 77               7      LD  (HL),A
000C68 4C68 23               6      INC HL
000C69 4C69 10E8            13      DJNZ    FILE4L
000C6B 4C6B C9              10      RET
                                
       4C6C                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000C6C 4C6C CD714C          17      CALL    FILE10
000C6F 4C6F 18D5            12      JR  FILE3
                                
       4C71                     FILE10:
000C71 4C71 3E3F             7      LD  A,'?'
000C73 4C73 1808            12      JR  FILL_MEMORY
       4C75                     FILEI:              ;名前＋拡張子をスペースで初期化
000C75 4C75 3E20             7      LD  A,020H
000C77 4C77 01000B          10      LD  BC,11*256   ;C=0にしておく
000C7A 4C7A 21FAF2          10      LD  HL,FNAME
       4C7D                     FILL_MEMORY:            ;HLからBバイトAで埋める
000C7D 4C7D 77               7      LD  (HL),A
000C7E 4C7E 23               6      INC HL
000C7F 4C7F 10FC            13      DJNZ    FILL_MEMORY
000C81 4C81 C9              10      RET
                                
       4C82                     CCHKF:
000C82 4C82 7B               4      LD  A,E
000C83 4C83 B7               4      OR  A
000C84 4C84 C8              11      RET Z
000C85 4C85 DD7E00          19      LD  A,(IX+0)
000C88 4C88 CD8F4C          17      CALL    CCHK2
000C8B 4C8B C8              11      RET Z
000C8C 4C8C C3F24C          10      JP  FKAN
                                
       4C8F                     CCHK2:
000C8F 4C8F 0C               4      INC C
000C90 4C90 0D               4      DEC C
000C91 4C91 C0              11      RET NZ
       4C92                     CCHK3:              ;ZF=1 で使えない文字
000C92 4C92 FE2B             7      CP  '+'
000C94 4C94 C8              11      RET Z
000C95 4C95 FE2C             7      CP  ','
000C97 4C97 C8              11      RET Z
000C98 4C98 FE2F             7      CP  '/'
000C9A 4C9A C8              11      RET Z
000C9B 4C9B FE3A             7      CP  ':'
000C9D 4C9D C8              11      RET Z
000C9E 4C9E FE3B             7      CP  ';'
000CA0 4CA0 C8              11      RET Z
000CA1 4CA1 FE3D             7      CP  '='
000CA3 4CA3 C8              11      RET Z
000CA4 4CA4 FE5C             7      CP  05CH    ;\
000CA6 4CA6 C8              11      RET Z
000CA7 4CA7 FE1F             7      CP  01FH
000CA9 4CA9 D0              11      RET NC
000CAA 4CAA BF               4      CP  A       ;Z=1
000CAB 4CAB C9              10      RET
                                
       4CAC                     SS1:
000CAC 4CAC 13               6      INC DE
       4CAD                     SPCUT:              ;スペースをカット
000CAD 4CAD 1A               7      LD  A,(DE)
000CAE 4CAE FE20             7      CP  020H
000CB0 4CB0 28FA            12      JR  Z,SS1
000CB2 4CB2 C9              10      RET
                                
       4CB3                     SCREOF1:
000CB3 4CB3 13               6      INC DE
       4CB4                     SPCUTEX:            ;スペース改行などをカット
000CB4 4CB4 1A               7      LD  A,(DE)
000CB5 4CB5 FE20             7      CP  020H
000CB7 4CB7 28FA            12      JR  Z,SCREOF1
000CB9 4CB9 FE0D             7      CP  00DH
000CBB 4CBB 28F6            12      JR  Z,SCREOF1
000CBD 4CBD FE0A             7      CP  00AH
000CBF 4CBF 28F2            12      JR  Z,SCREOF1
000CC1 4CC1 FE1A             7      CP  01AH
000CC3 4CC3 28EE            12      JR  Z,SCREOF1
000CC5 4CC5 C9              10      RET
                                
       4CC6                     GETNUM:
000CC6 4CC6 210000          10      LD  HL,0
       4CC9                     GETNUM1:
000CC9 4CC9 1A               7      LD  A,(DE)
000CCA 4CCA 13               6      INC DE
000CCB 4CCB D630             7      SUB '0'
000CCD 4CCD D8              11      RET C
000CCE 4CCE FE0A             7      CP  10
000CD0 4CD0 D0              11      RET NC
000CD1 4CD1 4D               4      LD  C,L
000CD2 4CD2 44               4      LD  B,H
000CD3 4CD3 29              11      ADD HL,HL   ;*2
000CD4 4CD4 29              11      ADD HL,HL   ;*4
000CD5 4CD5 09              11      ADD HL,BC   ;*5
000CD6 4CD6 29              11      ADD HL,HL   ;*10
000CD7 4CD7 4F               4      LD  C,A
000CD8 4CD8 0600             7      LD  B,0
000CDA 4CDA 09              11      ADD HL,BC
000CDB 4CDB 18EC            12      JR  GETNUM1
                                
       4CDD                     SEARCH_END:
000CDD 4CDD 7E               7      LD  A,(HL)
       4CDE                     SEARCH_END1:
000CDE 4CDE 23               6      INC HL
000CDF 4CDF B7               4      OR  A
000CE0 4CE0 C8              11      RET Z
000CE1 4CE1 FE3A             7      CP  ':'
000CE3 4CE3 20F8            12      JR  NZ,SEARCH_END
000CE5 4CE5 7E               7      LD  A,(HL)
000CE6 4CE6 FE3A             7      CP  ':'
000CE8 4CE8 28F4            12      JR  Z,SEARCH_END1
000CEA 4CEA C9              10      RET
                                
       4CEB                     FKANC:
000CEB 4CEB CB41             8      BIT 0,C
000CED 4CED CC104D          17      CALL    Z,CAP2
000CF0 4CF0 1803            12      JR  FKANX
       4CF2                     FKAN:           ;漢字チェック
000CF2 4CF2 DD23            10      INC IX
000CF4 4CF4 1D               4      DEC E
       4CF5                     FKANX:
000CF5 4CF5 CB41             8      BIT 0,C
000CF7 4CF7 CB81             8      RES 0,C
000CF9 4CF9 C0              11      RET NZ
000CFA 4CFA FE80             7      CP  080H
000CFC 4CFC D8              11      RET C
000CFD 4CFD FEA0             7      CP  0A0H
000CFF 4CFF 3803            12      JR  C,FKAN1
000D01 4D01 FEE0             7      CP  0E0H
000D03 4D03 D8              11      RET C
       4D04                     FKAN1:
000D04 4D04 0C               4      INC C
000D05 4D05 A7               4      AND A
000D06 4D06 C9              10      RET
                                
       4D07                     CAP:
000D07 4D07 FE61             7      CP  'a'
000D09 4D09 D8              11      RET C
000D0A 4D0A FE7B             7      CP  'z'+1
000D0C 4D0C D0              11      RET NC
000D0D 4D0D D620             7      SUB 020H
000D0F 4D0F C9              10      RET
       4D10                     CAP2:
000D10 4D10 CD074D          17      CALL    CAP
       4D13                     CAP3:               ;
000D13 4D13 FE05             7      CP  5
000D15 4D15 2803            12      JR  Z,CAP4
000D17 4D17 FE21             7      CP  021H
000D19 4D19 C9              10      RET
       4D1A                     CAP4:
000D1A 4D1A 3EE5             7      LD  A,0E5H
000D1C 4D1C C9              10      RET
                                
       4D1D                     ROM_OPEN:
000D1D 4D1D CD5E54          17      CALL    GET_DISK_BANK_FDRV
                                
000D20 4D20 CD7B4F          17      CALL    GET_DIR_DAT
000D23 4D23 D5              11      PUSH    DE
000D24 4D24 CD394D          17      CALL    FILESE
000D27 4D27 D1              10      POP DE
000D28 4D28 3F               4      CCF
000D29 4D29 D8              11      RET C
000D2A 4D2A 22EDF2          16      LD  (DIRENT1),HL
000D2D 4D2D E5              11      PUSH    HL
000D2E 4D2E 210000          10      LD  HL,0
000D31 4D31 22CAF2          16      LD  (RR_LOW),HL
000D34 4D34 22CCF2          16      LD  (RR_HIGH),HL
000D37 4D37 E1              10      POP HL
000D38 4D38 C9              10      RET
                                
       4D39                     FILESE:
       4D39                     FILESE0:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000D39 4D39 7E               7      LD  A,(HL)
                                #endif
000D3A 4D3A B7               4      OR  A
000D3B 4D3B C8              11      RET Z       ;END:ZF=1 CF=0
000D3C 4D3C FEE5             7      CP  0E5H
000D3E 4D3E 280D            12      JR  Z,FILESE1
000D40 4D40 11FAF2          10      LD  DE,FNAME
000D43 4D43 E5              11      PUSH    HL
000D44 4D44 CD8A4D          17      CALL    CPFILE
000D47 4D47 CCAB4D          17      CALL    Z,CPFILE2
000D4A 4D4A E1              10      POP HL
000D4B 4D4B 37               4      SCF
000D4C 4D4C C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4D4D                     FILESE1:
000D4D 4D4D CD554D          17      CALL    FNEXT
000D50 4D50 20E7            12      JR  NZ,FILESE0
000D52 4D52 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000D54 4D54 C9              10      RET
                                
       4D55                     FNEXT:
000D55 4D55 112000          10      LD  DE,020H
000D58 4D58 19              11      ADD HL,DE
000D59 4D59 ED5BF7F2        20      LD  DE,(_CDX)
000D5D 4D5D 7A               4      LD  A,D
000D5E 4D5E B3               4      OR  E
000D5F 4D5F 2019            12      JR  NZ,FNEXT_SUBDIR
000D61 4D61 0D               4      DEC C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
       4D62                     CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
000D62 4D62 F5              11      PUSH    AF      ;※フラグを保存する必要あり
000D63 4D63 CB7C             8      BIT 7,H
000D65 4D65 2811            12      JR  Z,CHECK_DIR_PAGE1
000D67 4D67 7C               4      LD  A,H
000D68 4D68 D620             7      SUB 020H
000D6A 4D6A 67               4      LD  H,A
000D6B 4D6B 3AEFF2          13      LD  A,(_DIR_BANK)
000D6E 4D6E 3C               4      INC A
000D6F 4D6F 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D72 4D72 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D75 4D75 32EFF2          13      LD  (_DIR_BANK),A
       4D78                     CHECK_DIR_PAGE1:
000D78 4D78 F1              10      POP AF
                                #endif
000D79 4D79 C9              10      RET
                                
       4D7A                     FNEXT_SUBDIR:           ;サブディレクトリ
000D7A 4D7A 0D               4      DEC C
000D7B 4D7B C0              11      RET NZ
                                
000D7C 4D7C ED5BF7F2        20      LD  DE,(_CDX)
000D80 4D80 CDB24E          17      CALL    GNCL
000D83 4D83 EB               4      EX  DE,HL
000D84 4D84 22F7F2          16      LD  (_CDX),HL
000D87 4D87 C3B74F          10      JP  GET_SUBDIR
                                
       4D8A                     CPFILE:
000D8A 4D8A C5              11      PUSH    BC
000D8B 4D8B 01000B          10      LD  BC,00B00H
       4D8E                     CPSTR1:
000D8E 4D8E 1A               7      LD  A,(DE)
000D8F 4D8F FE3F             7      CP  '?'     ;Wild card
000D91 4D91 2812            12      JR  Z,CPSTR2
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000D93 4D93 7E               7      LD  A,(HL)
                                #endif
000D94 4D94 CDEB4C          17      CALL    FKANC
000D97 4D97 E5              11      PUSH    HL
000D98 4D98 67               4      LD  H,A
000D99 4D99 1A               7      LD  A,(DE)
000D9A 4D9A CB01             8      RLC C
000D9C 4D9C CDEB4C          17      CALL    FKANC
000D9F 4D9F CB09             8      RRC C
000DA1 4DA1 BC               4      CP  H       ;CP (HL),(DE)
000DA2 4DA2 E1              10      POP HL
000DA3 4DA3 2004            12      JR  NZ,CPSTR3
       4DA5                     CPSTR2:
000DA5 4DA5 13               6      INC DE
000DA6 4DA6 23               6      INC HL
000DA7 4DA7 10E5            13      DJNZ    CPSTR1
       4DA9                     CPSTR3:
000DA9 4DA9 C1              10      POP BC
000DAA 4DAA C9              10      RET
                                
       4DAB                     CPFILE2:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    CALL    RDSLT_ROM
                                #else
000DAB 4DAB 7E               7      LD  A,(HL)
                                #endif
000DAC 4DAC E608             7      AND 008H    ;~0F7H
000DAE 4DAE C9              10      RET
                                
       4DAF                     RBX1:
000DAF 4DAF E5              11      PUSH    HL      ;Record byte
                                
000DB0 4DB0 ED5BCAF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000DB4 4DB4 3ACDF2          13      LD  A,(RR_HIGH+1)
000DB7 4DB7 4F               4      LD  C,A
                                
000DB8 4DB8 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001CH
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    CALL    RDSLT_ROM
                                    EX  DE,HL       ;AHL=File size
                                    POP DE
                                #else
000DBB 4DBB 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000DBE 4DBE 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000DC1 4DC1 FD2AEDF2        20      LD  IY,(DIRENT1)
000DC5 4DC5 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000DC8 4DC8 FD661D          19      LD  H,(IY+01DH)
000DCB 4DCB FD7E1E          19      LD  A,(IY+01EH)
                                #endif
                                
000DCE 4DCE A7               4      AND A
000DCF 4DCF ED52            15      SBC HL,DE
000DD1 4DD1 99               4      SBC A,C
000DD2 4DD2 D1              10      POP DE
                                
000DD3 4DD3 D8              11      RET C
000DD4 4DD4 4F               4      LD  C,A
000DD5 4DD5 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000DD6 4DD6 B2               4      OR  D
000DD7 4DD7 B3               4      OR  E
000DD8 4DD8 C0              11      RET NZ
000DD9 4DD9 37               4      SCF
000DDA 4DDA C9              10      RET
                                
       4DDB                     RBX2:
000DDB 4DDB ED4BCBF2        20      LD  BC,(RR_LOW+1)
000DDF 4DDF CD634E          17      CALL    RWXR
000DE2 4DE2 3AC7F2          13      LD  A,(CLSZ_H)
000DE5 4DE5 3D               4      DEC A
000DE6 4DE6 E5              11      PUSH    HL
000DE7 4DE7 2ACAF2          16      LD  HL,(RR_LOW)
000DEA 4DEA A4               4      AND H
000DEB 4DEB B5               4      OR  L
000DEC 4DEC E1              10      POP HL
000DED 4DED C9              10      RET
                                
       4DEE                     RBXA:
000DEE 4DEE D5              11      PUSH    DE
000DEF 4DEF CDD54E          17      CALL    CLUST
000DF2 4DF2 ED53D2F2        20      LD  (_DTPS),DE
000DF6 4DF6 D1              10      POP DE
000DF7 4DF7 CDB24E          17      CALL    GNCL
000DFA 4DFA D8              11      RET C
000DFB 4DFB ED53CEF2        20      LD  (_CLPS),DE
                                
000DFF 4DFF ED4BCAF2        20      LD  BC,(RR_LOW)
000E03 4E03 2AC6F2          16      LD  HL,(CLSZ)
000E06 4E06 7C               4      LD  A,H
000E07 4E07 3D               4      DEC A
000E08 4E08 A0               4      AND B
000E09 4E09 47               4      LD  B,A
000E0A 4E0A ED42            15      SBC HL,BC       ;remaining cluster
                                
000E0C 4E0C ED5BF1F2        20      LD  DE,(LEFTX)
000E10 4E10 ED52            15      SBC HL,DE       ;CP HL,DE
000E12 4E12 19              11      ADD HL,DE
000E13 4E13 3801            12      JR  C,RBXA1
000E15 4E15 EB               4      EX  DE,HL
       4E16                     RBXA1:
000E16 4E16 3AC4F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
000E19 4E19 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000E1C 4E1C 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000E1F 4E1F E5              11      PUSH    HL
000E20 4E20 2AD2F2          16      LD  HL,(_DTPS)
000E23 4E23 09              11      ADD HL,BC
000E24 4E24 ED5BE7F2        20      LD  DE,(DTAX)
000E28 4E28 C1              10      POP BC
000E29 4E29 C9              10      RET
                                
       4E2A                     RBXB:
000E2A 4E2A 2AE7F2          16      LD  HL,(DTAX)
000E2D 4E2D ED5BCEF2        20      LD  DE,(_CLPS)
000E31 4E31 3AF2F2          13      LD  A,(LEFTX+1)
000E34 4E34 47               4      LD  B,A
000E35 4E35 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4E38                     RBXB1:
000E38 4E38 1F               4      RRA     ;->CF
000E39 4E39 3804            12      JR  C,RBXB2
000E3B 4E3B CB38             8      SRL B   ;B=B/2
000E3D 4E3D 18F9            12      JR  RBXB1
       4E3F                     RBXB2:
000E3F 4E3F 78               4      LD  A,B
000E40 4E40 B7               4      OR  A
000E41 4E41 C9              10      RET
                                
       4E42                     RBXC:
000E42 4E42 ED4BF1F2        20      LD  BC,(LEFTX)
000E46 4E46 3AC7F2          13      LD  A,(CLSZ_H)
000E49 4E49 3D               4      DEC A
000E4A 4E4A A0               4      AND B
000E4B 4E4B 47               4      LD  B,A
000E4C 4E4C B1               4      OR  C
000E4D 4E4D C9              10      RET
                                
       4E4E                     RBXEND:
000E4E 4E4E ED5BD0F2        20      LD  DE,(_LEFT)
000E52 4E52 2ACAF2          16      LD  HL,(RR_LOW)
000E55 4E55 3ACDF2          13      LD  A,(RR_HIGH+1)
000E58 4E58 19              11      ADD HL,DE
000E59 4E59 CE00             7      ADC A,0
000E5B 4E5B 22CAF2          16      LD  (RR_LOW),HL
000E5E 4E5E 32CDF2          13      LD  (RR_HIGH+1),A
000E61 4E61 EB               4      EX  DE,HL       ;HL=Read byte
000E62 4E62 C9              10      RET
                                
       4E63                     RWXR:
000E63 4E63 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4E66                     L_RWX:
000E66 4E66 1F               4      RRA     ;->CF
000E67 4E67 3806            12      JR  C,E_RWX
000E69 4E69 CB38             8      SRL B   ;BC=BC/2
000E6B 4E6B CB19             8      RR  C   ;
000E6D 4E6D 18F7            12      JR  L_RWX
       4E6F                     E_RWX:
000E6F 4E6F 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
                                    PUSH    HL
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    POP HL
                                #else
000E72 4E72 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000E75 4E75 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000E78 4E78 FD2AEDF2        20      LD  IY,(DIRENT1)
000E7C 4E7C FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000E7F 4E7F FD561B          19      LD  D,(IY+01BH)
                                #endif
000E82 4E82 CD5E54          17      CALL    GET_DISK_BANK_FDRV
       4E85                     RWX1:
000E85 4E85 ED53CEF2        20      LD  (_CLPS),DE
000E89 4E89 7A               4      LD  A,D
000E8A 4E8A B3               4      OR  E
000E8B 4E8B 37               4      SCF
000E8C 4E8C C8              11      RET Z
                                
000E8D 4E8D 78               4      LD  A,B
000E8E 4E8E B1               4      OR  C
000E8F 4E8F C8              11      RET Z
                                
000E90 4E90 CDB24E          17      CALL    GNCL
000E93 4E93 D8              11      RET C
000E94 4E94 0B               6      DEC BC
000E95 4E95 CD144F          17      CALL    ENDCL
000E98 4E98 38EB            12      JR  C,RWX1
000E9A 4E9A 37               4      SCF
000E9B 4E9B C9              10      RET
                                
       4E9C                     NCL3:
000E9C 4E9C CD5E54          17      CALL    GET_DISK_BANK_FDRV
000E9F 4E9F 6B               4      LD  L,E
000EA0 4EA0 62               4      LD  H,D
000EA1 4EA1 CB3C             8      SRL H
000EA3 4EA3 CB1D             8      RR  L
000EA5 4EA5 1F               4      RRA
000EA6 4EA6 19              11      ADD HL,DE
000EA7 4EA7 010060          10      LD  BC,BANK1_ADR
000EAA 4EAA 09              11      ADD HL,BC
000EAB 4EAB ED4BC8F2        20      LD  BC,(SECSZ)
000EAF 4EAF 09              11      ADD HL,BC
000EB0 4EB0 17               4      RLA
000EB1 4EB1 C9              10      RET
                                
       4EB2                     GNCL:
000EB2 4EB2 7A               4      LD  A,D
000EB3 4EB3 B3               4      OR  E
000EB4 4EB4 37               4      SCF
000EB5 4EB5 C8              11      RET Z
000EB6 4EB6 C5              11      PUSH    BC
000EB7 4EB7 E5              11      PUSH    HL
000EB8 4EB8 CD9C4E          17      CALL    NCL3
000EBB 4EBB 3809            12      JR  C,GNC1
000EBD 4EBD 5E               7      LD  E,(HL)
000EBE 4EBE 23               6      INC HL
000EBF 4EBF 7E               7      LD  A,(HL)
000EC0 4EC0 E60F             7      AND 00FH
000EC2 4EC2 57               4      LD  D,A
000EC3 4EC3 E1              10      POP HL
000EC4 4EC4 C1              10      POP BC
000EC5 4EC5 C9              10      RET
       4EC6                     GNC1:
000EC6 4EC6 7E               7      LD  A,(HL)
000EC7 4EC7 23               6      INC HL
000EC8 4EC8 56               7      LD  D,(HL)
000EC9 4EC9 0604             7      LD  B,4
       4ECB                     GNC1L:
000ECB 4ECB CB3A             8      SRL D
000ECD 4ECD 1F               4      RRA
000ECE 4ECE 10FB            13      DJNZ    GNC1L
                                
000ED0 4ED0 5F               4      LD  E,A
000ED1 4ED1 E1              10      POP HL
000ED2 4ED2 C1              10      POP BC
000ED3 4ED3 A7               4      AND A
000ED4 4ED4 C9              10      RET
                                
       4ED5                     CLUST:
000ED5 4ED5 EB               4      EX  DE,HL
       4ED6                     CLUST_HL:
000ED6 4ED6 2B               6      DEC HL
000ED7 4ED7 2B               6      DEC HL
000ED8 4ED8 C5              11      PUSH    BC
000ED9 4ED9 3AC7F2          13      LD  A,(CLSZ_H)
000EDC 4EDC CD8E54          17      CALL    MUL_AHL
                                
000EDF 4EDF CD984F          17      CALL    GET_DIR_POS
000EE2 4EE2 4F               4      LD  C,A
000EE3 4EE3 0600             7      LD  B,0
000EE5 4EE5 09              11      ADD HL,BC
                                
000EE6 4EE6 ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
000EEA 4EEA CB38             8      SRL B
000EEC 4EEC CB19             8      RR  C           ;/2
000EEE 4EEE CB38             8      SRL B
000EF0 4EF0 CB19             8      RR  C           ;/4
000EF2 4EF2 CB38             8      SRL B
000EF4 4EF4 CB19             8      RR  C           ;/8
000EF6 4EF6 09              11      ADD HL,BC
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  A,L
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    JR  NC,CLUST2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
000EF7 4EF7 4D               4      LD  C,L     ;C=読み出し元
000EF8 4EF8 29              11      ADD HL,HL   ;64KB→32KB
000EF9 4EF9 29              11      ADD HL,HL   ;32KB→16KB
000EFA 4EFA 29              11      ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
000EFB 4EFB CD5E54          17      CALL    GET_DISK_BANK_FDRV
000EFE 4EFE 84               4      ADD A,H
000EFF 4EFF 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000F02 4F02 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000F05 4F05 32C4F2          13      LD  (_BANK),A
000F08 4F08 69               4      LD  L,C     ;C=読み出し元
000F09 4F09 3E1F             7      LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
000F0B 4F0B A5               4      AND L
                                #endif
       4F0C                     CLUST2:
000F0C 4F0C C660             7      ADD A,high BANK1_ADR
000F0E 4F0E 67               4      LD  H,A
000F0F 4F0F 2E00             7      LD  L,0
000F11 4F11 EB               4      EX  DE,HL
000F12 4F12 C1              10      POP BC
000F13 4F13 C9              10      RET
                                
       4F14                     ENDCL:
000F14 4F14 7A               4      LD  A,D ;END CLUSTER
000F15 4F15 FE0F             7      CP  00FH    ;FAT12の最大値
000F17 4F17 C0              11      RET NZ
000F18 4F18 7B               4      LD  A,E
000F19 4F19 FEF7             7      CP  0F7H
000F1B 4F1B C9              10      RET
                                
       4F1C                     RB_READ:
000F1C 4F1C AF               4      XOR A   ;HLA = HL*128
000F1D 4F1D CB3C             8      SRL H
000F1F 4F1F CB1D             8      RR  L
000F21 4F21 1F               4      RRA
000F22 4F22 32CAF2          13      LD  (RR_LOW),A
000F25 4F25 22CBF2          16      LD  (RR_MID),HL
000F28 4F28 218000          10      LD  HL,128
                                
000F2B 4F2B CDFD4A          17      CALL    ROM_READ
000F2E 4F2E C9              10      RET
                                
       4F2F                     GETSEQ:
000F2F 4F2F FD6E20          19      LD  L,(IY+32)
000F32 4F32 FD660C          19      LD  H,(IY+12)
                                
000F35 4F35 CB25             8      SLA L
                                
000F37 4F37 CB3C             8      SRL H
000F39 4F39 CB1D             8      RR  L
000F3B 4F3B C9              10      RET
                                
       4F3C                     SETSEQ:
000F3C 4F3C F5              11      PUSH    AF
000F3D 4F3D 3ACAF2          13      LD  A,(RR_LOW)
000F40 4F40 2ACBF2          16      LD  HL,(RR_MID)
                                
000F43 4F43 CD5A4F          17      CALL    SSQ1
                                
000F46 4F46 29              11      ADD HL,HL
000F47 4F47 CB3D             8      SRL L
000F49 4F49 FD7520          19      LD  (IY+32),L
000F4C 4F4C FD740C          19      LD  (IY+12),H
000F4F 4F4F F1              10      POP AF
000F50 4F50 C9              10      RET
                                
       4F51                     GETSIZE:
000F51 4F51 FD7E10          19      LD  A,(IY+16)
000F54 4F54 FD6E11          19      LD  L,(IY+17)
000F57 4F57 FD6612          19      LD  H,(IY+18)
       4F5A                     SSQ1:
000F5A 4F5A 87               4      ADD A,A
000F5B 4F5B ED6A            15      ADC HL,HL
000F5D 4F5D B7               4      OR  A
000F5E 4F5E C8              11      RET Z
000F5F 4F5F 23               6      INC HL
000F60 4F60 C9              10      RET
                                
       4F61                     SET_FCB:
000F61 4F61 D5              11      PUSH    DE
000F62 4F62 FDE1            14      POP IY
000F64 4F64 FD7E1C          19      LD  A,(IY+28)
000F67 4F67 FEFF             7      CP  0FFH
000F69 4F69 200C            12      JR  NZ,POPAF_SCF_FF_RET
000F6B 4F6B E5              11      PUSH    HL
000F6C 4F6C FD6E1A          19      LD  L,(IY+26)
000F6F 4F6F FD661B          19      LD  H,(IY+27)
000F72 4F72 22CEF2          16      LD  (_CLPS),HL
000F75 4F75 E1              10      POP HL
000F76 4F76 C9              10      RET
                                
       4F77                     POPAF_SCF_FF_RET:
000F77 4F77 F1              10      POP AF
000F78 4F78 37               4      SCF
000F79 4F79 9F               4      SBC A,A
000F7A 4F7A C9              10      RET
                                
       4F7B                     GET_DIR_DAT:
000F7B 4F7B 2AF7F2          16      LD  HL,(_CDX)
000F7E 4F7E 7C               4      LD  A,H
000F7F 4F7F B5               4      OR  L
000F80 4F80 2035            12      JR  NZ,GET_SUBDIR
000F82 4F82 CD984F          17      CALL    GET_DIR_POS
000F85 4F85 C660             7      ADD A,high BANK1_ADR
000F87 4F87 2E00             7      LD  L,0
000F89 4F89 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
000F8A 4F8A CD624D          17      CALL    CHECK_DIR_PAGE
                                #endif
000F8D 4F8D 3AC5F2          13      LD  A,(_BANK1)
000F90 4F90 32EFF2          13      LD  (_DIR_BANK),A
                                
000F93 4F93 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000F96 4F96 4F               4      LD  C,A
000F97 4F97 C9              10      RET
                                
       4F98                     GET_DIR_POS:                ;ルートディレクトリ
000F98 4F98 CD5E54          17      CALL    GET_DISK_BANK_FDRV
000F9B 4F9B 32C5F2          13      LD  (_BANK1),A
000F9E 4F9E 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000FA1 4FA1 47               4      LD  B,A
000FA2 4FA2 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000FA5 4FA5 4F               4      LD  C,A
000FA6 4FA6 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4FA9                     GET_DIR_POS1:
000FA9 4FA9 81               4      ADD A,C
000FAA 4FAA 10FD            13      DJNZ    GET_DIR_POS1
                                
000FAC 4FAC ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
000FB0 4FB0 37               4      SCF     ;無限ループ回避
       4FB1                     L_MDP:
000FB1 4FB1 CB18             8      RR  B   ;->CF
000FB3 4FB3 D8              11      RET C
000FB4 4FB4 87               4      ADD A,A
000FB5 4FB5 18FA            12      JR  L_MDP
                                
       4FB7                     GET_SUBDIR:             ;サブディレクトリ
000FB7 4FB7 CDD64E          17      CALL    CLUST_HL
000FBA 4FBA EB               4      EX  DE,HL
000FBB 4FBB 3AC4F2          13      LD  A,(_BANK)
000FBE 4FBE 32EFF2          13      LD  (_DIR_BANK),A
000FC1 4FC1 3AC7F2          13      LD  A,(CLSZ_H)
000FC4 4FC4 87               4      ADD A,A     ;*2
000FC5 4FC5 87               4      ADD A,A     ;*4
000FC6 4FC6 87               4      ADD A,A     ;*8
000FC7 4FC7 4F               4      LD  C,A
000FC8 4FC8 C9              10      RET
                                
       4FC9                     STATEMENT:
000FC9 4FC9 113352          10      LD  DE,STR_CHDIR
000FCC 4FCC CD1952          17      CALL    CPPROCNM
000FCF 4FCF 2812            12      JR  Z,_CHDIR
000FD1 4FD1 113952          10      LD  DE,STR_CHDRV
000FD4 4FD4 CD1952          17      CALL    CPPROCNM
000FD7 4FD7 281C            12      JR  Z,_CHDRV
000FD9 4FD9 113F52          10      LD  DE,STR_RAMDISK
000FDC 4FDC CD1952          17      CALL    CPPROCNM
000FDF 4FDF 2829            12      JR  Z,_RAMDISK
000FE1 4FE1 37               4      SCF
000FE2 4FE2 C9              10      RET
       4FE3                     _CHDIR:
000FE3 4FE3 7E               7      LD  A,(HL)
000FE4 4FE4 FE28             7      CP  '('
000FE6 4FE6 37               4      SCF
000FE7 4FE7 C0              11      RET NZ
000FE8 4FE8 CDAB48          17      CALL    INIT_PARAM
000FEB 4FEB CD9E4B          17      CALL    FILE_B
000FEE 4FEE CD3550          17      CALL    ROM_CD
000FF1 4FF1 D0              11      RET NC
000FF2 4FF2 C35247          10      JP  ERROR_FILE_NOT_FOUND
                                
       4FF5                     _CHDRV:
000FF5 4FF5 7E               7      LD  A,(HL)
000FF6 4FF6 FE28             7      CP  '('
000FF8 4FF8 37               4      SCF
000FF9 4FF9 C0              11      RET NZ
000FFA 4FFA CDAB48          17      CALL    INIT_PARAM
000FFD 4FFD E5              11      PUSH    HL
000FFE 4FFE CD9E4B          17      CALL    FILE_B
001001 5001 E1              10      POP HL
001002 5002 23               6      INC HL
001003 5003 3AF9F2          13      LD  A,(FDRV)
001006 5006 3D               4      DEC A
001007 5007 C3E756          10      JP  _SYS0EX1
                                
       500A                     _RAMDISK:
00100A 500A 7E               7      LD  A,(HL)
00100B 500B FE28             7      CP  '('
00100D 500D 37               4      SCF
00100E 500E C0              11      RET NZ
00100F 500F 23               6      INC HL
001010 5010 DD212F54        14      LD  IX,FRMQNT
001014 5014 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001018 5018 CD1C00          17      CALL    _CALSLT
00101B 501B E5              11      PUSH    HL
00101C 501C 110F00          10      LD  DE,15       ;切り上げの為
00101F 501F 19              11      ADD HL,DE
001020 5020 7D               4      LD  A,L
001021 5021 0604             7      LD  B,4     ;16で割る
       5023                     RAMDISK1:
001023 5023 CB3C             8      SRL H   ;/2
001025 5025 1F               4      RRA
001026 5026 10FB            13      DJNZ    RAMDISK1
001028 5028 FEFF             7      CP  0FFH
00102A 502A 2001            12      JR  NZ,RAMDISK2
00102C 502C 3D               4      DEC A
       502D                     RAMDISK2:
00102D 502D 47               4      LD  B,A
00102E 502E CD8758          17      CALL    _SYS68
                                
001031 5031 E1              10      POP HL
001032 5032 23               6      INC HL
001033 5033 AF               4      XOR A
001034 5034 C9              10      RET
                                
       5035                     ROM_CD:
001035 5035 3AFAF2          13      LD  A,(FNAME)
001038 5038 FE20             7      CP  020H
00103A 503A 2822            12      JR  Z,CD1
00103C 503C CD1D4D          17      CALL    ROM_OPEN
00103F 503F D8              11      RET C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0000BH   ;属性(アトリビュート)
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    POP DE
                                    BIT 4,A     ;ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001AH   ;ファイルの先頭クラスタ
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    LD  D,A
                                    EX  DE,HL
                                    POP DE
                                #else
001040 5040 FD2AEDF2        20      LD  IY,(DIRENT1)
001044 5044 FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
001048 5048 CA5247          10      JP  Z,ERROR_FILE_NOT_FOUND
00104B 504B FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
00104E 504E FD661B          19      LD  H,(IY+01BH)
                                #endif
       5051                     CD2:
001051 5051 22EBF2          16      LD  (_CD),HL
001054 5054 2AF5F2          16      LD  HL,(PARAM1)
       5057                     CD_SKIP:
001057 5057 7E               7      LD  A,(HL)
001058 5058 23               6      INC HL
001059 5059 FE21             7      CP  021H
00105B 505B 38FA            12      JR  C,CD_SKIP
00105D 505D C9              10      RET
       505E                     CD1:
00105E 505E 2AF7F2          16      LD  HL,(_CDX)
001061 5061 18EE            12      JR  CD2
                                
       5063                     GET_BASIC_FCB:
001063 5063 D5              11      PUSH    DE
001064 5064 23               6      INC HL  ;+1
001065 5065 5E               7      LD  E,(HL)  ;FCB[1]
001066 5066 23               6      INC HL  ;+2
001067 5067 56               7      LD  D,(HL)  ;FCB[2]
001068 5068 23               6      INC HL  ;+3
001069 5069 ED53EDF2        20      LD  (DIRENT1),DE
                                            ;FCB[3] backup char
00106D 506D 23               6      INC HL  ;+4
                                            ;FCB[4]
00106E 506E 23               6      INC HL  ;+5
00106F 506F 7E               7      LD  A,(HL)  ;FCB[5]
001070 5070 23               6      INC HL  ;+6
001071 5071 32EFF2          13      LD  (_DIR_BANK),A
001074 5074 5E               7      LD  E,(HL)  ;FCB[6]
001075 5075 23               6      INC HL  ;+7
001076 5076 56               7      LD  D,(HL)  ;FCB[7]
001077 5077 23               6      INC HL  ;+8
001078 5078 ED53CAF2        20      LD  (RR_LOW),DE
00107C 507C 7E               7      LD  A,(HL)  ;FCB[8]
00107D 507D 23               6      INC HL  ;+9
00107E 507E 32CCF2          13      LD  (RR_HIGH),A
001081 5081 22D4F2          16      LD  (_DTA),HL   ;FCB[9]
001084 5084 D1              10      POP DE
001085 5085 C9              10      RET
                                
       5086                     SET_BASIC_FCB:
001086 5086 E5              11      PUSH    HL
001087 5087 2A64F8          16      LD  HL,(PTRFIL)
00108A 508A 23               6      INC HL  ;+1
00108B 508B D5              11      PUSH    DE
00108C 508C ED5BEDF2        20      LD  DE,(DIRENT1)
001090 5090 73               7      LD  (HL),E  ;FCB[1]
001091 5091 23               6      INC HL  ;+2
001092 5092 72               7      LD  (HL),D  ;FCB[2]
001093 5093 23               6      INC HL  ;+3
001094 5094 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
001095 5095 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
001096 5096 23               6      INC HL  ;+5
001097 5097 3AEFF2          13      LD  A,(_DIR_BANK)
00109A 509A 77               7      LD  (HL),A  ;FCB[5]
00109B 509B 23               6      INC HL  ;+6
00109C 509C ED5BCAF2        20      LD  DE,(RR_LOW)
0010A0 50A0 73               7      LD  (HL),E  ;FCB[6]
0010A1 50A1 23               6      INC HL  ;+7
0010A2 50A2 72               7      LD  (HL),D  ;FCB[7]
0010A3 50A3 23               6      INC HL  ;+8
0010A4 50A4 3ACCF2          13      LD  A,(RR_HIGH)
0010A7 50A7 77               7      LD  (HL),A  ;FCB[8]
0010A8 50A8 D1              10      POP DE
0010A9 50A9 E1              10      POP HL
0010AA 50AA C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_18:BACKUP
                                ;in
                                ;   C : backup charactor
                                ;   HL: FBC pointer
                                ;out
       50AB                     DEVICE_18_BACKUP:
0010AB 50AB D5              11      PUSH    DE
0010AC 50AC E5              11      PUSH    HL
0010AD 50AD 110300          10      LD  DE,3
0010B0 50B0 19              11      ADD HL,DE
0010B1 50B1 71               7      LD  (HL),C
0010B2 50B2 E1              10      POP HL
0010B3 50B3 D1              10      POP DE
0010B4 50B4 C9              10      RET
                                
       50B5                     DEVICE_CHECK:
0010B5 50B5 3A8AFD          13      LD  A,(PROCNM+1)
0010B8 50B8 B7               4      OR  A
0010B9 50B9 C8              11      RET Z
0010BA 50BA 114752          10      LD  DE,STR_ROM
0010BD 50BD CD1952          17      CALL    CPPROCNM
0010C0 50C0 2802            12      JR  Z,DEVICE_OK
0010C2 50C2 37               4      SCF
0010C3 50C3 C9              10      RET
       50C4                     DEVICE_OK:
0010C4 50C4 AF               4      XOR A
0010C5 50C5 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファ
                                
       50C6                     DEVICE_0_OPEN:
0010C6 50C6 7B               4      LD  A,E
0010C7 50C7 FE02             7      CP  2       ;FOR OUTPUT
0010C9 50C9 281B            12      JR  Z,OPEN2
0010CB 50CB D5              11      PUSH    DE
0010CC 50CC E5              11      push    hl
                                ;
0010CD 50CD 3E01             7      LD  A,1     ;ドライブA
0010CF 50CF 32F9F2          13      LD  (FDRV),A
0010D2 50D2 2166F8          10      LD  HL,FILNAM
0010D5 50D5 11FAF2          10      LD  DE,FNAME
0010D8 50D8 010B00          10      LD  BC,8+3
0010DB 50DB CD9B58          17      CALL    INIT_FILE1
0010DE 50DE CD1D4D          17      CALL    ROM_OPEN
0010E1 50E1 DA5247          10      JP  C,ERROR_FILE_NOT_FOUND
0010E4 50E4 E1              10      pop hl
0010E5 50E5 D1              10      POP DE
       50E6                     OPEN2:
0010E6 50E6 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
0010E9 50E9 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
0010EA 50EA AF               4      XOR A
0010EB 50EB 32F1F2          13      LD  (LEFTX),A
0010EE 50EE CD8650          17      CALL    SET_BASIC_FCB
0010F1 50F1 7B               4      ld  a,e
0010F2 50F2 FE08             7      cp  8
0010F4 50F4 3F               4      ccf
0010F5 50F5 C9              10      ret
                                
       50F6                     DEVICE_2_CLOSE:
0010F6 50F6 AF               4      XOR A
                                ;   LD  (HL),A
0010F7 50F7 6F               4      LD  L,A
0010F8 50F8 67               4      LD  H,A
0010F9 50F9 2264F8          16      LD  (PTRFIL),HL
0010FC 50FC C9              10      RET
                                
       50FD                     DEVICE_ENTRY:
0010FD 50FD FE08             7      CP  8
0010FF 50FF 2826            12      JR  Z,DEVICE_8_SIN
001101 5101 3C               4      INC A
001102 5102 28B1            12      JR  Z,DEVICE_CHECK:
001104 5104 3D               4      DEC A
001105 5105 28BF            12      JR  Z,DEVICE_0_OPEN
001107 5107 FE0E             7      CP  14
001109 5109 2860            12      JR  Z,DEVICE_14_EOF
00110B 510B FE04             7      CP  4
00110D 510D 2834            12      JR  Z,DEVICE_4_RANDOM
00110F 510F FE0A             7      CP  10
001111 5111 2850            12      JR  Z,DEVICE_10_LOC
001113 5113 FE0C             7      CP  12
001115 5115 2878            12      JR  Z,DEVICE_12_LOF
001117 5117 FE02             7      CP  2
001119 5119 2890            12      JR  Z,DEVICE_18_BACKUP
00111B 511B FE02             7      CP  2
00111D 511D 28D7            12      JR  Z,DEVICE_2_CLOSE
00111F 511F FE06             7      CP  6
001121 5121 2802            12      JR  Z,DEVICE_6_SOUT
001123 5123 37               4      SCF
001124 5124 C9              10      RET
                                
       5125                     DEVICE_6_SOUT:
001125 5125 AF               4      XOR A
001126 5126 C9              10      RET
                                
       5127                     DEVICE_8_SIN:
001127 5127 CD6350          17      CALL    GET_BASIC_FCB
00112A 512A 210100          10      LD  HL,1
00112D 512D CDFD4A          17      CALL    ROM_READ
001130 5130 7C               4      LD  A,H
001131 5131 B5               4      OR  L
001132 5132 280D            12      JR  Z,CCF_RET
001134 5134 2AD4F2          16      LD  HL,(_DTA)
001137 5137 7E               7      LD  A,(HL)
001138 5138 F5              11      PUSH    AF
001139 5139 CD8650          17      CALL    SET_BASIC_FCB
00113C 513C F1              10      POP AF
00113D 513D FE0A             7      CP  00AH
00113F 513F C8              11      RET Z   ;ZF=separate
                                ;   CP  01AH
                                ;   JR  Z,SCF_RET
001140 5140 37               4      SCF     ;
       5141                     CCF_RET:
001141 5141 3F               4      CCF     ;ZF=0 CF=0にしたい
001142 5142 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_4:RANDOM
                                ;in
                                ;   A : 4
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
       5143                     DEVICE_4_RANDOM:
001143 5143 D5              11      PUSH    DE
001144 5144 CD6350          17      CALL    GET_BASIC_FCB
001147 5147 DDE5            15      PUSH    IX
001149 5149 DD218A2F        14      LD  IX,FRCINT
00114D 514D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001151 5151 CDB0F2          17      CALL    CAL_MP
001154 5154 DDE1            14      POP IX
001156 5156 2AF8F7          16      LD  HL,(DACDAT)
001159 5159 22CAF2          16      LD  (RR_LOW),HL
00115C 515C AF               4      XOR A
00115D 515D CD8650          17      CALL    SET_BASIC_FCB
001160 5160 D1              10      POP DE
001161 5161 AF               4      XOR A
001162 5162 C9              10      RET
                                
                                ;FUNC_10:LOC
                                ;in
                                ;   A : 10
                                ;out
                                ;   DAC    : value of received bytes
                                ;   VALTYP : DAC type
       5163                     DEVICE_10_LOC:
001163 5163 CD6350          17      CALL    GET_BASIC_FCB
001166 5166 2ACAF2          16      LD  HL,(RR_LOW)
001169 5169 183D            12      JR  RETURN_TYPE8_AHL
                                
                                ;--------------------------------------
                                ;FUNC_14:EOF
                                ;in
                                ;   A : 14
                                ;out
                                ;   DAC    : value of EOF value (EOF=-1)
                                ;   VALTYP : DAC type
       516B                     DEVICE_14_EOF:
00116B 516B CD6350          17      CALL    GET_BASIC_FCB
00116E 516E CDAF4D          17      CALL    RBX1
001171 5171 3810            12      JR  C,DEVICE_14_EOF1
001173 5173 210100          10      LD  HL,1
001176 5176 CDFD4A          17      CALL    ROM_READ
001179 5179 2AD4F2          16      LD  HL,(_DTA)
00117C 517C 7E               7      LD  A,(HL)
00117D 517D FE1A             7      CP  01AH
00117F 517F 37               4      SCF
001180 5180 2801            12      JR  Z,DEVICE_14_EOF1
001182 5182 3F               4      CCF
       5183                     DEVICE_14_EOF1:
001183 5183 9F               4      SBC A,A
001184 5184 6F               4      LD  L,A
001185 5185 67               4      LD  H,A
       5186                     return_type2_hl:
001186 5186 22F8F7          16      ld  (DACDAT),hl
001189 5189 3E02             7      ld  a,2
00118B 518B 3263F6          13      ld  (VALTYP),a
00118E 518E C9              10      ret
                                
                                ;--------------------------------------
                                ;FUNC_16:FPOS
                                ;in
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
                                ;   illegal function call
                                
                                ;--------------------------------------
                                ;FUNC_12:LOF
                                ;in
                                ;   A : 12
                                ;out
                                ;   DAC    : value of LOC+RSIQLN
                                ;   VALTYP : DAC type
       518F                     DEVICE_12_LOF:
00118F 518F CD6350          17      CALL    GET_BASIC_FCB
                                
001192 5192 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                    PUSH    DE
                                    LD  HL,(DIRENT1)
                                    LD  DE,0001CH
                                    ADD HL,DE
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  E,A
                                    CALL    RDSLT_ROM
                                    INC HL
                                    LD  D,A
                                    CALL    RDSLT_ROM
                                    EX  DE,HL       ;AHL=File size
                                    POP DE
                                #else
001195 5195 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
001198 5198 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
00119B 519B FD2AEDF2        20      LD  IY,(DIRENT1)
00119F 519F FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
0011A2 51A2 FD661D          19      LD  H,(IY+01DH)
0011A5 51A5 FD7E1E          19      LD  A,(IY+01EH)
                                #endif
       51A8                     RETURN_TYPE8_AHL:
0011A8 51A8 B7               4      OR  A
0011A9 51A9 2004            12      JR  NZ,RT8AHL1
0011AB 51AB CB7C             8      BIT 7,H
0011AD 51AD 28D7            12      JR  Z,return_type2_hl
       51AF                     RT8AHL1:
0011AF 51AF E5              11      PUSH    HL
0011B0 51B0 29              11      ADD HL,HL
0011B1 51B1 8F               4      ADC A,A
0011B2 51B2 32F8F7          13      LD  (DACDAT),A
0011B5 51B5 3E00             7      LD  A,0
0011B7 51B7 8F               4      ADC A,A
0011B8 51B8 32F9F7          13      LD  (DACDAT+1),A
                                
0011BB 51BB 3E02             7      LD  A,2
0011BD 51BD 3263F6          13      LD  (VALTYP),A
0011C0 51C0 DD213A30        14      LD  IX,FRCDBL
0011C4 51C4 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0011C8 51C8 CDB0F2          17      CALL    CAL_MP
                                
0011CB 51CB 211152          10      LD  HL,DBL32768
0011CE 51CE 1147F8          10      LD  DE,ARG
0011D1 51D1 010800          10      LD  BC,8
0011D4 51D4 EDB0                    LDIR
                                
0011D6 51D6 DD21E627        14      LD  IX,DECMUL
0011DA 51DA FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0011DE 51DE CDB0F2          17      CALL    CAL_MP
                                
0011E1 51E1 21F6F7          10      LD  HL,DAC
0011E4 51E4 1147F8          10      LD  DE,ARG
0011E7 51E7 010800          10      LD  BC,8
0011EA 51EA EDB0                    LDIR
                                
0011EC 51EC E1              10      POP HL
0011ED 51ED 22F8F7          16      LD  (DACDAT),HL
                                
0011F0 51F0 3E02             7      LD  A,2
0011F2 51F2 3263F6          13      LD  (VALTYP),A
0011F5 51F5 DD213A30        14      LD  IX,FRCDBL
0011F9 51F9 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0011FD 51FD CDB0F2          17      CALL    CAL_MP
                                
001200 5200 DD219A26        14      LD  IX,DECADD
001204 5204 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001208 5208 CDB0F2          17      CALL    CAL_MP
                                
00120B 520B 3E08             7      LD  A,8
00120D 520D 3263F6          13      LD  (VALTYP),A
001210 5210 C9              10      RET
                                
       5211                     DBL32768:
001211 5211 4532768000000000        DB  045H,032H,076H,080H,0,0,0,0
                                
       5219                     CPPROCNM:
001219 5219 E5              11      PUSH    HL
00121A 521A 2189FD          10      LD  HL,PROCNM
       521D                     CPPROCNM1:
00121D 521D 1A               7      LD  A,(DE)
00121E 521E 13               6      INC DE
00121F 521F BE               7      CP  (HL)
001220 5220 23               6      INC HL
001221 5221 2003            12      JR  NZ,CPPROCNM2
001223 5223 B7               4      OR  A
001224 5224 20F7            12      JR  NZ,CPPROCNM1
       5226                     CPPROCNM2:
001226 5226 E1              10      POP HL
001227 5227 C9              10      RET
                                
       5228                     WILDCARD:
001228 5228 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       5233                     STR_CHDIR:
001233 5233 434844495200            DB  "CHDIR",0
       5239                     STR_CHDRV:
001239 5239 434844525600            DB  "CHDRV",0
       523F                     STR_RAMDISK:
00123F 523F 52414D4449534B00        DB  "RAMDISK",0
       5247                     STR_ROM:
001247 5247 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       524B                     ERROR_WRITE_PROTECTED:
00124B 524B 3E00             7      LD  A,0     ;Write protected
00124D 524D C9              10      RET
       524E                     ERROR_NOT_READY:
00124E 524E F1              10      POP AF
00124F 524F 37               4      SCF
001250 5250 3E02             7      LD  A,2     ;Not ready
001252 5252 C9              10      RET
       5253                     DISKIO:
001253 5253 38F6            12      JR  C,ERROR_WRITE_PROTECTED
001255 5255 48               4      LD  C,B
001256 5256 CD6854          17      CALL    GET_DISK_BANK
001259 5259 F5              11      PUSH    AF
00125A 525A 3AC9F2          13      LD  A,(SECSZ_H)
00125D 525D B7               4      OR  A
00125E 525E 28EE            12      JR  Z,ERROR_NOT_READY
001260 5260 F1              10      POP AF
       5261                     SETMAP1:
001261 5261 E5              11      PUSH    HL
       5262                     DISKIO1:
001262 5262 C5              11      PUSH    BC      ;B=残りのセクタ数
001263 5263 D5              11      PUSH    DE      ;DE=セクタ番号
001264 5264 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
001265 5265 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
001266 5266 F5              11      PUSH    AF
001267 5267 3AC9F2          13      LD  A,(SECSZ_H)
00126A 526A CD8E54          17      CALL    MUL_AHL
00126D 526D F1              10      POP AF
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  A,L
                                    PUSH    BC
                                    LD  BC,-00020H  ;先頭の8KB部分
                                    ADD HL,BC
                                    POP BC
                                    JR  NC,DISKIO2
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
                                    AND L
                                    ADD A,020H
                                #else
00126E 526E 4D               4      LD  C,L     ;C=読み出し元
00126F 526F 29              11      ADD HL,HL       ;64KB→32KB
001270 5270 29              11      ADD HL,HL       ;32KB→16KB
001271 5271 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
001272 5272 84               4      ADD A,H
001273 5273 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
001276 5276 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
001279 5279 32C4F2          13      LD  (_BANK),A
00127C 527C 79               4      LD  A,C     ;C=読み出し元
00127D 527D E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       527F                     DISKIO2:
00127F 527F C660             7      ADD A,high BANK1_ADR
001281 5281 67               4      LD  H,A
001282 5282 ED4BC8F2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
001286 5286 69               4      LD  L,C     ;C=0
001287 5287 CD1145          17      CALL    ROM_LDIR
00128A 528A EB               4      EX  DE,HL
00128B 528B F1              10      POP AF
00128C 528C D1              10      POP DE
00128D 528D 13               6      INC DE
00128E 528E C1              10      POP BC
00128F 528F 10D1            13      DJNZ    DISKIO1
001291 5291 41               4      LD  B,C
                                
001292 5292 E1              10      POP HL
001293 5293 AF               4      XOR A
001294 5294 C9              10      RET
                                
       5295                     DSKCHG:
001295 5295 CDCE52          17      CALL    IS_BPB
001298 5298 3824            12      JR  C,NOTREADY
00129A 529A 3A23FB          13      LD  A,(DRVTBL+2)
00129D 529D B7               4      OR  A
00129E 529E 201A            12      JR  NZ,DSKCHG1
0012A0 52A0 3A21FB          13      LD  A,(DRVTBL)
0012A3 52A3 FE02             7      CP  2
0012A5 52A5 2013            12      JR  NZ,DSKCHG1
0012A7 52A7 CDCE52          17      CALL    IS_BPB
0012AA 52AA 300E            12      JR  NC,DSKCHG1
0012AC 52AC 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
0012AE 52AE 3221FB          13      LD  (DRVTBL),A
0012B1 52B1 3223FB          13      LD  (DRVTBL+2),A
0012B4 52B4 3A48F3          13      LD  A,(MASTERS)
0012B7 52B7 3224FB          13      LD  (DRVTBL+3),A
       52BA                     DSKCHG1:
0012BA 52BA AF               4      XOR A
0012BB 52BB 0601             7      LD  B,1
0012BD 52BD C9              10      RET
       52BE                     NOTREADY:
0012BE 52BE 3E02             7      LD  A,2
0012C0 52C0 37               4      SCF
0012C1 52C1 C9              10      RET
                                
       52C2                     NO_BPB:
0012C2 52C2 E1              10      POP HL
0012C3 52C3 23               6      INC HL
0012C4 52C4 119454          10      LD  DE,DPB2DD
0012C7 52C7 011200          10      LD  BC,DPB2DD_E-DPB2DD
0012CA 52CA EDB0                    LDIR
0012CC 52CC AF               4      XOR A
0012CD 52CD C9              10      RET
                                
       52CE                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
0012CE 52CE CD6854          17      CALL    GET_DISK_BANK
                                
0012D1 52D1 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
0012D4 52D4 FE01             7      CP  1
0012D6 52D6 D8              11      RET C
                                
0012D7 52D7 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
0012DA 52DA C6FF             7      ADD A,0FFH
0012DC 52DC D8              11      RET C
                                
0012DD 52DD 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       52E0                     IS_BPB1:
0012E0 52E0 FE01             7      CP  1
0012E2 52E2 C8              11      RET Z
0012E3 52E3 FE02             7      CP  2
0012E5 52E5 C8              11      RET Z
0012E6 52E6 FE04             7      CP  4
0012E8 52E8 C8              11      RET Z
0012E9 52E9 37               4      SCF
0012EA 52EA C9              10      RET
                                
       52EB                     GETDPB:
0012EB 52EB E5              11      PUSH    HL
0012EC 52EC CD6854          17      CALL    GET_DISK_BANK
                                
0012EF 52EF 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
0012F2 52F2 B7               4      OR  A
0012F3 52F3 28CD            12      JR  Z,NO_BPB
0012F5 52F5 DDE1            14      POP IX
0012F7 52F7 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
0012FA 52FA 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
0012FD 52FD DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
001300 5300 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
001303 5303 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
001306 5306 87               4      ADD A,A
001307 5307 87               4      ADD A,A
001308 5308 87               4      ADD A,A
001309 5309 3D               4      DEC A
00130A 530A DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
00130D 530D 06FF             7      LD  B,-1
00130F 530F A7               4      AND A           ;無限ループ阻止
       5310                     GETDPB1:
001310 5310 04               4      INC B
001311 5311 1F               4      RRA
001312 5312 38FC            12      JR  C,GETDPB1
001314 5314 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
001317 5317 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
00131A 531A 3D               4      DEC A
00131B 531B DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
00131E 531E A7               4      AND A           ;無限ループ阻止
00131F 531F 06FF             7      LD  B,-1
       5321                     GETDPB2:
001321 5321 04               4      INC B
001322 5322 1F               4      RRA
001323 5323 38FC            12      JR  C,GETDPB2
001325 5325 04               4      INC B
001326 5326 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
001329 5329 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt
00132C 532C DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
00132F 532F DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
001332 5332 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
001335 5335 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
001338 5338 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
00133B 533B DD770B          19      LD  (IX+11),A       ;MAXENT
                                
00133E 533E ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16
001342 5342 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
001345 5345 DD460A          19      LD  B,(IX+10)       ;FATCNT
001348 5348 210000          10      LD  HL,0
       534B                     GETDPB3:
00134B 534B 19              11      ADD HL,DE
00134C 534C 10FD            13      DJNZ    GETDPB3
       534E                     GETDPB4:
00134E 534E DD5E08          19      LD  E,(IX+8)        ;FIRFAT
001351 5351 DD5609          19      LD  D,(IX+9)        ;FIRFAT
001354 5354 19              11      ADD HL,DE
001355 5355 DD7511          19      LD  (IX+17),L       ;FIRDIR
001358 5358 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
00135B 535B DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
00135E 535E 87               4      ADD A,A
00135F 535F 87               4      ADD A,A
001360 5360 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       5363                     GETDPB5:
001363 5363 CB3B             8      SRL E
001365 5365 1F               4      RRA
001366 5366 30FB            12      JR  NC,GETDPB5
001368 5368 1600             7      LD  D,0
00136A 536A 19              11      ADD HL,DE
00136B 536B DD750C          19      LD  (IX+12),L       ;FIRREC
00136E 536E DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001371 5371 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16
                                
001374 5374 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
001377 5377 DD560D          19      LD  D,(IX+13)       ;FIRREC
00137A 537A A7               4      AND A
00137B 537B ED52            15      SBC HL,DE
                                
00137D 537D DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
001380 5380 3C               4      INC A
001381 5381 37               4      SCF             ;無限ループ阻止
       5382                     GETDPB6:
001382 5382 1F               4      RRA
001383 5383 3806            12      JR  C,GETDPB7
001385 5385 CB3C             8      SRL H
001387 5387 CB1D             8      RR  L
001389 5389 18F7            12      JR  GETDPB6
       538B                     GETDPB7:
00138B 538B 23               6      INC HL
00138C 538C DD750E          19      LD  (IX+14),L       ;MAXCLUS
00138F 538F DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       5392                     GETDPBD1:
001392 5392 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001395 5395 E6FC             7      AND 0FCH
001397 5397 C8              11      RET Z
                                
001398 5398 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
00139C 539C 37               4      SCF
00139D 539D DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
0013A1 53A1 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
0013A4 53A4 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
0013A8 53A8 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
0013AC 53AC DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
0013B0 53B0 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
0013B4 53B4 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
0013B8 53B8 DDCB1126        23      SLA (IX+17)         ;FIRDIR
0013BC 53BC DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
0013C0 53C0 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
0013C3 53C3 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
0013C6 53C6 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0013C9 53C9 87               4      ADD A,A
0013CA 53CA 87               4      ADD A,A
0013CB 53CB DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       53CE                     GETDPBD5:
0013CE 53CE CB3B             8      SRL E
0013D0 53D0 1F               4      RRA
0013D1 53D1 30FB            12      JR  NC,GETDPBD5
0013D3 53D3 1600             7      LD  D,0
0013D5 53D5 19              11      ADD HL,DE
0013D6 53D6 DD750C          19      LD  (IX+12),L       ;FIRREC
0013D9 53D9 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
0013DC 53DC 18B4            12      JR  GETDPBD1
                                
       53DE                     CHOICE:
0013DE 53DE 210000          10      LD  HL,0
0013E1 53E1 C9              10      RET
                                
       53E2                     DSKFMT:
0013E2 53E2 AF               4      XOR A
0013E3 53E3 37               4      SCF
       53E4                     DSKSTP:
0013E4 53E4 C9              10      RET
                                
       53E5                     BASENT:
0013E5 53E5 3E                      DB  03EH
0013E6 53E6 F7              12      RST 30H
0013E7 53E7 32DBFD          13      LD  (H_PINL),A
0013EA 53EA 3A48F3          13      LD  A,(MASTERS)
0013ED 53ED 32DCFD          13      LD  (H_PINL+1),A
0013F0 53F0 210C54          10      LD  HL,BOOT_BASIC
0013F3 53F3 22DDFD          16      LD  (H_PINL+2),HL
0013F6 53F6 3E                      DB  03EH
0013F7 53F7 C9              10      RET
0013F8 53F8 32DFFD          13      LD  (H_PINL+4),A
                                
                                #if exists _RAM64K
0013FB 53FB 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
0013FE 53FE CD095A          17      CALL    ENASLT_00H
                                #endif
                                    ;BASICを起動する
001401 5401 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
001405 5405 DD21177D        14      LD  IX,ST_BAS   ;continue start of MSX-BASIC without executing BASIC programs in ROM
001409 5409 C35901          10      JP  CALBAS
                                
       540C                     BOOT_BASIC:
00140C 540C 3E                      DB  03EH
00140D 540D C9              10      RET
00140E 540E 32DBFD          13      LD  (H_PINL),A
                                
001411 5411 2A74F6          16      LD  HL,(STKTOP)
001414 5414 3A40F3          13      LD  A,(REBOOT)
001417 5417 C6FF             7      ADD A,0FFH
001419 5419 3811            12      JR  C,REBOOT1
00141B 541B 21A654          10      LD  HL,AUTOEXEC
00141E 541E 11F9F2          10      LD  DE,FDRV
001421 5421 010C00          10      LD  BC,1+8+3
001424 5424 EDB0                    LDIR
001426 5426 CD1D4D          17      CALL    ROM_OPEN
001429 5429 D49C46          17      CALL    NC,ROM_LOAD1
       542C                     REBOOT1:
00142C 542C 21BD54          10      LD  HL,DELOK
00142F 542F CDD944          17      CALL    MSX
001432 5432 21B254          10      LD  HL,CMD_RUN
001435 5435 111FF4          10      LD  DE,KBUF
001438 5438 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
00143B 543B D5              11      PUSH    DE
00143C 543C EDB0                    LDIR
00143E 543E 3004            12      JR  NC,REBOOT2
001440 5440 AF               4      XOR A
001441 5441 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       5444                     REBOOT2:
001444 5444 E1              10      POP HL
001445 5445 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
001449 5449 DD210146        14      LD  IX,NEWSTT
00144D 544D C31C00          10      JP  _CALSLT
                                
       5450                     GETSLT:
001450 5450 3A22FB          13      LD  A,(DRVTBL+1)
001453 5453 C9              10      RET
                                
       5454                     GET_DISK_BANK_H:
001454 5454 3AF0F2          13      LD  A,(_LVECTOR)
001457 5457 E680             7      AND 080H
001459 5459 87               4      ADD A,A
00145A 545A 3811            12      JR  C,SET_DISK_BANK_A
00145C 545C 1816            12      JR  SET_DISK_BANK
       545E                     GET_DISK_BANK_FDRV:
00145E 545E 3AF9F2          13      LD  A,(FDRV)
001461 5461 D601             7      SUB 1
001463 5463 3003            12      JR  NC,GET_DISK_BANK
001465 5465 3AEAF2          13      LD  A,(_DVSW)
       5468                     GET_DISK_BANK:
001468 5468 FE07             7      CP  7       ;H:
00146A 546A 28E8            12      JR  Z,GET_DISK_BANK_H
00146C 546C B7               4      OR  A       ;A=DRIVE
       546D                     SET_DISK_BANK_A:
00146D 546D 3E01             7      LD  A,DISK_BANK
00146F 546F 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
001471 5471 3AE9F2          13      LD  A,(B_DRIVE)
                                #endif
       5474                     SET_DISK_BANK:
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
001474 5474 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
001477 5477 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
00147A 547A F5              11      PUSH    AF
00147B 547B E5              11      PUSH    HL
00147C 547C 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec
00147F 547F 22C8F2          16      LD  (SECSZ),HL
001482 5482 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
001485 5485 CD8E54          17      CALL    MUL_AHL
001488 5488 22C6F2          16      LD  (CLSZ),HL
00148B 548B E1              10      POP HL
00148C 548C F1              10      POP AF
00148D 548D C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       548E                     MUL_AHL:
00148E 548E 37               4      SCF     ;無限ループ回避
       548F                     MUL_AHL1:
00148F 548F 1F               4      RRA     ;->CF
001490 5490 D8              11      RET C
001491 5491 29              11      ADD HL,HL
001492 5492 18FB            12      JR  MUL_AHL1
                                
       5494                     DPB2DD:
001494 5494 F9                      DB  0F9H    ;MEDIA
001495 5495 0002                    DW  00200H  ;SECSIZ
001497 5497 0F                      DB  00FH    ;DIRMSK
001498 5498 04                      DB  004H    ;DIRSHFT
001499 5499 01                      DB  001H    ;CLUSMSK
00149A 549A 02                      DB  002H    ;CLUSSHFT
00149B 549B 0100                    DW  00001H  ;FIRFAT
00149D 549D 02                      DB  002H    ;FATCNT
00149E 549E 70                      DB  070H    ;MAXENT
00149F 549F 0E00                    DW  0000EH  ;FIRREC
0014A1 54A1 CA02                    DW  002CAH  ;MAXCLUS
0014A3 54A3 03                      DB  003H    ;FATSIZ
0014A4 54A4 0700                    DW  0007H   ;FIRDIR
       54A6                     DPB2DD_E:
                                
       54A6                     AUTOEXEC:
0014A6 54A6 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       54B2                     CMD_RUN:
0014B2 54B2 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
0014B8 54B8 80EF                    DW  NEW_HIMEM
       54BA                     CMD_CLEAR_E:
0014BA 54BA 3A8A00                  DB  03AH,08AH,0         ;RUN
       54BD                     CMD_RUN_E:
       54BD                     DELOK:
0014BD 54BD 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       54C1                     _ERROR:
0014C1 54C1 AF               4      XOR A
0014C2 54C2 47               4      LD  B,A
0014C3 54C3 C9              10      RET
                                
       54C4                     ROM_BDOS:
0014C4 54C4 E5              11      PUSH    HL
0014C5 54C5 79               4      LD  A,C
0014C6 54C6 87               4      ADD A,A
0014C7 54C7 38F8            12      JR  C,_ERROR
0014C9 54C9 6F               4      LD  L,A
0014CA 54CA 2659             7      LD  H,high STABLE
0014CC 54CC 7E               7      LD  A,(HL)
0014CD 54CD 2C               4      INC L
0014CE 54CE 66               7      LD  H,(HL)
0014CF 54CF 6F               4      LD  L,A
0014D0 54D0 E3              19      EX  (SP),HL
0014D1 54D1 79               4      LD  A,C
0014D2 54D2 C9              10      RET
                                
       54D3                     _PRINT:
       54D3                     PRINT:
0014D3 54D3 7B               4      LD  A,E
0014D4 54D4 1803            12      JR  MSG_A
                                
       54D6                     _SYS01:     ;(BDOS)コンソール入力
0014D6 54D6 CD5B55          17      CALL    _SYS07
       54D9                     MSG_A:
0014D9 54D9 FE03             7      CP  3
0014DB 54DB 2814            12      JR  Z,MSG_BR
       54DD                     MSGA1:
0014DD 54DD F5              11      PUSH    AF
0014DE 54DE C5              11      PUSH    BC
0014DF 54DF D5              11      PUSH    DE
0014E0 54E0 E5              11      PUSH    HL
0014E1 54E1 DDE5            15      PUSH    IX
0014E3 54E3 DD21A200        14      LD  IX,CHPUT
0014E7 54E7 CDBA44          17      CALL    CALSLT_R
0014EA 54EA DDE1            14      POP IX
0014EC 54EC E1              10      POP HL
0014ED 54ED D1              10      POP DE
0014EE 54EE C1              10      POP BC
       54EF                     MSGA2:
0014EF 54EF F1              10      POP AF
0014F0 54F0 C9              10      RET
       54F1                     MSG_BR:
0014F1 54F1 F5              11      PUSH    AF
0014F2 54F2 3ADDF3          13      LD  A,(CSRX)
0014F5 54F5 FE02             7      CP  2
0014F7 54F7 38F6            12      JR  C,MSGA2
0014F9 54F9 F1              10      POP AF
       54FA                     MSG_CR:
0014FA 54FA F5              11      PUSH    AF
0014FB 54FB 3E0D             7      LD  A,00DH
0014FD 54FD CDDD54          17      CALL    MSGA1
001500 5500 3E0A             7      LD  A,00AH
001502 5502 CDDD54          17      CALL    MSGA1
001505 5505 F1              10      POP AF
001506 5506 C9              10      RET
                                
       5507                     _SYS02:     ;(BDOS)コンソール出力
001507 5507 CD2255          17      CALL    BREAK
00150A 550A 1805            12      JR  PRINTX
                                
       550C                     _SYS06:     ;(BDOS)コンソール直接入出力
00150C 550C 7B               4      LD  A,E
00150D 550D 3C               4      INC A
00150E 550E CA6F55          10      JP  Z,_INKEY
       5511                     PRINTX:
001511 5511 C3D354          10      JP  _PRINT
                                
       5514                     _SYS08:     ;(BDOS)エコーなしコンソール入力
001514 5514 CD5B55          17      CALL    _SYS07
001517 5517 FE03             7      CP  3
001519 5519 CC2255          17      CALL    Z,_BREAK
00151C 551C FE13             7      CP  013H        ;CTRL+S
00151E 551E C0              11      RET NZ
       551F                     PAUSE:
00151F 551F CD3955          17      CALL    KEYBC
                                
       5522                     _BREAK:
       5522                     BREAK:
001522 5522 F5              11      PUSH    AF
001523 5523 C5              11      PUSH    BC
001524 5524 D5              11      PUSH    DE
001525 5525 E5              11      PUSH    HL
001526 5526 DDE5            15      PUSH    IX
001528 5528 DD21B700        14      LD  IX,BREAKX
00152C 552C CDBA44          17      CALL    CALSLT_R
00152F 552F DDE1            14      POP IX
001531 5531 E1              10      POP HL
001532 5532 D1              10      POP DE
001533 5533 C1              10      POP BC
001534 5534 DC2255          17      CALL    C,_BREAK
001537 5537 F1              10      POP AF
001538 5538 C9              10      RET
       5539                     KEYBC:
001539 5539 F5              11      PUSH    AF
00153A 553A C5              11      PUSH    BC
00153B 553B D5              11      PUSH    DE
00153C 553C E5              11      PUSH    HL
00153D 553D DDE5            15      PUSH    IX
00153F 553F DD215601        14      LD  IX,KILBUF
001543 5543 CDBA44          17      CALL    CALSLT_R
001546 5546 DDE1            14      POP IX
001548 5548 E1              10      POP HL
001549 5549 D1              10      POP DE
00154A 554A C1              10      POP BC
00154B 554B F1              10      POP AF
00154C 554C C9              10      RET
                                
       554D                     _SYS09:     ;(BDOS)文字列出力
00154D 554D D5              11      PUSH    DE
       554E                     _SX09:
00154E 554E 1A               7      LD  A,(DE)
00154F 554F 13               6      INC DE
001550 5550 FE24             7      CP  '$'
001552 5552 2805            12      JR  Z,POPDE_RET
001554 5554 CDD954          17      CALL    MSG_A
001557 5557 18F5            12      JR  _SX09
       5559                     POPDE_RET:
001559 5559 D1              10      POP DE
00155A 555A C9              10      RET
                                
       555B                     _SYS07:
       555B                     FLGET:
00155B 555B C5              11      PUSH    BC
00155C 555C D5              11      PUSH    DE
00155D 555D E5              11      PUSH    HL
00155E 555E DDE5            15      PUSH    IX
001560 5560 DD219F00        14      LD  IX,CHGET
001564 5564 CDBA44          17      CALL    CALSLT_R
001567 5567 DDE1            14      POP IX
001569 5569 E1              10      POP HL
00156A 556A D1              10      POP DE
00156B 556B C1              10      POP BC
00156C 556C FE03             7      CP  3
00156E 556E C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       556F                     _INKEY:
       556F                     INKEY:
00156F 556F CDBA55          17      CALL    CPM_CONST
001572 5572 C8              11      RET Z
001573 5573 18E6            12      JR  FLGET
                                
       5575                     _SYS0A:     ;(BDOS)文字列入力
001575 5575 C5              11      PUSH    BC
001576 5576 E5              11      PUSH    HL
001577 5577 D5              11      PUSH    DE
001578 5578 3ADDF3          13      LD  A,(CSRX)
00157B 557B 5F               4      LD  E,A
00157C 557C 1600             7      LD  D,0
00157E 557E D5              11      PUSH    DE
00157F 557F DDE5            15      PUSH    IX
001581 5581 DD21AE00        14      LD  IX,PLININ
001585 5585 CDBA44          17      CALL    CALSLT_R
001588 5588 DDE1            14      POP IX
00158A 558A D1              10      POP DE
00158B 558B 215DF5          10      LD  HL,BUF-1
00158E 558E F5              11      PUSH    AF
00158F 558F 19              11      ADD HL,DE
001590 5590 F1              10      POP AF
001591 5591 EB               4      EX  DE,HL
001592 5592 E1              10      POP HL
001593 5593 E5              11      PUSH    HL
001594 5594 0E00             7      LD  C,0
001596 5596 3004            12      JR  NC,SAX0
001598 5598 23               6      INC HL
001599 5599 23               6      INC HL
00159A 559A 1808            12      JR  SAX4
       559C                     SAX0:
00159C 559C 46               7      LD  B,(HL)
00159D 559D 23               6      INC HL
       559E                     SAX1:
00159E 559E 23               6      INC HL
00159F 559F 1A               7      LD  A,(DE)
0015A0 55A0 13               6      INC DE
0015A1 55A1 B7               4      OR  A
0015A2 55A2 2004            12      JR  NZ,SAX2
       55A4                     SAX4:
0015A4 55A4 360D            10      LD  (HL),00DH
0015A6 55A6 1804            12      JR  SAX3
       55A8                     SAX2:
0015A8 55A8 77               7      LD  (HL),A
0015A9 55A9 0C               4      INC C
0015AA 55AA 10F2            13      DJNZ    SAX1
       55AC                     SAX3:
0015AC 55AC D1              10      POP DE
0015AD 55AD 79               4      LD  A,C
0015AE 55AE 13               6      INC DE
0015AF 55AF 12               7      LD  (DE),A
0015B0 55B0 1B               6      DEC DE
0015B1 55B1 E1              10      POP HL
0015B2 55B2 C1              10      POP BC
0015B3 55B3 3E1E             7      LD  A,01EH
0015B5 55B5 CDD954          17      CALL    MSG_A
0015B8 55B8 AF               4      XOR A
0015B9 55B9 C9              10      RET
                                
       55BA                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       55BA                     CONSTX:
       55BA                     CPM_CONST:
0015BA 55BA C5              11      PUSH    BC
0015BB 55BB D5              11      PUSH    DE
0015BC 55BC E5              11      PUSH    HL
0015BD 55BD DDE5            15      PUSH    IX
0015BF 55BF DD219C00        14      LD  IX,CHSNS
0015C3 55C3 CDBA44          17      CALL    CALSLT_R
0015C6 55C6 DDE1            14      POP IX
0015C8 55C8 E1              10      POP HL
0015C9 55C9 D1              10      POP DE
0015CA 55CA C1              10      POP BC
0015CB 55CB C9              10      RET
                                
       55CC                     _SYS2A:     ;(BDOS)日付の獲得
0015CC 55CC 0E0B             7      LD  C,11        ;年/Year→HL
0015CE 55CE CD0D56          17      CALL    RDCLK_BCD
0015D1 55D1 6F               4      LD  L,A
0015D2 55D2 2600             7      LD  H,0
0015D4 55D4 3AF8FA          13      LD  A,(EXBRSA)
0015D7 55D7 B7               4      OR  A
0015D8 55D8 2804            12      JR  Z,SX2A1
0015DA 55DA 11BC07          10      LD  DE,1980     ;1980年～2079年
0015DD 55DD 19              11      ADD HL,DE
       55DE                     SX2A1:
0015DE 55DE 0E09             7      LD  C,9     ;月/Month→D
0015E0 55E0 CD0D56          17      CALL    RDCLK_BCD
0015E3 55E3 57               4      LD  D,A
                                
0015E4 55E4 0E07             7      LD  C,7     ;日/Day→E
0015E6 55E6 CD0D56          17      CALL    RDCLK_BCD
0015E9 55E9 5F               4      LD  E,A
                                
0015EA 55EA 0E06             7      LD  C,6     ;曜日/Week→A
       55EC                     RDCLK:
0015EC 55EC DDE5            15      PUSH    IX
0015EE 55EE DD21F501        14      LD  IX,REDCLK
       55F2                     WRCLK1:
0015F2 55F2 3AF8FA          13      LD  A,(EXBRSA)
0015F5 55F5 B7               4      OR  A
0015F6 55F6 280A            12      JR  Z,RDCLK1    ;MSX1
0015F8 55F8 FDE5            15      PUSH    IY
0015FA 55FA FD67             9      LD  IYH,A
0015FC 55FC 78               4      LD  A,B
0015FD 55FD CD1C00          17      CALL    _CALSLT
001600 5600 FDE1            14      POP IY
       5602                     RDCLK1:
001602 5602 DDE1            14      POP IX
001604 5604 C9              10      RET
       5605                     WRCLK:
001605 5605 DDE5            15      PUSH    IX
001607 5607 DD21F901        14      LD  IX,WRTCLK
00160B 560B 18E5            12      JR  WRCLK1
                                
       560D                     RDCLK_BCD:
00160D 560D CDEC55          17      CALL    RDCLK       ;1の位
001610 5610 47               4      LD  B,A
001611 5611 0C               4      INC C
001612 5612 CDEC55          17      CALL    RDCLK       ;10の位
001615 5615 87               4      ADD A,A     ;*2
001616 5616 4F               4      LD  C,A
001617 5617 87               4      ADD A,A     ;*4
001618 5618 87               4      ADD A,A     ;*8
001619 5619 81               4      ADD A,C     ;*10(8+2)
00161A 561A 80               4      ADD A,B     ;1の位
00161B 561B C9              10      RET
                                
       561C                     _SYS2C:     ;(BDOS)時刻の獲得
00161C 561C 011501          10      LD  BC,00115H       ;12時間計/24時間計の設定を24時間計に
00161F 561F CD0556          17      CALL    WRCLK
001622 5622 0E04             7      LD  C,4     ;H=時/Hour
001624 5624 CD0D56          17      CALL    RDCLK_BCD
001627 5627 67               4      LD  H,A
001628 5628 0E02             7      LD  C,2     ;L=分/Minute
00162A 562A CD0D56          17      CALL    RDCLK_BCD
00162D 562D 6F               4      LD  L,A
00162E 562E 0E00             7      LD  C,0     ;D=秒/Second
001630 5630 CD0D56          17      CALL    RDCLK_BCD
001633 5633 57               4      LD  D,A
001634 5634 AF               4      XOR A       ;E=1/100秒
001635 5635 5F               4      LD  E,A
001636 5636 C9              10      RET
                                
       5637                     POS:
001637 5637 F5              11      PUSH    AF
001638 5638 2ADCF3          16      LD  HL,(CSRY)
00163B 563B 7D               4      LD  A,L
00163C 563C 6C               4      LD  L,H
00163D 563D 67               4      LD  H,A
00163E 563E 2C               4      INC L
00163F 563F 24               4      INC H
001640 5640 F1              10      POP AF
001641 5641 C9              10      RET
                                
       5642                     LOC:
001642 5642 F5              11      PUSH    AF
001643 5643 E5              11      PUSH    HL
001644 5644 7D               4      LD  A,L
001645 5645 6C               4      LD  L,H
001646 5646 67               4      LD  H,A
001647 5647 2D               4      DEC L
001648 5648 25               4      DEC H
001649 5649 DDE5            15      PUSH    IX
00164B 564B DD21C600        14      LD  IX,POSIT
00164F 564F CDBA44          17      CALL    CALSLT_R
001652 5652 DDE1            14      POP IX
001654 5654 E1              10      POP HL
001655 5655 F1              10      POP AF
001656 5656 C9              10      RET
                                
       5657                     _SCRN:
       5657                     SCRN:
001657 5657 E5              11      PUSH    HL
001658 5658 DDE5            15      PUSH    IX
                                
00165A 565A 69               4      LD  L,C
00165B 565B 60               4      LD  H,B
00165C 565C DD214A00        14      LD  IX,RDVRM
001660 5660 CDBA44          17      CALL    CALSLT_R
                                
001663 5663 DDE1            14      POP IX
001665 5665 E1              10      POP HL
001666 5666 C9              10      RET
                                
       5667                     CTRL02:
001667 5667 F5              11      PUSH    AF
001668 5668 D5              11      PUSH    DE
001669 5669 2ADCF3          16      LD  HL,(CSRY)
00166C 566C 3AB0F3          13      LD  A,(LINLEN)
00166F 566F 4F               4      LD  C,A
001670 5670 94               4      SUB H   ;CSRX
001671 5671 C602             7      ADD A,2
001673 5673 47               4      LD  B,A ;カーソルより右の文字数
001674 5674 61               4      LD  H,C ;LINLEN
001675 5675 C5              11      PUSH    BC
001676 5676 CDC456          17      CALL    LOC0
001679 5679 C1              10      POP BC
                                
00167A 567A 1620             7      LD  D,020H
       567C                     C8X1:
00167C 567C DD214A00        14      LD  IX,RDVRM
001680 5680 CDBA44          17      CALL    CALSLT_R
001683 5683 4F               4      LD  C,A
001684 5684 7A               4      LD  A,D
001685 5685 DD214D00        14      LD  IX,WRTVRM
001689 5689 CDBA44          17      CALL    CALSLT_R
00168C 568C 2B               6      DEC HL
00168D 568D 51               4      LD  D,C
00168E 568E 10EC            13      DJNZ    C8X1
001690 5690 D1              10      POP DE
001691 5691 F1              10      POP AF
001692 5692 C9              10      RET
                                
       5693                     INSERT:
001693 5693 F5              11      PUSH    AF
001694 5694 D5              11      PUSH    DE
001695 5695 2ADCF3          16      LD  HL,(CSRY)
001698 5698 3AB0F3          13      LD  A,(LINLEN)
00169B 569B 4F               4      LD  C,A
00169C 569C 94               4      SUB H   ;CSRX
00169D 569D 3C               4      INC A
00169E 569E 47               4      LD  B,A ;カーソルより右の文字数
00169F 569F C5              11      PUSH    BC
0016A0 56A0 CDC456          17      CALL    LOC0
0016A3 56A3 C1              10      POP BC
                                
0016A4 56A4 1620             7      LD  D,020H
       56A6                     INS1:
0016A6 56A6 DD214A00        14      LD  IX,RDVRM
0016AA 56AA CDBA44          17      CALL    CALSLT_R
0016AD 56AD 4F               4      LD  C,A
0016AE 56AE 7A               4      LD  A,D
0016AF 56AF DD214D00        14      LD  IX,WRTVRM
0016B3 56B3 CDBA44          17      CALL    CALSLT_R
0016B6 56B6 23               6      INC HL
0016B7 56B7 51               4      LD  D,C
0016B8 56B8 10EC            13      DJNZ    INS1
0016BA 56BA D1              10      POP DE
0016BB 56BB F1              10      POP AF
0016BC 56BC C9              10      RET
                                
       56BD                     CONOUT1:
0016BD 56BD 59               4      LD  E,C
0016BE 56BE C3D354          10      JP  _PRINT
                                
       56C1                     GETVRAM:
0016C1 56C1 2ADCF3          16      LD  HL,(CSRY)
       56C4                     LOC0:
0016C4 56C4 2D               4      DEC L
0016C5 56C5 25               4      DEC H
0016C6 56C6 4C               4      LD  C,H ;CSRX-1
0016C7 56C7 5D               4      LD  E,L ;CSRY-1
       56C8                     LOC1:
0016C8 56C8 3AB0F3          13      LD  A,(LINLEN)
0016CB 56CB 67               4      LD  H,A
0016CC 56CC 1600             7      LD  D,0
0016CE 56CE 6A               4      LD  L,D ;0
0016CF 56CF 0608             7      LD  B,8
       56D1                     LOC2:
0016D1 56D1 29              11      ADD HL,HL
0016D2 56D2 3001            12      JR  NC,LOC3
0016D4 56D4 19              11      ADD HL,DE
       56D5                     LOC3:
0016D5 56D5 10FA            13      DJNZ    LOC2
0016D7 56D7 09              11      ADD HL,BC
0016D8 56D8 C9              10      RET
                                
       56D9                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0016D9 56D9 212200          10      LD  HL,00022H
0016DC 56DC AF               4      XOR A
0016DD 56DD 7D               4      LD  A,L
0016DE 56DE C9              10      RET
                                
       56DF                     _SYS0D:     ;(BDOS)ディスク・リセット
0016DF 56DF 218000          10      LD  HL,00080H
0016E2 56E2 22D4F2          16      LD  (_DTA),HL
0016E5 56E5 C9              10      RET
                                
       56E6                     _SYS0E:     ;(BDOS)カレントドライブの設定
0016E6 56E6 7B               4      LD  A,E
       56E7                     _SYS0EX1:
0016E7 56E7 FE08             7      CP  8
0016E9 56E9 3F               4      CCF
0016EA 56EA D8              11      RET C
0016EB 56EB 32EAF2          13      LD  (_DVSW),A
0016EE 56EE C9              10      RET
                                
       56EF                     _SYS0F:     ;(BDOS)ファイルのオープン
0016EF 56EF D5              11      PUSH    DE
0016F0 56F0 FDE1            14      POP IY
0016F2 56F2 CD9458          17      CALL    INIT_FILE
0016F5 56F5 CD1D4D          17      CALL    ROM_OPEN
0016F8 56F8 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
0016FA 56FA FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
0016FE 56FE FDE5            15      PUSH    IY
001700 5700 D1              10      POP DE
001701 5701 13               6      INC DE
001702 5702 010B00          10      LD  BC,11
001705 5705 EDB0                    LDIR
                                ;               Attribute
001707 5707 7E               7      LD  A,(HL)
001708 5708 FD770D          19      LD  (IY+13),A
                                ;               TIME
00170B 570B 110B00          10      LD  DE,11
00170E 570E 19              11      ADD HL,DE
00170F 570F 7E               7      LD  A,(HL)
001710 5710 23               6      INC HL
001711 5711 FD7716          19      LD  (IY+22),A
001714 5714 7E               7      LD  A,(HL)
001715 5715 23               6      INC HL
001716 5716 FD7717          19      LD  (IY+23),A
                                ;               DATE
001719 5719 7E               7      LD  A,(HL)
00171A 571A 23               6      INC HL
00171B 571B FD7714          19      LD  (IY+20),A
00171E 571E 7E               7      LD  A,(HL)
00171F 571F 23               6      INC HL
001720 5720 FD7715          19      LD  (IY+21),A
                                ;               First cluster
001723 5723 7E               7      LD  A,(HL)
001724 5724 23               6      INC HL
001725 5725 FD771A          19      LD  (IY+26),A
001728 5728 7E               7      LD  A,(HL)
001729 5729 23               6      INC HL
00172A 572A FD771B          19      LD  (IY+27),A
                                ;               SIZE
00172D 572D 7E               7      LD  A,(HL)
00172E 572E 23               6      INC HL
00172F 572F FD7710          19      LD  (IY+16),A
001732 5732 7E               7      LD  A,(HL)
001733 5733 23               6      INC HL
001734 5734 FD7711          19      LD  (IY+17),A
001737 5737 7E               7      LD  A,(HL)
001738 5738 23               6      INC HL
001739 5739 FD7712          19      LD  (IY+18),A
00173C 573C 7E               7      LD  A,(HL)
00173D 573D FD7713          19      LD  (IY+19),A
001740 5740 AF               4      XOR A
001741 5741 FD770C          19      LD  (IY+12),A
001744 5744 C9              10      RET
                                
       5745                     _SYS10:     ;(BDOS)ファイルのクローズ
001745 5745 AF               4      XOR A
001746 5746 C9              10      RET
                                
       5747                     S11X1:
001747 5747 FD7119          19      LD  (IY+25),C       ;RootEntCnt
00174A 574A FD750E          19      LD  (IY+14),L
00174D 574D FD740F          19      LD  (IY+15),H
       5750                     SCF_FF_RET:
001750 5750 37               4      SCF
001751 5751 9F               4      SBC A,A
001752 5752 C9              10      RET
                                
       5753                     _SYS11:     ;(BDOS)最初のファイルの検索
001753 5753 ED53D7F2        20      LD  (_FCB),DE
001757 5757 D5              11      PUSH    DE
001758 5758 FDE1            14      POP IY
00175A 575A CD9458          17      CALL    INIT_FILE
       575D                     S12X0:
00175D 575D CD7B4F          17      CALL    GET_DIR_DAT
       5760                     S12X1:
001760 5760 CD394D          17      CALL    FILESE
001763 5763 30E2            12      JR  NC,S11X1
001765 5765 0D               4      DEC C
001766 5766 FD7119          19      LD  (IY+25),C       ;RootEntCnt
001769 5769 FDCB0D66        20      BIT 4,(IY+13)
00176D 576D 280A            12      JR  Z,S12X2
00176F 576F E5              11      PUSH    HL
001770 5770 DDE1            14      POP IX
001772 5772 DD7E0B          19      LD  A,(IX+11)
001775 5775 FE0F             7      CP  00FH
001777 5777 28E4            12      JR  Z,S12X0
       5779                     S12X2:
001779 5779 012000          10      LD  BC,32
00177C 577C ED5BD4F2        20      LD  DE,(_DTA)
001780 5780 AF               4      XOR A
001781 5781 12               7      LD  (DE),A      ;ドライブ番号
001782 5782 13               6      INC DE
001783 5783 EDB0                    LDIR            ;ディレクトリエントリ
001785 5785 FD750E          19      LD  (IY+14),L
001788 5788 FD740F          19      LD  (IY+15),H
00178B 578B C9              10      RET
                                
       578C                     _SYS12:
00178C 578C FD2AD7F2        20      LD  IY,(_FCB)
001790 5790 FDE5            15      PUSH    IY
001792 5792 D1              10      POP DE
001793 5793 CD9458          17      CALL    INIT_FILE
       5796                     S12X3:
001796 5796 FD6E0E          19      LD  L,(IY+14)
001799 5799 FD660F          19      LD  H,(IY+15)
00179C 579C FD4E19          19      LD  C,(IY+25)
00179F 579F 18BF            12      JR  S12X1
                                
       57A1                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0017A1 57A1 CD614F          17      CALL    SET_FCB
0017A4 57A4 CD2F4F          17      CALL    GETSEQ
0017A7 57A7 CD1C4F          17      CALL    RB_READ
0017AA 57AA E5              11      PUSH    HL
0017AB 57AB CD3C4F          17      CALL    SETSEQ
0017AE 57AE E1              10      POP HL
       57AF                     SREAD:
0017AF 57AF C601             7      ADD A,001H
0017B1 57B1 D8              11      RET C
                                
0017B2 57B2 7D               4      LD  A,L
0017B3 57B3 D601             7      SUB 001H
0017B5 57B5 9F               4      SBC A,A
0017B6 57B6 E603             7      AND 3
0017B8 57B8 1F               4      RRA
0017B9 57B9 C9              10      RET
                                
       57BA                     _SYS18:     ;(BDOS)ログインベクトルの獲得
       57BA                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
0017BA 57BA 2AF0F2          16      LD  HL,(_LVECTOR)
0017BD 57BD AF               4      XOR A
0017BE 57BE 67               4      LD  H,A
0017BF 57BF C9              10      RET
                                
       57C0                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
0017C0 57C0 3AEAF2          13      LD  A,(_DVSW)
0017C3 57C3 A7               4      AND A
0017C4 57C4 C9              10      RET
                                
       57C5                     _SYS1A:     ;(BDOS)DTAの設定
0017C5 57C5 ED53D4F2        20      LD  (_DTA),DE
0017C9 57C9 AF               4      XOR A
0017CA 57CA C9              10      RET
                                
       57CB                     _SYS1B:     ;(BDOS)ディスク情報の獲得
0017CB 57CB 7B               4      LD  A,E
0017CC 57CC D601             7      SUB 1
0017CE 57CE DCC057          17      CALL    C,_SYS19
0017D1 57D1 5F               4      LD  E,A
0017D2 57D2 CDCE52          17      CALL    IS_BPB
0017D5 57D5 3827            12      JR  C,S1B_E
0017D7 57D7 F5              11      PUSH    AF
0017D8 57D8 215EF5          10      LD  HL,SYS1B_DPB
0017DB 57DB 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
0017DE 57DE 47               4      LD  B,A
0017DF 57DF 4F               4      LD  C,A
0017E0 57E0 3271F5          13      LD  (SYS1B_FAT),A
0017E3 57E3 7B               4      LD  A,E
0017E4 57E4 CDEB52          17      CALL    GETDPB
0017E7 57E7 DD215EF5        14      LD  IX,SYS1B_DPB
0017EB 57EB FD2171F5        14      LD  IY,SYS1B_FAT
0017EF 57EF ED4B60F5        20      LD  BC,(SYS1B_DPB+1+1)  ;SECSIZ
0017F3 57F3 ED5B6CF5        20      LD  DE,(SYS1B_DPB+1+13) ;MAXCLUS
0017F7 57F7 1B               6      DEC DE
0017F8 57F8 1B               6      DEC DE
0017F9 57F9 210000          10      LD  HL,0            ;書き込み不可なので0を返す
0017FC 57FC F1              10      POP AF
0017FD 57FD C9              10      RET
       57FE                     S1B_E:
0017FE 57FE 9F               4      SBC A,A
0017FF 57FF C9              10      RET
                                
       5800                     _SYS21:     ;(BDOS)ランダムな読み出し
001800 5800 CD614F          17      CALL    SET_FCB
                                
001803 5803 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001806 5806 FD6622          19      LD  H,(IY+34)
                                
001809 5809 CD1C4F          17      CALL    RB_READ
00180C 580C 18A1            12      JR  SREAD
                                
       580E                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
00180E 580E CDEF56          17      CALL    _SYS0F
001811 5811 D8              11      RET C
                                
001812 5812 D5              11      PUSH    DE      ;EX DE,IY
001813 5813 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001815 5815 CD514F          17      CALL    GETSIZE
       5818                     _S24X1:
001818 5818 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
00181B 581B FD7422          19      LD  (IY+34),H
00181E 581E FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
001822 5822 FDE3            23      EX  (SP),IY     ;
001824 5824 D1              10      POP DE      ;
                                
001825 5825 AF               4      XOR A
001826 5826 C9              10      RET
                                
       5827                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
001827 5827 E5              11      PUSH    HL
001828 5828 D5              11      PUSH    DE      ;EX DE,IY
001829 5829 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00182B 582B CD2F4F          17      CALL    GETSEQ
00182E 582E 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       5830                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001830 5830 CD614F          17      CALL    SET_FCB
001833 5833 E5              11      PUSH    HL
001834 5834 FD6E21          19      LD  L,(IY+33)
001837 5837 FD6622          19      LD  H,(IY+34)
00183A 583A 22CAF2          16      LD  (RR_LOW),HL
00183D 583D FD6E23          19      LD  L,(IY+35)
001840 5840 FD6624          19      LD  H,(IY+36)
001843 5843 22CCF2          16      LD  (RR_HIGH),HL
001846 5846 E1              10      POP HL
001847 5847 CDFD4A          17      CALL    ROM_READ
00184A 584A ED5BCAF2        20      LD  DE,(RR_LOW)
00184E 584E FD7321          19      LD  (IY+33),E
001851 5851 FD7222          19      LD  (IY+34),D
001854 5854 ED5BCCF2        20      LD  DE,(RR_HIGH)
001858 5858 FD7323          19      LD  (IY+35),E
00185B 585B FD7224          19      LD  (IY+36),D
00185E 585E 9F               4      SBC A,A
00185F 585F D8              11      RET C
001860 5860 3AC3F2          13      LD  A,(_RESULT)
001863 5863 C9              10      RET
                                
       5864                     _SYS2F:
001864 5864 44               4      LD  B,H
001865 5865 7D               4      LD  A,L
001866 5866 2AD4F2          16      LD  HL,(_DTA)
001869 5869 C35352          10      JP  DISKIO
                                
       586C                     _SYS5A:
00186C 586C 0600             7      LD  B,0
00186E 586E D5              11      PUSH    DE
00186F 586F DDE1            14      POP IX
       5871                     _SX5A1:
001871 5871 1A               7      LD  A,(DE)
001872 5872 B7               4      OR  A
001873 5873 2804            12      JR  Z,_SX5A2
001875 5875 13               6      INC DE
001876 5876 04               4      INC B
001877 5877 18F8            12      JR  _SX5A1
                                
       5879                     _SX5A2:
001879 5879 78               4      LD  A,B
00187A 587A CDC84B          17      CALL    FILE_BDOS
00187D 587D CD3550          17      CALL    ROM_CD
001880 5880 9F               4      SBC A,A
001881 5881 C9              10      RET
                                
       5882                     _SYS6F:
001882 5882 016F00          10      LD  BC,006FH
001885 5885 AF               4      XOR A
001886 5886 C9              10      RET
                                
       5887                     _SYS68:
001887 5887 21F0F2          10      LD  HL,_LVECTOR
00188A 588A CBFE            15      SET 7,(HL)
00188C 588C 78               4      LD  A,B
00188D 588D B7               4      OR  A
00188E 588E 3E00             7      LD  A,0
001890 5890 C0              11      RET NZ
001891 5891 CBBE            15      RES 7,(HL)
001893 5893 C9              10      RET 
                                
       5894                     INIT_FILE:
001894 5894 EB               4      EX  DE,HL
001895 5895 11F9F2          10      LD  DE,FDRV
001898 5898 010C00          10      LD  BC,1+8+3
       589B                     INIT_FILE1:
00189B 589B EDB0                    LDIR
00189D 589D CD5E54          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_MORMAL32K_OR_ASCII16
                                    LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
0018A0 58A0 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0018A3 58A3 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0018A6 58A6 2AEBF2          16      LD  HL,(_CD)
0018A9 58A9 22F7F2          16      LD  (_CDX),HL           ;カレントディレクトリ
0018AC 58AC C9              10      RET
                                
       58AD                     ZERO_MEMORY_DE:
0018AD 58AD AF               4      XOR A
       58AE                     FILL_MEMORY_DE:
0018AE 58AE 12               7      LD  (DE),A
0018AF 58AF 13               6      INC DE
0018B0 58B0 10FC            13      DJNZ    FILL_MEMORY_DE
0018B2 58B2 C9              10      RET
                                
       58B3                     LD_A_DE:
0018B3 58B3 1A               7      LD  A,(DE)
0018B4 58B4 CB7A             8      BIT 7,D
0018B6 58B6 C0              11      RET NZ
0018B7 58B7 C5              11      PUSH    BC
0018B8 58B8 D5              11      PUSH    DE
0018B9 58B9 E5              11      PUSH    HL
0018BA 58BA EB               4      EX  DE,HL
                                
0018BB 58BB 0141F3          10      LD  BC,RAMAD0
0018BE 58BE 7C               4      LD  A,H
0018BF 58BF 07               4      RLCA
0018C0 58C0 07               4      RLCA
0018C1 58C1 E603             7      AND 3
0018C3 58C3 81               4      ADD A,C
0018C4 58C4 4F               4      LD  C,A
0018C5 58C5 0A               7      LD  A,(BC)
                                
0018C6 58C6 CD0C00          17      CALL    _RDSLT
0018C9 58C9 E1              10      POP HL
0018CA 58CA D1              10      POP DE
0018CB 58CB C1              10      POP BC
0018CC 58CC C9              10      RET
                                
       5750                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       5750                     _SYS13  EQU SCF_FF_RET  ;(BDOS)ファイルの削除
       5750                     _SYS15  EQU SCF_FF_RET  ;(BDOS)シーケンシャルな書き込み
       5750                     _SYS16  EQU SCF_FF_RET  ;(BDOS)ファイルの作成
       5750                     _SYS17  EQU SCF_FF_RET  ;(BDOS)ファイル名の変更
       5750                     _SYS22  EQU SCF_FF_RET  ;(BDOS)ランダムな書き込み
       5750                     _SYS26  EQU SCF_FF_RET  ;(BDOS)ランダムブロック書き込み
       5750                     _SYS28  EQU SCF_FF_RET  ;(BDOS)ランダムな書き込み・その2
                                
       5750                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       5750                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       5750                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       5750                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
0018CD 58CD                         ALIGN   256
       5900                     STABLE:
                                ;0
001900 5900 C154D65407555057        DW  _ERROR,_SYS01,_SYS02,_SYS03
001908 5908 C154C1540C555B55        DW  _ERROR,_ERROR,_SYS06,_SYS07
001910 5910 14554D557555BA55        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
001918 5918 D956DF56E656EF56        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001920 5920 455753578C575057        DW  _SYS10,_SYS11,_SYS12,_SYS13
001928 5928 A157505750575057        DW  _SYS14,_SYS15,_SYS16,_SYS17
001930 5930 BA57C057C557CB57        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001938 5938 C154BA57C154C154        DW  _ERROR,_SYS1D,_ERROR,_ERROR
                                ;2
001940 5940 C154005850570E58        DW  _ERROR,_SYS21,_SYS22,_SYS23
001948 5948 2758C15450573058        DW  _SYS24,_ERROR,_SYS26,_SYS27
001950 5950 5057C154CC555057        DW  _SYS28,_ERROR,_SYS2A,_SYS2B
001958 5958 1C565057C1546458        DW  _SYS2C,_SYS2D,_ERROR,_SYS2F
                                ;3
001960 5960 C154C154C154C154        DW  _ERROR,_ERROR,_ERROR,_ERROR
001968 5968 C154C154C154C154        DW  _ERROR,_ERROR,_ERROR,_ERROR
001970 5970 C15450575057C154        DW  _ERROR,_SYS39,_SYS3A,_ERROR
001978 5978 C154C154C154C154        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001980 5980 C154C154C154C154        DW  _ERROR,_ERROR,_ERROR,_ERROR
001988 5988 C154C154C154C154        DW  _ERROR,_ERROR,_ERROR,_ERROR
001990 5990 C154C154C154C154        DW  _ERROR,_ERROR,_ERROR,_ERROR
001998 5998 C154C154C154C154        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
0019A0 59A0 C154C154C154C154        DW  _ERROR,_ERROR,_ERROR,_ERROR
0019A8 59A8 C154C154C154C154        DW  _ERROR,_ERROR,_ERROR,_ERROR
0019B0 59B0 C154C1546C58C154        DW  _ERROR,_ERROR,_SYS5A,_ERROR
0019B8 59B8 C154C154C154C154        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
0019C0 59C0 C154C154C154C154        DW  _ERROR,_ERROR,_ERROR,_ERROR
0019C8 59C8 C154C154C154C154        DW  _ERROR,_ERROR,_ERROR,_ERROR
0019D0 59D0 8758C154C154C154        DW  _SYS68,_ERROR,_ERROR,_ERROR
0019D8 59D8 C154C154C1548258        DW  _ERROR,_ERROR,_ERROR,_SYS6F
                                ;7
0019E0 59E0 C154C154C154C154        DW  _ERROR,_ERROR,_ERROR,_ERROR
0019E8 59E8 C154C154C154C154        DW  _ERROR,_ERROR,_ERROR,_ERROR
0019F0 59F0 C154C154C154C154        DW  _ERROR,_ERROR,_ERROR,_ERROR
0019F8 59F8 C154C154C154C154        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
                                    INCLUDE "SLOT.ASM"
                                #if exists _RAM64K
       5A00                     INT38H_ROM:
001A00 5A00 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
001A03 5A03 CD095A          17      CALL    ENASLT_00H
001A06 5A06 CD3800          17      CALL    00038H
                                ;   JP  ENASLT_00H
                                ;
                                ;ページ0専門のENASLT
                                ;in
                                ;A←スロット
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
                                ; ページ1 に配置
       5A09                     ENASLT_00H:
001A09 5A09 F3               4      DI
001A0A 5A0A D5              11      PUSH    DE
001A0B 5A0B 6F               4      LD  L,A
001A0C 5A0C E603             7      AND 3
001A0E 5A0E 4F               4      LD  C,A
001A0F 5A0F DBA8            11      IN  A,(0A8H)
001A11 5A11 67               4      LD  H,A
001A12 5A12 E6FC             7      AND 0FCH    ;ページ0
001A14 5A14 B1               4      OR  C
001A15 5A15 57               4      LD  D,A ;基本スロット
                                
001A16 5A16 7C               4      LD  A,H
001A17 5A17 E603             7      AND 3
001A19 5A19 CB7D             8      BIT 7,L
001A1B 5A1B CAFAEF          10      JP  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001A1E 5A1E F680             7      OR  080H
001A20 5A20 67               4      LD  H,A
                                            ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001A21 5A21 79               4      LD  A,C
001A22 5A22 0F               4      RRCA
001A23 5A23 0F               4      RRCA
001A24 5A24 4F               4      LD  C,A
001A25 5A25 7A               4      LD  A,D
001A26 5A26 E63F             7      AND 03FH    ;ページ0
001A28 5A28 B1               4      OR  C
001A29 5A29 D3A8            11      OUT (0A8H),A
                                                ;拡張スロットの切り替え
001A2B 5A2B 7D               4      LD  A,L
001A2C 5A2C 0F               4      RRCA
001A2D 5A2D 0F               4      RRCA
001A2E 5A2E E603             7      AND 3
001A30 5A30 4F               4      LD  C,A
                                
001A31 5A31 3AFFFF          13      LD  A,(0FFFFH)
001A34 5A34 2F               4      CPL
001A35 5A35 47               4      LD  B,A
001A36 5A36 E6FC             7      AND 0FCH    ;ページ0
001A38 5A38 B1               4      OR  C
001A39 5A39 32FFFF          13      LD  (0FFFFH),A
                                                ;基本スロットの切り替え
001A3C 5A3C 7A               4      LD  A,D
001A3D 5A3D D3A8            11      OUT (0A8H),A
001A3F 5A3F 78               4      LD  A,B
001A40 5A40 E603             7      AND 3
001A42 5A42 87               4      ADD A,A
001A43 5A43 87               4      ADD A,A
001A44 5A44 C3ECEF          10      JP  WRITE_SLTTBL
                                ;
                                ;   ENASLOTの補助（ページ0・003BH～に配置）
                                ;
       5A47                     AT_3B:              ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001A47 5A47 D3A8            11      OUT (0A8H),A
001A49 5A49 3AFFFF          13      LD  A,(0FFFFH)  ;拡張スロットの切り替え
001A4C 5A4C 2F               4      CPL
001A4D 5A4D 47               4      LD  B,A
001A4E 5A4E A3               4      AND E
001A4F 5A4F B1               4      OR  C
001A50 5A50 32FFFF          13      LD  (0FFFFH),A
                                                ;基本スロットの切り替え
001A53 5A53 7A               4      LD  A,D
001A54 5A54 D3A8            11      OUT (0A8H),A
001A56 5A56 C9              10      RET
       5A57                     AT_3B_E:
                                
       5A57                     AT_ISC:
001A57 EF80                         ORG ISC,AT_ISC-RUN
                                ;
                                ; インタースロットコール
                                ; ページ3 に配置
                                
                                ;
                                ;ENASLT
                                ;in
                                ;A←スロット
                                ;HL←上位2ビットで切り替えるページを指定
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
       EF80                     ENASLT:
001A57 EF80 CB7C             8      BIT 7,H
001A59 EF82 207D            12      JR  NZ,ENASLT1
001A5B EF84 CB74             8      BIT 6,H
001A5D EF86 2032            12      JR  NZ,ENASLT_40H
       EF88                     _ENASLT_00H:
001A5F EF88 E5              11      PUSH    HL
001A60 EF89 210280          10      LD  HL,08002H
001A63 EF8C 39              11      ADD HL,SP
001A64 EF8D E1              10      POP HL
001A65 EF8E 3014            12      JR  NC,_ENASLT_00H_S
       EF90                     ENASLT_SUB:
001A67 EF90 DDE5            15      PUSH    IX
001A69 EF92 DD21095A        14      LD  IX,ENASLT_00H
       EF96                     INT38H_SUB1:
001A6D EF96 FDE5            15      PUSH    IY
001A6F EF98 FD2A96F2        20      LD  IY,(ROM_SLT-1)
001A73 EF9C CD51F0          17      CALL    CALSLT
001A76 EF9F FDE1            14      POP IY
001A78 EFA1 DDE1            14      POP IX
001A7A EFA3 C9              10      RET
       EFA4                     _ENASLT_00H_S:
001A7B EFA4 ED73AFEF        20      LD  (ENASLT_SP1),SP
001A7F EFA8 315DF5          10      LD  SP,SPBUF
001A82 EFAB CD90EF          17      CALL    ENASLT_SUB
001A85 EFAE 310000          10      LD  SP,0
       EFAF                     ENASLT_SP1  EQU $-2
001A88 EFB1 C9              10      RET
                                
       EFB2                     INT38H_SUB:
001A89 EFB2 DDE5            15      PUSH    IX
001A8B EFB4 DD21005A        14      LD  IX,INT38H_ROM
001A8F EFB8 18DC            12      JR  INT38H_SUB1
                                ;
                                ;ページ1専門のENASLT
                                ;in
                                ;A←スロット
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
       EFBA                     ENASLT_40H:
001A91 EFBA F3               4      DI
001A92 EFBB D5              11      PUSH    DE
001A93 EFBC 6F               4      LD  L,A
001A94 EFBD E603             7      AND 3
001A96 EFBF 87               4      ADD A,A
001A97 EFC0 87               4      ADD A,A
001A98 EFC1 4F               4      LD  C,A
001A99 EFC2 DBA8            11      IN  A,(0A8H)
001A9B EFC4 67               4      LD  H,A
001A9C EFC5 E6F3             7      AND 0F3H    ;ページ1
001A9E EFC7 B1               4      OR  C
001A9F EFC8 57               4      LD  D,A ;基本スロットに出力する値
                                
001AA0 EFC9 7C               4      LD  A,H ;切り替えページ
001AA1 EFCA 0F               4      RRCA
001AA2 EFCB 0F               4      RRCA
001AA3 EFCC E603             7      AND 3
001AA5 EFCE CB7D             8      BIT 7,L
001AA7 EFD0 2828            12      JR  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001AA9 EFD2 F680             7      OR  080H
001AAB EFD4 67               4      LD  H,A ;基本スロットに出力する値
                                            ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001AAC EFD5 E603             7      AND 3
001AAE EFD7 0F               4      RRCA
001AAF EFD8 0F               4      RRCA
001AB0 EFD9 4F               4      LD  C,A
                                
001AB1 EFDA 7A               4      LD  A,D ;基本スロットに出力する値
001AB2 EFDB E63F             7      AND 03FH
001AB4 EFDD B1               4      OR  C
001AB5 EFDE 5F               4      LD  E,A ;基本スロットでページ3にスロットを割り当てる
                                
001AB6 EFDF 7D               4      LD  A,L
001AB7 EFE0 E60C             7      AND 00CH    ;ページ1
001AB9 EFE2 4F               4      LD  C,A
                                
001ABA EFE3 7B               4      LD  A,E
001ABB EFE4 1EF3             7      LD  E,0F3H  ;ページ1
001ABD EFE6 CD3B00          17      CALL    ENASUB
                                
001AC0 EFE9 78               4      LD  A,B
001AC1 EFEA E60C             7      AND 00CH
       EFEC                     WRITE_SLTTBL:       ;SLTTBLを書き換える
001AC3 EFEC B4               4      OR  H   ;A=拡張スロット H=基本スロット
001AC4 EFED 4F               4      LD  C,A
                                
001AC5 EFEE 7D               4      LD  A,L
001AC6 EFEF E603             7      AND 3
001AC8 EFF1 C6C5             7      ADD A,LOW SLTTBL
001ACA EFF3 6F               4      LD  L,A
001ACB EFF4 26FC             7      LD  H,HIGH SLTTBL
001ACD EFF6 70               7      LD  (HL),B  ;B:拡張スロットに設定した値
001ACE EFF7 79               4      LD  A,C ;ENASLTする前のスロット情報をAで返す
001ACF EFF8 D1              10      POP DE
001AD0 EFF9 C9              10      RET
                                
       EFFA                     ENASLT_NOEXT:               ;スロットが拡張されていない場合
001AD1 EFFA 5F               4      LD  E,A
001AD2 EFFB 7A               4      LD  A,D
001AD3 EFFC D3A8            11      OUT (0A8H),A
001AD5 EFFE 7B               4      LD  A,E ;ENASLTする前のスロット情報をAで返す
001AD6 EFFF D1              10      POP DE
001AD7 F000 C9              10      RET
                                
       F001                     ENASLT1:
001AD8 F001 CB74             8      BIT 6,H
001ADA F003 C0              11      RET NZ          ;ページ3はスロット切り替え不可
                                ;
                                ;ページ2専門のENASLT
                                ;in
                                ;A←スロット
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
       F004                     ENASLT_80H:
001ADB F004 F3               4      DI
001ADC F005 D5              11      PUSH    DE
001ADD F006 6F               4      LD  L,A
001ADE F007 E603             7      AND 3
001AE0 F009 87               4      ADD A,A
001AE1 F00A 87               4      ADD A,A
001AE2 F00B 87               4      ADD A,A
001AE3 F00C 87               4      ADD A,A
001AE4 F00D 4F               4      LD  C,A
001AE5 F00E DBA8            11      IN  A,(0A8H)
001AE7 F010 67               4      LD  H,A
001AE8 F011 E6CF             7      AND 0CFH    ;ページ2
001AEA F013 B1               4      OR  C
001AEB F014 57               4      LD  D,A ;基本スロット
                                
001AEC F015 7C               4      LD  A,H
001AED F016 0F               4      RRCA
001AEE F017 0F               4      RRCA
001AEF F018 0F               4      RRCA
001AF0 F019 0F               4      RRCA
001AF1 F01A E603             7      AND 3
001AF3 F01C CB7D             8      BIT 7,L
001AF5 F01E 28DA            12      JR  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001AF7 F020 F680             7      OR  080H
001AF9 F022 67               4      LD  H,A
                                            ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001AFA F023 7F               4      LD  A,A
001AFB F024 E603             7      AND 3
001AFD F026 0F               4      RRCA
001AFE F027 0F               4      RRCA
001AFF F028 4F               4      LD  C,A
001B00 F029 7A               4      LD  A,D
001B01 F02A E63F             7      AND 03FH    ;ページ2
001B03 F02C B1               4      OR  C
001B04 F02D 5F               4      LD  E,A
                                
001B05 F02E 7D               4      LD  A,L
001B06 F02F 07               4      RLCA
001B07 F030 07               4      RLCA
001B08 F031 E630             7      AND 030H
001B0A F033 4F               4      LD  C,A
                                
001B0B F034 7B               4      LD  A,E
001B0C F035 1ECF             7      LD  E,0CFH  ;ページ2
001B0E F037 CD3B00          17      CALL    ENASUB
                                
001B11 F03A 78               4      LD  A,B
001B12 F03B E630             7      AND 030H    ;ページ2
001B14 F03D 0F               4      RRCA
001B15 F03E 0F               4      RRCA
001B16 F03F 18AB            12      JR  WRITE_SLTTBL
                                
       F041                     CALLF:
001B18 F041 E3              19      EX  (SP),HL
001B19 F042 F5              11      PUSH    AF
001B1A F043 7E               7      LD  A,(HL)
001B1B F044 FD67             9      LD  IYH,A
001B1D F046 23               6      INC HL
001B1E F047 7E               7      LD  A,(HL)
001B1F F048 DD6F             9      LD  IXL,A
001B21 F04A 23               6      INC HL
001B22 F04B 7E               7      LD  A,(HL)
001B23 F04C DD67             9      LD  IXH,A
001B25 F04E 23               6      INC HL
001B26 F04F F1              10      POP AF
001B27 F050 E3              19      EX  (SP),HL
       F051                     CALSLT:
001B28 F051 08               4      EX  AF,AF'
001B29 F052 F5              11      PUSH    AF      ;裏AFを保存
001B2A F053 F3               4      DI
001B2B F054 E5              11      PUSH    HL
001B2C F055 210280          10      LD  HL,08002H
001B2F F058 39              11      ADD HL,SP
001B30 F059 E1              10      POP HL
001B31 F05A 3008            12      JR  NC,CALSLT_1
001B33 F05C CD73F0          17      CALL    CALSLT_2
       F05F                     CALSLT_E:
001B36 F05F 08               4      EX  AF,AF'
001B37 F060 F1              10      POP AF      ;保存した裏AF
001B38 F061 08               4      EX  AF,AF'
001B39 F062 FB               4      EI
001B3A F063 C9              10      RET
       F064                     CALSLT_1:
001B3B F064 ED736FF0        20      LD  (CSSP),SP
001B3F F068 315DF5          10      LD  SP,SPBUF
001B42 F06B CD73F0          17      CALL    CALSLT_2
001B45 F06E 310000          10      LD  SP,0
       F06F                     CSSP    EQU $-2
001B48 F071 18EC            12      JR  CALSLT_E
                                
       F073                     CALSLT_2:
001B4A F073 E5              11      PUSH    HL
001B4B F074 C5              11      PUSH    BC
001B4C F075 DD7C             9      LD  A,IXH
001B4E F077 67               4      LD  H,A
001B4F F078 FD7C             9      LD  A,IYH
001B51 F07A CD80EF          17      CALL    ENASLT
001B54 F07D C1              10      POP BC
001B55 F07E 6F               4      LD  L,A
001B56 F07F DD7C             9      LD  A,IXH
001B58 F081 67               4      LD  H,A
001B59 F082 E3              19      EX  (SP),HL
001B5A F083 08               4      EX  AF,AF'
001B5B F084 CD98F3          17      CALL    JP_IX
001B5E F087 E3              19      EX  (SP),HL
001B5F F088 C5              11      PUSH    BC
001B60 F089 08               4      EX  AF,AF'
001B61 F08A 7D               4      LD  A,L
001B62 F08B CD80EF          17      CALL    ENASLT
001B65 F08E 08               4      EX  AF,AF'
001B66 F08F C1              10      POP BC
001B67 F090 E1              10      POP HL
001B68 F091 C9              10      RET
                                
       F092                     RDSLT:
001B69 F092 E5              11      PUSH    HL
001B6A F093 CD80EF          17      CALL    ENASLT
001B6D F096 E1              10      POP HL
001B6E F097 46               7      LD  B,(HL)
001B6F F098 C5              11      PUSH    BC
001B70 F099 E5              11      PUSH    HL
001B71 F09A CD80EF          17      CALL    ENASLT
001B74 F09D E1              10      POP HL
001B75 F09E F1              10      POP AF
001B76 F09F C9              10      RET
                                
       F0A0                     WRSLT:
001B77 F0A0 E5              11      PUSH    HL
001B78 F0A1 CD80EF          17      CALL    ENASLT
001B7B F0A4 E1              10      POP HL
001B7C F0A5 73               7      LD  (HL),E
001B7D F0A6 E5              11      PUSH    HL
001B7E F0A7 CD80EF          17      CALL    ENASLT
001B81 F0AA E1              10      POP HL
001B82 F0AB C9              10      RET
                                
       F0AC                     INT38H:
001B83 F0AC F5              11      PUSH    AF
001B84 F0AD C5              11      PUSH    BC
001B85 F0AE E5              11      PUSH    HL
001B86 F0AF 210280          10      LD  HL,08002H
001B89 F0B2 39              11      ADD HL,SP
001B8A F0B3 380E            12      JR  C,INT38H1
001B8C F0B5 ED73C0F0        20      LD  (INTSP),SP  ;スタックポインタ保存
001B90 F0B9 315DF5          10      LD  SP,SPBUF
001B93 F0BC CDB2EF          17      CALL    INT38H_SUB
001B96 F0BF 310000          10      LD  SP,0
       F0C0                     INTSP   EQU $-2
001B99 F0C2 AF               4      XOR A
       F0C3                     INT38H1:
001B9A F0C3 DCB2EF          17      CALL    C,INT38H_SUB
001B9D F0C6 E1              10      POP HL
001B9E F0C7 C1              10      POP BC
001B9F F0C8 F1              10      POP AF
001BA0 F0C9 FB               4      EI
001BA1 F0CA C9              10      RET
                                ;
                                ;   ページ1のディスクの読み込み補助
                                ;
       F0CB                     LDIR_PAGE1_RAM:
001BA2 F0CB CDBAEF          17      CALL    ENASLT_40H
001BA5 F0CE C1              10      POP BC
001BA6 F0CF D1              10      POP DE
001BA7 F0D0 215EF5          10      LD  HL,BUF
001BAA F0D3 EDB0                    LDIR
001BAC F0D5 CDBAEF          17      CALL    ENASLT_40H
001BAF F0D8 C39045          10      JP  LDIR_PAGE1_ROM
       F0DB                     ISC_E:
001BB2 5BB2                         ORG $$+RUN,$$   ;$DEPHASE
                                
                                #endif
       5BB2                     AT_ISCB:
001BB2 F280                         ORG ISCB,AT_ISCB-RUN
                                
       F280                     REPLACE_COMMAND:
001BB2 F280 FEB7             7      CP  0B7H            ;FILES
001BB4 F282 CC7BFE          17      CALL    Z,H_FILE
001BB7 F285 FEB5             7      CP  0B5H            ;LOAD
001BB9 F287 CA71FE          10      JP  Z,H_BINS
001BBC F28A FE8A             7      CP  08AH            ;RUN
001BBE F28C CA76FE          10      JP  Z,H_BINL
001BC1 F28F FED6             7      CP  0D6H            ;COPY
001BC3 F291 2813            12      JR  Z,FIX_COPY
001BC5 F293 FECF             7      CP  0CFH            ;BLOAD
001BC7 F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
001BC8 F296 F7              12      RST 30H
       F297                     ROM_SLT:
001BC9 F297 00                      DB  0
001BCA F298 5F47                    DW  ROM_BLOAD
001BCC F29A F5              11      PUSH    AF
001BCD F29B E5              11      PUSH    HL
001BCE F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
001BD1 F29F E1              10      POP HL
001BD2 F2A0 F1              10      POP AF
001BD3 F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
001BD5 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
001BD7 F2A5 C9              10      RET
       F2A6                     FIX_COPY:
001BD8 F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
001BD9 F2A7 00                      DB  0
001BDA F2A8 DD48                    DW  ROM_COPY
001BDC F2AA C9              10      RET
       F2AB                     RAMUSE1:
001BDD F2AB 3A42F3          13      LD  A,(RAMAD1)
001BE0 F2AE 180E            12      JR  _ENASLT_40H
       F2B0                     CAL_MP:
001BE2 F2B0 2640             7      LD  H,040H
001BE4 F2B2 3AC1FC          13      LD  A,(EXPTBL)
001BE7 F2B5 CD2400          17      CALL    _ENASLT
001BEA F2B8 CD1C00          17      CALL    _CALSLT
       F2BB                     ROMUSE1:
001BED F2BB 3A97F2          13      LD  A,(ROM_SLT)
       F2BE                     _ENASLT_40H:
001BF0 F2BE 2640             7      LD  H,040H
001BF2 F2C0 C32400          10      JP  _ENASLT
                                
       F2C3                     _RESULT:
001BF5 F2C3 00                      DB  0
       F2C4                     _BANK:
001BF6 F2C4 00                      DB  0
       F2C5                     _BANK1:
001BF7 F2C5 00                      DB  0
       F2C6                     CLSZ:               ;クラスタサイズ
001BF8 F2C6 0004                    DW  1024
       F2C7                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2C8                     SECSZ:              ;セクタサイズ
001BFA F2C8 0002                    DW  512
       F2C9                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2CA                     RR_LOW:
001BFC F2CA 0000                    DW  0
       F2CB                     RR_MID  EQU $-1
       F2CC                     RR_HIGH:
001BFE F2CC 0000                    DW  0
       F2CE                     _CLPS:
001C00 F2CE 0000                    DW  0
       F2D0                     _LEFT:
001C02 F2D0 0000                    DW  0
       F2D2                     _DTPS:
001C04 F2D2 0000                    DW  0
       F2D4                     _DTA:
001C06 F2D4 0000                    DW  0
       F2D6                     FLG_LDIR:
001C08 F2D6 00                      DB  0
       F2D7                     _FCB:
001C09 F2D7 0000                    DW  0
       F2D9                     _BUF:
       F2D9                     _BUF_LO:        ;LOGICAL OPERATION
001C0B F2D9 00                      DB  0
       F2DA                     _BUF_ST:
001C0C F2DA 0000                    DW  0
       F2DC                     _BUF_EN:
001C0E F2DC 0000                    DW  0
       F2DE                     _BUF_EX:
       F2DE                     _BUF_W:
001C10 F2DE 0000                    DW  0
       F2E0                     _BUF_H:
001C12 F2E0 0000                    DW  0
       F2E2                     _BUF_X:
001C14 F2E2 0000                    DW  0
       F2E4                     _BUF_Y:
001C16 F2E4 00                      DB  0
       F2E5                     _BUF_P:
001C17 F2E5 00                      DB  0
       F2E6                     _BUF_O:
001C18 F2E6 00                      DB  0
       F2E7                     DTAX:
001C19 F2E7 0000                    DW  0
       F2E9                     B_DRIVE:
001C1B F2E9 00                      DB  0
       F2EA                     _DVSW:          ;カレントドライブ
001C1C F2EA 00                      DB  0
       F2EB                     _CD:            ;カレントディレクトリ
001C1D F2EB 0000                    DW  0
       F2ED                     DIRENT1:
001C1F F2ED 0000                    DW  0
       F2EF                     _DIR_BANK:
001C21 F2EF 00                      DB  0
       F2F0                     _LVECTOR:
001C22 F2F0 01                      DB  1
       F2F1                     LEFTX:
001C23 F2F1 0000                    DW  0
       F2F3                     PARAM0:
001C25 F2F3 0000                    DW  0
       F2F5                     PARAM1:
001C27 F2F5 0000                    DW  0
       F2F7                     _CDX:
001C29 F2F7 0000                    DW  0
       F2F9                     FDRV:
001C2B F2F9 00                      DB  0
       F2FA                     FNAME:
001C2C F2FA                         DS  8+3
       F305                     _HL:
001C37 F305 0000                    DW  0
       F307                     _SP:
001C39 F307 0000                    DW  0
       F308                     _SP_H   EQU $-1
                                
       F309                     ISCB_E:
[EOF:SLOT.ASM:UTF_8]
       1C3B                     LAST    EQU $$
001C3B F309                         DS  01FFFH-LAST
001FFF F6CD 00                      DB  0
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
[EOF:DISKROM64K.ASM:UTF_8]
