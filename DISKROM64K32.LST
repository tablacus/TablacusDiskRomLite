                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
       0001                     _RAM64K     EQU 1   ;メインRAM 64KB使用可能
       0001                     USE_MORMAL32K_OR_ASCII16        EQU 1   ;ノーマル32KB/ASCII-16K ROMを作成する
                                
                                    INCLUDE "DISKROM.ASM"
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00AE                     PLININ  EQU 000AEH
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
       0159                     CALBAS  EQU 00159H
       01F5                     REDCLK  EQU 001F5H  ;SUB
       01F9                     WRTCLK  EQU 001F9H  ;SUB
                                
       269A                     DECADD  EQU 0269AH
       27E6                     DECMUL  EQU 027E6H
       2F8A                     FRCINT  EQU 02F8AH
                                
       303A                     FRCDBL  EQU 0303AH
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
       7D17                     ST_BAS  EQU 07D17H
                                
       F323                     DISKVE  EQU 0F323H
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F398                     JP_IX   EQU 0F398H
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F847                     ARG EQU 0F847H
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
       FAF8                     EXBRSA  EQU 0FAF8H
                                
       FB03                     RSTMP   EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBB1                     BASROM  EQU 0FBB1H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCC5                     SLTTBL  EQU 0FCC5H
       FCC9                     SLTATR  EQU 0FCC9H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
       FD99                     DEVICE  EQU 0FD99H
                                
       FDDB                     H_PINL  EQU 0FDDBH
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       C000                     FD_BOOT_START   EQU 0C000H
       C01E                     FD_BOOT_EXEC    EQU 0C01EH
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                            ;ASCII-16K
       6000                     ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
       7000                     ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
                                BANK0_SEL EQU   06000H  ;6000-67FF
                                BANK1_SEL EQU   06800H  ;6800-6FFF
                                BANK2_SEL EQU   07000H  ;7000-77FF
                                BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
                                KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
                                KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
                                KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
                                KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
                                KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
                                KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
                                KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
       EF80                     ISC EQU 0EF80H
       F280                     ISCB    EQU 0F280H
                                
                                #if exists _RAM64K
       EF80                     NEW_HIMEM   EQU ISC
                                #else
                                NEW_HIMEM   EQU ISCB
                                #endif
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F55D                     SPBUF   EQU KBUF+318    ;ページ3にスタックがない場合はKBUFを一時的に使う
                                
       003B                     ENASUB  EQU 0003BH
       F55E                     SYS1B_DPB   EQU BUF
       F571                     SYS1B_FAT   EQU SYS1B_DPB+19
                                
       FB03                     TMP_DIRENT  EQU RSTMP
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0042                    DW  INIT_ROM    ; Main program execution address.
000004 4004 F750                    DW  STATEMENT   ; STATEMENT
000006 4006 3E52                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C39B53          10      JP  DISKIO
000013 4013 C3E853          10      JP  DSKCHG
000016 4016 C33E54          10      JP  GETDPB
000019 4019 C33155          10      JP  CHOICE
00001C 401C C33555          10      JP  DSKFMT
00001F 401F C33755          10      JP  DSKSTP
000022 4022 C33855          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C33555          10      JP  DSKFMT
000029 4029 C33755          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3A355          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite"
            204449534B20524F    
            4D204C697465        
000096 4096                         ALIGN   32
0000A0 40A0 76302E372E322E30        DB  "v0.7.2.0"
0000A8 40A8                         ALIGN   32
       40C0                     MSG_ERROR_ROM_MODE:
                                #if exists USE_MORMAL32K_OR_ASCII16
0000C0 40C0 4E6F726D616C2052        DB  "Normal ROM/ASCII-16K only!",13,10
            4F4D2F4153434949    
            2D31364B206F6E6C    
            79210D0A            
                                #else
                                    DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
                                #endif
0001BD 41BD                         ORG 041BDH
0001BD 41BD C9              10      RET
                                
                                    ;MBR_Partition1 (2DDのデータ)
0001BE 41BE 00                      DB  0       ;ブートフラグ
0001BF 41BF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001C2 41C2 01                      DB  1       ;識別子(FAT12)
0001C3 41C3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001C6 41C6 10000000                DW  16,0        ;パーティションの最初のセクタ番号(LBA方式)
0001CA 41CA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                    ;MBR_Partition2 (2DDのデータ)
                                    DB  0       ;ブートフラグ
                                    DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
                                    DB  1       ;識別子(FAT12)
                                    DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
                                    DW  16+1440,0   ;パーティションの最初のセクタ番号(LBA方式)
                                    DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                #endif
                                
0001FE 41FE                         ORG 041FEH
0001FE 41FE 55AA                    DB  055H,0AAH   ;MBR_Sig
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4200                     INIT_ROM:
000200 4200 AF               4      XOR A
000201 4201 2100F3          10      LD  HL,0F300H
000204 4204 0668             7      LD  B,068H
000206 4206 CD454D          17      CALL    FILL_MEMORY
                                
000209 4209 3E01             7      LD  A,1
00020B 420B 3221FB          13      LD  (DRVTBL),A
                                
00020E 420E 2A4AFC          16      LD  HL,(HIMEM)
000211 4211 1180EF          10      LD  DE,NEW_HIMEM
000214 4214 A7               4      AND A
000215 4215 ED52            15      SBC HL,DE
000217 4217 3820            12      JR  C,INIT1
000219 4219 EB               4      EX  DE,HL
00021A 421A 2A74F6          16      LD  HL,(STKTOP)
00021D 421D ED52            15      SBC HL,DE
00021F 421F 2274F6          16      LD  (STKTOP),HL ;起動時の空き容量表示の為
000222 4222 F9               6      LD  SP,HL
000223 4223 2A72F6          16      LD  HL,(MEMSIZ)
000226 4226 ED52            15      SBC HL,DE
000228 4228 2272F6          16      LD  (MEMSIZ),HL
00022B 422B 2A9BF6          16      LD  HL,(FRETOP)
00022E 422E ED52            15      SBC HL,DE
000230 4230 229BF6          16      LD  (FRETOP),HL
000233 4233 2180EF          10      LD  HL,NEW_HIMEM
000236 4236 224AFC          16      LD  (HIMEM),HL
       4239                     INIT1:
000239 4239 AF               4      XOR A
00023A 423A 32EAF2          13      LD  (_DVSW),A
00023D 423D 3D               4      DEC A       ;0FFH
00023E 423E 3299FD          13      LD  (DEVICE),A
                                
                                #if exists _RAM64K
000241 4241 21575D          10      LD  HL,AT_ISC
000244 4244 1180EF          10      LD  DE,ISC
000247 4247 015B01          10      LD  BC,ISC_E-ISC
00024A 424A EDB0                    LDIR
                                #endif
00024C 424C 21B25E          10      LD  HL,AT_ISCB
00024F 424F 1180F2          10      LD  DE,ISCB
000252 4252 018C00          10      LD  BC,ISCB_E-ISCB
000255 4255 EDB0                    LDIR
000257 4257 2AB1F6          16      LD  HL,(SAVSTK)
00025A 425A 224BF3          16      LD  (0F34BH),HL
                                
00025D 425D 3EC3             7      LD  A,0C3H      ;JP
00025F 425F 3243FF          13      LD  (H_GONE),A
000262 4262 327DF3          13      LD  (BDOS),A
000265 4265 326BF3          13      LD  (RAMUSE),A
000268 4268 3268F3          13      LD  (ROMUSE),A
00026B 426B 2180F2          10      LD  HL,REPLACE_COMMAND
00026E 426E 2244FF          16      LD  (H_GONE+1),HL
000271 4271 2131F3          10      LD  HL,H_BDOS
000274 4274 227EF3          16      LD  (BDOS+1),HL
000277 4277 21ABF2          10      LD  HL,RAMUSE1
00027A 427A 226CF3          16      LD  (RAMUSE+1),HL
00027D 427D 21BBF2          10      LD  HL,ROMUSE1
000280 4280 2269F3          16      LD  (ROMUSE+1),HL
                                
000283 4283 3E                      DB  03EH
000284 4284 F7              12      RST 30H
000285 4285 3271FE          13      LD  (H_BINS),A
000288 4288 3276FE          13      LD  (H_BINL),A
00028B 428B 327BFE          13      LD  (H_FILE),A
00028E 428E 3231F3          13      LD  (H_BDOS),A
000291 4291 32A7FF          13      LD  (H_PHYD),A
                                
000294 4294 CD1044          17      CALL    GTSL1_
000297 4297 3297F2          13      LD  (ROM_SLT),A
00029A 429A 32A7F2          13      LD  (ROM_SLT_COPY),A
00029D 429D 3272FE          13      LD  (H_BINS+1),A
0002A0 42A0 3277FE          13      LD  (H_BINL+1),A
0002A3 42A3 327CFE          13      LD  (H_FILE+1),A
0002A6 42A6 3232F3          13      LD  (H_BDOS+1),A
0002A9 42A9 32A8FF          13      LD  (H_PHYD+1),A
0002AC 42AC 3222FB          13      LD  (DRVTBL+1),A
0002AF 42AF 3248F3          13      LD  (MASTERS),A
0002B2 42B2 211A47          10      LD  HL,ROM_LOAD
0002B5 42B5 2273FE          16      LD  (H_BINS+2),HL
0002B8 42B8 21CE48          10      LD  HL,ROM_RUN
0002BB 42BB 2278FE          16      LD  (H_BINL+2),HL
0002BE 42BE 21DC48          10      LD  HL,ROM_FILES
0002C1 42C1 227DFE          16      LD  (H_FILE+2),HL
0002C4 42C4 213656          10      LD  HL,ROM_BDOS
0002C7 42C7 2233F3          16      LD  (H_BDOS+2),HL
0002CA 42CA 219B53          10      LD  HL,DISKIO
0002CD 42CD 22A9FF          16      LD  (H_PHYD+2),HL
                                
0002D0 42D0 3E                      DB  03EH
0002D1 42D1 C9              10      RET
0002D2 42D2 327FFE          13      LD  (H_FILE+4),A
0002D5 42D5 3275FE          13      LD  (H_BINS+4),A
0002D8 42D8 327AFE          13      LD  (H_BINL+4),A
0002DB 42DB 3235F3          13      LD  (H_BDOS+4),A
0002DE 42DE 32DFFD          13      LD  (H_PINL+4),A
0002E1 42E1 32ABFF          13      LD  (H_PHYD+4),A
                                
0002E4 42E4 AF               4      XOR A
                                #if exists USE_MORMAL32K_OR_ASCII16
0002E5 42E5 320060          13      LD  (ASCII16_BANK0_SEL),A       ;似非RAM対策でバンク0を設定
0002E8 42E8 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK0_SEL),A           ;似非RAM対策でバンク0を設定
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0002EB 42EB 3A0060          13      LD  A,(BANK1_ADR)
0002EE 42EE FE41             7      CP  'A'
                                #if exists USE_MORMAL32K_OR_ASCII16
0002F0 42F0 CA0344          10      JP  Z,NOT_BANK_TYPE
0002F3 42F3 3E01             7      LD  A,DISK_BANK
0002F5 42F5 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    JP  NZ,NOT_BANK_TYPE
                                    LD  A,DISK_BANK
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0002F8 42F8 CD3801          17      CALL    RSLREG      ;read primary slot #
0002FB 42FB 07               4      RLCA
0002FC 42FC 07               4      RLCA
0002FD 42FD F5              11      PUSH    AF
0002FE 42FE 1605             7      LD  D,4+1
000300 4300 CD1744          17      CALL    GTSL2_
000303 4303 3244F3          13      LD  (RAMAD3),A
000306 4306 F1              10      POP AF
000307 4307 07               4      RLCA
000308 4308 07               4      RLCA
000309 4309 1603             7      LD  D,2+1
00030B 430B CD1744          17      CALL    GTSL2_
00030E 430E 2680             7      LD  H,080H
000310 4310 CD3444          17      CALL    CHK_RAM
000313 4313 3243F3          13      LD  (RAMAD2),A
       4316                     RAMCHK2:
000316 4316 3A44F3          13      LD  A,(RAMAD3)
000319 4319 2640             7      LD  H,040H
00031B 431B CD3444          17      CALL    CHK_RAM
00031E 431E 3242F3          13      LD  (RAMAD1),A
       4321                     RAMCHK1:
000321 4321 3A44F3          13      LD  A,(RAMAD3)
000324 4324 2600             7      LD  H,00H
000326 4326 CD3444          17      CALL    CHK_RAM
000329 4329 3241F3          13      LD  (RAMAD0),A
       432C                     RAMCHK0:
00032C 432C 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16
00032F 432F 010F00          10      LD  BC,0000FH       ;切り上げ
000332 4332 09              11      ADD HL,BC
000333 4333 7D               4      LD  A,L
                                
000334 4334 0604             7      LD  B,4
       4336                     B_DRIVE1:
000336 4336 CB3C             8      SRL H
000338 4338 1F               4      RRA
000339 4339 10FB            13      DJNZ    B_DRIVE1
                                
00033B 433B C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
00033D 433D 32E9F2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IX,CHGET
                                    CALL    CALSLT_R
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
                                    ;拡張スロットの選択を設定する
000340 4340 3A97F2          13      LD  A,(ROM_SLT)
000343 4343 57               4      LD  D,A
000344 4344 E60C             7      AND 00CH
000346 4346 5F               4      LD  E,A
000347 4347 7A               4      LD  A,D
000348 4348 E603             7      AND 3
00034A 434A 87               4      ADD A,A
00034B 434B 87               4      ADD A,A
00034C 434C 87               4      ADD A,A
00034D 434D 37               4      SCF
00034E 434E 8F               4      ADC A,A
00034F 434F B3               4      OR  E
000350 4350 5F               4      LD  E,A
000351 4351 1600             7      LD  D,0
000353 4353 21C9FC          10      LD  HL,SLTATR
000356 4356 19              11      ADD HL,DE
000357 4357 3660            10      LD  (HL),060H
                                
000359 4359 3E01             7      LD  A,1
00035B 435B CD2154          17      CALL    IS_BPB
00035E 435E 9F               4      SBC A,A
00035F 435F E602             7      AND 2
000361 4361 EE03             7      XOR 3
000363 4363 32F2F2          13      LD  (_LVECTOR),A
                                    ;CTRL+STOPを抑制する
000366 4366 3E01             7      LD  A,1
000368 4368 32B1FB          13      LD  (BASROM),A
                                
00036B 436B 3ACAFF          13      LD  A,(EXTBIO)
00036E 436E FEF7             7      CP  0F7H        ;RST 30H
000370 4370 280A            12      JR  Z,EXTBIO_OK
000372 4372 3E                      DB  03EH
000373 4373 C9              10      RET
000374 4374 21CAFF          10      LD  HL,EXTBIO
000377 4377 061D             7      LD  B,29
000379 4379 CD454D          17      CALL    FILL_MEMORY
       437C                     EXTBIO_OK:
00037C 437C AF               4      XOR A
00037D 437D 3240F3          13      LD  (REBOOT),A
000380 4380 2A48FC          16      LD  HL,(BOTTOM)
000383 4383 110040          10      LD  DE,16384
000386 4386 19              11      ADD HL,DE
000387 4387 DA0044          10      JP  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
00038A 438A 57               4      LD  D,A
00038B 438B 0601             7      LD  B,1
00038D 438D 2100C0          10      LD  HL,FD_BOOT_START
000390 4390 CD9B53          17      CALL    DISKIO
                                
000393 4393 1168F3          10      LD  DE,ROMUSE
000396 4396 2123F3          10      LD  HL,DISKVE
000399 4399 AF               4      XOR A
00039A 439A CD1EC0          17      CALL    FD_BOOT_EXEC
                                #if exists _RAM64K
                                                ;64K版の場合はページ0をRAMに切り替えRAM側にインタースロットコールを入れる
00039D 439D 3A41F3          13      LD  A,(RAMAD0)  ;ページ0をRAMに切り替える
0003A0 43A0 CD095D          17      CALL    ENASLT_00H
                                
0003A3 43A3 AF               4      XOR A
0003A4 43A4 47               4      LD  B,A
0003A5 43A5 67               4      LD  H,A
0003A6 43A6 6F               4      LD  L,A
0003A7 43A7 CD454D          17      CALL    FILL_MEMORY
                                
0003AA 43AA 3EC3             7      LD  A,0C3H      ;JP
                                                ;インタースロットコール
0003AC 43AC 2191F0          10      LD  HL,RDSLT
0003AF 43AF 320C00          13      LD  (_RDSLT),A
0003B2 43B2 220D00          16      LD  (_RDSLT+1),HL
                                
0003B5 43B5 219FF0          10      LD  HL,WRSLT
0003B8 43B8 321400          13      LD  (_WRSLT),A
0003BB 43BB 221500          16      LD  (_WRSLT+1),HL
                                
0003BE 43BE 2151F0          10      LD  HL,CALSLT
0003C1 43C1 321C00          13      LD  (_CALSLT),A
0003C4 43C4 221D00          16      LD  (_CALSLT+1),HL
                                
0003C7 43C7 2180EF          10      LD  HL,ENASLT
0003CA 43CA 322400          13      LD  (_ENASLT),A
0003CD 43CD 222500          16      LD  (_ENASLT+1),HL
                                
0003D0 43D0 2141F0          10      LD  HL,CALLF
0003D3 43D3 323000          13      LD  (_CALLF),A
0003D6 43D6 223100          16      LD  (_CALLF+1),HL
                                                ;割り込み
0003D9 43D9 21ABF0          10      LD  HL,INT38H
0003DC 43DC 323800          13      LD  (00038H),A
0003DF 43DF 223900          16      LD  (00038H+1),HL
                                                ;インタースロットコールの補助
0003E2 43E2 21475D          10      LD  HL,AT_3B
0003E5 43E5 113B00          10      LD  DE,ENASUB
0003E8 43E8 011000          10      LD  BC,AT_3B_E-AT_3B
0003EB 43EB EDB0                    LDIR
                                
0003ED 43ED 2A0D00          16      LD  HL,(_RDSLT+1)
0003F0 43F0 1191F0          10      LD  DE,RDSLT
0003F3 43F3 AF               4      XOR A
0003F4 43F4 ED52            15      SBC HL,DE
0003F6 43F6 1168F3          10      LD  DE,ROMUSE
0003F9 43F9 2123F3          10      LD  HL,DISKVE
0003FC 43FC 37               4      SCF
0003FD 43FD CC1EC0          17      CALL    Z,FD_BOOT_EXEC
                                #endif
       4400                     BOOT1:
000400 4400 C33855          10      JP  BASENT
                                
       4403                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
000403 4403 21C040          10      LD  HL,MSG_ERROR_ROM_MODE
000406 4406 CDD344          17      CALL    MSX
000409 4409 DD219F00        14      LD  IX,CHGET
00040D 440D C3B444          10      JP  CALSLT_R
                                
       4410                     GTSL1_:             ;自分のいるスロットを知る
000410 4410 CD3801          17      CALL    RSLREG      ;read primary slot #
000413 4413 0F               4      RRCA
000414 4414 0F               4      RRCA
000415 4415 1601             7      LD  D,1
       4417                     GTSL2_:
000417 4417 E603             7      AND 3       ;[A]=000000PP
000419 4419 5F               4      LD  E,A     ;[E]=000000PP
00041A 441A 21C1FC          10      LD  HL,EXPTBL
00041D 441D 85               4      ADD A,L     ;桁上りは無い
00041E 441E 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
00041F 441F 7B               4      LD  A,E     ;[A]=000000PP
000420 4420 CB7E            13      BIT 7,(HL)
000422 4422 C8              11      RET Z
000423 4423 7D               4      LD  A,L     ;point to SLTTBL entry
000424 4424 C604             7      ADD A,4     ;桁上りは無い
000426 4426 6F               4      LD  L,A
000427 4427 7E               7      LD  A,(HL)      ;get currently expansion slot register
       4428                     GTSL3_:
000428 4428 15               4      DEC D
000429 4429 2803            12      JR  Z,GTSL4_:
00042B 442B 0F               4      RRCA
00042C 442C 18FA            12      JR  GTSL3_:
       442E                     GTSL4_:
00042E 442E E60C             7      AND 00CH        ;[A] = 0000SS00
000430 4430 B3               4      OR  E       ;[A] = 0000SSPP
000431 4431 F680             7      OR  080H        ;[A] = 1000SSPP
000433 4433 C9              10      RET
                                
       4434                     CHK_RAM:
000434 4434 E5              11      PUSH    HL
000435 4435 CD8B44          17      CALL    CHK_RAM0
000438 4438 E1              10      POP HL
000439 4439 C8              11      RET Z
00043A 443A 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
00043D 443D E680             7      AND 080H
00043F 443F CD6044          17      CALL    CHK_RAM_SLT
000442 4442 C8              11      RET Z
000443 4443 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000446 4446 E680             7      AND 080H
000448 4448 C601             7      ADD A,1
00044A 444A CD6044          17      CALL    CHK_RAM_SLT
00044D 444D C8              11      RET Z
00044E 444E 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000451 4451 E680             7      AND 080H
000453 4453 C602             7      ADD A,2
000455 4455 CD6044          17      CALL    CHK_RAM_SLT
000458 4458 C8              11      RET Z
000459 4459 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
00045C 445C E680             7      AND 080H
00045E 445E C603             7      ADD A,3
       4460                     CHK_RAM_SLT:
000460 4460 E5              11      PUSH    HL
000461 4461 CD8B44          17      CALL    CHK_RAM0        ;スロット#X or X-0
000464 4464 E1              10      POP HL
000465 4465 C8              11      RET Z
000466 4466 CB79             8      BIT 7,C
000468 4468 281C            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
00046A 446A 79               4      LD  A,C
00046B 446B F604             7      OR  4           ;スロット#X-1
00046D 446D E5              11      PUSH    HL
00046E 446E CD8B44          17      CALL    CHK_RAM0
000471 4471 E1              10      POP HL
000472 4472 C8              11      RET Z
000473 4473 79               4      LD  A,C
000474 4474 F60C             7      OR  00CH            ;スロット#X-3
000476 4476 E5              11      PUSH    HL
000477 4477 CD8B44          17      CALL    CHK_RAM0
00047A 447A E1              10      POP HL
00047B 447B C8              11      RET Z
00047C 447C 79               4      LD  A,C
00047D 447D E6F3             7      AND 0F3H            ;スロット#X-3
00047F 447F F608             7      OR  8
000481 4481 E5              11      PUSH    HL
000482 4482 CD8B44          17      CALL    CHK_RAM0
000485 4485 E1              10      POP HL
       4486                     CHK_RAM_E:
000486 4486 AF               4      XOR A
000487 4487 3C               4      INC A           ;ZF=0にする
000488 4488 3E00             7      LD  A,0
00048A 448A C9              10      RET
                                
       448B                     CHK_RAM0:
00048B 448B 4F               4      LD  C,A
00048C 448C 2E00             7      LD  L,0
       448E                     CHK_RAM1:
00048E 448E 79               4      LD  A,C
00048F 448F CD0545          17      CALL    RDSLTX
000492 4492 C6E5             7      ADD A,0E5H
000494 4494 47               4      LD  B,A
000495 4495 5F               4      LD  E,A
000496 4496 79               4      LD  A,C
000497 4497 C5              11      PUSH    BC
000498 4498 CD1400          17      CALL    _WRSLT
00049B 449B C1              10      POP BC
00049C 449C 79               4      LD  A,C
00049D 449D CD0545          17      CALL    RDSLTX
0004A0 44A0 B8               4      CP  B
0004A1 44A1 C0              11      RET NZ
0004A2 44A2 D6E5             7      SUB 0E5H
0004A4 44A4 79               4      LD  A,C
0004A5 44A5 5F               4      LD  E,A
0004A6 44A6 C5              11      PUSH    BC
0004A7 44A7 CD1400          17      CALL    _WRSLT
0004AA 44AA C1              10      POP BC
0004AB 44AB 24               4      INC H
0004AC 44AC 7D               4      LD  A,L
0004AD 44AD C604             7      ADD A,4
0004AF 44AF 6F               4      LD  L,A
0004B0 44B0 20DC            12      JR  NZ,CHK_RAM1
0004B2 44B2 79               4      LD  A,C     ;ZF=1のハズ
0004B3 44B3 C9              10      RET
                                
       44B4                     CALSLT_R:
0004B4 44B4 C5              11      PUSH    BC
0004B5 44B5 E5              11      PUSH    HL
0004B6 44B6 F5              11      PUSH    AF
0004B7 44B7 3A0000          13      LD  A,(0000H)
0004BA 44BA FEF3             7      CP  0F3H        ;0000H が DI の場合はページ0を BIOS ROM とみなす
0004BC 44BC 280B            12      JR  Z,CALSLT_R2
0004BE 44BE F1              10      POP AF
0004BF 44BF FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0004C3 44C3 CD1C00          17      CALL    _CALSLT
0004C6 44C6 E1              10      POP HL
0004C7 44C7 C1              10      POP BC
0004C8 44C8 C9              10      RET
       44C9                     CALSLT_R2:
0004C9 44C9 F1              10      POP AF
0004CA 44CA CD98F3          17      CALL    JP_IX
0004CD 44CD E1              10      POP HL
0004CE 44CE C1              10      POP BC
0004CF 44CF C9              10      RET
                                
       44D0                     MSX1:
0004D0 44D0 CD4F56          17      CALL    MSGA1
       44D3                     MSX:
0004D3 44D3 7E               7      LD  A,(HL)
0004D4 44D4 23               6      INC HL
0004D5 44D5 B7               4      OR  A
0004D6 44D6 20F8            12      JR  NZ,MSX1
0004D8 44D8 C9              10      RET
                                
       44D9                     PRTHX:
0004D9 44D9 F5              11      PUSH    AF
0004DA 44DA 07               4      RLCA
0004DB 44DB 07               4      RLCA
0004DC 44DC 07               4      RLCA
0004DD 44DD 07               4      RLCA
0004DE 44DE CDE244          17      CALL    PRTA2
0004E1 44E1 F1              10      POP AF
       44E2                     PRTA2:
0004E2 44E2 CDE844          17      CALL    ASC
0004E5 44E5 C34B56          10      JP  MSG_A
                                
       44E8                     ASC:
0004E8 44E8 E60F             7      AND 0FH
0004EA 44EA C630             7      ADD A,'0'
0004EC 44EC FE3A             7      CP  '9'+1
0004EE 44EE D8              11      RET C
0004EF 44EF C607             7      ADD A,7
0004F1 44F1 C9              10      RET
                                
       44F2                     MSN:
                                #if exists USE_MORMAL32K_OR_ASCII16
0004F2 44F2 CDFE44          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
0004F5 44F5 23               6      INC HL
0004F6 44F6 CD4B56          17      CALL    MSG_A
0004F9 44F9 10F7            13      DJNZ    MSN
0004FB 44FB C9              10      RET
                                
       44FC                     RDSLT_ROM3:
0004FC 44FC 7E               7      LD  A,(HL)
0004FD 44FD C9              10      RET
       44FE                     RDSLT_ROM:
0004FE 44FE CB7C             8      BIT 7,H
000500 4500 28FA            12      JR  Z,RDSLT_ROM3
       4502                     RDSLT_ROM2:
000502 4502 3A97F2          13      LD  A,(ROM_SLT)
       4505                     RDSLTX:
000505 4505 C5              11      PUSH    BC
000506 4506 D5              11      PUSH    DE
000507 4507 CD0C00          17      CALL    _RDSLT
00050A 450A D1              10      POP DE
00050B 450B C1              10      POP BC
00050C 450C C9              10      RET
                                
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
                                ;
                                ;   ディスクからメモリへの転送
                                ;
       450D                     ROM_LDIR:
00050D 450D 3AD6F2          13      LD  A,(FLG_LDIR)
000510 4510 B7               4      OR  A
000511 4511 2069            12      JR  NZ,ROM_LDIRVM
000513 4513 CB7A             8      BIT 7,D
000515 4515 CAAC45          10      JP  Z,ROM_LDIRSLT
                                ;
                                ;   ページ2/ページ3
                                ;
                                #if exists USE_MORMAL32K_OR_ASCII16
000518 4518 F3               4      DI
000519 4519 ED73FEF2        20      LD  (_SP),SP
00051D 451D 3A0BF3          13      LD  A,(_SP_H)
000520 4520 FEC0             7      CP  0C0H
000522 4522 3003            12      JR  NC,SPJ1
000524 4524 315DF5          10      LD  SP,SPBUF
       4527                     SPJ1:
       4527                     LDIR_PAGE2_1:
000527 4527 78               4      LD  A,B
000528 4528 B1               4      OR  C
000529 4529 284C            12      JR  Z,LDIRE
                                
00052B 452B C5              11      PUSH    BC
00052C 452C D5              11      PUSH    DE
00052D 452D E5              11      PUSH    HL
00052E 452E 3A97F2          13      LD  A,(ROM_SLT)
000531 4531 2680             7      LD  H,080H
000533 4533 CD2400          17      CALL    _ENASLT
000536 4536 E1              10      POP HL
000537 4537 D1              10      POP DE
000538 4538 C1              10      POP BC
       4539                     LDIR_PAGE2_2:
000539 4539 CB72             8      BIT 6,D
00053B 453B 202C            12      JR  NZ,LDIR_PAGE2_4
                                
00053D 453D C5              11      PUSH    BC
00053E 453E D5              11      PUSH    DE
00053F 453F 115EF5          10      LD  DE,BUF
                                
000542 4542 78               4      LD  A,B
000543 4543 B7               4      OR  A
000544 4544 2803            12      JR  Z,LDIR_PAGE2_3
000546 4546 010001          10      LD  BC,00100H       ;B != 0 の場合は256バイトずつ転送
       4549                     LDIR_PAGE2_3:
000549 4549 C5              11      PUSH    BC
00054A 454A EDB0                    LDIR
00054C 454C 22FCF2          16      LD  (_HL),HL
                                
00054F 454F 3A43F3          13      LD  A,(RAMAD2)
000552 4552 2680             7      LD  H,080H
000554 4554 CD2400          17      CALL    _ENASLT
                                
000557 4557 C1              10      POP BC
000558 4558 D1              10      POP DE
000559 4559 215EF5          10      LD  HL,BUF
00055C 455C EDB0                    LDIR
                                
00055E 455E 2AFCF2          16      LD  HL,(_HL)
000561 4561 C1              10      POP BC
000562 4562 78               4      LD  A,B
000563 4563 B7               4      OR  A
000564 4564 2811            12      JR  Z,LDIRE
000566 4566 05               4      DEC B
000567 4567 18BE            12      JR  LDIR_PAGE2_1
       4569                     LDIR_PAGE2_4:               ;ページ3
                                #endif
000569 4569 EDB0                    LDIR
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
       456B                     LDIRE2:
00056B 456B D5              11      PUSH    DE
00056C 456C E5              11      PUSH    HL
00056D 456D 3A43F3          13      LD  A,(RAMAD2)
000570 4570 2680             7      LD  H,080H
000572 4572 CD2400          17      CALL    _ENASLT
000575 4575 E1              10      POP HL
000576 4576 D1              10      POP DE
       4577                     LDIRE:
000577 4577 ED7BFEF2        20      LD  SP,(_SP)
                                #else
                                LDIRE2:
                                #endif
00057B 457B C9              10      RET
                                ;
                                ;   ディスクからV-RAMへの転送
                                ;
       457C                     ROM_LDIRVM:
                                #if exists USE_MORMAL32K_OR_ASCII16
00057C 457C F3               4      DI
00057D 457D ED73FEF2        20      LD  (_SP),SP
000581 4581 3A0BF3          13      LD  A,(_SP_H)
000584 4584 FEC0             7      CP  0C0H
000586 4586 3003            12      JR  NC,SPJ2
000588 4588 315DF5          10      LD  SP,SPBUF
       458B                     SPJ2:
00058B 458B C5              11      PUSH    BC
00058C 458C D5              11      PUSH    DE
00058D 458D E5              11      PUSH    HL
00058E 458E 3A97F2          13      LD  A,(ROM_SLT)
000591 4591 2680             7      LD  H,080H
000593 4593 CD2400          17      CALL    _ENASLT
000596 4596 E1              10      POP HL
000597 4597 D1              10      POP DE
000598 4598 C1              10      POP BC
                                #endif
000599 4599 C5              11      PUSH    BC
00059A 459A D5              11      PUSH    DE
00059B 459B FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00059F 459F DD215C00        14      LD  IX,LDIRVM
0005A3 45A3 CD1C00          17      CALL    _CALSLT
0005A6 45A6 E1              10      POP HL
0005A7 45A7 C1              10      POP BC
0005A8 45A8 09              11      ADD HL,BC
0005A9 45A9 EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
0005AA 45AA 18BF            12      JR  LDIRE2
                                #else
                                    RET
                                #endif
                                ;
                                ;   ページ0/ページ1
                                ;
       45AC                     ROM_LDIRSLT:
                                #if exists USE_MORMAL32K_OR_ASCII16
0005AC 45AC F3               4      DI
0005AD 45AD ED73FEF2        20      LD  (_SP),SP
0005B1 45B1 3A0BF3          13      LD  A,(_SP_H)
0005B4 45B4 FEC0             7      CP  0C0H
0005B6 45B6 3003            12      JR  NC,SPJ3
0005B8 45B8 315DF5          10      LD  SP,SPBUF
       45BB                     SPJ3:
0005BB 45BB C5              11      PUSH    BC
0005BC 45BC D5              11      PUSH    DE
0005BD 45BD E5              11      PUSH    HL
0005BE 45BE 3A97F2          13      LD  A,(ROM_SLT)
0005C1 45C1 2680             7      LD  H,080H
0005C3 45C3 CD2400          17      CALL    _ENASLT
0005C6 45C6 E1              10      POP HL
0005C7 45C7 D1              10      POP DE
0005C8 45C8 C1              10      POP BC
                                #endif
                                                ;ページ0
0005C9 45C9 3A0000          13      LD  A,(0000H)
0005CC 45CC FEF3             7      CP  0F3H        ;0000H が DI じゃない場合はページ0は RAM とみなす
0005CE 45CE 280C            12      JR  Z,LDIR_PAGE0_SLT
       45D0                     LDIR_PAGE0_1:
0005D0 45D0 CB72             8      BIT 6,D
0005D2 45D2 2026            12      JR  NZ,LDIR_PAGE1
0005D4 45D4 EDA0            16      LDI         ;ページ0 直接転送
0005D6 45D6 EAD045          10      JP  PE,LDIR_PAGE0_1
                                #if exists USE_MORMAL32K_OR_ASCII16
0005D9 45D9 C36B45          10      JP  LDIRE2
                                #else
                                    RET
                                #endif
                                
       45DC                     LDIR_PAGE0_SLT:     ;ページ0 WRSLTを使用
0005DC 45DC EB               4      EX  DE,HL       ;転送方向(DE)→(HL)
       45DD                     LDIR_PAGE0_SLT1:
0005DD 45DD CB74             8      BIT 6,H
0005DF 45DF 2018            12      JR  NZ,LDIR_PAGE1_DEHL
0005E1 45E1 1A               7      LD  A,(DE)
0005E2 45E2 13               6      INC DE
0005E3 45E3 D5              11      PUSH    DE
0005E4 45E4 5F               4      LD  E,A
0005E5 45E5 E5              11      PUSH    HL
0005E6 45E6 C5              11      PUSH    BC
0005E7 45E7 3A41F3          13      LD  A,(RAMAD0)
0005EA 45EA CD1400          17      CALL    _WRSLT
0005ED 45ED C1              10      POP BC
0005EE 45EE E1              10      POP HL
0005EF 45EF D1              10      POP DE
0005F0 45F0 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0005F2 45F2 EADD45          10      JP  PE,LDIR_PAGE0_SLT1
0005F5 45F5 EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
                                #if exists USE_MORMAL32K_OR_ASCII16
0005F6 45F6 C36B45          10      JP  LDIRE2
                                #else
                                    RET
                                #endif
                                
                                #if exists _RAM64K
       45F9                     LDIR_PAGE1_DEHL:
0005F9 45F9 EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
       45FA                     LDIR_PAGE1:         ;ページ1
0005FA 45FA 78               4      LD  A,B
0005FB 45FB B1               4      OR  C
0005FC 45FC CA6B45          10      JP  Z,LDIRE2
                                
0005FF 45FF 7A               4      LD  A,D
000600 4600 FE7F             7      CP  07FH        ;ページ2と被る可能性？($7FXX)
000602 4602 380F            12      JR  C,LDIR_PAGE1_2
000604 4604 87               4      ADD A,A
000605 4605 DA2745          10      JP  C,LDIR_PAGE2_1  ;ページ2へ
000608 4608 78               4      LD  A,B
000609 4609 B7               4      OR  A
00060A 460A 7B               4      LD  A,E
00060B 460B 2803            12      JR  Z,LDIR_PAGE1_1
00060D 460D B7               4      OR  A           ;B != 0 の場合は256バイト転送
00060E 460E 2027            12      JR  NZ,LDIR_PAGE1_SLT_HLDE  ;被る
       4610                     LDIR_PAGE1_1:
000610 4610 81               4      ADD A,C
000611 4611 3824            12      JR  C,LDIR_PAGE1_SLT_HLDE   ;被る
       4613                     LDIR_PAGE1_2:
000613 4613 C5              11      PUSH    BC
000614 4614 D5              11      PUSH    DE
000615 4615 115EF5          10      LD  DE,BUF
                                
000618 4618 78               4      LD  A,B
000619 4619 B7               4      OR  A
00061A 461A 2803            12      JR  Z,LDIR_PAGE1_3
00061C 461C 010001          10      LD  BC,00100H       ;B != 0 の場合は256バイトずつ転送
       461F                     LDIR_PAGE1_3:
00061F 461F C5              11      PUSH    BC
000620 4620 EDB0                    LDIR
000622 4622 22FCF2          16      LD  (_HL),HL
                                
000625 4625 3A42F3          13      LD  A,(RAMAD1)
000628 4628 C3CBF0          10      JP  LDIR_PAGE1_RAM      ;ページ1をRAMにする処理はページ3にある
       462B                     LDIR_PAGE1_ROM:
00062B 462B 2AFCF2          16      LD  HL,(_HL)
00062E 462E C1              10      POP BC
00062F 462F 78               4      LD  A,B
000630 4630 B7               4      OR  A
000631 4631 CA6B45          10      JP  Z,LDIRE2
000634 4634 05               4      DEC B
000635 4635 18C3            12      JR  LDIR_PAGE1
                                
       4637                     LDIR_PAGE1_SLT_HLDE:
000637 4637 EB               4      EX  DE,HL       ;転送方向(DE)→(HL)
                                #else
                                LDIR_PAGE1:         ;ページ1 WRSLTを使用
                                LDIR_PAGE1_HLDE:
                                    EX  DE,HL       ;転送方向(DE)→(HL)
                                LDIR_PAGE1_DEHL:
                                #endif
       4638                     LDIR_PAGE1_SLT1:
000638 4638 CB7C             8      BIT 7,H
00063A 463A 2018            12      JR  NZ,LDIR_PAGE2_HLDE
00063C 463C 1A               7      LD  A,(DE)
00063D 463D 13               6      INC DE
00063E 463E D5              11      PUSH    DE
00063F 463F 5F               4      LD  E,A
000640 4640 E5              11      PUSH    HL
000641 4641 C5              11      PUSH    BC
000642 4642 3A42F3          13      LD  A,(RAMAD1)
000645 4645 CD1400          17      CALL    _WRSLT
000648 4648 C1              10      POP BC
000649 4649 E1              10      POP HL
00064A 464A D1              10      POP DE
00064B 464B EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00064D 464D EA3846          10      JP  PE,LDIR_PAGE1_SLT1
000650 4650 EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
                                #if exists USE_MORMAL32K_OR_ASCII16
000651 4651 C36B45          10      JP  LDIRE2
       4654                     LDIR_PAGE2_HLDE:            ;ページ2
000654 4654 EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
000655 4655 C32745          10      JP  LDIR_PAGE2_1
                                #else
                                    RET
                                LDIR_PAGE2_HLDE:            ;ページ2
                                    EX  DE,HL       ;転送方向(HL)→(DE)
                                LDIR_PAGE2_1:
                                    LDIR
                                    RET
                                #endif
                                ;
                                ;   BASIC関連
                                ;
       4658                     END_OF_LINE:
000658 4658 215EF5          10      LD  HL,BUF
       465B                     EOL1:
00065B 465B 7E               7      LD  A,(HL)
00065C 465C C8              11      RET Z
00065D 465D FE0D             7      CP  00DH
00065F 465F 2807            12      JR  Z,EOLE
000661 4661 FE0A             7      CP  00AH
000663 4663 2803            12      JR  Z,EOLE
000665 4665 23               6      INC HL
000666 4666 18F3            12      JR  EOL1
       4668                     EOLE:
000668 4668 3600            10      LD  (HL),0
00066A 466A 23               6      INC HL
00066B 466B 7E               7      LD  A,(HL)
00066C 466C FE0A             7      CP  00AH
00066E 466E C0              11      RET NZ
00066F 466F 23               6      INC HL
000670 4670 C9              10      RET
                                ;
                                ;   アスキー形式のファイルを読み込む
                                ;
       4671                     ROM_LOAD_ASCII:
000671 4671 210000          10      LD  HL,0
000674 4674 22DAF2          16      LD  (_BUF_ST),HL    ;読み出し位置
000677 4677 2A76F6          16      LD  HL,(TXTTAB)
00067A 467A 22DCF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
00067D 467D 215EF5          10      LD  HL,BUF
000680 4680 22D4F2          16      LD  (_DTA),HL
       4683                     RLOAD_A1:
000683 4683 2ADAF2          16      LD  HL,(_BUF_ST)
000686 4686 22CAF2          16      LD  (RR_LOW),HL
000689 4689 210201          10      LD  HL,258
00068C 468C CDA14B          17      CALL    ROM_READ
00068F 468F 7C               4      LD  A,H
000690 4690 B5               4      OR  L
000691 4691 2879            12      JR  Z,RLOAD_AEND
000693 4693 015EF5          10      LD  BC,BUF
000696 4696 09              11      ADD HL,BC
000697 4697 3600            10      LD  (HL),0
000699 4699 CD5846          17      CALL    END_OF_LINE
00069C 469C 015EF5          10      LD  BC,BUF
00069F 469F A7               4      AND A
0006A0 46A0 ED42            15      SBC HL,BC
0006A2 46A2 2810            12      JR  Z,RLOAD_A2
0006A4 46A4 4D               4      LD  C,L
0006A5 46A5 44               4      LD  B,H
0006A6 46A6 ED5BDAF2        20      LD  DE,(_BUF_ST)
0006AA 46AA 19              11      ADD HL,DE
0006AB 46AB 22DAF2          16      LD  (_BUF_ST),HL
0006AE 46AE 3A5EF5          13      LD  A,(BUF)
0006B1 46B1 B7               4      OR  A
0006B2 46B2 28CF            12      JR  Z,RLOAD_A1
       46B4                     RLOAD_A2:
0006B4 46B4 115EF5          10      LD  DE,BUF
0006B7 46B7 CD804D          17      CALL    SPCUTEX
0006BA 46BA 1A               7      LD  A,(DE)
0006BB 46BB B7               4      OR  A
0006BC 46BC 284E            12      JR  Z,RLOAD_AEND
0006BE 46BE CD924D          17      CALL    GETNUM
0006C1 46C1 7C               4      LD  A,H
0006C2 46C2 B5               4      OR  L
0006C3 46C3 CAE347          10      JP  Z,ERROR_DIRECT_IN_FILE
0006C6 46C6 DD2ADCF2        20      LD  IX,(_BUF_EN)
0006CA 46CA DD7502          19      LD  (IX+2),L
0006CD 46CD DD7403          19      LD  (IX+3),H
                                
0006D0 46D0 CD794D          17      CALL    SPCUT
0006D3 46D3 EB               4      EX  DE,HL
0006D4 46D4 DDE5            15      PUSH    IX
0006D6 46D6 DD21B242        14      LD  IX,CRUNCH
0006DA 46DA FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0006DE 46DE CD1C00          17      CALL    _CALSLT
0006E1 46E1 DDE1            14      POP IX
0006E3 46E3 EB               4      EX  DE,HL
0006E4 46E4 111FF4          10      LD  DE,KBUF
0006E7 46E7 37               4      SCF
0006E8 46E8 ED52            15      SBC HL,DE
0006EA 46EA CAE347          10      JP  Z,ERROR_DIRECT_IN_FILE
0006ED 46ED DAE347          10      JP  C,ERROR_DIRECT_IN_FILE
0006F0 46F0 4D               4      LD  C,L
0006F1 46F1 44               4      LD  B,H
0006F2 46F2 2ADCF2          16      LD  HL,(_BUF_EN)
0006F5 46F5 110400          10      LD  DE,4
0006F8 46F8 19              11      ADD HL,DE
0006F9 46F9 111FF4          10      LD  DE,KBUF
                                
0006FC 46FC EB               4      EX  DE,HL
0006FD 46FD EDB0                    LDIR
0006FF 46FF EB               4      EX  DE,HL
                                
000700 4700 DD7500          19      LD  (IX+0),L
000703 4703 DD7401          19      LD  (IX+1),H
000706 4706 22DCF2          16      LD  (_BUF_EN),HL
000709 4709 C38346          10      JP  RLOAD_A1
                                
       470C                     RLOAD_AEND:
00070C 470C 2ADCF2          16      LD  HL,(_BUF_EN)
00070F 470F AF               4      XOR A
000710 4710 77               7      LD  (HL),A
000711 4711 23               6      INC HL
000712 4712 77               7      LD  (HL),A
000713 4713 23               6      INC HL
000714 4714 22DCF2          16      LD  (_BUF_EN),HL
000717 4717 C3A647          10      JP  RLOAD_END1
                                
       471A                     ROM_LOAD:
00071A 471A CD4C49          17      CALL    INIT_PARAM
00071D 471D 7E               7      LD  A,(HL)
00071E 471E FE2C             7      CP  ','
000720 4720 2003            12      JR  NZ,ROM_LOAD0
000722 4722 23               6      INC HL
000723 4723 7E               7      LD  A,(HL)
000724 4724 2B               6      DEC HL
       4725                     ROM_LOAD0:
000725 4725 32BEFC          13      LD  (RUNBNF),A
000728 4728 CD424C          17      CALL    FILE_B
00072B 472B 3A01F3          13      LD  A,(FNAME)
00072E 472E FE20             7      CP  020H
000730 4730 CA3D4C          10      JP  Z,ROM_ORG
                                
000733 4733 CDE94D          17      CALL    ROM_OPEN
000736 4736 DAEF47          10      JP  C,ERROR_FILE_NOT_FOUND
       4739                     ROM_LOAD1:
000739 4739 21D9F2          10      LD  HL,_BUF
00073C 473C 22D4F2          16      LD  (_DTA),HL
00073F 473F 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
000742 4742 CDA14B          17      CALL    ROM_READ
000745 4745 3AD9F2          13      LD  A,(_BUF)
000748 4748 3C               4      INC A
000749 4749 C27146          10      JP  NZ,ROM_LOAD_ASCII
00074C 474C 2A76F6          16      LD  HL,(TXTTAB)
00074F 474F 22D4F2          16      LD  (_DTA),HL
000752 4752 EB               4      EX  DE,HL
000753 4753 2100FF          10      LD  HL,-256
000756 4756 39              11      ADD HL,SP
000757 4757 ED52            15      SBC HL,DE
000759 4759 CDA14B          17      CALL    ROM_READ
00075C 475C ED5BD4F2        20      LD  DE,(_DTA)
000760 4760 19              11      ADD HL,DE
000761 4761 E5              11      PUSH    HL
000762 4762 2A76F6          16      LD  HL,(TXTTAB)
       4765                     ROM_LOAD2:          ;リンクポインタをFIX
000765 4765 E5              11      PUSH    HL
000766 4766 DDE1            14      POP IX
000768 4768 7E               7      LD  A,(HL)      ;リンクポインタL
000769 4769 23               6      INC HL
00076A 476A B6               7      OR  (HL)        ;リンクポインタH
00076B 476B 23               6      INC HL
00076C 476C 2837            12      JR  Z,RLOAD_END0
00076E 476E 23               6      INC HL      ;行番号
00076F 476F 23               6      INC HL      ;行番号
       4770                     ROM_LOAD3:
000770 4770 7E               7      LD  A,(HL)
000771 4771 23               6      INC HL
000772 4772 FE0B             7      CP  00BH        ;8進数(&O)
000774 4774 2822            12      JR  Z,INC_HL2
000776 4776 FE0C             7      CP  00CH        ;16進数(&H)
000778 4778 281E            12      JR  Z,INC_HL2
00077A 477A FE0D             7      CP  00DH        ;行番号(RUN後)
00077C 477C 281A            12      JR  Z,INC_HL2
00077E 477E FE0E             7      CP  00EH        ;行番号(RUN前)
000780 4780 2816            12      JR  Z,INC_HL2
000782 4782 FE0F             7      CP  00FH        ;10～255の整数(%)
000784 4784 2813            12      JR  Z,INC_HL1
000786 4786 FE1C             7      CP  01CH        ;256～65535の整数(%)
000788 4788 280E            12      JR  Z,INC_HL2
00078A 478A FE1D             7      CP  01DH        ;単精度実数(!)
00078C 478C 2808            12      JR  Z,INC_HL4
00078E 478E FE1F             7      CP  01FH        ;倍制度実数(#)
000790 4790 2008            12      JR  NZ,INC_HL0
000792 4792 23               6      INC HL
000793 4793 23               6      INC HL
000794 4794 23               6      INC HL
000795 4795 23               6      INC HL
       4796                     INC_HL4:
000796 4796 23               6      INC HL
000797 4797 23               6      INC HL
       4798                     INC_HL2:
000798 4798 23               6      INC HL
       4799                     INC_HL1:
000799 4799 23               6      INC HL
       479A                     INC_HL0:
00079A 479A B7               4      OR  A
00079B 479B 20D3            12      JR  NZ,ROM_LOAD3
00079D 479D DD7500          19      LD  (IX+0),L
0007A0 47A0 DD7401          19      LD  (IX+1),H
0007A3 47A3 18C0            12      JR  ROM_LOAD2
       47A5                     RLOAD_END0:
0007A5 47A5 E1              10      POP HL
       47A6                     RLOAD_END1:
0007A6 47A6 22C2F6          16      LD  (VARTAB),HL
0007A9 47A9 22C4F6          16      LD  (ARYTAB),HL
0007AC 47AC 22C6F6          16      LD  (STREND),HL
                                
0007AF 47AF 3ABEFC          13      LD  A,(RUNBNF)
0007B2 47B2 CDD34D          17      CALL    CAP
0007B5 47B5 FE52             7      CP  'R'
0007B7 47B7 280E            12      JR  Z,RLOAD_END2
0007B9 47B9 AF               4      XOR A
0007BA 47BA 21DCF2          10      LD  HL,_BUF+3
0007BD 47BD 77               7      LD  (HL),A      ;3
0007BE 47BE 2B               6      DEC HL
0007BF 47BF 77               7      LD  (HL),A      ;2
0007C0 47C0 2B               6      DEC HL
0007C1 47C1 77               7      LD  (HL),A      ;1
0007C2 47C2 2B               6      DEC HL
0007C3 47C3 3E8F             7      LD  A,08FH      ;REM
0007C5 47C5 77               7      LD  (HL),A      ;0
0007C6 47C6 C9              10      RET
       47C7                     RLOAD_END2:
0007C7 47C7 D5              11      PUSH    DE
0007C8 47C8 ED5B76F6        20      LD  DE,(TXTTAB)
0007CC 47CC 1B               6      DEC DE
0007CD 47CD AF               4      XOR A
0007CE 47CE 21DFF2          10      LD  HL,_BUF+6
0007D1 47D1 77               7      LD  (HL),A      ;6
0007D2 47D2 2B               6      DEC HL
0007D3 47D3 77               7      LD  (HL),A      ;5
0007D4 47D4 2B               6      DEC HL
0007D5 47D5 77               7      LD  (HL),A      ;4
0007D6 47D6 2B               6      DEC HL
0007D7 47D7 72               7      LD  (HL),D      ;3 行番号H
0007D8 47D8 2B               6      DEC HL
0007D9 47D9 73               7      LD  (HL),E      ;2 行番号L
0007DA 47DA 2B               6      DEC HL
0007DB 47DB 360D            10      LD  (HL),00DH   ;1 行番号(RUN後)
0007DD 47DD 2B               6      DEC HL
0007DE 47DE 3E89             7      LD  A,089H      ;GOTO
0007E0 47E0 77               7      LD  (HL),A      ;0
0007E1 47E1 D1              10      POP DE
0007E2 47E2 C9              10      RET
                                
       47E3                     ERROR_DIRECT_IN_FILE:
0007E3 47E3 1E39             7      LD  E,57            ;Direct statement in file
0007E5 47E5 01                      DB  1           ;LD BC,
       47E6                     ERROR_DEVICE_IO_ERROR:
0007E6 47E6 1E13             7      LD  E,19            ;Device I/O error
0007E8 47E8 01                      DB  1           ;LD BC,
       47E9                     ERROR_INTERNAL_ERROR:
0007E9 47E9 1E33             7      LD  E,51            ;Internal error
0007EB 47EB 01                      DB  1           ;LD BC,
       47EC                     ERROR_FILE_NOT_OPEN:
0007EC 47EC 1E3B             7      LD  E,59            ;File not OPEN
0007EE 47EE 01                      DB  1           ;LD BC,
       47EF                     ERROR_FILE_NOT_FOUND:
0007EF 47EF 1E35             7      LD  E,53            ;File not found
       47F1                     ERROR:
0007F1 47F1 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0007F5 47F5 DD216F40        14      LD  IX,ERRHAND
0007F9 47F9 C31C00          10      JP  _CALSLT
                                
       47FC                     ROM_BLOAD:
0007FC 47FC CD4C49          17      CALL    INIT_PARAM
0007FF 47FF CD424C          17      CALL    FILE_B
000802 4802 CDE94D          17      CALL    ROM_OPEN
000805 4805 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000807 4807 21D9F2          10      LD  HL,_BUF
00080A 480A 22D4F2          16      LD  (_DTA),HL
00080D 480D 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
000810 4810 CDA14B          17      CALL    ROM_READ
000813 4813 3AD9F2          13      LD  A,(_BUF)
000816 4816 FEFE             7      CP  0FEH
000818 4818 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
00081A 481A 21A5F2          10      LD  HL,BLOAD_RET
00081D 481D 229DF2          16      LD  (SWC_BLOAD),HL
                                
000820 4820 2AF7F2          16      LD  HL,(PARAM1)
000823 4823 7E               7      LD  A,(HL)
000824 4824 FE2C             7      CP  ','
000826 4826 204C            12      JR  NZ,RBREAD_MEM
000828 4828 23               6      INC HL
000829 4829 7E               7      LD  A,(HL)
00082A 482A CDD34D          17      CALL    CAP
00082D 482D 32BEFC          13      LD  (RUNBNF),A
000830 4830 FE52             7      CP  'R'     ;R,Sスイッチじゃ無い場合はオフセット値として処理する
000832 4832 2808            12      JR  Z,RBOS1
000834 4834 FE53             7      CP  'S'
000836 4836 2804            12      JR  Z,RBOS1
000838 4838 FE2C             7      CP  ','
00083A 483A 200D            12      JR  NZ,RBOS2
       483C                     RBOS1:
00083C 483C 7E               7      LD  A,(HL)
00083D 483D 23               6      INC HL
00083E 483E B7               4      OR  A
00083F 483F 2824            12      JR  Z,RBREAD_OSE
000841 4841 FE3A             7      CP  ':'
000843 4843 2820            12      JR  Z,RBREAD_OSE
000845 4845 FE2C             7      CP  ','     ;次のパラメータを探す
000847 4847 20F3            12      JR  NZ,RBOS1
       4849                     RBOS2:              ;オフセット
000849 4849 22F7F2          16      LD  (PARAM1),HL
00084C 484C 7E               7      LD  A,(HL)
00084D 484D B7               4      OR  A
00084E 484E 2815            12      JR  Z,RBREAD_OSE
000850 4850 DD212F54        14      LD  IX,FRMQNT
000854 4854 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000858 4858 CD1C00          17      CALL    _CALSLT
00085B 485B 22F7F2          16      LD  (PARAM1),HL
00085E 485E 2ADAF2          16      LD  HL,(_BUF_ST)
000861 4861 19              11      ADD HL,DE
000862 4862 22DAF2          16      LD  (_BUF_ST),HL
       4865                     RBREAD_OSE:
000865 4865 3ABEFC          13      LD  A,(RUNBNF)
000868 4868 FE53             7      CP  'S'
00086A 486A 2008            12      JR  NZ,RBREAD_MEM
00086C 486C CD2F4B          17      CALL    WAIT_VDP
00086F 486F 3E01             7      LD  A,1
000871 4871 32D6F2          13      LD  (FLG_LDIR),A
       4874                     RBREAD_MEM:
000874 4874 2ADAF2          16      LD  HL,(_BUF_ST)
000877 4877 22BFFC          16      LD  (SAVENT),HL
00087A 487A 22D4F2          16      LD  (_DTA),HL
00087D 487D 21FFFF          10      LD  HL,0FFFFH
000880 4880 CDA14B          17      CALL    ROM_READ
000883 4883 AF               4      XOR A
000884 4884 32D6F2          13      LD  (FLG_LDIR),A
000887 4887 3ABEFC          13      LD  A,(RUNBNF)
00088A 488A FE52             7      CP  'R'
00088C 488C 2006            12      JR  NZ,RBREAD1
00088E 488E 2ADEF2          16      LD  HL,(_BUF_EX)
000891 4891 229DF2          16      LD  (SWC_BLOAD),HL
       4894                     RBREAD1:
       4894                     ROM_NEXT:
000894 4894 2AF7F2          16      LD  HL,(PARAM1)
000897 4897 7E               7      LD  A,(HL)
000898 4898 2B               6      DEC HL
000899 4899 B7               4      OR  A
00089A 489A 2805            12      JR  Z,ROM_NEXT1
00089C 489C FE3A             7      CP  ':'
00089E 489E 2801            12      JR  Z,ROM_NEXT1
0008A0 48A0 23               6      INC HL
       48A1                     ROM_NEXT1:
0008A1 48A1 5D               4      LD  E,L
0008A2 48A2 54               4      LD  D,H
                                
0008A3 48A3 CDA94D          17      CALL    SEARCH_END
0008A6 48A6 B7               4      OR  A
0008A7 48A7 2821            12      JR  Z,REM
       48A9                     RN3:                    ;マルチステートメントの処理
0008A9 48A9 7E               7      LD  A,(HL)
                                
0008AA 48AA FEB5             7      CP  0B5H            ;LOAD
0008AC 48AC CA1A47          10      JP  Z,ROM_LOAD
0008AF 48AF FE8A             7      CP  08AH            ;RUN
0008B1 48B1 281B            12      JR  Z,ROM_RUN
0008B3 48B3 FEB7             7      CP  0B7H            ;FILES
0008B5 48B5 2825            12      JR  Z,ROM_FILES
0008B7 48B7 FED6             7      CP  0D6H            ;COPY
0008B9 48B9 CA8149          10      JP  Z,ROM_COPY
0008BC 48BC FE20             7      CP  020H
0008BE 48BE 2807            12      JR  Z,RN_SP
                                
0008C0 48C0 3E28             7      LD  A,028H          ;JR Z,
0008C2 48C2 32A3F2          13      LD  (SWC_BLOAD_M),A
0008C5 48C5 7E               7      LD  A,(HL)
0008C6 48C6 C9              10      RET
       48C7                     RN_SP:
0008C7 48C7 23               6      INC HL
0008C8 48C8 18DF            12      JR  RN3
                                
       48CA                     REM:
0008CA 48CA EB               4      EX  DE,HL
0008CB 48CB 3E8F             7      LD  A,08FH          ;REM
0008CD 48CD C9              10      RET
                                
       48CE                     ROM_RUN:
0008CE 48CE 23               6      INC HL
0008CF 48CF 7E               7      LD  A,(HL)
0008D0 48D0 2B               6      DEC HL
0008D1 48D1 B7               4      OR  A
0008D2 48D2 C41A47          17      CALL    NZ,ROM_LOAD
0008D5 48D5 FE8F             7      CP  08FH            ;REM
0008D7 48D7 3E8A             7      LD  A,08AH          ;RUN
0008D9 48D9 C0              11      RET NZ
0008DA 48DA 77               7      LD  (HL),A
0008DB 48DB C9              10      RET
                                
       48DC                     ROM_FILES:
0008DC 48DC CD4C49          17      CALL    INIT_PARAM
0008DF 48DF CD424C          17      CALL    FILE_B
0008E2 48E2 CDDA55          17      CALL    GET_DISK_BANK_FDRV
0008E5 48E5 3AC9F2          13      LD  A,(SECSZ_H)
0008E8 48E8 CD3354          17      CALL    IS_BPB1
0008EB 48EB DAE647          10      JP  C,ERROR_DEVICE_IO_ERROR
0008EE 48EE 3A01F3          13      LD  A,(FNAME)
0008F1 48F1 FE21             7      CP  021H
0008F3 48F3 3005            12      JR  NC,RFILES0
0008F5 48F5 060B             7      LD  B,11
0008F7 48F7 CD394D          17      CALL    FILE10
       48FA                     RFILES0:
0008FA 48FA CDAC50          17      CALL    GET_DIR_DAT
       48FD                     RFILES1:
0008FD 48FD CD5D4E          17      CALL    FILESE
000900 4900 3045            12      JR  NC,RFILES_NOT_MATCH
       4902                     RFILES_DISP:
000902 4902 E5              11      PUSH    HL
000903 4903 110B00          10      LD  DE,0000BH   ;属性
000906 4906 19              11      ADD HL,DE
                                #if exists USE_MORMAL32K_OR_ASCII16
000907 4907 CDFE44          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
00090A 490A E1              10      POP HL
00090B 490B CB4F             8      BIT 1,A     ;不可視属性
00090D 490D 2035            12      JR  NZ,RFILES_NEXT
00090F 490F E5              11      PUSH    HL
000910 4910 0608             7      LD  B,8
000912 4912 CDF244          17      CALL    MSN
                                #if exists USE_MORMAL32K_OR_ASCII16
000915 4915 CDFE44          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000918 4918 FE20             7      CP  020H
00091A 491A F5              11      PUSH    AF
00091B 491B 3E2E             7      LD  A,'.'
00091D 491D C44B56          17      CALL    NZ,MSG_A
000920 4920 0603             7      LD  B,3
000922 4922 CDF244          17      CALL    MSN
000925 4925 F1              10      POP AF
000926 4926 CC4B56          17      CALL    Z,MSG_A
000929 4929 3ADDF3          13      LD  A,(CSRX)
00092C 492C 47               4      LD  B,A
00092D 492D 3AB0F3          13      LD  A,(LINLEN)
000930 4930 90               4      SUB B
000931 4931 FE0C             7      CP  12
000933 4933 3009            12      JR  NC,RFILES2
000935 4935 3E0D             7      LD  A,00DH      ;改行
000937 4937 CD4B56          17      CALL    MSG_A
00093A 493A 3E0A             7      LD  A,00AH
00093C 493C 1802            12      JR  RFILES3
       493E                     RFILES2:
00093E 493E 3E20             7      LD  A,020H
       4940                     RFILES3:
000940 4940 CD4B56          17      CALL    MSG_A
000943 4943 E1              10      POP HL
       4944                     RFILES_NEXT:
000944 4944 CD7B4E          17      CALL    FNEXT
       4947                     RFILES_NOT_MATCH:
000947 4947 20B4            12      JR  NZ,RFILES1
000949 4949 C39448          10      JP  ROM_NEXT
                                
       494C                     INIT_PARAM:
00094C 494C 22F5F2          16      LD  (PARAM0),HL
00094F 494F 22F7F2          16      LD  (PARAM1),HL
000952 4952 EB               4      EX  DE,HL
000953 4953 32BEFC          13      LD  (RUNBNF),A
000956 4956 3263F6          13      LD  (VALTYP),A
000959 4959 E5              11      PUSH    HL
00095A 495A 3AEAF2          13      LD  A,(_DVSW)
00095D 495D CDBC55          17      CALL    GET_CD
000960 4960 22F9F2          16      LD  (_CDX),HL
000963 4963 E1              10      POP HL
000964 4964 13               6      INC DE
000965 4965 CD794D          17      CALL    SPCUT
000968 4968 1A               7      LD  A,(DE)
000969 4969 B7               4      OR  A
00096A 496A C8              11      RET Z
00096B 496B FE3A             7      CP  ':'
00096D 496D C8              11      RET Z
00096E 496E FE28             7      CP  '('
000970 4970 C8              11      RET Z
000971 4971 EB               4      EX  DE,HL
000972 4972 DD21644C        14      LD  IX,FRMEVL
000976 4976 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00097A 497A CD1C00          17      CALL    _CALSLT
00097D 497D 22F7F2          16      LD  (PARAM1),HL
000980 4980 C9              10      RET
                                
       4981                     ROM_COPY:
000981 4981 CD4C49          17      CALL    INIT_PARAM
000984 4984 3A63F6          13      LD  A,(VALTYP)
000987 4987 FE03             7      CP  3       ;string
000989 4989 C23D4C          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
00098C 498C CD424C          17      CALL    FILE_B
00098F 498F CDE94D          17      CALL    ROM_OPEN
000992 4992 DAEF47          10      JP  C,ERROR_FILE_NOT_FOUND
                                
000995 4995 21DEF2          10      LD  HL,_BUF_W
000998 4998 22D4F2          16      LD  (_DTA),HL
00099B 499B 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
00099E 499E CDA14B          17      CALL    ROM_READ
                                
0009A1 49A1 AF               4      XOR A
0009A2 49A2 32D9F2          13      LD  (_BUF_LO),A     ;PSET
0009A5 49A5 32E6F2          13      LD  (_BUF_O),A      ;向き
                                
0009A8 49A8 2AF7F2          16      LD  HL,(PARAM1)
       49AB                     RCP_PARAM1:
0009AB 49AB 7E               7      LD  A,(HL)
0009AC 49AC 23               6      INC HL
0009AD 49AD B7               4      OR  A
0009AE 49AE CAA148          10      JP  Z,ROM_NEXT1
0009B1 49B1 FE3A             7      CP  ':'
0009B3 49B3 CAA148          10      JP  Z,ROM_NEXT1
0009B6 49B6 FE2C             7      CP  ','
0009B8 49B8 2012            12      JR  NZ,RCP_PARAM1_
                                
0009BA 49BA DD212F54        14      LD  IX,FRMQNT
0009BE 49BE FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009C2 49C2 CD1C00          17      CALL    _CALSLT
0009C5 49C5 7B               4      LD  A,E
0009C6 49C6 87               4      ADD A,A
0009C7 49C7 87               4      ADD A,A
0009C8 49C8 32E6F2          13      LD  (_BUF_O),A
0009CB 49CB 7E               7      LD  A,(HL)
       49CC                     RCP_PARAM1_:
0009CC 49CC FE28             7      CP  '('
0009CE 49CE 20DB            12      JR  NZ,RCP_PARAM1
0009D0 49D0 DD212F54        14      LD  IX,FRMQNT
0009D4 49D4 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009D8 49D8 CD1C00          17      CALL    _CALSLT
                                
0009DB 49DB ED53E2F2        20      LD  (_BUF_X),DE
                                
       49DF                     RCP_PARAM2:
0009DF 49DF 23               6      INC HL
0009E0 49E0 7E               7      LD  A,(HL)
0009E1 49E1 FE20             7      CP  020H
0009E3 49E3 28FA            12      JR  Z,RCP_PARAM2
0009E5 49E5 FE2C             7      CP  ','
0009E7 49E7 28F6            12      JR  Z,RCP_PARAM2
                                
0009E9 49E9 DD212F54        14      LD  IX,FRMQNT
0009ED 49ED FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009F1 49F1 CD1C00          17      CALL    _CALSLT
                                
0009F4 49F4 3AF6FA          13      LD  A,(ACPAGE)
0009F7 49F7 57               4      LD  D,A
0009F8 49F8 ED53E4F2        20      LD  (_BUF_Y),DE
       49FC                     RCP_PARAM3:
0009FC 49FC 23               6      INC HL
0009FD 49FD 7E               7      LD  A,(HL)
0009FE 49FE FE20             7      CP  020H
000A00 4A00 28FA            12      JR  Z,RCP_PARAM3
000A02 4A02 FE29             7      CP  ')'
000A04 4A04 28F6            12      JR  Z,RCP_PARAM3
000A06 4A06 FE2C             7      CP  ','
000A08 4A08 2033            12      JR  NZ,RCP_ST
                                
000A0A 4A0A 23               6      INC HL
000A0B 4A0B DD212F54        14      LD  IX,FRMQNT
000A0F 4A0F FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000A13 4A13 CD1C00          17      CALL    _CALSLT
                                
000A16 4A16 7B               4      LD  A,E
000A17 4A17 32E5F2          13      LD  (_BUF_P),A
                                
       4A1A                     RCP_PARAM4:
000A1A 4A1A 7E               7      LD  A,(HL)
000A1B 4A1B 23               6      INC HL
000A1C 4A1C FE20             7      CP  020H
000A1E 4A1E 28FA            12      JR  Z,RCP_PARAM4
                                
000A20 4A20 FE2C             7      CP  ','
000A22 4A22 2019            12      JR  NZ,RCP_ST
                                
000A24 4A24 7E               7      LD  A,(HL)
000A25 4A25 0604             7      LD  B,4
000A27 4A27 FEC3             7      CP  0C3H        ;PRESET
000A29 4A29 280E            12      JR  Z,RCP_LO
000A2B 4A2B 05               4      DEC B       ;3
000A2C 4A2C D6F8             7      SUB 0F8H        ;XOR
000A2E 4A2E 2809            12      JR  Z,RCP_LO
000A30 4A30 05               4      DEC B       ;2
000A31 4A31 3C               4      INC A       ;OR
000A32 4A32 2805            12      JR  Z,RCP_LO
000A34 4A34 05               4      DEC B       ;1
000A35 4A35 3C               4      INC A       ;AND
000A36 4A36 2801            12      JR  Z,RCP_LO
000A38 4A38 05               4      DEC B       ;0
                                                ;PSET
       4A39                     RCP_LO:
000A39 4A39 78               4      LD  A,B
000A3A 4A3A 32D9F2          13      LD  (_BUF_LO),A
       4A3D                     RCP_ST:
000A3D 4A3D 2AC6F6          16      LD  HL,(STREND)
000A40 4A40 22D4F2          16      LD  (_DTA),HL
000A43 4A43 EB               4      EX  DE,HL
000A44 4A44 2100FE          10      LD  HL,-512
000A47 4A47 39              11      ADD HL,SP
000A48 4A48 AF               4      XOR A
000A49 4A49 ED52            15      SBC HL,DE
000A4B 4A4B 3008            12      JR  NC,RCP0
000A4D 4A4D 215EF5          10      LD  HL,BUF
000A50 4A50 22D4F2          16      LD  (_DTA),HL
000A53 4A53 6F               4      LD  L,A ;0
000A54 4A54 67               4      LD  H,A ;0
       4A55                     RCP0:
000A55 4A55 24               4      INC H
000A56 4A56 22DCF2          16      LD  (_BUF_EN),HL
       4A59                     RCP1:
000A59 4A59 F3               4      DI
000A5A 4A5A CD2F4B          17      CALL    WAIT_VDP
                                
000A5D 4A5D 3A0700          13      LD  A,(WRVDP)
000A60 4A60 4F               4      LD  C,A
000A61 4A61 0C               4      INC C       ;C := PORT#1's address(WR)
000A62 4A62 3E24             7      LD  A,36
000A64 4A64 ED79            12      OUT (C),A
000A66 4A66 3E91             7      LD  A,080H+17
000A68 4A68 ED79            12      OUT (C),A       ;R#17 := 36
                                
000A6A 4A6A 0C               4      INC C
000A6B 4A6B 0C               4      INC C       ;C := PORT#3's address(WR)
000A6C 4A6C 2AE2F2          16      LD  HL,(_BUF_X)
000A6F 4A6F ED69            12      OUT (C),L       ;R#36 DX
000A71 4A71 ED61            12      OUT (C),H       ;R#37
000A73 4A73 2AE4F2          16      LD  HL,(_BUF_Y)
000A76 4A76 ED69            12      OUT (C),L       ;R#38 DY
000A78 4A78 ED61            12      OUT (C),H       ;R#39
000A7A 4A7A 2ADEF2          16      LD  HL,(_BUF_W)
000A7D 4A7D ED69            12      OUT (C),L       ;R#40 NX
000A7F 4A7F ED61            12      OUT (C),H       ;R#41
000A81 4A81 2AE0F2          16      LD  HL,(_BUF_H)
000A84 4A84 ED69            12      OUT (C),L       ;R#42 NY
000A86 4A86 ED61            12      OUT (C),H       ;R#43
                                
000A88 4A88 DD2AAFFC        20      LD  IX,(SCRMOD)
000A8C 4A8C 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000A8F 4A8F B7               4      OR  A
000A90 4A90 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000A92 4A92 DD7D             9      LD  A,IXL
000A94 4A94 FE08             7      CP  8
000A96 4A96 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
000A98 4A98 FE06             7      CP  6
000A9A 4A9A 2AE2F2          16      LD  HL,(_BUF_X)
000A9D 4A9D 3ADEF2          13      LD  A,(_BUF_W)
000AA0 4AA0 2005            12      JR  NZ,SCR57
000AA2 4AA2 B5               4      OR  L       ;スクリーン6
000AA3 4AA3 E603             7      AND 3
000AA5 4AA5 200D            12      JR  NZ,USE_LMMC
       4AA7                     SCR57:              ;スクリーン5,7
000AA7 4AA7 B5               4      OR  L
000AA8 4AA8 E601             7      AND 1
000AAA 4AAA 2008            12      JR  NZ,USE_LMMC
       4AAC                     USE_HMMC:
000AAC 4AAC DD2E08          10      LD  IXL,8
       4AAF                     USE_HMMC8:
000AAF 4AAF 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
000AB1 4AB1 32D9F2          13      LD  (_BUF_LO),A
       4AB4                     USE_LMMC:
000AB4 4AB4 110000          10      LD  DE,0
000AB7 4AB7 06FF             7      LD  B,-1
000AB9 4AB9 CD5A4B          17      CALL    GET_PIXEL
000ABC 4ABC ED79            12      OUT (C),A       ;R#44 first DATA
000ABE 4ABE 3AE6F2          13      LD  A,(_BUF_O)
000AC1 4AC1 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
000AC3 4AC3 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000AC6 4AC6 F6B0             7      OR  0B0H        ;R#46 LMMC command
000AC8 4AC8 ED79            12      OUT (C),A
                                
000ACA 4ACA FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
000ACC 4ACC 0D               4      DEC C
000ACD 4ACD 0D               4      DEC C       ;C := PORT#1's address(WR)
000ACE 4ACE 3EAC             7      LD  A,080H+44
000AD0 4AD0 ED79            12      OUT (C),A
000AD2 4AD2 3E91             7      LD  A,080H+17
000AD4 4AD4 ED79            12      OUT (C),A       ;R#17 := 44
                                
000AD6 4AD6 3A0600          13      LD  A,(RDVDP)
000AD9 4AD9 3C               4      INC A
000ADA 4ADA FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
000ADC 4ADC 3E02             7      LD  A,2
000ADE 4ADE ED79            12      OUT (C),A
000AE0 4AE0 3E8F             7      LD  A,08FH
000AE2 4AE2 ED79            12      OUT (C),A
000AE4 4AE4 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000AE7 4AE7 E640             7      AND 040H
000AE9 4AE9 201C            12      JR  NZ,LOOP_HMMC
       4AEB                     LOOP_COPY:
000AEB 4AEB CD5A4B          17      CALL    GET_PIXEL
000AEE 4AEE 08               4      EX  AF,AF'
000AEF 4AEF FD4C             9      LD  C,IYH
       4AF1                     LOOP_COPY1:
000AF1 4AF1 ED78            12      IN  A,(C)
000AF3 4AF3 0F               4      RRCA            ;RRCAではサインフラグは変化しない
000AF4 4AF4 300A            12      JR  NC,EXIT_COPY    ;check CE bit
000AF6 4AF6 F2F14A          10      JP  P,LOOP_COPY1    ;check TR bit
000AF9 4AF9 08               4      EX  AF,AF'
000AFA 4AFA FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000AFC 4AFC ED79            12      OUT (C),A
000AFE 4AFE 18EB            12      JR  LOOP_COPY
                                
       4B00                     EXIT_COPY:
000B00 4B00 CD374B          17      CALL    GET_STATUS_0
000B03 4B03 FB               4      EI
000B04 4B04 C39448          10      JP  ROM_NEXT
                                
       4B07                     LOOP_HMMC:
000B07 4B07 F3               4      DI          ;必要
000B08 4B08 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000B0A 4B0A 43               4      LD  B,E
000B0B 4B0B 7B               4      LD  A,E
000B0C 4B0C B7               4      OR  A
000B0D 4B0D 2802            12      JR  Z,LOOP_HMMC1
000B0F 4B0F EDB3                    OTIR
       4B11                     LOOP_HMMC1:
000B11 4B11 14               4      INC D
       4B12                     LOOP_HMMC2:
000B12 4B12 15               4      DEC D
000B13 4B13 2805            12      JR  Z,LOOP_HMMC3
000B15 4B15 EDB3                    OTIR
000B17 4B17 C3124B          10      JP  LOOP_HMMC2
       4B1A                     LOOP_HMMC3:
000B1A 4B1A ED78            12      IN  A,(C)
000B1C 4B1C 0F               4      RRCA
000B1D 4B1D 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
000B1F 4B1F 2ADCF2          16      LD  HL,(_BUF_EN)
000B22 4B22 CDA14B          17      CALL    ROM_READ
000B25 4B25 EB               4      EX  DE,HL
000B26 4B26 2AD4F2          16      LD  HL,(_DTA)
000B29 4B29 7A               4      LD  A,D
000B2A 4B2A B3               4      OR  E
000B2B 4B2B 20DA            12      JR  NZ,LOOP_HMMC
000B2D 4B2D 18C2            12      JR  LOOP_COPY1
                                
       4B2F                     WAIT_VDP:
000B2F 4B2F 3E02             7      LD  A,2
000B31 4B31 CD384B          17      CALL    GET_STATUS
000B34 4B34 0F               4      RRCA
000B35 4B35 38F8            12      JR  C,WAIT_VDP
       4B37                     GET_STATUS_0:
000B37 4B37 AF               4      XOR A
       4B38                     GET_STATUS:
000B38 4B38 C5              11      PUSH    BC
000B39 4B39 ED4B0600        20      LD  BC,(RDVDP)
000B3D 4B3D 0C               4      INC C
000B3E 4B3E ED79            12      OUT (C),A
000B40 4B40 3E8F             7      LD  A,08FH
000B42 4B42 ED79            12      OUT (C),A
000B44 4B44 ED78            12      IN  A,(C)
000B46 4B46 C1              10      POP BC
000B47 4B47 C9              10      RET
                                
       4B48                     GET_PIXEL256:
000B48 4B48 7A               4      LD  A,D
000B49 4B49 B3               4      OR  E
000B4A 4B4A 200A            12      JR  NZ,GET_PIXEL1
000B4C 4B4C 2ADCF2          16      LD  HL,(_BUF_EN)
000B4F 4B4F CDA14B          17      CALL    ROM_READ
000B52 4B52 EB               4      EX  DE,HL
000B53 4B53 2AD4F2          16      LD  HL,(_DTA)
       4B56                     GET_PIXEL1:
000B56 4B56 7E               7      LD  A,(HL)
000B57 4B57 23               6      INC HL
000B58 4B58 1B               6      DEC DE
000B59 4B59 C9              10      RET
                                
       4B5A                     GET_PIXEL:
000B5A 4B5A DD7D             9      LD  A,IXL
000B5C 4B5C FE08             7      CP  8
000B5E 4B5E 28E8            12      JR  Z,GET_PIXEL256
000B60 4B60 04               4      INC B
000B61 4B61 FE06             7      CP  6
000B63 4B63 282E            12      JR  Z,GET_PIXEL4
                                
000B65 4B65 CB40             8      BIT 0,B
000B67 4B67 20ED            12      JR  NZ,GET_PIXEL1
                                
000B69 4B69 7A               4      LD  A,D
000B6A 4B6A B3               4      OR  E
000B6B 4B6B 200A            12      JR  NZ,GET_PIXEL2
                                
000B6D 4B6D 2ADCF2          16      LD  HL,(_BUF_EN)
000B70 4B70 CDA14B          17      CALL    ROM_READ
000B73 4B73 EB               4      EX  DE,HL
000B74 4B74 2AD4F2          16      LD  HL,(_DTA)
                                
       4B77                     GET_PIXEL2:
000B77 4B77 7E               7      LD  A,(HL)
000B78 4B78 0F               4      RRCA
000B79 4B79 0F               4      RRCA
000B7A 4B7A 0F               4      RRCA
000B7B 4B7B 0F               4      RRCA
000B7C 4B7C C9              10      RET
                                
       4B7D                     GET_PIXEL3:
000B7D 4B7D 7A               4      LD  A,D
000B7E 4B7E B3               4      OR  E
000B7F 4B7F 200A            12      JR  NZ,GET_PIXEL5
                                
000B81 4B81 2ADCF2          16      LD  HL,(_BUF_EN)
000B84 4B84 CDA14B          17      CALL    ROM_READ
000B87 4B87 EB               4      EX  DE,HL
000B88 4B88 2AD4F2          16      LD  HL,(_DTA)
       4B8B                     GET_PIXEL5:
000B8B 4B8B 7E               7      LD  A,(HL)
000B8C 4B8C 0F               4      RRCA
000B8D 4B8D 0F               4      RRCA
000B8E 4B8E 0F               4      RRCA
000B8F 4B8F 0F               4      RRCA
000B90 4B90 0F               4      RRCA
000B91 4B91 0F               4      RRCA
000B92 4B92 C9              10      RET
                                
       4B93                     GET_PIXEL4:
000B93 4B93 78               4      LD  A,B
000B94 4B94 E603             7      AND 3   ;+0
000B96 4B96 28E5            12      JR  Z,GET_PIXEL3
000B98 4B98 3D               4      DEC A   ;+1
000B99 4B99 28DC            12      JR  Z,GET_PIXEL2
000B9B 4B9B 3D               4      DEC A   ;+2
000B9C 4B9C 7E               7      LD  A,(HL)
000B9D 4B9D C0              11      RET NZ
000B9E 4B9E 0F               4      RRCA        ;+3
000B9F 4B9F 0F               4      RRCA
000BA0 4BA0 C9              10      RET
                                
       4BA1                     ROM_READ:
000BA1 4BA1 E5              11      PUSH    HL
000BA2 4BA2 D5              11      PUSH    DE
000BA3 4BA3 C5              11      PUSH    BC
000BA4 4BA4 FDE5            15      PUSH    IY
000BA6 4BA6 22F3F2          16      LD  (LEFTX),HL
000BA9 4BA9 2AD4F2          16      LD  HL,(_DTA)
000BAC 4BAC 22E7F2          16      LD  (DTAX),HL
000BAF 4BAF 2AF3F2          16      LD  HL,(LEFTX)
                                
000BB2 4BB2 CDC24E          17      CALL    RBX1
000BB5 4BB5 3870            12      JR  C,RBRERR1
000BB7 4BB7 79               4      LD  A,C
000BB8 4BB8 EB               4      EX  DE,HL
000BB9 4BB9 ED52            15      SBC HL,DE       ;CP 0HL,CDE
000BBB 4BBB 19              11      ADD HL,DE
000BBC 4BBC DE00             7      SBC A,000H
000BBE 4BBE 3801            12      JR  C,RBR1
000BC0 4BC0 EB               4      EX  DE,HL
       4BC1                     RBR1:
000BC1 4BC1 9F               4      SBC A,A
000BC2 4BC2 E601             7      AND 1
000BC4 4BC4 32C3F2          13      LD  (_RESULT),A
000BC7 4BC7 7C               4      LD  A,H
000BC8 4BC8 B5               4      OR  L
000BC9 4BC9 CA1D4C          10      JP  Z,RBREND0
                                
000BCC 4BCC 22D0F2          16      LD  (_LEFT),HL  ;Read record byte
000BCF 4BCF 22F3F2          16      LD  (LEFTX),HL
                                
000BD2 4BD2 CDF54E          17      CALL    RBX2
000BD5 4BD5 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000BD7 4BD7 CD084F          17      CALL    RBXA
000BDA 4BDA DA334C          10      JP  C,RBRERR
000BDD 4BDD C5              11      PUSH    BC
000BDE 4BDE CD0D45          17      CALL    ROM_LDIR
000BE1 4BE1 ED53E7F2        20      LD  (DTAX),DE
000BE5 4BE5 2AF3F2          16      LD  HL,(LEFTX)
000BE8 4BE8 D1              10      POP DE
000BE9 4BE9 A7               4      AND A
000BEA 4BEA ED52            15      SBC HL,DE
000BEC 4BEC 22F3F2          16      LD  (LEFTX),HL
000BEF 4BEF 2829            12      JR  Z,RBREND
                                
       4BF1                     RBRB:
000BF1 4BF1 CD414F          17      CALL    RBXB
000BF4 4BF4 2818            12      JR  Z,RBRC
       4BF6                     RBRB1:
000BF6 4BF6 C5              11      PUSH    BC
000BF7 4BF7 D5              11      PUSH    DE
000BF8 4BF8 CDF24F          17      CALL    CLUST
000BFB 4BFB EB               4      EX  DE,HL
000BFC 4BFC ED4BC6F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000C00 4C00 CD0D45          17      CALL    ROM_LDIR
000C03 4C03 EB               4      EX  DE,HL
000C04 4C04 D1              10      POP DE
000C05 4C05 C1              10      POP BC
000C06 4C06 CDCF4F          17      CALL    GNCL
000C09 4C09 DA334C          10      JP  C,RBRERR
000C0C 4C0C 10E8            13      DJNZ    RBRB1
       4C0E                     RBRC:
000C0E 4C0E CD594F          17      CALL    RBXC
000C11 4C11 2807            12      JR  Z,RBREND
                                
000C13 4C13 CDF24F          17      CALL    CLUST
000C16 4C16 EB               4      EX  DE,HL
000C17 4C17 CD0D45          17      CALL    ROM_LDIR
       4C1A                     RBREND:
000C1A 4C1A CD654F          17      CALL    RBXEND
       4C1D                     RBREND0:
000C1D 4C1D FDE1            14      POP IY
000C1F 4C1F C1              10      POP BC
000C20 4C20 D1              10      POP DE
000C21 4C21 F1              10      POP AF  ;(HL)
000C22 4C22 AF               4      XOR A
000C23 4C23 3AC3F2          13      LD  A,(_RESULT)
000C26 4C26 C9              10      RET
                                
       4C27                     RBRERR1:
000C27 4C27 3E01             7      LD  A,001H
       4C29                     RBRERR2:
000C29 4C29 FDE1            14      POP IY
000C2B 4C2B C1              10      POP BC
000C2C 4C2C D1              10      POP DE
000C2D 4C2D E1              10      POP HL
000C2E 4C2E 37               4      SCF
000C2F 4C2F 210000          10      LD  HL,0
000C32 4C32 C9              10      RET
       4C33                     RBRERR:
000C33 4C33 3EFF             7      LD  A,0FFH
000C35 4C35 18F2            12      JR  RBRERR2
                                
       4C37                     FILE_DD:
000C37 4C37 E1              10      POP HL
000C38 4C38 3E                      DB  03EH
000C39 4C39 C9              10      RET
000C3A 4C3A 32A3F2          13      LD  (SWC_BLOAD_M),A
       4C3D                     ROM_ORG:
000C3D 4C3D 2AF5F2          16      LD  HL,(PARAM0)
000C40 4C40 7E               7      LD  A,(HL)
000C41 4C41 C9              10      RET
       4C42                     FILE_B:
000C42 4C42 1E00             7      LD  E,0
000C44 4C44 3A63F6          13      LD  A,(VALTYP)
000C47 4C47 FE03             7      CP  3       ;string
000C49 4C49 C2F64C          10      JP  NZ,FILED
                                
000C4C 4C4C DD21D067        14      LD  IX,FRESTR
000C50 4C50 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000C54 4C54 CD1C00          17      CALL    _CALSLT
000C57 4C57 E5              11      PUSH    HL
000C58 4C58 DDE1            14      POP IX
                                
000C5A 4C5A DD5E00          19      LD  E,(IX+0)
000C5D 4C5D DD7E01          19      LD  A,(IX+1)
000C60 4C60 DD5602          19      LD  D,(IX+2)
000C63 4C63 DD62             9      LD  IXH,D
000C65 4C65 DD6F             9      LD  IXL,A
000C67 4C67 3E1F             7      LD  A,01FH
000C69 4C69 1802            12      JR  FILE_BAS
       4C6B                     FILE_BDOS:
000C6B 4C6B 3E20             7      LD  A,020H
       4C6D                     FILE_BAS:
000C6D 4C6D 32FBF2          13      LD  (_CHKSP),A
000C70 4C70 AF               4      XOR A
000C71 4C71 3200F3          13      LD  (FDRV),A
000C74 4C74 7B               4      LD  A,E
000C75 4C75 FE04             7      CP  4
000C77 4C77 3808            12      JR  C,FILEB1
000C79 4C79 DD7E03          19      LD  A,(IX+3)
000C7C 4C7C FE3A             7      CP  ':'
000C7E 4C7E 28B7            12      JR  Z,FILE_DD
000C80 4C80 7B               4      LD  A,E
       4C81                     FILEB1:
000C81 4C81 FE02             7      CP  2
000C83 4C83 3820            12      JR  C,DEVI1
000C85 4C85 DD7E01          19      LD  A,(IX+1)
000C88 4C88 FE3A             7      CP  ':'
000C8A 4C8A 2019            12      JR  NZ,DEVI1
000C8C 4C8C DD7E00          19      LD  A,(IX+0)        ;DRIVE
000C8F 4C8F CDD34D          17      CALL    CAP
000C92 4C92 D640             7      SUB '@'
000C94 4C94 DD23            10      INC IX
000C96 4C96 DD23            10      INC IX
000C98 4C98 1D               4      DEC E
000C99 4C99 1D               4      DEC E
000C9A 4C9A 3200F3          13      LD  (FDRV),A
000C9D 4C9D F5              11      PUSH    AF
000C9E 4C9E CDB955          17      CALL    GET_CD_CDRV
000CA1 4CA1 22F9F2          16      LD  (_CDX),HL
000CA4 4CA4 E1              10      POP HL
       4CA5                     DEVI1:
000CA5 4CA5 DD7E00          19      LD  A,(IX+0)
000CA8 4CA8 D65C             7      SUB 05CH        ;\
000CAA 4CAA 2008            12      JR  NZ,NOROOT
000CAC 4CAC 6F               4      LD  L,A
000CAD 4CAD 67               4      LD  H,A
000CAE 4CAE 22F9F2          16      LD  (_CDX),HL
000CB1 4CB1 DD23            10      INC IX
000CB3 4CB3 1D               4      DEC E
       4CB4                     NOROOT:
                                
       4CB4                     SETDIR:
000CB4 4CB4 CDF64C          17      CALL    FILED
000CB7 4CB7 DD7E00          19      LD  A,(IX+0)
000CBA 4CBA FE5C             7      CP  05CH        ;\
000CBC 4CBC C0              11      RET NZ
000CBD 4CBD DD23            10      INC IX
000CBF 4CBF 1D               4      DEC E
000CC0 4CC0 3A01F3          13      LD  A,(FNAME)
000CC3 4CC3 FE20             7      CP  020H        ;. の処理
000CC5 4CC5 28ED            12      JR  Z,SETDIR
                                
000CC7 4CC7 CDE94D          17      CALL    ROM_OPEN
000CCA 4CCA B7               4      OR  A
000CCB 4CCB C0              11      RET NZ
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
000CCC 4CCC D5              11      PUSH    DE
000CCD 4CCD 2AEFF2          16      LD  HL,(DIRENT1)
000CD0 4CD0 110B00          10      LD  DE,0000BH   ;属性(アトリビュート)
000CD3 4CD3 19              11      ADD HL,DE
000CD4 4CD4 CDFE44          17      CALL    RDSLT_ROM
000CD7 4CD7 D1              10      POP DE
000CD8 4CD8 CB67             8      BIT 4,A     ;ディレクトリ
                                #else
                                    LD  IY,(DIRENT1)
                                    BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000CDA 4CDA C8              11      RET Z
000CDB 4CDB CD3D4D          17      CALL    FILEI
                                #if exists USE_MORMAL32K_OR_ASCII16
000CDE 4CDE D5              11      PUSH    DE
000CDF 4CDF 2AEFF2          16      LD  HL,(DIRENT1)
000CE2 4CE2 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000CE5 4CE5 19              11      ADD HL,DE
000CE6 4CE6 CDFE44          17      CALL    RDSLT_ROM
000CE9 4CE9 23               6      INC HL
000CEA 4CEA 5F               4      LD  E,A
000CEB 4CEB CDFE44          17      CALL    RDSLT_ROM
000CEE 4CEE 57               4      LD  D,A
000CEF 4CEF EB               4      EX  DE,HL
000CF0 4CF0 D1              10      POP DE
                                #else
                                    LD  L,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  H,(IY+01BH)
                                #endif
000CF1 4CF1 22F9F2          16      LD  (_CDX),HL
000CF4 4CF4 18BE            12      JR  SETDIR
                                
       4CF6                     FILED:
000CF6 4CF6 CD3D4D          17      CALL    FILEI
000CF9 4CF9 2101F3          10      LD  HL,FNAME
                                
000CFC 4CFC 0608             7      LD  B,8
       4CFE                     FILE2:
000CFE 4CFE CD4A4D          17      CALL    CCHKF
000D01 4D01 C8              11      RET Z
000D02 4D02 FE2A             7      CP  '*'
000D04 4D04 282E            12      JR  Z,FILE9
000D06 4D06 FE2E             7      CP  '.'
000D08 4D08 280C            12      JR  Z,FILE4
000D0A 4D0A 77               7      LD  (HL),A
000D0B 4D0B 23               6      INC HL
000D0C 4D0C 10F0            13      DJNZ    FILE2
                                
       4D0E                     FILE3:
000D0E 4D0E CD4A4D          17      CALL    CCHKF
000D11 4D11 C8              11      RET Z
000D12 4D12 FE2E             7      CP  '.'
000D14 4D14 20F8            12      JR  NZ,FILE3
                                
       4D16                     FILE4:
000D16 4D16 2109F3          10      LD  HL,FNAME+8
000D19 4D19 0603             7      LD  B,3
                                
       4D1B                     FILE4L:
000D1B 4D1B CD4A4D          17      CALL    CCHKF
000D1E 4D1E C8              11      RET Z
000D1F 4D1F FE2E             7      CP  '.'
000D21 4D21 2008            12      JR  NZ,FILE12
000D23 4D23 3201F3          13      LD  (FNAME),A   ;Parent directory(..)
000D26 4D26 3202F3          13      LD  (FNAME+1),A
000D29 4D29 3E20             7      LD  A,020H
       4D2B                     FILE12:
000D2B 4D2B FE2A             7      CP  '*'
000D2D 4D2D 280A            12      JR  Z,FILE10
000D2F 4D2F 77               7      LD  (HL),A
000D30 4D30 23               6      INC HL
000D31 4D31 10E8            13      DJNZ    FILE4L
000D33 4D33 C9              10      RET
                                
       4D34                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000D34 4D34 CD394D          17      CALL    FILE10
000D37 4D37 18D5            12      JR  FILE3
                                
       4D39                     FILE10:
000D39 4D39 3E3F             7      LD  A,'?'
000D3B 4D3B 1808            12      JR  FILL_MEMORY
       4D3D                     FILEI:              ;名前＋拡張子をスペースで初期化
000D3D 4D3D 3E20             7      LD  A,020H
000D3F 4D3F 01000B          10      LD  BC,11*256   ;C=0にしておく
000D42 4D42 2101F3          10      LD  HL,FNAME
       4D45                     FILL_MEMORY:            ;HLからBバイトAで埋める
000D45 4D45 77               7      LD  (HL),A
000D46 4D46 23               6      INC HL
000D47 4D47 10FC            13      DJNZ    FILL_MEMORY
000D49 4D49 C9              10      RET
                                
       4D4A                     CCHKF:
000D4A 4D4A 7B               4      LD  A,E
000D4B 4D4B B7               4      OR  A
000D4C 4D4C C8              11      RET Z
000D4D 4D4D DD7E00          19      LD  A,(IX+0)
000D50 4D50 CD574D          17      CALL    CCHK2
000D53 4D53 C8              11      RET Z
000D54 4D54 C3BE4D          10      JP  FKAN
                                
       4D57                     CCHK2:
000D57 4D57 0C               4      INC C
000D58 4D58 0D               4      DEC C
000D59 4D59 C0              11      RET NZ
       4D5A                     CCHK3:              ;ZF=1 で使えない文字
000D5A 4D5A FE2B             7      CP  '+'
000D5C 4D5C C8              11      RET Z
000D5D 4D5D FE2C             7      CP  ','
000D5F 4D5F C8              11      RET Z
000D60 4D60 FE2F             7      CP  '/'
000D62 4D62 C8              11      RET Z
000D63 4D63 FE3A             7      CP  ':'
000D65 4D65 C8              11      RET Z
000D66 4D66 FE3B             7      CP  ';'
000D68 4D68 C8              11      RET Z
000D69 4D69 FE3D             7      CP  '='
000D6B 4D6B C8              11      RET Z
000D6C 4D6C FE5C             7      CP  05CH    ;\
000D6E 4D6E C8              11      RET Z
000D6F 4D6F E5              11      PUSH    HL
000D70 4D70 2AFBF2          16      LD  HL,(_CHKSP)
000D73 4D73 BD               4      CP  L
000D74 4D74 E1              10      POP HL
000D75 4D75 D0              11      RET NC
000D76 4D76 BF               4      CP  A       ;Z=1
000D77 4D77 C9              10      RET
                                
       4D78                     SS1:
000D78 4D78 13               6      INC DE
       4D79                     SPCUT:              ;スペースをカット
000D79 4D79 1A               7      LD  A,(DE)
000D7A 4D7A FE20             7      CP  020H
000D7C 4D7C 28FA            12      JR  Z,SS1
000D7E 4D7E C9              10      RET
                                
       4D7F                     SCREOF1:
000D7F 4D7F 13               6      INC DE
       4D80                     SPCUTEX:            ;スペース改行などをカット
000D80 4D80 1A               7      LD  A,(DE)
000D81 4D81 FE20             7      CP  020H
000D83 4D83 28FA            12      JR  Z,SCREOF1
000D85 4D85 FE0D             7      CP  00DH
000D87 4D87 28F6            12      JR  Z,SCREOF1
000D89 4D89 FE0A             7      CP  00AH
000D8B 4D8B 28F2            12      JR  Z,SCREOF1
000D8D 4D8D FE1A             7      CP  01AH
000D8F 4D8F 28EE            12      JR  Z,SCREOF1
000D91 4D91 C9              10      RET
                                
       4D92                     GETNUM:
000D92 4D92 210000          10      LD  HL,0
       4D95                     GETNUM1:
000D95 4D95 1A               7      LD  A,(DE)
000D96 4D96 13               6      INC DE
000D97 4D97 D630             7      SUB '0'
000D99 4D99 D8              11      RET C
000D9A 4D9A FE0A             7      CP  10
000D9C 4D9C D0              11      RET NC
000D9D 4D9D 4D               4      LD  C,L
000D9E 4D9E 44               4      LD  B,H
000D9F 4D9F 29              11      ADD HL,HL   ;*2
000DA0 4DA0 29              11      ADD HL,HL   ;*4
000DA1 4DA1 09              11      ADD HL,BC   ;*5
000DA2 4DA2 29              11      ADD HL,HL   ;*10
000DA3 4DA3 4F               4      LD  C,A
000DA4 4DA4 0600             7      LD  B,0
000DA6 4DA6 09              11      ADD HL,BC
000DA7 4DA7 18EC            12      JR  GETNUM1
                                
       4DA9                     SEARCH_END:
000DA9 4DA9 7E               7      LD  A,(HL)
       4DAA                     SEARCH_END1:
000DAA 4DAA 23               6      INC HL
000DAB 4DAB B7               4      OR  A
000DAC 4DAC C8              11      RET Z
000DAD 4DAD FE3A             7      CP  ':'
000DAF 4DAF 20F8            12      JR  NZ,SEARCH_END
000DB1 4DB1 7E               7      LD  A,(HL)
000DB2 4DB2 FE3A             7      CP  ':'
000DB4 4DB4 28F4            12      JR  Z,SEARCH_END1
000DB6 4DB6 C9              10      RET
                                
       4DB7                     FKANC:
000DB7 4DB7 CB41             8      BIT 0,C
000DB9 4DB9 CCDC4D          17      CALL    Z,CAP2
000DBC 4DBC 1803            12      JR  FKANX
       4DBE                     FKAN:           ;漢字チェック
000DBE 4DBE DD23            10      INC IX
000DC0 4DC0 1D               4      DEC E
       4DC1                     FKANX:
000DC1 4DC1 CB41             8      BIT 0,C
000DC3 4DC3 CB81             8      RES 0,C
000DC5 4DC5 C0              11      RET NZ
000DC6 4DC6 FE80             7      CP  080H
000DC8 4DC8 D8              11      RET C
000DC9 4DC9 FEA0             7      CP  0A0H
000DCB 4DCB 3803            12      JR  C,FKAN1
000DCD 4DCD FEE0             7      CP  0E0H
000DCF 4DCF D8              11      RET C
       4DD0                     FKAN1:
000DD0 4DD0 0C               4      INC C
000DD1 4DD1 A7               4      AND A
000DD2 4DD2 C9              10      RET
                                
       4DD3                     CAP:
000DD3 4DD3 FE61             7      CP  'a'
000DD5 4DD5 D8              11      RET C
000DD6 4DD6 FE7B             7      CP  'z'+1
000DD8 4DD8 D0              11      RET NC
000DD9 4DD9 D620             7      SUB 020H
000DDB 4DDB C9              10      RET
       4DDC                     CAP2:
000DDC 4DDC CDD34D          17      CALL    CAP
       4DDF                     CAP3:               ;
000DDF 4DDF FE05             7      CP  5
000DE1 4DE1 2803            12      JR  Z,CAP4
000DE3 4DE3 FE21             7      CP  021H
000DE5 4DE5 C9              10      RET
       4DE6                     CAP4:
000DE6 4DE6 3EE5             7      LD  A,0E5H
000DE8 4DE8 C9              10      RET
                                
       4DE9                     ROM_OPEN:
000DE9 4DE9 CDDA55          17      CALL    GET_DISK_BANK_FDRV
                                
000DEC 4DEC CDAC50          17      CALL    GET_DIR_DAT
000DEF 4DEF D5              11      PUSH    DE
000DF0 4DF0 CD5D4E          17      CALL    FILESE
000DF3 4DF3 D1              10      POP DE
000DF4 4DF4 300F            12      JR  NC,ROM_OPEN_C
       4DF6                     ROM_OPEN_OK:
000DF6 4DF6 22EFF2          16      LD  (DIRENT1),HL
000DF9 4DF9 E5              11      PUSH    HL
000DFA 4DFA AF               4      XOR A
000DFB 4DFB 6F               4      LD  L,A
000DFC 4DFC 67               4      LD  H,A
000DFD 4DFD 22CAF2          16      LD  (RR_LOW),HL
000E00 4E00 22CCF2          16      LD  (RR_HIGH),HL
000E03 4E03 E1              10      POP HL
000E04 4E04 C9              10      RET
                                
       4E05                     ROM_OPEN_C:         ;#XXXX 形式のサブディスク
000E05 4E05 3A01F3          13      LD  A,(FNAME)
000E08 4E08 FE23             7      CP  '#'
000E0A 4E0A 37               4      SCF
000E0B 4E0B C0              11      RET NZ
000E0C 4E0C D5              11      PUSH    DE
000E0D 4E0D 2100F3          10      LD  HL,FDRV
000E10 4E10 1103FB          10      LD  DE,TMP_DIRENT
000E13 4E13 010C00          10      LD  BC,1+8+3
000E16 4E16 EDB0                    LDIR
000E18 4E18 0614             7      LD  B,32-(1+8+3)
000E1A 4E1A CDBE5A          17      CALL    ZERO_MEMORY_DE
000E1D 4E1D 3E10             7      LD  A,010H          ;ディレクトリ属性
000E1F 4E1F 320EFB          13      LD  (TMP_DIRENT+0000BH),A   ;属性(アトリビュート)
000E22 4E22 3A02F3          13      LD  A,(FNAME+1)
000E25 4E25 CD315B          17      CALL    HEX
000E28 4E28 3830            12      JR  C,POPDE_SCF
000E2A 4E2A 87               4      ADD A,A
000E2B 4E2B 87               4      ADD A,A
000E2C 4E2C 87               4      ADD A,A
000E2D 4E2D 87               4      ADD A,A
000E2E 4E2E 5F               4      LD  E,A
000E2F 4E2F 3A03F3          13      LD  A,(FNAME+2)
000E32 4E32 CD315B          17      CALL    HEX
000E35 4E35 3823            12      JR  C,POPDE_SCF
000E37 4E37 B3               4      OR  E
000E38 4E38 321EFB          13      LD  (TMP_DIRENT+0001BH),A       ;ファイルの先頭クラスタ
000E3B 4E3B 3A04F3          13      LD  A,(FNAME+3)
000E3E 4E3E CD315B          17      CALL    HEX
000E41 4E41 3817            12      JR  C,POPDE_SCF
000E43 4E43 87               4      ADD A,A
000E44 4E44 87               4      ADD A,A
000E45 4E45 87               4      ADD A,A
000E46 4E46 87               4      ADD A,A
000E47 4E47 5F               4      LD  E,A
000E48 4E48 3A05F3          13      LD  A,(FNAME+4)
000E4B 4E4B CD315B          17      CALL    HEX
000E4E 4E4E 380A            12      JR  C,POPDE_SCF
000E50 4E50 B3               4      OR  E
000E51 4E51 321DFB          13      LD  (TMP_DIRENT+0001AH),A       ;ファイルの先頭クラスタ
000E54 4E54 D1              10      POP DE
000E55 4E55 2103FB          10      LD  HL,TMP_DIRENT
000E58 4E58 189C            12      JR  ROM_OPEN_OK
       4E5A                     POPDE_SCF:
000E5A 4E5A D1              10      POP DE
000E5B 4E5B 37               4      SCF
000E5C 4E5C C9              10      RET
                                
       4E5D                     FILESE:
       4E5D                     FILESE0:
                                #if exists USE_MORMAL32K_OR_ASCII16
000E5D 4E5D CDFE44          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000E60 4E60 B7               4      OR  A
000E61 4E61 C8              11      RET Z       ;END:ZF=1 CF=0
000E62 4E62 FEE5             7      CP  0E5H
000E64 4E64 280D            12      JR  Z,FILESE1
000E66 4E66 1101F3          10      LD  DE,FNAME
000E69 4E69 E5              11      PUSH    HL
000E6A 4E6A CD994E          17      CALL    CPFILE
000E6D 4E6D CCBC4E          17      CALL    Z,CPFILE2
000E70 4E70 E1              10      POP HL
000E71 4E71 37               4      SCF
000E72 4E72 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4E73                     FILESE1:
000E73 4E73 CD7B4E          17      CALL    FNEXT
000E76 4E76 20E5            12      JR  NZ,FILESE0
000E78 4E78 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000E7A 4E7A C9              10      RET
                                
       4E7B                     FNEXT:
000E7B 4E7B 112000          10      LD  DE,020H
000E7E 4E7E 19              11      ADD HL,DE
000E7F 4E7F ED5BF9F2        20      LD  DE,(_CDX)
000E83 4E83 7A               4      LD  A,D
000E84 4E84 B3               4      OR  E
000E85 4E85 2002            12      JR  NZ,FNEXT_SUBDIR
000E87 4E87 0D               4      DEC C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
                                    PUSH    AF      ;※フラグを保存する必要あり
                                    BIT 7,H
                                    JR  Z,CHECK_DIR_PAGE1
                                    LD  A,H
                                    SUB 020H
                                    LD  H,A
                                    LD  A,(_DIR_BANK)
                                    INC A
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_DIR_BANK),A
                                CHECK_DIR_PAGE1:
                                    POP AF
                                #endif
000E88 4E88 C9              10      RET
                                
       4E89                     FNEXT_SUBDIR:           ;サブディレクトリ
000E89 4E89 0D               4      DEC C
000E8A 4E8A C0              11      RET NZ
                                
000E8B 4E8B ED5BF9F2        20      LD  DE,(_CDX)
000E8F 4E8F CDCF4F          17      CALL    GNCL
000E92 4E92 EB               4      EX  DE,HL
000E93 4E93 22F9F2          16      LD  (_CDX),HL
000E96 4E96 C3E550          10      JP  GET_SUBDIR
                                
       4E99                     CPFILE:
000E99 4E99 C5              11      PUSH    BC
000E9A 4E9A 01000B          10      LD  BC,00B00H
       4E9D                     CPSTR1:
000E9D 4E9D 1A               7      LD  A,(DE)
000E9E 4E9E FE3F             7      CP  '?'     ;Wild card
000EA0 4EA0 2814            12      JR  Z,CPSTR2
                                #if exists USE_MORMAL32K_OR_ASCII16
000EA2 4EA2 CDFE44          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000EA5 4EA5 CDB74D          17      CALL    FKANC
000EA8 4EA8 E5              11      PUSH    HL
000EA9 4EA9 67               4      LD  H,A
000EAA 4EAA 1A               7      LD  A,(DE)
000EAB 4EAB CB01             8      RLC C
000EAD 4EAD CDB74D          17      CALL    FKANC
000EB0 4EB0 CB09             8      RRC C
000EB2 4EB2 BC               4      CP  H       ;CP (HL),(DE)
000EB3 4EB3 E1              10      POP HL
000EB4 4EB4 2004            12      JR  NZ,CPSTR3
       4EB6                     CPSTR2:
000EB6 4EB6 13               6      INC DE
000EB7 4EB7 23               6      INC HL
000EB8 4EB8 10E3            13      DJNZ    CPSTR1
       4EBA                     CPSTR3:
000EBA 4EBA C1              10      POP BC
000EBB 4EBB C9              10      RET
                                
       4EBC                     CPFILE2:
                                #if exists USE_MORMAL32K_OR_ASCII16
000EBC 4EBC CDFE44          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000EBF 4EBF E608             7      AND 008H    ;~0F7H
000EC1 4EC1 C9              10      RET
                                
       4EC2                     RBX1:
000EC2 4EC2 E5              11      PUSH    HL      ;Record byte
                                
000EC3 4EC3 ED5BCAF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000EC7 4EC7 3ACDF2          13      LD  A,(RR_HIGH+1)
000ECA 4ECA 4F               4      LD  C,A
                                
000ECB 4ECB 3AF1F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
000ECE 4ECE 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
000ED1 4ED1 D5              11      PUSH    DE
000ED2 4ED2 2AEFF2          16      LD  HL,(DIRENT1)
000ED5 4ED5 111C00          10      LD  DE,0001CH
000ED8 4ED8 19              11      ADD HL,DE
000ED9 4ED9 CDFE44          17      CALL    RDSLT_ROM
000EDC 4EDC 23               6      INC HL
000EDD 4EDD 5F               4      LD  E,A
000EDE 4EDE CDFE44          17      CALL    RDSLT_ROM
000EE1 4EE1 23               6      INC HL
000EE2 4EE2 57               4      LD  D,A
000EE3 4EE3 CDFE44          17      CALL    RDSLT_ROM
000EE6 4EE6 EB               4      EX  DE,HL       ;AHL=File size
000EE7 4EE7 D1              10      POP DE
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  L,(IY+01CH) ;AHL=File size
                                    LD  H,(IY+01DH)
                                    LD  A,(IY+01EH)
                                #endif
                                
000EE8 4EE8 A7               4      AND A
000EE9 4EE9 ED52            15      SBC HL,DE
000EEB 4EEB 99               4      SBC A,C
000EEC 4EEC D1              10      POP DE
                                
000EED 4EED D8              11      RET C
000EEE 4EEE 4F               4      LD  C,A
000EEF 4EEF EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000EF0 4EF0 B2               4      OR  D
000EF1 4EF1 B3               4      OR  E
000EF2 4EF2 C0              11      RET NZ
000EF3 4EF3 37               4      SCF
000EF4 4EF4 C9              10      RET
                                
       4EF5                     RBX2:
000EF5 4EF5 ED4BCBF2        20      LD  BC,(RR_LOW+1)
000EF9 4EF9 CD7A4F          17      CALL    RWXR
000EFC 4EFC 3AC7F2          13      LD  A,(CLSZ_H)
000EFF 4EFF 3D               4      DEC A
000F00 4F00 E5              11      PUSH    HL
000F01 4F01 2ACAF2          16      LD  HL,(RR_LOW)
000F04 4F04 A4               4      AND H
000F05 4F05 B5               4      OR  L
000F06 4F06 E1              10      POP HL
000F07 4F07 C9              10      RET
                                
       4F08                     RBXA:
000F08 4F08 D5              11      PUSH    DE
000F09 4F09 CDF24F          17      CALL    CLUST
000F0C 4F0C ED53D2F2        20      LD  (_DTPS),DE
000F10 4F10 D1              10      POP DE
000F11 4F11 CDCF4F          17      CALL    GNCL
000F14 4F14 D8              11      RET C
000F15 4F15 ED53CEF2        20      LD  (_CLPS),DE
                                
000F19 4F19 ED4BCAF2        20      LD  BC,(RR_LOW)
000F1D 4F1D 2AC6F2          16      LD  HL,(CLSZ)
000F20 4F20 7C               4      LD  A,H
000F21 4F21 3D               4      DEC A
000F22 4F22 A0               4      AND B
000F23 4F23 47               4      LD  B,A
000F24 4F24 ED42            15      SBC HL,BC       ;remaining cluster
                                
000F26 4F26 ED5BF3F2        20      LD  DE,(LEFTX)
000F2A 4F2A ED52            15      SBC HL,DE       ;CP HL,DE
000F2C 4F2C 19              11      ADD HL,DE
000F2D 4F2D 3801            12      JR  C,RBXA1
000F2F 4F2F EB               4      EX  DE,HL
       4F30                     RBXA1:
000F30 4F30 3AC4F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_MORMAL32K_OR_ASCII16
000F33 4F33 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000F36 4F36 E5              11      PUSH    HL
000F37 4F37 2AD2F2          16      LD  HL,(_DTPS)
000F3A 4F3A 09              11      ADD HL,BC
000F3B 4F3B ED5BE7F2        20      LD  DE,(DTAX)
000F3F 4F3F C1              10      POP BC
000F40 4F40 C9              10      RET
                                
       4F41                     RBXB:
000F41 4F41 2AE7F2          16      LD  HL,(DTAX)
000F44 4F44 ED5BCEF2        20      LD  DE,(_CLPS)
000F48 4F48 3AF4F2          13      LD  A,(LEFTX+1)
000F4B 4F4B 47               4      LD  B,A
000F4C 4F4C 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4F4F                     RBXB1:
000F4F 4F4F 1F               4      RRA     ;->CF
000F50 4F50 3804            12      JR  C,RBXB2
000F52 4F52 CB38             8      SRL B   ;B=B/2
000F54 4F54 18F9            12      JR  RBXB1
       4F56                     RBXB2:
000F56 4F56 78               4      LD  A,B
000F57 4F57 B7               4      OR  A
000F58 4F58 C9              10      RET
                                
       4F59                     RBXC:
000F59 4F59 ED4BF3F2        20      LD  BC,(LEFTX)
000F5D 4F5D 3AC7F2          13      LD  A,(CLSZ_H)
000F60 4F60 3D               4      DEC A
000F61 4F61 A0               4      AND B
000F62 4F62 47               4      LD  B,A
000F63 4F63 B1               4      OR  C
000F64 4F64 C9              10      RET
                                
       4F65                     RBXEND:
000F65 4F65 ED5BD0F2        20      LD  DE,(_LEFT)
000F69 4F69 2ACAF2          16      LD  HL,(RR_LOW)
000F6C 4F6C 3ACDF2          13      LD  A,(RR_HIGH+1)
000F6F 4F6F 19              11      ADD HL,DE
000F70 4F70 CE00             7      ADC A,0
000F72 4F72 22CAF2          16      LD  (RR_LOW),HL
000F75 4F75 32CDF2          13      LD  (RR_HIGH+1),A
000F78 4F78 EB               4      EX  DE,HL       ;HL=Read byte
000F79 4F79 C9              10      RET
                                
       4F7A                     RWXR:
000F7A 4F7A 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4F7D                     L_RWX:
000F7D 4F7D 1F               4      RRA     ;->CF
000F7E 4F7E 3806            12      JR  C,E_RWX
000F80 4F80 CB38             8      SRL B   ;BC=BC/2
000F82 4F82 CB19             8      RR  C   ;
000F84 4F84 18F7            12      JR  L_RWX
       4F86                     E_RWX:
000F86 4F86 3AF1F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
000F89 4F89 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
000F8C 4F8C E5              11      PUSH    HL
000F8D 4F8D 2AEFF2          16      LD  HL,(DIRENT1)
000F90 4F90 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000F93 4F93 19              11      ADD HL,DE
000F94 4F94 CDFE44          17      CALL    RDSLT_ROM
000F97 4F97 23               6      INC HL
000F98 4F98 5F               4      LD  E,A
000F99 4F99 CDFE44          17      CALL    RDSLT_ROM
000F9C 4F9C 23               6      INC HL
000F9D 4F9D 57               4      LD  D,A
000F9E 4F9E E1              10      POP HL
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  E,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  D,(IY+01BH)
                                #endif
000F9F 4F9F CDDA55          17      CALL    GET_DISK_BANK_FDRV
       4FA2                     RWX1:
000FA2 4FA2 ED53CEF2        20      LD  (_CLPS),DE
000FA6 4FA6 7A               4      LD  A,D
000FA7 4FA7 B3               4      OR  E
000FA8 4FA8 37               4      SCF
000FA9 4FA9 C8              11      RET Z
                                
000FAA 4FAA 78               4      LD  A,B
000FAB 4FAB B1               4      OR  C
000FAC 4FAC C8              11      RET Z
                                
000FAD 4FAD CDCF4F          17      CALL    GNCL
000FB0 4FB0 D8              11      RET C
000FB1 4FB1 0B               6      DEC BC
000FB2 4FB2 CD3650          17      CALL    ENDCL
000FB5 4FB5 38EB            12      JR  C,RWX1
000FB7 4FB7 37               4      SCF
000FB8 4FB8 C9              10      RET
                                
       4FB9                     NCL3:
000FB9 4FB9 CDDA55          17      CALL    GET_DISK_BANK_FDRV
000FBC 4FBC 6B               4      LD  L,E
000FBD 4FBD 62               4      LD  H,D
000FBE 4FBE CB3C             8      SRL H
000FC0 4FC0 CB1D             8      RR  L
000FC2 4FC2 1F               4      RRA
000FC3 4FC3 19              11      ADD HL,DE
000FC4 4FC4 010060          10      LD  BC,BANK1_ADR
000FC7 4FC7 09              11      ADD HL,BC
000FC8 4FC8 ED4BC8F2        20      LD  BC,(SECSZ)
000FCC 4FCC 09              11      ADD HL,BC
000FCD 4FCD 17               4      RLA
000FCE 4FCE C9              10      RET
                                
       4FCF                     GNCL:
000FCF 4FCF 7A               4      LD  A,D
000FD0 4FD0 B3               4      OR  E
000FD1 4FD1 37               4      SCF
000FD2 4FD2 C8              11      RET Z
000FD3 4FD3 C5              11      PUSH    BC
000FD4 4FD4 E5              11      PUSH    HL
000FD5 4FD5 CDB94F          17      CALL    NCL3
000FD8 4FD8 3809            12      JR  C,GNC1
000FDA 4FDA 5E               7      LD  E,(HL)
000FDB 4FDB 23               6      INC HL
000FDC 4FDC 7E               7      LD  A,(HL)
000FDD 4FDD E60F             7      AND 00FH
000FDF 4FDF 57               4      LD  D,A
000FE0 4FE0 E1              10      POP HL
000FE1 4FE1 C1              10      POP BC
000FE2 4FE2 C9              10      RET
       4FE3                     GNC1:
000FE3 4FE3 7E               7      LD  A,(HL)
000FE4 4FE4 23               6      INC HL
000FE5 4FE5 56               7      LD  D,(HL)
000FE6 4FE6 0604             7      LD  B,4
       4FE8                     GNC1L:
000FE8 4FE8 CB3A             8      SRL D
000FEA 4FEA 1F               4      RRA
000FEB 4FEB 10FB            13      DJNZ    GNC1L
                                
000FED 4FED 5F               4      LD  E,A
000FEE 4FEE E1              10      POP HL
000FEF 4FEF C1              10      POP BC
000FF0 4FF0 A7               4      AND A
000FF1 4FF1 C9              10      RET
                                
       4FF2                     CLUST:
000FF2 4FF2 EB               4      EX  DE,HL
       4FF3                     CLUST_HL:
000FF3 4FF3 2B               6      DEC HL
000FF4 4FF4 2B               6      DEC HL
000FF5 4FF5 C5              11      PUSH    BC
000FF6 4FF6 3AC7F2          13      LD  A,(CLSZ_H)
000FF9 4FF9 CD0056          17      CALL    MUL_AHL
                                
000FFC 4FFC CDC650          17      CALL    GET_DIR_POS
000FFF 4FFF 4F               4      LD  C,A
001000 5000 0600             7      LD  B,0
001002 5002 09              11      ADD HL,BC
                                
001003 5003 ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
001007 5007 CB38             8      SRL B
001009 5009 CB19             8      RR  C           ;/2
00100B 500B CB38             8      SRL B
00100D 500D CB19             8      RR  C           ;/4
00100F 500F CB38             8      SRL B
001011 5011 CB19             8      RR  C           ;/8
001013 5013 09              11      ADD HL,BC
                                #if exists USE_MORMAL32K_OR_ASCII16
001014 5014 7D               4      LD  A,L
001015 5015 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
001018 5018 09              11      ADD HL,BC
001019 5019 3013            12      JR  NC,CLUST2
00101B 501B 4D               4      LD  C,L     ;C=読み出し元
00101C 501C 29              11      ADD HL,HL   ;64KB→32KB
00101D 501D 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
00101E 501E CDDA55          17      CALL    GET_DISK_BANK_FDRV
001021 5021 84               4      ADD A,H
001022 5022 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
001025 5025 32C4F2          13      LD  (_BANK),A
001028 5028 69               4      LD  L,C     ;C=読み出し元
001029 5029 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
00102B 502B A5               4      AND L
00102C 502C C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB
                                    ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
                                    AND L
                                #endif
       502E                     CLUST2:
00102E 502E C660             7      ADD A,high BANK1_ADR
001030 5030 67               4      LD  H,A
001031 5031 2E00             7      LD  L,0
001033 5033 EB               4      EX  DE,HL
001034 5034 C1              10      POP BC
001035 5035 C9              10      RET
                                
       5036                     ENDCL:
001036 5036 7A               4      LD  A,D ;END CLUSTER
001037 5037 FE0F             7      CP  00FH    ;FAT12の最大値
001039 5039 C0              11      RET NZ
00103A 503A 7B               4      LD  A,E
00103B 503B FEF7             7      CP  0F7H
00103D 503D C9              10      RET
                                
       503E                     RB_READ:
00103E 503E AF               4      XOR A   ;HLA = HL*128
00103F 503F CB3C             8      SRL H
001041 5041 CB1D             8      RR  L
001043 5043 1F               4      RRA
001044 5044 32CAF2          13      LD  (RR_LOW),A
001047 5047 22CBF2          16      LD  (RR_MID),HL
00104A 504A 218000          10      LD  HL,128
                                
00104D 504D CDA14B          17      CALL    ROM_READ
001050 5050 C9              10      RET
                                
       5051                     GETSEQ:
001051 5051 FD6E20          19      LD  L,(IY+32)
001054 5054 FD660C          19      LD  H,(IY+12)
                                
001057 5057 CB25             8      SLA L
                                
001059 5059 CB3C             8      SRL H
00105B 505B CB1D             8      RR  L
00105D 505D C9              10      RET
                                
       505E                     SETSEQ:
00105E 505E F5              11      PUSH    AF
00105F 505F 3ACAF2          13      LD  A,(RR_LOW)
001062 5062 2ACBF2          16      LD  HL,(RR_MID)
                                
001065 5065 CD7C50          17      CALL    SSQ1
                                
001068 5068 29              11      ADD HL,HL
001069 5069 CB3D             8      SRL L
00106B 506B FD7520          19      LD  (IY+32),L
00106E 506E FD740C          19      LD  (IY+12),H
001071 5071 F1              10      POP AF
001072 5072 C9              10      RET
                                
       5073                     GETSIZE:
001073 5073 FD7E10          19      LD  A,(IY+16)
001076 5076 FD6E11          19      LD  L,(IY+17)
001079 5079 FD6612          19      LD  H,(IY+18)
       507C                     SSQ1:
00107C 507C 87               4      ADD A,A
00107D 507D ED6A            15      ADC HL,HL
00107F 507F B7               4      OR  A
001080 5080 C8              11      RET Z
001081 5081 23               6      INC HL
001082 5082 C9              10      RET
                                
       5083                     SET_FCB:
001083 5083 D5              11      PUSH    DE
001084 5084 FDE1            14      POP IY
001086 5086 FD7E1C          19      LD  A,(IY+28)
001089 5089 FEFF             7      CP  0FFH
00108B 508B 201B            12      JR  NZ,POPAF_SCF_FF_RET
00108D 508D E5              11      PUSH    HL
00108E 508E FD6E1A          19      LD  L,(IY+26)
001091 5091 FD661B          19      LD  H,(IY+27)
001094 5094 22CEF2          16      LD  (_CLPS),HL
001097 5097 FD7E1D          19      LD  A,(IY+29)
00109A 509A 32F1F2          13      LD  (_DIR_BANK),A
00109D 509D FD6E1E          19      LD  L,(IY+30)
0010A0 50A0 FD661F          19      LD  H,(IY+31)
0010A3 50A3 22EFF2          16      LD  (DIRENT1),HL
0010A6 50A6 E1              10      POP HL
0010A7 50A7 C9              10      RET
                                
       50A8                     POPAF_SCF_FF_RET:
0010A8 50A8 F1              10      POP AF
0010A9 50A9 37               4      SCF
0010AA 50AA 9F               4      SBC A,A
0010AB 50AB C9              10      RET
                                
       50AC                     GET_DIR_DAT:
0010AC 50AC 2AF9F2          16      LD  HL,(_CDX)
0010AF 50AF 7C               4      LD  A,H
0010B0 50B0 B5               4      OR  L
0010B1 50B1 2032            12      JR  NZ,GET_SUBDIR
0010B3 50B3 CDC650          17      CALL    GET_DIR_POS
0010B6 50B6 C660             7      ADD A,high BANK1_ADR
0010B8 50B8 2E00             7      LD  L,0
0010BA 50BA 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                    CALL    CHECK_DIR_PAGE
                                #endif
0010BB 50BB 3AC5F2          13      LD  A,(_BANK1)
0010BE 50BE 32F1F2          13      LD  (_DIR_BANK),A
                                
0010C1 50C1 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
0010C4 50C4 4F               4      LD  C,A
0010C5 50C5 C9              10      RET
                                
       50C6                     GET_DIR_POS:                ;ルートディレクトリ
0010C6 50C6 CDDA55          17      CALL    GET_DISK_BANK_FDRV
0010C9 50C9 32C5F2          13      LD  (_BANK1),A
0010CC 50CC 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
0010CF 50CF 47               4      LD  B,A
0010D0 50D0 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
0010D3 50D3 4F               4      LD  C,A
0010D4 50D4 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       50D7                     GET_DIR_POS1:
0010D7 50D7 81               4      ADD A,C
0010D8 50D8 10FD            13      DJNZ    GET_DIR_POS1
                                
0010DA 50DA ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
0010DE 50DE 37               4      SCF     ;無限ループ回避
       50DF                     L_MDP:
0010DF 50DF CB18             8      RR  B   ;->CF
0010E1 50E1 D8              11      RET C
0010E2 50E2 87               4      ADD A,A
0010E3 50E3 18FA            12      JR  L_MDP
                                
       50E5                     GET_SUBDIR:             ;サブディレクトリ
0010E5 50E5 CDF34F          17      CALL    CLUST_HL
0010E8 50E8 EB               4      EX  DE,HL
0010E9 50E9 3AC4F2          13      LD  A,(_BANK)
0010EC 50EC 32F1F2          13      LD  (_DIR_BANK),A
0010EF 50EF 3AC7F2          13      LD  A,(CLSZ_H)
0010F2 50F2 87               4      ADD A,A     ;*2
0010F3 50F3 87               4      ADD A,A     ;*4
0010F4 50F4 87               4      ADD A,A     ;*8
0010F5 50F5 4F               4      LD  C,A
0010F6 50F6 C9              10      RET
                                
       50F7                     STATEMENT:
0010F7 50F7 117B53          10      LD  DE,STR_CHDIR
0010FA 50FA CD6153          17      CALL    CPPROCNM
0010FD 50FD 2812            12      JR  Z,_CHDIR
0010FF 50FF 118153          10      LD  DE,STR_CHDRV
001102 5102 CD6153          17      CALL    CPPROCNM
001105 5105 281C            12      JR  Z,_CHDRV
001107 5107 118753          10      LD  DE,STR_RAMDISK
00110A 510A CD6153          17      CALL    CPPROCNM
00110D 510D 2829            12      JR  Z,_RAMDISK
00110F 510F 37               4      SCF
001110 5110 C9              10      RET
       5111                     _CHDIR:
001111 5111 7E               7      LD  A,(HL)
001112 5112 FE28             7      CP  '('
001114 5114 37               4      SCF
001115 5115 C0              11      RET NZ
001116 5116 CD4C49          17      CALL    INIT_PARAM
001119 5119 CD424C          17      CALL    FILE_B
00111C 511C CD6351          17      CALL    ROM_CD
00111F 511F D0              11      RET NC
001120 5120 C3EF47          10      JP  ERROR_FILE_NOT_FOUND
                                
       5123                     _CHDRV:
001123 5123 7E               7      LD  A,(HL)
001124 5124 FE28             7      CP  '('
001126 5126 37               4      SCF
001127 5127 C0              11      RET NZ
001128 5128 CD4C49          17      CALL    INIT_PARAM
00112B 512B E5              11      PUSH    HL
00112C 512C CD424C          17      CALL    FILE_B
00112F 512F E1              10      POP HL
001130 5130 23               6      INC HL
001131 5131 3A00F3          13      LD  A,(FDRV)
001134 5134 3D               4      DEC A
001135 5135 C35958          10      JP  _SYS0EX1
                                
       5138                     _RAMDISK:
001138 5138 7E               7      LD  A,(HL)
001139 5139 FE28             7      CP  '('
00113B 513B 37               4      SCF
00113C 513C C0              11      RET NZ
00113D 513D 23               6      INC HL
00113E 513E DD212F54        14      LD  IX,FRMQNT
001142 5142 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001146 5146 CD1C00          17      CALL    _CALSLT
001149 5149 E5              11      PUSH    HL
00114A 514A 110F00          10      LD  DE,15       ;切り上げの為
00114D 514D 19              11      ADD HL,DE
00114E 514E 7D               4      LD  A,L
00114F 514F 0604             7      LD  B,4     ;16で割る
       5151                     RAMDISK1:
001151 5151 CB3C             8      SRL H   ;/2
001153 5153 1F               4      RRA
001154 5154 10FB            13      DJNZ    RAMDISK1
001156 5156 FEFF             7      CP  0FFH
001158 5158 2001            12      JR  NZ,RAMDISK2
00115A 515A 3D               4      DEC A
       515B                     RAMDISK2:
00115B 515B 47               4      LD  B,A
00115C 515C CD8D5A          17      CALL    _SYS68
                                
00115F 515F E1              10      POP HL
001160 5160 23               6      INC HL
001161 5161 AF               4      XOR A
001162 5162 C9              10      RET
                                
       5163                     ROM_CD:
001163 5163 3A01F3          13      LD  A,(FNAME)
001166 5166 FE20             7      CP  020H
001168 5168 2835            12      JR  Z,CD1
00116A 516A CDE94D          17      CALL    ROM_OPEN
00116D 516D D8              11      RET C
                                #if exists USE_MORMAL32K_OR_ASCII16
00116E 516E D5              11      PUSH    DE
00116F 516F 2AEFF2          16      LD  HL,(DIRENT1)
001172 5172 110B00          10      LD  DE,0000BH   ;属性(アトリビュート)
001175 5175 19              11      ADD HL,DE
001176 5176 CDFE44          17      CALL    RDSLT_ROM
001179 5179 D1              10      POP DE
00117A 517A CB67             8      BIT 4,A     ;ディレクトリ
00117C 517C CAEF47          10      JP  Z,ERROR_FILE_NOT_FOUND
00117F 517F D5              11      PUSH    DE
001180 5180 2AEFF2          16      LD  HL,(DIRENT1)
001183 5183 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
001186 5186 19              11      ADD HL,DE
001187 5187 CDFE44          17      CALL    RDSLT_ROM
00118A 518A 23               6      INC HL
00118B 518B 5F               4      LD  E,A
00118C 518C CDFE44          17      CALL    RDSLT_ROM
00118F 518F 57               4      LD  D,A
001190 5190 EB               4      EX  DE,HL
001191 5191 D1              10      POP DE
                                #else
                                    LD  IY,(DIRENT1)
                                    BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    LD  L,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  H,(IY+01BH)
                                #endif
       5192                     CD2:
001192 5192 CDA755          17      CALL    SET_CD_FDRV
001195 5195 2AF7F2          16      LD  HL,(PARAM1)
       5198                     CD_SKIP:
001198 5198 7E               7      LD  A,(HL)
001199 5199 23               6      INC HL
00119A 519A FE21             7      CP  021H
00119C 519C 38FA            12      JR  C,CD_SKIP
00119E 519E C9              10      RET
       519F                     CD1:
00119F 519F 2AF9F2          16      LD  HL,(_CDX)
0011A2 51A2 18EE            12      JR  CD2
                                
       51A4                     GET_BASIC_FCB:
0011A4 51A4 D5              11      PUSH    DE
0011A5 51A5 23               6      INC HL  ;+1
0011A6 51A6 5E               7      LD  E,(HL)  ;FCB[1]
0011A7 51A7 23               6      INC HL  ;+2
0011A8 51A8 56               7      LD  D,(HL)  ;FCB[2]
0011A9 51A9 23               6      INC HL  ;+3
0011AA 51AA ED53EFF2        20      LD  (DIRENT1),DE
                                            ;FCB[3] backup char
0011AE 51AE 23               6      INC HL  ;+4
                                            ;FCB[4]
0011AF 51AF 23               6      INC HL  ;+5
0011B0 51B0 7E               7      LD  A,(HL)  ;FCB[5]
0011B1 51B1 23               6      INC HL  ;+6
0011B2 51B2 32F1F2          13      LD  (_DIR_BANK),A
0011B5 51B5 5E               7      LD  E,(HL)  ;FCB[6]
0011B6 51B6 23               6      INC HL  ;+7
0011B7 51B7 56               7      LD  D,(HL)  ;FCB[7]
0011B8 51B8 23               6      INC HL  ;+8
0011B9 51B9 ED53CAF2        20      LD  (RR_LOW),DE
0011BD 51BD 7E               7      LD  A,(HL)  ;FCB[8]
0011BE 51BE 23               6      INC HL  ;+9
0011BF 51BF 32CCF2          13      LD  (RR_HIGH),A
0011C2 51C2 22D4F2          16      LD  (_DTA),HL   ;FCB[9]
0011C5 51C5 D1              10      POP DE
0011C6 51C6 C9              10      RET
                                
       51C7                     SET_BASIC_FCB:
0011C7 51C7 E5              11      PUSH    HL
0011C8 51C8 2A64F8          16      LD  HL,(PTRFIL)
0011CB 51CB 23               6      INC HL  ;+1
0011CC 51CC D5              11      PUSH    DE
0011CD 51CD ED5BEFF2        20      LD  DE,(DIRENT1)
0011D1 51D1 73               7      LD  (HL),E  ;FCB[1]
0011D2 51D2 23               6      INC HL  ;+2
0011D3 51D3 72               7      LD  (HL),D  ;FCB[2]
0011D4 51D4 23               6      INC HL  ;+3
0011D5 51D5 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
0011D6 51D6 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
0011D7 51D7 23               6      INC HL  ;+5
0011D8 51D8 3AF1F2          13      LD  A,(_DIR_BANK)
0011DB 51DB 77               7      LD  (HL),A  ;FCB[5]
0011DC 51DC 23               6      INC HL  ;+6
0011DD 51DD ED5BCAF2        20      LD  DE,(RR_LOW)
0011E1 51E1 73               7      LD  (HL),E  ;FCB[6]
0011E2 51E2 23               6      INC HL  ;+7
0011E3 51E3 72               7      LD  (HL),D  ;FCB[7]
0011E4 51E4 23               6      INC HL  ;+8
0011E5 51E5 3ACCF2          13      LD  A,(RR_HIGH)
0011E8 51E8 77               7      LD  (HL),A  ;FCB[8]
0011E9 51E9 D1              10      POP DE
0011EA 51EA E1              10      POP HL
0011EB 51EB C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_18:BACKUP
                                ;in
                                ;   C : backup charactor
                                ;   HL: FBC pointer
                                ;out
       51EC                     DEVICE_18_BACKUP:
0011EC 51EC D5              11      PUSH    DE
0011ED 51ED E5              11      PUSH    HL
0011EE 51EE 110300          10      LD  DE,3
0011F1 51F1 19              11      ADD HL,DE
0011F2 51F2 71               7      LD  (HL),C
0011F3 51F3 E1              10      POP HL
0011F4 51F4 D1              10      POP DE
0011F5 51F5 C9              10      RET
                                
       51F6                     DEVICE_CHECK:
0011F6 51F6 3A8AFD          13      LD  A,(PROCNM+1)
0011F9 51F9 B7               4      OR  A
0011FA 51FA C8              11      RET Z
0011FB 51FB 118F53          10      LD  DE,STR_ROM
0011FE 51FE CD6153          17      CALL    CPPROCNM
001201 5201 2802            12      JR  Z,DEVICE_OK
001203 5203 37               4      SCF
001204 5204 C9              10      RET
       5205                     DEVICE_OK:
001205 5205 AF               4      XOR A
001206 5206 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファ
                                
       5207                     DEVICE_0_OPEN:
001207 5207 7B               4      LD  A,E
001208 5208 FE02             7      CP  2       ;FOR OUTPUT
00120A 520A 281B            12      JR  Z,OPEN2
00120C 520C D5              11      PUSH    DE
00120D 520D E5              11      push    hl
                                ;
00120E 520E 3E01             7      LD  A,1     ;ドライブA
001210 5210 3200F3          13      LD  (FDRV),A
001213 5213 2166F8          10      LD  HL,FILNAM
001216 5216 1101F3          10      LD  DE,FNAME
001219 5219 010B00          10      LD  BC,8+3
00121C 521C CDA15A          17      CALL    INIT_FILE1
00121F 521F CDE94D          17      CALL    ROM_OPEN
001222 5222 DAEF47          10      JP  C,ERROR_FILE_NOT_FOUND
001225 5225 E1              10      pop hl
001226 5226 D1              10      POP DE
       5227                     OPEN2:
001227 5227 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
00122A 522A 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
00122B 522B AF               4      XOR A
00122C 522C 32F3F2          13      LD  (LEFTX),A
00122F 522F CDC751          17      CALL    SET_BASIC_FCB
001232 5232 7B               4      ld  a,e
001233 5233 FE08             7      cp  8
001235 5235 3F               4      ccf
001236 5236 C9              10      ret
                                
       5237                     DEVICE_2_CLOSE:
001237 5237 AF               4      XOR A
                                ;   LD  (HL),A
001238 5238 6F               4      LD  L,A
001239 5239 67               4      LD  H,A
00123A 523A 2264F8          16      LD  (PTRFIL),HL
00123D 523D C9              10      RET
                                
       523E                     DEVICE_ENTRY:
00123E 523E FE08             7      CP  8
001240 5240 2826            12      JR  Z,DEVICE_8_SIN
001242 5242 3C               4      INC A
001243 5243 28B1            12      JR  Z,DEVICE_CHECK:
001245 5245 3D               4      DEC A
001246 5246 28BF            12      JR  Z,DEVICE_0_OPEN
001248 5248 FE0E             7      CP  14
00124A 524A 2860            12      JR  Z,DEVICE_14_EOF
00124C 524C FE04             7      CP  4
00124E 524E 2834            12      JR  Z,DEVICE_4_RANDOM
001250 5250 FE0A             7      CP  10
001252 5252 2850            12      JR  Z,DEVICE_10_LOC
001254 5254 FE0C             7      CP  12
001256 5256 2878            12      JR  Z,DEVICE_12_LOF
001258 5258 FE02             7      CP  2
00125A 525A 2890            12      JR  Z,DEVICE_18_BACKUP
00125C 525C FE02             7      CP  2
00125E 525E 28D7            12      JR  Z,DEVICE_2_CLOSE
001260 5260 FE06             7      CP  6
001262 5262 2802            12      JR  Z,DEVICE_6_SOUT
001264 5264 37               4      SCF
001265 5265 C9              10      RET
                                
       5266                     DEVICE_6_SOUT:
001266 5266 AF               4      XOR A
001267 5267 C9              10      RET
                                
       5268                     DEVICE_8_SIN:
001268 5268 CDA451          17      CALL    GET_BASIC_FCB
00126B 526B 210100          10      LD  HL,1
00126E 526E CDA14B          17      CALL    ROM_READ
001271 5271 7C               4      LD  A,H
001272 5272 B5               4      OR  L
001273 5273 280D            12      JR  Z,CCF_RET
001275 5275 2AD4F2          16      LD  HL,(_DTA)
001278 5278 7E               7      LD  A,(HL)
001279 5279 F5              11      PUSH    AF
00127A 527A CDC751          17      CALL    SET_BASIC_FCB
00127D 527D F1              10      POP AF
00127E 527E FE0A             7      CP  00AH
001280 5280 C8              11      RET Z   ;ZF=separate
                                ;   CP  01AH
                                ;   JR  Z,SCF_RET
001281 5281 37               4      SCF     ;
       5282                     CCF_RET:
001282 5282 3F               4      CCF     ;ZF=0 CF=0にしたい
001283 5283 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_4:RANDOM
                                ;in
                                ;   A : 4
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
       5284                     DEVICE_4_RANDOM:
001284 5284 D5              11      PUSH    DE
001285 5285 CDA451          17      CALL    GET_BASIC_FCB
001288 5288 DDE5            15      PUSH    IX
00128A 528A DD218A2F        14      LD  IX,FRCINT
00128E 528E FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001292 5292 CDB0F2          17      CALL    CAL_MP
001295 5295 DDE1            14      POP IX
001297 5297 2AF8F7          16      LD  HL,(DACDAT)
00129A 529A 22CAF2          16      LD  (RR_LOW),HL
00129D 529D AF               4      XOR A
00129E 529E CDC751          17      CALL    SET_BASIC_FCB
0012A1 52A1 D1              10      POP DE
0012A2 52A2 AF               4      XOR A
0012A3 52A3 C9              10      RET
                                
                                ;FUNC_10:LOC
                                ;in
                                ;   A : 10
                                ;out
                                ;   DAC    : value of received bytes
                                ;   VALTYP : DAC type
       52A4                     DEVICE_10_LOC:
0012A4 52A4 CDA451          17      CALL    GET_BASIC_FCB
0012A7 52A7 2ACAF2          16      LD  HL,(RR_LOW)
0012AA 52AA 1844            12      JR  RETURN_TYPE8_AHL
                                
                                ;--------------------------------------
                                ;FUNC_14:EOF
                                ;in
                                ;   A : 14
                                ;out
                                ;   DAC    : value of EOF value (EOF=-1)
                                ;   VALTYP : DAC type
       52AC                     DEVICE_14_EOF:
0012AC 52AC CDA451          17      CALL    GET_BASIC_FCB
0012AF 52AF CDC24E          17      CALL    RBX1
0012B2 52B2 3810            12      JR  C,DEVICE_14_EOF1
0012B4 52B4 210100          10      LD  HL,1
0012B7 52B7 CDA14B          17      CALL    ROM_READ
0012BA 52BA 2AD4F2          16      LD  HL,(_DTA)
0012BD 52BD 7E               7      LD  A,(HL)
0012BE 52BE FE1A             7      CP  01AH
0012C0 52C0 37               4      SCF
0012C1 52C1 2801            12      JR  Z,DEVICE_14_EOF1
0012C3 52C3 3F               4      CCF
       52C4                     DEVICE_14_EOF1:
0012C4 52C4 9F               4      SBC A,A
0012C5 52C5 6F               4      LD  L,A
0012C6 52C6 67               4      LD  H,A
       52C7                     return_type2_hl:
0012C7 52C7 22F8F7          16      ld  (DACDAT),hl
0012CA 52CA 3E02             7      ld  a,2
0012CC 52CC 3263F6          13      ld  (VALTYP),a
0012CF 52CF C9              10      ret
                                
                                ;--------------------------------------
                                ;FUNC_16:FPOS
                                ;in
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
                                ;   illegal function call
                                
                                ;--------------------------------------
                                ;FUNC_12:LOF
                                ;in
                                ;   A : 12
                                ;out
                                ;   DAC    : value of LOC+RSIQLN
                                ;   VALTYP : DAC type
       52D0                     DEVICE_12_LOF:
0012D0 52D0 CDA451          17      CALL    GET_BASIC_FCB
                                
0012D3 52D3 3AF1F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
0012D6 52D6 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
0012D9 52D9 D5              11      PUSH    DE
0012DA 52DA 2AEFF2          16      LD  HL,(DIRENT1)
0012DD 52DD 111C00          10      LD  DE,0001CH
0012E0 52E0 19              11      ADD HL,DE
0012E1 52E1 CDFE44          17      CALL    RDSLT_ROM
0012E4 52E4 23               6      INC HL
0012E5 52E5 5F               4      LD  E,A
0012E6 52E6 CDFE44          17      CALL    RDSLT_ROM
0012E9 52E9 23               6      INC HL
0012EA 52EA 57               4      LD  D,A
0012EB 52EB CDFE44          17      CALL    RDSLT_ROM
0012EE 52EE EB               4      EX  DE,HL       ;AHL=File size
0012EF 52EF D1              10      POP DE
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  L,(IY+01CH) ;AHL=File size
                                    LD  H,(IY+01DH)
                                    LD  A,(IY+01EH)
                                #endif
       52F0                     RETURN_TYPE8_AHL:
0012F0 52F0 B7               4      OR  A
0012F1 52F1 2004            12      JR  NZ,RT8AHL1
0012F3 52F3 CB7C             8      BIT 7,H
0012F5 52F5 28D0            12      JR  Z,return_type2_hl
       52F7                     RT8AHL1:
0012F7 52F7 E5              11      PUSH    HL
0012F8 52F8 29              11      ADD HL,HL
0012F9 52F9 8F               4      ADC A,A
0012FA 52FA 32F8F7          13      LD  (DACDAT),A
0012FD 52FD 3E00             7      LD  A,0
0012FF 52FF 8F               4      ADC A,A
001300 5300 32F9F7          13      LD  (DACDAT+1),A
                                
001303 5303 3E02             7      LD  A,2
001305 5305 3263F6          13      LD  (VALTYP),A
001308 5308 DD213A30        14      LD  IX,FRCDBL
00130C 530C FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001310 5310 CDB0F2          17      CALL    CAL_MP
                                
001313 5313 215953          10      LD  HL,DBL32768
001316 5316 1147F8          10      LD  DE,ARG
001319 5319 010800          10      LD  BC,8
00131C 531C EDB0                    LDIR
                                
00131E 531E DD21E627        14      LD  IX,DECMUL
001322 5322 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001326 5326 CDB0F2          17      CALL    CAL_MP
                                
001329 5329 21F6F7          10      LD  HL,DAC
00132C 532C 1147F8          10      LD  DE,ARG
00132F 532F 010800          10      LD  BC,8
001332 5332 EDB0                    LDIR
                                
001334 5334 E1              10      POP HL
001335 5335 22F8F7          16      LD  (DACDAT),HL
                                
001338 5338 3E02             7      LD  A,2
00133A 533A 3263F6          13      LD  (VALTYP),A
00133D 533D DD213A30        14      LD  IX,FRCDBL
001341 5341 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001345 5345 CDB0F2          17      CALL    CAL_MP
                                
001348 5348 DD219A26        14      LD  IX,DECADD
00134C 534C FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001350 5350 CDB0F2          17      CALL    CAL_MP
                                
001353 5353 3E08             7      LD  A,8
001355 5355 3263F6          13      LD  (VALTYP),A
001358 5358 C9              10      RET
                                
       5359                     DBL32768:
001359 5359 4532768000000000        DB  045H,032H,076H,080H,0,0,0,0
                                
       5361                     CPPROCNM:
001361 5361 E5              11      PUSH    HL
001362 5362 2189FD          10      LD  HL,PROCNM
       5365                     CPPROCNM1:
001365 5365 1A               7      LD  A,(DE)
001366 5366 13               6      INC DE
001367 5367 BE               7      CP  (HL)
001368 5368 23               6      INC HL
001369 5369 2003            12      JR  NZ,CPPROCNM2
00136B 536B B7               4      OR  A
00136C 536C 20F7            12      JR  NZ,CPPROCNM1
       536E                     CPPROCNM2:
00136E 536E E1              10      POP HL
00136F 536F C9              10      RET
                                
       5370                     WILDCARD:
001370 5370 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       537B                     STR_CHDIR:
00137B 537B 434844495200            DB  "CHDIR",0
       5381                     STR_CHDRV:
001381 5381 434844525600            DB  "CHDRV",0
       5387                     STR_RAMDISK:
001387 5387 52414D4449534B00        DB  "RAMDISK",0
       538F                     STR_ROM:
00138F 538F 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       5393                     ERROR_WRITE_PROTECTED:
001393 5393 3E00             7      LD  A,0     ;Write protected
001395 5395 C9              10      RET
       5396                     ERROR_NOT_READY:
001396 5396 F1              10      POP AF
001397 5397 37               4      SCF
001398 5398 3E02             7      LD  A,2     ;Not ready
00139A 539A C9              10      RET
       539B                     DISKIO:
00139B 539B 38F6            12      JR  C,ERROR_WRITE_PROTECTED
00139D 539D 48               4      LD  C,B
00139E 539E CDDD55          17      CALL    GET_DISK_BANK
0013A1 53A1 F5              11      PUSH    AF
0013A2 53A2 3AC9F2          13      LD  A,(SECSZ_H)
0013A5 53A5 B7               4      OR  A
0013A6 53A6 28EE            12      JR  Z,ERROR_NOT_READY
0013A8 53A8 F1              10      POP AF
       53A9                     SETMAP1:
0013A9 53A9 E5              11      PUSH    HL
       53AA                     DISKIO1:
0013AA 53AA C5              11      PUSH    BC      ;B=残りのセクタ数
0013AB 53AB D5              11      PUSH    DE      ;DE=セクタ番号
0013AC 53AC F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
0013AD 53AD EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
0013AE 53AE F5              11      PUSH    AF
0013AF 53AF 3AC9F2          13      LD  A,(SECSZ_H)
0013B2 53B2 CD0056          17      CALL    MUL_AHL
0013B5 53B5 F1              10      POP AF
                                #if exists USE_MORMAL32K_OR_ASCII16
0013B6 53B6 7D               4      LD  A,L
0013B7 53B7 C5              11      PUSH    BC
0013B8 53B8 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
0013BB 53BB 09              11      ADD HL,BC
0013BC 53BC C1              10      POP BC
0013BD 53BD 3013            12      JR  NC,DISKIO2
0013BF 53BF 4D               4      LD  C,L     ;C=読み出し元
0013C0 53C0 29              11      ADD HL,HL   ;64KB→32KB
0013C1 53C1 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
0013C2 53C2 CDDA55          17      CALL    GET_DISK_BANK_FDRV
0013C5 53C5 84               4      ADD A,H
0013C6 53C6 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
0013C9 53C9 32C4F2          13      LD  (_BANK),A
0013CC 53CC 69               4      LD  L,C     ;C=読み出し元
0013CD 53CD 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
0013CF 53CF A5               4      AND L
0013D0 53D0 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL       ;64KB→32KB
                                    ADD HL,HL       ;32KB→16KB
                                    ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  A,C     ;C=読み出し元
                                    AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       53D2                     DISKIO2:
0013D2 53D2 C660             7      ADD A,high BANK1_ADR
0013D4 53D4 67               4      LD  H,A
0013D5 53D5 ED4BC8F2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
0013D9 53D9 69               4      LD  L,C     ;C=0
0013DA 53DA CD0D45          17      CALL    ROM_LDIR
0013DD 53DD EB               4      EX  DE,HL
0013DE 53DE F1              10      POP AF
0013DF 53DF D1              10      POP DE
0013E0 53E0 13               6      INC DE
0013E1 53E1 C1              10      POP BC
0013E2 53E2 10C6            13      DJNZ    DISKIO1
0013E4 53E4 41               4      LD  B,C
                                
0013E5 53E5 E1              10      POP HL
0013E6 53E6 AF               4      XOR A
0013E7 53E7 C9              10      RET
                                
       53E8                     DSKCHG:
0013E8 53E8 CD2154          17      CALL    IS_BPB
0013EB 53EB 3824            12      JR  C,NOTREADY
0013ED 53ED 3A23FB          13      LD  A,(DRVTBL+2)
0013F0 53F0 B7               4      OR  A
0013F1 53F1 201A            12      JR  NZ,DSKCHG1
0013F3 53F3 3A21FB          13      LD  A,(DRVTBL)
0013F6 53F6 FE02             7      CP  2
0013F8 53F8 2013            12      JR  NZ,DSKCHG1
0013FA 53FA CD2154          17      CALL    IS_BPB
0013FD 53FD 300E            12      JR  NC,DSKCHG1
0013FF 53FF 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
001401 5401 3221FB          13      LD  (DRVTBL),A
001404 5404 3223FB          13      LD  (DRVTBL+2),A
001407 5407 3A48F3          13      LD  A,(MASTERS)
00140A 540A 3224FB          13      LD  (DRVTBL+3),A
       540D                     DSKCHG1:
00140D 540D AF               4      XOR A
00140E 540E 0601             7      LD  B,1
001410 5410 C9              10      RET
       5411                     NOTREADY:
001411 5411 3E02             7      LD  A,2
001413 5413 37               4      SCF
001414 5414 C9              10      RET
                                
       5415                     NO_BPB:
001415 5415 E1              10      POP HL
001416 5416 23               6      INC HL
001417 5417 110656          10      LD  DE,DPB2DD
00141A 541A 011200          10      LD  BC,DPB2DD_E-DPB2DD
00141D 541D EDB0                    LDIR
00141F 541F AF               4      XOR A
001420 5420 C9              10      RET
                                
       5421                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
001421 5421 CDDD55          17      CALL    GET_DISK_BANK
                                
001424 5424 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
001427 5427 FE01             7      CP  1
001429 5429 D8              11      RET C
                                
00142A 542A 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
00142D 542D C6FF             7      ADD A,0FFH
00142F 542F D8              11      RET C
                                
001430 5430 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       5433                     IS_BPB1:
001433 5433 FE01             7      CP  1
001435 5435 C8              11      RET Z
001436 5436 FE02             7      CP  2
001438 5438 C8              11      RET Z
001439 5439 FE04             7      CP  4
00143B 543B C8              11      RET Z
00143C 543C 37               4      SCF
00143D 543D C9              10      RET
                                
       543E                     GETDPB:
00143E 543E E5              11      PUSH    HL
00143F 543F CDDD55          17      CALL    GET_DISK_BANK
                                
001442 5442 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
001445 5445 B7               4      OR  A
001446 5446 28CD            12      JR  Z,NO_BPB
001448 5448 DDE1            14      POP IX
00144A 544A DD7701          19      LD  (IX+1),A        ;MEDIA
                                
00144D 544D 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
001450 5450 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
001453 5453 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
001456 5456 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
001459 5459 87               4      ADD A,A
00145A 545A 87               4      ADD A,A
00145B 545B 87               4      ADD A,A
00145C 545C 3D               4      DEC A
00145D 545D DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
001460 5460 06FF             7      LD  B,-1
001462 5462 A7               4      AND A           ;無限ループ阻止
       5463                     GETDPB1:
001463 5463 04               4      INC B
001464 5464 1F               4      RRA
001465 5465 38FC            12      JR  C,GETDPB1
001467 5467 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
00146A 546A 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
00146D 546D 3D               4      DEC A
00146E 546E DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
001471 5471 A7               4      AND A           ;無限ループ阻止
001472 5472 06FF             7      LD  B,-1
       5474                     GETDPB2:
001474 5474 04               4      INC B
001475 5475 1F               4      RRA
001476 5476 38FC            12      JR  C,GETDPB2
001478 5478 04               4      INC B
001479 5479 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
00147C 547C 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt
00147F 547F DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
001482 5482 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
001485 5485 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
001488 5488 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
00148B 548B 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
00148E 548E DD770B          19      LD  (IX+11),A       ;MAXENT
                                
001491 5491 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16
001495 5495 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
001498 5498 DD460A          19      LD  B,(IX+10)       ;FATCNT
00149B 549B 210000          10      LD  HL,0
       549E                     GETDPB3:
00149E 549E 19              11      ADD HL,DE
00149F 549F 10FD            13      DJNZ    GETDPB3
       54A1                     GETDPB4:
0014A1 54A1 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
0014A4 54A4 DD5609          19      LD  D,(IX+9)        ;FIRFAT
0014A7 54A7 19              11      ADD HL,DE
0014A8 54A8 DD7511          19      LD  (IX+17),L       ;FIRDIR
0014AB 54AB DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
0014AE 54AE DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0014B1 54B1 87               4      ADD A,A
0014B2 54B2 87               4      ADD A,A
0014B3 54B3 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       54B6                     GETDPB5:
0014B6 54B6 CB3B             8      SRL E
0014B8 54B8 1F               4      RRA
0014B9 54B9 30FB            12      JR  NC,GETDPB5
0014BB 54BB 1600             7      LD  D,0
0014BD 54BD 19              11      ADD HL,DE
0014BE 54BE DD750C          19      LD  (IX+12),L       ;FIRREC
0014C1 54C1 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
0014C4 54C4 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16
                                
0014C7 54C7 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
0014CA 54CA DD560D          19      LD  D,(IX+13)       ;FIRREC
0014CD 54CD A7               4      AND A
0014CE 54CE ED52            15      SBC HL,DE
                                
0014D0 54D0 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
0014D3 54D3 3C               4      INC A
0014D4 54D4 37               4      SCF             ;無限ループ阻止
       54D5                     GETDPB6:
0014D5 54D5 1F               4      RRA
0014D6 54D6 3806            12      JR  C,GETDPB7
0014D8 54D8 CB3C             8      SRL H
0014DA 54DA CB1D             8      RR  L
0014DC 54DC 18F7            12      JR  GETDPB6
       54DE                     GETDPB7:
0014DE 54DE 23               6      INC HL
0014DF 54DF DD750E          19      LD  (IX+14),L       ;MAXCLUS
0014E2 54E2 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       54E5                     GETDPBD1:
0014E5 54E5 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0014E8 54E8 E6FC             7      AND 0FCH
0014EA 54EA C8              11      RET Z
                                
0014EB 54EB DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
0014EF 54EF 37               4      SCF
0014F0 54F0 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
0014F4 54F4 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
0014F7 54F7 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
0014FB 54FB DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
0014FF 54FF DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
001503 5503 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
001507 5507 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
00150B 550B DDCB1126        23      SLA (IX+17)         ;FIRDIR
00150F 550F DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
001513 5513 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
001516 5516 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
001519 5519 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
00151C 551C 87               4      ADD A,A
00151D 551D 87               4      ADD A,A
00151E 551E DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       5521                     GETDPBD5:
001521 5521 CB3B             8      SRL E
001523 5523 1F               4      RRA
001524 5524 30FB            12      JR  NC,GETDPBD5
001526 5526 1600             7      LD  D,0
001528 5528 19              11      ADD HL,DE
001529 5529 DD750C          19      LD  (IX+12),L       ;FIRREC
00152C 552C DD740D          19      LD  (IX+13),H       ;FIRREC
                                
00152F 552F 18B4            12      JR  GETDPBD1
                                
       5531                     CHOICE:
001531 5531 210000          10      LD  HL,0
001534 5534 C9              10      RET
                                
       5535                     DSKFMT:
001535 5535 AF               4      XOR A
001536 5536 37               4      SCF
       5537                     DSKSTP:
001537 5537 C9              10      RET
                                
       5538                     BASENT:
001538 5538 3E                      DB  03EH
001539 5539 F7              12      RST 30H
00153A 553A 32DBFD          13      LD  (H_PINL),A
00153D 553D 3A48F3          13      LD  A,(MASTERS)
001540 5540 32DCFD          13      LD  (H_PINL+1),A
001543 5543 215F55          10      LD  HL,BOOT_BASIC
001546 5546 22DDFD          16      LD  (H_PINL+2),HL
001549 5549 3E                      DB  03EH
00154A 554A C9              10      RET
00154B 554B 32DFFD          13      LD  (H_PINL+4),A
                                
                                #if exists _RAM64K
00154E 554E 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
001551 5551 CD095D          17      CALL    ENASLT_00H
                                #endif
                                    ;BASICを起動する
001554 5554 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
001558 5558 DD21177D        14      LD  IX,ST_BAS   ;continue start of MSX-BASIC without executing BASIC programs in ROM
00155C 555C C35901          10      JP  CALBAS
                                
       555F                     BOOT_BASIC:
00155F 555F 3E                      DB  03EH
001560 5560 C9              10      RET
001561 5561 32DBFD          13      LD  (H_PINL),A
                                
001564 5564 2A74F6          16      LD  HL,(STKTOP)
001567 5567 3A40F3          13      LD  A,(REBOOT)
00156A 556A C6FF             7      ADD A,0FFH
00156C 556C 3811            12      JR  C,REBOOT1
00156E 556E 211856          10      LD  HL,AUTOEXEC
001571 5571 1100F3          10      LD  DE,FDRV
001574 5574 010C00          10      LD  BC,1+8+3
001577 5577 EDB0                    LDIR
001579 5579 CDE94D          17      CALL    ROM_OPEN
00157C 557C D43947          17      CALL    NC,ROM_LOAD1
       557F                     REBOOT1:
00157F 557F 212F56          10      LD  HL,DELOK
001582 5582 CDD344          17      CALL    MSX
001585 5585 212456          10      LD  HL,CMD_RUN
001588 5588 111FF4          10      LD  DE,KBUF
00158B 558B 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
00158E 558E D5              11      PUSH    DE
00158F 558F EDB0                    LDIR
001591 5591 3004            12      JR  NC,REBOOT2
001593 5593 AF               4      XOR A
001594 5594 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       5597                     REBOOT2:
001597 5597 E1              10      POP HL
001598 5598 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00159C 559C DD210146        14      LD  IX,NEWSTT
0015A0 55A0 C31C00          10      JP  _CALSLT
                                
       55A3                     GETSLT:
0015A3 55A3 3A22FB          13      LD  A,(DRVTBL+1)
0015A6 55A6 C9              10      RET
                                
       55A7                     SET_CD_FDRV:
0015A7 55A7 3A00F3          13      LD  A,(FDRV)
0015AA 55AA CDC955          17      CALL    GET_DRIVE
0015AD 55AD FE01             7      CP  1
0015AF 55AF 2804            12      JR  Z,SET_CD_B
0015B1 55B1 22EBF2          16      LD  (_CD_A),HL
0015B4 55B4 C9              10      RET
       55B5                     SET_CD_B:
0015B5 55B5 22EDF2          16      LD  (_CD_B),HL
0015B8 55B8 C9              10      RET
                                
       55B9                     GET_CD_CDRV:
0015B9 55B9 CDC955          17      CALL    GET_DRIVE
       55BC                     GET_CD:
0015BC 55BC FE01             7      CP  1
0015BE 55BE 2AEBF2          16      LD  HL,(_CD_A)
0015C1 55C1 C0              11      RET NZ
0015C2 55C2 2AEDF2          16      LD  HL,(_CD_B)
0015C5 55C5 C9              10      RET
                                
       55C6                     GET_DRIVE_FDRV:
0015C6 55C6 3A00F3          13      LD  A,(FDRV)
       55C9                     GET_DRIVE:
0015C9 55C9 D601             7      SUB 1
0015CB 55CB D0              11      RET NC
0015CC 55CC 3AEAF2          13      LD  A,(_DVSW)
0015CF 55CF C9              10      RET
                                
       55D0                     GET_DISK_BANK_H:
0015D0 55D0 3AF2F2          13      LD  A,(_LVECTOR)
0015D3 55D3 E680             7      AND 080H
0015D5 55D5 87               4      ADD A,A
0015D6 55D6 380A            12      JR  C,SET_DISK_BANK_A
0015D8 55D8 180F            12      JR  SET_DISK_BANK
       55DA                     GET_DISK_BANK_FDRV:
0015DA 55DA CDC655          17      CALL    GET_DRIVE_FDRV
       55DD                     GET_DISK_BANK:
0015DD 55DD FE07             7      CP  7       ;H:
0015DF 55DF 28EF            12      JR  Z,GET_DISK_BANK_H
0015E1 55E1 B7               4      OR  A       ;A=DRIVE
       55E2                     SET_DISK_BANK_A:
0015E2 55E2 3E01             7      LD  A,DISK_BANK
0015E4 55E4 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
0015E6 55E6 3AE9F2          13      LD  A,(B_DRIVE)
                                #endif
       55E9                     SET_DISK_BANK:
                                #if exists USE_MORMAL32K_OR_ASCII16
0015E9 55E9 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0015EC 55EC F5              11      PUSH    AF
0015ED 55ED E5              11      PUSH    HL
0015EE 55EE 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec
0015F1 55F1 22C8F2          16      LD  (SECSZ),HL
0015F4 55F4 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0015F7 55F7 CD0056          17      CALL    MUL_AHL
0015FA 55FA 22C6F2          16      LD  (CLSZ),HL
0015FD 55FD E1              10      POP HL
0015FE 55FE F1              10      POP AF
0015FF 55FF C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       5600                     MUL_AHL:
001600 5600 37               4      SCF     ;無限ループ回避
       5601                     MUL_AHL1:
001601 5601 1F               4      RRA     ;->CF
001602 5602 D8              11      RET C
001603 5603 29              11      ADD HL,HL
001604 5604 18FB            12      JR  MUL_AHL1
                                
       5606                     DPB2DD:
001606 5606 F9                      DB  0F9H    ;MEDIA
001607 5607 0002                    DW  00200H  ;SECSIZ
001609 5609 0F                      DB  00FH    ;DIRMSK
00160A 560A 04                      DB  004H    ;DIRSHFT
00160B 560B 01                      DB  001H    ;CLUSMSK
00160C 560C 02                      DB  002H    ;CLUSSHFT
00160D 560D 0100                    DW  00001H  ;FIRFAT
00160F 560F 02                      DB  002H    ;FATCNT
001610 5610 70                      DB  070H    ;MAXENT
001611 5611 0E00                    DW  0000EH  ;FIRREC
001613 5613 CA02                    DW  002CAH  ;MAXCLUS
001615 5615 03                      DB  003H    ;FATSIZ
001616 5616 0700                    DW  0007H   ;FIRDIR
       5618                     DPB2DD_E:
                                
       5618                     AUTOEXEC:
001618 5618 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       5624                     CMD_RUN:
001624 5624 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
00162A 562A 80EF                    DW  NEW_HIMEM
       562C                     CMD_CLEAR_E:
00162C 562C 3A8A00                  DB  03AH,08AH,0         ;RUN
       562F                     CMD_RUN_E:
       562F                     DELOK:
00162F 562F 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       5633                     _ERROR:
001633 5633 AF               4      XOR A
001634 5634 47               4      LD  B,A
001635 5635 C9              10      RET
                                
       5636                     ROM_BDOS:
001636 5636 E5              11      PUSH    HL
001637 5637 79               4      LD  A,C
001638 5638 87               4      ADD A,A
001639 5639 38F8            12      JR  C,_ERROR
00163B 563B 6F               4      LD  L,A
00163C 563C 265C             7      LD  H,high STABLE
00163E 563E 7E               7      LD  A,(HL)
00163F 563F 2C               4      INC L
001640 5640 66               7      LD  H,(HL)
001641 5641 6F               4      LD  L,A
001642 5642 E3              19      EX  (SP),HL
001643 5643 79               4      LD  A,C
001644 5644 C9              10      RET
                                
       5645                     _PRINT:
       5645                     PRINT:
001645 5645 7B               4      LD  A,E
001646 5646 1803            12      JR  MSG_A
                                
       5648                     _SYS01:     ;(BDOS)コンソール入力
001648 5648 CDCD56          17      CALL    _SYS07
       564B                     MSG_A:
00164B 564B FE03             7      CP  3
00164D 564D 2814            12      JR  Z,MSG_BR
       564F                     MSGA1:
00164F 564F F5              11      PUSH    AF
001650 5650 C5              11      PUSH    BC
001651 5651 D5              11      PUSH    DE
001652 5652 E5              11      PUSH    HL
001653 5653 DDE5            15      PUSH    IX
001655 5655 DD21A200        14      LD  IX,CHPUT
001659 5659 CDB444          17      CALL    CALSLT_R
00165C 565C DDE1            14      POP IX
00165E 565E E1              10      POP HL
00165F 565F D1              10      POP DE
001660 5660 C1              10      POP BC
       5661                     MSGA2:
001661 5661 F1              10      POP AF
001662 5662 C9              10      RET
       5663                     MSG_BR:
001663 5663 F5              11      PUSH    AF
001664 5664 3ADDF3          13      LD  A,(CSRX)
001667 5667 FE02             7      CP  2
001669 5669 38F6            12      JR  C,MSGA2
00166B 566B F1              10      POP AF
       566C                     MSG_CR:
00166C 566C F5              11      PUSH    AF
00166D 566D 3E0D             7      LD  A,00DH
00166F 566F CD4F56          17      CALL    MSGA1
001672 5672 3E0A             7      LD  A,00AH
001674 5674 CD4F56          17      CALL    MSGA1
001677 5677 F1              10      POP AF
001678 5678 C9              10      RET
                                
       5679                     _SYS02:     ;(BDOS)コンソール出力
001679 5679 CD9456          17      CALL    BREAK
00167C 567C 1805            12      JR  PRINTX
                                
       567E                     _SYS06:     ;(BDOS)コンソール直接入出力
00167E 567E 7B               4      LD  A,E
00167F 567F 3C               4      INC A
001680 5680 CAE156          10      JP  Z,_INKEY
       5683                     PRINTX:
001683 5683 C34556          10      JP  _PRINT
                                
       5686                     _SYS08:     ;(BDOS)エコーなしコンソール入力
001686 5686 CDCD56          17      CALL    _SYS07
001689 5689 FE03             7      CP  3
00168B 568B CC9456          17      CALL    Z,_BREAK
00168E 568E FE13             7      CP  013H        ;CTRL+S
001690 5690 C0              11      RET NZ
       5691                     PAUSE:
001691 5691 CDAB56          17      CALL    KEYBC
                                
       5694                     _BREAK:
       5694                     BREAK:
001694 5694 F5              11      PUSH    AF
001695 5695 C5              11      PUSH    BC
001696 5696 D5              11      PUSH    DE
001697 5697 E5              11      PUSH    HL
001698 5698 DDE5            15      PUSH    IX
00169A 569A DD21B700        14      LD  IX,BREAKX
00169E 569E CDB444          17      CALL    CALSLT_R
0016A1 56A1 DDE1            14      POP IX
0016A3 56A3 E1              10      POP HL
0016A4 56A4 D1              10      POP DE
0016A5 56A5 C1              10      POP BC
0016A6 56A6 DC9456          17      CALL    C,_BREAK
0016A9 56A9 F1              10      POP AF
0016AA 56AA C9              10      RET
       56AB                     KEYBC:
0016AB 56AB F5              11      PUSH    AF
0016AC 56AC C5              11      PUSH    BC
0016AD 56AD D5              11      PUSH    DE
0016AE 56AE E5              11      PUSH    HL
0016AF 56AF DDE5            15      PUSH    IX
0016B1 56B1 DD215601        14      LD  IX,KILBUF
0016B5 56B5 CDB444          17      CALL    CALSLT_R
0016B8 56B8 DDE1            14      POP IX
0016BA 56BA E1              10      POP HL
0016BB 56BB D1              10      POP DE
0016BC 56BC C1              10      POP BC
0016BD 56BD F1              10      POP AF
0016BE 56BE C9              10      RET
                                
       56BF                     _SYS09:     ;(BDOS)文字列出力
0016BF 56BF D5              11      PUSH    DE
       56C0                     _SX09:
0016C0 56C0 1A               7      LD  A,(DE)
0016C1 56C1 13               6      INC DE
0016C2 56C2 FE24             7      CP  '$'
0016C4 56C4 2805            12      JR  Z,POPDE_RET
0016C6 56C6 CD4B56          17      CALL    MSG_A
0016C9 56C9 18F5            12      JR  _SX09
       56CB                     POPDE_RET:
0016CB 56CB D1              10      POP DE
0016CC 56CC C9              10      RET
                                
       56CD                     _SYS07:
       56CD                     FLGET:
0016CD 56CD C5              11      PUSH    BC
0016CE 56CE D5              11      PUSH    DE
0016CF 56CF E5              11      PUSH    HL
0016D0 56D0 DDE5            15      PUSH    IX
0016D2 56D2 DD219F00        14      LD  IX,CHGET
0016D6 56D6 CDB444          17      CALL    CALSLT_R
0016D9 56D9 DDE1            14      POP IX
0016DB 56DB E1              10      POP HL
0016DC 56DC D1              10      POP DE
0016DD 56DD C1              10      POP BC
0016DE 56DE FE03             7      CP  3
0016E0 56E0 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       56E1                     _INKEY:
       56E1                     INKEY:
0016E1 56E1 CD2C57          17      CALL    CPM_CONST
0016E4 56E4 C8              11      RET Z
0016E5 56E5 18E6            12      JR  FLGET
                                
       56E7                     _SYS0A:     ;(BDOS)文字列入力
0016E7 56E7 C5              11      PUSH    BC
0016E8 56E8 E5              11      PUSH    HL
0016E9 56E9 D5              11      PUSH    DE
0016EA 56EA 3ADDF3          13      LD  A,(CSRX)
0016ED 56ED 5F               4      LD  E,A
0016EE 56EE 1600             7      LD  D,0
0016F0 56F0 D5              11      PUSH    DE
0016F1 56F1 DDE5            15      PUSH    IX
0016F3 56F3 DD21AE00        14      LD  IX,PLININ
0016F7 56F7 CDB444          17      CALL    CALSLT_R
0016FA 56FA DDE1            14      POP IX
0016FC 56FC D1              10      POP DE
0016FD 56FD 215DF5          10      LD  HL,BUF-1
001700 5700 F5              11      PUSH    AF
001701 5701 19              11      ADD HL,DE
001702 5702 F1              10      POP AF
001703 5703 EB               4      EX  DE,HL
001704 5704 E1              10      POP HL
001705 5705 E5              11      PUSH    HL
001706 5706 0E00             7      LD  C,0
001708 5708 3004            12      JR  NC,SAX0
00170A 570A 23               6      INC HL
00170B 570B 23               6      INC HL
00170C 570C 1808            12      JR  SAX4
       570E                     SAX0:
00170E 570E 46               7      LD  B,(HL)
00170F 570F 23               6      INC HL
       5710                     SAX1:
001710 5710 23               6      INC HL
001711 5711 1A               7      LD  A,(DE)
001712 5712 13               6      INC DE
001713 5713 B7               4      OR  A
001714 5714 2004            12      JR  NZ,SAX2
       5716                     SAX4:
001716 5716 360D            10      LD  (HL),00DH
001718 5718 1804            12      JR  SAX3
       571A                     SAX2:
00171A 571A 77               7      LD  (HL),A
00171B 571B 0C               4      INC C
00171C 571C 10F2            13      DJNZ    SAX1
       571E                     SAX3:
00171E 571E D1              10      POP DE
00171F 571F 79               4      LD  A,C
001720 5720 13               6      INC DE
001721 5721 12               7      LD  (DE),A
001722 5722 1B               6      DEC DE
001723 5723 E1              10      POP HL
001724 5724 C1              10      POP BC
001725 5725 3E1E             7      LD  A,01EH
001727 5727 CD4B56          17      CALL    MSG_A
00172A 572A AF               4      XOR A
00172B 572B C9              10      RET
                                
       572C                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       572C                     CONSTX:
       572C                     CPM_CONST:
00172C 572C C5              11      PUSH    BC
00172D 572D D5              11      PUSH    DE
00172E 572E E5              11      PUSH    HL
00172F 572F DDE5            15      PUSH    IX
001731 5731 DD219C00        14      LD  IX,CHSNS
001735 5735 CDB444          17      CALL    CALSLT_R
001738 5738 DDE1            14      POP IX
00173A 573A E1              10      POP HL
00173B 573B D1              10      POP DE
00173C 573C C1              10      POP BC
00173D 573D C9              10      RET
                                
       573E                     _SYS2A:     ;(BDOS)日付の獲得
00173E 573E 0E0B             7      LD  C,11        ;年/Year→HL
001740 5740 CD7F57          17      CALL    RDCLK_BCD
001743 5743 6F               4      LD  L,A
001744 5744 2600             7      LD  H,0
001746 5746 3AF8FA          13      LD  A,(EXBRSA)
001749 5749 B7               4      OR  A
00174A 574A 2804            12      JR  Z,SX2A1
00174C 574C 11BC07          10      LD  DE,1980     ;1980年～2079年
00174F 574F 19              11      ADD HL,DE
       5750                     SX2A1:
001750 5750 0E09             7      LD  C,9     ;月/Month→D
001752 5752 CD7F57          17      CALL    RDCLK_BCD
001755 5755 57               4      LD  D,A
                                
001756 5756 0E07             7      LD  C,7     ;日/Day→E
001758 5758 CD7F57          17      CALL    RDCLK_BCD
00175B 575B 5F               4      LD  E,A
                                
00175C 575C 0E06             7      LD  C,6     ;曜日/Week→A
       575E                     RDCLK:
00175E 575E DDE5            15      PUSH    IX
001760 5760 DD21F501        14      LD  IX,REDCLK
       5764                     WRCLK1:
001764 5764 3AF8FA          13      LD  A,(EXBRSA)
001767 5767 B7               4      OR  A
001768 5768 280A            12      JR  Z,RDCLK1    ;MSX1
00176A 576A FDE5            15      PUSH    IY
00176C 576C FD67             9      LD  IYH,A
00176E 576E 78               4      LD  A,B
00176F 576F CD1C00          17      CALL    _CALSLT
001772 5772 FDE1            14      POP IY
       5774                     RDCLK1:
001774 5774 DDE1            14      POP IX
001776 5776 C9              10      RET
       5777                     WRCLK:
001777 5777 DDE5            15      PUSH    IX
001779 5779 DD21F901        14      LD  IX,WRTCLK
00177D 577D 18E5            12      JR  WRCLK1
                                
       577F                     RDCLK_BCD:
00177F 577F CD5E57          17      CALL    RDCLK       ;1の位
001782 5782 47               4      LD  B,A
001783 5783 0C               4      INC C
001784 5784 CD5E57          17      CALL    RDCLK       ;10の位
001787 5787 87               4      ADD A,A     ;*2
001788 5788 4F               4      LD  C,A
001789 5789 87               4      ADD A,A     ;*4
00178A 578A 87               4      ADD A,A     ;*8
00178B 578B 81               4      ADD A,C     ;*10(8+2)
00178C 578C 80               4      ADD A,B     ;1の位
00178D 578D C9              10      RET
                                
       578E                     _SYS2C:     ;(BDOS)時刻の獲得
00178E 578E 011501          10      LD  BC,00115H       ;12時間計/24時間計の設定を24時間計に
001791 5791 CD7757          17      CALL    WRCLK
001794 5794 0E04             7      LD  C,4     ;H=時/Hour
001796 5796 CD7F57          17      CALL    RDCLK_BCD
001799 5799 67               4      LD  H,A
00179A 579A 0E02             7      LD  C,2     ;L=分/Minute
00179C 579C CD7F57          17      CALL    RDCLK_BCD
00179F 579F 6F               4      LD  L,A
0017A0 57A0 0E00             7      LD  C,0     ;D=秒/Second
0017A2 57A2 CD7F57          17      CALL    RDCLK_BCD
0017A5 57A5 57               4      LD  D,A
0017A6 57A6 AF               4      XOR A       ;E=1/100秒
0017A7 57A7 5F               4      LD  E,A
0017A8 57A8 C9              10      RET
                                
       57A9                     POS:
0017A9 57A9 F5              11      PUSH    AF
0017AA 57AA 2ADCF3          16      LD  HL,(CSRY)
0017AD 57AD 7D               4      LD  A,L
0017AE 57AE 6C               4      LD  L,H
0017AF 57AF 67               4      LD  H,A
0017B0 57B0 2C               4      INC L
0017B1 57B1 24               4      INC H
0017B2 57B2 F1              10      POP AF
0017B3 57B3 C9              10      RET
                                
       57B4                     LOC:
0017B4 57B4 F5              11      PUSH    AF
0017B5 57B5 E5              11      PUSH    HL
0017B6 57B6 7D               4      LD  A,L
0017B7 57B7 6C               4      LD  L,H
0017B8 57B8 67               4      LD  H,A
0017B9 57B9 2D               4      DEC L
0017BA 57BA 25               4      DEC H
0017BB 57BB DDE5            15      PUSH    IX
0017BD 57BD DD21C600        14      LD  IX,POSIT
0017C1 57C1 CDB444          17      CALL    CALSLT_R
0017C4 57C4 DDE1            14      POP IX
0017C6 57C6 E1              10      POP HL
0017C7 57C7 F1              10      POP AF
0017C8 57C8 C9              10      RET
                                
       57C9                     _SCRN:
       57C9                     SCRN:
0017C9 57C9 E5              11      PUSH    HL
0017CA 57CA DDE5            15      PUSH    IX
                                
0017CC 57CC 69               4      LD  L,C
0017CD 57CD 60               4      LD  H,B
0017CE 57CE DD214A00        14      LD  IX,RDVRM
0017D2 57D2 CDB444          17      CALL    CALSLT_R
                                
0017D5 57D5 DDE1            14      POP IX
0017D7 57D7 E1              10      POP HL
0017D8 57D8 C9              10      RET
                                
       57D9                     CTRL02:
0017D9 57D9 F5              11      PUSH    AF
0017DA 57DA D5              11      PUSH    DE
0017DB 57DB 2ADCF3          16      LD  HL,(CSRY)
0017DE 57DE 3AB0F3          13      LD  A,(LINLEN)
0017E1 57E1 4F               4      LD  C,A
0017E2 57E2 94               4      SUB H   ;CSRX
0017E3 57E3 C602             7      ADD A,2
0017E5 57E5 47               4      LD  B,A ;カーソルより右の文字数
0017E6 57E6 61               4      LD  H,C ;LINLEN
0017E7 57E7 C5              11      PUSH    BC
0017E8 57E8 CD3658          17      CALL    LOC0
0017EB 57EB C1              10      POP BC
                                
0017EC 57EC 1620             7      LD  D,020H
       57EE                     C8X1:
0017EE 57EE DD214A00        14      LD  IX,RDVRM
0017F2 57F2 CDB444          17      CALL    CALSLT_R
0017F5 57F5 4F               4      LD  C,A
0017F6 57F6 7A               4      LD  A,D
0017F7 57F7 DD214D00        14      LD  IX,WRTVRM
0017FB 57FB CDB444          17      CALL    CALSLT_R
0017FE 57FE 2B               6      DEC HL
0017FF 57FF 51               4      LD  D,C
001800 5800 10EC            13      DJNZ    C8X1
001802 5802 D1              10      POP DE
001803 5803 F1              10      POP AF
001804 5804 C9              10      RET
                                
       5805                     INSERT:
001805 5805 F5              11      PUSH    AF
001806 5806 D5              11      PUSH    DE
001807 5807 2ADCF3          16      LD  HL,(CSRY)
00180A 580A 3AB0F3          13      LD  A,(LINLEN)
00180D 580D 4F               4      LD  C,A
00180E 580E 94               4      SUB H   ;CSRX
00180F 580F 3C               4      INC A
001810 5810 47               4      LD  B,A ;カーソルより右の文字数
001811 5811 C5              11      PUSH    BC
001812 5812 CD3658          17      CALL    LOC0
001815 5815 C1              10      POP BC
                                
001816 5816 1620             7      LD  D,020H
       5818                     INS1:
001818 5818 DD214A00        14      LD  IX,RDVRM
00181C 581C CDB444          17      CALL    CALSLT_R
00181F 581F 4F               4      LD  C,A
001820 5820 7A               4      LD  A,D
001821 5821 DD214D00        14      LD  IX,WRTVRM
001825 5825 CDB444          17      CALL    CALSLT_R
001828 5828 23               6      INC HL
001829 5829 51               4      LD  D,C
00182A 582A 10EC            13      DJNZ    INS1
00182C 582C D1              10      POP DE
00182D 582D F1              10      POP AF
00182E 582E C9              10      RET
                                
       582F                     CONOUT1:
00182F 582F 59               4      LD  E,C
001830 5830 C34556          10      JP  _PRINT
                                
       5833                     GETVRAM:
001833 5833 2ADCF3          16      LD  HL,(CSRY)
       5836                     LOC0:
001836 5836 2D               4      DEC L
001837 5837 25               4      DEC H
001838 5838 4C               4      LD  C,H ;CSRX-1
001839 5839 5D               4      LD  E,L ;CSRY-1
       583A                     LOC1:
00183A 583A 3AB0F3          13      LD  A,(LINLEN)
00183D 583D 67               4      LD  H,A
00183E 583E 1600             7      LD  D,0
001840 5840 6A               4      LD  L,D ;0
001841 5841 0608             7      LD  B,8
       5843                     LOC2:
001843 5843 29              11      ADD HL,HL
001844 5844 3001            12      JR  NC,LOC3
001846 5846 19              11      ADD HL,DE
       5847                     LOC3:
001847 5847 10FA            13      DJNZ    LOC2
001849 5849 09              11      ADD HL,BC
00184A 584A C9              10      RET
                                
       584B                     _SYS0C:     ;(BDOS)バージョン番号の獲得
00184B 584B 212200          10      LD  HL,00022H
00184E 584E AF               4      XOR A
00184F 584F 7D               4      LD  A,L
001850 5850 C9              10      RET
                                
       5851                     _SYS0D:     ;(BDOS)ディスク・リセット
001851 5851 218000          10      LD  HL,00080H
001854 5854 22D4F2          16      LD  (_DTA),HL
001857 5857 C9              10      RET
                                
       5858                     _SYS0E:     ;(BDOS)カレントドライブの設定
001858 5858 7B               4      LD  A,E
       5859                     _SYS0EX1:
001859 5859 FE08             7      CP  8
00185B 585B 3F               4      CCF
00185C 585C D8              11      RET C
00185D 585D 32EAF2          13      LD  (_DVSW),A
001860 5860 C9              10      RET
                                
       5861                     _SYS0F:     ;(BDOS)ファイルのオープン
001861 5861 D5              11      PUSH    DE
001862 5862 FDE1            14      POP IY
001864 5864 CD9A5A          17      CALL    INIT_FILE
001867 5867 CDE94D          17      CALL    ROM_OPEN
00186A 586A 385F            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
00186C 586C FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
001870 5870 FDE5            15      PUSH    IY
001872 5872 D1              10      POP DE
001873 5873 13               6      INC DE
001874 5874 010B00          10      LD  BC,11
001877 5877 EDB0                    LDIR
                                ;               Attribute
001879 5879 7E               7      LD  A,(HL)
00187A 587A FD770D          19      LD  (IY+13),A
                                ;               TIME
00187D 587D 110B00          10      LD  DE,11
001880 5880 19              11      ADD HL,DE
001881 5881 7E               7      LD  A,(HL)
001882 5882 23               6      INC HL
001883 5883 FD7716          19      LD  (IY+22),A
001886 5886 7E               7      LD  A,(HL)
001887 5887 23               6      INC HL
001888 5888 FD7717          19      LD  (IY+23),A
                                ;               DATE
00188B 588B 7E               7      LD  A,(HL)
00188C 588C 23               6      INC HL
00188D 588D FD7714          19      LD  (IY+20),A
001890 5890 7E               7      LD  A,(HL)
001891 5891 23               6      INC HL
001892 5892 FD7715          19      LD  (IY+21),A
                                ;               First cluster
001895 5895 7E               7      LD  A,(HL)
001896 5896 23               6      INC HL
001897 5897 FD771A          19      LD  (IY+26),A
00189A 589A 7E               7      LD  A,(HL)
00189B 589B 23               6      INC HL
00189C 589C FD771B          19      LD  (IY+27),A
                                ;               SIZE
00189F 589F 7E               7      LD  A,(HL)
0018A0 58A0 23               6      INC HL
0018A1 58A1 FD7710          19      LD  (IY+16),A
0018A4 58A4 7E               7      LD  A,(HL)
0018A5 58A5 23               6      INC HL
0018A6 58A6 FD7711          19      LD  (IY+17),A
0018A9 58A9 7E               7      LD  A,(HL)
0018AA 58AA 23               6      INC HL
0018AB 58AB FD7712          19      LD  (IY+18),A
0018AE 58AE 7E               7      LD  A,(HL)
0018AF 58AF FD7713          19      LD  (IY+19),A
0018B2 58B2 2AEFF2          16      LD  HL,(DIRENT1)
0018B5 58B5 FD751E          19      LD  (IY+30),L
0018B8 58B8 FD741F          19      LD  (IY+31),H
0018BB 58BB 3AF1F2          13      LD  A,(_DIR_BANK)
0018BE 58BE FD771D          19      LD  (IY+29),A
0018C1 58C1 AF               4      XOR A
0018C2 58C2 FD770C          19      LD  (IY+12),A
0018C5 58C5 C9              10      RET
                                
       58C6                     _SYS10:     ;(BDOS)ファイルのクローズ
0018C6 58C6 AF               4      XOR A
0018C7 58C7 C9              10      RET
                                
       58C8                     S11X1:
0018C8 58C8 FD7119          19      LD  (IY+25),C       ;RootEntCnt
       58CB                     SCF_FF_RET:
0018CB 58CB 37               4      SCF
0018CC 58CC 9F               4      SBC A,A
0018CD 58CD C9              10      RET
                                
       58CE                     _SYS11:     ;(BDOS)最初のファイルの検索
0018CE 58CE ED53D7F2        20      LD  (_FCB),DE
0018D2 58D2 D5              11      PUSH    DE
0018D3 58D3 FDE1            14      POP IY
0018D5 58D5 CD9A5A          17      CALL    INIT_FILE
0018D8 58D8 FD361800        19      LD  (IY+24),0
0018DC 58DC CDAC50          17      CALL    GET_DIR_DAT
       58DF                     S12X1:
0018DF 58DF CD5D4E          17      CALL    FILESE
0018E2 58E2 FD3418          23      INC (IY+24)
0018E5 58E5 30E1            12      JR  NC,S11X1
0018E7 58E7 0D               4      DEC C
0018E8 58E8 FD7119          19      LD  (IY+25),C       ;RootEntCnt
0018EB 58EB FDCB0D66        20      BIT 4,(IY+13)
0018EF 58EF 280A            12      JR  Z,S12X2
0018F1 58F1 E5              11      PUSH    HL
0018F2 58F2 DDE1            14      POP IX
0018F4 58F4 DD7E0B          19      LD  A,(IX+11)
0018F7 58F7 FE0F             7      CP  00FH
0018F9 58F9 2810            12      JR  Z,S11NEXT
       58FB                     S12X2:
0018FB 58FB 012000          10      LD  BC,32
0018FE 58FE ED5BD4F2        20      LD  DE,(_DTA)
001902 5902 FD7E00          19      LD  A,(IY+0)
001905 5905 12               7      LD  (DE),A      ;ドライブ番号
001906 5906 13               6      INC DE
001907 5907 EDB0                    LDIR            ;ディレクトリエントリ
001909 5909 AF               4      XOR A
00190A 590A C9              10      RET
       590B                     S11NEXT:
00190B 590B CD7B4E          17      CALL    FNEXT
00190E 590E 20CF            12      JR  NZ,S12X1
001910 5910 37               4      SCF
001911 5911 9F               4      SBC A,A
001912 5912 C9              10      RET
                                
       5913                     _SYS12:
001913 5913 FD2AD7F2        20      LD  IY,(_FCB)
001917 5917 FDE5            15      PUSH    IY
001919 5919 D1              10      POP DE
00191A 591A CD9A5A          17      CALL    INIT_FILE
       591D                     S12X3:
00191D 591D CDAC50          17      CALL    GET_DIR_DAT
001920 5920 FD4618          19      LD  B,(IY+24)
       5923                     S12X4:
001923 5923 C5              11      PUSH    BC
001924 5924 CD7B4E          17      CALL    FNEXT
001927 5927 C1              10      POP BC
001928 5928 2802            12      JR  Z,S12X5
00192A 592A 10F7            13      DJNZ    S12X4
       592C                     S12X5:
00192C 592C FD4E19          19      LD  C,(IY+25)
00192F 592F 18AE            12      JR  S12X1
                                
       5931                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
001931 5931 CD8350          17      CALL    SET_FCB
001934 5934 CD5150          17      CALL    GETSEQ
001937 5937 CD3E50          17      CALL    RB_READ
00193A 593A E5              11      PUSH    HL
00193B 593B CD5E50          17      CALL    SETSEQ
00193E 593E E1              10      POP HL
       593F                     SREAD:
00193F 593F C601             7      ADD A,001H
001941 5941 D8              11      RET C
                                
001942 5942 7D               4      LD  A,L
001943 5943 D601             7      SUB 001H
001945 5945 9F               4      SBC A,A
001946 5946 E603             7      AND 3
001948 5948 1F               4      RRA
001949 5949 C9              10      RET
                                
       594A                     _SYS18:     ;(BDOS)ログインベクトルの獲得
       594A                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
00194A 594A 2AF2F2          16      LD  HL,(_LVECTOR)
00194D 594D AF               4      XOR A
00194E 594E 67               4      LD  H,A
00194F 594F C9              10      RET
                                
       5950                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
001950 5950 3AEAF2          13      LD  A,(_DVSW)
001953 5953 A7               4      AND A
001954 5954 C9              10      RET
                                
       5955                     _SYS1A:     ;(BDOS)DTAの設定
001955 5955 ED53D4F2        20      LD  (_DTA),DE
001959 5959 AF               4      XOR A
00195A 595A C9              10      RET
                                
       595B                     _SYS1B:     ;(BDOS)ディスク情報の獲得
00195B 595B 7B               4      LD  A,E
00195C 595C D601             7      SUB 1
00195E 595E DC5059          17      CALL    C,_SYS19
001961 5961 5F               4      LD  E,A
001962 5962 CD2154          17      CALL    IS_BPB
001965 5965 3827            12      JR  C,S1B_E
001967 5967 F5              11      PUSH    AF
001968 5968 215EF5          10      LD  HL,SYS1B_DPB
00196B 596B 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
00196E 596E 47               4      LD  B,A
00196F 596F 4F               4      LD  C,A
001970 5970 3271F5          13      LD  (SYS1B_FAT),A
001973 5973 7B               4      LD  A,E
001974 5974 CD3E54          17      CALL    GETDPB
001977 5977 DD215EF5        14      LD  IX,SYS1B_DPB
00197B 597B FD2171F5        14      LD  IY,SYS1B_FAT
00197F 597F ED4B60F5        20      LD  BC,(SYS1B_DPB+1+1)  ;SECSIZ
001983 5983 ED5B6CF5        20      LD  DE,(SYS1B_DPB+1+13) ;MAXCLUS
001987 5987 1B               6      DEC DE
001988 5988 1B               6      DEC DE
001989 5989 210000          10      LD  HL,0            ;書き込み不可なので0を返す
00198C 598C F1              10      POP AF
00198D 598D C9              10      RET
       598E                     S1B_E:
00198E 598E 9F               4      SBC A,A
00198F 598F C9              10      RET
                                
       5990                     _SYS21:     ;(BDOS)ランダムな読み出し
001990 5990 CD8350          17      CALL    SET_FCB
                                
001993 5993 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001996 5996 FD6622          19      LD  H,(IY+34)
                                
001999 5999 CD3E50          17      CALL    RB_READ
00199C 599C 18A1            12      JR  SREAD
                                
       599E                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
00199E 599E CD6158          17      CALL    _SYS0F
0019A1 59A1 D8              11      RET C
                                
0019A2 59A2 D5              11      PUSH    DE      ;EX DE,IY
0019A3 59A3 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0019A5 59A5 CD7350          17      CALL    GETSIZE
       59A8                     _S24X1:
0019A8 59A8 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
0019AB 59AB FD7422          19      LD  (IY+34),H
0019AE 59AE FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
0019B2 59B2 FDE3            23      EX  (SP),IY     ;
0019B4 59B4 D1              10      POP DE      ;
                                
0019B5 59B5 AF               4      XOR A
0019B6 59B6 C9              10      RET
                                
       59B7                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
0019B7 59B7 E5              11      PUSH    HL
0019B8 59B8 D5              11      PUSH    DE      ;EX DE,IY
0019B9 59B9 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0019BB 59BB CD5150          17      CALL    GETSEQ
0019BE 59BE 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       59C0                     _SYS27:     ;(BDOS)ランダムブロック読み込み
0019C0 59C0 CD8350          17      CALL    SET_FCB
0019C3 59C3 E5              11      PUSH    HL
0019C4 59C4 FD7E00          19      LD  A,(IY+0)
0019C7 59C7 3200F3          13      LD  (FDRV),A
0019CA 59CA FD7E18          19      LD  A,(IY+24)
0019CD 59CD 32C4F2          13      LD  (_BANK),A
0019D0 59D0 FD6E21          19      LD  L,(IY+33)
0019D3 59D3 FD6622          19      LD  H,(IY+34)
0019D6 59D6 22CAF2          16      LD  (RR_LOW),HL
0019D9 59D9 FD6E23          19      LD  L,(IY+35)
0019DC 59DC FD6624          19      LD  H,(IY+36)
0019DF 59DF 22CCF2          16      LD  (RR_HIGH),HL
0019E2 59E2 E1              10      POP HL
0019E3 59E3 CDA14B          17      CALL    ROM_READ
0019E6 59E6 ED5BCAF2        20      LD  DE,(RR_LOW)
0019EA 59EA FD7321          19      LD  (IY+33),E
0019ED 59ED FD7222          19      LD  (IY+34),D
0019F0 59F0 ED5BCCF2        20      LD  DE,(RR_HIGH)
0019F4 59F4 FD7323          19      LD  (IY+35),E
0019F7 59F7 FD7224          19      LD  (IY+36),D
0019FA 59FA 3AC4F2          13      LD  A,(_BANK)
0019FD 59FD FD7718          19      LD  (IY+24),A
001A00 5A00 9F               4      SBC A,A
001A01 5A01 D8              11      RET C
001A02 5A02 3AC3F2          13      LD  A,(_RESULT)
001A05 5A05 C9              10      RET
                                
       5A06                     _SYS29:
001A06 5A06 E5              11      PUSH    HL
001A07 5A07 23               6      INC HL
001A08 5A08 CD505A          17      CALL    _SYS5C
001A0B 5A0B E3              19      EX  (SP),HL
001A0C 5A0C 79               4      LD  A,C
001A0D 5A0D CD035B          17      CALL    LD_HL_A
001A10 5A10 010E00          10      LD  BC,14
001A13 5A13 09              11      ADD HL,BC
001A14 5A14 C1              10      POP BC
001A15 5A15 03               6      INC BC
001A16 5A16 79               4      LD  A,C
001A17 5A17 CD035B          17      CALL    LD_HL_A
001A1A 5A1A 23               6      INC HL
001A1B 5A1B 78               4      LD  A,B
001A1C 5A1C CD035B          17      CALL    LD_HL_A
001A1F 5A1F AF               4      XOR A
001A20 5A20 C9              10      RET
                                
       5A21                     _SYS2F:
001A21 5A21 44               4      LD  B,H
001A22 5A22 7D               4      LD  A,L
001A23 5A23 2AD4F2          16      LD  HL,(_DTA)
001A26 5A26 C39B53          10      JP  DISKIO
                                
       5A29                     _SYS59:     ;(BDOS)カレントディレクトリの取得
001A29 5A29 78               4      LD  A,B
001A2A 5A2A CDB955          17      CALL    GET_CD_CDRV
001A2D 5A2D 7C               4      LD  A,H
001A2E 5A2E B5               4      OR  L
001A2F 5A2F 2808            12      JR  Z,S59E
001A31 5A31 3E23             7      LD  A,'#'
001A33 5A33 12               7      LD  (DE),A
001A34 5A34 13               6      INC DE
001A35 5A35 CD1D5B          17      CALL    HEXHL
001A38 5A38 AF               4      XOR A
       5A39                     S59E:
001A39 5A39 12               7      LD  (DE),A
001A3A 5A3A C9              10      RET
                                
       5A3B                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
001A3B 5A3B CDCD5A          17      CALL    GET_PARAM_IX
001A3E 5A3E CD6B4C          17      CALL    FILE_BDOS
001A41 5A41 CD6351          17      CALL    ROM_CD
001A44 5A44 9F               4      SBC A,A
001A45 5A45 C9              10      RET
                                
       5A46                     _SYS5B:     ;(BDOS)パス名の解析(_PARSE)
001A46 5A46 D5              11      PUSH    DE
001A47 5A47 CDCD5A          17      CALL    GET_PARAM_IX
001A4A 5A4A CD6B4C          17      CALL    FILE_BDOS
001A4D 5A4D D1              10      POP DE
001A4E 5A4E 182C            12      JR  S5B_1
                                
       5A50                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
001A50 5A50 CDC55A          17      CALL    SPCUT_SL
001A53 5A53 D5              11      PUSH    DE
                                
001A54 5A54 E5              11      PUSH    HL
001A55 5A55 AF               4      XOR A
001A56 5A56 CDB955          17      CALL    GET_CD_CDRV
001A59 5A59 22F9F2          16      LD  (_CDX),HL
                                
001A5C 5A5C CDCD5A          17      CALL    GET_PARAM_IX
001A5F 5A5F CD6B4C          17      CALL    FILE_BDOS
001A62 5A62 E1              10      POP HL
                                
001A63 5A63 060B             7      LD  B,11
001A65 5A65 1101F3          10      LD  DE,FNAME
       5A68                     S5C_1:
001A68 5A68 1A               7      LD  A,(DE)
001A69 5A69 13               6      INC DE
001A6A 5A6A CD035B          17      CALL    LD_HL_A
001A6D 5A6D 23               6      INC HL
001A6E 5A6E 10F8            13      DJNZ    S5C_1
                                
001A70 5A70 DDE5            15      PUSH    IX
001A72 5A72 E1              10      POP HL
001A73 5A73 115EF5          10      LD  DE,BUF
001A76 5A76 A7               4      AND A
001A77 5A77 ED52            15      SBC HL,DE
001A79 5A79 D1              10      POP DE
001A7A 5A7A 19              11      ADD HL,DE
001A7B 5A7B EB               4      EX  DE,HL
       5A7C                     S5B_1:
001A7C 5A7C 2AF9F2          16      LD  HL,(_CDX)
001A7F 5A7F 3A00F3          13      LD  A,(FDRV)
001A82 5A82 4F               4      LD  C,A
001A83 5A83 AF               4      XOR A
001A84 5A84 C9              10      RET
                                
       5A85                     _SYS6F:
001A85 5A85 016F00          10      LD  BC,0006FH
001A88 5A88 11918A          10      LD  DE,08A91H       ;Tablacus Disk ROM Lite 認識コード
001A8B 5A8B AF               4      XOR A
001A8C 5A8C C9              10      RET
                                
       5A8D                     _SYS68:
001A8D 5A8D 21F2F2          10      LD  HL,_LVECTOR
001A90 5A90 CBFE            15      SET 7,(HL)
001A92 5A92 78               4      LD  A,B
001A93 5A93 B7               4      OR  A
001A94 5A94 3E00             7      LD  A,0
001A96 5A96 C0              11      RET NZ
001A97 5A97 CBBE            15      RES 7,(HL)
001A99 5A99 C9              10      RET
                                
       5A9A                     INIT_FILE:
001A9A 5A9A EB               4      EX  DE,HL
001A9B 5A9B 1100F3          10      LD  DE,FDRV
001A9E 5A9E 010C00          10      LD  BC,1+8+3
       5AA1                     INIT_FILE1:
001AA1 5AA1 EDB0                    LDIR
001AA3 5AA3 CDDA55          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_MORMAL32K_OR_ASCII16
001AA6 5AA6 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
001AA9 5AA9 FD6E0E          19      LD  L,(IY+14)
001AAC 5AAC FD660F          19      LD  H,(IY+15)
001AAF 5AAF 7C               4      LD  A,H
001AB0 5AB0 B5               4      OR  L
001AB1 5AB1 2B               6      DEC HL
001AB2 5AB2 2006            12      JR  NZ,INIT_FILE2
001AB4 5AB4 FD7E00          19      LD  A,(IY+0)
001AB7 5AB7 CDB955          17      CALL    GET_CD_CDRV
       5ABA                     INIT_FILE2:
001ABA 5ABA 22F9F2          16      LD  (_CDX),HL           ;カレントディレクトリ
001ABD 5ABD C9              10      RET
                                
       5ABE                     ZERO_MEMORY_DE:
001ABE 5ABE AF               4      XOR A
       5ABF                     FILL_MEMORY_DE:
001ABF 5ABF 12               7      LD  (DE),A
001AC0 5AC0 13               6      INC DE
001AC1 5AC1 10FC            13      DJNZ    FILL_MEMORY_DE
001AC3 5AC3 C9              10      RET
                                
       5AC4                     SS1_SL:
001AC4 5AC4 13               6      INC DE
       5AC5                     SPCUT_SL:               ;スペースをカット
001AC5 5AC5 CDE75A          17      CALL    LD_A_DE
001AC8 5AC8 FE20             7      CP  020H
001ACA 5ACA 28F8            12      JR  Z,SS1_SL
001ACC 5ACC C9              10      RET
                                
       5ACD                     GET_PARAM_IX:
001ACD 5ACD 0600             7      LD  B,0
001ACF 5ACF 215EF5          10      LD  HL,BUF
001AD2 5AD2 E5              11      PUSH    HL
001AD3 5AD3 CDC55A          17      CALL    SPCUT_SL
       5AD6                     GPIX1:
001AD6 5AD6 CDE75A          17      CALL    LD_A_DE
001AD9 5AD9 13               6      INC DE
001ADA 5ADA 77               7      LD  (HL),A
001ADB 5ADB 23               6      INC HL
001ADC 5ADC B7               4      OR  A
001ADD 5ADD 2804            12      JR  Z,GPIX2
001ADF 5ADF 04               4      INC B
001AE0 5AE0 20F4            12      JR  NZ,GPIX1
001AE2 5AE2 05               4      DEC B
       5AE3                     GPIX2:
001AE3 5AE3 DDE1            14      POP IX
001AE5 5AE5 58               4      LD  E,B
001AE6 5AE6 C9              10      RET
                                
       5AE7                     LD_A_DE:
001AE7 5AE7 1A               7      LD  A,(DE)
001AE8 5AE8 CB7A             8      BIT 7,D
001AEA 5AEA C0              11      RET NZ
001AEB 5AEB C5              11      PUSH    BC
001AEC 5AEC D5              11      PUSH    DE
001AED 5AED E5              11      PUSH    HL
001AEE 5AEE EB               4      EX  DE,HL
                                
001AEF 5AEF 0141F3          10      LD  BC,RAMAD0
001AF2 5AF2 7C               4      LD  A,H
001AF3 5AF3 07               4      RLCA
001AF4 5AF4 07               4      RLCA
001AF5 5AF5 E603             7      AND 3
001AF7 5AF7 81               4      ADD A,C
001AF8 5AF8 4F               4      LD  C,A
001AF9 5AF9 0A               7      LD  A,(BC)
                                
001AFA 5AFA CD0C00          17      CALL    _RDSLT
001AFD 5AFD E1              10      POP HL
001AFE 5AFE D1              10      POP DE
001AFF 5AFF C1              10      POP BC
001B00 5B00 C9              10      RET
                                
       5B01                     LD_HL_A_1:
001B01 5B01 77               7      LD  (HL),A
001B02 5B02 C9              10      RET
       5B03                     LD_HL_A:
001B03 5B03 CB7C             8      BIT 7,H
001B05 5B05 20FA            12      JR  NZ,LD_HL_A_1
001B07 5B07 C5              11      PUSH    BC
001B08 5B08 D5              11      PUSH    DE
001B09 5B09 E5              11      PUSH    HL
                                
001B0A 5B0A 5F               4      LD  E,A
001B0B 5B0B 0141F3          10      LD  BC,RAMAD0
001B0E 5B0E 7C               4      LD  A,H
001B0F 5B0F 07               4      RLCA
001B10 5B10 07               4      RLCA
001B11 5B11 E603             7      AND 3
001B13 5B13 81               4      ADD A,C
001B14 5B14 4F               4      LD  C,A
001B15 5B15 0A               7      LD  A,(BC)
                                
001B16 5B16 CD1400          17      CALL    _WRSLT
001B19 5B19 E1              10      POP HL
001B1A 5B1A D1              10      POP DE
001B1B 5B1B C1              10      POP BC
001B1C 5B1C C9              10      RET
                                
       5B1D                     HEXHL:
001B1D 5B1D 7C               4      LD  A,H
001B1E 5B1E CD225B          17      CALL    HEXHX
001B21 5B21 7D               4      LD  A,L
       5B22                     HEXHX:
001B22 5B22 F5              11      PUSH    AF
001B23 5B23 07               4      RLCA
001B24 5B24 07               4      RLCA
001B25 5B25 07               4      RLCA
001B26 5B26 07               4      RLCA
001B27 5B27 CD2B5B          17      CALL    HEXA2
001B2A 5B2A F1              10      POP AF
       5B2B                     HEXA2:
001B2B 5B2B CDE844          17      CALL    ASC
001B2E 5B2E 12               7      LD  (DE),A
001B2F 5B2F 13               6      INC DE
001B30 5B30 C9              10      RET
                                
       5B31                     HEX:
001B31 5B31 CDD34D          17      CALL    CAP
001B34 5B34 D630             7      SUB '0'
001B36 5B36 D8              11      RET C
001B37 5B37 FE0A             7      CP  10
001B39 5B39 3F               4      CCF
001B3A 5B3A D0              11      RET NC
001B3B 5B3B FE11             7      CP  16+1
001B3D 5B3D D8              11      RET C
001B3E 5B3E D607             7      SUB 7
001B40 5B40 FE10             7      CP  10H
001B42 5B42 3F               4      CCF
001B43 5B43 C9              10      RET
                                
       58CB                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       58CB                     _SYS13  EQU SCF_FF_RET  ;(BDOS)ファイルの削除
       58CB                     _SYS15  EQU SCF_FF_RET  ;(BDOS)シーケンシャルな書き込み
       58CB                     _SYS16  EQU SCF_FF_RET  ;(BDOS)ファイルの作成
       58CB                     _SYS17  EQU SCF_FF_RET  ;(BDOS)ファイル名の変更
       58CB                     _SYS22  EQU SCF_FF_RET  ;(BDOS)ランダムな書き込み
       58CB                     _SYS26  EQU SCF_FF_RET  ;(BDOS)ランダムブロック書き込み
       58CB                     _SYS28  EQU SCF_FF_RET  ;(BDOS)ランダムな書き込み・その2
                                
       58CB                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       58CB                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       58CB                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       58CB                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
001B44 5B44                         ALIGN   256
       5C00                     STABLE:
                                ;0
001C00 5C00 335648567956CB58        DW  _ERROR,_SYS01,_SYS02,_SYS03
001C08 5C08 335633567E56CD56        DW  _ERROR,_ERROR,_SYS06,_SYS07
001C10 5C10 8656BF56E7562C57        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
001C18 5C18 4B58515858586158        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001C20 5C20 C658CE581359CB58        DW  _SYS10,_SYS11,_SYS12,_SYS13
001C28 5C28 3159CB58CB58CB58        DW  _SYS14,_SYS15,_SYS16,_SYS17
001C30 5C30 4A59505955595B59        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001C38 5C38 33564A5933563356        DW  _ERROR,_SYS1D,_ERROR,_ERROR
                                ;2
001C40 5C40 33569059CB589E59        DW  _ERROR,_SYS21,_SYS22,_SYS23
001C48 5C48 B7593356CB58C059        DW  _SYS24,_ERROR,_SYS26,_SYS27
001C50 5C50 CB58065A3E57CB58        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
001C58 5C58 8E57CB583356215A        DW  _SYS2C,_SYS2D,_ERROR,_SYS2F
                                ;3
001C60 5C60 3356335633563356        DW  _ERROR,_ERROR,_ERROR,_ERROR
001C68 5C68 3356335633563356        DW  _ERROR,_ERROR,_ERROR,_ERROR
001C70 5C70 3356CB58CB583356        DW  _ERROR,_SYS39,_SYS3A,_ERROR
001C78 5C78 3356335633563356        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001C80 5C80 3356335633563356        DW  _ERROR,_ERROR,_ERROR,_ERROR
001C88 5C88 3356335633563356        DW  _ERROR,_ERROR,_ERROR,_ERROR
001C90 5C90 3356335633563356        DW  _ERROR,_ERROR,_ERROR,_ERROR
001C98 5C98 3356335633563356        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001CA0 5CA0 3356335633563356        DW  _ERROR,_ERROR,_ERROR,_ERROR
001CA8 5CA8 3356335633563356        DW  _ERROR,_ERROR,_ERROR,_ERROR
001CB0 5CB0 3356295A3B5A465A        DW  _ERROR,_SYS59,_SYS5A,_SYS5B
001CB8 5CB8 505A335633563356        DW  _SYS5C,_ERROR,_ERROR,_ERROR
                                ;6
001CC0 5CC0 3356335633563356        DW  _ERROR,_ERROR,_ERROR,_ERROR
001CC8 5CC8 3356335633563356        DW  _ERROR,_ERROR,_ERROR,_ERROR
001CD0 5CD0 8D5A335633563356        DW  _SYS68,_ERROR,_ERROR,_ERROR
001CD8 5CD8 335633563356855A        DW  _ERROR,_ERROR,_ERROR,_SYS6F
                                ;7
001CE0 5CE0 3356335633563356        DW  _ERROR,_ERROR,_ERROR,_ERROR
001CE8 5CE8 3356335633563356        DW  _ERROR,_ERROR,_ERROR,_ERROR
001CF0 5CF0 3356335633563356        DW  _ERROR,_ERROR,_ERROR,_ERROR
001CF8 5CF8 3356335633563356        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
                                    INCLUDE "SLOT.ASM"
                                #if exists _RAM64K
       5D00                     INT38H_ROM:
001D00 5D00 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
001D03 5D03 CD095D          17      CALL    ENASLT_00H
001D06 5D06 CD3800          17      CALL    00038H
                                ;   JP  ENASLT_00H
                                ;
                                ;ページ0専門のENASLT
                                ;in
                                ;A←スロット
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
                                ; ページ1 に配置
       5D09                     ENASLT_00H:
001D09 5D09 F3               4      DI
001D0A 5D0A D5              11      PUSH    DE
001D0B 5D0B 6F               4      LD  L,A
001D0C 5D0C E603             7      AND 3
001D0E 5D0E 4F               4      LD  C,A
001D0F 5D0F DBA8            11      IN  A,(0A8H)
001D11 5D11 67               4      LD  H,A
001D12 5D12 E6FC             7      AND 0FCH    ;ページ0
001D14 5D14 B1               4      OR  C
001D15 5D15 57               4      LD  D,A ;基本スロット
                                
001D16 5D16 7C               4      LD  A,H
001D17 5D17 E603             7      AND 3
001D19 5D19 CB7D             8      BIT 7,L
001D1B 5D1B CAFAEF          10      JP  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001D1E 5D1E F680             7      OR  080H
001D20 5D20 67               4      LD  H,A
                                            ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001D21 5D21 79               4      LD  A,C
001D22 5D22 0F               4      RRCA
001D23 5D23 0F               4      RRCA
001D24 5D24 4F               4      LD  C,A
001D25 5D25 7A               4      LD  A,D
001D26 5D26 E63F             7      AND 03FH    ;ページ0
001D28 5D28 B1               4      OR  C
001D29 5D29 D3A8            11      OUT (0A8H),A
                                                ;拡張スロットの切り替え
001D2B 5D2B 7D               4      LD  A,L
001D2C 5D2C 0F               4      RRCA
001D2D 5D2D 0F               4      RRCA
001D2E 5D2E E603             7      AND 3
001D30 5D30 4F               4      LD  C,A
                                
001D31 5D31 3AFFFF          13      LD  A,(0FFFFH)
001D34 5D34 2F               4      CPL
001D35 5D35 47               4      LD  B,A
001D36 5D36 E6FC             7      AND 0FCH    ;ページ0
001D38 5D38 B1               4      OR  C
001D39 5D39 32FFFF          13      LD  (0FFFFH),A
                                                ;基本スロットの切り替え
001D3C 5D3C 7A               4      LD  A,D
001D3D 5D3D D3A8            11      OUT (0A8H),A
001D3F 5D3F 78               4      LD  A,B
001D40 5D40 E603             7      AND 3
001D42 5D42 87               4      ADD A,A
001D43 5D43 87               4      ADD A,A
001D44 5D44 C3ECEF          10      JP  WRITE_SLTTBL
                                ;
                                ;   ENASLOTの補助（ページ0・003BH～に配置）
                                ;
       5D47                     AT_3B:              ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001D47 5D47 D3A8            11      OUT (0A8H),A
001D49 5D49 3AFFFF          13      LD  A,(0FFFFH)  ;拡張スロットの切り替え
001D4C 5D4C 2F               4      CPL
001D4D 5D4D 47               4      LD  B,A
001D4E 5D4E A3               4      AND E
001D4F 5D4F B1               4      OR  C
001D50 5D50 32FFFF          13      LD  (0FFFFH),A
                                                ;基本スロットの切り替え
001D53 5D53 7A               4      LD  A,D
001D54 5D54 D3A8            11      OUT (0A8H),A
001D56 5D56 C9              10      RET
       5D57                     AT_3B_E:
                                
       5D57                     AT_ISC:
001D57 EF80                         ORG ISC,AT_ISC-RUN
                                ;
                                ; インタースロットコール
                                ; ページ3 に配置
                                
                                ;
                                ;ENASLT
                                ;in
                                ;A←スロット
                                ;HL←上位2ビットで切り替えるページを指定
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
       EF80                     ENASLT:
001D57 EF80 CB7C             8      BIT 7,H
001D59 EF82 207D            12      JR  NZ,ENASLT1
001D5B EF84 CB74             8      BIT 6,H
001D5D EF86 2032            12      JR  NZ,ENASLT_40H
       EF88                     _ENASLT_00H:
001D5F EF88 E5              11      PUSH    HL
001D60 EF89 210280          10      LD  HL,08002H
001D63 EF8C 39              11      ADD HL,SP
001D64 EF8D E1              10      POP HL
001D65 EF8E 3014            12      JR  NC,_ENASLT_00H_S
       EF90                     ENASLT_SUB:
001D67 EF90 DDE5            15      PUSH    IX
001D69 EF92 DD21095D        14      LD  IX,ENASLT_00H
       EF96                     INT38H_SUB1:
001D6D EF96 FDE5            15      PUSH    IY
001D6F EF98 FD2A96F2        20      LD  IY,(ROM_SLT-1)
001D73 EF9C CD51F0          17      CALL    CALSLT
001D76 EF9F FDE1            14      POP IY
001D78 EFA1 DDE1            14      POP IX
001D7A EFA3 C9              10      RET
       EFA4                     _ENASLT_00H_S:
001D7B EFA4 ED73AFEF        20      LD  (ENASLT_SP1),SP
001D7F EFA8 315DF5          10      LD  SP,SPBUF
001D82 EFAB CD90EF          17      CALL    ENASLT_SUB
001D85 EFAE 310000          10      LD  SP,0
       EFAF                     ENASLT_SP1  EQU $-2
001D88 EFB1 C9              10      RET
                                
       EFB2                     INT38H_SUB:
001D89 EFB2 DDE5            15      PUSH    IX
001D8B EFB4 DD21005D        14      LD  IX,INT38H_ROM
001D8F EFB8 18DC            12      JR  INT38H_SUB1
                                ;
                                ;ページ1専門のENASLT
                                ;in
                                ;A←スロット
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
       EFBA                     ENASLT_40H:
001D91 EFBA F3               4      DI
001D92 EFBB D5              11      PUSH    DE
001D93 EFBC 6F               4      LD  L,A
001D94 EFBD E603             7      AND 3
001D96 EFBF 87               4      ADD A,A
001D97 EFC0 87               4      ADD A,A
001D98 EFC1 4F               4      LD  C,A
001D99 EFC2 DBA8            11      IN  A,(0A8H)
001D9B EFC4 67               4      LD  H,A
001D9C EFC5 E6F3             7      AND 0F3H    ;ページ1
001D9E EFC7 B1               4      OR  C
001D9F EFC8 57               4      LD  D,A ;基本スロットに出力する値
                                
001DA0 EFC9 7C               4      LD  A,H ;切り替えページ
001DA1 EFCA 0F               4      RRCA
001DA2 EFCB 0F               4      RRCA
001DA3 EFCC E603             7      AND 3
001DA5 EFCE CB7D             8      BIT 7,L
001DA7 EFD0 2828            12      JR  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001DA9 EFD2 F680             7      OR  080H
001DAB EFD4 67               4      LD  H,A ;基本スロットに出力する値
                                            ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001DAC EFD5 E603             7      AND 3
001DAE EFD7 0F               4      RRCA
001DAF EFD8 0F               4      RRCA
001DB0 EFD9 4F               4      LD  C,A
                                
001DB1 EFDA 7A               4      LD  A,D ;基本スロットに出力する値
001DB2 EFDB E63F             7      AND 03FH
001DB4 EFDD B1               4      OR  C
001DB5 EFDE 5F               4      LD  E,A ;基本スロットでページ3にスロットを割り当てる
                                
001DB6 EFDF 7D               4      LD  A,L
001DB7 EFE0 E60C             7      AND 00CH    ;ページ1
001DB9 EFE2 4F               4      LD  C,A
                                
001DBA EFE3 7B               4      LD  A,E
001DBB EFE4 1EF3             7      LD  E,0F3H  ;ページ1
001DBD EFE6 CD3B00          17      CALL    ENASUB
                                
001DC0 EFE9 78               4      LD  A,B
001DC1 EFEA E60C             7      AND 00CH
       EFEC                     WRITE_SLTTBL:       ;SLTTBLを書き換える
001DC3 EFEC B4               4      OR  H   ;A=拡張スロット H=基本スロット
001DC4 EFED 4F               4      LD  C,A
                                
001DC5 EFEE 7D               4      LD  A,L
001DC6 EFEF E603             7      AND 3
001DC8 EFF1 C6C5             7      ADD A,LOW SLTTBL
001DCA EFF3 6F               4      LD  L,A
001DCB EFF4 26FC             7      LD  H,HIGH SLTTBL
001DCD EFF6 70               7      LD  (HL),B  ;B:拡張スロットに設定した値
001DCE EFF7 79               4      LD  A,C ;ENASLTする前のスロット情報をAで返す
001DCF EFF8 D1              10      POP DE
001DD0 EFF9 C9              10      RET
                                
       EFFA                     ENASLT_NOEXT:               ;スロットが拡張されていない場合
001DD1 EFFA 5F               4      LD  E,A
001DD2 EFFB 7A               4      LD  A,D
001DD3 EFFC D3A8            11      OUT (0A8H),A
001DD5 EFFE 7B               4      LD  A,E ;ENASLTする前のスロット情報をAで返す
001DD6 EFFF D1              10      POP DE
001DD7 F000 C9              10      RET
                                
       F001                     ENASLT1:
001DD8 F001 CB74             8      BIT 6,H
001DDA F003 C0              11      RET NZ          ;ページ3はスロット切り替え不可
                                ;
                                ;ページ2専門のENASLT
                                ;in
                                ;A←スロット
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
       F004                     ENASLT_80H:
001DDB F004 F3               4      DI
001DDC F005 D5              11      PUSH    DE
001DDD F006 6F               4      LD  L,A
001DDE F007 E603             7      AND 3
001DE0 F009 87               4      ADD A,A
001DE1 F00A 87               4      ADD A,A
001DE2 F00B 87               4      ADD A,A
001DE3 F00C 87               4      ADD A,A
001DE4 F00D 4F               4      LD  C,A
001DE5 F00E DBA8            11      IN  A,(0A8H)
001DE7 F010 67               4      LD  H,A
001DE8 F011 E6CF             7      AND 0CFH    ;ページ2
001DEA F013 B1               4      OR  C
001DEB F014 57               4      LD  D,A ;基本スロット
                                
001DEC F015 7C               4      LD  A,H
001DED F016 0F               4      RRCA
001DEE F017 0F               4      RRCA
001DEF F018 0F               4      RRCA
001DF0 F019 0F               4      RRCA
001DF1 F01A E603             7      AND 3
001DF3 F01C CB7D             8      BIT 7,L
001DF5 F01E 28DA            12      JR  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001DF7 F020 F680             7      OR  080H
001DF9 F022 67               4      LD  H,A
                                            ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001DFA F023 7F               4      LD  A,A
001DFB F024 E603             7      AND 3
001DFD F026 0F               4      RRCA
001DFE F027 0F               4      RRCA
001DFF F028 4F               4      LD  C,A
001E00 F029 7A               4      LD  A,D
001E01 F02A E63F             7      AND 03FH    ;ページ2
001E03 F02C B1               4      OR  C
001E04 F02D 5F               4      LD  E,A
                                
001E05 F02E 7D               4      LD  A,L
001E06 F02F 07               4      RLCA
001E07 F030 07               4      RLCA
001E08 F031 E630             7      AND 030H
001E0A F033 4F               4      LD  C,A
                                
001E0B F034 7B               4      LD  A,E
001E0C F035 1ECF             7      LD  E,0CFH  ;ページ2
001E0E F037 CD3B00          17      CALL    ENASUB
                                
001E11 F03A 78               4      LD  A,B
001E12 F03B E630             7      AND 030H    ;ページ2
001E14 F03D 0F               4      RRCA
001E15 F03E 0F               4      RRCA
001E16 F03F 18AB            12      JR  WRITE_SLTTBL
                                
       F041                     CALLF:
001E18 F041 E3              19      EX  (SP),HL
001E19 F042 F5              11      PUSH    AF
001E1A F043 7E               7      LD  A,(HL)
001E1B F044 FD67             9      LD  IYH,A
001E1D F046 23               6      INC HL
001E1E F047 7E               7      LD  A,(HL)
001E1F F048 DD6F             9      LD  IXL,A
001E21 F04A 23               6      INC HL
001E22 F04B 7E               7      LD  A,(HL)
001E23 F04C DD67             9      LD  IXH,A
001E25 F04E 23               6      INC HL
001E26 F04F F1              10      POP AF
001E27 F050 E3              19      EX  (SP),HL
       F051                     CALSLT:
001E28 F051 08               4      EX  AF,AF'
001E29 F052 F5              11      PUSH    AF      ;裏AFを保存
001E2A F053 F3               4      DI
001E2B F054 E5              11      PUSH    HL
001E2C F055 210280          10      LD  HL,08002H
001E2F F058 39              11      ADD HL,SP
001E30 F059 E1              10      POP HL
001E31 F05A 3007            12      JR  NC,CALSLT_1
001E33 F05C CD72F0          17      CALL    CALSLT_2
       F05F                     CALSLT_E:
001E36 F05F 08               4      EX  AF,AF'
001E37 F060 F1              10      POP AF      ;保存した裏AF
001E38 F061 08               4      EX  AF,AF'
001E39 F062 C9              10      RET
       F063                     CALSLT_1:
001E3A F063 ED736EF0        20      LD  (CSSP),SP
001E3E F067 315DF5          10      LD  SP,SPBUF
001E41 F06A CD72F0          17      CALL    CALSLT_2
001E44 F06D 310000          10      LD  SP,0
       F06E                     CSSP    EQU $-2
001E47 F070 18ED            12      JR  CALSLT_E
                                
       F072                     CALSLT_2:
001E49 F072 E5              11      PUSH    HL
001E4A F073 C5              11      PUSH    BC
001E4B F074 DD7C             9      LD  A,IXH
001E4D F076 67               4      LD  H,A
001E4E F077 FD7C             9      LD  A,IYH
001E50 F079 CD80EF          17      CALL    ENASLT
001E53 F07C C1              10      POP BC
001E54 F07D 6F               4      LD  L,A
001E55 F07E DD7C             9      LD  A,IXH
001E57 F080 67               4      LD  H,A
001E58 F081 E3              19      EX  (SP),HL
001E59 F082 08               4      EX  AF,AF'
001E5A F083 CD98F3          17      CALL    JP_IX
001E5D F086 E3              19      EX  (SP),HL
001E5E F087 C5              11      PUSH    BC
001E5F F088 08               4      EX  AF,AF'
001E60 F089 7D               4      LD  A,L
001E61 F08A CD80EF          17      CALL    ENASLT
001E64 F08D 08               4      EX  AF,AF'
001E65 F08E C1              10      POP BC
001E66 F08F E1              10      POP HL
001E67 F090 C9              10      RET
                                
       F091                     RDSLT:
001E68 F091 E5              11      PUSH    HL
001E69 F092 CD80EF          17      CALL    ENASLT
001E6C F095 E1              10      POP HL
001E6D F096 46               7      LD  B,(HL)
001E6E F097 C5              11      PUSH    BC
001E6F F098 E5              11      PUSH    HL
001E70 F099 CD80EF          17      CALL    ENASLT
001E73 F09C E1              10      POP HL
001E74 F09D F1              10      POP AF
001E75 F09E C9              10      RET
                                
       F09F                     WRSLT:
001E76 F09F E5              11      PUSH    HL
001E77 F0A0 CD80EF          17      CALL    ENASLT
001E7A F0A3 E1              10      POP HL
001E7B F0A4 73               7      LD  (HL),E
001E7C F0A5 E5              11      PUSH    HL
001E7D F0A6 CD80EF          17      CALL    ENASLT
001E80 F0A9 E1              10      POP HL
001E81 F0AA C9              10      RET
                                
       F0AB                     INT38H:
001E82 F0AB F3               4      DI
001E83 F0AC F5              11      PUSH    AF
001E84 F0AD C5              11      PUSH    BC
001E85 F0AE E5              11      PUSH    HL
001E86 F0AF 210280          10      LD  HL,08002H
001E89 F0B2 39              11      ADD HL,SP
001E8A F0B3 380E            12      JR  C,INT38H1
001E8C F0B5 ED73C0F0        20      LD  (INTSP),SP  ;スタックポインタ保存
001E90 F0B9 315DF5          10      LD  SP,SPBUF
001E93 F0BC CDB2EF          17      CALL    INT38H_SUB
001E96 F0BF 310000          10      LD  SP,0
       F0C0                     INTSP   EQU $-2
001E99 F0C2 AF               4      XOR A
       F0C3                     INT38H1:
001E9A F0C3 DCB2EF          17      CALL    C,INT38H_SUB
001E9D F0C6 E1              10      POP HL
001E9E F0C7 C1              10      POP BC
001E9F F0C8 F1              10      POP AF
001EA0 F0C9 FB               4      EI
001EA1 F0CA C9              10      RET
                                ;
                                ;   ページ1のディスクの読み込み補助
                                ;
       F0CB                     LDIR_PAGE1_RAM:
001EA2 F0CB CDBAEF          17      CALL    ENASLT_40H
001EA5 F0CE C1              10      POP BC
001EA6 F0CF D1              10      POP DE
001EA7 F0D0 215EF5          10      LD  HL,BUF
001EAA F0D3 EDB0                    LDIR
001EAC F0D5 CDBAEF          17      CALL    ENASLT_40H
001EAF F0D8 C32B46          10      JP  LDIR_PAGE1_ROM
       F0DB                     ISC_E:
001EB2 5EB2                         ORG $$+RUN,$$   ;$DEPHASE
                                
                                #endif
       5EB2                     AT_ISCB:
001EB2 F280                         ORG ISCB,AT_ISCB-RUN
                                
       F280                     REPLACE_COMMAND:
001EB2 F280 FEB7             7      CP  0B7H            ;FILES
001EB4 F282 CC7BFE          17      CALL    Z,H_FILE
001EB7 F285 FEB5             7      CP  0B5H            ;LOAD
001EB9 F287 CA71FE          10      JP  Z,H_BINS
001EBC F28A FE8A             7      CP  08AH            ;RUN
001EBE F28C CA76FE          10      JP  Z,H_BINL
001EC1 F28F FED6             7      CP  0D6H            ;COPY
001EC3 F291 2813            12      JR  Z,FIX_COPY
001EC5 F293 FECF             7      CP  0CFH            ;BLOAD
001EC7 F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
001EC8 F296 F7              12      RST 30H
       F297                     ROM_SLT:
001EC9 F297 00                      DB  0
001ECA F298 FC47                    DW  ROM_BLOAD
001ECC F29A F5              11      PUSH    AF
001ECD F29B E5              11      PUSH    HL
001ECE F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
001ED1 F29F E1              10      POP HL
001ED2 F2A0 F1              10      POP AF
001ED3 F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
001ED5 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
001ED7 F2A5 C9              10      RET
       F2A6                     FIX_COPY:
001ED8 F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
001ED9 F2A7 00                      DB  0
001EDA F2A8 8149                    DW  ROM_COPY
001EDC F2AA C9              10      RET
       F2AB                     RAMUSE1:
001EDD F2AB 3A42F3          13      LD  A,(RAMAD1)
001EE0 F2AE 180E            12      JR  _ENASLT_40H
       F2B0                     CAL_MP:
001EE2 F2B0 2640             7      LD  H,040H
001EE4 F2B2 3AC1FC          13      LD  A,(EXPTBL)
001EE7 F2B5 CD2400          17      CALL    _ENASLT
001EEA F2B8 CD1C00          17      CALL    _CALSLT
       F2BB                     ROMUSE1:
001EED F2BB 3A97F2          13      LD  A,(ROM_SLT)
       F2BE                     _ENASLT_40H:
001EF0 F2BE 2640             7      LD  H,040H
001EF2 F2C0 C32400          10      JP  _ENASLT
                                
       F2C3                     _RESULT:
001EF5 F2C3 00                      DB  0
       F2C4                     _BANK:
001EF6 F2C4 00                      DB  0
       F2C5                     _BANK1:
001EF7 F2C5 00                      DB  0
       F2C6                     CLSZ:               ;クラスタサイズ
001EF8 F2C6 0004                    DW  1024
       F2C7                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2C8                     SECSZ:              ;セクタサイズ
001EFA F2C8 0002                    DW  512
       F2C9                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2CA                     RR_LOW:
001EFC F2CA 0000                    DW  0
       F2CB                     RR_MID  EQU $-1
       F2CC                     RR_HIGH:
001EFE F2CC 0000                    DW  0
       F2CE                     _CLPS:
001F00 F2CE 0000                    DW  0
       F2D0                     _LEFT:
001F02 F2D0 0000                    DW  0
       F2D2                     _DTPS:
001F04 F2D2 0000                    DW  0
       F2D4                     _DTA:
001F06 F2D4 0000                    DW  0
       F2D6                     FLG_LDIR:
001F08 F2D6 00                      DB  0
       F2D7                     _FCB:
001F09 F2D7 0000                    DW  0
       F2D9                     _BUF:
       F2D9                     _BUF_LO:        ;LOGICAL OPERATION
001F0B F2D9 00                      DB  0
       F2DA                     _BUF_ST:
001F0C F2DA 0000                    DW  0
       F2DC                     _BUF_EN:
001F0E F2DC 0000                    DW  0
       F2DE                     _BUF_EX:
       F2DE                     _BUF_W:
001F10 F2DE 0000                    DW  0
       F2E0                     _BUF_H:
001F12 F2E0 0000                    DW  0
       F2E2                     _BUF_X:
001F14 F2E2 0000                    DW  0
       F2E4                     _BUF_Y:
001F16 F2E4 00                      DB  0
       F2E5                     _BUF_P:
001F17 F2E5 00                      DB  0
       F2E6                     _BUF_O:
001F18 F2E6 00                      DB  0
       F2E7                     DTAX:
001F19 F2E7 0000                    DW  0
       F2E9                     B_DRIVE:
001F1B F2E9 00                      DB  0
       F2EA                     _DVSW:          ;カレントドライブ
001F1C F2EA 00                      DB  0
       F2EB                     _CD_A:          ;カレントディレクトリ A:
001F1D F2EB 0000                    DW  0
       F2ED                     _CD_B:          ;カレントディレクトリ B:
001F1F F2ED 0000                    DW  0
       F2EF                     DIRENT1:
001F21 F2EF 0000                    DW  0
       F2F1                     _DIR_BANK:
001F23 F2F1 00                      DB  0
       F2F2                     _LVECTOR:
001F24 F2F2 01                      DB  1
       F2F3                     LEFTX:
001F25 F2F3 0000                    DW  0
       F2F5                     PARAM0:
001F27 F2F5 0000                    DW  0
       F2F7                     PARAM1:
001F29 F2F7 0000                    DW  0
       F2F9                     _CDX:
001F2B F2F9 0000                    DW  0
       F2FB                     _CHKSP:
001F2D F2FB 1F                      DB  01FH
       F2FC                     _HL:
001F2E F2FC 0000                    DW  0
       F2FE                     _SP:
001F30 F2FE 0000                    DW  0
       F300                     FDRV:
001F32 F300 00                      DB  0
       F301                     FNAME:
001F33 F301                         DS  8+3
       F30B                     _SP_H   EQU $-1
                                
       F30C                     ISCB_E:
[EOF:SLOT.ASM:UTF_8]
       1F3E                     LAST    EQU $$
001F3E F30C                         DS  01FFFH-LAST
001FFF F3CD 00                      DB  0
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
[EOF:DISKROM64K32.ASM:UTF_8]
