                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
       0001                     _RAM64K     EQU 1   ;メインRAM 64KB使用可能
       0001                     USE_MORMAL32K_OR_ASCII16        EQU 1   ;ノーマル32KB/ASCII-16K ROMを作成する
                                
                                    INCLUDE "DISKROM.ASM"
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       006C                     INITXT  EQU 0006CH
       0078                     SETTXT  EQU 00078H
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00AE                     PLININ  EQU 000AEH
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
       0159                     CALBAS  EQU 00159H
       01F5                     REDCLK  EQU 001F5H  ;SUB
       01F9                     WRTCLK  EQU 001F9H  ;SUB
                                
       269A                     DECADD  EQU 0269AH
       27E6                     DECMUL  EQU 027E6H
       2F8A                     FRCINT  EQU 02F8AH
                                
       303A                     FRCDBL  EQU 0303AH
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
       7D17                     ST_BAS  EQU 07D17H
                                
       F323                     DISKVE  EQU 0F323H
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F398                     JP_IX   EQU 0F398H
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F847                     ARG EQU 0F847H
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
       FAF8                     EXBRSA  EQU 0FAF8H
                                
       FB03                     RSTMP   EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBB1                     BASROM  EQU 0FBB1H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCC5                     SLTTBL  EQU 0FCC5H
       FCC9                     SLTATR  EQU 0FCC9H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
       FD99                     DEVICE  EQU 0FD99H
                                
       FDDB                     H_PINL  EQU 0FDDBH
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       C000                     FD_BOOT_START   EQU 0C000H
       C01E                     FD_BOOT_EXEC    EQU 0C01EH
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                            ;ASCII-16K
       6000                     ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
       7000                     ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
                                BANK0_SEL EQU   06000H  ;6000-67FF
                                BANK1_SEL EQU   06800H  ;6800-6FFF
                                BANK2_SEL EQU   07000H  ;7000-77FF
                                BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
                                KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
                                KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
                                KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
                                KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
                                KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
                                KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
                                KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
       EF80                     ISC EQU 0EF80H
       F280                     ISCB    EQU 0F280H
                                
                                #if exists _RAM64K
       EF80                     NEW_HIMEM   EQU ISC
                                #else
                                NEW_HIMEM   EQU ISCB
                                #endif
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F55D                     SPBUF   EQU KBUF+318    ;ページ3にスタックがない場合はKBUFを一時的に使う
                                
       003B                     ENASUB  EQU 0003BH
       F55E                     SYS1B_DPB   EQU BUF
       F571                     SYS1B_FAT   EQU SYS1B_DPB+19
                                
       FB03                     TMP_DIRENT  EQU RSTMP
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0042                    DW  INIT_ROM    ; Main program execution address.
000004 4004 DD50                    DW  STATEMENT   ; STATEMENT
000006 4006 2452                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C38153          10      JP  DISKIO
000013 4013 C3CE53          10      JP  DSKCHG
000016 4016 C32454          10      JP  GETDPB
000019 4019 C31755          10      JP  CHOICE
00001C 401C C31B55          10      JP  DSKFMT
00001F 401F C31D55          10      JP  DSKSTP
000022 4022 C31E55          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C31B55          10      JP  DSKFMT
000029 4029 C31D55          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C38955          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite"
            204449534B20524F    
            4D204C697465        
000096 4096                         ALIGN   32
0000A0 40A0 76302E372E332E30        DB  "v0.7.3.0"
0000A8 40A8                         ALIGN   32
       40C0                     MSG_ERROR_ROM_MODE:
                                #if exists USE_MORMAL32K_OR_ASCII16
0000C0 40C0 4E6F726D616C2052        DB  "Normal ROM/ASCII-16K only!",13,10
            4F4D2F4153434949    
            2D31364B206F6E6C    
            79210D0A            
                                #else
                                    DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
                                #endif
0001BD 41BD                         ORG 041BDH
0001BD 41BD C9              10      RET
                                
                                    ;MBR_Partition1 (2DDのデータ)
0001BE 41BE 00                      DB  0       ;ブートフラグ
0001BF 41BF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001C2 41C2 01                      DB  1       ;識別子(FAT12)
0001C3 41C3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001C6 41C6 10000000                DW  16,0        ;パーティションの最初のセクタ番号(LBA方式)
0001CA 41CA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                    ;MBR_Partition2 (2DDのデータ)
                                    DB  0       ;ブートフラグ
                                    DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
                                    DB  1       ;識別子(FAT12)
                                    DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
                                    DW  16+1440,0   ;パーティションの最初のセクタ番号(LBA方式)
                                    DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                #endif
                                
0001FE 41FE                         ORG 041FEH
0001FE 41FE 55AA                    DB  055H,0AAH   ;MBR_Sig
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4200                     INIT_ROM:
000200 4200 AF               4      XOR A
000201 4201 2100F3          10      LD  HL,0F300H
000204 4204 0668             7      LD  B,068H
000206 4206 CD2B4D          17      CALL    FILL_MEMORY
                                
000209 4209 3E01             7      LD  A,1
00020B 420B 3221FB          13      LD  (DRVTBL),A
                                
00020E 420E 2A4AFC          16      LD  HL,(HIMEM)
000211 4211 1180EF          10      LD  DE,NEW_HIMEM
000214 4214 A7               4      AND A
000215 4215 ED52            15      SBC HL,DE
000217 4217 382D            12      JR  C,INIT1
000219 4219 EB               4      EX  DE,HL
00021A 421A 2A74F6          16      LD  HL,(STKTOP)
00021D 421D ED52            15      SBC HL,DE
00021F 421F 2274F6          16      LD  (STKTOP),HL ;起動時の空き容量表示の為
000222 4222 F9               6      LD  SP,HL
000223 4223 2A72F6          16      LD  HL,(MEMSIZ)
000226 4226 7C               4      LD  A,H
000227 4227 B5               4      OR  L
000228 4228 320CF3          13      LD  (IS_BIOS),A
00022B 422B 2006            12      JR  NZ,GENUINE
00022D 422D 2180F1          10      LD  HL,0F180H   ;C-BIOSの場合に補正する
000230 4230 229BF6          16      LD  (FRETOP),HL
       4233                     GENUINE:
000233 4233 ED52            15      SBC HL,DE
000235 4235 2272F6          16      LD  (MEMSIZ),HL
000238 4238 2A9BF6          16      LD  HL,(FRETOP)
00023B 423B ED52            15      SBC HL,DE
00023D 423D 229BF6          16      LD  (FRETOP),HL
000240 4240 2180EF          10      LD  HL,NEW_HIMEM
000243 4243 224AFC          16      LD  (HIMEM),HL
       4246                     INIT1:
000246 4246 AF               4      XOR A
000247 4247 32EAF2          13      LD  (_DVSW),A
00024A 424A 3D               4      DEC A       ;0FFH
00024B 424B 3299FD          13      LD  (DEVICE),A
                                
                                #if exists _RAM64K
00024E 424E 213A5D          10      LD  HL,AT_ISC
000251 4251 1180EF          10      LD  DE,ISC
000254 4254 01FC01          10      LD  BC,ISC_E-ISC
000257 4257 EDB0                    LDIR
                                #endif
000259 4259 3A0CF3          13      LD  A,(IS_BIOS)
00025C 425C 21365F          10      LD  HL,AT_ISCB
00025F 425F 1180F2          10      LD  DE,ISCB
000262 4262 018D00          10      LD  BC,ISCB_E-ISCB
000265 4265 EDB0                    LDIR
000267 4267 320CF3          13      LD  (IS_BIOS),A
00026A 426A 2AB1F6          16      LD  HL,(SAVSTK)
00026D 426D 224BF3          16      LD  (0F34BH),HL
                                
000270 4270 3EC3             7      LD  A,0C3H      ;JP
000272 4272 3243FF          13      LD  (H_GONE),A
000275 4275 327DF3          13      LD  (BDOS),A
000278 4278 326BF3          13      LD  (RAMUSE),A
00027B 427B 3268F3          13      LD  (ROMUSE),A
00027E 427E 2180F2          10      LD  HL,REPLACE_COMMAND
000281 4281 2244FF          16      LD  (H_GONE+1),HL
000284 4284 2131F3          10      LD  HL,H_BDOS
000287 4287 227EF3          16      LD  (BDOS+1),HL
00028A 428A 21ABF2          10      LD  HL,RAMUSE1
00028D 428D 226CF3          16      LD  (RAMUSE+1),HL
000290 4290 21BBF2          10      LD  HL,ROMUSE1
000293 4293 2269F3          16      LD  (ROMUSE+1),HL
                                
000296 4296 3E                      DB  03EH
000297 4297 F7              12      RST 30H
000298 4298 3271FE          13      LD  (H_BINS),A
00029B 429B 3276FE          13      LD  (H_BINL),A
00029E 429E 327BFE          13      LD  (H_FILE),A
0002A1 42A1 3231F3          13      LD  (H_BDOS),A
0002A4 42A4 32A7FF          13      LD  (H_PHYD),A
                                
0002A7 42A7 2640             7      LD  H,040H
0002A9 42A9 CD3A5D          17      CALL    AT_GETSLT
0002AC 42AC 3297F2          13      LD  (ROM_SLT),A
0002AF 42AF 32A7F2          13      LD  (ROM_SLT_COPY),A
0002B2 42B2 3272FE          13      LD  (H_BINS+1),A
0002B5 42B5 3277FE          13      LD  (H_BINL+1),A
0002B8 42B8 327CFE          13      LD  (H_FILE+1),A
0002BB 42BB 3232F3          13      LD  (H_BDOS+1),A
0002BE 42BE 32A8FF          13      LD  (H_PHYD+1),A
0002C1 42C1 3222FB          13      LD  (DRVTBL+1),A
0002C4 42C4 3248F3          13      LD  (MASTERS),A
0002C7 42C7 210047          10      LD  HL,ROM_LOAD
0002CA 42CA 2273FE          16      LD  (H_BINS+2),HL
0002CD 42CD 21B448          10      LD  HL,ROM_RUN
0002D0 42D0 2278FE          16      LD  (H_BINL+2),HL
0002D3 42D3 21C248          10      LD  HL,ROM_FILES
0002D6 42D6 227DFE          16      LD  (H_FILE+2),HL
0002D9 42D9 211C56          10      LD  HL,ROM_BDOS
0002DC 42DC 2233F3          16      LD  (H_BDOS+2),HL
0002DF 42DF 218153          10      LD  HL,DISKIO
0002E2 42E2 22A9FF          16      LD  (H_PHYD+2),HL
                                
0002E5 42E5 3E                      DB  03EH
0002E6 42E6 C9              10      RET
0002E7 42E7 327FFE          13      LD  (H_FILE+4),A
0002EA 42EA 3275FE          13      LD  (H_BINS+4),A
0002ED 42ED 327AFE          13      LD  (H_BINL+4),A
0002F0 42F0 3235F3          13      LD  (H_BDOS+4),A
0002F3 42F3 32DFFD          13      LD  (H_PINL+4),A
0002F6 42F6 32ABFF          13      LD  (H_PHYD+4),A
                                
0002F9 42F9 AF               4      XOR A
                                #if exists USE_MORMAL32K_OR_ASCII16
0002FA 42FA 320060          13      LD  (ASCII16_BANK0_SEL),A       ;似非RAM対策でバンク0を設定
0002FD 42FD 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK0_SEL),A           ;似非RAM対策でバンク0を設定
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000300 4300 3A0060          13      LD  A,(BANK1_ADR)
000303 4303 FE41             7      CP  'A'
                                #if exists USE_MORMAL32K_OR_ASCII16
000305 4305 CA0D44          10      JP  Z,NOT_BANK_TYPE
000308 4308 3E01             7      LD  A,DISK_BANK
00030A 430A 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    JP  NZ,NOT_BANK_TYPE
                                    LD  A,DISK_BANK
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
00030D 430D 26C0             7      LD  H,0C0H
00030F 430F CD3A5D          17      CALL    AT_GETSLT
000312 4312 3244F3          13      LD  (RAMAD3),A
000315 4315 2680             7      LD  H,080H
000317 4317 CD3A5D          17      CALL    AT_GETSLT
00031A 431A CD1A44          17      CALL    CHK_RAM
00031D 431D 3243F3          13      LD  (RAMAD2),A
       4320                     RAMCHK2:
000320 4320 3A44F3          13      LD  A,(RAMAD3)
000323 4323 2640             7      LD  H,040H
000325 4325 CD1A44          17      CALL    CHK_RAM
000328 4328 3242F3          13      LD  (RAMAD1),A
       432B                     RAMCHK1:
00032B 432B 3A44F3          13      LD  A,(RAMAD3)
00032E 432E 2600             7      LD  H,00H
000330 4330 CD1A44          17      CALL    CHK_RAM
000333 4333 3241F3          13      LD  (RAMAD0),A
       4336                     RAMCHK0:
000336 4336 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16
000339 4339 010F00          10      LD  BC,0000FH       ;切り上げ
00033C 433C 09              11      ADD HL,BC
00033D 433D 7D               4      LD  A,L
                                
00033E 433E 0604             7      LD  B,4
       4340                     B_DRIVE1:
000340 4340 CB3C             8      SRL H
000342 4342 1F               4      RRA
000343 4343 10FB            13      DJNZ    B_DRIVE1
                                
000345 4345 C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000347 4347 32E9F2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IX,CHGET
                                    CALL    CALSLT_R
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
                                    ;拡張スロットの選択を設定する
00034A 434A 3A97F2          13      LD  A,(ROM_SLT)
00034D 434D 57               4      LD  D,A
00034E 434E E60C             7      AND 00CH
000350 4350 5F               4      LD  E,A
000351 4351 7A               4      LD  A,D
000352 4352 E603             7      AND 3
000354 4354 87               4      ADD A,A
000355 4355 87               4      ADD A,A
000356 4356 87               4      ADD A,A
000357 4357 37               4      SCF
000358 4358 8F               4      ADC A,A
000359 4359 B3               4      OR  E
00035A 435A 5F               4      LD  E,A
00035B 435B 1600             7      LD  D,0
00035D 435D 21C9FC          10      LD  HL,SLTATR
000360 4360 19              11      ADD HL,DE
000361 4361 3660            10      LD  (HL),060H
                                
000363 4363 3E01             7      LD  A,1
000365 4365 CD0754          17      CALL    IS_BPB
000368 4368 9F               4      SBC A,A
000369 4369 E602             7      AND 2
00036B 436B EE03             7      XOR 3
00036D 436D 32F2F2          13      LD  (_LVECTOR),A
                                    ;CTRL+STOPを抑制する
000370 4370 3E01             7      LD  A,1
000372 4372 32B1FB          13      LD  (BASROM),A
                                
000375 4375 3ACAFF          13      LD  A,(EXTBIO)
000378 4378 FEF7             7      CP  0F7H        ;RST 30H
00037A 437A 280A            12      JR  Z,EXTBIO_OK
00037C 437C 3E                      DB  03EH
00037D 437D C9              10      RET
00037E 437E 21CAFF          10      LD  HL,EXTBIO
000381 4381 061D             7      LD  B,29
000383 4383 CD2B4D          17      CALL    FILL_MEMORY
       4386                     EXTBIO_OK:
000386 4386 AF               4      XOR A
000387 4387 3240F3          13      LD  (REBOOT),A
00038A 438A 2A48FC          16      LD  HL,(BOTTOM)
00038D 438D 110040          10      LD  DE,16384
000390 4390 19              11      ADD HL,DE
000391 4391 DA0A44          10      JP  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
000394 4394 57               4      LD  D,A
000395 4395 0601             7      LD  B,1
000397 4397 2100C0          10      LD  HL,FD_BOOT_START
00039A 439A CD8153          17      CALL    DISKIO
                                
00039D 439D 1168F3          10      LD  DE,ROMUSE
0003A0 43A0 2123F3          10      LD  HL,DISKVE
0003A3 43A3 AF               4      XOR A
0003A4 43A4 CD1EC0          17      CALL    FD_BOOT_EXEC
                                #if exists _RAM64K
                                                ;64K版の場合はページ0をRAMに切り替えRAM側にインタースロットコールを入れる
0003A7 43A7 3A41F3          13      LD  A,(RAMAD0)  ;ページ0をRAMに切り替える
0003AA 43AA CD0C5D          17      CALL    ENASLT_00H
                                
0003AD 43AD AF               4      XOR A
0003AE 43AE 47               4      LD  B,A
0003AF 43AF 67               4      LD  H,A
0003B0 43B0 6F               4      LD  L,A
0003B1 43B1 CD2B4D          17      CALL    FILL_MEMORY
                                
0003B4 43B4 3EC3             7      LD  A,0C3H      ;JP
                                                ;インタースロットコール
0003B6 43B6 210FF1          10      LD  HL,RDSLT
0003B9 43B9 320C00          13      LD  (_RDSLT),A
0003BC 43BC 220D00          16      LD  (_RDSLT+1),HL
                                
0003BF 43BF 212DF1          10      LD  HL,WRSLT
0003C2 43C2 321400          13      LD  (_WRSLT),A
0003C5 43C5 221500          16      LD  (_WRSLT+1),HL
                                
0003C8 43C8 21C1F0          10      LD  HL,CALSLT
0003CB 43CB 321C00          13      LD  (_CALSLT),A
0003CE 43CE 221D00          16      LD  (_CALSLT+1),HL
                                
0003D1 43D1 2119F0          10      LD  HL,ENASLT
0003D4 43D4 322400          13      LD  (_ENASLT),A
0003D7 43D7 222500          16      LD  (_ENASLT+1),HL
                                
0003DA 43DA 21B1F0          10      LD  HL,CALLF
0003DD 43DD 323000          13      LD  (_CALLF),A
0003E0 43E0 223100          16      LD  (_CALLF+1),HL
                                                ;割り込み
0003E3 43E3 2149F1          10      LD  HL,INT38H
0003E6 43E6 323800          13      LD  (00038H),A
0003E9 43E9 223900          16      LD  (00038H+1),HL
                                                ;インタースロットコールの補助
0003EC 43EC 212A5D          10      LD  HL,AT_3B
0003EF 43EF 113B00          10      LD  DE,ENASUB
0003F2 43F2 011000          10      LD  BC,AT_3B_E-AT_3B
0003F5 43F5 EDB0                    LDIR
                                
0003F7 43F7 2A0D00          16      LD  HL,(_RDSLT+1)
0003FA 43FA 110FF1          10      LD  DE,RDSLT
0003FD 43FD AF               4      XOR A
0003FE 43FE ED52            15      SBC HL,DE
000400 4400 1168F3          10      LD  DE,ROMUSE
000403 4403 2123F3          10      LD  HL,DISKVE
000406 4406 37               4      SCF
000407 4407 CC1EC0          17      CALL    Z,FD_BOOT_EXEC
                                #endif
       440A                     BOOT1:
00040A 440A C31E55          10      JP  BASENT
                                
       440D                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
00040D 440D 21C040          10      LD  HL,MSG_ERROR_ROM_MODE
000410 4410 CDB944          17      CALL    MSX
000413 4413 DD219F00        14      LD  IX,CHGET
000417 4417 C39A44          10      JP  CALSLT_R
                                
       441A                     CHK_RAM:
00041A 441A E5              11      PUSH    HL
00041B 441B CD7144          17      CALL    CHK_RAM0
00041E 441E E1              10      POP HL
00041F 441F C8              11      RET Z
000420 4420 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000423 4423 E680             7      AND 080H
000425 4425 CD4644          17      CALL    CHK_RAM_SLT
000428 4428 C8              11      RET Z
000429 4429 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
00042C 442C E680             7      AND 080H
00042E 442E C601             7      ADD A,1
000430 4430 CD4644          17      CALL    CHK_RAM_SLT
000433 4433 C8              11      RET Z
000434 4434 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000437 4437 E680             7      AND 080H
000439 4439 C602             7      ADD A,2
00043B 443B CD4644          17      CALL    CHK_RAM_SLT
00043E 443E C8              11      RET Z
00043F 443F 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000442 4442 E680             7      AND 080H
000444 4444 C603             7      ADD A,3
       4446                     CHK_RAM_SLT:
000446 4446 E5              11      PUSH    HL
000447 4447 CD7144          17      CALL    CHK_RAM0        ;スロット#X or X-0
00044A 444A E1              10      POP HL
00044B 444B C8              11      RET Z
00044C 444C CB79             8      BIT 7,C
00044E 444E 281C            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000450 4450 79               4      LD  A,C
000451 4451 F604             7      OR  4           ;スロット#X-1
000453 4453 E5              11      PUSH    HL
000454 4454 CD7144          17      CALL    CHK_RAM0
000457 4457 E1              10      POP HL
000458 4458 C8              11      RET Z
000459 4459 79               4      LD  A,C
00045A 445A F60C             7      OR  00CH            ;スロット#X-3
00045C 445C E5              11      PUSH    HL
00045D 445D CD7144          17      CALL    CHK_RAM0
000460 4460 E1              10      POP HL
000461 4461 C8              11      RET Z
000462 4462 79               4      LD  A,C
000463 4463 E6F3             7      AND 0F3H            ;スロット#X-2
000465 4465 F608             7      OR  8
000467 4467 E5              11      PUSH    HL
000468 4468 CD7144          17      CALL    CHK_RAM0
00046B 446B E1              10      POP HL
       446C                     CHK_RAM_E:
00046C 446C AF               4      XOR A
00046D 446D 3C               4      INC A           ;ZF=0にする
00046E 446E 3E00             7      LD  A,0
000470 4470 C9              10      RET
                                
       4471                     CHK_RAM0:
000471 4471 4F               4      LD  C,A
000472 4472 2E00             7      LD  L,0
       4474                     CHK_RAM1:
000474 4474 79               4      LD  A,C
000475 4475 CDEB44          17      CALL    RDSLTX
000478 4478 C6E5             7      ADD A,0E5H
00047A 447A 47               4      LD  B,A
00047B 447B 5F               4      LD  E,A
00047C 447C 79               4      LD  A,C
00047D 447D C5              11      PUSH    BC
00047E 447E CD1400          17      CALL    _WRSLT
000481 4481 C1              10      POP BC
000482 4482 79               4      LD  A,C
000483 4483 CDEB44          17      CALL    RDSLTX
000486 4486 B8               4      CP  B
000487 4487 C0              11      RET NZ
000488 4488 D6E5             7      SUB 0E5H
00048A 448A 79               4      LD  A,C
00048B 448B 5F               4      LD  E,A
00048C 448C C5              11      PUSH    BC
00048D 448D CD1400          17      CALL    _WRSLT
000490 4490 C1              10      POP BC
000491 4491 24               4      INC H
000492 4492 7D               4      LD  A,L
000493 4493 C604             7      ADD A,4
000495 4495 6F               4      LD  L,A
000496 4496 20DC            12      JR  NZ,CHK_RAM1
000498 4498 79               4      LD  A,C     ;ZF=1のハズ
000499 4499 C9              10      RET
                                
       449A                     CALSLT_R:
00049A 449A C5              11      PUSH    BC
00049B 449B E5              11      PUSH    HL
00049C 449C F5              11      PUSH    AF
00049D 449D 3A0000          13      LD  A,(0000H)
0004A0 44A0 FEF3             7      CP  0F3H        ;0000H が DI の場合はページ0を BIOS ROM とみなす
0004A2 44A2 280B            12      JR  Z,CALSLT_R2
0004A4 44A4 F1              10      POP AF
0004A5 44A5 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0004A9 44A9 CD1C00          17      CALL    _CALSLT
0004AC 44AC E1              10      POP HL
0004AD 44AD C1              10      POP BC
0004AE 44AE C9              10      RET
       44AF                     CALSLT_R2:
0004AF 44AF F1              10      POP AF
0004B0 44B0 CD98F3          17      CALL    JP_IX
0004B3 44B3 E1              10      POP HL
0004B4 44B4 C1              10      POP BC
0004B5 44B5 C9              10      RET
                                
       44B6                     MSX1:
0004B6 44B6 CD3556          17      CALL    MSGA1
       44B9                     MSX:
0004B9 44B9 7E               7      LD  A,(HL)
0004BA 44BA 23               6      INC HL
0004BB 44BB B7               4      OR  A
0004BC 44BC 20F8            12      JR  NZ,MSX1
0004BE 44BE C9              10      RET
                                
       44BF                     PRTHX:
0004BF 44BF F5              11      PUSH    AF
0004C0 44C0 07               4      RLCA
0004C1 44C1 07               4      RLCA
0004C2 44C2 07               4      RLCA
0004C3 44C3 07               4      RLCA
0004C4 44C4 CDC844          17      CALL    PRTA2
0004C7 44C7 F1              10      POP AF
       44C8                     PRTA2:
0004C8 44C8 CDCE44          17      CALL    ASC
0004CB 44CB C33156          10      JP  MSG_A
                                
       44CE                     ASC:
0004CE 44CE E60F             7      AND 0FH
0004D0 44D0 C630             7      ADD A,'0'
0004D2 44D2 FE3A             7      CP  '9'+1
0004D4 44D4 D8              11      RET C
0004D5 44D5 C607             7      ADD A,7
0004D7 44D7 C9              10      RET
                                
       44D8                     MSN:
                                #if exists USE_MORMAL32K_OR_ASCII16
0004D8 44D8 CDE444          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
0004DB 44DB 23               6      INC HL
0004DC 44DC CD3156          17      CALL    MSG_A
0004DF 44DF 10F7            13      DJNZ    MSN
0004E1 44E1 C9              10      RET
                                
       44E2                     RDSLT_ROM3:
0004E2 44E2 7E               7      LD  A,(HL)
0004E3 44E3 C9              10      RET
       44E4                     RDSLT_ROM:
0004E4 44E4 CB7C             8      BIT 7,H
0004E6 44E6 28FA            12      JR  Z,RDSLT_ROM3
       44E8                     RDSLT_ROM2:
0004E8 44E8 3A97F2          13      LD  A,(ROM_SLT)
       44EB                     RDSLTX:
0004EB 44EB C5              11      PUSH    BC
0004EC 44EC D5              11      PUSH    DE
0004ED 44ED CD0C00          17      CALL    _RDSLT
0004F0 44F0 D1              10      POP DE
0004F1 44F1 C1              10      POP BC
0004F2 44F2 C9              10      RET
                                
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
                                ;
                                ;   ディスクからメモリへの転送
                                ;
       44F3                     ROM_LDIR:
0004F3 44F3 3AD6F2          13      LD  A,(FLG_LDIR)
0004F6 44F6 B7               4      OR  A
0004F7 44F7 2069            12      JR  NZ,ROM_LDIRVM
0004F9 44F9 CB7A             8      BIT 7,D
0004FB 44FB CA9245          10      JP  Z,ROM_LDIRSLT
                                ;
                                ;   ページ2/ページ3
                                ;
                                #if exists USE_MORMAL32K_OR_ASCII16
0004FE 44FE F3               4      DI
0004FF 44FF ED73FEF2        20      LD  (_SP),SP
000503 4503 3AFFF2          13      LD  A,(_SP_H)
000506 4506 FEC0             7      CP  0C0H
000508 4508 3003            12      JR  NC,SPJ1
00050A 450A 315DF5          10      LD  SP,SPBUF
       450D                     SPJ1:
       450D                     LDIR_PAGE2_1:
00050D 450D 78               4      LD  A,B
00050E 450E B1               4      OR  C
00050F 450F 284C            12      JR  Z,LDIRE
                                
000511 4511 C5              11      PUSH    BC
000512 4512 D5              11      PUSH    DE
000513 4513 E5              11      PUSH    HL
000514 4514 3A97F2          13      LD  A,(ROM_SLT)
000517 4517 2680             7      LD  H,080H
000519 4519 CD2400          17      CALL    _ENASLT
00051C 451C E1              10      POP HL
00051D 451D D1              10      POP DE
00051E 451E C1              10      POP BC
       451F                     LDIR_PAGE2_2:
00051F 451F CB72             8      BIT 6,D
000521 4521 202C            12      JR  NZ,LDIR_PAGE2_4
                                
000523 4523 C5              11      PUSH    BC
000524 4524 D5              11      PUSH    DE
000525 4525 115EF5          10      LD  DE,BUF
                                
000528 4528 78               4      LD  A,B
000529 4529 B7               4      OR  A
00052A 452A 2803            12      JR  Z,LDIR_PAGE2_3
00052C 452C 010001          10      LD  BC,00100H       ;B != 0 の場合は256バイトずつ転送
       452F                     LDIR_PAGE2_3:
00052F 452F C5              11      PUSH    BC
000530 4530 EDB0                    LDIR
000532 4532 22FCF2          16      LD  (_HL),HL
                                
000535 4535 3A43F3          13      LD  A,(RAMAD2)
000538 4538 2680             7      LD  H,080H
00053A 453A CD2400          17      CALL    _ENASLT
                                
00053D 453D C1              10      POP BC
00053E 453E D1              10      POP DE
00053F 453F 215EF5          10      LD  HL,BUF
000542 4542 EDB0                    LDIR
                                
000544 4544 2AFCF2          16      LD  HL,(_HL)
000547 4547 C1              10      POP BC
000548 4548 78               4      LD  A,B
000549 4549 B7               4      OR  A
00054A 454A 2811            12      JR  Z,LDIRE
00054C 454C 05               4      DEC B
00054D 454D 18BE            12      JR  LDIR_PAGE2_1
       454F                     LDIR_PAGE2_4:               ;ページ3
                                #endif
00054F 454F EDB0                    LDIR
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
       4551                     LDIRE2:
000551 4551 D5              11      PUSH    DE
000552 4552 E5              11      PUSH    HL
000553 4553 3A43F3          13      LD  A,(RAMAD2)
000556 4556 2680             7      LD  H,080H
000558 4558 CD2400          17      CALL    _ENASLT
00055B 455B E1              10      POP HL
00055C 455C D1              10      POP DE
       455D                     LDIRE:
00055D 455D ED7BFEF2        20      LD  SP,(_SP)
                                #else
                                LDIRE2:
                                #endif
000561 4561 C9              10      RET
                                ;
                                ;   ディスクからV-RAMへの転送
                                ;
       4562                     ROM_LDIRVM:
                                #if exists USE_MORMAL32K_OR_ASCII16
000562 4562 F3               4      DI
000563 4563 ED73FEF2        20      LD  (_SP),SP
000567 4567 3AFFF2          13      LD  A,(_SP_H)
00056A 456A FEC0             7      CP  0C0H
00056C 456C 3003            12      JR  NC,SPJ2
00056E 456E 315DF5          10      LD  SP,SPBUF
       4571                     SPJ2:
000571 4571 C5              11      PUSH    BC
000572 4572 D5              11      PUSH    DE
000573 4573 E5              11      PUSH    HL
000574 4574 3A97F2          13      LD  A,(ROM_SLT)
000577 4577 2680             7      LD  H,080H
000579 4579 CD2400          17      CALL    _ENASLT
00057C 457C E1              10      POP HL
00057D 457D D1              10      POP DE
00057E 457E C1              10      POP BC
                                #endif
00057F 457F C5              11      PUSH    BC
000580 4580 D5              11      PUSH    DE
000581 4581 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000585 4585 DD215C00        14      LD  IX,LDIRVM
000589 4589 CD1C00          17      CALL    _CALSLT
00058C 458C E1              10      POP HL
00058D 458D C1              10      POP BC
00058E 458E 09              11      ADD HL,BC
00058F 458F EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
000590 4590 18BF            12      JR  LDIRE2
                                #else
                                    RET
                                #endif
                                ;
                                ;   ページ0/ページ1
                                ;
       4592                     ROM_LDIRSLT:
                                #if exists USE_MORMAL32K_OR_ASCII16
000592 4592 F3               4      DI
000593 4593 ED73FEF2        20      LD  (_SP),SP
000597 4597 3AFFF2          13      LD  A,(_SP_H)
00059A 459A FEC0             7      CP  0C0H
00059C 459C 3003            12      JR  NC,SPJ3
00059E 459E 315DF5          10      LD  SP,SPBUF
       45A1                     SPJ3:
0005A1 45A1 C5              11      PUSH    BC
0005A2 45A2 D5              11      PUSH    DE
0005A3 45A3 E5              11      PUSH    HL
0005A4 45A4 3A97F2          13      LD  A,(ROM_SLT)
0005A7 45A7 2680             7      LD  H,080H
0005A9 45A9 CD2400          17      CALL    _ENASLT
0005AC 45AC E1              10      POP HL
0005AD 45AD D1              10      POP DE
0005AE 45AE C1              10      POP BC
                                #endif
                                                ;ページ0
0005AF 45AF 3A0000          13      LD  A,(0000H)
0005B2 45B2 FEF3             7      CP  0F3H        ;0000H が DI じゃない場合はページ0は RAM とみなす
0005B4 45B4 280C            12      JR  Z,LDIR_PAGE0_SLT
       45B6                     LDIR_PAGE0_1:
0005B6 45B6 CB72             8      BIT 6,D
0005B8 45B8 2026            12      JR  NZ,LDIR_PAGE1
0005BA 45BA EDA0            16      LDI         ;ページ0 直接転送
0005BC 45BC EAB645          10      JP  PE,LDIR_PAGE0_1
                                #if exists USE_MORMAL32K_OR_ASCII16
0005BF 45BF C35145          10      JP  LDIRE2
                                #else
                                    RET
                                #endif
                                
       45C2                     LDIR_PAGE0_SLT:     ;ページ0 WRSLTを使用
0005C2 45C2 EB               4      EX  DE,HL       ;転送方向(DE)→(HL)
       45C3                     LDIR_PAGE0_SLT1:
0005C3 45C3 CB74             8      BIT 6,H
0005C5 45C5 2018            12      JR  NZ,LDIR_PAGE1_DEHL
0005C7 45C7 1A               7      LD  A,(DE)
0005C8 45C8 13               6      INC DE
0005C9 45C9 D5              11      PUSH    DE
0005CA 45CA 5F               4      LD  E,A
0005CB 45CB E5              11      PUSH    HL
0005CC 45CC C5              11      PUSH    BC
0005CD 45CD 3A41F3          13      LD  A,(RAMAD0)
0005D0 45D0 CD1400          17      CALL    _WRSLT
0005D3 45D3 C1              10      POP BC
0005D4 45D4 E1              10      POP HL
0005D5 45D5 D1              10      POP DE
0005D6 45D6 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0005D8 45D8 EAC345          10      JP  PE,LDIR_PAGE0_SLT1
0005DB 45DB EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
                                #if exists USE_MORMAL32K_OR_ASCII16
0005DC 45DC C35145          10      JP  LDIRE2
                                #else
                                    RET
                                #endif
                                
                                #if exists _RAM64K
       45DF                     LDIR_PAGE1_DEHL:
0005DF 45DF EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
       45E0                     LDIR_PAGE1:         ;ページ1
0005E0 45E0 78               4      LD  A,B
0005E1 45E1 B1               4      OR  C
0005E2 45E2 CA5145          10      JP  Z,LDIRE2
                                
0005E5 45E5 7A               4      LD  A,D
0005E6 45E6 FE7F             7      CP  07FH        ;ページ2と被る可能性？($7FXX)
0005E8 45E8 380F            12      JR  C,LDIR_PAGE1_2
0005EA 45EA 87               4      ADD A,A
0005EB 45EB DA0D45          10      JP  C,LDIR_PAGE2_1  ;ページ2へ
0005EE 45EE 78               4      LD  A,B
0005EF 45EF B7               4      OR  A
0005F0 45F0 7B               4      LD  A,E
0005F1 45F1 2803            12      JR  Z,LDIR_PAGE1_1
0005F3 45F3 B7               4      OR  A           ;B != 0 の場合は256バイト転送
0005F4 45F4 2027            12      JR  NZ,LDIR_PAGE1_SLT_HLDE  ;被る
       45F6                     LDIR_PAGE1_1:
0005F6 45F6 81               4      ADD A,C
0005F7 45F7 3824            12      JR  C,LDIR_PAGE1_SLT_HLDE   ;被る
       45F9                     LDIR_PAGE1_2:
0005F9 45F9 C5              11      PUSH    BC
0005FA 45FA D5              11      PUSH    DE
0005FB 45FB 115EF5          10      LD  DE,BUF
                                
0005FE 45FE 78               4      LD  A,B
0005FF 45FF B7               4      OR  A
000600 4600 2803            12      JR  Z,LDIR_PAGE1_3
000602 4602 010001          10      LD  BC,00100H       ;B != 0 の場合は256バイトずつ転送
       4605                     LDIR_PAGE1_3:
000605 4605 C5              11      PUSH    BC
000606 4606 EDB0                    LDIR
000608 4608 22FCF2          16      LD  (_HL),HL
                                
00060B 460B 3A42F3          13      LD  A,(RAMAD1)
00060E 460E C369F1          10      JP  LDIR_PAGE1_RAM      ;ページ1をRAMにする処理はページ3にある
       4611                     LDIR_PAGE1_ROM:
000611 4611 2AFCF2          16      LD  HL,(_HL)
000614 4614 C1              10      POP BC
000615 4615 78               4      LD  A,B
000616 4616 B7               4      OR  A
000617 4617 CA5145          10      JP  Z,LDIRE2
00061A 461A 05               4      DEC B
00061B 461B 18C3            12      JR  LDIR_PAGE1
                                
       461D                     LDIR_PAGE1_SLT_HLDE:
00061D 461D EB               4      EX  DE,HL       ;転送方向(DE)→(HL)
                                #else
                                LDIR_PAGE1:         ;ページ1 WRSLTを使用
                                LDIR_PAGE1_HLDE:
                                    EX  DE,HL       ;転送方向(DE)→(HL)
                                LDIR_PAGE1_DEHL:
                                #endif
       461E                     LDIR_PAGE1_SLT1:
00061E 461E CB7C             8      BIT 7,H
000620 4620 2018            12      JR  NZ,LDIR_PAGE2_HLDE
000622 4622 1A               7      LD  A,(DE)
000623 4623 13               6      INC DE
000624 4624 D5              11      PUSH    DE
000625 4625 5F               4      LD  E,A
000626 4626 E5              11      PUSH    HL
000627 4627 C5              11      PUSH    BC
000628 4628 3A42F3          13      LD  A,(RAMAD1)
00062B 462B CD1400          17      CALL    _WRSLT
00062E 462E C1              10      POP BC
00062F 462F E1              10      POP HL
000630 4630 D1              10      POP DE
000631 4631 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
000633 4633 EA1E46          10      JP  PE,LDIR_PAGE1_SLT1
000636 4636 EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
                                #if exists USE_MORMAL32K_OR_ASCII16
000637 4637 C35145          10      JP  LDIRE2
       463A                     LDIR_PAGE2_HLDE:            ;ページ2
00063A 463A EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
00063B 463B C30D45          10      JP  LDIR_PAGE2_1
                                #else
                                    RET
                                LDIR_PAGE2_HLDE:            ;ページ2
                                    EX  DE,HL       ;転送方向(HL)→(DE)
                                LDIR_PAGE2_1:
                                    LDIR
                                    RET
                                #endif
                                ;
                                ;   BASIC関連
                                ;
       463E                     END_OF_LINE:
00063E 463E 215EF5          10      LD  HL,BUF
       4641                     EOL1:
000641 4641 7E               7      LD  A,(HL)
000642 4642 C8              11      RET Z
000643 4643 FE0D             7      CP  00DH
000645 4645 2807            12      JR  Z,EOLE
000647 4647 FE0A             7      CP  00AH
000649 4649 2803            12      JR  Z,EOLE
00064B 464B 23               6      INC HL
00064C 464C 18F3            12      JR  EOL1
       464E                     EOLE:
00064E 464E 3600            10      LD  (HL),0
000650 4650 23               6      INC HL
000651 4651 7E               7      LD  A,(HL)
000652 4652 FE0A             7      CP  00AH
000654 4654 C0              11      RET NZ
000655 4655 23               6      INC HL
000656 4656 C9              10      RET
                                ;
                                ;   アスキー形式のファイルを読み込む
                                ;
       4657                     ROM_LOAD_ASCII:
000657 4657 210000          10      LD  HL,0
00065A 465A 22DAF2          16      LD  (_BUF_ST),HL    ;読み出し位置
00065D 465D 2A76F6          16      LD  HL,(TXTTAB)
000660 4660 22DCF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
000663 4663 215EF5          10      LD  HL,BUF
000666 4666 22D4F2          16      LD  (_DTA),HL
       4669                     RLOAD_A1:
000669 4669 2ADAF2          16      LD  HL,(_BUF_ST)
00066C 466C 22CAF2          16      LD  (RR_LOW),HL
00066F 466F 210201          10      LD  HL,258
000672 4672 CD874B          17      CALL    ROM_READ
000675 4675 7C               4      LD  A,H
000676 4676 B5               4      OR  L
000677 4677 2879            12      JR  Z,RLOAD_AEND
000679 4679 015EF5          10      LD  BC,BUF
00067C 467C 09              11      ADD HL,BC
00067D 467D 3600            10      LD  (HL),0
00067F 467F CD3E46          17      CALL    END_OF_LINE
000682 4682 015EF5          10      LD  BC,BUF
000685 4685 A7               4      AND A
000686 4686 ED42            15      SBC HL,BC
000688 4688 2810            12      JR  Z,RLOAD_A2
00068A 468A 4D               4      LD  C,L
00068B 468B 44               4      LD  B,H
00068C 468C ED5BDAF2        20      LD  DE,(_BUF_ST)
000690 4690 19              11      ADD HL,DE
000691 4691 22DAF2          16      LD  (_BUF_ST),HL
000694 4694 3A5EF5          13      LD  A,(BUF)
000697 4697 B7               4      OR  A
000698 4698 28CF            12      JR  Z,RLOAD_A1
       469A                     RLOAD_A2:
00069A 469A 115EF5          10      LD  DE,BUF
00069D 469D CD664D          17      CALL    SPCUTEX
0006A0 46A0 1A               7      LD  A,(DE)
0006A1 46A1 B7               4      OR  A
0006A2 46A2 284E            12      JR  Z,RLOAD_AEND
0006A4 46A4 CD784D          17      CALL    GETNUM
0006A7 46A7 7C               4      LD  A,H
0006A8 46A8 B5               4      OR  L
0006A9 46A9 CAC947          10      JP  Z,ERROR_DIRECT_IN_FILE
0006AC 46AC DD2ADCF2        20      LD  IX,(_BUF_EN)
0006B0 46B0 DD7502          19      LD  (IX+2),L
0006B3 46B3 DD7403          19      LD  (IX+3),H
                                
0006B6 46B6 CD5F4D          17      CALL    SPCUT
0006B9 46B9 EB               4      EX  DE,HL
0006BA 46BA DDE5            15      PUSH    IX
0006BC 46BC DD21B242        14      LD  IX,CRUNCH
0006C0 46C0 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0006C4 46C4 CD1C00          17      CALL    _CALSLT
0006C7 46C7 DDE1            14      POP IX
0006C9 46C9 EB               4      EX  DE,HL
0006CA 46CA 111FF4          10      LD  DE,KBUF
0006CD 46CD 37               4      SCF
0006CE 46CE ED52            15      SBC HL,DE
0006D0 46D0 CAC947          10      JP  Z,ERROR_DIRECT_IN_FILE
0006D3 46D3 DAC947          10      JP  C,ERROR_DIRECT_IN_FILE
0006D6 46D6 4D               4      LD  C,L
0006D7 46D7 44               4      LD  B,H
0006D8 46D8 2ADCF2          16      LD  HL,(_BUF_EN)
0006DB 46DB 110400          10      LD  DE,4
0006DE 46DE 19              11      ADD HL,DE
0006DF 46DF 111FF4          10      LD  DE,KBUF
                                
0006E2 46E2 EB               4      EX  DE,HL
0006E3 46E3 EDB0                    LDIR
0006E5 46E5 EB               4      EX  DE,HL
                                
0006E6 46E6 DD7500          19      LD  (IX+0),L
0006E9 46E9 DD7401          19      LD  (IX+1),H
0006EC 46EC 22DCF2          16      LD  (_BUF_EN),HL
0006EF 46EF C36946          10      JP  RLOAD_A1
                                
       46F2                     RLOAD_AEND:
0006F2 46F2 2ADCF2          16      LD  HL,(_BUF_EN)
0006F5 46F5 AF               4      XOR A
0006F6 46F6 77               7      LD  (HL),A
0006F7 46F7 23               6      INC HL
0006F8 46F8 77               7      LD  (HL),A
0006F9 46F9 23               6      INC HL
0006FA 46FA 22DCF2          16      LD  (_BUF_EN),HL
0006FD 46FD C38C47          10      JP  RLOAD_END1
                                
       4700                     ROM_LOAD:
000700 4700 CD3249          17      CALL    INIT_PARAM
000703 4703 7E               7      LD  A,(HL)
000704 4704 FE2C             7      CP  ','
000706 4706 2003            12      JR  NZ,ROM_LOAD0
000708 4708 23               6      INC HL
000709 4709 7E               7      LD  A,(HL)
00070A 470A 2B               6      DEC HL
       470B                     ROM_LOAD0:
00070B 470B 32BEFC          13      LD  (RUNBNF),A
00070E 470E CD284C          17      CALL    FILE_B
000711 4711 3A01F3          13      LD  A,(FNAME)
000714 4714 FE20             7      CP  020H
000716 4716 CA234C          10      JP  Z,ROM_ORG
                                
000719 4719 CDCF4D          17      CALL    ROM_OPEN
00071C 471C DAD547          10      JP  C,ERROR_FILE_NOT_FOUND
       471F                     ROM_LOAD1:
00071F 471F 21D9F2          10      LD  HL,_BUF
000722 4722 22D4F2          16      LD  (_DTA),HL
000725 4725 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
000728 4728 CD874B          17      CALL    ROM_READ
00072B 472B 3AD9F2          13      LD  A,(_BUF)
00072E 472E 3C               4      INC A
00072F 472F C25746          10      JP  NZ,ROM_LOAD_ASCII
000732 4732 2A76F6          16      LD  HL,(TXTTAB)
000735 4735 22D4F2          16      LD  (_DTA),HL
000738 4738 EB               4      EX  DE,HL
000739 4739 2100FF          10      LD  HL,-256
00073C 473C 39              11      ADD HL,SP
00073D 473D ED52            15      SBC HL,DE
00073F 473F CD874B          17      CALL    ROM_READ
000742 4742 ED5BD4F2        20      LD  DE,(_DTA)
000746 4746 19              11      ADD HL,DE
000747 4747 E5              11      PUSH    HL
000748 4748 2A76F6          16      LD  HL,(TXTTAB)
       474B                     ROM_LOAD2:          ;リンクポインタをFIX
00074B 474B E5              11      PUSH    HL
00074C 474C DDE1            14      POP IX
00074E 474E 7E               7      LD  A,(HL)      ;リンクポインタL
00074F 474F 23               6      INC HL
000750 4750 B6               7      OR  (HL)        ;リンクポインタH
000751 4751 23               6      INC HL
000752 4752 2837            12      JR  Z,RLOAD_END0
000754 4754 23               6      INC HL      ;行番号
000755 4755 23               6      INC HL      ;行番号
       4756                     ROM_LOAD3:
000756 4756 7E               7      LD  A,(HL)
000757 4757 23               6      INC HL
000758 4758 FE0B             7      CP  00BH        ;8進数(&O)
00075A 475A 2822            12      JR  Z,INC_HL2
00075C 475C FE0C             7      CP  00CH        ;16進数(&H)
00075E 475E 281E            12      JR  Z,INC_HL2
000760 4760 FE0D             7      CP  00DH        ;行番号(RUN後)
000762 4762 281A            12      JR  Z,INC_HL2
000764 4764 FE0E             7      CP  00EH        ;行番号(RUN前)
000766 4766 2816            12      JR  Z,INC_HL2
000768 4768 FE0F             7      CP  00FH        ;10～255の整数(%)
00076A 476A 2813            12      JR  Z,INC_HL1
00076C 476C FE1C             7      CP  01CH        ;256～65535の整数(%)
00076E 476E 280E            12      JR  Z,INC_HL2
000770 4770 FE1D             7      CP  01DH        ;単精度実数(!)
000772 4772 2808            12      JR  Z,INC_HL4
000774 4774 FE1F             7      CP  01FH        ;倍制度実数(#)
000776 4776 2008            12      JR  NZ,INC_HL0
000778 4778 23               6      INC HL
000779 4779 23               6      INC HL
00077A 477A 23               6      INC HL
00077B 477B 23               6      INC HL
       477C                     INC_HL4:
00077C 477C 23               6      INC HL
00077D 477D 23               6      INC HL
       477E                     INC_HL2:
00077E 477E 23               6      INC HL
       477F                     INC_HL1:
00077F 477F 23               6      INC HL
       4780                     INC_HL0:
000780 4780 B7               4      OR  A
000781 4781 20D3            12      JR  NZ,ROM_LOAD3
000783 4783 DD7500          19      LD  (IX+0),L
000786 4786 DD7401          19      LD  (IX+1),H
000789 4789 18C0            12      JR  ROM_LOAD2
       478B                     RLOAD_END0:
00078B 478B E1              10      POP HL
       478C                     RLOAD_END1:
00078C 478C 22C2F6          16      LD  (VARTAB),HL
00078F 478F 22C4F6          16      LD  (ARYTAB),HL
000792 4792 22C6F6          16      LD  (STREND),HL
                                
000795 4795 3ABEFC          13      LD  A,(RUNBNF)
000798 4798 CDB94D          17      CALL    CAP
00079B 479B FE52             7      CP  'R'
00079D 479D 280E            12      JR  Z,RLOAD_END2
00079F 479F AF               4      XOR A
0007A0 47A0 21DCF2          10      LD  HL,_BUF+3
0007A3 47A3 77               7      LD  (HL),A      ;3
0007A4 47A4 2B               6      DEC HL
0007A5 47A5 77               7      LD  (HL),A      ;2
0007A6 47A6 2B               6      DEC HL
0007A7 47A7 77               7      LD  (HL),A      ;1
0007A8 47A8 2B               6      DEC HL
0007A9 47A9 3E8F             7      LD  A,08FH      ;REM
0007AB 47AB 77               7      LD  (HL),A      ;0
0007AC 47AC C9              10      RET
       47AD                     RLOAD_END2:
0007AD 47AD D5              11      PUSH    DE
0007AE 47AE ED5B76F6        20      LD  DE,(TXTTAB)
0007B2 47B2 1B               6      DEC DE
0007B3 47B3 AF               4      XOR A
0007B4 47B4 21DFF2          10      LD  HL,_BUF+6
0007B7 47B7 77               7      LD  (HL),A      ;6
0007B8 47B8 2B               6      DEC HL
0007B9 47B9 77               7      LD  (HL),A      ;5
0007BA 47BA 2B               6      DEC HL
0007BB 47BB 77               7      LD  (HL),A      ;4
0007BC 47BC 2B               6      DEC HL
0007BD 47BD 72               7      LD  (HL),D      ;3 行番号H
0007BE 47BE 2B               6      DEC HL
0007BF 47BF 73               7      LD  (HL),E      ;2 行番号L
0007C0 47C0 2B               6      DEC HL
0007C1 47C1 360D            10      LD  (HL),00DH   ;1 行番号(RUN後)
0007C3 47C3 2B               6      DEC HL
0007C4 47C4 3E89             7      LD  A,089H      ;GOTO
0007C6 47C6 77               7      LD  (HL),A      ;0
0007C7 47C7 D1              10      POP DE
0007C8 47C8 C9              10      RET
                                
       47C9                     ERROR_DIRECT_IN_FILE:
0007C9 47C9 1E39             7      LD  E,57            ;Direct statement in file
0007CB 47CB 01                      DB  1           ;LD BC,
       47CC                     ERROR_DEVICE_IO_ERROR:
0007CC 47CC 1E13             7      LD  E,19            ;Device I/O error
0007CE 47CE 01                      DB  1           ;LD BC,
       47CF                     ERROR_INTERNAL_ERROR:
0007CF 47CF 1E33             7      LD  E,51            ;Internal error
0007D1 47D1 01                      DB  1           ;LD BC,
       47D2                     ERROR_FILE_NOT_OPEN:
0007D2 47D2 1E3B             7      LD  E,59            ;File not OPEN
0007D4 47D4 01                      DB  1           ;LD BC,
       47D5                     ERROR_FILE_NOT_FOUND:
0007D5 47D5 1E35             7      LD  E,53            ;File not found
       47D7                     ERROR:
0007D7 47D7 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0007DB 47DB DD216F40        14      LD  IX,ERRHAND
0007DF 47DF C31C00          10      JP  _CALSLT
                                
       47E2                     ROM_BLOAD:
0007E2 47E2 CD3249          17      CALL    INIT_PARAM
0007E5 47E5 CD284C          17      CALL    FILE_B
0007E8 47E8 CDCF4D          17      CALL    ROM_OPEN
0007EB 47EB 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
0007ED 47ED 21D9F2          10      LD  HL,_BUF
0007F0 47F0 22D4F2          16      LD  (_DTA),HL
0007F3 47F3 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
0007F6 47F6 CD874B          17      CALL    ROM_READ
0007F9 47F9 3AD9F2          13      LD  A,(_BUF)
0007FC 47FC FEFE             7      CP  0FEH
0007FE 47FE 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
000800 4800 21A5F2          10      LD  HL,BLOAD_RET
000803 4803 229DF2          16      LD  (SWC_BLOAD),HL
                                
000806 4806 2AF7F2          16      LD  HL,(PARAM1)
000809 4809 7E               7      LD  A,(HL)
00080A 480A FE2C             7      CP  ','
00080C 480C 204C            12      JR  NZ,RBREAD_MEM
00080E 480E 23               6      INC HL
00080F 480F 7E               7      LD  A,(HL)
000810 4810 CDB94D          17      CALL    CAP
000813 4813 32BEFC          13      LD  (RUNBNF),A
000816 4816 FE52             7      CP  'R'     ;R,Sスイッチじゃ無い場合はオフセット値として処理する
000818 4818 2808            12      JR  Z,RBOS1
00081A 481A FE53             7      CP  'S'
00081C 481C 2804            12      JR  Z,RBOS1
00081E 481E FE2C             7      CP  ','
000820 4820 200D            12      JR  NZ,RBOS2
       4822                     RBOS1:
000822 4822 7E               7      LD  A,(HL)
000823 4823 23               6      INC HL
000824 4824 B7               4      OR  A
000825 4825 2824            12      JR  Z,RBREAD_OSE
000827 4827 FE3A             7      CP  ':'
000829 4829 2820            12      JR  Z,RBREAD_OSE
00082B 482B FE2C             7      CP  ','     ;次のパラメータを探す
00082D 482D 20F3            12      JR  NZ,RBOS1
       482F                     RBOS2:              ;オフセット
00082F 482F 22F7F2          16      LD  (PARAM1),HL
000832 4832 7E               7      LD  A,(HL)
000833 4833 B7               4      OR  A
000834 4834 2815            12      JR  Z,RBREAD_OSE
000836 4836 DD212F54        14      LD  IX,FRMQNT
00083A 483A FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00083E 483E CD1C00          17      CALL    _CALSLT
000841 4841 22F7F2          16      LD  (PARAM1),HL
000844 4844 2ADAF2          16      LD  HL,(_BUF_ST)
000847 4847 19              11      ADD HL,DE
000848 4848 22DAF2          16      LD  (_BUF_ST),HL
       484B                     RBREAD_OSE:
00084B 484B 3ABEFC          13      LD  A,(RUNBNF)
00084E 484E FE53             7      CP  'S'
000850 4850 2008            12      JR  NZ,RBREAD_MEM
000852 4852 CD154B          17      CALL    WAIT_VDP
000855 4855 3E01             7      LD  A,1
000857 4857 32D6F2          13      LD  (FLG_LDIR),A
       485A                     RBREAD_MEM:
00085A 485A 2ADAF2          16      LD  HL,(_BUF_ST)
00085D 485D 22BFFC          16      LD  (SAVENT),HL
000860 4860 22D4F2          16      LD  (_DTA),HL
000863 4863 21FFFF          10      LD  HL,0FFFFH
000866 4866 CD874B          17      CALL    ROM_READ
000869 4869 AF               4      XOR A
00086A 486A 32D6F2          13      LD  (FLG_LDIR),A
00086D 486D 3ABEFC          13      LD  A,(RUNBNF)
000870 4870 FE52             7      CP  'R'
000872 4872 2006            12      JR  NZ,RBREAD1
000874 4874 2ADEF2          16      LD  HL,(_BUF_EX)
000877 4877 229DF2          16      LD  (SWC_BLOAD),HL
       487A                     RBREAD1:
       487A                     ROM_NEXT:
00087A 487A 2AF7F2          16      LD  HL,(PARAM1)
00087D 487D 7E               7      LD  A,(HL)
00087E 487E 2B               6      DEC HL
00087F 487F B7               4      OR  A
000880 4880 2805            12      JR  Z,ROM_NEXT1
000882 4882 FE3A             7      CP  ':'
000884 4884 2801            12      JR  Z,ROM_NEXT1
000886 4886 23               6      INC HL
       4887                     ROM_NEXT1:
000887 4887 5D               4      LD  E,L
000888 4888 54               4      LD  D,H
                                
000889 4889 CD8F4D          17      CALL    SEARCH_END
00088C 488C B7               4      OR  A
00088D 488D 2821            12      JR  Z,REM
       488F                     RN3:                    ;マルチステートメントの処理
00088F 488F 7E               7      LD  A,(HL)
                                
000890 4890 FEB5             7      CP  0B5H            ;LOAD
000892 4892 CA0047          10      JP  Z,ROM_LOAD
000895 4895 FE8A             7      CP  08AH            ;RUN
000897 4897 281B            12      JR  Z,ROM_RUN
000899 4899 FEB7             7      CP  0B7H            ;FILES
00089B 489B 2825            12      JR  Z,ROM_FILES
00089D 489D FED6             7      CP  0D6H            ;COPY
00089F 489F CA6749          10      JP  Z,ROM_COPY
0008A2 48A2 FE20             7      CP  020H
0008A4 48A4 2807            12      JR  Z,RN_SP
                                
0008A6 48A6 3E28             7      LD  A,028H          ;JR Z,
0008A8 48A8 32A3F2          13      LD  (SWC_BLOAD_M),A
0008AB 48AB 7E               7      LD  A,(HL)
0008AC 48AC C9              10      RET
       48AD                     RN_SP:
0008AD 48AD 23               6      INC HL
0008AE 48AE 18DF            12      JR  RN3
                                
       48B0                     REM:
0008B0 48B0 EB               4      EX  DE,HL
0008B1 48B1 3E8F             7      LD  A,08FH          ;REM
0008B3 48B3 C9              10      RET
                                
       48B4                     ROM_RUN:
0008B4 48B4 23               6      INC HL
0008B5 48B5 7E               7      LD  A,(HL)
0008B6 48B6 2B               6      DEC HL
0008B7 48B7 B7               4      OR  A
0008B8 48B8 C40047          17      CALL    NZ,ROM_LOAD
0008BB 48BB FE8F             7      CP  08FH            ;REM
0008BD 48BD 3E8A             7      LD  A,08AH          ;RUN
0008BF 48BF C0              11      RET NZ
0008C0 48C0 77               7      LD  (HL),A
0008C1 48C1 C9              10      RET
                                
       48C2                     ROM_FILES:
0008C2 48C2 CD3249          17      CALL    INIT_PARAM
0008C5 48C5 CD284C          17      CALL    FILE_B
0008C8 48C8 CDC055          17      CALL    GET_DISK_BANK_FDRV
0008CB 48CB 3AC9F2          13      LD  A,(SECSZ_H)
0008CE 48CE CD1954          17      CALL    IS_BPB1
0008D1 48D1 DACC47          10      JP  C,ERROR_DEVICE_IO_ERROR
0008D4 48D4 3A01F3          13      LD  A,(FNAME)
0008D7 48D7 FE21             7      CP  021H
0008D9 48D9 3005            12      JR  NC,RFILES0
0008DB 48DB 060B             7      LD  B,11
0008DD 48DD CD1F4D          17      CALL    FILE10
       48E0                     RFILES0:
0008E0 48E0 CD9250          17      CALL    GET_DIR_DAT
       48E3                     RFILES1:
0008E3 48E3 CD434E          17      CALL    FILESE
0008E6 48E6 3045            12      JR  NC,RFILES_NOT_MATCH
       48E8                     RFILES_DISP:
0008E8 48E8 E5              11      PUSH    HL
0008E9 48E9 110B00          10      LD  DE,0000BH   ;属性
0008EC 48EC 19              11      ADD HL,DE
                                #if exists USE_MORMAL32K_OR_ASCII16
0008ED 48ED CDE444          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
0008F0 48F0 E1              10      POP HL
0008F1 48F1 CB4F             8      BIT 1,A     ;不可視属性
0008F3 48F3 2035            12      JR  NZ,RFILES_NEXT
0008F5 48F5 E5              11      PUSH    HL
0008F6 48F6 0608             7      LD  B,8
0008F8 48F8 CDD844          17      CALL    MSN
                                #if exists USE_MORMAL32K_OR_ASCII16
0008FB 48FB CDE444          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
0008FE 48FE FE20             7      CP  020H
000900 4900 F5              11      PUSH    AF
000901 4901 3E2E             7      LD  A,'.'
000903 4903 C43156          17      CALL    NZ,MSG_A
000906 4906 0603             7      LD  B,3
000908 4908 CDD844          17      CALL    MSN
00090B 490B F1              10      POP AF
00090C 490C CC3156          17      CALL    Z,MSG_A
00090F 490F 3ADDF3          13      LD  A,(CSRX)
000912 4912 47               4      LD  B,A
000913 4913 3AB0F3          13      LD  A,(LINLEN)
000916 4916 90               4      SUB B
000917 4917 FE0C             7      CP  12
000919 4919 3009            12      JR  NC,RFILES2
00091B 491B 3E0D             7      LD  A,00DH      ;改行
00091D 491D CD3156          17      CALL    MSG_A
000920 4920 3E0A             7      LD  A,00AH
000922 4922 1802            12      JR  RFILES3
       4924                     RFILES2:
000924 4924 3E20             7      LD  A,020H
       4926                     RFILES3:
000926 4926 CD3156          17      CALL    MSG_A
000929 4929 E1              10      POP HL
       492A                     RFILES_NEXT:
00092A 492A CD614E          17      CALL    FNEXT
       492D                     RFILES_NOT_MATCH:
00092D 492D 20B4            12      JR  NZ,RFILES1
00092F 492F C37A48          10      JP  ROM_NEXT
                                
       4932                     INIT_PARAM:
000932 4932 22F5F2          16      LD  (PARAM0),HL
000935 4935 22F7F2          16      LD  (PARAM1),HL
000938 4938 EB               4      EX  DE,HL
000939 4939 32BEFC          13      LD  (RUNBNF),A
00093C 493C 3263F6          13      LD  (VALTYP),A
00093F 493F E5              11      PUSH    HL
000940 4940 3AEAF2          13      LD  A,(_DVSW)
000943 4943 CDA255          17      CALL    GET_CD
000946 4946 22F9F2          16      LD  (_CDX),HL
000949 4949 E1              10      POP HL
00094A 494A 13               6      INC DE
00094B 494B CD5F4D          17      CALL    SPCUT
00094E 494E 1A               7      LD  A,(DE)
00094F 494F B7               4      OR  A
000950 4950 C8              11      RET Z
000951 4951 FE3A             7      CP  ':'
000953 4953 C8              11      RET Z
000954 4954 FE28             7      CP  '('
000956 4956 C8              11      RET Z
000957 4957 EB               4      EX  DE,HL
000958 4958 DD21644C        14      LD  IX,FRMEVL
00095C 495C FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000960 4960 CD1C00          17      CALL    _CALSLT
000963 4963 22F7F2          16      LD  (PARAM1),HL
000966 4966 C9              10      RET
                                
       4967                     ROM_COPY:
000967 4967 CD3249          17      CALL    INIT_PARAM
00096A 496A 3A63F6          13      LD  A,(VALTYP)
00096D 496D FE03             7      CP  3       ;string
00096F 496F C2234C          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
000972 4972 CD284C          17      CALL    FILE_B
000975 4975 CDCF4D          17      CALL    ROM_OPEN
000978 4978 DAD547          10      JP  C,ERROR_FILE_NOT_FOUND
                                
00097B 497B 21DEF2          10      LD  HL,_BUF_W
00097E 497E 22D4F2          16      LD  (_DTA),HL
000981 4981 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
000984 4984 CD874B          17      CALL    ROM_READ
                                
000987 4987 AF               4      XOR A
000988 4988 32D9F2          13      LD  (_BUF_LO),A     ;PSET
00098B 498B 32E6F2          13      LD  (_BUF_O),A      ;向き
                                
00098E 498E 2AF7F2          16      LD  HL,(PARAM1)
       4991                     RCP_PARAM1:
000991 4991 7E               7      LD  A,(HL)
000992 4992 23               6      INC HL
000993 4993 B7               4      OR  A
000994 4994 CA8748          10      JP  Z,ROM_NEXT1
000997 4997 FE3A             7      CP  ':'
000999 4999 CA8748          10      JP  Z,ROM_NEXT1
00099C 499C FE2C             7      CP  ','
00099E 499E 2012            12      JR  NZ,RCP_PARAM1_
                                
0009A0 49A0 DD212F54        14      LD  IX,FRMQNT
0009A4 49A4 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009A8 49A8 CD1C00          17      CALL    _CALSLT
0009AB 49AB 7B               4      LD  A,E
0009AC 49AC 87               4      ADD A,A
0009AD 49AD 87               4      ADD A,A
0009AE 49AE 32E6F2          13      LD  (_BUF_O),A
0009B1 49B1 7E               7      LD  A,(HL)
       49B2                     RCP_PARAM1_:
0009B2 49B2 FE28             7      CP  '('
0009B4 49B4 20DB            12      JR  NZ,RCP_PARAM1
0009B6 49B6 DD212F54        14      LD  IX,FRMQNT
0009BA 49BA FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009BE 49BE CD1C00          17      CALL    _CALSLT
                                
0009C1 49C1 ED53E2F2        20      LD  (_BUF_X),DE
                                
       49C5                     RCP_PARAM2:
0009C5 49C5 23               6      INC HL
0009C6 49C6 7E               7      LD  A,(HL)
0009C7 49C7 FE20             7      CP  020H
0009C9 49C9 28FA            12      JR  Z,RCP_PARAM2
0009CB 49CB FE2C             7      CP  ','
0009CD 49CD 28F6            12      JR  Z,RCP_PARAM2
                                
0009CF 49CF DD212F54        14      LD  IX,FRMQNT
0009D3 49D3 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009D7 49D7 CD1C00          17      CALL    _CALSLT
                                
0009DA 49DA 3AF6FA          13      LD  A,(ACPAGE)
0009DD 49DD 57               4      LD  D,A
0009DE 49DE ED53E4F2        20      LD  (_BUF_Y),DE
       49E2                     RCP_PARAM3:
0009E2 49E2 23               6      INC HL
0009E3 49E3 7E               7      LD  A,(HL)
0009E4 49E4 FE20             7      CP  020H
0009E6 49E6 28FA            12      JR  Z,RCP_PARAM3
0009E8 49E8 FE29             7      CP  ')'
0009EA 49EA 28F6            12      JR  Z,RCP_PARAM3
0009EC 49EC FE2C             7      CP  ','
0009EE 49EE 2033            12      JR  NZ,RCP_ST
                                
0009F0 49F0 23               6      INC HL
0009F1 49F1 DD212F54        14      LD  IX,FRMQNT
0009F5 49F5 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009F9 49F9 CD1C00          17      CALL    _CALSLT
                                
0009FC 49FC 7B               4      LD  A,E
0009FD 49FD 32E5F2          13      LD  (_BUF_P),A
                                
       4A00                     RCP_PARAM4:
000A00 4A00 7E               7      LD  A,(HL)
000A01 4A01 23               6      INC HL
000A02 4A02 FE20             7      CP  020H
000A04 4A04 28FA            12      JR  Z,RCP_PARAM4
                                
000A06 4A06 FE2C             7      CP  ','
000A08 4A08 2019            12      JR  NZ,RCP_ST
                                
000A0A 4A0A 7E               7      LD  A,(HL)
000A0B 4A0B 0604             7      LD  B,4
000A0D 4A0D FEC3             7      CP  0C3H        ;PRESET
000A0F 4A0F 280E            12      JR  Z,RCP_LO
000A11 4A11 05               4      DEC B       ;3
000A12 4A12 D6F8             7      SUB 0F8H        ;XOR
000A14 4A14 2809            12      JR  Z,RCP_LO
000A16 4A16 05               4      DEC B       ;2
000A17 4A17 3C               4      INC A       ;OR
000A18 4A18 2805            12      JR  Z,RCP_LO
000A1A 4A1A 05               4      DEC B       ;1
000A1B 4A1B 3C               4      INC A       ;AND
000A1C 4A1C 2801            12      JR  Z,RCP_LO
000A1E 4A1E 05               4      DEC B       ;0
                                                ;PSET
       4A1F                     RCP_LO:
000A1F 4A1F 78               4      LD  A,B
000A20 4A20 32D9F2          13      LD  (_BUF_LO),A
       4A23                     RCP_ST:
000A23 4A23 2AC6F6          16      LD  HL,(STREND)
000A26 4A26 22D4F2          16      LD  (_DTA),HL
000A29 4A29 EB               4      EX  DE,HL
000A2A 4A2A 2100FE          10      LD  HL,-512
000A2D 4A2D 39              11      ADD HL,SP
000A2E 4A2E AF               4      XOR A
000A2F 4A2F ED52            15      SBC HL,DE
000A31 4A31 3008            12      JR  NC,RCP0
000A33 4A33 215EF5          10      LD  HL,BUF
000A36 4A36 22D4F2          16      LD  (_DTA),HL
000A39 4A39 6F               4      LD  L,A ;0
000A3A 4A3A 67               4      LD  H,A ;0
       4A3B                     RCP0:
000A3B 4A3B 24               4      INC H
000A3C 4A3C 22DCF2          16      LD  (_BUF_EN),HL
       4A3F                     RCP1:
000A3F 4A3F F3               4      DI
000A40 4A40 CD154B          17      CALL    WAIT_VDP
                                
000A43 4A43 3A0700          13      LD  A,(WRVDP)
000A46 4A46 4F               4      LD  C,A
000A47 4A47 0C               4      INC C       ;C := PORT#1's address(WR)
000A48 4A48 3E24             7      LD  A,36
000A4A 4A4A ED79            12      OUT (C),A
000A4C 4A4C 3E91             7      LD  A,080H+17
000A4E 4A4E ED79            12      OUT (C),A       ;R#17 := 36
                                
000A50 4A50 0C               4      INC C
000A51 4A51 0C               4      INC C       ;C := PORT#3's address(WR)
000A52 4A52 2AE2F2          16      LD  HL,(_BUF_X)
000A55 4A55 ED69            12      OUT (C),L       ;R#36 DX
000A57 4A57 ED61            12      OUT (C),H       ;R#37
000A59 4A59 2AE4F2          16      LD  HL,(_BUF_Y)
000A5C 4A5C ED69            12      OUT (C),L       ;R#38 DY
000A5E 4A5E ED61            12      OUT (C),H       ;R#39
000A60 4A60 2ADEF2          16      LD  HL,(_BUF_W)
000A63 4A63 ED69            12      OUT (C),L       ;R#40 NX
000A65 4A65 ED61            12      OUT (C),H       ;R#41
000A67 4A67 2AE0F2          16      LD  HL,(_BUF_H)
000A6A 4A6A ED69            12      OUT (C),L       ;R#42 NY
000A6C 4A6C ED61            12      OUT (C),H       ;R#43
                                
000A6E 4A6E DD2AAFFC        20      LD  IX,(SCRMOD)
000A72 4A72 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000A75 4A75 B7               4      OR  A
000A76 4A76 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000A78 4A78 DD7D             9      LD  A,IXL
000A7A 4A7A FE08             7      CP  8
000A7C 4A7C 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
000A7E 4A7E FE06             7      CP  6
000A80 4A80 2AE2F2          16      LD  HL,(_BUF_X)
000A83 4A83 3ADEF2          13      LD  A,(_BUF_W)
000A86 4A86 2005            12      JR  NZ,SCR57
000A88 4A88 B5               4      OR  L       ;スクリーン6
000A89 4A89 E603             7      AND 3
000A8B 4A8B 200D            12      JR  NZ,USE_LMMC
       4A8D                     SCR57:              ;スクリーン5,7
000A8D 4A8D B5               4      OR  L
000A8E 4A8E E601             7      AND 1
000A90 4A90 2008            12      JR  NZ,USE_LMMC
       4A92                     USE_HMMC:
000A92 4A92 DD2E08          10      LD  IXL,8
       4A95                     USE_HMMC8:
000A95 4A95 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
000A97 4A97 32D9F2          13      LD  (_BUF_LO),A
       4A9A                     USE_LMMC:
000A9A 4A9A 110000          10      LD  DE,0
000A9D 4A9D 06FF             7      LD  B,-1
000A9F 4A9F CD404B          17      CALL    GET_PIXEL
000AA2 4AA2 ED79            12      OUT (C),A       ;R#44 first DATA
000AA4 4AA4 3AE6F2          13      LD  A,(_BUF_O)
000AA7 4AA7 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
000AA9 4AA9 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000AAC 4AAC F6B0             7      OR  0B0H        ;R#46 LMMC command
000AAE 4AAE ED79            12      OUT (C),A
                                
000AB0 4AB0 FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
000AB2 4AB2 0D               4      DEC C
000AB3 4AB3 0D               4      DEC C       ;C := PORT#1's address(WR)
000AB4 4AB4 3EAC             7      LD  A,080H+44
000AB6 4AB6 ED79            12      OUT (C),A
000AB8 4AB8 3E91             7      LD  A,080H+17
000ABA 4ABA ED79            12      OUT (C),A       ;R#17 := 44
                                
000ABC 4ABC 3A0600          13      LD  A,(RDVDP)
000ABF 4ABF 3C               4      INC A
000AC0 4AC0 FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
000AC2 4AC2 3E02             7      LD  A,2
000AC4 4AC4 ED79            12      OUT (C),A
000AC6 4AC6 3E8F             7      LD  A,08FH
000AC8 4AC8 ED79            12      OUT (C),A
000ACA 4ACA 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000ACD 4ACD E640             7      AND 040H
000ACF 4ACF 201C            12      JR  NZ,LOOP_HMMC
       4AD1                     LOOP_COPY:
000AD1 4AD1 CD404B          17      CALL    GET_PIXEL
000AD4 4AD4 08               4      EX  AF,AF'
000AD5 4AD5 FD4C             9      LD  C,IYH
       4AD7                     LOOP_COPY1:
000AD7 4AD7 ED78            12      IN  A,(C)
000AD9 4AD9 0F               4      RRCA            ;RRCAではサインフラグは変化しない
000ADA 4ADA 300A            12      JR  NC,EXIT_COPY    ;check CE bit
000ADC 4ADC F2D74A          10      JP  P,LOOP_COPY1    ;check TR bit
000ADF 4ADF 08               4      EX  AF,AF'
000AE0 4AE0 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000AE2 4AE2 ED79            12      OUT (C),A
000AE4 4AE4 18EB            12      JR  LOOP_COPY
                                
       4AE6                     EXIT_COPY:
000AE6 4AE6 CD1D4B          17      CALL    GET_STATUS_0
000AE9 4AE9 FB               4      EI
000AEA 4AEA C37A48          10      JP  ROM_NEXT
                                
       4AED                     LOOP_HMMC:
000AED 4AED F3               4      DI          ;必要
000AEE 4AEE FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000AF0 4AF0 43               4      LD  B,E
000AF1 4AF1 7B               4      LD  A,E
000AF2 4AF2 B7               4      OR  A
000AF3 4AF3 2802            12      JR  Z,LOOP_HMMC1
000AF5 4AF5 EDB3                    OTIR
       4AF7                     LOOP_HMMC1:
000AF7 4AF7 14               4      INC D
       4AF8                     LOOP_HMMC2:
000AF8 4AF8 15               4      DEC D
000AF9 4AF9 2805            12      JR  Z,LOOP_HMMC3
000AFB 4AFB EDB3                    OTIR
000AFD 4AFD C3F84A          10      JP  LOOP_HMMC2
       4B00                     LOOP_HMMC3:
000B00 4B00 ED78            12      IN  A,(C)
000B02 4B02 0F               4      RRCA
000B03 4B03 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
000B05 4B05 2ADCF2          16      LD  HL,(_BUF_EN)
000B08 4B08 CD874B          17      CALL    ROM_READ
000B0B 4B0B EB               4      EX  DE,HL
000B0C 4B0C 2AD4F2          16      LD  HL,(_DTA)
000B0F 4B0F 7A               4      LD  A,D
000B10 4B10 B3               4      OR  E
000B11 4B11 20DA            12      JR  NZ,LOOP_HMMC
000B13 4B13 18C2            12      JR  LOOP_COPY1
                                
       4B15                     WAIT_VDP:
000B15 4B15 3E02             7      LD  A,2
000B17 4B17 CD1E4B          17      CALL    GET_STATUS
000B1A 4B1A 0F               4      RRCA
000B1B 4B1B 38F8            12      JR  C,WAIT_VDP
       4B1D                     GET_STATUS_0:
000B1D 4B1D AF               4      XOR A
       4B1E                     GET_STATUS:
000B1E 4B1E C5              11      PUSH    BC
000B1F 4B1F ED4B0600        20      LD  BC,(RDVDP)
000B23 4B23 0C               4      INC C
000B24 4B24 ED79            12      OUT (C),A
000B26 4B26 3E8F             7      LD  A,08FH
000B28 4B28 ED79            12      OUT (C),A
000B2A 4B2A ED78            12      IN  A,(C)
000B2C 4B2C C1              10      POP BC
000B2D 4B2D C9              10      RET
                                
       4B2E                     GET_PIXEL256:
000B2E 4B2E 7A               4      LD  A,D
000B2F 4B2F B3               4      OR  E
000B30 4B30 200A            12      JR  NZ,GET_PIXEL1
000B32 4B32 2ADCF2          16      LD  HL,(_BUF_EN)
000B35 4B35 CD874B          17      CALL    ROM_READ
000B38 4B38 EB               4      EX  DE,HL
000B39 4B39 2AD4F2          16      LD  HL,(_DTA)
       4B3C                     GET_PIXEL1:
000B3C 4B3C 7E               7      LD  A,(HL)
000B3D 4B3D 23               6      INC HL
000B3E 4B3E 1B               6      DEC DE
000B3F 4B3F C9              10      RET
                                
       4B40                     GET_PIXEL:
000B40 4B40 DD7D             9      LD  A,IXL
000B42 4B42 FE08             7      CP  8
000B44 4B44 28E8            12      JR  Z,GET_PIXEL256
000B46 4B46 04               4      INC B
000B47 4B47 FE06             7      CP  6
000B49 4B49 282E            12      JR  Z,GET_PIXEL4
                                
000B4B 4B4B CB40             8      BIT 0,B
000B4D 4B4D 20ED            12      JR  NZ,GET_PIXEL1
                                
000B4F 4B4F 7A               4      LD  A,D
000B50 4B50 B3               4      OR  E
000B51 4B51 200A            12      JR  NZ,GET_PIXEL2
                                
000B53 4B53 2ADCF2          16      LD  HL,(_BUF_EN)
000B56 4B56 CD874B          17      CALL    ROM_READ
000B59 4B59 EB               4      EX  DE,HL
000B5A 4B5A 2AD4F2          16      LD  HL,(_DTA)
                                
       4B5D                     GET_PIXEL2:
000B5D 4B5D 7E               7      LD  A,(HL)
000B5E 4B5E 0F               4      RRCA
000B5F 4B5F 0F               4      RRCA
000B60 4B60 0F               4      RRCA
000B61 4B61 0F               4      RRCA
000B62 4B62 C9              10      RET
                                
       4B63                     GET_PIXEL3:
000B63 4B63 7A               4      LD  A,D
000B64 4B64 B3               4      OR  E
000B65 4B65 200A            12      JR  NZ,GET_PIXEL5
                                
000B67 4B67 2ADCF2          16      LD  HL,(_BUF_EN)
000B6A 4B6A CD874B          17      CALL    ROM_READ
000B6D 4B6D EB               4      EX  DE,HL
000B6E 4B6E 2AD4F2          16      LD  HL,(_DTA)
       4B71                     GET_PIXEL5:
000B71 4B71 7E               7      LD  A,(HL)
000B72 4B72 0F               4      RRCA
000B73 4B73 0F               4      RRCA
000B74 4B74 0F               4      RRCA
000B75 4B75 0F               4      RRCA
000B76 4B76 0F               4      RRCA
000B77 4B77 0F               4      RRCA
000B78 4B78 C9              10      RET
                                
       4B79                     GET_PIXEL4:
000B79 4B79 78               4      LD  A,B
000B7A 4B7A E603             7      AND 3   ;+0
000B7C 4B7C 28E5            12      JR  Z,GET_PIXEL3
000B7E 4B7E 3D               4      DEC A   ;+1
000B7F 4B7F 28DC            12      JR  Z,GET_PIXEL2
000B81 4B81 3D               4      DEC A   ;+2
000B82 4B82 7E               7      LD  A,(HL)
000B83 4B83 C0              11      RET NZ
000B84 4B84 0F               4      RRCA        ;+3
000B85 4B85 0F               4      RRCA
000B86 4B86 C9              10      RET
                                
       4B87                     ROM_READ:
000B87 4B87 E5              11      PUSH    HL
000B88 4B88 D5              11      PUSH    DE
000B89 4B89 C5              11      PUSH    BC
000B8A 4B8A FDE5            15      PUSH    IY
000B8C 4B8C 22F3F2          16      LD  (LEFTX),HL
000B8F 4B8F 2AD4F2          16      LD  HL,(_DTA)
000B92 4B92 22E7F2          16      LD  (DTAX),HL
000B95 4B95 2AF3F2          16      LD  HL,(LEFTX)
                                
000B98 4B98 CDA84E          17      CALL    RBX1
000B9B 4B9B 3870            12      JR  C,RBRERR1
000B9D 4B9D 79               4      LD  A,C
000B9E 4B9E EB               4      EX  DE,HL
000B9F 4B9F ED52            15      SBC HL,DE       ;CP 0HL,CDE
000BA1 4BA1 19              11      ADD HL,DE
000BA2 4BA2 DE00             7      SBC A,000H
000BA4 4BA4 3801            12      JR  C,RBR1
000BA6 4BA6 EB               4      EX  DE,HL
       4BA7                     RBR1:
000BA7 4BA7 9F               4      SBC A,A
000BA8 4BA8 E601             7      AND 1
000BAA 4BAA 32C3F2          13      LD  (_RESULT),A
000BAD 4BAD 7C               4      LD  A,H
000BAE 4BAE B5               4      OR  L
000BAF 4BAF CA034C          10      JP  Z,RBREND0
                                
000BB2 4BB2 22D0F2          16      LD  (_LEFT),HL  ;Read record byte
000BB5 4BB5 22F3F2          16      LD  (LEFTX),HL
                                
000BB8 4BB8 CDDB4E          17      CALL    RBX2
000BBB 4BBB 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000BBD 4BBD CDEE4E          17      CALL    RBXA
000BC0 4BC0 DA194C          10      JP  C,RBRERR
000BC3 4BC3 C5              11      PUSH    BC
000BC4 4BC4 CDF344          17      CALL    ROM_LDIR
000BC7 4BC7 ED53E7F2        20      LD  (DTAX),DE
000BCB 4BCB 2AF3F2          16      LD  HL,(LEFTX)
000BCE 4BCE D1              10      POP DE
000BCF 4BCF A7               4      AND A
000BD0 4BD0 ED52            15      SBC HL,DE
000BD2 4BD2 22F3F2          16      LD  (LEFTX),HL
000BD5 4BD5 2829            12      JR  Z,RBREND
                                
       4BD7                     RBRB:
000BD7 4BD7 CD274F          17      CALL    RBXB
000BDA 4BDA 2818            12      JR  Z,RBRC
       4BDC                     RBRB1:
000BDC 4BDC C5              11      PUSH    BC
000BDD 4BDD D5              11      PUSH    DE
000BDE 4BDE CDD84F          17      CALL    CLUST
000BE1 4BE1 EB               4      EX  DE,HL
000BE2 4BE2 ED4BC6F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000BE6 4BE6 CDF344          17      CALL    ROM_LDIR
000BE9 4BE9 EB               4      EX  DE,HL
000BEA 4BEA D1              10      POP DE
000BEB 4BEB C1              10      POP BC
000BEC 4BEC CDB54F          17      CALL    GNCL
000BEF 4BEF DA194C          10      JP  C,RBRERR
000BF2 4BF2 10E8            13      DJNZ    RBRB1
       4BF4                     RBRC:
000BF4 4BF4 CD3F4F          17      CALL    RBXC
000BF7 4BF7 2807            12      JR  Z,RBREND
                                
000BF9 4BF9 CDD84F          17      CALL    CLUST
000BFC 4BFC EB               4      EX  DE,HL
000BFD 4BFD CDF344          17      CALL    ROM_LDIR
       4C00                     RBREND:
000C00 4C00 CD4B4F          17      CALL    RBXEND
       4C03                     RBREND0:
000C03 4C03 FDE1            14      POP IY
000C05 4C05 C1              10      POP BC
000C06 4C06 D1              10      POP DE
000C07 4C07 F1              10      POP AF  ;(HL)
000C08 4C08 AF               4      XOR A
000C09 4C09 3AC3F2          13      LD  A,(_RESULT)
000C0C 4C0C C9              10      RET
                                
       4C0D                     RBRERR1:
000C0D 4C0D 3E01             7      LD  A,001H
       4C0F                     RBRERR2:
000C0F 4C0F FDE1            14      POP IY
000C11 4C11 C1              10      POP BC
000C12 4C12 D1              10      POP DE
000C13 4C13 E1              10      POP HL
000C14 4C14 37               4      SCF
000C15 4C15 210000          10      LD  HL,0
000C18 4C18 C9              10      RET
       4C19                     RBRERR:
000C19 4C19 3EFF             7      LD  A,0FFH
000C1B 4C1B 18F2            12      JR  RBRERR2
                                
       4C1D                     FILE_DD:
000C1D 4C1D E1              10      POP HL
000C1E 4C1E 3E                      DB  03EH
000C1F 4C1F C9              10      RET
000C20 4C20 32A3F2          13      LD  (SWC_BLOAD_M),A
       4C23                     ROM_ORG:
000C23 4C23 2AF5F2          16      LD  HL,(PARAM0)
000C26 4C26 7E               7      LD  A,(HL)
000C27 4C27 C9              10      RET
       4C28                     FILE_B:
000C28 4C28 1E00             7      LD  E,0
000C2A 4C2A 3A63F6          13      LD  A,(VALTYP)
000C2D 4C2D FE03             7      CP  3       ;string
000C2F 4C2F C2DC4C          10      JP  NZ,FILED
                                
000C32 4C32 DD21D067        14      LD  IX,FRESTR
000C36 4C36 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000C3A 4C3A CD1C00          17      CALL    _CALSLT
000C3D 4C3D E5              11      PUSH    HL
000C3E 4C3E DDE1            14      POP IX
                                
000C40 4C40 DD5E00          19      LD  E,(IX+0)
000C43 4C43 DD7E01          19      LD  A,(IX+1)
000C46 4C46 DD5602          19      LD  D,(IX+2)
000C49 4C49 DD62             9      LD  IXH,D
000C4B 4C4B DD6F             9      LD  IXL,A
000C4D 4C4D 3E1F             7      LD  A,01FH
000C4F 4C4F 1802            12      JR  FILE_BAS
       4C51                     FILE_BDOS:
000C51 4C51 3E20             7      LD  A,020H
       4C53                     FILE_BAS:
000C53 4C53 32FBF2          13      LD  (_CHKSP),A
000C56 4C56 AF               4      XOR A
000C57 4C57 3200F3          13      LD  (FDRV),A
000C5A 4C5A 7B               4      LD  A,E
000C5B 4C5B FE04             7      CP  4
000C5D 4C5D 3808            12      JR  C,FILEB1
000C5F 4C5F DD7E03          19      LD  A,(IX+3)
000C62 4C62 FE3A             7      CP  ':'
000C64 4C64 28B7            12      JR  Z,FILE_DD
000C66 4C66 7B               4      LD  A,E
       4C67                     FILEB1:
000C67 4C67 FE02             7      CP  2
000C69 4C69 3820            12      JR  C,DEVI1
000C6B 4C6B DD7E01          19      LD  A,(IX+1)
000C6E 4C6E FE3A             7      CP  ':'
000C70 4C70 2019            12      JR  NZ,DEVI1
000C72 4C72 DD7E00          19      LD  A,(IX+0)        ;DRIVE
000C75 4C75 CDB94D          17      CALL    CAP
000C78 4C78 D640             7      SUB '@'
000C7A 4C7A DD23            10      INC IX
000C7C 4C7C DD23            10      INC IX
000C7E 4C7E 1D               4      DEC E
000C7F 4C7F 1D               4      DEC E
000C80 4C80 3200F3          13      LD  (FDRV),A
000C83 4C83 F5              11      PUSH    AF
000C84 4C84 CD9F55          17      CALL    GET_CD_CDRV
000C87 4C87 22F9F2          16      LD  (_CDX),HL
000C8A 4C8A E1              10      POP HL
       4C8B                     DEVI1:
000C8B 4C8B DD7E00          19      LD  A,(IX+0)
000C8E 4C8E D65C             7      SUB 05CH        ;\
000C90 4C90 2008            12      JR  NZ,NOROOT
000C92 4C92 6F               4      LD  L,A
000C93 4C93 67               4      LD  H,A
000C94 4C94 22F9F2          16      LD  (_CDX),HL
000C97 4C97 DD23            10      INC IX
000C99 4C99 1D               4      DEC E
       4C9A                     NOROOT:
                                
       4C9A                     SETDIR:
000C9A 4C9A CDDC4C          17      CALL    FILED
000C9D 4C9D DD7E00          19      LD  A,(IX+0)
000CA0 4CA0 FE5C             7      CP  05CH        ;\
000CA2 4CA2 C0              11      RET NZ
000CA3 4CA3 DD23            10      INC IX
000CA5 4CA5 1D               4      DEC E
000CA6 4CA6 3A01F3          13      LD  A,(FNAME)
000CA9 4CA9 FE20             7      CP  020H        ;. の処理
000CAB 4CAB 28ED            12      JR  Z,SETDIR
                                
000CAD 4CAD CDCF4D          17      CALL    ROM_OPEN
000CB0 4CB0 B7               4      OR  A
000CB1 4CB1 C0              11      RET NZ
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
000CB2 4CB2 D5              11      PUSH    DE
000CB3 4CB3 2AEFF2          16      LD  HL,(DIRENT1)
000CB6 4CB6 110B00          10      LD  DE,0000BH   ;属性(アトリビュート)
000CB9 4CB9 19              11      ADD HL,DE
000CBA 4CBA CDE444          17      CALL    RDSLT_ROM
000CBD 4CBD D1              10      POP DE
000CBE 4CBE CB67             8      BIT 4,A     ;ディレクトリ
                                #else
                                    LD  IY,(DIRENT1)
                                    BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000CC0 4CC0 C8              11      RET Z
000CC1 4CC1 CD234D          17      CALL    FILEI
                                #if exists USE_MORMAL32K_OR_ASCII16
000CC4 4CC4 D5              11      PUSH    DE
000CC5 4CC5 2AEFF2          16      LD  HL,(DIRENT1)
000CC8 4CC8 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000CCB 4CCB 19              11      ADD HL,DE
000CCC 4CCC CDE444          17      CALL    RDSLT_ROM
000CCF 4CCF 23               6      INC HL
000CD0 4CD0 5F               4      LD  E,A
000CD1 4CD1 CDE444          17      CALL    RDSLT_ROM
000CD4 4CD4 57               4      LD  D,A
000CD5 4CD5 EB               4      EX  DE,HL
000CD6 4CD6 D1              10      POP DE
                                #else
                                    LD  L,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  H,(IY+01BH)
                                #endif
000CD7 4CD7 22F9F2          16      LD  (_CDX),HL
000CDA 4CDA 18BE            12      JR  SETDIR
                                
       4CDC                     FILED:
000CDC 4CDC CD234D          17      CALL    FILEI
000CDF 4CDF 2101F3          10      LD  HL,FNAME
                                
000CE2 4CE2 0608             7      LD  B,8
       4CE4                     FILE2:
000CE4 4CE4 CD304D          17      CALL    CCHKF
000CE7 4CE7 C8              11      RET Z
000CE8 4CE8 FE2A             7      CP  '*'
000CEA 4CEA 282E            12      JR  Z,FILE9
000CEC 4CEC FE2E             7      CP  '.'
000CEE 4CEE 280C            12      JR  Z,FILE4
000CF0 4CF0 77               7      LD  (HL),A
000CF1 4CF1 23               6      INC HL
000CF2 4CF2 10F0            13      DJNZ    FILE2
                                
       4CF4                     FILE3:
000CF4 4CF4 CD304D          17      CALL    CCHKF
000CF7 4CF7 C8              11      RET Z
000CF8 4CF8 FE2E             7      CP  '.'
000CFA 4CFA 20F8            12      JR  NZ,FILE3
                                
       4CFC                     FILE4:
000CFC 4CFC 2109F3          10      LD  HL,FNAME+8
000CFF 4CFF 0603             7      LD  B,3
                                
       4D01                     FILE4L:
000D01 4D01 CD304D          17      CALL    CCHKF
000D04 4D04 C8              11      RET Z
000D05 4D05 FE2E             7      CP  '.'
000D07 4D07 2008            12      JR  NZ,FILE12
000D09 4D09 3201F3          13      LD  (FNAME),A   ;Parent directory(..)
000D0C 4D0C 3202F3          13      LD  (FNAME+1),A
000D0F 4D0F 3E20             7      LD  A,020H
       4D11                     FILE12:
000D11 4D11 FE2A             7      CP  '*'
000D13 4D13 280A            12      JR  Z,FILE10
000D15 4D15 77               7      LD  (HL),A
000D16 4D16 23               6      INC HL
000D17 4D17 10E8            13      DJNZ    FILE4L
000D19 4D19 C9              10      RET
                                
       4D1A                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000D1A 4D1A CD1F4D          17      CALL    FILE10
000D1D 4D1D 18D5            12      JR  FILE3
                                
       4D1F                     FILE10:
000D1F 4D1F 3E3F             7      LD  A,'?'
000D21 4D21 1808            12      JR  FILL_MEMORY
       4D23                     FILEI:              ;名前＋拡張子をスペースで初期化
000D23 4D23 3E20             7      LD  A,020H
000D25 4D25 01000B          10      LD  BC,11*256   ;C=0にしておく
000D28 4D28 2101F3          10      LD  HL,FNAME
       4D2B                     FILL_MEMORY:            ;HLからBバイトAで埋める
000D2B 4D2B 77               7      LD  (HL),A
000D2C 4D2C 23               6      INC HL
000D2D 4D2D 10FC            13      DJNZ    FILL_MEMORY
000D2F 4D2F C9              10      RET
                                
       4D30                     CCHKF:
000D30 4D30 7B               4      LD  A,E
000D31 4D31 B7               4      OR  A
000D32 4D32 C8              11      RET Z
000D33 4D33 DD7E00          19      LD  A,(IX+0)
000D36 4D36 CD3D4D          17      CALL    CCHK2
000D39 4D39 C8              11      RET Z
000D3A 4D3A C3A44D          10      JP  FKAN
                                
       4D3D                     CCHK2:
000D3D 4D3D 0C               4      INC C
000D3E 4D3E 0D               4      DEC C
000D3F 4D3F C0              11      RET NZ
       4D40                     CCHK3:              ;ZF=1 で使えない文字
000D40 4D40 FE2B             7      CP  '+'
000D42 4D42 C8              11      RET Z
000D43 4D43 FE2C             7      CP  ','
000D45 4D45 C8              11      RET Z
000D46 4D46 FE2F             7      CP  '/'
000D48 4D48 C8              11      RET Z
000D49 4D49 FE3A             7      CP  ':'
000D4B 4D4B C8              11      RET Z
000D4C 4D4C FE3B             7      CP  ';'
000D4E 4D4E C8              11      RET Z
000D4F 4D4F FE3D             7      CP  '='
000D51 4D51 C8              11      RET Z
000D52 4D52 FE5C             7      CP  05CH    ;\
000D54 4D54 C8              11      RET Z
000D55 4D55 E5              11      PUSH    HL
000D56 4D56 2AFBF2          16      LD  HL,(_CHKSP)
000D59 4D59 BD               4      CP  L
000D5A 4D5A E1              10      POP HL
000D5B 4D5B D0              11      RET NC
000D5C 4D5C BF               4      CP  A       ;Z=1
000D5D 4D5D C9              10      RET
                                
       4D5E                     SS1:
000D5E 4D5E 13               6      INC DE
       4D5F                     SPCUT:              ;スペースをカット
000D5F 4D5F 1A               7      LD  A,(DE)
000D60 4D60 FE20             7      CP  020H
000D62 4D62 28FA            12      JR  Z,SS1
000D64 4D64 C9              10      RET
                                
       4D65                     SCREOF1:
000D65 4D65 13               6      INC DE
       4D66                     SPCUTEX:            ;スペース改行などをカット
000D66 4D66 1A               7      LD  A,(DE)
000D67 4D67 FE20             7      CP  020H
000D69 4D69 28FA            12      JR  Z,SCREOF1
000D6B 4D6B FE0D             7      CP  00DH
000D6D 4D6D 28F6            12      JR  Z,SCREOF1
000D6F 4D6F FE0A             7      CP  00AH
000D71 4D71 28F2            12      JR  Z,SCREOF1
000D73 4D73 FE1A             7      CP  01AH
000D75 4D75 28EE            12      JR  Z,SCREOF1
000D77 4D77 C9              10      RET
                                
       4D78                     GETNUM:
000D78 4D78 210000          10      LD  HL,0
       4D7B                     GETNUM1:
000D7B 4D7B 1A               7      LD  A,(DE)
000D7C 4D7C 13               6      INC DE
000D7D 4D7D D630             7      SUB '0'
000D7F 4D7F D8              11      RET C
000D80 4D80 FE0A             7      CP  10
000D82 4D82 D0              11      RET NC
000D83 4D83 4D               4      LD  C,L
000D84 4D84 44               4      LD  B,H
000D85 4D85 29              11      ADD HL,HL   ;*2
000D86 4D86 29              11      ADD HL,HL   ;*4
000D87 4D87 09              11      ADD HL,BC   ;*5
000D88 4D88 29              11      ADD HL,HL   ;*10
000D89 4D89 4F               4      LD  C,A
000D8A 4D8A 0600             7      LD  B,0
000D8C 4D8C 09              11      ADD HL,BC
000D8D 4D8D 18EC            12      JR  GETNUM1
                                
       4D8F                     SEARCH_END:
000D8F 4D8F 7E               7      LD  A,(HL)
       4D90                     SEARCH_END1:
000D90 4D90 23               6      INC HL
000D91 4D91 B7               4      OR  A
000D92 4D92 C8              11      RET Z
000D93 4D93 FE3A             7      CP  ':'
000D95 4D95 20F8            12      JR  NZ,SEARCH_END
000D97 4D97 7E               7      LD  A,(HL)
000D98 4D98 FE3A             7      CP  ':'
000D9A 4D9A 28F4            12      JR  Z,SEARCH_END1
000D9C 4D9C C9              10      RET
                                
       4D9D                     FKANC:
000D9D 4D9D CB41             8      BIT 0,C
000D9F 4D9F CCC24D          17      CALL    Z,CAP2
000DA2 4DA2 1803            12      JR  FKANX
       4DA4                     FKAN:           ;漢字チェック
000DA4 4DA4 DD23            10      INC IX
000DA6 4DA6 1D               4      DEC E
       4DA7                     FKANX:
000DA7 4DA7 CB41             8      BIT 0,C
000DA9 4DA9 CB81             8      RES 0,C
000DAB 4DAB C0              11      RET NZ
000DAC 4DAC FE80             7      CP  080H
000DAE 4DAE D8              11      RET C
000DAF 4DAF FEA0             7      CP  0A0H
000DB1 4DB1 3803            12      JR  C,FKAN1
000DB3 4DB3 FEE0             7      CP  0E0H
000DB5 4DB5 D8              11      RET C
       4DB6                     FKAN1:
000DB6 4DB6 0C               4      INC C
000DB7 4DB7 A7               4      AND A
000DB8 4DB8 C9              10      RET
                                
       4DB9                     CAP:
000DB9 4DB9 FE61             7      CP  'a'
000DBB 4DBB D8              11      RET C
000DBC 4DBC FE7B             7      CP  'z'+1
000DBE 4DBE D0              11      RET NC
000DBF 4DBF D620             7      SUB 020H
000DC1 4DC1 C9              10      RET
       4DC2                     CAP2:
000DC2 4DC2 CDB94D          17      CALL    CAP
       4DC5                     CAP3:               ;
000DC5 4DC5 FE05             7      CP  5
000DC7 4DC7 2803            12      JR  Z,CAP4
000DC9 4DC9 FE21             7      CP  021H
000DCB 4DCB C9              10      RET
       4DCC                     CAP4:
000DCC 4DCC 3EE5             7      LD  A,0E5H
000DCE 4DCE C9              10      RET
                                
       4DCF                     ROM_OPEN:
000DCF 4DCF CDC055          17      CALL    GET_DISK_BANK_FDRV
                                
000DD2 4DD2 CD9250          17      CALL    GET_DIR_DAT
000DD5 4DD5 D5              11      PUSH    DE
000DD6 4DD6 CD434E          17      CALL    FILESE
000DD9 4DD9 D1              10      POP DE
000DDA 4DDA 300F            12      JR  NC,ROM_OPEN_C
       4DDC                     ROM_OPEN_OK:
000DDC 4DDC 22EFF2          16      LD  (DIRENT1),HL
000DDF 4DDF E5              11      PUSH    HL
000DE0 4DE0 AF               4      XOR A
000DE1 4DE1 6F               4      LD  L,A
000DE2 4DE2 67               4      LD  H,A
000DE3 4DE3 22CAF2          16      LD  (RR_LOW),HL
000DE6 4DE6 22CCF2          16      LD  (RR_HIGH),HL
000DE9 4DE9 E1              10      POP HL
000DEA 4DEA C9              10      RET
                                
       4DEB                     ROM_OPEN_C:         ;#XXXX 形式のサブディスク
000DEB 4DEB 3A01F3          13      LD  A,(FNAME)
000DEE 4DEE FE23             7      CP  '#'
000DF0 4DF0 37               4      SCF
000DF1 4DF1 C0              11      RET NZ
000DF2 4DF2 D5              11      PUSH    DE
000DF3 4DF3 2100F3          10      LD  HL,FDRV
000DF6 4DF6 1103FB          10      LD  DE,TMP_DIRENT
000DF9 4DF9 010C00          10      LD  BC,1+8+3
000DFC 4DFC EDB0                    LDIR
000DFE 4DFE 0614             7      LD  B,32-(1+8+3)
000E00 4E00 CD715B          17      CALL    ZERO_MEMORY_DE
000E03 4E03 3E10             7      LD  A,010H          ;ディレクトリ属性
000E05 4E05 320EFB          13      LD  (TMP_DIRENT+0000BH),A   ;属性(アトリビュート)
000E08 4E08 3A02F3          13      LD  A,(FNAME+1)
000E0B 4E0B CDE45B          17      CALL    HEX
000E0E 4E0E 3830            12      JR  C,POPDE_SCF
000E10 4E10 87               4      ADD A,A
000E11 4E11 87               4      ADD A,A
000E12 4E12 87               4      ADD A,A
000E13 4E13 87               4      ADD A,A
000E14 4E14 5F               4      LD  E,A
000E15 4E15 3A03F3          13      LD  A,(FNAME+2)
000E18 4E18 CDE45B          17      CALL    HEX
000E1B 4E1B 3823            12      JR  C,POPDE_SCF
000E1D 4E1D B3               4      OR  E
000E1E 4E1E 321EFB          13      LD  (TMP_DIRENT+0001BH),A       ;ファイルの先頭クラスタ
000E21 4E21 3A04F3          13      LD  A,(FNAME+3)
000E24 4E24 CDE45B          17      CALL    HEX
000E27 4E27 3817            12      JR  C,POPDE_SCF
000E29 4E29 87               4      ADD A,A
000E2A 4E2A 87               4      ADD A,A
000E2B 4E2B 87               4      ADD A,A
000E2C 4E2C 87               4      ADD A,A
000E2D 4E2D 5F               4      LD  E,A
000E2E 4E2E 3A05F3          13      LD  A,(FNAME+4)
000E31 4E31 CDE45B          17      CALL    HEX
000E34 4E34 380A            12      JR  C,POPDE_SCF
000E36 4E36 B3               4      OR  E
000E37 4E37 321DFB          13      LD  (TMP_DIRENT+0001AH),A       ;ファイルの先頭クラスタ
000E3A 4E3A D1              10      POP DE
000E3B 4E3B 2103FB          10      LD  HL,TMP_DIRENT
000E3E 4E3E 189C            12      JR  ROM_OPEN_OK
       4E40                     POPDE_SCF:
000E40 4E40 D1              10      POP DE
000E41 4E41 37               4      SCF
000E42 4E42 C9              10      RET
                                
       4E43                     FILESE:
       4E43                     FILESE0:
                                #if exists USE_MORMAL32K_OR_ASCII16
000E43 4E43 CDE444          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000E46 4E46 B7               4      OR  A
000E47 4E47 C8              11      RET Z       ;END:ZF=1 CF=0
000E48 4E48 FEE5             7      CP  0E5H
000E4A 4E4A 280D            12      JR  Z,FILESE1
000E4C 4E4C 1101F3          10      LD  DE,FNAME
000E4F 4E4F E5              11      PUSH    HL
000E50 4E50 CD7F4E          17      CALL    CPFILE
000E53 4E53 CCA24E          17      CALL    Z,CPFILE2
000E56 4E56 E1              10      POP HL
000E57 4E57 37               4      SCF
000E58 4E58 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4E59                     FILESE1:
000E59 4E59 CD614E          17      CALL    FNEXT
000E5C 4E5C 20E5            12      JR  NZ,FILESE0
000E5E 4E5E F6FF             7      OR  0FFH        ;ZF=0 CF=0
000E60 4E60 C9              10      RET
                                
       4E61                     FNEXT:
000E61 4E61 112000          10      LD  DE,020H
000E64 4E64 19              11      ADD HL,DE
000E65 4E65 ED5BF9F2        20      LD  DE,(_CDX)
000E69 4E69 7A               4      LD  A,D
000E6A 4E6A B3               4      OR  E
000E6B 4E6B 2002            12      JR  NZ,FNEXT_SUBDIR
000E6D 4E6D 0D               4      DEC C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
                                    PUSH    AF      ;※フラグを保存する必要あり
                                    BIT 7,H
                                    JR  Z,CHECK_DIR_PAGE1
                                    LD  A,H
                                    SUB 020H
                                    LD  H,A
                                    LD  A,(_DIR_BANK)
                                    INC A
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_DIR_BANK),A
                                CHECK_DIR_PAGE1:
                                    POP AF
                                #endif
000E6E 4E6E C9              10      RET
                                
       4E6F                     FNEXT_SUBDIR:           ;サブディレクトリ
000E6F 4E6F 0D               4      DEC C
000E70 4E70 C0              11      RET NZ
                                
000E71 4E71 ED5BF9F2        20      LD  DE,(_CDX)
000E75 4E75 CDB54F          17      CALL    GNCL
000E78 4E78 EB               4      EX  DE,HL
000E79 4E79 22F9F2          16      LD  (_CDX),HL
000E7C 4E7C C3CB50          10      JP  GET_SUBDIR
                                
       4E7F                     CPFILE:
000E7F 4E7F C5              11      PUSH    BC
000E80 4E80 01000B          10      LD  BC,00B00H
       4E83                     CPSTR1:
000E83 4E83 1A               7      LD  A,(DE)
000E84 4E84 FE3F             7      CP  '?'     ;Wild card
000E86 4E86 2814            12      JR  Z,CPSTR2
                                #if exists USE_MORMAL32K_OR_ASCII16
000E88 4E88 CDE444          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000E8B 4E8B CD9D4D          17      CALL    FKANC
000E8E 4E8E E5              11      PUSH    HL
000E8F 4E8F 67               4      LD  H,A
000E90 4E90 1A               7      LD  A,(DE)
000E91 4E91 CB01             8      RLC C
000E93 4E93 CD9D4D          17      CALL    FKANC
000E96 4E96 CB09             8      RRC C
000E98 4E98 BC               4      CP  H       ;CP (HL),(DE)
000E99 4E99 E1              10      POP HL
000E9A 4E9A 2004            12      JR  NZ,CPSTR3
       4E9C                     CPSTR2:
000E9C 4E9C 13               6      INC DE
000E9D 4E9D 23               6      INC HL
000E9E 4E9E 10E3            13      DJNZ    CPSTR1
       4EA0                     CPSTR3:
000EA0 4EA0 C1              10      POP BC
000EA1 4EA1 C9              10      RET
                                
       4EA2                     CPFILE2:
                                #if exists USE_MORMAL32K_OR_ASCII16
000EA2 4EA2 CDE444          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000EA5 4EA5 E608             7      AND 008H    ;~0F7H
000EA7 4EA7 C9              10      RET
                                
       4EA8                     RBX1:
000EA8 4EA8 E5              11      PUSH    HL      ;Record byte
                                
000EA9 4EA9 ED5BCAF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000EAD 4EAD 3ACDF2          13      LD  A,(RR_HIGH+1)
000EB0 4EB0 4F               4      LD  C,A
                                
000EB1 4EB1 3AF1F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
000EB4 4EB4 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
000EB7 4EB7 D5              11      PUSH    DE
000EB8 4EB8 2AEFF2          16      LD  HL,(DIRENT1)
000EBB 4EBB 111C00          10      LD  DE,0001CH
000EBE 4EBE 19              11      ADD HL,DE
000EBF 4EBF CDE444          17      CALL    RDSLT_ROM
000EC2 4EC2 23               6      INC HL
000EC3 4EC3 5F               4      LD  E,A
000EC4 4EC4 CDE444          17      CALL    RDSLT_ROM
000EC7 4EC7 23               6      INC HL
000EC8 4EC8 57               4      LD  D,A
000EC9 4EC9 CDE444          17      CALL    RDSLT_ROM
000ECC 4ECC EB               4      EX  DE,HL       ;AHL=File size
000ECD 4ECD D1              10      POP DE
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  L,(IY+01CH) ;AHL=File size
                                    LD  H,(IY+01DH)
                                    LD  A,(IY+01EH)
                                #endif
                                
000ECE 4ECE A7               4      AND A
000ECF 4ECF ED52            15      SBC HL,DE
000ED1 4ED1 99               4      SBC A,C
000ED2 4ED2 D1              10      POP DE
                                
000ED3 4ED3 D8              11      RET C
000ED4 4ED4 4F               4      LD  C,A
000ED5 4ED5 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000ED6 4ED6 B2               4      OR  D
000ED7 4ED7 B3               4      OR  E
000ED8 4ED8 C0              11      RET NZ
000ED9 4ED9 37               4      SCF
000EDA 4EDA C9              10      RET
                                
       4EDB                     RBX2:
000EDB 4EDB ED4BCBF2        20      LD  BC,(RR_LOW+1)
000EDF 4EDF CD604F          17      CALL    RWXR
000EE2 4EE2 3AC7F2          13      LD  A,(CLSZ_H)
000EE5 4EE5 3D               4      DEC A
000EE6 4EE6 E5              11      PUSH    HL
000EE7 4EE7 2ACAF2          16      LD  HL,(RR_LOW)
000EEA 4EEA A4               4      AND H
000EEB 4EEB B5               4      OR  L
000EEC 4EEC E1              10      POP HL
000EED 4EED C9              10      RET
                                
       4EEE                     RBXA:
000EEE 4EEE D5              11      PUSH    DE
000EEF 4EEF CDD84F          17      CALL    CLUST
000EF2 4EF2 ED53D2F2        20      LD  (_DTPS),DE
000EF6 4EF6 D1              10      POP DE
000EF7 4EF7 CDB54F          17      CALL    GNCL
000EFA 4EFA D8              11      RET C
000EFB 4EFB ED53CEF2        20      LD  (_CLPS),DE
                                
000EFF 4EFF ED4BCAF2        20      LD  BC,(RR_LOW)
000F03 4F03 2AC6F2          16      LD  HL,(CLSZ)
000F06 4F06 7C               4      LD  A,H
000F07 4F07 3D               4      DEC A
000F08 4F08 A0               4      AND B
000F09 4F09 47               4      LD  B,A
000F0A 4F0A ED42            15      SBC HL,BC       ;remaining cluster
                                
000F0C 4F0C ED5BF3F2        20      LD  DE,(LEFTX)
000F10 4F10 ED52            15      SBC HL,DE       ;CP HL,DE
000F12 4F12 19              11      ADD HL,DE
000F13 4F13 3801            12      JR  C,RBXA1
000F15 4F15 EB               4      EX  DE,HL
       4F16                     RBXA1:
000F16 4F16 3AC4F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_MORMAL32K_OR_ASCII16
000F19 4F19 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000F1C 4F1C E5              11      PUSH    HL
000F1D 4F1D 2AD2F2          16      LD  HL,(_DTPS)
000F20 4F20 09              11      ADD HL,BC
000F21 4F21 ED5BE7F2        20      LD  DE,(DTAX)
000F25 4F25 C1              10      POP BC
000F26 4F26 C9              10      RET
                                
       4F27                     RBXB:
000F27 4F27 2AE7F2          16      LD  HL,(DTAX)
000F2A 4F2A ED5BCEF2        20      LD  DE,(_CLPS)
000F2E 4F2E 3AF4F2          13      LD  A,(LEFTX+1)
000F31 4F31 47               4      LD  B,A
000F32 4F32 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4F35                     RBXB1:
000F35 4F35 1F               4      RRA     ;->CF
000F36 4F36 3804            12      JR  C,RBXB2
000F38 4F38 CB38             8      SRL B   ;B=B/2
000F3A 4F3A 18F9            12      JR  RBXB1
       4F3C                     RBXB2:
000F3C 4F3C 78               4      LD  A,B
000F3D 4F3D B7               4      OR  A
000F3E 4F3E C9              10      RET
                                
       4F3F                     RBXC:
000F3F 4F3F ED4BF3F2        20      LD  BC,(LEFTX)
000F43 4F43 3AC7F2          13      LD  A,(CLSZ_H)
000F46 4F46 3D               4      DEC A
000F47 4F47 A0               4      AND B
000F48 4F48 47               4      LD  B,A
000F49 4F49 B1               4      OR  C
000F4A 4F4A C9              10      RET
                                
       4F4B                     RBXEND:
000F4B 4F4B ED5BD0F2        20      LD  DE,(_LEFT)
000F4F 4F4F 2ACAF2          16      LD  HL,(RR_LOW)
000F52 4F52 3ACDF2          13      LD  A,(RR_HIGH+1)
000F55 4F55 19              11      ADD HL,DE
000F56 4F56 CE00             7      ADC A,0
000F58 4F58 22CAF2          16      LD  (RR_LOW),HL
000F5B 4F5B 32CDF2          13      LD  (RR_HIGH+1),A
000F5E 4F5E EB               4      EX  DE,HL       ;HL=Read byte
000F5F 4F5F C9              10      RET
                                
       4F60                     RWXR:
000F60 4F60 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4F63                     L_RWX:
000F63 4F63 1F               4      RRA     ;->CF
000F64 4F64 3806            12      JR  C,E_RWX
000F66 4F66 CB38             8      SRL B   ;BC=BC/2
000F68 4F68 CB19             8      RR  C   ;
000F6A 4F6A 18F7            12      JR  L_RWX
       4F6C                     E_RWX:
000F6C 4F6C 3AF1F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
000F6F 4F6F 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
000F72 4F72 E5              11      PUSH    HL
000F73 4F73 2AEFF2          16      LD  HL,(DIRENT1)
000F76 4F76 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000F79 4F79 19              11      ADD HL,DE
000F7A 4F7A CDE444          17      CALL    RDSLT_ROM
000F7D 4F7D 23               6      INC HL
000F7E 4F7E 5F               4      LD  E,A
000F7F 4F7F CDE444          17      CALL    RDSLT_ROM
000F82 4F82 23               6      INC HL
000F83 4F83 57               4      LD  D,A
000F84 4F84 E1              10      POP HL
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  E,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  D,(IY+01BH)
                                #endif
000F85 4F85 CDC055          17      CALL    GET_DISK_BANK_FDRV
       4F88                     RWX1:
000F88 4F88 ED53CEF2        20      LD  (_CLPS),DE
000F8C 4F8C 7A               4      LD  A,D
000F8D 4F8D B3               4      OR  E
000F8E 4F8E 37               4      SCF
000F8F 4F8F C8              11      RET Z
                                
000F90 4F90 78               4      LD  A,B
000F91 4F91 B1               4      OR  C
000F92 4F92 C8              11      RET Z
                                
000F93 4F93 CDB54F          17      CALL    GNCL
000F96 4F96 D8              11      RET C
000F97 4F97 0B               6      DEC BC
000F98 4F98 CD1C50          17      CALL    ENDCL
000F9B 4F9B 38EB            12      JR  C,RWX1
000F9D 4F9D 37               4      SCF
000F9E 4F9E C9              10      RET
                                
       4F9F                     NCL3:
000F9F 4F9F CDC055          17      CALL    GET_DISK_BANK_FDRV
000FA2 4FA2 6B               4      LD  L,E
000FA3 4FA3 62               4      LD  H,D
000FA4 4FA4 CB3C             8      SRL H
000FA6 4FA6 CB1D             8      RR  L
000FA8 4FA8 1F               4      RRA
000FA9 4FA9 19              11      ADD HL,DE
000FAA 4FAA 010060          10      LD  BC,BANK1_ADR
000FAD 4FAD 09              11      ADD HL,BC
000FAE 4FAE ED4BC8F2        20      LD  BC,(SECSZ)
000FB2 4FB2 09              11      ADD HL,BC
000FB3 4FB3 17               4      RLA
000FB4 4FB4 C9              10      RET
                                
       4FB5                     GNCL:
000FB5 4FB5 7A               4      LD  A,D
000FB6 4FB6 B3               4      OR  E
000FB7 4FB7 37               4      SCF
000FB8 4FB8 C8              11      RET Z
000FB9 4FB9 C5              11      PUSH    BC
000FBA 4FBA E5              11      PUSH    HL
000FBB 4FBB CD9F4F          17      CALL    NCL3
000FBE 4FBE 3809            12      JR  C,GNC1
000FC0 4FC0 5E               7      LD  E,(HL)
000FC1 4FC1 23               6      INC HL
000FC2 4FC2 7E               7      LD  A,(HL)
000FC3 4FC3 E60F             7      AND 00FH
000FC5 4FC5 57               4      LD  D,A
000FC6 4FC6 E1              10      POP HL
000FC7 4FC7 C1              10      POP BC
000FC8 4FC8 C9              10      RET
       4FC9                     GNC1:
000FC9 4FC9 7E               7      LD  A,(HL)
000FCA 4FCA 23               6      INC HL
000FCB 4FCB 56               7      LD  D,(HL)
000FCC 4FCC 0604             7      LD  B,4
       4FCE                     GNC1L:
000FCE 4FCE CB3A             8      SRL D
000FD0 4FD0 1F               4      RRA
000FD1 4FD1 10FB            13      DJNZ    GNC1L
                                
000FD3 4FD3 5F               4      LD  E,A
000FD4 4FD4 E1              10      POP HL
000FD5 4FD5 C1              10      POP BC
000FD6 4FD6 A7               4      AND A
000FD7 4FD7 C9              10      RET
                                
       4FD8                     CLUST:
000FD8 4FD8 EB               4      EX  DE,HL
       4FD9                     CLUST_HL:
000FD9 4FD9 2B               6      DEC HL
000FDA 4FDA 2B               6      DEC HL
000FDB 4FDB C5              11      PUSH    BC
000FDC 4FDC 3AC7F2          13      LD  A,(CLSZ_H)
000FDF 4FDF CDE655          17      CALL    MUL_AHL
                                
000FE2 4FE2 CDAC50          17      CALL    GET_DIR_POS
000FE5 4FE5 4F               4      LD  C,A
000FE6 4FE6 0600             7      LD  B,0
000FE8 4FE8 09              11      ADD HL,BC
                                
000FE9 4FE9 ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
000FED 4FED CB38             8      SRL B
000FEF 4FEF CB19             8      RR  C           ;/2
000FF1 4FF1 CB38             8      SRL B
000FF3 4FF3 CB19             8      RR  C           ;/4
000FF5 4FF5 CB38             8      SRL B
000FF7 4FF7 CB19             8      RR  C           ;/8
000FF9 4FF9 09              11      ADD HL,BC
                                #if exists USE_MORMAL32K_OR_ASCII16
000FFA 4FFA 7D               4      LD  A,L
000FFB 4FFB 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
000FFE 4FFE 09              11      ADD HL,BC
000FFF 4FFF 3013            12      JR  NC,CLUST2
001001 5001 4D               4      LD  C,L     ;C=読み出し元
001002 5002 29              11      ADD HL,HL   ;64KB→32KB
001003 5003 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
001004 5004 CDC055          17      CALL    GET_DISK_BANK_FDRV
001007 5007 84               4      ADD A,H
001008 5008 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
00100B 500B 32C4F2          13      LD  (_BANK),A
00100E 500E 69               4      LD  L,C     ;C=読み出し元
00100F 500F 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
001011 5011 A5               4      AND L
001012 5012 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB
                                    ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
                                    AND L
                                #endif
       5014                     CLUST2:
001014 5014 C660             7      ADD A,high BANK1_ADR
001016 5016 67               4      LD  H,A
001017 5017 2E00             7      LD  L,0
001019 5019 EB               4      EX  DE,HL
00101A 501A C1              10      POP BC
00101B 501B C9              10      RET
                                
       501C                     ENDCL:
00101C 501C 7A               4      LD  A,D ;END CLUSTER
00101D 501D FE0F             7      CP  00FH    ;FAT12の最大値
00101F 501F C0              11      RET NZ
001020 5020 7B               4      LD  A,E
001021 5021 FEF7             7      CP  0F7H
001023 5023 C9              10      RET
                                
       5024                     RB_READ:
001024 5024 AF               4      XOR A   ;HLA = HL*128
001025 5025 CB3C             8      SRL H
001027 5027 CB1D             8      RR  L
001029 5029 1F               4      RRA
00102A 502A 32CAF2          13      LD  (RR_LOW),A
00102D 502D 22CBF2          16      LD  (RR_MID),HL
001030 5030 218000          10      LD  HL,128
                                
001033 5033 CD874B          17      CALL    ROM_READ
001036 5036 C9              10      RET
                                
       5037                     GETSEQ:
001037 5037 FD6E20          19      LD  L,(IY+32)
00103A 503A FD660C          19      LD  H,(IY+12)
                                
00103D 503D CB25             8      SLA L
                                
00103F 503F CB3C             8      SRL H
001041 5041 CB1D             8      RR  L
001043 5043 C9              10      RET
                                
       5044                     SETSEQ:
001044 5044 F5              11      PUSH    AF
001045 5045 3ACAF2          13      LD  A,(RR_LOW)
001048 5048 2ACBF2          16      LD  HL,(RR_MID)
                                
00104B 504B CD6250          17      CALL    SSQ1
                                
00104E 504E 29              11      ADD HL,HL
00104F 504F CB3D             8      SRL L
001051 5051 FD7520          19      LD  (IY+32),L
001054 5054 FD740C          19      LD  (IY+12),H
001057 5057 F1              10      POP AF
001058 5058 C9              10      RET
                                
       5059                     GETSIZE:
001059 5059 FD7E10          19      LD  A,(IY+16)
00105C 505C FD6E11          19      LD  L,(IY+17)
00105F 505F FD6612          19      LD  H,(IY+18)
       5062                     SSQ1:
001062 5062 87               4      ADD A,A
001063 5063 ED6A            15      ADC HL,HL
001065 5065 B7               4      OR  A
001066 5066 C8              11      RET Z
001067 5067 23               6      INC HL
001068 5068 C9              10      RET
                                
       5069                     SET_FCB:
001069 5069 D5              11      PUSH    DE
00106A 506A FDE1            14      POP IY
00106C 506C FD7E1C          19      LD  A,(IY+28)
00106F 506F FEFF             7      CP  0FFH
001071 5071 201B            12      JR  NZ,POPAF_SCF_FF_RET
001073 5073 E5              11      PUSH    HL
001074 5074 FD6E1A          19      LD  L,(IY+26)
001077 5077 FD661B          19      LD  H,(IY+27)
00107A 507A 22CEF2          16      LD  (_CLPS),HL
00107D 507D FD7E1D          19      LD  A,(IY+29)
001080 5080 32F1F2          13      LD  (_DIR_BANK),A
001083 5083 FD6E1E          19      LD  L,(IY+30)
001086 5086 FD661F          19      LD  H,(IY+31)
001089 5089 22EFF2          16      LD  (DIRENT1),HL
00108C 508C E1              10      POP HL
00108D 508D C9              10      RET
                                
       508E                     POPAF_SCF_FF_RET:
00108E 508E F1              10      POP AF
00108F 508F 37               4      SCF
001090 5090 9F               4      SBC A,A
001091 5091 C9              10      RET
                                
       5092                     GET_DIR_DAT:
001092 5092 2AF9F2          16      LD  HL,(_CDX)
001095 5095 7C               4      LD  A,H
001096 5096 B5               4      OR  L
001097 5097 2032            12      JR  NZ,GET_SUBDIR
001099 5099 CDAC50          17      CALL    GET_DIR_POS
00109C 509C C660             7      ADD A,high BANK1_ADR
00109E 509E 2E00             7      LD  L,0
0010A0 50A0 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                    CALL    CHECK_DIR_PAGE
                                #endif
0010A1 50A1 3AC5F2          13      LD  A,(_BANK1)
0010A4 50A4 32F1F2          13      LD  (_DIR_BANK),A
                                
0010A7 50A7 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
0010AA 50AA 4F               4      LD  C,A
0010AB 50AB C9              10      RET
                                
       50AC                     GET_DIR_POS:                ;ルートディレクトリ
0010AC 50AC CDC055          17      CALL    GET_DISK_BANK_FDRV
0010AF 50AF 32C5F2          13      LD  (_BANK1),A
0010B2 50B2 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
0010B5 50B5 47               4      LD  B,A
0010B6 50B6 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
0010B9 50B9 4F               4      LD  C,A
0010BA 50BA 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       50BD                     GET_DIR_POS1:
0010BD 50BD 81               4      ADD A,C
0010BE 50BE 10FD            13      DJNZ    GET_DIR_POS1
                                
0010C0 50C0 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
0010C4 50C4 37               4      SCF     ;無限ループ回避
       50C5                     L_MDP:
0010C5 50C5 CB18             8      RR  B   ;->CF
0010C7 50C7 D8              11      RET C
0010C8 50C8 87               4      ADD A,A
0010C9 50C9 18FA            12      JR  L_MDP
                                
       50CB                     GET_SUBDIR:             ;サブディレクトリ
0010CB 50CB CDD94F          17      CALL    CLUST_HL
0010CE 50CE EB               4      EX  DE,HL
0010CF 50CF 3AC4F2          13      LD  A,(_BANK)
0010D2 50D2 32F1F2          13      LD  (_DIR_BANK),A
0010D5 50D5 3AC7F2          13      LD  A,(CLSZ_H)
0010D8 50D8 87               4      ADD A,A     ;*2
0010D9 50D9 87               4      ADD A,A     ;*4
0010DA 50DA 87               4      ADD A,A     ;*8
0010DB 50DB 4F               4      LD  C,A
0010DC 50DC C9              10      RET
                                
       50DD                     STATEMENT:
0010DD 50DD 116153          10      LD  DE,STR_CHDIR
0010E0 50E0 CD4753          17      CALL    CPPROCNM
0010E3 50E3 2812            12      JR  Z,_CHDIR
0010E5 50E5 116753          10      LD  DE,STR_CHDRV
0010E8 50E8 CD4753          17      CALL    CPPROCNM
0010EB 50EB 281C            12      JR  Z,_CHDRV
0010ED 50ED 116D53          10      LD  DE,STR_RAMDISK
0010F0 50F0 CD4753          17      CALL    CPPROCNM
0010F3 50F3 2829            12      JR  Z,_RAMDISK
0010F5 50F5 37               4      SCF
0010F6 50F6 C9              10      RET
       50F7                     _CHDIR:
0010F7 50F7 7E               7      LD  A,(HL)
0010F8 50F8 FE28             7      CP  '('
0010FA 50FA 37               4      SCF
0010FB 50FB C0              11      RET NZ
0010FC 50FC CD3249          17      CALL    INIT_PARAM
0010FF 50FF CD284C          17      CALL    FILE_B
001102 5102 CD4951          17      CALL    ROM_CD
001105 5105 D0              11      RET NC
001106 5106 C3D547          10      JP  ERROR_FILE_NOT_FOUND
                                
       5109                     _CHDRV:
001109 5109 7E               7      LD  A,(HL)
00110A 510A FE28             7      CP  '('
00110C 510C 37               4      SCF
00110D 510D C0              11      RET NZ
00110E 510E CD3249          17      CALL    INIT_PARAM
001111 5111 E5              11      PUSH    HL
001112 5112 CD284C          17      CALL    FILE_B
001115 5115 E1              10      POP HL
001116 5116 23               6      INC HL
001117 5117 3A00F3          13      LD  A,(FDRV)
00111A 511A 3D               4      DEC A
00111B 511B C30359          10      JP  _SYS0EX1
                                
       511E                     _RAMDISK:
00111E 511E 7E               7      LD  A,(HL)
00111F 511F FE28             7      CP  '('
001121 5121 37               4      SCF
001122 5122 C0              11      RET NZ
001123 5123 23               6      INC HL
001124 5124 DD212F54        14      LD  IX,FRMQNT
001128 5128 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00112C 512C CD1C00          17      CALL    _CALSLT
00112F 512F E5              11      PUSH    HL
001130 5130 110F00          10      LD  DE,15       ;切り上げの為
001133 5133 19              11      ADD HL,DE
001134 5134 7D               4      LD  A,L
001135 5135 0604             7      LD  B,4     ;16で割る
       5137                     RAMDISK1:
001137 5137 CB3C             8      SRL H   ;/2
001139 5139 1F               4      RRA
00113A 513A 10FB            13      DJNZ    RAMDISK1
00113C 513C FEFF             7      CP  0FFH
00113E 513E 2001            12      JR  NZ,RAMDISK2
001140 5140 3D               4      DEC A
       5141                     RAMDISK2:
001141 5141 47               4      LD  B,A
001142 5142 CD3C5B          17      CALL    _SYS68
                                
001145 5145 E1              10      POP HL
001146 5146 23               6      INC HL
001147 5147 AF               4      XOR A
001148 5148 C9              10      RET
                                
       5149                     ROM_CD:
001149 5149 3A01F3          13      LD  A,(FNAME)
00114C 514C FE20             7      CP  020H
00114E 514E 2835            12      JR  Z,CD1
001150 5150 CDCF4D          17      CALL    ROM_OPEN
001153 5153 D8              11      RET C
                                #if exists USE_MORMAL32K_OR_ASCII16
001154 5154 D5              11      PUSH    DE
001155 5155 2AEFF2          16      LD  HL,(DIRENT1)
001158 5158 110B00          10      LD  DE,0000BH   ;属性(アトリビュート)
00115B 515B 19              11      ADD HL,DE
00115C 515C CDE444          17      CALL    RDSLT_ROM
00115F 515F D1              10      POP DE
001160 5160 CB67             8      BIT 4,A     ;ディレクトリ
001162 5162 CAD547          10      JP  Z,ERROR_FILE_NOT_FOUND
001165 5165 D5              11      PUSH    DE
001166 5166 2AEFF2          16      LD  HL,(DIRENT1)
001169 5169 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
00116C 516C 19              11      ADD HL,DE
00116D 516D CDE444          17      CALL    RDSLT_ROM
001170 5170 23               6      INC HL
001171 5171 5F               4      LD  E,A
001172 5172 CDE444          17      CALL    RDSLT_ROM
001175 5175 57               4      LD  D,A
001176 5176 EB               4      EX  DE,HL
001177 5177 D1              10      POP DE
                                #else
                                    LD  IY,(DIRENT1)
                                    BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    LD  L,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  H,(IY+01BH)
                                #endif
       5178                     CD2:
001178 5178 CD8D55          17      CALL    SET_CD_FDRV
00117B 517B 2AF7F2          16      LD  HL,(PARAM1)
       517E                     CD_SKIP:
00117E 517E 7E               7      LD  A,(HL)
00117F 517F 23               6      INC HL
001180 5180 FE21             7      CP  021H
001182 5182 38FA            12      JR  C,CD_SKIP
001184 5184 C9              10      RET
       5185                     CD1:
001185 5185 2AF9F2          16      LD  HL,(_CDX)
001188 5188 18EE            12      JR  CD2
                                
       518A                     GET_BASIC_FCB:
00118A 518A D5              11      PUSH    DE
00118B 518B 23               6      INC HL  ;+1
00118C 518C 5E               7      LD  E,(HL)  ;FCB[1]
00118D 518D 23               6      INC HL  ;+2
00118E 518E 56               7      LD  D,(HL)  ;FCB[2]
00118F 518F 23               6      INC HL  ;+3
001190 5190 ED53EFF2        20      LD  (DIRENT1),DE
                                            ;FCB[3] backup char
001194 5194 23               6      INC HL  ;+4
                                            ;FCB[4]
001195 5195 23               6      INC HL  ;+5
001196 5196 7E               7      LD  A,(HL)  ;FCB[5]
001197 5197 23               6      INC HL  ;+6
001198 5198 32F1F2          13      LD  (_DIR_BANK),A
00119B 519B 5E               7      LD  E,(HL)  ;FCB[6]
00119C 519C 23               6      INC HL  ;+7
00119D 519D 56               7      LD  D,(HL)  ;FCB[7]
00119E 519E 23               6      INC HL  ;+8
00119F 519F ED53CAF2        20      LD  (RR_LOW),DE
0011A3 51A3 7E               7      LD  A,(HL)  ;FCB[8]
0011A4 51A4 23               6      INC HL  ;+9
0011A5 51A5 32CCF2          13      LD  (RR_HIGH),A
0011A8 51A8 22D4F2          16      LD  (_DTA),HL   ;FCB[9]
0011AB 51AB D1              10      POP DE
0011AC 51AC C9              10      RET
                                
       51AD                     SET_BASIC_FCB:
0011AD 51AD E5              11      PUSH    HL
0011AE 51AE 2A64F8          16      LD  HL,(PTRFIL)
0011B1 51B1 23               6      INC HL  ;+1
0011B2 51B2 D5              11      PUSH    DE
0011B3 51B3 ED5BEFF2        20      LD  DE,(DIRENT1)
0011B7 51B7 73               7      LD  (HL),E  ;FCB[1]
0011B8 51B8 23               6      INC HL  ;+2
0011B9 51B9 72               7      LD  (HL),D  ;FCB[2]
0011BA 51BA 23               6      INC HL  ;+3
0011BB 51BB 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
0011BC 51BC 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
0011BD 51BD 23               6      INC HL  ;+5
0011BE 51BE 3AF1F2          13      LD  A,(_DIR_BANK)
0011C1 51C1 77               7      LD  (HL),A  ;FCB[5]
0011C2 51C2 23               6      INC HL  ;+6
0011C3 51C3 ED5BCAF2        20      LD  DE,(RR_LOW)
0011C7 51C7 73               7      LD  (HL),E  ;FCB[6]
0011C8 51C8 23               6      INC HL  ;+7
0011C9 51C9 72               7      LD  (HL),D  ;FCB[7]
0011CA 51CA 23               6      INC HL  ;+8
0011CB 51CB 3ACCF2          13      LD  A,(RR_HIGH)
0011CE 51CE 77               7      LD  (HL),A  ;FCB[8]
0011CF 51CF D1              10      POP DE
0011D0 51D0 E1              10      POP HL
0011D1 51D1 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_18:BACKUP
                                ;in
                                ;   C : backup charactor
                                ;   HL: FBC pointer
                                ;out
       51D2                     DEVICE_18_BACKUP:
0011D2 51D2 D5              11      PUSH    DE
0011D3 51D3 E5              11      PUSH    HL
0011D4 51D4 110300          10      LD  DE,3
0011D7 51D7 19              11      ADD HL,DE
0011D8 51D8 71               7      LD  (HL),C
0011D9 51D9 E1              10      POP HL
0011DA 51DA D1              10      POP DE
0011DB 51DB C9              10      RET
                                
       51DC                     DEVICE_CHECK:
0011DC 51DC 3A8AFD          13      LD  A,(PROCNM+1)
0011DF 51DF B7               4      OR  A
0011E0 51E0 C8              11      RET Z
0011E1 51E1 117553          10      LD  DE,STR_ROM
0011E4 51E4 CD4753          17      CALL    CPPROCNM
0011E7 51E7 2802            12      JR  Z,DEVICE_OK
0011E9 51E9 37               4      SCF
0011EA 51EA C9              10      RET
       51EB                     DEVICE_OK:
0011EB 51EB AF               4      XOR A
0011EC 51EC C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファ
                                
       51ED                     DEVICE_0_OPEN:
0011ED 51ED 7B               4      LD  A,E
0011EE 51EE FE02             7      CP  2       ;FOR OUTPUT
0011F0 51F0 281B            12      JR  Z,OPEN2
0011F2 51F2 D5              11      PUSH    DE
0011F3 51F3 E5              11      push    hl
                                ;
0011F4 51F4 3E01             7      LD  A,1     ;ドライブA
0011F6 51F6 3200F3          13      LD  (FDRV),A
0011F9 51F9 2166F8          10      LD  HL,FILNAM
0011FC 51FC 1101F3          10      LD  DE,FNAME
0011FF 51FF 010B00          10      LD  BC,8+3
001202 5202 CD505B          17      CALL    INIT_FILE1
001205 5205 CDCF4D          17      CALL    ROM_OPEN
001208 5208 DAD547          10      JP  C,ERROR_FILE_NOT_FOUND
00120B 520B E1              10      pop hl
00120C 520C D1              10      POP DE
       520D                     OPEN2:
00120D 520D 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
001210 5210 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
001211 5211 AF               4      XOR A
001212 5212 32F3F2          13      LD  (LEFTX),A
001215 5215 CDAD51          17      CALL    SET_BASIC_FCB
001218 5218 7B               4      ld  a,e
001219 5219 FE08             7      cp  8
00121B 521B 3F               4      ccf
00121C 521C C9              10      ret
                                
       521D                     DEVICE_2_CLOSE:
00121D 521D AF               4      XOR A
                                ;   LD  (HL),A
00121E 521E 6F               4      LD  L,A
00121F 521F 67               4      LD  H,A
001220 5220 2264F8          16      LD  (PTRFIL),HL
001223 5223 C9              10      RET
                                
       5224                     DEVICE_ENTRY:
001224 5224 FE08             7      CP  8
001226 5226 2826            12      JR  Z,DEVICE_8_SIN
001228 5228 3C               4      INC A
001229 5229 28B1            12      JR  Z,DEVICE_CHECK:
00122B 522B 3D               4      DEC A
00122C 522C 28BF            12      JR  Z,DEVICE_0_OPEN
00122E 522E FE0E             7      CP  14
001230 5230 2860            12      JR  Z,DEVICE_14_EOF
001232 5232 FE04             7      CP  4
001234 5234 2834            12      JR  Z,DEVICE_4_RANDOM
001236 5236 FE0A             7      CP  10
001238 5238 2850            12      JR  Z,DEVICE_10_LOC
00123A 523A FE0C             7      CP  12
00123C 523C 2878            12      JR  Z,DEVICE_12_LOF
00123E 523E FE02             7      CP  2
001240 5240 2890            12      JR  Z,DEVICE_18_BACKUP
001242 5242 FE02             7      CP  2
001244 5244 28D7            12      JR  Z,DEVICE_2_CLOSE
001246 5246 FE06             7      CP  6
001248 5248 2802            12      JR  Z,DEVICE_6_SOUT
00124A 524A 37               4      SCF
00124B 524B C9              10      RET
                                
       524C                     DEVICE_6_SOUT:
00124C 524C AF               4      XOR A
00124D 524D C9              10      RET
                                
       524E                     DEVICE_8_SIN:
00124E 524E CD8A51          17      CALL    GET_BASIC_FCB
001251 5251 210100          10      LD  HL,1
001254 5254 CD874B          17      CALL    ROM_READ
001257 5257 7C               4      LD  A,H
001258 5258 B5               4      OR  L
001259 5259 280D            12      JR  Z,CCF_RET
00125B 525B 2AD4F2          16      LD  HL,(_DTA)
00125E 525E 7E               7      LD  A,(HL)
00125F 525F F5              11      PUSH    AF
001260 5260 CDAD51          17      CALL    SET_BASIC_FCB
001263 5263 F1              10      POP AF
001264 5264 FE0A             7      CP  00AH
001266 5266 C8              11      RET Z   ;ZF=separate
                                ;   CP  01AH
                                ;   JR  Z,SCF_RET
001267 5267 37               4      SCF     ;
       5268                     CCF_RET:
001268 5268 3F               4      CCF     ;ZF=0 CF=0にしたい
001269 5269 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_4:RANDOM
                                ;in
                                ;   A : 4
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
       526A                     DEVICE_4_RANDOM:
00126A 526A D5              11      PUSH    DE
00126B 526B CD8A51          17      CALL    GET_BASIC_FCB
00126E 526E DDE5            15      PUSH    IX
001270 5270 DD218A2F        14      LD  IX,FRCINT
001274 5274 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001278 5278 CDB0F2          17      CALL    CAL_MP
00127B 527B DDE1            14      POP IX
00127D 527D 2AF8F7          16      LD  HL,(DACDAT)
001280 5280 22CAF2          16      LD  (RR_LOW),HL
001283 5283 AF               4      XOR A
001284 5284 CDAD51          17      CALL    SET_BASIC_FCB
001287 5287 D1              10      POP DE
001288 5288 AF               4      XOR A
001289 5289 C9              10      RET
                                
                                ;FUNC_10:LOC
                                ;in
                                ;   A : 10
                                ;out
                                ;   DAC    : value of received bytes
                                ;   VALTYP : DAC type
       528A                     DEVICE_10_LOC:
00128A 528A CD8A51          17      CALL    GET_BASIC_FCB
00128D 528D 2ACAF2          16      LD  HL,(RR_LOW)
001290 5290 1844            12      JR  RETURN_TYPE8_AHL
                                
                                ;--------------------------------------
                                ;FUNC_14:EOF
                                ;in
                                ;   A : 14
                                ;out
                                ;   DAC    : value of EOF value (EOF=-1)
                                ;   VALTYP : DAC type
       5292                     DEVICE_14_EOF:
001292 5292 CD8A51          17      CALL    GET_BASIC_FCB
001295 5295 CDA84E          17      CALL    RBX1
001298 5298 3810            12      JR  C,DEVICE_14_EOF1
00129A 529A 210100          10      LD  HL,1
00129D 529D CD874B          17      CALL    ROM_READ
0012A0 52A0 2AD4F2          16      LD  HL,(_DTA)
0012A3 52A3 7E               7      LD  A,(HL)
0012A4 52A4 FE1A             7      CP  01AH
0012A6 52A6 37               4      SCF
0012A7 52A7 2801            12      JR  Z,DEVICE_14_EOF1
0012A9 52A9 3F               4      CCF
       52AA                     DEVICE_14_EOF1:
0012AA 52AA 9F               4      SBC A,A
0012AB 52AB 6F               4      LD  L,A
0012AC 52AC 67               4      LD  H,A
       52AD                     return_type2_hl:
0012AD 52AD 22F8F7          16      ld  (DACDAT),hl
0012B0 52B0 3E02             7      ld  a,2
0012B2 52B2 3263F6          13      ld  (VALTYP),a
0012B5 52B5 C9              10      ret
                                
                                ;--------------------------------------
                                ;FUNC_16:FPOS
                                ;in
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
                                ;   illegal function call
                                
                                ;--------------------------------------
                                ;FUNC_12:LOF
                                ;in
                                ;   A : 12
                                ;out
                                ;   DAC    : value of LOC+RSIQLN
                                ;   VALTYP : DAC type
       52B6                     DEVICE_12_LOF:
0012B6 52B6 CD8A51          17      CALL    GET_BASIC_FCB
                                
0012B9 52B9 3AF1F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
0012BC 52BC 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
0012BF 52BF D5              11      PUSH    DE
0012C0 52C0 2AEFF2          16      LD  HL,(DIRENT1)
0012C3 52C3 111C00          10      LD  DE,0001CH
0012C6 52C6 19              11      ADD HL,DE
0012C7 52C7 CDE444          17      CALL    RDSLT_ROM
0012CA 52CA 23               6      INC HL
0012CB 52CB 5F               4      LD  E,A
0012CC 52CC CDE444          17      CALL    RDSLT_ROM
0012CF 52CF 23               6      INC HL
0012D0 52D0 57               4      LD  D,A
0012D1 52D1 CDE444          17      CALL    RDSLT_ROM
0012D4 52D4 EB               4      EX  DE,HL       ;AHL=File size
0012D5 52D5 D1              10      POP DE
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  L,(IY+01CH) ;AHL=File size
                                    LD  H,(IY+01DH)
                                    LD  A,(IY+01EH)
                                #endif
       52D6                     RETURN_TYPE8_AHL:
0012D6 52D6 B7               4      OR  A
0012D7 52D7 2004            12      JR  NZ,RT8AHL1
0012D9 52D9 CB7C             8      BIT 7,H
0012DB 52DB 28D0            12      JR  Z,return_type2_hl
       52DD                     RT8AHL1:
0012DD 52DD E5              11      PUSH    HL
0012DE 52DE 29              11      ADD HL,HL
0012DF 52DF 8F               4      ADC A,A
0012E0 52E0 32F8F7          13      LD  (DACDAT),A
0012E3 52E3 3E00             7      LD  A,0
0012E5 52E5 8F               4      ADC A,A
0012E6 52E6 32F9F7          13      LD  (DACDAT+1),A
                                
0012E9 52E9 3E02             7      LD  A,2
0012EB 52EB 3263F6          13      LD  (VALTYP),A
0012EE 52EE DD213A30        14      LD  IX,FRCDBL
0012F2 52F2 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0012F6 52F6 CDB0F2          17      CALL    CAL_MP
                                
0012F9 52F9 213F53          10      LD  HL,DBL32768
0012FC 52FC 1147F8          10      LD  DE,ARG
0012FF 52FF 010800          10      LD  BC,8
001302 5302 EDB0                    LDIR
                                
001304 5304 DD21E627        14      LD  IX,DECMUL
001308 5308 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00130C 530C CDB0F2          17      CALL    CAL_MP
                                
00130F 530F 21F6F7          10      LD  HL,DAC
001312 5312 1147F8          10      LD  DE,ARG
001315 5315 010800          10      LD  BC,8
001318 5318 EDB0                    LDIR
                                
00131A 531A E1              10      POP HL
00131B 531B 22F8F7          16      LD  (DACDAT),HL
                                
00131E 531E 3E02             7      LD  A,2
001320 5320 3263F6          13      LD  (VALTYP),A
001323 5323 DD213A30        14      LD  IX,FRCDBL
001327 5327 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00132B 532B CDB0F2          17      CALL    CAL_MP
                                
00132E 532E DD219A26        14      LD  IX,DECADD
001332 5332 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001336 5336 CDB0F2          17      CALL    CAL_MP
                                
001339 5339 3E08             7      LD  A,8
00133B 533B 3263F6          13      LD  (VALTYP),A
00133E 533E C9              10      RET
                                
       533F                     DBL32768:
00133F 533F 4532768000000000        DB  045H,032H,076H,080H,0,0,0,0
                                
       5347                     CPPROCNM:
001347 5347 E5              11      PUSH    HL
001348 5348 2189FD          10      LD  HL,PROCNM
       534B                     CPPROCNM1:
00134B 534B 1A               7      LD  A,(DE)
00134C 534C 13               6      INC DE
00134D 534D BE               7      CP  (HL)
00134E 534E 23               6      INC HL
00134F 534F 2003            12      JR  NZ,CPPROCNM2
001351 5351 B7               4      OR  A
001352 5352 20F7            12      JR  NZ,CPPROCNM1
       5354                     CPPROCNM2:
001354 5354 E1              10      POP HL
001355 5355 C9              10      RET
                                
       5356                     WILDCARD:
001356 5356 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       5361                     STR_CHDIR:
001361 5361 434844495200            DB  "CHDIR",0
       5367                     STR_CHDRV:
001367 5367 434844525600            DB  "CHDRV",0
       536D                     STR_RAMDISK:
00136D 536D 52414D4449534B00        DB  "RAMDISK",0
       5375                     STR_ROM:
001375 5375 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       5379                     ERROR_WRITE_PROTECTED:
001379 5379 3E00             7      LD  A,0     ;Write protected
00137B 537B C9              10      RET
       537C                     ERROR_NOT_READY:
00137C 537C F1              10      POP AF
00137D 537D 37               4      SCF
00137E 537E 3E02             7      LD  A,2     ;Not ready
001380 5380 C9              10      RET
       5381                     DISKIO:
001381 5381 38F6            12      JR  C,ERROR_WRITE_PROTECTED
001383 5383 48               4      LD  C,B
001384 5384 CDC355          17      CALL    GET_DISK_BANK
001387 5387 F5              11      PUSH    AF
001388 5388 3AC9F2          13      LD  A,(SECSZ_H)
00138B 538B B7               4      OR  A
00138C 538C 28EE            12      JR  Z,ERROR_NOT_READY
00138E 538E F1              10      POP AF
       538F                     SETMAP1:
00138F 538F E5              11      PUSH    HL
       5390                     DISKIO1:
001390 5390 C5              11      PUSH    BC      ;B=残りのセクタ数
001391 5391 D5              11      PUSH    DE      ;DE=セクタ番号
001392 5392 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
001393 5393 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
001394 5394 F5              11      PUSH    AF
001395 5395 3AC9F2          13      LD  A,(SECSZ_H)
001398 5398 CDE655          17      CALL    MUL_AHL
00139B 539B F1              10      POP AF
                                #if exists USE_MORMAL32K_OR_ASCII16
00139C 539C 7D               4      LD  A,L
00139D 539D C5              11      PUSH    BC
00139E 539E 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
0013A1 53A1 09              11      ADD HL,BC
0013A2 53A2 C1              10      POP BC
0013A3 53A3 3013            12      JR  NC,DISKIO2
0013A5 53A5 4D               4      LD  C,L     ;C=読み出し元
0013A6 53A6 29              11      ADD HL,HL   ;64KB→32KB
0013A7 53A7 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
0013A8 53A8 CDC055          17      CALL    GET_DISK_BANK_FDRV
0013AB 53AB 84               4      ADD A,H
0013AC 53AC 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
0013AF 53AF 32C4F2          13      LD  (_BANK),A
0013B2 53B2 69               4      LD  L,C     ;C=読み出し元
0013B3 53B3 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
0013B5 53B5 A5               4      AND L
0013B6 53B6 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL       ;64KB→32KB
                                    ADD HL,HL       ;32KB→16KB
                                    ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  A,C     ;C=読み出し元
                                    AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       53B8                     DISKIO2:
0013B8 53B8 C660             7      ADD A,high BANK1_ADR
0013BA 53BA 67               4      LD  H,A
0013BB 53BB ED4BC8F2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
0013BF 53BF 69               4      LD  L,C     ;C=0
0013C0 53C0 CDF344          17      CALL    ROM_LDIR
0013C3 53C3 EB               4      EX  DE,HL
0013C4 53C4 F1              10      POP AF
0013C5 53C5 D1              10      POP DE
0013C6 53C6 13               6      INC DE
0013C7 53C7 C1              10      POP BC
0013C8 53C8 10C6            13      DJNZ    DISKIO1
0013CA 53CA 41               4      LD  B,C
                                
0013CB 53CB E1              10      POP HL
0013CC 53CC AF               4      XOR A
0013CD 53CD C9              10      RET
                                
       53CE                     DSKCHG:
0013CE 53CE CD0754          17      CALL    IS_BPB
0013D1 53D1 3824            12      JR  C,NOTREADY
0013D3 53D3 3A23FB          13      LD  A,(DRVTBL+2)
0013D6 53D6 B7               4      OR  A
0013D7 53D7 201A            12      JR  NZ,DSKCHG1
0013D9 53D9 3A21FB          13      LD  A,(DRVTBL)
0013DC 53DC FE02             7      CP  2
0013DE 53DE 2013            12      JR  NZ,DSKCHG1
0013E0 53E0 CD0754          17      CALL    IS_BPB
0013E3 53E3 300E            12      JR  NC,DSKCHG1
0013E5 53E5 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
0013E7 53E7 3221FB          13      LD  (DRVTBL),A
0013EA 53EA 3223FB          13      LD  (DRVTBL+2),A
0013ED 53ED 3A48F3          13      LD  A,(MASTERS)
0013F0 53F0 3224FB          13      LD  (DRVTBL+3),A
       53F3                     DSKCHG1:
0013F3 53F3 AF               4      XOR A
0013F4 53F4 0601             7      LD  B,1
0013F6 53F6 C9              10      RET
       53F7                     NOTREADY:
0013F7 53F7 3E02             7      LD  A,2
0013F9 53F9 37               4      SCF
0013FA 53FA C9              10      RET
                                
       53FB                     NO_BPB:
0013FB 53FB E1              10      POP HL
0013FC 53FC 23               6      INC HL
0013FD 53FD 11EC55          10      LD  DE,DPB2DD
001400 5400 011200          10      LD  BC,DPB2DD_E-DPB2DD
001403 5403 EDB0                    LDIR
001405 5405 AF               4      XOR A
001406 5406 C9              10      RET
                                
       5407                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
001407 5407 CDC355          17      CALL    GET_DISK_BANK
                                
00140A 540A 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
00140D 540D FE01             7      CP  1
00140F 540F D8              11      RET C
                                
001410 5410 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
001413 5413 C6FF             7      ADD A,0FFH
001415 5415 D8              11      RET C
                                
001416 5416 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       5419                     IS_BPB1:
001419 5419 FE01             7      CP  1
00141B 541B C8              11      RET Z
00141C 541C FE02             7      CP  2
00141E 541E C8              11      RET Z
00141F 541F FE04             7      CP  4
001421 5421 C8              11      RET Z
001422 5422 37               4      SCF
001423 5423 C9              10      RET
                                
       5424                     GETDPB:
001424 5424 E5              11      PUSH    HL
001425 5425 CDC355          17      CALL    GET_DISK_BANK
                                
001428 5428 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
00142B 542B B7               4      OR  A
00142C 542C 28CD            12      JR  Z,NO_BPB
00142E 542E DDE1            14      POP IX
001430 5430 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
001433 5433 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
001436 5436 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
001439 5439 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
00143C 543C DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
00143F 543F 87               4      ADD A,A
001440 5440 87               4      ADD A,A
001441 5441 87               4      ADD A,A
001442 5442 3D               4      DEC A
001443 5443 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
001446 5446 06FF             7      LD  B,-1
001448 5448 A7               4      AND A           ;無限ループ阻止
       5449                     GETDPB1:
001449 5449 04               4      INC B
00144A 544A 1F               4      RRA
00144B 544B 38FC            12      JR  C,GETDPB1
00144D 544D DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
001450 5450 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
001453 5453 3D               4      DEC A
001454 5454 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
001457 5457 A7               4      AND A           ;無限ループ阻止
001458 5458 06FF             7      LD  B,-1
       545A                     GETDPB2:
00145A 545A 04               4      INC B
00145B 545B 1F               4      RRA
00145C 545C 38FC            12      JR  C,GETDPB2
00145E 545E 04               4      INC B
00145F 545F DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
001462 5462 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt
001465 5465 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
001468 5468 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
00146B 546B 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
00146E 546E DD770A          19      LD  (IX+10),A       ;FATCNT
                                
001471 5471 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
001474 5474 DD770B          19      LD  (IX+11),A       ;MAXENT
                                
001477 5477 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16
00147B 547B DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
00147E 547E DD460A          19      LD  B,(IX+10)       ;FATCNT
001481 5481 210000          10      LD  HL,0
       5484                     GETDPB3:
001484 5484 19              11      ADD HL,DE
001485 5485 10FD            13      DJNZ    GETDPB3
       5487                     GETDPB4:
001487 5487 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
00148A 548A DD5609          19      LD  D,(IX+9)        ;FIRFAT
00148D 548D 19              11      ADD HL,DE
00148E 548E DD7511          19      LD  (IX+17),L       ;FIRDIR
001491 5491 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
001494 5494 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001497 5497 87               4      ADD A,A
001498 5498 87               4      ADD A,A
001499 5499 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       549C                     GETDPB5:
00149C 549C CB3B             8      SRL E
00149E 549E 1F               4      RRA
00149F 549F 30FB            12      JR  NC,GETDPB5
0014A1 54A1 1600             7      LD  D,0
0014A3 54A3 19              11      ADD HL,DE
0014A4 54A4 DD750C          19      LD  (IX+12),L       ;FIRREC
0014A7 54A7 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
0014AA 54AA 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16
                                
0014AD 54AD DD5E0C          19      LD  E,(IX+12)       ;FIRREC
0014B0 54B0 DD560D          19      LD  D,(IX+13)       ;FIRREC
0014B3 54B3 A7               4      AND A
0014B4 54B4 ED52            15      SBC HL,DE
                                
0014B6 54B6 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
0014B9 54B9 3C               4      INC A
0014BA 54BA 37               4      SCF             ;無限ループ阻止
       54BB                     GETDPB6:
0014BB 54BB 1F               4      RRA
0014BC 54BC 3806            12      JR  C,GETDPB7
0014BE 54BE CB3C             8      SRL H
0014C0 54C0 CB1D             8      RR  L
0014C2 54C2 18F7            12      JR  GETDPB6
       54C4                     GETDPB7:
0014C4 54C4 23               6      INC HL
0014C5 54C5 DD750E          19      LD  (IX+14),L       ;MAXCLUS
0014C8 54C8 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       54CB                     GETDPBD1:
0014CB 54CB DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0014CE 54CE E6FC             7      AND 0FCH
0014D0 54D0 C8              11      RET Z
                                
0014D1 54D1 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
0014D5 54D5 37               4      SCF
0014D6 54D6 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
0014DA 54DA DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
0014DD 54DD DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
0014E1 54E1 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
0014E5 54E5 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
0014E9 54E9 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
0014ED 54ED DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
0014F1 54F1 DDCB1126        23      SLA (IX+17)         ;FIRDIR
0014F5 54F5 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
0014F9 54F9 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
0014FC 54FC DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
0014FF 54FF DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001502 5502 87               4      ADD A,A
001503 5503 87               4      ADD A,A
001504 5504 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       5507                     GETDPBD5:
001507 5507 CB3B             8      SRL E
001509 5509 1F               4      RRA
00150A 550A 30FB            12      JR  NC,GETDPBD5
00150C 550C 1600             7      LD  D,0
00150E 550E 19              11      ADD HL,DE
00150F 550F DD750C          19      LD  (IX+12),L       ;FIRREC
001512 5512 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001515 5515 18B4            12      JR  GETDPBD1
                                
       5517                     CHOICE:
001517 5517 210000          10      LD  HL,0
00151A 551A C9              10      RET
                                
       551B                     DSKFMT:
00151B 551B AF               4      XOR A
00151C 551C 37               4      SCF
       551D                     DSKSTP:
00151D 551D C9              10      RET
                                
       551E                     BASENT:
00151E 551E 3E                      DB  03EH
00151F 551F F7              12      RST 30H
001520 5520 32DBFD          13      LD  (H_PINL),A
001523 5523 3A48F3          13      LD  A,(MASTERS)
001526 5526 32DCFD          13      LD  (H_PINL+1),A
001529 5529 214555          10      LD  HL,BOOT_BASIC
00152C 552C 22DDFD          16      LD  (H_PINL+2),HL
00152F 552F 3E                      DB  03EH
001530 5530 C9              10      RET
001531 5531 32DFFD          13      LD  (H_PINL+4),A
                                
                                #if exists _RAM64K
001534 5534 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
001537 5537 CD0C5D          17      CALL    ENASLT_00H
                                #endif
                                    ;BASICを起動する
00153A 553A FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00153E 553E DD21177D        14      LD  IX,ST_BAS   ;continue start of MSX-BASIC without executing BASIC programs in ROM
001542 5542 C35901          10      JP  CALBAS
                                
       5545                     BOOT_BASIC:
001545 5545 3E                      DB  03EH
001546 5546 C9              10      RET
001547 5547 32DBFD          13      LD  (H_PINL),A
                                
00154A 554A 2A74F6          16      LD  HL,(STKTOP)
00154D 554D 3A40F3          13      LD  A,(REBOOT)
001550 5550 C6FF             7      ADD A,0FFH
001552 5552 3811            12      JR  C,REBOOT1
001554 5554 21FE55          10      LD  HL,AUTOEXEC
001557 5557 1100F3          10      LD  DE,FDRV
00155A 555A 010C00          10      LD  BC,1+8+3
00155D 555D EDB0                    LDIR
00155F 555F CDCF4D          17      CALL    ROM_OPEN
001562 5562 D41F47          17      CALL    NC,ROM_LOAD1
       5565                     REBOOT1:
001565 5565 211556          10      LD  HL,DELOK
001568 5568 CDB944          17      CALL    MSX
00156B 556B 210A56          10      LD  HL,CMD_RUN
00156E 556E 111FF4          10      LD  DE,KBUF
001571 5571 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
001574 5574 D5              11      PUSH    DE
001575 5575 EDB0                    LDIR
001577 5577 3004            12      JR  NC,REBOOT2
001579 5579 AF               4      XOR A
00157A 557A 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       557D                     REBOOT2:
00157D 557D E1              10      POP HL
00157E 557E FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
001582 5582 DD210146        14      LD  IX,NEWSTT
001586 5586 C31C00          10      JP  _CALSLT
                                
       5589                     GETSLT:
001589 5589 3A22FB          13      LD  A,(DRVTBL+1)
00158C 558C C9              10      RET
                                
       558D                     SET_CD_FDRV:
00158D 558D 3A00F3          13      LD  A,(FDRV)
001590 5590 CDAF55          17      CALL    GET_DRIVE
001593 5593 FE01             7      CP  1
001595 5595 2804            12      JR  Z,SET_CD_B
001597 5597 22EBF2          16      LD  (_CD_A),HL
00159A 559A C9              10      RET
       559B                     SET_CD_B:
00159B 559B 22EDF2          16      LD  (_CD_B),HL
00159E 559E C9              10      RET
                                
       559F                     GET_CD_CDRV:
00159F 559F CDAF55          17      CALL    GET_DRIVE
       55A2                     GET_CD:
0015A2 55A2 FE01             7      CP  1
0015A4 55A4 2AEBF2          16      LD  HL,(_CD_A)
0015A7 55A7 C0              11      RET NZ
0015A8 55A8 2AEDF2          16      LD  HL,(_CD_B)
0015AB 55AB C9              10      RET
                                
       55AC                     GET_DRIVE_FDRV:
0015AC 55AC 3A00F3          13      LD  A,(FDRV)
       55AF                     GET_DRIVE:
0015AF 55AF D601             7      SUB 1
0015B1 55B1 D0              11      RET NC
0015B2 55B2 3AEAF2          13      LD  A,(_DVSW)
0015B5 55B5 C9              10      RET
                                
       55B6                     GET_DISK_BANK_H:
0015B6 55B6 3AF2F2          13      LD  A,(_LVECTOR)
0015B9 55B9 E680             7      AND 080H
0015BB 55BB 87               4      ADD A,A
0015BC 55BC 380A            12      JR  C,SET_DISK_BANK_A
0015BE 55BE 180F            12      JR  SET_DISK_BANK
       55C0                     GET_DISK_BANK_FDRV:
0015C0 55C0 CDAC55          17      CALL    GET_DRIVE_FDRV
       55C3                     GET_DISK_BANK:
0015C3 55C3 FE07             7      CP  7       ;H:
0015C5 55C5 28EF            12      JR  Z,GET_DISK_BANK_H
0015C7 55C7 B7               4      OR  A       ;A=DRIVE
       55C8                     SET_DISK_BANK_A:
0015C8 55C8 3E01             7      LD  A,DISK_BANK
0015CA 55CA 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
0015CC 55CC 3AE9F2          13      LD  A,(B_DRIVE)
                                #endif
       55CF                     SET_DISK_BANK:
                                #if exists USE_MORMAL32K_OR_ASCII16
0015CF 55CF 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0015D2 55D2 F5              11      PUSH    AF
0015D3 55D3 E5              11      PUSH    HL
0015D4 55D4 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec
0015D7 55D7 22C8F2          16      LD  (SECSZ),HL
0015DA 55DA 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0015DD 55DD CDE655          17      CALL    MUL_AHL
0015E0 55E0 22C6F2          16      LD  (CLSZ),HL
0015E3 55E3 E1              10      POP HL
0015E4 55E4 F1              10      POP AF
0015E5 55E5 C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       55E6                     MUL_AHL:
0015E6 55E6 37               4      SCF     ;無限ループ回避
       55E7                     MUL_AHL1:
0015E7 55E7 1F               4      RRA     ;->CF
0015E8 55E8 D8              11      RET C
0015E9 55E9 29              11      ADD HL,HL
0015EA 55EA 18FB            12      JR  MUL_AHL1
                                
       55EC                     DPB2DD:
0015EC 55EC F9                      DB  0F9H    ;MEDIA
0015ED 55ED 0002                    DW  00200H  ;SECSIZ
0015EF 55EF 0F                      DB  00FH    ;DIRMSK
0015F0 55F0 04                      DB  004H    ;DIRSHFT
0015F1 55F1 01                      DB  001H    ;CLUSMSK
0015F2 55F2 02                      DB  002H    ;CLUSSHFT
0015F3 55F3 0100                    DW  00001H  ;FIRFAT
0015F5 55F5 02                      DB  002H    ;FATCNT
0015F6 55F6 70                      DB  070H    ;MAXENT
0015F7 55F7 0E00                    DW  0000EH  ;FIRREC
0015F9 55F9 CA02                    DW  002CAH  ;MAXCLUS
0015FB 55FB 03                      DB  003H    ;FATSIZ
0015FC 55FC 0700                    DW  0007H   ;FIRDIR
       55FE                     DPB2DD_E:
                                
       55FE                     AUTOEXEC:
0015FE 55FE 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       560A                     CMD_RUN:
00160A 560A 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
001610 5610 80EF                    DW  NEW_HIMEM
       5612                     CMD_CLEAR_E:
001612 5612 3A8A00                  DB  03AH,08AH,0         ;RUN
       5615                     CMD_RUN_E:
       5615                     DELOK:
001615 5615 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       5619                     _ERROR:
001619 5619 AF               4      XOR A
00161A 561A 47               4      LD  B,A
00161B 561B C9              10      RET
                                
       561C                     ROM_BDOS:
00161C 561C E5              11      PUSH    HL
00161D 561D 79               4      LD  A,C
00161E 561E 87               4      ADD A,A
00161F 561F 38F8            12      JR  C,_ERROR
001621 5621 6F               4      LD  L,A
001622 5622 265C             7      LD  H,high STABLE
001624 5624 7E               7      LD  A,(HL)
001625 5625 2C               4      INC L
001626 5626 66               7      LD  H,(HL)
001627 5627 6F               4      LD  L,A
001628 5628 E3              19      EX  (SP),HL
001629 5629 79               4      LD  A,C
00162A 562A C9              10      RET
                                
       562B                     _PRINT:
       562B                     PRINT:
00162B 562B 7B               4      LD  A,E
00162C 562C 1803            12      JR  MSG_A
                                
       562E                     _SYS01:     ;(BDOS)コンソール入力
00162E 562E CDB356          17      CALL    _SYS07
       5631                     MSG_A:
001631 5631 FE03             7      CP  3
001633 5633 2814            12      JR  Z,MSG_BR
       5635                     MSGA1:
001635 5635 F5              11      PUSH    AF
001636 5636 C5              11      PUSH    BC
001637 5637 D5              11      PUSH    DE
001638 5638 E5              11      PUSH    HL
001639 5639 DDE5            15      PUSH    IX
00163B 563B DD21A200        14      LD  IX,CHPUT
00163F 563F CD9A44          17      CALL    CALSLT_R
001642 5642 DDE1            14      POP IX
001644 5644 E1              10      POP HL
001645 5645 D1              10      POP DE
001646 5646 C1              10      POP BC
       5647                     MSGA2:
001647 5647 F1              10      POP AF
001648 5648 C9              10      RET
       5649                     MSG_BR:
001649 5649 F5              11      PUSH    AF
00164A 564A 3ADDF3          13      LD  A,(CSRX)
00164D 564D FE02             7      CP  2
00164F 564F 38F6            12      JR  C,MSGA2
001651 5651 F1              10      POP AF
       5652                     MSG_CR:
001652 5652 F5              11      PUSH    AF
001653 5653 3E0D             7      LD  A,00DH
001655 5655 CD3556          17      CALL    MSGA1
001658 5658 3E0A             7      LD  A,00AH
00165A 565A CD3556          17      CALL    MSGA1
00165D 565D F1              10      POP AF
00165E 565E C9              10      RET
                                
       565F                     _SYS02:     ;(BDOS)コンソール出力
00165F 565F CD7A56          17      CALL    BREAK
001662 5662 1805            12      JR  PRINTX
                                
       5664                     _SYS06:     ;(BDOS)コンソール直接入出力
001664 5664 7B               4      LD  A,E
001665 5665 3C               4      INC A
001666 5666 CAF956          10      JP  Z,_INKEY
       5669                     PRINTX:
001669 5669 C32B56          10      JP  _PRINT
                                
       566C                     _SYS08:     ;(BDOS)エコーなしコンソール入力
00166C 566C CDB356          17      CALL    _SYS07
00166F 566F FE03             7      CP  3
001671 5671 CC7A56          17      CALL    Z,_BREAK
001674 5674 FE13             7      CP  013H        ;CTRL+S
001676 5676 C0              11      RET NZ
       5677                     PAUSE:
001677 5677 CD9156          17      CALL    KEYBC
                                
       567A                     _BREAK:
       567A                     BREAK:
00167A 567A F5              11      PUSH    AF
00167B 567B C5              11      PUSH    BC
00167C 567C D5              11      PUSH    DE
00167D 567D E5              11      PUSH    HL
00167E 567E DDE5            15      PUSH    IX
001680 5680 DD21B700        14      LD  IX,BREAKX
001684 5684 CD9A44          17      CALL    CALSLT_R
001687 5687 DDE1            14      POP IX
001689 5689 E1              10      POP HL
00168A 568A D1              10      POP DE
00168B 568B C1              10      POP BC
00168C 568C DC7A56          17      CALL    C,_BREAK
00168F 568F F1              10      POP AF
001690 5690 C9              10      RET
       5691                     KEYBC:
001691 5691 F5              11      PUSH    AF
001692 5692 C5              11      PUSH    BC
001693 5693 D5              11      PUSH    DE
001694 5694 E5              11      PUSH    HL
001695 5695 DDE5            15      PUSH    IX
001697 5697 DD215601        14      LD  IX,KILBUF
00169B 569B CD9A44          17      CALL    CALSLT_R
00169E 569E DDE1            14      POP IX
0016A0 56A0 E1              10      POP HL
0016A1 56A1 D1              10      POP DE
0016A2 56A2 C1              10      POP BC
0016A3 56A3 F1              10      POP AF
0016A4 56A4 C9              10      RET
                                
       56A5                     _SYS09:     ;(BDOS)文字列出力
0016A5 56A5 D5              11      PUSH    DE
       56A6                     _SX09:
0016A6 56A6 1A               7      LD  A,(DE)
0016A7 56A7 13               6      INC DE
0016A8 56A8 FE24             7      CP  '$'
0016AA 56AA 2805            12      JR  Z,POPDE_RET
0016AC 56AC CD3156          17      CALL    MSG_A
0016AF 56AF 18F5            12      JR  _SX09
       56B1                     POPDE_RET:
0016B1 56B1 D1              10      POP DE
0016B2 56B2 C9              10      RET
                                
       56B3                     _SYS07:
       56B3                     FLGET:
0016B3 56B3 C5              11      PUSH    BC
0016B4 56B4 D5              11      PUSH    DE
0016B5 56B5 E5              11      PUSH    HL
0016B6 56B6 DDE5            15      PUSH    IX
0016B8 56B8 3A0CF3          13      LD  A,(IS_BIOS)
0016BB 56BB B7               4      OR  A
0016BC 56BC 2018            12      JR  NZ,FLGET_G1
                                
0016BE 56BE CDDD58          17      CALL    GETVRAM
0016C1 56C1 E5              11      PUSH    HL
0016C2 56C2 DD214A00        14      LD  IX,RDVRM
0016C6 56C6 CD9A44          17      CALL    CALSLT_R
0016C9 56C9 E1              10      POP HL
0016CA 56CA F5              11      PUSH    AF
0016CB 56CB E5              11      PUSH    HL
0016CC 56CC 3EFF             7      LD  A,0FFH
0016CE 56CE DD214D00        14      LD  IX,WRTVRM
0016D2 56D2 CD9A44          17      CALL    CALSLT_R
0016D5 56D5 E1              10      POP HL
       56D6                     FLGET_G1:
0016D6 56D6 E5              11      PUSH    HL
0016D7 56D7 DD219F00        14      LD  IX,CHGET
0016DB 56DB CD9A44          17      CALL    CALSLT_R
0016DE 56DE 67               4      LD  H,A
0016DF 56DF E3              19      EX  (SP),HL
0016E0 56E0 3A0CF3          13      LD  A,(IS_BIOS)
0016E3 56E3 B7               4      OR  A
0016E4 56E4 200A            12      JR  NZ,FLGET_G2
0016E6 56E6 C1              10      POP BC
0016E7 56E7 F1              10      POP AF
0016E8 56E8 C5              11      PUSH    BC
0016E9 56E9 DD214D00        14      LD  IX,WRTVRM
0016ED 56ED CD9A44          17      CALL    CALSLT_R
       56F0                     FLGET_G2:
0016F0 56F0 F1              10      POP AF
0016F1 56F1 DDE1            14      POP IX
0016F3 56F3 E1              10      POP HL
0016F4 56F4 D1              10      POP DE
0016F5 56F5 C1              10      POP BC
0016F6 56F6 FE03             7      CP  3
0016F8 56F8 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       56F9                     _INKEY:
       56F9                     INKEY:
0016F9 56F9 CDD657          17      CALL    CPM_CONST
0016FC 56FC C8              11      RET Z
0016FD 56FD 18B4            12      JR  FLGET
                                
       56FF                     _SYS0A:     ;(BDOS)文字列入力
0016FF 56FF C5              11      PUSH    BC
001700 5700 E5              11      PUSH    HL
001701 5701 D5              11      PUSH    DE
                                
001702 5702 3A0CF3          13      LD  A,(IS_BIOS)
001705 5705 B7               4      OR  A
001706 5706 2824            12      JR  Z,SX0A_CBIOS
001708 5708 3ADDF3          13      LD  A,(CSRX)
00170B 570B 5F               4      LD  E,A
00170C 570C 1600             7      LD  D,0
00170E 570E D5              11      PUSH    DE
00170F 570F DDE5            15      PUSH    IX
001711 5711 DD21AE00        14      LD  IX,PLININ
001715 5715 CD9A44          17      CALL    CALSLT_R
001718 5718 DDE1            14      POP IX
00171A 571A D1              10      POP DE
00171B 571B 215DF5          10      LD  HL,BUF-1
00171E 571E F5              11      PUSH    AF
00171F 571F 19              11      ADD HL,DE
001720 5720 F1              10      POP AF
001721 5721 EB               4      EX  DE,HL
001722 5722 E1              10      POP HL
001723 5723 E5              11      PUSH    HL
001724 5724 0E00             7      LD  C,0
001726 5726 3014            12      JR  NC,SAX0
001728 5728 23               6      INC HL
001729 5729 23               6      INC HL
00172A 572A 1818            12      JR  SAX4
       572C                     SX0A_CBIOS:
00172C 572C CD5A57          17      CALL    GETL
00172F 572F 111FF4          10      LD  DE,KBUF
001732 5732 E1              10      POP HL
001733 5733 E5              11      PUSH    HL
001734 5734 0E00             7      LD  C,0
001736 5736 3004            12      JR  NC,SAX0
001738 5738 23               6      INC HL
001739 5739 23               6      INC HL
00173A 573A 1808            12      JR  SAX4
       573C                     SAX0:
00173C 573C 46               7      LD  B,(HL)
00173D 573D 23               6      INC HL
       573E                     SAX1:
00173E 573E 23               6      INC HL
00173F 573F 1A               7      LD  A,(DE)
001740 5740 13               6      INC DE
001741 5741 B7               4      OR  A
001742 5742 2004            12      JR  NZ,SAX2
       5744                     SAX4:
001744 5744 360D            10      LD  (HL),00DH
001746 5746 1804            12      JR  SAX3
       5748                     SAX2:
001748 5748 77               7      LD  (HL),A
001749 5749 0C               4      INC C
00174A 574A 10F2            13      DJNZ    SAX1
       574C                     SAX3:
00174C 574C D1              10      POP DE
00174D 574D 79               4      LD  A,C
00174E 574E 13               6      INC DE
00174F 574F 12               7      LD  (DE),A
001750 5750 1B               6      DEC DE
001751 5751 E1              10      POP HL
001752 5752 C1              10      POP BC
001753 5753 3E1E             7      LD  A,01EH
001755 5755 CD3156          17      CALL    MSG_A
001758 5758 AF               4      XOR A
001759 5759 C9              10      RET
                                ;           ;C-BIOSはPLININが意図通りに動作しないので
       575A                     GETL:
00175A 575A DDE5            15      PUSH    IX
00175C 575C FDE5            15      PUSH    IY
                                
00175E 575E 3AAFFC          13      LD  A,(SCRMOD)
001761 5761 B7               4      OR  A
001762 5762 280E            12      JR  Z,GETL0
001764 5764 DD216C00        14      LD  IX,INITXT
001768 5768 CD9A44          17      CALL    CALSLT_R
00176B 576B DD217800        14      LD  IX,SETTXT
00176F 576F CD9A44          17      CALL    CALSLT_R
       5772                     GETL0:
001772 5772 2ADCF3          16      LD  HL,(CSRY)
001775 5775 22CAFB          16      LD  (FSTPOS),HL
       5778                     GETL1:
001778 5778 CD6C56          17      CALL    _SYS08
00177B 577B FE09             7      CP  9
00177D 577D 2008            12      JR  NZ,GETL1V
00177F 577F 211FF4          10      LD  HL,KBUF
001782 5782 CDB944          17      CALL    MSX
001785 5785 18F1            12      JR  GETL1
       5787                     GETL1V:
001787 5787 5F               4      LD  E,A
001788 5788 FE08             7      CP  8
00178A 578A CC8358          17      CALL    Z,CTRL02
00178D 578D FE20             7      CP  020H
00178F 578F D4AF58          17      CALL    NC,INSERT
001792 5792 CD3556          17      CALL    MSGA1
                                
001795 5795 7B               4      LD  A,E
001796 5796 FE0D             7      CP  00DH
001798 5798 20DE            12      JR  NZ,GETL1
                                
00179A 579A 111FF4          10      LD  DE,KBUF
00179D 579D 3AB0F3          13      LD  A,(LINLEN)
0017A0 57A0 47               4      LD  B,A
0017A1 57A1 CD715B          17      CALL    ZERO_MEMORY_DE
                                
0017A4 57A4 2ACAFB          16      LD  HL,(FSTPOS)
0017A7 57A7 3ADCF3          13      LD  A,(CSRY)
0017AA 57AA 6F               4      LD  L,A
0017AB 57AB E5              11      PUSH    HL
0017AC 57AC CDE058          17      CALL    LOC0
0017AF 57AF 4D               4      LD  C,L
0017B0 57B0 44               4      LD  B,H
0017B1 57B1 E1              10      POP HL
0017B2 57B2 3AB0F3          13      LD  A,(LINLEN)
0017B5 57B5 94               4      SUB H
0017B6 57B6 3D               4      DEC A
0017B7 57B7 5F               4      LD  E,A
0017B8 57B8 211FF4          10      LD  HL,KBUF
       57BB                     GETL2:
0017BB 57BB CD7358          17      CALL    _SCRN
0017BE 57BE 03               6      INC BC
0017BF 57BF 77               7      LD  (HL),A
0017C0 57C0 23               6      INC HL
0017C1 57C1 1D               4      DEC E
0017C2 57C2 20F7            12      JR  NZ,GETL2
0017C4 57C4 CD5256          17      CALL    MSG_CR
                                
0017C7 57C7 FDE1            14      POP IY
0017C9 57C9 DDE1            14      POP IX
       57CB                     GETL3:
0017CB 57CB 2B               6      DEC HL
0017CC 57CC 7E               7      LD  A,(HL)
0017CD 57CD FE21             7      CP  021H
0017CF 57CF D0              11      RET NC
0017D0 57D0 3600            10      LD  (HL),0
0017D2 57D2 15               4      DEC D
0017D3 57D3 20F6            12      JR  NZ,GETL3
0017D5 57D5 C9              10      RET
                                
       57D6                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       57D6                     CONSTX:
       57D6                     CPM_CONST:
0017D6 57D6 C5              11      PUSH    BC
0017D7 57D7 D5              11      PUSH    DE
0017D8 57D8 E5              11      PUSH    HL
0017D9 57D9 DDE5            15      PUSH    IX
0017DB 57DB DD219C00        14      LD  IX,CHSNS
0017DF 57DF CD9A44          17      CALL    CALSLT_R
0017E2 57E2 DDE1            14      POP IX
0017E4 57E4 E1              10      POP HL
0017E5 57E5 D1              10      POP DE
0017E6 57E6 C1              10      POP BC
0017E7 57E7 C9              10      RET
                                
       57E8                     _SYS2A:     ;(BDOS)日付の獲得
0017E8 57E8 0E0B             7      LD  C,11        ;年/Year→HL
0017EA 57EA CD2958          17      CALL    RDCLK_BCD
0017ED 57ED 6F               4      LD  L,A
0017EE 57EE 2600             7      LD  H,0
0017F0 57F0 3AF8FA          13      LD  A,(EXBRSA)
0017F3 57F3 B7               4      OR  A
0017F4 57F4 2804            12      JR  Z,SX2A1
0017F6 57F6 11BC07          10      LD  DE,1980     ;1980年～2079年
0017F9 57F9 19              11      ADD HL,DE
       57FA                     SX2A1:
0017FA 57FA 0E09             7      LD  C,9     ;月/Month→D
0017FC 57FC CD2958          17      CALL    RDCLK_BCD
0017FF 57FF 57               4      LD  D,A
                                
001800 5800 0E07             7      LD  C,7     ;日/Day→E
001802 5802 CD2958          17      CALL    RDCLK_BCD
001805 5805 5F               4      LD  E,A
                                
001806 5806 0E06             7      LD  C,6     ;曜日/Week→A
       5808                     RDCLK:
001808 5808 DDE5            15      PUSH    IX
00180A 580A DD21F501        14      LD  IX,REDCLK
       580E                     WRCLK1:
00180E 580E 3AF8FA          13      LD  A,(EXBRSA)
001811 5811 B7               4      OR  A
001812 5812 280A            12      JR  Z,RDCLK1    ;MSX1
001814 5814 FDE5            15      PUSH    IY
001816 5816 FD67             9      LD  IYH,A
001818 5818 78               4      LD  A,B
001819 5819 CD1C00          17      CALL    _CALSLT
00181C 581C FDE1            14      POP IY
       581E                     RDCLK1:
00181E 581E DDE1            14      POP IX
001820 5820 C9              10      RET
       5821                     WRCLK:
001821 5821 DDE5            15      PUSH    IX
001823 5823 DD21F901        14      LD  IX,WRTCLK
001827 5827 18E5            12      JR  WRCLK1
                                
       5829                     RDCLK_BCD:
001829 5829 CD0858          17      CALL    RDCLK       ;1の位
00182C 582C 47               4      LD  B,A
00182D 582D 0C               4      INC C
00182E 582E CD0858          17      CALL    RDCLK       ;10の位
001831 5831 87               4      ADD A,A     ;*2
001832 5832 4F               4      LD  C,A
001833 5833 87               4      ADD A,A     ;*4
001834 5834 87               4      ADD A,A     ;*8
001835 5835 81               4      ADD A,C     ;*10(8+2)
001836 5836 80               4      ADD A,B     ;1の位
001837 5837 C9              10      RET
                                
       5838                     _SYS2C:     ;(BDOS)時刻の獲得
001838 5838 011501          10      LD  BC,00115H       ;12時間計/24時間計の設定を24時間計に
00183B 583B CD2158          17      CALL    WRCLK
00183E 583E 0E04             7      LD  C,4     ;H=時/Hour
001840 5840 CD2958          17      CALL    RDCLK_BCD
001843 5843 67               4      LD  H,A
001844 5844 0E02             7      LD  C,2     ;L=分/Minute
001846 5846 CD2958          17      CALL    RDCLK_BCD
001849 5849 6F               4      LD  L,A
00184A 584A 0E00             7      LD  C,0     ;D=秒/Second
00184C 584C CD2958          17      CALL    RDCLK_BCD
00184F 584F 57               4      LD  D,A
001850 5850 AF               4      XOR A       ;E=1/100秒
001851 5851 5F               4      LD  E,A
001852 5852 C9              10      RET
                                
       5853                     POS:
001853 5853 F5              11      PUSH    AF
001854 5854 2ADCF3          16      LD  HL,(CSRY)
001857 5857 7D               4      LD  A,L
001858 5858 6C               4      LD  L,H
001859 5859 67               4      LD  H,A
00185A 585A 2C               4      INC L
00185B 585B 24               4      INC H
00185C 585C F1              10      POP AF
00185D 585D C9              10      RET
                                
       585E                     LOC:
00185E 585E F5              11      PUSH    AF
00185F 585F E5              11      PUSH    HL
001860 5860 7D               4      LD  A,L
001861 5861 6C               4      LD  L,H
001862 5862 67               4      LD  H,A
001863 5863 2D               4      DEC L
001864 5864 25               4      DEC H
001865 5865 DDE5            15      PUSH    IX
001867 5867 DD21C600        14      LD  IX,POSIT
00186B 586B CD9A44          17      CALL    CALSLT_R
00186E 586E DDE1            14      POP IX
001870 5870 E1              10      POP HL
001871 5871 F1              10      POP AF
001872 5872 C9              10      RET
                                
       5873                     _SCRN:
       5873                     SCRN:
001873 5873 E5              11      PUSH    HL
001874 5874 DDE5            15      PUSH    IX
                                
001876 5876 69               4      LD  L,C
001877 5877 60               4      LD  H,B
001878 5878 DD214A00        14      LD  IX,RDVRM
00187C 587C CD9A44          17      CALL    CALSLT_R
                                
00187F 587F DDE1            14      POP IX
001881 5881 E1              10      POP HL
001882 5882 C9              10      RET
                                
       5883                     CTRL02:
001883 5883 F5              11      PUSH    AF
001884 5884 D5              11      PUSH    DE
001885 5885 2ADCF3          16      LD  HL,(CSRY)
001888 5888 3AB0F3          13      LD  A,(LINLEN)
00188B 588B 4F               4      LD  C,A
00188C 588C 94               4      SUB H   ;CSRX
00188D 588D C602             7      ADD A,2
00188F 588F 47               4      LD  B,A ;カーソルより右の文字数
001890 5890 61               4      LD  H,C ;LINLEN
001891 5891 C5              11      PUSH    BC
001892 5892 CDE058          17      CALL    LOC0
001895 5895 C1              10      POP BC
                                
001896 5896 1620             7      LD  D,020H
       5898                     C8X1:
001898 5898 DD214A00        14      LD  IX,RDVRM
00189C 589C CD9A44          17      CALL    CALSLT_R
00189F 589F 4F               4      LD  C,A
0018A0 58A0 7A               4      LD  A,D
0018A1 58A1 DD214D00        14      LD  IX,WRTVRM
0018A5 58A5 CD9A44          17      CALL    CALSLT_R
0018A8 58A8 2B               6      DEC HL
0018A9 58A9 51               4      LD  D,C
0018AA 58AA 10EC            13      DJNZ    C8X1
0018AC 58AC D1              10      POP DE
0018AD 58AD F1              10      POP AF
0018AE 58AE C9              10      RET
                                
       58AF                     INSERT:
0018AF 58AF F5              11      PUSH    AF
0018B0 58B0 D5              11      PUSH    DE
0018B1 58B1 2ADCF3          16      LD  HL,(CSRY)
0018B4 58B4 3AB0F3          13      LD  A,(LINLEN)
0018B7 58B7 4F               4      LD  C,A
0018B8 58B8 94               4      SUB H   ;CSRX
0018B9 58B9 3C               4      INC A
0018BA 58BA 47               4      LD  B,A ;カーソルより右の文字数
0018BB 58BB C5              11      PUSH    BC
0018BC 58BC CDE058          17      CALL    LOC0
0018BF 58BF C1              10      POP BC
                                
0018C0 58C0 1620             7      LD  D,020H
       58C2                     INS1:
0018C2 58C2 DD214A00        14      LD  IX,RDVRM
0018C6 58C6 CD9A44          17      CALL    CALSLT_R
0018C9 58C9 4F               4      LD  C,A
0018CA 58CA 7A               4      LD  A,D
0018CB 58CB DD214D00        14      LD  IX,WRTVRM
0018CF 58CF CD9A44          17      CALL    CALSLT_R
0018D2 58D2 23               6      INC HL
0018D3 58D3 51               4      LD  D,C
0018D4 58D4 10EC            13      DJNZ    INS1
0018D6 58D6 D1              10      POP DE
0018D7 58D7 F1              10      POP AF
0018D8 58D8 C9              10      RET
                                
       58D9                     CONOUT1:
0018D9 58D9 59               4      LD  E,C
0018DA 58DA C32B56          10      JP  _PRINT
                                
       58DD                     GETVRAM:
0018DD 58DD 2ADCF3          16      LD  HL,(CSRY)
       58E0                     LOC0:
0018E0 58E0 2D               4      DEC L
0018E1 58E1 25               4      DEC H
0018E2 58E2 4C               4      LD  C,H ;CSRX-1
0018E3 58E3 5D               4      LD  E,L ;CSRY-1
       58E4                     LOC1:
0018E4 58E4 3AB0F3          13      LD  A,(LINLEN)
0018E7 58E7 67               4      LD  H,A
0018E8 58E8 1600             7      LD  D,0
0018EA 58EA 6A               4      LD  L,D ;0
0018EB 58EB 0608             7      LD  B,8
       58ED                     LOC2:
0018ED 58ED 29              11      ADD HL,HL
0018EE 58EE 3001            12      JR  NC,LOC3
0018F0 58F0 19              11      ADD HL,DE
       58F1                     LOC3:
0018F1 58F1 10FA            13      DJNZ    LOC2
0018F3 58F3 09              11      ADD HL,BC
0018F4 58F4 C9              10      RET
                                
       58F5                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0018F5 58F5 212200          10      LD  HL,00022H
0018F8 58F8 AF               4      XOR A
0018F9 58F9 7D               4      LD  A,L
0018FA 58FA C9              10      RET
                                
       58FB                     _SYS0D:     ;(BDOS)ディスク・リセット
0018FB 58FB 218000          10      LD  HL,00080H
0018FE 58FE 22D4F2          16      LD  (_DTA),HL
001901 5901 C9              10      RET
                                
       5902                     _SYS0E:     ;(BDOS)カレントドライブの設定
001902 5902 7B               4      LD  A,E
       5903                     _SYS0EX1:
001903 5903 FE08             7      CP  8
001905 5905 3F               4      CCF
001906 5906 D8              11      RET C
001907 5907 32EAF2          13      LD  (_DVSW),A
00190A 590A C9              10      RET
                                
       590B                     _SYS0F:     ;(BDOS)ファイルのオープン
00190B 590B D5              11      PUSH    DE
00190C 590C FDE1            14      POP IY
00190E 590E CD495B          17      CALL    INIT_FILE
001911 5911 CDCF4D          17      CALL    ROM_OPEN
001914 5914 385F            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
001916 5916 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
00191A 591A FDE5            15      PUSH    IY
00191C 591C D1              10      POP DE
00191D 591D 13               6      INC DE
00191E 591E 010B00          10      LD  BC,11
001921 5921 EDB0                    LDIR
                                ;               Attribute
001923 5923 7E               7      LD  A,(HL)
001924 5924 FD770D          19      LD  (IY+13),A
                                ;               TIME
001927 5927 110B00          10      LD  DE,11
00192A 592A 19              11      ADD HL,DE
00192B 592B 7E               7      LD  A,(HL)
00192C 592C 23               6      INC HL
00192D 592D FD7716          19      LD  (IY+22),A
001930 5930 7E               7      LD  A,(HL)
001931 5931 23               6      INC HL
001932 5932 FD7717          19      LD  (IY+23),A
                                ;               DATE
001935 5935 7E               7      LD  A,(HL)
001936 5936 23               6      INC HL
001937 5937 FD7714          19      LD  (IY+20),A
00193A 593A 7E               7      LD  A,(HL)
00193B 593B 23               6      INC HL
00193C 593C FD7715          19      LD  (IY+21),A
                                ;               First cluster
00193F 593F 7E               7      LD  A,(HL)
001940 5940 23               6      INC HL
001941 5941 FD771A          19      LD  (IY+26),A
001944 5944 7E               7      LD  A,(HL)
001945 5945 23               6      INC HL
001946 5946 FD771B          19      LD  (IY+27),A
                                ;               SIZE
001949 5949 7E               7      LD  A,(HL)
00194A 594A 23               6      INC HL
00194B 594B FD7710          19      LD  (IY+16),A
00194E 594E 7E               7      LD  A,(HL)
00194F 594F 23               6      INC HL
001950 5950 FD7711          19      LD  (IY+17),A
001953 5953 7E               7      LD  A,(HL)
001954 5954 23               6      INC HL
001955 5955 FD7712          19      LD  (IY+18),A
001958 5958 7E               7      LD  A,(HL)
001959 5959 FD7713          19      LD  (IY+19),A
00195C 595C 2AEFF2          16      LD  HL,(DIRENT1)
00195F 595F FD751E          19      LD  (IY+30),L
001962 5962 FD741F          19      LD  (IY+31),H
001965 5965 3AF1F2          13      LD  A,(_DIR_BANK)
001968 5968 FD771D          19      LD  (IY+29),A
00196B 596B AF               4      XOR A
00196C 596C FD770C          19      LD  (IY+12),A
00196F 596F C9              10      RET
                                
       5970                     _SYS10:     ;(BDOS)ファイルのクローズ
001970 5970 AF               4      XOR A
001971 5971 C9              10      RET
                                
       5972                     S11X1:
001972 5972 FD7119          19      LD  (IY+25),C       ;RootEntCnt
       5975                     SCF_FF_RET:
001975 5975 37               4      SCF
001976 5976 9F               4      SBC A,A
001977 5977 C9              10      RET
                                
       5978                     _SYS11:     ;(BDOS)最初のファイルの検索
001978 5978 ED53D7F2        20      LD  (_FCB),DE
00197C 597C D5              11      PUSH    DE
00197D 597D FDE1            14      POP IY
00197F 597F CD495B          17      CALL    INIT_FILE
001982 5982 FD361801        19      LD  (IY+24),1
001986 5986 CD9250          17      CALL    GET_DIR_DAT
       5989                     S12X1:
001989 5989 CD434E          17      CALL    FILESE
00198C 598C FD3418          23      INC (IY+24)
00198F 598F 30E1            12      JR  NC,S11X1
001991 5991 0D               4      DEC C
001992 5992 FD7119          19      LD  (IY+25),C       ;RootEntCnt
001995 5995 FDCB0D66        20      BIT 4,(IY+13)
001999 5999 280A            12      JR  Z,S12X2
00199B 599B E5              11      PUSH    HL
00199C 599C DDE1            14      POP IX
00199E 599E DD7E0B          19      LD  A,(IX+11)
0019A1 59A1 FE0F             7      CP  00FH
0019A3 59A3 2810            12      JR  Z,S11NEXT
       59A5                     S12X2:
0019A5 59A5 012000          10      LD  BC,32
0019A8 59A8 ED5BD4F2        20      LD  DE,(_DTA)
0019AC 59AC FD7E00          19      LD  A,(IY+0)
0019AF 59AF 12               7      LD  (DE),A      ;ドライブ番号
0019B0 59B0 13               6      INC DE
0019B1 59B1 EDB0                    LDIR            ;ディレクトリエントリ
0019B3 59B3 AF               4      XOR A
0019B4 59B4 C9              10      RET
       59B5                     S11NEXT:
0019B5 59B5 CD614E          17      CALL    FNEXT
0019B8 59B8 20CF            12      JR  NZ,S12X1
0019BA 59BA 37               4      SCF
0019BB 59BB 9F               4      SBC A,A
0019BC 59BC C9              10      RET
                                
       59BD                     _SYS12:
0019BD 59BD FD2AD7F2        20      LD  IY,(_FCB)
0019C1 59C1 FDE5            15      PUSH    IY
0019C3 59C3 D1              10      POP DE
0019C4 59C4 CD495B          17      CALL    INIT_FILE
       59C7                     S12X3:
0019C7 59C7 CD9250          17      CALL    GET_DIR_DAT
0019CA 59CA FD4618          19      LD  B,(IY+24)
       59CD                     S12X4:
0019CD 59CD C5              11      PUSH    BC
0019CE 59CE CD614E          17      CALL    FNEXT
0019D1 59D1 C1              10      POP BC
0019D2 59D2 2807            12      JR  Z,S12X5
0019D4 59D4 7E               7      LD  A,(HL)
0019D5 59D5 FEE5             7      CP  0E5H
0019D7 59D7 28F4            12      JR  Z,S12X4
0019D9 59D9 10F2            13      DJNZ    S12X4
       59DB                     S12X5:
0019DB 59DB FD4E19          19      LD  C,(IY+25)
0019DE 59DE 18A9            12      JR  S12X1
                                
       59E0                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0019E0 59E0 CD6950          17      CALL    SET_FCB
0019E3 59E3 CD3750          17      CALL    GETSEQ
0019E6 59E6 CD2450          17      CALL    RB_READ
0019E9 59E9 E5              11      PUSH    HL
0019EA 59EA CD4450          17      CALL    SETSEQ
0019ED 59ED E1              10      POP HL
       59EE                     SREAD:
0019EE 59EE C601             7      ADD A,001H
0019F0 59F0 D8              11      RET C
                                
0019F1 59F1 7D               4      LD  A,L
0019F2 59F2 D601             7      SUB 001H
0019F4 59F4 9F               4      SBC A,A
0019F5 59F5 E603             7      AND 3
0019F7 59F7 1F               4      RRA
0019F8 59F8 C9              10      RET
                                
       59F9                     _SYS18:     ;(BDOS)ログインベクトルの獲得
       59F9                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
0019F9 59F9 2AF2F2          16      LD  HL,(_LVECTOR)
0019FC 59FC AF               4      XOR A
0019FD 59FD 67               4      LD  H,A
0019FE 59FE C9              10      RET
                                
       59FF                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
0019FF 59FF 3AEAF2          13      LD  A,(_DVSW)
001A02 5A02 A7               4      AND A
001A03 5A03 C9              10      RET
                                
       5A04                     _SYS1A:     ;(BDOS)DTAの設定
001A04 5A04 ED53D4F2        20      LD  (_DTA),DE
001A08 5A08 AF               4      XOR A
001A09 5A09 C9              10      RET
                                
       5A0A                     _SYS1B:     ;(BDOS)ディスク情報の獲得
001A0A 5A0A 7B               4      LD  A,E
001A0B 5A0B D601             7      SUB 1
001A0D 5A0D DCFF59          17      CALL    C,_SYS19
001A10 5A10 5F               4      LD  E,A
001A11 5A11 CD0754          17      CALL    IS_BPB
001A14 5A14 3827            12      JR  C,S1B_E
001A16 5A16 F5              11      PUSH    AF
001A17 5A17 215EF5          10      LD  HL,SYS1B_DPB
001A1A 5A1A 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
001A1D 5A1D 47               4      LD  B,A
001A1E 5A1E 4F               4      LD  C,A
001A1F 5A1F 3271F5          13      LD  (SYS1B_FAT),A
001A22 5A22 7B               4      LD  A,E
001A23 5A23 CD2454          17      CALL    GETDPB
001A26 5A26 DD215EF5        14      LD  IX,SYS1B_DPB
001A2A 5A2A FD2171F5        14      LD  IY,SYS1B_FAT
001A2E 5A2E ED4B60F5        20      LD  BC,(SYS1B_DPB+1+1)  ;SECSIZ
001A32 5A32 ED5B6CF5        20      LD  DE,(SYS1B_DPB+1+13) ;MAXCLUS
001A36 5A36 1B               6      DEC DE
001A37 5A37 1B               6      DEC DE
001A38 5A38 210000          10      LD  HL,0            ;書き込み不可なので0を返す
001A3B 5A3B F1              10      POP AF
001A3C 5A3C C9              10      RET
       5A3D                     S1B_E:
001A3D 5A3D 9F               4      SBC A,A
001A3E 5A3E C9              10      RET
                                
       5A3F                     _SYS21:     ;(BDOS)ランダムな読み出し
001A3F 5A3F CD6950          17      CALL    SET_FCB
                                
001A42 5A42 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001A45 5A45 FD6622          19      LD  H,(IY+34)
                                
001A48 5A48 CD2450          17      CALL    RB_READ
001A4B 5A4B 18A1            12      JR  SREAD
                                
       5A4D                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
001A4D 5A4D CD0B59          17      CALL    _SYS0F
001A50 5A50 D8              11      RET C
                                
001A51 5A51 D5              11      PUSH    DE      ;EX DE,IY
001A52 5A52 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001A54 5A54 CD5950          17      CALL    GETSIZE
       5A57                     _S24X1:
001A57 5A57 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001A5A 5A5A FD7422          19      LD  (IY+34),H
001A5D 5A5D FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
001A61 5A61 FDE3            23      EX  (SP),IY     ;
001A63 5A63 D1              10      POP DE      ;
                                
001A64 5A64 AF               4      XOR A
001A65 5A65 C9              10      RET
                                
       5A66                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
001A66 5A66 E5              11      PUSH    HL
001A67 5A67 D5              11      PUSH    DE      ;EX DE,IY
001A68 5A68 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001A6A 5A6A CD3750          17      CALL    GETSEQ
001A6D 5A6D 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       5A6F                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001A6F 5A6F CD6950          17      CALL    SET_FCB
001A72 5A72 E5              11      PUSH    HL
001A73 5A73 FD7E00          19      LD  A,(IY+0)
001A76 5A76 3200F3          13      LD  (FDRV),A
001A79 5A79 FD7E18          19      LD  A,(IY+24)
001A7C 5A7C 32C4F2          13      LD  (_BANK),A
001A7F 5A7F FD6E21          19      LD  L,(IY+33)
001A82 5A82 FD6622          19      LD  H,(IY+34)
001A85 5A85 22CAF2          16      LD  (RR_LOW),HL
001A88 5A88 FD6E23          19      LD  L,(IY+35)
001A8B 5A8B FD6624          19      LD  H,(IY+36)
001A8E 5A8E 22CCF2          16      LD  (RR_HIGH),HL
001A91 5A91 E1              10      POP HL
001A92 5A92 CD874B          17      CALL    ROM_READ
001A95 5A95 ED5BCAF2        20      LD  DE,(RR_LOW)
001A99 5A99 FD7321          19      LD  (IY+33),E
001A9C 5A9C FD7222          19      LD  (IY+34),D
001A9F 5A9F ED5BCCF2        20      LD  DE,(RR_HIGH)
001AA3 5AA3 FD7323          19      LD  (IY+35),E
001AA6 5AA6 FD7224          19      LD  (IY+36),D
001AA9 5AA9 3AC4F2          13      LD  A,(_BANK)
001AAC 5AAC FD7718          19      LD  (IY+24),A
001AAF 5AAF 9F               4      SBC A,A
001AB0 5AB0 D8              11      RET C
001AB1 5AB1 3AC3F2          13      LD  A,(_RESULT)
001AB4 5AB4 C9              10      RET
                                
       5AB5                     _SYS29:
001AB5 5AB5 E5              11      PUSH    HL
001AB6 5AB6 23               6      INC HL
001AB7 5AB7 CDFF5A          17      CALL    _SYS5C
001ABA 5ABA E3              19      EX  (SP),HL
001ABB 5ABB 79               4      LD  A,C
001ABC 5ABC CDB65B          17      CALL    LD_HL_A
001ABF 5ABF 010E00          10      LD  BC,14
001AC2 5AC2 09              11      ADD HL,BC
001AC3 5AC3 C1              10      POP BC
001AC4 5AC4 03               6      INC BC
001AC5 5AC5 79               4      LD  A,C
001AC6 5AC6 CDB65B          17      CALL    LD_HL_A
001AC9 5AC9 23               6      INC HL
001ACA 5ACA 78               4      LD  A,B
001ACB 5ACB CDB65B          17      CALL    LD_HL_A
001ACE 5ACE AF               4      XOR A
001ACF 5ACF C9              10      RET
                                
       5AD0                     _SYS2F:
001AD0 5AD0 44               4      LD  B,H
001AD1 5AD1 7D               4      LD  A,L
001AD2 5AD2 2AD4F2          16      LD  HL,(_DTA)
001AD5 5AD5 C38153          10      JP  DISKIO
                                
       5AD8                     _SYS59:     ;(BDOS)カレントディレクトリの取得
001AD8 5AD8 78               4      LD  A,B
001AD9 5AD9 CD9F55          17      CALL    GET_CD_CDRV
001ADC 5ADC 7C               4      LD  A,H
001ADD 5ADD B5               4      OR  L
001ADE 5ADE 2808            12      JR  Z,S59E
001AE0 5AE0 3E23             7      LD  A,'#'
001AE2 5AE2 12               7      LD  (DE),A
001AE3 5AE3 13               6      INC DE
001AE4 5AE4 CDD05B          17      CALL    HEXHL
001AE7 5AE7 AF               4      XOR A
       5AE8                     S59E:
001AE8 5AE8 12               7      LD  (DE),A
001AE9 5AE9 C9              10      RET
                                
       5AEA                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
001AEA 5AEA CD805B          17      CALL    GET_PARAM_IX
001AED 5AED CD514C          17      CALL    FILE_BDOS
001AF0 5AF0 CD4951          17      CALL    ROM_CD
001AF3 5AF3 9F               4      SBC A,A
001AF4 5AF4 C9              10      RET
                                
       5AF5                     _SYS5B:     ;(BDOS)パス名の解析(_PARSE)
001AF5 5AF5 D5              11      PUSH    DE
001AF6 5AF6 CD805B          17      CALL    GET_PARAM_IX
001AF9 5AF9 CD514C          17      CALL    FILE_BDOS
001AFC 5AFC D1              10      POP DE
001AFD 5AFD 182C            12      JR  S5B_1
                                
       5AFF                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
001AFF 5AFF CD785B          17      CALL    SPCUT_SL
001B02 5B02 D5              11      PUSH    DE
                                
001B03 5B03 E5              11      PUSH    HL
001B04 5B04 AF               4      XOR A
001B05 5B05 CD9F55          17      CALL    GET_CD_CDRV
001B08 5B08 22F9F2          16      LD  (_CDX),HL
                                
001B0B 5B0B CD805B          17      CALL    GET_PARAM_IX
001B0E 5B0E CD514C          17      CALL    FILE_BDOS
001B11 5B11 E1              10      POP HL
                                
001B12 5B12 060B             7      LD  B,11
001B14 5B14 1101F3          10      LD  DE,FNAME
       5B17                     S5C_1:
001B17 5B17 1A               7      LD  A,(DE)
001B18 5B18 13               6      INC DE
001B19 5B19 CDB65B          17      CALL    LD_HL_A
001B1C 5B1C 23               6      INC HL
001B1D 5B1D 10F8            13      DJNZ    S5C_1
                                
001B1F 5B1F DDE5            15      PUSH    IX
001B21 5B21 E1              10      POP HL
001B22 5B22 115EF5          10      LD  DE,BUF
001B25 5B25 A7               4      AND A
001B26 5B26 ED52            15      SBC HL,DE
001B28 5B28 D1              10      POP DE
001B29 5B29 19              11      ADD HL,DE
001B2A 5B2A EB               4      EX  DE,HL
       5B2B                     S5B_1:
001B2B 5B2B 2AF9F2          16      LD  HL,(_CDX)
001B2E 5B2E 3A00F3          13      LD  A,(FDRV)
001B31 5B31 4F               4      LD  C,A
001B32 5B32 AF               4      XOR A
001B33 5B33 C9              10      RET
                                
       5B34                     _SYS6F:
001B34 5B34 016F00          10      LD  BC,0006FH
001B37 5B37 11918A          10      LD  DE,08A91H       ;Tablacus Disk ROM Lite 認識コード
001B3A 5B3A AF               4      XOR A
001B3B 5B3B C9              10      RET
                                
       5B3C                     _SYS68:
001B3C 5B3C 21F2F2          10      LD  HL,_LVECTOR
001B3F 5B3F CBFE            15      SET 7,(HL)
001B41 5B41 78               4      LD  A,B
001B42 5B42 B7               4      OR  A
001B43 5B43 3E00             7      LD  A,0
001B45 5B45 C0              11      RET NZ
001B46 5B46 CBBE            15      RES 7,(HL)
001B48 5B48 C9              10      RET
                                
       5B49                     INIT_FILE:
001B49 5B49 EB               4      EX  DE,HL
001B4A 5B4A 1100F3          10      LD  DE,FDRV
001B4D 5B4D 010C00          10      LD  BC,1+8+3
       5B50                     INIT_FILE1:
001B50 5B50 EDB0                    LDIR
001B52 5B52 CDC055          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_MORMAL32K_OR_ASCII16
001B55 5B55 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
001B58 5B58 FD6E0E          19      LD  L,(IY+14)
001B5B 5B5B FD660F          19      LD  H,(IY+15)
001B5E 5B5E 7C               4      LD  A,H
001B5F 5B5F FE10             7      CP  010H
001B61 5B61 3004            12      JR  NC,INIT_FILE1X
001B63 5B63 B5               4      OR  L
001B64 5B64 2B               6      DEC HL
001B65 5B65 2006            12      JR  NZ,INIT_FILE2
       5B67                     INIT_FILE1X:
001B67 5B67 FD7E00          19      LD  A,(IY+0)
001B6A 5B6A CD9F55          17      CALL    GET_CD_CDRV
       5B6D                     INIT_FILE2:
001B6D 5B6D 22F9F2          16      LD  (_CDX),HL           ;カレントディレクトリ
001B70 5B70 C9              10      RET
                                
       5B71                     ZERO_MEMORY_DE:
001B71 5B71 AF               4      XOR A
       5B72                     FILL_MEMORY_DE:
001B72 5B72 12               7      LD  (DE),A
001B73 5B73 13               6      INC DE
001B74 5B74 10FC            13      DJNZ    FILL_MEMORY_DE
001B76 5B76 C9              10      RET
                                
       5B77                     SS1_SL:
001B77 5B77 13               6      INC DE
       5B78                     SPCUT_SL:               ;スペースをカット
001B78 5B78 CD9A5B          17      CALL    LD_A_DE
001B7B 5B7B FE20             7      CP  020H
001B7D 5B7D 28F8            12      JR  Z,SS1_SL
001B7F 5B7F C9              10      RET
                                
       5B80                     GET_PARAM_IX:
001B80 5B80 0600             7      LD  B,0
001B82 5B82 215EF5          10      LD  HL,BUF
001B85 5B85 E5              11      PUSH    HL
001B86 5B86 CD785B          17      CALL    SPCUT_SL
       5B89                     GPIX1:
001B89 5B89 CD9A5B          17      CALL    LD_A_DE
001B8C 5B8C 13               6      INC DE
001B8D 5B8D 77               7      LD  (HL),A
001B8E 5B8E 23               6      INC HL
001B8F 5B8F B7               4      OR  A
001B90 5B90 2804            12      JR  Z,GPIX2
001B92 5B92 04               4      INC B
001B93 5B93 20F4            12      JR  NZ,GPIX1
001B95 5B95 05               4      DEC B
       5B96                     GPIX2:
001B96 5B96 DDE1            14      POP IX
001B98 5B98 58               4      LD  E,B
001B99 5B99 C9              10      RET
                                
       5B9A                     LD_A_DE:
001B9A 5B9A 1A               7      LD  A,(DE)
001B9B 5B9B CB7A             8      BIT 7,D
001B9D 5B9D C0              11      RET NZ
001B9E 5B9E C5              11      PUSH    BC
001B9F 5B9F D5              11      PUSH    DE
001BA0 5BA0 E5              11      PUSH    HL
001BA1 5BA1 EB               4      EX  DE,HL
                                
001BA2 5BA2 0141F3          10      LD  BC,RAMAD0
001BA5 5BA5 7C               4      LD  A,H
001BA6 5BA6 07               4      RLCA
001BA7 5BA7 07               4      RLCA
001BA8 5BA8 E603             7      AND 3
001BAA 5BAA 81               4      ADD A,C
001BAB 5BAB 4F               4      LD  C,A
001BAC 5BAC 0A               7      LD  A,(BC)
                                
001BAD 5BAD CD0C00          17      CALL    _RDSLT
001BB0 5BB0 E1              10      POP HL
001BB1 5BB1 D1              10      POP DE
001BB2 5BB2 C1              10      POP BC
001BB3 5BB3 C9              10      RET
                                
       5BB4                     LD_HL_A_1:
001BB4 5BB4 77               7      LD  (HL),A
001BB5 5BB5 C9              10      RET
       5BB6                     LD_HL_A:
001BB6 5BB6 CB7C             8      BIT 7,H
001BB8 5BB8 20FA            12      JR  NZ,LD_HL_A_1
001BBA 5BBA C5              11      PUSH    BC
001BBB 5BBB D5              11      PUSH    DE
001BBC 5BBC E5              11      PUSH    HL
                                
001BBD 5BBD 5F               4      LD  E,A
001BBE 5BBE 0141F3          10      LD  BC,RAMAD0
001BC1 5BC1 7C               4      LD  A,H
001BC2 5BC2 07               4      RLCA
001BC3 5BC3 07               4      RLCA
001BC4 5BC4 E603             7      AND 3
001BC6 5BC6 81               4      ADD A,C
001BC7 5BC7 4F               4      LD  C,A
001BC8 5BC8 0A               7      LD  A,(BC)
                                
001BC9 5BC9 CD1400          17      CALL    _WRSLT
001BCC 5BCC E1              10      POP HL
001BCD 5BCD D1              10      POP DE
001BCE 5BCE C1              10      POP BC
001BCF 5BCF C9              10      RET
                                
       5BD0                     HEXHL:
001BD0 5BD0 7C               4      LD  A,H
001BD1 5BD1 CDD55B          17      CALL    HEXHX
001BD4 5BD4 7D               4      LD  A,L
       5BD5                     HEXHX:
001BD5 5BD5 F5              11      PUSH    AF
001BD6 5BD6 07               4      RLCA
001BD7 5BD7 07               4      RLCA
001BD8 5BD8 07               4      RLCA
001BD9 5BD9 07               4      RLCA
001BDA 5BDA CDDE5B          17      CALL    HEXA2
001BDD 5BDD F1              10      POP AF
       5BDE                     HEXA2:
001BDE 5BDE CDCE44          17      CALL    ASC
001BE1 5BE1 12               7      LD  (DE),A
001BE2 5BE2 13               6      INC DE
001BE3 5BE3 C9              10      RET
                                
       5BE4                     HEX:
001BE4 5BE4 CDB94D          17      CALL    CAP
001BE7 5BE7 D630             7      SUB '0'
001BE9 5BE9 D8              11      RET C
001BEA 5BEA FE0A             7      CP  10
001BEC 5BEC 3F               4      CCF
001BED 5BED D0              11      RET NC
001BEE 5BEE FE11             7      CP  16+1
001BF0 5BF0 D8              11      RET C
001BF1 5BF1 D607             7      SUB 7
001BF3 5BF3 FE10             7      CP  10H
001BF5 5BF5 3F               4      CCF
001BF6 5BF6 C9              10      RET
                                
       5975                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       5975                     _SYS13  EQU SCF_FF_RET  ;(BDOS)ファイルの削除
       5975                     _SYS15  EQU SCF_FF_RET  ;(BDOS)シーケンシャルな書き込み
       5975                     _SYS16  EQU SCF_FF_RET  ;(BDOS)ファイルの作成
       5975                     _SYS17  EQU SCF_FF_RET  ;(BDOS)ファイル名の変更
       5975                     _SYS22  EQU SCF_FF_RET  ;(BDOS)ランダムな書き込み
       5975                     _SYS26  EQU SCF_FF_RET  ;(BDOS)ランダムブロック書き込み
       5975                     _SYS28  EQU SCF_FF_RET  ;(BDOS)ランダムな書き込み・その2
                                
       5975                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       5975                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       5975                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       5975                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
001BF7 5BF7                         ALIGN   256
       5C00                     STABLE:
                                ;0
001C00 5C00 19562E565F567559        DW  _ERROR,_SYS01,_SYS02,_SYS03
001C08 5C08 195619566456B356        DW  _ERROR,_ERROR,_SYS06,_SYS07
001C10 5C10 6C56A556FF56D657        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
001C18 5C18 F558FB5802590B59        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001C20 5C20 70597859BD597559        DW  _SYS10,_SYS11,_SYS12,_SYS13
001C28 5C28 E059755975597559        DW  _SYS14,_SYS15,_SYS16,_SYS17
001C30 5C30 F959FF59045A0A5A        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001C38 5C38 1956F95919561956        DW  _ERROR,_SYS1D,_ERROR,_ERROR
                                ;2
001C40 5C40 19563F5A75594D5A        DW  _ERROR,_SYS21,_SYS22,_SYS23
001C48 5C48 665A195675596F5A        DW  _SYS24,_ERROR,_SYS26,_SYS27
001C50 5C50 7559B55AE8577559        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
001C58 5C58 385875591956D05A        DW  _SYS2C,_SYS2D,_ERROR,_SYS2F
                                ;3
001C60 5C60 1956195619561956        DW  _ERROR,_ERROR,_ERROR,_ERROR
001C68 5C68 1956195619561956        DW  _ERROR,_ERROR,_ERROR,_ERROR
001C70 5C70 1956755975591956        DW  _ERROR,_SYS39,_SYS3A,_ERROR
001C78 5C78 1956195619561956        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001C80 5C80 1956195619561956        DW  _ERROR,_ERROR,_ERROR,_ERROR
001C88 5C88 1956195619561956        DW  _ERROR,_ERROR,_ERROR,_ERROR
001C90 5C90 1956195619561956        DW  _ERROR,_ERROR,_ERROR,_ERROR
001C98 5C98 1956195619561956        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001CA0 5CA0 1956195619561956        DW  _ERROR,_ERROR,_ERROR,_ERROR
001CA8 5CA8 1956195619561956        DW  _ERROR,_ERROR,_ERROR,_ERROR
001CB0 5CB0 1956D85AEA5AF55A        DW  _ERROR,_SYS59,_SYS5A,_SYS5B
001CB8 5CB8 FF5A195619561956        DW  _SYS5C,_ERROR,_ERROR,_ERROR
                                ;6
001CC0 5CC0 1956195619561956        DW  _ERROR,_ERROR,_ERROR,_ERROR
001CC8 5CC8 1956195619561956        DW  _ERROR,_ERROR,_ERROR,_ERROR
001CD0 5CD0 3C5B195619561956        DW  _SYS68,_ERROR,_ERROR,_ERROR
001CD8 5CD8 195619561956345B        DW  _ERROR,_ERROR,_ERROR,_SYS6F
                                ;7
001CE0 5CE0 1956195619561956        DW  _ERROR,_ERROR,_ERROR,_ERROR
001CE8 5CE8 1956195619561956        DW  _ERROR,_ERROR,_ERROR,_ERROR
001CF0 5CF0 1956195619561956        DW  _ERROR,_ERROR,_ERROR,_ERROR
001CF8 5CF8 1956195619561956        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
                                    INCLUDE "SLOT.ASM"
                                #if exists _RAM64K
       5D00                     INT38H_ROM:
001D00 5D00 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
001D03 5D03 CD0C5D          17      CALL    ENASLT_00H
001D06 5D06 CD3800          17      CALL    00038H
001D09 5D09 3A41F3          13      LD  A,(RAMAD0)  ;メインRAMに切り替える
                                ;   JP  ENASLT_00H
                                ;
                                ;ページ0専門のENASLT
                                ;in
                                ;A←スロット
                                ;破壊
                                ;ABCHL
                                ;
                                ; ページ1 に配置
       5D0C                     ENASLT_00H:
001D0C 5D0C F3               4      DI
001D0D 5D0D 67               4      LD  H,A
001D0E 5D0E E603             7      AND 3
001D10 5D10 4F               4      LD  C,A
001D11 5D11 DBA8            11      IN  A,(0A8H)
001D13 5D13 06FC             7      LD  B,0FCH  ;ページ0
001D15 5D15 A0               4      AND B
001D16 5D16 B1               4      OR  C
001D17 5D17 CB7C             8      BIT 7,H
001D19 5D19 CA91F0          10      JP  Z,ENASLT_NOEXT
                                                ;拡張スロットの処理
001D1C 5D1C D5              11      PUSH    DE
001D1D 5D1D CD79F0          17      CALL    ENATBL
001D20 5D20 0F               4      RRCA
001D21 5D21 0F               4      RRCA
001D22 5D22 4F               4      LD  C,A
001D23 5D23 7B               4      LD  A,E
001D24 5D24 CD2A5D          17      CALL    AT_3B
001D27 5D27 73               7      LD  (HL),E
001D28 5D28 D1              10      POP DE
001D29 5D29 C9              10      RET
                                ;
                                ;   ENASLOTの補助（ページ0・003BH～にも配置）
                                ;
       5D2A                     AT_3B:              ;ENASUB 対象の拡張スロットを切り替えるために基本スロットを切り替える
001D2A 5D2A D3A8            11      OUT (0A8H),A
001D2C 5D2C 3AFFFF          13      LD  A,(0FFFFH)  ;拡張スロットの切り替え
001D2F 5D2F 2F               4      CPL
001D30 5D30 A0               4      AND B
001D31 5D31 B1               4      OR  C
001D32 5D32 32FFFF          13      LD  (0FFFFH),A
001D35 5D35 5F               4      LD  E,A
                                                ;基本スロットの切り替え
001D36 5D36 7A               4      LD  A,D
001D37 5D37 D3A8            11      OUT (0A8H),A
001D39 5D39 C9              10      RET
       5D3A                     AT_3B_E:
                                
                                #endif
                                
       5D3A                     AT_GETSLT:
       5D3A                     AT_ISC:
001D3A EF80                         ORG ISC,AT_ISC-RUN
                                ;
                                ; インタースロットコール
                                ; ページ3 に配置
                                
                                ;
                                ;   現在のスロットを知る
                                ;in
                                ;HL←上位2ビットで切り替えるページを指定
                                ;out
                                ;A→スロット
                                ;※ROM、RAMの両方のルーチンを使うため絶対番地を使わない
       EF80                     _GETSLT:
001D3A EF80 E5              11      PUSH    HL
001D3B EF81 DBA8            11      IN  A,(0A8H)
                                
001D3D EF83 CB7C             8      BIT 7,H
001D3F EF85 2032            12      JR  NZ,GETSLT_HIGH
001D41 EF87 CB74             8      BIT 6,H
001D43 EF89 21C1FC          10      LD  HL,EXPTBL
001D46 EF8C 201B            12      JR  NZ,GETSLT_40H
       EF8E                     GETSLT_00H:             ;ページ0
001D48 EF8E E603             7      AND 3
001D4A EF90 85               4      ADD A,L
001D4B EF91 6F               4      LD  L,A
001D4C EF92 CB7E            13      BIT 7,(HL)
001D4E EF94 280F            12      JR  Z,GETSLT_1
001D50 EF96 C604             7      ADD A,SLTTBL-EXPTBL     ;拡張スロットをワークアリアから取得
001D52 EF98 6F               4      LD  L,A
001D53 EF99 7E               7      LD  A,(HL)
       EF9A                     GETSLT_3:
001D54 EF9A 07               4      RLCA
001D55 EF9B 07               4      RLCA
       EF9C                     GETSLT_2:
001D56 EF9C E60C             7      AND 00CH
001D58 EF9E 67               4      LD  H,A
001D59 EF9F 7D               4      LD  A,L
001D5A EFA0 D645             7      SUB LOW SLTTBL - 080H
001D5C EFA2 B4               4      OR  H
001D5D EFA3 E1              10      POP HL
001D5E EFA4 C9              10      RET
       EFA5                     GETSLT_1:               ;スロットは拡張されていない
001D5F EFA5 D6C1             7      SUB LOW EXPTBL
001D61 EFA7 E1              10      POP HL
001D62 EFA8 C9              10      RET
                                
       EFA9                     GETSLT_40H:             ;ページ1
001D63 EFA9 0F               4      RRCA
001D64 EFAA 0F               4      RRCA
001D65 EFAB E603             7      AND 3
001D67 EFAD 85               4      ADD A,L
001D68 EFAE 6F               4      LD  L,A
001D69 EFAF CB7E            13      BIT 7,(HL)
001D6B EFB1 28F2            12      JR  Z,GETSLT_1
001D6D EFB3 C604             7      ADD A,SLTTBL-EXPTBL
001D6F EFB5 6F               4      LD  L,A
001D70 EFB6 7E               7      LD  A,(HL)
001D71 EFB7 18E3            12      JR  GETSLT_2
                                
       EFB9                     GETSLT_HIGH:
001D73 EFB9 CB74             8      BIT 6,H
001D75 EFBB 21C1FC          10      LD  HL,EXPTBL
001D78 EFBE 2014            12      JR  NZ,GETSLT_C0H
       EFC0                     GETSLT_80H:             ;ページ2
001D7A EFC0 0F               4      RRCA
001D7B EFC1 0F               4      RRCA
001D7C EFC2 0F               4      RRCA
001D7D EFC3 0F               4      RRCA
001D7E EFC4 E603             7      AND 3
001D80 EFC6 85               4      ADD A,L
001D81 EFC7 6F               4      LD  L,A
001D82 EFC8 CB7E            13      BIT 7,(HL)
001D84 EFCA 28D9            12      JR  Z,GETSLT_1
001D86 EFCC C604             7      ADD A,SLTTBL-EXPTBL
001D88 EFCE 6F               4      LD  L,A
001D89 EFCF 7E               7      LD  A,(HL)
001D8A EFD0 0F               4      RRCA
001D8B EFD1 0F               4      RRCA
001D8C EFD2 18C8            12      JR  GETSLT_2
                                
       EFD4                     GETSLT_C0H:             ;ページ3
001D8E EFD4 07               4      RLCA
001D8F EFD5 07               4      RLCA
001D90 EFD6 E603             7      AND 3
001D92 EFD8 85               4      ADD A,L
001D93 EFD9 6F               4      LD  L,A
001D94 EFDA CB7E            13      BIT 7,(HL)
001D96 EFDC 28C7            12      JR  Z,GETSLT_1
001D98 EFDE C604             7      ADD A,SLTTBL-EXPTBL
001D9A EFE0 6F               4      LD  L,A
001D9B EFE1 7E               7      LD  A,(HL)
001D9C EFE2 07               4      RLCA
001D9D EFE3 07               4      RLCA
001D9E EFE4 18B4            12      JR  GETSLT_3
                                
                                #if exists _RAM64K
       EFE6                     SAME_SLOT_00H:          ;ページ0とページ3のスロットが同一
001DA0 EFE6 D3A8            11      OUT (0A8H),A
001DA2 EFE8 3AFFFF          13      LD  A,(0FFFFH)  ;拡張スロットの切り替え
001DA5 EFEB 2F               4      CPL
001DA6 EFEC E6FC             7      AND 0FCH        ;ページ0マスク
001DA8 EFEE B1               4      OR  C
001DA9 EFEF 32FFFF          13      LD  (0FFFFH),A
001DAC EFF2 77               7      LD  (HL),A
001DAD EFF3 C9              10      RET
                                
       EFF4                     ENASLT_HIGH:
001DAE EFF4 CB74             8      BIT 6,H
001DB0 EFF6 C0              11      RET NZ          ;ページ3はスロット切り替え不可
                                ;
                                ;ページ2専門のENASLT
                                ;in
                                ;A←スロット
                                ;破壊
                                ;ABCHL
                                ;
       EFF7                     ENASLT_80H:
001DB1 EFF7 F3               4      DI
001DB2 EFF8 6F               4      LD  L,A
001DB3 EFF9 E603             7      AND 3
001DB5 EFFB 07               4      RLCA
001DB6 EFFC 07               4      RLCA
001DB7 EFFD 07               4      RLCA
001DB8 EFFE 07               4      RLCA
001DB9 EFFF 4F               4      LD  C,A
001DBA F000 DBA8            11      IN  A,(0A8H)
001DBC F002 06CF             7      LD  B,0CFH  ;ページ2マスク
001DBE F004 A0               4      AND B
001DBF F005 B1               4      OR  C
001DC0 F006 CB7D             8      BIT 7,L
001DC2 F008 CA91F0          10      JP  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001DC5 F00B D5              11      PUSH    DE
001DC6 F00C CD6FF0          17      CALL    ENATBL_BIOS_CHECK
001DC9 F00F 07               4      RLCA
001DCA F010 07               4      RLCA
001DCB F011 4F               4      LD  C,A
001DCC F012 7B               4      LD  A,E
001DCD F013 CD3B00          17      CALL    ENASUB
001DD0 F016 73               7      LD  (HL),E
001DD1 F017 D1              10      POP DE
001DD2 F018 C9              10      RET
                                ;
                                ;ENASLT
                                ;in
                                ;A←スロット
                                ;HL←上位2ビットで切り替えるページを指定
                                ;破壊
                                ;ABCHL
                                ;
       F019                     ENASLT:
001DD3 F019 CB7C             8      BIT 7,H
001DD5 F01B 20D7            12      JR  NZ,ENASLT_HIGH
001DD7 F01D CB74             8      BIT 6,H
001DD9 F01F 2073            12      JR  NZ,ENASLT_40H
       F021                     _ENASLT_00H:
001DDB F021 F3               4      DI
001DDC F022 67               4      LD  H,A
001DDD F023 E603             7      AND 3
001DDF F025 4F               4      LD  C,A
001DE0 F026 DBA8            11      IN  A,(0A8H)
001DE2 F028 E6FC             7      AND 0FCH    ;ページ0マスク
001DE4 F02A B1               4      OR  C
001DE5 F02B CB7C             8      BIT 7,H
001DE7 F02D 2862            12      JR  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001DE9 F02F D5              11      PUSH    DE
001DEA F030 44               4      LD  B,H
001DEB F031 CD79F0          17      CALL    ENATBL
001DEE F034 0F               4      RRCA
001DEF F035 0F               4      RRCA
001DF0 F036 4F               4      LD  C,A
001DF1 F037 7B               4      LD  A,E
001DF2 F038 BA               4      CP  D
001DF3 F039 D1              10      POP DE
001DF4 F03A 28AA            12      JR  Z,SAME_SLOT_00H ;ページ0とページ3のスロットが同一の場合
001DF6 F03C 60               4      LD  H,B
       F03D                     ENASLT_SUB:
001DF7 F03D 7C               4      LD  A,H     ;ページ3でスロットを指定するためにページ1のROMのルーチンを使う
001DF8 F03E DDE5            15      PUSH    IX
001DFA F040 DD210C5D        14      LD  IX,ENASLT_00H
       F044                     INT38H_SUB1:
001DFE F044 FDE5            15      PUSH    IY
001E00 F046 FD2A96F2        20      LD  IY,(ROM_SLT-1)
001E04 F04A CDC1F0          17      CALL    CALSLT
001E07 F04D FDE1            14      POP IY
001E09 F04F DDE1            14      POP IX
001E0B F051 C9              10      RET
                                
       F052                     _ENASLT_00H_S:
001E0C F052 ED735DF0        20      LD  (ENASLT_SP1),SP
001E10 F056 315DF5          10      LD  SP,SPBUF
001E13 F059 CD3DF0          17      CALL    ENASLT_SUB
001E16 F05C 310000          10      LD  SP,0
       F05D                     ENASLT_SP1  EQU $-2
001E19 F05F C9              10      RET
                                
       F060                     INT38H_SUB:
001E1A F060 DDE5            15      PUSH    IX
001E1C F062 DD21005D        14      LD  IX,INT38H_ROM
001E20 F066 18DC            12      JR  INT38H_SUB1
                                
       F068                     ENASLT_BIOS:
001E22 F068 D1              10      POP DE
001E23 F069 7D               4      LD  A,L
001E24 F06A CD2400          17      CALL    _ENASLT
001E27 F06D D1              10      POP DE
001E28 F06E C9              10      RET
                                
       F06F                     ENATBL_BIOS_CHECK:
001E29 F06F 57               4      LD  D,A
001E2A F070 3A0000          13      LD  A,(0000H)
001E2D F073 FEF3             7      CP  0F3H    ;0000H が DI の場合はページ0は BIOS とみなす
001E2F F075 28F1            12      JR  Z,ENASLT_BIOS
001E31 F077 65               4      LD  H,L
001E32 F078 7A               4      LD  A,D
       F079                     ENATBL:
001E33 F079 57               4      LD  D,A ;基本スロットに出力する値
                                            ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001E34 F07A 7C               4      LD  A,H
001E35 F07B E603             7      AND 3
001E37 F07D 4F               4      LD  C,A ;C=スロット#
                                
                                    ;スロットテーブル
001E38 F07E 2EC5             7      LD  L,LOW SLTTBL
001E3A F080 85               4      ADD A,L
001E3B F081 6F               4      LD  L,A
                                            ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001E3C F082 79               4      LD  A,C ;C=スロット#
001E3D F083 0F               4      RRCA
001E3E F084 0F               4      RRCA        ;ページ3
001E3F F085 4F               4      LD  C,A
001E40 F086 7A               4      LD  A,D ;基本スロットに出力する値
001E41 F087 E63F             7      AND 03FH    ;ページ3マスク
001E43 F089 B1               4      OR  C
001E44 F08A 5F               4      LD  E,A ;基本スロットでページ3にスロットを割り当てる
001E45 F08B 7C               4      LD  A,H
001E46 F08C E60C             7      AND 00CH
001E48 F08E 26FC             7      LD  H,HIGH SLTTBL
001E4A F090 C9              10      RET
       F091                     ENASLT_NOEXT_00H:
                                
       F091                     ENASLT_NOEXT:               ;スロットが拡張されていない場合
001E4B F091 D3A8            11      OUT (0A8H),A
001E4D F093 C9              10      RET
                                
                                ;
                                ;ページ1専門のENASLT
                                ;in
                                ;A←スロット
                                ;破壊
                                ;ABCHL
                                ;
       F094                     ENASLT_40H:
001E4E F094 F3               4      DI
001E4F F095 6F               4      LD  L,A
001E50 F096 E603             7      AND 3
001E52 F098 07               4      RLCA
001E53 F099 07               4      RLCA
001E54 F09A 4F               4      LD  C,A
001E55 F09B DBA8            11      IN  A,(0A8H)
001E57 F09D 06F3             7      LD  B,0F3H  ;ページ1マスク
001E59 F09F A0               4      AND B
001E5A F0A0 B1               4      OR  C
001E5B F0A1 CB7D             8      BIT 7,L
001E5D F0A3 28EC            12      JR  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001E5F F0A5 D5              11      PUSH    DE
001E60 F0A6 CD6FF0          17      CALL    ENATBL_BIOS_CHECK
001E63 F0A9 4F               4      LD  C,A
001E64 F0AA 7B               4      LD  A,E
001E65 F0AB CD3B00          17      CALL    ENASUB
001E68 F0AE 73               7      LD  (HL),E
001E69 F0AF D1              10      POP DE
001E6A F0B0 C9              10      RET
                                
       F0B1                     CALLF:
001E6B F0B1 E3              19      EX  (SP),HL
001E6C F0B2 F5              11      PUSH    AF
001E6D F0B3 7E               7      LD  A,(HL)
001E6E F0B4 FD67             9      LD  IYH,A
001E70 F0B6 23               6      INC HL
001E71 F0B7 7E               7      LD  A,(HL)
001E72 F0B8 DD6F             9      LD  IXL,A
001E74 F0BA 23               6      INC HL
001E75 F0BB 7E               7      LD  A,(HL)
001E76 F0BC DD67             9      LD  IXH,A
001E78 F0BE 23               6      INC HL
001E79 F0BF F1              10      POP AF
001E7A F0C0 E3              19      EX  (SP),HL
       F0C1                     CALSLT:
001E7B F0C1 F3               4      DI
001E7C F0C2 08               4      EX  AF,AF'
001E7D F0C3 F5              11      PUSH    AF      ;裏AFを保存
001E7E F0C4 E5              11      PUSH    HL
001E7F F0C5 210280          10      LD  HL,08002H
001E82 F0C8 39              11      ADD HL,SP
001E83 F0C9 E1              10      POP HL
001E84 F0CA 3007            12      JR  NC,CALSLT_1
001E86 F0CC CDE2F0          17      CALL    CALSLT_2
       F0CF                     CALSLT_E:
001E89 F0CF 08               4      EX  AF,AF'
001E8A F0D0 F1              10      POP AF      ;保存した裏AF
001E8B F0D1 08               4      EX  AF,AF'
001E8C F0D2 C9              10      RET
       F0D3                     CALSLT_1:
001E8D F0D3 ED73DEF0        20      LD  (CSSP),SP
001E91 F0D7 315DF5          10      LD  SP,SPBUF
001E94 F0DA CDE2F0          17      CALL    CALSLT_2
001E97 F0DD 310000          10      LD  SP,0
       F0DE                     CSSP    EQU $-2
001E9A F0E0 18ED            12      JR  CALSLT_E
                                
       F0E2                     CALSLT_2:
001E9C F0E2 E5              11      PUSH    HL
001E9D F0E3 DD7C             9      LD  A,IXH
001E9F F0E5 67               4      LD  H,A
001EA0 F0E6 CD80EF          17      CALL    _GETSLT
001EA3 F0E9 FDBC            10      CP  IYH
001EA5 F0EB 281E            12      JR  Z,CALSLT_3
001EA7 F0ED C5              11      PUSH    BC
001EA8 F0EE F5              11      PUSH    AF
001EA9 F0EF FD7C             9      LD  A,IYH
001EAB F0F1 CD19F0          17      CALL    ENASLT
001EAE F0F4 F1              10      POP AF
001EAF F0F5 C1              10      POP BC
001EB0 F0F6 6F               4      LD  L,A
001EB1 F0F7 DD7C             9      LD  A,IXH
001EB3 F0F9 67               4      LD  H,A
001EB4 F0FA E3              19      EX  (SP),HL
001EB5 F0FB 08               4      EX  AF,AF'
001EB6 F0FC CD98F3          17      CALL    JP_IX
001EB9 F0FF E3              19      EX  (SP),HL
001EBA F100 C5              11      PUSH    BC
001EBB F101 08               4      EX  AF,AF'
001EBC F102 7D               4      LD  A,L
001EBD F103 CD19F0          17      CALL    ENASLT
001EC0 F106 08               4      EX  AF,AF'
001EC1 F107 C1              10      POP BC
001EC2 F108 E1              10      POP HL
001EC3 F109 FB               4      EI
001EC4 F10A C9              10      RET
                                
       F10B                     CALSLT_3:
001EC5 F10B E1              10      POP HL
001EC6 F10C 08               4      EX  AF,AF'
001EC7 F10D DDE9             8      JP  (IX)
                                
       F10F                     RDSLT:
001EC9 F10F F3               4      DI
001ECA F110 D5              11      PUSH    DE
001ECB F111 57               4      LD  D,A
001ECC F112 CD80EF          17      CALL    _GETSLT
001ECF F115 BA               4      CP  D
001ED0 F116 2812            12      JR  Z,RDSLT1
001ED2 F118 5F               4      LD  E,A
001ED3 F119 7A               4      LD  A,D
001ED4 F11A E5              11      PUSH    HL
001ED5 F11B CD19F0          17      CALL    ENASLT
001ED8 F11E E1              10      POP HL
001ED9 F11F 46               7      LD  B,(HL)
001EDA F120 C5              11      PUSH    BC
001EDB F121 7B               4      LD  A,E
001EDC F122 E5              11      PUSH    HL
001EDD F123 CD19F0          17      CALL    ENASLT
001EE0 F126 E1              10      POP HL
001EE1 F127 F1              10      POP AF
001EE2 F128 D1              10      POP DE
001EE3 F129 C9              10      RET
       F12A                     RDSLT1:
001EE4 F12A 7E               7      LD  A,(HL)
001EE5 F12B D1              10      POP DE
001EE6 F12C C9              10      RET
                                
       F12D                     WRSLT:
001EE7 F12D F3               4      DI
001EE8 F12E D5              11      PUSH    DE
001EE9 F12F 57               4      LD  D,A
001EEA F130 CD80EF          17      CALL    _GETSLT
001EED F133 BA               4      CP  D
001EEE F134 2810            12      JR  Z,WRSLT1
001EF0 F136 F5              11      PUSH    AF
001EF1 F137 E5              11      PUSH    HL
001EF2 F138 7A               4      LD  A,D
001EF3 F139 CD19F0          17      CALL    ENASLT
001EF6 F13C E1              10      POP HL
001EF7 F13D 73               7      LD  (HL),E
001EF8 F13E F1              10      POP AF
001EF9 F13F E5              11      PUSH    HL
001EFA F140 CD19F0          17      CALL    ENASLT
001EFD F143 E1              10      POP HL
001EFE F144 D1              10      POP DE
001EFF F145 C9              10      RET
                                
       F146                     WRSLT1:
001F00 F146 73               7      LD  (HL),E
001F01 F147 D1              10      POP DE
001F02 F148 C9              10      RET
                                
       F149                     INT38H:
001F03 F149 F3               4      DI
001F04 F14A F5              11      PUSH    AF
001F05 F14B C5              11      PUSH    BC
001F06 F14C E5              11      PUSH    HL
001F07 F14D 210280          10      LD  HL,08002H
001F0A F150 39              11      ADD HL,SP
001F0B F151 380E            12      JR  C,INT38H1
001F0D F153 ED735EF1        20      LD  (INTSP),SP  ;スタックポインタ保存
001F11 F157 315DF5          10      LD  SP,SPBUF
001F14 F15A CD60F0          17      CALL    INT38H_SUB
001F17 F15D 310000          10      LD  SP,0
       F15E                     INTSP   EQU $-2
001F1A F160 AF               4      XOR A
       F161                     INT38H1:
001F1B F161 DC60F0          17      CALL    C,INT38H_SUB
001F1E F164 E1              10      POP HL
001F1F F165 C1              10      POP BC
001F20 F166 F1              10      POP AF
001F21 F167 FB               4      EI
001F22 F168 C9              10      RET
                                ;
                                ;   ページ1のディスクの読み込み補助
                                ;
       F169                     LDIR_PAGE1_RAM:
001F23 F169 CD94F0          17      CALL    ENASLT_40H
001F26 F16C C1              10      POP BC
001F27 F16D D1              10      POP DE
001F28 F16E 215EF5          10      LD  HL,BUF
001F2B F171 EDB0                    LDIR
001F2D F173 3A97F2          13      LD  A,(ROM_SLT)
001F30 F176 CD94F0          17      CALL    ENASLT_40H
001F33 F179 C31146          10      JP  LDIR_PAGE1_ROM
       F17C                     ISC_E:
001F36 5F36                         ORG $$+RUN,$$   ;$DEPHASE
                                
                                #endif
       5F36                     AT_ISCB:
001F36 F280                         ORG ISCB,AT_ISCB-RUN
                                
       F280                     REPLACE_COMMAND:
001F36 F280 FEB7             7      CP  0B7H            ;FILES
001F38 F282 CC7BFE          17      CALL    Z,H_FILE
001F3B F285 FEB5             7      CP  0B5H            ;LOAD
001F3D F287 CA71FE          10      JP  Z,H_BINS
001F40 F28A FE8A             7      CP  08AH            ;RUN
001F42 F28C CA76FE          10      JP  Z,H_BINL
001F45 F28F FED6             7      CP  0D6H            ;COPY
001F47 F291 2813            12      JR  Z,FIX_COPY
001F49 F293 FECF             7      CP  0CFH            ;BLOAD
001F4B F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
001F4C F296 F7              12      RST 30H
       F297                     ROM_SLT:
001F4D F297 00                      DB  0
001F4E F298 E247                    DW  ROM_BLOAD
001F50 F29A F5              11      PUSH    AF
001F51 F29B E5              11      PUSH    HL
001F52 F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
001F55 F29F E1              10      POP HL
001F56 F2A0 F1              10      POP AF
001F57 F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
001F59 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
001F5B F2A5 C9              10      RET
       F2A6                     FIX_COPY:
001F5C F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
001F5D F2A7 00                      DB  0
001F5E F2A8 6749                    DW  ROM_COPY
001F60 F2AA C9              10      RET
       F2AB                     RAMUSE1:
001F61 F2AB 3A42F3          13      LD  A,(RAMAD1)
001F64 F2AE 180E            12      JR  _ENASLT_40H
       F2B0                     CAL_MP:
001F66 F2B0 2640             7      LD  H,040H
001F68 F2B2 3AC1FC          13      LD  A,(EXPTBL)
001F6B F2B5 CD2400          17      CALL    _ENASLT
001F6E F2B8 CD1C00          17      CALL    _CALSLT
       F2BB                     ROMUSE1:
001F71 F2BB 3A97F2          13      LD  A,(ROM_SLT)
       F2BE                     _ENASLT_40H:
001F74 F2BE 2640             7      LD  H,040H
001F76 F2C0 C32400          10      JP  _ENASLT
                                
       F2C3                     _RESULT:
001F79 F2C3 00                      DB  0
       F2C4                     _BANK:
001F7A F2C4 00                      DB  0
       F2C5                     _BANK1:
001F7B F2C5 00                      DB  0
       F2C6                     CLSZ:               ;クラスタサイズ
001F7C F2C6 0004                    DW  1024
       F2C7                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2C8                     SECSZ:              ;セクタサイズ
001F7E F2C8 0002                    DW  512
       F2C9                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2CA                     RR_LOW:
001F80 F2CA 0000                    DW  0
       F2CB                     RR_MID  EQU $-1
       F2CC                     RR_HIGH:
001F82 F2CC 0000                    DW  0
       F2CE                     _CLPS:
001F84 F2CE 0000                    DW  0
       F2D0                     _LEFT:
001F86 F2D0 0000                    DW  0
       F2D2                     _DTPS:
001F88 F2D2 0000                    DW  0
       F2D4                     _DTA:
001F8A F2D4 0000                    DW  0
       F2D6                     FLG_LDIR:
001F8C F2D6 00                      DB  0
       F2D7                     _FCB:
001F8D F2D7 0000                    DW  0
       F2D9                     _BUF:
       F2D9                     _BUF_LO:        ;LOGICAL OPERATION
001F8F F2D9 00                      DB  0
       F2DA                     _BUF_ST:
001F90 F2DA 0000                    DW  0
       F2DC                     _BUF_EN:
001F92 F2DC 0000                    DW  0
       F2DE                     _BUF_EX:
       F2DE                     _BUF_W:
001F94 F2DE 0000                    DW  0
       F2E0                     _BUF_H:
001F96 F2E0 0000                    DW  0
       F2E2                     _BUF_X:
001F98 F2E2 0000                    DW  0
       F2E4                     _BUF_Y:
001F9A F2E4 00                      DB  0
       F2E5                     _BUF_P:
001F9B F2E5 00                      DB  0
       F2E6                     _BUF_O:
001F9C F2E6 00                      DB  0
       F2E7                     DTAX:
001F9D F2E7 0000                    DW  0
       F2E9                     B_DRIVE:
001F9F F2E9 00                      DB  0
       F2EA                     _DVSW:          ;カレントドライブ
001FA0 F2EA 00                      DB  0
       F2EB                     _CD_A:          ;カレントディレクトリ A:
001FA1 F2EB 0000                    DW  0
       F2ED                     _CD_B:          ;カレントディレクトリ B:
001FA3 F2ED 0000                    DW  0
       F2EF                     DIRENT1:
001FA5 F2EF 0000                    DW  0
       F2F1                     _DIR_BANK:
001FA7 F2F1 00                      DB  0
       F2F2                     _LVECTOR:
001FA8 F2F2 01                      DB  1
       F2F3                     LEFTX:
001FA9 F2F3 0000                    DW  0
       F2F5                     PARAM0:
001FAB F2F5 0000                    DW  0
       F2F7                     PARAM1:
001FAD F2F7 0000                    DW  0
       F2F9                     _CDX:
001FAF F2F9 0000                    DW  0
       F2FB                     _CHKSP:
001FB1 F2FB 1F                      DB  01FH
       F2FC                     _HL:
001FB2 F2FC 0000                    DW  0
       F2FE                     _SP:
001FB4 F2FE 0000                    DW  0
       F2FF                     _SP_H   EQU $-1
       F300                     FDRV:
001FB6 F300 00                      DB  0
       F301                     FNAME:
001FB7 F301                         DS  8+3
       F30C                     IS_BIOS:            ;C-BIOSの場合は0
001FC2 F30C FF                      DB  0FFH
                                
       F30D                     ISCB_E:
[EOF:SLOT.ASM:UTF_8]
       1FC3                     LAST    EQU $$
001FC3 F30D                         DS  01FFFH-LAST
001FFF F349 00                      DB  0
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
[EOF:DISKROM64K32.ASM:UTF_8]
