                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
       0001                     _RAM64K     EQU 1   ;メインRAM 64KB使用可能
       0001                     USE_MORMAL32K_OR_ASCII16        EQU 1   ;ノーマル32KB/ASCII-16K ROMを作成する
                                
                                    INCLUDE "DISKROM.ASM"
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00AE                     PLININ  EQU 000AEH
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
       0159                     CALBAS  EQU 00159H
       01F5                     REDCLK  EQU 001F5H  ;SUB
       01F9                     WRTCLK  EQU 001F9H  ;SUB
                                
       269A                     DECADD  EQU 0269AH
       27E6                     DECMUL  EQU 027E6H
       2F8A                     FRCINT  EQU 02F8AH
                                
       303A                     FRCDBL  EQU 0303AH
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
       7D17                     ST_BAS  EQU 07D17H
                                
       F323                     DISKVE  EQU 0F323H
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F398                     JP_IX   EQU 0F398H
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F847                     ARG EQU 0F847H
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
       FAF8                     EXBRSA  EQU 0FAF8H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBB1                     BASROM  EQU 0FBB1H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCC5                     SLTTBL  EQU 0FCC5H
       FCC9                     SLTATR  EQU 0FCC9H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
       FD99                     DEVICE  EQU 0FD99H
                                
       FDDB                     H_PINL  EQU 0FDDBH
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       C000                     FD_BOOT_START   EQU 0C000H
       C01E                     FD_BOOT_EXEC    EQU 0C01EH
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                            ;ASCII-16K
       6000                     ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
       7000                     ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
                                BANK0_SEL EQU   06000H  ;6000-67FF
                                BANK1_SEL EQU   06800H  ;6800-6FFF
                                BANK2_SEL EQU   07000H  ;7000-77FF
                                BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
                                KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
                                KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
                                KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
                                KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
                                KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
                                KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
                                KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
                                
       EF80                     ISC EQU 0EF80H
       F280                     ISCB    EQU 0F280H
                                
       EF80                     NEW_HIMEM   EQU ISC
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F55D                     SPBUF   EQU KBUF+318    ;ページ3にスタックがない場合はKBUFを一時的に使う
                                
       003B                     ENASUB  EQU 0003BH
       F55E                     SYS1B_DPB   EQU BUF
       F571                     SYS1B_FAT   EQU SYS1B_DPB+19
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0042                    DW  INIT_ROM    ; Main program execution address.
000004 4004 7950                    DW  STATEMENT   ; STATEMENT
000006 4006 C051                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C31D53          10      JP  DISKIO
000013 4013 C36A53          10      JP  DSKCHG
000016 4016 C3C053          10      JP  GETDPB
000019 4019 C3B354          10      JP  CHOICE
00001C 401C C3B754          10      JP  DSKFMT
00001F 401F C3B954          10      JP  DSKSTP
000022 4022 C3BA54          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C3B754          10      JP  DSKFMT
000029 4029 C3B954          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C32555          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite"
            204449534B20524F    
            4D204C697465        
000096 4096                         ALIGN   32
0000A0 40A0 76302E372E312E30        DB  "v0.7.1.0"
0000A8 40A8                         ALIGN   32
       40C0                     MSG_ERROR_ROM_MODE:
                                #if exists USE_MORMAL32K_OR_ASCII16
0000C0 40C0 4E6F726D616C2052        DB  "Normal ROM/ASCII-16K only!",13,10
            4F4D2F4153434949    
            2D31364B206F6E6C    
            79210D0A            
                                #else
                                    DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
                                #endif
0001BD 41BD                         ORG 041BDH
0001BD 41BD C9              10      RET
                                
                                    ;MBR_Partition1 (2DDのデータ)
0001BE 41BE 00                      DB  0       ;ブートフラグ
0001BF 41BF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001C2 41C2 01                      DB  1       ;識別子(FAT12)
0001C3 41C3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001C6 41C6 10000000                DW  16,0        ;パーティションの最初のセクタ番号(LBA方式)
0001CA 41CA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                    ;MBR_Partition2 (2DDのデータ)
                                    DB  0       ;ブートフラグ
                                    DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
                                    DB  1       ;識別子(FAT12)
                                    DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
                                    DW  16+1440,0   ;パーティションの最初のセクタ番号(LBA方式)
                                    DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                #endif
                                
0001FE 41FE                         ORG 041FEH
0001FE 41FE 55AA                    DB  055H,0AAH   ;MBR_Sig
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4200                     INIT_ROM:
000200 4200 AF               4      XOR A
000201 4201 2100F3          10      LD  HL,0F300H
000204 4204 0668             7      LD  B,068H
000206 4206 CD324D          17      CALL    FILL_MEMORY
                                
000209 4209 3E01             7      LD  A,1
00020B 420B 3221FB          13      LD  (DRVTBL),A
                                
00020E 420E 2A4AFC          16      LD  HL,(HIMEM)
000211 4211 1180EF          10      LD  DE,NEW_HIMEM
000214 4214 A7               4      AND A
000215 4215 ED52            15      SBC HL,DE
000217 4217 3820            12      JR  C,INIT1
000219 4219 EB               4      EX  DE,HL
00021A 421A 2A74F6          16      LD  HL,(STKTOP)
00021D 421D ED52            15      SBC HL,DE
00021F 421F 2274F6          16      LD  (STKTOP),HL ;起動時の空き容量表示の為
000222 4222 F9               6      LD  SP,HL
000223 4223 2A72F6          16      LD  HL,(MEMSIZ)
000226 4226 ED52            15      SBC HL,DE
000228 4228 2272F6          16      LD  (MEMSIZ),HL
00022B 422B 2A9BF6          16      LD  HL,(FRETOP)
00022E 422E ED52            15      SBC HL,DE
000230 4230 229BF6          16      LD  (FRETOP),HL
000233 4233 2180EF          10      LD  HL,NEW_HIMEM
000236 4236 224AFC          16      LD  (HIMEM),HL
       4239                     INIT1:
000239 4239 AF               4      XOR A
00023A 423A 32EAF2          13      LD  (_DVSW),A
00023D 423D 3D               4      DEC A       ;0FFH
00023E 423E 3299FD          13      LD  (DEVICE),A
                                
                                #if exists _RAM64K
000241 4241 21575B          10      LD  HL,AT_ISC
000244 4244 1180EF          10      LD  DE,ISC
000247 4247 015B01          10      LD  BC,ISC_E-ISC
00024A 424A EDB0                    LDIR
                                #endif
00024C 424C 21B25C          10      LD  HL,AT_ISCB
00024F 424F 1180F2          10      LD  DE,ISCB
000252 4252 018900          10      LD  BC,ISCB_E-ISCB
000255 4255 EDB0                    LDIR
000257 4257 2AB1F6          16      LD  HL,(SAVSTK)
00025A 425A 224BF3          16      LD  (0F34BH),HL
                                
00025D 425D 3EC3             7      LD  A,0C3H      ;JP
00025F 425F 3243FF          13      LD  (H_GONE),A
000262 4262 327DF3          13      LD  (BDOS),A
000265 4265 326BF3          13      LD  (RAMUSE),A
000268 4268 3268F3          13      LD  (ROMUSE),A
00026B 426B 2180F2          10      LD  HL,REPLACE_COMMAND
00026E 426E 2244FF          16      LD  (H_GONE+1),HL
000271 4271 2131F3          10      LD  HL,H_BDOS
000274 4274 227EF3          16      LD  (BDOS+1),HL
000277 4277 21ABF2          10      LD  HL,RAMUSE1
00027A 427A 226CF3          16      LD  (RAMUSE+1),HL
00027D 427D 21BBF2          10      LD  HL,ROMUSE1
000280 4280 2269F3          16      LD  (ROMUSE+1),HL
                                
000283 4283 3E                      DB  03EH
000284 4284 F7              12      RST 30H
000285 4285 3271FE          13      LD  (H_BINS),A
000288 4288 3276FE          13      LD  (H_BINL),A
00028B 428B 327BFE          13      LD  (H_FILE),A
00028E 428E 3231F3          13      LD  (H_BDOS),A
000291 4291 32A7FF          13      LD  (H_PHYD),A
                                
000294 4294 CD0C44          17      CALL    GTSL1_
000297 4297 3297F2          13      LD  (ROM_SLT),A
00029A 429A 32A7F2          13      LD  (ROM_SLT_COPY),A
00029D 429D 3272FE          13      LD  (H_BINS+1),A
0002A0 42A0 3277FE          13      LD  (H_BINL+1),A
0002A3 42A3 327CFE          13      LD  (H_FILE+1),A
0002A6 42A6 3232F3          13      LD  (H_BDOS+1),A
0002A9 42A9 32A8FF          13      LD  (H_PHYD+1),A
0002AC 42AC 3222FB          13      LD  (DRVTBL+1),A
0002AF 42AF 3248F3          13      LD  (MASTERS),A
0002B2 42B2 211B47          10      LD  HL,ROM_LOAD
0002B5 42B5 2273FE          16      LD  (H_BINS+2),HL
0002B8 42B8 21CF48          10      LD  HL,ROM_RUN
0002BB 42BB 2278FE          16      LD  (H_BINL+2),HL
0002BE 42BE 21DD48          10      LD  HL,ROM_FILES
0002C1 42C1 227DFE          16      LD  (H_FILE+2),HL
0002C4 42C4 219655          10      LD  HL,ROM_BDOS
0002C7 42C7 2233F3          16      LD  (H_BDOS+2),HL
0002CA 42CA 211D53          10      LD  HL,DISKIO
0002CD 42CD 22A9FF          16      LD  (H_PHYD+2),HL
                                
0002D0 42D0 3E                      DB  03EH
0002D1 42D1 C9              10      RET
0002D2 42D2 327FFE          13      LD  (H_FILE+4),A
0002D5 42D5 3275FE          13      LD  (H_BINS+4),A
0002D8 42D8 327AFE          13      LD  (H_BINL+4),A
0002DB 42DB 3235F3          13      LD  (H_BDOS+4),A
0002DE 42DE 32DFFD          13      LD  (H_PINL+4),A
0002E1 42E1 32ABFF          13      LD  (H_PHYD+4),A
                                
0002E4 42E4 AF               4      XOR A
                                #if exists USE_MORMAL32K_OR_ASCII16
0002E5 42E5 320060          13      LD  (ASCII16_BANK0_SEL),A       ;似非RAM対策でバンク0を設定
0002E8 42E8 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK0_SEL),A           ;似非RAM対策でバンク0を設定
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0002EB 42EB 3A0060          13      LD  A,(BANK1_ADR)
0002EE 42EE FE41             7      CP  'A'
                                #if exists USE_MORMAL32K_OR_ASCII16
0002F0 42F0 CAFB43          10      JP  Z,NOT_BANK_TYPE
0002F3 42F3 3E01             7      LD  A,DISK_BANK
0002F5 42F5 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    JP  NZ,NOT_BANK_TYPE
                                    LD  A,DISK_BANK
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0002F8 42F8 CD3801          17      CALL    RSLREG      ;read primary slot #
0002FB 42FB 07               4      RLCA
0002FC 42FC 07               4      RLCA
0002FD 42FD F5              11      PUSH    AF
0002FE 42FE 1605             7      LD  D,4+1
000300 4300 CD1344          17      CALL    GTSL2_
000303 4303 3244F3          13      LD  (RAMAD3),A
000306 4306 F1              10      POP AF
000307 4307 07               4      RLCA
000308 4308 07               4      RLCA
000309 4309 1603             7      LD  D,2+1
00030B 430B CD1344          17      CALL    GTSL2_
00030E 430E 2680             7      LD  H,080H
000310 4310 CD3044          17      CALL    CHK_RAM
000313 4313 3243F3          13      LD  (RAMAD2),A
       4316                     RAMCHK2:
000316 4316 3A44F3          13      LD  A,(RAMAD3)
000319 4319 2640             7      LD  H,040H
00031B 431B CD3044          17      CALL    CHK_RAM
00031E 431E 3242F3          13      LD  (RAMAD1),A
       4321                     RAMCHK1:
000321 4321 3A44F3          13      LD  A,(RAMAD3)
000324 4324 2600             7      LD  H,00H
000326 4326 CD3044          17      CALL    CHK_RAM
000329 4329 3241F3          13      LD  (RAMAD0),A
       432C                     RAMCHK0:
00032C 432C 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16
00032F 432F 010F00          10      LD  BC,0000FH       ;切り上げ
000332 4332 09              11      ADD HL,BC
000333 4333 7D               4      LD  A,L
                                
000334 4334 0604             7      LD  B,4
       4336                     B_DRIVE1:
000336 4336 CB3C             8      SRL H
000338 4338 1F               4      RRA
000339 4339 10FB            13      DJNZ    B_DRIVE1
                                
00033B 433B C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
00033D 433D 32E9F2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
                                    ;拡張スロットの選択を設定する
000340 4340 3A97F2          13      LD  A,(ROM_SLT)
000343 4343 57               4      LD  D,A
000344 4344 E60C             7      AND 00CH
000346 4346 5F               4      LD  E,A
000347 4347 7A               4      LD  A,D
000348 4348 E603             7      AND 3
00034A 434A 87               4      ADD A,A
00034B 434B 87               4      ADD A,A
00034C 434C 87               4      ADD A,A
00034D 434D 37               4      SCF
00034E 434E 8F               4      ADC A,A
00034F 434F B3               4      OR  E
000350 4350 5F               4      LD  E,A
000351 4351 1600             7      LD  D,0
000353 4353 21C9FC          10      LD  HL,SLTATR
000356 4356 19              11      ADD HL,DE
000357 4357 3660            10      LD  (HL),060H
                                
000359 4359 3E01             7      LD  A,1
00035B 435B CDA353          17      CALL    IS_BPB
00035E 435E 9F               4      SBC A,A
00035F 435F E602             7      AND 2
000361 4361 EE03             7      XOR 3
000363 4363 32F0F2          13      LD  (_LVECTOR),A
                                    ;CTRL+STOPを抑制する
000366 4366 3E01             7      LD  A,1
000368 4368 32B1FB          13      LD  (BASROM),A
                                
00036B 436B 3ACAFF          13      LD  A,(EXTBIO)
00036E 436E FEF7             7      CP  0F7H        ;RST 30H
000370 4370 280A            12      JR  Z,EXTBIO_OK
000372 4372 3E                      DB  03EH
000373 4373 C9              10      RET
000374 4374 21CAFF          10      LD  HL,EXTBIO
000377 4377 061D             7      LD  B,29
000379 4379 CD324D          17      CALL    FILL_MEMORY
       437C                     EXTBIO_OK:
00037C 437C AF               4      XOR A
00037D 437D 3240F3          13      LD  (REBOOT),A
000380 4380 2A48FC          16      LD  HL,(BOTTOM)
000383 4383 110040          10      LD  DE,16384
000386 4386 19              11      ADD HL,DE
000387 4387 DAF843          10      JP  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
00038A 438A 57               4      LD  D,A
00038B 438B 0601             7      LD  B,1
00038D 438D 2100C0          10      LD  HL,FD_BOOT_START
000390 4390 CD1D53          17      CALL    DISKIO
                                
000393 4393 1168F3          10      LD  DE,ROMUSE
000396 4396 2123F3          10      LD  HL,DISKVE
000399 4399 AF               4      XOR A
00039A 439A CD1EC0          17      CALL    FD_BOOT_EXEC
                                #if exists _RAM64K
                                                ;64K版の場合はページ0をRAMに切り替えRAM側にインタースロットコールを入れる
00039D 439D 3A41F3          13      LD  A,(RAMAD0)  ;ページ0をRAMに切り替える
0003A0 43A0 CD095B          17      CALL    ENASLT_00H
                                
0003A3 43A3 AF               4      XOR A
0003A4 43A4 47               4      LD  B,A
0003A5 43A5 67               4      LD  H,A
0003A6 43A6 6F               4      LD  L,A
0003A7 43A7 CD324D          17      CALL    FILL_MEMORY
                                
0003AA 43AA 3EC3             7      LD  A,0C3H      ;JP
                                                ;インタースロットコール
0003AC 43AC 2192F0          10      LD  HL,RDSLT
0003AF 43AF 320C00          13      LD  (_RDSLT),A
0003B2 43B2 220D00          16      LD  (_RDSLT+1),HL
                                
0003B5 43B5 21A0F0          10      LD  HL,WRSLT
0003B8 43B8 321400          13      LD  (_WRSLT),A
0003BB 43BB 221500          16      LD  (_WRSLT+1),HL
                                
0003BE 43BE 2151F0          10      LD  HL,CALSLT
0003C1 43C1 321C00          13      LD  (_CALSLT),A
0003C4 43C4 221D00          16      LD  (_CALSLT+1),HL
                                
0003C7 43C7 2180EF          10      LD  HL,ENASLT
0003CA 43CA 322400          13      LD  (_ENASLT),A
0003CD 43CD 222500          16      LD  (_ENASLT+1),HL
                                
0003D0 43D0 2141F0          10      LD  HL,CALLF
0003D3 43D3 323000          13      LD  (_CALLF),A
0003D6 43D6 223100          16      LD  (_CALLF+1),HL
                                                ;割り込み
0003D9 43D9 21ACF0          10      LD  HL,INT38H
0003DC 43DC 323800          13      LD  (00038H),A
0003DF 43DF 223900          16      LD  (00038H+1),HL
                                                ;インタースロットコールの補助
0003E2 43E2 21475B          10      LD  HL,AT_3B
0003E5 43E5 113B00          10      LD  DE,ENASUB
0003E8 43E8 011000          10      LD  BC,AT_3B_E-AT_3B
0003EB 43EB EDB0                    LDIR
                                
0003ED 43ED 1168F3          10      LD  DE,ROMUSE
0003F0 43F0 2123F3          10      LD  HL,DISKVE
0003F3 43F3 AF               4      XOR A
0003F4 43F4 37               4      SCF
0003F5 43F5 CD1EC0          17      CALL    FD_BOOT_EXEC
                                #endif
       43F8                     BOOT1:
0003F8 43F8 C3BA54          10      JP  BASENT
                                
       43FB                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
0003FB 43FB 21C040          10      LD  HL,MSG_ERROR_ROM_MODE
0003FE 43FE CDD344          17      CALL    MSX
000401 4401 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000405 4405 DD219F00        14      LD  IX,CHGET
000409 4409 C31C00          10      JP  _CALSLT
                                
       440C                     GTSL1_:             ;自分のいるスロットを知る
00040C 440C CD3801          17      CALL    RSLREG      ;read primary slot #
00040F 440F 0F               4      RRCA
000410 4410 0F               4      RRCA
000411 4411 1601             7      LD  D,1
       4413                     GTSL2_:
000413 4413 E603             7      AND 3       ;[A]=000000PP
000415 4415 5F               4      LD  E,A     ;[E]=000000PP
000416 4416 21C1FC          10      LD  HL,EXPTBL
000419 4419 85               4      ADD A,L     ;桁上りは無い
00041A 441A 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
00041B 441B 7B               4      LD  A,E     ;[A]=000000PP
00041C 441C CB7E            13      BIT 7,(HL)
00041E 441E C8              11      RET Z
00041F 441F 7D               4      LD  A,L     ;point to SLTTBL entry
000420 4420 C604             7      ADD A,4     ;桁上りは無い
000422 4422 6F               4      LD  L,A
000423 4423 7E               7      LD  A,(HL)      ;get currently expansion slot register
       4424                     GTSL3_:
000424 4424 15               4      DEC D
000425 4425 2803            12      JR  Z,GTSL4_:
000427 4427 0F               4      RRCA
000428 4428 18FA            12      JR  GTSL3_:
       442A                     GTSL4_:
00042A 442A E60C             7      AND 00CH        ;[A] = 0000SS00
00042C 442C B3               4      OR  E       ;[A] = 0000SSPP
00042D 442D F680             7      OR  080H        ;[A] = 1000SSPP
00042F 442F C9              10      RET
                                
       4430                     CHK_RAM:
000430 4430 E5              11      PUSH    HL
000431 4431 CD8544          17      CALL    CHK_RAM0
000434 4434 E1              10      POP HL
000435 4435 C8              11      RET Z
000436 4436 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000439 4439 E680             7      AND 080H
00043B 443B CD5C44          17      CALL    CHK_RAM_SLT
00043E 443E C8              11      RET Z
00043F 443F 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000442 4442 E680             7      AND 080H
000444 4444 C601             7      ADD A,1
000446 4446 CD5C44          17      CALL    CHK_RAM_SLT
000449 4449 C8              11      RET Z
00044A 444A 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00044D 444D E680             7      AND 080H
00044F 444F C602             7      ADD A,2
000451 4451 CD5C44          17      CALL    CHK_RAM_SLT
000454 4454 C8              11      RET Z
000455 4455 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000458 4458 E680             7      AND 080H
00045A 445A C603             7      ADD A,3
       445C                     CHK_RAM_SLT:
00045C 445C E5              11      PUSH    HL
00045D 445D CD8544          17      CALL    CHK_RAM0        ;スロット#X or X-0
000460 4460 E1              10      POP HL
000461 4461 C8              11      RET Z
000462 4462 CB79             8      BIT 7,C
000464 4464 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000466 4466 79               4      LD  A,C
000467 4467 C604             7      ADD A,4*1           ;スロット#X-1
000469 4469 E5              11      PUSH    HL
00046A 446A CD8544          17      CALL    CHK_RAM0
00046D 446D E1              10      POP HL
00046E 446E C8              11      RET Z
00046F 446F 79               4      LD  A,C
000470 4470 C608             7      ADD A,4*2           ;スロット#X-2
000472 4472 E5              11      PUSH    HL
000473 4473 CD8544          17      CALL    CHK_RAM0
000476 4476 E1              10      POP HL
000477 4477 C8              11      RET Z
000478 4478 79               4      LD  A,C
000479 4479 C60C             7      ADD A,4*3           ;スロット#X-3
00047B 447B E5              11      PUSH    HL
00047C 447C CD8544          17      CALL    CHK_RAM0
00047F 447F E1              10      POP HL
       4480                     CHK_RAM_E:
000480 4480 AF               4      XOR A
000481 4481 3C               4      INC A           ;ZF=0にする
000482 4482 3E00             7      LD  A,0
000484 4484 C9              10      RET
                                
       4485                     CHK_RAM0:
000485 4485 4F               4      LD  C,A
000486 4486 3A97F2          13      LD  A,(ROM_SLT)
000489 4489 B9               4      CP  C
00048A 448A 28F4            12      JR  Z,CHK_RAM_E
00048C 448C 2E00             7      LD  L,0
       448E                     CHK_RAM1:
00048E 448E 79               4      LD  A,C
00048F 448F CD0545          17      CALL    RDSLTX
000492 4492 C6E5             7      ADD A,0E5H
000494 4494 47               4      LD  B,A
000495 4495 5F               4      LD  E,A
000496 4496 79               4      LD  A,C
000497 4497 C5              11      PUSH    BC
000498 4498 CD1400          17      CALL    _WRSLT
00049B 449B C1              10      POP BC
00049C 449C 79               4      LD  A,C
00049D 449D CD0545          17      CALL    RDSLTX
0004A0 44A0 B8               4      CP  B
0004A1 44A1 C0              11      RET NZ
0004A2 44A2 D6E5             7      SUB 0E5H
0004A4 44A4 79               4      LD  A,C
0004A5 44A5 5F               4      LD  E,A
0004A6 44A6 C5              11      PUSH    BC
0004A7 44A7 CD1400          17      CALL    _WRSLT
0004AA 44AA C1              10      POP BC
0004AB 44AB 24               4      INC H
0004AC 44AC 7D               4      LD  A,L
0004AD 44AD C604             7      ADD A,4
0004AF 44AF 6F               4      LD  L,A
0004B0 44B0 20DC            12      JR  NZ,CHK_RAM1
0004B2 44B2 79               4      LD  A,C     ;ZF=1のハズ
0004B3 44B3 C9              10      RET
                                
       44B4                     CALSLT_R:
0004B4 44B4 C5              11      PUSH    BC
0004B5 44B5 E5              11      PUSH    HL
0004B6 44B6 F5              11      PUSH    AF
0004B7 44B7 3A0000          13      LD  A,(0000H)
0004BA 44BA FEF3             7      CP  0F3H        ;0000H が DI の場合はページ0を BIOS ROM とみなす
0004BC 44BC 280B            12      JR  Z,CALSLT_R2
0004BE 44BE F1              10      POP AF
0004BF 44BF FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0004C3 44C3 CD1C00          17      CALL    _CALSLT
0004C6 44C6 E1              10      POP HL
0004C7 44C7 C1              10      POP BC
0004C8 44C8 C9              10      RET
       44C9                     CALSLT_R2:
0004C9 44C9 F1              10      POP AF
0004CA 44CA CD98F3          17      CALL    JP_IX
0004CD 44CD E1              10      POP HL
0004CE 44CE C1              10      POP BC
0004CF 44CF C9              10      RET
                                
       44D0                     MSX1:
0004D0 44D0 CDAF55          17      CALL    MSGA1
       44D3                     MSX:
0004D3 44D3 7E               7      LD  A,(HL)
0004D4 44D4 23               6      INC HL
0004D5 44D5 B7               4      OR  A
0004D6 44D6 20F8            12      JR  NZ,MSX1
0004D8 44D8 C9              10      RET
                                
       44D9                     PRTHX:
0004D9 44D9 F5              11      PUSH    AF
0004DA 44DA 07               4      RLCA
0004DB 44DB 07               4      RLCA
0004DC 44DC 07               4      RLCA
0004DD 44DD 07               4      RLCA
0004DE 44DE CDE244          17      CALL    PRTA2
0004E1 44E1 F1              10      POP AF
       44E2                     PRTA2:
0004E2 44E2 CDE844          17      CALL    ASC
0004E5 44E5 C3AB55          10      JP  MSG_A
                                
       44E8                     ASC:
0004E8 44E8 E60F             7      AND $0F
0004EA 44EA F630             7      OR  $30
0004EC 44EC FE3A             7      CP  $3A
0004EE 44EE D8              11      RET C
0004EF 44EF C607             7      ADD A,7
0004F1 44F1 C9              10      RET
                                
       44F2                     MSN:
                                #if exists USE_MORMAL32K_OR_ASCII16
0004F2 44F2 CDFE44          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
0004F5 44F5 23               6      INC HL
0004F6 44F6 CDAB55          17      CALL    MSG_A
0004F9 44F9 10F7            13      DJNZ    MSN
0004FB 44FB C9              10      RET
                                
       44FC                     RDSLT_ROM3:
0004FC 44FC 7E               7      LD  A,(HL)
0004FD 44FD C9              10      RET
       44FE                     RDSLT_ROM:
0004FE 44FE CB7C             8      BIT 7,H
000500 4500 28FA            12      JR  Z,RDSLT_ROM3
       4502                     RDSLT_ROM2:
000502 4502 3A97F2          13      LD  A,(ROM_SLT)
       4505                     RDSLTX:
000505 4505 C5              11      PUSH    BC
000506 4506 D5              11      PUSH    DE
000507 4507 CD0C00          17      CALL    _RDSLT
00050A 450A D1              10      POP DE
00050B 450B C1              10      POP BC
00050C 450C C9              10      RET
                                
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
                                ;
                                ;   ディスクからメモリへの転送
                                ;
       450D                     ROM_LDIR:
00050D 450D 3AD6F2          13      LD  A,(FLG_LDIR)
000510 4510 B7               4      OR  A
000511 4511 2069            12      JR  NZ,ROM_LDIRVM
000513 4513 CB7A             8      BIT 7,D
000515 4515 CAAC45          10      JP  Z,ROM_LDIRSLT
                                ;
                                ;   ページ2/ページ3
                                ;
                                #if exists USE_MORMAL32K_OR_ASCII16
000518 4518 F3               4      DI
000519 4519 ED7307F3        20      LD  (_SP),SP
00051D 451D 3A08F3          13      LD  A,(_SP_H)
000520 4520 FEC0             7      CP  0C0H
000522 4522 3003            12      JR  NC,SPJ1
000524 4524 315DF5          10      LD  SP,SPBUF
       4527                     SPJ1:
       4527                     LDIR_PAGE2_1:
000527 4527 78               4      LD  A,B
000528 4528 B1               4      OR  C
000529 4529 284C            12      JR  Z,LDIRE
                                
00052B 452B C5              11      PUSH    BC
00052C 452C D5              11      PUSH    DE
00052D 452D E5              11      PUSH    HL
00052E 452E 3A97F2          13      LD  A,(ROM_SLT)
000531 4531 2680             7      LD  H,080H
000533 4533 CD2400          17      CALL    _ENASLT
000536 4536 E1              10      POP HL
000537 4537 D1              10      POP DE
000538 4538 C1              10      POP BC
       4539                     LDIR_PAGE2_2:
000539 4539 CB72             8      BIT 6,D
00053B 453B 202C            12      JR  NZ,LDIR_PAGE2_4
                                
00053D 453D C5              11      PUSH    BC
00053E 453E D5              11      PUSH    DE
00053F 453F 115EF5          10      LD  DE,BUF
                                
000542 4542 78               4      LD  A,B
000543 4543 B7               4      OR  A
000544 4544 2803            12      JR  Z,LDIR_PAGE2_3
000546 4546 010001          10      LD  BC,00100H       ;B != 0 の場合は256バイトずつ転送
       4549                     LDIR_PAGE2_3:
000549 4549 C5              11      PUSH    BC
00054A 454A EDB0                    LDIR
00054C 454C 2205F3          16      LD  (_HL),HL
                                
00054F 454F 3A43F3          13      LD  A,(RAMAD2)
000552 4552 2680             7      LD  H,080H
000554 4554 CD2400          17      CALL    _ENASLT
                                
000557 4557 C1              10      POP BC
000558 4558 D1              10      POP DE
000559 4559 215EF5          10      LD  HL,BUF
00055C 455C EDB0                    LDIR
                                
00055E 455E 2A05F3          16      LD  HL,(_HL)
000561 4561 C1              10      POP BC
000562 4562 78               4      LD  A,B
000563 4563 B7               4      OR  A
000564 4564 2811            12      JR  Z,LDIRE
000566 4566 05               4      DEC B
000567 4567 18BE            12      JR  LDIR_PAGE2_1
       4569                     LDIR_PAGE2_4:               ;ページ3
                                #endif
000569 4569 EDB0                    LDIR
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
       456B                     LDIRE2:
00056B 456B D5              11      PUSH    DE
00056C 456C E5              11      PUSH    HL
00056D 456D 3A43F3          13      LD  A,(RAMAD2)
000570 4570 2680             7      LD  H,080H
000572 4572 CD2400          17      CALL    _ENASLT
000575 4575 E1              10      POP HL
000576 4576 D1              10      POP DE
       4577                     LDIRE:
000577 4577 ED7B07F3        20      LD  SP,(_SP)
                                #else
                                LDIRE2:
                                #endif
00057B 457B C9              10      RET
                                ;
                                ;   ディスクからV-RAMへの転送
                                ;
       457C                     ROM_LDIRVM:
                                #if exists USE_MORMAL32K_OR_ASCII16
00057C 457C F3               4      DI
00057D 457D ED7307F3        20      LD  (_SP),SP
000581 4581 3A08F3          13      LD  A,(_SP_H)
000584 4584 FEC0             7      CP  0C0H
000586 4586 3003            12      JR  NC,SPJ2
000588 4588 315DF5          10      LD  SP,SPBUF
       458B                     SPJ2:
00058B 458B C5              11      PUSH    BC
00058C 458C D5              11      PUSH    DE
00058D 458D E5              11      PUSH    HL
00058E 458E 3A97F2          13      LD  A,(ROM_SLT)
000591 4591 2680             7      LD  H,080H
000593 4593 CD2400          17      CALL    _ENASLT
000596 4596 E1              10      POP HL
000597 4597 D1              10      POP DE
000598 4598 C1              10      POP BC
                                #endif
000599 4599 C5              11      PUSH    BC
00059A 459A D5              11      PUSH    DE
00059B 459B FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00059F 459F DD215C00        14      LD  IX,LDIRVM
0005A3 45A3 CD1C00          17      CALL    _CALSLT
0005A6 45A6 E1              10      POP HL
0005A7 45A7 C1              10      POP BC
0005A8 45A8 09              11      ADD HL,BC
0005A9 45A9 EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
0005AA 45AA 18BF            12      JR  LDIRE2
                                #else
                                    RET
                                #endif
                                ;
                                ;   ページ0/ページ1
                                ;
       45AC                     ROM_LDIRSLT:
                                #if exists USE_MORMAL32K_OR_ASCII16
0005AC 45AC F3               4      DI
0005AD 45AD ED7307F3        20      LD  (_SP),SP
0005B1 45B1 3A08F3          13      LD  A,(_SP_H)
0005B4 45B4 FEC0             7      CP  0C0H
0005B6 45B6 3003            12      JR  NC,SPJ3
0005B8 45B8 315DF5          10      LD  SP,SPBUF
       45BB                     SPJ3:
0005BB 45BB C5              11      PUSH    BC
0005BC 45BC D5              11      PUSH    DE
0005BD 45BD E5              11      PUSH    HL
0005BE 45BE 3A97F2          13      LD  A,(ROM_SLT)
0005C1 45C1 2680             7      LD  H,080H
0005C3 45C3 CD2400          17      CALL    _ENASLT
0005C6 45C6 E1              10      POP HL
0005C7 45C7 D1              10      POP DE
0005C8 45C8 C1              10      POP BC
                                #endif
                                                ;ページ0
0005C9 45C9 3A0000          13      LD  A,(0000H)
0005CC 45CC FEF3             7      CP  0F3H        ;0000H が DI じゃない場合はページ0は RAM とみなす
0005CE 45CE 280C            12      JR  Z,LDIR_PAGE0_SLT
       45D0                     LDIR_PAGE0_1:
0005D0 45D0 CB72             8      BIT 6,D
0005D2 45D2 2026            12      JR  NZ,LDIR_PAGE1
0005D4 45D4 EDA0            16      LDI         ;ページ0 直接転送
0005D6 45D6 EAD045          10      JP  PE,LDIR_PAGE0_1
                                #if exists USE_MORMAL32K_OR_ASCII16
0005D9 45D9 C36B45          10      JP  LDIRE2
                                #else
                                    RET
                                #endif
                                
       45DC                     LDIR_PAGE0_SLT:     ;ページ0 WRSLTを使用
0005DC 45DC EB               4      EX  DE,HL       ;転送方向(DE)→(HL)
       45DD                     LDIR_PAGE0_SLT1:
0005DD 45DD CB74             8      BIT 6,H
0005DF 45DF 2018            12      JR  NZ,LDIR_PAGE1_DEHL
0005E1 45E1 1A               7      LD  A,(DE)
0005E2 45E2 13               6      INC DE
0005E3 45E3 D5              11      PUSH    DE
0005E4 45E4 5F               4      LD  E,A
0005E5 45E5 E5              11      PUSH    HL
0005E6 45E6 C5              11      PUSH    BC
0005E7 45E7 3A41F3          13      LD  A,(RAMAD0)
0005EA 45EA CD1400          17      CALL    _WRSLT
0005ED 45ED C1              10      POP BC
0005EE 45EE E1              10      POP HL
0005EF 45EF D1              10      POP DE
0005F0 45F0 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0005F2 45F2 EADD45          10      JP  PE,LDIR_PAGE0_SLT1
0005F5 45F5 EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
                                #if exists USE_MORMAL32K_OR_ASCII16
0005F6 45F6 C36B45          10      JP  LDIRE2
                                #else
                                    RET
                                #endif
                                
                                #if exists _RAM64K
       45F9                     LDIR_PAGE1_DEHL:
0005F9 45F9 EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
       45FA                     LDIR_PAGE1:         ;ページ1
0005FA 45FA 78               4      LD  A,B
0005FB 45FB B1               4      OR  C
0005FC 45FC CA6B45          10      JP  Z,LDIRE2
                                
0005FF 45FF 7A               4      LD  A,D
000600 4600 FE7F             7      CP  07FH        ;ページ2と被る可能性？($7FXX)
000602 4602 3810            12      JR  C,LDIR_PAGE1_2
000604 4604 87               4      ADD A,A
000605 4605 DA2745          10      JP  C,LDIR_PAGE2_1  ;ページ2へ
000608 4608 78               4      LD  A,B
000609 4609 B7               4      OR  A
00060A 460A 2804            12      JR  Z,LDIR_PAGE1_1
00060C 460C 7B               4      LD  A,E     ;B != 0 の場合は256バイト転送
00060D 460D B7               4      OR  A
00060E 460E 2028            12      JR  NZ,LDIR_PAGE1_SLT_HLDE  ;被る
       4610                     LDIR_PAGE1_1:
000610 4610 7B               4      LD  A,E     ;B == 0 の場合はCバイト転送
000611 4611 81               4      ADD A,C
000612 4612 3824            12      JR  C,LDIR_PAGE1_SLT_HLDE   ;被る
       4614                     LDIR_PAGE1_2:
000614 4614 C5              11      PUSH    BC
000615 4615 D5              11      PUSH    DE
000616 4616 115EF5          10      LD  DE,BUF
                                
000619 4619 78               4      LD  A,B
00061A 461A B7               4      OR  A
00061B 461B 2803            12      JR  Z,LDIR_PAGE1_3
00061D 461D 010001          10      LD  BC,00100H       ;B != 0 の場合は256バイトずつ転送
       4620                     LDIR_PAGE1_3:
000620 4620 C5              11      PUSH    BC
000621 4621 EDB0                    LDIR
000623 4623 2205F3          16      LD  (_HL),HL
                                
000626 4626 3A42F3          13      LD  A,(RAMAD1)
000629 4629 C3CBF0          10      JP  LDIR_PAGE1_RAM      ;ページ1をRAMにする処理はページ3にある
       462C                     LDIR_PAGE1_ROM:
00062C 462C 2A05F3          16      LD  HL,(_HL)
00062F 462F C1              10      POP BC
000630 4630 78               4      LD  A,B
000631 4631 B7               4      OR  A
000632 4632 CA6B45          10      JP  Z,LDIRE2
000635 4635 05               4      DEC B
000636 4636 18C2            12      JR  LDIR_PAGE1
                                
       4638                     LDIR_PAGE1_SLT_HLDE:
000638 4638 EB               4      EX  DE,HL       ;転送方向(DE)→(HL)
                                #else
                                LDIR_PAGE1:         ;ページ1 WRSLTを使用
                                LDIR_PAGE1_HLDE:
                                    EX  DE,HL       ;転送方向(DE)→(HL)
                                LDIR_PAGE1_DEHL:
                                #endif
       4639                     LDIR_PAGE1_SLT1:
000639 4639 CB7C             8      BIT 7,H
00063B 463B 2018            12      JR  NZ,LDIR_PAGE2_HLDE
00063D 463D 1A               7      LD  A,(DE)
00063E 463E 13               6      INC DE
00063F 463F D5              11      PUSH    DE
000640 4640 5F               4      LD  E,A
000641 4641 E5              11      PUSH    HL
000642 4642 C5              11      PUSH    BC
000643 4643 3A42F3          13      LD  A,(RAMAD1)
000646 4646 CD1400          17      CALL    _WRSLT
000649 4649 C1              10      POP BC
00064A 464A E1              10      POP HL
00064B 464B D1              10      POP DE
00064C 464C EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00064E 464E EA3946          10      JP  PE,LDIR_PAGE1_SLT1
000651 4651 EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
                                #if exists USE_MORMAL32K_OR_ASCII16
000652 4652 C36B45          10      JP  LDIRE2
       4655                     LDIR_PAGE2_HLDE:            ;ページ2
000655 4655 EB               4      EX  DE,HL       ;転送方向(HL)→(DE)
000656 4656 C32745          10      JP  LDIR_PAGE2_1
                                #else
                                    RET
                                LDIR_PAGE2_HLDE:            ;ページ2
                                    EX  DE,HL       ;転送方向(HL)→(DE)
                                LDIR_PAGE2_1:
                                    LDIR
                                    RET
                                #endif
                                ;
                                ;   BASIC関連
                                ;
       4659                     END_OF_LINE:
000659 4659 215EF5          10      LD  HL,BUF
       465C                     EOL1:
00065C 465C 7E               7      LD  A,(HL)
00065D 465D C8              11      RET Z
00065E 465E FE0D             7      CP  00DH
000660 4660 2807            12      JR  Z,EOLE
000662 4662 FE0A             7      CP  00AH
000664 4664 2803            12      JR  Z,EOLE
000666 4666 23               6      INC HL
000667 4667 18F3            12      JR  EOL1
       4669                     EOLE:
000669 4669 3600            10      LD  (HL),0
00066B 466B 23               6      INC HL
00066C 466C 7E               7      LD  A,(HL)
00066D 466D FE0A             7      CP  00AH
00066F 466F C0              11      RET NZ
000670 4670 23               6      INC HL
000671 4671 C9              10      RET
                                ;
                                ;   アスキー形式のファイルを読み込む
                                ;
       4672                     ROM_LOAD_ASCII:
000672 4672 210000          10      LD  HL,0
000675 4675 22DAF2          16      LD  (_BUF_ST),HL    ;読み出し位置
000678 4678 2A76F6          16      LD  HL,(TXTTAB)
00067B 467B 22DCF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
00067E 467E 215EF5          10      LD  HL,BUF
000681 4681 22D4F2          16      LD  (_DTA),HL
       4684                     RLOAD_A1:
000684 4684 2ADAF2          16      LD  HL,(_BUF_ST)
000687 4687 22CAF2          16      LD  (RR_LOW),HL
00068A 468A 210201          10      LD  HL,258
00068D 468D CD9F4B          17      CALL    ROM_READ
000690 4690 7C               4      LD  A,H
000691 4691 B5               4      OR  L
000692 4692 2879            12      JR  Z,RLOAD_AEND
000694 4694 015EF5          10      LD  BC,BUF
000697 4697 09              11      ADD HL,BC
000698 4698 3600            10      LD  (HL),0
00069A 469A CD5946          17      CALL    END_OF_LINE
00069D 469D 015EF5          10      LD  BC,BUF
0006A0 46A0 A7               4      AND A
0006A1 46A1 ED42            15      SBC HL,BC
0006A3 46A3 2810            12      JR  Z,RLOAD_A2
0006A5 46A5 4D               4      LD  C,L
0006A6 46A6 44               4      LD  B,H
0006A7 46A7 ED5BDAF2        20      LD  DE,(_BUF_ST)
0006AB 46AB 19              11      ADD HL,DE
0006AC 46AC 22DAF2          16      LD  (_BUF_ST),HL
0006AF 46AF 3A5EF5          13      LD  A,(BUF)
0006B2 46B2 B7               4      OR  A
0006B3 46B3 28CF            12      JR  Z,RLOAD_A1
       46B5                     RLOAD_A2:
0006B5 46B5 115EF5          10      LD  DE,BUF
0006B8 46B8 CD694D          17      CALL    SPCUTEX
0006BB 46BB 1A               7      LD  A,(DE)
0006BC 46BC B7               4      OR  A
0006BD 46BD 284E            12      JR  Z,RLOAD_AEND
0006BF 46BF CD7B4D          17      CALL    GETNUM
0006C2 46C2 7C               4      LD  A,H
0006C3 46C3 B5               4      OR  L
0006C4 46C4 CAE447          10      JP  Z,ERROR_DIRECT_IN_FILE
0006C7 46C7 DD2ADCF2        20      LD  IX,(_BUF_EN)
0006CB 46CB DD7502          19      LD  (IX+2),L
0006CE 46CE DD7403          19      LD  (IX+3),H
                                
0006D1 46D1 CD624D          17      CALL    SPCUT
0006D4 46D4 EB               4      EX  DE,HL
0006D5 46D5 DDE5            15      PUSH    IX
0006D7 46D7 DD21B242        14      LD  IX,CRUNCH
0006DB 46DB FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0006DF 46DF CD1C00          17      CALL    _CALSLT
0006E2 46E2 DDE1            14      POP IX
0006E4 46E4 EB               4      EX  DE,HL
0006E5 46E5 111FF4          10      LD  DE,KBUF
0006E8 46E8 37               4      SCF
0006E9 46E9 ED52            15      SBC HL,DE
0006EB 46EB CAE447          10      JP  Z,ERROR_DIRECT_IN_FILE
0006EE 46EE DAE447          10      JP  C,ERROR_DIRECT_IN_FILE
0006F1 46F1 4D               4      LD  C,L
0006F2 46F2 44               4      LD  B,H
0006F3 46F3 2ADCF2          16      LD  HL,(_BUF_EN)
0006F6 46F6 110400          10      LD  DE,4
0006F9 46F9 19              11      ADD HL,DE
0006FA 46FA 111FF4          10      LD  DE,KBUF
                                
0006FD 46FD EB               4      EX  DE,HL
0006FE 46FE EDB0                    LDIR
000700 4700 EB               4      EX  DE,HL
                                
000701 4701 DD7500          19      LD  (IX+0),L
000704 4704 DD7401          19      LD  (IX+1),H
000707 4707 22DCF2          16      LD  (_BUF_EN),HL
00070A 470A C38446          10      JP  RLOAD_A1
                                
       470D                     RLOAD_AEND:
00070D 470D 2ADCF2          16      LD  HL,(_BUF_EN)
000710 4710 AF               4      XOR A
000711 4711 77               7      LD  (HL),A
000712 4712 23               6      INC HL
000713 4713 77               7      LD  (HL),A
000714 4714 23               6      INC HL
000715 4715 22DCF2          16      LD  (_BUF_EN),HL
000718 4718 C3A747          10      JP  RLOAD_END1
                                
       471B                     ROM_LOAD:
00071B 471B CD4D49          17      CALL    INIT_PARAM
00071E 471E 7E               7      LD  A,(HL)
00071F 471F FE2C             7      CP  ','
000721 4721 2003            12      JR  NZ,ROM_LOAD0
000723 4723 23               6      INC HL
000724 4724 7E               7      LD  A,(HL)
000725 4725 2B               6      DEC HL
       4726                     ROM_LOAD0:
000726 4726 32BEFC          13      LD  (RUNBNF),A
000729 4729 CD404C          17      CALL    FILE_B
00072C 472C 3AFAF2          13      LD  A,(FNAME)
00072F 472F FE20             7      CP  020H
000731 4731 CA3B4C          10      JP  Z,ROM_ORG
                                
000734 4734 CDD24D          17      CALL    ROM_OPEN
000737 4737 DAF047          10      JP  C,ERROR_FILE_NOT_FOUND
       473A                     ROM_LOAD1:
00073A 473A 21D9F2          10      LD  HL,_BUF
00073D 473D 22D4F2          16      LD  (_DTA),HL
000740 4740 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
000743 4743 CD9F4B          17      CALL    ROM_READ
000746 4746 3AD9F2          13      LD  A,(_BUF)
000749 4749 3C               4      INC A
00074A 474A C27246          10      JP  NZ,ROM_LOAD_ASCII
00074D 474D 2A76F6          16      LD  HL,(TXTTAB)
000750 4750 22D4F2          16      LD  (_DTA),HL
000753 4753 EB               4      EX  DE,HL
000754 4754 2100FF          10      LD  HL,-256
000757 4757 39              11      ADD HL,SP
000758 4758 ED52            15      SBC HL,DE
00075A 475A CD9F4B          17      CALL    ROM_READ
00075D 475D ED5BD4F2        20      LD  DE,(_DTA)
000761 4761 19              11      ADD HL,DE
000762 4762 E5              11      PUSH    HL
000763 4763 2A76F6          16      LD  HL,(TXTTAB)
       4766                     ROM_LOAD2:          ;リンクポインタをFIX
000766 4766 E5              11      PUSH    HL
000767 4767 DDE1            14      POP IX
000769 4769 7E               7      LD  A,(HL)      ;リンクポインタL
00076A 476A 23               6      INC HL
00076B 476B B6               7      OR  (HL)        ;リンクポインタH
00076C 476C 23               6      INC HL
00076D 476D 2837            12      JR  Z,RLOAD_END0
00076F 476F 23               6      INC HL      ;行番号
000770 4770 23               6      INC HL      ;行番号
       4771                     ROM_LOAD3:
000771 4771 7E               7      LD  A,(HL)
000772 4772 23               6      INC HL
000773 4773 FE0B             7      CP  00BH        ;8進数(&O)
000775 4775 2822            12      JR  Z,INC_HL2
000777 4777 FE0C             7      CP  00CH        ;16進数(&H)
000779 4779 281E            12      JR  Z,INC_HL2
00077B 477B FE0D             7      CP  00DH        ;行番号(RUN後)
00077D 477D 281A            12      JR  Z,INC_HL2
00077F 477F FE0E             7      CP  00EH        ;行番号(RUN前)
000781 4781 2816            12      JR  Z,INC_HL2
000783 4783 FE0F             7      CP  00FH        ;10～255の整数(%)
000785 4785 2813            12      JR  Z,INC_HL1
000787 4787 FE1C             7      CP  01CH        ;256～65535の整数(%)
000789 4789 280E            12      JR  Z,INC_HL2
00078B 478B FE1D             7      CP  01DH        ;単精度実数(!)
00078D 478D 2808            12      JR  Z,INC_HL4
00078F 478F FE1F             7      CP  01FH        ;倍制度実数(#)
000791 4791 2008            12      JR  NZ,INC_HL0
000793 4793 23               6      INC HL
000794 4794 23               6      INC HL
000795 4795 23               6      INC HL
000796 4796 23               6      INC HL
       4797                     INC_HL4:
000797 4797 23               6      INC HL
000798 4798 23               6      INC HL
       4799                     INC_HL2:
000799 4799 23               6      INC HL
       479A                     INC_HL1:
00079A 479A 23               6      INC HL
       479B                     INC_HL0:
00079B 479B B7               4      OR  A
00079C 479C 20D3            12      JR  NZ,ROM_LOAD3
00079E 479E DD7500          19      LD  (IX+0),L
0007A1 47A1 DD7401          19      LD  (IX+1),H
0007A4 47A4 18C0            12      JR  ROM_LOAD2
       47A6                     RLOAD_END0:
0007A6 47A6 E1              10      POP HL
       47A7                     RLOAD_END1:
0007A7 47A7 22C2F6          16      LD  (VARTAB),HL
0007AA 47AA 22C4F6          16      LD  (ARYTAB),HL
0007AD 47AD 22C6F6          16      LD  (STREND),HL
                                
0007B0 47B0 3ABEFC          13      LD  A,(RUNBNF)
0007B3 47B3 CDBC4D          17      CALL    CAP
0007B6 47B6 FE52             7      CP  'R'
0007B8 47B8 280E            12      JR  Z,RLOAD_END2
0007BA 47BA AF               4      XOR A
0007BB 47BB 21DCF2          10      LD  HL,_BUF+3
0007BE 47BE 77               7      LD  (HL),A      ;3
0007BF 47BF 2B               6      DEC HL
0007C0 47C0 77               7      LD  (HL),A      ;2
0007C1 47C1 2B               6      DEC HL
0007C2 47C2 77               7      LD  (HL),A      ;1
0007C3 47C3 2B               6      DEC HL
0007C4 47C4 3E8F             7      LD  A,08FH      ;REM
0007C6 47C6 77               7      LD  (HL),A      ;0
0007C7 47C7 C9              10      RET
       47C8                     RLOAD_END2:
0007C8 47C8 D5              11      PUSH    DE
0007C9 47C9 ED5B76F6        20      LD  DE,(TXTTAB)
0007CD 47CD 1B               6      DEC DE
0007CE 47CE AF               4      XOR A
0007CF 47CF 21DFF2          10      LD  HL,_BUF+6
0007D2 47D2 77               7      LD  (HL),A      ;6
0007D3 47D3 2B               6      DEC HL
0007D4 47D4 77               7      LD  (HL),A      ;5
0007D5 47D5 2B               6      DEC HL
0007D6 47D6 77               7      LD  (HL),A      ;4
0007D7 47D7 2B               6      DEC HL
0007D8 47D8 72               7      LD  (HL),D      ;3 行番号H
0007D9 47D9 2B               6      DEC HL
0007DA 47DA 73               7      LD  (HL),E      ;2 行番号L
0007DB 47DB 2B               6      DEC HL
0007DC 47DC 360D            10      LD  (HL),00DH   ;1 行番号(RUN後)
0007DE 47DE 2B               6      DEC HL
0007DF 47DF 3E89             7      LD  A,089H      ;GOTO
0007E1 47E1 77               7      LD  (HL),A      ;0
0007E2 47E2 D1              10      POP DE
0007E3 47E3 C9              10      RET
                                
       47E4                     ERROR_DIRECT_IN_FILE:
0007E4 47E4 1E39             7      LD  E,57            ;Direct statement in file
0007E6 47E6 01                      DB  1           ;LD BC,
       47E7                     ERROR_DEVICE_IO_ERROR:
0007E7 47E7 1E13             7      LD  E,19            ;Device I/O error
0007E9 47E9 01                      DB  1           ;LD BC,
       47EA                     ERROR_INTERNAL_ERROR:
0007EA 47EA 1E33             7      LD  E,51            ;Internal error
0007EC 47EC 01                      DB  1           ;LD BC,
       47ED                     ERROR_FILE_NOT_OPEN:
0007ED 47ED 1E3B             7      LD  E,59            ;File not OPEN
0007EF 47EF 01                      DB  1           ;LD BC,
       47F0                     ERROR_FILE_NOT_FOUND:
0007F0 47F0 1E35             7      LD  E,53            ;File not found
       47F2                     ERROR:
0007F2 47F2 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0007F6 47F6 DD216F40        14      LD  IX,ERRHAND
0007FA 47FA C31C00          10      JP  _CALSLT
                                
       47FD                     ROM_BLOAD:
0007FD 47FD CD4D49          17      CALL    INIT_PARAM
000800 4800 CD404C          17      CALL    FILE_B
000803 4803 CDD24D          17      CALL    ROM_OPEN
000806 4806 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000808 4808 21D9F2          10      LD  HL,_BUF
00080B 480B 22D4F2          16      LD  (_DTA),HL
00080E 480E 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
000811 4811 CD9F4B          17      CALL    ROM_READ
000814 4814 3AD9F2          13      LD  A,(_BUF)
000817 4817 FEFE             7      CP  0FEH
000819 4819 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
00081B 481B 21A5F2          10      LD  HL,BLOAD_RET
00081E 481E 229DF2          16      LD  (SWC_BLOAD),HL
                                
000821 4821 2AF5F2          16      LD  HL,(PARAM1)
000824 4824 7E               7      LD  A,(HL)
000825 4825 FE2C             7      CP  ','
000827 4827 204C            12      JR  NZ,RBREAD_MEM
000829 4829 23               6      INC HL
00082A 482A 7E               7      LD  A,(HL)
00082B 482B CDBC4D          17      CALL    CAP
00082E 482E 32BEFC          13      LD  (RUNBNF),A
000831 4831 FE52             7      CP  'R'     ;R,Sスイッチじゃ無い場合はオフセット値として処理する
000833 4833 2808            12      JR  Z,RBOS1
000835 4835 FE53             7      CP  'S'
000837 4837 2804            12      JR  Z,RBOS1
000839 4839 FE2C             7      CP  ','
00083B 483B 200D            12      JR  NZ,RBOS2
       483D                     RBOS1:
00083D 483D 7E               7      LD  A,(HL)
00083E 483E 23               6      INC HL
00083F 483F B7               4      OR  A
000840 4840 2824            12      JR  Z,RBREAD_OSE
000842 4842 FE3A             7      CP  ':'
000844 4844 2820            12      JR  Z,RBREAD_OSE
000846 4846 FE2C             7      CP  ','     ;次のパラメータを探す
000848 4848 20F3            12      JR  NZ,RBOS1
       484A                     RBOS2:              ;オフセット
00084A 484A 22F5F2          16      LD  (PARAM1),HL
00084D 484D 7E               7      LD  A,(HL)
00084E 484E B7               4      OR  A
00084F 484F 2815            12      JR  Z,RBREAD_OSE
000851 4851 DD212F54        14      LD  IX,FRMQNT
000855 4855 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000859 4859 CD1C00          17      CALL    _CALSLT
00085C 485C 22F5F2          16      LD  (PARAM1),HL
00085F 485F 2ADAF2          16      LD  HL,(_BUF_ST)
000862 4862 19              11      ADD HL,DE
000863 4863 22DAF2          16      LD  (_BUF_ST),HL
       4866                     RBREAD_OSE:
000866 4866 3ABEFC          13      LD  A,(RUNBNF)
000869 4869 FE53             7      CP  'S'
00086B 486B 2008            12      JR  NZ,RBREAD_MEM
00086D 486D CD2D4B          17      CALL    WAIT_VDP
000870 4870 3E01             7      LD  A,1
000872 4872 32D6F2          13      LD  (FLG_LDIR),A
       4875                     RBREAD_MEM:
000875 4875 2ADAF2          16      LD  HL,(_BUF_ST)
000878 4878 22BFFC          16      LD  (SAVENT),HL
00087B 487B 22D4F2          16      LD  (_DTA),HL
00087E 487E 21FFFF          10      LD  HL,0FFFFH
000881 4881 CD9F4B          17      CALL    ROM_READ
000884 4884 AF               4      XOR A
000885 4885 32D6F2          13      LD  (FLG_LDIR),A
000888 4888 3ABEFC          13      LD  A,(RUNBNF)
00088B 488B FE52             7      CP  'R'
00088D 488D 2006            12      JR  NZ,RBREAD1
00088F 488F 2ADEF2          16      LD  HL,(_BUF_EX)
000892 4892 229DF2          16      LD  (SWC_BLOAD),HL
       4895                     RBREAD1:
       4895                     ROM_NEXT:
000895 4895 2AF5F2          16      LD  HL,(PARAM1)
000898 4898 7E               7      LD  A,(HL)
000899 4899 2B               6      DEC HL
00089A 489A B7               4      OR  A
00089B 489B 2805            12      JR  Z,ROM_NEXT1
00089D 489D FE3A             7      CP  ':'
00089F 489F 2801            12      JR  Z,ROM_NEXT1
0008A1 48A1 23               6      INC HL
       48A2                     ROM_NEXT1:
0008A2 48A2 5D               4      LD  E,L
0008A3 48A3 54               4      LD  D,H
                                
0008A4 48A4 CD924D          17      CALL    SEARCH_END
0008A7 48A7 B7               4      OR  A
0008A8 48A8 2821            12      JR  Z,REM
       48AA                     RN3:                    ;マルチステートメントの処理
0008AA 48AA 7E               7      LD  A,(HL)
                                
0008AB 48AB FEB5             7      CP  0B5H            ;LOAD
0008AD 48AD CA1B47          10      JP  Z,ROM_LOAD
0008B0 48B0 FE8A             7      CP  08AH            ;RUN
0008B2 48B2 281B            12      JR  Z,ROM_RUN
0008B4 48B4 FEB7             7      CP  0B7H            ;FILES
0008B6 48B6 2825            12      JR  Z,ROM_FILES
0008B8 48B8 FED6             7      CP  0D6H            ;COPY
0008BA 48BA CA7F49          10      JP  Z,ROM_COPY
0008BD 48BD FE20             7      CP  020H
0008BF 48BF 2807            12      JR  Z,RN_SP
                                
0008C1 48C1 3E28             7      LD  A,028H          ;JR Z,
0008C3 48C3 32A3F2          13      LD  (SWC_BLOAD_M),A
0008C6 48C6 7E               7      LD  A,(HL)
0008C7 48C7 C9              10      RET
       48C8                     RN_SP:
0008C8 48C8 23               6      INC HL
0008C9 48C9 18DF            12      JR  RN3
                                
       48CB                     REM:
0008CB 48CB EB               4      EX  DE,HL
0008CC 48CC 3E8F             7      LD  A,08FH          ;REM
0008CE 48CE C9              10      RET
                                
       48CF                     ROM_RUN:
0008CF 48CF 23               6      INC HL
0008D0 48D0 7E               7      LD  A,(HL)
0008D1 48D1 2B               6      DEC HL
0008D2 48D2 B7               4      OR  A
0008D3 48D3 C41B47          17      CALL    NZ,ROM_LOAD
0008D6 48D6 FE8F             7      CP  08FH            ;REM
0008D8 48D8 3E8A             7      LD  A,08AH          ;RUN
0008DA 48DA C0              11      RET NZ
0008DB 48DB 77               7      LD  (HL),A
0008DC 48DC C9              10      RET
                                
       48DD                     ROM_FILES:
0008DD 48DD CD4D49          17      CALL    INIT_PARAM
0008E0 48E0 CD404C          17      CALL    FILE_B
0008E3 48E3 CD3355          17      CALL    GET_DISK_BANK_FDRV
0008E6 48E6 3AC9F2          13      LD  A,(SECSZ_H)
0008E9 48E9 CDB553          17      CALL    IS_BPB1
0008EC 48EC DAE747          10      JP  C,ERROR_DEVICE_IO_ERROR
0008EF 48EF 3AFAF2          13      LD  A,(FNAME)
0008F2 48F2 FE21             7      CP  021H
0008F4 48F4 3005            12      JR  NC,RFILES0
0008F6 48F6 060B             7      LD  B,11
0008F8 48F8 CD264D          17      CALL    FILE10
       48FB                     RFILES0:
0008FB 48FB CD2E50          17      CALL    GET_DIR_DAT
       48FE                     RFILES1:
0008FE 48FE CDEE4D          17      CALL    FILESE
000901 4901 3045            12      JR  NC,RFILES_NOT_MATCH
       4903                     RFILES_DISP:
000903 4903 E5              11      PUSH    HL
000904 4904 110B00          10      LD  DE,0000BH   ;属性
000907 4907 19              11      ADD HL,DE
                                #if exists USE_MORMAL32K_OR_ASCII16
000908 4908 CDFE44          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
00090B 490B E1              10      POP HL
00090C 490C CB4F             8      BIT 1,A     ;不可視属性
00090E 490E 2035            12      JR  NZ,RFILES_NEXT
000910 4910 E5              11      PUSH    HL
000911 4911 0608             7      LD  B,8
000913 4913 CDF244          17      CALL    MSN
                                #if exists USE_MORMAL32K_OR_ASCII16
000916 4916 CDFE44          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000919 4919 FE20             7      CP  020H
00091B 491B F5              11      PUSH    AF
00091C 491C 3E2E             7      LD  A,'.'
00091E 491E C4AB55          17      CALL    NZ,MSG_A
000921 4921 0603             7      LD  B,3
000923 4923 CDF244          17      CALL    MSN
000926 4926 F1              10      POP AF
000927 4927 CCAB55          17      CALL    Z,MSG_A
00092A 492A 3ADDF3          13      LD  A,(CSRX)
00092D 492D 47               4      LD  B,A
00092E 492E 3AB0F3          13      LD  A,(LINLEN)
000931 4931 90               4      SUB B
000932 4932 FE0C             7      CP  12
000934 4934 3009            12      JR  NC,RFILES2
000936 4936 3E0D             7      LD  A,00DH      ;改行
000938 4938 CDAB55          17      CALL    MSG_A
00093B 493B 3E0A             7      LD  A,00AH
00093D 493D 1802            12      JR  RFILES3
       493F                     RFILES2:
00093F 493F 3E20             7      LD  A,020H
       4941                     RFILES3:
000941 4941 CDAB55          17      CALL    MSG_A
000944 4944 E1              10      POP HL
       4945                     RFILES_NEXT:
000945 4945 CD0C4E          17      CALL    FNEXT
       4948                     RFILES_NOT_MATCH:
000948 4948 20B4            12      JR  NZ,RFILES1
00094A 494A C39548          10      JP  ROM_NEXT
                                
       494D                     INIT_PARAM:
00094D 494D 22F3F2          16      LD  (PARAM0),HL
000950 4950 22F5F2          16      LD  (PARAM1),HL
000953 4953 EB               4      EX  DE,HL
000954 4954 32BEFC          13      LD  (RUNBNF),A
000957 4957 3263F6          13      LD  (VALTYP),A
00095A 495A E5              11      PUSH    HL
00095B 495B 2AEBF2          16      LD  HL,(_CD)
00095E 495E 22F7F2          16      LD  (_CDX),HL
000961 4961 E1              10      POP HL
000962 4962 13               6      INC DE
000963 4963 CD624D          17      CALL    SPCUT
000966 4966 1A               7      LD  A,(DE)
000967 4967 B7               4      OR  A
000968 4968 C8              11      RET Z
000969 4969 FE3A             7      CP  ':'
00096B 496B C8              11      RET Z
00096C 496C FE28             7      CP  '('
00096E 496E C8              11      RET Z
00096F 496F EB               4      EX  DE,HL
000970 4970 DD21644C        14      LD  IX,FRMEVL
000974 4974 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000978 4978 CD1C00          17      CALL    _CALSLT
00097B 497B 22F5F2          16      LD  (PARAM1),HL
00097E 497E C9              10      RET
                                
       497F                     ROM_COPY:
00097F 497F CD4D49          17      CALL    INIT_PARAM
000982 4982 3A63F6          13      LD  A,(VALTYP)
000985 4985 FE03             7      CP  3       ;string
000987 4987 C23B4C          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
00098A 498A CD404C          17      CALL    FILE_B
00098D 498D CDD24D          17      CALL    ROM_OPEN
000990 4990 DAF047          10      JP  C,ERROR_FILE_NOT_FOUND
                                
000993 4993 21DEF2          10      LD  HL,_BUF_W
000996 4996 22D4F2          16      LD  (_DTA),HL
000999 4999 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
00099C 499C CD9F4B          17      CALL    ROM_READ
                                
00099F 499F AF               4      XOR A
0009A0 49A0 32D9F2          13      LD  (_BUF_LO),A     ;PSET
0009A3 49A3 32E6F2          13      LD  (_BUF_O),A      ;向き
                                
0009A6 49A6 2AF5F2          16      LD  HL,(PARAM1)
       49A9                     RCP_PARAM1:
0009A9 49A9 7E               7      LD  A,(HL)
0009AA 49AA 23               6      INC HL
0009AB 49AB B7               4      OR  A
0009AC 49AC CAA248          10      JP  Z,ROM_NEXT1
0009AF 49AF FE3A             7      CP  ':'
0009B1 49B1 CAA248          10      JP  Z,ROM_NEXT1
0009B4 49B4 FE2C             7      CP  ','
0009B6 49B6 2012            12      JR  NZ,RCP_PARAM1_
                                
0009B8 49B8 DD212F54        14      LD  IX,FRMQNT
0009BC 49BC FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009C0 49C0 CD1C00          17      CALL    _CALSLT
0009C3 49C3 7B               4      LD  A,E
0009C4 49C4 87               4      ADD A,A
0009C5 49C5 87               4      ADD A,A
0009C6 49C6 32E6F2          13      LD  (_BUF_O),A
0009C9 49C9 7E               7      LD  A,(HL)
       49CA                     RCP_PARAM1_:
0009CA 49CA FE28             7      CP  '('
0009CC 49CC 20DB            12      JR  NZ,RCP_PARAM1
0009CE 49CE DD212F54        14      LD  IX,FRMQNT
0009D2 49D2 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009D6 49D6 CD1C00          17      CALL    _CALSLT
                                
0009D9 49D9 ED53E2F2        20      LD  (_BUF_X),DE
                                
       49DD                     RCP_PARAM2:
0009DD 49DD 23               6      INC HL
0009DE 49DE 7E               7      LD  A,(HL)
0009DF 49DF FE20             7      CP  020H
0009E1 49E1 28FA            12      JR  Z,RCP_PARAM2
0009E3 49E3 FE2C             7      CP  ','
0009E5 49E5 28F6            12      JR  Z,RCP_PARAM2
                                
0009E7 49E7 DD212F54        14      LD  IX,FRMQNT
0009EB 49EB FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009EF 49EF CD1C00          17      CALL    _CALSLT
                                
0009F2 49F2 3AF6FA          13      LD  A,(ACPAGE)
0009F5 49F5 57               4      LD  D,A
0009F6 49F6 ED53E4F2        20      LD  (_BUF_Y),DE
       49FA                     RCP_PARAM3:
0009FA 49FA 23               6      INC HL
0009FB 49FB 7E               7      LD  A,(HL)
0009FC 49FC FE20             7      CP  020H
0009FE 49FE 28FA            12      JR  Z,RCP_PARAM3
000A00 4A00 FE29             7      CP  ')'
000A02 4A02 28F6            12      JR  Z,RCP_PARAM3
000A04 4A04 FE2C             7      CP  ','
000A06 4A06 2033            12      JR  NZ,RCP_ST
                                
000A08 4A08 23               6      INC HL
000A09 4A09 DD212F54        14      LD  IX,FRMQNT
000A0D 4A0D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000A11 4A11 CD1C00          17      CALL    _CALSLT
                                
000A14 4A14 7B               4      LD  A,E
000A15 4A15 32E5F2          13      LD  (_BUF_P),A
                                
       4A18                     RCP_PARAM4:
000A18 4A18 7E               7      LD  A,(HL)
000A19 4A19 23               6      INC HL
000A1A 4A1A FE20             7      CP  020H
000A1C 4A1C 28FA            12      JR  Z,RCP_PARAM4
                                
000A1E 4A1E FE2C             7      CP  ','
000A20 4A20 2019            12      JR  NZ,RCP_ST
                                
000A22 4A22 7E               7      LD  A,(HL)
000A23 4A23 0604             7      LD  B,4
000A25 4A25 FEC3             7      CP  0C3H        ;PRESET
000A27 4A27 280E            12      JR  Z,RCP_LO
000A29 4A29 05               4      DEC B       ;3
000A2A 4A2A D6F8             7      SUB 0F8H        ;XOR
000A2C 4A2C 2809            12      JR  Z,RCP_LO
000A2E 4A2E 05               4      DEC B       ;2
000A2F 4A2F 3C               4      INC A       ;OR
000A30 4A30 2805            12      JR  Z,RCP_LO
000A32 4A32 05               4      DEC B       ;1
000A33 4A33 3C               4      INC A       ;AND
000A34 4A34 2801            12      JR  Z,RCP_LO
000A36 4A36 05               4      DEC B       ;0
                                                ;PSET
       4A37                     RCP_LO:
000A37 4A37 78               4      LD  A,B
000A38 4A38 32D9F2          13      LD  (_BUF_LO),A
       4A3B                     RCP_ST:
000A3B 4A3B 2AC6F6          16      LD  HL,(STREND)
000A3E 4A3E 22D4F2          16      LD  (_DTA),HL
000A41 4A41 EB               4      EX  DE,HL
000A42 4A42 2100FE          10      LD  HL,-512
000A45 4A45 39              11      ADD HL,SP
000A46 4A46 AF               4      XOR A
000A47 4A47 ED52            15      SBC HL,DE
000A49 4A49 3008            12      JR  NC,RCP0
000A4B 4A4B 215EF5          10      LD  HL,BUF
000A4E 4A4E 22D4F2          16      LD  (_DTA),HL
000A51 4A51 6F               4      LD  L,A ;0
000A52 4A52 67               4      LD  H,A ;0
       4A53                     RCP0:
000A53 4A53 24               4      INC H
000A54 4A54 22DCF2          16      LD  (_BUF_EN),HL
       4A57                     RCP1:
000A57 4A57 F3               4      DI
000A58 4A58 CD2D4B          17      CALL    WAIT_VDP
                                
000A5B 4A5B 3A0700          13      LD  A,(WRVDP)
000A5E 4A5E 4F               4      LD  C,A
000A5F 4A5F 0C               4      INC C       ;C := PORT#1's address(WR)
000A60 4A60 3E24             7      LD  A,36
000A62 4A62 ED79            12      OUT (C),A
000A64 4A64 3E91             7      LD  A,080H+17
000A66 4A66 ED79            12      OUT (C),A       ;R#17 := 36
                                
000A68 4A68 0C               4      INC C
000A69 4A69 0C               4      INC C       ;C := PORT#3's address(WR)
000A6A 4A6A 2AE2F2          16      LD  HL,(_BUF_X)
000A6D 4A6D ED69            12      OUT (C),L       ;R#36 DX
000A6F 4A6F ED61            12      OUT (C),H       ;R#37
000A71 4A71 2AE4F2          16      LD  HL,(_BUF_Y)
000A74 4A74 ED69            12      OUT (C),L       ;R#38 DY
000A76 4A76 ED61            12      OUT (C),H       ;R#39
000A78 4A78 2ADEF2          16      LD  HL,(_BUF_W)
000A7B 4A7B ED69            12      OUT (C),L       ;R#40 NX
000A7D 4A7D ED61            12      OUT (C),H       ;R#41
000A7F 4A7F 2AE0F2          16      LD  HL,(_BUF_H)
000A82 4A82 ED69            12      OUT (C),L       ;R#42 NY
000A84 4A84 ED61            12      OUT (C),H       ;R#43
                                
000A86 4A86 DD2AAFFC        20      LD  IX,(SCRMOD)
000A8A 4A8A 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000A8D 4A8D B7               4      OR  A
000A8E 4A8E 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000A90 4A90 DD7D             9      LD  A,IXL
000A92 4A92 FE08             7      CP  8
000A94 4A94 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
000A96 4A96 FE06             7      CP  6
000A98 4A98 2AE2F2          16      LD  HL,(_BUF_X)
000A9B 4A9B 3ADEF2          13      LD  A,(_BUF_W)
000A9E 4A9E 2005            12      JR  NZ,SCR57
000AA0 4AA0 B5               4      OR  L       ;スクリーン6
000AA1 4AA1 E603             7      AND 3
000AA3 4AA3 200D            12      JR  NZ,USE_LMMC
       4AA5                     SCR57:              ;スクリーン5,7
000AA5 4AA5 B5               4      OR  L
000AA6 4AA6 E601             7      AND 1
000AA8 4AA8 2008            12      JR  NZ,USE_LMMC
       4AAA                     USE_HMMC:
000AAA 4AAA DD2E08          10      LD  IXL,8
       4AAD                     USE_HMMC8:
000AAD 4AAD 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
000AAF 4AAF 32D9F2          13      LD  (_BUF_LO),A
       4AB2                     USE_LMMC:
000AB2 4AB2 110000          10      LD  DE,0
000AB5 4AB5 06FF             7      LD  B,-1
000AB7 4AB7 CD584B          17      CALL    GET_PIXEL
000ABA 4ABA ED79            12      OUT (C),A       ;R#44 first DATA
000ABC 4ABC 3AE6F2          13      LD  A,(_BUF_O)
000ABF 4ABF ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
000AC1 4AC1 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000AC4 4AC4 F6B0             7      OR  0B0H        ;R#46 LMMC command
000AC6 4AC6 ED79            12      OUT (C),A
                                
000AC8 4AC8 FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
000ACA 4ACA 0D               4      DEC C
000ACB 4ACB 0D               4      DEC C       ;C := PORT#1's address(WR)
000ACC 4ACC 3EAC             7      LD  A,080H+44
000ACE 4ACE ED79            12      OUT (C),A
000AD0 4AD0 3E91             7      LD  A,080H+17
000AD2 4AD2 ED79            12      OUT (C),A       ;R#17 := 44
                                
000AD4 4AD4 3A0600          13      LD  A,(RDVDP)
000AD7 4AD7 3C               4      INC A
000AD8 4AD8 FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
000ADA 4ADA 3E02             7      LD  A,2
000ADC 4ADC ED79            12      OUT (C),A
000ADE 4ADE 3E8F             7      LD  A,08FH
000AE0 4AE0 ED79            12      OUT (C),A
000AE2 4AE2 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000AE5 4AE5 E640             7      AND 040H
000AE7 4AE7 201C            12      JR  NZ,LOOP_HMMC
       4AE9                     LOOP_COPY:
000AE9 4AE9 CD584B          17      CALL    GET_PIXEL
000AEC 4AEC 08               4      EX  AF,AF'
000AED 4AED FD4C             9      LD  C,IYH
       4AEF                     LOOP_COPY1:
000AEF 4AEF ED78            12      IN  A,(C)
000AF1 4AF1 0F               4      RRCA            ;RRCAではサインフラグは変化しない
000AF2 4AF2 300A            12      JR  NC,EXIT_COPY    ;check CE bit
000AF4 4AF4 F2EF4A          10      JP  P,LOOP_COPY1    ;check TR bit
000AF7 4AF7 08               4      EX  AF,AF'
000AF8 4AF8 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000AFA 4AFA ED79            12      OUT (C),A
000AFC 4AFC 18EB            12      JR  LOOP_COPY
                                
       4AFE                     EXIT_COPY:
000AFE 4AFE CD354B          17      CALL    GET_STATUS_0
000B01 4B01 FB               4      EI
000B02 4B02 C39548          10      JP  ROM_NEXT
                                
       4B05                     LOOP_HMMC:
000B05 4B05 F3               4      DI          ;必要
000B06 4B06 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000B08 4B08 43               4      LD  B,E
000B09 4B09 7B               4      LD  A,E
000B0A 4B0A B7               4      OR  A
000B0B 4B0B 2802            12      JR  Z,LOOP_HMMC1
000B0D 4B0D EDB3                    OTIR
       4B0F                     LOOP_HMMC1:
000B0F 4B0F 14               4      INC D
       4B10                     LOOP_HMMC2:
000B10 4B10 15               4      DEC D
000B11 4B11 2805            12      JR  Z,LOOP_HMMC3
000B13 4B13 EDB3                    OTIR
000B15 4B15 C3104B          10      JP  LOOP_HMMC2
       4B18                     LOOP_HMMC3:
000B18 4B18 ED78            12      IN  A,(C)
000B1A 4B1A 0F               4      RRCA
000B1B 4B1B 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
000B1D 4B1D 2ADCF2          16      LD  HL,(_BUF_EN)
000B20 4B20 CD9F4B          17      CALL    ROM_READ
000B23 4B23 EB               4      EX  DE,HL
000B24 4B24 2AD4F2          16      LD  HL,(_DTA)
000B27 4B27 7A               4      LD  A,D
000B28 4B28 B3               4      OR  E
000B29 4B29 20DA            12      JR  NZ,LOOP_HMMC
000B2B 4B2B 18C2            12      JR  LOOP_COPY1
                                
       4B2D                     WAIT_VDP:
000B2D 4B2D 3E02             7      LD  A,2
000B2F 4B2F CD364B          17      CALL    GET_STATUS
000B32 4B32 0F               4      RRCA
000B33 4B33 38F8            12      JR  C,WAIT_VDP
       4B35                     GET_STATUS_0:
000B35 4B35 AF               4      XOR A
       4B36                     GET_STATUS:
000B36 4B36 C5              11      PUSH    BC
000B37 4B37 ED4B0600        20      LD  BC,(RDVDP)
000B3B 4B3B 0C               4      INC C
000B3C 4B3C ED79            12      OUT (C),A
000B3E 4B3E 3E8F             7      LD  A,08FH
000B40 4B40 ED79            12      OUT (C),A
000B42 4B42 ED78            12      IN  A,(C)
000B44 4B44 C1              10      POP BC
000B45 4B45 C9              10      RET
                                
       4B46                     GET_PIXEL256:
000B46 4B46 7A               4      LD  A,D
000B47 4B47 B3               4      OR  E
000B48 4B48 200A            12      JR  NZ,GET_PIXEL1
000B4A 4B4A 2ADCF2          16      LD  HL,(_BUF_EN)
000B4D 4B4D CD9F4B          17      CALL    ROM_READ
000B50 4B50 EB               4      EX  DE,HL
000B51 4B51 2AD4F2          16      LD  HL,(_DTA)
       4B54                     GET_PIXEL1:
000B54 4B54 7E               7      LD  A,(HL)
000B55 4B55 23               6      INC HL
000B56 4B56 1B               6      DEC DE
000B57 4B57 C9              10      RET
                                
       4B58                     GET_PIXEL:
000B58 4B58 DD7D             9      LD  A,IXL
000B5A 4B5A FE08             7      CP  8
000B5C 4B5C 28E8            12      JR  Z,GET_PIXEL256
000B5E 4B5E 04               4      INC B
000B5F 4B5F FE06             7      CP  6
000B61 4B61 282E            12      JR  Z,GET_PIXEL4
                                
000B63 4B63 CB40             8      BIT 0,B
000B65 4B65 20ED            12      JR  NZ,GET_PIXEL1
                                
000B67 4B67 7A               4      LD  A,D
000B68 4B68 B3               4      OR  E
000B69 4B69 200A            12      JR  NZ,GET_PIXEL2
                                
000B6B 4B6B 2ADCF2          16      LD  HL,(_BUF_EN)
000B6E 4B6E CD9F4B          17      CALL    ROM_READ
000B71 4B71 EB               4      EX  DE,HL
000B72 4B72 2AD4F2          16      LD  HL,(_DTA)
                                
       4B75                     GET_PIXEL2:
000B75 4B75 7E               7      LD  A,(HL)
000B76 4B76 0F               4      RRCA
000B77 4B77 0F               4      RRCA
000B78 4B78 0F               4      RRCA
000B79 4B79 0F               4      RRCA
000B7A 4B7A C9              10      RET
                                
       4B7B                     GET_PIXEL3:
000B7B 4B7B 7A               4      LD  A,D
000B7C 4B7C B3               4      OR  E
000B7D 4B7D 200A            12      JR  NZ,GET_PIXEL5
                                
000B7F 4B7F 2ADCF2          16      LD  HL,(_BUF_EN)
000B82 4B82 CD9F4B          17      CALL    ROM_READ
000B85 4B85 EB               4      EX  DE,HL
000B86 4B86 2AD4F2          16      LD  HL,(_DTA)
       4B89                     GET_PIXEL5:
000B89 4B89 7E               7      LD  A,(HL)
000B8A 4B8A 0F               4      RRCA
000B8B 4B8B 0F               4      RRCA
000B8C 4B8C 0F               4      RRCA
000B8D 4B8D 0F               4      RRCA
000B8E 4B8E 0F               4      RRCA
000B8F 4B8F 0F               4      RRCA
000B90 4B90 C9              10      RET
                                
       4B91                     GET_PIXEL4:
000B91 4B91 78               4      LD  A,B
000B92 4B92 E603             7      AND 3   ;+0
000B94 4B94 28E5            12      JR  Z,GET_PIXEL3
000B96 4B96 3D               4      DEC A   ;+1
000B97 4B97 28DC            12      JR  Z,GET_PIXEL2
000B99 4B99 3D               4      DEC A   ;+2
000B9A 4B9A 7E               7      LD  A,(HL)
000B9B 4B9B C0              11      RET NZ
000B9C 4B9C 0F               4      RRCA        ;+3
000B9D 4B9D 0F               4      RRCA
000B9E 4B9E C9              10      RET
                                
       4B9F                     ROM_READ:
000B9F 4B9F E5              11      PUSH    HL
000BA0 4BA0 D5              11      PUSH    DE
000BA1 4BA1 C5              11      PUSH    BC
000BA2 4BA2 FDE5            15      PUSH    IY
000BA4 4BA4 22F1F2          16      LD  (LEFTX),HL
000BA7 4BA7 2AD4F2          16      LD  HL,(_DTA)
000BAA 4BAA 22E7F2          16      LD  (DTAX),HL
000BAD 4BAD 2AF1F2          16      LD  HL,(LEFTX)
                                
000BB0 4BB0 CD534E          17      CALL    RBX1
000BB3 4BB3 3870            12      JR  C,RBRERR1
000BB5 4BB5 79               4      LD  A,C
000BB6 4BB6 EB               4      EX  DE,HL
000BB7 4BB7 ED52            15      SBC HL,DE       ;CP 0HL,CDE
000BB9 4BB9 19              11      ADD HL,DE
000BBA 4BBA DE00             7      SBC A,000H
000BBC 4BBC 3801            12      JR  C,RBR1
000BBE 4BBE EB               4      EX  DE,HL
       4BBF                     RBR1:
000BBF 4BBF 9F               4      SBC A,A
000BC0 4BC0 E601             7      AND 1
000BC2 4BC2 32C3F2          13      LD  (_RESULT),A
000BC5 4BC5 7C               4      LD  A,H
000BC6 4BC6 B5               4      OR  L
000BC7 4BC7 CA1B4C          10      JP  Z,RBREND0
                                
000BCA 4BCA 22D0F2          16      LD  (_LEFT),HL  ;Read record byte
000BCD 4BCD 22F1F2          16      LD  (LEFTX),HL
                                
000BD0 4BD0 CD864E          17      CALL    RBX2
000BD3 4BD3 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000BD5 4BD5 CD994E          17      CALL    RBXA
000BD8 4BD8 DA314C          10      JP  C,RBRERR
000BDB 4BDB C5              11      PUSH    BC
000BDC 4BDC CD0D45          17      CALL    ROM_LDIR
000BDF 4BDF ED53E7F2        20      LD  (DTAX),DE
000BE3 4BE3 2AF1F2          16      LD  HL,(LEFTX)
000BE6 4BE6 D1              10      POP DE
000BE7 4BE7 A7               4      AND A
000BE8 4BE8 ED52            15      SBC HL,DE
000BEA 4BEA 22F1F2          16      LD  (LEFTX),HL
000BED 4BED 2829            12      JR  Z,RBREND
                                
       4BEF                     RBRB:
000BEF 4BEF CDD24E          17      CALL    RBXB
000BF2 4BF2 2818            12      JR  Z,RBRC
       4BF4                     RBRB1:
000BF4 4BF4 C5              11      PUSH    BC
000BF5 4BF5 D5              11      PUSH    DE
000BF6 4BF6 CD834F          17      CALL    CLUST
000BF9 4BF9 EB               4      EX  DE,HL
000BFA 4BFA ED4BC6F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000BFE 4BFE CD0D45          17      CALL    ROM_LDIR
000C01 4C01 EB               4      EX  DE,HL
000C02 4C02 D1              10      POP DE
000C03 4C03 C1              10      POP BC
000C04 4C04 CD604F          17      CALL    GNCL
000C07 4C07 DA314C          10      JP  C,RBRERR
000C0A 4C0A 10E8            13      DJNZ    RBRB1
       4C0C                     RBRC:
000C0C 4C0C CDEA4E          17      CALL    RBXC
000C0F 4C0F 2807            12      JR  Z,RBREND
                                
000C11 4C11 CD834F          17      CALL    CLUST
000C14 4C14 EB               4      EX  DE,HL
000C15 4C15 CD0D45          17      CALL    ROM_LDIR
       4C18                     RBREND:
000C18 4C18 CDF64E          17      CALL    RBXEND
       4C1B                     RBREND0:
000C1B 4C1B FDE1            14      POP IY
000C1D 4C1D C1              10      POP BC
000C1E 4C1E D1              10      POP DE
000C1F 4C1F F1              10      POP AF  ;(HL)
000C20 4C20 AF               4      XOR A
000C21 4C21 3AC3F2          13      LD  A,(_RESULT)
000C24 4C24 C9              10      RET
                                
       4C25                     RBRERR1:
000C25 4C25 3E01             7      LD  A,001H
       4C27                     RBRERR2:
000C27 4C27 FDE1            14      POP IY
000C29 4C29 C1              10      POP BC
000C2A 4C2A D1              10      POP DE
000C2B 4C2B E1              10      POP HL
000C2C 4C2C 37               4      SCF
000C2D 4C2D 210000          10      LD  HL,0
000C30 4C30 C9              10      RET
       4C31                     RBRERR:
000C31 4C31 3EFF             7      LD  A,0FFH
000C33 4C33 18F2            12      JR  RBRERR2
                                
       4C35                     FILE_DD:
000C35 4C35 E1              10      POP HL
000C36 4C36 3E                      DB  03EH
000C37 4C37 C9              10      RET
000C38 4C38 32A3F2          13      LD  (SWC_BLOAD_M),A
       4C3B                     ROM_ORG:
000C3B 4C3B 2AF3F2          16      LD  HL,(PARAM0)
000C3E 4C3E 7E               7      LD  A,(HL)
000C3F 4C3F C9              10      RET
       4C40                     FILE_B:
000C40 4C40 AF               4      XOR A
000C41 4C41 32F9F2          13      LD  (FDRV),A
000C44 4C44 1E00             7      LD  E,0
000C46 4C46 3A63F6          13      LD  A,(VALTYP)
000C49 4C49 FE03             7      CP  3       ;string
000C4B 4C4B C2E34C          10      JP  NZ,FILED
                                
000C4E 4C4E DD21D067        14      LD  IX,FRESTR
000C52 4C52 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000C56 4C56 CD1C00          17      CALL    _CALSLT
000C59 4C59 E5              11      PUSH    HL
000C5A 4C5A DDE1            14      POP IX
                                
000C5C 4C5C DD5E00          19      LD  E,(IX+0)
000C5F 4C5F DD7E01          19      LD  A,(IX+1)
000C62 4C62 DD5602          19      LD  D,(IX+2)
000C65 4C65 DD62             9      LD  IXH,D
000C67 4C67 DD6F             9      LD  IXL,A
000C69 4C69 7B               4      LD  A,E
       4C6A                     FILE_BDOS:
000C6A 4C6A FE04             7      CP  4
000C6C 4C6C 3808            12      JR  C,FILEB1
000C6E 4C6E DD7E03          19      LD  A,(IX+3)
000C71 4C71 FE3A             7      CP  ':'
000C73 4C73 28C0            12      JR  Z,FILE_DD
000C75 4C75 7B               4      LD  A,E
       4C76                     FILEB1:
000C76 4C76 FE02             7      CP  2
000C78 4C78 3818            12      JR  C,DEVI1
000C7A 4C7A DD7E01          19      LD  A,(IX+1)
000C7D 4C7D FE3A             7      CP  ':'
000C7F 4C7F 2011            12      JR  NZ,DEVI1
000C81 4C81 DD7E00          19      LD  A,(IX+0)        ;DRIVE
000C84 4C84 CDBC4D          17      CALL    CAP
000C87 4C87 D640             7      SUB '@'
000C89 4C89 DD23            10      INC IX
000C8B 4C8B DD23            10      INC IX
000C8D 4C8D 1D               4      DEC E
000C8E 4C8E 1D               4      DEC E
000C8F 4C8F 32F9F2          13      LD  (FDRV),A
       4C92                     DEVI1:
000C92 4C92 DD7E00          19      LD  A,(IX+0)
000C95 4C95 D65C             7      SUB 05CH        ;\
000C97 4C97 2008            12      JR  NZ,NOROOT
000C99 4C99 6F               4      LD  L,A
000C9A 4C9A 67               4      LD  H,A
000C9B 4C9B 22F7F2          16      LD  (_CDX),HL
000C9E 4C9E DD23            10      INC IX
000CA0 4CA0 1D               4      DEC E
       4CA1                     NOROOT:
                                
       4CA1                     SETDIR:
000CA1 4CA1 CDE34C          17      CALL    FILED
000CA4 4CA4 DD7E00          19      LD  A,(IX+0)
000CA7 4CA7 FE5C             7      CP  05CH        ;\
000CA9 4CA9 C0              11      RET NZ
000CAA 4CAA DD23            10      INC IX
000CAC 4CAC 1D               4      DEC E
000CAD 4CAD 3AFAF2          13      LD  A,(FNAME)
000CB0 4CB0 FE20             7      CP  020H        ;. の処理
000CB2 4CB2 28ED            12      JR  Z,SETDIR
                                
000CB4 4CB4 CDD24D          17      CALL    ROM_OPEN
000CB7 4CB7 B7               4      OR  A
000CB8 4CB8 C0              11      RET NZ
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
000CB9 4CB9 D5              11      PUSH    DE
000CBA 4CBA 2AEDF2          16      LD  HL,(DIRENT1)
000CBD 4CBD 110B00          10      LD  DE,0000BH   ;属性(アトリビュート)
000CC0 4CC0 19              11      ADD HL,DE
000CC1 4CC1 CDFE44          17      CALL    RDSLT_ROM
000CC4 4CC4 D1              10      POP DE
000CC5 4CC5 CB67             8      BIT 4,A     ;ディレクトリ
                                #else
                                    LD  IY,(DIRENT1)
                                    BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000CC7 4CC7 C8              11      RET Z
000CC8 4CC8 CD2A4D          17      CALL    FILEI
                                #if exists USE_MORMAL32K_OR_ASCII16
000CCB 4CCB D5              11      PUSH    DE
000CCC 4CCC 2AEDF2          16      LD  HL,(DIRENT1)
000CCF 4CCF 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000CD2 4CD2 19              11      ADD HL,DE
000CD3 4CD3 CDFE44          17      CALL    RDSLT_ROM
000CD6 4CD6 23               6      INC HL
000CD7 4CD7 5F               4      LD  E,A
000CD8 4CD8 CDFE44          17      CALL    RDSLT_ROM
000CDB 4CDB 57               4      LD  D,A
000CDC 4CDC EB               4      EX  DE,HL
000CDD 4CDD D1              10      POP DE
                                #else
                                    LD  L,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  H,(IY+01BH)
                                #endif
000CDE 4CDE 22F7F2          16      LD  (_CDX),HL
000CE1 4CE1 18BE            12      JR  SETDIR
                                
       4CE3                     FILED:
000CE3 4CE3 CD2A4D          17      CALL    FILEI
000CE6 4CE6 21FAF2          10      LD  HL,FNAME
                                
000CE9 4CE9 0608             7      LD  B,8
       4CEB                     FILE2:
000CEB 4CEB CD374D          17      CALL    CCHKF
000CEE 4CEE C8              11      RET Z
000CEF 4CEF FE2A             7      CP  '*'
000CF1 4CF1 282E            12      JR  Z,FILE9
000CF3 4CF3 FE2E             7      CP  '.'
000CF5 4CF5 280C            12      JR  Z,FILE4
000CF7 4CF7 77               7      LD  (HL),A
000CF8 4CF8 23               6      INC HL
000CF9 4CF9 10F0            13      DJNZ    FILE2
                                
       4CFB                     FILE3:
000CFB 4CFB CD374D          17      CALL    CCHKF
000CFE 4CFE C8              11      RET Z
000CFF 4CFF FE2E             7      CP  '.'
000D01 4D01 20F8            12      JR  NZ,FILE3
                                
       4D03                     FILE4:
000D03 4D03 2102F3          10      LD  HL,FNAME+8
000D06 4D06 0603             7      LD  B,3
                                
       4D08                     FILE4L:
000D08 4D08 CD374D          17      CALL    CCHKF
000D0B 4D0B C8              11      RET Z
000D0C 4D0C FE2E             7      CP  '.'
000D0E 4D0E 2008            12      JR  NZ,FILE12
000D10 4D10 32FAF2          13      LD  (FNAME),A   ;Parent directory(..)
000D13 4D13 32FBF2          13      LD  (FNAME+1),A
000D16 4D16 3E20             7      LD  A,020H
       4D18                     FILE12:
000D18 4D18 FE2A             7      CP  '*'
000D1A 4D1A 280A            12      JR  Z,FILE10
000D1C 4D1C 77               7      LD  (HL),A
000D1D 4D1D 23               6      INC HL
000D1E 4D1E 10E8            13      DJNZ    FILE4L
000D20 4D20 C9              10      RET
                                
       4D21                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000D21 4D21 CD264D          17      CALL    FILE10
000D24 4D24 18D5            12      JR  FILE3
                                
       4D26                     FILE10:
000D26 4D26 3E3F             7      LD  A,'?'
000D28 4D28 1808            12      JR  FILL_MEMORY
       4D2A                     FILEI:              ;名前＋拡張子をスペースで初期化
000D2A 4D2A 3E20             7      LD  A,020H
000D2C 4D2C 01000B          10      LD  BC,11*256   ;C=0にしておく
000D2F 4D2F 21FAF2          10      LD  HL,FNAME
       4D32                     FILL_MEMORY:            ;HLからBバイトAで埋める
000D32 4D32 77               7      LD  (HL),A
000D33 4D33 23               6      INC HL
000D34 4D34 10FC            13      DJNZ    FILL_MEMORY
000D36 4D36 C9              10      RET
                                
       4D37                     CCHKF:
000D37 4D37 7B               4      LD  A,E
000D38 4D38 B7               4      OR  A
000D39 4D39 C8              11      RET Z
000D3A 4D3A DD7E00          19      LD  A,(IX+0)
000D3D 4D3D CD444D          17      CALL    CCHK2
000D40 4D40 C8              11      RET Z
000D41 4D41 C3A74D          10      JP  FKAN
                                
       4D44                     CCHK2:
000D44 4D44 0C               4      INC C
000D45 4D45 0D               4      DEC C
000D46 4D46 C0              11      RET NZ
       4D47                     CCHK3:              ;ZF=1 で使えない文字
000D47 4D47 FE2B             7      CP  '+'
000D49 4D49 C8              11      RET Z
000D4A 4D4A FE2C             7      CP  ','
000D4C 4D4C C8              11      RET Z
000D4D 4D4D FE2F             7      CP  '/'
000D4F 4D4F C8              11      RET Z
000D50 4D50 FE3A             7      CP  ':'
000D52 4D52 C8              11      RET Z
000D53 4D53 FE3B             7      CP  ';'
000D55 4D55 C8              11      RET Z
000D56 4D56 FE3D             7      CP  '='
000D58 4D58 C8              11      RET Z
000D59 4D59 FE5C             7      CP  05CH    ;\
000D5B 4D5B C8              11      RET Z
000D5C 4D5C FE1F             7      CP  01FH
000D5E 4D5E D0              11      RET NC
000D5F 4D5F BF               4      CP  A       ;Z=1
000D60 4D60 C9              10      RET
                                
       4D61                     SS1:
000D61 4D61 13               6      INC DE
       4D62                     SPCUT:              ;スペースをカット
000D62 4D62 1A               7      LD  A,(DE)
000D63 4D63 FE20             7      CP  020H
000D65 4D65 28FA            12      JR  Z,SS1
000D67 4D67 C9              10      RET
                                
       4D68                     SCREOF1:
000D68 4D68 13               6      INC DE
       4D69                     SPCUTEX:            ;スペース改行などをカット
000D69 4D69 1A               7      LD  A,(DE)
000D6A 4D6A FE20             7      CP  020H
000D6C 4D6C 28FA            12      JR  Z,SCREOF1
000D6E 4D6E FE0D             7      CP  00DH
000D70 4D70 28F6            12      JR  Z,SCREOF1
000D72 4D72 FE0A             7      CP  00AH
000D74 4D74 28F2            12      JR  Z,SCREOF1
000D76 4D76 FE1A             7      CP  01AH
000D78 4D78 28EE            12      JR  Z,SCREOF1
000D7A 4D7A C9              10      RET
                                
       4D7B                     GETNUM:
000D7B 4D7B 210000          10      LD  HL,0
       4D7E                     GETNUM1:
000D7E 4D7E 1A               7      LD  A,(DE)
000D7F 4D7F 13               6      INC DE
000D80 4D80 D630             7      SUB '0'
000D82 4D82 D8              11      RET C
000D83 4D83 FE0A             7      CP  10
000D85 4D85 D0              11      RET NC
000D86 4D86 4D               4      LD  C,L
000D87 4D87 44               4      LD  B,H
000D88 4D88 29              11      ADD HL,HL   ;*2
000D89 4D89 29              11      ADD HL,HL   ;*4
000D8A 4D8A 09              11      ADD HL,BC   ;*5
000D8B 4D8B 29              11      ADD HL,HL   ;*10
000D8C 4D8C 4F               4      LD  C,A
000D8D 4D8D 0600             7      LD  B,0
000D8F 4D8F 09              11      ADD HL,BC
000D90 4D90 18EC            12      JR  GETNUM1
                                
       4D92                     SEARCH_END:
000D92 4D92 7E               7      LD  A,(HL)
       4D93                     SEARCH_END1:
000D93 4D93 23               6      INC HL
000D94 4D94 B7               4      OR  A
000D95 4D95 C8              11      RET Z
000D96 4D96 FE3A             7      CP  ':'
000D98 4D98 20F8            12      JR  NZ,SEARCH_END
000D9A 4D9A 7E               7      LD  A,(HL)
000D9B 4D9B FE3A             7      CP  ':'
000D9D 4D9D 28F4            12      JR  Z,SEARCH_END1
000D9F 4D9F C9              10      RET
                                
       4DA0                     FKANC:
000DA0 4DA0 CB41             8      BIT 0,C
000DA2 4DA2 CCC54D          17      CALL    Z,CAP2
000DA5 4DA5 1803            12      JR  FKANX
       4DA7                     FKAN:           ;漢字チェック
000DA7 4DA7 DD23            10      INC IX
000DA9 4DA9 1D               4      DEC E
       4DAA                     FKANX:
000DAA 4DAA CB41             8      BIT 0,C
000DAC 4DAC CB81             8      RES 0,C
000DAE 4DAE C0              11      RET NZ
000DAF 4DAF FE80             7      CP  080H
000DB1 4DB1 D8              11      RET C
000DB2 4DB2 FEA0             7      CP  0A0H
000DB4 4DB4 3803            12      JR  C,FKAN1
000DB6 4DB6 FEE0             7      CP  0E0H
000DB8 4DB8 D8              11      RET C
       4DB9                     FKAN1:
000DB9 4DB9 0C               4      INC C
000DBA 4DBA A7               4      AND A
000DBB 4DBB C9              10      RET
                                
       4DBC                     CAP:
000DBC 4DBC FE61             7      CP  'a'
000DBE 4DBE D8              11      RET C
000DBF 4DBF FE7B             7      CP  'z'+1
000DC1 4DC1 D0              11      RET NC
000DC2 4DC2 D620             7      SUB 020H
000DC4 4DC4 C9              10      RET
       4DC5                     CAP2:
000DC5 4DC5 CDBC4D          17      CALL    CAP
       4DC8                     CAP3:               ;
000DC8 4DC8 FE05             7      CP  5
000DCA 4DCA 2803            12      JR  Z,CAP4
000DCC 4DCC FE21             7      CP  021H
000DCE 4DCE C9              10      RET
       4DCF                     CAP4:
000DCF 4DCF 3EE5             7      LD  A,0E5H
000DD1 4DD1 C9              10      RET
                                
       4DD2                     ROM_OPEN:
000DD2 4DD2 CD3355          17      CALL    GET_DISK_BANK_FDRV
                                
000DD5 4DD5 CD2E50          17      CALL    GET_DIR_DAT
000DD8 4DD8 D5              11      PUSH    DE
000DD9 4DD9 CDEE4D          17      CALL    FILESE
000DDC 4DDC D1              10      POP DE
000DDD 4DDD 3F               4      CCF
000DDE 4DDE D8              11      RET C
000DDF 4DDF 22EDF2          16      LD  (DIRENT1),HL
000DE2 4DE2 E5              11      PUSH    HL
000DE3 4DE3 210000          10      LD  HL,0
000DE6 4DE6 22CAF2          16      LD  (RR_LOW),HL
000DE9 4DE9 22CCF2          16      LD  (RR_HIGH),HL
000DEC 4DEC E1              10      POP HL
000DED 4DED C9              10      RET
                                
       4DEE                     FILESE:
       4DEE                     FILESE0:
                                #if exists USE_MORMAL32K_OR_ASCII16
000DEE 4DEE CDFE44          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000DF1 4DF1 B7               4      OR  A
000DF2 4DF2 C8              11      RET Z       ;END:ZF=1 CF=0
000DF3 4DF3 FEE5             7      CP  0E5H
000DF5 4DF5 280D            12      JR  Z,FILESE1
000DF7 4DF7 11FAF2          10      LD  DE,FNAME
000DFA 4DFA E5              11      PUSH    HL
000DFB 4DFB CD2A4E          17      CALL    CPFILE
000DFE 4DFE CC4D4E          17      CALL    Z,CPFILE2
000E01 4E01 E1              10      POP HL
000E02 4E02 37               4      SCF
000E03 4E03 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4E04                     FILESE1:
000E04 4E04 CD0C4E          17      CALL    FNEXT
000E07 4E07 20E5            12      JR  NZ,FILESE0
000E09 4E09 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000E0B 4E0B C9              10      RET
                                
       4E0C                     FNEXT:
000E0C 4E0C 112000          10      LD  DE,020H
000E0F 4E0F 19              11      ADD HL,DE
000E10 4E10 ED5BF7F2        20      LD  DE,(_CDX)
000E14 4E14 7A               4      LD  A,D
000E15 4E15 B3               4      OR  E
000E16 4E16 2002            12      JR  NZ,FNEXT_SUBDIR
000E18 4E18 0D               4      DEC C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
                                    PUSH    AF      ;※フラグを保存する必要あり
                                    BIT 7,H
                                    JR  Z,CHECK_DIR_PAGE1
                                    LD  A,H
                                    SUB 020H
                                    LD  H,A
                                    LD  A,(_DIR_BANK)
                                    INC A
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_DIR_BANK),A
                                CHECK_DIR_PAGE1:
                                    POP AF
                                #endif
000E19 4E19 C9              10      RET
                                
       4E1A                     FNEXT_SUBDIR:           ;サブディレクトリ
000E1A 4E1A 0D               4      DEC C
000E1B 4E1B C0              11      RET NZ
                                
000E1C 4E1C ED5BF7F2        20      LD  DE,(_CDX)
000E20 4E20 CD604F          17      CALL    GNCL
000E23 4E23 EB               4      EX  DE,HL
000E24 4E24 22F7F2          16      LD  (_CDX),HL
000E27 4E27 C36750          10      JP  GET_SUBDIR
                                
       4E2A                     CPFILE:
000E2A 4E2A C5              11      PUSH    BC
000E2B 4E2B 01000B          10      LD  BC,00B00H
       4E2E                     CPSTR1:
000E2E 4E2E 1A               7      LD  A,(DE)
000E2F 4E2F FE3F             7      CP  '?'     ;Wild card
000E31 4E31 2814            12      JR  Z,CPSTR2
                                #if exists USE_MORMAL32K_OR_ASCII16
000E33 4E33 CDFE44          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000E36 4E36 CDA04D          17      CALL    FKANC
000E39 4E39 E5              11      PUSH    HL
000E3A 4E3A 67               4      LD  H,A
000E3B 4E3B 1A               7      LD  A,(DE)
000E3C 4E3C CB01             8      RLC C
000E3E 4E3E CDA04D          17      CALL    FKANC
000E41 4E41 CB09             8      RRC C
000E43 4E43 BC               4      CP  H       ;CP (HL),(DE)
000E44 4E44 E1              10      POP HL
000E45 4E45 2004            12      JR  NZ,CPSTR3
       4E47                     CPSTR2:
000E47 4E47 13               6      INC DE
000E48 4E48 23               6      INC HL
000E49 4E49 10E3            13      DJNZ    CPSTR1
       4E4B                     CPSTR3:
000E4B 4E4B C1              10      POP BC
000E4C 4E4C C9              10      RET
                                
       4E4D                     CPFILE2:
                                #if exists USE_MORMAL32K_OR_ASCII16
000E4D 4E4D CDFE44          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000E50 4E50 E608             7      AND 008H    ;~0F7H
000E52 4E52 C9              10      RET
                                
       4E53                     RBX1:
000E53 4E53 E5              11      PUSH    HL      ;Record byte
                                
000E54 4E54 ED5BCAF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000E58 4E58 3ACDF2          13      LD  A,(RR_HIGH+1)
000E5B 4E5B 4F               4      LD  C,A
                                
000E5C 4E5C 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
000E5F 4E5F 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
000E62 4E62 D5              11      PUSH    DE
000E63 4E63 2AEDF2          16      LD  HL,(DIRENT1)
000E66 4E66 111C00          10      LD  DE,0001CH
000E69 4E69 19              11      ADD HL,DE
000E6A 4E6A CDFE44          17      CALL    RDSLT_ROM
000E6D 4E6D 23               6      INC HL
000E6E 4E6E 5F               4      LD  E,A
000E6F 4E6F CDFE44          17      CALL    RDSLT_ROM
000E72 4E72 23               6      INC HL
000E73 4E73 57               4      LD  D,A
000E74 4E74 CDFE44          17      CALL    RDSLT_ROM
000E77 4E77 EB               4      EX  DE,HL       ;AHL=File size
000E78 4E78 D1              10      POP DE
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  L,(IY+01CH) ;AHL=File size
                                    LD  H,(IY+01DH)
                                    LD  A,(IY+01EH)
                                #endif
                                
000E79 4E79 A7               4      AND A
000E7A 4E7A ED52            15      SBC HL,DE
000E7C 4E7C 99               4      SBC A,C
000E7D 4E7D D1              10      POP DE
                                
000E7E 4E7E D8              11      RET C
000E7F 4E7F 4F               4      LD  C,A
000E80 4E80 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000E81 4E81 B2               4      OR  D
000E82 4E82 B3               4      OR  E
000E83 4E83 C0              11      RET NZ
000E84 4E84 37               4      SCF
000E85 4E85 C9              10      RET
                                
       4E86                     RBX2:
000E86 4E86 ED4BCBF2        20      LD  BC,(RR_LOW+1)
000E8A 4E8A CD0B4F          17      CALL    RWXR
000E8D 4E8D 3AC7F2          13      LD  A,(CLSZ_H)
000E90 4E90 3D               4      DEC A
000E91 4E91 E5              11      PUSH    HL
000E92 4E92 2ACAF2          16      LD  HL,(RR_LOW)
000E95 4E95 A4               4      AND H
000E96 4E96 B5               4      OR  L
000E97 4E97 E1              10      POP HL
000E98 4E98 C9              10      RET
                                
       4E99                     RBXA:
000E99 4E99 D5              11      PUSH    DE
000E9A 4E9A CD834F          17      CALL    CLUST
000E9D 4E9D ED53D2F2        20      LD  (_DTPS),DE
000EA1 4EA1 D1              10      POP DE
000EA2 4EA2 CD604F          17      CALL    GNCL
000EA5 4EA5 D8              11      RET C
000EA6 4EA6 ED53CEF2        20      LD  (_CLPS),DE
                                
000EAA 4EAA ED4BCAF2        20      LD  BC,(RR_LOW)
000EAE 4EAE 2AC6F2          16      LD  HL,(CLSZ)
000EB1 4EB1 7C               4      LD  A,H
000EB2 4EB2 3D               4      DEC A
000EB3 4EB3 A0               4      AND B
000EB4 4EB4 47               4      LD  B,A
000EB5 4EB5 ED42            15      SBC HL,BC       ;remaining cluster
                                
000EB7 4EB7 ED5BF1F2        20      LD  DE,(LEFTX)
000EBB 4EBB ED52            15      SBC HL,DE       ;CP HL,DE
000EBD 4EBD 19              11      ADD HL,DE
000EBE 4EBE 3801            12      JR  C,RBXA1
000EC0 4EC0 EB               4      EX  DE,HL
       4EC1                     RBXA1:
000EC1 4EC1 3AC4F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_MORMAL32K_OR_ASCII16
000EC4 4EC4 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000EC7 4EC7 E5              11      PUSH    HL
000EC8 4EC8 2AD2F2          16      LD  HL,(_DTPS)
000ECB 4ECB 09              11      ADD HL,BC
000ECC 4ECC ED5BE7F2        20      LD  DE,(DTAX)
000ED0 4ED0 C1              10      POP BC
000ED1 4ED1 C9              10      RET
                                
       4ED2                     RBXB:
000ED2 4ED2 2AE7F2          16      LD  HL,(DTAX)
000ED5 4ED5 ED5BCEF2        20      LD  DE,(_CLPS)
000ED9 4ED9 3AF2F2          13      LD  A,(LEFTX+1)
000EDC 4EDC 47               4      LD  B,A
000EDD 4EDD 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4EE0                     RBXB1:
000EE0 4EE0 1F               4      RRA     ;->CF
000EE1 4EE1 3804            12      JR  C,RBXB2
000EE3 4EE3 CB38             8      SRL B   ;B=B/2
000EE5 4EE5 18F9            12      JR  RBXB1
       4EE7                     RBXB2:
000EE7 4EE7 78               4      LD  A,B
000EE8 4EE8 B7               4      OR  A
000EE9 4EE9 C9              10      RET
                                
       4EEA                     RBXC:
000EEA 4EEA ED4BF1F2        20      LD  BC,(LEFTX)
000EEE 4EEE 3AC7F2          13      LD  A,(CLSZ_H)
000EF1 4EF1 3D               4      DEC A
000EF2 4EF2 A0               4      AND B
000EF3 4EF3 47               4      LD  B,A
000EF4 4EF4 B1               4      OR  C
000EF5 4EF5 C9              10      RET
                                
       4EF6                     RBXEND:
000EF6 4EF6 ED5BD0F2        20      LD  DE,(_LEFT)
000EFA 4EFA 2ACAF2          16      LD  HL,(RR_LOW)
000EFD 4EFD 3ACDF2          13      LD  A,(RR_HIGH+1)
000F00 4F00 19              11      ADD HL,DE
000F01 4F01 CE00             7      ADC A,0
000F03 4F03 22CAF2          16      LD  (RR_LOW),HL
000F06 4F06 32CDF2          13      LD  (RR_HIGH+1),A
000F09 4F09 EB               4      EX  DE,HL       ;HL=Read byte
000F0A 4F0A C9              10      RET
                                
       4F0B                     RWXR:
000F0B 4F0B 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4F0E                     L_RWX:
000F0E 4F0E 1F               4      RRA     ;->CF
000F0F 4F0F 3806            12      JR  C,E_RWX
000F11 4F11 CB38             8      SRL B   ;BC=BC/2
000F13 4F13 CB19             8      RR  C   ;
000F15 4F15 18F7            12      JR  L_RWX
       4F17                     E_RWX:
000F17 4F17 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
000F1A 4F1A 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
000F1D 4F1D E5              11      PUSH    HL
000F1E 4F1E 2AEDF2          16      LD  HL,(DIRENT1)
000F21 4F21 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000F24 4F24 19              11      ADD HL,DE
000F25 4F25 CDFE44          17      CALL    RDSLT_ROM
000F28 4F28 23               6      INC HL
000F29 4F29 5F               4      LD  E,A
000F2A 4F2A CDFE44          17      CALL    RDSLT_ROM
000F2D 4F2D 23               6      INC HL
000F2E 4F2E 57               4      LD  D,A
000F2F 4F2F E1              10      POP HL
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  E,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  D,(IY+01BH)
                                #endif
000F30 4F30 CD3355          17      CALL    GET_DISK_BANK_FDRV
       4F33                     RWX1:
000F33 4F33 ED53CEF2        20      LD  (_CLPS),DE
000F37 4F37 7A               4      LD  A,D
000F38 4F38 B3               4      OR  E
000F39 4F39 37               4      SCF
000F3A 4F3A C8              11      RET Z
                                
000F3B 4F3B 78               4      LD  A,B
000F3C 4F3C B1               4      OR  C
000F3D 4F3D C8              11      RET Z
                                
000F3E 4F3E CD604F          17      CALL    GNCL
000F41 4F41 D8              11      RET C
000F42 4F42 0B               6      DEC BC
000F43 4F43 CDC74F          17      CALL    ENDCL
000F46 4F46 38EB            12      JR  C,RWX1
000F48 4F48 37               4      SCF
000F49 4F49 C9              10      RET
                                
       4F4A                     NCL3:
000F4A 4F4A CD3355          17      CALL    GET_DISK_BANK_FDRV
000F4D 4F4D 6B               4      LD  L,E
000F4E 4F4E 62               4      LD  H,D
000F4F 4F4F CB3C             8      SRL H
000F51 4F51 CB1D             8      RR  L
000F53 4F53 1F               4      RRA
000F54 4F54 19              11      ADD HL,DE
000F55 4F55 010060          10      LD  BC,BANK1_ADR
000F58 4F58 09              11      ADD HL,BC
000F59 4F59 ED4BC8F2        20      LD  BC,(SECSZ)
000F5D 4F5D 09              11      ADD HL,BC
000F5E 4F5E 17               4      RLA
000F5F 4F5F C9              10      RET
                                
       4F60                     GNCL:
000F60 4F60 7A               4      LD  A,D
000F61 4F61 B3               4      OR  E
000F62 4F62 37               4      SCF
000F63 4F63 C8              11      RET Z
000F64 4F64 C5              11      PUSH    BC
000F65 4F65 E5              11      PUSH    HL
000F66 4F66 CD4A4F          17      CALL    NCL3
000F69 4F69 3809            12      JR  C,GNC1
000F6B 4F6B 5E               7      LD  E,(HL)
000F6C 4F6C 23               6      INC HL
000F6D 4F6D 7E               7      LD  A,(HL)
000F6E 4F6E E60F             7      AND 00FH
000F70 4F70 57               4      LD  D,A
000F71 4F71 E1              10      POP HL
000F72 4F72 C1              10      POP BC
000F73 4F73 C9              10      RET
       4F74                     GNC1:
000F74 4F74 7E               7      LD  A,(HL)
000F75 4F75 23               6      INC HL
000F76 4F76 56               7      LD  D,(HL)
000F77 4F77 0604             7      LD  B,4
       4F79                     GNC1L:
000F79 4F79 CB3A             8      SRL D
000F7B 4F7B 1F               4      RRA
000F7C 4F7C 10FB            13      DJNZ    GNC1L
                                
000F7E 4F7E 5F               4      LD  E,A
000F7F 4F7F E1              10      POP HL
000F80 4F80 C1              10      POP BC
000F81 4F81 A7               4      AND A
000F82 4F82 C9              10      RET
                                
       4F83                     CLUST:
000F83 4F83 EB               4      EX  DE,HL
       4F84                     CLUST_HL:
000F84 4F84 2B               6      DEC HL
000F85 4F85 2B               6      DEC HL
000F86 4F86 C5              11      PUSH    BC
000F87 4F87 3AC7F2          13      LD  A,(CLSZ_H)
000F8A 4F8A CD6055          17      CALL    MUL_AHL
                                
000F8D 4F8D CD4850          17      CALL    GET_DIR_POS
000F90 4F90 4F               4      LD  C,A
000F91 4F91 0600             7      LD  B,0
000F93 4F93 09              11      ADD HL,BC
                                
000F94 4F94 ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
000F98 4F98 CB38             8      SRL B
000F9A 4F9A CB19             8      RR  C           ;/2
000F9C 4F9C CB38             8      SRL B
000F9E 4F9E CB19             8      RR  C           ;/4
000FA0 4FA0 CB38             8      SRL B
000FA2 4FA2 CB19             8      RR  C           ;/8
000FA4 4FA4 09              11      ADD HL,BC
                                #if exists USE_MORMAL32K_OR_ASCII16
000FA5 4FA5 7D               4      LD  A,L
000FA6 4FA6 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
000FA9 4FA9 09              11      ADD HL,BC
000FAA 4FAA 3013            12      JR  NC,CLUST2
000FAC 4FAC 4D               4      LD  C,L     ;C=読み出し元
000FAD 4FAD 29              11      ADD HL,HL   ;64KB→32KB
000FAE 4FAE 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
000FAF 4FAF CD3355          17      CALL    GET_DISK_BANK_FDRV
000FB2 4FB2 84               4      ADD A,H
000FB3 4FB3 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
000FB6 4FB6 32C4F2          13      LD  (_BANK),A
000FB9 4FB9 69               4      LD  L,C     ;C=読み出し元
000FBA 4FBA 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
000FBC 4FBC A5               4      AND L
000FBD 4FBD C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB
                                    ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
                                    AND L
                                #endif
       4FBF                     CLUST2:
000FBF 4FBF C660             7      ADD A,high BANK1_ADR
000FC1 4FC1 67               4      LD  H,A
000FC2 4FC2 2E00             7      LD  L,0
000FC4 4FC4 EB               4      EX  DE,HL
000FC5 4FC5 C1              10      POP BC
000FC6 4FC6 C9              10      RET
                                
       4FC7                     ENDCL:
000FC7 4FC7 7A               4      LD  A,D ;END CLUSTER
000FC8 4FC8 FE0F             7      CP  00FH    ;FAT12の最大値
000FCA 4FCA C0              11      RET NZ
000FCB 4FCB 7B               4      LD  A,E
000FCC 4FCC FEF7             7      CP  0F7H
000FCE 4FCE C9              10      RET
                                
       4FCF                     RB_READ:
000FCF 4FCF AF               4      XOR A   ;HLA = HL*128
000FD0 4FD0 CB3C             8      SRL H
000FD2 4FD2 CB1D             8      RR  L
000FD4 4FD4 1F               4      RRA
000FD5 4FD5 32CAF2          13      LD  (RR_LOW),A
000FD8 4FD8 22CBF2          16      LD  (RR_MID),HL
000FDB 4FDB 218000          10      LD  HL,128
                                
000FDE 4FDE CD9F4B          17      CALL    ROM_READ
000FE1 4FE1 C9              10      RET
                                
       4FE2                     GETSEQ:
000FE2 4FE2 FD6E20          19      LD  L,(IY+32)
000FE5 4FE5 FD660C          19      LD  H,(IY+12)
                                
000FE8 4FE8 CB25             8      SLA L
                                
000FEA 4FEA CB3C             8      SRL H
000FEC 4FEC CB1D             8      RR  L
000FEE 4FEE C9              10      RET
                                
       4FEF                     SETSEQ:
000FEF 4FEF F5              11      PUSH    AF
000FF0 4FF0 3ACAF2          13      LD  A,(RR_LOW)
000FF3 4FF3 2ACBF2          16      LD  HL,(RR_MID)
                                
000FF6 4FF6 CD0D50          17      CALL    SSQ1
                                
000FF9 4FF9 29              11      ADD HL,HL
000FFA 4FFA CB3D             8      SRL L
000FFC 4FFC FD7520          19      LD  (IY+32),L
000FFF 4FFF FD740C          19      LD  (IY+12),H
001002 5002 F1              10      POP AF
001003 5003 C9              10      RET
                                
       5004                     GETSIZE:
001004 5004 FD7E10          19      LD  A,(IY+16)
001007 5007 FD6E11          19      LD  L,(IY+17)
00100A 500A FD6612          19      LD  H,(IY+18)
       500D                     SSQ1:
00100D 500D 87               4      ADD A,A
00100E 500E ED6A            15      ADC HL,HL
001010 5010 B7               4      OR  A
001011 5011 C8              11      RET Z
001012 5012 23               6      INC HL
001013 5013 C9              10      RET
                                
       5014                     SET_FCB:
001014 5014 D5              11      PUSH    DE
001015 5015 FDE1            14      POP IY
001017 5017 FD7E1C          19      LD  A,(IY+28)
00101A 501A FEFF             7      CP  0FFH
00101C 501C 200C            12      JR  NZ,POPAF_SCF_FF_RET
00101E 501E E5              11      PUSH    HL
00101F 501F FD6E1A          19      LD  L,(IY+26)
001022 5022 FD661B          19      LD  H,(IY+27)
001025 5025 22CEF2          16      LD  (_CLPS),HL
001028 5028 E1              10      POP HL
001029 5029 C9              10      RET
                                
       502A                     POPAF_SCF_FF_RET:
00102A 502A F1              10      POP AF
00102B 502B 37               4      SCF
00102C 502C 9F               4      SBC A,A
00102D 502D C9              10      RET
                                
       502E                     GET_DIR_DAT:
00102E 502E 2AF7F2          16      LD  HL,(_CDX)
001031 5031 7C               4      LD  A,H
001032 5032 B5               4      OR  L
001033 5033 2032            12      JR  NZ,GET_SUBDIR
001035 5035 CD4850          17      CALL    GET_DIR_POS
001038 5038 C660             7      ADD A,high BANK1_ADR
00103A 503A 2E00             7      LD  L,0
00103C 503C 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                    CALL    CHECK_DIR_PAGE
                                #endif
00103D 503D 3AC5F2          13      LD  A,(_BANK1)
001040 5040 32EFF2          13      LD  (_DIR_BANK),A
                                
001043 5043 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
001046 5046 4F               4      LD  C,A
001047 5047 C9              10      RET
                                
       5048                     GET_DIR_POS:                ;ルートディレクトリ
001048 5048 CD3355          17      CALL    GET_DISK_BANK_FDRV
00104B 504B 32C5F2          13      LD  (_BANK1),A
00104E 504E 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
001051 5051 47               4      LD  B,A
001052 5052 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
001055 5055 4F               4      LD  C,A
001056 5056 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       5059                     GET_DIR_POS1:
001059 5059 81               4      ADD A,C
00105A 505A 10FD            13      DJNZ    GET_DIR_POS1
                                
00105C 505C ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
001060 5060 37               4      SCF     ;無限ループ回避
       5061                     L_MDP:
001061 5061 CB18             8      RR  B   ;->CF
001063 5063 D8              11      RET C
001064 5064 87               4      ADD A,A
001065 5065 18FA            12      JR  L_MDP
                                
       5067                     GET_SUBDIR:             ;サブディレクトリ
001067 5067 CD844F          17      CALL    CLUST_HL
00106A 506A EB               4      EX  DE,HL
00106B 506B 3AC4F2          13      LD  A,(_BANK)
00106E 506E 32EFF2          13      LD  (_DIR_BANK),A
001071 5071 3AC7F2          13      LD  A,(CLSZ_H)
001074 5074 87               4      ADD A,A     ;*2
001075 5075 87               4      ADD A,A     ;*4
001076 5076 87               4      ADD A,A     ;*8
001077 5077 4F               4      LD  C,A
001078 5078 C9              10      RET
                                
       5079                     STATEMENT:
001079 5079 11FD52          10      LD  DE,STR_CHDIR
00107C 507C CDE352          17      CALL    CPPROCNM
00107F 507F 2812            12      JR  Z,_CHDIR
001081 5081 110353          10      LD  DE,STR_CHDRV
001084 5084 CDE352          17      CALL    CPPROCNM
001087 5087 281C            12      JR  Z,_CHDRV
001089 5089 110953          10      LD  DE,STR_RAMDISK
00108C 508C CDE352          17      CALL    CPPROCNM
00108F 508F 2829            12      JR  Z,_RAMDISK
001091 5091 37               4      SCF
001092 5092 C9              10      RET
       5093                     _CHDIR:
001093 5093 7E               7      LD  A,(HL)
001094 5094 FE28             7      CP  '('
001096 5096 37               4      SCF
001097 5097 C0              11      RET NZ
001098 5098 CD4D49          17      CALL    INIT_PARAM
00109B 509B CD404C          17      CALL    FILE_B
00109E 509E CDE550          17      CALL    ROM_CD
0010A1 50A1 D0              11      RET NC
0010A2 50A2 C3F047          10      JP  ERROR_FILE_NOT_FOUND
                                
       50A5                     _CHDRV:
0010A5 50A5 7E               7      LD  A,(HL)
0010A6 50A6 FE28             7      CP  '('
0010A8 50A8 37               4      SCF
0010A9 50A9 C0              11      RET NZ
0010AA 50AA CD4D49          17      CALL    INIT_PARAM
0010AD 50AD E5              11      PUSH    HL
0010AE 50AE CD404C          17      CALL    FILE_B
0010B1 50B1 E1              10      POP HL
0010B2 50B2 23               6      INC HL
0010B3 50B3 3AF9F2          13      LD  A,(FDRV)
0010B6 50B6 3D               4      DEC A
0010B7 50B7 C3B957          10      JP  _SYS0EX1
                                
       50BA                     _RAMDISK:
0010BA 50BA 7E               7      LD  A,(HL)
0010BB 50BB FE28             7      CP  '('
0010BD 50BD 37               4      SCF
0010BE 50BE C0              11      RET NZ
0010BF 50BF 23               6      INC HL
0010C0 50C0 DD212F54        14      LD  IX,FRMQNT
0010C4 50C4 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0010C8 50C8 CD1C00          17      CALL    _CALSLT
0010CB 50CB E5              11      PUSH    HL
0010CC 50CC 110F00          10      LD  DE,15       ;切り上げの為
0010CF 50CF 19              11      ADD HL,DE
0010D0 50D0 7D               4      LD  A,L
0010D1 50D1 0604             7      LD  B,4     ;16で割る
       50D3                     RAMDISK1:
0010D3 50D3 CB3C             8      SRL H   ;/2
0010D5 50D5 1F               4      RRA
0010D6 50D6 10FB            13      DJNZ    RAMDISK1
0010D8 50D8 FEFF             7      CP  0FFH
0010DA 50DA 2001            12      JR  NZ,RAMDISK2
0010DC 50DC 3D               4      DEC A
       50DD                     RAMDISK2:
0010DD 50DD 47               4      LD  B,A
0010DE 50DE CD5959          17      CALL    _SYS68
                                
0010E1 50E1 E1              10      POP HL
0010E2 50E2 23               6      INC HL
0010E3 50E3 AF               4      XOR A
0010E4 50E4 C9              10      RET
                                
       50E5                     ROM_CD:
0010E5 50E5 3AFAF2          13      LD  A,(FNAME)
0010E8 50E8 FE20             7      CP  020H
0010EA 50EA 2835            12      JR  Z,CD1
0010EC 50EC CDD24D          17      CALL    ROM_OPEN
0010EF 50EF D8              11      RET C
                                #if exists USE_MORMAL32K_OR_ASCII16
0010F0 50F0 D5              11      PUSH    DE
0010F1 50F1 2AEDF2          16      LD  HL,(DIRENT1)
0010F4 50F4 110B00          10      LD  DE,0000BH   ;属性(アトリビュート)
0010F7 50F7 19              11      ADD HL,DE
0010F8 50F8 CDFE44          17      CALL    RDSLT_ROM
0010FB 50FB D1              10      POP DE
0010FC 50FC CB67             8      BIT 4,A     ;ディレクトリ
0010FE 50FE CAF047          10      JP  Z,ERROR_FILE_NOT_FOUND
001101 5101 D5              11      PUSH    DE
001102 5102 2AEDF2          16      LD  HL,(DIRENT1)
001105 5105 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
001108 5108 19              11      ADD HL,DE
001109 5109 CDFE44          17      CALL    RDSLT_ROM
00110C 510C 23               6      INC HL
00110D 510D 5F               4      LD  E,A
00110E 510E CDFE44          17      CALL    RDSLT_ROM
001111 5111 57               4      LD  D,A
001112 5112 EB               4      EX  DE,HL
001113 5113 D1              10      POP DE
                                #else
                                    LD  IY,(DIRENT1)
                                    BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    LD  L,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  H,(IY+01BH)
                                #endif
       5114                     CD2:
001114 5114 22EBF2          16      LD  (_CD),HL
001117 5117 2AF5F2          16      LD  HL,(PARAM1)
       511A                     CD_SKIP:
00111A 511A 7E               7      LD  A,(HL)
00111B 511B 23               6      INC HL
00111C 511C FE21             7      CP  021H
00111E 511E 38FA            12      JR  C,CD_SKIP
001120 5120 C9              10      RET
       5121                     CD1:
001121 5121 2AF7F2          16      LD  HL,(_CDX)
001124 5124 18EE            12      JR  CD2
                                
       5126                     GET_BASIC_FCB:
001126 5126 D5              11      PUSH    DE
001127 5127 23               6      INC HL  ;+1
001128 5128 5E               7      LD  E,(HL)  ;FCB[1]
001129 5129 23               6      INC HL  ;+2
00112A 512A 56               7      LD  D,(HL)  ;FCB[2]
00112B 512B 23               6      INC HL  ;+3
00112C 512C ED53EDF2        20      LD  (DIRENT1),DE
                                            ;FCB[3] backup char
001130 5130 23               6      INC HL  ;+4
                                            ;FCB[4]
001131 5131 23               6      INC HL  ;+5
001132 5132 7E               7      LD  A,(HL)  ;FCB[5]
001133 5133 23               6      INC HL  ;+6
001134 5134 32EFF2          13      LD  (_DIR_BANK),A
001137 5137 5E               7      LD  E,(HL)  ;FCB[6]
001138 5138 23               6      INC HL  ;+7
001139 5139 56               7      LD  D,(HL)  ;FCB[7]
00113A 513A 23               6      INC HL  ;+8
00113B 513B ED53CAF2        20      LD  (RR_LOW),DE
00113F 513F 7E               7      LD  A,(HL)  ;FCB[8]
001140 5140 23               6      INC HL  ;+9
001141 5141 32CCF2          13      LD  (RR_HIGH),A
001144 5144 22D4F2          16      LD  (_DTA),HL   ;FCB[9]
001147 5147 D1              10      POP DE
001148 5148 C9              10      RET
                                
       5149                     SET_BASIC_FCB:
001149 5149 E5              11      PUSH    HL
00114A 514A 2A64F8          16      LD  HL,(PTRFIL)
00114D 514D 23               6      INC HL  ;+1
00114E 514E D5              11      PUSH    DE
00114F 514F ED5BEDF2        20      LD  DE,(DIRENT1)
001153 5153 73               7      LD  (HL),E  ;FCB[1]
001154 5154 23               6      INC HL  ;+2
001155 5155 72               7      LD  (HL),D  ;FCB[2]
001156 5156 23               6      INC HL  ;+3
001157 5157 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
001158 5158 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
001159 5159 23               6      INC HL  ;+5
00115A 515A 3AEFF2          13      LD  A,(_DIR_BANK)
00115D 515D 77               7      LD  (HL),A  ;FCB[5]
00115E 515E 23               6      INC HL  ;+6
00115F 515F ED5BCAF2        20      LD  DE,(RR_LOW)
001163 5163 73               7      LD  (HL),E  ;FCB[6]
001164 5164 23               6      INC HL  ;+7
001165 5165 72               7      LD  (HL),D  ;FCB[7]
001166 5166 23               6      INC HL  ;+8
001167 5167 3ACCF2          13      LD  A,(RR_HIGH)
00116A 516A 77               7      LD  (HL),A  ;FCB[8]
00116B 516B D1              10      POP DE
00116C 516C E1              10      POP HL
00116D 516D C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_18:BACKUP
                                ;in
                                ;   C : backup charactor
                                ;   HL: FBC pointer
                                ;out
       516E                     DEVICE_18_BACKUP:
00116E 516E D5              11      PUSH    DE
00116F 516F E5              11      PUSH    HL
001170 5170 110300          10      LD  DE,3
001173 5173 19              11      ADD HL,DE
001174 5174 71               7      LD  (HL),C
001175 5175 E1              10      POP HL
001176 5176 D1              10      POP DE
001177 5177 C9              10      RET
                                
       5178                     DEVICE_CHECK:
001178 5178 3A8AFD          13      LD  A,(PROCNM+1)
00117B 517B B7               4      OR  A
00117C 517C C8              11      RET Z
00117D 517D 111153          10      LD  DE,STR_ROM
001180 5180 CDE352          17      CALL    CPPROCNM
001183 5183 2802            12      JR  Z,DEVICE_OK
001185 5185 37               4      SCF
001186 5186 C9              10      RET
       5187                     DEVICE_OK:
001187 5187 AF               4      XOR A
001188 5188 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファ
                                
       5189                     DEVICE_0_OPEN:
001189 5189 7B               4      LD  A,E
00118A 518A FE02             7      CP  2       ;FOR OUTPUT
00118C 518C 281B            12      JR  Z,OPEN2
00118E 518E D5              11      PUSH    DE
00118F 518F E5              11      push    hl
                                ;
001190 5190 3E01             7      LD  A,1     ;ドライブA
001192 5192 32F9F2          13      LD  (FDRV),A
001195 5195 2166F8          10      LD  HL,FILNAM
001198 5198 11FAF2          10      LD  DE,FNAME
00119B 519B 010B00          10      LD  BC,8+3
00119E 519E CD6D59          17      CALL    INIT_FILE1
0011A1 51A1 CDD24D          17      CALL    ROM_OPEN
0011A4 51A4 DAF047          10      JP  C,ERROR_FILE_NOT_FOUND
0011A7 51A7 E1              10      pop hl
0011A8 51A8 D1              10      POP DE
       51A9                     OPEN2:
0011A9 51A9 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
0011AC 51AC 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
0011AD 51AD AF               4      XOR A
0011AE 51AE 32F1F2          13      LD  (LEFTX),A
0011B1 51B1 CD4951          17      CALL    SET_BASIC_FCB
0011B4 51B4 7B               4      ld  a,e
0011B5 51B5 FE08             7      cp  8
0011B7 51B7 3F               4      ccf
0011B8 51B8 C9              10      ret
                                
       51B9                     DEVICE_2_CLOSE:
0011B9 51B9 AF               4      XOR A
                                ;   LD  (HL),A
0011BA 51BA 6F               4      LD  L,A
0011BB 51BB 67               4      LD  H,A
0011BC 51BC 2264F8          16      LD  (PTRFIL),HL
0011BF 51BF C9              10      RET
                                
       51C0                     DEVICE_ENTRY:
0011C0 51C0 FE08             7      CP  8
0011C2 51C2 2826            12      JR  Z,DEVICE_8_SIN
0011C4 51C4 3C               4      INC A
0011C5 51C5 28B1            12      JR  Z,DEVICE_CHECK:
0011C7 51C7 3D               4      DEC A
0011C8 51C8 28BF            12      JR  Z,DEVICE_0_OPEN
0011CA 51CA FE0E             7      CP  14
0011CC 51CC 2860            12      JR  Z,DEVICE_14_EOF
0011CE 51CE FE04             7      CP  4
0011D0 51D0 2834            12      JR  Z,DEVICE_4_RANDOM
0011D2 51D2 FE0A             7      CP  10
0011D4 51D4 2850            12      JR  Z,DEVICE_10_LOC
0011D6 51D6 FE0C             7      CP  12
0011D8 51D8 2878            12      JR  Z,DEVICE_12_LOF
0011DA 51DA FE02             7      CP  2
0011DC 51DC 2890            12      JR  Z,DEVICE_18_BACKUP
0011DE 51DE FE02             7      CP  2
0011E0 51E0 28D7            12      JR  Z,DEVICE_2_CLOSE
0011E2 51E2 FE06             7      CP  6
0011E4 51E4 2802            12      JR  Z,DEVICE_6_SOUT
0011E6 51E6 37               4      SCF
0011E7 51E7 C9              10      RET
                                
       51E8                     DEVICE_6_SOUT:
0011E8 51E8 AF               4      XOR A
0011E9 51E9 C9              10      RET
                                
       51EA                     DEVICE_8_SIN:
0011EA 51EA CD2651          17      CALL    GET_BASIC_FCB
0011ED 51ED 210100          10      LD  HL,1
0011F0 51F0 CD9F4B          17      CALL    ROM_READ
0011F3 51F3 7C               4      LD  A,H
0011F4 51F4 B5               4      OR  L
0011F5 51F5 280D            12      JR  Z,CCF_RET
0011F7 51F7 2AD4F2          16      LD  HL,(_DTA)
0011FA 51FA 7E               7      LD  A,(HL)
0011FB 51FB F5              11      PUSH    AF
0011FC 51FC CD4951          17      CALL    SET_BASIC_FCB
0011FF 51FF F1              10      POP AF
001200 5200 FE0A             7      CP  00AH
001202 5202 C8              11      RET Z   ;ZF=separate
                                ;   CP  01AH
                                ;   JR  Z,SCF_RET
001203 5203 37               4      SCF     ;
       5204                     CCF_RET:
001204 5204 3F               4      CCF     ;ZF=0 CF=0にしたい
001205 5205 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_4:RANDOM
                                ;in
                                ;   A : 4
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
       5206                     DEVICE_4_RANDOM:
001206 5206 D5              11      PUSH    DE
001207 5207 CD2651          17      CALL    GET_BASIC_FCB
00120A 520A DDE5            15      PUSH    IX
00120C 520C DD218A2F        14      LD  IX,FRCINT
001210 5210 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001214 5214 CDB0F2          17      CALL    CAL_MP
001217 5217 DDE1            14      POP IX
001219 5219 2AF8F7          16      LD  HL,(DACDAT)
00121C 521C 22CAF2          16      LD  (RR_LOW),HL
00121F 521F AF               4      XOR A
001220 5220 CD4951          17      CALL    SET_BASIC_FCB
001223 5223 D1              10      POP DE
001224 5224 AF               4      XOR A
001225 5225 C9              10      RET
                                
                                ;FUNC_10:LOC
                                ;in
                                ;   A : 10
                                ;out
                                ;   DAC    : value of received bytes
                                ;   VALTYP : DAC type
       5226                     DEVICE_10_LOC:
001226 5226 CD2651          17      CALL    GET_BASIC_FCB
001229 5229 2ACAF2          16      LD  HL,(RR_LOW)
00122C 522C 1844            12      JR  RETURN_TYPE8_AHL
                                
                                ;--------------------------------------
                                ;FUNC_14:EOF
                                ;in
                                ;   A : 14
                                ;out
                                ;   DAC    : value of EOF value (EOF=-1)
                                ;   VALTYP : DAC type
       522E                     DEVICE_14_EOF:
00122E 522E CD2651          17      CALL    GET_BASIC_FCB
001231 5231 CD534E          17      CALL    RBX1
001234 5234 3810            12      JR  C,DEVICE_14_EOF1
001236 5236 210100          10      LD  HL,1
001239 5239 CD9F4B          17      CALL    ROM_READ
00123C 523C 2AD4F2          16      LD  HL,(_DTA)
00123F 523F 7E               7      LD  A,(HL)
001240 5240 FE1A             7      CP  01AH
001242 5242 37               4      SCF
001243 5243 2801            12      JR  Z,DEVICE_14_EOF1
001245 5245 3F               4      CCF
       5246                     DEVICE_14_EOF1:
001246 5246 9F               4      SBC A,A
001247 5247 6F               4      LD  L,A
001248 5248 67               4      LD  H,A
       5249                     return_type2_hl:
001249 5249 22F8F7          16      ld  (DACDAT),hl
00124C 524C 3E02             7      ld  a,2
00124E 524E 3263F6          13      ld  (VALTYP),a
001251 5251 C9              10      ret
                                
                                ;--------------------------------------
                                ;FUNC_16:FPOS
                                ;in
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
                                ;   illegal function call
                                
                                ;--------------------------------------
                                ;FUNC_12:LOF
                                ;in
                                ;   A : 12
                                ;out
                                ;   DAC    : value of LOC+RSIQLN
                                ;   VALTYP : DAC type
       5252                     DEVICE_12_LOF:
001252 5252 CD2651          17      CALL    GET_BASIC_FCB
                                
001255 5255 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
001258 5258 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
00125B 525B D5              11      PUSH    DE
00125C 525C 2AEDF2          16      LD  HL,(DIRENT1)
00125F 525F 111C00          10      LD  DE,0001CH
001262 5262 19              11      ADD HL,DE
001263 5263 CDFE44          17      CALL    RDSLT_ROM
001266 5266 23               6      INC HL
001267 5267 5F               4      LD  E,A
001268 5268 CDFE44          17      CALL    RDSLT_ROM
00126B 526B 23               6      INC HL
00126C 526C 57               4      LD  D,A
00126D 526D CDFE44          17      CALL    RDSLT_ROM
001270 5270 EB               4      EX  DE,HL       ;AHL=File size
001271 5271 D1              10      POP DE
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  L,(IY+01CH) ;AHL=File size
                                    LD  H,(IY+01DH)
                                    LD  A,(IY+01EH)
                                #endif
       5272                     RETURN_TYPE8_AHL:
001272 5272 B7               4      OR  A
001273 5273 2004            12      JR  NZ,RT8AHL1
001275 5275 CB7C             8      BIT 7,H
001277 5277 28D0            12      JR  Z,return_type2_hl
       5279                     RT8AHL1:
001279 5279 E5              11      PUSH    HL
00127A 527A 29              11      ADD HL,HL
00127B 527B 8F               4      ADC A,A
00127C 527C 32F8F7          13      LD  (DACDAT),A
00127F 527F 3E00             7      LD  A,0
001281 5281 8F               4      ADC A,A
001282 5282 32F9F7          13      LD  (DACDAT+1),A
                                
001285 5285 3E02             7      LD  A,2
001287 5287 3263F6          13      LD  (VALTYP),A
00128A 528A DD213A30        14      LD  IX,FRCDBL
00128E 528E FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001292 5292 CDB0F2          17      CALL    CAL_MP
                                
001295 5295 21DB52          10      LD  HL,DBL32768
001298 5298 1147F8          10      LD  DE,ARG
00129B 529B 010800          10      LD  BC,8
00129E 529E EDB0                    LDIR
                                
0012A0 52A0 DD21E627        14      LD  IX,DECMUL
0012A4 52A4 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0012A8 52A8 CDB0F2          17      CALL    CAL_MP
                                
0012AB 52AB 21F6F7          10      LD  HL,DAC
0012AE 52AE 1147F8          10      LD  DE,ARG
0012B1 52B1 010800          10      LD  BC,8
0012B4 52B4 EDB0                    LDIR
                                
0012B6 52B6 E1              10      POP HL
0012B7 52B7 22F8F7          16      LD  (DACDAT),HL
                                
0012BA 52BA 3E02             7      LD  A,2
0012BC 52BC 3263F6          13      LD  (VALTYP),A
0012BF 52BF DD213A30        14      LD  IX,FRCDBL
0012C3 52C3 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0012C7 52C7 CDB0F2          17      CALL    CAL_MP
                                
0012CA 52CA DD219A26        14      LD  IX,DECADD
0012CE 52CE FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0012D2 52D2 CDB0F2          17      CALL    CAL_MP
                                
0012D5 52D5 3E08             7      LD  A,8
0012D7 52D7 3263F6          13      LD  (VALTYP),A
0012DA 52DA C9              10      RET
                                
       52DB                     DBL32768:
0012DB 52DB 4532768000000000        DB  045H,032H,076H,080H,0,0,0,0
                                
       52E3                     CPPROCNM:
0012E3 52E3 E5              11      PUSH    HL
0012E4 52E4 2189FD          10      LD  HL,PROCNM
       52E7                     CPPROCNM1:
0012E7 52E7 1A               7      LD  A,(DE)
0012E8 52E8 13               6      INC DE
0012E9 52E9 BE               7      CP  (HL)
0012EA 52EA 23               6      INC HL
0012EB 52EB 2003            12      JR  NZ,CPPROCNM2
0012ED 52ED B7               4      OR  A
0012EE 52EE 20F7            12      JR  NZ,CPPROCNM1
       52F0                     CPPROCNM2:
0012F0 52F0 E1              10      POP HL
0012F1 52F1 C9              10      RET
                                
       52F2                     WILDCARD:
0012F2 52F2 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       52FD                     STR_CHDIR:
0012FD 52FD 434844495200            DB  "CHDIR",0
       5303                     STR_CHDRV:
001303 5303 434844525600            DB  "CHDRV",0
       5309                     STR_RAMDISK:
001309 5309 52414D4449534B00        DB  "RAMDISK",0
       5311                     STR_ROM:
001311 5311 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       5315                     ERROR_WRITE_PROTECTED:
001315 5315 3E00             7      LD  A,0     ;Write protected
001317 5317 C9              10      RET
       5318                     ERROR_NOT_READY:
001318 5318 F1              10      POP AF
001319 5319 37               4      SCF
00131A 531A 3E02             7      LD  A,2     ;Not ready
00131C 531C C9              10      RET
       531D                     DISKIO:
00131D 531D 38F6            12      JR  C,ERROR_WRITE_PROTECTED
00131F 531F 48               4      LD  C,B
001320 5320 CD3D55          17      CALL    GET_DISK_BANK
001323 5323 F5              11      PUSH    AF
001324 5324 3AC9F2          13      LD  A,(SECSZ_H)
001327 5327 B7               4      OR  A
001328 5328 28EE            12      JR  Z,ERROR_NOT_READY
00132A 532A F1              10      POP AF
       532B                     SETMAP1:
00132B 532B E5              11      PUSH    HL
       532C                     DISKIO1:
00132C 532C C5              11      PUSH    BC      ;B=残りのセクタ数
00132D 532D D5              11      PUSH    DE      ;DE=セクタ番号
00132E 532E F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
00132F 532F EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
001330 5330 F5              11      PUSH    AF
001331 5331 3AC9F2          13      LD  A,(SECSZ_H)
001334 5334 CD6055          17      CALL    MUL_AHL
001337 5337 F1              10      POP AF
                                #if exists USE_MORMAL32K_OR_ASCII16
001338 5338 7D               4      LD  A,L
001339 5339 C5              11      PUSH    BC
00133A 533A 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
00133D 533D 09              11      ADD HL,BC
00133E 533E C1              10      POP BC
00133F 533F 3013            12      JR  NC,DISKIO2
001341 5341 4D               4      LD  C,L     ;C=読み出し元
001342 5342 29              11      ADD HL,HL   ;64KB→32KB
001343 5343 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
001344 5344 CD3355          17      CALL    GET_DISK_BANK_FDRV
001347 5347 84               4      ADD A,H
001348 5348 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
00134B 534B 32C4F2          13      LD  (_BANK),A
00134E 534E 69               4      LD  L,C     ;C=読み出し元
00134F 534F 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
001351 5351 A5               4      AND L
001352 5352 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL       ;64KB→32KB
                                    ADD HL,HL       ;32KB→16KB
                                    ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  A,C     ;C=読み出し元
                                    AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       5354                     DISKIO2:
001354 5354 C660             7      ADD A,high BANK1_ADR
001356 5356 67               4      LD  H,A
001357 5357 ED4BC8F2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
00135B 535B 69               4      LD  L,C     ;C=0
00135C 535C CD0D45          17      CALL    ROM_LDIR
00135F 535F EB               4      EX  DE,HL
001360 5360 F1              10      POP AF
001361 5361 D1              10      POP DE
001362 5362 13               6      INC DE
001363 5363 C1              10      POP BC
001364 5364 10C6            13      DJNZ    DISKIO1
001366 5366 41               4      LD  B,C
                                
001367 5367 E1              10      POP HL
001368 5368 AF               4      XOR A
001369 5369 C9              10      RET
                                
       536A                     DSKCHG:
00136A 536A CDA353          17      CALL    IS_BPB
00136D 536D 3824            12      JR  C,NOTREADY
00136F 536F 3A23FB          13      LD  A,(DRVTBL+2)
001372 5372 B7               4      OR  A
001373 5373 201A            12      JR  NZ,DSKCHG1
001375 5375 3A21FB          13      LD  A,(DRVTBL)
001378 5378 FE02             7      CP  2
00137A 537A 2013            12      JR  NZ,DSKCHG1
00137C 537C CDA353          17      CALL    IS_BPB
00137F 537F 300E            12      JR  NC,DSKCHG1
001381 5381 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
001383 5383 3221FB          13      LD  (DRVTBL),A
001386 5386 3223FB          13      LD  (DRVTBL+2),A
001389 5389 3A48F3          13      LD  A,(MASTERS)
00138C 538C 3224FB          13      LD  (DRVTBL+3),A
       538F                     DSKCHG1:
00138F 538F AF               4      XOR A
001390 5390 0601             7      LD  B,1
001392 5392 C9              10      RET
       5393                     NOTREADY:
001393 5393 3E02             7      LD  A,2
001395 5395 37               4      SCF
001396 5396 C9              10      RET
                                
       5397                     NO_BPB:
001397 5397 E1              10      POP HL
001398 5398 23               6      INC HL
001399 5399 116655          10      LD  DE,DPB2DD
00139C 539C 011200          10      LD  BC,DPB2DD_E-DPB2DD
00139F 539F EDB0                    LDIR
0013A1 53A1 AF               4      XOR A
0013A2 53A2 C9              10      RET
                                
       53A3                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
0013A3 53A3 CD3D55          17      CALL    GET_DISK_BANK
                                
0013A6 53A6 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
0013A9 53A9 FE01             7      CP  1
0013AB 53AB D8              11      RET C
                                
0013AC 53AC 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
0013AF 53AF C6FF             7      ADD A,0FFH
0013B1 53B1 D8              11      RET C
                                
0013B2 53B2 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       53B5                     IS_BPB1:
0013B5 53B5 FE01             7      CP  1
0013B7 53B7 C8              11      RET Z
0013B8 53B8 FE02             7      CP  2
0013BA 53BA C8              11      RET Z
0013BB 53BB FE04             7      CP  4
0013BD 53BD C8              11      RET Z
0013BE 53BE 37               4      SCF
0013BF 53BF C9              10      RET
                                
       53C0                     GETDPB:
0013C0 53C0 E5              11      PUSH    HL
0013C1 53C1 CD3D55          17      CALL    GET_DISK_BANK
                                
0013C4 53C4 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
0013C7 53C7 B7               4      OR  A
0013C8 53C8 28CD            12      JR  Z,NO_BPB
0013CA 53CA DDE1            14      POP IX
0013CC 53CC DD7701          19      LD  (IX+1),A        ;MEDIA
                                
0013CF 53CF 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
0013D2 53D2 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
0013D5 53D5 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
0013D8 53D8 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
0013DB 53DB 87               4      ADD A,A
0013DC 53DC 87               4      ADD A,A
0013DD 53DD 87               4      ADD A,A
0013DE 53DE 3D               4      DEC A
0013DF 53DF DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
0013E2 53E2 06FF             7      LD  B,-1
0013E4 53E4 A7               4      AND A           ;無限ループ阻止
       53E5                     GETDPB1:
0013E5 53E5 04               4      INC B
0013E6 53E6 1F               4      RRA
0013E7 53E7 38FC            12      JR  C,GETDPB1
0013E9 53E9 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
0013EC 53EC 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0013EF 53EF 3D               4      DEC A
0013F0 53F0 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
0013F3 53F3 A7               4      AND A           ;無限ループ阻止
0013F4 53F4 06FF             7      LD  B,-1
       53F6                     GETDPB2:
0013F6 53F6 04               4      INC B
0013F7 53F7 1F               4      RRA
0013F8 53F8 38FC            12      JR  C,GETDPB2
0013FA 53FA 04               4      INC B
0013FB 53FB DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
0013FE 53FE 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt
001401 5401 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
001404 5404 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
001407 5407 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
00140A 540A DD770A          19      LD  (IX+10),A       ;FATCNT
                                
00140D 540D 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
001410 5410 DD770B          19      LD  (IX+11),A       ;MAXENT
                                
001413 5413 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16
001417 5417 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
00141A 541A DD460A          19      LD  B,(IX+10)       ;FATCNT
00141D 541D 210000          10      LD  HL,0
       5420                     GETDPB3:
001420 5420 19              11      ADD HL,DE
001421 5421 10FD            13      DJNZ    GETDPB3
       5423                     GETDPB4:
001423 5423 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
001426 5426 DD5609          19      LD  D,(IX+9)        ;FIRFAT
001429 5429 19              11      ADD HL,DE
00142A 542A DD7511          19      LD  (IX+17),L       ;FIRDIR
00142D 542D DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
001430 5430 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001433 5433 87               4      ADD A,A
001434 5434 87               4      ADD A,A
001435 5435 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       5438                     GETDPB5:
001438 5438 CB3B             8      SRL E
00143A 543A 1F               4      RRA
00143B 543B 30FB            12      JR  NC,GETDPB5
00143D 543D 1600             7      LD  D,0
00143F 543F 19              11      ADD HL,DE
001440 5440 DD750C          19      LD  (IX+12),L       ;FIRREC
001443 5443 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001446 5446 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16
                                
001449 5449 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
00144C 544C DD560D          19      LD  D,(IX+13)       ;FIRREC
00144F 544F A7               4      AND A
001450 5450 ED52            15      SBC HL,DE
                                
001452 5452 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
001455 5455 3C               4      INC A
001456 5456 37               4      SCF             ;無限ループ阻止
       5457                     GETDPB6:
001457 5457 1F               4      RRA
001458 5458 3806            12      JR  C,GETDPB7
00145A 545A CB3C             8      SRL H
00145C 545C CB1D             8      RR  L
00145E 545E 18F7            12      JR  GETDPB6
       5460                     GETDPB7:
001460 5460 23               6      INC HL
001461 5461 DD750E          19      LD  (IX+14),L       ;MAXCLUS
001464 5464 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       5467                     GETDPBD1:
001467 5467 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
00146A 546A E6FC             7      AND 0FCH
00146C 546C C8              11      RET Z
                                
00146D 546D DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
001471 5471 37               4      SCF
001472 5472 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
001476 5476 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
001479 5479 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
00147D 547D DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
001481 5481 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
001485 5485 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
001489 5489 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
00148D 548D DDCB1126        23      SLA (IX+17)         ;FIRDIR
001491 5491 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
001495 5495 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
001498 5498 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
00149B 549B DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
00149E 549E 87               4      ADD A,A
00149F 549F 87               4      ADD A,A
0014A0 54A0 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       54A3                     GETDPBD5:
0014A3 54A3 CB3B             8      SRL E
0014A5 54A5 1F               4      RRA
0014A6 54A6 30FB            12      JR  NC,GETDPBD5
0014A8 54A8 1600             7      LD  D,0
0014AA 54AA 19              11      ADD HL,DE
0014AB 54AB DD750C          19      LD  (IX+12),L       ;FIRREC
0014AE 54AE DD740D          19      LD  (IX+13),H       ;FIRREC
                                
0014B1 54B1 18B4            12      JR  GETDPBD1
                                
       54B3                     CHOICE:
0014B3 54B3 210000          10      LD  HL,0
0014B6 54B6 C9              10      RET
                                
       54B7                     DSKFMT:
0014B7 54B7 AF               4      XOR A
0014B8 54B8 37               4      SCF
       54B9                     DSKSTP:
0014B9 54B9 C9              10      RET
                                
       54BA                     BASENT:
0014BA 54BA 3E                      DB  03EH
0014BB 54BB F7              12      RST 30H
0014BC 54BC 32DBFD          13      LD  (H_PINL),A
0014BF 54BF 3A48F3          13      LD  A,(MASTERS)
0014C2 54C2 32DCFD          13      LD  (H_PINL+1),A
0014C5 54C5 21E154          10      LD  HL,BOOT_BASIC
0014C8 54C8 22DDFD          16      LD  (H_PINL+2),HL
0014CB 54CB 3E                      DB  03EH
0014CC 54CC C9              10      RET
0014CD 54CD 32DFFD          13      LD  (H_PINL+4),A
                                
                                #if exists _RAM64K
0014D0 54D0 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
0014D3 54D3 CD095B          17      CALL    ENASLT_00H
                                #endif
                                    ;BASICを起動する
0014D6 54D6 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0014DA 54DA DD21177D        14      LD  IX,ST_BAS   ;continue start of MSX-BASIC without executing BASIC programs in ROM
0014DE 54DE C35901          10      JP  CALBAS
                                
       54E1                     BOOT_BASIC:
0014E1 54E1 3E                      DB  03EH
0014E2 54E2 C9              10      RET
0014E3 54E3 32DBFD          13      LD  (H_PINL),A
                                
0014E6 54E6 2A74F6          16      LD  HL,(STKTOP)
0014E9 54E9 3A40F3          13      LD  A,(REBOOT)
0014EC 54EC C6FF             7      ADD A,0FFH
0014EE 54EE 3811            12      JR  C,REBOOT1
0014F0 54F0 217855          10      LD  HL,AUTOEXEC
0014F3 54F3 11F9F2          10      LD  DE,FDRV
0014F6 54F6 010C00          10      LD  BC,1+8+3
0014F9 54F9 EDB0                    LDIR
0014FB 54FB CDD24D          17      CALL    ROM_OPEN
0014FE 54FE D43A47          17      CALL    NC,ROM_LOAD1
       5501                     REBOOT1:
001501 5501 218F55          10      LD  HL,DELOK
001504 5504 CDD344          17      CALL    MSX
001507 5507 218455          10      LD  HL,CMD_RUN
00150A 550A 111FF4          10      LD  DE,KBUF
00150D 550D 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
001510 5510 D5              11      PUSH    DE
001511 5511 EDB0                    LDIR
001513 5513 3004            12      JR  NC,REBOOT2
001515 5515 AF               4      XOR A
001516 5516 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       5519                     REBOOT2:
001519 5519 E1              10      POP HL
00151A 551A FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00151E 551E DD210146        14      LD  IX,NEWSTT
001522 5522 C31C00          10      JP  _CALSLT
                                
       5525                     GETSLT:
001525 5525 3A22FB          13      LD  A,(DRVTBL+1)
001528 5528 C9              10      RET
                                
       5529                     GET_DISK_BANK_H:
001529 5529 3AF0F2          13      LD  A,(_LVECTOR)
00152C 552C E680             7      AND 080H
00152E 552E 87               4      ADD A,A
00152F 552F 3811            12      JR  C,SET_DISK_BANK_A
001531 5531 1816            12      JR  SET_DISK_BANK
       5533                     GET_DISK_BANK_FDRV:
001533 5533 3AF9F2          13      LD  A,(FDRV)
001536 5536 D601             7      SUB 1
001538 5538 3003            12      JR  NC,GET_DISK_BANK
00153A 553A 3AEAF2          13      LD  A,(_DVSW)
       553D                     GET_DISK_BANK:
00153D 553D FE07             7      CP  7       ;H:
00153F 553F 28E8            12      JR  Z,GET_DISK_BANK_H
001541 5541 B7               4      OR  A       ;A=DRIVE
       5542                     SET_DISK_BANK_A:
001542 5542 3E01             7      LD  A,DISK_BANK
001544 5544 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
001546 5546 3AE9F2          13      LD  A,(B_DRIVE)
                                #endif
       5549                     SET_DISK_BANK:
                                #if exists USE_MORMAL32K_OR_ASCII16
001549 5549 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
00154C 554C F5              11      PUSH    AF
00154D 554D E5              11      PUSH    HL
00154E 554E 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec
001551 5551 22C8F2          16      LD  (SECSZ),HL
001554 5554 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
001557 5557 CD6055          17      CALL    MUL_AHL
00155A 555A 22C6F2          16      LD  (CLSZ),HL
00155D 555D E1              10      POP HL
00155E 555E F1              10      POP AF
00155F 555F C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       5560                     MUL_AHL:
001560 5560 37               4      SCF     ;無限ループ回避
       5561                     MUL_AHL1:
001561 5561 1F               4      RRA     ;->CF
001562 5562 D8              11      RET C
001563 5563 29              11      ADD HL,HL
001564 5564 18FB            12      JR  MUL_AHL1
                                
       5566                     DPB2DD:
001566 5566 F9                      DB  0F9H    ;MEDIA
001567 5567 0002                    DW  00200H  ;SECSIZ
001569 5569 0F                      DB  00FH    ;DIRMSK
00156A 556A 04                      DB  004H    ;DIRSHFT
00156B 556B 01                      DB  001H    ;CLUSMSK
00156C 556C 02                      DB  002H    ;CLUSSHFT
00156D 556D 0100                    DW  00001H  ;FIRFAT
00156F 556F 02                      DB  002H    ;FATCNT
001570 5570 70                      DB  070H    ;MAXENT
001571 5571 0E00                    DW  0000EH  ;FIRREC
001573 5573 CA02                    DW  002CAH  ;MAXCLUS
001575 5575 03                      DB  003H    ;FATSIZ
001576 5576 0700                    DW  0007H   ;FIRDIR
       5578                     DPB2DD_E:
                                
       5578                     AUTOEXEC:
001578 5578 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       5584                     CMD_RUN:
001584 5584 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
00158A 558A 80EF                    DW  NEW_HIMEM
       558C                     CMD_CLEAR_E:
00158C 558C 3A8A00                  DB  03AH,08AH,0         ;RUN
       558F                     CMD_RUN_E:
       558F                     DELOK:
00158F 558F 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       5593                     _ERROR:
001593 5593 AF               4      XOR A
001594 5594 47               4      LD  B,A
001595 5595 C9              10      RET
                                
       5596                     ROM_BDOS:
001596 5596 E5              11      PUSH    HL
001597 5597 79               4      LD  A,C
001598 5598 87               4      ADD A,A
001599 5599 38F8            12      JR  C,_ERROR
00159B 559B 6F               4      LD  L,A
00159C 559C 265A             7      LD  H,high STABLE
00159E 559E 7E               7      LD  A,(HL)
00159F 559F 2C               4      INC L
0015A0 55A0 66               7      LD  H,(HL)
0015A1 55A1 6F               4      LD  L,A
0015A2 55A2 E3              19      EX  (SP),HL
0015A3 55A3 79               4      LD  A,C
0015A4 55A4 C9              10      RET
                                
       55A5                     _PRINT:
       55A5                     PRINT:
0015A5 55A5 7B               4      LD  A,E
0015A6 55A6 1803            12      JR  MSG_A
                                
       55A8                     _SYS01:     ;(BDOS)コンソール入力
0015A8 55A8 CD2D56          17      CALL    _SYS07
       55AB                     MSG_A:
0015AB 55AB FE03             7      CP  3
0015AD 55AD 2814            12      JR  Z,MSG_BR
       55AF                     MSGA1:
0015AF 55AF F5              11      PUSH    AF
0015B0 55B0 C5              11      PUSH    BC
0015B1 55B1 D5              11      PUSH    DE
0015B2 55B2 E5              11      PUSH    HL
0015B3 55B3 DDE5            15      PUSH    IX
0015B5 55B5 DD21A200        14      LD  IX,CHPUT
0015B9 55B9 CDB444          17      CALL    CALSLT_R
0015BC 55BC DDE1            14      POP IX
0015BE 55BE E1              10      POP HL
0015BF 55BF D1              10      POP DE
0015C0 55C0 C1              10      POP BC
       55C1                     MSGA2:
0015C1 55C1 F1              10      POP AF
0015C2 55C2 C9              10      RET
       55C3                     MSG_BR:
0015C3 55C3 F5              11      PUSH    AF
0015C4 55C4 3ADDF3          13      LD  A,(CSRX)
0015C7 55C7 FE02             7      CP  2
0015C9 55C9 38F6            12      JR  C,MSGA2
0015CB 55CB F1              10      POP AF
       55CC                     MSG_CR:
0015CC 55CC F5              11      PUSH    AF
0015CD 55CD 3E0D             7      LD  A,00DH
0015CF 55CF CDAF55          17      CALL    MSGA1
0015D2 55D2 3E0A             7      LD  A,00AH
0015D4 55D4 CDAF55          17      CALL    MSGA1
0015D7 55D7 F1              10      POP AF
0015D8 55D8 C9              10      RET
                                
       55D9                     _SYS02:     ;(BDOS)コンソール出力
0015D9 55D9 CDF455          17      CALL    BREAK
0015DC 55DC 1805            12      JR  PRINTX
                                
       55DE                     _SYS06:     ;(BDOS)コンソール直接入出力
0015DE 55DE 7B               4      LD  A,E
0015DF 55DF 3C               4      INC A
0015E0 55E0 CA4156          10      JP  Z,_INKEY
       55E3                     PRINTX:
0015E3 55E3 C3A555          10      JP  _PRINT
                                
       55E6                     _SYS08:     ;(BDOS)エコーなしコンソール入力
0015E6 55E6 CD2D56          17      CALL    _SYS07
0015E9 55E9 FE03             7      CP  3
0015EB 55EB CCF455          17      CALL    Z,_BREAK
0015EE 55EE FE13             7      CP  013H        ;CTRL+S
0015F0 55F0 C0              11      RET NZ
       55F1                     PAUSE:
0015F1 55F1 CD0B56          17      CALL    KEYBC
                                
       55F4                     _BREAK:
       55F4                     BREAK:
0015F4 55F4 F5              11      PUSH    AF
0015F5 55F5 C5              11      PUSH    BC
0015F6 55F6 D5              11      PUSH    DE
0015F7 55F7 E5              11      PUSH    HL
0015F8 55F8 DDE5            15      PUSH    IX
0015FA 55FA DD21B700        14      LD  IX,BREAKX
0015FE 55FE CDB444          17      CALL    CALSLT_R
001601 5601 DDE1            14      POP IX
001603 5603 E1              10      POP HL
001604 5604 D1              10      POP DE
001605 5605 C1              10      POP BC
001606 5606 DCF455          17      CALL    C,_BREAK
001609 5609 F1              10      POP AF
00160A 560A C9              10      RET
       560B                     KEYBC:
00160B 560B F5              11      PUSH    AF
00160C 560C C5              11      PUSH    BC
00160D 560D D5              11      PUSH    DE
00160E 560E E5              11      PUSH    HL
00160F 560F DDE5            15      PUSH    IX
001611 5611 DD215601        14      LD  IX,KILBUF
001615 5615 CDB444          17      CALL    CALSLT_R
001618 5618 DDE1            14      POP IX
00161A 561A E1              10      POP HL
00161B 561B D1              10      POP DE
00161C 561C C1              10      POP BC
00161D 561D F1              10      POP AF
00161E 561E C9              10      RET
                                
       561F                     _SYS09:     ;(BDOS)文字列出力
00161F 561F D5              11      PUSH    DE
       5620                     _SX09:
001620 5620 1A               7      LD  A,(DE)
001621 5621 13               6      INC DE
001622 5622 FE24             7      CP  '$'
001624 5624 2805            12      JR  Z,POPDE_RET
001626 5626 CDAB55          17      CALL    MSG_A
001629 5629 18F5            12      JR  _SX09
       562B                     POPDE_RET:
00162B 562B D1              10      POP DE
00162C 562C C9              10      RET
                                
       562D                     _SYS07:
       562D                     FLGET:
00162D 562D C5              11      PUSH    BC
00162E 562E D5              11      PUSH    DE
00162F 562F E5              11      PUSH    HL
001630 5630 DDE5            15      PUSH    IX
001632 5632 DD219F00        14      LD  IX,CHGET
001636 5636 CDB444          17      CALL    CALSLT_R
001639 5639 DDE1            14      POP IX
00163B 563B E1              10      POP HL
00163C 563C D1              10      POP DE
00163D 563D C1              10      POP BC
00163E 563E FE03             7      CP  3
001640 5640 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       5641                     _INKEY:
       5641                     INKEY:
001641 5641 CD8C56          17      CALL    CPM_CONST
001644 5644 C8              11      RET Z
001645 5645 18E6            12      JR  FLGET
                                
       5647                     _SYS0A:     ;(BDOS)文字列入力
001647 5647 C5              11      PUSH    BC
001648 5648 E5              11      PUSH    HL
001649 5649 D5              11      PUSH    DE
00164A 564A 3ADDF3          13      LD  A,(CSRX)
00164D 564D 5F               4      LD  E,A
00164E 564E 1600             7      LD  D,0
001650 5650 D5              11      PUSH    DE
001651 5651 DDE5            15      PUSH    IX
001653 5653 DD21AE00        14      LD  IX,PLININ
001657 5657 CDB444          17      CALL    CALSLT_R
00165A 565A DDE1            14      POP IX
00165C 565C D1              10      POP DE
00165D 565D 215DF5          10      LD  HL,BUF-1
001660 5660 F5              11      PUSH    AF
001661 5661 19              11      ADD HL,DE
001662 5662 F1              10      POP AF
001663 5663 EB               4      EX  DE,HL
001664 5664 E1              10      POP HL
001665 5665 E5              11      PUSH    HL
001666 5666 0E00             7      LD  C,0
001668 5668 3004            12      JR  NC,SAX0
00166A 566A 23               6      INC HL
00166B 566B 23               6      INC HL
00166C 566C 1808            12      JR  SAX4
       566E                     SAX0:
00166E 566E 46               7      LD  B,(HL)
00166F 566F 23               6      INC HL
       5670                     SAX1:
001670 5670 23               6      INC HL
001671 5671 1A               7      LD  A,(DE)
001672 5672 13               6      INC DE
001673 5673 B7               4      OR  A
001674 5674 2004            12      JR  NZ,SAX2
       5676                     SAX4:
001676 5676 360D            10      LD  (HL),00DH
001678 5678 1804            12      JR  SAX3
       567A                     SAX2:
00167A 567A 77               7      LD  (HL),A
00167B 567B 0C               4      INC C
00167C 567C 10F2            13      DJNZ    SAX1
       567E                     SAX3:
00167E 567E D1              10      POP DE
00167F 567F 79               4      LD  A,C
001680 5680 13               6      INC DE
001681 5681 12               7      LD  (DE),A
001682 5682 1B               6      DEC DE
001683 5683 E1              10      POP HL
001684 5684 C1              10      POP BC
001685 5685 3E1E             7      LD  A,01EH
001687 5687 CDAB55          17      CALL    MSG_A
00168A 568A AF               4      XOR A
00168B 568B C9              10      RET
                                
       568C                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       568C                     CONSTX:
       568C                     CPM_CONST:
00168C 568C C5              11      PUSH    BC
00168D 568D D5              11      PUSH    DE
00168E 568E E5              11      PUSH    HL
00168F 568F DDE5            15      PUSH    IX
001691 5691 DD219C00        14      LD  IX,CHSNS
001695 5695 CDB444          17      CALL    CALSLT_R
001698 5698 DDE1            14      POP IX
00169A 569A E1              10      POP HL
00169B 569B D1              10      POP DE
00169C 569C C1              10      POP BC
00169D 569D C9              10      RET
                                
       569E                     _SYS2A:     ;(BDOS)日付の獲得
00169E 569E 0E0B             7      LD  C,11        ;年/Year→HL
0016A0 56A0 CDDF56          17      CALL    RDCLK_BCD
0016A3 56A3 6F               4      LD  L,A
0016A4 56A4 2600             7      LD  H,0
0016A6 56A6 3AF8FA          13      LD  A,(EXBRSA)
0016A9 56A9 B7               4      OR  A
0016AA 56AA 2804            12      JR  Z,SX2A1
0016AC 56AC 11BC07          10      LD  DE,1980     ;1980年～2079年
0016AF 56AF 19              11      ADD HL,DE
       56B0                     SX2A1:
0016B0 56B0 0E09             7      LD  C,9     ;月/Month→D
0016B2 56B2 CDDF56          17      CALL    RDCLK_BCD
0016B5 56B5 57               4      LD  D,A
                                
0016B6 56B6 0E07             7      LD  C,7     ;日/Day→E
0016B8 56B8 CDDF56          17      CALL    RDCLK_BCD
0016BB 56BB 5F               4      LD  E,A
                                
0016BC 56BC 0E06             7      LD  C,6     ;曜日/Week→A
       56BE                     RDCLK:
0016BE 56BE DDE5            15      PUSH    IX
0016C0 56C0 DD21F501        14      LD  IX,REDCLK
       56C4                     WRCLK1:
0016C4 56C4 3AF8FA          13      LD  A,(EXBRSA)
0016C7 56C7 B7               4      OR  A
0016C8 56C8 280A            12      JR  Z,RDCLK1    ;MSX1
0016CA 56CA FDE5            15      PUSH    IY
0016CC 56CC FD67             9      LD  IYH,A
0016CE 56CE 78               4      LD  A,B
0016CF 56CF CD1C00          17      CALL    _CALSLT
0016D2 56D2 FDE1            14      POP IY
       56D4                     RDCLK1:
0016D4 56D4 DDE1            14      POP IX
0016D6 56D6 C9              10      RET
       56D7                     WRCLK:
0016D7 56D7 DDE5            15      PUSH    IX
0016D9 56D9 DD21F901        14      LD  IX,WRTCLK
0016DD 56DD 18E5            12      JR  WRCLK1
                                
       56DF                     RDCLK_BCD:
0016DF 56DF CDBE56          17      CALL    RDCLK       ;1の位
0016E2 56E2 47               4      LD  B,A
0016E3 56E3 0C               4      INC C
0016E4 56E4 CDBE56          17      CALL    RDCLK       ;10の位
0016E7 56E7 87               4      ADD A,A     ;*2
0016E8 56E8 4F               4      LD  C,A
0016E9 56E9 87               4      ADD A,A     ;*4
0016EA 56EA 87               4      ADD A,A     ;*8
0016EB 56EB 81               4      ADD A,C     ;*10(8+2)
0016EC 56EC 80               4      ADD A,B     ;1の位
0016ED 56ED C9              10      RET
                                
       56EE                     _SYS2C:     ;(BDOS)時刻の獲得
0016EE 56EE 011501          10      LD  BC,00115H       ;12時間計/24時間計の設定を24時間計に
0016F1 56F1 CDD756          17      CALL    WRCLK
0016F4 56F4 0E04             7      LD  C,4     ;H=時/Hour
0016F6 56F6 CDDF56          17      CALL    RDCLK_BCD
0016F9 56F9 67               4      LD  H,A
0016FA 56FA 0E02             7      LD  C,2     ;L=分/Minute
0016FC 56FC CDDF56          17      CALL    RDCLK_BCD
0016FF 56FF 6F               4      LD  L,A
001700 5700 0E00             7      LD  C,0     ;D=秒/Second
001702 5702 CDDF56          17      CALL    RDCLK_BCD
001705 5705 57               4      LD  D,A
001706 5706 AF               4      XOR A       ;E=1/100秒
001707 5707 5F               4      LD  E,A
001708 5708 C9              10      RET
                                
       5709                     POS:
001709 5709 F5              11      PUSH    AF
00170A 570A 2ADCF3          16      LD  HL,(CSRY)
00170D 570D 7D               4      LD  A,L
00170E 570E 6C               4      LD  L,H
00170F 570F 67               4      LD  H,A
001710 5710 2C               4      INC L
001711 5711 24               4      INC H
001712 5712 F1              10      POP AF
001713 5713 C9              10      RET
                                
       5714                     LOC:
001714 5714 F5              11      PUSH    AF
001715 5715 E5              11      PUSH    HL
001716 5716 7D               4      LD  A,L
001717 5717 6C               4      LD  L,H
001718 5718 67               4      LD  H,A
001719 5719 2D               4      DEC L
00171A 571A 25               4      DEC H
00171B 571B DDE5            15      PUSH    IX
00171D 571D DD21C600        14      LD  IX,POSIT
001721 5721 CDB444          17      CALL    CALSLT_R
001724 5724 DDE1            14      POP IX
001726 5726 E1              10      POP HL
001727 5727 F1              10      POP AF
001728 5728 C9              10      RET
                                
       5729                     _SCRN:
       5729                     SCRN:
001729 5729 E5              11      PUSH    HL
00172A 572A DDE5            15      PUSH    IX
                                
00172C 572C 69               4      LD  L,C
00172D 572D 60               4      LD  H,B
00172E 572E DD214A00        14      LD  IX,RDVRM
001732 5732 CDB444          17      CALL    CALSLT_R
                                
001735 5735 DDE1            14      POP IX
001737 5737 E1              10      POP HL
001738 5738 C9              10      RET
                                
       5739                     CTRL02:
001739 5739 F5              11      PUSH    AF
00173A 573A D5              11      PUSH    DE
00173B 573B 2ADCF3          16      LD  HL,(CSRY)
00173E 573E 3AB0F3          13      LD  A,(LINLEN)
001741 5741 4F               4      LD  C,A
001742 5742 94               4      SUB H   ;CSRX
001743 5743 C602             7      ADD A,2
001745 5745 47               4      LD  B,A ;カーソルより右の文字数
001746 5746 61               4      LD  H,C ;LINLEN
001747 5747 C5              11      PUSH    BC
001748 5748 CD9657          17      CALL    LOC0
00174B 574B C1              10      POP BC
                                
00174C 574C 1620             7      LD  D,020H
       574E                     C8X1:
00174E 574E DD214A00        14      LD  IX,RDVRM
001752 5752 CDB444          17      CALL    CALSLT_R
001755 5755 4F               4      LD  C,A
001756 5756 7A               4      LD  A,D
001757 5757 DD214D00        14      LD  IX,WRTVRM
00175B 575B CDB444          17      CALL    CALSLT_R
00175E 575E 2B               6      DEC HL
00175F 575F 51               4      LD  D,C
001760 5760 10EC            13      DJNZ    C8X1
001762 5762 D1              10      POP DE
001763 5763 F1              10      POP AF
001764 5764 C9              10      RET
                                
       5765                     INSERT:
001765 5765 F5              11      PUSH    AF
001766 5766 D5              11      PUSH    DE
001767 5767 2ADCF3          16      LD  HL,(CSRY)
00176A 576A 3AB0F3          13      LD  A,(LINLEN)
00176D 576D 4F               4      LD  C,A
00176E 576E 94               4      SUB H   ;CSRX
00176F 576F 3C               4      INC A
001770 5770 47               4      LD  B,A ;カーソルより右の文字数
001771 5771 C5              11      PUSH    BC
001772 5772 CD9657          17      CALL    LOC0
001775 5775 C1              10      POP BC
                                
001776 5776 1620             7      LD  D,020H
       5778                     INS1:
001778 5778 DD214A00        14      LD  IX,RDVRM
00177C 577C CDB444          17      CALL    CALSLT_R
00177F 577F 4F               4      LD  C,A
001780 5780 7A               4      LD  A,D
001781 5781 DD214D00        14      LD  IX,WRTVRM
001785 5785 CDB444          17      CALL    CALSLT_R
001788 5788 23               6      INC HL
001789 5789 51               4      LD  D,C
00178A 578A 10EC            13      DJNZ    INS1
00178C 578C D1              10      POP DE
00178D 578D F1              10      POP AF
00178E 578E C9              10      RET
                                
       578F                     CONOUT1:
00178F 578F 59               4      LD  E,C
001790 5790 C3A555          10      JP  _PRINT
                                
       5793                     GETVRAM:
001793 5793 2ADCF3          16      LD  HL,(CSRY)
       5796                     LOC0:
001796 5796 2D               4      DEC L
001797 5797 25               4      DEC H
001798 5798 4C               4      LD  C,H ;CSRX-1
001799 5799 5D               4      LD  E,L ;CSRY-1
       579A                     LOC1:
00179A 579A 3AB0F3          13      LD  A,(LINLEN)
00179D 579D 67               4      LD  H,A
00179E 579E 1600             7      LD  D,0
0017A0 57A0 6A               4      LD  L,D ;0
0017A1 57A1 0608             7      LD  B,8
       57A3                     LOC2:
0017A3 57A3 29              11      ADD HL,HL
0017A4 57A4 3001            12      JR  NC,LOC3
0017A6 57A6 19              11      ADD HL,DE
       57A7                     LOC3:
0017A7 57A7 10FA            13      DJNZ    LOC2
0017A9 57A9 09              11      ADD HL,BC
0017AA 57AA C9              10      RET
                                
       57AB                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0017AB 57AB 212200          10      LD  HL,00022H
0017AE 57AE AF               4      XOR A
0017AF 57AF 7D               4      LD  A,L
0017B0 57B0 C9              10      RET
                                
       57B1                     _SYS0D:     ;(BDOS)ディスク・リセット
0017B1 57B1 218000          10      LD  HL,00080H
0017B4 57B4 22D4F2          16      LD  (_DTA),HL
0017B7 57B7 C9              10      RET
                                
       57B8                     _SYS0E:     ;(BDOS)カレントドライブの設定
0017B8 57B8 7B               4      LD  A,E
       57B9                     _SYS0EX1:
0017B9 57B9 FE08             7      CP  8
0017BB 57BB 3F               4      CCF
0017BC 57BC D8              11      RET C
0017BD 57BD 32EAF2          13      LD  (_DVSW),A
0017C0 57C0 C9              10      RET
                                
       57C1                     _SYS0F:     ;(BDOS)ファイルのオープン
0017C1 57C1 D5              11      PUSH    DE
0017C2 57C2 FDE1            14      POP IY
0017C4 57C4 CD6659          17      CALL    INIT_FILE
0017C7 57C7 CDD24D          17      CALL    ROM_OPEN
0017CA 57CA 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
0017CC 57CC FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
0017D0 57D0 FDE5            15      PUSH    IY
0017D2 57D2 D1              10      POP DE
0017D3 57D3 13               6      INC DE
0017D4 57D4 010B00          10      LD  BC,11
0017D7 57D7 EDB0                    LDIR
                                ;               Attribute
0017D9 57D9 7E               7      LD  A,(HL)
0017DA 57DA FD770D          19      LD  (IY+13),A
                                ;               TIME
0017DD 57DD 110B00          10      LD  DE,11
0017E0 57E0 19              11      ADD HL,DE
0017E1 57E1 7E               7      LD  A,(HL)
0017E2 57E2 23               6      INC HL
0017E3 57E3 FD7716          19      LD  (IY+22),A
0017E6 57E6 7E               7      LD  A,(HL)
0017E7 57E7 23               6      INC HL
0017E8 57E8 FD7717          19      LD  (IY+23),A
                                ;               DATE
0017EB 57EB 7E               7      LD  A,(HL)
0017EC 57EC 23               6      INC HL
0017ED 57ED FD7714          19      LD  (IY+20),A
0017F0 57F0 7E               7      LD  A,(HL)
0017F1 57F1 23               6      INC HL
0017F2 57F2 FD7715          19      LD  (IY+21),A
                                ;               First cluster
0017F5 57F5 7E               7      LD  A,(HL)
0017F6 57F6 23               6      INC HL
0017F7 57F7 FD771A          19      LD  (IY+26),A
0017FA 57FA 7E               7      LD  A,(HL)
0017FB 57FB 23               6      INC HL
0017FC 57FC FD771B          19      LD  (IY+27),A
                                ;               SIZE
0017FF 57FF 7E               7      LD  A,(HL)
001800 5800 23               6      INC HL
001801 5801 FD7710          19      LD  (IY+16),A
001804 5804 7E               7      LD  A,(HL)
001805 5805 23               6      INC HL
001806 5806 FD7711          19      LD  (IY+17),A
001809 5809 7E               7      LD  A,(HL)
00180A 580A 23               6      INC HL
00180B 580B FD7712          19      LD  (IY+18),A
00180E 580E 7E               7      LD  A,(HL)
00180F 580F FD7713          19      LD  (IY+19),A
001812 5812 AF               4      XOR A
001813 5813 FD770C          19      LD  (IY+12),A
001816 5816 C9              10      RET
                                
       5817                     _SYS10:     ;(BDOS)ファイルのクローズ
001817 5817 AF               4      XOR A
001818 5818 C9              10      RET
                                
       5819                     S11X1:
001819 5819 FD7119          19      LD  (IY+25),C       ;RootEntCnt
00181C 581C FD750E          19      LD  (IY+14),L
00181F 581F FD740F          19      LD  (IY+15),H
       5822                     SCF_FF_RET:
001822 5822 37               4      SCF
001823 5823 9F               4      SBC A,A
001824 5824 C9              10      RET
                                
       5825                     _SYS11:     ;(BDOS)最初のファイルの検索
001825 5825 ED53D7F2        20      LD  (_FCB),DE
001829 5829 D5              11      PUSH    DE
00182A 582A FDE1            14      POP IY
00182C 582C CD6659          17      CALL    INIT_FILE
       582F                     S12X0:
00182F 582F CD2E50          17      CALL    GET_DIR_DAT
       5832                     S12X1:
001832 5832 CDEE4D          17      CALL    FILESE
001835 5835 30E2            12      JR  NC,S11X1
001837 5837 0D               4      DEC C
001838 5838 FD7119          19      LD  (IY+25),C       ;RootEntCnt
00183B 583B FDCB0D66        20      BIT 4,(IY+13)
00183F 583F 280A            12      JR  Z,S12X2
001841 5841 E5              11      PUSH    HL
001842 5842 DDE1            14      POP IX
001844 5844 DD7E0B          19      LD  A,(IX+11)
001847 5847 FE0F             7      CP  00FH
001849 5849 28E4            12      JR  Z,S12X0
       584B                     S12X2:
00184B 584B 012000          10      LD  BC,32
00184E 584E ED5BD4F2        20      LD  DE,(_DTA)
001852 5852 AF               4      XOR A
001853 5853 12               7      LD  (DE),A      ;ドライブ番号
001854 5854 13               6      INC DE
001855 5855 EDB0                    LDIR            ;ディレクトリエントリ
001857 5857 FD750E          19      LD  (IY+14),L
00185A 585A FD740F          19      LD  (IY+15),H
00185D 585D C9              10      RET
                                
       585E                     _SYS12:
00185E 585E FD2AD7F2        20      LD  IY,(_FCB)
001862 5862 FDE5            15      PUSH    IY
001864 5864 D1              10      POP DE
001865 5865 CD6659          17      CALL    INIT_FILE
       5868                     S12X3:
001868 5868 FD6E0E          19      LD  L,(IY+14)
00186B 586B FD660F          19      LD  H,(IY+15)
00186E 586E FD4E19          19      LD  C,(IY+25)
001871 5871 18BF            12      JR  S12X1
                                
       5873                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
001873 5873 CD1450          17      CALL    SET_FCB
001876 5876 CDE24F          17      CALL    GETSEQ
001879 5879 CDCF4F          17      CALL    RB_READ
00187C 587C E5              11      PUSH    HL
00187D 587D CDEF4F          17      CALL    SETSEQ
001880 5880 E1              10      POP HL
       5881                     SREAD:
001881 5881 C601             7      ADD A,001H
001883 5883 D8              11      RET C
                                
001884 5884 7D               4      LD  A,L
001885 5885 D601             7      SUB 001H
001887 5887 9F               4      SBC A,A
001888 5888 E603             7      AND 3
00188A 588A 1F               4      RRA
00188B 588B C9              10      RET
                                
       588C                     _SYS18:     ;(BDOS)ログインベクトルの獲得
       588C                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
00188C 588C 2AF0F2          16      LD  HL,(_LVECTOR)
00188F 588F AF               4      XOR A
001890 5890 67               4      LD  H,A
001891 5891 C9              10      RET
                                
       5892                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
001892 5892 3AEAF2          13      LD  A,(_DVSW)
001895 5895 A7               4      AND A
001896 5896 C9              10      RET
                                
       5897                     _SYS1A:     ;(BDOS)DTAの設定
001897 5897 ED53D4F2        20      LD  (_DTA),DE
00189B 589B AF               4      XOR A
00189C 589C C9              10      RET
                                
       589D                     _SYS1B:     ;(BDOS)ディスク情報の獲得
00189D 589D 7B               4      LD  A,E
00189E 589E D601             7      SUB 1
0018A0 58A0 DC9258          17      CALL    C,_SYS19
0018A3 58A3 5F               4      LD  E,A
0018A4 58A4 CDA353          17      CALL    IS_BPB
0018A7 58A7 3827            12      JR  C,S1B_E
0018A9 58A9 F5              11      PUSH    AF
0018AA 58AA 215EF5          10      LD  HL,SYS1B_DPB
0018AD 58AD 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
0018B0 58B0 47               4      LD  B,A
0018B1 58B1 4F               4      LD  C,A
0018B2 58B2 3271F5          13      LD  (SYS1B_FAT),A
0018B5 58B5 7B               4      LD  A,E
0018B6 58B6 CDC053          17      CALL    GETDPB
0018B9 58B9 DD215EF5        14      LD  IX,SYS1B_DPB
0018BD 58BD FD2171F5        14      LD  IY,SYS1B_FAT
0018C1 58C1 ED4B60F5        20      LD  BC,(SYS1B_DPB+1+1)  ;SECSIZ
0018C5 58C5 ED5B6CF5        20      LD  DE,(SYS1B_DPB+1+13) ;MAXCLUS
0018C9 58C9 1B               6      DEC DE
0018CA 58CA 1B               6      DEC DE
0018CB 58CB 210000          10      LD  HL,0            ;書き込み不可なので0を返す
0018CE 58CE F1              10      POP AF
0018CF 58CF C9              10      RET
       58D0                     S1B_E:
0018D0 58D0 9F               4      SBC A,A
0018D1 58D1 C9              10      RET
                                
       58D2                     _SYS21:     ;(BDOS)ランダムな読み出し
0018D2 58D2 CD1450          17      CALL    SET_FCB
                                
0018D5 58D5 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0018D8 58D8 FD6622          19      LD  H,(IY+34)
                                
0018DB 58DB CDCF4F          17      CALL    RB_READ
0018DE 58DE 18A1            12      JR  SREAD
                                
       58E0                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
0018E0 58E0 CDC157          17      CALL    _SYS0F
0018E3 58E3 D8              11      RET C
                                
0018E4 58E4 D5              11      PUSH    DE      ;EX DE,IY
0018E5 58E5 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0018E7 58E7 CD0450          17      CALL    GETSIZE
       58EA                     _S24X1:
0018EA 58EA FD7521          19      LD  (IY+33),L   ;(FCB)Random record
0018ED 58ED FD7422          19      LD  (IY+34),H
0018F0 58F0 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
0018F4 58F4 FDE3            23      EX  (SP),IY     ;
0018F6 58F6 D1              10      POP DE      ;
                                
0018F7 58F7 AF               4      XOR A
0018F8 58F8 C9              10      RET
                                
       58F9                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
0018F9 58F9 E5              11      PUSH    HL
0018FA 58FA D5              11      PUSH    DE      ;EX DE,IY
0018FB 58FB FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0018FD 58FD CDE24F          17      CALL    GETSEQ
001900 5900 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       5902                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001902 5902 CD1450          17      CALL    SET_FCB
001905 5905 E5              11      PUSH    HL
001906 5906 FD6E21          19      LD  L,(IY+33)
001909 5909 FD6622          19      LD  H,(IY+34)
00190C 590C 22CAF2          16      LD  (RR_LOW),HL
00190F 590F FD6E23          19      LD  L,(IY+35)
001912 5912 FD6624          19      LD  H,(IY+36)
001915 5915 22CCF2          16      LD  (RR_HIGH),HL
001918 5918 E1              10      POP HL
001919 5919 CD9F4B          17      CALL    ROM_READ
00191C 591C ED5BCAF2        20      LD  DE,(RR_LOW)
001920 5920 FD7321          19      LD  (IY+33),E
001923 5923 FD7222          19      LD  (IY+34),D
001926 5926 ED5BCCF2        20      LD  DE,(RR_HIGH)
00192A 592A FD7323          19      LD  (IY+35),E
00192D 592D FD7224          19      LD  (IY+36),D
001930 5930 9F               4      SBC A,A
001931 5931 D8              11      RET C
001932 5932 3AC3F2          13      LD  A,(_RESULT)
001935 5935 C9              10      RET
                                
       5936                     _SYS2F:
001936 5936 44               4      LD  B,H
001937 5937 7D               4      LD  A,L
001938 5938 2AD4F2          16      LD  HL,(_DTA)
00193B 593B C31D53          10      JP  DISKIO
                                
       593E                     _SYS5A:
00193E 593E 0600             7      LD  B,0
001940 5940 D5              11      PUSH    DE
001941 5941 DDE1            14      POP IX
       5943                     _SX5A1:
001943 5943 1A               7      LD  A,(DE)
001944 5944 B7               4      OR  A
001945 5945 2804            12      JR  Z,_SX5A2
001947 5947 13               6      INC DE
001948 5948 04               4      INC B
001949 5949 18F8            12      JR  _SX5A1
                                
       594B                     _SX5A2:
00194B 594B 78               4      LD  A,B
00194C 594C CD6A4C          17      CALL    FILE_BDOS
00194F 594F CDE550          17      CALL    ROM_CD
001952 5952 9F               4      SBC A,A
001953 5953 C9              10      RET
                                
       5954                     _SYS6F:
001954 5954 016F00          10      LD  BC,006FH
001957 5957 AF               4      XOR A
001958 5958 C9              10      RET
                                
       5959                     _SYS68:
001959 5959 21F0F2          10      LD  HL,_LVECTOR
00195C 595C CBFE            15      SET 7,(HL)
00195E 595E 78               4      LD  A,B
00195F 595F B7               4      OR  A
001960 5960 3E00             7      LD  A,0
001962 5962 C0              11      RET NZ
001963 5963 CBBE            15      RES 7,(HL)
001965 5965 C9              10      RET 
                                
       5966                     INIT_FILE:
001966 5966 EB               4      EX  DE,HL
001967 5967 11F9F2          10      LD  DE,FDRV
00196A 596A 010C00          10      LD  BC,1+8+3
       596D                     INIT_FILE1:
00196D 596D EDB0                    LDIR
00196F 596F CD3355          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_MORMAL32K_OR_ASCII16
001972 5972 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
001975 5975 2AEBF2          16      LD  HL,(_CD)
001978 5978 22F7F2          16      LD  (_CDX),HL           ;カレントディレクトリ
00197B 597B C9              10      RET
                                
       597C                     ZERO_MEMORY_DE:
00197C 597C AF               4      XOR A
       597D                     FILL_MEMORY_DE:
00197D 597D 12               7      LD  (DE),A
00197E 597E 13               6      INC DE
00197F 597F 10FC            13      DJNZ    FILL_MEMORY_DE
001981 5981 C9              10      RET
                                
       5982                     LD_A_DE:
001982 5982 1A               7      LD  A,(DE)
001983 5983 CB7A             8      BIT 7,D
001985 5985 C0              11      RET NZ
001986 5986 C5              11      PUSH    BC
001987 5987 D5              11      PUSH    DE
001988 5988 E5              11      PUSH    HL
001989 5989 EB               4      EX  DE,HL
                                
00198A 598A 0141F3          10      LD  BC,RAMAD0
00198D 598D 7C               4      LD  A,H
00198E 598E 07               4      RLCA
00198F 598F 07               4      RLCA
001990 5990 E603             7      AND 3
001992 5992 81               4      ADD A,C
001993 5993 4F               4      LD  C,A
001994 5994 0A               7      LD  A,(BC)
                                
001995 5995 CD0C00          17      CALL    _RDSLT
001998 5998 E1              10      POP HL
001999 5999 D1              10      POP DE
00199A 599A C1              10      POP BC
00199B 599B C9              10      RET
                                
       5822                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       5822                     _SYS13  EQU SCF_FF_RET  ;(BDOS)ファイルの削除
       5822                     _SYS15  EQU SCF_FF_RET  ;(BDOS)シーケンシャルな書き込み
       5822                     _SYS16  EQU SCF_FF_RET  ;(BDOS)ファイルの作成
       5822                     _SYS17  EQU SCF_FF_RET  ;(BDOS)ファイル名の変更
       5822                     _SYS22  EQU SCF_FF_RET  ;(BDOS)ランダムな書き込み
       5822                     _SYS26  EQU SCF_FF_RET  ;(BDOS)ランダムブロック書き込み
       5822                     _SYS28  EQU SCF_FF_RET  ;(BDOS)ランダムな書き込み・その2
                                
       5822                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       5822                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       5822                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       5822                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
00199C 599C                         ALIGN   256
       5A00                     STABLE:
                                ;0
001A00 5A00 9355A855D9552258        DW  _ERROR,_SYS01,_SYS02,_SYS03
001A08 5A08 93559355DE552D56        DW  _ERROR,_ERROR,_SYS06,_SYS07
001A10 5A10 E6551F5647568C56        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
001A18 5A18 AB57B157B857C157        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001A20 5A20 175825585E582258        DW  _SYS10,_SYS11,_SYS12,_SYS13
001A28 5A28 7358225822582258        DW  _SYS14,_SYS15,_SYS16,_SYS17
001A30 5A30 8C58925897589D58        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001A38 5A38 93558C5893559355        DW  _ERROR,_SYS1D,_ERROR,_ERROR
                                ;2
001A40 5A40 9355D2582258E058        DW  _ERROR,_SYS21,_SYS22,_SYS23
001A48 5A48 F958935522580259        DW  _SYS24,_ERROR,_SYS26,_SYS27
001A50 5A50 225893559E562258        DW  _SYS28,_ERROR,_SYS2A,_SYS2B
001A58 5A58 EE56225893553659        DW  _SYS2C,_SYS2D,_ERROR,_SYS2F
                                ;3
001A60 5A60 9355935593559355        DW  _ERROR,_ERROR,_ERROR,_ERROR
001A68 5A68 9355935593559355        DW  _ERROR,_ERROR,_ERROR,_ERROR
001A70 5A70 9355225822589355        DW  _ERROR,_SYS39,_SYS3A,_ERROR
001A78 5A78 9355935593559355        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001A80 5A80 9355935593559355        DW  _ERROR,_ERROR,_ERROR,_ERROR
001A88 5A88 9355935593559355        DW  _ERROR,_ERROR,_ERROR,_ERROR
001A90 5A90 9355935593559355        DW  _ERROR,_ERROR,_ERROR,_ERROR
001A98 5A98 9355935593559355        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001AA0 5AA0 9355935593559355        DW  _ERROR,_ERROR,_ERROR,_ERROR
001AA8 5AA8 9355935593559355        DW  _ERROR,_ERROR,_ERROR,_ERROR
001AB0 5AB0 935593553E599355        DW  _ERROR,_ERROR,_SYS5A,_ERROR
001AB8 5AB8 9355935593559355        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001AC0 5AC0 9355935593559355        DW  _ERROR,_ERROR,_ERROR,_ERROR
001AC8 5AC8 9355935593559355        DW  _ERROR,_ERROR,_ERROR,_ERROR
001AD0 5AD0 5959935593559355        DW  _SYS68,_ERROR,_ERROR,_ERROR
001AD8 5AD8 9355935593555459        DW  _ERROR,_ERROR,_ERROR,_SYS6F
                                ;7
001AE0 5AE0 9355935593559355        DW  _ERROR,_ERROR,_ERROR,_ERROR
001AE8 5AE8 9355935593559355        DW  _ERROR,_ERROR,_ERROR,_ERROR
001AF0 5AF0 9355935593559355        DW  _ERROR,_ERROR,_ERROR,_ERROR
001AF8 5AF8 9355935593559355        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
                                    INCLUDE "SLOT.ASM"
                                #if exists _RAM64K
       5B00                     INT38H_ROM:
001B00 5B00 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
001B03 5B03 CD095B          17      CALL    ENASLT_00H
001B06 5B06 CD3800          17      CALL    00038H
                                ;   JP  ENASLT_00H
                                ;
                                ;ページ0専門のENASLT
                                ;in
                                ;A←スロット
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
                                ; ページ1 に配置
       5B09                     ENASLT_00H:
001B09 5B09 F3               4      DI
001B0A 5B0A D5              11      PUSH    DE
001B0B 5B0B 6F               4      LD  L,A
001B0C 5B0C E603             7      AND 3
001B0E 5B0E 4F               4      LD  C,A
001B0F 5B0F DBA8            11      IN  A,(0A8H)
001B11 5B11 67               4      LD  H,A
001B12 5B12 E6FC             7      AND 0FCH    ;ページ0
001B14 5B14 B1               4      OR  C
001B15 5B15 57               4      LD  D,A ;基本スロット
                                
001B16 5B16 7C               4      LD  A,H
001B17 5B17 E603             7      AND 3
001B19 5B19 CB7D             8      BIT 7,L
001B1B 5B1B CAFAEF          10      JP  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001B1E 5B1E F680             7      OR  080H
001B20 5B20 67               4      LD  H,A
                                            ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001B21 5B21 79               4      LD  A,C
001B22 5B22 0F               4      RRCA
001B23 5B23 0F               4      RRCA
001B24 5B24 4F               4      LD  C,A
001B25 5B25 7A               4      LD  A,D
001B26 5B26 E63F             7      AND 03FH    ;ページ0
001B28 5B28 B1               4      OR  C
001B29 5B29 D3A8            11      OUT (0A8H),A
                                                ;拡張スロットの切り替え
001B2B 5B2B 7D               4      LD  A,L
001B2C 5B2C 0F               4      RRCA
001B2D 5B2D 0F               4      RRCA
001B2E 5B2E E603             7      AND 3
001B30 5B30 4F               4      LD  C,A
                                
001B31 5B31 3AFFFF          13      LD  A,(0FFFFH)
001B34 5B34 2F               4      CPL
001B35 5B35 47               4      LD  B,A
001B36 5B36 E6FC             7      AND 0FCH    ;ページ0
001B38 5B38 B1               4      OR  C
001B39 5B39 32FFFF          13      LD  (0FFFFH),A
                                                ;基本スロットの切り替え
001B3C 5B3C 7A               4      LD  A,D
001B3D 5B3D D3A8            11      OUT (0A8H),A
001B3F 5B3F 78               4      LD  A,B
001B40 5B40 E603             7      AND 3
001B42 5B42 87               4      ADD A,A
001B43 5B43 87               4      ADD A,A
001B44 5B44 C3ECEF          10      JP  WRITE_SLTTBL
                                ;
                                ;   ENASLOTの補助（ページ0・003BH～に配置）
                                ;
       5B47                     AT_3B:              ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001B47 5B47 D3A8            11      OUT (0A8H),A
001B49 5B49 3AFFFF          13      LD  A,(0FFFFH)  ;拡張スロットの切り替え
001B4C 5B4C 2F               4      CPL
001B4D 5B4D 47               4      LD  B,A
001B4E 5B4E A3               4      AND E
001B4F 5B4F B1               4      OR  C
001B50 5B50 32FFFF          13      LD  (0FFFFH),A
                                                ;基本スロットの切り替え
001B53 5B53 7A               4      LD  A,D
001B54 5B54 D3A8            11      OUT (0A8H),A
001B56 5B56 C9              10      RET
       5B57                     AT_3B_E:
                                
       5B57                     AT_ISC:
001B57 EF80                         ORG ISC,AT_ISC-RUN
                                ;
                                ; インタースロットコール
                                ; ページ3 に配置
                                
                                ;
                                ;ENASLT
                                ;in
                                ;A←スロット
                                ;HL←上位2ビットで切り替えるページを指定
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
       EF80                     ENASLT:
001B57 EF80 CB7C             8      BIT 7,H
001B59 EF82 207D            12      JR  NZ,ENASLT1
001B5B EF84 CB74             8      BIT 6,H
001B5D EF86 2032            12      JR  NZ,ENASLT_40H
       EF88                     _ENASLT_00H:
001B5F EF88 E5              11      PUSH    HL
001B60 EF89 210280          10      LD  HL,08002H
001B63 EF8C 39              11      ADD HL,SP
001B64 EF8D E1              10      POP HL
001B65 EF8E 3014            12      JR  NC,_ENASLT_00H_S
       EF90                     ENASLT_SUB:
001B67 EF90 DDE5            15      PUSH    IX
001B69 EF92 DD21095B        14      LD  IX,ENASLT_00H
       EF96                     INT38H_SUB1:
001B6D EF96 FDE5            15      PUSH    IY
001B6F EF98 FD2A96F2        20      LD  IY,(ROM_SLT-1)
001B73 EF9C CD51F0          17      CALL    CALSLT
001B76 EF9F FDE1            14      POP IY
001B78 EFA1 DDE1            14      POP IX
001B7A EFA3 C9              10      RET
       EFA4                     _ENASLT_00H_S:
001B7B EFA4 ED73AFEF        20      LD  (ENASLT_SP1),SP
001B7F EFA8 315DF5          10      LD  SP,SPBUF
001B82 EFAB CD90EF          17      CALL    ENASLT_SUB
001B85 EFAE 310000          10      LD  SP,0
       EFAF                     ENASLT_SP1  EQU $-2
001B88 EFB1 C9              10      RET
                                
       EFB2                     INT38H_SUB:
001B89 EFB2 DDE5            15      PUSH    IX
001B8B EFB4 DD21005B        14      LD  IX,INT38H_ROM
001B8F EFB8 18DC            12      JR  INT38H_SUB1
                                ;
                                ;ページ1専門のENASLT
                                ;in
                                ;A←スロット
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
       EFBA                     ENASLT_40H:
001B91 EFBA F3               4      DI
001B92 EFBB D5              11      PUSH    DE
001B93 EFBC 6F               4      LD  L,A
001B94 EFBD E603             7      AND 3
001B96 EFBF 87               4      ADD A,A
001B97 EFC0 87               4      ADD A,A
001B98 EFC1 4F               4      LD  C,A
001B99 EFC2 DBA8            11      IN  A,(0A8H)
001B9B EFC4 67               4      LD  H,A
001B9C EFC5 E6F3             7      AND 0F3H    ;ページ1
001B9E EFC7 B1               4      OR  C
001B9F EFC8 57               4      LD  D,A ;基本スロットに出力する値
                                
001BA0 EFC9 7C               4      LD  A,H ;切り替えページ
001BA1 EFCA 0F               4      RRCA
001BA2 EFCB 0F               4      RRCA
001BA3 EFCC E603             7      AND 3
001BA5 EFCE CB7D             8      BIT 7,L
001BA7 EFD0 2828            12      JR  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001BA9 EFD2 F680             7      OR  080H
001BAB EFD4 67               4      LD  H,A ;基本スロットに出力する値
                                            ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001BAC EFD5 E603             7      AND 3
001BAE EFD7 0F               4      RRCA
001BAF EFD8 0F               4      RRCA
001BB0 EFD9 4F               4      LD  C,A
                                
001BB1 EFDA 7A               4      LD  A,D ;基本スロットに出力する値
001BB2 EFDB E63F             7      AND 03FH
001BB4 EFDD B1               4      OR  C
001BB5 EFDE 5F               4      LD  E,A ;基本スロットでページ3にスロットを割り当てる
                                
001BB6 EFDF 7D               4      LD  A,L
001BB7 EFE0 E60C             7      AND 00CH    ;ページ1
001BB9 EFE2 4F               4      LD  C,A
                                
001BBA EFE3 7B               4      LD  A,E
001BBB EFE4 1EF3             7      LD  E,0F3H  ;ページ1
001BBD EFE6 CD3B00          17      CALL    ENASUB
                                
001BC0 EFE9 78               4      LD  A,B
001BC1 EFEA E60C             7      AND 00CH
       EFEC                     WRITE_SLTTBL:       ;SLTTBLを書き換える
001BC3 EFEC B4               4      OR  H   ;A=拡張スロット H=基本スロット
001BC4 EFED 4F               4      LD  C,A
                                
001BC5 EFEE 7D               4      LD  A,L
001BC6 EFEF E603             7      AND 3
001BC8 EFF1 C6C5             7      ADD A,LOW SLTTBL
001BCA EFF3 6F               4      LD  L,A
001BCB EFF4 26FC             7      LD  H,HIGH SLTTBL
001BCD EFF6 70               7      LD  (HL),B  ;B:拡張スロットに設定した値
001BCE EFF7 79               4      LD  A,C ;ENASLTする前のスロット情報をAで返す
001BCF EFF8 D1              10      POP DE
001BD0 EFF9 C9              10      RET
                                
       EFFA                     ENASLT_NOEXT:               ;スロットが拡張されていない場合
001BD1 EFFA 5F               4      LD  E,A
001BD2 EFFB 7A               4      LD  A,D
001BD3 EFFC D3A8            11      OUT (0A8H),A
001BD5 EFFE 7B               4      LD  A,E ;ENASLTする前のスロット情報をAで返す
001BD6 EFFF D1              10      POP DE
001BD7 F000 C9              10      RET
                                
       F001                     ENASLT1:
001BD8 F001 CB74             8      BIT 6,H
001BDA F003 C0              11      RET NZ          ;ページ3はスロット切り替え不可
                                ;
                                ;ページ2専門のENASLT
                                ;in
                                ;A←スロット
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
       F004                     ENASLT_80H:
001BDB F004 F3               4      DI
001BDC F005 D5              11      PUSH    DE
001BDD F006 6F               4      LD  L,A
001BDE F007 E603             7      AND 3
001BE0 F009 87               4      ADD A,A
001BE1 F00A 87               4      ADD A,A
001BE2 F00B 87               4      ADD A,A
001BE3 F00C 87               4      ADD A,A
001BE4 F00D 4F               4      LD  C,A
001BE5 F00E DBA8            11      IN  A,(0A8H)
001BE7 F010 67               4      LD  H,A
001BE8 F011 E6CF             7      AND 0CFH    ;ページ2
001BEA F013 B1               4      OR  C
001BEB F014 57               4      LD  D,A ;基本スロット
                                
001BEC F015 7C               4      LD  A,H
001BED F016 0F               4      RRCA
001BEE F017 0F               4      RRCA
001BEF F018 0F               4      RRCA
001BF0 F019 0F               4      RRCA
001BF1 F01A E603             7      AND 3
001BF3 F01C CB7D             8      BIT 7,L
001BF5 F01E 28DA            12      JR  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001BF7 F020 F680             7      OR  080H
001BF9 F022 67               4      LD  H,A
                                            ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001BFA F023 7F               4      LD  A,A
001BFB F024 E603             7      AND 3
001BFD F026 0F               4      RRCA
001BFE F027 0F               4      RRCA
001BFF F028 4F               4      LD  C,A
001C00 F029 7A               4      LD  A,D
001C01 F02A E63F             7      AND 03FH    ;ページ2
001C03 F02C B1               4      OR  C
001C04 F02D 5F               4      LD  E,A
                                
001C05 F02E 7D               4      LD  A,L
001C06 F02F 07               4      RLCA
001C07 F030 07               4      RLCA
001C08 F031 E630             7      AND 030H
001C0A F033 4F               4      LD  C,A
                                
001C0B F034 7B               4      LD  A,E
001C0C F035 1ECF             7      LD  E,0CFH  ;ページ2
001C0E F037 CD3B00          17      CALL    ENASUB
                                
001C11 F03A 78               4      LD  A,B
001C12 F03B E630             7      AND 030H    ;ページ2
001C14 F03D 0F               4      RRCA
001C15 F03E 0F               4      RRCA
001C16 F03F 18AB            12      JR  WRITE_SLTTBL
                                
       F041                     CALLF:
001C18 F041 E3              19      EX  (SP),HL
001C19 F042 F5              11      PUSH    AF
001C1A F043 7E               7      LD  A,(HL)
001C1B F044 FD67             9      LD  IYH,A
001C1D F046 23               6      INC HL
001C1E F047 7E               7      LD  A,(HL)
001C1F F048 DD6F             9      LD  IXL,A
001C21 F04A 23               6      INC HL
001C22 F04B 7E               7      LD  A,(HL)
001C23 F04C DD67             9      LD  IXH,A
001C25 F04E 23               6      INC HL
001C26 F04F F1              10      POP AF
001C27 F050 E3              19      EX  (SP),HL
       F051                     CALSLT:
001C28 F051 08               4      EX  AF,AF'
001C29 F052 F5              11      PUSH    AF      ;裏AFを保存
001C2A F053 F3               4      DI
001C2B F054 E5              11      PUSH    HL
001C2C F055 210280          10      LD  HL,08002H
001C2F F058 39              11      ADD HL,SP
001C30 F059 E1              10      POP HL
001C31 F05A 3008            12      JR  NC,CALSLT_1
001C33 F05C CD73F0          17      CALL    CALSLT_2
       F05F                     CALSLT_E:
001C36 F05F 08               4      EX  AF,AF'
001C37 F060 F1              10      POP AF      ;保存した裏AF
001C38 F061 08               4      EX  AF,AF'
001C39 F062 FB               4      EI
001C3A F063 C9              10      RET
       F064                     CALSLT_1:
001C3B F064 ED736FF0        20      LD  (CSSP),SP
001C3F F068 315DF5          10      LD  SP,SPBUF
001C42 F06B CD73F0          17      CALL    CALSLT_2
001C45 F06E 310000          10      LD  SP,0
       F06F                     CSSP    EQU $-2
001C48 F071 18EC            12      JR  CALSLT_E
                                
       F073                     CALSLT_2:
001C4A F073 E5              11      PUSH    HL
001C4B F074 C5              11      PUSH    BC
001C4C F075 DD7C             9      LD  A,IXH
001C4E F077 67               4      LD  H,A
001C4F F078 FD7C             9      LD  A,IYH
001C51 F07A CD80EF          17      CALL    ENASLT
001C54 F07D C1              10      POP BC
001C55 F07E 6F               4      LD  L,A
001C56 F07F DD7C             9      LD  A,IXH
001C58 F081 67               4      LD  H,A
001C59 F082 E3              19      EX  (SP),HL
001C5A F083 08               4      EX  AF,AF'
001C5B F084 CD98F3          17      CALL    JP_IX
001C5E F087 E3              19      EX  (SP),HL
001C5F F088 C5              11      PUSH    BC
001C60 F089 08               4      EX  AF,AF'
001C61 F08A 7D               4      LD  A,L
001C62 F08B CD80EF          17      CALL    ENASLT
001C65 F08E 08               4      EX  AF,AF'
001C66 F08F C1              10      POP BC
001C67 F090 E1              10      POP HL
001C68 F091 C9              10      RET
                                
       F092                     RDSLT:
001C69 F092 E5              11      PUSH    HL
001C6A F093 CD80EF          17      CALL    ENASLT
001C6D F096 E1              10      POP HL
001C6E F097 46               7      LD  B,(HL)
001C6F F098 C5              11      PUSH    BC
001C70 F099 E5              11      PUSH    HL
001C71 F09A CD80EF          17      CALL    ENASLT
001C74 F09D E1              10      POP HL
001C75 F09E F1              10      POP AF
001C76 F09F C9              10      RET
                                
       F0A0                     WRSLT:
001C77 F0A0 E5              11      PUSH    HL
001C78 F0A1 CD80EF          17      CALL    ENASLT
001C7B F0A4 E1              10      POP HL
001C7C F0A5 73               7      LD  (HL),E
001C7D F0A6 E5              11      PUSH    HL
001C7E F0A7 CD80EF          17      CALL    ENASLT
001C81 F0AA E1              10      POP HL
001C82 F0AB C9              10      RET
                                
       F0AC                     INT38H:
001C83 F0AC F5              11      PUSH    AF
001C84 F0AD C5              11      PUSH    BC
001C85 F0AE E5              11      PUSH    HL
001C86 F0AF 210280          10      LD  HL,08002H
001C89 F0B2 39              11      ADD HL,SP
001C8A F0B3 380E            12      JR  C,INT38H1
001C8C F0B5 ED73C0F0        20      LD  (INTSP),SP  ;スタックポインタ保存
001C90 F0B9 315DF5          10      LD  SP,SPBUF
001C93 F0BC CDB2EF          17      CALL    INT38H_SUB
001C96 F0BF 310000          10      LD  SP,0
       F0C0                     INTSP   EQU $-2
001C99 F0C2 AF               4      XOR A
       F0C3                     INT38H1:
001C9A F0C3 DCB2EF          17      CALL    C,INT38H_SUB
001C9D F0C6 E1              10      POP HL
001C9E F0C7 C1              10      POP BC
001C9F F0C8 F1              10      POP AF
001CA0 F0C9 FB               4      EI
001CA1 F0CA C9              10      RET
                                ;
                                ;   ページ1のディスクの読み込み補助
                                ;
       F0CB                     LDIR_PAGE1_RAM:
001CA2 F0CB CDBAEF          17      CALL    ENASLT_40H
001CA5 F0CE C1              10      POP BC
001CA6 F0CF D1              10      POP DE
001CA7 F0D0 215EF5          10      LD  HL,BUF
001CAA F0D3 EDB0                    LDIR
001CAC F0D5 CDBAEF          17      CALL    ENASLT_40H
001CAF F0D8 C32C46          10      JP  LDIR_PAGE1_ROM
       F0DB                     ISC_E:
001CB2 5CB2                         ORG $$+RUN,$$   ;$DEPHASE
                                
                                #endif
       5CB2                     AT_ISCB:
001CB2 F280                         ORG ISCB,AT_ISCB-RUN
                                
       F280                     REPLACE_COMMAND:
001CB2 F280 FEB7             7      CP  0B7H            ;FILES
001CB4 F282 CC7BFE          17      CALL    Z,H_FILE
001CB7 F285 FEB5             7      CP  0B5H            ;LOAD
001CB9 F287 CA71FE          10      JP  Z,H_BINS
001CBC F28A FE8A             7      CP  08AH            ;RUN
001CBE F28C CA76FE          10      JP  Z,H_BINL
001CC1 F28F FED6             7      CP  0D6H            ;COPY
001CC3 F291 2813            12      JR  Z,FIX_COPY
001CC5 F293 FECF             7      CP  0CFH            ;BLOAD
001CC7 F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
001CC8 F296 F7              12      RST 30H
       F297                     ROM_SLT:
001CC9 F297 00                      DB  0
001CCA F298 FD47                    DW  ROM_BLOAD
001CCC F29A F5              11      PUSH    AF
001CCD F29B E5              11      PUSH    HL
001CCE F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
001CD1 F29F E1              10      POP HL
001CD2 F2A0 F1              10      POP AF
001CD3 F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
001CD5 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
001CD7 F2A5 C9              10      RET
       F2A6                     FIX_COPY:
001CD8 F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
001CD9 F2A7 00                      DB  0
001CDA F2A8 7F49                    DW  ROM_COPY
001CDC F2AA C9              10      RET
       F2AB                     RAMUSE1:
001CDD F2AB 3A42F3          13      LD  A,(RAMAD1)
001CE0 F2AE 180E            12      JR  _ENASLT_40H
       F2B0                     CAL_MP:
001CE2 F2B0 2640             7      LD  H,040H
001CE4 F2B2 3AC1FC          13      LD  A,(EXPTBL)
001CE7 F2B5 CD2400          17      CALL    _ENASLT
001CEA F2B8 CD1C00          17      CALL    _CALSLT
       F2BB                     ROMUSE1:
001CED F2BB 3A97F2          13      LD  A,(ROM_SLT)
       F2BE                     _ENASLT_40H:
001CF0 F2BE 2640             7      LD  H,040H
001CF2 F2C0 C32400          10      JP  _ENASLT
                                
       F2C3                     _RESULT:
001CF5 F2C3 00                      DB  0
       F2C4                     _BANK:
001CF6 F2C4 00                      DB  0
       F2C5                     _BANK1:
001CF7 F2C5 00                      DB  0
       F2C6                     CLSZ:               ;クラスタサイズ
001CF8 F2C6 0004                    DW  1024
       F2C7                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2C8                     SECSZ:              ;セクタサイズ
001CFA F2C8 0002                    DW  512
       F2C9                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2CA                     RR_LOW:
001CFC F2CA 0000                    DW  0
       F2CB                     RR_MID  EQU $-1
       F2CC                     RR_HIGH:
001CFE F2CC 0000                    DW  0
       F2CE                     _CLPS:
001D00 F2CE 0000                    DW  0
       F2D0                     _LEFT:
001D02 F2D0 0000                    DW  0
       F2D2                     _DTPS:
001D04 F2D2 0000                    DW  0
       F2D4                     _DTA:
001D06 F2D4 0000                    DW  0
       F2D6                     FLG_LDIR:
001D08 F2D6 00                      DB  0
       F2D7                     _FCB:
001D09 F2D7 0000                    DW  0
       F2D9                     _BUF:
       F2D9                     _BUF_LO:        ;LOGICAL OPERATION
001D0B F2D9 00                      DB  0
       F2DA                     _BUF_ST:
001D0C F2DA 0000                    DW  0
       F2DC                     _BUF_EN:
001D0E F2DC 0000                    DW  0
       F2DE                     _BUF_EX:
       F2DE                     _BUF_W:
001D10 F2DE 0000                    DW  0
       F2E0                     _BUF_H:
001D12 F2E0 0000                    DW  0
       F2E2                     _BUF_X:
001D14 F2E2 0000                    DW  0
       F2E4                     _BUF_Y:
001D16 F2E4 00                      DB  0
       F2E5                     _BUF_P:
001D17 F2E5 00                      DB  0
       F2E6                     _BUF_O:
001D18 F2E6 00                      DB  0
       F2E7                     DTAX:
001D19 F2E7 0000                    DW  0
       F2E9                     B_DRIVE:
001D1B F2E9 00                      DB  0
       F2EA                     _DVSW:          ;カレントドライブ
001D1C F2EA 00                      DB  0
       F2EB                     _CD:            ;カレントディレクトリ
001D1D F2EB 0000                    DW  0
       F2ED                     DIRENT1:
001D1F F2ED 0000                    DW  0
       F2EF                     _DIR_BANK:
001D21 F2EF 00                      DB  0
       F2F0                     _LVECTOR:
001D22 F2F0 01                      DB  1
       F2F1                     LEFTX:
001D23 F2F1 0000                    DW  0
       F2F3                     PARAM0:
001D25 F2F3 0000                    DW  0
       F2F5                     PARAM1:
001D27 F2F5 0000                    DW  0
       F2F7                     _CDX:
001D29 F2F7 0000                    DW  0
       F2F9                     FDRV:
001D2B F2F9 00                      DB  0
       F2FA                     FNAME:
001D2C F2FA                         DS  8+3
       F305                     _HL:
001D37 F305 0000                    DW  0
       F307                     _SP:
001D39 F307 0000                    DW  0
       F308                     _SP_H   EQU $-1
                                
       F309                     ISCB_E:
[EOF:SLOT.ASM:UTF_8]
       1D3B                     LAST    EQU $$
001D3B F309                         DS  01FFFH-LAST
001FFF F5CD 00                      DB  0
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
[EOF:DISKROM64K32.ASM:UTF_8]
