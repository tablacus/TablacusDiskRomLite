                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       42B2                     CRUNCH  EQU 042B2H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
                                ;PTRFIL EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
                                ;FILNAM EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
                                ;RSTMP  EQU 0FB03H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FEDA                     H_STKE  EQU 0FEDAH
                                
       FF43                     H_GONE  EQU 0FF43H
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;KONAMI-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                
       F0E9                     ISC EQU 0F0E9H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
[EOF:DEF.ASM:UTF_8]
                                
       0001                     USE_NORMAL_32K_ROM      EQU 1   ;ノーマル32KB ROMを作成する
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C36E4D          10      JP  DISKIO
000013 4013 C3A84D          10      JP  DSKCHG
000016 4016 C3FE4D          10      JP  GETDPB
000019 4019 C3F14E          10      JP  CHOICE
00001C 401C C3F54E          10      JP  DSKFMT
00001F 401F C3F74E          10      JP  DSKSTP
000022 4022 C3F84E          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C3F54E          10      JP  DSKFMT
000029 4029 C3F74E          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3FF4E          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.1.5.1",0
            204449534B20524F    
            4D204C6974652076    
            302E312E352E3100    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 0180FF          10      LD  BC,-00080H
000109 4109 2A72F6          16      LD  HL,(MEMSIZ)
00010C 410C 09              11      ADD HL,BC
00010D 410D 2272F6          16      LD  (MEMSIZ),HL
000110 4110 2A74F6          16      LD  HL,(STKTOP)
000113 4113 09              11      ADD HL,BC
000114 4114 2274F6          16      LD  (STKTOP),HL
000117 4117 2180F0          10      LD  HL,0F080H
00011A 411A 1100F0          10      LD  DE,0F000H
00011D 411D 012000          10      LD  BC,00020H
000120 4120 EDB0                    LDIR
000122 4122 2180FF          10      LD  HL,-00080H
000125 4125 39              11      ADD HL,SP
000126 4126 225FF1          16      LD  (BASSTK),HL
000129 4129 ED7B5FF1        20      LD  SP,(BASSTK)
                                
00012D 412D 3EFF             7      LD  A,0FFH
00012F 412F 3299FD          13      LD  (DEVICE),A
                                
000132 4132 3E01             7      LD  A,1
000134 4134 3221FB          13      LD  (DRVTBL),A
                                
000137 4137 AF               4      XOR A
000138 4138 324AF1          13      LD  (_DVSW),A
                                
00013B 413B 21F342          10      LD  HL,AT_ISC
00013E 413E 11E9F0          10      LD  DE,ISC
000141 4141 017C00          10      LD  BC,ISC_E-ISC
000144 4144 EDB0                    LDIR
                                    
000146 4146 3EC3             7      LD  A,0C3H      ;JP
000148 4148 3243FF          13      LD  (H_GONE),A
00014B 414B 327DF3          13      LD  (BDOS),A
00014E 414E 326BF3          13      LD  (RAMUSE),A
000151 4151 3268F3          13      LD  (ROMUSE),A
000154 4154 21E9F0          10      LD  HL,REPLACE_COMMAND
000157 4157 2244FF          16      LD  (H_GONE+1),HL
00015A 415A 2131F3          10      LD  HL,H_BDOS
00015D 415D 227EF3          16      LD  (BDOS+1),HL
000160 4160 2119F1          10      LD  HL,RAMUSE1
000163 4163 226CF3          16      LD  (RAMUSE+1),HL
000166 4166 2114F1          10      LD  HL,ROMUSE1
000169 4169 2269F3          16      LD  (ROMUSE+1),HL
                                
00016C 416C 3E                      DB  03EH
00016D 416D F7              12      RST 30H
00016E 416E 3271FE          13      LD  (H_BINS),A
000171 4171 3276FE          13      LD  (H_BINL),A
000174 4174 327BFE          13      LD  (H_FILE),A
000177 4177 3231F3          13      LD  (H_BDOS),A
00017A 417A 32DAFE          13      LD  (H_STKE),A
00017D 417D 32A7FF          13      LD  (H_PHYD),A
                                
000180 4180 CD3342          17      CALL    GTSL1_
000183 4183 3200F1          13      LD  (ROM_SLT),A
000186 4186 3210F1          13      LD  (ROM_SLT_COPY),A
000189 4189 3272FE          13      LD  (H_BINS+1),A
00018C 418C 3277FE          13      LD  (H_BINL+1),A
00018F 418F 327CFE          13      LD  (H_FILE+1),A
000192 4192 3232F3          13      LD  (H_BDOS+1),A
000195 4195 32DBFE          13      LD  (H_STKE+1),A
000198 4198 32A8FF          13      LD  (H_PHYD+1),A
00019B 419B 3222FB          13      LD  (DRVTBL+1),A
00019E 419E 3248F3          13      LD  (MASTERS),A
                                
0001A1 41A1 219A45          10      LD  HL,ROM_LOAD
0001A4 41A4 2273FE          16      LD  (H_BINS+2),HL
0001A7 41A7 21BA46          10      LD  HL,ROM_RUN
0001AA 41AA 2278FE          16      LD  (H_BINL+2),HL
0001AD 41AD 21C746          10      LD  HL,ROM_FILES
0001B0 41B0 227DFE          16      LD  (H_FILE+2),HL
0001B3 41B3 214B4F          10      LD  HL,ROM_BDOS
0001B6 41B6 2233F3          16      LD  (H_BDOS+2),HL
0001B9 41B9 219943          10      LD  HL,ROM_STKE
0001BC 41BC 22DCFE          16      LD  (H_STKE+2),HL
0001BF 41BF 216E4D          10      LD  HL,DISKIO
0001C2 41C2 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001C5 41C5 3E                      DB  03EH
0001C6 41C6 C9              10      RET
0001C7 41C7 327FFE          13      LD  (H_FILE+4),A
0001CA 41CA 3275FE          13      LD  (H_BINS+4),A
0001CD 41CD 327AFE          13      LD  (H_BINL+4),A
0001D0 41D0 3235F3          13      LD  (H_BDOS+4),A
0001D3 41D3 32DEFE          13      LD  (H_STKE+4),A
0001D6 41D6 32ABFF          13      LD  (H_PHYD+4),A
                                
                                #if exists USE_NORMAL_32K_ROM
                                #else
                                    XOR A
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  A,(BANK1_ADR)
                                    CP  'A'
                                    JR  NZ,NOT_8K_BANK
                                    LD  A,DISK_BANK
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001D9 41D9 CD3801          17      CALL    RSLREG      ;read primary slot #
0001DC 41DC 07               4      RLCA
0001DD 41DD 07               4      RLCA
0001DE 41DE F5              11      PUSH    AF
0001DF 41DF 1605             7      LD  D,4+1
0001E1 41E1 CD3A42          17      CALL    GTSL2_
0001E4 41E4 3244F3          13      LD  (RAMAD3),A
0001E7 41E7 F1              10      POP AF
0001E8 41E8 07               4      RLCA
0001E9 41E9 07               4      RLCA
0001EA 41EA 1603             7      LD  D,2+1
0001EC 41EC CD3A42          17      CALL    GTSL2_
0001EF 41EF 2680             7      LD  H,080H
0001F1 41F1 CD5742          17      CALL    CHK_RAM
0001F4 41F4 3243F3          13      LD  (RAMAD2),A
       41F7                     RAMCHK2:
0001F7 41F7 3A44F3          13      LD  A,(RAMAD3)
0001FA 41FA 2640             7      LD  H,040H
0001FC 41FC CD5742          17      CALL    CHK_RAM
0001FF 41FF 3242F3          13      LD  (RAMAD1),A
       4202                     RAMCHK1:
000202 4202 3A44F3          13      LD  A,(RAMAD3)
000205 4205 2600             7      LD  H,00H
000207 4207 CD5742          17      CALL    CHK_RAM
00020A 420A 3241F3          13      LD  (RAMAD0),A
       420D                     RAMCHK0:
00020D 420D 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
000210 4210 010F00          10      LD  BC,0000FH       ;切り上げ
000213 4213 09              11      ADD HL,BC
000214 4214 7D               4      LD  A,L
                                
000215 4215 0604             7      LD  B,4
       4217                     B_DRIVE1:
000217 4217 CB3C             8      SRL H
000219 4219 1F               4      RRA
00021A 421A 10FB            13      DJNZ    B_DRIVE1
                                
00021C 421C C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
00021E 421E 3249F1          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
000221 4221 C9              10      RET
                                
       4222                     NOT_8K_BANK:
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K等)
000222 4222 21E743          10      LD  HL,MSG_ERROR_ROM_MODE
000225 4225 CD7243          17      CALL    MSX
000228 4228 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00022C 422C DD219F00        14      LD  IX,CHGET
000230 4230 C31C00          10      JP  _CALSLT
                                
       4233                     GTSL1_:             ;自分のいるスロットを知る
000233 4233 CD3801          17      CALL    RSLREG      ;read primary slot #
000236 4236 0F               4      RRCA
000237 4237 0F               4      RRCA
000238 4238 1601             7      LD  D,1
       423A                     GTSL2_:
00023A 423A E603             7      AND 3       ;[A]=000000PP
00023C 423C 5F               4      LD  E,A     ;[E]=000000PP
00023D 423D 21C1FC          10      LD  HL,EXPTBL
000240 4240 85               4      ADD A,L     ;桁上りは無い
000241 4241 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000242 4242 7B               4      LD  A,E     ;[A]=000000PP
000243 4243 CB7E            13      BIT 7,(HL)
000245 4245 C8              11      RET Z
000246 4246 7D               4      LD  A,L     ;point to SLTTBL entry
000247 4247 C604             7      ADD A,4     ;桁上りは無い
000249 4249 6F               4      LD  L,A
00024A 424A 7E               7      LD  A,(HL)      ;get currently expansion slot register
       424B                     GTSL3_:
00024B 424B 15               4      DEC D
00024C 424C 2803            12      JR  Z,GTSL4_:
00024E 424E 0F               4      RRCA
00024F 424F 18FA            12      JR  GTSL3_:
       4251                     GTSL4_:
000251 4251 E60C             7      AND 00CH        ;[A] = 0000SS00
000253 4253 B3               4      OR  E       ;[A] = 0000SSPP
000254 4254 F680             7      OR  080H        ;[A] = 1000SSPP
000256 4256 C9              10      RET
                                
       4257                     CHK_RAM:
000257 4257 E5              11      PUSH    HL
000258 4258 CDAC42          17      CALL    CHK_RAM0
00025B 425B E1              10      POP HL
00025C 425C C8              11      RET Z
00025D 425D 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000260 4260 E680             7      AND 080H
000262 4262 CD8342          17      CALL    CHK_RAM_SLT
000265 4265 C8              11      RET Z
000266 4266 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000269 4269 E680             7      AND 080H
00026B 426B C601             7      ADD A,1
00026D 426D CD8342          17      CALL    CHK_RAM_SLT
000270 4270 C8              11      RET Z
000271 4271 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000274 4274 E680             7      AND 080H
000276 4276 C602             7      ADD A,2
000278 4278 CD8342          17      CALL    CHK_RAM_SLT
00027B 427B C8              11      RET Z
00027C 427C 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
00027F 427F E680             7      AND 080H
000281 4281 C603             7      ADD A,3
       4283                     CHK_RAM_SLT:
000283 4283 E5              11      PUSH    HL
000284 4284 CDAC42          17      CALL    CHK_RAM0        ;スロット#X or X-0
000287 4287 E1              10      POP HL
000288 4288 C8              11      RET Z
000289 4289 CB79             8      BIT 7,C
00028B 428B 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
00028D 428D 79               4      LD  A,C
00028E 428E C604             7      ADD A,4*1           ;スロット#X-1
000290 4290 E5              11      PUSH    HL
000291 4291 CDAC42          17      CALL    CHK_RAM0
000294 4294 E1              10      POP HL
000295 4295 C8              11      RET Z
000296 4296 79               4      LD  A,C
000297 4297 C608             7      ADD A,4*2           ;スロット#X-2
000299 4299 E5              11      PUSH    HL
00029A 429A CDAC42          17      CALL    CHK_RAM0
00029D 429D E1              10      POP HL
00029E 429E C8              11      RET Z
00029F 429F 79               4      LD  A,C
0002A0 42A0 C60C             7      ADD A,4*3           ;スロット#X-3
0002A2 42A2 E5              11      PUSH    HL
0002A3 42A3 CDAC42          17      CALL    CHK_RAM0
0002A6 42A6 E1              10      POP HL
       42A7                     CHK_RAM_E:
0002A7 42A7 AF               4      XOR A
0002A8 42A8 3C               4      INC A           ;ZF=0にする
0002A9 42A9 3E00             7      LD  A,0
0002AB 42AB C9              10      RET
                                
       42AC                     CHK_RAM0:
0002AC 42AC 4F               4      LD  C,A
0002AD 42AD 3A00F1          13      LD  A,(ROM_SLT)
0002B0 42B0 B9               4      CP  C
0002B1 42B1 28F4            12      JR  Z,CHK_RAM_E
0002B3 42B3 2E00             7      LD  L,0
       42B5                     CHK_RAM1:
0002B5 42B5 79               4      LD  A,C
0002B6 42B6 DD210C00        14      LD  IX,_RDSLT
0002BA 42BA CDE742          17      CALL    CALSLT_R
0002BD 42BD C6E5             7      ADD A,0E5H
0002BF 42BF 47               4      LD  B,A
0002C0 42C0 5F               4      LD  E,A
0002C1 42C1 79               4      LD  A,C
0002C2 42C2 DD211400        14      LD  IX,_WRSLT
0002C6 42C6 CDE742          17      CALL    CALSLT_R
0002C9 42C9 79               4      LD  A,C
0002CA 42CA DD210C00        14      LD  IX,_RDSLT
0002CE 42CE CDE742          17      CALL    CALSLT_R
0002D1 42D1 B8               4      CP  B
0002D2 42D2 C0              11      RET NZ
0002D3 42D3 D6E5             7      SUB 0E5H
0002D5 42D5 79               4      LD  A,C
0002D6 42D6 5F               4      LD  E,A
0002D7 42D7 DD211400        14      LD  IX,_WRSLT
0002DB 42DB CDE742          17      CALL    CALSLT_R
0002DE 42DE 24               4      INC H
0002DF 42DF 7D               4      LD  A,L
0002E0 42E0 C604             7      ADD A,4
0002E2 42E2 6F               4      LD  L,A
0002E3 42E3 20D0            12      JR  NZ,CHK_RAM1
0002E5 42E5 79               4      LD  A,C     ;ZF=1のハズ
0002E6 42E6 C9              10      RET
                                
       42E7                     CALSLT_R:
0002E7 42E7 C5              11      PUSH    BC
0002E8 42E8 E5              11      PUSH    HL
0002E9 42E9 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0002ED 42ED CD1C00          17      CALL    _CALSLT
0002F0 42F0 E1              10      POP HL
0002F1 42F1 C1              10      POP BC
0002F2 42F2 C9              10      RET
                                
       42F3                     AT_ISC:
0002F3 F0E9                         ORG ISC,AT_ISC-RUN
       F0E9                     REPLACE_COMMAND:
0002F3 F0E9 FEB7             7      CP  0B7H            ;FILES
0002F5 F0EB CC7BFE          17      CALL    Z,H_FILE
0002F8 F0EE FEB5             7      CP  0B5H            ;LOAD
0002FA F0F0 CA71FE          10      JP  Z,H_BINS
0002FD F0F3 FE8A             7      CP  08AH            ;RUN
0002FF F0F5 CA76FE          10      JP  Z,H_BINL
000302 F0F8 FED6             7      CP  0D6H            ;COPY
000304 F0FA 2813            12      JR  Z,FIX_COPY
000306 F0FC FECF             7      CP  0CFH            ;BLOAD
000308 F0FE C0              11      RET NZ
       F0FF                     FIX_BLOAD:
000309 F0FF F7              12      RST 30H
       F100                     ROM_SLT:
00030A F100 00                      DB  0
00030B F101 F745                    DW  ROM_BLOAD
00030D F103 F5              11      PUSH    AF
00030E F104 E5              11      PUSH    HL
00030F F105 CD0EF1          17      CALL    BLOAD_RET
       F106                     SWC_BLOAD   EQU $-2
000312 F108 E1              10      POP HL
000313 F109 F1              10      POP AF
000314 F10A FECF             7      CP  0CFH            ;BLOAD
       F10C                     SWC_BLOAD_M:
000316 F10C 28DB            12      JR  Z,REPLACE_COMMAND
       F10E                     BLOAD_RET:
000318 F10E C9              10      RET
       F10F                     FIX_COPY:
000319 F10F F7              12      RST 30H
       F110                     ROM_SLT_COPY:
00031A F110 00                      DB  0
00031B F111 4C47                    DW  ROM_COPY
00031D F113 C9              10      RET
       F114                     ROMUSE1:
00031E F114 3A00F1          13      LD  A,(ROM_SLT)
000321 F117 1803            12      JR  ROMUSE2
       F119                     RAMUSE1:
000323 F119 3A42F3          13      LD  A,(RAMAD1)
       F11C                     ROMUSE2:
000326 F11C C32400          10      JP  _ENASLT
                                
       F11F                     _RESULT:
000329 F11F 00                      DB  0
       F120                     _BANK:
00032A F120 00                      DB  0
       F121                     CLSZ:               ;クラスタサイズ
00032B F121 0004                    DW  1024
       F122                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F123                     SECSZ:              ;セクタサイズ
00032D F123 0002                    DW  512
       F124                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F125                     RR_LOW:
00032F F125 0000                    DW  0
       F126                     RR_MID  EQU $-1
       F127                     RR_HIGH:
000331 F127 0000                    DW  0
       F129                     _CLPS:
000333 F129 0000                    DW  0
       F12B                     _LEFT:
000335 F12B 0000                    DW  0
       F12D                     _DTPS:
000337 F12D 0000                    DW  0
       F12F                     _DTA:
000339 F12F 0000                    DW  0
       F131                     FLG_LDIR:
00033B F131 00                      DB  0
                                
                                ;   BDOS
00033C F132 F7              12      RST 30H
00033D F133 00                      DB  0
00033E F134 4B4F                    DW  ROM_BDOS
000340 F136 C9              10      RET 
       F137                     _FCB:
000341 F137 0000                    DW  0
       F139                     _BUF:
       F139                     _BUF_LO:        ;LOGICAL OPERATION
000343 F139 00                      DB  0
       F13A                     _BUF_ST:
000344 F13A 0000                    DW  0
       F13C                     _BUF_EN:
000346 F13C 0000                    DW  0
       F13E                     _BUF_EX:
       F13E                     _BUF_W:
000348 F13E 0000                    DW  0
       F140                     _BUF_H:
00034A F140 0000                    DW  0
       F142                     _BUF_X:
00034C F142 0000                    DW  0
       F144                     _BUF_Y:
00034E F144 00                      DB  0
       F145                     _BUF_P:
00034F F145 00                      DB  0
       F146                     _BUF_O:
000350 F146 00                      DB  0
       F147                     DTAX:
000351 F147 0000                    DW  0
       F149                     B_DRIVE:
000353 F149 00                      DB  0
       F14A                     _DVSW:
000354 F14A 00                      DB  0
       F14B                     FCBX:
000355 F14B 0000                    DW  0
       F14D                     LEFTX:
000357 F14D 0000                    DW  0
       F14F                     PARAM0:
000359 F14F 0000                    DW  0
       F151                     PARAM1:
00035B F151 0000                    DW  0
       F153                     FDRV:
00035D F153 00                      DB  0
       F154                     FNAME:
00035E F154                         DS  8+3
                                
       F15F                     BASSTK:
000369 F15F 0000                    DW  0
       F161                     _HL:
00036B F161 0000                    DW  0
       F163                     _SP:
00036D F163 0000                    DW  0
                                
       F165                     ISC_E:
00036F 436F                         ORG $$+RUN          ;$DEPHASE
                                
       436F                     MSX1:
00036F 436F CD644F          17      CALL    MSGA1
       4372                     MSX:
000372 4372 7E               7      LD  A,(HL)
000373 4373 23               6      INC HL
000374 4374 B7               4      OR  A
000375 4375 20F8            12      JR  NZ,MSX1
000377 4377 C9              10      RET
                                
       4378                     PRTHX:
000378 4378 F5              11      PUSH    AF
000379 4379 07               4      RLCA
00037A 437A 07               4      RLCA
00037B 437B 07               4      RLCA
00037C 437C 07               4      RLCA
00037D 437D CD8143          17      CALL    PRTA2
000380 4380 F1              10      POP AF
       4381                     PRTA2:
000381 4381 CD8743          17      CALL    ASC
000384 4384 C3604F          10      JP  MSG_A
                                    
       4387                     ASC:
000387 4387 E60F             7      AND $0F
000389 4389 F630             7      OR  $30
00038B 438B FE3A             7      CP  $3A
00038D 438D D8              11      RET C
00038E 438E C607             7      ADD A,7
000390 4390 C9              10      RET
                                
       4391                     MSN:
000391 4391 7E               7      LD  A,(HL)
000392 4392 23               6      INC HL
000393 4393 CD604F          17      CALL    MSG_A
000396 4396 10F9            13      DJNZ    MSN
000398 4398 C9              10      RET
                                
       4399                     ROM_STKE:
000399 4399 3E                      DB  03EH
00039A 439A C9              10      RET
00039B 439B 32DAFE          13      LD  (H_STKE),A
00039E 439E E5              11      PUSH    HL
00039F 439F D5              11      PUSH    DE
0003A0 43A0 C5              11      PUSH    BC
0003A1 43A1 181D            12      JR  BASAUTO
                                
0003A3 43A3 AF               4      XOR A
0003A4 43A4 5F               4      LD  E,A
0003A5 43A5 57               4      LD  D,A
0003A6 43A6 0601             7      LD  B,1
0003A8 43A8 2100C0          10      LD  HL,0C000H
0003AB 43AB CD6E4D          17      CALL    DISKIO
                                
0003AE 43AE ED735FF1        20      LD  (BASSTK),SP
0003B2 43B2 116BF3          10      LD  DE,RAMUSE
0003B5 43B5 AF               4      XOR A
0003B6 43B6 CD1EC0          17      CALL    0C01EH
0003B9 43B9 116BF3          10      LD  DE,RAMUSE
0003BC 43BC 37               4      SCF
0003BD 43BD CD1EC0          17      CALL    0C01EH
       43C0                     BASAUTO:
0003C0 43C0 210D44          10      LD  HL,AUTOEXEC
0003C3 43C3 1153F1          10      LD  DE,FDRV
0003C6 43C6 010C00          10      LD  BC,1+8+3
0003C9 43C9 EDB0                    LDIR
0003CB 43CB CD124B          17      CALL    ROM_OPEN
0003CE 43CE 3813            12      JR  C,RSTKEE
0003D0 43D0 211944          10      LD  HL,RUN_AUTOEXEC
0003D3 43D3 11F0FB          10      LD  DE,KEYBUF
0003D6 43D6 ED53FAF3        20      LD  (GETPNT),DE
0003DA 43DA 011300          10      LD  BC,RUN_AUTOEXEC_E-RUN_AUTOEXEC
0003DD 43DD EDB0                    LDIR
0003DF 43DF ED53F8F3        20      LD  (PUTPNT),DE
       43E3                     RSTKEE:
0003E3 43E3 C1              10      POP BC
0003E4 43E4 D1              10      POP DE
0003E5 43E5 E1              10      POP HL
0003E6 43E6 C9              10      RET
                                
       43E7                     MSG_ERROR_ROM_MODE:
0003E7 43E7 41534349492D384B        DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
            2F4B6F6E616D692D    
            384B2F4B6F6E616D    
            692D534343206F6E    
            6C79210D0A          
       440C                     NULL:
00040C 440C 00                      DB  0
                                
       440D                     AUTOEXEC:
00040D 440D 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       4419                     RUN_AUTOEXEC:
000419 4419 52554E2022415554        DB  'RUN "AUTOEXEC.BAS"',00DH
            4F455845432E4241    
            53220D              
                                ;   DB  'LOAD "AUTOEXEC.BAS"',00DH  ;テスト用
       442C                     RUN_AUTOEXEC_E:
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       442C                     ROM_LDIR:
00042C 442C 3A31F1          13      LD  A,(FLG_LDIR)
00042F 442F B7               4      OR  A
000430 4430 2062            12      JR  NZ,ROM_LDIRVM
000432 4432 CB7A             8      BIT 7,D
000434 4434 CABC44          10      JP  Z,ROM_LDIRSLT
                                
                                #if exists USE_NORMAL_32K_ROM
000437 4437 ED7363F1        20      LD  (_SP),SP
00043B 443B 3121FB          10      LD  SP,DRVTBL
       443E                     LDIR1:
00043E 443E 78               4      LD  A,B
00043F 443F B1               4      OR  C
000440 4440 2841            12      JR  Z,LDIRE
                                
000442 4442 C5              11      PUSH    BC
000443 4443 D5              11      PUSH    DE
000444 4444 E5              11      PUSH    HL
000445 4445 3A00F1          13      LD  A,(ROM_SLT)
000448 4448 2680             7      LD  H,080H
00044A 444A CD2400          17      CALL    _ENASLT
00044D 444D E1              10      POP HL
00044E 444E D1              10      POP DE
00044F 444F C1              10      POP BC
       4450                     LDIR2:
000450 4450 7A               4      LD  A,D
000451 4451 FEC0             7      CP  0C0H
000453 4453 302C            12      JR  NC,LDIR4
                                
000455 4455 C5              11      PUSH    BC
000456 4456 D5              11      PUSH    DE
000457 4457 115EF5          10      LD  DE,BUF
                                
00045A 445A 78               4      LD  A,B
00045B 445B B7               4      OR  A
00045C 445C 2803            12      JR  Z,LDIR3
00045E 445E 010001          10      LD  BC,00100H
       4461                     LDIR3:
000461 4461 C5              11      PUSH    BC
000462 4462 EDB0                    LDIR
000464 4464 2261F1          16      LD  (_HL),HL
                                
000467 4467 3A43F3          13      LD  A,(RAMAD2)
00046A 446A 2680             7      LD  H,080H
00046C 446C CD2400          17      CALL    _ENASLT
                                
00046F 446F 215EF5          10      LD  HL,BUF
000472 4472 C1              10      POP BC
000473 4473 D1              10      POP DE
000474 4474 EDB0                    LDIR
                                
000476 4476 2A61F1          16      LD  HL,(_HL)
000479 4479 C1              10      POP BC
00047A 447A 78               4      LD  A,B
00047B 447B B7               4      OR  A
00047C 447C 2805            12      JR  Z,LDIRE
00047E 447E 05               4      DEC B
00047F 447F 18BD            12      JR  LDIR1
       4481                     LDIR4:
                                #endif
000481 4481 EDB0                    LDIR
                                
                                #if exists USE_NORMAL_32K_ROM
       4483                     LDIRE:
000483 4483 D5              11      PUSH    DE
000484 4484 E5              11      PUSH    HL
000485 4485 3A43F3          13      LD  A,(RAMAD2)
000488 4488 2680             7      LD  H,080H
00048A 448A CD2400          17      CALL    _ENASLT
00048D 448D E1              10      POP HL
00048E 448E D1              10      POP DE
00048F 448F ED7B63F1        20      LD  SP,(_SP)
                                #endif
000493 4493 C9              10      RET
                                
       4494                     ROM_LDIRVM:
                                #if exists USE_NORMAL_32K_ROM
000494 4494 C5              11      PUSH    BC
000495 4495 D5              11      PUSH    DE
000496 4496 E5              11      PUSH    HL
000497 4497 3A00F1          13      LD  A,(ROM_SLT)
00049A 449A 2680             7      LD  H,080H
00049C 449C CD2400          17      CALL    _ENASLT
00049F 449F E1              10      POP HL
0004A0 44A0 D1              10      POP DE
0004A1 44A1 C1              10      POP BC
                                #endif
0004A2 44A2 C5              11      PUSH    BC
0004A3 44A3 D5              11      PUSH    DE
0004A4 44A4 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0004A8 44A8 DD215C00        14      LD  IX,LDIRVM
0004AC 44AC CD1C00          17      CALL    _CALSLT
                                #if exists USE_NORMAL_32K_ROM
0004AF 44AF 2680             7      LD  H,080H
0004B1 44B1 3A43F3          13      LD  A,(RAMAD2)
0004B4 44B4 CD2400          17      CALL    _ENASLT
                                #endif
0004B7 44B7 E1              10      POP HL
0004B8 44B8 C1              10      POP BC
0004B9 44B9 09              11      ADD HL,BC
0004BA 44BA EB               4      EX  DE,HL
0004BB 44BB C9              10      RET
                                
       44BC                     ROM_LDIRSLT:
0004BC 44BC EB               4      EX  DE,HL
       44BD                     RLDIRSLT1:
0004BD 44BD 1A               7      LD  A,(DE)
0004BE 44BE 13               6      INC DE
0004BF 44BF C5              11      PUSH    BC
0004C0 44C0 D5              11      PUSH    DE
0004C1 44C1 E5              11      PUSH    HL
0004C2 44C2 5F               4      LD  E,A
0004C3 44C3 3A42F3          13      LD  A,(RAMAD1)
0004C6 44C6 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0004CA 44CA DD211400        14      LD  IX,_WRSLT
0004CE 44CE CD1C00          17      CALL    _CALSLT
0004D1 44D1 E1              10      POP HL
0004D2 44D2 D1              10      POP DE
0004D3 44D3 C1              10      POP BC
0004D4 44D4 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0004D6 44D6 EABD44          10      JP  PE,RLDIRSLT1
0004D9 44D9 EB               4      EX  DE,HL
0004DA 44DA C9              10      RET
                                
       44DB                     END_OF_LINE:
0004DB 44DB 215EF5          10      LD  HL,BUF
       44DE                     EOL1:
0004DE 44DE 7E               7      LD  A,(HL)
0004DF 44DF C8              11      RET Z
0004E0 44E0 FE0D             7      CP  00DH
0004E2 44E2 2807            12      JR  Z,EOLE
0004E4 44E4 FE0A             7      CP  00AH
0004E6 44E6 2803            12      JR  Z,EOLE
0004E8 44E8 23               6      INC HL
0004E9 44E9 18F3            12      JR  EOL1
       44EB                     EOLE:
0004EB 44EB 3600            10      LD  (HL),0
0004ED 44ED 23               6      INC HL
0004EE 44EE 7E               7      LD  A,(HL)
0004EF 44EF FE0A             7      CP  00AH
0004F1 44F1 C0              11      RET NZ
0004F2 44F2 23               6      INC HL
0004F3 44F3 C9              10      RET
                                
       44F4                     ROM_LOAD_ASCII:
0004F4 44F4 210000          10      LD  HL,0
0004F7 44F7 223AF1          16      LD  (_BUF_ST),HL    ;読み出し位置
0004FA 44FA 2A76F6          16      LD  HL,(TXTTAB)
0004FD 44FD 223CF1          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
000500 4500 215EF5          10      LD  HL,BUF
000503 4503 222FF1          16      LD  (_DTA),HL
       4506                     RLOAD_A1:
000506 4506 2A3AF1          16      LD  HL,(_BUF_ST)
000509 4509 2225F1          16      LD  (RR_LOW),HL
00050C 450C 210201          10      LD  HL,258
00050F 450F CD3249          17      CALL    ROM_READ
000512 4512 7C               4      LD  A,H
000513 4513 B5               4      OR  L
000514 4514 2877            12      JR  Z,RLOAD_AEND
000516 4516 015EF5          10      LD  BC,BUF
000519 4519 09              11      ADD HL,BC
00051A 451A 3600            10      LD  (HL),0
00051C 451C CDDB44          17      CALL    END_OF_LINE
00051F 451F 015EF5          10      LD  BC,BUF
000522 4522 A7               4      AND A
000523 4523 ED42            15      SBC HL,BC
000525 4525 2810            12      JR  Z,RLOAD_A2
000527 4527 4D               4      LD  C,L
000528 4528 44               4      LD  B,H
000529 4529 ED5B3AF1        20      LD  DE,(_BUF_ST)
00052D 452D 19              11      ADD HL,DE
00052E 452E 223AF1          16      LD  (_BUF_ST),HL
000531 4531 3A5EF5          13      LD  A,(BUF)
000534 4534 B7               4      OR  A
000535 4535 28CF            12      JR  Z,RLOAD_A1
       4537                     RLOAD_A2:
000537 4537 115EF5          10      LD  DE,BUF
00053A 453A CDA94A          17      CALL    SPCUTEX
00053D 453D 1A               7      LD  A,(DE)
00053E 453E B7               4      OR  A
00053F 453F 284C            12      JR  Z,RLOAD_AEND
000541 4541 CDBB4A          17      CALL    GETNUM
000544 4544 7C               4      LD  A,H
000545 4545 B5               4      OR  L
000546 4546 CAE445          10      JP  Z,ERROR_DIRECT_IN_FILE
000549 4549 DD2A3CF1        20      LD  IX,(_BUF_EN)
00054D 454D DD7502          19      LD  (IX+2),L
000550 4550 DD7403          19      LD  (IX+3),H
                                
000553 4553 CDA24A          17      CALL    SPCUT
000556 4556 EB               4      EX  DE,HL
000557 4557 DDE5            15      PUSH    IX
000559 4559 DD21B242        14      LD  IX,CRUNCH
00055D 455D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000561 4561 CD1C00          17      CALL    _CALSLT
000564 4564 DDE1            14      POP IX
000566 4566 EB               4      EX  DE,HL
000567 4567 111FF4          10      LD  DE,KBUF
00056A 456A 37               4      SCF
00056B 456B ED52            15      SBC HL,DE
00056D 456D 2875            12      JR  Z,ERROR_DIRECT_IN_FILE
00056F 456F 3873            12      JR  C,ERROR_DIRECT_IN_FILE
000571 4571 4D               4      LD  C,L
000572 4572 44               4      LD  B,H
000573 4573 2A3CF1          16      LD  HL,(_BUF_EN)
000576 4576 110400          10      LD  DE,4
000579 4579 19              11      ADD HL,DE
00057A 457A 111FF4          10      LD  DE,KBUF
                                
00057D 457D EB               4      EX  DE,HL
00057E 457E EDB0                    LDIR
000580 4580 EB               4      EX  DE,HL
                                
000581 4581 DD7500          19      LD  (IX+0),L
000584 4584 DD7401          19      LD  (IX+1),H
000587 4587 223CF1          16      LD  (_BUF_EN),HL
00058A 458A C30645          10      JP  RLOAD_A1
                                
       458D                     RLOAD_AEND:
00058D 458D 2A3CF1          16      LD  HL,(_BUF_EN)
000590 4590 AF               4      XOR A
000591 4591 77               7      LD  (HL),A
000592 4592 23               6      INC HL
000593 4593 77               7      LD  (HL),A
000594 4594 23               6      INC HL
000595 4595 223CF1          16      LD  (_BUF_EN),HL
000598 4598 1833            12      JR  RLOAD_END1
                                
       459A                     ROM_LOAD:
00059A 459A CD1D47          17      CALL    INIT_PARAM
00059D 459D CDD249          17      CALL    FILE_B
0005A0 45A0 CD124B          17      CALL    ROM_OPEN
0005A3 45A3 3845            12      JR  C,ERROR_FILE_NOT_FOUND
                                
0005A5 45A5 2139F1          10      LD  HL,_BUF
0005A8 45A8 222FF1          16      LD  (_DTA),HL
0005AB 45AB 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
0005AE 45AE CD3249          17      CALL    ROM_READ
0005B1 45B1 3A39F1          13      LD  A,(_BUF)
0005B4 45B4 3C               4      INC A
0005B5 45B5 C2F444          10      JP  NZ,ROM_LOAD_ASCII
0005B8 45B8 2A76F6          16      LD  HL,(TXTTAB)
0005BB 45BB 222FF1          16      LD  (_DTA),HL
0005BE 45BE EB               4      EX  DE,HL
0005BF 45BF 2100FF          10      LD  HL,-256
0005C2 45C2 39              11      ADD HL,SP
0005C3 45C3 ED52            15      SBC HL,DE
0005C5 45C5 CD3249          17      CALL    ROM_READ
0005C8 45C8 ED5B2FF1        20      LD  DE,(_DTA)
0005CC 45CC 19              11      ADD HL,DE
       45CD                     RLOAD_END1:
0005CD 45CD 22C2F6          16      LD  (VARTAB),HL
0005D0 45D0 22C4F6          16      LD  (ARYTAB),HL
0005D3 45D3 22C6F6          16      LD  (STREND),HL
                                
0005D6 45D6 AF               4      XOR A
0005D7 45D7 213CF1          10      LD  HL,_BUF+3
0005DA 45DA 77               7      LD  (HL),A
0005DB 45DB 2B               6      DEC HL
0005DC 45DC 77               7      LD  (HL),A
0005DD 45DD 2B               6      DEC HL
0005DE 45DE 77               7      LD  (HL),A
0005DF 45DF 2B               6      DEC HL
0005E0 45E0 3E8F             7      LD  A,08FH          ;REM
0005E2 45E2 77               7      LD  (HL),A
0005E3 45E3 C9              10      RET
                                
       45E4                     ERROR_DIRECT_IN_FILE:
0005E4 45E4 1E39             7      LD  E,57            ;Direct statement in file
0005E6 45E6 01                      DB  1           ;LD BC,
       45E7                     ERROR_FILE_NOT_OPEN:
0005E7 45E7 1E3B             7      LD  E,59            ;File not OPEN
0005E9 45E9 01                      DB  1           ;LD BC,
       45EA                     ERROR_FILE_NOT_FOUND:
0005EA 45EA 1E35             7      LD  E,53            ;File not found
       45EC                     ERROR:
0005EC 45EC FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0005F0 45F0 DD216F40        14      LD  IX,ERRHAND
0005F4 45F4 C31C00          10      JP  _CALSLT
                                
       45F7                     ROM_BLOAD:
0005F7 45F7 CD1D47          17      CALL    INIT_PARAM
0005FA 45FA CDD249          17      CALL    FILE_B
0005FD 45FD CD124B          17      CALL    ROM_OPEN
000600 4600 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000602 4602 2139F1          10      LD  HL,_BUF
000605 4605 222FF1          16      LD  (_DTA),HL
000608 4608 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
00060B 460B CD3249          17      CALL    ROM_READ
00060E 460E 3A39F1          13      LD  A,(_BUF)
000611 4611 FEFE             7      CP  0FEH
000613 4613 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
000615 4615 210EF1          10      LD  HL,BLOAD_RET
000618 4618 2206F1          16      LD  (SWC_BLOAD),HL
                                
00061B 461B 2A51F1          16      LD  HL,(PARAM1)
00061E 461E 7E               7      LD  A,(HL)
00061F 461F FE2C             7      CP  ','
000621 4621 2048            12      JR  NZ,RBREAD_MEM
000623 4623 23               6      INC HL
000624 4624 7E               7      LD  A,(HL)
000625 4625 CDFC4A          17      CALL    CAP
000628 4628 32BEFC          13      LD  (RUNBNF),A
       462B                     RBOS1:
00062B 462B 7E               7      LD  A,(HL)
00062C 462C 23               6      INC HL
00062D 462D B7               4      OR  A
00062E 462E 282F            12      JR  Z,RBREAD_OSE
000630 4630 FE3A             7      CP  ':'
000632 4632 282B            12      JR  Z,RBREAD_OSE
000634 4634 FE2C             7      CP  ','     ;次のパラメータを探す
000636 4636 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
000638 4638 2251F1          16      LD  (PARAM1),HL
00063B 463B 7E               7      LD  A,(HL)
00063C 463C B7               4      OR  A
00063D 463D 2820            12      JR  Z,RBREAD_OSE
00063F 463F DD21644C        14      LD  IX,FRMEVL
000643 4643 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000647 4647 CD1C00          17      CALL    _CALSLT
00064A 464A 2251F1          16      LD  (PARAM1),HL
00064D 464D 3A63F6          13      LD  A,(VALTYP)
000650 4650 FE02             7      CP  2
000652 4652 200B            12      JR  NZ,RBREAD_OSE
000654 4654 2A3AF1          16      LD  HL,(_BUF_ST)
000657 4657 ED5BF8F7        20      LD  DE,(DACDAT)
00065B 465B 19              11      ADD HL,DE
00065C 465C 223AF1          16      LD  (_BUF_ST),HL
       465F                     RBREAD_OSE:
00065F 465F 3ABEFC          13      LD  A,(RUNBNF)
000662 4662 FE53             7      CP  'S'
000664 4664 2005            12      JR  NZ,RBREAD_MEM
000666 4666 3E01             7      LD  A,1
000668 4668 3231F1          13      LD  (FLG_LDIR),A
       466B                     RBREAD_MEM:
00066B 466B 2A3AF1          16      LD  HL,(_BUF_ST)
00066E 466E 22BFFC          16      LD  (SAVENT),HL
000671 4671 222FF1          16      LD  (_DTA),HL
000674 4674 21FFFF          10      LD  HL,0FFFFH
000677 4677 CD3249          17      CALL    ROM_READ
00067A 467A 3ABEFC          13      LD  A,(RUNBNF)
00067D 467D FE52             7      CP  'R'
00067F 467F 2006            12      JR  NZ,RBREAD1
000681 4681 2A3EF1          16      LD  HL,(_BUF_EX)
000684 4684 2206F1          16      LD  (SWC_BLOAD),HL
       4687                     RBREAD1:
       4687                     ROM_NEXT:
000687 4687 2A51F1          16      LD  HL,(PARAM1)
00068A 468A 7E               7      LD  A,(HL)
00068B 468B 2B               6      DEC HL
00068C 468C B7               4      OR  A
00068D 468D 2805            12      JR  Z,RN1
00068F 468F FE3A             7      CP  ':'
000691 4691 2801            12      JR  Z,RN1
000693 4693 23               6      INC HL
       4694                     RN1:
000694 4694 5D               4      LD  E,L
000695 4695 54               4      LD  D,H
                                
000696 4696 CDD24A          17      CALL    SEARCH_END
000699 4699 B7               4      OR  A
00069A 469A 281A            12      JR  Z,REM
                                                    ;マルチステートメントの処理
00069C 469C 7E               7      LD  A,(HL)
                                
00069D 469D FEB5             7      CP  0B5H            ;LOAD
00069F 469F CA9A45          10      JP  Z,ROM_LOAD
0006A2 46A2 FE8A             7      CP  08AH            ;RUN
0006A4 46A4 2814            12      JR  Z,ROM_RUN
0006A6 46A6 FEB7             7      CP  0B7H            ;FILES
0006A8 46A8 281D            12      JR  Z,ROM_FILES
0006AA 46AA FED6             7      CP  0D6H            ;COPY
0006AC 46AC CA4C47          10      JP  Z,ROM_COPY
0006AF 46AF 3E28             7      LD  A,028H          ;JR Z,
0006B1 46B1 320CF1          13      LD  (SWC_BLOAD_M),A
0006B4 46B4 7E               7      LD  A,(HL)
0006B5 46B5 C9              10      RET
                                
       46B6                     REM:
0006B6 46B6 EB               4      EX  DE,HL
0006B7 46B7 3E8F             7      LD  A,08FH          ;REM
0006B9 46B9 C9              10      RET
                                
       46BA                     ROM_RUN:
0006BA 46BA 23               6      INC HL
0006BB 46BB 7E               7      LD  A,(HL)
0006BC 46BC 2B               6      DEC HL
0006BD 46BD B7               4      OR  A
0006BE 46BE 2803            12      JR  Z,ROM_RUN1
0006C0 46C0 CD9A45          17      CALL    ROM_LOAD
       46C3                     ROM_RUN1:
0006C3 46C3 3E8A             7      LD  A,08AH          ;RUN
0006C5 46C5 77               7      LD  (HL),A
0006C6 46C6 C9              10      RET
                                
       46C7                     ROM_FILES:
0006C7 46C7 CD1D47          17      CALL    INIT_PARAM
0006CA 46CA CDD249          17      CALL    FILE_B
0006CD 46CD CD034F          17      CALL    GET_DISK_BANK_FDRV
0006D0 46D0 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0006D3 46D3 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0006D6 46D6 3A54F1          13      LD  A,(FNAME)
0006D9 46D9 FE21             7      CP  021H
0006DB 46DB 3005            12      JR  NC,RFILES0
0006DD 46DD 060B             7      LD  B,11
0006DF 46DF CD664A          17      CALL    FILE10
       46E2                     RFILES0:
0006E2 46E2 CD2F4D          17      CALL    GET_DIR_DAT
       46E5                     RFILES1:
0006E5 46E5 CD2E4B          17      CALL    FILESE
0006E8 46E8 302E            12      JR  NC,RFILES_NOT_MATCH
       46EA                     RFILES_DISP:
0006EA 46EA E5              11      PUSH    HL
0006EB 46EB 0608             7      LD  B,8
0006ED 46ED CD9143          17      CALL    MSN
0006F0 46F0 3E2E             7      LD  A,'.'
0006F2 46F2 CD604F          17      CALL    MSG_A
0006F5 46F5 0603             7      LD  B,3
0006F7 46F7 CD9143          17      CALL    MSN
0006FA 46FA 3ADDF3          13      LD  A,(CSRX)
0006FD 46FD 47               4      LD  B,A
0006FE 46FE 3AB0F3          13      LD  A,(LINLEN)
000701 4701 90               4      SUB B
000702 4702 FE0C             7      CP  12
000704 4704 3009            12      JR  NC,RFILES2
000706 4706 3E0D             7      LD  A,00DH      ;改行
000708 4708 CD604F          17      CALL    MSG_A
00070B 470B 3E0A             7      LD  A,00AH
00070D 470D 1802            12      JR  RFILES3
       470F                     RFILES2:
00070F 470F 3E20             7      LD  A,020H
       4711                     RFILES3:
000711 4711 CD604F          17      CALL    MSG_A
000714 4714 E1              10      POP HL
000715 4715 CD4A4B          17      CALL    FNEXT
       4718                     RFILES_NOT_MATCH:
000718 4718 20CB            12      JR  NZ,RFILES1
00071A 471A C38746          10      JP  ROM_NEXT
                                
       471D                     INIT_PARAM:
00071D 471D 224FF1          16      LD  (PARAM0),HL
000720 4720 2251F1          16      LD  (PARAM1),HL
000723 4723 EB               4      EX  DE,HL
000724 4724 AF               4      XOR A
000725 4725 3231F1          13      LD  (FLG_LDIR),A
000728 4728 32BEFC          13      LD  (RUNBNF),A
00072B 472B 3263F6          13      LD  (VALTYP),A
00072E 472E 13               6      INC DE
00072F 472F CDA24A          17      CALL    SPCUT
000732 4732 1A               7      LD  A,(DE)
000733 4733 B7               4      OR  A
000734 4734 C8              11      RET Z
000735 4735 FE3A             7      CP  ':'
000737 4737 C8              11      RET Z
000738 4738 FE28             7      CP  '('
00073A 473A C8              11      RET Z
00073B 473B EB               4      EX  DE,HL
00073C 473C DD21644C        14      LD  IX,FRMEVL
000740 4740 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000744 4744 CD1C00          17      CALL    _CALSLT
000747 4747 2251F1          16      LD  (PARAM1),HL
00074A 474A C9              10      RET
                                
00074B 474B 00               4      NOP
       474C                     ROM_COPY:
00074C 474C CD1D47          17      CALL    INIT_PARAM
00074F 474F 3A63F6          13      LD  A,(VALTYP)
000752 4752 FE03             7      CP  3       ;string
000754 4754 C2CD49          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
000757 4757 CDD249          17      CALL    FILE_B
00075A 475A CD124B          17      CALL    ROM_OPEN
00075D 475D DAEA45          10      JP  C,ERROR_FILE_NOT_FOUND
                                
000760 4760 213EF1          10      LD  HL,_BUF_W
000763 4763 222FF1          16      LD  (_DTA),HL
000766 4766 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
000769 4769 CD3249          17      CALL    ROM_READ
                                
00076C 476C AF               4      XOR A
00076D 476D 3239F1          13      LD  (_BUF_LO),A     ;PSET
000770 4770 3246F1          13      LD  (_BUF_O),A      ;向き
                                
000773 4773 2A51F1          16      LD  HL,(PARAM1)
       4776                     RCP_PARAM1:
000776 4776 7E               7      LD  A,(HL)
000777 4777 23               6      INC HL
000778 4778 B7               4      OR  A
000779 4779 CACD49          10      JP  Z,ROM_ORG
00077C 477C FE3A             7      CP  ':'
00077E 477E CACD49          10      JP  Z,ROM_ORG
000781 4781 FE2C             7      CP  ','
000783 4783 2012            12      JR  NZ,RCP_PARAM1_
                                
000785 4785 DD212F54        14      LD  IX,FRMQNT
000789 4789 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00078D 478D CD1C00          17      CALL    _CALSLT
000790 4790 7B               4      LD  A,E
000791 4791 87               4      ADD A,A
000792 4792 87               4      ADD A,A
000793 4793 3246F1          13      LD  (_BUF_O),A
000796 4796 7E               7      LD  A,(HL)
       4797                     RCP_PARAM1_:
000797 4797 FE28             7      CP  '('
000799 4799 20DB            12      JR  NZ,RCP_PARAM1
                                
00079B 479B DD212F54        14      LD  IX,FRMQNT
00079F 479F FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007A3 47A3 CD1C00          17      CALL    _CALSLT
                                
0007A6 47A6 ED5342F1        20      LD  (_BUF_X),DE
                                
       47AA                     RCP_PARAM2:
0007AA 47AA 23               6      INC HL
0007AB 47AB 7E               7      LD  A,(HL)
0007AC 47AC FE20             7      CP  020H
0007AE 47AE 28FA            12      JR  Z,RCP_PARAM2
0007B0 47B0 FE2C             7      CP  ','
0007B2 47B2 28F6            12      JR  Z,RCP_PARAM2
                                
0007B4 47B4 DD212F54        14      LD  IX,FRMQNT
0007B8 47B8 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007BC 47BC CD1C00          17      CALL    _CALSLT
                                
0007BF 47BF ED5344F1        20      LD  (_BUF_Y),DE
       47C3                     RCP_PARAM3:
0007C3 47C3 23               6      INC HL
0007C4 47C4 7E               7      LD  A,(HL)
0007C5 47C5 FE20             7      CP  020H
0007C7 47C7 28FA            12      JR  Z,RCP_PARAM3
0007C9 47C9 FE29             7      CP  ')'
0007CB 47CB 28F6            12      JR  Z,RCP_PARAM3
0007CD 47CD FE2C             7      CP  ','
0007CF 47CF 2033            12      JR  NZ,RCP_ST
                                
0007D1 47D1 23               6      INC HL
0007D2 47D2 DD212F54        14      LD  IX,FRMQNT
0007D6 47D6 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007DA 47DA CD1C00          17      CALL    _CALSLT
                                
0007DD 47DD 7B               4      LD  A,E
0007DE 47DE 3245F1          13      LD  (_BUF_P),A
                                
       47E1                     RCP_PARAM4:
0007E1 47E1 7E               7      LD  A,(HL)
0007E2 47E2 23               6      INC HL
0007E3 47E3 FE20             7      CP  020H
0007E5 47E5 28FA            12      JR  Z,RCP_PARAM4
                                
0007E7 47E7 FE2C             7      CP  ','
0007E9 47E9 2019            12      JR  NZ,RCP_ST
                                
0007EB 47EB 7E               7      LD  A,(HL)
0007EC 47EC 0604             7      LD  B,4
0007EE 47EE FEC3             7      CP  0C3H        ;PRESET
0007F0 47F0 280E            12      JR  Z,RCP_LO
0007F2 47F2 05               4      DEC B       ;3
0007F3 47F3 D6F8             7      SUB 0F8H        ;XOR
0007F5 47F5 2809            12      JR  Z,RCP_LO
0007F7 47F7 05               4      DEC B       ;2
0007F8 47F8 3C               4      INC A       ;OR
0007F9 47F9 2805            12      JR  Z,RCP_LO
0007FB 47FB 05               4      DEC B       ;1
0007FC 47FC 3C               4      INC A       ;AND
0007FD 47FD 2801            12      JR  Z,RCP_LO
0007FF 47FF 05               4      DEC B       ;0
                                                ;PSET
       4800                     RCP_LO:
000800 4800 78               4      LD  A,B
000801 4801 3239F1          13      LD  (_BUF_LO),A
       4804                     RCP_ST:
000804 4804 2AC6F6          16      LD  HL,(STREND)
000807 4807 222FF1          16      LD  (_DTA),HL
00080A 480A EB               4      EX  DE,HL
00080B 480B 2100FE          10      LD  HL,-512
00080E 480E 39              11      ADD HL,SP
00080F 480F AF               4      XOR A
000810 4810 ED52            15      SBC HL,DE
000812 4812 3008            12      JR  NC,RCP0
000814 4814 215EF5          10      LD  HL,BUF
000817 4817 222FF1          16      LD  (_DTA),HL
00081A 481A 6F               4      LD  L,A ;0
00081B 481B 67               4      LD  H,A ;0
       481C                     RCP0:
00081C 481C 24               4      INC H
00081D 481D 223CF1          16      LD  (_BUF_EN),HL
       4820                     RCP1:
000820 4820 F3               4      DI
000821 4821 CDCB48          17      CALL    WAIT_VDP
                                
000824 4824 3A0700          13      LD  A,(WRVDP)
000827 4827 4F               4      LD  C,A
000828 4828 0C               4      INC C       ;C := PORT#1's address
000829 4829 3E24             7      LD  A,36
00082B 482B ED79            12      OUT (C),A
00082D 482D 3E91             7      LD  A,080H+17
00082F 482F ED79            12      OUT (C),A       ;R#17 := 36
                                
000831 4831 0C               4      INC C
000832 4832 0C               4      INC C       ;C := PORT#3's address
000833 4833 2A42F1          16      LD  HL,(_BUF_X)
000836 4836 ED69            12      OUT (C),L       ;R#36 DX
000838 4838 ED61            12      OUT (C),H       ;R#37
00083A 483A 2A44F1          16      LD  HL,(_BUF_Y)
00083D 483D ED69            12      OUT (C),L       ;R#38 DY
00083F 483F ED61            12      OUT (C),H       ;R#39
000841 4841 2A3EF1          16      LD  HL,(_BUF_W)
000844 4844 ED69            12      OUT (C),L       ;R#40 NX
000846 4846 ED61            12      OUT (C),H       ;R#41
000848 4848 2A40F1          16      LD  HL,(_BUF_H)
00084B 484B ED69            12      OUT (C),L       ;R#42 NY
00084D 484D ED61            12      OUT (C),H       ;R#43
                                
00084F 484F DD2AAFFC        20      LD  IX,(SCRMOD)
000853 4853 3A39F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000856 4856 B7               4      OR  A
000857 4857 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000859 4859 DD7D             9      LD  A,IXL
00085B 485B FE08             7      CP  8
00085D 485D 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
00085F 485F FE06             7      CP  6
000861 4861 2A42F1          16      LD  HL,(_BUF_X)
000864 4864 3A3EF1          13      LD  A,(_BUF_W)
000867 4867 2005            12      JR  NZ,SCR57
000869 4869 B5               4      OR  L       ;スクリーン6
00086A 486A E603             7      AND 3
00086C 486C 200D            12      JR  NZ,USE_LMMC
       486E                     SCR57:              ;スクリーン5,7
00086E 486E B5               4      OR  L
00086F 486F E601             7      AND 1
000871 4871 2008            12      JR  NZ,USE_LMMC
       4873                     USE_HMMC:
000873 4873 DD2E08          10      LD  IXL,8
       4876                     USE_HMMC8:
000876 4876 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
000878 4878 3239F1          13      LD  (_BUF_LO),A
       487B                     USE_LMMC:
00087B 487B 110000          10      LD  DE,0
00087E 487E 06FF             7      LD  B,-1
000880 4880 CDEB48          17      CALL    GET_PIXEL
000883 4883 ED79            12      OUT (C),A       ;R#44 first DATA
000885 4885 3A46F1          13      LD  A,(_BUF_O)
000888 4888 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
00088A 488A 3A39F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00088D 488D F6B0             7      OR  0B0H        ;R#46 LMMC command
00088F 488F ED79            12      OUT (C),A
                                
000891 4891 0D               4      DEC C
000892 4892 0D               4      DEC C       ;C := PORT#1's address
000893 4893 3EAC             7      LD  A,080H+44
000895 4895 ED79            12      OUT (C),A
000897 4897 3E91             7      LD  A,080H+17
000899 4899 ED79            12      OUT (C),A       ;R#17 := 44
00089B 489B 0C               4      INC C
00089C 489C 0C               4      INC C       ;C := PORT#3's address
       489D                     LOOP_COPY:
00089D 489D CDEB48          17      CALL    GET_PIXEL
0008A0 48A0 08               4      EX  AF,AF'
0008A1 48A1 3E02             7      LD  A,2
0008A3 48A3 CDBB48          17      CALL    GET_STATUS
0008A6 48A6 CB47             8      BIT 0,A     ;check CE bit
0008A8 48A8 2809            12      JR  Z,EXIT_COPY
0008AA 48AA CB7F             8      BIT 7,A     ;check TR bit
0008AC 48AC 28EF            12      JR  Z,LOOP_COPY
0008AE 48AE 08               4      EX  AF,AF'
0008AF 48AF ED79            12      OUT (C),A
0008B1 48B1 18EA            12      JR  LOOP_COPY
                                
       48B3                     EXIT_COPY:
0008B3 48B3 AF               4      XOR A
0008B4 48B4 CDBB48          17      CALL    GET_STATUS
                                
0008B7 48B7 FB               4      EI
0008B8 48B8 C38746          10      JP  ROM_NEXT
                                
       48BB                     GET_STATUS:
0008BB 48BB C5              11      PUSH    BC
0008BC 48BC ED4B0600        20      LD  BC,(RDVDP)
0008C0 48C0 0C               4      INC C
0008C1 48C1 ED79            12      OUT (C),A
0008C3 48C3 3E8F             7      LD  A,8FH
0008C5 48C5 ED79            12      OUT (C),A
0008C7 48C7 ED78            12      IN  A,(C)
0008C9 48C9 C1              10      POP BC
0008CA 48CA C9              10      RET
                                
       48CB                     WAIT_VDP:
0008CB 48CB 3E02             7      LD  A,2
0008CD 48CD CDBB48          17      CALL    GET_STATUS
0008D0 48D0 E601             7      AND 1
0008D2 48D2 20F7            12      JR  NZ,WAIT_VDP
0008D4 48D4 AF               4      XOR A
0008D5 48D5 CDBB48          17      CALL    GET_STATUS
0008D8 48D8 C9              10      RET
                                
       48D9                     GET_PIXEL256:
0008D9 48D9 7A               4      LD  A,D
0008DA 48DA B3               4      OR  E
0008DB 48DB 200A            12      JR  NZ,GET_PIXEL1
                                
0008DD 48DD 2A3CF1          16      LD  HL,(_BUF_EN)
0008E0 48E0 CD3249          17      CALL    ROM_READ
0008E3 48E3 EB               4      EX  DE,HL
0008E4 48E4 2A2FF1          16      LD  HL,(_DTA)
       48E7                     GET_PIXEL1:
0008E7 48E7 7E               7      LD  A,(HL)
0008E8 48E8 23               6      INC HL
0008E9 48E9 1B               6      DEC DE
0008EA 48EA C9              10      RET
                                
       48EB                     GET_PIXEL:
0008EB 48EB 04               4      INC B
0008EC 48EC DD7D             9      LD  A,IXL
0008EE 48EE FE08             7      CP  8
0008F0 48F0 28E7            12      JR  Z,GET_PIXEL256
0008F2 48F2 FE06             7      CP  6
0008F4 48F4 282E            12      JR  Z,GET_PIXEL4
                                
0008F6 48F6 CB40             8      BIT 0,B
0008F8 48F8 20ED            12      JR  NZ,GET_PIXEL1
                                
0008FA 48FA 7A               4      LD  A,D
0008FB 48FB B3               4      OR  E
0008FC 48FC 200A            12      JR  NZ,GET_PIXEL2
                                
0008FE 48FE 2A3CF1          16      LD  HL,(_BUF_EN)
000901 4901 CD3249          17      CALL    ROM_READ
000904 4904 EB               4      EX  DE,HL
000905 4905 2A2FF1          16      LD  HL,(_DTA)
                                
       4908                     GET_PIXEL2:
000908 4908 7E               7      LD  A,(HL)
000909 4909 0F               4      RRCA
00090A 490A 0F               4      RRCA
00090B 490B 0F               4      RRCA
00090C 490C 0F               4      RRCA
00090D 490D C9              10      RET
                                
       490E                     GET_PIXEL3:
00090E 490E 7A               4      LD  A,D
00090F 490F B3               4      OR  E
000910 4910 200A            12      JR  NZ,GET_PIXEL5
                                
000912 4912 2A3CF1          16      LD  HL,(_BUF_EN)
000915 4915 CD3249          17      CALL    ROM_READ
000918 4918 EB               4      EX  DE,HL
000919 4919 2A2FF1          16      LD  HL,(_DTA)
       491C                     GET_PIXEL5:
00091C 491C 7E               7      LD  A,(HL)
00091D 491D 0F               4      RRCA
00091E 491E 0F               4      RRCA
00091F 491F 0F               4      RRCA
000920 4920 0F               4      RRCA
000921 4921 0F               4      RRCA
000922 4922 0F               4      RRCA
000923 4923 C9              10      RET
                                
       4924                     GET_PIXEL4:
000924 4924 78               4      LD  A,B
000925 4925 E603             7      AND 3   ;+0
000927 4927 28E5            12      JR  Z,GET_PIXEL3
000929 4929 3D               4      DEC A   ;+1
00092A 492A 28DC            12      JR  Z,GET_PIXEL2
00092C 492C 3D               4      DEC A   ;+2
00092D 492D 7E               7      LD  A,(HL)
00092E 492E C0              11      RET NZ
00092F 492F 0F               4      RRCA        ;+3
000930 4930 0F               4      RRCA
000931 4931 C9              10      RET
                                
       4932                     ROM_READ:
000932 4932 E5              11      PUSH    HL
000933 4933 D5              11      PUSH    DE
000934 4934 C5              11      PUSH    BC
000935 4935 FDE5            15      PUSH    IY
000937 4937 224DF1          16      LD  (LEFTX),HL
00093A 493A 2A2FF1          16      LD  HL,(_DTA)
00093D 493D 2247F1          16      LD  (DTAX),HL
000940 4940 2A4DF1          16      LD  HL,(LEFTX)
                                
000943 4943 CD764B          17      CALL    RBX1
000946 4946 3870            12      JR  C,RBRERR1
000948 4948 79               4      LD  A,C
000949 4949 EB               4      EX  DE,HL
00094A 494A ED52            15      SBC HL,DE       ;CP 0HL,CDE
00094C 494C 19              11      ADD HL,DE
00094D 494D DE00             7      SBC A,000H
00094F 494F 3801            12      JR  C,RBR1
000951 4951 EB               4      EX  DE,HL
       4952                     RBR1:
000952 4952 9F               4      SBC A,A
000953 4953 E601             7      AND 1
000955 4955 321FF1          13      LD  (_RESULT),A
000958 4958 7C               4      LD  A,H
000959 4959 B5               4      OR  L
00095A 495A CAAE49          10      JP  Z,RBREND0
                                
00095D 495D 222BF1          16      LD  (_LEFT),HL  ;Read record byte
000960 4960 224DF1          16      LD  (LEFTX),HL
                                
000963 4963 CD9C4B          17      CALL    RBX2
000966 4966 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000968 4968 CDAF4B          17      CALL    RBXA
00096B 496B DAC449          10      JP  C,RBRERR
00096E 496E C5              11      PUSH    BC
00096F 496F CD2C44          17      CALL    ROM_LDIR
000972 4972 ED5347F1        20      LD  (DTAX),DE
000976 4976 2A4DF1          16      LD  HL,(LEFTX)
000979 4979 D1              10      POP DE
00097A 497A A7               4      AND A
00097B 497B ED52            15      SBC HL,DE
00097D 497D 224DF1          16      LD  (LEFTX),HL
000980 4980 2829            12      JR  Z,RBREND
                                
       4982                     RBRB:
000982 4982 CDEB4B          17      CALL    RBXB
000985 4985 2818            12      JR  Z,RBRC
       4987                     RBRB1:
000987 4987 C5              11      PUSH    BC
000988 4988 D5              11      PUSH    DE
000989 4989 CD934C          17      CALL    CLUST
00098C 498C EB               4      EX  DE,HL
00098D 498D ED4B21F1        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000991 4991 CD2C44          17      CALL    ROM_LDIR
000994 4994 EB               4      EX  DE,HL
000995 4995 D1              10      POP DE
000996 4996 C1              10      POP BC
000997 4997 CD704C          17      CALL    GNCL
00099A 499A DAC449          10      JP  C,RBRERR
00099D 499D 10E8            13      DJNZ    RBRB1
       499F                     RBRC:
00099F 499F CD034C          17      CALL    RBXC
0009A2 49A2 2807            12      JR  Z,RBREND
                                
0009A4 49A4 CD934C          17      CALL    CLUST
0009A7 49A7 EB               4      EX  DE,HL
0009A8 49A8 CD2C44          17      CALL    ROM_LDIR
       49AB                     RBREND:
0009AB 49AB CD0F4C          17      CALL    RBXEND
       49AE                     RBREND0:
0009AE 49AE FDE1            14      POP IY
0009B0 49B0 C1              10      POP BC
0009B1 49B1 D1              10      POP DE
0009B2 49B2 F1              10      POP AF  ;(HL)
0009B3 49B3 AF               4      XOR A
0009B4 49B4 3A1FF1          13      LD  A,(_RESULT)
0009B7 49B7 C9              10      RET
                                
       49B8                     RBRERR1:
0009B8 49B8 3E01             7      LD  A,001H
       49BA                     RBRERR2:
0009BA 49BA FDE1            14      POP IY
0009BC 49BC C1              10      POP BC
0009BD 49BD D1              10      POP DE
0009BE 49BE E1              10      POP HL
0009BF 49BF 37               4      SCF
0009C0 49C0 210000          10      LD  HL,0
0009C3 49C3 C9              10      RET
       49C4                     RBRERR:
0009C4 49C4 3EFF             7      LD  A,0FFH
0009C6 49C6 18F2            12      JR  RBRERR2
                                
       49C8                     FILE_DD:
0009C8 49C8 3E                      DB  03EH
0009C9 49C9 C9              10      RET
0009CA 49CA 320CF1          13      LD  (SWC_BLOAD_M),A
       49CD                     ROM_ORG:
0009CD 49CD 2A4FF1          16      LD  HL,(PARAM0)
0009D0 49D0 7E               7      LD  A,(HL)
0009D1 49D1 C9              10      RET
       49D2                     FILE_B:
0009D2 49D2 AF               4      XOR A
0009D3 49D3 3253F1          13      LD  (FDRV),A
0009D6 49D6 1E00             7      LD  E,0
0009D8 49D8 3A63F6          13      LD  A,(VALTYP)
0009DB 49DB FE03             7      CP  3       ;string
0009DD 49DD 2044            12      JR  NZ,FILED
                                
0009DF 49DF DD21D067        14      LD  IX,FRESTR
0009E3 49E3 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009E7 49E7 CD1C00          17      CALL    _CALSLT
0009EA 49EA E5              11      PUSH    HL
0009EB 49EB DDE1            14      POP IX
                                
0009ED 49ED DD5E00          19      LD  E,(IX+0)
0009F0 49F0 DD7E01          19      LD  A,(IX+1)
0009F3 49F3 DD5602          19      LD  D,(IX+2)
0009F6 49F6 DD62             9      LD  IXH,D
0009F8 49F8 DD6F             9      LD  IXL,A
0009FA 49FA 7B               4      LD  A,E
0009FB 49FB FE04             7      CP  4
0009FD 49FD 3808            12      JR  C,FILEB1
0009FF 49FF DD7E03          19      LD  A,(IX+3)
000A02 4A02 FE3A             7      CP  ':'
000A04 4A04 28C2            12      JR  Z,FILE_DD
000A06 4A06 7B               4      LD  A,E
       4A07                     FILEB1:
000A07 4A07 FE02             7      CP  2
000A09 4A09 3818            12      JR  C,FILED
000A0B 4A0B DD7E01          19      LD  A,(IX+1)
000A0E 4A0E FE3A             7      CP  ':'
000A10 4A10 2011            12      JR  NZ,DEVI1
000A12 4A12 DD7E00          19      LD  A,(IX+0)        ;DRIVE
000A15 4A15 CDFC4A          17      CALL    CAP
000A18 4A18 D640             7      SUB '@'
000A1A 4A1A DD23            10      INC IX
000A1C 4A1C DD23            10      INC IX
000A1E 4A1E 1D               4      DEC E
000A1F 4A1F 1D               4      DEC E
000A20 4A20 3253F1          13      LD  (FDRV),A
       4A23                     DEVI1:
                                
       4A23                     FILED:
000A23 4A23 CD6A4A          17      CALL    FILEI
000A26 4A26 2154F1          10      LD  HL,FNAME
                                
000A29 4A29 0608             7      LD  B,8
       4A2B                     FILE2:
000A2B 4A2B CD774A          17      CALL    CCHKF
000A2E 4A2E C8              11      RET Z
000A2F 4A2F FE2A             7      CP  '*'
000A31 4A31 282E            12      JR  Z,FILE9
000A33 4A33 FE2E             7      CP  '.'
000A35 4A35 280C            12      JR  Z,FILE4
000A37 4A37 77               7      LD  (HL),A
000A38 4A38 23               6      INC HL
000A39 4A39 10F0            13      DJNZ    FILE2
                                
       4A3B                     FILE3:
000A3B 4A3B CD774A          17      CALL    CCHKF
000A3E 4A3E C8              11      RET Z
000A3F 4A3F FE2E             7      CP  '.'
000A41 4A41 20F8            12      JR  NZ,FILE3
                                
       4A43                     FILE4:
000A43 4A43 215CF1          10      LD  HL,FNAME+8
000A46 4A46 0603             7      LD  B,3
                                
       4A48                     FILE4L:
000A48 4A48 CD774A          17      CALL    CCHKF
000A4B 4A4B C8              11      RET Z
000A4C 4A4C FE2E             7      CP  '.'
000A4E 4A4E 2008            12      JR  NZ,FILE12
000A50 4A50 3254F1          13      LD  (FNAME),A   ;Parent directory(..)
000A53 4A53 3255F1          13      LD  (FNAME+1),A
000A56 4A56 3E20             7      LD  A,020H
       4A58                     FILE12:
000A58 4A58 FE2A             7      CP  '*'
000A5A 4A5A 280A            12      JR  Z,FILE10
000A5C 4A5C 77               7      LD  (HL),A
000A5D 4A5D 23               6      INC HL
000A5E 4A5E 10E8            13      DJNZ    FILE4L
000A60 4A60 C9              10      RET
                                
       4A61                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000A61 4A61 CD664A          17      CALL    FILE10
000A64 4A64 18D5            12      JR  FILE3
                                
       4A66                     FILE10:
000A66 4A66 3E3F             7      LD  A,'?'
000A68 4A68 1808            12      JR  FILL_MEMORY
       4A6A                     FILEI:              ;名前＋拡張子をスペースで初期化
000A6A 4A6A 3E20             7      LD  A,020H
000A6C 4A6C 01000B          10      LD  BC,11*256   ;C=0にしておく
000A6F 4A6F 2154F1          10      LD  HL,FNAME
       4A72                     FILL_MEMORY:            ;HLからBバイトAで埋める
000A72 4A72 77               7      LD  (HL),A
000A73 4A73 23               6      INC HL
000A74 4A74 10FC            13      DJNZ    FILL_MEMORY
000A76 4A76 C9              10      RET
                                
       4A77                     CCHKF:
000A77 4A77 7B               4      LD  A,E
000A78 4A78 B7               4      OR  A
000A79 4A79 C8              11      RET Z
000A7A 4A7A DD7E00          19      LD  A,(IX+0)
000A7D 4A7D CD844A          17      CALL    CCHK2
000A80 4A80 C8              11      RET Z
000A81 4A81 C3E74A          10      JP  FKAN
                                
       4A84                     CCHK2:
000A84 4A84 0C               4      INC C
000A85 4A85 0D               4      DEC C
000A86 4A86 C0              11      RET NZ
       4A87                     CCHK3:              ;ZF=1 で使えない文字
000A87 4A87 FE2B             7      CP  '+'
000A89 4A89 C8              11      RET Z
000A8A 4A8A FE2C             7      CP  ','
000A8C 4A8C C8              11      RET Z
000A8D 4A8D FE2F             7      CP  '/'
000A8F 4A8F C8              11      RET Z
000A90 4A90 FE3A             7      CP  ':'
000A92 4A92 C8              11      RET Z
000A93 4A93 FE3B             7      CP  ';'
000A95 4A95 C8              11      RET Z
000A96 4A96 FE3D             7      CP  '='
000A98 4A98 C8              11      RET Z
000A99 4A99 FE5C             7      CP  05CH    ;\
000A9B 4A9B C8              11      RET Z
000A9C 4A9C FE1F             7      CP  01FH
000A9E 4A9E D0              11      RET NC
000A9F 4A9F BF               4      CP  A       ;Z=1
000AA0 4AA0 C9              10      RET
                                
       4AA1                     SS1:
000AA1 4AA1 13               6      INC DE
       4AA2                     SPCUT:              ;スペースをカット
000AA2 4AA2 1A               7      LD  A,(DE)
000AA3 4AA3 FE20             7      CP  020H
000AA5 4AA5 28FA            12      JR  Z,SS1
000AA7 4AA7 C9              10      RET
                                
       4AA8                     SCREOF1:
000AA8 4AA8 13               6      INC DE
       4AA9                     SPCUTEX:            ;スペース改行などをカット
000AA9 4AA9 1A               7      LD  A,(DE)
000AAA 4AAA FE20             7      CP  020H
000AAC 4AAC 28FA            12      JR  Z,SCREOF1
000AAE 4AAE FE0D             7      CP  00DH
000AB0 4AB0 28F6            12      JR  Z,SCREOF1
000AB2 4AB2 FE0A             7      CP  00AH
000AB4 4AB4 28F2            12      JR  Z,SCREOF1
000AB6 4AB6 FE1A             7      CP  01AH
000AB8 4AB8 28EE            12      JR  Z,SCREOF1
000ABA 4ABA C9              10      RET
                                
       4ABB                     GETNUM:
000ABB 4ABB 210000          10      LD  HL,0
       4ABE                     GETNUM1:
000ABE 4ABE 1A               7      LD  A,(DE)
000ABF 4ABF 13               6      INC DE
000AC0 4AC0 D630             7      SUB '0'
000AC2 4AC2 D8              11      RET C
000AC3 4AC3 FE0A             7      CP  10
000AC5 4AC5 D0              11      RET NC
000AC6 4AC6 4D               4      LD  C,L
000AC7 4AC7 44               4      LD  B,H
000AC8 4AC8 29              11      ADD HL,HL   ;*2
000AC9 4AC9 29              11      ADD HL,HL   ;*4
000ACA 4ACA 09              11      ADD HL,BC   ;*5
000ACB 4ACB 29              11      ADD HL,HL   ;*10
000ACC 4ACC 4F               4      LD  C,A
000ACD 4ACD 0600             7      LD  B,0
000ACF 4ACF 09              11      ADD HL,BC
000AD0 4AD0 18EC            12      JR  GETNUM1
                                
       4AD2                     SEARCH_END:
000AD2 4AD2 7E               7      LD  A,(HL)
       4AD3                     SEARCH_END1:
000AD3 4AD3 23               6      INC HL
000AD4 4AD4 B7               4      OR  A
000AD5 4AD5 C8              11      RET Z
000AD6 4AD6 FE3A             7      CP  ':'
000AD8 4AD8 20F8            12      JR  NZ,SEARCH_END
000ADA 4ADA 7E               7      LD  A,(HL)
000ADB 4ADB FE3A             7      CP  ':'
000ADD 4ADD 28F4            12      JR  Z,SEARCH_END1
000ADF 4ADF C9              10      RET
                                
       4AE0                     FKANC:
000AE0 4AE0 CB41             8      BIT 0,C
000AE2 4AE2 CC054B          17      CALL    Z,CAP2
000AE5 4AE5 1803            12      JR  FKANX
       4AE7                     FKAN:           ;漢字チェック
000AE7 4AE7 DD23            10      INC IX
000AE9 4AE9 1D               4      DEC E
       4AEA                     FKANX:
000AEA 4AEA CB41             8      BIT 0,C
000AEC 4AEC CB81             8      RES 0,C
000AEE 4AEE C0              11      RET NZ
000AEF 4AEF FE80             7      CP  080H
000AF1 4AF1 D8              11      RET C
000AF2 4AF2 FEA0             7      CP  0A0H
000AF4 4AF4 3803            12      JR  C,FKAN1
000AF6 4AF6 FEE0             7      CP  0E0H
000AF8 4AF8 D8              11      RET C
       4AF9                     FKAN1:
000AF9 4AF9 0C               4      INC C
000AFA 4AFA A7               4      AND A
000AFB 4AFB C9              10      RET
                                
       4AFC                     CAP:
000AFC 4AFC FE61             7      CP  'a'
000AFE 4AFE D8              11      RET C
000AFF 4AFF FE7B             7      CP  'z'+1
000B01 4B01 D0              11      RET NC
000B02 4B02 D620             7      SUB 020H
000B04 4B04 C9              10      RET
       4B05                     CAP2:
000B05 4B05 CDFC4A          17      CALL    CAP
       4B08                     CAP3:               ;
000B08 4B08 FE05             7      CP  5
000B0A 4B0A 2803            12      JR  Z,CAP4
000B0C 4B0C FE21             7      CP  021H
000B0E 4B0E C9              10      RET
       4B0F                     CAP4:
000B0F 4B0F 3EE5             7      LD  A,0E5H
000B11 4B11 C9              10      RET
                                
       4B12                     ROM_OPEN:
000B12 4B12 CD034F          17      CALL    GET_DISK_BANK_FDRV
                                
000B15 4B15 CD2F4D          17      CALL    GET_DIR_DAT
000B18 4B18 D5              11      PUSH    DE
000B19 4B19 CD2E4B          17      CALL    FILESE
000B1C 4B1C D1              10      POP DE
000B1D 4B1D 3F               4      CCF
000B1E 4B1E D8              11      RET C
000B1F 4B1F 224BF1          16      LD  (FCBX),HL
000B22 4B22 E5              11      PUSH    HL
000B23 4B23 210000          10      LD  HL,0
000B26 4B26 2225F1          16      LD  (RR_LOW),HL
000B29 4B29 2227F1          16      LD  (RR_HIGH),HL
000B2C 4B2C E1              10      POP HL
000B2D 4B2D C9              10      RET
                                
       4B2E                     FILESE:
000B2E 4B2E 7E               7      LD  A,(HL)
000B2F 4B2F B7               4      OR  A
000B30 4B30 C8              11      RET Z       ;END:ZF=1 CF=0
000B31 4B31 FEE5             7      CP  0E5H
000B33 4B33 280D            12      JR  Z,FILESE1
000B35 4B35 1154F1          10      LD  DE,FNAME
000B38 4B38 E5              11      PUSH    HL
000B39 4B39 CD504B          17      CALL    CPFILE
000B3C 4B3C CC714B          17      CALL    Z,CPFILE2
000B3F 4B3F E1              10      POP HL
000B40 4B40 37               4      SCF
000B41 4B41 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4B42                     FILESE1:
000B42 4B42 CD4A4B          17      CALL    FNEXT
000B45 4B45 20E7            12      JR  NZ,FILESE
       4B47                     ZF0_CF0_AFF_RET:
000B47 4B47 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000B49 4B49 C9              10      RET
                                
       4B4A                     FNEXT:
000B4A 4B4A 112000          10      LD  DE,020H
000B4D 4B4D 19              11      ADD HL,DE
000B4E 4B4E 0D               4      DEC C
                                #if exists USE_NORMAL_32K_ROM
                                #else
                                CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
                                    PUSH    AF
                                    BIT 7,H
                                    JR  Z,CHECK_DIR_PAGE1
                                    LD  A,H
                                    SUB 020H
                                    LD  H,A
                                    LD  A,(_BANK)
                                    INC A
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                CHECK_DIR_PAGE1:
                                    POP AF
                                #endif
000B4F 4B4F C9              10      RET
                                
       4B50                     CPFILE:
000B50 4B50 C5              11      PUSH    BC
000B51 4B51 01000B          10      LD  BC,00B00H
       4B54                     CPSTR1:
000B54 4B54 1A               7      LD  A,(DE)
000B55 4B55 FE3F             7      CP  '?'     ;Wild card
000B57 4B57 2812            12      JR  Z,CPSTR2
000B59 4B59 7E               7      LD  A,(HL)
000B5A 4B5A CDE04A          17      CALL    FKANC
000B5D 4B5D E5              11      PUSH    HL
000B5E 4B5E 67               4      LD  H,A
000B5F 4B5F 1A               7      LD  A,(DE)
000B60 4B60 CB01             4      RLC C
000B62 4B62 CDE04A          17      CALL    FKANC
000B65 4B65 CB09             4      RRC C
000B67 4B67 BC               4      CP  H       ;CP (HL),(DE)
000B68 4B68 E1              10      POP HL
000B69 4B69 2004            12      JR  NZ,CPSTR3
       4B6B                     CPSTR2:
000B6B 4B6B 13               6      INC DE
000B6C 4B6C 23               6      INC HL
000B6D 4B6D 10E5            13      DJNZ    CPSTR1
       4B6F                     CPSTR3:
000B6F 4B6F C1              10      POP BC
000B70 4B70 C9              10      RET
                                
       4B71                     CPFILE2:
                                ;   LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
                                ;   OR  0E1H
000B71 4B71 3EE1             7      LD  A,0E1H
000B73 4B73 2F               4      CPL
000B74 4B74 A6               7      AND (HL)
000B75 4B75 C9              10      RET
                                
       4B76                     RBX1:
000B76 4B76 E5              11      PUSH    HL      ;Record byte
                                
000B77 4B77 ED5B25F1        20      LD  DE,(RR_LOW) ;CDE=Random record
000B7B 4B7B 3A28F1          13      LD  A,(RR_HIGH+1)
000B7E 4B7E 4F               4      LD  C,A
                                
000B7F 4B7F CD034F          17      CALL    GET_DISK_BANK_FDRV
                                
000B82 4B82 FD2A4BF1        20      LD  IY,(FCBX)
000B86 4B86 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000B89 4B89 FD661D          19      LD  H,(IY+01DH)
000B8C 4B8C FD7E1E          19      LD  A,(IY+01EH)
                                
000B8F 4B8F A7               4      AND A
000B90 4B90 ED52            15      SBC HL,DE
000B92 4B92 99               4      SBC A,C
000B93 4B93 D1              10      POP DE
                                
000B94 4B94 D8              11      RET C
000B95 4B95 4F               4      LD  C,A
000B96 4B96 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000B97 4B97 B2               4      OR  D
000B98 4B98 B3               4      OR  E
000B99 4B99 C0              11      RET NZ
000B9A 4B9A 37               4      SCF
000B9B 4B9B C9              10      RET
                                
       4B9C                     RBX2:
000B9C 4B9C ED4B26F1        20      LD  BC,(RR_LOW+1)
000BA0 4BA0 CD244C          17      CALL    RWXR
000BA3 4BA3 3A22F1          13      LD  A,(CLSZ_H)
000BA6 4BA6 3D               4      DEC A
000BA7 4BA7 E5              11      PUSH    HL
000BA8 4BA8 2A25F1          16      LD  HL,(RR_LOW)
000BAB 4BAB A4               4      AND H
000BAC 4BAC B5               4      OR  L
000BAD 4BAD E1              10      POP HL
000BAE 4BAE C9              10      RET
                                
       4BAF                     RBXA:
000BAF 4BAF D5              11      PUSH    DE
000BB0 4BB0 CD934C          17      CALL    CLUST
000BB3 4BB3 ED532DF1        20      LD  (_DTPS),DE
000BB7 4BB7 D1              10      POP DE
000BB8 4BB8 CD704C          17      CALL    GNCL
000BBB 4BBB D8              11      RET C
000BBC 4BBC ED5329F1        20      LD  (_CLPS),DE
                                
000BC0 4BC0 ED4B25F1        20      LD  BC,(RR_LOW)
000BC4 4BC4 2A21F1          16      LD  HL,(CLSZ)
000BC7 4BC7 7C               4      LD  A,H
000BC8 4BC8 3D               4      DEC A
000BC9 4BC9 A0               4      AND B
000BCA 4BCA 47               4      LD  B,A
000BCB 4BCB ED42            15      SBC HL,BC       ;remaining cluster
                                
000BCD 4BCD ED5B4DF1        20      LD  DE,(LEFTX)
000BD1 4BD1 ED52            15      SBC HL,DE       ;CP HL,DE
000BD3 4BD3 19              11      ADD HL,DE
000BD4 4BD4 3801            12      JR  C,RBXA1
000BD6 4BD6 EB               4      EX  DE,HL
       4BD7                     RBXA1:
000BD7 4BD7 3A20F1          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
000BDA 4BDA 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000BDD 4BDD 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000BE0 4BE0 E5              11      PUSH    HL
000BE1 4BE1 2A2DF1          16      LD  HL,(_DTPS)
000BE4 4BE4 09              11      ADD HL,BC
000BE5 4BE5 ED5B47F1        20      LD  DE,(DTAX)
000BE9 4BE9 C1              10      POP BC
000BEA 4BEA C9              10      RET
                                
       4BEB                     RBXB:
000BEB 4BEB 2A47F1          16      LD  HL,(DTAX)
000BEE 4BEE ED5B29F1        20      LD  DE,(_CLPS)
000BF2 4BF2 3A4EF1          13      LD  A,(LEFTX+1)
000BF5 4BF5 47               4      LD  B,A
000BF6 4BF6 3A22F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4BF9                     RBXB1:
000BF9 4BF9 1F               4      RRA     ;->CF
000BFA 4BFA 3804            12      JR  C,RBXB2
000BFC 4BFC CB38             8      SRL B   ;B=B/2
000BFE 4BFE 18F9            12      JR  RBXB1
       4C00                     RBXB2:
000C00 4C00 78               4      LD  A,B
000C01 4C01 B7               4      OR  A
000C02 4C02 C9              10      RET
                                
       4C03                     RBXC:
000C03 4C03 ED4B4DF1        20      LD  BC,(LEFTX)
000C07 4C07 3A22F1          13      LD  A,(CLSZ_H)
000C0A 4C0A 3D               4      DEC A
000C0B 4C0B A0               4      AND B
000C0C 4C0C 47               4      LD  B,A
000C0D 4C0D B1               4      OR  C
000C0E 4C0E C9              10      RET
                                
       4C0F                     RBXEND:
000C0F 4C0F ED5B2BF1        20      LD  DE,(_LEFT)
000C13 4C13 2A25F1          16      LD  HL,(RR_LOW)
000C16 4C16 3A28F1          13      LD  A,(RR_HIGH+1)
000C19 4C19 19              11      ADD HL,DE
000C1A 4C1A CE00             7      ADC A,0
000C1C 4C1C 2225F1          16      LD  (RR_LOW),HL
000C1F 4C1F 3228F1          13      LD  (RR_HIGH+1),A
000C22 4C22 EB               4      EX  DE,HL       ;HL=Read byte
000C23 4C23 C9              10      RET 
                                
       4C24                     RWXR:
000C24 4C24 3A22F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4C27                     L_RWX:
000C27 4C27 1F               4      RRA     ;->CF
000C28 4C28 3806            12      JR  C,E_RWX
000C2A 4C2A CB38             8      SRL B   ;BC=BC/2
000C2C 4C2C CB19             8      RR  C   ;
000C2E 4C2E 18F7            12      JR  L_RWX
       4C30                     E_RWX:
000C30 4C30 CD034F          17      CALL    GET_DISK_BANK_FDRV
                                
000C33 4C33 FD2A4BF1        20      LD  IY,(FCBX)
000C37 4C37 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000C3A 4C3A FD561B          19      LD  D,(IY+01BH)
       4C3D                     RWX1:
000C3D 4C3D ED5329F1        20      LD  (_CLPS),DE
000C41 4C41 7A               4      LD  A,D
000C42 4C42 B3               4      OR  E
000C43 4C43 37               4      SCF
000C44 4C44 C8              11      RET Z
                                
000C45 4C45 78               4      LD  A,B
000C46 4C46 B1               4      OR  C
000C47 4C47 C8              11      RET Z
                                
000C48 4C48 CD704C          17      CALL    GNCL
000C4B 4C4B D8              11      RET C
000C4C 4C4C 0B               6      DEC BC
000C4D 4C4D CDC84C          17      CALL    ENDCL
000C50 4C50 38EB            12      JR  C,RWX1
000C52 4C52 37               4      SCF
000C53 4C53 C9              10      RET
                                
       4C54                     NCL3:
000C54 4C54 CD034F          17      CALL    GET_DISK_BANK_FDRV
000C57 4C57 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C5A 4C5A 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000C5D 4C5D 6B               4      LD  L,E
000C5E 4C5E 62               4      LD  H,D
000C5F 4C5F CB3C             8      SRL H
000C61 4C61 CB1D             8      RR  L
000C63 4C63 1F               4      RRA
000C64 4C64 19              11      ADD HL,DE
000C65 4C65 010060          10      LD  BC,BANK1_ADR
000C68 4C68 09              11      ADD HL,BC
000C69 4C69 ED4B23F1        20      LD  BC,(SECSZ)
000C6D 4C6D 09              11      ADD HL,BC
000C6E 4C6E 17               4      RLA
000C6F 4C6F C9              10      RET
                                
       4C70                     GNCL:
000C70 4C70 7A               4      LD  A,D
000C71 4C71 B3               4      OR  E
000C72 4C72 37               4      SCF
000C73 4C73 C8              11      RET Z
000C74 4C74 C5              11      PUSH    BC
000C75 4C75 E5              11      PUSH    HL
000C76 4C76 CD544C          17      CALL    NCL3
000C79 4C79 3809            12      JR  C,GNC1
000C7B 4C7B 5E               7      LD  E,(HL)
000C7C 4C7C 23               6      INC HL
000C7D 4C7D 7E               7      LD  A,(HL)
000C7E 4C7E E60F             7      AND 00FH
000C80 4C80 57               4      LD  D,A
000C81 4C81 E1              10      POP HL
000C82 4C82 C1              10      POP BC
000C83 4C83 C9              10      RET
       4C84                     GNC1:
000C84 4C84 7E               7      LD  A,(HL)
000C85 4C85 23               6      INC HL
000C86 4C86 56               7      LD  D,(HL)
000C87 4C87 0604             7      LD  B,4
       4C89                     GNC1L:
000C89 4C89 CB3A             8      SRL D
000C8B 4C8B 1F               4      RRA
000C8C 4C8C 10FB            13      DJNZ    GNC1L
                                
000C8E 4C8E 5F               4      LD  E,A
000C8F 4C8F E1              10      POP HL
000C90 4C90 C1              10      POP BC
000C91 4C91 A7               4      AND A
000C92 4C92 C9              10      RET
                                
       4C93                     CLUST:
000C93 4C93 EB               4      EX  DE,HL
000C94 4C94 C5              11      PUSH    BC
000C95 4C95 3A22F1          13      LD  A,(CLSZ_H)
000C98 4C98 CD2F4F          17      CALL    MUL_AHL
                                
000C9B 4C9B CD3C4D          17      CALL    GET_DIR_POS
000C9E 4C9E 4F               4      LD  C,A
000C9F 4C9F 0600             7      LD  B,0
000CA1 4CA1 09              11      ADD HL,BC
                                
000CA2 4CA2 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000CA5 4CA5 0F               4      RRCA
000CA6 4CA6 0F               4      RRCA
000CA7 4CA7 0F               4      RRCA
000CA8 4CA8 0F               4      RRCA
000CA9 4CA9 4F               4      LD  C,A
                                
000CAA 4CAA 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000CAD 4CAD FE02             7      CP  2
000CAF 4CAF 280C            12      JR  Z,CLUST1
000CB1 4CB1 CB01             4      RLC C
000CB3 4CB3 0D               4      DEC C
000CB4 4CB4 3A0C60          13      LD  A,(BANK1_ADR+11+1)  ;BPB_BytsPerSec High    
000CB7 4CB7 FE02             7      CP  2
000CB9 4CB9 2002            12      JR  NZ,CLUST1
000CBB 4CBB 0D               4      DEC C
000CBC 4CBC 0D               4      DEC C
       4CBD                     CLUST1:
000CBD 4CBD 0D               4      DEC C
000CBE 4CBE 09              11      ADD HL,BC
                                
                                #if exists USE_NORMAL_32K_ROM
000CBF 4CBF 7D               4      LD  A,L
                                #else
                                    PUSH    HL
                                    ADD HL,HL   ;*2
                                    ADD HL,HL   ;*4
                                    ADD HL,HL   ;*8
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    POP HL
                                    LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
                                    AND L
                                #endif
000CC0 4CC0 C660             7      ADD A,high BANK1_ADR
000CC2 4CC2 67               4      LD  H,A
000CC3 4CC3 2E00             7      LD  L,0
000CC5 4CC5 EB               4      EX  DE,HL
000CC6 4CC6 C1              10      POP BC
000CC7 4CC7 C9              10      RET
                                
       4CC8                     ENDCL:
000CC8 4CC8 7A               4      LD  A,D ;END CLUSTER
000CC9 4CC9 FE0F             7      CP  00FH    ;FAT12の最大値
000CCB 4CCB C0              11      RET NZ
000CCC 4CCC 7B               4      LD  A,E
000CCD 4CCD FEF7             7      CP  0F7H
000CCF 4CCF C9              10      RET
                                
       4CD0                     RB_READ:
000CD0 4CD0 AF               4      XOR A   ;HLA = HL*128
000CD1 4CD1 CB3C             8      SRL H
000CD3 4CD3 CB1D             8      RR  L
000CD5 4CD5 1F               4      RRA
000CD6 4CD6 3225F1          13      LD  (RR_LOW),A
000CD9 4CD9 2226F1          16      LD  (RR_MID),HL
000CDC 4CDC 218000          10      LD  HL,128
                                
000CDF 4CDF CD3249          17      CALL    ROM_READ
000CE2 4CE2 C9              10      RET
                                
       4CE3                     GETSEQ:
000CE3 4CE3 FD6E20          19      LD  L,(IY+32)
000CE6 4CE6 FD660C          19      LD  H,(IY+12)
                                
000CE9 4CE9 CB25             8      SLA L
                                
000CEB 4CEB CB3C             8      SRL H
000CED 4CED CB1D             8      RR  L
000CEF 4CEF C9              10      RET
                                
       4CF0                     SETSEQ:
000CF0 4CF0 F5              11      PUSH    AF
000CF1 4CF1 3A25F1          13      LD  A,(RR_LOW)
000CF4 4CF4 2A26F1          16      LD  HL,(RR_MID)
                                
000CF7 4CF7 CD0E4D          17      CALL    SSQ1
                                
000CFA 4CFA 29              11      ADD HL,HL
000CFB 4CFB CB3D             8      SRL L
000CFD 4CFD FD7520          19      LD  (IY+32),L
000D00 4D00 FD740C          19      LD  (IY+12),H
000D03 4D03 F1              10      POP AF
000D04 4D04 C9              10      RET
                                
       4D05                     GETSIZE:
000D05 4D05 FD7E10          19      LD  A,(IY+16)
000D08 4D08 FD6E11          19      LD  L,(IY+17)
000D0B 4D0B FD6612          19      LD  H,(IY+18)
       4D0E                     SSQ1:
000D0E 4D0E 87               4      ADD A,A
000D0F 4D0F ED6A            15      ADC HL,HL
000D11 4D11 B7               4      OR  A
000D12 4D12 C8              11      RET Z
000D13 4D13 23               6      INC HL
000D14 4D14 C9              10      RET
                                
       4D15                     SET_FCB:
000D15 4D15 D5              11      PUSH    DE
000D16 4D16 FDE1            14      POP IY
000D18 4D18 FD7E1C          19      LD  A,(IY+28)
000D1B 4D1B FEFF             7      CP  0FFH
000D1D 4D1D 200C            12      JR  NZ,POPAF_SCF_FF_RET
000D1F 4D1F E5              11      PUSH    HL
000D20 4D20 FD6E1A          19      LD  L,(IY+26)
000D23 4D23 FD661B          19      LD  H,(IY+27)
000D26 4D26 2229F1          16      LD  (_CLPS),HL
000D29 4D29 E1              10      POP HL
000D2A 4D2A C9              10      RET
                                
       4D2B                     POPAF_SCF_FF_RET:
000D2B 4D2B F1              10      POP AF
000D2C 4D2C 37               4      SCF
000D2D 4D2D 9F               4      SBC A,A
000D2E 4D2E C9              10      RET
                                
       4D2F                     GET_DIR_DAT:
000D2F 4D2F CD3C4D          17      CALL    GET_DIR_POS
000D32 4D32 C660             7      ADD A,high BANK1_ADR
000D34 4D34 2E00             7      LD  L,0
000D36 4D36 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_NORMAL_32K_ROM
                                #else
                                    CALL    CHECK_DIR_PAGE
                                #endif
000D37 4D37 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000D3A 4D3A 4F               4      LD  C,A
000D3B 4D3B C9              10      RET
                                
       4D3C                     GET_DIR_POS:
000D3C 4D3C CD034F          17      CALL    GET_DISK_BANK_FDRV
000D3F 4D3F 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D42 4D42 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D45 4D45 3220F1          13      LD  (_BANK),A
000D48 4D48 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000D4B 4D4B 47               4      LD  B,A
000D4C 4D4C 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000D4F 4D4F 4F               4      LD  C,A
000D50 4D50 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4D53                     GET_DIR_POS1:
000D53 4D53 81               4      ADD A,C
000D54 4D54 10FD            13      DJNZ    GET_DIR_POS1
                                
000D56 4D56 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec 
       4D5A                     L_MDP:
000D5A 4D5A CB18             8      RR  B   ;->CF
000D5C 4D5C D8              11      RET C
000D5D 4D5D 87               4      ADD A,A
000D5E 4D5E 18FA            12      JR  L_MDP
                                
       4D60                     WILDCARD:
000D60 4D60 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4D6B                     ERROR_WRITE_PROTECTED:
000D6B 4D6B 3E00             7      LD  A,0     ;Write protected
000D6D 4D6D C9              10      RET
       4D6E                     DISKIO:
000D6E 4D6E 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000D70 4D70 48               4      LD  C,B
000D71 4D71 CD0D4F          17      CALL    GET_DISK_BANK
       4D74                     SETMAP1:        
000D74 4D74 E5              11      PUSH    HL
       4D75                     DISKIO1:
000D75 4D75 C5              11      PUSH    BC      ;B=残りのセクタ数
000D76 4D76 D5              11      PUSH    DE      ;DE=セクタ番号
000D77 4D77 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
000D78 4D78 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
000D79 4D79 F5              11      PUSH    AF
000D7A 4D7A 3A24F1          13      LD  A,(SECSZ_H)
000D7D 4D7D CD2F4F          17      CALL    MUL_AHL
000D80 4D80 F1              10      POP AF
000D81 4D81 4D               4      LD  C,L     ;C=読み出し元
000D82 4D82 29              11      ADD HL,HL       ;64KB→32KB
000D83 4D83 29              11      ADD HL,HL       ;32KB→16KB
000D84 4D84 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
000D85 4D85 84               4      ADD A,H
000D86 4D86 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D89 4D89 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D8C 4D8C 3220F1          13      LD  (_BANK),A
000D8F 4D8F 79               4      LD  A,C     ;C=読み出し元
000D90 4D90 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
000D92 4D92 C660             7      ADD A,high BANK1_ADR
000D94 4D94 67               4      LD  H,A
000D95 4D95 ED4B23F1        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
000D99 4D99 69               4      LD  L,C     ;C=0
000D9A 4D9A EDB0                    LDIR
000D9C 4D9C EB               4      EX  DE,HL
000D9D 4D9D F1              10      POP AF
000D9E 4D9E D1              10      POP DE
000D9F 4D9F 13               6      INC DE
000DA0 4DA0 C1              10      POP BC
000DA1 4DA1 10D2            13      DJNZ    DISKIO1
000DA3 4DA3 41               4      LD  B,C
                                
000DA4 4DA4 E1              10      POP HL
000DA5 4DA5 AF               4      XOR A
000DA6 4DA6 FB               4      EI
000DA7 4DA7 C9              10      RET
                                
       4DA8                     DSKCHG:
000DA8 4DA8 CDE14D          17      CALL    IS_BPB
000DAB 4DAB 3824            12      JR  C,NOTREADY
000DAD 4DAD 3A23FB          13      LD  A,(DRVTBL+2)
000DB0 4DB0 B7               4      OR  A
000DB1 4DB1 201A            12      JR  NZ,DSKCHG1
000DB3 4DB3 3A21FB          13      LD  A,(DRVTBL)
000DB6 4DB6 FE02             7      CP  2
000DB8 4DB8 2013            12      JR  NZ,DSKCHG1
000DBA 4DBA CDE14D          17      CALL    IS_BPB
000DBD 4DBD 300E            12      JR  NC,DSKCHG1
000DBF 4DBF 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000DC1 4DC1 3221FB          13      LD  (DRVTBL),A
000DC4 4DC4 3223FB          13      LD  (DRVTBL+2),A
000DC7 4DC7 3A48F3          13      LD  A,(MASTERS)
000DCA 4DCA 3224FB          13      LD  (DRVTBL+3),A
       4DCD                     DSKCHG1:
000DCD 4DCD AF               4      XOR A
000DCE 4DCE 0601             7      LD  B,1
000DD0 4DD0 C9              10      RET
       4DD1                     NOTREADY:
000DD1 4DD1 3E02             7      LD  A,2
000DD3 4DD3 37               4      SCF
000DD4 4DD4 C9              10      RET
                                
       4DD5                     NO_BPB:
000DD5 4DD5 E1              10      POP HL
000DD6 4DD6 23               6      INC HL
000DD7 4DD7 11344F          10      LD  DE,DPB2DD
000DDA 4DDA 011200          10      LD  BC,DPB2DD_E-DPB2DD
000DDD 4DDD EDB0                    LDIR
000DDF 4DDF AF               4      XOR A
000DE0 4DE0 C9              10      RET
                                
       4DE1                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000DE1 4DE1 CD0D4F          17      CALL    GET_DISK_BANK
                                
000DE4 4DE4 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000DE7 4DE7 FE01             7      CP  1
000DE9 4DE9 D8              11      RET C
                                
000DEA 4DEA 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000DED 4DED C6FF             7      ADD A,0FFH
000DEF 4DEF D8              11      RET C
                                
000DF0 4DF0 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
000DF3 4DF3 FE01             7      CP  1
000DF5 4DF5 C8              11      RET Z
000DF6 4DF6 FE02             7      CP  2
000DF8 4DF8 C8              11      RET Z
000DF9 4DF9 FE04             7      CP  4
000DFB 4DFB C8              11      RET Z
000DFC 4DFC 37               4      SCF
000DFD 4DFD C9              10      RET
                                
       4DFE                     GETDPB:
000DFE 4DFE E5              11      PUSH    HL
000DFF 4DFF CD0D4F          17      CALL    GET_DISK_BANK
                                
000E02 4E02 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000E05 4E05 B7               4      OR  A
000E06 4E06 28CD            12      JR  Z,NO_BPB
000E08 4E08 DDE1            14      POP IX
000E0A 4E0A DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000E0D 4E0D 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000E10 4E10 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000E13 4E13 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000E16 4E16 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000E19 4E19 87               4      ADD A,A
000E1A 4E1A 87               4      ADD A,A
000E1B 4E1B 87               4      ADD A,A
000E1C 4E1C 3D               4      DEC A
000E1D 4E1D DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000E20 4E20 06FF             7      LD  B,-1
000E22 4E22 A7               4      AND A           ;無限ループ阻止
       4E23                     GETDPB1:
000E23 4E23 04               4      INC B
000E24 4E24 1F               4      RRA
000E25 4E25 38FC            12      JR  C,GETDPB1
000E27 4E27 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000E2A 4E2A 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000E2D 4E2D 3D               4      DEC A
000E2E 4E2E DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000E31 4E31 A7               4      AND A           ;無限ループ阻止
000E32 4E32 06FF             7      LD  B,-1
       4E34                     GETDPB2:
000E34 4E34 04               4      INC B
000E35 4E35 1F               4      RRA
000E36 4E36 38FC            12      JR  C,GETDPB2
000E38 4E38 04               4      INC B
000E39 4E39 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000E3C 4E3C 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
000E3F 4E3F DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
000E42 4E42 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
000E45 4E45 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
000E48 4E48 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000E4B 4E4B 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
000E4E 4E4E DD770B          19      LD  (IX+11),A       ;FATCNT
                                
000E51 4E51 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
000E55 4E55 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
000E58 4E58 DD460A          19      LD  B,(IX+10)       ;FATCNT
000E5B 4E5B 210000          10      LD  HL,0
       4E5E                     GETDPB3:
000E5E 4E5E 19              11      ADD HL,DE
000E5F 4E5F 10FD            13      DJNZ    GETDPB3
       4E61                     GETDPB4:
000E61 4E61 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
000E64 4E64 DD5609          19      LD  D,(IX+9)        ;FIRFAT
000E67 4E67 19              11      ADD HL,DE
000E68 4E68 DD7511          19      LD  (IX+17),L       ;FIRDIR
000E6B 4E6B DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000E6E 4E6E DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000E71 4E71 87               4      ADD A,A
000E72 4E72 87               4      ADD A,A
000E73 4E73 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4E76                     GETDPB5:
000E76 4E76 CB3B             8      SRL E
000E78 4E78 1F               4      RRA
000E79 4E79 30FB            12      JR  NC,GETDPB5
000E7B 4E7B 1600             7      LD  D,0
000E7D 4E7D 19              11      ADD HL,DE
000E7E 4E7E DD750C          19      LD  (IX+12),L       ;FIRREC
000E81 4E81 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000E84 4E84 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
000E87 4E87 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
000E8A 4E8A DD560D          19      LD  D,(IX+13)       ;FIRREC
000E8D 4E8D A7               4      AND A
000E8E 4E8E ED52            15      SBC HL,DE
                                
000E90 4E90 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
000E93 4E93 3C               4      INC A
000E94 4E94 37               4      SCF             ;無限ループ阻止
       4E95                     GETDPB6:
000E95 4E95 1F               4      RRA
000E96 4E96 3806            12      JR  C,GETDPB7
000E98 4E98 CB3C             8      SRL H
000E9A 4E9A CB1D             8      RR  L
000E9C 4E9C 18F7            12      JR  GETDPB6
       4E9E                     GETDPB7:
000E9E 4E9E 23               6      INC HL
000E9F 4E9F DD750E          19      LD  (IX+14),L       ;MAXCLUS
000EA2 4EA2 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       4EA5                     GETDPBD1:
000EA5 4EA5 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000EA8 4EA8 E6FC             7      AND 0FCH
000EAA 4EAA C8              11      RET Z
                                
000EAB 4EAB DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
000EAF 4EAF 37               4      SCF
000EB0 4EB0 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
000EB4 4EB4 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
000EB7 4EB7 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
000EBB 4EBB DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
000EBF 4EBF DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
000EC3 4EC3 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
000EC7 4EC7 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
000ECB 4ECB DDCB1126        23      SLA (IX+17)         ;FIRDIR
000ECF 4ECF DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
000ED3 4ED3 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
000ED6 4ED6 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
000ED9 4ED9 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000EDC 4EDC 87               4      ADD A,A
000EDD 4EDD 87               4      ADD A,A
000EDE 4EDE DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4EE1                     GETDPBD5:
000EE1 4EE1 CB3B             8      SRL E
000EE3 4EE3 1F               4      RRA
000EE4 4EE4 30FB            12      JR  NC,GETDPBD5
000EE6 4EE6 1600             7      LD  D,0
000EE8 4EE8 19              11      ADD HL,DE
000EE9 4EE9 DD750C          19      LD  (IX+12),L       ;FIRREC
000EEC 4EEC DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000EEF 4EEF 18B4            12      JR  GETDPBD1
                                
       4EF1                     CHOICE:
000EF1 4EF1 210000          10      LD  HL,0
000EF4 4EF4 C9              10      RET
                                
       4EF5                     DSKFMT:
000EF5 4EF5 AF               4      XOR A
000EF6 4EF6 37               4      SCF
       4EF7                     DSKSTP:
000EF7 4EF7 C9              10      RET
                                
       4EF8                     BASENT:
000EF8 4EF8 ED7B5FF1        20      LD  SP,(BASSTK)
000EFC 4EFC C3C043          10      JP  BASAUTO
                                
       4EFF                     GETSLT:
000EFF 4EFF 3A22FB          13      LD  A,(DRVTBL+1)
000F02 4F02 C9              10      RET
                                
       4F03                     GET_DISK_BANK_FDRV:
000F03 4F03 3A53F1          13      LD  A,(FDRV)
000F06 4F06 D601             7      SUB 1
000F08 4F08 3003            12      JR  NC,GET_DISK_BANK
000F0A 4F0A 3A4AF1          13      LD  A,(_DVSW)
       4F0D                     GET_DISK_BANK:
000F0D 4F0D B7               4      OR  A       ;A=DRIVE
000F0E 4F0E 3E01             7      LD  A,DISK_BANK
000F10 4F10 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
000F12 4F12 3A49F1          13      LD  A,(B_DRIVE)
                                #endif
       4F15                     SET_DISK_BANK:
000F15 4F15 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000F18 4F18 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000F1B 4F1B F5              11      PUSH    AF
000F1C 4F1C E5              11      PUSH    HL
000F1D 4F1D 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
000F20 4F20 2223F1          16      LD  (SECSZ),HL
000F23 4F23 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000F26 4F26 CD2F4F          17      CALL    MUL_AHL
000F29 4F29 2221F1          16      LD  (CLSZ),HL
000F2C 4F2C E1              10      POP HL
000F2D 4F2D F1              10      POP AF
000F2E 4F2E C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)
       4F2F                     MUL_AHL:
000F2F 4F2F 1F               4      RRA     ;->CF
000F30 4F30 D8              11      RET C
000F31 4F31 29              11      ADD HL,HL
000F32 4F32 18FB            12      JR  MUL_AHL
                                
       4F34                     DPB2DD:
000F34 4F34 F9                      DB  0F9H    ;MEDIA
000F35 4F35 0002                    DW  00200H  ;SECSIZ
000F37 4F37 0F                      DB  00FH    ;DIRMSK
000F38 4F38 04                      DB  004H    ;DIRSHFT
000F39 4F39 01                      DB  001H    ;CLUSMSK
000F3A 4F3A 02                      DB  002H    ;CLUSSHFT
000F3B 4F3B 0100                    DW  00001H  ;FIRFAT
000F3D 4F3D 02                      DB  002H    ;FATCNT
000F3E 4F3E 70                      DB  070H    ;MAXENT
000F3F 4F3F 0E00                    DW  0000EH  ;FIRREC
000F41 4F41 CA02                    DW  002CAH  ;MAXCLUS
000F43 4F43 03                      DB  003H    ;FATSIZ
000F44 4F44 0700                    DW  0007H   ;FIRDIR
       4F46                     DPB2DD_E:
                                
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       4F46                     POP_HL_ERROR:
000F46 4F46 E1              10      POP     HL
       4F47                     _ERROR:
000F47 4F47 0600             7      LD  B,0
000F49 4F49 A7               4      AND A
000F4A 4F4A C9              10      RET
                                
       4F4B                     ROM_BDOS:
000F4B 4F4B E5              11      PUSH    HL
000F4C 4F4C 79               4      LD  A,C
000F4D 4F4D 87               4      ADD A,A
000F4E 4F4E 38F7            12      JR  C,_ERROR
000F50 4F50 6F               4      LD  L,A
000F51 4F51 265F             7      LD  H,high STABLE
000F53 4F53 7E               7      LD  A,(HL)
000F54 4F54 2C               4      INC L
000F55 4F55 66               7      LD  H,(HL)
000F56 4F56 6F               4      LD  L,A
000F57 4F57 E3              19      EX  (SP),HL
000F58 4F58 79               4      LD  A,C
000F59 4F59 C9              10      RET
                                
       4F5A                     _PRINT:
       4F5A                     PRINT:
000F5A 4F5A 7B               4      LD  A,E
000F5B 4F5B 1803            12      JR  MSG_A
                                
       4F5D                     _SYS01:     ;(BDOS)コンソール入力
000F5D 4F5D CDD44F          17      CALL    _SYS07
       4F60                     MSG_A:
000F60 4F60 FE03             7      CP  3
000F62 4F62 2814            12      JR  Z,MSG_BR
       4F64                     MSGA1:
000F64 4F64 F5              11      PUSH    AF
000F65 4F65 C5              11      PUSH    BC
000F66 4F66 D5              11      PUSH    DE
000F67 4F67 E5              11      PUSH    HL
000F68 4F68 DDE5            15      PUSH    IX
000F6A 4F6A DD21A200        14      LD  IX,CHPUT
000F6E 4F6E CDE742          17      CALL    CALSLT_R
000F71 4F71 DDE1            14      POP IX
000F73 4F73 E1              10      POP HL
000F74 4F74 D1              10      POP DE
000F75 4F75 C1              10      POP BC
       4F76                     MSGA2:
000F76 4F76 F1              10      POP AF
000F77 4F77 C9              10      RET
       4F78                     MSG_BR:
000F78 4F78 F5              11      PUSH    AF
000F79 4F79 3ADDF3          13      LD  A,(CSRX)
000F7C 4F7C FE02             7      CP  2
000F7E 4F7E 38F6            12      JR  C,MSGA2
000F80 4F80 F1              10      POP AF
       4F81                     MSG_CR:
000F81 4F81 F5              11      PUSH    AF
000F82 4F82 3E0D             7      LD  A,00DH
000F84 4F84 CD644F          17      CALL    MSGA1
000F87 4F87 3E0A             7      LD  A,00AH
000F89 4F89 CD644F          17      CALL    MSGA1
000F8C 4F8C F1              10      POP AF
000F8D 4F8D C9              10      RET
                                
       4F8E                     _SYS02:     ;(BDOS)コンソール出力
000F8E 4F8E CDA94F          17      CALL    BREAK
000F91 4F91 1805            12      JR  PRINTX
                                
       4F93                     _SYS06:     ;(BDOS)コンソール直接入出力
000F93 4F93 7B               4      LD  A,E
000F94 4F94 3C               4      INC A
000F95 4F95 CAE84F          10      JP  Z,_INKEY
       4F98                     PRINTX:
000F98 4F98 C35A4F          10      JP  _PRINT
                                
       4F9B                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000F9B 4F9B CDD44F          17      CALL    _SYS07
000F9E 4F9E FE03             7      CP  3
000FA0 4FA0 CCA94F          17      CALL    Z,_BREAK
000FA3 4FA3 FE13             7      CP  013H        ;CTRL+S
000FA5 4FA5 C0              11      RET NZ
       4FA6                     PAUSE:
000FA6 4FA6 CDC04F          17      CALL    KEYBC
                                
       4FA9                     _BREAK:
       4FA9                     BREAK:
000FA9 4FA9 F5              11      PUSH    AF
000FAA 4FAA C5              11      PUSH    BC
000FAB 4FAB D5              11      PUSH    DE
000FAC 4FAC E5              11      PUSH    HL
000FAD 4FAD DDE5            15      PUSH    IX
000FAF 4FAF DD21B700        14      LD  IX,BREAKX
000FB3 4FB3 CDE742          17      CALL    CALSLT_R
000FB6 4FB6 DDE1            14      POP IX
000FB8 4FB8 E1              10      POP HL
000FB9 4FB9 D1              10      POP DE
000FBA 4FBA C1              10      POP BC
000FBB 4FBB DCA94F          17      CALL    C,_BREAK
000FBE 4FBE F1              10      POP AF
000FBF 4FBF C9              10      RET
       4FC0                     KEYBC:
000FC0 4FC0 F5              11      PUSH    AF
000FC1 4FC1 C5              11      PUSH    BC
000FC2 4FC2 D5              11      PUSH    DE
000FC3 4FC3 E5              11      PUSH    HL
000FC4 4FC4 DDE5            15      PUSH    IX
000FC6 4FC6 DD215601        14      LD  IX,KILBUF
000FCA 4FCA CDE742          17      CALL    CALSLT_R
000FCD 4FCD DDE1            14      POP IX
000FCF 4FCF E1              10      POP HL
000FD0 4FD0 D1              10      POP DE
000FD1 4FD1 C1              10      POP BC
000FD2 4FD2 F1              10      POP AF
000FD3 4FD3 C9              10      RET
                                
       4FD4                     _SYS07:
       4FD4                     FLGET:
000FD4 4FD4 C5              11      PUSH    BC
000FD5 4FD5 D5              11      PUSH    DE
000FD6 4FD6 E5              11      PUSH    HL
000FD7 4FD7 DDE5            15      PUSH    IX
000FD9 4FD9 DD219F00        14      LD  IX,CHGET
000FDD 4FDD CDE742          17      CALL    CALSLT_R
000FE0 4FE0 DDE1            14      POP IX
000FE2 4FE2 E1              10      POP HL
000FE3 4FE3 D1              10      POP DE
000FE4 4FE4 C1              10      POP BC
000FE5 4FE5 FE03             7      CP  3
000FE7 4FE7 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       4FE8                     _INKEY:
       4FE8                     INKEY:
000FE8 4FE8 CD8250          17      CALL    CPM_CONST
000FEB 4FEB C8              11      RET Z
000FEC 4FEC 18E6            12      JR  FLGET
                                
       4FEE                     _SYS0A:     ;(BDOS)文字列入力
000FEE 4FEE C5              11      PUSH    BC
000FEF 4FEF E5              11      PUSH    HL
000FF0 4FF0 D5              11      PUSH    DE
000FF1 4FF1 CD1A50          17      CALL    GETL
000FF4 4FF4 111FF4          10      LD  DE,KBUF
000FF7 4FF7 E1              10      POP HL
000FF8 4FF8 E5              11      PUSH    HL
000FF9 4FF9 0E00             7      LD  C,0
000FFB 4FFB 3004            12      JR  NC,SAX0
000FFD 4FFD 23               6      INC HL
000FFE 4FFE 23               6      INC HL
000FFF 4FFF 1808            12      JR  SAX4
       5001                     SAX0:
001001 5001 46               7      LD  B,(HL)
001002 5002 23               6      INC HL
       5003                     SAX1:
001003 5003 23               6      INC HL
001004 5004 1A               7      LD  A,(DE)
001005 5005 13               6      INC DE
001006 5006 B7               4      OR  A
001007 5007 2004            12      JR  NZ,SAX2
       5009                     SAX4:
001009 5009 360D            10      LD  (HL),00DH
00100B 500B 1804            12      JR  SAX3
       500D                     SAX2:
00100D 500D 77               7      LD  (HL),A
00100E 500E 0C               4      INC C
00100F 500F 10F2            13      DJNZ    SAX1
       5011                     SAX3:
001011 5011 D1              10      POP DE
001012 5012 79               4      LD  A,C
001013 5013 13               6      INC DE
001014 5014 12               7      LD  (DE),A
001015 5015 1B               6      DEC DE
001016 5016 E1              10      POP HL
001017 5017 C1              10      POP BC
001018 5018 A7               4      AND A
001019 5019 C9              10      RET
       501A                     GETL:
00101A 501A DDE5            15      PUSH    IX
00101C 501C FDE5            15      PUSH    IY
                                
00101E 501E 2ADCF3          16      LD  HL,(CSRY)
001021 5021 22CAFB          16      LD  (FSTPOS),HL
       5024                     GETL1:
001024 5024 CD9B4F          17      CALL    _SYS08
001027 5027 FE09             7      CP  9
001029 5029 2008            12      JR  NZ,GETL1V
00102B 502B 211FF4          10      LD  HL,KBUF
00102E 502E CD7243          17      CALL    MSX
001031 5031 18F1            12      JR  GETL1
       5033                     GETL1V:
001033 5033 5F               4      LD  E,A
001034 5034 FE08             7      CP  8
001036 5036 CCD050          17      CALL    Z,CTRL02
001039 5039 FE20             7      CP  020H
00103B 503B D4FC50          17      CALL    NC,INSERT
00103E 503E CD644F          17      CALL    MSGA1
                                
001041 5041 7B               4      LD  A,E
001042 5042 FE0D             7      CP  00DH
001044 5044 20DE            12      JR  NZ,GETL1
                                
001046 5046 111FF4          10      LD  DE,KBUF
001049 5049 3AB0F3          13      LD  A,(LINLEN)
00104C 504C 47               4      LD  B,A
00104D 504D CDAF52          17      CALL    ZERO_MEMORY_DE
                                
001050 5050 2ACAFB          16      LD  HL,(FSTPOS)
001053 5053 3ADCF3          13      LD  A,(CSRY)
001056 5056 6F               4      LD  L,A
001057 5057 E5              11      PUSH    HL
001058 5058 CD2D51          17      CALL    LOC0
00105B 505B 4D               4      LD  C,L
00105C 505C 44               4      LD  B,H
00105D 505D E1              10      POP HL
00105E 505E 3AB0F3          13      LD  A,(LINLEN)
001061 5061 94               4      SUB H
001062 5062 3D               4      DEC A
001063 5063 5F               4      LD  E,A
001064 5064 211FF4          10      LD  HL,KBUF
       5067                     GETL2:
001067 5067 CDC050          17      CALL    _SCRN
00106A 506A 03               6      INC BC
00106B 506B 77               7      LD  (HL),A
00106C 506C 23               6      INC HL
00106D 506D 1D               4      DEC E
00106E 506E 20F7            12      JR  NZ,GETL2
001070 5070 CD814F          17      CALL    MSG_CR
                                
001073 5073 FDE1            14      POP IY
001075 5075 DDE1            14      POP IX
       5077                     GETL3:
001077 5077 2B               6      DEC HL
001078 5078 7E               7      LD  A,(HL)
001079 5079 FE21             7      CP  021H
00107B 507B D0              11      RET NC
00107C 507C 3600            10      LD  (HL),0
00107E 507E 15               4      DEC D
00107F 507F 20F6            12      JR  NZ,GETL3
001081 5081 C9              10      RET
                                
       5082                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       5082                     CONSTX:
       5082                     CPM_CONST:
001082 5082 C5              11      PUSH    BC
001083 5083 D5              11      PUSH    DE
001084 5084 E5              11      PUSH    HL
001085 5085 DDE5            15      PUSH    IX
001087 5087 DD219C00        14      LD  IX,CHSNS
00108B 508B CDE742          17      CALL    CALSLT_R
00108E 508E DDE1            14      POP IX
001090 5090 E1              10      POP HL
001091 5091 D1              10      POP DE
001092 5092 C1              10      POP BC
001093 5093 C9              10      RET
                                
       5094                     _SYS2A:     ;(BDOS)日付の獲得
001094 5094 AF               4      XOR A
001095 5095 57               4      LD  D,A
001096 5096 5F               4      LD  E,A
001097 5097 67               4      LD  H,A
001098 5098 6F               4      LD  L,A
001099 5099 C9              10      RET
                                
       509A                     _SYS2C:     ;(BDOS)時刻の獲得
00109A 509A AF               4      XOR A
00109B 509B 57               4      LD  D,A
00109C 509C 5F               4      LD  E,A
00109D 509D 67               4      LD  H,A
00109E 509E 6F               4      LD  L,A
00109F 509F C9              10      RET
                                
       50A0                     POS:
0010A0 50A0 F5              11      PUSH    AF
0010A1 50A1 2ADCF3          16      LD  HL,(CSRY)
0010A4 50A4 7D               4      LD  A,L
0010A5 50A5 6C               4      LD  L,H
0010A6 50A6 67               4      LD  H,A
0010A7 50A7 2C               4      INC L
0010A8 50A8 24               4      INC H
0010A9 50A9 F1              10      POP AF
0010AA 50AA C9              10      RET
                                
       50AB                     LOC:
0010AB 50AB F5              11      PUSH    AF
0010AC 50AC E5              11      PUSH    HL
0010AD 50AD 7D               4      LD  A,L
0010AE 50AE 6C               4      LD  L,H
0010AF 50AF 67               4      LD  H,A
0010B0 50B0 2D               4      DEC L
0010B1 50B1 25               4      DEC H
0010B2 50B2 DDE5            15      PUSH    IX
0010B4 50B4 DD21C600        14      LD  IX,POSIT
0010B8 50B8 CDE742          17      CALL    CALSLT_R
0010BB 50BB DDE1            14      POP IX
0010BD 50BD E1              10      POP HL
0010BE 50BE F1              10      POP AF
0010BF 50BF C9              10      RET
                                
       50C0                     _SCRN:
       50C0                     SCRN:
0010C0 50C0 E5              11      PUSH    HL
0010C1 50C1 DDE5            15      PUSH    IX
                                
0010C3 50C3 69               4      LD  L,C
0010C4 50C4 60               4      LD  H,B
0010C5 50C5 DD214A00        14      LD  IX,RDVRM
0010C9 50C9 CDE742          17      CALL    CALSLT_R
                                
0010CC 50CC DDE1            14      POP IX
0010CE 50CE E1              10      POP HL
0010CF 50CF C9              10      RET
                                
       50D0                     CTRL02:
0010D0 50D0 F5              11      PUSH    AF
0010D1 50D1 D5              11      PUSH    DE
0010D2 50D2 2ADCF3          16      LD  HL,(CSRY)
0010D5 50D5 3AB0F3          13      LD  A,(LINLEN)
0010D8 50D8 4F               4      LD  C,A
0010D9 50D9 94               4      SUB H   ;CSRX
0010DA 50DA C602             7      ADD A,2
0010DC 50DC 47               4      LD  B,A ;カーソルより右の文字数
0010DD 50DD 61               4      LD  H,C ;LINLEN
0010DE 50DE C5              11      PUSH    BC
0010DF 50DF CD2D51          17      CALL    LOC0
0010E2 50E2 C1              10      POP BC
                                
0010E3 50E3 1620             7      LD  D,020H
       50E5                     C8X1:
0010E5 50E5 DD214A00        14      LD  IX,RDVRM
0010E9 50E9 CDE742          17      CALL    CALSLT_R
0010EC 50EC 4F               4      LD  C,A
0010ED 50ED 7A               4      LD  A,D
0010EE 50EE DD214D00        14      LD  IX,WRTVRM
0010F2 50F2 CDE742          17      CALL    CALSLT_R
0010F5 50F5 2B               6      DEC HL
0010F6 50F6 51               4      LD  D,C
0010F7 50F7 10EC            13      DJNZ    C8X1
0010F9 50F9 D1              10      POP DE
0010FA 50FA F1              10      POP AF
0010FB 50FB C9              10      RET
                                
       50FC                     INSERT:
0010FC 50FC F5              11      PUSH    AF
0010FD 50FD D5              11      PUSH    DE
0010FE 50FE 2ADCF3          16      LD  HL,(CSRY)
001101 5101 3AB0F3          13      LD  A,(LINLEN)
001104 5104 4F               4      LD  C,A
001105 5105 94               4      SUB H   ;CSRX
001106 5106 3C               4      INC A
001107 5107 47               4      LD  B,A ;カーソルより右の文字数
001108 5108 C5              11      PUSH    BC
001109 5109 CD2D51          17      CALL    LOC0
00110C 510C C1              10      POP BC
                                
00110D 510D 1620             7      LD  D,020H
       510F                     INS1:
00110F 510F DD214A00        14      LD  IX,RDVRM
001113 5113 CDE742          17      CALL    CALSLT_R
001116 5116 4F               4      LD  C,A
001117 5117 7A               4      LD  A,D
001118 5118 DD214D00        14      LD  IX,WRTVRM
00111C 511C CDE742          17      CALL    CALSLT_R
00111F 511F 23               6      INC HL
001120 5120 51               4      LD  D,C
001121 5121 10EC            13      DJNZ    INS1
001123 5123 D1              10      POP DE
001124 5124 F1              10      POP AF
001125 5125 C9              10      RET
                                
       5126                     CONOUT1:
001126 5126 59               4      LD  E,C
001127 5127 C35A4F          10      JP  _PRINT
                                
       512A                     GETVRAM:
00112A 512A 2ADCF3          16      LD  HL,(CSRY)
       512D                     LOC0:
00112D 512D 2D               4      DEC L
00112E 512E 25               4      DEC H
00112F 512F 4C               4      LD  C,H ;CSRX-1
001130 5130 5D               4      LD  E,L ;CSRY-1
       5131                     LOC1:
001131 5131 3AB0F3          13      LD  A,(LINLEN)
001134 5134 67               4      LD  H,A
001135 5135 1600             7      LD  D,0
001137 5137 6A               4      LD  L,D ;0
001138 5138 0608             7      LD  B,8
       513A                     LOC2:
00113A 513A 29              11      ADD HL,HL
00113B 513B 3001            12      JR  NC,LOC3
00113D 513D 19              11      ADD HL,DE
       513E                     LOC3:
00113E 513E 10FA            13      DJNZ    LOC2
001140 5140 09              11      ADD HL,BC
001141 5141 C9              10      RET
                                
       5142                     _SYS0C:     ;(BDOS)バージョン番号の獲得
001142 5142 212200          10      LD  HL,00022H
001145 5145 AF               4      XOR A
001146 5146 7D               4      LD  A,L
001147 5147 C9              10      RET
                                
       5148                     _SYS0D:     ;(BDOS)ディスク・リセット
001148 5148 218000          10      LD  HL,00080H
00114B 514B 222FF1          16      LD  (_DTA),HL
00114E 514E C9              10      RET
                                
       514F                     _SYS0E:     ;(BDOS)カレントドライブの設定
00114F 514F 324AF1          13      LD  (_DVSW),A
001152 5152 C9              10      RET
                                
       5153                     _SYS0F:     ;(BDOS)ファイルのオープン
001153 5153 D5              11      PUSH    DE
001154 5154 FDE1            14      POP IY
001156 5156 CD9C52          17      CALL    INIT_FILE
001159 5159 CD124B          17      CALL    ROM_OPEN
00115C 515C 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
00115E 515E FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
001162 5162 FDE5            15      PUSH    IY
001164 5164 D1              10      POP DE
001165 5165 13               6      INC DE
001166 5166 010B00          10      LD  BC,11
001169 5169 EDB0                    LDIR
                                ;               Attribute
00116B 516B 7E               7      LD  A,(HL)
00116C 516C FD770D          19      LD  (IY+13),A
                                ;               TIME
00116F 516F 110B00          10      LD  DE,11
001172 5172 19              11      ADD HL,DE
001173 5173 7E               7      LD  A,(HL)
001174 5174 23               6      INC HL
001175 5175 FD7716          19      LD  (IY+22),A
001178 5178 7E               7      LD  A,(HL)
001179 5179 23               6      INC HL
00117A 517A FD7717          19      LD  (IY+23),A
                                ;               DATE
00117D 517D 7E               7      LD  A,(HL)
00117E 517E 23               6      INC HL
00117F 517F FD7714          19      LD  (IY+20),A
001182 5182 7E               7      LD  A,(HL)
001183 5183 23               6      INC HL
001184 5184 FD7715          19      LD  (IY+21),A
                                ;               First cluster
001187 5187 7E               7      LD  A,(HL)
001188 5188 23               6      INC HL
001189 5189 FD771A          19      LD  (IY+26),A
00118C 518C 7E               7      LD  A,(HL)
00118D 518D 23               6      INC HL
00118E 518E FD771B          19      LD  (IY+27),A
                                ;               SIZE
001191 5191 7E               7      LD  A,(HL)
001192 5192 23               6      INC HL
001193 5193 FD7710          19      LD  (IY+16),A
001196 5196 7E               7      LD  A,(HL)
001197 5197 23               6      INC HL
001198 5198 FD7711          19      LD  (IY+17),A
00119B 519B 7E               7      LD  A,(HL)
00119C 519C 23               6      INC HL
00119D 519D FD7712          19      LD  (IY+18),A
0011A0 51A0 7E               7      LD  A,(HL)
0011A1 51A1 FD7713          19      LD  (IY+19),A
0011A4 51A4 AF               4      XOR A
0011A5 51A5 FD770C          19      LD  (IY+12),A
0011A8 51A8 C9              10      RET
                                
       51A9                     _SYS10:     ;(BDOS)ファイルのクローズ
0011A9 51A9 AF               4      XOR A
0011AA 51AA C9              10      RET
                                
       51AB                     S11X1:
0011AB 51AB FD7119          19      LD  (IY+25),C       ;RootEntCnt
0011AE 51AE FD750E          19      LD  (IY+14),L
0011B1 51B1 FD740F          19      LD  (IY+15),H
       51B4                     SCF_FF_RET:
0011B4 51B4 37               4      SCF
0011B5 51B5 9F               4      SBC A,A
0011B6 51B6 C9              10      RET
                                
       51B7                     _SYS11:     ;(BDOS)最初のファイルの検索
0011B7 51B7 ED5337F1        20      LD  (_FCB),DE
0011BB 51BB D5              11      PUSH    DE
0011BC 51BC FDE1            14      POP IY
0011BE 51BE CD9C52          17      CALL    INIT_FILE
0011C1 51C1 CD2F4D          17      CALL    GET_DIR_DAT
       51C4                     S12X1:
0011C4 51C4 CD2E4B          17      CALL    FILESE
0011C7 51C7 30E2            12      JR  NC,S11X1
0011C9 51C9 0D               4      DEC C
0011CA 51CA FD7119          19      LD  (IY+25),C       ;RootEntCnt
0011CD 51CD 012000          10      LD  BC,32
0011D0 51D0 ED5B2FF1        20      LD  DE,(_DTA)
0011D4 51D4 AF               4      XOR A
0011D5 51D5 12               7      LD  (DE),A      ;ドライブ番号
0011D6 51D6 13               6      INC DE
0011D7 51D7 EDB0                    LDIR            ;ディレクトリエントリ
0011D9 51D9 FD750E          19      LD  (IY+14),L
0011DC 51DC FD740F          19      LD  (IY+15),H
0011DF 51DF C9              10      RET
                                
       51E0                     _SYS12:
0011E0 51E0 FD2A37F1        20      LD  IY,(_FCB)
0011E4 51E4 FDE5            15      PUSH    IY
0011E6 51E6 D1              10      POP DE
0011E7 51E7 CD9C52          17      CALL    INIT_FILE
                                
0011EA 51EA FD6E0E          19      LD  L,(IY+14)
0011ED 51ED FD660F          19      LD  H,(IY+15)
0011F0 51F0 FD4E19          19      LD  C,(IY+25)
0011F3 51F3 18CF            12      JR  S12X1
                                
       51F5                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0011F5 51F5 CD154D          17      CALL    SET_FCB
0011F8 51F8 CDE34C          17      CALL    GETSEQ
0011FB 51FB CDD04C          17      CALL    RB_READ
0011FE 51FE E5              11      PUSH    HL
0011FF 51FF CDF04C          17      CALL    SETSEQ
001202 5202 E1              10      POP HL
       5203                     SREAD:
001203 5203 C601             7      ADD A,001H
001205 5205 D8              11      RET C
                                
001206 5206 7D               4      LD  A,L
001207 5207 D601             7      SUB 001H
001209 5209 9F               4      SBC A,A
00120A 520A E603             7      AND 3
00120C 520C 1F               4      RRA
00120D 520D C9              10      RET
                                
       520E                     _SYS18:     ;(BDOS)ログインベクトルの獲得
00120E 520E 210100          10      LD  HL,00001H
001211 5211 AF               4      XOR A
001212 5212 C9              10      RET
                                
       5213                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
001213 5213 3A4AF1          13      LD  A,(_DVSW)
001216 5216 C9              10      RET
                                
       5217                     _SYS1A:     ;(BDOS)DTAの設定
001217 5217 ED532FF1        20      LD  (_DTA),DE
00121B 521B AF               4      XOR A
00121C 521C C9              10      RET
                                
       521D                     _SYS1B:     ;(BDOS)ディスク情報の獲得
00121D 521D 010002          10      LD  BC,512
001220 5220 11C302          10      LD  DE,707
001223 5223 210000          10      LD  HL,0
001226 5226 DD2139F1        14      LD  IX,_BUF
00122A 522A FD2139F1        14      LD  IY,_BUF
00122E 522E FD3600F9        19      LD  (IY+0),0F9H
001232 5232 3E02             7      LD  A,2
001234 5234 C9              10      RET
                                
       5235                     _SYS21:     ;(BDOS)ランダムな読み出し
001235 5235 CD154D          17      CALL    SET_FCB
                                
001238 5238 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
00123B 523B FD6622          19      LD  H,(IY+34)
                                
00123E 523E CDD04C          17      CALL    RB_READ
001241 5241 18C0            12      JR  SREAD
                                
       5243                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
001243 5243 CD5351          17      CALL    _SYS0F
001246 5246 D8              11      RET C
                                
001247 5247 D5              11      PUSH    DE      ;EX DE,IY
001248 5248 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00124A 524A CD054D          17      CALL    GETSIZE
       524D                     _S24X1:
00124D 524D FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001250 5250 FD7422          19      LD  (IY+34),H
001253 5253 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
001257 5257 FDE3            23      EX  (SP),IY     ;
001259 5259 D1              10      POP DE      ;
                                
00125A 525A AF               4      XOR A
00125B 525B C9              10      RET
                                
       525C                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
00125C 525C E5              11      PUSH    HL
00125D 525D D5              11      PUSH    DE      ;EX DE,IY
00125E 525E FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001260 5260 CDE34C          17      CALL    GETSEQ
001263 5263 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       5265                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001265 5265 CD154D          17      CALL    SET_FCB
001268 5268 E5              11      PUSH    HL
001269 5269 FD6E21          19      LD  L,(IY+33)
00126C 526C FD6622          19      LD  H,(IY+34)
00126F 526F 2225F1          16      LD  (RR_LOW),HL
001272 5272 FD6E23          19      LD  L,(IY+35)
001275 5275 FD6624          19      LD  H,(IY+36)
001278 5278 2227F1          16      LD  (RR_HIGH),HL
00127B 527B E1              10      POP HL
00127C 527C CD3249          17      CALL    ROM_READ
00127F 527F ED5B25F1        20      LD  DE,(RR_LOW)
001283 5283 FD7321          19      LD  (IY+33),E
001286 5286 FD7222          19      LD  (IY+34),D
001289 5289 ED5B27F1        20      LD  DE,(RR_HIGH)
00128D 528D FD7323          19      LD  (IY+35),E
001290 5290 FD7224          19      LD  (IY+36),D
001293 5293 9F               4      SBC A,A
001294 5294 C9              10      RET
                                
       5295                     _SYS2F:
001295 5295 44               4      LD  B,H
001296 5296 2A2FF1          16      LD  HL,(_DTA)
001299 5299 C36E4D          10      JP  DISKIO
                                
       529C                     INIT_FILE:
00129C 529C EB               4      EX  DE,HL
00129D 529D 1153F1          10      LD  DE,FDRV
0012A0 52A0 010C00          10      LD  BC,1+8+3
0012A3 52A3 EDB0                    LDIR
0012A5 52A5 CD034F          17      CALL    GET_DISK_BANK_FDRV
0012A8 52A8 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0012AB 52AB 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0012AE 52AE C9              10      RET
                                
       52AF                     ZERO_MEMORY_DE:
0012AF 52AF AF               4      XOR A
       52B0                     FILL_MEMORY_DE:
0012B0 52B0 12               7      LD  (DE),A
0012B1 52B1 13               6      INC DE
0012B2 52B2 10FC            13      DJNZ    FILL_MEMORY_DE
0012B4 52B4 C9              10      RET
                                
0012B5 52B5                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 474F5D4F8E4F474F        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 474F474F934FD44F        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 9B4F474FEE4F8250        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 425148514F515351        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 A951B751E051474F        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 F551474F474F474F        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 0E52135217521D52        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 474F474F474F4352        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 5C52474F474F6552        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 474F474F9450474F        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 9A50474F474F9552        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB8 5FB8 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 474F474F474F474F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM32.ASM:UTF_8]
