                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
       0001                     USE_MORMAL32K_OR_ASCII16        EQU 1   ;ノーマル32KB/ASCII-16K ROMを作成する
                                
                                    INCLUDE "DISKROM.ASM"
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
       0159                     CALBAS  EQU 00159H
                                
       269A                     DECADD  EQU 0269AH
       27E6                     DECMUL  EQU 027E6H
       2F8A                     FRCINT  EQU 02F8AH
                                
       303A                     FRCDBL  EQU 0303AH
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
       7D17                     ST_BAS  EQU 07D17H
                                
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F847                     ARG EQU 0F847H
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBB1                     BASROM  EQU 0FBB1H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCC9                     SLTATR  EQU 0FCC9H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
       FD99                     DEVICE  EQU 0FD99H
                                
       FDDB                     H_PINL  EQU 0FDDBH
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                            ;ASCII-16K
       6000                     ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
       7000                     ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
                                BANK0_SEL EQU   06000H  ;6000-67FF
                                BANK1_SEL EQU   06800H  ;6800-6FFF
                                BANK2_SEL EQU   07000H  ;7000-77FF
                                BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
                                KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
                                KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
                                KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
                                KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
                                KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
                                KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
                                KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
       F280                     ISC EQU 0F280H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F280                     SP32    EQU 0F280H
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0042                    DW  INIT_ROM    ; Main program execution address.
000004 4004 1D50                    DW  STATEMENT   ; STATEMENT
000006 4006 4D51                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C3A552          10      JP  DISKIO
000013 4013 C3EB52          10      JP  DSKCHG
000016 4016 C34153          10      JP  GETDPB
000019 4019 C33454          10      JP  CHOICE
00001C 401C C33854          10      JP  DSKFMT
00001F 401F C33A54          10      JP  DSKSTP
000022 4022 C33B54          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C33854          10      JP  DSKFMT
000029 4029 C33A54          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C37454          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite"
            204449534B20524F    
            4D204C697465        
000096 4096                         ALIGN   32
0000A0 40A0 76302E362E302E30        DB  "v0.6.0.0"
0000A8 40A8                         ALIGN   32
       40C0                     MSG_ERROR_ROM_MODE:
                                #if exists USE_MORMAL32K_OR_ASCII16
0000C0 40C0 4E6F726D616C2052        DB  "Normal ROM/ASCII-16K only!",13,10
            4F4D2F4153434949    
            2D31364B206F6E6C    
            79210D0A            
                                #else
                                    DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
                                #endif
0001BD 41BD                         ORG 041BDH
0001BD 41BD C9              10      RET
                                
                                    ;MBR_Partition1 (2DDのデータ)
0001BE 41BE 00                      DB  0       ;ブートフラグ
0001BF 41BF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001C2 41C2 01                      DB  1       ;識別子(FAT12)
0001C3 41C3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001C6 41C6 10000000                DW  16,0        ;パーティションの最初のセクタ番号(LBA方式)
0001CA 41CA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                    ;MBR_Partition2 (2DDのデータ)
                                    DB  0       ;ブートフラグ
                                    DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
                                    DB  1       ;識別子(FAT12)
                                    DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
                                    DW  16+1440,0   ;パーティションの最初のセクタ番号(LBA方式)
                                    DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                #endif
                                
0001FE 41FE                         ORG 041FEH
0001FE 41FE 55AA                    DB  055H,0AAH   ;MBR_Sig
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4200                     INIT_ROM:
000200 4200 3A21FB          13      LD  A,(DRVTBL)
000203 4203 FE01             7      CP  1
000205 4205 C8              11      RET Z
                                
000206 4206 AF               4      XOR A
000207 4207 2100F3          10      LD  HL,0F300H
00020A 420A 0668             7      LD  B,068H
00020C 420C CDD64C          17      CALL    FILL_MEMORY
                                
00020F 420F 3E01             7      LD  A,1
000211 4211 3221FB          13      LD  (DRVTBL),A
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
000214 4214 2A74F6          16      LD  HL,(STKTOP) ;起動時の空き容量表示の為
000217 4217 01C0FE          10      LD  BC,-00140H
00021A 421A 09              11      ADD HL,BC
00021B 421B 2274F6          16      LD  (STKTOP),HL
                                #else
                                    LD  HL,STKTOP+1 ;起動時の空き容量表示の為
                                    DEC (HL)
                                #endif
                                
00021E 421E AF               4      XOR A
00021F 421F 32EAF2          13      LD  (_DVSW),A
000222 4222 3D               4      DEC A       ;0FFH
000223 4223 3299FD          13      LD  (DEVICE),A
                                
000226 4226 210D44          10      LD  HL,AT_ISC
000229 4229 1180F2          10      LD  DE,ISC
00022C 422C 018800          10      LD  BC,ISC_E-ISC
00022F 422F EDB0                    LDIR
                                    
000231 4231 3EC3             7      LD  A,0C3H      ;JP
000233 4233 3243FF          13      LD  (H_GONE),A
000236 4236 327DF3          13      LD  (BDOS),A
000239 4239 326BF3          13      LD  (RAMUSE),A
00023C 423C 3268F3          13      LD  (ROMUSE),A
00023F 423F 2180F2          10      LD  HL,REPLACE_COMMAND
000242 4242 2244FF          16      LD  (H_GONE+1),HL
000245 4245 2131F3          10      LD  HL,H_BDOS
000248 4248 227EF3          16      LD  (BDOS+1),HL
00024B 424B 21ABF2          10      LD  HL,RAMUSE1
00024E 424E 226CF3          16      LD  (RAMUSE+1),HL
000251 4251 21BDF2          10      LD  HL,ROMUSE1
000254 4254 2269F3          16      LD  (ROMUSE+1),HL
                                
000257 4257 3E                      DB  03EH
000258 4258 F7              12      RST 30H
000259 4259 3271FE          13      LD  (H_BINS),A
00025C 425C 3276FE          13      LD  (H_BINL),A
00025F 425F 327BFE          13      LD  (H_FILE),A
000262 4262 3231F3          13      LD  (H_BDOS),A
000265 4265 32DBFD          13      LD  (H_PINL),A
000268 4268 32A7FF          13      LD  (H_PHYD),A
                                
00026B 426B CD5943          17      CALL    GTSL1_
00026E 426E 3297F2          13      LD  (ROM_SLT),A
000271 4271 32A7F2          13      LD  (ROM_SLT_COPY),A
000274 4274 3272FE          13      LD  (H_BINS+1),A
000277 4277 3277FE          13      LD  (H_BINL+1),A
00027A 427A 327CFE          13      LD  (H_FILE+1),A
00027D 427D 3232F3          13      LD  (H_BDOS+1),A
000280 4280 32DCFD          13      LD  (H_PINL+1),A
000283 4283 32A8FF          13      LD  (H_PHYD+1),A
000286 4286 3222FB          13      LD  (DRVTBL+1),A
000289 4289 3248F3          13      LD  (MASTERS),A
                                
00028C 428C 21C246          10      LD  HL,ROM_LOAD
00028F 428F 2273FE          16      LD  (H_BINS+2),HL
000292 4292 217348          10      LD  HL,ROM_RUN
000295 4295 2278FE          16      LD  (H_BINL+2),HL
000298 4298 218148          10      LD  HL,ROM_FILES
00029B 429B 227DFE          16      LD  (H_FILE+2),HL
00029E 429E 21D954          10      LD  HL,ROM_BDOS
0002A1 42A1 2233F3          16      LD  (H_BDOS+2),HL
0002A4 42A4 21D244          10      LD  HL,ROM_BOOT
0002A7 42A7 22DDFD          16      LD  (H_PINL+2),HL
0002AA 42AA 21A552          10      LD  HL,DISKIO
0002AD 42AD 22A9FF          16      LD  (H_PHYD+2),HL
                                
0002B0 42B0 3E                      DB  03EH
0002B1 42B1 C9              10      RET
0002B2 42B2 327FFE          13      LD  (H_FILE+4),A
0002B5 42B5 3275FE          13      LD  (H_BINS+4),A
0002B8 42B8 327AFE          13      LD  (H_BINL+4),A
0002BB 42BB 3235F3          13      LD  (H_BDOS+4),A
0002BE 42BE 32DFFD          13      LD  (H_PINL+4),A
0002C1 42C1 32ABFF          13      LD  (H_PHYD+4),A
                                
0002C4 42C4 AF               4      XOR A
                                #if exists USE_MORMAL32K_OR_ASCII16
0002C5 42C5 320060          13      LD  (ASCII16_BANK0_SEL),A       ;似非RAM対策でバンク0を設定
0002C8 42C8 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK0_SEL),A           ;似非RAM対策でバンク0を設定
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0002CB 42CB 3A0060          13      LD  A,(BANK1_ADR)
0002CE 42CE FE41             7      CP  'A'
                                #if exists USE_MORMAL32K_OR_ASCII16
0002D0 42D0 2876            12      JR  Z,NOT_BANK_TYPE
0002D2 42D2 3E01             7      LD  A,DISK_BANK
0002D4 42D4 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    JR  NZ,NOT_BANK_TYPE
                                    LD  A,DISK_BANK
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0002D7 42D7 CD3801          17      CALL    RSLREG      ;read primary slot #
0002DA 42DA 07               4      RLCA
0002DB 42DB 07               4      RLCA
0002DC 42DC F5              11      PUSH    AF
0002DD 42DD 1605             7      LD  D,4+1
0002DF 42DF CD6043          17      CALL    GTSL2_
0002E2 42E2 3244F3          13      LD  (RAMAD3),A
0002E5 42E5 F1              10      POP AF
0002E6 42E6 07               4      RLCA
0002E7 42E7 07               4      RLCA
0002E8 42E8 1603             7      LD  D,2+1
0002EA 42EA CD6043          17      CALL    GTSL2_
0002ED 42ED 2680             7      LD  H,080H
0002EF 42EF CD7D43          17      CALL    CHK_RAM
0002F2 42F2 3243F3          13      LD  (RAMAD2),A
       42F5                     RAMCHK2:
0002F5 42F5 3A44F3          13      LD  A,(RAMAD3)
0002F8 42F8 2640             7      LD  H,040H
0002FA 42FA CD7D43          17      CALL    CHK_RAM
0002FD 42FD 3242F3          13      LD  (RAMAD1),A
       4300                     RAMCHK1:
000300 4300 3A44F3          13      LD  A,(RAMAD3)
000303 4303 2600             7      LD  H,00H
000305 4305 CD7D43          17      CALL    CHK_RAM
000308 4308 3241F3          13      LD  (RAMAD0),A
       430B                     RAMCHK0:
00030B 430B 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
00030E 430E 010F00          10      LD  BC,0000FH       ;切り上げ
000311 4311 09              11      ADD HL,BC
000312 4312 7D               4      LD  A,L
                                
000313 4313 0604             7      LD  B,4
       4315                     B_DRIVE1:
000315 4315 CB3C             8      SRL H
000317 4317 1F               4      RRA
000318 4318 10FB            13      DJNZ    B_DRIVE1
                                
00031A 431A C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
00031C 431C 32E9F2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
                                    ;拡張スロットの選択を設定する
00031F 431F 3A97F2          13      LD  A,(ROM_SLT)
000322 4322 57               4      LD  D,A
000323 4323 E60C             7      AND 00CH
000325 4325 5F               4      LD  E,A
000326 4326 7A               4      LD  A,D
000327 4327 E603             7      AND 3
000329 4329 87               4      ADD A,A
00032A 432A 87               4      ADD A,A
00032B 432B 87               4      ADD A,A
00032C 432C 37               4      SCF
00032D 432D 8F               4      ADC A,A
00032E 432E B3               4      OR  E
00032F 432F 5F               4      LD  E,A
000330 4330 1600             7      LD  D,0
000332 4332 21C9FC          10      LD  HL,SLTATR
000335 4335 19              11      ADD HL,DE
000336 4336 3660            10      LD  (HL),060H
                                    ;CTRL+STOPを抑制する
000338 4338 3E01             7      LD  A,1
00033A 433A 32B1FB          13      LD  (BASROM),A
                                    ;BASICを起動する
00033D 433D FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000341 4341 DD21177D        14      LD  IX,ST_BAS   ;continue start of MSX-BASIC without executing BASIC programs in ROM
000345 4345 C35901          10      JP  CALBAS
                                
       4348                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
000348 4348 21C040          10      LD  HL,MSG_ERROR_ROM_MODE
00034B 434B CD9844          17      CALL    MSX
00034E 434E FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000352 4352 DD219F00        14      LD  IX,CHGET
000356 4356 C31C00          10      JP  _CALSLT
                                
       4359                     GTSL1_:             ;自分のいるスロットを知る
000359 4359 CD3801          17      CALL    RSLREG      ;read primary slot #
00035C 435C 0F               4      RRCA
00035D 435D 0F               4      RRCA
00035E 435E 1601             7      LD  D,1
       4360                     GTSL2_:
000360 4360 E603             7      AND 3       ;[A]=000000PP
000362 4362 5F               4      LD  E,A     ;[E]=000000PP
000363 4363 21C1FC          10      LD  HL,EXPTBL
000366 4366 85               4      ADD A,L     ;桁上りは無い
000367 4367 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000368 4368 7B               4      LD  A,E     ;[A]=000000PP
000369 4369 CB7E            13      BIT 7,(HL)
00036B 436B C8              11      RET Z
00036C 436C 7D               4      LD  A,L     ;point to SLTTBL entry
00036D 436D C604             7      ADD A,4     ;桁上りは無い
00036F 436F 6F               4      LD  L,A
000370 4370 7E               7      LD  A,(HL)      ;get currently expansion slot register
       4371                     GTSL3_:
000371 4371 15               4      DEC D
000372 4372 2803            12      JR  Z,GTSL4_:
000374 4374 0F               4      RRCA
000375 4375 18FA            12      JR  GTSL3_:
       4377                     GTSL4_:
000377 4377 E60C             7      AND 00CH        ;[A] = 0000SS00
000379 4379 B3               4      OR  E       ;[A] = 0000SSPP
00037A 437A F680             7      OR  080H        ;[A] = 1000SSPP
00037C 437C C9              10      RET
                                
       437D                     CHK_RAM:
00037D 437D E5              11      PUSH    HL
00037E 437E CDD243          17      CALL    CHK_RAM0
000381 4381 E1              10      POP HL
000382 4382 C8              11      RET Z
000383 4383 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000386 4386 E680             7      AND 080H
000388 4388 CDA943          17      CALL    CHK_RAM_SLT
00038B 438B C8              11      RET Z
00038C 438C 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
00038F 438F E680             7      AND 080H
000391 4391 C601             7      ADD A,1
000393 4393 CDA943          17      CALL    CHK_RAM_SLT
000396 4396 C8              11      RET Z
000397 4397 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00039A 439A E680             7      AND 080H
00039C 439C C602             7      ADD A,2
00039E 439E CDA943          17      CALL    CHK_RAM_SLT
0003A1 43A1 C8              11      RET Z
0003A2 43A2 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
0003A5 43A5 E680             7      AND 080H
0003A7 43A7 C603             7      ADD A,3
       43A9                     CHK_RAM_SLT:
0003A9 43A9 E5              11      PUSH    HL
0003AA 43AA CDD243          17      CALL    CHK_RAM0        ;スロット#X or X-0
0003AD 43AD E1              10      POP HL
0003AE 43AE C8              11      RET Z
0003AF 43AF CB79             8      BIT 7,C
0003B1 43B1 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
0003B3 43B3 79               4      LD  A,C
0003B4 43B4 C604             7      ADD A,4*1           ;スロット#X-1
0003B6 43B6 E5              11      PUSH    HL
0003B7 43B7 CDD243          17      CALL    CHK_RAM0
0003BA 43BA E1              10      POP HL
0003BB 43BB C8              11      RET Z
0003BC 43BC 79               4      LD  A,C
0003BD 43BD C608             7      ADD A,4*2           ;スロット#X-2
0003BF 43BF E5              11      PUSH    HL
0003C0 43C0 CDD243          17      CALL    CHK_RAM0
0003C3 43C3 E1              10      POP HL
0003C4 43C4 C8              11      RET Z
0003C5 43C5 79               4      LD  A,C
0003C6 43C6 C60C             7      ADD A,4*3           ;スロット#X-3
0003C8 43C8 E5              11      PUSH    HL
0003C9 43C9 CDD243          17      CALL    CHK_RAM0
0003CC 43CC E1              10      POP HL
       43CD                     CHK_RAM_E:
0003CD 43CD AF               4      XOR A
0003CE 43CE 3C               4      INC A           ;ZF=0にする
0003CF 43CF 3E00             7      LD  A,0
0003D1 43D1 C9              10      RET
                                
       43D2                     CHK_RAM0:
0003D2 43D2 4F               4      LD  C,A
0003D3 43D3 3A97F2          13      LD  A,(ROM_SLT)
0003D6 43D6 B9               4      CP  C
0003D7 43D7 28F4            12      JR  Z,CHK_RAM_E
0003D9 43D9 2E00             7      LD  L,0
       43DB                     CHK_RAM1:
0003DB 43DB 79               4      LD  A,C
0003DC 43DC CDCA44          17      CALL    RDSLTX
0003DF 43DF C6E5             7      ADD A,0E5H
0003E1 43E1 47               4      LD  B,A
0003E2 43E2 5F               4      LD  E,A
0003E3 43E3 79               4      LD  A,C
0003E4 43E4 C5              11      PUSH    BC
0003E5 43E5 CD1400          17      CALL    _WRSLT
0003E8 43E8 C1              10      POP BC
0003E9 43E9 79               4      LD  A,C
0003EA 43EA CDCA44          17      CALL    RDSLTX
0003ED 43ED B8               4      CP  B
0003EE 43EE C0              11      RET NZ
0003EF 43EF D6E5             7      SUB 0E5H
0003F1 43F1 79               4      LD  A,C
0003F2 43F2 5F               4      LD  E,A
0003F3 43F3 C5              11      PUSH    BC
0003F4 43F4 CD1400          17      CALL    _WRSLT
0003F7 43F7 C1              10      POP BC
0003F8 43F8 24               4      INC H
0003F9 43F9 7D               4      LD  A,L
0003FA 43FA C604             7      ADD A,4
0003FC 43FC 6F               4      LD  L,A
0003FD 43FD 20DC            12      JR  NZ,CHK_RAM1
0003FF 43FF 79               4      LD  A,C     ;ZF=1のハズ
000400 4400 C9              10      RET
                                
       4401                     CALSLT_R:
000401 4401 C5              11      PUSH    BC
000402 4402 E5              11      PUSH    HL
000403 4403 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000407 4407 CD1C00          17      CALL    _CALSLT
00040A 440A E1              10      POP HL
00040B 440B C1              10      POP BC
00040C 440C C9              10      RET
                                
       440D                     AT_ISC:
00040D F280                         ORG ISC,AT_ISC-RUN
       F280                     REPLACE_COMMAND:
00040D F280 FEB7             7      CP  0B7H            ;FILES
00040F F282 CC7BFE          17      CALL    Z,H_FILE
000412 F285 FEB5             7      CP  0B5H            ;LOAD
000414 F287 CA71FE          10      JP  Z,H_BINS
000417 F28A FE8A             7      CP  08AH            ;RUN
000419 F28C CA76FE          10      JP  Z,H_BINL
00041C F28F FED6             7      CP  0D6H            ;COPY
00041E F291 2813            12      JR  Z,FIX_COPY
000420 F293 FECF             7      CP  0CFH            ;BLOAD
000422 F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
000423 F296 F7              12      RST 30H
       F297                     ROM_SLT:
000424 F297 00                      DB  0
000425 F298 A447                    DW  ROM_BLOAD
000427 F29A F5              11      PUSH    AF
000428 F29B E5              11      PUSH    HL
000429 F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
00042C F29F E1              10      POP HL
00042D F2A0 F1              10      POP AF
00042E F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
000430 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
000432 F2A5 C9              10      RET
       F2A6                     FIX_COPY:
000433 F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
000434 F2A7 00                      DB  0
000435 F2A8 2349                    DW  ROM_COPY
000437 F2AA C9              10      RET
       F2AB                     RAMUSE1:
000438 F2AB 3A42F3          13      LD  A,(RAMAD1)
00043B F2AE 1810            12      JR  ENASLT2
       F2B0                     CAL_MP:
00043D F2B0 2640             7      LD  H,040H
00043F F2B2 3AC1FC          13      LD  A,(EXPTBL)
000442 F2B5 CD2400          17      CALL    _ENASLT
000445 F2B8 CD1C00          17      CALL    _CALSLT
000448 F2BB 2640             7      LD  H,040H
       F2BD                     ROMUSE1:
00044A F2BD 3A97F2          13      LD  A,(ROM_SLT)
       F2C0                     ENASLT2:
00044D F2C0 C32400          10      JP  _ENASLT
                                
       F2C3                     _RESULT:
000450 F2C3 00                      DB  0
       F2C4                     _BANK:
000451 F2C4 00                      DB  0
       F2C5                     _BANK1:
000452 F2C5 00                      DB  0
       F2C6                     CLSZ:               ;クラスタサイズ
000453 F2C6 0004                    DW  1024
       F2C7                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2C8                     SECSZ:              ;セクタサイズ
000455 F2C8 0002                    DW  512
       F2C9                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2CA                     RR_LOW:
000457 F2CA 0000                    DW  0
       F2CB                     RR_MID  EQU $-1
       F2CC                     RR_HIGH:
000459 F2CC 0000                    DW  0
       F2CE                     _CLPS:
00045B F2CE 0000                    DW  0
       F2D0                     _LEFT:
00045D F2D0 0000                    DW  0
       F2D2                     _DTPS:
00045F F2D2 0000                    DW  0
       F2D4                     _DTA:
000461 F2D4 0000                    DW  0
       F2D6                     FLG_LDIR:
000463 F2D6 00                      DB  0
       F2D7                     _FCB:
000464 F2D7 0000                    DW  0
       F2D9                     _BUF:
       F2D9                     _BUF_LO:        ;LOGICAL OPERATION
000466 F2D9 00                      DB  0
       F2DA                     _BUF_ST:
000467 F2DA 0000                    DW  0
       F2DC                     _BUF_EN:
000469 F2DC 0000                    DW  0
       F2DE                     _BUF_EX:
       F2DE                     _BUF_W:
00046B F2DE 0000                    DW  0
       F2E0                     _BUF_H:
00046D F2E0 0000                    DW  0
       F2E2                     _BUF_X:
00046F F2E2 0000                    DW  0
       F2E4                     _BUF_Y:
000471 F2E4 00                      DB  0
       F2E5                     _BUF_P:
000472 F2E5 00                      DB  0
       F2E6                     _BUF_O:
000473 F2E6 00                      DB  0
       F2E7                     DTAX:
000474 F2E7 0000                    DW  0
       F2E9                     B_DRIVE:
000476 F2E9 00                      DB  0
       F2EA                     _DVSW:          ;カレントドライブ
000477 F2EA 00                      DB  0
       F2EB                     _CD:            ;カレントディレクトリ
000478 F2EB 0000                    DW  0
       F2ED                     DIRENT1:
00047A F2ED 0000                    DW  0
       F2EF                     _DIR_BANK:
00047C F2EF 00                      DB  0
       F2F0                     LEFTX:
00047D F2F0 0000                    DW  0
       F2F2                     PARAM0:
00047F F2F2 0000                    DW  0
       F2F4                     PARAM1:
000481 F2F4 0000                    DW  0
       F2F6                     _CDX:
000483 F2F6 0000                    DW  0
       F2F8                     FDRV:
000485 F2F8 00                      DB  0
       F2F9                     FNAME:
000486 F2F9                         DS  8+3
       F304                     _HL:
000491 F304 0000                    DW  0
       F306                     _SP:
000493 F306 0000                    DW  0
       F307                     _SP_H   EQU $-1
       F308                     ISC_E:
000495 4495                         ORG $$+RUN          ;$DEPHASE
                                
       4495                     MSX1:
000495 4495 CDF254          17      CALL    MSGA1
       4498                     MSX:
000498 4498 7E               7      LD  A,(HL)
000499 4499 23               6      INC HL
00049A 449A B7               4      OR  A
00049B 449B 20F8            12      JR  NZ,MSX1
00049D 449D C9              10      RET
                                
       449E                     PRTHX:
00049E 449E F5              11      PUSH    AF
00049F 449F 07               4      RLCA
0004A0 44A0 07               4      RLCA
0004A1 44A1 07               4      RLCA
0004A2 44A2 07               4      RLCA
0004A3 44A3 CDA744          17      CALL    PRTA2
0004A6 44A6 F1              10      POP AF
       44A7                     PRTA2:
0004A7 44A7 CDAD44          17      CALL    ASC
0004AA 44AA C3EE54          10      JP  MSG_A
                                    
       44AD                     ASC:
0004AD 44AD E60F             7      AND $0F
0004AF 44AF F630             7      OR  $30
0004B1 44B1 FE3A             7      CP  $3A
0004B3 44B3 D8              11      RET C
0004B4 44B4 C607             7      ADD A,7
0004B6 44B6 C9              10      RET
                                
       44B7                     MSN:
                                #if exists USE_MORMAL32K_OR_ASCII16
0004B7 44B7 CDC344          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
0004BA 44BA 23               6      INC HL
0004BB 44BB CDEE54          17      CALL    MSG_A
0004BE 44BE 10F7            13      DJNZ    MSN
0004C0 44C0 C9              10      RET
                                
       44C1                     RDSLT_ROM3:
0004C1 44C1 7E               7      LD  A,(HL)
0004C2 44C2 C9              10      RET
       44C3                     RDSLT_ROM:
0004C3 44C3 CB7C             8      BIT 7,H
0004C5 44C5 28FA            12      JR  Z,RDSLT_ROM3
       44C7                     RDSLT_ROM2:
0004C7 44C7 3A97F2          13      LD  A,(ROM_SLT)
       44CA                     RDSLTX:
0004CA 44CA C5              11      PUSH    BC
0004CB 44CB D5              11      PUSH    DE
0004CC 44CC CD0C00          17      CALL    _RDSLT
0004CF 44CF D1              10      POP DE
0004D0 44D0 C1              10      POP BC
0004D1 44D1 C9              10      RET
                                
       44D2                     ROM_BOOT:
0004D2 44D2 3E                      DB  03EH
0004D3 44D3 C9              10      RET
0004D4 44D4 32DBFD          13      LD  (H_PINL),A
0004D7 44D7 3ACAFF          13      LD  A,(EXTBIO)
0004DA 44DA FEF7             7      CP  0F7H        ;RST 30H
0004DC 44DC 280A            12      JR  Z,EXTBIO_OK
0004DE 44DE 3E                      DB  03EH
0004DF 44DF C9              10      RET
0004E0 44E0 21CAFF          10      LD  HL,EXTBIO
0004E3 44E3 061D             7      LD  B,29
0004E5 44E5 CDD64C          17      CALL    FILL_MEMORY
       44E8                     EXTBIO_OK:
0004E8 44E8 211545          10      LD  HL,DELOK
0004EB 44EB CD9844          17      CALL    MSX
                                
0004EE 44EE AF               4      XOR A
0004EF 44EF 3240F3          13      LD  (REBOOT),A
0004F2 44F2 2A48FC          16      LD  HL,(BOTTOM)
0004F5 44F5 110040          10      LD  DE,16384
0004F8 44F8 19              11      ADD HL,DE
0004F9 44F9 3817            12      JR  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
0004FB 44FB 57               4      LD  D,A
0004FC 44FC 0601             7      LD  B,1
0004FE 44FE 2100C0          10      LD  HL,0C000H
000501 4501 CDA552          17      CALL    DISKIO
                                
000504 4504 116BF3          10      LD  DE,RAMUSE
000507 4507 AF               4      XOR A
000508 4508 CD1EC0          17      CALL    0C01EH
00050B 450B 116BF3          10      LD  DE,RAMUSE
00050E 450E 37               4      SCF
00050F 450F CD1EC0          17      CALL    0C01EH
       4512                     BOOT1:
000512 4512 C33B54          10      JP  BASENT
                                
       4515                     DELOK:
000515 4515 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       4519                     ROM_LDIR:
000519 4519 3AD6F2          13      LD  A,(FLG_LDIR)
00051C 451C B7               4      OR  A
00051D 451D 206A            12      JR  NZ,ROM_LDIRVM
00051F 451F CB7A             8      BIT 7,D
000521 4521 CAB945          10      JP  Z,ROM_LDIRSLT
                                #if exists USE_MORMAL32K_OR_ASCII16
       4524                     LDIRA:
000524 4524 F3               4      DI
000525 4525 ED7306F3        20      LD  (_SP),SP
000529 4529 3A07F3          13      LD  A,(_SP_H)
00052C 452C FEC0             7      CP  0C0H
00052E 452E 3003            12      JR  NC,SPJ1
000530 4530 3180F2          10      LD  SP,SP32
       4533                     SPJ1:
       4533                     LDIR1:
000533 4533 78               4      LD  A,B
000534 4534 B1               4      OR  C
000535 4535 284D            12      JR  Z,LDIRE
                                
000537 4537 C5              11      PUSH    BC
000538 4538 D5              11      PUSH    DE
000539 4539 E5              11      PUSH    HL
00053A 453A 3A97F2          13      LD  A,(ROM_SLT)
00053D 453D 2680             7      LD  H,080H
00053F 453F CD2400          17      CALL    _ENASLT
000542 4542 E1              10      POP HL
000543 4543 D1              10      POP DE
000544 4544 C1              10      POP BC
       4545                     LDIR2:
000545 4545 7A               4      LD  A,D
000546 4546 FEC0             7      CP  0C0H
000548 4548 302C            12      JR  NC,LDIR4
                                
00054A 454A C5              11      PUSH    BC
00054B 454B D5              11      PUSH    DE
00054C 454C 115EF5          10      LD  DE,BUF
                                
00054F 454F 78               4      LD  A,B
000550 4550 B7               4      OR  A
000551 4551 2803            12      JR  Z,LDIR3
000553 4553 010001          10      LD  BC,00100H
       4556                     LDIR3:
000556 4556 C5              11      PUSH    BC
000557 4557 EDB0                    LDIR
000559 4559 2204F3          16      LD  (_HL),HL
                                
00055C 455C 3A43F3          13      LD  A,(RAMAD2)
00055F 455F 2680             7      LD  H,080H
000561 4561 CD2400          17      CALL    _ENASLT
                                
000564 4564 C1              10      POP BC
000565 4565 D1              10      POP DE
000566 4566 215EF5          10      LD  HL,BUF
000569 4569 EDB0                    LDIR
                                
00056B 456B 2A04F3          16      LD  HL,(_HL)
00056E 456E C1              10      POP BC
00056F 456F 78               4      LD  A,B
000570 4570 B7               4      OR  A
000571 4571 2811            12      JR  Z,LDIRE
000573 4573 05               4      DEC B
000574 4574 18BD            12      JR  LDIR1
       4576                     LDIR4:
                                #endif
000576 4576 EDB0                    LDIR
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
       4578                     LDIRE2:
000578 4578 D5              11      PUSH    DE
000579 4579 E5              11      PUSH    HL
00057A 457A 3A43F3          13      LD  A,(RAMAD2)
00057D 457D 2680             7      LD  H,080H
00057F 457F CD2400          17      CALL    _ENASLT
000582 4582 E1              10      POP HL
000583 4583 D1              10      POP DE
       4584                     LDIRE:
000584 4584 ED7B06F3        20      LD  SP,(_SP)
                                #endif
000588 4588 C9              10      RET
                                
       4589                     ROM_LDIRVM:
                                #if exists USE_MORMAL32K_OR_ASCII16
000589 4589 F3               4      DI
00058A 458A ED7306F3        20      LD  (_SP),SP
00058E 458E 3A07F3          13      LD  A,(_SP_H)
000591 4591 FEC0             7      CP  0C0H
000593 4593 3003            12      JR  NC,SPJ2
000595 4595 3180F2          10      LD  SP,SP32
       4598                     SPJ2:
000598 4598 C5              11      PUSH    BC
000599 4599 D5              11      PUSH    DE
00059A 459A E5              11      PUSH    HL
00059B 459B 3A97F2          13      LD  A,(ROM_SLT)
00059E 459E 2680             7      LD  H,080H
0005A0 45A0 CD2400          17      CALL    _ENASLT
0005A3 45A3 E1              10      POP HL
0005A4 45A4 D1              10      POP DE
0005A5 45A5 C1              10      POP BC
                                #endif
0005A6 45A6 C5              11      PUSH    BC
0005A7 45A7 D5              11      PUSH    DE
0005A8 45A8 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0005AC 45AC DD215C00        14      LD  IX,LDIRVM
0005B0 45B0 CD1C00          17      CALL    _CALSLT
0005B3 45B3 E1              10      POP HL
0005B4 45B4 C1              10      POP BC
0005B5 45B5 09              11      ADD HL,BC
0005B6 45B6 EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
0005B7 45B7 18BF            12      JR  LDIRE2
                                #else
                                    RET
                                #endif
                                
       45B9                     ROM_LDIRSLT:
                                #if exists USE_MORMAL32K_OR_ASCII16
0005B9 45B9 F3               4      DI
0005BA 45BA ED7306F3        20      LD  (_SP),SP
0005BE 45BE 3A07F3          13      LD  A,(_SP_H)
0005C1 45C1 FEC0             7      CP  0C0H
0005C3 45C3 3003            12      JR  NC,SPJ3
0005C5 45C5 3180F2          10      LD  SP,SP32
       45C8                     SPJ3:
0005C8 45C8 C5              11      PUSH    BC
0005C9 45C9 D5              11      PUSH    DE
0005CA 45CA E5              11      PUSH    HL
0005CB 45CB 3A97F2          13      LD  A,(ROM_SLT)
0005CE 45CE 2680             7      LD  H,080H
0005D0 45D0 CD2400          17      CALL    _ENASLT
0005D3 45D3 E1              10      POP HL
0005D4 45D4 D1              10      POP DE
0005D5 45D5 C1              10      POP BC
                                #endif
       45D6                     ROM_LDIRSLT1:
0005D6 45D6 EB               4      EX  DE,HL
       45D7                     RLDIRSLT1:
0005D7 45D7 CB7C             8      BIT 7,H
0005D9 45D9 2021            12      JR  NZ,RLDIRSLT_EXIT
0005DB 45DB 1A               7      LD  A,(DE)
0005DC 45DC 13               6      INC DE
0005DD 45DD C5              11      PUSH    BC
0005DE 45DE D5              11      PUSH    DE
0005DF 45DF E5              11      PUSH    HL
0005E0 45E0 5F               4      LD  E,A
                                
0005E1 45E1 0141F3          10      LD  BC,RAMAD0
0005E4 45E4 7C               4      LD  A,H
0005E5 45E5 07               4      RLCA
0005E6 45E6 07               4      RLCA
0005E7 45E7 E603             7      AND 3
0005E9 45E9 81               4      ADD A,C
0005EA 45EA 4F               4      LD  C,A
0005EB 45EB 0A               7      LD  A,(BC)
       45EC                     RLDIRSLT2:
0005EC 45EC CD1400          17      CALL    _WRSLT
0005EF 45EF 08               4      EX  AF,AF'
0005F0 45F0 E1              10      POP HL
0005F1 45F1 D1              10      POP DE
0005F2 45F2 C1              10      POP BC
0005F3 45F3 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0005F5 45F5 EAD745          10      JP  PE,RLDIRSLT1
0005F8 45F8 EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
0005F9 45F9 C37845          10      JP  LDIRE2
       45FC                     RLDIRSLT_EXIT:
0005FC 45FC EB               4      EX  DE,HL
0005FD 45FD C33345          10      JP  LDIR1
                                #else
                                    RET
                                RLDIRSLT_EXIT:
                                    EX  DE,HL
                                    LDIR
                                    RET
                                #endif
                                
       4600                     END_OF_LINE:
000600 4600 215EF5          10      LD  HL,BUF
       4603                     EOL1:
000603 4603 7E               7      LD  A,(HL)
000604 4604 C8              11      RET Z
000605 4605 FE0D             7      CP  00DH
000607 4607 2807            12      JR  Z,EOLE
000609 4609 FE0A             7      CP  00AH
00060B 460B 2803            12      JR  Z,EOLE
00060D 460D 23               6      INC HL
00060E 460E 18F3            12      JR  EOL1
       4610                     EOLE:
000610 4610 3600            10      LD  (HL),0
000612 4612 23               6      INC HL
000613 4613 7E               7      LD  A,(HL)
000614 4614 FE0A             7      CP  00AH
000616 4616 C0              11      RET NZ
000617 4617 23               6      INC HL
000618 4618 C9              10      RET
                                
       4619                     ROM_LOAD_ASCII:
000619 4619 210000          10      LD  HL,0
00061C 461C 22DAF2          16      LD  (_BUF_ST),HL    ;読み出し位置
00061F 461F 2A76F6          16      LD  HL,(TXTTAB)
000622 4622 22DCF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
000625 4625 215EF5          10      LD  HL,BUF
000628 4628 22D4F2          16      LD  (_DTA),HL
       462B                     RLOAD_A1:
00062B 462B 2ADAF2          16      LD  HL,(_BUF_ST)
00062E 462E 22CAF2          16      LD  (RR_LOW),HL
000631 4631 210201          10      LD  HL,258
000634 4634 CD434B          17      CALL    ROM_READ
000637 4637 7C               4      LD  A,H
000638 4638 B5               4      OR  L
000639 4639 2879            12      JR  Z,RLOAD_AEND
00063B 463B 015EF5          10      LD  BC,BUF
00063E 463E 09              11      ADD HL,BC
00063F 463F 3600            10      LD  (HL),0
000641 4641 CD0046          17      CALL    END_OF_LINE
000644 4644 015EF5          10      LD  BC,BUF
000647 4647 A7               4      AND A
000648 4648 ED42            15      SBC HL,BC
00064A 464A 2810            12      JR  Z,RLOAD_A2
00064C 464C 4D               4      LD  C,L
00064D 464D 44               4      LD  B,H
00064E 464E ED5BDAF2        20      LD  DE,(_BUF_ST)
000652 4652 19              11      ADD HL,DE
000653 4653 22DAF2          16      LD  (_BUF_ST),HL
000656 4656 3A5EF5          13      LD  A,(BUF)
000659 4659 B7               4      OR  A
00065A 465A 28CF            12      JR  Z,RLOAD_A1
       465C                     RLOAD_A2:
00065C 465C 115EF5          10      LD  DE,BUF
00065F 465F CD0D4D          17      CALL    SPCUTEX
000662 4662 1A               7      LD  A,(DE)
000663 4663 B7               4      OR  A
000664 4664 284E            12      JR  Z,RLOAD_AEND
000666 4666 CD1F4D          17      CALL    GETNUM
000669 4669 7C               4      LD  A,H
00066A 466A B5               4      OR  L
00066B 466B CA8B47          10      JP  Z,ERROR_DIRECT_IN_FILE
00066E 466E DD2ADCF2        20      LD  IX,(_BUF_EN)
000672 4672 DD7502          19      LD  (IX+2),L
000675 4675 DD7403          19      LD  (IX+3),H
                                
000678 4678 CD064D          17      CALL    SPCUT
00067B 467B EB               4      EX  DE,HL
00067C 467C DDE5            15      PUSH    IX
00067E 467E DD21B242        14      LD  IX,CRUNCH
000682 4682 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000686 4686 CD1C00          17      CALL    _CALSLT
000689 4689 DDE1            14      POP IX
00068B 468B EB               4      EX  DE,HL
00068C 468C 111FF4          10      LD  DE,KBUF
00068F 468F 37               4      SCF
000690 4690 ED52            15      SBC HL,DE
000692 4692 CA8B47          10      JP  Z,ERROR_DIRECT_IN_FILE
000695 4695 DA8B47          10      JP  C,ERROR_DIRECT_IN_FILE
000698 4698 4D               4      LD  C,L
000699 4699 44               4      LD  B,H
00069A 469A 2ADCF2          16      LD  HL,(_BUF_EN)
00069D 469D 110400          10      LD  DE,4
0006A0 46A0 19              11      ADD HL,DE
0006A1 46A1 111FF4          10      LD  DE,KBUF
                                
0006A4 46A4 EB               4      EX  DE,HL
0006A5 46A5 EDB0                    LDIR
0006A7 46A7 EB               4      EX  DE,HL
                                
0006A8 46A8 DD7500          19      LD  (IX+0),L
0006AB 46AB DD7401          19      LD  (IX+1),H
0006AE 46AE 22DCF2          16      LD  (_BUF_EN),HL
0006B1 46B1 C32B46          10      JP  RLOAD_A1
                                
       46B4                     RLOAD_AEND:
0006B4 46B4 2ADCF2          16      LD  HL,(_BUF_EN)
0006B7 46B7 AF               4      XOR A
0006B8 46B8 77               7      LD  (HL),A
0006B9 46B9 23               6      INC HL
0006BA 46BA 77               7      LD  (HL),A
0006BB 46BB 23               6      INC HL
0006BC 46BC 22DCF2          16      LD  (_BUF_EN),HL
0006BF 46BF C34E47          10      JP  RLOAD_END1
                                
       46C2                     ROM_LOAD:
0006C2 46C2 CDF148          17      CALL    INIT_PARAM
0006C5 46C5 7E               7      LD  A,(HL)
0006C6 46C6 FE2C             7      CP  ','
0006C8 46C8 2003            12      JR  NZ,ROM_LOAD0
0006CA 46CA 23               6      INC HL
0006CB 46CB 7E               7      LD  A,(HL)
0006CC 46CC 2B               6      DEC HL
       46CD                     ROM_LOAD0:
0006CD 46CD 32BEFC          13      LD  (RUNBNF),A
0006D0 46D0 CDE44B          17      CALL    FILE_B
0006D3 46D3 3AF9F2          13      LD  A,(FNAME)
0006D6 46D6 FE20             7      CP  020H
0006D8 46D8 CADF4B          10      JP  Z,ROM_ORG
                                
0006DB 46DB CD764D          17      CALL    ROM_OPEN
0006DE 46DE DA9747          10      JP  C,ERROR_FILE_NOT_FOUND
       46E1                     ROM_LOAD1:
0006E1 46E1 21D9F2          10      LD  HL,_BUF
0006E4 46E4 22D4F2          16      LD  (_DTA),HL
0006E7 46E7 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
0006EA 46EA CD434B          17      CALL    ROM_READ
0006ED 46ED 3AD9F2          13      LD  A,(_BUF)
0006F0 46F0 3C               4      INC A
0006F1 46F1 C21946          10      JP  NZ,ROM_LOAD_ASCII
0006F4 46F4 2A76F6          16      LD  HL,(TXTTAB)
0006F7 46F7 22D4F2          16      LD  (_DTA),HL
0006FA 46FA EB               4      EX  DE,HL
0006FB 46FB 2100FF          10      LD  HL,-256
0006FE 46FE 39              11      ADD HL,SP
0006FF 46FF ED52            15      SBC HL,DE
000701 4701 CD434B          17      CALL    ROM_READ
000704 4704 ED5BD4F2        20      LD  DE,(_DTA)
000708 4708 19              11      ADD HL,DE
000709 4709 E5              11      PUSH    HL
00070A 470A 2A76F6          16      LD  HL,(TXTTAB)
       470D                     ROM_LOAD2:          ;リンクポインタをFIX
00070D 470D E5              11      PUSH    HL
00070E 470E DDE1            14      POP IX
000710 4710 7E               7      LD  A,(HL)      ;リンクポインタL
000711 4711 23               6      INC HL
000712 4712 B6               7      OR  (HL)        ;リンクポインタH
000713 4713 23               6      INC HL
000714 4714 2837            12      JR  Z,RLOAD_END0
000716 4716 23               6      INC HL      ;行番号
000717 4717 23               6      INC HL      ;行番号
       4718                     ROM_LOAD3:
000718 4718 7E               7      LD  A,(HL)
000719 4719 23               6      INC HL
00071A 471A FE0B             7      CP  00BH        ;8進数(&O)
00071C 471C 2822            12      JR  Z,INC_HL2
00071E 471E FE0C             7      CP  00CH        ;16進数(&H)
000720 4720 281E            12      JR  Z,INC_HL2
000722 4722 FE0D             7      CP  00DH        ;行番号(RUN後)
000724 4724 281A            12      JR  Z,INC_HL2
000726 4726 FE0E             7      CP  00EH        ;行番号(RUN前)
000728 4728 2816            12      JR  Z,INC_HL2
00072A 472A FE0F             7      CP  00FH        ;10～255の整数(%)
00072C 472C 2813            12      JR  Z,INC_HL1
00072E 472E FE1C             7      CP  01CH        ;256～65535の整数(%)
000730 4730 280E            12      JR  Z,INC_HL2
000732 4732 FE1D             7      CP  01DH        ;単精度実数(!)
000734 4734 2808            12      JR  Z,INC_HL4
000736 4736 FE1F             7      CP  01FH        ;倍制度実数(#)
000738 4738 2008            12      JR  NZ,INC_HL0
00073A 473A 23               6      INC HL
00073B 473B 23               6      INC HL
00073C 473C 23               6      INC HL
00073D 473D 23               6      INC HL
       473E                     INC_HL4:
00073E 473E 23               6      INC HL
00073F 473F 23               6      INC HL
       4740                     INC_HL2:
000740 4740 23               6      INC HL
       4741                     INC_HL1:
000741 4741 23               6      INC HL
       4742                     INC_HL0:
000742 4742 B7               4      OR  A
000743 4743 20D3            12      JR  NZ,ROM_LOAD3
000745 4745 DD7500          19      LD  (IX+0),L
000748 4748 DD7401          19      LD  (IX+1),H
00074B 474B 18C0            12      JR  ROM_LOAD2
       474D                     RLOAD_END0:
00074D 474D E1              10      POP HL
       474E                     RLOAD_END1:
00074E 474E 22C2F6          16      LD  (VARTAB),HL
000751 4751 22C4F6          16      LD  (ARYTAB),HL
000754 4754 22C6F6          16      LD  (STREND),HL
                                
000757 4757 3ABEFC          13      LD  A,(RUNBNF)
00075A 475A CD604D          17      CALL    CAP
00075D 475D FE52             7      CP  'R'
00075F 475F 280E            12      JR  Z,RLOAD_END2
000761 4761 AF               4      XOR A
000762 4762 21DCF2          10      LD  HL,_BUF+3
000765 4765 77               7      LD  (HL),A      ;3
000766 4766 2B               6      DEC HL
000767 4767 77               7      LD  (HL),A      ;2
000768 4768 2B               6      DEC HL
000769 4769 77               7      LD  (HL),A      ;1
00076A 476A 2B               6      DEC HL
00076B 476B 3E8F             7      LD  A,08FH      ;REM
00076D 476D 77               7      LD  (HL),A      ;0
00076E 476E C9              10      RET
       476F                     RLOAD_END2:
00076F 476F D5              11      PUSH    DE
000770 4770 ED5B76F6        20      LD  DE,(TXTTAB)
000774 4774 1B               6      DEC DE
000775 4775 AF               4      XOR A
000776 4776 21DFF2          10      LD  HL,_BUF+6
000779 4779 77               7      LD  (HL),A      ;6
00077A 477A 2B               6      DEC HL
00077B 477B 77               7      LD  (HL),A      ;5
00077C 477C 2B               6      DEC HL
00077D 477D 77               7      LD  (HL),A      ;4
00077E 477E 2B               6      DEC HL
00077F 477F 72               7      LD  (HL),D      ;3 行番号H
000780 4780 2B               6      DEC HL
000781 4781 73               7      LD  (HL),E      ;2 行番号L
000782 4782 2B               6      DEC HL
000783 4783 360D            10      LD  (HL),00DH   ;1 行番号(RUN後)
000785 4785 2B               6      DEC HL
000786 4786 3E89             7      LD  A,089H      ;GOTO
000788 4788 77               7      LD  (HL),A      ;0
000789 4789 D1              10      POP DE
00078A 478A C9              10      RET
                                
       478B                     ERROR_DIRECT_IN_FILE:
00078B 478B 1E39             7      LD  E,57            ;Direct statement in file
00078D 478D 01                      DB  1           ;LD BC,
       478E                     ERROR_DEVICE_IO_ERROR:
00078E 478E 1E13             7      LD  E,19            ;Device I/O error
000790 4790 01                      DB  1           ;LD BC,
       4791                     ERROR_INTERNAL_ERROR:
000791 4791 1E33             7      LD  E,51            ;Internal error
000793 4793 01                      DB  1           ;LD BC,
       4794                     ERROR_FILE_NOT_OPEN:
000794 4794 1E3B             7      LD  E,59            ;File not OPEN
000796 4796 01                      DB  1           ;LD BC,
       4797                     ERROR_FILE_NOT_FOUND:
000797 4797 1E35             7      LD  E,53            ;File not found
       4799                     ERROR:
000799 4799 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00079D 479D DD216F40        14      LD  IX,ERRHAND
0007A1 47A1 C31C00          10      JP  _CALSLT
                                
       47A4                     ROM_BLOAD:
0007A4 47A4 CDF148          17      CALL    INIT_PARAM
0007A7 47A7 CDE44B          17      CALL    FILE_B
0007AA 47AA CD764D          17      CALL    ROM_OPEN
0007AD 47AD 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
0007AF 47AF 21D9F2          10      LD  HL,_BUF
0007B2 47B2 22D4F2          16      LD  (_DTA),HL
0007B5 47B5 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
0007B8 47B8 CD434B          17      CALL    ROM_READ
0007BB 47BB 3AD9F2          13      LD  A,(_BUF)
0007BE 47BE FEFE             7      CP  0FEH
0007C0 47C0 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
0007C2 47C2 21A5F2          10      LD  HL,BLOAD_RET
0007C5 47C5 229DF2          16      LD  (SWC_BLOAD),HL
                                
0007C8 47C8 2AF4F2          16      LD  HL,(PARAM1)
0007CB 47CB 7E               7      LD  A,(HL)
0007CC 47CC FE2C             7      CP  ','
0007CE 47CE 2049            12      JR  NZ,RBREAD_MEM
0007D0 47D0 23               6      INC HL
0007D1 47D1 7E               7      LD  A,(HL)
0007D2 47D2 CD604D          17      CALL    CAP
0007D5 47D5 32BEFC          13      LD  (RUNBNF),A
0007D8 47D8 FE52             7      CP  'R'     ;R,Sスイッチじゃ無い場合はオフセット値として処理する
0007DA 47DA 2808            12      JR  Z,RBOS1
0007DC 47DC FE53             7      CP  'S'
0007DE 47DE 2804            12      JR  Z,RBOS1
0007E0 47E0 FE2C             7      CP  ','
0007E2 47E2 200D            12      JR  NZ,RBOS2
       47E4                     RBOS1:
0007E4 47E4 7E               7      LD  A,(HL)
0007E5 47E5 23               6      INC HL
0007E6 47E6 B7               4      OR  A
0007E7 47E7 2824            12      JR  Z,RBREAD_OSE
0007E9 47E9 FE3A             7      CP  ':'
0007EB 47EB 2820            12      JR  Z,RBREAD_OSE
0007ED 47ED FE2C             7      CP  ','     ;次のパラメータを探す
0007EF 47EF 20F3            12      JR  NZ,RBOS1
       47F1                     RBOS2:              ;オフセット
0007F1 47F1 22F4F2          16      LD  (PARAM1),HL
0007F4 47F4 7E               7      LD  A,(HL)
0007F5 47F5 B7               4      OR  A
0007F6 47F6 2815            12      JR  Z,RBREAD_OSE
0007F8 47F8 DD212F54        14      LD  IX,FRMQNT
0007FC 47FC FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000800 4800 CD1C00          17      CALL    _CALSLT
000803 4803 22F4F2          16      LD  (PARAM1),HL
000806 4806 2ADAF2          16      LD  HL,(_BUF_ST)
000809 4809 19              11      ADD HL,DE
00080A 480A 22DAF2          16      LD  (_BUF_ST),HL
       480D                     RBREAD_OSE:
00080D 480D 3ABEFC          13      LD  A,(RUNBNF)
000810 4810 FE53             7      CP  'S'
000812 4812 2005            12      JR  NZ,RBREAD_MEM
000814 4814 3E01             7      LD  A,1
000816 4816 32D6F2          13      LD  (FLG_LDIR),A
       4819                     RBREAD_MEM:
000819 4819 2ADAF2          16      LD  HL,(_BUF_ST)
00081C 481C 22BFFC          16      LD  (SAVENT),HL
00081F 481F 22D4F2          16      LD  (_DTA),HL
000822 4822 21FFFF          10      LD  HL,0FFFFH
000825 4825 CD434B          17      CALL    ROM_READ
000828 4828 AF               4      XOR A
000829 4829 32D6F2          13      LD  (FLG_LDIR),A
00082C 482C 3ABEFC          13      LD  A,(RUNBNF)
00082F 482F FE52             7      CP  'R'
000831 4831 2006            12      JR  NZ,RBREAD1
000833 4833 2ADEF2          16      LD  HL,(_BUF_EX)
000836 4836 229DF2          16      LD  (SWC_BLOAD),HL
       4839                     RBREAD1:
       4839                     ROM_NEXT:
000839 4839 2AF4F2          16      LD  HL,(PARAM1)
00083C 483C 7E               7      LD  A,(HL)
00083D 483D 2B               6      DEC HL
00083E 483E B7               4      OR  A
00083F 483F 2805            12      JR  Z,ROM_NEXT1
000841 4841 FE3A             7      CP  ':'
000843 4843 2801            12      JR  Z,ROM_NEXT1
000845 4845 23               6      INC HL
       4846                     ROM_NEXT1:
000846 4846 5D               4      LD  E,L
000847 4847 54               4      LD  D,H
                                
000848 4848 CD364D          17      CALL    SEARCH_END
00084B 484B B7               4      OR  A
00084C 484C 2821            12      JR  Z,REM
       484E                     RN3:                    ;マルチステートメントの処理
00084E 484E 7E               7      LD  A,(HL)
                                
00084F 484F FEB5             7      CP  0B5H            ;LOAD
000851 4851 CAC246          10      JP  Z,ROM_LOAD
000854 4854 FE8A             7      CP  08AH            ;RUN
000856 4856 281B            12      JR  Z,ROM_RUN
000858 4858 FEB7             7      CP  0B7H            ;FILES
00085A 485A 2825            12      JR  Z,ROM_FILES
00085C 485C FED6             7      CP  0D6H            ;COPY
00085E 485E CA2349          10      JP  Z,ROM_COPY
000861 4861 FE20             7      CP  020H
000863 4863 2807            12      JR  Z,RN_SP
                                
000865 4865 3E28             7      LD  A,028H          ;JR Z,
000867 4867 32A3F2          13      LD  (SWC_BLOAD_M),A
00086A 486A 7E               7      LD  A,(HL)
00086B 486B C9              10      RET
       486C                     RN_SP:
00086C 486C 23               6      INC HL
00086D 486D 18DF            12      JR  RN3
                                
       486F                     REM:
00086F 486F EB               4      EX  DE,HL
000870 4870 3E8F             7      LD  A,08FH          ;REM
000872 4872 C9              10      RET
                                
       4873                     ROM_RUN:
000873 4873 23               6      INC HL
000874 4874 7E               7      LD  A,(HL)
000875 4875 2B               6      DEC HL
000876 4876 B7               4      OR  A
000877 4877 C4C246          17      CALL    NZ,ROM_LOAD
00087A 487A FE8F             7      CP  08FH            ;REM
00087C 487C 3E8A             7      LD  A,08AH          ;RUN
00087E 487E C0              11      RET NZ
00087F 487F 77               7      LD  (HL),A
000880 4880 C9              10      RET
                                
       4881                     ROM_FILES:
000881 4881 CDF148          17      CALL    INIT_PARAM
000884 4884 CDE44B          17      CALL    FILE_B
000887 4887 CD7854          17      CALL    GET_DISK_BANK_FDRV
00088A 488A 3AC9F2          13      LD  A,(SECSZ_H)
00088D 488D CD3653          17      CALL    IS_BPB1
000890 4890 DA8E47          10      JP  C,ERROR_DEVICE_IO_ERROR
000893 4893 3AF9F2          13      LD  A,(FNAME)
000896 4896 FE21             7      CP  021H
000898 4898 3005            12      JR  NC,RFILES0
00089A 489A 060B             7      LD  B,11
00089C 489C CDCA4C          17      CALL    FILE10
       489F                     RFILES0:
00089F 489F CDD24F          17      CALL    GET_DIR_DAT
       48A2                     RFILES1:
0008A2 48A2 CD924D          17      CALL    FILESE
0008A5 48A5 3045            12      JR  NC,RFILES_NOT_MATCH
       48A7                     RFILES_DISP:
0008A7 48A7 E5              11      PUSH    HL
0008A8 48A8 110B00          10      LD  DE,0000BH   ;属性
0008AB 48AB 19              11      ADD HL,DE
                                #if exists USE_MORMAL32K_OR_ASCII16
0008AC 48AC CDC344          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
0008AF 48AF E1              10      POP HL
0008B0 48B0 CB4F             8      BIT 1,A     ;不可視属性
0008B2 48B2 2035            12      JR  NZ,RFILES_NEXT
0008B4 48B4 E5              11      PUSH    HL
0008B5 48B5 0608             7      LD  B,8
0008B7 48B7 CDB744          17      CALL    MSN
                                #if exists USE_MORMAL32K_OR_ASCII16
0008BA 48BA CDC344          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
0008BD 48BD FE20             7      CP  020H
0008BF 48BF F5              11      PUSH    AF
0008C0 48C0 3E2E             7      LD  A,'.'
0008C2 48C2 C4EE54          17      CALL    NZ,MSG_A
0008C5 48C5 0603             7      LD  B,3
0008C7 48C7 CDB744          17      CALL    MSN
0008CA 48CA F1              10      POP AF
0008CB 48CB CCEE54          17      CALL    Z,MSG_A
0008CE 48CE 3ADDF3          13      LD  A,(CSRX)
0008D1 48D1 47               4      LD  B,A
0008D2 48D2 3AB0F3          13      LD  A,(LINLEN)
0008D5 48D5 90               4      SUB B
0008D6 48D6 FE0C             7      CP  12
0008D8 48D8 3009            12      JR  NC,RFILES2
0008DA 48DA 3E0D             7      LD  A,00DH      ;改行
0008DC 48DC CDEE54          17      CALL    MSG_A
0008DF 48DF 3E0A             7      LD  A,00AH
0008E1 48E1 1802            12      JR  RFILES3
       48E3                     RFILES2:
0008E3 48E3 3E20             7      LD  A,020H
       48E5                     RFILES3:
0008E5 48E5 CDEE54          17      CALL    MSG_A
0008E8 48E8 E1              10      POP HL
       48E9                     RFILES_NEXT:
0008E9 48E9 CDB04D          17      CALL    FNEXT
       48EC                     RFILES_NOT_MATCH:
0008EC 48EC 20B4            12      JR  NZ,RFILES1
0008EE 48EE C33948          10      JP  ROM_NEXT
                                
       48F1                     INIT_PARAM:
0008F1 48F1 22F2F2          16      LD  (PARAM0),HL
0008F4 48F4 22F4F2          16      LD  (PARAM1),HL
0008F7 48F7 EB               4      EX  DE,HL
0008F8 48F8 32BEFC          13      LD  (RUNBNF),A
0008FB 48FB 3263F6          13      LD  (VALTYP),A
0008FE 48FE E5              11      PUSH    HL
0008FF 48FF 2AEBF2          16      LD  HL,(_CD)
000902 4902 22F6F2          16      LD  (_CDX),HL
000905 4905 E1              10      POP HL
000906 4906 13               6      INC DE
000907 4907 CD064D          17      CALL    SPCUT
00090A 490A 1A               7      LD  A,(DE)
00090B 490B B7               4      OR  A
00090C 490C C8              11      RET Z
00090D 490D FE3A             7      CP  ':'
00090F 490F C8              11      RET Z
000910 4910 FE28             7      CP  '('
000912 4912 C8              11      RET Z
000913 4913 EB               4      EX  DE,HL
000914 4914 DD21644C        14      LD  IX,FRMEVL
000918 4918 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00091C 491C CD1C00          17      CALL    _CALSLT
00091F 491F 22F4F2          16      LD  (PARAM1),HL
000922 4922 C9              10      RET
                                
       4923                     ROM_COPY:
000923 4923 CDF148          17      CALL    INIT_PARAM
000926 4926 3A63F6          13      LD  A,(VALTYP)
000929 4929 FE03             7      CP  3       ;string
00092B 492B C2DF4B          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
00092E 492E CDE44B          17      CALL    FILE_B
000931 4931 CD764D          17      CALL    ROM_OPEN
000934 4934 DA9747          10      JP  C,ERROR_FILE_NOT_FOUND
                                
000937 4937 21DEF2          10      LD  HL,_BUF_W
00093A 493A 22D4F2          16      LD  (_DTA),HL
00093D 493D 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
000940 4940 CD434B          17      CALL    ROM_READ
                                
000943 4943 AF               4      XOR A
000944 4944 32D9F2          13      LD  (_BUF_LO),A     ;PSET
000947 4947 32E6F2          13      LD  (_BUF_O),A      ;向き
                                
00094A 494A 2AF4F2          16      LD  HL,(PARAM1)
       494D                     RCP_PARAM1:
00094D 494D 7E               7      LD  A,(HL)
00094E 494E 23               6      INC HL
00094F 494F B7               4      OR  A
000950 4950 CA4648          10      JP  Z,ROM_NEXT1
000953 4953 FE3A             7      CP  ':'
000955 4955 CA4648          10      JP  Z,ROM_NEXT1
000958 4958 FE2C             7      CP  ','
00095A 495A 2012            12      JR  NZ,RCP_PARAM1_
                                
00095C 495C DD212F54        14      LD  IX,FRMQNT
000960 4960 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000964 4964 CD1C00          17      CALL    _CALSLT
000967 4967 7B               4      LD  A,E
000968 4968 87               4      ADD A,A
000969 4969 87               4      ADD A,A
00096A 496A 32E6F2          13      LD  (_BUF_O),A
00096D 496D 7E               7      LD  A,(HL)
       496E                     RCP_PARAM1_:
00096E 496E FE28             7      CP  '('
000970 4970 20DB            12      JR  NZ,RCP_PARAM1
000972 4972 DD212F54        14      LD  IX,FRMQNT
000976 4976 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00097A 497A CD1C00          17      CALL    _CALSLT
                                
00097D 497D ED53E2F2        20      LD  (_BUF_X),DE
                                
       4981                     RCP_PARAM2:
000981 4981 23               6      INC HL
000982 4982 7E               7      LD  A,(HL)
000983 4983 FE20             7      CP  020H
000985 4985 28FA            12      JR  Z,RCP_PARAM2
000987 4987 FE2C             7      CP  ','
000989 4989 28F6            12      JR  Z,RCP_PARAM2
                                
00098B 498B DD212F54        14      LD  IX,FRMQNT
00098F 498F FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000993 4993 CD1C00          17      CALL    _CALSLT
                                
000996 4996 3AF6FA          13      LD  A,(ACPAGE)
000999 4999 57               4      LD  D,A
00099A 499A ED53E4F2        20      LD  (_BUF_Y),DE
       499E                     RCP_PARAM3:
00099E 499E 23               6      INC HL
00099F 499F 7E               7      LD  A,(HL)
0009A0 49A0 FE20             7      CP  020H
0009A2 49A2 28FA            12      JR  Z,RCP_PARAM3
0009A4 49A4 FE29             7      CP  ')'
0009A6 49A6 28F6            12      JR  Z,RCP_PARAM3
0009A8 49A8 FE2C             7      CP  ','
0009AA 49AA 2033            12      JR  NZ,RCP_ST
                                
0009AC 49AC 23               6      INC HL
0009AD 49AD DD212F54        14      LD  IX,FRMQNT
0009B1 49B1 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009B5 49B5 CD1C00          17      CALL    _CALSLT
                                
0009B8 49B8 7B               4      LD  A,E
0009B9 49B9 32E5F2          13      LD  (_BUF_P),A
                                
       49BC                     RCP_PARAM4:
0009BC 49BC 7E               7      LD  A,(HL)
0009BD 49BD 23               6      INC HL
0009BE 49BE FE20             7      CP  020H
0009C0 49C0 28FA            12      JR  Z,RCP_PARAM4
                                
0009C2 49C2 FE2C             7      CP  ','
0009C4 49C4 2019            12      JR  NZ,RCP_ST
                                
0009C6 49C6 7E               7      LD  A,(HL)
0009C7 49C7 0604             7      LD  B,4
0009C9 49C9 FEC3             7      CP  0C3H        ;PRESET
0009CB 49CB 280E            12      JR  Z,RCP_LO
0009CD 49CD 05               4      DEC B       ;3
0009CE 49CE D6F8             7      SUB 0F8H        ;XOR
0009D0 49D0 2809            12      JR  Z,RCP_LO
0009D2 49D2 05               4      DEC B       ;2
0009D3 49D3 3C               4      INC A       ;OR
0009D4 49D4 2805            12      JR  Z,RCP_LO
0009D6 49D6 05               4      DEC B       ;1
0009D7 49D7 3C               4      INC A       ;AND
0009D8 49D8 2801            12      JR  Z,RCP_LO
0009DA 49DA 05               4      DEC B       ;0
                                                ;PSET
       49DB                     RCP_LO:
0009DB 49DB 78               4      LD  A,B
0009DC 49DC 32D9F2          13      LD  (_BUF_LO),A
       49DF                     RCP_ST:
0009DF 49DF 2AC6F6          16      LD  HL,(STREND)
0009E2 49E2 22D4F2          16      LD  (_DTA),HL
0009E5 49E5 EB               4      EX  DE,HL
0009E6 49E6 2100FE          10      LD  HL,-512
0009E9 49E9 39              11      ADD HL,SP
0009EA 49EA AF               4      XOR A
0009EB 49EB ED52            15      SBC HL,DE
0009ED 49ED 3008            12      JR  NC,RCP0
0009EF 49EF 215EF5          10      LD  HL,BUF
0009F2 49F2 22D4F2          16      LD  (_DTA),HL
0009F5 49F5 6F               4      LD  L,A ;0
0009F6 49F6 67               4      LD  H,A ;0
       49F7                     RCP0:
0009F7 49F7 24               4      INC H
0009F8 49F8 22DCF2          16      LD  (_BUF_EN),HL
       49FB                     RCP1:
0009FB 49FB F3               4      DI
0009FC 49FC CDD14A          17      CALL    WAIT_VDP
                                
0009FF 49FF 3A0700          13      LD  A,(WRVDP)
000A02 4A02 4F               4      LD  C,A
000A03 4A03 0C               4      INC C       ;C := PORT#1's address(WR)
000A04 4A04 3E24             7      LD  A,36
000A06 4A06 ED79            12      OUT (C),A
000A08 4A08 3E91             7      LD  A,080H+17
000A0A 4A0A ED79            12      OUT (C),A       ;R#17 := 36
                                
000A0C 4A0C 0C               4      INC C
000A0D 4A0D 0C               4      INC C       ;C := PORT#3's address(WR)
000A0E 4A0E 2AE2F2          16      LD  HL,(_BUF_X)
000A11 4A11 ED69            12      OUT (C),L       ;R#36 DX
000A13 4A13 ED61            12      OUT (C),H       ;R#37
000A15 4A15 2AE4F2          16      LD  HL,(_BUF_Y)
000A18 4A18 ED69            12      OUT (C),L       ;R#38 DY
000A1A 4A1A ED61            12      OUT (C),H       ;R#39
000A1C 4A1C 2ADEF2          16      LD  HL,(_BUF_W)
000A1F 4A1F ED69            12      OUT (C),L       ;R#40 NX
000A21 4A21 ED61            12      OUT (C),H       ;R#41
000A23 4A23 2AE0F2          16      LD  HL,(_BUF_H)
000A26 4A26 ED69            12      OUT (C),L       ;R#42 NY
000A28 4A28 ED61            12      OUT (C),H       ;R#43
                                
000A2A 4A2A DD2AAFFC        20      LD  IX,(SCRMOD)
000A2E 4A2E 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000A31 4A31 B7               4      OR  A
000A32 4A32 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000A34 4A34 DD7D             9      LD  A,IXL
000A36 4A36 FE08             7      CP  8
000A38 4A38 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
000A3A 4A3A FE06             7      CP  6
000A3C 4A3C 2AE2F2          16      LD  HL,(_BUF_X)
000A3F 4A3F 3ADEF2          13      LD  A,(_BUF_W)
000A42 4A42 2005            12      JR  NZ,SCR57
000A44 4A44 B5               4      OR  L       ;スクリーン6
000A45 4A45 E603             7      AND 3
000A47 4A47 200D            12      JR  NZ,USE_LMMC
       4A49                     SCR57:              ;スクリーン5,7
000A49 4A49 B5               4      OR  L
000A4A 4A4A E601             7      AND 1
000A4C 4A4C 2008            12      JR  NZ,USE_LMMC
       4A4E                     USE_HMMC:
000A4E 4A4E DD2E08          10      LD  IXL,8
       4A51                     USE_HMMC8:
000A51 4A51 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
000A53 4A53 32D9F2          13      LD  (_BUF_LO),A
       4A56                     USE_LMMC:
000A56 4A56 110000          10      LD  DE,0
000A59 4A59 06FF             7      LD  B,-1
000A5B 4A5B CDFC4A          17      CALL    GET_PIXEL
000A5E 4A5E ED79            12      OUT (C),A       ;R#44 first DATA
000A60 4A60 3AE6F2          13      LD  A,(_BUF_O)
000A63 4A63 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
000A65 4A65 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000A68 4A68 F6B0             7      OR  0B0H        ;R#46 LMMC command
000A6A 4A6A ED79            12      OUT (C),A
                                
000A6C 4A6C FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
000A6E 4A6E 0D               4      DEC C
000A6F 4A6F 0D               4      DEC C       ;C := PORT#1's address(WR)
000A70 4A70 3EAC             7      LD  A,080H+44
000A72 4A72 ED79            12      OUT (C),A
000A74 4A74 3E91             7      LD  A,080H+17
000A76 4A76 ED79            12      OUT (C),A       ;R#17 := 44
                                
000A78 4A78 3A0600          13      LD  A,(RDVDP)
000A7B 4A7B 3C               4      INC A
000A7C 4A7C FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
000A7E 4A7E 3E02             7      LD  A,2
000A80 4A80 ED79            12      OUT (C),A
000A82 4A82 3E8F             7      LD  A,08FH
000A84 4A84 ED79            12      OUT (C),A
000A86 4A86 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000A89 4A89 E640             7      AND 040H
000A8B 4A8B 201C            12      JR  NZ,LOOP_HMMC
       4A8D                     LOOP_COPY:
000A8D 4A8D CDFC4A          17      CALL    GET_PIXEL
000A90 4A90 08               4      EX  AF,AF'
000A91 4A91 FD4C             9      LD  C,IYH
       4A93                     LOOP_COPY1:
000A93 4A93 ED78            12      IN  A,(C)
000A95 4A95 0F               4      RRCA            ;RRCAではサインフラグは変化しない
000A96 4A96 300A            12      JR  NC,EXIT_COPY    ;check CE bit
000A98 4A98 F2934A          10      JP  P,LOOP_COPY1    ;check TR bit
000A9B 4A9B 08               4      EX  AF,AF'
000A9C 4A9C FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000A9E 4A9E ED79            12      OUT (C),A
000AA0 4AA0 18EB            12      JR  LOOP_COPY
                                
       4AA2                     EXIT_COPY:
000AA2 4AA2 CDD94A          17      CALL    GET_STATUS_0
000AA5 4AA5 FB               4      EI
000AA6 4AA6 C33948          10      JP  ROM_NEXT
                                
       4AA9                     LOOP_HMMC:
000AA9 4AA9 F3               4      DI          ;必要
000AAA 4AAA FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000AAC 4AAC 43               4      LD  B,E
000AAD 4AAD 7B               4      LD  A,E
000AAE 4AAE B7               4      OR  A
000AAF 4AAF 2802            12      JR  Z,LOOP_HMMC1
000AB1 4AB1 EDB3                    OTIR
       4AB3                     LOOP_HMMC1:
000AB3 4AB3 14               4      INC D
       4AB4                     LOOP_HMMC2:
000AB4 4AB4 15               4      DEC D
000AB5 4AB5 2805            12      JR  Z,LOOP_HMMC3
000AB7 4AB7 EDB3                    OTIR
000AB9 4AB9 C3B44A          10      JP  LOOP_HMMC2
       4ABC                     LOOP_HMMC3:
000ABC 4ABC ED78            12      IN  A,(C)
000ABE 4ABE 0F               4      RRCA
000ABF 4ABF 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
000AC1 4AC1 2ADCF2          16      LD  HL,(_BUF_EN)
000AC4 4AC4 CD434B          17      CALL    ROM_READ
000AC7 4AC7 EB               4      EX  DE,HL
000AC8 4AC8 2AD4F2          16      LD  HL,(_DTA)
000ACB 4ACB 7A               4      LD  A,D
000ACC 4ACC B3               4      OR  E
000ACD 4ACD 20DA            12      JR  NZ,LOOP_HMMC
000ACF 4ACF 18C2            12      JR  LOOP_COPY1
                                    
       4AD1                     WAIT_VDP:
000AD1 4AD1 3E02             7      LD  A,2
000AD3 4AD3 CDDA4A          17      CALL    GET_STATUS
000AD6 4AD6 0F               4      RRCA
000AD7 4AD7 38F8            12      JR  C,WAIT_VDP
       4AD9                     GET_STATUS_0:
000AD9 4AD9 AF               4      XOR A
       4ADA                     GET_STATUS:
000ADA 4ADA C5              11      PUSH    BC
000ADB 4ADB ED4B0600        20      LD  BC,(RDVDP)
000ADF 4ADF 0C               4      INC C
000AE0 4AE0 ED79            12      OUT (C),A
000AE2 4AE2 3E8F             7      LD  A,08FH
000AE4 4AE4 ED79            12      OUT (C),A
000AE6 4AE6 ED78            12      IN  A,(C)
000AE8 4AE8 C1              10      POP BC
000AE9 4AE9 C9              10      RET
                                
       4AEA                     GET_PIXEL256:
000AEA 4AEA 7A               4      LD  A,D
000AEB 4AEB B3               4      OR  E
000AEC 4AEC 200A            12      JR  NZ,GET_PIXEL1
000AEE 4AEE 2ADCF2          16      LD  HL,(_BUF_EN)
000AF1 4AF1 CD434B          17      CALL    ROM_READ
000AF4 4AF4 EB               4      EX  DE,HL
000AF5 4AF5 2AD4F2          16      LD  HL,(_DTA)
       4AF8                     GET_PIXEL1:
000AF8 4AF8 7E               7      LD  A,(HL)
000AF9 4AF9 23               6      INC HL
000AFA 4AFA 1B               6      DEC DE
000AFB 4AFB C9              10      RET
                                
       4AFC                     GET_PIXEL:
000AFC 4AFC DD7D             9      LD  A,IXL
000AFE 4AFE FE08             7      CP  8
000B00 4B00 28E8            12      JR  Z,GET_PIXEL256
000B02 4B02 04               4      INC B
000B03 4B03 FE06             7      CP  6
000B05 4B05 282E            12      JR  Z,GET_PIXEL4
                                
000B07 4B07 CB40             8      BIT 0,B
000B09 4B09 20ED            12      JR  NZ,GET_PIXEL1
                                
000B0B 4B0B 7A               4      LD  A,D
000B0C 4B0C B3               4      OR  E
000B0D 4B0D 200A            12      JR  NZ,GET_PIXEL2
                                
000B0F 4B0F 2ADCF2          16      LD  HL,(_BUF_EN)
000B12 4B12 CD434B          17      CALL    ROM_READ
000B15 4B15 EB               4      EX  DE,HL
000B16 4B16 2AD4F2          16      LD  HL,(_DTA)
                                
       4B19                     GET_PIXEL2:
000B19 4B19 7E               7      LD  A,(HL)
000B1A 4B1A 0F               4      RRCA
000B1B 4B1B 0F               4      RRCA
000B1C 4B1C 0F               4      RRCA
000B1D 4B1D 0F               4      RRCA
000B1E 4B1E C9              10      RET
                                
       4B1F                     GET_PIXEL3:
000B1F 4B1F 7A               4      LD  A,D
000B20 4B20 B3               4      OR  E
000B21 4B21 200A            12      JR  NZ,GET_PIXEL5
                                
000B23 4B23 2ADCF2          16      LD  HL,(_BUF_EN)
000B26 4B26 CD434B          17      CALL    ROM_READ
000B29 4B29 EB               4      EX  DE,HL
000B2A 4B2A 2AD4F2          16      LD  HL,(_DTA)
       4B2D                     GET_PIXEL5:
000B2D 4B2D 7E               7      LD  A,(HL)
000B2E 4B2E 0F               4      RRCA
000B2F 4B2F 0F               4      RRCA
000B30 4B30 0F               4      RRCA
000B31 4B31 0F               4      RRCA
000B32 4B32 0F               4      RRCA
000B33 4B33 0F               4      RRCA
000B34 4B34 C9              10      RET
                                
       4B35                     GET_PIXEL4:
000B35 4B35 78               4      LD  A,B
000B36 4B36 E603             7      AND 3   ;+0
000B38 4B38 28E5            12      JR  Z,GET_PIXEL3
000B3A 4B3A 3D               4      DEC A   ;+1
000B3B 4B3B 28DC            12      JR  Z,GET_PIXEL2
000B3D 4B3D 3D               4      DEC A   ;+2
000B3E 4B3E 7E               7      LD  A,(HL)
000B3F 4B3F C0              11      RET NZ
000B40 4B40 0F               4      RRCA        ;+3
000B41 4B41 0F               4      RRCA
000B42 4B42 C9              10      RET
                                
       4B43                     ROM_READ:
000B43 4B43 E5              11      PUSH    HL
000B44 4B44 D5              11      PUSH    DE
000B45 4B45 C5              11      PUSH    BC
000B46 4B46 FDE5            15      PUSH    IY
000B48 4B48 22F0F2          16      LD  (LEFTX),HL
000B4B 4B4B 2AD4F2          16      LD  HL,(_DTA)
000B4E 4B4E 22E7F2          16      LD  (DTAX),HL
000B51 4B51 2AF0F2          16      LD  HL,(LEFTX)
                                
000B54 4B54 CDF74D          17      CALL    RBX1
000B57 4B57 3870            12      JR  C,RBRERR1
000B59 4B59 79               4      LD  A,C
000B5A 4B5A EB               4      EX  DE,HL
000B5B 4B5B ED52            15      SBC HL,DE       ;CP 0HL,CDE
000B5D 4B5D 19              11      ADD HL,DE
000B5E 4B5E DE00             7      SBC A,000H
000B60 4B60 3801            12      JR  C,RBR1
000B62 4B62 EB               4      EX  DE,HL
       4B63                     RBR1:
000B63 4B63 9F               4      SBC A,A
000B64 4B64 E601             7      AND 1
000B66 4B66 32C3F2          13      LD  (_RESULT),A
000B69 4B69 7C               4      LD  A,H
000B6A 4B6A B5               4      OR  L
000B6B 4B6B CABF4B          10      JP  Z,RBREND0
                                
000B6E 4B6E 22D0F2          16      LD  (_LEFT),HL  ;Read record byte
000B71 4B71 22F0F2          16      LD  (LEFTX),HL
                                
000B74 4B74 CD2A4E          17      CALL    RBX2
000B77 4B77 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000B79 4B79 CD3D4E          17      CALL    RBXA
000B7C 4B7C DAD54B          10      JP  C,RBRERR
000B7F 4B7F C5              11      PUSH    BC
000B80 4B80 CD1945          17      CALL    ROM_LDIR
000B83 4B83 ED53E7F2        20      LD  (DTAX),DE
000B87 4B87 2AF0F2          16      LD  HL,(LEFTX)
000B8A 4B8A D1              10      POP DE
000B8B 4B8B A7               4      AND A
000B8C 4B8C ED52            15      SBC HL,DE
000B8E 4B8E 22F0F2          16      LD  (LEFTX),HL
000B91 4B91 2829            12      JR  Z,RBREND
                                
       4B93                     RBRB:
000B93 4B93 CD764E          17      CALL    RBXB
000B96 4B96 2818            12      JR  Z,RBRC
       4B98                     RBRB1:
000B98 4B98 C5              11      PUSH    BC
000B99 4B99 D5              11      PUSH    DE
000B9A 4B9A CD274F          17      CALL    CLUST
000B9D 4B9D EB               4      EX  DE,HL
000B9E 4B9E ED4BC6F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000BA2 4BA2 CD1945          17      CALL    ROM_LDIR
000BA5 4BA5 EB               4      EX  DE,HL
000BA6 4BA6 D1              10      POP DE
000BA7 4BA7 C1              10      POP BC
000BA8 4BA8 CD044F          17      CALL    GNCL
000BAB 4BAB DAD54B          10      JP  C,RBRERR
000BAE 4BAE 10E8            13      DJNZ    RBRB1
       4BB0                     RBRC:
000BB0 4BB0 CD8E4E          17      CALL    RBXC
000BB3 4BB3 2807            12      JR  Z,RBREND
                                
000BB5 4BB5 CD274F          17      CALL    CLUST
000BB8 4BB8 EB               4      EX  DE,HL
000BB9 4BB9 CD1945          17      CALL    ROM_LDIR
       4BBC                     RBREND:
000BBC 4BBC CD9A4E          17      CALL    RBXEND
       4BBF                     RBREND0:
000BBF 4BBF FDE1            14      POP IY
000BC1 4BC1 C1              10      POP BC
000BC2 4BC2 D1              10      POP DE
000BC3 4BC3 F1              10      POP AF  ;(HL)
000BC4 4BC4 AF               4      XOR A
000BC5 4BC5 3AC3F2          13      LD  A,(_RESULT)
000BC8 4BC8 C9              10      RET
                                
       4BC9                     RBRERR1:
000BC9 4BC9 3E01             7      LD  A,001H
       4BCB                     RBRERR2:
000BCB 4BCB FDE1            14      POP IY
000BCD 4BCD C1              10      POP BC
000BCE 4BCE D1              10      POP DE
000BCF 4BCF E1              10      POP HL
000BD0 4BD0 37               4      SCF
000BD1 4BD1 210000          10      LD  HL,0
000BD4 4BD4 C9              10      RET
       4BD5                     RBRERR:
000BD5 4BD5 3EFF             7      LD  A,0FFH
000BD7 4BD7 18F2            12      JR  RBRERR2
                                
       4BD9                     FILE_DD:
000BD9 4BD9 E1              10      POP HL
000BDA 4BDA 3E                      DB  03EH
000BDB 4BDB C9              10      RET
000BDC 4BDC 32A3F2          13      LD  (SWC_BLOAD_M),A
       4BDF                     ROM_ORG:
000BDF 4BDF 2AF2F2          16      LD  HL,(PARAM0)
000BE2 4BE2 7E               7      LD  A,(HL)
000BE3 4BE3 C9              10      RET
       4BE4                     FILE_B:
000BE4 4BE4 AF               4      XOR A
000BE5 4BE5 32F8F2          13      LD  (FDRV),A
000BE8 4BE8 1E00             7      LD  E,0
000BEA 4BEA 3A63F6          13      LD  A,(VALTYP)
000BED 4BED FE03             7      CP  3       ;string
000BEF 4BEF C2874C          10      JP  NZ,FILED
                                
000BF2 4BF2 DD21D067        14      LD  IX,FRESTR
000BF6 4BF6 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000BFA 4BFA CD1C00          17      CALL    _CALSLT
000BFD 4BFD E5              11      PUSH    HL
000BFE 4BFE DDE1            14      POP IX
                                
000C00 4C00 DD5E00          19      LD  E,(IX+0)
000C03 4C03 DD7E01          19      LD  A,(IX+1)
000C06 4C06 DD5602          19      LD  D,(IX+2)
000C09 4C09 DD62             9      LD  IXH,D
000C0B 4C0B DD6F             9      LD  IXL,A
000C0D 4C0D 7B               4      LD  A,E
       4C0E                     FILE_BDOS:
000C0E 4C0E FE04             7      CP  4
000C10 4C10 3808            12      JR  C,FILEB1
000C12 4C12 DD7E03          19      LD  A,(IX+3)
000C15 4C15 FE3A             7      CP  ':'
000C17 4C17 28C0            12      JR  Z,FILE_DD
000C19 4C19 7B               4      LD  A,E
       4C1A                     FILEB1:
000C1A 4C1A FE02             7      CP  2
000C1C 4C1C 3818            12      JR  C,DEVI1
000C1E 4C1E DD7E01          19      LD  A,(IX+1)
000C21 4C21 FE3A             7      CP  ':'
000C23 4C23 2011            12      JR  NZ,DEVI1
000C25 4C25 DD7E00          19      LD  A,(IX+0)        ;DRIVE
000C28 4C28 CD604D          17      CALL    CAP
000C2B 4C2B D640             7      SUB '@'
000C2D 4C2D DD23            10      INC IX
000C2F 4C2F DD23            10      INC IX
000C31 4C31 1D               4      DEC E
000C32 4C32 1D               4      DEC E
000C33 4C33 32F8F2          13      LD  (FDRV),A
       4C36                     DEVI1:
000C36 4C36 DD7E00          19      LD  A,(IX+0)
000C39 4C39 D65C             7      SUB 05CH        ;\
000C3B 4C3B 2008            12      JR  NZ,NOROOT
000C3D 4C3D 6F               4      LD  L,A
000C3E 4C3E 67               4      LD  H,A
000C3F 4C3F 22F6F2          16      LD  (_CDX),HL
000C42 4C42 DD23            10      INC IX
000C44 4C44 1D               4      DEC E
       4C45                     NOROOT:
                                
       4C45                     SETDIR:
000C45 4C45 CD874C          17      CALL    FILED
000C48 4C48 DD7E00          19      LD  A,(IX+0)
000C4B 4C4B FE5C             7      CP  05CH        ;\
000C4D 4C4D C0              11      RET NZ
000C4E 4C4E DD23            10      INC IX
000C50 4C50 1D               4      DEC E
000C51 4C51 3AF9F2          13      LD  A,(FNAME)
000C54 4C54 FE20             7      CP  020H        ;. の処理
000C56 4C56 28ED            12      JR  Z,SETDIR
                                
000C58 4C58 CD764D          17      CALL    ROM_OPEN
000C5B 4C5B B7               4      OR  A
000C5C 4C5C C0              11      RET NZ
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
000C5D 4C5D D5              11      PUSH    DE
000C5E 4C5E 2AEDF2          16      LD  HL,(DIRENT1)
000C61 4C61 110B00          10      LD  DE,0000BH   ;属性(アトリビュート)
000C64 4C64 19              11      ADD HL,DE
000C65 4C65 CDC344          17      CALL    RDSLT_ROM
000C68 4C68 D1              10      POP DE
000C69 4C69 CB67             8      BIT 4,A     ;ディレクトリ
                                #else
                                    LD  IY,(DIRENT1)
                                    BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000C6B 4C6B C8              11      RET Z
000C6C 4C6C CDCE4C          17      CALL    FILEI
                                #if exists USE_MORMAL32K_OR_ASCII16
000C6F 4C6F D5              11      PUSH    DE
000C70 4C70 2AEDF2          16      LD  HL,(DIRENT1)
000C73 4C73 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000C76 4C76 19              11      ADD HL,DE
000C77 4C77 CDC344          17      CALL    RDSLT_ROM
000C7A 4C7A 23               6      INC HL
000C7B 4C7B 5F               4      LD  E,A
000C7C 4C7C CDC344          17      CALL    RDSLT_ROM
000C7F 4C7F 57               4      LD  D,A
000C80 4C80 EB               4      EX  DE,HL
000C81 4C81 D1              10      POP DE
                                #else
                                    LD  L,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  H,(IY+01BH)
                                #endif
000C82 4C82 22F6F2          16      LD  (_CDX),HL
000C85 4C85 18BE            12      JR  SETDIR
                                
       4C87                     FILED:
000C87 4C87 CDCE4C          17      CALL    FILEI
000C8A 4C8A 21F9F2          10      LD  HL,FNAME
                                
000C8D 4C8D 0608             7      LD  B,8
       4C8F                     FILE2:
000C8F 4C8F CDDB4C          17      CALL    CCHKF
000C92 4C92 C8              11      RET Z
000C93 4C93 FE2A             7      CP  '*'
000C95 4C95 282E            12      JR  Z,FILE9
000C97 4C97 FE2E             7      CP  '.'
000C99 4C99 280C            12      JR  Z,FILE4
000C9B 4C9B 77               7      LD  (HL),A
000C9C 4C9C 23               6      INC HL
000C9D 4C9D 10F0            13      DJNZ    FILE2
                                
       4C9F                     FILE3:
000C9F 4C9F CDDB4C          17      CALL    CCHKF
000CA2 4CA2 C8              11      RET Z
000CA3 4CA3 FE2E             7      CP  '.'
000CA5 4CA5 20F8            12      JR  NZ,FILE3
                                
       4CA7                     FILE4:
000CA7 4CA7 2101F3          10      LD  HL,FNAME+8
000CAA 4CAA 0603             7      LD  B,3
                                
       4CAC                     FILE4L:
000CAC 4CAC CDDB4C          17      CALL    CCHKF
000CAF 4CAF C8              11      RET Z
000CB0 4CB0 FE2E             7      CP  '.'
000CB2 4CB2 2008            12      JR  NZ,FILE12
000CB4 4CB4 32F9F2          13      LD  (FNAME),A   ;Parent directory(..)
000CB7 4CB7 32FAF2          13      LD  (FNAME+1),A
000CBA 4CBA 3E20             7      LD  A,020H
       4CBC                     FILE12:
000CBC 4CBC FE2A             7      CP  '*'
000CBE 4CBE 280A            12      JR  Z,FILE10
000CC0 4CC0 77               7      LD  (HL),A
000CC1 4CC1 23               6      INC HL
000CC2 4CC2 10E8            13      DJNZ    FILE4L
000CC4 4CC4 C9              10      RET
                                
       4CC5                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000CC5 4CC5 CDCA4C          17      CALL    FILE10
000CC8 4CC8 18D5            12      JR  FILE3
                                
       4CCA                     FILE10:
000CCA 4CCA 3E3F             7      LD  A,'?'
000CCC 4CCC 1808            12      JR  FILL_MEMORY
       4CCE                     FILEI:              ;名前＋拡張子をスペースで初期化
000CCE 4CCE 3E20             7      LD  A,020H
000CD0 4CD0 01000B          10      LD  BC,11*256   ;C=0にしておく
000CD3 4CD3 21F9F2          10      LD  HL,FNAME
       4CD6                     FILL_MEMORY:            ;HLからBバイトAで埋める
000CD6 4CD6 77               7      LD  (HL),A
000CD7 4CD7 23               6      INC HL
000CD8 4CD8 10FC            13      DJNZ    FILL_MEMORY
000CDA 4CDA C9              10      RET
                                
       4CDB                     CCHKF:
000CDB 4CDB 7B               4      LD  A,E
000CDC 4CDC B7               4      OR  A
000CDD 4CDD C8              11      RET Z
000CDE 4CDE DD7E00          19      LD  A,(IX+0)
000CE1 4CE1 CDE84C          17      CALL    CCHK2
000CE4 4CE4 C8              11      RET Z
000CE5 4CE5 C34B4D          10      JP  FKAN
                                
       4CE8                     CCHK2:
000CE8 4CE8 0C               4      INC C
000CE9 4CE9 0D               4      DEC C
000CEA 4CEA C0              11      RET NZ
       4CEB                     CCHK3:              ;ZF=1 で使えない文字
000CEB 4CEB FE2B             7      CP  '+'
000CED 4CED C8              11      RET Z
000CEE 4CEE FE2C             7      CP  ','
000CF0 4CF0 C8              11      RET Z
000CF1 4CF1 FE2F             7      CP  '/'
000CF3 4CF3 C8              11      RET Z
000CF4 4CF4 FE3A             7      CP  ':'
000CF6 4CF6 C8              11      RET Z
000CF7 4CF7 FE3B             7      CP  ';'
000CF9 4CF9 C8              11      RET Z
000CFA 4CFA FE3D             7      CP  '='
000CFC 4CFC C8              11      RET Z
000CFD 4CFD FE5C             7      CP  05CH    ;\
000CFF 4CFF C8              11      RET Z
000D00 4D00 FE1F             7      CP  01FH
000D02 4D02 D0              11      RET NC
000D03 4D03 BF               4      CP  A       ;Z=1
000D04 4D04 C9              10      RET
                                
       4D05                     SS1:
000D05 4D05 13               6      INC DE
       4D06                     SPCUT:              ;スペースをカット
000D06 4D06 1A               7      LD  A,(DE)
000D07 4D07 FE20             7      CP  020H
000D09 4D09 28FA            12      JR  Z,SS1
000D0B 4D0B C9              10      RET
                                
       4D0C                     SCREOF1:
000D0C 4D0C 13               6      INC DE
       4D0D                     SPCUTEX:            ;スペース改行などをカット
000D0D 4D0D 1A               7      LD  A,(DE)
000D0E 4D0E FE20             7      CP  020H
000D10 4D10 28FA            12      JR  Z,SCREOF1
000D12 4D12 FE0D             7      CP  00DH
000D14 4D14 28F6            12      JR  Z,SCREOF1
000D16 4D16 FE0A             7      CP  00AH
000D18 4D18 28F2            12      JR  Z,SCREOF1
000D1A 4D1A FE1A             7      CP  01AH
000D1C 4D1C 28EE            12      JR  Z,SCREOF1
000D1E 4D1E C9              10      RET
                                
       4D1F                     GETNUM:
000D1F 4D1F 210000          10      LD  HL,0
       4D22                     GETNUM1:
000D22 4D22 1A               7      LD  A,(DE)
000D23 4D23 13               6      INC DE
000D24 4D24 D630             7      SUB '0'
000D26 4D26 D8              11      RET C
000D27 4D27 FE0A             7      CP  10
000D29 4D29 D0              11      RET NC
000D2A 4D2A 4D               4      LD  C,L
000D2B 4D2B 44               4      LD  B,H
000D2C 4D2C 29              11      ADD HL,HL   ;*2
000D2D 4D2D 29              11      ADD HL,HL   ;*4
000D2E 4D2E 09              11      ADD HL,BC   ;*5
000D2F 4D2F 29              11      ADD HL,HL   ;*10
000D30 4D30 4F               4      LD  C,A
000D31 4D31 0600             7      LD  B,0
000D33 4D33 09              11      ADD HL,BC
000D34 4D34 18EC            12      JR  GETNUM1
                                
       4D36                     SEARCH_END:
000D36 4D36 7E               7      LD  A,(HL)
       4D37                     SEARCH_END1:
000D37 4D37 23               6      INC HL
000D38 4D38 B7               4      OR  A
000D39 4D39 C8              11      RET Z
000D3A 4D3A FE3A             7      CP  ':'
000D3C 4D3C 20F8            12      JR  NZ,SEARCH_END
000D3E 4D3E 7E               7      LD  A,(HL)
000D3F 4D3F FE3A             7      CP  ':'
000D41 4D41 28F4            12      JR  Z,SEARCH_END1
000D43 4D43 C9              10      RET
                                
       4D44                     FKANC:
000D44 4D44 CB41             8      BIT 0,C
000D46 4D46 CC694D          17      CALL    Z,CAP2
000D49 4D49 1803            12      JR  FKANX
       4D4B                     FKAN:           ;漢字チェック
000D4B 4D4B DD23            10      INC IX
000D4D 4D4D 1D               4      DEC E
       4D4E                     FKANX:
000D4E 4D4E CB41             8      BIT 0,C
000D50 4D50 CB81             8      RES 0,C
000D52 4D52 C0              11      RET NZ
000D53 4D53 FE80             7      CP  080H
000D55 4D55 D8              11      RET C
000D56 4D56 FEA0             7      CP  0A0H
000D58 4D58 3803            12      JR  C,FKAN1
000D5A 4D5A FEE0             7      CP  0E0H
000D5C 4D5C D8              11      RET C
       4D5D                     FKAN1:
000D5D 4D5D 0C               4      INC C
000D5E 4D5E A7               4      AND A
000D5F 4D5F C9              10      RET
                                
       4D60                     CAP:
000D60 4D60 FE61             7      CP  'a'
000D62 4D62 D8              11      RET C
000D63 4D63 FE7B             7      CP  'z'+1
000D65 4D65 D0              11      RET NC
000D66 4D66 D620             7      SUB 020H
000D68 4D68 C9              10      RET
       4D69                     CAP2:
000D69 4D69 CD604D          17      CALL    CAP
       4D6C                     CAP3:               ;
000D6C 4D6C FE05             7      CP  5
000D6E 4D6E 2803            12      JR  Z,CAP4
000D70 4D70 FE21             7      CP  021H
000D72 4D72 C9              10      RET
       4D73                     CAP4:
000D73 4D73 3EE5             7      LD  A,0E5H
000D75 4D75 C9              10      RET
                                
       4D76                     ROM_OPEN:
000D76 4D76 CD7854          17      CALL    GET_DISK_BANK_FDRV
                                
000D79 4D79 CDD24F          17      CALL    GET_DIR_DAT
000D7C 4D7C D5              11      PUSH    DE
000D7D 4D7D CD924D          17      CALL    FILESE
000D80 4D80 D1              10      POP DE
000D81 4D81 3F               4      CCF
000D82 4D82 D8              11      RET C
000D83 4D83 22EDF2          16      LD  (DIRENT1),HL
000D86 4D86 E5              11      PUSH    HL
000D87 4D87 210000          10      LD  HL,0
000D8A 4D8A 22CAF2          16      LD  (RR_LOW),HL
000D8D 4D8D 22CCF2          16      LD  (RR_HIGH),HL
000D90 4D90 E1              10      POP HL
000D91 4D91 C9              10      RET
                                
       4D92                     FILESE:
       4D92                     FILESE0:
                                #if exists USE_MORMAL32K_OR_ASCII16
000D92 4D92 CDC344          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000D95 4D95 B7               4      OR  A
000D96 4D96 C8              11      RET Z       ;END:ZF=1 CF=0
000D97 4D97 FEE5             7      CP  0E5H
000D99 4D99 280D            12      JR  Z,FILESE1
000D9B 4D9B 11F9F2          10      LD  DE,FNAME
000D9E 4D9E E5              11      PUSH    HL
000D9F 4D9F CDCE4D          17      CALL    CPFILE
000DA2 4DA2 CCF14D          17      CALL    Z,CPFILE2
000DA5 4DA5 E1              10      POP HL
000DA6 4DA6 37               4      SCF
000DA7 4DA7 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4DA8                     FILESE1:
000DA8 4DA8 CDB04D          17      CALL    FNEXT
000DAB 4DAB 20E5            12      JR  NZ,FILESE0
000DAD 4DAD F6FF             7      OR  0FFH        ;ZF=0 CF=0
000DAF 4DAF C9              10      RET
                                
       4DB0                     FNEXT:
000DB0 4DB0 112000          10      LD  DE,020H
000DB3 4DB3 19              11      ADD HL,DE
000DB4 4DB4 ED5BF6F2        20      LD  DE,(_CDX)
000DB8 4DB8 7A               4      LD  A,D
000DB9 4DB9 B3               4      OR  E
000DBA 4DBA 2002            12      JR  NZ,FNEXT_SUBDIR
000DBC 4DBC 0D               4      DEC C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
                                    PUSH    AF      ;※フラグを保存する必要あり
                                    BIT 7,H
                                    JR  Z,CHECK_DIR_PAGE1
                                    LD  A,H
                                    SUB 020H
                                    LD  H,A
                                    LD  A,(_DIR_BANK)
                                    INC A
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_DIR_BANK),A
                                CHECK_DIR_PAGE1:
                                    POP AF
                                #endif
000DBD 4DBD C9              10      RET
                                
       4DBE                     FNEXT_SUBDIR:           ;サブディレクトリ
000DBE 4DBE 0D               4      DEC C
000DBF 4DBF C0              11      RET NZ
                                
000DC0 4DC0 ED5BF6F2        20      LD  DE,(_CDX)
000DC4 4DC4 CD044F          17      CALL    GNCL
000DC7 4DC7 EB               4      EX  DE,HL
000DC8 4DC8 22F6F2          16      LD  (_CDX),HL
000DCB 4DCB C30B50          10      JP  GET_SUBDIR
                                
       4DCE                     CPFILE:
000DCE 4DCE C5              11      PUSH    BC
000DCF 4DCF 01000B          10      LD  BC,00B00H
       4DD2                     CPSTR1:
000DD2 4DD2 1A               7      LD  A,(DE)
000DD3 4DD3 FE3F             7      CP  '?'     ;Wild card
000DD5 4DD5 2814            12      JR  Z,CPSTR2
                                #if exists USE_MORMAL32K_OR_ASCII16
000DD7 4DD7 CDC344          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000DDA 4DDA CD444D          17      CALL    FKANC
000DDD 4DDD E5              11      PUSH    HL
000DDE 4DDE 67               4      LD  H,A
000DDF 4DDF 1A               7      LD  A,(DE)
000DE0 4DE0 CB01             8      RLC C
000DE2 4DE2 CD444D          17      CALL    FKANC
000DE5 4DE5 CB09             8      RRC C
000DE7 4DE7 BC               4      CP  H       ;CP (HL),(DE)
000DE8 4DE8 E1              10      POP HL
000DE9 4DE9 2004            12      JR  NZ,CPSTR3
       4DEB                     CPSTR2:
000DEB 4DEB 13               6      INC DE
000DEC 4DEC 23               6      INC HL
000DED 4DED 10E3            13      DJNZ    CPSTR1
       4DEF                     CPSTR3:
000DEF 4DEF C1              10      POP BC
000DF0 4DF0 C9              10      RET
                                
       4DF1                     CPFILE2:
                                #if exists USE_MORMAL32K_OR_ASCII16
000DF1 4DF1 CDC344          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000DF4 4DF4 E608             7      AND 008H    ;~0F7H
000DF6 4DF6 C9              10      RET
                                
       4DF7                     RBX1:
000DF7 4DF7 E5              11      PUSH    HL      ;Record byte
                                
000DF8 4DF8 ED5BCAF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000DFC 4DFC 3ACDF2          13      LD  A,(RR_HIGH+1)
000DFF 4DFF 4F               4      LD  C,A
                                
000E00 4E00 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
000E03 4E03 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
000E06 4E06 D5              11      PUSH    DE
000E07 4E07 2AEDF2          16      LD  HL,(DIRENT1)
000E0A 4E0A 111C00          10      LD  DE,0001CH
000E0D 4E0D 19              11      ADD HL,DE
000E0E 4E0E CDC344          17      CALL    RDSLT_ROM
000E11 4E11 23               6      INC HL
000E12 4E12 5F               4      LD  E,A
000E13 4E13 CDC344          17      CALL    RDSLT_ROM
000E16 4E16 23               6      INC HL
000E17 4E17 57               4      LD  D,A
000E18 4E18 CDC344          17      CALL    RDSLT_ROM
000E1B 4E1B EB               4      EX  DE,HL       ;AHL=File size
000E1C 4E1C D1              10      POP DE
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  L,(IY+01CH) ;AHL=File size
                                    LD  H,(IY+01DH)
                                    LD  A,(IY+01EH)
                                #endif
                                
000E1D 4E1D A7               4      AND A
000E1E 4E1E ED52            15      SBC HL,DE
000E20 4E20 99               4      SBC A,C
000E21 4E21 D1              10      POP DE
                                
000E22 4E22 D8              11      RET C
000E23 4E23 4F               4      LD  C,A
000E24 4E24 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000E25 4E25 B2               4      OR  D
000E26 4E26 B3               4      OR  E
000E27 4E27 C0              11      RET NZ
000E28 4E28 37               4      SCF
000E29 4E29 C9              10      RET
                                
       4E2A                     RBX2:
000E2A 4E2A ED4BCBF2        20      LD  BC,(RR_LOW+1)
000E2E 4E2E CDAF4E          17      CALL    RWXR
000E31 4E31 3AC7F2          13      LD  A,(CLSZ_H)
000E34 4E34 3D               4      DEC A
000E35 4E35 E5              11      PUSH    HL
000E36 4E36 2ACAF2          16      LD  HL,(RR_LOW)
000E39 4E39 A4               4      AND H
000E3A 4E3A B5               4      OR  L
000E3B 4E3B E1              10      POP HL
000E3C 4E3C C9              10      RET
                                
       4E3D                     RBXA:
000E3D 4E3D D5              11      PUSH    DE
000E3E 4E3E CD274F          17      CALL    CLUST
000E41 4E41 ED53D2F2        20      LD  (_DTPS),DE
000E45 4E45 D1              10      POP DE
000E46 4E46 CD044F          17      CALL    GNCL
000E49 4E49 D8              11      RET C
000E4A 4E4A ED53CEF2        20      LD  (_CLPS),DE
                                
000E4E 4E4E ED4BCAF2        20      LD  BC,(RR_LOW)
000E52 4E52 2AC6F2          16      LD  HL,(CLSZ)
000E55 4E55 7C               4      LD  A,H
000E56 4E56 3D               4      DEC A
000E57 4E57 A0               4      AND B
000E58 4E58 47               4      LD  B,A
000E59 4E59 ED42            15      SBC HL,BC       ;remaining cluster
                                
000E5B 4E5B ED5BF0F2        20      LD  DE,(LEFTX)
000E5F 4E5F ED52            15      SBC HL,DE       ;CP HL,DE
000E61 4E61 19              11      ADD HL,DE
000E62 4E62 3801            12      JR  C,RBXA1
000E64 4E64 EB               4      EX  DE,HL
       4E65                     RBXA1:
000E65 4E65 3AC4F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_MORMAL32K_OR_ASCII16
000E68 4E68 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000E6B 4E6B E5              11      PUSH    HL
000E6C 4E6C 2AD2F2          16      LD  HL,(_DTPS)
000E6F 4E6F 09              11      ADD HL,BC
000E70 4E70 ED5BE7F2        20      LD  DE,(DTAX)
000E74 4E74 C1              10      POP BC
000E75 4E75 C9              10      RET
                                
       4E76                     RBXB:
000E76 4E76 2AE7F2          16      LD  HL,(DTAX)
000E79 4E79 ED5BCEF2        20      LD  DE,(_CLPS)
000E7D 4E7D 3AF1F2          13      LD  A,(LEFTX+1)
000E80 4E80 47               4      LD  B,A
000E81 4E81 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4E84                     RBXB1:
000E84 4E84 1F               4      RRA     ;->CF
000E85 4E85 3804            12      JR  C,RBXB2
000E87 4E87 CB38             8      SRL B   ;B=B/2
000E89 4E89 18F9            12      JR  RBXB1
       4E8B                     RBXB2:
000E8B 4E8B 78               4      LD  A,B
000E8C 4E8C B7               4      OR  A
000E8D 4E8D C9              10      RET
                                
       4E8E                     RBXC:
000E8E 4E8E ED4BF0F2        20      LD  BC,(LEFTX)
000E92 4E92 3AC7F2          13      LD  A,(CLSZ_H)
000E95 4E95 3D               4      DEC A
000E96 4E96 A0               4      AND B
000E97 4E97 47               4      LD  B,A
000E98 4E98 B1               4      OR  C
000E99 4E99 C9              10      RET
                                
       4E9A                     RBXEND:
000E9A 4E9A ED5BD0F2        20      LD  DE,(_LEFT)
000E9E 4E9E 2ACAF2          16      LD  HL,(RR_LOW)
000EA1 4EA1 3ACDF2          13      LD  A,(RR_HIGH+1)
000EA4 4EA4 19              11      ADD HL,DE
000EA5 4EA5 CE00             7      ADC A,0
000EA7 4EA7 22CAF2          16      LD  (RR_LOW),HL
000EAA 4EAA 32CDF2          13      LD  (RR_HIGH+1),A
000EAD 4EAD EB               4      EX  DE,HL       ;HL=Read byte
000EAE 4EAE C9              10      RET 
                                
       4EAF                     RWXR:
000EAF 4EAF 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4EB2                     L_RWX:
000EB2 4EB2 1F               4      RRA     ;->CF
000EB3 4EB3 3806            12      JR  C,E_RWX
000EB5 4EB5 CB38             8      SRL B   ;BC=BC/2
000EB7 4EB7 CB19             8      RR  C   ;
000EB9 4EB9 18F7            12      JR  L_RWX
       4EBB                     E_RWX:
000EBB 4EBB 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
000EBE 4EBE 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
000EC1 4EC1 E5              11      PUSH    HL
000EC2 4EC2 2AEDF2          16      LD  HL,(DIRENT1)
000EC5 4EC5 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000EC8 4EC8 19              11      ADD HL,DE
000EC9 4EC9 CDC344          17      CALL    RDSLT_ROM
000ECC 4ECC 23               6      INC HL
000ECD 4ECD 5F               4      LD  E,A
000ECE 4ECE CDC344          17      CALL    RDSLT_ROM
000ED1 4ED1 23               6      INC HL
000ED2 4ED2 57               4      LD  D,A
000ED3 4ED3 E1              10      POP HL
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  E,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  D,(IY+01BH)
                                #endif
000ED4 4ED4 CD7854          17      CALL    GET_DISK_BANK_FDRV
       4ED7                     RWX1:
000ED7 4ED7 ED53CEF2        20      LD  (_CLPS),DE
000EDB 4EDB 7A               4      LD  A,D
000EDC 4EDC B3               4      OR  E
000EDD 4EDD 37               4      SCF
000EDE 4EDE C8              11      RET Z
                                
000EDF 4EDF 78               4      LD  A,B
000EE0 4EE0 B1               4      OR  C
000EE1 4EE1 C8              11      RET Z
                                
000EE2 4EE2 CD044F          17      CALL    GNCL
000EE5 4EE5 D8              11      RET C
000EE6 4EE6 0B               6      DEC BC
000EE7 4EE7 CD6B4F          17      CALL    ENDCL
000EEA 4EEA 38EB            12      JR  C,RWX1
000EEC 4EEC 37               4      SCF
000EED 4EED C9              10      RET
                                
       4EEE                     NCL3:
000EEE 4EEE CD7854          17      CALL    GET_DISK_BANK_FDRV
000EF1 4EF1 6B               4      LD  L,E
000EF2 4EF2 62               4      LD  H,D
000EF3 4EF3 CB3C             8      SRL H
000EF5 4EF5 CB1D             8      RR  L
000EF7 4EF7 1F               4      RRA
000EF8 4EF8 19              11      ADD HL,DE
000EF9 4EF9 010060          10      LD  BC,BANK1_ADR
000EFC 4EFC 09              11      ADD HL,BC
000EFD 4EFD ED4BC8F2        20      LD  BC,(SECSZ)
000F01 4F01 09              11      ADD HL,BC
000F02 4F02 17               4      RLA
000F03 4F03 C9              10      RET
                                
       4F04                     GNCL:
000F04 4F04 7A               4      LD  A,D
000F05 4F05 B3               4      OR  E
000F06 4F06 37               4      SCF
000F07 4F07 C8              11      RET Z
000F08 4F08 C5              11      PUSH    BC
000F09 4F09 E5              11      PUSH    HL
000F0A 4F0A CDEE4E          17      CALL    NCL3
000F0D 4F0D 3809            12      JR  C,GNC1
000F0F 4F0F 5E               7      LD  E,(HL)
000F10 4F10 23               6      INC HL
000F11 4F11 7E               7      LD  A,(HL)
000F12 4F12 E60F             7      AND 00FH
000F14 4F14 57               4      LD  D,A
000F15 4F15 E1              10      POP HL
000F16 4F16 C1              10      POP BC
000F17 4F17 C9              10      RET
       4F18                     GNC1:
000F18 4F18 7E               7      LD  A,(HL)
000F19 4F19 23               6      INC HL
000F1A 4F1A 56               7      LD  D,(HL)
000F1B 4F1B 0604             7      LD  B,4
       4F1D                     GNC1L:
000F1D 4F1D CB3A             8      SRL D
000F1F 4F1F 1F               4      RRA
000F20 4F20 10FB            13      DJNZ    GNC1L
                                
000F22 4F22 5F               4      LD  E,A
000F23 4F23 E1              10      POP HL
000F24 4F24 C1              10      POP BC
000F25 4F25 A7               4      AND A
000F26 4F26 C9              10      RET
                                
       4F27                     CLUST:
000F27 4F27 EB               4      EX  DE,HL
       4F28                     CLUST_HL:
000F28 4F28 2B               6      DEC HL
000F29 4F29 2B               6      DEC HL
000F2A 4F2A C5              11      PUSH    BC
000F2B 4F2B 3AC7F2          13      LD  A,(CLSZ_H)
000F2E 4F2E CDA554          17      CALL    MUL_AHL
                                
000F31 4F31 CDEC4F          17      CALL    GET_DIR_POS
000F34 4F34 4F               4      LD  C,A
000F35 4F35 0600             7      LD  B,0
000F37 4F37 09              11      ADD HL,BC
                                
000F38 4F38 ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
000F3C 4F3C CB38             8      SRL B
000F3E 4F3E CB19             8      RR  C           ;/2
000F40 4F40 CB38             8      SRL B
000F42 4F42 CB19             8      RR  C           ;/4
000F44 4F44 CB38             8      SRL B
000F46 4F46 CB19             8      RR  C           ;/8
000F48 4F48 09              11      ADD HL,BC
                                #if exists USE_MORMAL32K_OR_ASCII16
000F49 4F49 7D               4      LD  A,L
000F4A 4F4A 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
000F4D 4F4D 09              11      ADD HL,BC
000F4E 4F4E 3013            12      JR  NC,CLUST2
000F50 4F50 4D               4      LD  C,L     ;C=読み出し元
000F51 4F51 29              11      ADD HL,HL   ;64KB→32KB
000F52 4F52 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
000F53 4F53 CD7854          17      CALL    GET_DISK_BANK_FDRV
000F56 4F56 84               4      ADD A,H
000F57 4F57 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
000F5A 4F5A 32C4F2          13      LD  (_BANK),A
000F5D 4F5D 69               4      LD  L,C     ;C=読み出し元
000F5E 4F5E 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
000F60 4F60 A5               4      AND L
000F61 4F61 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB
                                    ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
                                    AND L
                                #endif
       4F63                     CLUST2:
000F63 4F63 C660             7      ADD A,high BANK1_ADR
000F65 4F65 67               4      LD  H,A
000F66 4F66 2E00             7      LD  L,0
000F68 4F68 EB               4      EX  DE,HL
000F69 4F69 C1              10      POP BC
000F6A 4F6A C9              10      RET
                                
       4F6B                     ENDCL:
000F6B 4F6B 7A               4      LD  A,D ;END CLUSTER
000F6C 4F6C FE0F             7      CP  00FH    ;FAT12の最大値
000F6E 4F6E C0              11      RET NZ
000F6F 4F6F 7B               4      LD  A,E
000F70 4F70 FEF7             7      CP  0F7H
000F72 4F72 C9              10      RET
                                
       4F73                     RB_READ:
000F73 4F73 AF               4      XOR A   ;HLA = HL*128
000F74 4F74 CB3C             8      SRL H
000F76 4F76 CB1D             8      RR  L
000F78 4F78 1F               4      RRA
000F79 4F79 32CAF2          13      LD  (RR_LOW),A
000F7C 4F7C 22CBF2          16      LD  (RR_MID),HL
000F7F 4F7F 218000          10      LD  HL,128
                                
000F82 4F82 CD434B          17      CALL    ROM_READ
000F85 4F85 C9              10      RET
                                
       4F86                     GETSEQ:
000F86 4F86 FD6E20          19      LD  L,(IY+32)
000F89 4F89 FD660C          19      LD  H,(IY+12)
                                
000F8C 4F8C CB25             8      SLA L
                                
000F8E 4F8E CB3C             8      SRL H
000F90 4F90 CB1D             8      RR  L
000F92 4F92 C9              10      RET
                                
       4F93                     SETSEQ:
000F93 4F93 F5              11      PUSH    AF
000F94 4F94 3ACAF2          13      LD  A,(RR_LOW)
000F97 4F97 2ACBF2          16      LD  HL,(RR_MID)
                                
000F9A 4F9A CDB14F          17      CALL    SSQ1
                                
000F9D 4F9D 29              11      ADD HL,HL
000F9E 4F9E CB3D             8      SRL L
000FA0 4FA0 FD7520          19      LD  (IY+32),L
000FA3 4FA3 FD740C          19      LD  (IY+12),H
000FA6 4FA6 F1              10      POP AF
000FA7 4FA7 C9              10      RET
                                
       4FA8                     GETSIZE:
000FA8 4FA8 FD7E10          19      LD  A,(IY+16)
000FAB 4FAB FD6E11          19      LD  L,(IY+17)
000FAE 4FAE FD6612          19      LD  H,(IY+18)
       4FB1                     SSQ1:
000FB1 4FB1 87               4      ADD A,A
000FB2 4FB2 ED6A            15      ADC HL,HL
000FB4 4FB4 B7               4      OR  A
000FB5 4FB5 C8              11      RET Z
000FB6 4FB6 23               6      INC HL
000FB7 4FB7 C9              10      RET
                                
       4FB8                     SET_FCB:
000FB8 4FB8 D5              11      PUSH    DE
000FB9 4FB9 FDE1            14      POP IY
000FBB 4FBB FD7E1C          19      LD  A,(IY+28)
000FBE 4FBE FEFF             7      CP  0FFH
000FC0 4FC0 200C            12      JR  NZ,POPAF_SCF_FF_RET
000FC2 4FC2 E5              11      PUSH    HL
000FC3 4FC3 FD6E1A          19      LD  L,(IY+26)
000FC6 4FC6 FD661B          19      LD  H,(IY+27)
000FC9 4FC9 22CEF2          16      LD  (_CLPS),HL
000FCC 4FCC E1              10      POP HL
000FCD 4FCD C9              10      RET
                                
       4FCE                     POPAF_SCF_FF_RET:
000FCE 4FCE F1              10      POP AF
000FCF 4FCF 37               4      SCF
000FD0 4FD0 9F               4      SBC A,A
000FD1 4FD1 C9              10      RET
                                
       4FD2                     GET_DIR_DAT:
000FD2 4FD2 2AF6F2          16      LD  HL,(_CDX)
000FD5 4FD5 7C               4      LD  A,H
000FD6 4FD6 B5               4      OR  L
000FD7 4FD7 2032            12      JR  NZ,GET_SUBDIR
000FD9 4FD9 CDEC4F          17      CALL    GET_DIR_POS
000FDC 4FDC C660             7      ADD A,high BANK1_ADR
000FDE 4FDE 2E00             7      LD  L,0
000FE0 4FE0 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                    CALL    CHECK_DIR_PAGE
                                #endif
000FE1 4FE1 3AC5F2          13      LD  A,(_BANK1)
000FE4 4FE4 32EFF2          13      LD  (_DIR_BANK),A
                                
000FE7 4FE7 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000FEA 4FEA 4F               4      LD  C,A
000FEB 4FEB C9              10      RET
                                
       4FEC                     GET_DIR_POS:                ;ルートディレクトリ
000FEC 4FEC CD7854          17      CALL    GET_DISK_BANK_FDRV
000FEF 4FEF 32C5F2          13      LD  (_BANK1),A
000FF2 4FF2 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000FF5 4FF5 47               4      LD  B,A
000FF6 4FF6 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000FF9 4FF9 4F               4      LD  C,A
000FFA 4FFA 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4FFD                     GET_DIR_POS1:
000FFD 4FFD 81               4      ADD A,C
000FFE 4FFE 10FD            13      DJNZ    GET_DIR_POS1
                                
001000 5000 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
001004 5004 37               4      SCF     ;無限ループ回避
       5005                     L_MDP:
001005 5005 CB18             8      RR  B   ;->CF
001007 5007 D8              11      RET C
001008 5008 87               4      ADD A,A
001009 5009 18FA            12      JR  L_MDP
                                
       500B                     GET_SUBDIR:             ;サブディレクトリ
00100B 500B CD284F          17      CALL    CLUST_HL
00100E 500E EB               4      EX  DE,HL
00100F 500F 3AC4F2          13      LD  A,(_BANK)
001012 5012 32EFF2          13      LD  (_DIR_BANK),A
001015 5015 3AC7F2          13      LD  A,(CLSZ_H)
001018 5018 87               4      ADD A,A     ;*2
001019 5019 87               4      ADD A,A     ;*4
00101A 501A 87               4      ADD A,A     ;*8
00101B 501B 4F               4      LD  C,A
00101C 501C C9              10      RET
                                
       501D                     STATEMENT:
00101D 501D 118A52          10      LD  DE,STR_CHDIR
001020 5020 CD7052          17      CALL    CPPROCNM
001023 5023 2812            12      JR  Z,_CHDIR
001025 5025 119052          10      LD  DE,STR_CHDRV
001028 5028 CD7052          17      CALL    CPPROCNM
00102B 502B 281C            12      JR  Z,_CHDRV
00102D 502D 119652          10      LD  DE,STR_RAMDISK
001030 5030 CD7052          17      CALL    CPPROCNM
001033 5033 2829            12      JR  Z,_RAMDISK
001035 5035 37               4      SCF
001036 5036 C9              10      RET
       5037                     _CHDIR:
001037 5037 7E               7      LD  A,(HL)
001038 5038 FE28             7      CP  '('
00103A 503A 37               4      SCF
00103B 503B C0              11      RET NZ
00103C 503C CDF148          17      CALL    INIT_PARAM
00103F 503F CDE44B          17      CALL    FILE_B
001042 5042 CD7250          17      CALL    ROM_CD
001045 5045 D0              11      RET NC
001046 5046 C39747          10      JP  ERROR_FILE_NOT_FOUND
                                
       5049                     _CHDRV:
001049 5049 7E               7      LD  A,(HL)
00104A 504A FE28             7      CP  '('
00104C 504C 37               4      SCF
00104D 504D C0              11      RET NZ
00104E 504E CDF148          17      CALL    INIT_PARAM
001051 5051 E5              11      PUSH    HL
001052 5052 CDE44B          17      CALL    FILE_B
001055 5055 E1              10      POP HL
001056 5056 23               6      INC HL
001057 5057 3AF8F2          13      LD  A,(FDRV)
00105A 505A 3D               4      DEC A
00105B 505B C3DE56          10      JP  _SYS0EX1
                                
       505E                     _RAMDISK:
00105E 505E 7E               7      LD  A,(HL)
00105F 505F FE28             7      CP  '('
001061 5061 37               4      SCF
001062 5062 C0              11      RET NZ
001063 5063 23               6      INC HL
001064 5064 DD212F54        14      LD  IX,FRMQNT
001068 5068 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00106C 506C CD1C00          17      CALL    _CALSLT
                                ;   LD  A,(HOKVLD)  ;bit0: 拡張 BIOSの存在
                                ;   CPL
                                ;   AND 1
                                ;   LD  A,D
                                ;   OR  E
                                ;   JP  NZ,ERROR_INTERNAL_ERROR
                                ;   PUSH    HL      ;EXTBIOもDISK BIOSで初期化してそう
                                ;   XOR A
                                ;   LD  DE,0401H    ;D=マッパサポートルチン(4) E=機能番号(1)
                                ;   CALL    EXTBIO
                                ;   POP HL
                                ;   OR  A
                                ;   JP  Z,ERROR_INTERNAL_ERROR
00106F 506F 23               6      INC HL
001070 5070 AF               4      XOR A
001071 5071 C9              10      RET
                                
       5072                     ROM_CD:
001072 5072 3AF9F2          13      LD  A,(FNAME)
001075 5075 FE20             7      CP  020H
001077 5077 2835            12      JR  Z,CD1
001079 5079 CD764D          17      CALL    ROM_OPEN
00107C 507C D8              11      RET C
                                #if exists USE_MORMAL32K_OR_ASCII16
00107D 507D D5              11      PUSH    DE
00107E 507E 2AEDF2          16      LD  HL,(DIRENT1)
001081 5081 110B00          10      LD  DE,0000BH   ;属性(アトリビュート)
001084 5084 19              11      ADD HL,DE
001085 5085 CDC344          17      CALL    RDSLT_ROM
001088 5088 D1              10      POP DE
001089 5089 CB67             8      BIT 4,A     ;ディレクトリ
00108B 508B CA9747          10      JP  Z,ERROR_FILE_NOT_FOUND
00108E 508E D5              11      PUSH    DE
00108F 508F 2AEDF2          16      LD  HL,(DIRENT1)
001092 5092 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
001095 5095 19              11      ADD HL,DE
001096 5096 CDC344          17      CALL    RDSLT_ROM
001099 5099 23               6      INC HL
00109A 509A 5F               4      LD  E,A
00109B 509B CDC344          17      CALL    RDSLT_ROM
00109E 509E 57               4      LD  D,A
00109F 509F EB               4      EX  DE,HL
0010A0 50A0 D1              10      POP DE
                                #else
                                    LD  IY,(DIRENT1)
                                    BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    LD  L,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  H,(IY+01BH)
                                #endif
       50A1                     CD2:
0010A1 50A1 22EBF2          16      LD  (_CD),HL
0010A4 50A4 2AF4F2          16      LD  HL,(PARAM1)
       50A7                     CD_SKIP:
0010A7 50A7 7E               7      LD  A,(HL)
0010A8 50A8 23               6      INC HL
0010A9 50A9 FE21             7      CP  021H
0010AB 50AB 38FA            12      JR  C,CD_SKIP
0010AD 50AD C9              10      RET
       50AE                     CD1:
0010AE 50AE 2AF6F2          16      LD  HL,(_CDX)
0010B1 50B1 18EE            12      JR  CD2
                                
       50B3                     GET_BASIC_FCB:
0010B3 50B3 D5              11      PUSH    DE
0010B4 50B4 23               6      INC HL  ;+1
0010B5 50B5 5E               7      LD  E,(HL)  ;FCB[1]
0010B6 50B6 23               6      INC HL  ;+2
0010B7 50B7 56               7      LD  D,(HL)  ;FCB[2]
0010B8 50B8 23               6      INC HL  ;+3
0010B9 50B9 ED53EDF2        20      LD  (DIRENT1),DE
                                            ;FCB[3] backup char
0010BD 50BD 23               6      INC HL  ;+4
                                            ;FCB[4]
0010BE 50BE 23               6      INC HL  ;+5
0010BF 50BF 7E               7      LD  A,(HL)  ;FCB[5]
0010C0 50C0 23               6      INC HL  ;+6
0010C1 50C1 32EFF2          13      LD  (_DIR_BANK),A
0010C4 50C4 5E               7      LD  E,(HL)  ;FCB[6]
0010C5 50C5 23               6      INC HL  ;+7
0010C6 50C6 56               7      LD  D,(HL)  ;FCB[7]
0010C7 50C7 23               6      INC HL  ;+8
0010C8 50C8 ED53CAF2        20      LD  (RR_LOW),DE
0010CC 50CC 7E               7      LD  A,(HL)  ;FCB[8]
0010CD 50CD 23               6      INC HL  ;+9
0010CE 50CE 32CCF2          13      LD  (RR_HIGH),A
0010D1 50D1 22D4F2          16      LD  (_DTA),HL   ;FCB[9]
0010D4 50D4 D1              10      POP DE
0010D5 50D5 C9              10      RET
                                
       50D6                     SET_BASIC_FCB:
0010D6 50D6 E5              11      PUSH    HL
0010D7 50D7 2A64F8          16      LD  HL,(PTRFIL)
0010DA 50DA 23               6      INC HL  ;+1
0010DB 50DB D5              11      PUSH    DE
0010DC 50DC ED5BEDF2        20      LD  DE,(DIRENT1)
0010E0 50E0 73               7      LD  (HL),E  ;FCB[1]
0010E1 50E1 23               6      INC HL  ;+2
0010E2 50E2 72               7      LD  (HL),D  ;FCB[2]
0010E3 50E3 23               6      INC HL  ;+3
0010E4 50E4 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
0010E5 50E5 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
0010E6 50E6 23               6      INC HL  ;+5
0010E7 50E7 3AEFF2          13      LD  A,(_DIR_BANK)
0010EA 50EA 77               7      LD  (HL),A  ;FCB[5]
0010EB 50EB 23               6      INC HL  ;+6
0010EC 50EC ED5BCAF2        20      LD  DE,(RR_LOW)
0010F0 50F0 73               7      LD  (HL),E  ;FCB[6]
0010F1 50F1 23               6      INC HL  ;+7
0010F2 50F2 72               7      LD  (HL),D  ;FCB[7]
0010F3 50F3 23               6      INC HL  ;+8
0010F4 50F4 3ACCF2          13      LD  A,(RR_HIGH)
0010F7 50F7 77               7      LD  (HL),A  ;FCB[8]
0010F8 50F8 D1              10      POP DE
0010F9 50F9 E1              10      POP HL
0010FA 50FA C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_18:BACKUP
                                ;in
                                ;   C : backup charactor
                                ;   HL: FBC pointer
                                ;out
       50FB                     DEVICE_18_BACKUP:
0010FB 50FB D5              11      PUSH    DE
0010FC 50FC E5              11      PUSH    HL
0010FD 50FD 110300          10      LD  DE,3
001100 5100 19              11      ADD HL,DE
001101 5101 71               7      LD  (HL),C
001102 5102 E1              10      POP HL
001103 5103 D1              10      POP DE
001104 5104 C9              10      RET
                                
       5105                     DEVICE_CHECK:
001105 5105 3A8AFD          13      LD  A,(PROCNM+1)
001108 5108 B7               4      OR  A
001109 5109 C8              11      RET Z
00110A 510A 119E52          10      LD  DE,STR_ROM
00110D 510D CD7052          17      CALL    CPPROCNM
001110 5110 2802            12      JR  Z,DEVICE_OK
001112 5112 37               4      SCF
001113 5113 C9              10      RET
       5114                     DEVICE_OK:
001114 5114 AF               4      XOR A
001115 5115 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファ
                                
       5116                     DEVICE_0_OPEN:
001116 5116 7B               4      LD  A,E
001117 5117 FE02             7      CP  2       ;FOR OUTPUT
001119 5119 281B            12      JR  Z,OPEN2
00111B 511B D5              11      PUSH    DE
00111C 511C E5              11      push    hl
                                ;
00111D 511D 3E01             7      LD  A,1     ;ドライブA
00111F 511F 32F8F2          13      LD  (FDRV),A
001122 5122 2166F8          10      LD  HL,FILNAM
001125 5125 11F9F2          10      LD  DE,FNAME
001128 5128 010B00          10      LD  BC,8+3
00112B 512B CD5C58          17      CALL    INIT_FILE1
00112E 512E CD764D          17      CALL    ROM_OPEN
001131 5131 DA9747          10      JP  C,ERROR_FILE_NOT_FOUND
001134 5134 E1              10      pop hl
001135 5135 D1              10      POP DE
       5136                     OPEN2:
001136 5136 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
001139 5139 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
00113A 513A AF               4      XOR A
00113B 513B 32F0F2          13      LD  (LEFTX),A
00113E 513E CDD650          17      CALL    SET_BASIC_FCB
001141 5141 7B               4      ld  a,e
001142 5142 FE08             7      cp  8
001144 5144 3F               4      ccf
001145 5145 C9              10      ret
                                
       5146                     DEVICE_2_CLOSE:
001146 5146 AF               4      XOR A
                                ;   LD  (HL),A
001147 5147 6F               4      LD  L,A
001148 5148 67               4      LD  H,A
001149 5149 2264F8          16      LD  (PTRFIL),HL
00114C 514C C9              10      RET
                                
       514D                     DEVICE_ENTRY:
00114D 514D FE08             7      CP  8
00114F 514F 2826            12      JR  Z,DEVICE_8_SIN
001151 5151 3C               4      INC A
001152 5152 28B1            12      JR  Z,DEVICE_CHECK:
001154 5154 3D               4      DEC A
001155 5155 28BF            12      JR  Z,DEVICE_0_OPEN
001157 5157 FE0E             7      CP  14
001159 5159 2860            12      JR  Z,DEVICE_14_EOF
00115B 515B FE04             7      CP  4
00115D 515D 2834            12      JR  Z,DEVICE_4_RANDOM
00115F 515F FE0A             7      CP  10
001161 5161 2850            12      JR  Z,DEVICE_10_LOC
001163 5163 FE0C             7      CP  12
001165 5165 2878            12      JR  Z,DEVICE_12_LOF
001167 5167 FE02             7      CP  2
001169 5169 2890            12      JR  Z,DEVICE_18_BACKUP  
00116B 516B FE02             7      CP  2
00116D 516D 28D7            12      JR  Z,DEVICE_2_CLOSE
00116F 516F FE06             7      CP  6
001171 5171 2802            12      JR  Z,DEVICE_6_SOUT
001173 5173 37               4      SCF
001174 5174 C9              10      RET
                                
       5175                     DEVICE_6_SOUT:
001175 5175 AF               4      XOR A
001176 5176 C9              10      RET
                                
       5177                     DEVICE_8_SIN:
001177 5177 CDB350          17      CALL    GET_BASIC_FCB
00117A 517A 210100          10      LD  HL,1
00117D 517D CD434B          17      CALL    ROM_READ
001180 5180 7C               4      LD  A,H
001181 5181 B5               4      OR  L
001182 5182 280D            12      JR  Z,CCF_RET
001184 5184 2AD4F2          16      LD  HL,(_DTA)
001187 5187 7E               7      LD  A,(HL)
001188 5188 F5              11      PUSH    AF
001189 5189 CDD650          17      CALL    SET_BASIC_FCB
00118C 518C F1              10      POP AF
00118D 518D FE0A             7      CP  00AH
00118F 518F C8              11      RET Z   ;ZF=separate
                                ;   CP  01AH
                                ;   JR  Z,SCF_RET
001190 5190 37               4      SCF     ;
       5191                     CCF_RET:
001191 5191 3F               4      CCF     ;ZF=0 CF=0にしたい
001192 5192 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_4:RANDOM
                                ;in
                                ;   A : 4
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
       5193                     DEVICE_4_RANDOM:
001193 5193 D5              11      PUSH    DE
001194 5194 CDB350          17      CALL    GET_BASIC_FCB
001197 5197 DDE5            15      PUSH    IX
001199 5199 DD218A2F        14      LD  IX,FRCINT
00119D 519D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0011A1 51A1 CDB0F2          17      CALL    CAL_MP
0011A4 51A4 DDE1            14      POP IX
0011A6 51A6 2AF8F7          16      LD  HL,(DACDAT)
0011A9 51A9 22CAF2          16      LD  (RR_LOW),HL
0011AC 51AC AF               4      XOR A
0011AD 51AD CDD650          17      CALL    SET_BASIC_FCB
0011B0 51B0 D1              10      POP DE
0011B1 51B1 AF               4      XOR A
0011B2 51B2 C9              10      RET
                                
                                ;FUNC_10:LOC
                                ;in
                                ;   A : 10
                                ;out
                                ;   DAC    : value of received bytes
                                ;   VALTYP : DAC type
       51B3                     DEVICE_10_LOC:
0011B3 51B3 CDB350          17      CALL    GET_BASIC_FCB
0011B6 51B6 2ACAF2          16      LD  HL,(RR_LOW)
0011B9 51B9 1844            12      JR  RETURN_TYPE8_AHL
                                
                                ;--------------------------------------
                                ;FUNC_14:EOF
                                ;in
                                ;   A : 14
                                ;out
                                ;   DAC    : value of EOF value (EOF=-1)
                                ;   VALTYP : DAC type
       51BB                     DEVICE_14_EOF:
0011BB 51BB CDB350          17      CALL    GET_BASIC_FCB
0011BE 51BE CDF74D          17      CALL    RBX1
0011C1 51C1 3810            12      JR  C,DEVICE_14_EOF1
0011C3 51C3 210100          10      LD  HL,1
0011C6 51C6 CD434B          17      CALL    ROM_READ
0011C9 51C9 2AD4F2          16      LD  HL,(_DTA)
0011CC 51CC 7E               7      LD  A,(HL)
0011CD 51CD FE1A             7      CP  01AH
0011CF 51CF 37               4      SCF
0011D0 51D0 2801            12      JR  Z,DEVICE_14_EOF1
0011D2 51D2 3F               4      CCF
       51D3                     DEVICE_14_EOF1:
0011D3 51D3 9F               4      SBC A,A
0011D4 51D4 6F               4      LD  L,A
0011D5 51D5 67               4      LD  H,A
       51D6                     return_type2_hl:
0011D6 51D6 22F8F7          16      ld  (DACDAT),hl
0011D9 51D9 3E02             7      ld  a,2
0011DB 51DB 3263F6          13      ld  (VALTYP),a
0011DE 51DE C9              10      ret
                                
                                ;--------------------------------------
                                ;FUNC_16:FPOS
                                ;in
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
                                ;   illegal function call
                                
                                ;--------------------------------------
                                ;FUNC_12:LOF
                                ;in
                                ;   A : 12
                                ;out
                                ;   DAC    : value of LOC+RSIQLN
                                ;   VALTYP : DAC type
       51DF                     DEVICE_12_LOF:
0011DF 51DF CDB350          17      CALL    GET_BASIC_FCB
                                
0011E2 51E2 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
0011E5 51E5 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
0011E8 51E8 D5              11      PUSH    DE
0011E9 51E9 2AEDF2          16      LD  HL,(DIRENT1)
0011EC 51EC 111C00          10      LD  DE,0001CH
0011EF 51EF 19              11      ADD HL,DE
0011F0 51F0 CDC344          17      CALL    RDSLT_ROM
0011F3 51F3 23               6      INC HL
0011F4 51F4 5F               4      LD  E,A
0011F5 51F5 CDC344          17      CALL    RDSLT_ROM
0011F8 51F8 23               6      INC HL
0011F9 51F9 57               4      LD  D,A
0011FA 51FA CDC344          17      CALL    RDSLT_ROM
0011FD 51FD EB               4      EX  DE,HL       ;AHL=File size
0011FE 51FE D1              10      POP DE
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  L,(IY+01CH) ;AHL=File size
                                    LD  H,(IY+01DH)
                                    LD  A,(IY+01EH)
                                #endif
       51FF                     RETURN_TYPE8_AHL:
0011FF 51FF B7               4      OR  A
001200 5200 2004            12      JR  NZ,RT8AHL1
001202 5202 CB7C             8      BIT 7,H
001204 5204 28D0            12      JR  Z,return_type2_hl
       5206                     RT8AHL1:
001206 5206 E5              11      PUSH    HL
001207 5207 29              11      ADD HL,HL
001208 5208 8F               4      ADC A,A
001209 5209 32F8F7          13      LD  (DACDAT),A
00120C 520C 3E00             7      LD  A,0
00120E 520E 8F               4      ADC A,A
00120F 520F 32F9F7          13      LD  (DACDAT+1),A
                                
001212 5212 3E02             7      LD  A,2
001214 5214 3263F6          13      LD  (VALTYP),A
001217 5217 DD213A30        14      LD  IX,FRCDBL
00121B 521B FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00121F 521F CDB0F2          17      CALL    CAL_MP
                                
001222 5222 216852          10      LD  HL,DBL32768
001225 5225 1147F8          10      LD  DE,ARG
001228 5228 010800          10      LD  BC,8
00122B 522B EDB0                    LDIR
                                
00122D 522D DD21E627        14      LD  IX,DECMUL
001231 5231 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001235 5235 CDB0F2          17      CALL    CAL_MP
                                
001238 5238 21F6F7          10      LD  HL,DAC
00123B 523B 1147F8          10      LD  DE,ARG
00123E 523E 010800          10      LD  BC,8
001241 5241 EDB0                    LDIR
                                
001243 5243 E1              10      POP HL
001244 5244 22F8F7          16      LD  (DACDAT),HL
                                
001247 5247 3E02             7      LD  A,2
001249 5249 3263F6          13      LD  (VALTYP),A
00124C 524C DD213A30        14      LD  IX,FRCDBL
001250 5250 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001254 5254 CDB0F2          17      CALL    CAL_MP
                                
001257 5257 DD219A26        14      LD  IX,DECADD
00125B 525B FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00125F 525F CDB0F2          17      CALL    CAL_MP
                                
001262 5262 3E08             7      LD  A,8
001264 5264 3263F6          13      LD  (VALTYP),A
001267 5267 C9              10      RET
                                
       5268                     DBL32768:
001268 5268 4532768000000000        DB  045H,032H,076H,080H,0,0,0,0
                                
       5270                     CPPROCNM:
001270 5270 E5              11      PUSH    HL
001271 5271 2189FD          10      LD  HL,PROCNM
       5274                     CPPROCNM1:
001274 5274 1A               7      LD  A,(DE)
001275 5275 13               6      INC DE
001276 5276 BE               7      CP  (HL)
001277 5277 23               6      INC HL
001278 5278 2003            12      JR  NZ,CPPROCNM2
00127A 527A B7               4      OR  A
00127B 527B 20F7            12      JR  NZ,CPPROCNM1
       527D                     CPPROCNM2:
00127D 527D E1              10      POP HL
00127E 527E C9              10      RET
                                
       527F                     WILDCARD:
00127F 527F 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       528A                     STR_CHDIR:
00128A 528A 434844495200            DB  "CHDIR",0
       5290                     STR_CHDRV:
001290 5290 434844525600            DB  "CHDRV",0
       5296                     STR_RAMDISK:
001296 5296 52414D4449534B00        DB  "RAMDISK",0
       529E                     STR_ROM:
00129E 529E 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       52A2                     ERROR_WRITE_PROTECTED:
0012A2 52A2 3E00             7      LD  A,0     ;Write protected
0012A4 52A4 C9              10      RET
       52A5                     DISKIO:
0012A5 52A5 38FB            12      JR  C,ERROR_WRITE_PROTECTED
0012A7 52A7 48               4      LD  C,B
0012A8 52A8 CD8254          17      CALL    GET_DISK_BANK
       52AB                     SETMAP1:        
0012AB 52AB E5              11      PUSH    HL
       52AC                     DISKIO1:
0012AC 52AC C5              11      PUSH    BC      ;B=残りのセクタ数
0012AD 52AD D5              11      PUSH    DE      ;DE=セクタ番号
0012AE 52AE F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
0012AF 52AF EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
0012B0 52B0 F5              11      PUSH    AF
0012B1 52B1 3AC9F2          13      LD  A,(SECSZ_H)
0012B4 52B4 CDA554          17      CALL    MUL_AHL
0012B7 52B7 F1              10      POP AF
                                #if exists USE_MORMAL32K_OR_ASCII16
0012B8 52B8 7D               4      LD  A,L
0012B9 52B9 C5              11      PUSH    BC
0012BA 52BA 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
0012BD 52BD 09              11      ADD HL,BC
0012BE 52BE C1              10      POP BC
0012BF 52BF 3013            12      JR  NC,DISKIO2
0012C1 52C1 4D               4      LD  C,L     ;C=読み出し元
0012C2 52C2 29              11      ADD HL,HL   ;64KB→32KB
0012C3 52C3 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
0012C4 52C4 CD7854          17      CALL    GET_DISK_BANK_FDRV
0012C7 52C7 84               4      ADD A,H
0012C8 52C8 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
0012CB 52CB 32C4F2          13      LD  (_BANK),A
0012CE 52CE 69               4      LD  L,C     ;C=読み出し元
0012CF 52CF 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
0012D1 52D1 A5               4      AND L
0012D2 52D2 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL       ;64KB→32KB
                                    ADD HL,HL       ;32KB→16KB
                                    ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  A,C     ;C=読み出し元
                                    AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       52D4                     DISKIO2:
0012D4 52D4 C660             7      ADD A,high BANK1_ADR
0012D6 52D6 67               4      LD  H,A
0012D7 52D7 ED4BC8F2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
0012DB 52DB 69               4      LD  L,C     ;C=0
0012DC 52DC CD1945          17      CALL    ROM_LDIR
0012DF 52DF EB               4      EX  DE,HL
0012E0 52E0 F1              10      POP AF
0012E1 52E1 D1              10      POP DE
0012E2 52E2 13               6      INC DE
0012E3 52E3 C1              10      POP BC
0012E4 52E4 10C6            13      DJNZ    DISKIO1
0012E6 52E6 41               4      LD  B,C
                                
0012E7 52E7 E1              10      POP HL
0012E8 52E8 AF               4      XOR A
                                
0012E9 52E9 FB               4      EI
0012EA 52EA C9              10      RET
                                
       52EB                     DSKCHG:
0012EB 52EB CD2453          17      CALL    IS_BPB
0012EE 52EE 3824            12      JR  C,NOTREADY
0012F0 52F0 3A23FB          13      LD  A,(DRVTBL+2)
0012F3 52F3 B7               4      OR  A
0012F4 52F4 201A            12      JR  NZ,DSKCHG1
0012F6 52F6 3A21FB          13      LD  A,(DRVTBL)
0012F9 52F9 FE02             7      CP  2
0012FB 52FB 2013            12      JR  NZ,DSKCHG1
0012FD 52FD CD2453          17      CALL    IS_BPB
001300 5300 300E            12      JR  NC,DSKCHG1
001302 5302 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
001304 5304 3221FB          13      LD  (DRVTBL),A
001307 5307 3223FB          13      LD  (DRVTBL+2),A
00130A 530A 3A48F3          13      LD  A,(MASTERS)
00130D 530D 3224FB          13      LD  (DRVTBL+3),A
       5310                     DSKCHG1:
001310 5310 AF               4      XOR A
001311 5311 0601             7      LD  B,1
001313 5313 C9              10      RET
       5314                     NOTREADY:
001314 5314 3E02             7      LD  A,2
001316 5316 37               4      SCF
001317 5317 C9              10      RET
                                
       5318                     NO_BPB:
001318 5318 E1              10      POP HL
001319 5319 23               6      INC HL
00131A 531A 11AB54          10      LD  DE,DPB2DD
00131D 531D 011200          10      LD  BC,DPB2DD_E-DPB2DD
001320 5320 EDB0                    LDIR
001322 5322 AF               4      XOR A
001323 5323 C9              10      RET
                                
       5324                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
001324 5324 CD8254          17      CALL    GET_DISK_BANK
                                
001327 5327 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
00132A 532A FE01             7      CP  1
00132C 532C D8              11      RET C
                                
00132D 532D 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
001330 5330 C6FF             7      ADD A,0FFH
001332 5332 D8              11      RET C
                                
001333 5333 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       5336                     IS_BPB1:
001336 5336 FE01             7      CP  1
001338 5338 C8              11      RET Z
001339 5339 FE02             7      CP  2
00133B 533B C8              11      RET Z
00133C 533C FE04             7      CP  4
00133E 533E C8              11      RET Z
00133F 533F 37               4      SCF
001340 5340 C9              10      RET
                                
       5341                     GETDPB:
001341 5341 E5              11      PUSH    HL
001342 5342 CD8254          17      CALL    GET_DISK_BANK
                                
001345 5345 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
001348 5348 B7               4      OR  A
001349 5349 28CD            12      JR  Z,NO_BPB
00134B 534B DDE1            14      POP IX
00134D 534D DD7701          19      LD  (IX+1),A        ;MEDIA
                                
001350 5350 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
001353 5353 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
001356 5356 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
001359 5359 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
00135C 535C 87               4      ADD A,A
00135D 535D 87               4      ADD A,A
00135E 535E 87               4      ADD A,A
00135F 535F 3D               4      DEC A
001360 5360 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
001363 5363 06FF             7      LD  B,-1
001365 5365 A7               4      AND A           ;無限ループ阻止
       5366                     GETDPB1:
001366 5366 04               4      INC B
001367 5367 1F               4      RRA
001368 5368 38FC            12      JR  C,GETDPB1
00136A 536A DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
00136D 536D 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
001370 5370 3D               4      DEC A
001371 5371 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
001374 5374 A7               4      AND A           ;無限ループ阻止
001375 5375 06FF             7      LD  B,-1
       5377                     GETDPB2:
001377 5377 04               4      INC B
001378 5378 1F               4      RRA
001379 5379 38FC            12      JR  C,GETDPB2
00137B 537B 04               4      INC B
00137C 537C DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
00137F 537F 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
001382 5382 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
001385 5385 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
001388 5388 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
00138B 538B DD770A          19      LD  (IX+10),A       ;FATCNT
                                
00138E 538E 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
001391 5391 DD770B          19      LD  (IX+11),A       ;MAXENT
                                
001394 5394 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
001398 5398 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
00139B 539B DD460A          19      LD  B,(IX+10)       ;FATCNT
00139E 539E 210000          10      LD  HL,0
       53A1                     GETDPB3:
0013A1 53A1 19              11      ADD HL,DE
0013A2 53A2 10FD            13      DJNZ    GETDPB3
       53A4                     GETDPB4:
0013A4 53A4 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
0013A7 53A7 DD5609          19      LD  D,(IX+9)        ;FIRFAT
0013AA 53AA 19              11      ADD HL,DE
0013AB 53AB DD7511          19      LD  (IX+17),L       ;FIRDIR
0013AE 53AE DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
0013B1 53B1 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0013B4 53B4 87               4      ADD A,A
0013B5 53B5 87               4      ADD A,A
0013B6 53B6 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       53B9                     GETDPB5:
0013B9 53B9 CB3B             8      SRL E
0013BB 53BB 1F               4      RRA
0013BC 53BC 30FB            12      JR  NC,GETDPB5
0013BE 53BE 1600             7      LD  D,0
0013C0 53C0 19              11      ADD HL,DE
0013C1 53C1 DD750C          19      LD  (IX+12),L       ;FIRREC
0013C4 53C4 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
0013C7 53C7 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
0013CA 53CA DD5E0C          19      LD  E,(IX+12)       ;FIRREC
0013CD 53CD DD560D          19      LD  D,(IX+13)       ;FIRREC
0013D0 53D0 A7               4      AND A
0013D1 53D1 ED52            15      SBC HL,DE
                                
0013D3 53D3 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
0013D6 53D6 3C               4      INC A
0013D7 53D7 37               4      SCF             ;無限ループ阻止
       53D8                     GETDPB6:
0013D8 53D8 1F               4      RRA
0013D9 53D9 3806            12      JR  C,GETDPB7
0013DB 53DB CB3C             8      SRL H
0013DD 53DD CB1D             8      RR  L
0013DF 53DF 18F7            12      JR  GETDPB6
       53E1                     GETDPB7:
0013E1 53E1 23               6      INC HL
0013E2 53E2 DD750E          19      LD  (IX+14),L       ;MAXCLUS
0013E5 53E5 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       53E8                     GETDPBD1:
0013E8 53E8 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0013EB 53EB E6FC             7      AND 0FCH
0013ED 53ED C8              11      RET Z
                                
0013EE 53EE DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
0013F2 53F2 37               4      SCF
0013F3 53F3 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
0013F7 53F7 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
0013FA 53FA DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
0013FE 53FE DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
001402 5402 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
001406 5406 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
00140A 540A DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
00140E 540E DDCB1126        23      SLA (IX+17)         ;FIRDIR
001412 5412 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
001416 5416 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
001419 5419 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
00141C 541C DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
00141F 541F 87               4      ADD A,A
001420 5420 87               4      ADD A,A
001421 5421 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       5424                     GETDPBD5:
001424 5424 CB3B             8      SRL E
001426 5426 1F               4      RRA
001427 5427 30FB            12      JR  NC,GETDPBD5
001429 5429 1600             7      LD  D,0
00142B 542B 19              11      ADD HL,DE
00142C 542C DD750C          19      LD  (IX+12),L       ;FIRREC
00142F 542F DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001432 5432 18B4            12      JR  GETDPBD1
                                
       5434                     CHOICE:
001434 5434 210000          10      LD  HL,0
001437 5437 C9              10      RET
                                
       5438                     DSKFMT:
001438 5438 AF               4      XOR A
001439 5439 37               4      SCF
       543A                     DSKSTP:
00143A 543A C9              10      RET
                                
       543B                     BASENT:
00143B 543B 2A74F6          16      LD  HL,(STKTOP)
00143E 543E 3A40F3          13      LD  A,(REBOOT)
001441 5441 C6FF             7      ADD A,0FFH
001443 5443 3811            12      JR  C,REBOOT1
001445 5445 21BD54          10      LD  HL,AUTOEXEC
001448 5448 11F8F2          10      LD  DE,FDRV
00144B 544B 010C00          10      LD  BC,1+8+3
00144E 544E EDB0                    LDIR
001450 5450 CD764D          17      CALL    ROM_OPEN
001453 5453 D4E146          17      CALL    NC,ROM_LOAD1
       5456                     REBOOT1:
001456 5456 21C954          10      LD  HL,CMD_RUN
001459 5459 111FF4          10      LD  DE,KBUF
00145C 545C 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
00145F 545F D5              11      PUSH    DE
001460 5460 EDB0                    LDIR
001462 5462 3004            12      JR  NC,REBOOT2
001464 5464 AF               4      XOR A
001465 5465 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       5468                     REBOOT2:
001468 5468 E1              10      POP HL
001469 5469 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00146D 546D DD210146        14      LD  IX,NEWSTT
001471 5471 C31C00          10      JP  _CALSLT
                                
       5474                     GETSLT:
001474 5474 3A22FB          13      LD  A,(DRVTBL+1)
001477 5477 C9              10      RET
                                
       5478                     GET_DISK_BANK_FDRV:
001478 5478 3AF8F2          13      LD  A,(FDRV)
00147B 547B D601             7      SUB 1
00147D 547D 3003            12      JR  NC,GET_DISK_BANK
00147F 547F 3AEAF2          13      LD  A,(_DVSW)
       5482                     GET_DISK_BANK:
001482 5482 FE07             7      CP  7       ;H:
001484 5484 2801            12      JR  Z,SET_DISK_BANK_A
001486 5486 B7               4      OR  A       ;A=DRIVE
       5487                     SET_DISK_BANK_A:
001487 5487 3E01             7      LD  A,DISK_BANK
001489 5489 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
00148B 548B 3AE9F2          13      LD  A,(B_DRIVE)
                                #endif
       548E                     SET_DISK_BANK:
                                #if exists USE_MORMAL32K_OR_ASCII16
00148E 548E 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
001491 5491 F5              11      PUSH    AF
001492 5492 E5              11      PUSH    HL
001493 5493 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
001496 5496 22C8F2          16      LD  (SECSZ),HL
001499 5499 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
00149C 549C CDA554          17      CALL    MUL_AHL
00149F 549F 22C6F2          16      LD  (CLSZ),HL
0014A2 54A2 E1              10      POP HL
0014A3 54A3 F1              10      POP AF
0014A4 54A4 C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       54A5                     MUL_AHL:
0014A5 54A5 37               4      SCF     ;無限ループ回避
       54A6                     MUL_AHL1:
0014A6 54A6 1F               4      RRA     ;->CF
0014A7 54A7 D8              11      RET C
0014A8 54A8 29              11      ADD HL,HL
0014A9 54A9 18FB            12      JR  MUL_AHL1
                                
       54AB                     DPB2DD:
0014AB 54AB F9                      DB  0F9H    ;MEDIA
0014AC 54AC 0002                    DW  00200H  ;SECSIZ
0014AE 54AE 0F                      DB  00FH    ;DIRMSK
0014AF 54AF 04                      DB  004H    ;DIRSHFT
0014B0 54B0 01                      DB  001H    ;CLUSMSK
0014B1 54B1 02                      DB  002H    ;CLUSSHFT
0014B2 54B2 0100                    DW  00001H  ;FIRFAT
0014B4 54B4 02                      DB  002H    ;FATCNT
0014B5 54B5 70                      DB  070H    ;MAXENT
0014B6 54B6 0E00                    DW  0000EH  ;FIRREC
0014B8 54B8 CA02                    DW  002CAH  ;MAXCLUS
0014BA 54BA 03                      DB  003H    ;FATSIZ
0014BB 54BB 0700                    DW  0007H   ;FIRDIR
       54BD                     DPB2DD_E:
                                
       54BD                     AUTOEXEC:
0014BD 54BD 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       54C9                     CMD_RUN:
0014C9 54C9 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
                                #if exists USE_MORMAL32K_OR_ASCII16
0014CF 54CF 80F2                    DW  0F280H
                                #else
                                    DW  0F240H
                                #endif
       54D1                     CMD_CLEAR_E:
0014D1 54D1 3A8A00                  DB  03AH,08AH,0         ;RUN
       54D4                     CMD_RUN_E:
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       54D4                     POP_HL_ERROR:
0014D4 54D4 E1              10      POP     HL
       54D5                     _ERROR:
0014D5 54D5 0600             7      LD  B,0
0014D7 54D7 A7               4      AND A
0014D8 54D8 C9              10      RET
                                
       54D9                     ROM_BDOS:
0014D9 54D9 E5              11      PUSH    HL
0014DA 54DA 79               4      LD  A,C
0014DB 54DB 87               4      ADD A,A
0014DC 54DC 38F7            12      JR  C,_ERROR
0014DE 54DE 6F               4      LD  L,A
0014DF 54DF 265F             7      LD  H,high STABLE
0014E1 54E1 7E               7      LD  A,(HL)
0014E2 54E2 2C               4      INC L
0014E3 54E3 66               7      LD  H,(HL)
0014E4 54E4 6F               4      LD  L,A
0014E5 54E5 E3              19      EX  (SP),HL
0014E6 54E6 79               4      LD  A,C
0014E7 54E7 C9              10      RET
                                
       54E8                     _PRINT:
       54E8                     PRINT:
0014E8 54E8 7B               4      LD  A,E
0014E9 54E9 1803            12      JR  MSG_A
                                
       54EB                     _SYS01:     ;(BDOS)コンソール入力
0014EB 54EB CD6255          17      CALL    _SYS07
       54EE                     MSG_A:
0014EE 54EE FE03             7      CP  3
0014F0 54F0 2814            12      JR  Z,MSG_BR
       54F2                     MSGA1:
0014F2 54F2 F5              11      PUSH    AF
0014F3 54F3 C5              11      PUSH    BC
0014F4 54F4 D5              11      PUSH    DE
0014F5 54F5 E5              11      PUSH    HL
0014F6 54F6 DDE5            15      PUSH    IX
0014F8 54F8 DD21A200        14      LD  IX,CHPUT
0014FC 54FC CD0144          17      CALL    CALSLT_R
0014FF 54FF DDE1            14      POP IX
001501 5501 E1              10      POP HL
001502 5502 D1              10      POP DE
001503 5503 C1              10      POP BC
       5504                     MSGA2:
001504 5504 F1              10      POP AF
001505 5505 C9              10      RET
       5506                     MSG_BR:
001506 5506 F5              11      PUSH    AF
001507 5507 3ADDF3          13      LD  A,(CSRX)
00150A 550A FE02             7      CP  2
00150C 550C 38F6            12      JR  C,MSGA2
00150E 550E F1              10      POP AF
       550F                     MSG_CR:
00150F 550F F5              11      PUSH    AF
001510 5510 3E0D             7      LD  A,00DH
001512 5512 CDF254          17      CALL    MSGA1
001515 5515 3E0A             7      LD  A,00AH
001517 5517 CDF254          17      CALL    MSGA1
00151A 551A F1              10      POP AF
00151B 551B C9              10      RET
                                
       551C                     _SYS02:     ;(BDOS)コンソール出力
00151C 551C CD3755          17      CALL    BREAK
00151F 551F 1805            12      JR  PRINTX
                                
       5521                     _SYS06:     ;(BDOS)コンソール直接入出力
001521 5521 7B               4      LD  A,E
001522 5522 3C               4      INC A
001523 5523 CA7655          10      JP  Z,_INKEY
       5526                     PRINTX:
001526 5526 C3E854          10      JP  _PRINT
                                
       5529                     _SYS08:     ;(BDOS)エコーなしコンソール入力
001529 5529 CD6255          17      CALL    _SYS07
00152C 552C FE03             7      CP  3
00152E 552E CC3755          17      CALL    Z,_BREAK
001531 5531 FE13             7      CP  013H        ;CTRL+S
001533 5533 C0              11      RET NZ
       5534                     PAUSE:
001534 5534 CD4E55          17      CALL    KEYBC
                                
       5537                     _BREAK:
       5537                     BREAK:
001537 5537 F5              11      PUSH    AF
001538 5538 C5              11      PUSH    BC
001539 5539 D5              11      PUSH    DE
00153A 553A E5              11      PUSH    HL
00153B 553B DDE5            15      PUSH    IX
00153D 553D DD21B700        14      LD  IX,BREAKX
001541 5541 CD0144          17      CALL    CALSLT_R
001544 5544 DDE1            14      POP IX
001546 5546 E1              10      POP HL
001547 5547 D1              10      POP DE
001548 5548 C1              10      POP BC
001549 5549 DC3755          17      CALL    C,_BREAK
00154C 554C F1              10      POP AF
00154D 554D C9              10      RET
       554E                     KEYBC:
00154E 554E F5              11      PUSH    AF
00154F 554F C5              11      PUSH    BC
001550 5550 D5              11      PUSH    DE
001551 5551 E5              11      PUSH    HL
001552 5552 DDE5            15      PUSH    IX
001554 5554 DD215601        14      LD  IX,KILBUF
001558 5558 CD0144          17      CALL    CALSLT_R
00155B 555B DDE1            14      POP IX
00155D 555D E1              10      POP HL
00155E 555E D1              10      POP DE
00155F 555F C1              10      POP BC
001560 5560 F1              10      POP AF
001561 5561 C9              10      RET
                                
       5562                     _SYS07:
       5562                     FLGET:
001562 5562 C5              11      PUSH    BC
001563 5563 D5              11      PUSH    DE
001564 5564 E5              11      PUSH    HL
001565 5565 DDE5            15      PUSH    IX
001567 5567 DD219F00        14      LD  IX,CHGET
00156B 556B CD0144          17      CALL    CALSLT_R
00156E 556E DDE1            14      POP IX
001570 5570 E1              10      POP HL
001571 5571 D1              10      POP DE
001572 5572 C1              10      POP BC
001573 5573 FE03             7      CP  3
001575 5575 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       5576                     _INKEY:
       5576                     INKEY:
001576 5576 CD1056          17      CALL    CPM_CONST
001579 5579 C8              11      RET Z
00157A 557A 18E6            12      JR  FLGET
                                
       557C                     _SYS0A:     ;(BDOS)文字列入力
00157C 557C C5              11      PUSH    BC
00157D 557D E5              11      PUSH    HL
00157E 557E D5              11      PUSH    DE
00157F 557F CDA855          17      CALL    GETL
001582 5582 111FF4          10      LD  DE,KBUF
001585 5585 E1              10      POP HL
001586 5586 E5              11      PUSH    HL
001587 5587 0E00             7      LD  C,0
001589 5589 3004            12      JR  NC,SAX0
00158B 558B 23               6      INC HL
00158C 558C 23               6      INC HL
00158D 558D 1808            12      JR  SAX4
       558F                     SAX0:
00158F 558F 46               7      LD  B,(HL)
001590 5590 23               6      INC HL
       5591                     SAX1:
001591 5591 23               6      INC HL
001592 5592 1A               7      LD  A,(DE)
001593 5593 13               6      INC DE
001594 5594 B7               4      OR  A
001595 5595 2004            12      JR  NZ,SAX2
       5597                     SAX4:
001597 5597 360D            10      LD  (HL),00DH
001599 5599 1804            12      JR  SAX3
       559B                     SAX2:
00159B 559B 77               7      LD  (HL),A
00159C 559C 0C               4      INC C
00159D 559D 10F2            13      DJNZ    SAX1
       559F                     SAX3:
00159F 559F D1              10      POP DE
0015A0 55A0 79               4      LD  A,C
0015A1 55A1 13               6      INC DE
0015A2 55A2 12               7      LD  (DE),A
0015A3 55A3 1B               6      DEC DE
0015A4 55A4 E1              10      POP HL
0015A5 55A5 C1              10      POP BC
0015A6 55A6 A7               4      AND A
0015A7 55A7 C9              10      RET
       55A8                     GETL:
0015A8 55A8 DDE5            15      PUSH    IX
0015AA 55AA FDE5            15      PUSH    IY
                                
0015AC 55AC 2ADCF3          16      LD  HL,(CSRY)
0015AF 55AF 22CAFB          16      LD  (FSTPOS),HL
       55B2                     GETL1:
0015B2 55B2 CD2955          17      CALL    _SYS08
0015B5 55B5 FE09             7      CP  9
0015B7 55B7 2008            12      JR  NZ,GETL1V
0015B9 55B9 211FF4          10      LD  HL,KBUF
0015BC 55BC CD9844          17      CALL    MSX
0015BF 55BF 18F1            12      JR  GETL1
       55C1                     GETL1V:
0015C1 55C1 5F               4      LD  E,A
0015C2 55C2 FE08             7      CP  8
0015C4 55C4 CC5E56          17      CALL    Z,CTRL02
0015C7 55C7 FE20             7      CP  020H
0015C9 55C9 D48A56          17      CALL    NC,INSERT
0015CC 55CC CDF254          17      CALL    MSGA1
                                
0015CF 55CF 7B               4      LD  A,E
0015D0 55D0 FE0D             7      CP  00DH
0015D2 55D2 20DE            12      JR  NZ,GETL1
                                
0015D4 55D4 111FF4          10      LD  DE,KBUF
0015D7 55D7 3AB0F3          13      LD  A,(LINLEN)
0015DA 55DA 47               4      LD  B,A
0015DB 55DB CD6B58          17      CALL    ZERO_MEMORY_DE
                                
0015DE 55DE 2ACAFB          16      LD  HL,(FSTPOS)
0015E1 55E1 3ADCF3          13      LD  A,(CSRY)
0015E4 55E4 6F               4      LD  L,A
0015E5 55E5 E5              11      PUSH    HL
0015E6 55E6 CDBB56          17      CALL    LOC0
0015E9 55E9 4D               4      LD  C,L
0015EA 55EA 44               4      LD  B,H
0015EB 55EB E1              10      POP HL
0015EC 55EC 3AB0F3          13      LD  A,(LINLEN)
0015EF 55EF 94               4      SUB H
0015F0 55F0 3D               4      DEC A
0015F1 55F1 5F               4      LD  E,A
0015F2 55F2 211FF4          10      LD  HL,KBUF
       55F5                     GETL2:
0015F5 55F5 CD4E56          17      CALL    _SCRN
0015F8 55F8 03               6      INC BC
0015F9 55F9 77               7      LD  (HL),A
0015FA 55FA 23               6      INC HL
0015FB 55FB 1D               4      DEC E
0015FC 55FC 20F7            12      JR  NZ,GETL2
0015FE 55FE CD0F55          17      CALL    MSG_CR
                                
001601 5601 FDE1            14      POP IY
001603 5603 DDE1            14      POP IX
       5605                     GETL3:
001605 5605 2B               6      DEC HL
001606 5606 7E               7      LD  A,(HL)
001607 5607 FE21             7      CP  021H
001609 5609 D0              11      RET NC
00160A 560A 3600            10      LD  (HL),0
00160C 560C 15               4      DEC D
00160D 560D 20F6            12      JR  NZ,GETL3
00160F 560F C9              10      RET
                                
       5610                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       5610                     CONSTX:
       5610                     CPM_CONST:
001610 5610 C5              11      PUSH    BC
001611 5611 D5              11      PUSH    DE
001612 5612 E5              11      PUSH    HL
001613 5613 DDE5            15      PUSH    IX
001615 5615 DD219C00        14      LD  IX,CHSNS
001619 5619 CD0144          17      CALL    CALSLT_R
00161C 561C DDE1            14      POP IX
00161E 561E E1              10      POP HL
00161F 561F D1              10      POP DE
001620 5620 C1              10      POP BC
001621 5621 C9              10      RET
                                
       5622                     _SYS2A:     ;(BDOS)日付の獲得
001622 5622 AF               4      XOR A
001623 5623 57               4      LD  D,A
001624 5624 5F               4      LD  E,A
001625 5625 67               4      LD  H,A
001626 5626 6F               4      LD  L,A
001627 5627 C9              10      RET
                                
       5628                     _SYS2C:     ;(BDOS)時刻の獲得
001628 5628 AF               4      XOR A
001629 5629 57               4      LD  D,A
00162A 562A 5F               4      LD  E,A
00162B 562B 67               4      LD  H,A
00162C 562C 6F               4      LD  L,A
00162D 562D C9              10      RET
                                
       562E                     POS:
00162E 562E F5              11      PUSH    AF
00162F 562F 2ADCF3          16      LD  HL,(CSRY)
001632 5632 7D               4      LD  A,L
001633 5633 6C               4      LD  L,H
001634 5634 67               4      LD  H,A
001635 5635 2C               4      INC L
001636 5636 24               4      INC H
001637 5637 F1              10      POP AF
001638 5638 C9              10      RET
                                
       5639                     LOC:
001639 5639 F5              11      PUSH    AF
00163A 563A E5              11      PUSH    HL
00163B 563B 7D               4      LD  A,L
00163C 563C 6C               4      LD  L,H
00163D 563D 67               4      LD  H,A
00163E 563E 2D               4      DEC L
00163F 563F 25               4      DEC H
001640 5640 DDE5            15      PUSH    IX
001642 5642 DD21C600        14      LD  IX,POSIT
001646 5646 CD0144          17      CALL    CALSLT_R
001649 5649 DDE1            14      POP IX
00164B 564B E1              10      POP HL
00164C 564C F1              10      POP AF
00164D 564D C9              10      RET
                                
       564E                     _SCRN:
       564E                     SCRN:
00164E 564E E5              11      PUSH    HL
00164F 564F DDE5            15      PUSH    IX
                                
001651 5651 69               4      LD  L,C
001652 5652 60               4      LD  H,B
001653 5653 DD214A00        14      LD  IX,RDVRM
001657 5657 CD0144          17      CALL    CALSLT_R
                                
00165A 565A DDE1            14      POP IX
00165C 565C E1              10      POP HL
00165D 565D C9              10      RET
                                
       565E                     CTRL02:
00165E 565E F5              11      PUSH    AF
00165F 565F D5              11      PUSH    DE
001660 5660 2ADCF3          16      LD  HL,(CSRY)
001663 5663 3AB0F3          13      LD  A,(LINLEN)
001666 5666 4F               4      LD  C,A
001667 5667 94               4      SUB H   ;CSRX
001668 5668 C602             7      ADD A,2
00166A 566A 47               4      LD  B,A ;カーソルより右の文字数
00166B 566B 61               4      LD  H,C ;LINLEN
00166C 566C C5              11      PUSH    BC
00166D 566D CDBB56          17      CALL    LOC0
001670 5670 C1              10      POP BC
                                
001671 5671 1620             7      LD  D,020H
       5673                     C8X1:
001673 5673 DD214A00        14      LD  IX,RDVRM
001677 5677 CD0144          17      CALL    CALSLT_R
00167A 567A 4F               4      LD  C,A
00167B 567B 7A               4      LD  A,D
00167C 567C DD214D00        14      LD  IX,WRTVRM
001680 5680 CD0144          17      CALL    CALSLT_R
001683 5683 2B               6      DEC HL
001684 5684 51               4      LD  D,C
001685 5685 10EC            13      DJNZ    C8X1
001687 5687 D1              10      POP DE
001688 5688 F1              10      POP AF
001689 5689 C9              10      RET
                                
       568A                     INSERT:
00168A 568A F5              11      PUSH    AF
00168B 568B D5              11      PUSH    DE
00168C 568C 2ADCF3          16      LD  HL,(CSRY)
00168F 568F 3AB0F3          13      LD  A,(LINLEN)
001692 5692 4F               4      LD  C,A
001693 5693 94               4      SUB H   ;CSRX
001694 5694 3C               4      INC A
001695 5695 47               4      LD  B,A ;カーソルより右の文字数
001696 5696 C5              11      PUSH    BC
001697 5697 CDBB56          17      CALL    LOC0
00169A 569A C1              10      POP BC
                                
00169B 569B 1620             7      LD  D,020H
       569D                     INS1:
00169D 569D DD214A00        14      LD  IX,RDVRM
0016A1 56A1 CD0144          17      CALL    CALSLT_R
0016A4 56A4 4F               4      LD  C,A
0016A5 56A5 7A               4      LD  A,D
0016A6 56A6 DD214D00        14      LD  IX,WRTVRM
0016AA 56AA CD0144          17      CALL    CALSLT_R
0016AD 56AD 23               6      INC HL
0016AE 56AE 51               4      LD  D,C
0016AF 56AF 10EC            13      DJNZ    INS1
0016B1 56B1 D1              10      POP DE
0016B2 56B2 F1              10      POP AF
0016B3 56B3 C9              10      RET
                                
       56B4                     CONOUT1:
0016B4 56B4 59               4      LD  E,C
0016B5 56B5 C3E854          10      JP  _PRINT
                                
       56B8                     GETVRAM:
0016B8 56B8 2ADCF3          16      LD  HL,(CSRY)
       56BB                     LOC0:
0016BB 56BB 2D               4      DEC L
0016BC 56BC 25               4      DEC H
0016BD 56BD 4C               4      LD  C,H ;CSRX-1
0016BE 56BE 5D               4      LD  E,L ;CSRY-1
       56BF                     LOC1:
0016BF 56BF 3AB0F3          13      LD  A,(LINLEN)
0016C2 56C2 67               4      LD  H,A
0016C3 56C3 1600             7      LD  D,0
0016C5 56C5 6A               4      LD  L,D ;0
0016C6 56C6 0608             7      LD  B,8
       56C8                     LOC2:
0016C8 56C8 29              11      ADD HL,HL
0016C9 56C9 3001            12      JR  NC,LOC3
0016CB 56CB 19              11      ADD HL,DE
       56CC                     LOC3:
0016CC 56CC 10FA            13      DJNZ    LOC2
0016CE 56CE 09              11      ADD HL,BC
0016CF 56CF C9              10      RET
                                
       56D0                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0016D0 56D0 212200          10      LD  HL,00022H
0016D3 56D3 AF               4      XOR A
0016D4 56D4 7D               4      LD  A,L
0016D5 56D5 C9              10      RET
                                
       56D6                     _SYS0D:     ;(BDOS)ディスク・リセット
0016D6 56D6 218000          10      LD  HL,00080H
0016D9 56D9 22D4F2          16      LD  (_DTA),HL
0016DC 56DC C9              10      RET
                                
       56DD                     _SYS0E:     ;(BDOS)カレントドライブの設定
0016DD 56DD 7B               4      LD  A,E
       56DE                     _SYS0EX1:
0016DE 56DE FE08             7      CP  8
0016E0 56E0 3F               4      CCF
0016E1 56E1 D8              11      RET C
0016E2 56E2 32EAF2          13      LD  (_DVSW),A
0016E5 56E5 C9              10      RET
                                
       56E6                     _SYS0F:     ;(BDOS)ファイルのオープン
0016E6 56E6 D5              11      PUSH    DE
0016E7 56E7 FDE1            14      POP IY
0016E9 56E9 CD5558          17      CALL    INIT_FILE
0016EC 56EC CD764D          17      CALL    ROM_OPEN
0016EF 56EF 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
0016F1 56F1 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
0016F5 56F5 FDE5            15      PUSH    IY
0016F7 56F7 D1              10      POP DE
0016F8 56F8 13               6      INC DE
0016F9 56F9 010B00          10      LD  BC,11
0016FC 56FC EDB0                    LDIR
                                ;               Attribute
0016FE 56FE 7E               7      LD  A,(HL)
0016FF 56FF FD770D          19      LD  (IY+13),A
                                ;               TIME
001702 5702 110B00          10      LD  DE,11
001705 5705 19              11      ADD HL,DE
001706 5706 7E               7      LD  A,(HL)
001707 5707 23               6      INC HL
001708 5708 FD7716          19      LD  (IY+22),A
00170B 570B 7E               7      LD  A,(HL)
00170C 570C 23               6      INC HL
00170D 570D FD7717          19      LD  (IY+23),A
                                ;               DATE
001710 5710 7E               7      LD  A,(HL)
001711 5711 23               6      INC HL
001712 5712 FD7714          19      LD  (IY+20),A
001715 5715 7E               7      LD  A,(HL)
001716 5716 23               6      INC HL
001717 5717 FD7715          19      LD  (IY+21),A
                                ;               First cluster
00171A 571A 7E               7      LD  A,(HL)
00171B 571B 23               6      INC HL
00171C 571C FD771A          19      LD  (IY+26),A
00171F 571F 7E               7      LD  A,(HL)
001720 5720 23               6      INC HL
001721 5721 FD771B          19      LD  (IY+27),A
                                ;               SIZE
001724 5724 7E               7      LD  A,(HL)
001725 5725 23               6      INC HL
001726 5726 FD7710          19      LD  (IY+16),A
001729 5729 7E               7      LD  A,(HL)
00172A 572A 23               6      INC HL
00172B 572B FD7711          19      LD  (IY+17),A
00172E 572E 7E               7      LD  A,(HL)
00172F 572F 23               6      INC HL
001730 5730 FD7712          19      LD  (IY+18),A
001733 5733 7E               7      LD  A,(HL)
001734 5734 FD7713          19      LD  (IY+19),A
001737 5737 AF               4      XOR A
001738 5738 FD770C          19      LD  (IY+12),A
00173B 573B C9              10      RET
                                
       573C                     _SYS10:     ;(BDOS)ファイルのクローズ
00173C 573C AF               4      XOR A
00173D 573D C9              10      RET
                                
       573E                     S11X1:
00173E 573E FD7119          19      LD  (IY+25),C       ;RootEntCnt
001741 5741 FD750E          19      LD  (IY+14),L
001744 5744 FD740F          19      LD  (IY+15),H
       5747                     SCF_FF_RET:
001747 5747 37               4      SCF
001748 5748 9F               4      SBC A,A
001749 5749 C9              10      RET
                                
       574A                     _SYS11:     ;(BDOS)最初のファイルの検索
00174A 574A ED53D7F2        20      LD  (_FCB),DE
00174E 574E D5              11      PUSH    DE
00174F 574F FDE1            14      POP IY
001751 5751 CD5558          17      CALL    INIT_FILE
001754 5754 CDD24F          17      CALL    GET_DIR_DAT
       5757                     S12X1:
001757 5757 CD924D          17      CALL    FILESE
00175A 575A 30E2            12      JR  NC,S11X1
00175C 575C 0D               4      DEC C
00175D 575D FD7119          19      LD  (IY+25),C       ;RootEntCnt
001760 5760 FDCB0D66        20      BIT 4,(IY+13)
001764 5764 2809            12      JR  Z,S12X2
001766 5766 E5              11      PUSH    HL
001767 5767 DDE1            14      POP IX
001769 5769 DDCB0E66        20      BIT 4,(IX+1+13)
00176D 576D 28E8            12      JR  Z,S12X1
       576F                     S12X2:
00176F 576F 012000          10      LD  BC,32
001772 5772 ED5BD4F2        20      LD  DE,(_DTA)
001776 5776 AF               4      XOR A
001777 5777 12               7      LD  (DE),A      ;ドライブ番号
001778 5778 13               6      INC DE
001779 5779 EDB0                    LDIR            ;ディレクトリエントリ
00177B 577B FD750E          19      LD  (IY+14),L
00177E 577E FD740F          19      LD  (IY+15),H
001781 5781 C9              10      RET
                                
       5782                     _SYS12:
001782 5782 FD2AD7F2        20      LD  IY,(_FCB)
001786 5786 FDE5            15      PUSH    IY
001788 5788 D1              10      POP DE
001789 5789 CD5558          17      CALL    INIT_FILE
                                
00178C 578C FD6E0E          19      LD  L,(IY+14)
00178F 578F FD660F          19      LD  H,(IY+15)
001792 5792 FD4E19          19      LD  C,(IY+25)
001795 5795 18C0            12      JR  S12X1
                                
       5797                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
001797 5797 CDB84F          17      CALL    SET_FCB
00179A 579A CD864F          17      CALL    GETSEQ
00179D 579D CD734F          17      CALL    RB_READ
0017A0 57A0 E5              11      PUSH    HL
0017A1 57A1 CD934F          17      CALL    SETSEQ
0017A4 57A4 E1              10      POP HL
       57A5                     SREAD:
0017A5 57A5 C601             7      ADD A,001H
0017A7 57A7 D8              11      RET C
                                
0017A8 57A8 7D               4      LD  A,L
0017A9 57A9 D601             7      SUB 001H
0017AB 57AB 9F               4      SBC A,A
0017AC 57AC E603             7      AND 3
0017AE 57AE 1F               4      RRA
0017AF 57AF C9              10      RET
                                
       57B0                     _SYS18:     ;(BDOS)ログインベクトルの獲得
0017B0 57B0 218300          10      LD  HL,00083H
0017B3 57B3 AF               4      XOR A
0017B4 57B4 C9              10      RET
                                
       57B5                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
0017B5 57B5 3AEAF2          13      LD  A,(_DVSW)
0017B8 57B8 A7               4      AND A
0017B9 57B9 C9              10      RET
                                
       57BA                     _SYS1A:     ;(BDOS)DTAの設定
0017BA 57BA ED53D4F2        20      LD  (_DTA),DE
0017BE 57BE AF               4      XOR A
0017BF 57BF C9              10      RET
                                
       57C0                     _SYS1B:     ;(BDOS)ディスク情報の獲得
0017C0 57C0 010002          10      LD  BC,512
0017C3 57C3 11C302          10      LD  DE,707
0017C6 57C6 210000          10      LD  HL,0
0017C9 57C9 DD21D9F2        14      LD  IX,_BUF
0017CD 57CD FD21D9F2        14      LD  IY,_BUF
0017D1 57D1 FD3600F9        19      LD  (IY+0),0F9H
0017D5 57D5 3E02             7      LD  A,2
0017D7 57D7 C9              10      RET
                                
       57D8                     _SYS21:     ;(BDOS)ランダムな読み出し
0017D8 57D8 CDB84F          17      CALL    SET_FCB
                                
0017DB 57DB FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0017DE 57DE FD6622          19      LD  H,(IY+34)
                                
0017E1 57E1 CD734F          17      CALL    RB_READ
0017E4 57E4 18BF            12      JR  SREAD
                                
       57E6                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
0017E6 57E6 CDE656          17      CALL    _SYS0F
0017E9 57E9 D8              11      RET C
                                
0017EA 57EA D5              11      PUSH    DE      ;EX DE,IY
0017EB 57EB FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0017ED 57ED CDA84F          17      CALL    GETSIZE
       57F0                     _S24X1:
0017F0 57F0 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
0017F3 57F3 FD7422          19      LD  (IY+34),H
0017F6 57F6 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
0017FA 57FA FDE3            23      EX  (SP),IY     ;
0017FC 57FC D1              10      POP DE      ;
                                
0017FD 57FD AF               4      XOR A
0017FE 57FE C9              10      RET
                                
       57FF                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
0017FF 57FF E5              11      PUSH    HL
001800 5800 D5              11      PUSH    DE      ;EX DE,IY
001801 5801 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001803 5803 CD864F          17      CALL    GETSEQ
001806 5806 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       5808                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001808 5808 CDB84F          17      CALL    SET_FCB
00180B 580B E5              11      PUSH    HL
00180C 580C FD6E21          19      LD  L,(IY+33)
00180F 580F FD6622          19      LD  H,(IY+34)
001812 5812 22CAF2          16      LD  (RR_LOW),HL
001815 5815 FD6E23          19      LD  L,(IY+35)
001818 5818 FD6624          19      LD  H,(IY+36)
00181B 581B 22CCF2          16      LD  (RR_HIGH),HL
00181E 581E E1              10      POP HL
00181F 581F CD434B          17      CALL    ROM_READ
001822 5822 ED5BCAF2        20      LD  DE,(RR_LOW)
001826 5826 FD7321          19      LD  (IY+33),E
001829 5829 FD7222          19      LD  (IY+34),D
00182C 582C ED5BCCF2        20      LD  DE,(RR_HIGH)
001830 5830 FD7323          19      LD  (IY+35),E
001833 5833 FD7224          19      LD  (IY+36),D
001836 5836 9F               4      SBC A,A
001837 5837 C9              10      RET
                                
       5838                     _SYS2F:
001838 5838 44               4      LD  B,H
001839 5839 2AD4F2          16      LD  HL,(_DTA)
00183C 583C C3A552          10      JP  DISKIO
                                
       583F                     _SYS5A:
00183F 583F 0600             7      LD  B,0
001841 5841 D5              11      PUSH    DE
001842 5842 DDE1            14      POP IX
       5844                     _SX5A1:
001844 5844 1A               7      LD  A,(DE)
001845 5845 B7               4      OR  A
001846 5846 2804            12      JR  Z,_SX5A2
001848 5848 13               6      INC DE
001849 5849 04               4      INC B
00184A 584A 18F8            12      JR  _SX5A1
                                
       584C                     _SX5A2:
00184C 584C 78               4      LD  A,B
00184D 584D CD0E4C          17      CALL    FILE_BDOS
001850 5850 CD7250          17      CALL    ROM_CD
001853 5853 9F               4      SBC A,A
001854 5854 C9              10      RET
                                
       5855                     INIT_FILE:
001855 5855 EB               4      EX  DE,HL
001856 5856 11F8F2          10      LD  DE,FDRV
001859 5859 010C00          10      LD  BC,1+8+3
       585C                     INIT_FILE1:
00185C 585C EDB0                    LDIR
00185E 585E CD7854          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_MORMAL32K_OR_ASCII16
001861 5861 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
001864 5864 2AEBF2          16      LD  HL,(_CD)
001867 5867 22F6F2          16      LD  (_CDX),HL           ;カレントディレクトリ
00186A 586A C9              10      RET
                                
       586B                     ZERO_MEMORY_DE:
00186B 586B AF               4      XOR A
       586C                     FILL_MEMORY_DE:
00186C 586C 12               7      LD  (DE),A
00186D 586D 13               6      INC DE
00186E 586E 10FC            13      DJNZ    FILL_MEMORY_DE
001870 5870 C9              10      RET
                                
001871 5871                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 D554EB541C55D554        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 D554D55421556255        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 2955D5547C551056        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 D056D656DD56E656        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 3C574A578257D554        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 9757D554D554D554        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 B057B557BA57C057        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 D554D554D554E657        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 FF57D554D5540858        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 D554D5542256D554        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 2856D554D5543858        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 D554D5543F58D554        DW  _ERROR,_ERROR,_SYS5A,_ERROR
001FB8 5FB8 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 D554D554D554D554        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
[EOF:DISKROM32.ASM:UTF_8]
