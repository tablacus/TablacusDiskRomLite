                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       42B2                     CRUNCH  EQU 042B2H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
                                ;PTRFIL EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
                                ;FILNAM EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
                                ;RSTMP  EQU 0FB03H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FEDA                     H_STKE  EQU 0FEDAH
                                
       FF43                     H_GONE  EQU 0FF43H
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;KONAMI-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                
       F0E9                     ISC EQU 0F0E9H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
[EOF:DEF.ASM:UTF_8]
                                
       0001                     USE_NORMAL_32K_ROM      EQU 1   ;ノーマル32KB ROMを作成する
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C3694D          10      JP  DISKIO
000013 4013 C3A34D          10      JP  DSKCHG
000016 4016 C3F94D          10      JP  GETDPB
000019 4019 C3EC4E          10      JP  CHOICE
00001C 401C C3F04E          10      JP  DSKFMT
00001F 401F C3F24E          10      JP  DSKSTP
000022 4022 C3F34E          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C3F04E          10      JP  DSKFMT
000029 4029 C3F24E          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3FA4E          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.1.5.0",0
            204449534B20524F    
            4D204C6974652076    
            302E312E352E3000    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 0180FF          10      LD  BC,-00080H
000109 4109 2A72F6          16      LD  HL,(MEMSIZ)
00010C 410C 09              11      ADD HL,BC
00010D 410D 2272F6          16      LD  (MEMSIZ),HL
000110 4110 2A74F6          16      LD  HL,(STKTOP)
000113 4113 09              11      ADD HL,BC
000114 4114 2274F6          16      LD  (STKTOP),HL
000117 4117 2180F0          10      LD  HL,0F080H
00011A 411A 1100F0          10      LD  DE,0F000H
00011D 411D 012000          10      LD  BC,00020H
000120 4120 EDB0                    LDIR
000122 4122 2180FF          10      LD  HL,-00080H
000125 4125 39              11      ADD HL,SP
000126 4126 225FF1          16      LD  (BASSTK),HL
000129 4129 ED7B5FF1        20      LD  SP,(BASSTK)
                                
00012D 412D 3EFF             7      LD  A,0FFH
00012F 412F 3299FD          13      LD  (DEVICE),A
                                
000132 4132 3E01             7      LD  A,1
000134 4134 3221FB          13      LD  (DRVTBL),A
                                
000137 4137 AF               4      XOR A
000138 4138 324AF1          13      LD  (_DVSW),A
                                
00013B 413B 21F342          10      LD  HL,AT_ISC
00013E 413E 11E9F0          10      LD  DE,ISC
000141 4141 017C00          10      LD  BC,ISC_E-ISC
000144 4144 EDB0                    LDIR
                                    
000146 4146 3EC3             7      LD  A,0C3H      ;JP
000148 4148 3243FF          13      LD  (H_GONE),A
00014B 414B 327DF3          13      LD  (BDOS),A
00014E 414E 326BF3          13      LD  (RAMUSE),A
000151 4151 3268F3          13      LD  (ROMUSE),A
000154 4154 21E9F0          10      LD  HL,REPLACE_COMMAND
000157 4157 2244FF          16      LD  (H_GONE+1),HL
00015A 415A 2131F3          10      LD  HL,H_BDOS
00015D 415D 227EF3          16      LD  (BDOS+1),HL
000160 4160 2119F1          10      LD  HL,RAMUSE1
000163 4163 226CF3          16      LD  (RAMUSE+1),HL
000166 4166 2114F1          10      LD  HL,ROMUSE1
000169 4169 2269F3          16      LD  (ROMUSE+1),HL
                                
00016C 416C 3E                      DB  03EH
00016D 416D F7              12      RST 30H
00016E 416E 3271FE          13      LD  (H_BINS),A
000171 4171 3276FE          13      LD  (H_BINL),A
000174 4174 327BFE          13      LD  (H_FILE),A
000177 4177 3231F3          13      LD  (H_BDOS),A
00017A 417A 32DAFE          13      LD  (H_STKE),A
00017D 417D 32A7FF          13      LD  (H_PHYD),A
                                
000180 4180 CD3342          17      CALL    GTSL1_
000183 4183 3200F1          13      LD  (ROM_SLT),A
000186 4186 3210F1          13      LD  (ROM_SLT_COPY),A
000189 4189 3272FE          13      LD  (H_BINS+1),A
00018C 418C 3277FE          13      LD  (H_BINL+1),A
00018F 418F 327CFE          13      LD  (H_FILE+1),A
000192 4192 3232F3          13      LD  (H_BDOS+1),A
000195 4195 32DBFE          13      LD  (H_STKE+1),A
000198 4198 32A8FF          13      LD  (H_PHYD+1),A
00019B 419B 3222FB          13      LD  (DRVTBL+1),A
00019E 419E 3248F3          13      LD  (MASTERS),A
                                
0001A1 41A1 219A45          10      LD  HL,ROM_LOAD
0001A4 41A4 2273FE          16      LD  (H_BINS+2),HL
0001A7 41A7 21B546          10      LD  HL,ROM_RUN
0001AA 41AA 2278FE          16      LD  (H_BINL+2),HL
0001AD 41AD 21C246          10      LD  HL,ROM_FILES
0001B0 41B0 227DFE          16      LD  (H_FILE+2),HL
0001B3 41B3 21464F          10      LD  HL,ROM_BDOS
0001B6 41B6 2233F3          16      LD  (H_BDOS+2),HL
0001B9 41B9 219943          10      LD  HL,ROM_STKE
0001BC 41BC 22DCFE          16      LD  (H_STKE+2),HL
0001BF 41BF 21694D          10      LD  HL,DISKIO
0001C2 41C2 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001C5 41C5 3E                      DB  03EH
0001C6 41C6 C9              10      RET
0001C7 41C7 327FFE          13      LD  (H_FILE+4),A
0001CA 41CA 3275FE          13      LD  (H_BINS+4),A
0001CD 41CD 327AFE          13      LD  (H_BINL+4),A
0001D0 41D0 3235F3          13      LD  (H_BDOS+4),A
0001D3 41D3 32DEFE          13      LD  (H_STKE+4),A
0001D6 41D6 32ABFF          13      LD  (H_PHYD+4),A
                                
                                #if exists USE_NORMAL_32K_ROM
                                #else
                                    XOR A
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  A,(BANK1_ADR)
                                    CP  'A'
                                    JR  NZ,NOT_8K_BANK
                                    LD  A,DISK_BANK
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001D9 41D9 CD3801          17      CALL    RSLREG      ;read primary slot #
0001DC 41DC 07               4      RLCA
0001DD 41DD 07               4      RLCA
0001DE 41DE F5              11      PUSH    AF
0001DF 41DF 1605             7      LD  D,4+1
0001E1 41E1 CD3A42          17      CALL    GTSL2_
0001E4 41E4 3244F3          13      LD  (RAMAD3),A
0001E7 41E7 F1              10      POP AF
0001E8 41E8 07               4      RLCA
0001E9 41E9 07               4      RLCA
0001EA 41EA 1603             7      LD  D,2+1
0001EC 41EC CD3A42          17      CALL    GTSL2_
0001EF 41EF 2680             7      LD  H,080H
0001F1 41F1 CD5742          17      CALL    CHK_RAM
0001F4 41F4 3243F3          13      LD  (RAMAD2),A
       41F7                     RAMCHK2:
0001F7 41F7 3A44F3          13      LD  A,(RAMAD3)
0001FA 41FA 2640             7      LD  H,040H
0001FC 41FC CD5742          17      CALL    CHK_RAM
0001FF 41FF 3242F3          13      LD  (RAMAD1),A
       4202                     RAMCHK1:
000202 4202 3A44F3          13      LD  A,(RAMAD3)
000205 4205 2600             7      LD  H,00H
000207 4207 CD5742          17      CALL    CHK_RAM
00020A 420A 3241F3          13      LD  (RAMAD0),A
       420D                     RAMCHK0:
00020D 420D 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
000210 4210 010F00          10      LD  BC,0000FH       ;切り上げ
000213 4213 09              11      ADD HL,BC
000214 4214 7D               4      LD  A,L
                                
000215 4215 0604             7      LD  B,4
       4217                     B_DRIVE1:
000217 4217 CB3C             8      SRL H
000219 4219 1F               4      RRA
00021A 421A 10FB            13      DJNZ    B_DRIVE1
                                
00021C 421C C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
00021E 421E 3249F1          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
000221 4221 C9              10      RET
                                
       4222                     NOT_8K_BANK:
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K等)
000222 4222 21E743          10      LD  HL,MSG_ERROR_ROM_MODE
000225 4225 CD7243          17      CALL    MSX
000228 4228 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00022C 422C DD219F00        14      LD  IX,CHGET
000230 4230 C31C00          10      JP  _CALSLT
                                
       4233                     GTSL1_:             ;自分のいるスロットを知る
000233 4233 CD3801          17      CALL    RSLREG      ;read primary slot #
000236 4236 0F               4      RRCA
000237 4237 0F               4      RRCA
000238 4238 1601             7      LD  D,1
       423A                     GTSL2_:
00023A 423A E603             7      AND 3       ;[A]=000000PP
00023C 423C 5F               4      LD  E,A     ;[E]=000000PP
00023D 423D 21C1FC          10      LD  HL,EXPTBL
000240 4240 85               4      ADD A,L     ;桁上りは無い
000241 4241 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000242 4242 7B               4      LD  A,E     ;[A]=000000PP
000243 4243 CB7E            13      BIT 7,(HL)
000245 4245 C8              11      RET Z
000246 4246 7D               4      LD  A,L     ;point to SLTTBL entry
000247 4247 C604             7      ADD A,4     ;桁上りは無い
000249 4249 6F               4      LD  L,A
00024A 424A 7E               7      LD  A,(HL)      ;get currently expansion slot register
       424B                     GTSL3_:
00024B 424B 15               4      DEC D
00024C 424C 2803            12      JR  Z,GTSL4_:
00024E 424E 0F               4      RRCA
00024F 424F 18FA            12      JR  GTSL3_:
       4251                     GTSL4_:
000251 4251 E60C             7      AND 00CH        ;[A] = 0000SS00
000253 4253 B3               4      OR  E       ;[A] = 0000SSPP
000254 4254 F680             7      OR  080H        ;[A] = 1000SSPP
000256 4256 C9              10      RET
                                
       4257                     CHK_RAM:
000257 4257 E5              11      PUSH    HL
000258 4258 CDAC42          17      CALL    CHK_RAM0
00025B 425B E1              10      POP HL
00025C 425C C8              11      RET Z
00025D 425D 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000260 4260 E680             7      AND 080H
000262 4262 CD8342          17      CALL    CHK_RAM_SLT
000265 4265 C8              11      RET Z
000266 4266 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000269 4269 E680             7      AND 080H
00026B 426B C601             7      ADD A,1
00026D 426D CD8342          17      CALL    CHK_RAM_SLT
000270 4270 C8              11      RET Z
000271 4271 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000274 4274 E680             7      AND 080H
000276 4276 C602             7      ADD A,2
000278 4278 CD8342          17      CALL    CHK_RAM_SLT
00027B 427B C8              11      RET Z
00027C 427C 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
00027F 427F E680             7      AND 080H
000281 4281 C603             7      ADD A,3
       4283                     CHK_RAM_SLT:
000283 4283 E5              11      PUSH    HL
000284 4284 CDAC42          17      CALL    CHK_RAM0        ;スロット#X or X-0
000287 4287 E1              10      POP HL
000288 4288 C8              11      RET Z
000289 4289 CB79             8      BIT 7,C
00028B 428B 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
00028D 428D 79               4      LD  A,C
00028E 428E C604             7      ADD A,4*1           ;スロット#X-1
000290 4290 E5              11      PUSH    HL
000291 4291 CDAC42          17      CALL    CHK_RAM0
000294 4294 E1              10      POP HL
000295 4295 C8              11      RET Z
000296 4296 79               4      LD  A,C
000297 4297 C608             7      ADD A,4*2           ;スロット#X-2
000299 4299 E5              11      PUSH    HL
00029A 429A CDAC42          17      CALL    CHK_RAM0
00029D 429D E1              10      POP HL
00029E 429E C8              11      RET Z
00029F 429F 79               4      LD  A,C
0002A0 42A0 C60C             7      ADD A,4*3           ;スロット#X-3
0002A2 42A2 E5              11      PUSH    HL
0002A3 42A3 CDAC42          17      CALL    CHK_RAM0
0002A6 42A6 E1              10      POP HL
       42A7                     CHK_RAM_E:
0002A7 42A7 AF               4      XOR A
0002A8 42A8 3C               4      INC A           ;ZF=0にする
0002A9 42A9 3E00             7      LD  A,0
0002AB 42AB C9              10      RET
                                
       42AC                     CHK_RAM0:
0002AC 42AC 4F               4      LD  C,A
0002AD 42AD 3A00F1          13      LD  A,(ROM_SLT)
0002B0 42B0 B9               4      CP  C
0002B1 42B1 28F4            12      JR  Z,CHK_RAM_E
0002B3 42B3 2E00             7      LD  L,0
       42B5                     CHK_RAM1:
0002B5 42B5 79               4      LD  A,C
0002B6 42B6 DD210C00        14      LD  IX,_RDSLT
0002BA 42BA CDE742          17      CALL    CALSLT_R
0002BD 42BD C6E5             7      ADD A,0E5H
0002BF 42BF 47               4      LD  B,A
0002C0 42C0 5F               4      LD  E,A
0002C1 42C1 79               4      LD  A,C
0002C2 42C2 DD211400        14      LD  IX,_WRSLT
0002C6 42C6 CDE742          17      CALL    CALSLT_R
0002C9 42C9 79               4      LD  A,C
0002CA 42CA DD210C00        14      LD  IX,_RDSLT
0002CE 42CE CDE742          17      CALL    CALSLT_R
0002D1 42D1 B8               4      CP  B
0002D2 42D2 C0              11      RET NZ
0002D3 42D3 D6E5             7      SUB 0E5H
0002D5 42D5 79               4      LD  A,C
0002D6 42D6 5F               4      LD  E,A
0002D7 42D7 DD211400        14      LD  IX,_WRSLT
0002DB 42DB CDE742          17      CALL    CALSLT_R
0002DE 42DE 24               4      INC H
0002DF 42DF 7D               4      LD  A,L
0002E0 42E0 C604             7      ADD A,4
0002E2 42E2 6F               4      LD  L,A
0002E3 42E3 20D0            12      JR  NZ,CHK_RAM1
0002E5 42E5 79               4      LD  A,C     ;ZF=1のハズ
0002E6 42E6 C9              10      RET
                                
       42E7                     CALSLT_R:
0002E7 42E7 C5              11      PUSH    BC
0002E8 42E8 E5              11      PUSH    HL
0002E9 42E9 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0002ED 42ED CD1C00          17      CALL    _CALSLT
0002F0 42F0 E1              10      POP HL
0002F1 42F1 C1              10      POP BC
0002F2 42F2 C9              10      RET
                                
       42F3                     AT_ISC:
0002F3 F0E9                         ORG ISC,AT_ISC-RUN
       F0E9                     REPLACE_COMMAND:
0002F3 F0E9 FEB7             7      CP  0B7H            ;FILES
0002F5 F0EB CC7BFE          17      CALL    Z,H_FILE
0002F8 F0EE FEB5             7      CP  0B5H            ;LOAD
0002FA F0F0 CA71FE          10      JP  Z,H_BINS
0002FD F0F3 FE8A             7      CP  08AH            ;RUN
0002FF F0F5 CA76FE          10      JP  Z,H_BINL
000302 F0F8 FED6             7      CP  0D6H            ;COPY
000304 F0FA 2813            12      JR  Z,FIX_COPY
000306 F0FC FECF             7      CP  0CFH            ;BLOAD
000308 F0FE C0              11      RET NZ
       F0FF                     FIX_BLOAD:
000309 F0FF F7              12      RST 30H
       F100                     ROM_SLT:
00030A F100 00                      DB  0
00030B F101 F745                    DW  ROM_BLOAD
00030D F103 F5              11      PUSH    AF
00030E F104 E5              11      PUSH    HL
00030F F105 CD0EF1          17      CALL    BLOAD_RET
       F106                     SWC_BLOAD   EQU $-2
000312 F108 E1              10      POP HL
000313 F109 F1              10      POP AF
000314 F10A FECF             7      CP  0CFH            ;BLOAD
       F10C                     SWC_BLOAD_M:
000316 F10C 28DB            12      JR  Z,REPLACE_COMMAND
       F10E                     BLOAD_RET:
000318 F10E C9              10      RET
       F10F                     FIX_COPY:
000319 F10F F7              12      RST 30H
       F110                     ROM_SLT_COPY:
00031A F110 00                      DB  0
00031B F111 4747                    DW  ROM_COPY
00031D F113 C9              10      RET
       F114                     ROMUSE1:
00031E F114 3A00F1          13      LD  A,(ROM_SLT)
000321 F117 1803            12      JR  ROMUSE2
       F119                     RAMUSE1:
000323 F119 3A42F3          13      LD  A,(RAMAD1)
       F11C                     ROMUSE2:
000326 F11C C32400          10      JP  _ENASLT
                                
       F11F                     _RESULT:
000329 F11F 00                      DB  0
       F120                     _BANK:
00032A F120 00                      DB  0
       F121                     CLSZ:               ;クラスタサイズ
00032B F121 0004                    DW  1024
       F122                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F123                     SECSZ:              ;セクタサイズ
00032D F123 0002                    DW  512
       F124                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F125                     RR_LOW:
00032F F125 0000                    DW  0
       F126                     RR_MID  EQU $-1
       F127                     RR_HIGH:
000331 F127 0000                    DW  0
       F129                     _CLPS:
000333 F129 0000                    DW  0
       F12B                     _LEFT:
000335 F12B 0000                    DW  0
       F12D                     _DTPS:
000337 F12D 0000                    DW  0
       F12F                     _DTA:
000339 F12F 0000                    DW  0
       F131                     FLG_LDIR:
00033B F131 00                      DB  0
                                
                                ;   BDOS
00033C F132 F7              12      RST 30H
00033D F133 00                      DB  0
00033E F134 464F                    DW  ROM_BDOS
000340 F136 C9              10      RET 
       F137                     _FCB:
000341 F137 0000                    DW  0
       F139                     _BUF:
       F139                     _BUF_LO:        ;LOGICAL OPERATION
000343 F139 00                      DB  0
       F13A                     _BUF_ST:
000344 F13A 0000                    DW  0
       F13C                     _BUF_EN:
000346 F13C 0000                    DW  0
       F13E                     _BUF_EX:
       F13E                     _BUF_W:
000348 F13E 0000                    DW  0
       F140                     _BUF_H:
00034A F140 0000                    DW  0
       F142                     _BUF_X:
00034C F142 0000                    DW  0
       F144                     _BUF_Y:
00034E F144 00                      DB  0
       F145                     _BUF_P:
00034F F145 00                      DB  0
       F146                     _BUF_O:
000350 F146 00                      DB  0
       F147                     DTAX:
000351 F147 0000                    DW  0
       F149                     B_DRIVE:
000353 F149 00                      DB  0
       F14A                     _DVSW:
000354 F14A 00                      DB  0
       F14B                     FCBX:
000355 F14B 0000                    DW  0
       F14D                     LEFTX:
000357 F14D 0000                    DW  0
       F14F                     PARAM0:
000359 F14F 0000                    DW  0
       F151                     PARAM1:
00035B F151 0000                    DW  0
       F153                     FDRV:
00035D F153 00                      DB  0
       F154                     FNAME:
00035E F154                         DS  8+3
                                
       F15F                     BASSTK:
000369 F15F 0000                    DW  0
       F161                     _HL:
00036B F161 0000                    DW  0
       F163                     _SP:
00036D F163 0000                    DW  0
                                
       F165                     ISC_E:
00036F 436F                         ORG $$+RUN          ;$DEPHASE
                                
       436F                     MSX1:
00036F 436F CD5F4F          17      CALL    MSGA1
       4372                     MSX:
000372 4372 7E               7      LD  A,(HL)
000373 4373 23               6      INC HL
000374 4374 B7               4      OR  A
000375 4375 20F8            12      JR  NZ,MSX1
000377 4377 C9              10      RET
                                
       4378                     PRTHX:
000378 4378 F5              11      PUSH    AF
000379 4379 07               4      RLCA
00037A 437A 07               4      RLCA
00037B 437B 07               4      RLCA
00037C 437C 07               4      RLCA
00037D 437D CD8143          17      CALL    PRTA2
000380 4380 F1              10      POP AF
       4381                     PRTA2:
000381 4381 CD8743          17      CALL    ASC
000384 4384 C35B4F          10      JP  MSG_A
                                    
       4387                     ASC:
000387 4387 E60F             7      AND $0F
000389 4389 F630             7      OR  $30
00038B 438B FE3A             7      CP  $3A
00038D 438D D8              11      RET C
00038E 438E C607             7      ADD A,7
000390 4390 C9              10      RET
                                
       4391                     MSN:
000391 4391 7E               7      LD  A,(HL)
000392 4392 23               6      INC HL
000393 4393 CD5B4F          17      CALL    MSG_A
000396 4396 10F9            13      DJNZ    MSN
000398 4398 C9              10      RET
                                
       4399                     ROM_STKE:
000399 4399 3E                      DB  03EH
00039A 439A C9              10      RET
00039B 439B 32DAFE          13      LD  (H_STKE),A
00039E 439E E5              11      PUSH    HL
00039F 439F D5              11      PUSH    DE
0003A0 43A0 C5              11      PUSH    BC
0003A1 43A1 181D            12      JR  BASAUTO
                                
0003A3 43A3 AF               4      XOR A
0003A4 43A4 5F               4      LD  E,A
0003A5 43A5 57               4      LD  D,A
0003A6 43A6 0601             7      LD  B,1
0003A8 43A8 2100C0          10      LD  HL,0C000H
0003AB 43AB CD694D          17      CALL    DISKIO
                                
0003AE 43AE ED735FF1        20      LD  (BASSTK),SP
0003B2 43B2 116BF3          10      LD  DE,RAMUSE
0003B5 43B5 AF               4      XOR A
0003B6 43B6 CD1EC0          17      CALL    0C01EH
0003B9 43B9 116BF3          10      LD  DE,RAMUSE
0003BC 43BC 37               4      SCF
0003BD 43BD CD1EC0          17      CALL    0C01EH
       43C0                     BASAUTO:
0003C0 43C0 210D44          10      LD  HL,AUTOEXEC
0003C3 43C3 1153F1          10      LD  DE,FDRV
0003C6 43C6 010C00          10      LD  BC,1+8+3
0003C9 43C9 EDB0                    LDIR
0003CB 43CB CD0D4B          17      CALL    ROM_OPEN
0003CE 43CE 3813            12      JR  C,RSTKEE
0003D0 43D0 211944          10      LD  HL,RUN_AUTOEXEC
0003D3 43D3 11F0FB          10      LD  DE,KEYBUF
0003D6 43D6 ED53FAF3        20      LD  (GETPNT),DE
0003DA 43DA 011300          10      LD  BC,RUN_AUTOEXEC_E-RUN_AUTOEXEC
0003DD 43DD EDB0                    LDIR
0003DF 43DF ED53F8F3        20      LD  (PUTPNT),DE
       43E3                     RSTKEE:
0003E3 43E3 C1              10      POP BC
0003E4 43E4 D1              10      POP DE
0003E5 43E5 E1              10      POP HL
0003E6 43E6 C9              10      RET
                                
       43E7                     MSG_ERROR_ROM_MODE:
0003E7 43E7 41534349492D384B        DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
            2F4B6F6E616D692D    
            384B2F4B6F6E616D    
            692D534343206F6E    
            6C79210D0A          
       440C                     NULL:
00040C 440C 00                      DB  0
                                
       440D                     AUTOEXEC:
00040D 440D 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       4419                     RUN_AUTOEXEC:
000419 4419 52554E2022415554        DB  'RUN "AUTOEXEC.BAS"',00DH
            4F455845432E4241    
            53220D              
                                ;   DB  'LOAD "AUTOEXEC.BAS"',00DH  ;テスト用
       442C                     RUN_AUTOEXEC_E:
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       442C                     ROM_LDIR:
00042C 442C 3A31F1          13      LD  A,(FLG_LDIR)
00042F 442F B7               4      OR  A
000430 4430 2062            12      JR  NZ,ROM_LDIRVM
000432 4432 CB7A             8      BIT 7,D
000434 4434 CABC44          10      JP  Z,ROM_LDIRSLT
                                
                                #if exists USE_NORMAL_32K_ROM
000437 4437 ED7363F1        20      LD  (_SP),SP
00043B 443B 3121FB          10      LD  SP,DRVTBL
       443E                     LDIR1:
00043E 443E 78               4      LD  A,B
00043F 443F B1               4      OR  C
000440 4440 2841            12      JR  Z,LDIRE
                                
000442 4442 C5              11      PUSH    BC
000443 4443 D5              11      PUSH    DE
000444 4444 E5              11      PUSH    HL
000445 4445 3A00F1          13      LD  A,(ROM_SLT)
000448 4448 2680             7      LD  H,080H
00044A 444A CD2400          17      CALL    _ENASLT
00044D 444D E1              10      POP HL
00044E 444E D1              10      POP DE
00044F 444F C1              10      POP BC
       4450                     LDIR2:
000450 4450 7A               4      LD  A,D
000451 4451 FEC0             7      CP  0C0H
000453 4453 302C            12      JR  NC,LDIR4
                                
000455 4455 C5              11      PUSH    BC
000456 4456 D5              11      PUSH    DE
000457 4457 115EF5          10      LD  DE,BUF
                                
00045A 445A 78               4      LD  A,B
00045B 445B B7               4      OR  A
00045C 445C 2803            12      JR  Z,LDIR3
00045E 445E 010001          10      LD  BC,00100H
       4461                     LDIR3:
000461 4461 C5              11      PUSH    BC
000462 4462 EDB0                    LDIR
000464 4464 2261F1          16      LD  (_HL),HL
                                
000467 4467 3A43F3          13      LD  A,(RAMAD2)
00046A 446A 2680             7      LD  H,080H
00046C 446C CD2400          17      CALL    _ENASLT
                                
00046F 446F 215EF5          10      LD  HL,BUF
000472 4472 C1              10      POP BC
000473 4473 D1              10      POP DE
000474 4474 EDB0                    LDIR
                                
000476 4476 2A61F1          16      LD  HL,(_HL)
000479 4479 C1              10      POP BC
00047A 447A 78               4      LD  A,B
00047B 447B B7               4      OR  A
00047C 447C 2805            12      JR  Z,LDIRE
00047E 447E 05               4      DEC B
00047F 447F 18BD            12      JR  LDIR1
       4481                     LDIR4:
                                #endif
000481 4481 EDB0                    LDIR
                                
                                #if exists USE_NORMAL_32K_ROM
       4483                     LDIRE:
000483 4483 D5              11      PUSH    DE
000484 4484 E5              11      PUSH    HL
000485 4485 3A43F3          13      LD  A,(RAMAD2)
000488 4488 2680             7      LD  H,080H
00048A 448A CD2400          17      CALL    _ENASLT
00048D 448D E1              10      POP HL
00048E 448E D1              10      POP DE
00048F 448F ED7B63F1        20      LD  SP,(_SP)
                                #endif
000493 4493 C9              10      RET
                                
       4494                     ROM_LDIRVM:
                                #if exists USE_NORMAL_32K_ROM
000494 4494 C5              11      PUSH    BC
000495 4495 D5              11      PUSH    DE
000496 4496 E5              11      PUSH    HL
000497 4497 3A00F1          13      LD  A,(ROM_SLT)
00049A 449A 2680             7      LD  H,080H
00049C 449C CD2400          17      CALL    _ENASLT
00049F 449F E1              10      POP HL
0004A0 44A0 D1              10      POP DE
0004A1 44A1 C1              10      POP BC
                                #endif
0004A2 44A2 C5              11      PUSH    BC
0004A3 44A3 D5              11      PUSH    DE
0004A4 44A4 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0004A8 44A8 DD215C00        14      LD  IX,LDIRVM
0004AC 44AC CD1C00          17      CALL    _CALSLT
                                #if exists USE_NORMAL_32K_ROM
0004AF 44AF 2680             7      LD  H,080H
0004B1 44B1 3A43F3          13      LD  A,(RAMAD2)
0004B4 44B4 CD2400          17      CALL    _ENASLT
                                #endif
0004B7 44B7 E1              10      POP HL
0004B8 44B8 C1              10      POP BC
0004B9 44B9 09              11      ADD HL,BC
0004BA 44BA EB               4      EX  DE,HL
0004BB 44BB C9              10      RET
                                
       44BC                     ROM_LDIRSLT:
0004BC 44BC EB               4      EX  DE,HL
       44BD                     RLDIRSLT1:
0004BD 44BD 1A               7      LD  A,(DE)
0004BE 44BE 13               6      INC DE
0004BF 44BF C5              11      PUSH    BC
0004C0 44C0 D5              11      PUSH    DE
0004C1 44C1 E5              11      PUSH    HL
0004C2 44C2 5F               4      LD  E,A
0004C3 44C3 3A42F3          13      LD  A,(RAMAD1)
0004C6 44C6 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0004CA 44CA DD211400        14      LD  IX,_WRSLT
0004CE 44CE CD1C00          17      CALL    _CALSLT
0004D1 44D1 E1              10      POP HL
0004D2 44D2 D1              10      POP DE
0004D3 44D3 C1              10      POP BC
0004D4 44D4 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0004D6 44D6 EABD44          10      JP  PE,RLDIRSLT1
0004D9 44D9 EB               4      EX  DE,HL
0004DA 44DA C9              10      RET
                                
       44DB                     END_OF_LINE:
0004DB 44DB 215EF5          10      LD  HL,BUF
       44DE                     EOL1:
0004DE 44DE 7E               7      LD  A,(HL)
0004DF 44DF C8              11      RET Z
0004E0 44E0 FE0D             7      CP  00DH
0004E2 44E2 2807            12      JR  Z,EOLE
0004E4 44E4 FE0A             7      CP  00AH
0004E6 44E6 2803            12      JR  Z,EOLE
0004E8 44E8 23               6      INC HL
0004E9 44E9 18F3            12      JR  EOL1
       44EB                     EOLE:
0004EB 44EB 3600            10      LD  (HL),0
0004ED 44ED 23               6      INC HL
0004EE 44EE 7E               7      LD  A,(HL)
0004EF 44EF FE0A             7      CP  00AH
0004F1 44F1 C0              11      RET NZ
0004F2 44F2 23               6      INC HL
0004F3 44F3 C9              10      RET
                                
       44F4                     ROM_LOAD_ASCII:
0004F4 44F4 210000          10      LD  HL,0
0004F7 44F7 223AF1          16      LD  (_BUF_ST),HL    ;読み出し位置
0004FA 44FA 2A76F6          16      LD  HL,(TXTTAB)
0004FD 44FD 223CF1          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
000500 4500 215EF5          10      LD  HL,BUF
000503 4503 222FF1          16      LD  (_DTA),HL
       4506                     RLOAD_A1:
000506 4506 2A3AF1          16      LD  HL,(_BUF_ST)
000509 4509 2225F1          16      LD  (RR_LOW),HL
00050C 450C 210201          10      LD  HL,258
00050F 450F CD2D49          17      CALL    ROM_READ
000512 4512 7C               4      LD  A,H
000513 4513 B5               4      OR  L
000514 4514 2877            12      JR  Z,RLOAD_AEND
000516 4516 015EF5          10      LD  BC,BUF
000519 4519 09              11      ADD HL,BC
00051A 451A 3600            10      LD  (HL),0
00051C 451C CDDB44          17      CALL    END_OF_LINE
00051F 451F 015EF5          10      LD  BC,BUF
000522 4522 A7               4      AND A
000523 4523 ED42            15      SBC HL,BC
000525 4525 2810            12      JR  Z,RLOAD_A2
000527 4527 4D               4      LD  C,L
000528 4528 44               4      LD  B,H
000529 4529 ED5B3AF1        20      LD  DE,(_BUF_ST)
00052D 452D 19              11      ADD HL,DE
00052E 452E 223AF1          16      LD  (_BUF_ST),HL
000531 4531 3A5EF5          13      LD  A,(BUF)
000534 4534 B7               4      OR  A
000535 4535 28CF            12      JR  Z,RLOAD_A1
       4537                     RLOAD_A2:
000537 4537 115EF5          10      LD  DE,BUF
00053A 453A CDA44A          17      CALL    SPCUTEX
00053D 453D 1A               7      LD  A,(DE)
00053E 453E B7               4      OR  A
00053F 453F 284C            12      JR  Z,RLOAD_AEND
000541 4541 CDB64A          17      CALL    GETNUM
000544 4544 7C               4      LD  A,H
000545 4545 B5               4      OR  L
000546 4546 CAE445          10      JP  Z,ERROR_DIRECT_IN_FILE
000549 4549 DD2A3CF1        20      LD  IX,(_BUF_EN)
00054D 454D DD7502          19      LD  (IX+2),L
000550 4550 DD7403          19      LD  (IX+3),H
                                
000553 4553 CD9D4A          17      CALL    SPCUT
000556 4556 EB               4      EX  DE,HL
000557 4557 DDE5            15      PUSH    IX
000559 4559 DD21B242        14      LD  IX,CRUNCH
00055D 455D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000561 4561 CD1C00          17      CALL    _CALSLT
000564 4564 DDE1            14      POP IX
000566 4566 EB               4      EX  DE,HL
000567 4567 111FF4          10      LD  DE,KBUF
00056A 456A 37               4      SCF
00056B 456B ED52            15      SBC HL,DE
00056D 456D 2875            12      JR  Z,ERROR_DIRECT_IN_FILE
00056F 456F 3873            12      JR  C,ERROR_DIRECT_IN_FILE
000571 4571 4D               4      LD  C,L
000572 4572 44               4      LD  B,H
000573 4573 2A3CF1          16      LD  HL,(_BUF_EN)
000576 4576 110400          10      LD  DE,4
000579 4579 19              11      ADD HL,DE
00057A 457A 111FF4          10      LD  DE,KBUF
                                
00057D 457D EB               4      EX  DE,HL
00057E 457E EDB0                    LDIR
000580 4580 EB               4      EX  DE,HL
                                
000581 4581 DD7500          19      LD  (IX+0),L
000584 4584 DD7401          19      LD  (IX+1),H
000587 4587 223CF1          16      LD  (_BUF_EN),HL
00058A 458A C30645          10      JP  RLOAD_A1
                                
       458D                     RLOAD_AEND:
00058D 458D 2A3CF1          16      LD  HL,(_BUF_EN)
000590 4590 AF               4      XOR A
000591 4591 77               7      LD  (HL),A
000592 4592 23               6      INC HL
000593 4593 77               7      LD  (HL),A
000594 4594 23               6      INC HL
000595 4595 223CF1          16      LD  (_BUF_EN),HL
000598 4598 1833            12      JR  RLOAD_END1
                                
       459A                     ROM_LOAD:
00059A 459A CD1847          17      CALL    INIT_PARAM
00059D 459D CDCD49          17      CALL    FILE_B
0005A0 45A0 CD0D4B          17      CALL    ROM_OPEN
0005A3 45A3 3845            12      JR  C,ERROR_FILE_NOT_FOUND
                                
0005A5 45A5 2139F1          10      LD  HL,_BUF
0005A8 45A8 222FF1          16      LD  (_DTA),HL
0005AB 45AB 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
0005AE 45AE CD2D49          17      CALL    ROM_READ
0005B1 45B1 3A39F1          13      LD  A,(_BUF)
0005B4 45B4 3C               4      INC A
0005B5 45B5 C2F444          10      JP  NZ,ROM_LOAD_ASCII
0005B8 45B8 2A76F6          16      LD  HL,(TXTTAB)
0005BB 45BB 222FF1          16      LD  (_DTA),HL
0005BE 45BE EB               4      EX  DE,HL
0005BF 45BF 2100FF          10      LD  HL,-256
0005C2 45C2 39              11      ADD HL,SP
0005C3 45C3 ED52            15      SBC HL,DE
0005C5 45C5 CD2D49          17      CALL    ROM_READ
0005C8 45C8 ED5B2FF1        20      LD  DE,(_DTA)
0005CC 45CC 19              11      ADD HL,DE
       45CD                     RLOAD_END1:
0005CD 45CD 22C2F6          16      LD  (VARTAB),HL
0005D0 45D0 22C4F6          16      LD  (ARYTAB),HL
0005D3 45D3 22C6F6          16      LD  (STREND),HL
                                
0005D6 45D6 AF               4      XOR A
0005D7 45D7 213CF1          10      LD  HL,_BUF+3
0005DA 45DA 77               7      LD  (HL),A
0005DB 45DB 2B               6      DEC HL
0005DC 45DC 77               7      LD  (HL),A
0005DD 45DD 2B               6      DEC HL
0005DE 45DE 77               7      LD  (HL),A
0005DF 45DF 2B               6      DEC HL
0005E0 45E0 3E8F             7      LD  A,08FH          ;REM
0005E2 45E2 77               7      LD  (HL),A
0005E3 45E3 C9              10      RET
                                
       45E4                     ERROR_DIRECT_IN_FILE:
0005E4 45E4 1E39             7      LD  E,57            ;Direct statement in file
0005E6 45E6 01                      DB  1           ;LD BC,
       45E7                     ERROR_FILE_NOT_OPEN:
0005E7 45E7 1E3B             7      LD  E,59            ;File not OPEN
0005E9 45E9 01                      DB  1           ;LD BC,
       45EA                     ERROR_FILE_NOT_FOUND:
0005EA 45EA 1E35             7      LD  E,53            ;File not found
       45EC                     ERROR:
0005EC 45EC FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0005F0 45F0 DD216F40        14      LD  IX,ERRHAND
0005F4 45F4 C31C00          10      JP  _CALSLT
                                
       45F7                     ROM_BLOAD:
0005F7 45F7 CD1847          17      CALL    INIT_PARAM
0005FA 45FA CDCD49          17      CALL    FILE_B
0005FD 45FD CD0D4B          17      CALL    ROM_OPEN
000600 4600 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000602 4602 2139F1          10      LD  HL,_BUF
000605 4605 222FF1          16      LD  (_DTA),HL
000608 4608 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
00060B 460B CD2D49          17      CALL    ROM_READ
00060E 460E 3A39F1          13      LD  A,(_BUF)
000611 4611 FEFE             7      CP  0FEH
000613 4613 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
000615 4615 210EF1          10      LD  HL,BLOAD_RET
000618 4618 2206F1          16      LD  (SWC_BLOAD),HL
                                
00061B 461B 2A51F1          16      LD  HL,(PARAM1)
00061E 461E 7E               7      LD  A,(HL)
00061F 461F FE2C             7      CP  ','
000621 4621 2048            12      JR  NZ,RBREAD_MEM
000623 4623 23               6      INC HL
000624 4624 7E               7      LD  A,(HL)
000625 4625 CDF74A          17      CALL    CAP
000628 4628 32BEFC          13      LD  (RUNBNF),A
       462B                     RBOS1:
00062B 462B 7E               7      LD  A,(HL)
00062C 462C 23               6      INC HL
00062D 462D B7               4      OR  A
00062E 462E 282F            12      JR  Z,RBREAD_OSE
000630 4630 FE3A             7      CP  ':'
000632 4632 282B            12      JR  Z,RBREAD_OSE
000634 4634 FE2C             7      CP  ','     ;次のパラメータを探す
000636 4636 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
000638 4638 2251F1          16      LD  (PARAM1),HL
00063B 463B 7E               7      LD  A,(HL)
00063C 463C B7               4      OR  A
00063D 463D 2820            12      JR  Z,RBREAD_OSE
00063F 463F DD21644C        14      LD  IX,FRMEVL
000643 4643 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000647 4647 CD1C00          17      CALL    _CALSLT
00064A 464A 2251F1          16      LD  (PARAM1),HL
00064D 464D 3A63F6          13      LD  A,(VALTYP)
000650 4650 FE02             7      CP  2
000652 4652 200B            12      JR  NZ,RBREAD_OSE
000654 4654 2A3AF1          16      LD  HL,(_BUF_ST)
000657 4657 ED5BF8F7        20      LD  DE,(DACDAT)
00065B 465B 19              11      ADD HL,DE
00065C 465C 223AF1          16      LD  (_BUF_ST),HL
       465F                     RBREAD_OSE:
00065F 465F 3ABEFC          13      LD  A,(RUNBNF)
000662 4662 FE53             7      CP  'S'
000664 4664 2005            12      JR  NZ,RBREAD_MEM
000666 4666 3E01             7      LD  A,1
000668 4668 3231F1          13      LD  (FLG_LDIR),A
       466B                     RBREAD_MEM:
00066B 466B 2A3AF1          16      LD  HL,(_BUF_ST)
00066E 466E 22BFFC          16      LD  (SAVENT),HL
000671 4671 222FF1          16      LD  (_DTA),HL
000674 4674 21FFFF          10      LD  HL,0FFFFH
000677 4677 CD2D49          17      CALL    ROM_READ
00067A 467A 3ABEFC          13      LD  A,(RUNBNF)
00067D 467D FE52             7      CP  'R'
00067F 467F 2006            12      JR  NZ,RBREAD1
000681 4681 2A3EF1          16      LD  HL,(_BUF_EX)
000684 4684 2206F1          16      LD  (SWC_BLOAD),HL
       4687                     RBREAD1:
       4687                     ROM_NEXT:
000687 4687 2A51F1          16      LD  HL,(PARAM1)
00068A 468A 7E               7      LD  A,(HL)
00068B 468B 2B               6      DEC HL
00068C 468C B7               4      OR  A
00068D 468D 2805            12      JR  Z,RN1
00068F 468F FE3A             7      CP  ':'
000691 4691 2801            12      JR  Z,RN1
000693 4693 23               6      INC HL
       4694                     RN1:
000694 4694 5D               4      LD  E,L
000695 4695 54               4      LD  D,H
                                
000696 4696 CDCD4A          17      CALL    SEARCH_END
000699 4699 B7               4      OR  A
00069A 469A 2815            12      JR  Z,REM
                                                    ;マルチステートメントの処理
00069C 469C 7E               7      LD  A,(HL)
                                
00069D 469D FEB5             7      CP  0B5H            ;LOAD
00069F 469F CA9A45          10      JP  Z,ROM_LOAD
0006A2 46A2 FE8A             7      CP  08AH            ;RUN
0006A4 46A4 280F            12      JR  Z,ROM_RUN
0006A6 46A6 FEB7             7      CP  0B7H            ;FILES
0006A8 46A8 2818            12      JR  Z,ROM_FILES
0006AA 46AA 3E28             7      LD  A,028H          ;JR Z,
0006AC 46AC 320CF1          13      LD  (SWC_BLOAD_M),A
0006AF 46AF 7E               7      LD  A,(HL)
0006B0 46B0 C9              10      RET
                                
       46B1                     REM:
0006B1 46B1 EB               4      EX  DE,HL
0006B2 46B2 3E8F             7      LD  A,08FH          ;REM
0006B4 46B4 C9              10      RET
                                
       46B5                     ROM_RUN:
0006B5 46B5 23               6      INC HL
0006B6 46B6 7E               7      LD  A,(HL)
0006B7 46B7 2B               6      DEC HL
0006B8 46B8 B7               4      OR  A
0006B9 46B9 2803            12      JR  Z,ROM_RUN1
0006BB 46BB CD9A45          17      CALL    ROM_LOAD
       46BE                     ROM_RUN1:
0006BE 46BE 3E8A             7      LD  A,08AH          ;RUN
0006C0 46C0 77               7      LD  (HL),A
0006C1 46C1 C9              10      RET
                                
       46C2                     ROM_FILES:
0006C2 46C2 CD1847          17      CALL    INIT_PARAM
0006C5 46C5 CDCD49          17      CALL    FILE_B
0006C8 46C8 CDFE4E          17      CALL    GET_DISK_BANK_FDRV
0006CB 46CB 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0006CE 46CE 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0006D1 46D1 3A54F1          13      LD  A,(FNAME)
0006D4 46D4 FE21             7      CP  021H
0006D6 46D6 3005            12      JR  NC,RFILES0
0006D8 46D8 060B             7      LD  B,11
0006DA 46DA CD614A          17      CALL    FILE10
       46DD                     RFILES0:
0006DD 46DD CD2A4D          17      CALL    GET_DIR_DAT
       46E0                     RFILES1:
0006E0 46E0 CD294B          17      CALL    FILESE
0006E3 46E3 302E            12      JR  NC,RFILES_NOT_MATCH
       46E5                     RFILES_DISP:
0006E5 46E5 E5              11      PUSH    HL
0006E6 46E6 0608             7      LD  B,8
0006E8 46E8 CD9143          17      CALL    MSN
0006EB 46EB 3E2E             7      LD  A,'.'
0006ED 46ED CD5B4F          17      CALL    MSG_A
0006F0 46F0 0603             7      LD  B,3
0006F2 46F2 CD9143          17      CALL    MSN
0006F5 46F5 3ADDF3          13      LD  A,(CSRX)
0006F8 46F8 47               4      LD  B,A
0006F9 46F9 3AB0F3          13      LD  A,(LINLEN)
0006FC 46FC 90               4      SUB B
0006FD 46FD FE0C             7      CP  12
0006FF 46FF 3009            12      JR  NC,RFILES2
000701 4701 3E0D             7      LD  A,00DH      ;改行
000703 4703 CD5B4F          17      CALL    MSG_A
000706 4706 3E0A             7      LD  A,00AH
000708 4708 1802            12      JR  RFILES3
       470A                     RFILES2:
00070A 470A 3E20             7      LD  A,020H
       470C                     RFILES3:
00070C 470C CD5B4F          17      CALL    MSG_A
00070F 470F E1              10      POP HL
000710 4710 CD454B          17      CALL    FNEXT
       4713                     RFILES_NOT_MATCH:
000713 4713 20CB            12      JR  NZ,RFILES1
000715 4715 C38746          10      JP  ROM_NEXT
                                
       4718                     INIT_PARAM:
000718 4718 224FF1          16      LD  (PARAM0),HL
00071B 471B 2251F1          16      LD  (PARAM1),HL
00071E 471E EB               4      EX  DE,HL
00071F 471F AF               4      XOR A
000720 4720 3231F1          13      LD  (FLG_LDIR),A
000723 4723 32BEFC          13      LD  (RUNBNF),A
000726 4726 3263F6          13      LD  (VALTYP),A
000729 4729 13               6      INC DE
00072A 472A CD9D4A          17      CALL    SPCUT
00072D 472D 1A               7      LD  A,(DE)
00072E 472E B7               4      OR  A
00072F 472F C8              11      RET Z
000730 4730 FE3A             7      CP  ':'
000732 4732 C8              11      RET Z
000733 4733 FE28             7      CP  '('
000735 4735 C8              11      RET Z
000736 4736 EB               4      EX  DE,HL
000737 4737 DD21644C        14      LD  IX,FRMEVL
00073B 473B FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00073F 473F CD1C00          17      CALL    _CALSLT
000742 4742 2251F1          16      LD  (PARAM1),HL
000745 4745 C9              10      RET
                                
000746 4746 00               4      NOP
       4747                     ROM_COPY:
000747 4747 CD1847          17      CALL    INIT_PARAM
00074A 474A 3A63F6          13      LD  A,(VALTYP)
00074D 474D FE03             7      CP  3       ;string
00074F 474F C2C849          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
000752 4752 CDCD49          17      CALL    FILE_B
000755 4755 CD0D4B          17      CALL    ROM_OPEN
000758 4758 DAEA45          10      JP  C,ERROR_FILE_NOT_FOUND
                                
00075B 475B 213EF1          10      LD  HL,_BUF_W
00075E 475E 222FF1          16      LD  (_DTA),HL
000761 4761 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
000764 4764 CD2D49          17      CALL    ROM_READ
                                
000767 4767 AF               4      XOR A
000768 4768 3239F1          13      LD  (_BUF_LO),A     ;PSET
00076B 476B 3246F1          13      LD  (_BUF_O),A      ;向き
                                
00076E 476E 2A51F1          16      LD  HL,(PARAM1)
       4771                     RCP_PARAM1:
000771 4771 7E               7      LD  A,(HL)
000772 4772 23               6      INC HL
000773 4773 B7               4      OR  A
000774 4774 CAC849          10      JP  Z,ROM_ORG
000777 4777 FE3A             7      CP  ':'
000779 4779 CAC849          10      JP  Z,ROM_ORG
00077C 477C FE2C             7      CP  ','
00077E 477E 2012            12      JR  NZ,RCP_PARAM1_
                                
000780 4780 DD212F54        14      LD  IX,FRMQNT
000784 4784 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000788 4788 CD1C00          17      CALL    _CALSLT
00078B 478B 7B               4      LD  A,E
00078C 478C 87               4      ADD A,A
00078D 478D 87               4      ADD A,A
00078E 478E 3246F1          13      LD  (_BUF_O),A
000791 4791 7E               7      LD  A,(HL)
       4792                     RCP_PARAM1_:
000792 4792 FE28             7      CP  '('
000794 4794 20DB            12      JR  NZ,RCP_PARAM1
                                
000796 4796 DD212F54        14      LD  IX,FRMQNT
00079A 479A FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00079E 479E CD1C00          17      CALL    _CALSLT
                                
0007A1 47A1 ED5342F1        20      LD  (_BUF_X),DE
                                
       47A5                     RCP_PARAM2:
0007A5 47A5 23               6      INC HL
0007A6 47A6 7E               7      LD  A,(HL)
0007A7 47A7 FE20             7      CP  020H
0007A9 47A9 28FA            12      JR  Z,RCP_PARAM2
0007AB 47AB FE2C             7      CP  ','
0007AD 47AD 28F6            12      JR  Z,RCP_PARAM2
                                
0007AF 47AF DD212F54        14      LD  IX,FRMQNT
0007B3 47B3 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007B7 47B7 CD1C00          17      CALL    _CALSLT
                                
0007BA 47BA ED5344F1        20      LD  (_BUF_Y),DE
       47BE                     RCP_PARAM3:
0007BE 47BE 23               6      INC HL
0007BF 47BF 7E               7      LD  A,(HL)
0007C0 47C0 FE20             7      CP  020H
0007C2 47C2 28FA            12      JR  Z,RCP_PARAM3
0007C4 47C4 FE29             7      CP  ')'
0007C6 47C6 28F6            12      JR  Z,RCP_PARAM3
0007C8 47C8 FE2C             7      CP  ','
0007CA 47CA 2033            12      JR  NZ,RCP_ST
                                
0007CC 47CC 23               6      INC HL
0007CD 47CD DD212F54        14      LD  IX,FRMQNT
0007D1 47D1 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007D5 47D5 CD1C00          17      CALL    _CALSLT
                                
0007D8 47D8 7B               4      LD  A,E
0007D9 47D9 3245F1          13      LD  (_BUF_P),A
                                
       47DC                     RCP_PARAM4:
0007DC 47DC 7E               7      LD  A,(HL)
0007DD 47DD 23               6      INC HL
0007DE 47DE FE20             7      CP  020H
0007E0 47E0 28FA            12      JR  Z,RCP_PARAM4
                                
0007E2 47E2 FE2C             7      CP  ','
0007E4 47E4 2019            12      JR  NZ,RCP_ST
                                
0007E6 47E6 7E               7      LD  A,(HL)
0007E7 47E7 0604             7      LD  B,4
0007E9 47E9 FEC3             7      CP  0C3H        ;PRESET
0007EB 47EB 280E            12      JR  Z,RCP_LO
0007ED 47ED 05               4      DEC B       ;3
0007EE 47EE D6F8             7      SUB 0F8H        ;XOR
0007F0 47F0 2809            12      JR  Z,RCP_LO
0007F2 47F2 05               4      DEC B       ;2
0007F3 47F3 3C               4      INC A       ;OR
0007F4 47F4 2805            12      JR  Z,RCP_LO
0007F6 47F6 05               4      DEC B       ;1
0007F7 47F7 3C               4      INC A       ;AND
0007F8 47F8 2801            12      JR  Z,RCP_LO
0007FA 47FA 05               4      DEC B       ;0
                                                ;PSET
       47FB                     RCP_LO:
0007FB 47FB 78               4      LD  A,B
0007FC 47FC 3239F1          13      LD  (_BUF_LO),A
       47FF                     RCP_ST:
0007FF 47FF 2AC6F6          16      LD  HL,(STREND)
000802 4802 222FF1          16      LD  (_DTA),HL
000805 4805 EB               4      EX  DE,HL
000806 4806 2100FE          10      LD  HL,-512
000809 4809 39              11      ADD HL,SP
00080A 480A AF               4      XOR A
00080B 480B ED52            15      SBC HL,DE
00080D 480D 3008            12      JR  NC,RCP0
00080F 480F 215EF5          10      LD  HL,BUF
000812 4812 222FF1          16      LD  (_DTA),HL
000815 4815 6F               4      LD  L,A ;0
000816 4816 67               4      LD  H,A ;0
       4817                     RCP0:
000817 4817 24               4      INC H
000818 4818 223CF1          16      LD  (_BUF_EN),HL
       481B                     RCP1:
00081B 481B F3               4      DI
00081C 481C CDC648          17      CALL    WAIT_VDP
                                
00081F 481F 3A0700          13      LD  A,(WRVDP)
000822 4822 4F               4      LD  C,A
000823 4823 0C               4      INC C       ;C := PORT#1's address
000824 4824 3E24             7      LD  A,36
000826 4826 ED79            12      OUT (C),A
000828 4828 3E91             7      LD  A,080H+17
00082A 482A ED79            12      OUT (C),A       ;R#17 := 36
                                
00082C 482C 0C               4      INC C
00082D 482D 0C               4      INC C       ;C := PORT#3's address
00082E 482E 2A42F1          16      LD  HL,(_BUF_X)
000831 4831 ED69            12      OUT (C),L       ;R#36 DX
000833 4833 ED61            12      OUT (C),H       ;R#37
000835 4835 2A44F1          16      LD  HL,(_BUF_Y)
000838 4838 ED69            12      OUT (C),L       ;R#38 DY
00083A 483A ED61            12      OUT (C),H       ;R#39
00083C 483C 2A3EF1          16      LD  HL,(_BUF_W)
00083F 483F ED69            12      OUT (C),L       ;R#40 NX
000841 4841 ED61            12      OUT (C),H       ;R#41
000843 4843 2A40F1          16      LD  HL,(_BUF_H)
000846 4846 ED69            12      OUT (C),L       ;R#42 NY
000848 4848 ED61            12      OUT (C),H       ;R#43
                                
00084A 484A DD2AAFFC        20      LD  IX,(SCRMOD)
00084E 484E 3A39F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000851 4851 B7               4      OR  A
000852 4852 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000854 4854 DD7D             9      LD  A,IXL
000856 4856 FE08             7      CP  8
000858 4858 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
00085A 485A FE06             7      CP  6
00085C 485C 2A42F1          16      LD  HL,(_BUF_X)
00085F 485F 3A3EF1          13      LD  A,(_BUF_W)
000862 4862 2005            12      JR  NZ,SCR57
000864 4864 B5               4      OR  L       ;スクリーン6
000865 4865 E603             7      AND 3
000867 4867 200D            12      JR  NZ,USE_LMMC
       4869                     SCR57:              ;スクリーン5,7
000869 4869 B5               4      OR  L
00086A 486A E601             7      AND 1
00086C 486C 2008            12      JR  NZ,USE_LMMC
       486E                     USE_HMMC:
00086E 486E DD2E08          10      LD  IXL,8
       4871                     USE_HMMC8:
000871 4871 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
000873 4873 3239F1          13      LD  (_BUF_LO),A
       4876                     USE_LMMC:
000876 4876 110000          10      LD  DE,0
000879 4879 06FF             7      LD  B,-1
00087B 487B CDE648          17      CALL    GET_PIXEL
00087E 487E ED79            12      OUT (C),A       ;R#44 first DATA
000880 4880 3A46F1          13      LD  A,(_BUF_O)
000883 4883 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
000885 4885 3A39F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000888 4888 F6B0             7      OR  0B0H        ;R#46 LMMC command
00088A 488A ED79            12      OUT (C),A
                                
00088C 488C 0D               4      DEC C
00088D 488D 0D               4      DEC C       ;C := PORT#1's address
00088E 488E 3EAC             7      LD  A,080H+44
000890 4890 ED79            12      OUT (C),A
000892 4892 3E91             7      LD  A,080H+17
000894 4894 ED79            12      OUT (C),A       ;R#17 := 44
000896 4896 0C               4      INC C
000897 4897 0C               4      INC C       ;C := PORT#3's address
       4898                     LOOP_COPY:
000898 4898 CDE648          17      CALL    GET_PIXEL
00089B 489B 08               4      EX  AF,AF'
00089C 489C 3E02             7      LD  A,2
00089E 489E CDB648          17      CALL    GET_STATUS
0008A1 48A1 CB47             8      BIT 0,A     ;check CE bit
0008A3 48A3 2809            12      JR  Z,EXIT_COPY
0008A5 48A5 CB7F             8      BIT 7,A     ;check TR bit
0008A7 48A7 28EF            12      JR  Z,LOOP_COPY
0008A9 48A9 08               4      EX  AF,AF'
0008AA 48AA ED79            12      OUT (C),A
0008AC 48AC 18EA            12      JR  LOOP_COPY
                                
       48AE                     EXIT_COPY:
0008AE 48AE AF               4      XOR A
0008AF 48AF CDB648          17      CALL    GET_STATUS
                                
0008B2 48B2 FB               4      EI
0008B3 48B3 C38746          10      JP  ROM_NEXT
                                
       48B6                     GET_STATUS:
0008B6 48B6 C5              11      PUSH    BC
0008B7 48B7 ED4B0600        20      LD  BC,(RDVDP)
0008BB 48BB 0C               4      INC C
0008BC 48BC ED79            12      OUT (C),A
0008BE 48BE 3E8F             7      LD  A,8FH
0008C0 48C0 ED79            12      OUT (C),A
0008C2 48C2 ED78            12      IN  A,(C)
0008C4 48C4 C1              10      POP BC
0008C5 48C5 C9              10      RET
                                
       48C6                     WAIT_VDP:
0008C6 48C6 3E02             7      LD  A,2
0008C8 48C8 CDB648          17      CALL    GET_STATUS
0008CB 48CB E601             7      AND 1
0008CD 48CD 20F7            12      JR  NZ,WAIT_VDP
0008CF 48CF AF               4      XOR A
0008D0 48D0 CDB648          17      CALL    GET_STATUS
0008D3 48D3 C9              10      RET
                                
       48D4                     GET_PIXEL256:
0008D4 48D4 7A               4      LD  A,D
0008D5 48D5 B3               4      OR  E
0008D6 48D6 200A            12      JR  NZ,GET_PIXEL1
                                
0008D8 48D8 2A3CF1          16      LD  HL,(_BUF_EN)
0008DB 48DB CD2D49          17      CALL    ROM_READ
0008DE 48DE EB               4      EX  DE,HL
0008DF 48DF 2A2FF1          16      LD  HL,(_DTA)
       48E2                     GET_PIXEL1:
0008E2 48E2 7E               7      LD  A,(HL)
0008E3 48E3 23               6      INC HL
0008E4 48E4 1B               6      DEC DE
0008E5 48E5 C9              10      RET
                                
       48E6                     GET_PIXEL:
0008E6 48E6 04               4      INC B
0008E7 48E7 DD7D             9      LD  A,IXL
0008E9 48E9 FE08             7      CP  8
0008EB 48EB 28E7            12      JR  Z,GET_PIXEL256
0008ED 48ED FE06             7      CP  6
0008EF 48EF 282E            12      JR  Z,GET_PIXEL4
                                
0008F1 48F1 CB40             8      BIT 0,B
0008F3 48F3 20ED            12      JR  NZ,GET_PIXEL1
                                
0008F5 48F5 7A               4      LD  A,D
0008F6 48F6 B3               4      OR  E
0008F7 48F7 200A            12      JR  NZ,GET_PIXEL2
                                
0008F9 48F9 2A3CF1          16      LD  HL,(_BUF_EN)
0008FC 48FC CD2D49          17      CALL    ROM_READ
0008FF 48FF EB               4      EX  DE,HL
000900 4900 2A2FF1          16      LD  HL,(_DTA)
                                
       4903                     GET_PIXEL2:
000903 4903 7E               7      LD  A,(HL)
000904 4904 0F               4      RRCA
000905 4905 0F               4      RRCA
000906 4906 0F               4      RRCA
000907 4907 0F               4      RRCA
000908 4908 C9              10      RET
                                
       4909                     GET_PIXEL3:
000909 4909 7A               4      LD  A,D
00090A 490A B3               4      OR  E
00090B 490B 200A            12      JR  NZ,GET_PIXEL5
                                
00090D 490D 2A3CF1          16      LD  HL,(_BUF_EN)
000910 4910 CD2D49          17      CALL    ROM_READ
000913 4913 EB               4      EX  DE,HL
000914 4914 2A2FF1          16      LD  HL,(_DTA)
       4917                     GET_PIXEL5:
000917 4917 7E               7      LD  A,(HL)
000918 4918 0F               4      RRCA
000919 4919 0F               4      RRCA
00091A 491A 0F               4      RRCA
00091B 491B 0F               4      RRCA
00091C 491C 0F               4      RRCA
00091D 491D 0F               4      RRCA
00091E 491E C9              10      RET
                                
       491F                     GET_PIXEL4:
00091F 491F 78               4      LD  A,B
000920 4920 E603             7      AND 3   ;+0
000922 4922 28E5            12      JR  Z,GET_PIXEL3
000924 4924 3D               4      DEC A   ;+1
000925 4925 28DC            12      JR  Z,GET_PIXEL2
000927 4927 3D               4      DEC A   ;+2
000928 4928 7E               7      LD  A,(HL)
000929 4929 C0              11      RET NZ
00092A 492A 0F               4      RRCA        ;+3
00092B 492B 0F               4      RRCA
00092C 492C C9              10      RET
                                
       492D                     ROM_READ:
00092D 492D E5              11      PUSH    HL
00092E 492E D5              11      PUSH    DE
00092F 492F C5              11      PUSH    BC
000930 4930 FDE5            15      PUSH    IY
000932 4932 224DF1          16      LD  (LEFTX),HL
000935 4935 2A2FF1          16      LD  HL,(_DTA)
000938 4938 2247F1          16      LD  (DTAX),HL
00093B 493B 2A4DF1          16      LD  HL,(LEFTX)
                                
00093E 493E CD714B          17      CALL    RBX1
000941 4941 3870            12      JR  C,RBRERR1
000943 4943 79               4      LD  A,C
000944 4944 EB               4      EX  DE,HL
000945 4945 ED52            15      SBC HL,DE       ;CP 0HL,CDE
000947 4947 19              11      ADD HL,DE
000948 4948 DE00             7      SBC A,000H
00094A 494A 3801            12      JR  C,RBR1
00094C 494C EB               4      EX  DE,HL
       494D                     RBR1:
00094D 494D 9F               4      SBC A,A
00094E 494E E601             7      AND 1
000950 4950 321FF1          13      LD  (_RESULT),A
000953 4953 7C               4      LD  A,H
000954 4954 B5               4      OR  L
000955 4955 CAA949          10      JP  Z,RBREND0
                                
000958 4958 222BF1          16      LD  (_LEFT),HL  ;Read record byte
00095B 495B 224DF1          16      LD  (LEFTX),HL
                                
00095E 495E CD974B          17      CALL    RBX2
000961 4961 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000963 4963 CDAA4B          17      CALL    RBXA
000966 4966 DABF49          10      JP  C,RBRERR
000969 4969 C5              11      PUSH    BC
00096A 496A CD2C44          17      CALL    ROM_LDIR
00096D 496D ED5347F1        20      LD  (DTAX),DE
000971 4971 2A4DF1          16      LD  HL,(LEFTX)
000974 4974 D1              10      POP DE
000975 4975 A7               4      AND A
000976 4976 ED52            15      SBC HL,DE
000978 4978 224DF1          16      LD  (LEFTX),HL
00097B 497B 2829            12      JR  Z,RBREND
                                
       497D                     RBRB:
00097D 497D CDE64B          17      CALL    RBXB
000980 4980 2818            12      JR  Z,RBRC
       4982                     RBRB1:
000982 4982 C5              11      PUSH    BC
000983 4983 D5              11      PUSH    DE
000984 4984 CD8E4C          17      CALL    CLUST
000987 4987 EB               4      EX  DE,HL
000988 4988 ED4B21F1        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
00098C 498C CD2C44          17      CALL    ROM_LDIR
00098F 498F EB               4      EX  DE,HL
000990 4990 D1              10      POP DE
000991 4991 C1              10      POP BC
000992 4992 CD6B4C          17      CALL    GNCL
000995 4995 DABF49          10      JP  C,RBRERR
000998 4998 10E8            13      DJNZ    RBRB1
       499A                     RBRC:
00099A 499A CDFE4B          17      CALL    RBXC
00099D 499D 2807            12      JR  Z,RBREND
                                
00099F 499F CD8E4C          17      CALL    CLUST
0009A2 49A2 EB               4      EX  DE,HL
0009A3 49A3 CD2C44          17      CALL    ROM_LDIR
       49A6                     RBREND:
0009A6 49A6 CD0A4C          17      CALL    RBXEND
       49A9                     RBREND0:
0009A9 49A9 FDE1            14      POP IY
0009AB 49AB C1              10      POP BC
0009AC 49AC D1              10      POP DE
0009AD 49AD F1              10      POP AF  ;(HL)
0009AE 49AE AF               4      XOR A
0009AF 49AF 3A1FF1          13      LD  A,(_RESULT)
0009B2 49B2 C9              10      RET
                                
       49B3                     RBRERR1:
0009B3 49B3 3E01             7      LD  A,001H
       49B5                     RBRERR2:
0009B5 49B5 FDE1            14      POP IY
0009B7 49B7 C1              10      POP BC
0009B8 49B8 D1              10      POP DE
0009B9 49B9 E1              10      POP HL
0009BA 49BA 37               4      SCF
0009BB 49BB 210000          10      LD  HL,0
0009BE 49BE C9              10      RET
       49BF                     RBRERR:
0009BF 49BF 3EFF             7      LD  A,0FFH
0009C1 49C1 18F2            12      JR  RBRERR2
                                
       49C3                     FILE_DD:
0009C3 49C3 3E                      DB  03EH
0009C4 49C4 C9              10      RET
0009C5 49C5 320CF1          13      LD  (SWC_BLOAD_M),A
       49C8                     ROM_ORG:
0009C8 49C8 2A4FF1          16      LD  HL,(PARAM0)
0009CB 49CB 7E               7      LD  A,(HL)
0009CC 49CC C9              10      RET
       49CD                     FILE_B:
0009CD 49CD AF               4      XOR A
0009CE 49CE 3253F1          13      LD  (FDRV),A
0009D1 49D1 1E00             7      LD  E,0
0009D3 49D3 3A63F6          13      LD  A,(VALTYP)
0009D6 49D6 FE03             7      CP  3       ;string
0009D8 49D8 2044            12      JR  NZ,FILED
                                
0009DA 49DA DD21D067        14      LD  IX,FRESTR
0009DE 49DE FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0009E2 49E2 CD1C00          17      CALL    _CALSLT
0009E5 49E5 E5              11      PUSH    HL
0009E6 49E6 DDE1            14      POP IX
                                
0009E8 49E8 DD5E00          19      LD  E,(IX+0)
0009EB 49EB DD7E01          19      LD  A,(IX+1)
0009EE 49EE DD5602          19      LD  D,(IX+2)
0009F1 49F1 DD62             9      LD  IXH,D
0009F3 49F3 DD6F             9      LD  IXL,A
0009F5 49F5 7B               4      LD  A,E
0009F6 49F6 FE04             7      CP  4
0009F8 49F8 3808            12      JR  C,FILEB1
0009FA 49FA DD7E03          19      LD  A,(IX+3)
0009FD 49FD FE3A             7      CP  ':'
0009FF 49FF 28C2            12      JR  Z,FILE_DD
000A01 4A01 7B               4      LD  A,E
       4A02                     FILEB1:
000A02 4A02 FE02             7      CP  2
000A04 4A04 3818            12      JR  C,FILED
000A06 4A06 DD7E01          19      LD  A,(IX+1)
000A09 4A09 FE3A             7      CP  ':'
000A0B 4A0B 2011            12      JR  NZ,DEVI1
000A0D 4A0D DD7E00          19      LD  A,(IX+0)        ;DRIVE
000A10 4A10 CDF74A          17      CALL    CAP
000A13 4A13 D640             7      SUB '@'
000A15 4A15 DD23            10      INC IX
000A17 4A17 DD23            10      INC IX
000A19 4A19 1D               4      DEC E
000A1A 4A1A 1D               4      DEC E
000A1B 4A1B 3253F1          13      LD  (FDRV),A
       4A1E                     DEVI1:
                                
       4A1E                     FILED:
000A1E 4A1E CD654A          17      CALL    FILEI
000A21 4A21 2154F1          10      LD  HL,FNAME
                                
000A24 4A24 0608             7      LD  B,8
       4A26                     FILE2:
000A26 4A26 CD724A          17      CALL    CCHKF
000A29 4A29 C8              11      RET Z
000A2A 4A2A FE2A             7      CP  '*'
000A2C 4A2C 282E            12      JR  Z,FILE9
000A2E 4A2E FE2E             7      CP  '.'
000A30 4A30 280C            12      JR  Z,FILE4
000A32 4A32 77               7      LD  (HL),A
000A33 4A33 23               6      INC HL
000A34 4A34 10F0            13      DJNZ    FILE2
                                
       4A36                     FILE3:
000A36 4A36 CD724A          17      CALL    CCHKF
000A39 4A39 C8              11      RET Z
000A3A 4A3A FE2E             7      CP  '.'
000A3C 4A3C 20F8            12      JR  NZ,FILE3
                                
       4A3E                     FILE4:
000A3E 4A3E 215CF1          10      LD  HL,FNAME+8
000A41 4A41 0603             7      LD  B,3
                                
       4A43                     FILE4L:
000A43 4A43 CD724A          17      CALL    CCHKF
000A46 4A46 C8              11      RET Z
000A47 4A47 FE2E             7      CP  '.'
000A49 4A49 2008            12      JR  NZ,FILE12
000A4B 4A4B 3254F1          13      LD  (FNAME),A   ;Parent directory(..)
000A4E 4A4E 3255F1          13      LD  (FNAME+1),A
000A51 4A51 3E20             7      LD  A,020H
       4A53                     FILE12:
000A53 4A53 FE2A             7      CP  '*'
000A55 4A55 280A            12      JR  Z,FILE10
000A57 4A57 77               7      LD  (HL),A
000A58 4A58 23               6      INC HL
000A59 4A59 10E8            13      DJNZ    FILE4L
000A5B 4A5B C9              10      RET
                                
       4A5C                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000A5C 4A5C CD614A          17      CALL    FILE10
000A5F 4A5F 18D5            12      JR  FILE3
                                
       4A61                     FILE10:
000A61 4A61 3E3F             7      LD  A,'?'
000A63 4A63 1808            12      JR  FILL_MEMORY
       4A65                     FILEI:              ;名前＋拡張子をスペースで初期化
000A65 4A65 3E20             7      LD  A,020H
000A67 4A67 01000B          10      LD  BC,11*256   ;C=0にしておく
000A6A 4A6A 2154F1          10      LD  HL,FNAME
       4A6D                     FILL_MEMORY:            ;HLからBバイトAで埋める
000A6D 4A6D 77               7      LD  (HL),A
000A6E 4A6E 23               6      INC HL
000A6F 4A6F 10FC            13      DJNZ    FILL_MEMORY
000A71 4A71 C9              10      RET
                                
       4A72                     CCHKF:
000A72 4A72 7B               4      LD  A,E
000A73 4A73 B7               4      OR  A
000A74 4A74 C8              11      RET Z
000A75 4A75 DD7E00          19      LD  A,(IX+0)
000A78 4A78 CD7F4A          17      CALL    CCHK2
000A7B 4A7B C8              11      RET Z
000A7C 4A7C C3E24A          10      JP  FKAN
                                
       4A7F                     CCHK2:
000A7F 4A7F 0C               4      INC C
000A80 4A80 0D               4      DEC C
000A81 4A81 C0              11      RET NZ
       4A82                     CCHK3:              ;ZF=1 で使えない文字
000A82 4A82 FE2B             7      CP  '+'
000A84 4A84 C8              11      RET Z
000A85 4A85 FE2C             7      CP  ','
000A87 4A87 C8              11      RET Z
000A88 4A88 FE2F             7      CP  '/'
000A8A 4A8A C8              11      RET Z
000A8B 4A8B FE3A             7      CP  ':'
000A8D 4A8D C8              11      RET Z
000A8E 4A8E FE3B             7      CP  ';'
000A90 4A90 C8              11      RET Z
000A91 4A91 FE3D             7      CP  '='
000A93 4A93 C8              11      RET Z
000A94 4A94 FE5C             7      CP  05CH    ;\
000A96 4A96 C8              11      RET Z
000A97 4A97 FE1F             7      CP  01FH
000A99 4A99 D0              11      RET NC
000A9A 4A9A BF               4      CP  A       ;Z=1
000A9B 4A9B C9              10      RET
                                
       4A9C                     SS1:
000A9C 4A9C 13               6      INC DE
       4A9D                     SPCUT:              ;スペースをカット
000A9D 4A9D 1A               7      LD  A,(DE)
000A9E 4A9E FE20             7      CP  020H
000AA0 4AA0 28FA            12      JR  Z,SS1
000AA2 4AA2 C9              10      RET
                                
       4AA3                     SCREOF1:
000AA3 4AA3 13               6      INC DE
       4AA4                     SPCUTEX:            ;スペース改行などをカット
000AA4 4AA4 1A               7      LD  A,(DE)
000AA5 4AA5 FE20             7      CP  020H
000AA7 4AA7 28FA            12      JR  Z,SCREOF1
000AA9 4AA9 FE0D             7      CP  00DH
000AAB 4AAB 28F6            12      JR  Z,SCREOF1
000AAD 4AAD FE0A             7      CP  00AH
000AAF 4AAF 28F2            12      JR  Z,SCREOF1
000AB1 4AB1 FE1A             7      CP  01AH
000AB3 4AB3 28EE            12      JR  Z,SCREOF1
000AB5 4AB5 C9              10      RET
                                
       4AB6                     GETNUM:
000AB6 4AB6 210000          10      LD  HL,0
       4AB9                     GETNUM1:
000AB9 4AB9 1A               7      LD  A,(DE)
000ABA 4ABA 13               6      INC DE
000ABB 4ABB D630             7      SUB '0'
000ABD 4ABD D8              11      RET C
000ABE 4ABE FE0A             7      CP  10
000AC0 4AC0 D0              11      RET NC
000AC1 4AC1 4D               4      LD  C,L
000AC2 4AC2 44               4      LD  B,H
000AC3 4AC3 29              11      ADD HL,HL   ;*2
000AC4 4AC4 29              11      ADD HL,HL   ;*4
000AC5 4AC5 09              11      ADD HL,BC   ;*5
000AC6 4AC6 29              11      ADD HL,HL   ;*10
000AC7 4AC7 4F               4      LD  C,A
000AC8 4AC8 0600             7      LD  B,0
000ACA 4ACA 09              11      ADD HL,BC
000ACB 4ACB 18EC            12      JR  GETNUM1
                                
       4ACD                     SEARCH_END:
000ACD 4ACD 7E               7      LD  A,(HL)
       4ACE                     SEARCH_END1:
000ACE 4ACE 23               6      INC HL
000ACF 4ACF B7               4      OR  A
000AD0 4AD0 C8              11      RET Z
000AD1 4AD1 FE3A             7      CP  ':'
000AD3 4AD3 20F8            12      JR  NZ,SEARCH_END
000AD5 4AD5 7E               7      LD  A,(HL)
000AD6 4AD6 FE3A             7      CP  ':'
000AD8 4AD8 28F4            12      JR  Z,SEARCH_END1
000ADA 4ADA C9              10      RET
                                
       4ADB                     FKANC:
000ADB 4ADB CB41             8      BIT 0,C
000ADD 4ADD CC004B          17      CALL    Z,CAP2
000AE0 4AE0 1803            12      JR  FKANX
       4AE2                     FKAN:           ;漢字チェック
000AE2 4AE2 DD23            10      INC IX
000AE4 4AE4 1D               4      DEC E
       4AE5                     FKANX:
000AE5 4AE5 CB41             8      BIT 0,C
000AE7 4AE7 CB81             8      RES 0,C
000AE9 4AE9 C0              11      RET NZ
000AEA 4AEA FE80             7      CP  080H
000AEC 4AEC D8              11      RET C
000AED 4AED FEA0             7      CP  0A0H
000AEF 4AEF 3803            12      JR  C,FKAN1
000AF1 4AF1 FEE0             7      CP  0E0H
000AF3 4AF3 D8              11      RET C
       4AF4                     FKAN1:
000AF4 4AF4 0C               4      INC C
000AF5 4AF5 A7               4      AND A
000AF6 4AF6 C9              10      RET
                                
       4AF7                     CAP:
000AF7 4AF7 FE61             7      CP  'a'
000AF9 4AF9 D8              11      RET C
000AFA 4AFA FE7B             7      CP  'z'+1
000AFC 4AFC D0              11      RET NC
000AFD 4AFD D620             7      SUB 020H
000AFF 4AFF C9              10      RET
       4B00                     CAP2:
000B00 4B00 CDF74A          17      CALL    CAP
       4B03                     CAP3:               ;
000B03 4B03 FE05             7      CP  5
000B05 4B05 2803            12      JR  Z,CAP4
000B07 4B07 FE21             7      CP  021H
000B09 4B09 C9              10      RET
       4B0A                     CAP4:
000B0A 4B0A 3EE5             7      LD  A,0E5H
000B0C 4B0C C9              10      RET
                                
       4B0D                     ROM_OPEN:
000B0D 4B0D CDFE4E          17      CALL    GET_DISK_BANK_FDRV
                                
000B10 4B10 CD2A4D          17      CALL    GET_DIR_DAT
000B13 4B13 D5              11      PUSH    DE
000B14 4B14 CD294B          17      CALL    FILESE
000B17 4B17 D1              10      POP DE
000B18 4B18 3F               4      CCF
000B19 4B19 D8              11      RET C
000B1A 4B1A 224BF1          16      LD  (FCBX),HL
000B1D 4B1D E5              11      PUSH    HL
000B1E 4B1E 210000          10      LD  HL,0
000B21 4B21 2225F1          16      LD  (RR_LOW),HL
000B24 4B24 2227F1          16      LD  (RR_HIGH),HL
000B27 4B27 E1              10      POP HL
000B28 4B28 C9              10      RET
                                
       4B29                     FILESE:
000B29 4B29 7E               7      LD  A,(HL)
000B2A 4B2A B7               4      OR  A
000B2B 4B2B C8              11      RET Z       ;END:ZF=1 CF=0
000B2C 4B2C FEE5             7      CP  0E5H
000B2E 4B2E 280D            12      JR  Z,FILESE1
000B30 4B30 1154F1          10      LD  DE,FNAME
000B33 4B33 E5              11      PUSH    HL
000B34 4B34 CD4B4B          17      CALL    CPFILE
000B37 4B37 CC6C4B          17      CALL    Z,CPFILE2
000B3A 4B3A E1              10      POP HL
000B3B 4B3B 37               4      SCF
000B3C 4B3C C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4B3D                     FILESE1:
000B3D 4B3D CD454B          17      CALL    FNEXT
000B40 4B40 20E7            12      JR  NZ,FILESE
       4B42                     ZF0_CF0_AFF_RET:
000B42 4B42 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000B44 4B44 C9              10      RET
                                
       4B45                     FNEXT:
000B45 4B45 112000          10      LD  DE,020H
000B48 4B48 19              11      ADD HL,DE
000B49 4B49 0D               4      DEC C
                                #if exists USE_NORMAL_32K_ROM
                                #else
                                CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
                                    PUSH    AF
                                    BIT 7,H
                                    JR  Z,CHECK_DIR_PAGE1
                                    LD  A,H
                                    SUB 020H
                                    LD  H,A
                                    LD  A,(_BANK)
                                    INC A
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                CHECK_DIR_PAGE1:
                                    POP AF
                                #endif
000B4A 4B4A C9              10      RET
                                
       4B4B                     CPFILE:
000B4B 4B4B C5              11      PUSH    BC
000B4C 4B4C 01000B          10      LD  BC,00B00H
       4B4F                     CPSTR1:
000B4F 4B4F 1A               7      LD  A,(DE)
000B50 4B50 FE3F             7      CP  '?'     ;Wild card
000B52 4B52 2812            12      JR  Z,CPSTR2
000B54 4B54 7E               7      LD  A,(HL)
000B55 4B55 CDDB4A          17      CALL    FKANC
000B58 4B58 E5              11      PUSH    HL
000B59 4B59 67               4      LD  H,A
000B5A 4B5A 1A               7      LD  A,(DE)
000B5B 4B5B CB01             4      RLC C
000B5D 4B5D CDDB4A          17      CALL    FKANC
000B60 4B60 CB09             4      RRC C
000B62 4B62 BC               4      CP  H       ;CP (HL),(DE)
000B63 4B63 E1              10      POP HL
000B64 4B64 2004            12      JR  NZ,CPSTR3
       4B66                     CPSTR2:
000B66 4B66 13               6      INC DE
000B67 4B67 23               6      INC HL
000B68 4B68 10E5            13      DJNZ    CPSTR1
       4B6A                     CPSTR3:
000B6A 4B6A C1              10      POP BC
000B6B 4B6B C9              10      RET
                                
       4B6C                     CPFILE2:
                                ;   LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
                                ;   OR  0E1H
000B6C 4B6C 3EE1             7      LD  A,0E1H
000B6E 4B6E 2F               4      CPL
000B6F 4B6F A6               7      AND (HL)
000B70 4B70 C9              10      RET
                                
       4B71                     RBX1:
000B71 4B71 E5              11      PUSH    HL      ;Record byte
                                
000B72 4B72 ED5B25F1        20      LD  DE,(RR_LOW) ;CDE=Random record
000B76 4B76 3A28F1          13      LD  A,(RR_HIGH+1)
000B79 4B79 4F               4      LD  C,A
                                
000B7A 4B7A CDFE4E          17      CALL    GET_DISK_BANK_FDRV
                                
000B7D 4B7D FD2A4BF1        20      LD  IY,(FCBX)
000B81 4B81 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000B84 4B84 FD661D          19      LD  H,(IY+01DH)
000B87 4B87 FD7E1E          19      LD  A,(IY+01EH)
                                
000B8A 4B8A A7               4      AND A
000B8B 4B8B ED52            15      SBC HL,DE
000B8D 4B8D 99               4      SBC A,C
000B8E 4B8E D1              10      POP DE
                                
000B8F 4B8F D8              11      RET C
000B90 4B90 4F               4      LD  C,A
000B91 4B91 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000B92 4B92 B2               4      OR  D
000B93 4B93 B3               4      OR  E
000B94 4B94 C0              11      RET NZ
000B95 4B95 37               4      SCF
000B96 4B96 C9              10      RET
                                
       4B97                     RBX2:
000B97 4B97 ED4B26F1        20      LD  BC,(RR_LOW+1)
000B9B 4B9B CD1F4C          17      CALL    RWXR
000B9E 4B9E 3A22F1          13      LD  A,(CLSZ_H)
000BA1 4BA1 3D               4      DEC A
000BA2 4BA2 E5              11      PUSH    HL
000BA3 4BA3 2A25F1          16      LD  HL,(RR_LOW)
000BA6 4BA6 A4               4      AND H
000BA7 4BA7 B5               4      OR  L
000BA8 4BA8 E1              10      POP HL
000BA9 4BA9 C9              10      RET
                                
       4BAA                     RBXA:
000BAA 4BAA D5              11      PUSH    DE
000BAB 4BAB CD8E4C          17      CALL    CLUST
000BAE 4BAE ED532DF1        20      LD  (_DTPS),DE
000BB2 4BB2 D1              10      POP DE
000BB3 4BB3 CD6B4C          17      CALL    GNCL
000BB6 4BB6 D8              11      RET C
000BB7 4BB7 ED5329F1        20      LD  (_CLPS),DE
                                
000BBB 4BBB ED4B25F1        20      LD  BC,(RR_LOW)
000BBF 4BBF 2A21F1          16      LD  HL,(CLSZ)
000BC2 4BC2 7C               4      LD  A,H
000BC3 4BC3 3D               4      DEC A
000BC4 4BC4 A0               4      AND B
000BC5 4BC5 47               4      LD  B,A
000BC6 4BC6 ED42            15      SBC HL,BC       ;remaining cluster
                                
000BC8 4BC8 ED5B4DF1        20      LD  DE,(LEFTX)
000BCC 4BCC ED52            15      SBC HL,DE       ;CP HL,DE
000BCE 4BCE 19              11      ADD HL,DE
000BCF 4BCF 3801            12      JR  C,RBXA1
000BD1 4BD1 EB               4      EX  DE,HL
       4BD2                     RBXA1:
000BD2 4BD2 3A20F1          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
000BD5 4BD5 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000BD8 4BD8 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000BDB 4BDB E5              11      PUSH    HL
000BDC 4BDC 2A2DF1          16      LD  HL,(_DTPS)
000BDF 4BDF 09              11      ADD HL,BC
000BE0 4BE0 ED5B47F1        20      LD  DE,(DTAX)
000BE4 4BE4 C1              10      POP BC
000BE5 4BE5 C9              10      RET
                                
       4BE6                     RBXB:
000BE6 4BE6 2A47F1          16      LD  HL,(DTAX)
000BE9 4BE9 ED5B29F1        20      LD  DE,(_CLPS)
000BED 4BED 3A4EF1          13      LD  A,(LEFTX+1)
000BF0 4BF0 47               4      LD  B,A
000BF1 4BF1 3A22F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4BF4                     RBXB1:
000BF4 4BF4 1F               4      RRA     ;->CF
000BF5 4BF5 3804            12      JR  C,RBXB2
000BF7 4BF7 CB38             8      SRL B   ;B=B/2
000BF9 4BF9 18F9            12      JR  RBXB1
       4BFB                     RBXB2:
000BFB 4BFB 78               4      LD  A,B
000BFC 4BFC B7               4      OR  A
000BFD 4BFD C9              10      RET
                                
       4BFE                     RBXC:
000BFE 4BFE ED4B4DF1        20      LD  BC,(LEFTX)
000C02 4C02 3A22F1          13      LD  A,(CLSZ_H)
000C05 4C05 3D               4      DEC A
000C06 4C06 A0               4      AND B
000C07 4C07 47               4      LD  B,A
000C08 4C08 B1               4      OR  C
000C09 4C09 C9              10      RET
                                
       4C0A                     RBXEND:
000C0A 4C0A ED5B2BF1        20      LD  DE,(_LEFT)
000C0E 4C0E 2A25F1          16      LD  HL,(RR_LOW)
000C11 4C11 3A28F1          13      LD  A,(RR_HIGH+1)
000C14 4C14 19              11      ADD HL,DE
000C15 4C15 CE00             7      ADC A,0
000C17 4C17 2225F1          16      LD  (RR_LOW),HL
000C1A 4C1A 3228F1          13      LD  (RR_HIGH+1),A
000C1D 4C1D EB               4      EX  DE,HL       ;HL=Read byte
000C1E 4C1E C9              10      RET 
                                
       4C1F                     RWXR:
000C1F 4C1F 3A22F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4C22                     L_RWX:
000C22 4C22 1F               4      RRA     ;->CF
000C23 4C23 3806            12      JR  C,E_RWX
000C25 4C25 CB38             8      SRL B   ;BC=BC/2
000C27 4C27 CB19             8      RR  C   ;
000C29 4C29 18F7            12      JR  L_RWX
       4C2B                     E_RWX:
000C2B 4C2B CDFE4E          17      CALL    GET_DISK_BANK_FDRV
                                
000C2E 4C2E FD2A4BF1        20      LD  IY,(FCBX)
000C32 4C32 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000C35 4C35 FD561B          19      LD  D,(IY+01BH)
       4C38                     RWX1:
000C38 4C38 ED5329F1        20      LD  (_CLPS),DE
000C3C 4C3C 7A               4      LD  A,D
000C3D 4C3D B3               4      OR  E
000C3E 4C3E 37               4      SCF
000C3F 4C3F C8              11      RET Z
                                
000C40 4C40 78               4      LD  A,B
000C41 4C41 B1               4      OR  C
000C42 4C42 C8              11      RET Z
                                
000C43 4C43 CD6B4C          17      CALL    GNCL
000C46 4C46 D8              11      RET C
000C47 4C47 0B               6      DEC BC
000C48 4C48 CDC34C          17      CALL    ENDCL
000C4B 4C4B 38EB            12      JR  C,RWX1
000C4D 4C4D 37               4      SCF
000C4E 4C4E C9              10      RET
                                
       4C4F                     NCL3:
000C4F 4C4F CDFE4E          17      CALL    GET_DISK_BANK_FDRV
000C52 4C52 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C55 4C55 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000C58 4C58 6B               4      LD  L,E
000C59 4C59 62               4      LD  H,D
000C5A 4C5A CB3C             8      SRL H
000C5C 4C5C CB1D             8      RR  L
000C5E 4C5E 1F               4      RRA
000C5F 4C5F 19              11      ADD HL,DE
000C60 4C60 010060          10      LD  BC,BANK1_ADR
000C63 4C63 09              11      ADD HL,BC
000C64 4C64 ED4B23F1        20      LD  BC,(SECSZ)
000C68 4C68 09              11      ADD HL,BC
000C69 4C69 17               4      RLA
000C6A 4C6A C9              10      RET
                                
       4C6B                     GNCL:
000C6B 4C6B 7A               4      LD  A,D
000C6C 4C6C B3               4      OR  E
000C6D 4C6D 37               4      SCF
000C6E 4C6E C8              11      RET Z
000C6F 4C6F C5              11      PUSH    BC
000C70 4C70 E5              11      PUSH    HL
000C71 4C71 CD4F4C          17      CALL    NCL3
000C74 4C74 3809            12      JR  C,GNC1
000C76 4C76 5E               7      LD  E,(HL)
000C77 4C77 23               6      INC HL
000C78 4C78 7E               7      LD  A,(HL)
000C79 4C79 E60F             7      AND 00FH
000C7B 4C7B 57               4      LD  D,A
000C7C 4C7C E1              10      POP HL
000C7D 4C7D C1              10      POP BC
000C7E 4C7E C9              10      RET
       4C7F                     GNC1:
000C7F 4C7F 7E               7      LD  A,(HL)
000C80 4C80 23               6      INC HL
000C81 4C81 56               7      LD  D,(HL)
000C82 4C82 0604             7      LD  B,4
       4C84                     GNC1L:
000C84 4C84 CB3A             8      SRL D
000C86 4C86 1F               4      RRA
000C87 4C87 10FB            13      DJNZ    GNC1L
                                
000C89 4C89 5F               4      LD  E,A
000C8A 4C8A E1              10      POP HL
000C8B 4C8B C1              10      POP BC
000C8C 4C8C A7               4      AND A
000C8D 4C8D C9              10      RET
                                
       4C8E                     CLUST:
000C8E 4C8E EB               4      EX  DE,HL
000C8F 4C8F C5              11      PUSH    BC
000C90 4C90 3A22F1          13      LD  A,(CLSZ_H)
000C93 4C93 CD2A4F          17      CALL    MUL_AHL
                                
000C96 4C96 CD374D          17      CALL    GET_DIR_POS
000C99 4C99 4F               4      LD  C,A
000C9A 4C9A 0600             7      LD  B,0
000C9C 4C9C 09              11      ADD HL,BC
                                
000C9D 4C9D 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000CA0 4CA0 0F               4      RRCA
000CA1 4CA1 0F               4      RRCA
000CA2 4CA2 0F               4      RRCA
000CA3 4CA3 0F               4      RRCA
000CA4 4CA4 4F               4      LD  C,A
                                
000CA5 4CA5 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000CA8 4CA8 FE02             7      CP  2
000CAA 4CAA 280C            12      JR  Z,CLUST1
000CAC 4CAC CB01             4      RLC C
000CAE 4CAE 0D               4      DEC C
000CAF 4CAF 3A0C60          13      LD  A,(BANK1_ADR+11+1)  ;BPB_BytsPerSec High    
000CB2 4CB2 FE02             7      CP  2
000CB4 4CB4 2002            12      JR  NZ,CLUST1
000CB6 4CB6 0D               4      DEC C
000CB7 4CB7 0D               4      DEC C
       4CB8                     CLUST1:
000CB8 4CB8 0D               4      DEC C
000CB9 4CB9 09              11      ADD HL,BC
                                
                                #if exists USE_NORMAL_32K_ROM
000CBA 4CBA 7D               4      LD  A,L
                                #else
                                    PUSH    HL
                                    ADD HL,HL   ;*2
                                    ADD HL,HL   ;*4
                                    ADD HL,HL   ;*8
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    POP HL
                                    LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
                                    AND L
                                #endif
000CBB 4CBB C660             7      ADD A,high BANK1_ADR
000CBD 4CBD 67               4      LD  H,A
000CBE 4CBE 2E00             7      LD  L,0
000CC0 4CC0 EB               4      EX  DE,HL
000CC1 4CC1 C1              10      POP BC
000CC2 4CC2 C9              10      RET
                                
       4CC3                     ENDCL:
000CC3 4CC3 7A               4      LD  A,D ;END CLUSTER
000CC4 4CC4 FE0F             7      CP  00FH    ;FAT12の最大値
000CC6 4CC6 C0              11      RET NZ
000CC7 4CC7 7B               4      LD  A,E
000CC8 4CC8 FEF7             7      CP  0F7H
000CCA 4CCA C9              10      RET
                                
       4CCB                     RB_READ:
000CCB 4CCB AF               4      XOR A   ;HLA = HL*128
000CCC 4CCC CB3C             8      SRL H
000CCE 4CCE CB1D             8      RR  L
000CD0 4CD0 1F               4      RRA
000CD1 4CD1 3225F1          13      LD  (RR_LOW),A
000CD4 4CD4 2226F1          16      LD  (RR_MID),HL
000CD7 4CD7 218000          10      LD  HL,128
                                
000CDA 4CDA CD2D49          17      CALL    ROM_READ
000CDD 4CDD C9              10      RET
                                
       4CDE                     GETSEQ:
000CDE 4CDE FD6E20          19      LD  L,(IY+32)
000CE1 4CE1 FD660C          19      LD  H,(IY+12)
                                
000CE4 4CE4 CB25             8      SLA L
                                
000CE6 4CE6 CB3C             8      SRL H
000CE8 4CE8 CB1D             8      RR  L
000CEA 4CEA C9              10      RET
                                
       4CEB                     SETSEQ:
000CEB 4CEB F5              11      PUSH    AF
000CEC 4CEC 3A25F1          13      LD  A,(RR_LOW)
000CEF 4CEF 2A26F1          16      LD  HL,(RR_MID)
                                
000CF2 4CF2 CD094D          17      CALL    SSQ1
                                
000CF5 4CF5 29              11      ADD HL,HL
000CF6 4CF6 CB3D             8      SRL L
000CF8 4CF8 FD7520          19      LD  (IY+32),L
000CFB 4CFB FD740C          19      LD  (IY+12),H
000CFE 4CFE F1              10      POP AF
000CFF 4CFF C9              10      RET
                                
       4D00                     GETSIZE:
000D00 4D00 FD7E10          19      LD  A,(IY+16)
000D03 4D03 FD6E11          19      LD  L,(IY+17)
000D06 4D06 FD6612          19      LD  H,(IY+18)
       4D09                     SSQ1:
000D09 4D09 87               4      ADD A,A
000D0A 4D0A ED6A            15      ADC HL,HL
000D0C 4D0C B7               4      OR  A
000D0D 4D0D C8              11      RET Z
000D0E 4D0E 23               6      INC HL
000D0F 4D0F C9              10      RET
                                
       4D10                     SET_FCB:
000D10 4D10 D5              11      PUSH    DE
000D11 4D11 FDE1            14      POP IY
000D13 4D13 FD7E1C          19      LD  A,(IY+28)
000D16 4D16 FEFF             7      CP  0FFH
000D18 4D18 200C            12      JR  NZ,POPAF_SCF_FF_RET
000D1A 4D1A E5              11      PUSH    HL
000D1B 4D1B FD6E1A          19      LD  L,(IY+26)
000D1E 4D1E FD661B          19      LD  H,(IY+27)
000D21 4D21 2229F1          16      LD  (_CLPS),HL
000D24 4D24 E1              10      POP HL
000D25 4D25 C9              10      RET
                                
       4D26                     POPAF_SCF_FF_RET:
000D26 4D26 F1              10      POP AF
000D27 4D27 37               4      SCF
000D28 4D28 9F               4      SBC A,A
000D29 4D29 C9              10      RET
                                
       4D2A                     GET_DIR_DAT:
000D2A 4D2A CD374D          17      CALL    GET_DIR_POS
000D2D 4D2D C660             7      ADD A,high BANK1_ADR
000D2F 4D2F 2E00             7      LD  L,0
000D31 4D31 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_NORMAL_32K_ROM
                                #else
                                    CALL    CHECK_DIR_PAGE
                                #endif
000D32 4D32 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000D35 4D35 4F               4      LD  C,A
000D36 4D36 C9              10      RET
                                
       4D37                     GET_DIR_POS:
000D37 4D37 CDFE4E          17      CALL    GET_DISK_BANK_FDRV
000D3A 4D3A 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D3D 4D3D 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D40 4D40 3220F1          13      LD  (_BANK),A
000D43 4D43 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000D46 4D46 47               4      LD  B,A
000D47 4D47 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000D4A 4D4A 4F               4      LD  C,A
000D4B 4D4B 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4D4E                     GET_DIR_POS1:
000D4E 4D4E 81               4      ADD A,C
000D4F 4D4F 10FD            13      DJNZ    GET_DIR_POS1
                                
000D51 4D51 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec 
       4D55                     L_MDP:
000D55 4D55 CB18             8      RR  B   ;->CF
000D57 4D57 D8              11      RET C
000D58 4D58 87               4      ADD A,A
000D59 4D59 18FA            12      JR  L_MDP
                                
       4D5B                     WILDCARD:
000D5B 4D5B 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4D66                     ERROR_WRITE_PROTECTED:
000D66 4D66 3E00             7      LD  A,0     ;Write protected
000D68 4D68 C9              10      RET
       4D69                     DISKIO:
000D69 4D69 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000D6B 4D6B 48               4      LD  C,B
000D6C 4D6C CD084F          17      CALL    GET_DISK_BANK
       4D6F                     SETMAP1:        
000D6F 4D6F E5              11      PUSH    HL
       4D70                     DISKIO1:
000D70 4D70 C5              11      PUSH    BC      ;B=残りのセクタ数
000D71 4D71 D5              11      PUSH    DE      ;DE=セクタ番号
000D72 4D72 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
000D73 4D73 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
000D74 4D74 F5              11      PUSH    AF
000D75 4D75 3A24F1          13      LD  A,(SECSZ_H)
000D78 4D78 CD2A4F          17      CALL    MUL_AHL
000D7B 4D7B F1              10      POP AF
000D7C 4D7C 4D               4      LD  C,L     ;C=読み出し元
000D7D 4D7D 29              11      ADD HL,HL       ;64KB→32KB
000D7E 4D7E 29              11      ADD HL,HL       ;32KB→16KB
000D7F 4D7F 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
000D80 4D80 84               4      ADD A,H
000D81 4D81 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D84 4D84 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D87 4D87 3220F1          13      LD  (_BANK),A
000D8A 4D8A 79               4      LD  A,C     ;C=読み出し元
000D8B 4D8B E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
000D8D 4D8D C660             7      ADD A,high BANK1_ADR
000D8F 4D8F 67               4      LD  H,A
000D90 4D90 ED4B23F1        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
000D94 4D94 69               4      LD  L,C     ;C=0
000D95 4D95 EDB0                    LDIR
000D97 4D97 EB               4      EX  DE,HL
000D98 4D98 F1              10      POP AF
000D99 4D99 D1              10      POP DE
000D9A 4D9A 13               6      INC DE
000D9B 4D9B C1              10      POP BC
000D9C 4D9C 10D2            13      DJNZ    DISKIO1
000D9E 4D9E 41               4      LD  B,C
                                
000D9F 4D9F E1              10      POP HL
000DA0 4DA0 AF               4      XOR A
000DA1 4DA1 FB               4      EI
000DA2 4DA2 C9              10      RET
                                
       4DA3                     DSKCHG:
000DA3 4DA3 CDDC4D          17      CALL    IS_BPB
000DA6 4DA6 3824            12      JR  C,NOTREADY
000DA8 4DA8 3A23FB          13      LD  A,(DRVTBL+2)
000DAB 4DAB B7               4      OR  A
000DAC 4DAC 201A            12      JR  NZ,DSKCHG1
000DAE 4DAE 3A21FB          13      LD  A,(DRVTBL)
000DB1 4DB1 FE02             7      CP  2
000DB3 4DB3 2013            12      JR  NZ,DSKCHG1
000DB5 4DB5 CDDC4D          17      CALL    IS_BPB
000DB8 4DB8 300E            12      JR  NC,DSKCHG1
000DBA 4DBA 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000DBC 4DBC 3221FB          13      LD  (DRVTBL),A
000DBF 4DBF 3223FB          13      LD  (DRVTBL+2),A
000DC2 4DC2 3A48F3          13      LD  A,(MASTERS)
000DC5 4DC5 3224FB          13      LD  (DRVTBL+3),A
       4DC8                     DSKCHG1:
000DC8 4DC8 AF               4      XOR A
000DC9 4DC9 0601             7      LD  B,1
000DCB 4DCB C9              10      RET
       4DCC                     NOTREADY:
000DCC 4DCC 3E02             7      LD  A,2
000DCE 4DCE 37               4      SCF
000DCF 4DCF C9              10      RET
                                
       4DD0                     NO_BPB:
000DD0 4DD0 E1              10      POP HL
000DD1 4DD1 23               6      INC HL
000DD2 4DD2 112F4F          10      LD  DE,DPB2DD
000DD5 4DD5 011200          10      LD  BC,DPB2DD_E-DPB2DD
000DD8 4DD8 EDB0                    LDIR
000DDA 4DDA AF               4      XOR A
000DDB 4DDB C9              10      RET
                                
       4DDC                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000DDC 4DDC CD084F          17      CALL    GET_DISK_BANK
                                
000DDF 4DDF 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000DE2 4DE2 FE01             7      CP  1
000DE4 4DE4 D8              11      RET C
                                
000DE5 4DE5 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000DE8 4DE8 C6FF             7      ADD A,0FFH
000DEA 4DEA D8              11      RET C
                                
000DEB 4DEB 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
000DEE 4DEE FE01             7      CP  1
000DF0 4DF0 C8              11      RET Z
000DF1 4DF1 FE02             7      CP  2
000DF3 4DF3 C8              11      RET Z
000DF4 4DF4 FE04             7      CP  4
000DF6 4DF6 C8              11      RET Z
000DF7 4DF7 37               4      SCF
000DF8 4DF8 C9              10      RET
                                
       4DF9                     GETDPB:
000DF9 4DF9 E5              11      PUSH    HL
000DFA 4DFA CD084F          17      CALL    GET_DISK_BANK
                                
000DFD 4DFD 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000E00 4E00 B7               4      OR  A
000E01 4E01 28CD            12      JR  Z,NO_BPB
000E03 4E03 DDE1            14      POP IX
000E05 4E05 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000E08 4E08 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000E0B 4E0B DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000E0E 4E0E 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000E11 4E11 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000E14 4E14 87               4      ADD A,A
000E15 4E15 87               4      ADD A,A
000E16 4E16 87               4      ADD A,A
000E17 4E17 3D               4      DEC A
000E18 4E18 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000E1B 4E1B 06FF             7      LD  B,-1
000E1D 4E1D A7               4      AND A           ;無限ループ阻止
       4E1E                     GETDPB1:
000E1E 4E1E 04               4      INC B
000E1F 4E1F 1F               4      RRA
000E20 4E20 38FC            12      JR  C,GETDPB1
000E22 4E22 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000E25 4E25 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000E28 4E28 3D               4      DEC A
000E29 4E29 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000E2C 4E2C A7               4      AND A           ;無限ループ阻止
000E2D 4E2D 06FF             7      LD  B,-1
       4E2F                     GETDPB2:
000E2F 4E2F 04               4      INC B
000E30 4E30 1F               4      RRA
000E31 4E31 38FC            12      JR  C,GETDPB2
000E33 4E33 04               4      INC B
000E34 4E34 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000E37 4E37 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
000E3A 4E3A DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
000E3D 4E3D DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
000E40 4E40 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
000E43 4E43 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000E46 4E46 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
000E49 4E49 DD770B          19      LD  (IX+11),A       ;FATCNT
                                
000E4C 4E4C ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
000E50 4E50 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
000E53 4E53 DD460A          19      LD  B,(IX+10)       ;FATCNT
000E56 4E56 210000          10      LD  HL,0
       4E59                     GETDPB3:
000E59 4E59 19              11      ADD HL,DE
000E5A 4E5A 10FD            13      DJNZ    GETDPB3
       4E5C                     GETDPB4:
000E5C 4E5C DD5E08          19      LD  E,(IX+8)        ;FIRFAT
000E5F 4E5F DD5609          19      LD  D,(IX+9)        ;FIRFAT
000E62 4E62 19              11      ADD HL,DE
000E63 4E63 DD7511          19      LD  (IX+17),L       ;FIRDIR
000E66 4E66 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000E69 4E69 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000E6C 4E6C 87               4      ADD A,A
000E6D 4E6D 87               4      ADD A,A
000E6E 4E6E DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4E71                     GETDPB5:
000E71 4E71 CB3B             8      SRL E
000E73 4E73 1F               4      RRA
000E74 4E74 30FB            12      JR  NC,GETDPB5
000E76 4E76 1600             7      LD  D,0
000E78 4E78 19              11      ADD HL,DE
000E79 4E79 DD750C          19      LD  (IX+12),L       ;FIRREC
000E7C 4E7C DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000E7F 4E7F 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
000E82 4E82 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
000E85 4E85 DD560D          19      LD  D,(IX+13)       ;FIRREC
000E88 4E88 A7               4      AND A
000E89 4E89 ED52            15      SBC HL,DE
                                
000E8B 4E8B DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
000E8E 4E8E 3C               4      INC A
000E8F 4E8F 37               4      SCF             ;無限ループ阻止
       4E90                     GETDPB6:
000E90 4E90 1F               4      RRA
000E91 4E91 3806            12      JR  C,GETDPB7
000E93 4E93 CB3C             8      SRL H
000E95 4E95 CB1D             8      RR  L
000E97 4E97 18F7            12      JR  GETDPB6
       4E99                     GETDPB7:
000E99 4E99 23               6      INC HL
000E9A 4E9A DD750E          19      LD  (IX+14),L       ;MAXCLUS
000E9D 4E9D DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       4EA0                     GETDPBD1:
000EA0 4EA0 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000EA3 4EA3 E6FC             7      AND 0FCH
000EA5 4EA5 C8              11      RET Z
                                
000EA6 4EA6 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
000EAA 4EAA 37               4      SCF
000EAB 4EAB DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
000EAF 4EAF DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
000EB2 4EB2 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
000EB6 4EB6 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
000EBA 4EBA DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
000EBE 4EBE DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
000EC2 4EC2 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
000EC6 4EC6 DDCB1126        23      SLA (IX+17)         ;FIRDIR
000ECA 4ECA DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
000ECE 4ECE DD6E11          19      LD  L,(IX+17)       ;FIRDIR
000ED1 4ED1 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
000ED4 4ED4 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000ED7 4ED7 87               4      ADD A,A
000ED8 4ED8 87               4      ADD A,A
000ED9 4ED9 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4EDC                     GETDPBD5:
000EDC 4EDC CB3B             8      SRL E
000EDE 4EDE 1F               4      RRA
000EDF 4EDF 30FB            12      JR  NC,GETDPBD5
000EE1 4EE1 1600             7      LD  D,0
000EE3 4EE3 19              11      ADD HL,DE
000EE4 4EE4 DD750C          19      LD  (IX+12),L       ;FIRREC
000EE7 4EE7 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000EEA 4EEA 18B4            12      JR  GETDPBD1
                                
       4EEC                     CHOICE:
000EEC 4EEC 210000          10      LD  HL,0
000EEF 4EEF C9              10      RET
                                
       4EF0                     DSKFMT:
000EF0 4EF0 AF               4      XOR A
000EF1 4EF1 37               4      SCF
       4EF2                     DSKSTP:
000EF2 4EF2 C9              10      RET
                                
       4EF3                     BASENT:
000EF3 4EF3 ED7B5FF1        20      LD  SP,(BASSTK)
000EF7 4EF7 C3C043          10      JP  BASAUTO
                                
       4EFA                     GETSLT:
000EFA 4EFA 3A22FB          13      LD  A,(DRVTBL+1)
000EFD 4EFD C9              10      RET
                                
       4EFE                     GET_DISK_BANK_FDRV:
000EFE 4EFE 3A53F1          13      LD  A,(FDRV)
000F01 4F01 D601             7      SUB 1
000F03 4F03 3003            12      JR  NC,GET_DISK_BANK
000F05 4F05 3A4AF1          13      LD  A,(_DVSW)
       4F08                     GET_DISK_BANK:
000F08 4F08 B7               4      OR  A       ;A=DRIVE
000F09 4F09 3E01             7      LD  A,DISK_BANK
000F0B 4F0B 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
000F0D 4F0D 3A49F1          13      LD  A,(B_DRIVE)
                                #endif
       4F10                     SET_DISK_BANK:
000F10 4F10 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000F13 4F13 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000F16 4F16 F5              11      PUSH    AF
000F17 4F17 E5              11      PUSH    HL
000F18 4F18 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
000F1B 4F1B 2223F1          16      LD  (SECSZ),HL
000F1E 4F1E 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000F21 4F21 CD2A4F          17      CALL    MUL_AHL
000F24 4F24 2221F1          16      LD  (CLSZ),HL
000F27 4F27 E1              10      POP HL
000F28 4F28 F1              10      POP AF
000F29 4F29 C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)
       4F2A                     MUL_AHL:
000F2A 4F2A 1F               4      RRA     ;->CF
000F2B 4F2B D8              11      RET C
000F2C 4F2C 29              11      ADD HL,HL
000F2D 4F2D 18FB            12      JR  MUL_AHL
                                
       4F2F                     DPB2DD:
000F2F 4F2F F9                      DB  0F9H    ;MEDIA
000F30 4F30 0002                    DW  00200H  ;SECSIZ
000F32 4F32 0F                      DB  00FH    ;DIRMSK
000F33 4F33 04                      DB  004H    ;DIRSHFT
000F34 4F34 01                      DB  001H    ;CLUSMSK
000F35 4F35 02                      DB  002H    ;CLUSSHFT
000F36 4F36 0100                    DW  00001H  ;FIRFAT
000F38 4F38 02                      DB  002H    ;FATCNT
000F39 4F39 70                      DB  070H    ;MAXENT
000F3A 4F3A 0E00                    DW  0000EH  ;FIRREC
000F3C 4F3C CA02                    DW  002CAH  ;MAXCLUS
000F3E 4F3E 03                      DB  003H    ;FATSIZ
000F3F 4F3F 0700                    DW  0007H   ;FIRDIR
       4F41                     DPB2DD_E:
                                
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       4F41                     POP_HL_ERROR:
000F41 4F41 E1              10      POP     HL
       4F42                     _ERROR:
000F42 4F42 0600             7      LD  B,0
000F44 4F44 A7               4      AND A
000F45 4F45 C9              10      RET
                                
       4F46                     ROM_BDOS:
000F46 4F46 E5              11      PUSH    HL
000F47 4F47 79               4      LD  A,C
000F48 4F48 87               4      ADD A,A
000F49 4F49 38F7            12      JR  C,_ERROR
000F4B 4F4B 6F               4      LD  L,A
000F4C 4F4C 265F             7      LD  H,high STABLE
000F4E 4F4E 7E               7      LD  A,(HL)
000F4F 4F4F 2C               4      INC L
000F50 4F50 66               7      LD  H,(HL)
000F51 4F51 6F               4      LD  L,A
000F52 4F52 E3              19      EX  (SP),HL
000F53 4F53 79               4      LD  A,C
000F54 4F54 C9              10      RET
                                
       4F55                     _PRINT:
       4F55                     PRINT:
000F55 4F55 7B               4      LD  A,E
000F56 4F56 1803            12      JR  MSG_A
                                
       4F58                     _SYS01:     ;(BDOS)コンソール入力
000F58 4F58 CDCF4F          17      CALL    _SYS07
       4F5B                     MSG_A:
000F5B 4F5B FE03             7      CP  3
000F5D 4F5D 2814            12      JR  Z,MSG_BR
       4F5F                     MSGA1:
000F5F 4F5F F5              11      PUSH    AF
000F60 4F60 C5              11      PUSH    BC
000F61 4F61 D5              11      PUSH    DE
000F62 4F62 E5              11      PUSH    HL
000F63 4F63 DDE5            15      PUSH    IX
000F65 4F65 DD21A200        14      LD  IX,CHPUT
000F69 4F69 CDE742          17      CALL    CALSLT_R
000F6C 4F6C DDE1            14      POP IX
000F6E 4F6E E1              10      POP HL
000F6F 4F6F D1              10      POP DE
000F70 4F70 C1              10      POP BC
       4F71                     MSGA2:
000F71 4F71 F1              10      POP AF
000F72 4F72 C9              10      RET
       4F73                     MSG_BR:
000F73 4F73 F5              11      PUSH    AF
000F74 4F74 3ADDF3          13      LD  A,(CSRX)
000F77 4F77 FE02             7      CP  2
000F79 4F79 38F6            12      JR  C,MSGA2
000F7B 4F7B F1              10      POP AF
       4F7C                     MSG_CR:
000F7C 4F7C F5              11      PUSH    AF
000F7D 4F7D 3E0D             7      LD  A,00DH
000F7F 4F7F CD5F4F          17      CALL    MSGA1
000F82 4F82 3E0A             7      LD  A,00AH
000F84 4F84 CD5F4F          17      CALL    MSGA1
000F87 4F87 F1              10      POP AF
000F88 4F88 C9              10      RET
                                
       4F89                     _SYS02:     ;(BDOS)コンソール出力
000F89 4F89 CDA44F          17      CALL    BREAK
000F8C 4F8C 1805            12      JR  PRINTX
                                
       4F8E                     _SYS06:     ;(BDOS)コンソール直接入出力
000F8E 4F8E 7B               4      LD  A,E
000F8F 4F8F 3C               4      INC A
000F90 4F90 CAE34F          10      JP  Z,_INKEY
       4F93                     PRINTX:
000F93 4F93 C3554F          10      JP  _PRINT
                                
       4F96                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000F96 4F96 CDCF4F          17      CALL    _SYS07
000F99 4F99 FE03             7      CP  3
000F9B 4F9B CCA44F          17      CALL    Z,_BREAK
000F9E 4F9E FE13             7      CP  013H        ;CTRL+S
000FA0 4FA0 C0              11      RET NZ
       4FA1                     PAUSE:
000FA1 4FA1 CDBB4F          17      CALL    KEYBC
                                
       4FA4                     _BREAK:
       4FA4                     BREAK:
000FA4 4FA4 F5              11      PUSH    AF
000FA5 4FA5 C5              11      PUSH    BC
000FA6 4FA6 D5              11      PUSH    DE
000FA7 4FA7 E5              11      PUSH    HL
000FA8 4FA8 DDE5            15      PUSH    IX
000FAA 4FAA DD21B700        14      LD  IX,BREAKX
000FAE 4FAE CDE742          17      CALL    CALSLT_R
000FB1 4FB1 DDE1            14      POP IX
000FB3 4FB3 E1              10      POP HL
000FB4 4FB4 D1              10      POP DE
000FB5 4FB5 C1              10      POP BC
000FB6 4FB6 DCA44F          17      CALL    C,_BREAK
000FB9 4FB9 F1              10      POP AF
000FBA 4FBA C9              10      RET
       4FBB                     KEYBC:
000FBB 4FBB F5              11      PUSH    AF
000FBC 4FBC C5              11      PUSH    BC
000FBD 4FBD D5              11      PUSH    DE
000FBE 4FBE E5              11      PUSH    HL
000FBF 4FBF DDE5            15      PUSH    IX
000FC1 4FC1 DD215601        14      LD  IX,KILBUF
000FC5 4FC5 CDE742          17      CALL    CALSLT_R
000FC8 4FC8 DDE1            14      POP IX
000FCA 4FCA E1              10      POP HL
000FCB 4FCB D1              10      POP DE
000FCC 4FCC C1              10      POP BC
000FCD 4FCD F1              10      POP AF
000FCE 4FCE C9              10      RET
                                
       4FCF                     _SYS07:
       4FCF                     FLGET:
000FCF 4FCF C5              11      PUSH    BC
000FD0 4FD0 D5              11      PUSH    DE
000FD1 4FD1 E5              11      PUSH    HL
000FD2 4FD2 DDE5            15      PUSH    IX
000FD4 4FD4 DD219F00        14      LD  IX,CHGET
000FD8 4FD8 CDE742          17      CALL    CALSLT_R
000FDB 4FDB DDE1            14      POP IX
000FDD 4FDD E1              10      POP HL
000FDE 4FDE D1              10      POP DE
000FDF 4FDF C1              10      POP BC
000FE0 4FE0 FE03             7      CP  3
000FE2 4FE2 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       4FE3                     _INKEY:
       4FE3                     INKEY:
000FE3 4FE3 CD7D50          17      CALL    CPM_CONST
000FE6 4FE6 C8              11      RET Z
000FE7 4FE7 18E6            12      JR  FLGET
                                
       4FE9                     _SYS0A:     ;(BDOS)文字列入力
000FE9 4FE9 C5              11      PUSH    BC
000FEA 4FEA E5              11      PUSH    HL
000FEB 4FEB D5              11      PUSH    DE
000FEC 4FEC CD1550          17      CALL    GETL
000FEF 4FEF 111FF4          10      LD  DE,KBUF
000FF2 4FF2 E1              10      POP HL
000FF3 4FF3 E5              11      PUSH    HL
000FF4 4FF4 0E00             7      LD  C,0
000FF6 4FF6 3004            12      JR  NC,SAX0
000FF8 4FF8 23               6      INC HL
000FF9 4FF9 23               6      INC HL
000FFA 4FFA 1808            12      JR  SAX4
       4FFC                     SAX0:
000FFC 4FFC 46               7      LD  B,(HL)
000FFD 4FFD 23               6      INC HL
       4FFE                     SAX1:
000FFE 4FFE 23               6      INC HL
000FFF 4FFF 1A               7      LD  A,(DE)
001000 5000 13               6      INC DE
001001 5001 B7               4      OR  A
001002 5002 2004            12      JR  NZ,SAX2
       5004                     SAX4:
001004 5004 360D            10      LD  (HL),00DH
001006 5006 1804            12      JR  SAX3
       5008                     SAX2:
001008 5008 77               7      LD  (HL),A
001009 5009 0C               4      INC C
00100A 500A 10F2            13      DJNZ    SAX1
       500C                     SAX3:
00100C 500C D1              10      POP DE
00100D 500D 79               4      LD  A,C
00100E 500E 13               6      INC DE
00100F 500F 12               7      LD  (DE),A
001010 5010 1B               6      DEC DE
001011 5011 E1              10      POP HL
001012 5012 C1              10      POP BC
001013 5013 A7               4      AND A
001014 5014 C9              10      RET
       5015                     GETL:
001015 5015 DDE5            15      PUSH    IX
001017 5017 FDE5            15      PUSH    IY
                                
001019 5019 2ADCF3          16      LD  HL,(CSRY)
00101C 501C 22CAFB          16      LD  (FSTPOS),HL
       501F                     GETL1:
00101F 501F CD964F          17      CALL    _SYS08
001022 5022 FE09             7      CP  9
001024 5024 2008            12      JR  NZ,GETL1V
001026 5026 211FF4          10      LD  HL,KBUF
001029 5029 CD7243          17      CALL    MSX
00102C 502C 18F1            12      JR  GETL1
       502E                     GETL1V:
00102E 502E 5F               4      LD  E,A
00102F 502F FE08             7      CP  8
001031 5031 CCCB50          17      CALL    Z,CTRL02
001034 5034 FE20             7      CP  020H
001036 5036 D4F750          17      CALL    NC,INSERT
001039 5039 CD5F4F          17      CALL    MSGA1
                                
00103C 503C 7B               4      LD  A,E
00103D 503D FE0D             7      CP  00DH
00103F 503F 20DE            12      JR  NZ,GETL1
                                
001041 5041 111FF4          10      LD  DE,KBUF
001044 5044 3AB0F3          13      LD  A,(LINLEN)
001047 5047 47               4      LD  B,A
001048 5048 CDAA52          17      CALL    ZERO_MEMORY_DE
                                
00104B 504B 2ACAFB          16      LD  HL,(FSTPOS)
00104E 504E 3ADCF3          13      LD  A,(CSRY)
001051 5051 6F               4      LD  L,A
001052 5052 E5              11      PUSH    HL
001053 5053 CD2851          17      CALL    LOC0
001056 5056 4D               4      LD  C,L
001057 5057 44               4      LD  B,H
001058 5058 E1              10      POP HL
001059 5059 3AB0F3          13      LD  A,(LINLEN)
00105C 505C 94               4      SUB H
00105D 505D 3D               4      DEC A
00105E 505E 5F               4      LD  E,A
00105F 505F 211FF4          10      LD  HL,KBUF
       5062                     GETL2:
001062 5062 CDBB50          17      CALL    _SCRN
001065 5065 03               6      INC BC
001066 5066 77               7      LD  (HL),A
001067 5067 23               6      INC HL
001068 5068 1D               4      DEC E
001069 5069 20F7            12      JR  NZ,GETL2
00106B 506B CD7C4F          17      CALL    MSG_CR
                                
00106E 506E FDE1            14      POP IY
001070 5070 DDE1            14      POP IX
       5072                     GETL3:
001072 5072 2B               6      DEC HL
001073 5073 7E               7      LD  A,(HL)
001074 5074 FE21             7      CP  021H
001076 5076 D0              11      RET NC
001077 5077 3600            10      LD  (HL),0
001079 5079 15               4      DEC D
00107A 507A 20F6            12      JR  NZ,GETL3
00107C 507C C9              10      RET
                                
       507D                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       507D                     CONSTX:
       507D                     CPM_CONST:
00107D 507D C5              11      PUSH    BC
00107E 507E D5              11      PUSH    DE
00107F 507F E5              11      PUSH    HL
001080 5080 DDE5            15      PUSH    IX
001082 5082 DD219C00        14      LD  IX,CHSNS
001086 5086 CDE742          17      CALL    CALSLT_R
001089 5089 DDE1            14      POP IX
00108B 508B E1              10      POP HL
00108C 508C D1              10      POP DE
00108D 508D C1              10      POP BC
00108E 508E C9              10      RET
                                
       508F                     _SYS2A:     ;(BDOS)日付の獲得
00108F 508F AF               4      XOR A
001090 5090 57               4      LD  D,A
001091 5091 5F               4      LD  E,A
001092 5092 67               4      LD  H,A
001093 5093 6F               4      LD  L,A
001094 5094 C9              10      RET
                                
       5095                     _SYS2C:     ;(BDOS)時刻の獲得
001095 5095 AF               4      XOR A
001096 5096 57               4      LD  D,A
001097 5097 5F               4      LD  E,A
001098 5098 67               4      LD  H,A
001099 5099 6F               4      LD  L,A
00109A 509A C9              10      RET
                                
       509B                     POS:
00109B 509B F5              11      PUSH    AF
00109C 509C 2ADCF3          16      LD  HL,(CSRY)
00109F 509F 7D               4      LD  A,L
0010A0 50A0 6C               4      LD  L,H
0010A1 50A1 67               4      LD  H,A
0010A2 50A2 2C               4      INC L
0010A3 50A3 24               4      INC H
0010A4 50A4 F1              10      POP AF
0010A5 50A5 C9              10      RET
                                
       50A6                     LOC:
0010A6 50A6 F5              11      PUSH    AF
0010A7 50A7 E5              11      PUSH    HL
0010A8 50A8 7D               4      LD  A,L
0010A9 50A9 6C               4      LD  L,H
0010AA 50AA 67               4      LD  H,A
0010AB 50AB 2D               4      DEC L
0010AC 50AC 25               4      DEC H
0010AD 50AD DDE5            15      PUSH    IX
0010AF 50AF DD21C600        14      LD  IX,POSIT
0010B3 50B3 CDE742          17      CALL    CALSLT_R
0010B6 50B6 DDE1            14      POP IX
0010B8 50B8 E1              10      POP HL
0010B9 50B9 F1              10      POP AF
0010BA 50BA C9              10      RET
                                
       50BB                     _SCRN:
       50BB                     SCRN:
0010BB 50BB E5              11      PUSH    HL
0010BC 50BC DDE5            15      PUSH    IX
                                
0010BE 50BE 69               4      LD  L,C
0010BF 50BF 60               4      LD  H,B
0010C0 50C0 DD214A00        14      LD  IX,RDVRM
0010C4 50C4 CDE742          17      CALL    CALSLT_R
                                
0010C7 50C7 DDE1            14      POP IX
0010C9 50C9 E1              10      POP HL
0010CA 50CA C9              10      RET
                                
       50CB                     CTRL02:
0010CB 50CB F5              11      PUSH    AF
0010CC 50CC D5              11      PUSH    DE
0010CD 50CD 2ADCF3          16      LD  HL,(CSRY)
0010D0 50D0 3AB0F3          13      LD  A,(LINLEN)
0010D3 50D3 4F               4      LD  C,A
0010D4 50D4 94               4      SUB H   ;CSRX
0010D5 50D5 C602             7      ADD A,2
0010D7 50D7 47               4      LD  B,A ;カーソルより右の文字数
0010D8 50D8 61               4      LD  H,C ;LINLEN
0010D9 50D9 C5              11      PUSH    BC
0010DA 50DA CD2851          17      CALL    LOC0
0010DD 50DD C1              10      POP BC
                                
0010DE 50DE 1620             7      LD  D,020H
       50E0                     C8X1:
0010E0 50E0 DD214A00        14      LD  IX,RDVRM
0010E4 50E4 CDE742          17      CALL    CALSLT_R
0010E7 50E7 4F               4      LD  C,A
0010E8 50E8 7A               4      LD  A,D
0010E9 50E9 DD214D00        14      LD  IX,WRTVRM
0010ED 50ED CDE742          17      CALL    CALSLT_R
0010F0 50F0 2B               6      DEC HL
0010F1 50F1 51               4      LD  D,C
0010F2 50F2 10EC            13      DJNZ    C8X1
0010F4 50F4 D1              10      POP DE
0010F5 50F5 F1              10      POP AF
0010F6 50F6 C9              10      RET
                                
       50F7                     INSERT:
0010F7 50F7 F5              11      PUSH    AF
0010F8 50F8 D5              11      PUSH    DE
0010F9 50F9 2ADCF3          16      LD  HL,(CSRY)
0010FC 50FC 3AB0F3          13      LD  A,(LINLEN)
0010FF 50FF 4F               4      LD  C,A
001100 5100 94               4      SUB H   ;CSRX
001101 5101 3C               4      INC A
001102 5102 47               4      LD  B,A ;カーソルより右の文字数
001103 5103 C5              11      PUSH    BC
001104 5104 CD2851          17      CALL    LOC0
001107 5107 C1              10      POP BC
                                
001108 5108 1620             7      LD  D,020H
       510A                     INS1:
00110A 510A DD214A00        14      LD  IX,RDVRM
00110E 510E CDE742          17      CALL    CALSLT_R
001111 5111 4F               4      LD  C,A
001112 5112 7A               4      LD  A,D
001113 5113 DD214D00        14      LD  IX,WRTVRM
001117 5117 CDE742          17      CALL    CALSLT_R
00111A 511A 23               6      INC HL
00111B 511B 51               4      LD  D,C
00111C 511C 10EC            13      DJNZ    INS1
00111E 511E D1              10      POP DE
00111F 511F F1              10      POP AF
001120 5120 C9              10      RET
                                
       5121                     CONOUT1:
001121 5121 59               4      LD  E,C
001122 5122 C3554F          10      JP  _PRINT
                                
       5125                     GETVRAM:
001125 5125 2ADCF3          16      LD  HL,(CSRY)
       5128                     LOC0:
001128 5128 2D               4      DEC L
001129 5129 25               4      DEC H
00112A 512A 4C               4      LD  C,H ;CSRX-1
00112B 512B 5D               4      LD  E,L ;CSRY-1
       512C                     LOC1:
00112C 512C 3AB0F3          13      LD  A,(LINLEN)
00112F 512F 67               4      LD  H,A
001130 5130 1600             7      LD  D,0
001132 5132 6A               4      LD  L,D ;0
001133 5133 0608             7      LD  B,8
       5135                     LOC2:
001135 5135 29              11      ADD HL,HL
001136 5136 3001            12      JR  NC,LOC3
001138 5138 19              11      ADD HL,DE
       5139                     LOC3:
001139 5139 10FA            13      DJNZ    LOC2
00113B 513B 09              11      ADD HL,BC
00113C 513C C9              10      RET
                                
       513D                     _SYS0C:     ;(BDOS)バージョン番号の獲得
00113D 513D 212200          10      LD  HL,00022H
001140 5140 AF               4      XOR A
001141 5141 7D               4      LD  A,L
001142 5142 C9              10      RET
                                
       5143                     _SYS0D:     ;(BDOS)ディスク・リセット
001143 5143 218000          10      LD  HL,00080H
001146 5146 222FF1          16      LD  (_DTA),HL
001149 5149 C9              10      RET
                                
       514A                     _SYS0E:     ;(BDOS)カレントドライブの設定
00114A 514A 324AF1          13      LD  (_DVSW),A
00114D 514D C9              10      RET
                                
       514E                     _SYS0F:     ;(BDOS)ファイルのオープン
00114E 514E D5              11      PUSH    DE
00114F 514F FDE1            14      POP IY
001151 5151 CD9752          17      CALL    INIT_FILE
001154 5154 CD0D4B          17      CALL    ROM_OPEN
001157 5157 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
001159 5159 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
00115D 515D FDE5            15      PUSH    IY
00115F 515F D1              10      POP DE
001160 5160 13               6      INC DE
001161 5161 010B00          10      LD  BC,11
001164 5164 EDB0                    LDIR
                                ;               Attribute
001166 5166 7E               7      LD  A,(HL)
001167 5167 FD770D          19      LD  (IY+13),A
                                ;               TIME
00116A 516A 110B00          10      LD  DE,11
00116D 516D 19              11      ADD HL,DE
00116E 516E 7E               7      LD  A,(HL)
00116F 516F 23               6      INC HL
001170 5170 FD7716          19      LD  (IY+22),A
001173 5173 7E               7      LD  A,(HL)
001174 5174 23               6      INC HL
001175 5175 FD7717          19      LD  (IY+23),A
                                ;               DATE
001178 5178 7E               7      LD  A,(HL)
001179 5179 23               6      INC HL
00117A 517A FD7714          19      LD  (IY+20),A
00117D 517D 7E               7      LD  A,(HL)
00117E 517E 23               6      INC HL
00117F 517F FD7715          19      LD  (IY+21),A
                                ;               First cluster
001182 5182 7E               7      LD  A,(HL)
001183 5183 23               6      INC HL
001184 5184 FD771A          19      LD  (IY+26),A
001187 5187 7E               7      LD  A,(HL)
001188 5188 23               6      INC HL
001189 5189 FD771B          19      LD  (IY+27),A
                                ;               SIZE
00118C 518C 7E               7      LD  A,(HL)
00118D 518D 23               6      INC HL
00118E 518E FD7710          19      LD  (IY+16),A
001191 5191 7E               7      LD  A,(HL)
001192 5192 23               6      INC HL
001193 5193 FD7711          19      LD  (IY+17),A
001196 5196 7E               7      LD  A,(HL)
001197 5197 23               6      INC HL
001198 5198 FD7712          19      LD  (IY+18),A
00119B 519B 7E               7      LD  A,(HL)
00119C 519C FD7713          19      LD  (IY+19),A
00119F 519F AF               4      XOR A
0011A0 51A0 FD770C          19      LD  (IY+12),A
0011A3 51A3 C9              10      RET
                                
       51A4                     _SYS10:     ;(BDOS)ファイルのクローズ
0011A4 51A4 AF               4      XOR A
0011A5 51A5 C9              10      RET
                                
       51A6                     S11X1:
0011A6 51A6 FD7119          19      LD  (IY+25),C       ;RootEntCnt
0011A9 51A9 FD750E          19      LD  (IY+14),L
0011AC 51AC FD740F          19      LD  (IY+15),H
       51AF                     SCF_FF_RET:
0011AF 51AF 37               4      SCF
0011B0 51B0 9F               4      SBC A,A
0011B1 51B1 C9              10      RET
                                
       51B2                     _SYS11:     ;(BDOS)最初のファイルの検索
0011B2 51B2 ED5337F1        20      LD  (_FCB),DE
0011B6 51B6 D5              11      PUSH    DE
0011B7 51B7 FDE1            14      POP IY
0011B9 51B9 CD9752          17      CALL    INIT_FILE
0011BC 51BC CD2A4D          17      CALL    GET_DIR_DAT
       51BF                     S12X1:
0011BF 51BF CD294B          17      CALL    FILESE
0011C2 51C2 30E2            12      JR  NC,S11X1
0011C4 51C4 0D               4      DEC C
0011C5 51C5 FD7119          19      LD  (IY+25),C       ;RootEntCnt
0011C8 51C8 012000          10      LD  BC,32
0011CB 51CB ED5B2FF1        20      LD  DE,(_DTA)
0011CF 51CF AF               4      XOR A
0011D0 51D0 12               7      LD  (DE),A      ;ドライブ番号
0011D1 51D1 13               6      INC DE
0011D2 51D2 EDB0                    LDIR            ;ディレクトリエントリ
0011D4 51D4 FD750E          19      LD  (IY+14),L
0011D7 51D7 FD740F          19      LD  (IY+15),H
0011DA 51DA C9              10      RET
                                
       51DB                     _SYS12:
0011DB 51DB FD2A37F1        20      LD  IY,(_FCB)
0011DF 51DF FDE5            15      PUSH    IY
0011E1 51E1 D1              10      POP DE
0011E2 51E2 CD9752          17      CALL    INIT_FILE
                                
0011E5 51E5 FD6E0E          19      LD  L,(IY+14)
0011E8 51E8 FD660F          19      LD  H,(IY+15)
0011EB 51EB FD4E19          19      LD  C,(IY+25)
0011EE 51EE 18CF            12      JR  S12X1
                                
       51F0                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0011F0 51F0 CD104D          17      CALL    SET_FCB
0011F3 51F3 CDDE4C          17      CALL    GETSEQ
0011F6 51F6 CDCB4C          17      CALL    RB_READ
0011F9 51F9 E5              11      PUSH    HL
0011FA 51FA CDEB4C          17      CALL    SETSEQ
0011FD 51FD E1              10      POP HL
       51FE                     SREAD:
0011FE 51FE C601             7      ADD A,001H
001200 5200 D8              11      RET C
                                
001201 5201 7D               4      LD  A,L
001202 5202 D601             7      SUB 001H
001204 5204 9F               4      SBC A,A
001205 5205 E603             7      AND 3
001207 5207 1F               4      RRA
001208 5208 C9              10      RET
                                
       5209                     _SYS18:     ;(BDOS)ログインベクトルの獲得
001209 5209 210100          10      LD  HL,00001H
00120C 520C AF               4      XOR A
00120D 520D C9              10      RET
                                
       520E                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
00120E 520E 3A4AF1          13      LD  A,(_DVSW)
001211 5211 C9              10      RET
                                
       5212                     _SYS1A:     ;(BDOS)DTAの設定
001212 5212 ED532FF1        20      LD  (_DTA),DE
001216 5216 AF               4      XOR A
001217 5217 C9              10      RET
                                
       5218                     _SYS1B:     ;(BDOS)ディスク情報の獲得
001218 5218 010002          10      LD  BC,512
00121B 521B 11C302          10      LD  DE,707
00121E 521E 210000          10      LD  HL,0
001221 5221 DD2139F1        14      LD  IX,_BUF
001225 5225 FD2139F1        14      LD  IY,_BUF
001229 5229 FD3600F9        19      LD  (IY+0),0F9H
00122D 522D 3E02             7      LD  A,2
00122F 522F C9              10      RET
                                
       5230                     _SYS21:     ;(BDOS)ランダムな読み出し
001230 5230 CD104D          17      CALL    SET_FCB
                                
001233 5233 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001236 5236 FD6622          19      LD  H,(IY+34)
                                
001239 5239 CDCB4C          17      CALL    RB_READ
00123C 523C 18C0            12      JR  SREAD
                                
       523E                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
00123E 523E CD4E51          17      CALL    _SYS0F
001241 5241 D8              11      RET C
                                
001242 5242 D5              11      PUSH    DE      ;EX DE,IY
001243 5243 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001245 5245 CD004D          17      CALL    GETSIZE
       5248                     _S24X1:
001248 5248 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
00124B 524B FD7422          19      LD  (IY+34),H
00124E 524E FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
001252 5252 FDE3            23      EX  (SP),IY     ;
001254 5254 D1              10      POP DE      ;
                                
001255 5255 AF               4      XOR A
001256 5256 C9              10      RET
                                
       5257                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
001257 5257 E5              11      PUSH    HL
001258 5258 D5              11      PUSH    DE      ;EX DE,IY
001259 5259 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00125B 525B CDDE4C          17      CALL    GETSEQ
00125E 525E 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       5260                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001260 5260 CD104D          17      CALL    SET_FCB
001263 5263 E5              11      PUSH    HL
001264 5264 FD6E21          19      LD  L,(IY+33)
001267 5267 FD6622          19      LD  H,(IY+34)
00126A 526A 2225F1          16      LD  (RR_LOW),HL
00126D 526D FD6E23          19      LD  L,(IY+35)
001270 5270 FD6624          19      LD  H,(IY+36)
001273 5273 2227F1          16      LD  (RR_HIGH),HL
001276 5276 E1              10      POP HL
001277 5277 CD2D49          17      CALL    ROM_READ
00127A 527A ED5B25F1        20      LD  DE,(RR_LOW)
00127E 527E FD7321          19      LD  (IY+33),E
001281 5281 FD7222          19      LD  (IY+34),D
001284 5284 ED5B27F1        20      LD  DE,(RR_HIGH)
001288 5288 FD7323          19      LD  (IY+35),E
00128B 528B FD7224          19      LD  (IY+36),D
00128E 528E 9F               4      SBC A,A
00128F 528F C9              10      RET
                                
       5290                     _SYS2F:
001290 5290 44               4      LD  B,H
001291 5291 2A2FF1          16      LD  HL,(_DTA)
001294 5294 C3694D          10      JP  DISKIO
                                
       5297                     INIT_FILE:
001297 5297 EB               4      EX  DE,HL
001298 5298 1153F1          10      LD  DE,FDRV
00129B 529B 010C00          10      LD  BC,1+8+3
00129E 529E EDB0                    LDIR
0012A0 52A0 CDFE4E          17      CALL    GET_DISK_BANK_FDRV
0012A3 52A3 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0012A6 52A6 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0012A9 52A9 C9              10      RET
                                
       52AA                     ZERO_MEMORY_DE:
0012AA 52AA AF               4      XOR A
       52AB                     FILL_MEMORY_DE:
0012AB 52AB 12               7      LD  (DE),A
0012AC 52AC 13               6      INC DE
0012AD 52AD 10FC            13      DJNZ    FILL_MEMORY_DE
0012AF 52AF C9              10      RET
                                
0012B0 52B0                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 424F584F894F424F        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 424F424F8E4FCF4F        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 964F424FE94F7D50        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 3D5143514A514E51        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 A451B251DB51424F        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 F051424F424F424F        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 09520E5212521852        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 424F424F424F3E52        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 5752424F424F6052        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 424F424F8F50424F        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 9550424F424F9052        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB8 5FB8 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 424F424F424F424F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM32.ASM:UTF_8]
