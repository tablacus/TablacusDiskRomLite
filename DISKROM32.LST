                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
                                ;PTRFIL EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
                                ;FILNAM EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FDDB                     H_PINL  EQU 0FDDBH
                                
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;ASCII-16K
       6000                     ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
       7000                     ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                            ;KONAMI-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;KONAMI-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                
       F0E9                     ISC EQU 0F0E9H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
[EOF:DEF.ASM:UTF_8]
                                
       0001                     USE_NORMAL_32K_ROM      EQU 1   ;ノーマル32KB ROMを作成する
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 2F4E                    DW  STATEMENT  ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C3D04E          10      JP  DISKIO
000013 4013 C3164F          10      JP  DSKCHG
000016 4016 C36C4F          10      JP  GETDPB
000019 4019 C35F50          10      JP  CHOICE
00001C 401C C36350          10      JP  DSKFMT
00001F 401F C36550          10      JP  DSKSTP
000022 4022 C36650          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C36350          10      JP  DSKFMT
000029 4029 C36550          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3A250          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.2.0.3",0
            204449534B20524F    
            4D204C6974652076    
            302E322E302E3300    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 0180FF          10      LD  BC,-00080H
000109 4109 2A72F6          16      LD  HL,(MEMSIZ)
00010C 410C 09              11      ADD HL,BC
00010D 410D 2272F6          16      LD  (MEMSIZ),HL
000110 4110 2A74F6          16      LD  HL,(STKTOP)
000113 4113 09              11      ADD HL,BC
000114 4114 2274F6          16      LD  (STKTOP),HL
000117 4117 2180F0          10      LD  HL,0F080H
00011A 411A 1100F0          10      LD  DE,0F000H
00011D 411D 012000          10      LD  BC,00020H
000120 4120 EDB0                    LDIR
000122 4122 2180FF          10      LD  HL,-00080H
000125 4125 39              11      ADD HL,SP
000126 4126 2262F1          16      LD  (_SP),HL
000129 4129 ED7B62F1        20      LD  SP,(_SP)
                                
00012D 412D 3EFF             7      LD  A,0FFH
00012F 412F 3299FD          13      LD  (DEVICE),A
                                
000132 4132 3E01             7      LD  A,1
000134 4134 3221FB          13      LD  (DRVTBL),A
                                
000137 4137 AF               4      XOR A
000138 4138 3246F1          13      LD  (_DVSW),A
                                
00013B 413B 210643          10      LD  HL,AT_ISC
00013E 413E 11E9F0          10      LD  DE,ISC
000141 4141 017B00          10      LD  BC,ISC_E-ISC
000144 4144 EDB0                    LDIR
                                    
000146 4146 3EC3             7      LD  A,0C3H      ;JP
000148 4148 3243FF          13      LD  (H_GONE),A
00014B 414B 327DF3          13      LD  (BDOS),A
00014E 414E 326BF3          13      LD  (RAMUSE),A
000151 4151 3268F3          13      LD  (ROMUSE),A
000154 4154 21E9F0          10      LD  HL,REPLACE_COMMAND
000157 4157 2244FF          16      LD  (H_GONE+1),HL
00015A 415A 2131F3          10      LD  HL,H_BDOS
00015D 415D 227EF3          16      LD  (BDOS+1),HL
000160 4160 2119F1          10      LD  HL,RAMUSE1
000163 4163 226CF3          16      LD  (RAMUSE+1),HL
000166 4166 2114F1          10      LD  HL,ROMUSE1
000169 4169 2269F3          16      LD  (ROMUSE+1),HL
                                
00016C 416C 3E                      DB  03EH
00016D 416D F7              12      RST 30H
00016E 416E 3271FE          13      LD  (H_BINS),A
000171 4171 3276FE          13      LD  (H_BINL),A
000174 4174 327BFE          13      LD  (H_FILE),A
000177 4177 3231F3          13      LD  (H_BDOS),A
00017A 417A 32DBFD          13      LD  (H_PINL),A
00017D 417D 32A7FF          13      LD  (H_PHYD),A
                                
000180 4180 CD4642          17      CALL    GTSL1_
000183 4183 3200F1          13      LD  (ROM_SLT),A
000186 4186 3210F1          13      LD  (ROM_SLT_COPY),A
000189 4189 3272FE          13      LD  (H_BINS+1),A
00018C 418C 3277FE          13      LD  (H_BINL+1),A
00018F 418F 327CFE          13      LD  (H_FILE+1),A
000192 4192 3232F3          13      LD  (H_BDOS+1),A
000195 4195 32DCFD          13      LD  (H_PINL+1),A
000198 4198 32A8FF          13      LD  (H_PHYD+1),A
00019B 419B 3222FB          13      LD  (DRVTBL+1),A
00019E 419E 3248F3          13      LD  (MASTERS),A
                                
0001A1 41A1 218745          10      LD  HL,ROM_LOAD
0001A4 41A4 2273FE          16      LD  (H_BINS+2),HL
0001A7 41A7 21BC46          10      LD  HL,ROM_RUN
0001AA 41AA 2278FE          16      LD  (H_BINL+2),HL
0001AD 41AD 21C946          10      LD  HL,ROM_FILES
0001B0 41B0 227DFE          16      LD  (H_FILE+2),HL
0001B3 41B3 21FB50          10      LD  HL,ROM_BDOS
0001B6 41B6 2233F3          16      LD  (H_BDOS+2),HL
0001B9 41B9 21AB43          10      LD  HL,ROM_BOOT
0001BC 41BC 22DDFD          16      LD  (H_PINL+2),HL
0001BF 41BF 21D04E          10      LD  HL,DISKIO
0001C2 41C2 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001C5 41C5 3E                      DB  03EH
0001C6 41C6 C9              10      RET
0001C7 41C7 327FFE          13      LD  (H_FILE+4),A
0001CA 41CA 3275FE          13      LD  (H_BINS+4),A
0001CD 41CD 327AFE          13      LD  (H_BINL+4),A
0001D0 41D0 3235F3          13      LD  (H_BDOS+4),A
0001D3 41D3 32DFFD          13      LD  (H_PINL+4),A
0001D6 41D6 32ABFF          13      LD  (H_PHYD+4),A
                                
0001D9 41D9 AF               4      XOR A
0001DA 41DA 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001DD 41DD 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0001E0 41E0 3A0060          13      LD  A,(BANK1_ADR)
0001E3 41E3 FE41             7      CP  'A'
                                #if exists USE_NORMAL_32K_ROM
0001E5 41E5 284E            12      JR  Z,NOT_BANK_TYPE
0001E7 41E7 3E01             7      LD  A,DISK_BANK
0001E9 41E9 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    JR  NZ,NOT_BANK_TYPE
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001EC 41EC CD3801          17      CALL    RSLREG      ;read primary slot #
0001EF 41EF 07               4      RLCA
0001F0 41F0 07               4      RLCA
0001F1 41F1 F5              11      PUSH    AF
0001F2 41F2 1605             7      LD  D,4+1
0001F4 41F4 CD4D42          17      CALL    GTSL2_
0001F7 41F7 3244F3          13      LD  (RAMAD3),A
0001FA 41FA F1              10      POP AF
0001FB 41FB 07               4      RLCA
0001FC 41FC 07               4      RLCA
0001FD 41FD 1603             7      LD  D,2+1
0001FF 41FF CD4D42          17      CALL    GTSL2_
000202 4202 2680             7      LD  H,080H
000204 4204 CD6A42          17      CALL    CHK_RAM
000207 4207 3243F3          13      LD  (RAMAD2),A
       420A                     RAMCHK2:
00020A 420A 3A44F3          13      LD  A,(RAMAD3)
00020D 420D 2640             7      LD  H,040H
00020F 420F CD6A42          17      CALL    CHK_RAM
000212 4212 3242F3          13      LD  (RAMAD1),A
       4215                     RAMCHK1:
000215 4215 3A44F3          13      LD  A,(RAMAD3)
000218 4218 2600             7      LD  H,00H
00021A 421A CD6A42          17      CALL    CHK_RAM
00021D 421D 3241F3          13      LD  (RAMAD0),A
       4220                     RAMCHK0:
000220 4220 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
000223 4223 010F00          10      LD  BC,0000FH       ;切り上げ
000226 4226 09              11      ADD HL,BC
000227 4227 7D               4      LD  A,L
                                
000228 4228 0604             7      LD  B,4
       422A                     B_DRIVE1:
00022A 422A CB3C             8      SRL H
00022C 422C 1F               4      RRA
00022D 422D 10FB            13      DJNZ    B_DRIVE1
                                
00022F 422F C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000231 4231 3245F1          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
000234 4234 C9              10      RET
                                
       4235                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
000235 4235 21DD43          10      LD  HL,MSG_ERROR_ROM_MODE
000238 4238 CD8443          17      CALL    MSX
00023B 423B FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00023F 423F DD219F00        14      LD  IX,CHGET
000243 4243 C31C00          10      JP  _CALSLT
                                
       4246                     GTSL1_:             ;自分のいるスロットを知る
000246 4246 CD3801          17      CALL    RSLREG      ;read primary slot #
000249 4249 0F               4      RRCA
00024A 424A 0F               4      RRCA
00024B 424B 1601             7      LD  D,1
       424D                     GTSL2_:
00024D 424D E603             7      AND 3       ;[A]=000000PP
00024F 424F 5F               4      LD  E,A     ;[E]=000000PP
000250 4250 21C1FC          10      LD  HL,EXPTBL
000253 4253 85               4      ADD A,L     ;桁上りは無い
000254 4254 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000255 4255 7B               4      LD  A,E     ;[A]=000000PP
000256 4256 CB7E            13      BIT 7,(HL)
000258 4258 C8              11      RET Z
000259 4259 7D               4      LD  A,L     ;point to SLTTBL entry
00025A 425A C604             7      ADD A,4     ;桁上りは無い
00025C 425C 6F               4      LD  L,A
00025D 425D 7E               7      LD  A,(HL)      ;get currently expansion slot register
       425E                     GTSL3_:
00025E 425E 15               4      DEC D
00025F 425F 2803            12      JR  Z,GTSL4_:
000261 4261 0F               4      RRCA
000262 4262 18FA            12      JR  GTSL3_:
       4264                     GTSL4_:
000264 4264 E60C             7      AND 00CH        ;[A] = 0000SS00
000266 4266 B3               4      OR  E       ;[A] = 0000SSPP
000267 4267 F680             7      OR  080H        ;[A] = 1000SSPP
000269 4269 C9              10      RET
                                
       426A                     CHK_RAM:
00026A 426A E5              11      PUSH    HL
00026B 426B CDBF42          17      CALL    CHK_RAM0
00026E 426E E1              10      POP HL
00026F 426F C8              11      RET Z
000270 4270 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000273 4273 E680             7      AND 080H
000275 4275 CD9642          17      CALL    CHK_RAM_SLT
000278 4278 C8              11      RET Z
000279 4279 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
00027C 427C E680             7      AND 080H
00027E 427E C601             7      ADD A,1
000280 4280 CD9642          17      CALL    CHK_RAM_SLT
000283 4283 C8              11      RET Z
000284 4284 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000287 4287 E680             7      AND 080H
000289 4289 C602             7      ADD A,2
00028B 428B CD9642          17      CALL    CHK_RAM_SLT
00028E 428E C8              11      RET Z
00028F 428F 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000292 4292 E680             7      AND 080H
000294 4294 C603             7      ADD A,3
       4296                     CHK_RAM_SLT:
000296 4296 E5              11      PUSH    HL
000297 4297 CDBF42          17      CALL    CHK_RAM0        ;スロット#X or X-0
00029A 429A E1              10      POP HL
00029B 429B C8              11      RET Z
00029C 429C CB79             8      BIT 7,C
00029E 429E 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
0002A0 42A0 79               4      LD  A,C
0002A1 42A1 C604             7      ADD A,4*1           ;スロット#X-1
0002A3 42A3 E5              11      PUSH    HL
0002A4 42A4 CDBF42          17      CALL    CHK_RAM0
0002A7 42A7 E1              10      POP HL
0002A8 42A8 C8              11      RET Z
0002A9 42A9 79               4      LD  A,C
0002AA 42AA C608             7      ADD A,4*2           ;スロット#X-2
0002AC 42AC E5              11      PUSH    HL
0002AD 42AD CDBF42          17      CALL    CHK_RAM0
0002B0 42B0 E1              10      POP HL
0002B1 42B1 C8              11      RET Z
0002B2 42B2 79               4      LD  A,C
0002B3 42B3 C60C             7      ADD A,4*3           ;スロット#X-3
0002B5 42B5 E5              11      PUSH    HL
0002B6 42B6 CDBF42          17      CALL    CHK_RAM0
0002B9 42B9 E1              10      POP HL
       42BA                     CHK_RAM_E:
0002BA 42BA AF               4      XOR A
0002BB 42BB 3C               4      INC A           ;ZF=0にする
0002BC 42BC 3E00             7      LD  A,0
0002BE 42BE C9              10      RET
                                
       42BF                     CHK_RAM0:
0002BF 42BF 4F               4      LD  C,A
0002C0 42C0 3A00F1          13      LD  A,(ROM_SLT)
0002C3 42C3 B9               4      CP  C
0002C4 42C4 28F4            12      JR  Z,CHK_RAM_E
0002C6 42C6 2E00             7      LD  L,0
       42C8                     CHK_RAM1:
0002C8 42C8 79               4      LD  A,C
0002C9 42C9 DD210C00        14      LD  IX,_RDSLT
0002CD 42CD CDFA42          17      CALL    CALSLT_R
0002D0 42D0 C6E5             7      ADD A,0E5H
0002D2 42D2 47               4      LD  B,A
0002D3 42D3 5F               4      LD  E,A
0002D4 42D4 79               4      LD  A,C
0002D5 42D5 DD211400        14      LD  IX,_WRSLT
0002D9 42D9 CDFA42          17      CALL    CALSLT_R
0002DC 42DC 79               4      LD  A,C
0002DD 42DD DD210C00        14      LD  IX,_RDSLT
0002E1 42E1 CDFA42          17      CALL    CALSLT_R
0002E4 42E4 B8               4      CP  B
0002E5 42E5 C0              11      RET NZ
0002E6 42E6 D6E5             7      SUB 0E5H
0002E8 42E8 79               4      LD  A,C
0002E9 42E9 5F               4      LD  E,A
0002EA 42EA DD211400        14      LD  IX,_WRSLT
0002EE 42EE CDFA42          17      CALL    CALSLT_R
0002F1 42F1 24               4      INC H
0002F2 42F2 7D               4      LD  A,L
0002F3 42F3 C604             7      ADD A,4
0002F5 42F5 6F               4      LD  L,A
0002F6 42F6 20D0            12      JR  NZ,CHK_RAM1
0002F8 42F8 79               4      LD  A,C     ;ZF=1のハズ
0002F9 42F9 C9              10      RET
                                
       42FA                     CALSLT_R:
0002FA 42FA C5              11      PUSH    BC
0002FB 42FB E5              11      PUSH    HL
0002FC 42FC FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000300 4300 CD1C00          17      CALL    _CALSLT
000303 4303 E1              10      POP HL
000304 4304 C1              10      POP BC
000305 4305 C9              10      RET
                                
       4306                     AT_ISC:
000306 F0E9                         ORG ISC,AT_ISC-RUN
       F0E9                     REPLACE_COMMAND:
000306 F0E9 FEB7             7      CP  0B7H            ;FILES
000308 F0EB CC7BFE          17      CALL    Z,H_FILE
00030B F0EE FEB5             7      CP  0B5H            ;LOAD
00030D F0F0 CA71FE          10      JP  Z,H_BINS
000310 F0F3 FE8A             7      CP  08AH            ;RUN
000312 F0F5 CA76FE          10      JP  Z,H_BINL
000315 F0F8 FED6             7      CP  0D6H            ;COPY
000317 F0FA 2813            12      JR  Z,FIX_COPY
000319 F0FC FECF             7      CP  0CFH            ;BLOAD
00031B F0FE C0              11      RET NZ
       F0FF                     FIX_BLOAD:
00031C F0FF F7              12      RST 30H
       F100                     ROM_SLT:
00031D F100 00                      DB  0
00031E F101 F245                    DW  ROM_BLOAD
000320 F103 F5              11      PUSH    AF
000321 F104 E5              11      PUSH    HL
000322 F105 CD0EF1          17      CALL    BLOAD_RET
       F106                     SWC_BLOAD   EQU $-2
000325 F108 E1              10      POP HL
000326 F109 F1              10      POP AF
000327 F10A FECF             7      CP  0CFH            ;BLOAD
       F10C                     SWC_BLOAD_M:
000329 F10C 28DB            12      JR  Z,REPLACE_COMMAND
       F10E                     BLOAD_RET:
00032B F10E C9              10      RET
       F10F                     FIX_COPY:
00032C F10F F7              12      RST 30H
       F110                     ROM_SLT_COPY:
00032D F110 00                      DB  0
00032E F111 5847                    DW  ROM_COPY
000330 F113 C9              10      RET
       F114                     ROMUSE1:
000331 F114 3A00F1          13      LD  A,(ROM_SLT)
000334 F117 1803            12      JR  ROMUSE2
       F119                     RAMUSE1:
000336 F119 3A42F3          13      LD  A,(RAMAD1)
       F11C                     ROMUSE2:
000339 F11C C32400          10      JP  _ENASLT
                                
       F11F                     _RESULT:
00033C F11F 00                      DB  0
       F120                     _BANK:
00033D F120 00                      DB  0
       F121                     _BANK1:
00033E F121 00                      DB  0
       F122                     CLSZ:               ;クラスタサイズ
00033F F122 0004                    DW  1024
       F123                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F124                     SECSZ:              ;セクタサイズ
000341 F124 0002                    DW  512
       F125                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F126                     RR_LOW:
000343 F126 0000                    DW  0
       F127                     RR_MID  EQU $-1
       F128                     RR_HIGH:
000345 F128 0000                    DW  0
       F12A                     _CLPS:
000347 F12A 0000                    DW  0
       F12C                     _LEFT:
000349 F12C 0000                    DW  0
       F12E                     _DTPS:
00034B F12E 0000                    DW  0
       F130                     _DTA:
00034D F130 0000                    DW  0
       F132                     FLG_LDIR:
00034F F132 00                      DB  0
       F133                     _FCB:
000350 F133 0000                    DW  0
       F135                     _BUF:
       F135                     _BUF_LO:        ;LOGICAL OPERATION
000352 F135 00                      DB  0
       F136                     _BUF_ST:
000353 F136 0000                    DW  0
       F138                     _BUF_EN:
000355 F138 0000                    DW  0
       F13A                     _BUF_EX:
       F13A                     _BUF_W:
000357 F13A 0000                    DW  0
       F13C                     _BUF_H:
000359 F13C 0000                    DW  0
       F13E                     _BUF_X:
00035B F13E 0000                    DW  0
       F140                     _BUF_Y:
00035D F140 00                      DB  0
       F141                     _BUF_P:
00035E F141 00                      DB  0
       F142                     _BUF_O:
00035F F142 00                      DB  0
       F143                     DTAX:
000360 F143 0000                    DW  0
       F145                     B_DRIVE:
000362 F145 00                      DB  0
       F146                     _DVSW:
000363 F146 00                      DB  0
       F147                     DIRENT1:
000364 F147 0000                    DW  0
       F149                     _DIR_BANK:
000366 F149 00                      DB  0
       F14A                     LEFTX:
000367 F14A 0000                    DW  0
       F14C                     PARAM0:
000369 F14C 0000                    DW  0
       F14E                     PARAM1:
00036B F14E 0000                    DW  0
       F150                     FDRV:
00036D F150 00                      DB  0
       F151                     FNAME:
00036E F151                         DS  8+3
       F15C                     _CD:            ;カレントディレクトリ
000379 F15C 0000                    DW  0
       F15E                     _CDX:
00037B F15E 0000                    DW  0
       F160                     _HL:
00037D F160 0000                    DW  0
       F162                     _SP:
00037F F162 0000                    DW  0
                                
       F164                     ISC_E:
000381 4381                         ORG $$+RUN          ;$DEPHASE
                                
       4381                     MSX1:
000381 4381 CD1451          17      CALL    MSGA1
       4384                     MSX:
000384 4384 7E               7      LD  A,(HL)
000385 4385 23               6      INC HL
000386 4386 B7               4      OR  A
000387 4387 20F8            12      JR  NZ,MSX1
000389 4389 C9              10      RET
                                
       438A                     PRTHX:
00038A 438A F5              11      PUSH    AF
00038B 438B 07               4      RLCA
00038C 438C 07               4      RLCA
00038D 438D 07               4      RLCA
00038E 438E 07               4      RLCA
00038F 438F CD9343          17      CALL    PRTA2
000392 4392 F1              10      POP AF
       4393                     PRTA2:
000393 4393 CD9943          17      CALL    ASC
000396 4396 C31051          10      JP  MSG_A
                                    
       4399                     ASC:
000399 4399 E60F             7      AND $0F
00039B 439B F630             7      OR  $30
00039D 439D FE3A             7      CP  $3A
00039F 439F D8              11      RET C
0003A0 43A0 C607             7      ADD A,7
0003A2 43A2 C9              10      RET
                                
       43A3                     MSN:
0003A3 43A3 7E               7      LD  A,(HL)
0003A4 43A4 23               6      INC HL
0003A5 43A5 CD1051          17      CALL    MSG_A
0003A8 43A8 10F9            13      DJNZ    MSN
0003AA 43AA C9              10      RET
                                
       43AB                     ROM_BOOT:
0003AB 43AB 3E                      DB  03EH
0003AC 43AC C9              10      RET
0003AD 43AD 32DBFD          13      LD  (H_PINL),A
                                
0003B0 43B0 21FA43          10      LD  HL,DELOK
0003B3 43B3 CD8443          17      CALL    MSX
                                
0003B6 43B6 AF               4      XOR A
0003B7 43B7 3240F3          13      LD  (REBOOT),A
0003BA 43BA 2A48FC          16      LD  HL,(BOTTOM)
0003BD 43BD 110040          10      LD  DE,16384
0003C0 43C0 19              11      ADD HL,DE
0003C1 43C1 3817            12      JR  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
0003C3 43C3 57               4      LD  D,A
0003C4 43C4 0601             7      LD  B,1
0003C6 43C6 2100C0          10      LD  HL,0C000H
0003C9 43C9 CDD04E          17      CALL    DISKIO
                                
0003CC 43CC 116BF3          10      LD  DE,RAMUSE
0003CF 43CF AF               4      XOR A
0003D0 43D0 CD1EC0          17      CALL    0C01EH
0003D3 43D3 116BF3          10      LD  DE,RAMUSE
0003D6 43D6 37               4      SCF
0003D7 43D7 CD1EC0          17      CALL    0C01EH
       43DA                     BOOT1:
0003DA 43DA C36650          10      JP  BASENT
                                
       43DD                     MSG_ERROR_ROM_MODE:
                                #if exists USE_NORMAL_32K_ROM
0003DD 43DD 4E6F726D616C2052        DB  "Normal ROM/ASCII-16K only!",13,10
            4F4D2F4153434949    
            2D31364B206F6E6C    
            79210D0A            
                                #else
                                    DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
                                #endif
       43F9                     NULL:
0003F9 43F9 00                      DB  0
       43FA                     DELOK:
0003FA 43FA 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       43FE                     ROM_LDIR:
0003FE 43FE 3A32F1          13      LD  A,(FLG_LDIR)
000401 4401 B7               4      OR  A
000402 4402 2064            12      JR  NZ,ROM_LDIRVM
000404 4404 CB7A             8      BIT 7,D
000406 4406 CA9144          10      JP  Z,ROM_LDIRSLT
                                #if exists USE_NORMAL_32K_ROM
       4409                     LDIRA:
000409 4409 F3               4      DI
00040A 440A ED7362F1        20      LD  (_SP),SP
00040E 440E 3121FB          10      LD  SP,DRVTBL
       4411                     LDIR1:
000411 4411 78               4      LD  A,B
000412 4412 B1               4      OR  C
000413 4413 284D            12      JR  Z,LDIRE
                                
000415 4415 C5              11      PUSH    BC
000416 4416 D5              11      PUSH    DE
000417 4417 E5              11      PUSH    HL
000418 4418 3A00F1          13      LD  A,(ROM_SLT)
00041B 441B 2680             7      LD  H,080H
00041D 441D CD2400          17      CALL    _ENASLT
000420 4420 E1              10      POP HL
000421 4421 D1              10      POP DE
000422 4422 C1              10      POP BC
       4423                     LDIR2:
000423 4423 7A               4      LD  A,D
000424 4424 FEC0             7      CP  0C0H
000426 4426 302C            12      JR  NC,LDIR4
                                
000428 4428 C5              11      PUSH    BC
000429 4429 D5              11      PUSH    DE
00042A 442A 115EF5          10      LD  DE,BUF
                                
00042D 442D 78               4      LD  A,B
00042E 442E B7               4      OR  A
00042F 442F 2803            12      JR  Z,LDIR3
000431 4431 010001          10      LD  BC,00100H
       4434                     LDIR3:
000434 4434 C5              11      PUSH    BC
000435 4435 EDB0                    LDIR
000437 4437 2260F1          16      LD  (_HL),HL
                                
00043A 443A 3A43F3          13      LD  A,(RAMAD2)
00043D 443D 2680             7      LD  H,080H
00043F 443F CD2400          17      CALL    _ENASLT
                                
000442 4442 C1              10      POP BC
000443 4443 D1              10      POP DE
000444 4444 215EF5          10      LD  HL,BUF
000447 4447 EDB0                    LDIR
                                
000449 4449 2A60F1          16      LD  HL,(_HL)
00044C 444C C1              10      POP BC
00044D 444D 78               4      LD  A,B
00044E 444E B7               4      OR  A
00044F 444F 2811            12      JR  Z,LDIRE
000451 4451 05               4      DEC B
000452 4452 18BD            12      JR  LDIR1
       4454                     LDIR4:
                                #endif
000454 4454 EDB0                    LDIR
                                
                                #if exists USE_NORMAL_32K_ROM
       4456                     LDIRE2:
000456 4456 D5              11      PUSH    DE
000457 4457 E5              11      PUSH    HL
000458 4458 3A43F3          13      LD  A,(RAMAD2)
00045B 445B 2680             7      LD  H,080H
00045D 445D CD2400          17      CALL    _ENASLT
000460 4460 E1              10      POP HL
000461 4461 D1              10      POP DE
       4462                     LDIRE:
000462 4462 ED7B62F1        20      LD  SP,(_SP)
000466 4466 FB               4      EI
                                #endif
000467 4467 C9              10      RET
                                
       4468                     ROM_LDIRVM:
                                #if exists USE_NORMAL_32K_ROM
000468 4468 F3               4      DI
000469 4469 ED7362F1        20      LD  (_SP),SP
00046D 446D 3121FB          10      LD  SP,DRVTBL
000470 4470 C5              11      PUSH    BC
000471 4471 D5              11      PUSH    DE
000472 4472 E5              11      PUSH    HL
000473 4473 3A00F1          13      LD  A,(ROM_SLT)
000476 4476 2680             7      LD  H,080H
000478 4478 CD2400          17      CALL    _ENASLT
00047B 447B E1              10      POP HL
00047C 447C D1              10      POP DE
00047D 447D C1              10      POP BC
                                #endif
00047E 447E C5              11      PUSH    BC
00047F 447F D5              11      PUSH    DE
000480 4480 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000484 4484 DD215C00        14      LD  IX,LDIRVM
000488 4488 CD1C00          17      CALL    _CALSLT
00048B 448B E1              10      POP HL
00048C 448C C1              10      POP BC
00048D 448D 09              11      ADD HL,BC
00048E 448E EB               4      EX  DE,HL
                                #if exists USE_NORMAL_32K_ROM
00048F 448F 18C5            12      JR  LDIRE2
                                #else
                                    RET
                                #endif
                                
       4491                     ROM_LDIRSLT:
                                #if exists USE_NORMAL_32K_ROM
000491 4491 F3               4      DI
000492 4492 ED7362F1        20      LD  (_SP),SP
000496 4496 3121FB          10      LD  SP,DRVTBL
000499 4499 C5              11      PUSH    BC
00049A 449A D5              11      PUSH    DE
00049B 449B E5              11      PUSH    HL
00049C 449C 3A00F1          13      LD  A,(ROM_SLT)
00049F 449F 2680             7      LD  H,080H
0004A1 44A1 CD2400          17      CALL    _ENASLT
0004A4 44A4 E1              10      POP HL
0004A5 44A5 D1              10      POP DE
0004A6 44A6 C1              10      POP BC
                                #endif
       44A7                     ROM_LDIRSLT1:
0004A7 44A7 EB               4      EX  DE,HL
       44A8                     RLDIRSLT1:
0004A8 44A8 1A               7      LD  A,(DE)
0004A9 44A9 13               6      INC DE
0004AA 44AA C5              11      PUSH    BC
0004AB 44AB D5              11      PUSH    DE
0004AC 44AC E5              11      PUSH    HL
0004AD 44AD 5F               4      LD  E,A
                                
0004AE 44AE 0141F3          10      LD  BC,RAMAD0
0004B1 44B1 7C               4      LD  A,H
0004B2 44B2 07               4      RLCA
0004B3 44B3 07               4      RLCA
0004B4 44B4 E603             7      AND 3
0004B6 44B6 81               4      ADD A,C
0004B7 44B7 4F               4      LD  C,A
0004B8 44B8 0A               7      LD  A,(BC)
       44B9                     RLDIRSLT2:
0004B9 44B9 CD1400          17      CALL    _WRSLT
0004BC 44BC 08               4      EX  AF,AF'
0004BD 44BD E1              10      POP HL
0004BE 44BE D1              10      POP DE
0004BF 44BF C1              10      POP BC
0004C0 44C0 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0004C2 44C2 EAA844          10      JP  PE,RLDIRSLT1
0004C5 44C5 EB               4      EX  DE,HL
                                #if exists USE_NORMAL_32K_ROM
0004C6 44C6 188E            12      JR  LDIRE2
                                #else
                                    RET
                                #endif
                                
       44C8                     END_OF_LINE:
0004C8 44C8 215EF5          10      LD  HL,BUF
       44CB                     EOL1:
0004CB 44CB 7E               7      LD  A,(HL)
0004CC 44CC C8              11      RET Z
0004CD 44CD FE0D             7      CP  00DH
0004CF 44CF 2807            12      JR  Z,EOLE
0004D1 44D1 FE0A             7      CP  00AH
0004D3 44D3 2803            12      JR  Z,EOLE
0004D5 44D5 23               6      INC HL
0004D6 44D6 18F3            12      JR  EOL1
       44D8                     EOLE:
0004D8 44D8 3600            10      LD  (HL),0
0004DA 44DA 23               6      INC HL
0004DB 44DB 7E               7      LD  A,(HL)
0004DC 44DC FE0A             7      CP  00AH
0004DE 44DE C0              11      RET NZ
0004DF 44DF 23               6      INC HL
0004E0 44E0 C9              10      RET
                                
       44E1                     ROM_LOAD_ASCII:
0004E1 44E1 210000          10      LD  HL,0
0004E4 44E4 2236F1          16      LD  (_BUF_ST),HL    ;読み出し位置
0004E7 44E7 2A76F6          16      LD  HL,(TXTTAB)
0004EA 44EA 2238F1          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
0004ED 44ED 215EF5          10      LD  HL,BUF
0004F0 44F0 2230F1          16      LD  (_DTA),HL
       44F3                     RLOAD_A1:
0004F3 44F3 2A36F1          16      LD  HL,(_BUF_ST)
0004F6 44F6 2226F1          16      LD  (RR_LOW),HL
0004F9 44F9 210201          10      LD  HL,258
0004FC 44FC CD7349          17      CALL    ROM_READ
0004FF 44FF 7C               4      LD  A,H
000500 4500 B5               4      OR  L
000501 4501 2877            12      JR  Z,RLOAD_AEND
000503 4503 015EF5          10      LD  BC,BUF
000506 4506 09              11      ADD HL,BC
000507 4507 3600            10      LD  (HL),0
000509 4509 CDC844          17      CALL    END_OF_LINE
00050C 450C 015EF5          10      LD  BC,BUF
00050F 450F A7               4      AND A
000510 4510 ED42            15      SBC HL,BC
000512 4512 2810            12      JR  Z,RLOAD_A2
000514 4514 4D               4      LD  C,L
000515 4515 44               4      LD  B,H
000516 4516 ED5B36F1        20      LD  DE,(_BUF_ST)
00051A 451A 19              11      ADD HL,DE
00051B 451B 2236F1          16      LD  (_BUF_ST),HL
00051E 451E 3A5EF5          13      LD  A,(BUF)
000521 4521 B7               4      OR  A
000522 4522 28CF            12      JR  Z,RLOAD_A1
       4524                     RLOAD_A2:
000524 4524 115EF5          10      LD  DE,BUF
000527 4527 CD2A4B          17      CALL    SPCUTEX
00052A 452A 1A               7      LD  A,(DE)
00052B 452B B7               4      OR  A
00052C 452C 284C            12      JR  Z,RLOAD_AEND
00052E 452E CD3C4B          17      CALL    GETNUM
000531 4531 7C               4      LD  A,H
000532 4532 B5               4      OR  L
000533 4533 CAD945          10      JP  Z,ERROR_DIRECT_IN_FILE
000536 4536 DD2A38F1        20      LD  IX,(_BUF_EN)
00053A 453A DD7502          19      LD  (IX+2),L
00053D 453D DD7403          19      LD  (IX+3),H
                                
000540 4540 CD234B          17      CALL    SPCUT
000543 4543 EB               4      EX  DE,HL
000544 4544 DDE5            15      PUSH    IX
000546 4546 DD21B242        14      LD  IX,CRUNCH
00054A 454A FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00054E 454E CD1C00          17      CALL    _CALSLT
000551 4551 DDE1            14      POP IX
000553 4553 EB               4      EX  DE,HL
000554 4554 111FF4          10      LD  DE,KBUF
000557 4557 37               4      SCF
000558 4558 ED52            15      SBC HL,DE
00055A 455A 287D            12      JR  Z,ERROR_DIRECT_IN_FILE
00055C 455C 387B            12      JR  C,ERROR_DIRECT_IN_FILE
00055E 455E 4D               4      LD  C,L
00055F 455F 44               4      LD  B,H
000560 4560 2A38F1          16      LD  HL,(_BUF_EN)
000563 4563 110400          10      LD  DE,4
000566 4566 19              11      ADD HL,DE
000567 4567 111FF4          10      LD  DE,KBUF
                                
00056A 456A EB               4      EX  DE,HL
00056B 456B EDB0                    LDIR
00056D 456D EB               4      EX  DE,HL
                                
00056E 456E DD7500          19      LD  (IX+0),L
000571 4571 DD7401          19      LD  (IX+1),H
000574 4574 2238F1          16      LD  (_BUF_EN),HL
000577 4577 C3F344          10      JP  RLOAD_A1
                                
       457A                     RLOAD_AEND:
00057A 457A 2A38F1          16      LD  HL,(_BUF_EN)
00057D 457D AF               4      XOR A
00057E 457E 77               7      LD  (HL),A
00057F 457F 23               6      INC HL
000580 4580 77               7      LD  (HL),A
000581 4581 23               6      INC HL
000582 4582 2238F1          16      LD  (_BUF_EN),HL
000585 4585 183B            12      JR  RLOAD_END1
                                
       4587                     ROM_LOAD:
000587 4587 CD2247          17      CALL    INIT_PARAM
00058A 458A CD144A          17      CALL    FILE_B
00058D 458D 3A51F1          13      LD  A,(FNAME)
000590 4590 FE20             7      CP  020H
000592 4592 CA0F4A          10      JP  Z,ROM_ORG
                                
000595 4595 CD934B          17      CALL    ROM_OPEN
000598 4598 384B            12      JR  C,ERROR_FILE_NOT_FOUND
       459A                     ROM_LOAD1:
00059A 459A 2135F1          10      LD  HL,_BUF
00059D 459D 2230F1          16      LD  (_DTA),HL
0005A0 45A0 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
0005A3 45A3 CD7349          17      CALL    ROM_READ
0005A6 45A6 3A35F1          13      LD  A,(_BUF)
0005A9 45A9 3C               4      INC A
0005AA 45AA C2E144          10      JP  NZ,ROM_LOAD_ASCII
0005AD 45AD 2A76F6          16      LD  HL,(TXTTAB)
0005B0 45B0 2230F1          16      LD  (_DTA),HL
0005B3 45B3 EB               4      EX  DE,HL
0005B4 45B4 2100FF          10      LD  HL,-256
0005B7 45B7 39              11      ADD HL,SP
0005B8 45B8 ED52            15      SBC HL,DE
0005BA 45BA CD7349          17      CALL    ROM_READ
0005BD 45BD ED5B30F1        20      LD  DE,(_DTA)
0005C1 45C1 19              11      ADD HL,DE
       45C2                     RLOAD_END1:
0005C2 45C2 22C2F6          16      LD  (VARTAB),HL
0005C5 45C5 22C4F6          16      LD  (ARYTAB),HL
0005C8 45C8 22C6F6          16      LD  (STREND),HL
                                
0005CB 45CB AF               4      XOR A
0005CC 45CC 2138F1          10      LD  HL,_BUF+3
0005CF 45CF 77               7      LD  (HL),A
0005D0 45D0 2B               6      DEC HL
0005D1 45D1 77               7      LD  (HL),A
0005D2 45D2 2B               6      DEC HL
0005D3 45D3 77               7      LD  (HL),A
0005D4 45D4 2B               6      DEC HL
0005D5 45D5 3E8F             7      LD  A,08FH          ;REM
0005D7 45D7 77               7      LD  (HL),A
0005D8 45D8 C9              10      RET
                                
       45D9                     ERROR_DIRECT_IN_FILE:
0005D9 45D9 1E39             7      LD  E,57            ;Direct statement in file
0005DB 45DB 01                      DB  1           ;LD BC,
       45DC                     ERROR_DEVICE_IO_ERROR:
0005DC 45DC 1E13             7      LD  E,19            ;Device I/O error
0005DE 45DE 01                      DB  1           ;LD BC,
       45DF                     ERROR_INTERNAL_ERROR:
0005DF 45DF 1E33             7      LD  E,51            ;Internal error
0005E1 45E1 01                      DB  1           ;LD BC,
       45E2                     ERROR_FILE_NOT_OPEN:
0005E2 45E2 1E3B             7      LD  E,59            ;File not OPEN
0005E4 45E4 01                      DB  1           ;LD BC,
       45E5                     ERROR_FILE_NOT_FOUND:
0005E5 45E5 1E35             7      LD  E,53            ;File not found
       45E7                     ERROR:
0005E7 45E7 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0005EB 45EB DD216F40        14      LD  IX,ERRHAND
0005EF 45EF C31C00          10      JP  _CALSLT
                                
       45F2                     ROM_BLOAD:
0005F2 45F2 CD2247          17      CALL    INIT_PARAM
0005F5 45F5 CD144A          17      CALL    FILE_B
0005F8 45F8 CD934B          17      CALL    ROM_OPEN
0005FB 45FB 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
0005FD 45FD 2135F1          10      LD  HL,_BUF
000600 4600 2230F1          16      LD  (_DTA),HL
000603 4603 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
000606 4606 CD7349          17      CALL    ROM_READ
000609 4609 3A35F1          13      LD  A,(_BUF)
00060C 460C FEFE             7      CP  0FEH
00060E 460E 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
000610 4610 210EF1          10      LD  HL,BLOAD_RET
000613 4613 2206F1          16      LD  (SWC_BLOAD),HL
                                
000616 4616 2A4EF1          16      LD  HL,(PARAM1)
000619 4619 7E               7      LD  A,(HL)
00061A 461A FE2C             7      CP  ','
00061C 461C 2048            12      JR  NZ,RBREAD_MEM
00061E 461E 23               6      INC HL
00061F 461F 7E               7      LD  A,(HL)
000620 4620 CD7D4B          17      CALL    CAP
000623 4623 32BEFC          13      LD  (RUNBNF),A
       4626                     RBOS1:
000626 4626 7E               7      LD  A,(HL)
000627 4627 23               6      INC HL
000628 4628 B7               4      OR  A
000629 4629 282F            12      JR  Z,RBREAD_OSE
00062B 462B FE3A             7      CP  ':'
00062D 462D 282B            12      JR  Z,RBREAD_OSE
00062F 462F FE2C             7      CP  ','     ;次のパラメータを探す
000631 4631 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
000633 4633 224EF1          16      LD  (PARAM1),HL
000636 4636 7E               7      LD  A,(HL)
000637 4637 B7               4      OR  A
000638 4638 2820            12      JR  Z,RBREAD_OSE
00063A 463A DD21644C        14      LD  IX,FRMEVL
00063E 463E FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000642 4642 CD1C00          17      CALL    _CALSLT
000645 4645 224EF1          16      LD  (PARAM1),HL
000648 4648 3A63F6          13      LD  A,(VALTYP)
00064B 464B FE02             7      CP  2
00064D 464D 200B            12      JR  NZ,RBREAD_OSE
00064F 464F 2A36F1          16      LD  HL,(_BUF_ST)
000652 4652 ED5BF8F7        20      LD  DE,(DACDAT)
000656 4656 19              11      ADD HL,DE
000657 4657 2236F1          16      LD  (_BUF_ST),HL
       465A                     RBREAD_OSE:
00065A 465A 3ABEFC          13      LD  A,(RUNBNF)
00065D 465D FE53             7      CP  'S'
00065F 465F 2005            12      JR  NZ,RBREAD_MEM
000661 4661 3E01             7      LD  A,1
000663 4663 3232F1          13      LD  (FLG_LDIR),A
       4666                     RBREAD_MEM:
000666 4666 2A36F1          16      LD  HL,(_BUF_ST)
000669 4669 22BFFC          16      LD  (SAVENT),HL
00066C 466C 2230F1          16      LD  (_DTA),HL
00066F 466F 21FFFF          10      LD  HL,0FFFFH
000672 4672 CD7349          17      CALL    ROM_READ
000675 4675 3ABEFC          13      LD  A,(RUNBNF)
000678 4678 FE52             7      CP  'R'
00067A 467A 2006            12      JR  NZ,RBREAD1
00067C 467C 2A3AF1          16      LD  HL,(_BUF_EX)
00067F 467F 2206F1          16      LD  (SWC_BLOAD),HL
       4682                     RBREAD1:
       4682                     ROM_NEXT:
000682 4682 2A4EF1          16      LD  HL,(PARAM1)
000685 4685 7E               7      LD  A,(HL)
000686 4686 2B               6      DEC HL
000687 4687 B7               4      OR  A
000688 4688 2805            12      JR  Z,RN1
00068A 468A FE3A             7      CP  ':'
00068C 468C 2801            12      JR  Z,RN1
00068E 468E 23               6      INC HL
       468F                     RN1:
00068F 468F 5D               4      LD  E,L
000690 4690 54               4      LD  D,H
                                
000691 4691 CD534B          17      CALL    SEARCH_END
000694 4694 B7               4      OR  A
000695 4695 2821            12      JR  Z,REM
       4697                     RN3:                    ;マルチステートメントの処理
000697 4697 7E               7      LD  A,(HL)
                                
000698 4698 FEB5             7      CP  0B5H            ;LOAD
00069A 469A CA8745          10      JP  Z,ROM_LOAD
00069D 469D FE8A             7      CP  08AH            ;RUN
00069F 469F 281B            12      JR  Z,ROM_RUN
0006A1 46A1 FEB7             7      CP  0B7H            ;FILES
0006A3 46A3 2824            12      JR  Z,ROM_FILES
0006A5 46A5 FED6             7      CP  0D6H            ;COPY
0006A7 46A7 CA5847          10      JP  Z,ROM_COPY
0006AA 46AA FE20             7      CP  020H
0006AC 46AC 2807            12      JR  Z,RN_SP
                                
0006AE 46AE 3E28             7      LD  A,028H          ;JR Z,
0006B0 46B0 320CF1          13      LD  (SWC_BLOAD_M),A
0006B3 46B3 7E               7      LD  A,(HL)
0006B4 46B4 C9              10      RET
       46B5                     RN_SP:
0006B5 46B5 23               6      INC HL
0006B6 46B6 18DF            12      JR  RN3
                                
       46B8                     REM:
0006B8 46B8 EB               4      EX  DE,HL
0006B9 46B9 3E8F             7      LD  A,08FH          ;REM
0006BB 46BB C9              10      RET
                                
       46BC                     ROM_RUN:
0006BC 46BC 23               6      INC HL
0006BD 46BD 7E               7      LD  A,(HL)
0006BE 46BE 2B               6      DEC HL
0006BF 46BF B7               4      OR  A
0006C0 46C0 2803            12      JR  Z,ROM_RUN1
0006C2 46C2 CD8745          17      CALL    ROM_LOAD
       46C5                     ROM_RUN1:
0006C5 46C5 3E8A             7      LD  A,08AH          ;RUN
0006C7 46C7 77               7      LD  (HL),A
0006C8 46C8 C9              10      RET
                                
       46C9                     ROM_FILES:
0006C9 46C9 CD2247          17      CALL    INIT_PARAM
0006CC 46CC CD144A          17      CALL    FILE_B
0006CF 46CF CDA650          17      CALL    GET_DISK_BANK_FDRV
0006D2 46D2 3A25F1          13      LD  A,(SECSZ_H)
0006D5 46D5 CD614F          17      CALL    IS_BPB1
0006D8 46D8 DADC45          10      JP  C,ERROR_DEVICE_IO_ERROR
0006DB 46DB 3A51F1          13      LD  A,(FNAME)
0006DE 46DE FE21             7      CP  021H
0006E0 46E0 3005            12      JR  NC,RFILES0
0006E2 46E2 060B             7      LD  B,11
0006E4 46E4 CDE74A          17      CALL    FILE10
       46E7                     RFILES0:
0006E7 46E7 CDE54D          17      CALL    GET_DIR_DAT
       46EA                     RFILES1:
0006EA 46EA CDAF4B          17      CALL    FILESE
0006ED 46ED 302E            12      JR  NC,RFILES_NOT_MATCH
       46EF                     RFILES_DISP:
0006EF 46EF E5              11      PUSH    HL
0006F0 46F0 0608             7      LD  B,8
0006F2 46F2 CDA343          17      CALL    MSN
0006F5 46F5 3E2E             7      LD  A,'.'
0006F7 46F7 CD1051          17      CALL    MSG_A
0006FA 46FA 0603             7      LD  B,3
0006FC 46FC CDA343          17      CALL    MSN
0006FF 46FF 3ADDF3          13      LD  A,(CSRX)
000702 4702 47               4      LD  B,A
000703 4703 3AB0F3          13      LD  A,(LINLEN)
000706 4706 90               4      SUB B
000707 4707 FE0C             7      CP  12
000709 4709 3009            12      JR  NC,RFILES2
00070B 470B 3E0D             7      LD  A,00DH      ;改行
00070D 470D CD1051          17      CALL    MSG_A
000710 4710 3E0A             7      LD  A,00AH
000712 4712 1802            12      JR  RFILES3
       4714                     RFILES2:
000714 4714 3E20             7      LD  A,020H
       4716                     RFILES3:
000716 4716 CD1051          17      CALL    MSG_A
000719 4719 E1              10      POP HL
00071A 471A CDCB4B          17      CALL    FNEXT
       471D                     RFILES_NOT_MATCH:
00071D 471D 20CB            12      JR  NZ,RFILES1
00071F 471F C38246          10      JP  ROM_NEXT
                                
       4722                     INIT_PARAM:
000722 4722 224CF1          16      LD  (PARAM0),HL
000725 4725 224EF1          16      LD  (PARAM1),HL
000728 4728 EB               4      EX  DE,HL
000729 4729 AF               4      XOR A
00072A 472A 3232F1          13      LD  (FLG_LDIR),A
00072D 472D 32BEFC          13      LD  (RUNBNF),A
000730 4730 3263F6          13      LD  (VALTYP),A
000733 4733 E5              11      PUSH    HL
000734 4734 2A5CF1          16      LD  HL,(_CD)
000737 4737 225EF1          16      LD  (_CDX),HL
00073A 473A E1              10      POP HL
00073B 473B 13               6      INC DE
00073C 473C CD234B          17      CALL    SPCUT
00073F 473F 1A               7      LD  A,(DE)
000740 4740 B7               4      OR  A
000741 4741 C8              11      RET Z
000742 4742 FE3A             7      CP  ':'
000744 4744 C8              11      RET Z
000745 4745 FE28             7      CP  '('
000747 4747 C8              11      RET Z
000748 4748 EB               4      EX  DE,HL
000749 4749 DD21644C        14      LD  IX,FRMEVL
00074D 474D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000751 4751 CD1C00          17      CALL    _CALSLT
000754 4754 224EF1          16      LD  (PARAM1),HL
000757 4757 C9              10      RET
                                
       4758                     ROM_COPY:
000758 4758 CD2247          17      CALL    INIT_PARAM
00075B 475B 3A63F6          13      LD  A,(VALTYP)
00075E 475E FE03             7      CP  3       ;string
000760 4760 C20F4A          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
000763 4763 CD144A          17      CALL    FILE_B
000766 4766 CD934B          17      CALL    ROM_OPEN
000769 4769 DAE545          10      JP  C,ERROR_FILE_NOT_FOUND
                                
00076C 476C 213AF1          10      LD  HL,_BUF_W
00076F 476F 2230F1          16      LD  (_DTA),HL
000772 4772 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
000775 4775 CD7349          17      CALL    ROM_READ
                                
000778 4778 AF               4      XOR A
000779 4779 3235F1          13      LD  (_BUF_LO),A     ;PSET
00077C 477C 3242F1          13      LD  (_BUF_O),A      ;向き
                                
00077F 477F 2A4EF1          16      LD  HL,(PARAM1)
       4782                     RCP_PARAM1:
000782 4782 7E               7      LD  A,(HL)
000783 4783 23               6      INC HL
000784 4784 B7               4      OR  A
000785 4785 CA0F4A          10      JP  Z,ROM_ORG
000788 4788 FE3A             7      CP  ':'
00078A 478A CA0F4A          10      JP  Z,ROM_ORG
00078D 478D FE2C             7      CP  ','
00078F 478F 2012            12      JR  NZ,RCP_PARAM1_
                                
000791 4791 DD212F54        14      LD  IX,FRMQNT
000795 4795 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000799 4799 CD1C00          17      CALL    _CALSLT
00079C 479C 7B               4      LD  A,E
00079D 479D 87               4      ADD A,A
00079E 479E 87               4      ADD A,A
00079F 479F 3242F1          13      LD  (_BUF_O),A
0007A2 47A2 7E               7      LD  A,(HL)
       47A3                     RCP_PARAM1_:
0007A3 47A3 FE28             7      CP  '('
0007A5 47A5 20DB            12      JR  NZ,RCP_PARAM1
                                
0007A7 47A7 DD212F54        14      LD  IX,FRMQNT
0007AB 47AB FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007AF 47AF CD1C00          17      CALL    _CALSLT
                                
0007B2 47B2 ED533EF1        20      LD  (_BUF_X),DE
                                
       47B6                     RCP_PARAM2:
0007B6 47B6 23               6      INC HL
0007B7 47B7 7E               7      LD  A,(HL)
0007B8 47B8 FE20             7      CP  020H
0007BA 47BA 28FA            12      JR  Z,RCP_PARAM2
0007BC 47BC FE2C             7      CP  ','
0007BE 47BE 28F6            12      JR  Z,RCP_PARAM2
                                
0007C0 47C0 DD212F54        14      LD  IX,FRMQNT
0007C4 47C4 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007C8 47C8 CD1C00          17      CALL    _CALSLT
                                
0007CB 47CB ED5340F1        20      LD  (_BUF_Y),DE
       47CF                     RCP_PARAM3:
0007CF 47CF 23               6      INC HL
0007D0 47D0 7E               7      LD  A,(HL)
0007D1 47D1 FE20             7      CP  020H
0007D3 47D3 28FA            12      JR  Z,RCP_PARAM3
0007D5 47D5 FE29             7      CP  ')'
0007D7 47D7 28F6            12      JR  Z,RCP_PARAM3
0007D9 47D9 FE2C             7      CP  ','
0007DB 47DB 2033            12      JR  NZ,RCP_ST
                                
0007DD 47DD 23               6      INC HL
0007DE 47DE DD212F54        14      LD  IX,FRMQNT
0007E2 47E2 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007E6 47E6 CD1C00          17      CALL    _CALSLT
                                
0007E9 47E9 7B               4      LD  A,E
0007EA 47EA 3241F1          13      LD  (_BUF_P),A
                                
       47ED                     RCP_PARAM4:
0007ED 47ED 7E               7      LD  A,(HL)
0007EE 47EE 23               6      INC HL
0007EF 47EF FE20             7      CP  020H
0007F1 47F1 28FA            12      JR  Z,RCP_PARAM4
                                
0007F3 47F3 FE2C             7      CP  ','
0007F5 47F5 2019            12      JR  NZ,RCP_ST
                                
0007F7 47F7 7E               7      LD  A,(HL)
0007F8 47F8 0604             7      LD  B,4
0007FA 47FA FEC3             7      CP  0C3H        ;PRESET
0007FC 47FC 280E            12      JR  Z,RCP_LO
0007FE 47FE 05               4      DEC B       ;3
0007FF 47FF D6F8             7      SUB 0F8H        ;XOR
000801 4801 2809            12      JR  Z,RCP_LO
000803 4803 05               4      DEC B       ;2
000804 4804 3C               4      INC A       ;OR
000805 4805 2805            12      JR  Z,RCP_LO
000807 4807 05               4      DEC B       ;1
000808 4808 3C               4      INC A       ;AND
000809 4809 2801            12      JR  Z,RCP_LO
00080B 480B 05               4      DEC B       ;0
                                                ;PSET
       480C                     RCP_LO:
00080C 480C 78               4      LD  A,B
00080D 480D 3235F1          13      LD  (_BUF_LO),A
       4810                     RCP_ST:
000810 4810 2AC6F6          16      LD  HL,(STREND)
000813 4813 2230F1          16      LD  (_DTA),HL
000816 4816 EB               4      EX  DE,HL
000817 4817 2100FE          10      LD  HL,-512
00081A 481A 39              11      ADD HL,SP
00081B 481B AF               4      XOR A
00081C 481C ED52            15      SBC HL,DE
00081E 481E 3008            12      JR  NC,RCP0
000820 4820 215EF5          10      LD  HL,BUF
000823 4823 2230F1          16      LD  (_DTA),HL
000826 4826 6F               4      LD  L,A ;0
000827 4827 67               4      LD  H,A ;0
       4828                     RCP0:
000828 4828 24               4      INC H
000829 4829 2238F1          16      LD  (_BUF_EN),HL
       482C                     RCP1:
00082C 482C F3               4      DI
00082D 482D CD0149          17      CALL    WAIT_VDP
                                
000830 4830 3A0700          13      LD  A,(WRVDP)
000833 4833 4F               4      LD  C,A
000834 4834 0C               4      INC C       ;C := PORT#1's address(WR)
000835 4835 3E24             7      LD  A,36
000837 4837 ED79            12      OUT (C),A
000839 4839 3E91             7      LD  A,080H+17
00083B 483B ED79            12      OUT (C),A       ;R#17 := 36
                                
00083D 483D 0C               4      INC C
00083E 483E 0C               4      INC C       ;C := PORT#3's address(WR)
00083F 483F 2A3EF1          16      LD  HL,(_BUF_X)
000842 4842 ED69            12      OUT (C),L       ;R#36 DX
000844 4844 ED61            12      OUT (C),H       ;R#37
000846 4846 2A40F1          16      LD  HL,(_BUF_Y)
000849 4849 ED69            12      OUT (C),L       ;R#38 DY
00084B 484B ED61            12      OUT (C),H       ;R#39
00084D 484D 2A3AF1          16      LD  HL,(_BUF_W)
000850 4850 ED69            12      OUT (C),L       ;R#40 NX
000852 4852 ED61            12      OUT (C),H       ;R#41
000854 4854 2A3CF1          16      LD  HL,(_BUF_H)
000857 4857 ED69            12      OUT (C),L       ;R#42 NY
000859 4859 ED61            12      OUT (C),H       ;R#43
                                
00085B 485B DD2AAFFC        20      LD  IX,(SCRMOD)
00085F 485F 3A35F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000862 4862 B7               4      OR  A
000863 4863 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000865 4865 DD7D             9      LD  A,IXL
000867 4867 FE08             7      CP  8
000869 4869 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
00086B 486B FE06             7      CP  6
00086D 486D 2A3EF1          16      LD  HL,(_BUF_X)
000870 4870 3A3AF1          13      LD  A,(_BUF_W)
000873 4873 2005            12      JR  NZ,SCR57
000875 4875 B5               4      OR  L       ;スクリーン6
000876 4876 E603             7      AND 3
000878 4878 200D            12      JR  NZ,USE_LMMC
       487A                     SCR57:              ;スクリーン5,7
00087A 487A B5               4      OR  L
00087B 487B E601             7      AND 1
00087D 487D 2008            12      JR  NZ,USE_LMMC
       487F                     USE_HMMC:
00087F 487F DD2E08          10      LD  IXL,8
       4882                     USE_HMMC8:
000882 4882 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
000884 4884 3235F1          13      LD  (_BUF_LO),A
       4887                     USE_LMMC:
000887 4887 110000          10      LD  DE,0
00088A 488A 06FF             7      LD  B,-1
00088C 488C CD2C49          17      CALL    GET_PIXEL
00088F 488F ED79            12      OUT (C),A       ;R#44 first DATA
000891 4891 3A42F1          13      LD  A,(_BUF_O)
000894 4894 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
000896 4896 3A35F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000899 4899 F6B0             7      OR  0B0H        ;R#46 LMMC command
00089B 489B ED79            12      OUT (C),A
                                
00089D 489D FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
00089F 489F 0D               4      DEC C
0008A0 48A0 0D               4      DEC C       ;C := PORT#1's address(WR)
0008A1 48A1 3EAC             7      LD  A,080H+44
0008A3 48A3 ED79            12      OUT (C),A
0008A5 48A5 3E91             7      LD  A,080H+17
0008A7 48A7 ED79            12      OUT (C),A       ;R#17 := 44
                                
0008A9 48A9 3A0600          13      LD  A,(RDVDP)
0008AC 48AC 3C               4      INC A
0008AD 48AD FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
0008AF 48AF 3E02             7      LD  A,2
0008B1 48B1 ED79            12      OUT (C),A
0008B3 48B3 3E8F             7      LD  A,08FH
0008B5 48B5 ED79            12      OUT (C),A
0008B7 48B7 3A35F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0008BA 48BA E640             7      AND 040H
0008BC 48BC 201C            12      JR  NZ,LOOP_HMMC
       48BE                     LOOP_COPY:
0008BE 48BE CD2C49          17      CALL    GET_PIXEL
0008C1 48C1 08               4      EX  AF,AF'
0008C2 48C2 FD4C             9      LD  C,IYH
       48C4                     LOOP_COPY1:
0008C4 48C4 ED78            12      IN  A,(C)
0008C6 48C6 0F               4      RRCA            ;RRCAではサインフラグは変化しない
0008C7 48C7 300A            12      JR  NC,EXIT_COPY    ;check CE bit
0008C9 48C9 F2C448          10      JP  P,LOOP_COPY1    ;check TR bit
0008CC 48CC 08               4      EX  AF,AF'
0008CD 48CD FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
0008CF 48CF ED79            12      OUT (C),A
0008D1 48D1 18EB            12      JR  LOOP_COPY
                                
       48D3                     EXIT_COPY:
0008D3 48D3 CD0949          17      CALL    GET_STATUS_0
0008D6 48D6 FB               4      EI
0008D7 48D7 C38246          10      JP  ROM_NEXT
                                
       48DA                     LOOP_HMMC:
0008DA 48DA FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
0008DC 48DC 43               4      LD  B,E
0008DD 48DD 7B               4      LD  A,E
0008DE 48DE B7               4      OR  A
0008DF 48DF 2802            12      JR  Z,LOOP_HMMC1
0008E1 48E1 EDB3                    OTIR
       48E3                     LOOP_HMMC1:
0008E3 48E3 14               4      INC D
       48E4                     LOOP_HMMC2:
0008E4 48E4 15               4      DEC D
0008E5 48E5 2805            12      JR  Z,LOOP_HMMC3
0008E7 48E7 EDB3                    OTIR
0008E9 48E9 C3E448          10      JP  LOOP_HMMC2
       48EC                     LOOP_HMMC3:
0008EC 48EC ED78            12      IN  A,(C)
0008EE 48EE 0F               4      RRCA
0008EF 48EF 30E2            12      JR  NC,EXIT_COPY    ;check CE bit
0008F1 48F1 2A38F1          16      LD  HL,(_BUF_EN)
0008F4 48F4 CD7349          17      CALL    ROM_READ
0008F7 48F7 EB               4      EX  DE,HL
0008F8 48F8 2A30F1          16      LD  HL,(_DTA)
0008FB 48FB 7A               4      LD  A,D
0008FC 48FC B3               4      OR  E
0008FD 48FD 20DB            12      JR  NZ,LOOP_HMMC
0008FF 48FF 18C3            12      JR  LOOP_COPY1
                                    
       4901                     WAIT_VDP:
000901 4901 3E02             7      LD  A,2
000903 4903 CD0A49          17      CALL    GET_STATUS
000906 4906 0F               4      RRCA
000907 4907 38F8            12      JR  C,WAIT_VDP
       4909                     GET_STATUS_0:
000909 4909 AF               4      XOR A
       490A                     GET_STATUS:
00090A 490A C5              11      PUSH    BC
00090B 490B ED4B0600        20      LD  BC,(RDVDP)
00090F 490F 0C               4      INC C
000910 4910 ED79            12      OUT (C),A
000912 4912 3E8F             7      LD  A,08FH
000914 4914 ED79            12      OUT (C),A
000916 4916 ED78            12      IN  A,(C)
000918 4918 C1              10      POP BC
000919 4919 C9              10      RET
                                
       491A                     GET_PIXEL256:
00091A 491A 7A               4      LD  A,D
00091B 491B B3               4      OR  E
00091C 491C 200A            12      JR  NZ,GET_PIXEL1
00091E 491E 2A38F1          16      LD  HL,(_BUF_EN)
000921 4921 CD7349          17      CALL    ROM_READ
000924 4924 EB               4      EX  DE,HL
000925 4925 2A30F1          16      LD  HL,(_DTA)
       4928                     GET_PIXEL1:
000928 4928 7E               7      LD  A,(HL)
000929 4929 23               6      INC HL
00092A 492A 1B               6      DEC DE
00092B 492B C9              10      RET
                                
       492C                     GET_PIXEL:
00092C 492C 04               4      INC B
00092D 492D DD7D             9      LD  A,IXL
00092F 492F FE08             7      CP  8
000931 4931 28E7            12      JR  Z,GET_PIXEL256
000933 4933 FE06             7      CP  6
000935 4935 282E            12      JR  Z,GET_PIXEL4
                                
000937 4937 CB40             8      BIT 0,B
000939 4939 20ED            12      JR  NZ,GET_PIXEL1
                                
00093B 493B 7A               4      LD  A,D
00093C 493C B3               4      OR  E
00093D 493D 200A            12      JR  NZ,GET_PIXEL2
                                
00093F 493F 2A38F1          16      LD  HL,(_BUF_EN)
000942 4942 CD7349          17      CALL    ROM_READ
000945 4945 EB               4      EX  DE,HL
000946 4946 2A30F1          16      LD  HL,(_DTA)
                                
       4949                     GET_PIXEL2:
000949 4949 7E               7      LD  A,(HL)
00094A 494A 0F               4      RRCA
00094B 494B 0F               4      RRCA
00094C 494C 0F               4      RRCA
00094D 494D 0F               4      RRCA
00094E 494E C9              10      RET
                                
       494F                     GET_PIXEL3:
00094F 494F 7A               4      LD  A,D
000950 4950 B3               4      OR  E
000951 4951 200A            12      JR  NZ,GET_PIXEL5
                                
000953 4953 2A38F1          16      LD  HL,(_BUF_EN)
000956 4956 CD7349          17      CALL    ROM_READ
000959 4959 EB               4      EX  DE,HL
00095A 495A 2A30F1          16      LD  HL,(_DTA)
       495D                     GET_PIXEL5:
00095D 495D 7E               7      LD  A,(HL)
00095E 495E 0F               4      RRCA
00095F 495F 0F               4      RRCA
000960 4960 0F               4      RRCA
000961 4961 0F               4      RRCA
000962 4962 0F               4      RRCA
000963 4963 0F               4      RRCA
000964 4964 C9              10      RET
                                
       4965                     GET_PIXEL4:
000965 4965 78               4      LD  A,B
000966 4966 E603             7      AND 3   ;+0
000968 4968 28E5            12      JR  Z,GET_PIXEL3
00096A 496A 3D               4      DEC A   ;+1
00096B 496B 28DC            12      JR  Z,GET_PIXEL2
00096D 496D 3D               4      DEC A   ;+2
00096E 496E 7E               7      LD  A,(HL)
00096F 496F C0              11      RET NZ
000970 4970 0F               4      RRCA        ;+3
000971 4971 0F               4      RRCA
000972 4972 C9              10      RET
                                
       4973                     ROM_READ:
000973 4973 E5              11      PUSH    HL
000974 4974 D5              11      PUSH    DE
000975 4975 C5              11      PUSH    BC
000976 4976 FDE5            15      PUSH    IY
000978 4978 224AF1          16      LD  (LEFTX),HL
00097B 497B 2A30F1          16      LD  HL,(_DTA)
00097E 497E 2243F1          16      LD  (DTAX),HL
000981 4981 2A4AF1          16      LD  HL,(LEFTX)
                                
000984 4984 CD0F4C          17      CALL    RBX1
000987 4987 3870            12      JR  C,RBRERR1
000989 4989 79               4      LD  A,C
00098A 498A EB               4      EX  DE,HL
00098B 498B ED52            15      SBC HL,DE       ;CP 0HL,CDE
00098D 498D 19              11      ADD HL,DE
00098E 498E DE00             7      SBC A,000H
000990 4990 3801            12      JR  C,RBR1
000992 4992 EB               4      EX  DE,HL
       4993                     RBR1:
000993 4993 9F               4      SBC A,A
000994 4994 E601             7      AND 1
000996 4996 321FF1          13      LD  (_RESULT),A
000999 4999 7C               4      LD  A,H
00099A 499A B5               4      OR  L
00099B 499B CAEF49          10      JP  Z,RBREND0
                                
00099E 499E 222CF1          16      LD  (_LEFT),HL  ;Read record byte
0009A1 49A1 224AF1          16      LD  (LEFTX),HL
                                
0009A4 49A4 CD384C          17      CALL    RBX2
0009A7 49A7 281A            12      JR  Z,RBRB
                                                ;先頭の端数
0009A9 49A9 CD4B4C          17      CALL    RBXA
0009AC 49AC DA054A          10      JP  C,RBRERR
0009AF 49AF C5              11      PUSH    BC
0009B0 49B0 CDFE43          17      CALL    ROM_LDIR
0009B3 49B3 ED5343F1        20      LD  (DTAX),DE
0009B7 49B7 2A4AF1          16      LD  HL,(LEFTX)
0009BA 49BA D1              10      POP DE
0009BB 49BB A7               4      AND A
0009BC 49BC ED52            15      SBC HL,DE
0009BE 49BE 224AF1          16      LD  (LEFTX),HL
0009C1 49C1 2829            12      JR  Z,RBREND
                                
       49C3                     RBRB:
0009C3 49C3 CD844C          17      CALL    RBXB
0009C6 49C6 2818            12      JR  Z,RBRC
       49C8                     RBRB1:
0009C8 49C8 C5              11      PUSH    BC
0009C9 49C9 D5              11      PUSH    DE
0009CA 49CA CD2C4D          17      CALL    CLUST
0009CD 49CD EB               4      EX  DE,HL
0009CE 49CE ED4B22F1        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
0009D2 49D2 CDFE43          17      CALL    ROM_LDIR
0009D5 49D5 EB               4      EX  DE,HL
0009D6 49D6 D1              10      POP DE
0009D7 49D7 C1              10      POP BC
0009D8 49D8 CD094D          17      CALL    GNCL
0009DB 49DB DA054A          10      JP  C,RBRERR
0009DE 49DE 10E8            13      DJNZ    RBRB1
       49E0                     RBRC:
0009E0 49E0 CD9C4C          17      CALL    RBXC
0009E3 49E3 2807            12      JR  Z,RBREND
                                
0009E5 49E5 CD2C4D          17      CALL    CLUST
0009E8 49E8 EB               4      EX  DE,HL
0009E9 49E9 CDFE43          17      CALL    ROM_LDIR
       49EC                     RBREND:
0009EC 49EC CDA84C          17      CALL    RBXEND
       49EF                     RBREND0:
0009EF 49EF FDE1            14      POP IY
0009F1 49F1 C1              10      POP BC
0009F2 49F2 D1              10      POP DE
0009F3 49F3 F1              10      POP AF  ;(HL)
0009F4 49F4 AF               4      XOR A
0009F5 49F5 3A1FF1          13      LD  A,(_RESULT)
0009F8 49F8 C9              10      RET
                                
       49F9                     RBRERR1:
0009F9 49F9 3E01             7      LD  A,001H
       49FB                     RBRERR2:
0009FB 49FB FDE1            14      POP IY
0009FD 49FD C1              10      POP BC
0009FE 49FE D1              10      POP DE
0009FF 49FF E1              10      POP HL
000A00 4A00 37               4      SCF
000A01 4A01 210000          10      LD  HL,0
000A04 4A04 C9              10      RET
       4A05                     RBRERR:
000A05 4A05 3EFF             7      LD  A,0FFH
000A07 4A07 18F2            12      JR  RBRERR2
                                
       4A09                     FILE_DD:
000A09 4A09 E1              10      POP HL
000A0A 4A0A 3E                      DB  03EH
000A0B 4A0B C9              10      RET
000A0C 4A0C 320CF1          13      LD  (SWC_BLOAD_M),A
       4A0F                     ROM_ORG:
000A0F 4A0F 2A4CF1          16      LD  HL,(PARAM0)
000A12 4A12 7E               7      LD  A,(HL)
000A13 4A13 C9              10      RET
       4A14                     FILE_B:
000A14 4A14 AF               4      XOR A
000A15 4A15 3250F1          13      LD  (FDRV),A
000A18 4A18 1E00             7      LD  E,0
000A1A 4A1A 3A63F6          13      LD  A,(VALTYP)
000A1D 4A1D FE03             7      CP  3       ;string
000A1F 4A1F C2A44A          10      JP  NZ,FILED
                                
000A22 4A22 DD21D067        14      LD  IX,FRESTR
000A26 4A26 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000A2A 4A2A CD1C00          17      CALL    _CALSLT
000A2D 4A2D E5              11      PUSH    HL
000A2E 4A2E DDE1            14      POP IX
                                
000A30 4A30 DD5E00          19      LD  E,(IX+0)
000A33 4A33 DD7E01          19      LD  A,(IX+1)
000A36 4A36 DD5602          19      LD  D,(IX+2)
000A39 4A39 DD62             9      LD  IXH,D
000A3B 4A3B DD6F             9      LD  IXL,A
000A3D 4A3D 7B               4      LD  A,E
       4A3E                     FILE_BDOS:
000A3E 4A3E FE04             7      CP  4
000A40 4A40 3808            12      JR  C,FILEB1
000A42 4A42 DD7E03          19      LD  A,(IX+3)
000A45 4A45 FE3A             7      CP  ':'
000A47 4A47 28C0            12      JR  Z,FILE_DD
000A49 4A49 7B               4      LD  A,E
       4A4A                     FILEB1:
000A4A 4A4A FE02             7      CP  2
000A4C 4A4C 3818            12      JR  C,DEVI1
000A4E 4A4E DD7E01          19      LD  A,(IX+1)
000A51 4A51 FE3A             7      CP  ':'
000A53 4A53 2011            12      JR  NZ,DEVI1
000A55 4A55 DD7E00          19      LD  A,(IX+0)        ;DRIVE
000A58 4A58 CD7D4B          17      CALL    CAP
000A5B 4A5B D640             7      SUB '@'
000A5D 4A5D DD23            10      INC IX
000A5F 4A5F DD23            10      INC IX
000A61 4A61 1D               4      DEC E
000A62 4A62 1D               4      DEC E
000A63 4A63 3250F1          13      LD  (FDRV),A
       4A66                     DEVI1:
000A66 4A66 DD7E00          19      LD  A,(IX+0)
000A69 4A69 D65C             7      SUB 05CH        ;\
000A6B 4A6B 2008            12      JR  NZ,NOROOT
000A6D 4A6D 6F               4      LD  L,A
000A6E 4A6E 67               4      LD  H,A
000A6F 4A6F 225EF1          16      LD  (_CDX),HL
000A72 4A72 DD23            10      INC IX
000A74 4A74 1D               4      DEC E
       4A75                     NOROOT:
                                
       4A75                     SETDIR:
000A75 4A75 CDA44A          17      CALL    FILED
000A78 4A78 DD7E00          19      LD  A,(IX+0)
000A7B 4A7B FE5C             7      CP  05CH        ;\
000A7D 4A7D C0              11      RET NZ
000A7E 4A7E DD23            10      INC IX
000A80 4A80 1D               4      DEC E
000A81 4A81 3A51F1          13      LD  A,(FNAME)
000A84 4A84 FE20             7      CP  020H        ;. の処理
000A86 4A86 28ED            12      JR  Z,SETDIR
                                
000A88 4A88 CD934B          17      CALL    ROM_OPEN
000A8B 4A8B B7               4      OR  A
000A8C 4A8C C0              11      RET NZ
                                
000A8D 4A8D FD2A47F1        20      LD  IY,(DIRENT1)
000A91 4A91 FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
000A95 4A95 C8              11      RET Z
000A96 4A96 CDEB4A          17      CALL    FILEI
000A99 4A99 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000A9C 4A9C FD661B          19      LD  H,(IY+01BH)
000A9F 4A9F 225EF1          16      LD  (_CDX),HL
000AA2 4AA2 18D1            12      JR  SETDIR
                                
       4AA4                     FILED:
000AA4 4AA4 CDEB4A          17      CALL    FILEI
000AA7 4AA7 2151F1          10      LD  HL,FNAME
                                
000AAA 4AAA 0608             7      LD  B,8
       4AAC                     FILE2:
000AAC 4AAC CDF84A          17      CALL    CCHKF
000AAF 4AAF C8              11      RET Z
000AB0 4AB0 FE2A             7      CP  '*'
000AB2 4AB2 282E            12      JR  Z,FILE9
000AB4 4AB4 FE2E             7      CP  '.'
000AB6 4AB6 280C            12      JR  Z,FILE4
000AB8 4AB8 77               7      LD  (HL),A
000AB9 4AB9 23               6      INC HL
000ABA 4ABA 10F0            13      DJNZ    FILE2
                                
       4ABC                     FILE3:
000ABC 4ABC CDF84A          17      CALL    CCHKF
000ABF 4ABF C8              11      RET Z
000AC0 4AC0 FE2E             7      CP  '.'
000AC2 4AC2 20F8            12      JR  NZ,FILE3
                                
       4AC4                     FILE4:
000AC4 4AC4 2159F1          10      LD  HL,FNAME+8
000AC7 4AC7 0603             7      LD  B,3
                                
       4AC9                     FILE4L:
000AC9 4AC9 CDF84A          17      CALL    CCHKF
000ACC 4ACC C8              11      RET Z
000ACD 4ACD FE2E             7      CP  '.'
000ACF 4ACF 2008            12      JR  NZ,FILE12
000AD1 4AD1 3251F1          13      LD  (FNAME),A   ;Parent directory(..)
000AD4 4AD4 3252F1          13      LD  (FNAME+1),A
000AD7 4AD7 3E20             7      LD  A,020H
       4AD9                     FILE12:
000AD9 4AD9 FE2A             7      CP  '*'
000ADB 4ADB 280A            12      JR  Z,FILE10
000ADD 4ADD 77               7      LD  (HL),A
000ADE 4ADE 23               6      INC HL
000ADF 4ADF 10E8            13      DJNZ    FILE4L
000AE1 4AE1 C9              10      RET
                                
       4AE2                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000AE2 4AE2 CDE74A          17      CALL    FILE10
000AE5 4AE5 18D5            12      JR  FILE3
                                
       4AE7                     FILE10:
000AE7 4AE7 3E3F             7      LD  A,'?'
000AE9 4AE9 1808            12      JR  FILL_MEMORY
       4AEB                     FILEI:              ;名前＋拡張子をスペースで初期化
000AEB 4AEB 3E20             7      LD  A,020H
000AED 4AED 01000B          10      LD  BC,11*256   ;C=0にしておく
000AF0 4AF0 2151F1          10      LD  HL,FNAME
       4AF3                     FILL_MEMORY:            ;HLからBバイトAで埋める
000AF3 4AF3 77               7      LD  (HL),A
000AF4 4AF4 23               6      INC HL
000AF5 4AF5 10FC            13      DJNZ    FILL_MEMORY
000AF7 4AF7 C9              10      RET
                                
       4AF8                     CCHKF:
000AF8 4AF8 7B               4      LD  A,E
000AF9 4AF9 B7               4      OR  A
000AFA 4AFA C8              11      RET Z
000AFB 4AFB DD7E00          19      LD  A,(IX+0)
000AFE 4AFE CD054B          17      CALL    CCHK2
000B01 4B01 C8              11      RET Z
000B02 4B02 C3684B          10      JP  FKAN
                                
       4B05                     CCHK2:
000B05 4B05 0C               4      INC C
000B06 4B06 0D               4      DEC C
000B07 4B07 C0              11      RET NZ
       4B08                     CCHK3:              ;ZF=1 で使えない文字
000B08 4B08 FE2B             7      CP  '+'
000B0A 4B0A C8              11      RET Z
000B0B 4B0B FE2C             7      CP  ','
000B0D 4B0D C8              11      RET Z
000B0E 4B0E FE2F             7      CP  '/'
000B10 4B10 C8              11      RET Z
000B11 4B11 FE3A             7      CP  ':'
000B13 4B13 C8              11      RET Z
000B14 4B14 FE3B             7      CP  ';'
000B16 4B16 C8              11      RET Z
000B17 4B17 FE3D             7      CP  '='
000B19 4B19 C8              11      RET Z
000B1A 4B1A FE5C             7      CP  05CH    ;\
000B1C 4B1C C8              11      RET Z
000B1D 4B1D FE1F             7      CP  01FH
000B1F 4B1F D0              11      RET NC
000B20 4B20 BF               4      CP  A       ;Z=1
000B21 4B21 C9              10      RET
                                
       4B22                     SS1:
000B22 4B22 13               6      INC DE
       4B23                     SPCUT:              ;スペースをカット
000B23 4B23 1A               7      LD  A,(DE)
000B24 4B24 FE20             7      CP  020H
000B26 4B26 28FA            12      JR  Z,SS1
000B28 4B28 C9              10      RET
                                
       4B29                     SCREOF1:
000B29 4B29 13               6      INC DE
       4B2A                     SPCUTEX:            ;スペース改行などをカット
000B2A 4B2A 1A               7      LD  A,(DE)
000B2B 4B2B FE20             7      CP  020H
000B2D 4B2D 28FA            12      JR  Z,SCREOF1
000B2F 4B2F FE0D             7      CP  00DH
000B31 4B31 28F6            12      JR  Z,SCREOF1
000B33 4B33 FE0A             7      CP  00AH
000B35 4B35 28F2            12      JR  Z,SCREOF1
000B37 4B37 FE1A             7      CP  01AH
000B39 4B39 28EE            12      JR  Z,SCREOF1
000B3B 4B3B C9              10      RET
                                
       4B3C                     GETNUM:
000B3C 4B3C 210000          10      LD  HL,0
       4B3F                     GETNUM1:
000B3F 4B3F 1A               7      LD  A,(DE)
000B40 4B40 13               6      INC DE
000B41 4B41 D630             7      SUB '0'
000B43 4B43 D8              11      RET C
000B44 4B44 FE0A             7      CP  10
000B46 4B46 D0              11      RET NC
000B47 4B47 4D               4      LD  C,L
000B48 4B48 44               4      LD  B,H
000B49 4B49 29              11      ADD HL,HL   ;*2
000B4A 4B4A 29              11      ADD HL,HL   ;*4
000B4B 4B4B 09              11      ADD HL,BC   ;*5
000B4C 4B4C 29              11      ADD HL,HL   ;*10
000B4D 4B4D 4F               4      LD  C,A
000B4E 4B4E 0600             7      LD  B,0
000B50 4B50 09              11      ADD HL,BC
000B51 4B51 18EC            12      JR  GETNUM1
                                
       4B53                     SEARCH_END:
000B53 4B53 7E               7      LD  A,(HL)
       4B54                     SEARCH_END1:
000B54 4B54 23               6      INC HL
000B55 4B55 B7               4      OR  A
000B56 4B56 C8              11      RET Z
000B57 4B57 FE3A             7      CP  ':'
000B59 4B59 20F8            12      JR  NZ,SEARCH_END
000B5B 4B5B 7E               7      LD  A,(HL)
000B5C 4B5C FE3A             7      CP  ':'
000B5E 4B5E 28F4            12      JR  Z,SEARCH_END1
000B60 4B60 C9              10      RET
                                
       4B61                     FKANC:
000B61 4B61 CB41             8      BIT 0,C
000B63 4B63 CC864B          17      CALL    Z,CAP2
000B66 4B66 1803            12      JR  FKANX
       4B68                     FKAN:           ;漢字チェック
000B68 4B68 DD23            10      INC IX
000B6A 4B6A 1D               4      DEC E
       4B6B                     FKANX:
000B6B 4B6B CB41             8      BIT 0,C
000B6D 4B6D CB81             8      RES 0,C
000B6F 4B6F C0              11      RET NZ
000B70 4B70 FE80             7      CP  080H
000B72 4B72 D8              11      RET C
000B73 4B73 FEA0             7      CP  0A0H
000B75 4B75 3803            12      JR  C,FKAN1
000B77 4B77 FEE0             7      CP  0E0H
000B79 4B79 D8              11      RET C
       4B7A                     FKAN1:
000B7A 4B7A 0C               4      INC C
000B7B 4B7B A7               4      AND A
000B7C 4B7C C9              10      RET
                                
       4B7D                     CAP:
000B7D 4B7D FE61             7      CP  'a'
000B7F 4B7F D8              11      RET C
000B80 4B80 FE7B             7      CP  'z'+1
000B82 4B82 D0              11      RET NC
000B83 4B83 D620             7      SUB 020H
000B85 4B85 C9              10      RET
       4B86                     CAP2:
000B86 4B86 CD7D4B          17      CALL    CAP
       4B89                     CAP3:               ;
000B89 4B89 FE05             7      CP  5
000B8B 4B8B 2803            12      JR  Z,CAP4
000B8D 4B8D FE21             7      CP  021H
000B8F 4B8F C9              10      RET
       4B90                     CAP4:
000B90 4B90 3EE5             7      LD  A,0E5H
000B92 4B92 C9              10      RET
                                
       4B93                     ROM_OPEN:
000B93 4B93 CDA650          17      CALL    GET_DISK_BANK_FDRV
                                
000B96 4B96 CDE54D          17      CALL    GET_DIR_DAT
000B99 4B99 D5              11      PUSH    DE
000B9A 4B9A CDAF4B          17      CALL    FILESE
000B9D 4B9D D1              10      POP DE
000B9E 4B9E 3F               4      CCF
000B9F 4B9F D8              11      RET C
000BA0 4BA0 2247F1          16      LD  (DIRENT1),HL
000BA3 4BA3 E5              11      PUSH    HL
000BA4 4BA4 210000          10      LD  HL,0
000BA7 4BA7 2226F1          16      LD  (RR_LOW),HL
000BAA 4BAA 2228F1          16      LD  (RR_HIGH),HL
000BAD 4BAD E1              10      POP HL
000BAE 4BAE C9              10      RET
                                
       4BAF                     FILESE:
000BAF 4BAF 7E               7      LD  A,(HL)
000BB0 4BB0 B7               4      OR  A
000BB1 4BB1 C8              11      RET Z       ;END:ZF=1 CF=0
000BB2 4BB2 FEE5             7      CP  0E5H
000BB4 4BB4 280D            12      JR  Z,FILESE1
000BB6 4BB6 1151F1          10      LD  DE,FNAME
000BB9 4BB9 E5              11      PUSH    HL
000BBA 4BBA CDE94B          17      CALL    CPFILE
000BBD 4BBD CC0A4C          17      CALL    Z,CPFILE2
000BC0 4BC0 E1              10      POP HL
000BC1 4BC1 37               4      SCF
000BC2 4BC2 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4BC3                     FILESE1:
000BC3 4BC3 CDCB4B          17      CALL    FNEXT
000BC6 4BC6 20E7            12      JR  NZ,FILESE
000BC8 4BC8 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000BCA 4BCA C9              10      RET
                                
       4BCB                     FNEXT:
000BCB 4BCB 112000          10      LD  DE,020H
000BCE 4BCE 19              11      ADD HL,DE
000BCF 4BCF ED5B5EF1        20      LD  DE,(_CDX)
000BD3 4BD3 7A               4      LD  A,D
000BD4 4BD4 B3               4      OR  E
000BD5 4BD5 2002            12      JR  NZ,FNEXT_SUBDIR
000BD7 4BD7 0D               4      DEC C
                                #if exists USE_NORMAL_32K_ROM
                                #else
                                CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
                                    PUSH    AF      ;※フラグを保存する必要あり
                                    BIT 7,H
                                    JR  Z,CHECK_DIR_PAGE1
                                    LD  A,H
                                    SUB 020H
                                    LD  H,A
                                    LD  A,(_DIR_BANK)
                                    INC A
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_DIR_BANK),A
                                CHECK_DIR_PAGE1:
                                    POP AF
                                #endif
000BD8 4BD8 C9              10      RET
                                
       4BD9                     FNEXT_SUBDIR:           ;サブディレクトリ
000BD9 4BD9 0D               4      DEC C
000BDA 4BDA C0              11      RET NZ
                                
000BDB 4BDB ED5B5EF1        20      LD  DE,(_CDX)
000BDF 4BDF CD094D          17      CALL    GNCL
000BE2 4BE2 EB               4      EX  DE,HL
000BE3 4BE3 225EF1          16      LD  (_CDX),HL
000BE6 4BE6 C31D4E          10      JP  GET_SUBDIR
                                
       4BE9                     CPFILE:
000BE9 4BE9 C5              11      PUSH    BC
000BEA 4BEA 01000B          10      LD  BC,00B00H
       4BED                     CPSTR1:
000BED 4BED 1A               7      LD  A,(DE)
000BEE 4BEE FE3F             7      CP  '?'     ;Wild card
000BF0 4BF0 2812            12      JR  Z,CPSTR2
000BF2 4BF2 7E               7      LD  A,(HL)
000BF3 4BF3 CD614B          17      CALL    FKANC
000BF6 4BF6 E5              11      PUSH    HL
000BF7 4BF7 67               4      LD  H,A
000BF8 4BF8 1A               7      LD  A,(DE)
000BF9 4BF9 CB01             4      RLC C
000BFB 4BFB CD614B          17      CALL    FKANC
000BFE 4BFE CB09             4      RRC C
000C00 4C00 BC               4      CP  H       ;CP (HL),(DE)
000C01 4C01 E1              10      POP HL
000C02 4C02 2004            12      JR  NZ,CPSTR3
       4C04                     CPSTR2:
000C04 4C04 13               6      INC DE
000C05 4C05 23               6      INC HL
000C06 4C06 10E5            13      DJNZ    CPSTR1
       4C08                     CPSTR3:
000C08 4C08 C1              10      POP BC
000C09 4C09 C9              10      RET
                                
       4C0A                     CPFILE2:
                                ;   LD  A,0E1H
000C0A 4C0A 3EF1             7      LD  A,0F1H
000C0C 4C0C 2F               4      CPL
000C0D 4C0D A6               7      AND (HL)
000C0E 4C0E C9              10      RET
                                
       4C0F                     RBX1:
000C0F 4C0F E5              11      PUSH    HL      ;Record byte
                                
000C10 4C10 ED5B26F1        20      LD  DE,(RR_LOW) ;CDE=Random record
000C14 4C14 3A29F1          13      LD  A,(RR_HIGH+1)
000C17 4C17 4F               4      LD  C,A
                                
000C18 4C18 3A49F1          13      LD  A,(_DIR_BANK)
                                #if exists USE_NORMAL_32K_ROM
000C1B 4C1B 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000C1E 4C1E FD2A47F1        20      LD  IY,(DIRENT1)
000C22 4C22 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000C25 4C25 FD661D          19      LD  H,(IY+01DH)
000C28 4C28 FD7E1E          19      LD  A,(IY+01EH)
                                
000C2B 4C2B A7               4      AND A
000C2C 4C2C ED52            15      SBC HL,DE
000C2E 4C2E 99               4      SBC A,C
000C2F 4C2F D1              10      POP DE
                                
000C30 4C30 D8              11      RET C
000C31 4C31 4F               4      LD  C,A
000C32 4C32 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000C33 4C33 B2               4      OR  D
000C34 4C34 B3               4      OR  E
000C35 4C35 C0              11      RET NZ
000C36 4C36 37               4      SCF
000C37 4C37 C9              10      RET
                                
       4C38                     RBX2:
000C38 4C38 ED4B27F1        20      LD  BC,(RR_LOW+1)
000C3C 4C3C CDBD4C          17      CALL    RWXR
000C3F 4C3F 3A23F1          13      LD  A,(CLSZ_H)
000C42 4C42 3D               4      DEC A
000C43 4C43 E5              11      PUSH    HL
000C44 4C44 2A26F1          16      LD  HL,(RR_LOW)
000C47 4C47 A4               4      AND H
000C48 4C48 B5               4      OR  L
000C49 4C49 E1              10      POP HL
000C4A 4C4A C9              10      RET
                                
       4C4B                     RBXA:
000C4B 4C4B D5              11      PUSH    DE
000C4C 4C4C CD2C4D          17      CALL    CLUST
000C4F 4C4F ED532EF1        20      LD  (_DTPS),DE
000C53 4C53 D1              10      POP DE
000C54 4C54 CD094D          17      CALL    GNCL
000C57 4C57 D8              11      RET C
000C58 4C58 ED532AF1        20      LD  (_CLPS),DE
                                
000C5C 4C5C ED4B26F1        20      LD  BC,(RR_LOW)
000C60 4C60 2A22F1          16      LD  HL,(CLSZ)
000C63 4C63 7C               4      LD  A,H
000C64 4C64 3D               4      DEC A
000C65 4C65 A0               4      AND B
000C66 4C66 47               4      LD  B,A
000C67 4C67 ED42            15      SBC HL,BC       ;remaining cluster
                                
000C69 4C69 ED5B4AF1        20      LD  DE,(LEFTX)
000C6D 4C6D ED52            15      SBC HL,DE       ;CP HL,DE
000C6F 4C6F 19              11      ADD HL,DE
000C70 4C70 3801            12      JR  C,RBXA1
000C72 4C72 EB               4      EX  DE,HL
       4C73                     RBXA1:
000C73 4C73 3A20F1          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_NORMAL_32K_ROM
000C76 4C76 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000C79 4C79 E5              11      PUSH    HL
000C7A 4C7A 2A2EF1          16      LD  HL,(_DTPS)
000C7D 4C7D 09              11      ADD HL,BC
000C7E 4C7E ED5B43F1        20      LD  DE,(DTAX)
000C82 4C82 C1              10      POP BC
000C83 4C83 C9              10      RET
                                
       4C84                     RBXB:
000C84 4C84 2A43F1          16      LD  HL,(DTAX)
000C87 4C87 ED5B2AF1        20      LD  DE,(_CLPS)
000C8B 4C8B 3A4BF1          13      LD  A,(LEFTX+1)
000C8E 4C8E 47               4      LD  B,A
000C8F 4C8F 3A23F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4C92                     RBXB1:
000C92 4C92 1F               4      RRA     ;->CF
000C93 4C93 3804            12      JR  C,RBXB2
000C95 4C95 CB38             8      SRL B   ;B=B/2
000C97 4C97 18F9            12      JR  RBXB1
       4C99                     RBXB2:
000C99 4C99 78               4      LD  A,B
000C9A 4C9A B7               4      OR  A
000C9B 4C9B C9              10      RET
                                
       4C9C                     RBXC:
000C9C 4C9C ED4B4AF1        20      LD  BC,(LEFTX)
000CA0 4CA0 3A23F1          13      LD  A,(CLSZ_H)
000CA3 4CA3 3D               4      DEC A
000CA4 4CA4 A0               4      AND B
000CA5 4CA5 47               4      LD  B,A
000CA6 4CA6 B1               4      OR  C
000CA7 4CA7 C9              10      RET
                                
       4CA8                     RBXEND:
000CA8 4CA8 ED5B2CF1        20      LD  DE,(_LEFT)
000CAC 4CAC 2A26F1          16      LD  HL,(RR_LOW)
000CAF 4CAF 3A29F1          13      LD  A,(RR_HIGH+1)
000CB2 4CB2 19              11      ADD HL,DE
000CB3 4CB3 CE00             7      ADC A,0
000CB5 4CB5 2226F1          16      LD  (RR_LOW),HL
000CB8 4CB8 3229F1          13      LD  (RR_HIGH+1),A
000CBB 4CBB EB               4      EX  DE,HL       ;HL=Read byte
000CBC 4CBC C9              10      RET 
                                
       4CBD                     RWXR:
000CBD 4CBD 3A23F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4CC0                     L_RWX:
000CC0 4CC0 1F               4      RRA     ;->CF
000CC1 4CC1 3806            12      JR  C,E_RWX
000CC3 4CC3 CB38             8      SRL B   ;BC=BC/2
000CC5 4CC5 CB19             8      RR  C   ;
000CC7 4CC7 18F7            12      JR  L_RWX
       4CC9                     E_RWX:
000CC9 4CC9 3A49F1          13      LD  A,(_DIR_BANK)
                                #if exists USE_NORMAL_32K_ROM
000CCC 4CCC 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000CCF 4CCF FD2A47F1        20      LD  IY,(DIRENT1)
000CD3 4CD3 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000CD6 4CD6 FD561B          19      LD  D,(IY+01BH)
000CD9 4CD9 CDA650          17      CALL    GET_DISK_BANK_FDRV
       4CDC                     RWX1:
000CDC 4CDC ED532AF1        20      LD  (_CLPS),DE
000CE0 4CE0 7A               4      LD  A,D
000CE1 4CE1 B3               4      OR  E
000CE2 4CE2 37               4      SCF
000CE3 4CE3 C8              11      RET Z
                                
000CE4 4CE4 78               4      LD  A,B
000CE5 4CE5 B1               4      OR  C
000CE6 4CE6 C8              11      RET Z
                                
000CE7 4CE7 CD094D          17      CALL    GNCL
000CEA 4CEA D8              11      RET C
000CEB 4CEB 0B               6      DEC BC
000CEC 4CEC CD7E4D          17      CALL    ENDCL
000CEF 4CEF 38EB            12      JR  C,RWX1
000CF1 4CF1 37               4      SCF
000CF2 4CF2 C9              10      RET
                                
       4CF3                     NCL3:
000CF3 4CF3 CDA650          17      CALL    GET_DISK_BANK_FDRV
000CF6 4CF6 6B               4      LD  L,E
000CF7 4CF7 62               4      LD  H,D
000CF8 4CF8 CB3C             8      SRL H
000CFA 4CFA CB1D             8      RR  L
000CFC 4CFC 1F               4      RRA
000CFD 4CFD 19              11      ADD HL,DE
000CFE 4CFE 010060          10      LD  BC,BANK1_ADR
000D01 4D01 09              11      ADD HL,BC
000D02 4D02 ED4B24F1        20      LD  BC,(SECSZ)
000D06 4D06 09              11      ADD HL,BC
000D07 4D07 17               4      RLA
000D08 4D08 C9              10      RET
                                
       4D09                     GNCL:
000D09 4D09 7A               4      LD  A,D
000D0A 4D0A B3               4      OR  E
000D0B 4D0B 37               4      SCF
000D0C 4D0C C8              11      RET Z
000D0D 4D0D C5              11      PUSH    BC
000D0E 4D0E E5              11      PUSH    HL
000D0F 4D0F CDF34C          17      CALL    NCL3
000D12 4D12 3809            12      JR  C,GNC1
000D14 4D14 5E               7      LD  E,(HL)
000D15 4D15 23               6      INC HL
000D16 4D16 7E               7      LD  A,(HL)
000D17 4D17 E60F             7      AND 00FH
000D19 4D19 57               4      LD  D,A
000D1A 4D1A E1              10      POP HL
000D1B 4D1B C1              10      POP BC
000D1C 4D1C C9              10      RET
       4D1D                     GNC1:
000D1D 4D1D 7E               7      LD  A,(HL)
000D1E 4D1E 23               6      INC HL
000D1F 4D1F 56               7      LD  D,(HL)
000D20 4D20 0604             7      LD  B,4
       4D22                     GNC1L:
000D22 4D22 CB3A             8      SRL D
000D24 4D24 1F               4      RRA
000D25 4D25 10FB            13      DJNZ    GNC1L
                                
000D27 4D27 5F               4      LD  E,A
000D28 4D28 E1              10      POP HL
000D29 4D29 C1              10      POP BC
000D2A 4D2A A7               4      AND A
000D2B 4D2B C9              10      RET
                                
       4D2C                     CLUST:
000D2C 4D2C EB               4      EX  DE,HL
       4D2D                     CLUST_HL:
000D2D 4D2D C5              11      PUSH    BC
000D2E 4D2E 3A23F1          13      LD  A,(CLSZ_H)
000D31 4D31 CDCF50          17      CALL    MUL_AHL
                                
000D34 4D34 CDFF4D          17      CALL    GET_DIR_POS
000D37 4D37 4F               4      LD  C,A
000D38 4D38 0600             7      LD  B,0
000D3A 4D3A 09              11      ADD HL,BC
                                
000D3B 4D3B 3A1260          13      LD  A,(BANK1_ADR+17+1)  ;BPB_RootEntCnt High
000D3E 4D3E 1F               4      RRA
000D3F 4D3F 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000D42 4D42 1F               4      RRA
000D43 4D43 0F               4      RRCA
000D44 4D44 0F               4      RRCA
000D45 4D45 0F               4      RRCA
000D46 4D46 4F               4      LD  C,A
                                
000D47 4D47 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000D4A 4D4A FE02             7      CP  2
000D4C 4D4C 280C            12      JR  Z,CLUST1
000D4E 4D4E CB01             4      RLC C
000D50 4D50 0D               4      DEC C
000D51 4D51 3A0C60          13      LD  A,(BANK1_ADR+11+1)  ;BPB_BytsPerSec High    
000D54 4D54 FE02             7      CP  2
000D56 4D56 2002            12      JR  NZ,CLUST1
000D58 4D58 0D               4      DEC C
000D59 4D59 0D               4      DEC C
       4D5A                     CLUST1:
000D5A 4D5A 0D               4      DEC C
000D5B 4D5B 09              11      ADD HL,BC
                                
                                #if exists USE_NORMAL_32K_ROM
000D5C 4D5C 7D               4      LD  A,L
000D5D 4D5D 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
000D60 4D60 09              11      ADD HL,BC
000D61 4D61 3013            12      JR  NC,CLUST2
000D63 4D63 4D               4      LD  C,L     ;C=読み出し元
000D64 4D64 29              11      ADD HL,HL   ;64KB→32KB
000D65 4D65 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
000D66 4D66 CDA650          17      CALL    GET_DISK_BANK_FDRV
000D69 4D69 84               4      ADD A,H
000D6A 4D6A 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
000D6D 4D6D 3220F1          13      LD  (_BANK),A
000D70 4D70 69               4      LD  L,C     ;C=読み出し元
000D71 4D71 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
000D73 4D73 A5               4      AND L
000D74 4D74 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB
                                    ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
                                    AND L
                                #endif
       4D76                     CLUST2:
000D76 4D76 C660             7      ADD A,high BANK1_ADR
000D78 4D78 67               4      LD  H,A
000D79 4D79 2E00             7      LD  L,0
000D7B 4D7B EB               4      EX  DE,HL
000D7C 4D7C C1              10      POP BC
000D7D 4D7D C9              10      RET
                                
       4D7E                     ENDCL:
000D7E 4D7E 7A               4      LD  A,D ;END CLUSTER
000D7F 4D7F FE0F             7      CP  00FH    ;FAT12の最大値
000D81 4D81 C0              11      RET NZ
000D82 4D82 7B               4      LD  A,E
000D83 4D83 FEF7             7      CP  0F7H
000D85 4D85 C9              10      RET
                                
       4D86                     RB_READ:
000D86 4D86 AF               4      XOR A   ;HLA = HL*128
000D87 4D87 CB3C             8      SRL H
000D89 4D89 CB1D             8      RR  L
000D8B 4D8B 1F               4      RRA
000D8C 4D8C 3226F1          13      LD  (RR_LOW),A
000D8F 4D8F 2227F1          16      LD  (RR_MID),HL
000D92 4D92 218000          10      LD  HL,128
                                
000D95 4D95 CD7349          17      CALL    ROM_READ
000D98 4D98 C9              10      RET
                                
       4D99                     GETSEQ:
000D99 4D99 FD6E20          19      LD  L,(IY+32)
000D9C 4D9C FD660C          19      LD  H,(IY+12)
                                
000D9F 4D9F CB25             8      SLA L
                                
000DA1 4DA1 CB3C             8      SRL H
000DA3 4DA3 CB1D             8      RR  L
000DA5 4DA5 C9              10      RET
                                
       4DA6                     SETSEQ:
000DA6 4DA6 F5              11      PUSH    AF
000DA7 4DA7 3A26F1          13      LD  A,(RR_LOW)
000DAA 4DAA 2A27F1          16      LD  HL,(RR_MID)
                                
000DAD 4DAD CDC44D          17      CALL    SSQ1
                                
000DB0 4DB0 29              11      ADD HL,HL
000DB1 4DB1 CB3D             8      SRL L
000DB3 4DB3 FD7520          19      LD  (IY+32),L
000DB6 4DB6 FD740C          19      LD  (IY+12),H
000DB9 4DB9 F1              10      POP AF
000DBA 4DBA C9              10      RET
                                
       4DBB                     GETSIZE:
000DBB 4DBB FD7E10          19      LD  A,(IY+16)
000DBE 4DBE FD6E11          19      LD  L,(IY+17)
000DC1 4DC1 FD6612          19      LD  H,(IY+18)
       4DC4                     SSQ1:
000DC4 4DC4 87               4      ADD A,A
000DC5 4DC5 ED6A            15      ADC HL,HL
000DC7 4DC7 B7               4      OR  A
000DC8 4DC8 C8              11      RET Z
000DC9 4DC9 23               6      INC HL
000DCA 4DCA C9              10      RET
                                
       4DCB                     SET_FCB:
000DCB 4DCB D5              11      PUSH    DE
000DCC 4DCC FDE1            14      POP IY
000DCE 4DCE FD7E1C          19      LD  A,(IY+28)
000DD1 4DD1 FEFF             7      CP  0FFH
000DD3 4DD3 200C            12      JR  NZ,POPAF_SCF_FF_RET
000DD5 4DD5 E5              11      PUSH    HL
000DD6 4DD6 FD6E1A          19      LD  L,(IY+26)
000DD9 4DD9 FD661B          19      LD  H,(IY+27)
000DDC 4DDC 222AF1          16      LD  (_CLPS),HL
000DDF 4DDF E1              10      POP HL
000DE0 4DE0 C9              10      RET
                                
       4DE1                     POPAF_SCF_FF_RET:
000DE1 4DE1 F1              10      POP AF
000DE2 4DE2 37               4      SCF
000DE3 4DE3 9F               4      SBC A,A
000DE4 4DE4 C9              10      RET
                                
       4DE5                     GET_DIR_DAT:
000DE5 4DE5 2A5EF1          16      LD  HL,(_CDX)
000DE8 4DE8 7C               4      LD  A,H
000DE9 4DE9 B5               4      OR  L
000DEA 4DEA 2031            12      JR  NZ,GET_SUBDIR
000DEC 4DEC CDFF4D          17      CALL    GET_DIR_POS
000DEF 4DEF C660             7      ADD A,high BANK1_ADR
000DF1 4DF1 2E00             7      LD  L,0
000DF3 4DF3 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_NORMAL_32K_ROM
                                #else
                                    CALL    CHECK_DIR_PAGE
                                #endif
000DF4 4DF4 3A21F1          13      LD  A,(_BANK1)
000DF7 4DF7 3249F1          13      LD  (_DIR_BANK),A
                                
000DFA 4DFA 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000DFD 4DFD 4F               4      LD  C,A
000DFE 4DFE C9              10      RET
                                
       4DFF                     GET_DIR_POS:                ;ルートディレクトリ
000DFF 4DFF CDA650          17      CALL    GET_DISK_BANK_FDRV
000E02 4E02 3221F1          13      LD  (_BANK1),A
000E05 4E05 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000E08 4E08 47               4      LD  B,A
000E09 4E09 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000E0C 4E0C 4F               4      LD  C,A
000E0D 4E0D 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4E10                     GET_DIR_POS1:
000E10 4E10 81               4      ADD A,C
000E11 4E11 10FD            13      DJNZ    GET_DIR_POS1
                                
000E13 4E13 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec 
       4E17                     L_MDP:
000E17 4E17 CB18             8      RR  B   ;->CF
000E19 4E19 D8              11      RET C
000E1A 4E1A 87               4      ADD A,A
000E1B 4E1B 18FA            12      JR  L_MDP
                                
       4E1D                     GET_SUBDIR:             ;サブディレクトリ
000E1D 4E1D CD2D4D          17      CALL    CLUST_HL
000E20 4E20 EB               4      EX  DE,HL
000E21 4E21 3A20F1          13      LD  A,(_BANK)
000E24 4E24 3249F1          13      LD  (_DIR_BANK),A
000E27 4E27 3A23F1          13      LD  A,(CLSZ_H)
000E2A 4E2A 87               4      ADD A,A     ;*2
000E2B 4E2B 87               4      ADD A,A     ;*4
000E2C 4E2C 87               4      ADD A,A     ;*8
000E2D 4E2D 4F               4      LD  C,A
000E2E 4E2E C9              10      RET
                                
       4E2F                     STATEMENT:
000E2F 4E2F 11BD4E          10      LD  DE,STR_CHDIR
000E32 4E32 CDA34E          17      CALL    CPPROCNM
000E35 4E35 280A            12      JR  Z,_CHDIR
000E37 4E37 11C34E          10      LD  DE,STR_RAMDISK
000E3A 4E3A CDA34E          17      CALL    CPPROCNM
000E3D 4E3D 2814            12      JR  Z,_RAMDISK
000E3F 4E3F 37               4      SCF
000E40 4E40 C9              10      RET
       4E41                     _CHDIR:
000E41 4E41 7E               7      LD  A,(HL)
000E42 4E42 FE28             7      CP  '('
000E44 4E44 37               4      SCF
000E45 4E45 C0              11      RET NZ
000E46 4E46 CD2247          17      CALL    INIT_PARAM
000E49 4E49 CD144A          17      CALL    FILE_B
000E4C 4E4C CD6B4E          17      CALL    ROM_CD
000E4F 4E4F DAE545          10      JP  C,ERROR_FILE_NOT_FOUND
000E52 4E52 C9              10      RET
                                
       4E53                     _RAMDISK:
000E53 4E53 7E               7      LD  A,(HL)
000E54 4E54 FE28             7      CP  '('
000E56 4E56 37               4      SCF
000E57 4E57 C0              11      RET NZ
000E58 4E58 23               6      INC HL
000E59 4E59 DD212F54        14      LD  IX,FRMQNT
000E5D 4E5D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000E61 4E61 CD1C00          17      CALL    _CALSLT
                                ;   LD  A,(HOKVLD)  ;bit0: 拡張 BIOSの存在
                                ;   CPL
                                ;   AND 1
000E64 4E64 7A               4      LD  A,D
000E65 4E65 B3               4      OR  E
000E66 4E66 C2DF45          10      JP  NZ,ERROR_INTERNAL_ERROR
                                ;   PUSH    HL      ;EXTBIOもDISK BIOSで初期化してそう
                                ;   LD  A,0     ;すでにA=0になっている
                                ;   LD  DE,0401H    ;D=マッパサポートルチン(4) E=機能番号(1)
                                ;   CALL    EXTBIO
                                ;   POP HL
                                ;   OR  A
                                ;   JP  Z,ERROR_INTERNAL_ERROR
000E69 4E69 23               6      INC HL
000E6A 4E6A C9              10      RET
                                
       4E6B                     ROM_CD:
000E6B 4E6B 3A51F1          13      LD  A,(FNAME)
000E6E 4E6E FE20             7      CP  020H
000E70 4E70 2822            12      JR  Z,CD1
000E72 4E72 CD934B          17      CALL    ROM_OPEN
000E75 4E75 D8              11      RET C
000E76 4E76 FD2A47F1        20      LD  IY,(DIRENT1)
000E7A 4E7A FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
000E7E 4E7E CAE545          10      JP  Z,ERROR_FILE_NOT_FOUND
000E81 4E81 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000E84 4E84 FD661B          19      LD  H,(IY+01BH)
       4E87                     CD2:
000E87 4E87 225CF1          16      LD  (_CD),HL
000E8A 4E8A 2A4EF1          16      LD  HL,(PARAM1)
       4E8D                     CD_SKIP:
000E8D 4E8D 7E               7      LD  A,(HL)
000E8E 4E8E 23               6      INC HL
000E8F 4E8F FE21             7      CP  021H
000E91 4E91 38FA            12      JR  C,CD_SKIP
000E93 4E93 C9              10      RET
       4E94                     CD1:
000E94 4E94 2A5EF1          16      LD  HL,(_CDX)
000E97 4E97 18EE            12      JR  CD2
                                
       4E99                     DEVICE1:
000E99 4E99 11CB4E          10      LD  DE,STR_A
000E9C 4E9C CDA34E          17      CALL    CPPROCNM
000E9F 4E9F 37               4      SCF
000EA0 4EA0 C0              11      RET NZ
000EA1 4EA1 AF               4      XOR A
000EA2 4EA2 C9              10      RET
                                
       4EA3                     CPPROCNM:
000EA3 4EA3 E5              11      PUSH    HL
000EA4 4EA4 2189FD          10      LD  HL,PROCNM
       4EA7                     CPPROCNM1:
000EA7 4EA7 1A               7      LD  A,(DE)
000EA8 4EA8 13               6      INC DE
000EA9 4EA9 BE               7      CP  (HL)
000EAA 4EAA 23               6      INC HL
000EAB 4EAB 2003            12      JR  NZ,CPPROCNM2
000EAD 4EAD B7               4      OR  A
000EAE 4EAE 20F7            12      JR  NZ,CPPROCNM1
       4EB0                     CPPROCNM2:
000EB0 4EB0 E1              10      POP HL
000EB1 4EB1 C9              10      RET
                                
       4EB2                     WILDCARD:
000EB2 4EB2 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       4EBD                     STR_CHDIR:
000EBD 4EBD 434844495200            DB  "CHDIR",0
       4EC3                     STR_RAMDISK:
000EC3 4EC3 52414D4449534B00        DB  "RAMDISK",0
       4ECB                     STR_A:
000ECB 4ECB 4100                    DB  "A",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4ECD                     ERROR_WRITE_PROTECTED:
000ECD 4ECD 3E00             7      LD  A,0     ;Write protected
000ECF 4ECF C9              10      RET
       4ED0                     DISKIO:
000ED0 4ED0 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000ED2 4ED2 48               4      LD  C,B
000ED3 4ED3 CDB050          17      CALL    GET_DISK_BANK
       4ED6                     SETMAP1:        
000ED6 4ED6 E5              11      PUSH    HL
       4ED7                     DISKIO1:
000ED7 4ED7 C5              11      PUSH    BC      ;B=残りのセクタ数
000ED8 4ED8 D5              11      PUSH    DE      ;DE=セクタ番号
000ED9 4ED9 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
000EDA 4EDA EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
000EDB 4EDB F5              11      PUSH    AF
000EDC 4EDC 3A25F1          13      LD  A,(SECSZ_H)
000EDF 4EDF CDCF50          17      CALL    MUL_AHL
000EE2 4EE2 F1              10      POP AF
                                #if exists USE_NORMAL_32K_ROM
000EE3 4EE3 7D               4      LD  A,L
000EE4 4EE4 C5              11      PUSH    BC
000EE5 4EE5 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
000EE8 4EE8 09              11      ADD HL,BC
000EE9 4EE9 C1              10      POP BC
000EEA 4EEA 3013            12      JR  NC,DISKIO2
000EEC 4EEC 4D               4      LD  C,L     ;C=読み出し元
000EED 4EED 29              11      ADD HL,HL   ;64KB→32KB
000EEE 4EEE 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
000EEF 4EEF CDA650          17      CALL    GET_DISK_BANK_FDRV
000EF2 4EF2 84               4      ADD A,H
000EF3 4EF3 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
000EF6 4EF6 3220F1          13      LD  (_BANK),A
000EF9 4EF9 69               4      LD  L,C     ;C=読み出し元
000EFA 4EFA 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
000EFC 4EFC A5               4      AND L
000EFD 4EFD C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL       ;64KB→32KB
                                    ADD HL,HL       ;32KB→16KB
                                    ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  A,C     ;C=読み出し元
                                    AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       4EFF                     DISKIO2:
000EFF 4EFF C660             7      ADD A,high BANK1_ADR
000F01 4F01 67               4      LD  H,A
000F02 4F02 ED4B24F1        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
000F06 4F06 69               4      LD  L,C     ;C=0
000F07 4F07 CDFE43          17      CALL    ROM_LDIR
000F0A 4F0A EB               4      EX  DE,HL
000F0B 4F0B F1              10      POP AF
000F0C 4F0C D1              10      POP DE
000F0D 4F0D 13               6      INC DE
000F0E 4F0E C1              10      POP BC
000F0F 4F0F 10C6            13      DJNZ    DISKIO1
000F11 4F11 41               4      LD  B,C
                                
000F12 4F12 E1              10      POP HL
000F13 4F13 AF               4      XOR A
                                
000F14 4F14 FB               4      EI
000F15 4F15 C9              10      RET
                                
       4F16                     DSKCHG:
000F16 4F16 CD4F4F          17      CALL    IS_BPB
000F19 4F19 3824            12      JR  C,NOTREADY
000F1B 4F1B 3A23FB          13      LD  A,(DRVTBL+2)
000F1E 4F1E B7               4      OR  A
000F1F 4F1F 201A            12      JR  NZ,DSKCHG1
000F21 4F21 3A21FB          13      LD  A,(DRVTBL)
000F24 4F24 FE02             7      CP  2
000F26 4F26 2013            12      JR  NZ,DSKCHG1
000F28 4F28 CD4F4F          17      CALL    IS_BPB
000F2B 4F2B 300E            12      JR  NC,DSKCHG1
000F2D 4F2D 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000F2F 4F2F 3221FB          13      LD  (DRVTBL),A
000F32 4F32 3223FB          13      LD  (DRVTBL+2),A
000F35 4F35 3A48F3          13      LD  A,(MASTERS)
000F38 4F38 3224FB          13      LD  (DRVTBL+3),A
       4F3B                     DSKCHG1:
000F3B 4F3B AF               4      XOR A
000F3C 4F3C 0601             7      LD  B,1
000F3E 4F3E C9              10      RET
       4F3F                     NOTREADY:
000F3F 4F3F 3E02             7      LD  A,2
000F41 4F41 37               4      SCF
000F42 4F42 C9              10      RET
                                
       4F43                     NO_BPB:
000F43 4F43 E1              10      POP HL
000F44 4F44 23               6      INC HL
000F45 4F45 11D550          10      LD  DE,DPB2DD
000F48 4F48 011200          10      LD  BC,DPB2DD_E-DPB2DD
000F4B 4F4B EDB0                    LDIR
000F4D 4F4D AF               4      XOR A
000F4E 4F4E C9              10      RET
                                
       4F4F                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000F4F 4F4F CDB050          17      CALL    GET_DISK_BANK
                                
000F52 4F52 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000F55 4F55 FE01             7      CP  1
000F57 4F57 D8              11      RET C
                                
000F58 4F58 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000F5B 4F5B C6FF             7      ADD A,0FFH
000F5D 4F5D D8              11      RET C
                                
000F5E 4F5E 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       4F61                     IS_BPB1:
000F61 4F61 FE01             7      CP  1
000F63 4F63 C8              11      RET Z
000F64 4F64 FE02             7      CP  2
000F66 4F66 C8              11      RET Z
000F67 4F67 FE04             7      CP  4
000F69 4F69 C8              11      RET Z
000F6A 4F6A 37               4      SCF
000F6B 4F6B C9              10      RET
                                
       4F6C                     GETDPB:
000F6C 4F6C E5              11      PUSH    HL
000F6D 4F6D CDB050          17      CALL    GET_DISK_BANK
                                
000F70 4F70 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000F73 4F73 B7               4      OR  A
000F74 4F74 28CD            12      JR  Z,NO_BPB
000F76 4F76 DDE1            14      POP IX
000F78 4F78 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000F7B 4F7B 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000F7E 4F7E DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000F81 4F81 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000F84 4F84 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000F87 4F87 87               4      ADD A,A
000F88 4F88 87               4      ADD A,A
000F89 4F89 87               4      ADD A,A
000F8A 4F8A 3D               4      DEC A
000F8B 4F8B DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000F8E 4F8E 06FF             7      LD  B,-1
000F90 4F90 A7               4      AND A           ;無限ループ阻止
       4F91                     GETDPB1:
000F91 4F91 04               4      INC B
000F92 4F92 1F               4      RRA
000F93 4F93 38FC            12      JR  C,GETDPB1
000F95 4F95 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000F98 4F98 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000F9B 4F9B 3D               4      DEC A
000F9C 4F9C DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000F9F 4F9F A7               4      AND A           ;無限ループ阻止
000FA0 4FA0 06FF             7      LD  B,-1
       4FA2                     GETDPB2:
000FA2 4FA2 04               4      INC B
000FA3 4FA3 1F               4      RRA
000FA4 4FA4 38FC            12      JR  C,GETDPB2
000FA6 4FA6 04               4      INC B
000FA7 4FA7 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000FAA 4FAA 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
000FAD 4FAD DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
000FB0 4FB0 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
000FB3 4FB3 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
000FB6 4FB6 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000FB9 4FB9 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
000FBC 4FBC DD770B          19      LD  (IX+11),A       ;MAXENT
                                
000FBF 4FBF ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
000FC3 4FC3 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
000FC6 4FC6 DD460A          19      LD  B,(IX+10)       ;FATCNT
000FC9 4FC9 210000          10      LD  HL,0
       4FCC                     GETDPB3:
000FCC 4FCC 19              11      ADD HL,DE
000FCD 4FCD 10FD            13      DJNZ    GETDPB3
       4FCF                     GETDPB4:
000FCF 4FCF DD5E08          19      LD  E,(IX+8)        ;FIRFAT
000FD2 4FD2 DD5609          19      LD  D,(IX+9)        ;FIRFAT
000FD5 4FD5 19              11      ADD HL,DE
000FD6 4FD6 DD7511          19      LD  (IX+17),L       ;FIRDIR
000FD9 4FD9 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000FDC 4FDC DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000FDF 4FDF 87               4      ADD A,A
000FE0 4FE0 87               4      ADD A,A
000FE1 4FE1 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4FE4                     GETDPB5:
000FE4 4FE4 CB3B             8      SRL E
000FE6 4FE6 1F               4      RRA
000FE7 4FE7 30FB            12      JR  NC,GETDPB5
000FE9 4FE9 1600             7      LD  D,0
000FEB 4FEB 19              11      ADD HL,DE
000FEC 4FEC DD750C          19      LD  (IX+12),L       ;FIRREC
000FEF 4FEF DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000FF2 4FF2 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
000FF5 4FF5 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
000FF8 4FF8 DD560D          19      LD  D,(IX+13)       ;FIRREC
000FFB 4FFB A7               4      AND A
000FFC 4FFC ED52            15      SBC HL,DE
                                
000FFE 4FFE DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
001001 5001 3C               4      INC A
001002 5002 37               4      SCF             ;無限ループ阻止
       5003                     GETDPB6:
001003 5003 1F               4      RRA
001004 5004 3806            12      JR  C,GETDPB7
001006 5006 CB3C             8      SRL H
001008 5008 CB1D             8      RR  L
00100A 500A 18F7            12      JR  GETDPB6
       500C                     GETDPB7:
00100C 500C 23               6      INC HL
00100D 500D DD750E          19      LD  (IX+14),L       ;MAXCLUS
001010 5010 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       5013                     GETDPBD1:
001013 5013 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001016 5016 E6FC             7      AND 0FCH
001018 5018 C8              11      RET Z
                                
001019 5019 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
00101D 501D 37               4      SCF
00101E 501E DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
001022 5022 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
001025 5025 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
001029 5029 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
00102D 502D DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
001031 5031 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
001035 5035 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
001039 5039 DDCB1126        23      SLA (IX+17)         ;FIRDIR
00103D 503D DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
001041 5041 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
001044 5044 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
001047 5047 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
00104A 504A 87               4      ADD A,A
00104B 504B 87               4      ADD A,A
00104C 504C DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       504F                     GETDPBD5:
00104F 504F CB3B             8      SRL E
001051 5051 1F               4      RRA
001052 5052 30FB            12      JR  NC,GETDPBD5
001054 5054 1600             7      LD  D,0
001056 5056 19              11      ADD HL,DE
001057 5057 DD750C          19      LD  (IX+12),L       ;FIRREC
00105A 505A DD740D          19      LD  (IX+13),H       ;FIRREC
                                
00105D 505D 18B4            12      JR  GETDPBD1
                                
       505F                     CHOICE:
00105F 505F 210000          10      LD  HL,0
001062 5062 C9              10      RET
                                
       5063                     DSKFMT:
001063 5063 AF               4      XOR A
001064 5064 37               4      SCF
       5065                     DSKSTP:
001065 5065 C9              10      RET
                                
       5066                     BASENT:
001066 5066 3A40F3          13      LD  A,(REBOOT)
001069 5069 B7               4      OR  A
00106A 506A 202B            12      JR  NZ,REBOOT1
00106C 506C 21E750          10      LD  HL,AUTOEXEC
00106F 506F 1150F1          10      LD  DE,FDRV
001072 5072 010C00          10      LD  BC,1+8+3
001075 5075 EDB0                    LDIR
001077 5077 CD934B          17      CALL    ROM_OPEN
00107A 507A 381B            12      JR  C,REBOOT1
00107C 507C CD9A45          17      CALL    ROM_LOAD1
00107F 507F 21F350          10      LD  HL,CMD_RUN
001082 5082 111FF4          10      LD  DE,KBUF
001085 5085 D5              11      PUSH    DE
001086 5086 010300          10      LD  BC,3
001089 5089 EDB0                    LDIR
00108B 508B E1              10      POP HL
00108C 508C FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
001090 5090 DD210146        14      LD  IX,NEWSTT
001094 5094 CD1C00          17      CALL    _CALSLT
       5097                     REBOOT1:
001097 5097 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00109B 509B DD219B40        14      LD  IX,READYR
00109F 509F C31C00          10      JP  _CALSLT
                                
       50A2                     GETSLT:
0010A2 50A2 3A22FB          13      LD  A,(DRVTBL+1)
0010A5 50A5 C9              10      RET
                                
       50A6                     GET_DISK_BANK_FDRV:
0010A6 50A6 3A50F1          13      LD  A,(FDRV)
0010A9 50A9 D601             7      SUB 1
0010AB 50AB 3003            12      JR  NC,GET_DISK_BANK
0010AD 50AD 3A46F1          13      LD  A,(_DVSW)
       50B0                     GET_DISK_BANK:
0010B0 50B0 B7               4      OR  A       ;A=DRIVE
0010B1 50B1 3E01             7      LD  A,DISK_BANK
0010B3 50B3 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
0010B5 50B5 3A45F1          13      LD  A,(B_DRIVE)
                                #endif
       50B8                     SET_DISK_BANK:
                                #if exists USE_NORMAL_32K_ROM
0010B8 50B8 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0010BB 50BB F5              11      PUSH    AF
0010BC 50BC E5              11      PUSH    HL
0010BD 50BD 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
0010C0 50C0 2224F1          16      LD  (SECSZ),HL
0010C3 50C3 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0010C6 50C6 CDCF50          17      CALL    MUL_AHL
0010C9 50C9 2222F1          16      LD  (CLSZ),HL
0010CC 50CC E1              10      POP HL
0010CD 50CD F1              10      POP AF
0010CE 50CE C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       50CF                     MUL_AHL:
0010CF 50CF 37               4      SCF     ;無限ループ回避
       50D0                     MUL_AHL1:
0010D0 50D0 1F               4      RRA     ;->CF
0010D1 50D1 D8              11      RET C
0010D2 50D2 29              11      ADD HL,HL
0010D3 50D3 18FB            12      JR  MUL_AHL1
                                
       50D5                     DPB2DD:
0010D5 50D5 F9                      DB  0F9H    ;MEDIA
0010D6 50D6 0002                    DW  00200H  ;SECSIZ
0010D8 50D8 0F                      DB  00FH    ;DIRMSK
0010D9 50D9 04                      DB  004H    ;DIRSHFT
0010DA 50DA 01                      DB  001H    ;CLUSMSK
0010DB 50DB 02                      DB  002H    ;CLUSSHFT
0010DC 50DC 0100                    DW  00001H  ;FIRFAT
0010DE 50DE 02                      DB  002H    ;FATCNT
0010DF 50DF 70                      DB  070H    ;MAXENT
0010E0 50E0 0E00                    DW  0000EH  ;FIRREC
0010E2 50E2 CA02                    DW  002CAH  ;MAXCLUS
0010E4 50E4 03                      DB  003H    ;FATSIZ
0010E5 50E5 0700                    DW  0007H   ;FIRDIR
       50E7                     DPB2DD_E:
                                
       50E7                     AUTOEXEC:
0010E7 50E7 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       50F3                     CMD_RUN:
0010F3 50F3 3A8A00                  DB  03AH,08AH,0
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       50F6                     POP_HL_ERROR:
0010F6 50F6 E1              10      POP     HL
       50F7                     _ERROR:
0010F7 50F7 0600             7      LD  B,0
0010F9 50F9 A7               4      AND A
0010FA 50FA C9              10      RET
                                
       50FB                     ROM_BDOS:
0010FB 50FB E5              11      PUSH    HL
0010FC 50FC 79               4      LD  A,C
0010FD 50FD 87               4      ADD A,A
0010FE 50FE 38F7            12      JR  C,_ERROR
001100 5100 6F               4      LD  L,A
001101 5101 265F             7      LD  H,high STABLE
001103 5103 7E               7      LD  A,(HL)
001104 5104 2C               4      INC L
001105 5105 66               7      LD  H,(HL)
001106 5106 6F               4      LD  L,A
001107 5107 E3              19      EX  (SP),HL
001108 5108 79               4      LD  A,C
001109 5109 C9              10      RET
                                
       510A                     _PRINT:
       510A                     PRINT:
00110A 510A 7B               4      LD  A,E
00110B 510B 1803            12      JR  MSG_A
                                
       510D                     _SYS01:     ;(BDOS)コンソール入力
00110D 510D CD8451          17      CALL    _SYS07
       5110                     MSG_A:
001110 5110 FE03             7      CP  3
001112 5112 2814            12      JR  Z,MSG_BR
       5114                     MSGA1:
001114 5114 F5              11      PUSH    AF
001115 5115 C5              11      PUSH    BC
001116 5116 D5              11      PUSH    DE
001117 5117 E5              11      PUSH    HL
001118 5118 DDE5            15      PUSH    IX
00111A 511A DD21A200        14      LD  IX,CHPUT
00111E 511E CDFA42          17      CALL    CALSLT_R
001121 5121 DDE1            14      POP IX
001123 5123 E1              10      POP HL
001124 5124 D1              10      POP DE
001125 5125 C1              10      POP BC
       5126                     MSGA2:
001126 5126 F1              10      POP AF
001127 5127 C9              10      RET
       5128                     MSG_BR:
001128 5128 F5              11      PUSH    AF
001129 5129 3ADDF3          13      LD  A,(CSRX)
00112C 512C FE02             7      CP  2
00112E 512E 38F6            12      JR  C,MSGA2
001130 5130 F1              10      POP AF
       5131                     MSG_CR:
001131 5131 F5              11      PUSH    AF
001132 5132 3E0D             7      LD  A,00DH
001134 5134 CD1451          17      CALL    MSGA1
001137 5137 3E0A             7      LD  A,00AH
001139 5139 CD1451          17      CALL    MSGA1
00113C 513C F1              10      POP AF
00113D 513D C9              10      RET
                                
       513E                     _SYS02:     ;(BDOS)コンソール出力
00113E 513E CD5951          17      CALL    BREAK
001141 5141 1805            12      JR  PRINTX
                                
       5143                     _SYS06:     ;(BDOS)コンソール直接入出力
001143 5143 7B               4      LD  A,E
001144 5144 3C               4      INC A
001145 5145 CA9851          10      JP  Z,_INKEY
       5148                     PRINTX:
001148 5148 C30A51          10      JP  _PRINT
                                
       514B                     _SYS08:     ;(BDOS)エコーなしコンソール入力
00114B 514B CD8451          17      CALL    _SYS07
00114E 514E FE03             7      CP  3
001150 5150 CC5951          17      CALL    Z,_BREAK
001153 5153 FE13             7      CP  013H        ;CTRL+S
001155 5155 C0              11      RET NZ
       5156                     PAUSE:
001156 5156 CD7051          17      CALL    KEYBC
                                
       5159                     _BREAK:
       5159                     BREAK:
001159 5159 F5              11      PUSH    AF
00115A 515A C5              11      PUSH    BC
00115B 515B D5              11      PUSH    DE
00115C 515C E5              11      PUSH    HL
00115D 515D DDE5            15      PUSH    IX
00115F 515F DD21B700        14      LD  IX,BREAKX
001163 5163 CDFA42          17      CALL    CALSLT_R
001166 5166 DDE1            14      POP IX
001168 5168 E1              10      POP HL
001169 5169 D1              10      POP DE
00116A 516A C1              10      POP BC
00116B 516B DC5951          17      CALL    C,_BREAK
00116E 516E F1              10      POP AF
00116F 516F C9              10      RET
       5170                     KEYBC:
001170 5170 F5              11      PUSH    AF
001171 5171 C5              11      PUSH    BC
001172 5172 D5              11      PUSH    DE
001173 5173 E5              11      PUSH    HL
001174 5174 DDE5            15      PUSH    IX
001176 5176 DD215601        14      LD  IX,KILBUF
00117A 517A CDFA42          17      CALL    CALSLT_R
00117D 517D DDE1            14      POP IX
00117F 517F E1              10      POP HL
001180 5180 D1              10      POP DE
001181 5181 C1              10      POP BC
001182 5182 F1              10      POP AF
001183 5183 C9              10      RET
                                
       5184                     _SYS07:
       5184                     FLGET:
001184 5184 C5              11      PUSH    BC
001185 5185 D5              11      PUSH    DE
001186 5186 E5              11      PUSH    HL
001187 5187 DDE5            15      PUSH    IX
001189 5189 DD219F00        14      LD  IX,CHGET
00118D 518D CDFA42          17      CALL    CALSLT_R
001190 5190 DDE1            14      POP IX
001192 5192 E1              10      POP HL
001193 5193 D1              10      POP DE
001194 5194 C1              10      POP BC
001195 5195 FE03             7      CP  3
001197 5197 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       5198                     _INKEY:
       5198                     INKEY:
001198 5198 CD3252          17      CALL    CPM_CONST
00119B 519B C8              11      RET Z
00119C 519C 18E6            12      JR  FLGET
                                
       519E                     _SYS0A:     ;(BDOS)文字列入力
00119E 519E C5              11      PUSH    BC
00119F 519F E5              11      PUSH    HL
0011A0 51A0 D5              11      PUSH    DE
0011A1 51A1 CDCA51          17      CALL    GETL
0011A4 51A4 111FF4          10      LD  DE,KBUF
0011A7 51A7 E1              10      POP HL
0011A8 51A8 E5              11      PUSH    HL
0011A9 51A9 0E00             7      LD  C,0
0011AB 51AB 3004            12      JR  NC,SAX0
0011AD 51AD 23               6      INC HL
0011AE 51AE 23               6      INC HL
0011AF 51AF 1808            12      JR  SAX4
       51B1                     SAX0:
0011B1 51B1 46               7      LD  B,(HL)
0011B2 51B2 23               6      INC HL
       51B3                     SAX1:
0011B3 51B3 23               6      INC HL
0011B4 51B4 1A               7      LD  A,(DE)
0011B5 51B5 13               6      INC DE
0011B6 51B6 B7               4      OR  A
0011B7 51B7 2004            12      JR  NZ,SAX2
       51B9                     SAX4:
0011B9 51B9 360D            10      LD  (HL),00DH
0011BB 51BB 1804            12      JR  SAX3
       51BD                     SAX2:
0011BD 51BD 77               7      LD  (HL),A
0011BE 51BE 0C               4      INC C
0011BF 51BF 10F2            13      DJNZ    SAX1
       51C1                     SAX3:
0011C1 51C1 D1              10      POP DE
0011C2 51C2 79               4      LD  A,C
0011C3 51C3 13               6      INC DE
0011C4 51C4 12               7      LD  (DE),A
0011C5 51C5 1B               6      DEC DE
0011C6 51C6 E1              10      POP HL
0011C7 51C7 C1              10      POP BC
0011C8 51C8 A7               4      AND A
0011C9 51C9 C9              10      RET
       51CA                     GETL:
0011CA 51CA DDE5            15      PUSH    IX
0011CC 51CC FDE5            15      PUSH    IY
                                
0011CE 51CE 2ADCF3          16      LD  HL,(CSRY)
0011D1 51D1 22CAFB          16      LD  (FSTPOS),HL
       51D4                     GETL1:
0011D4 51D4 CD4B51          17      CALL    _SYS08
0011D7 51D7 FE09             7      CP  9
0011D9 51D9 2008            12      JR  NZ,GETL1V
0011DB 51DB 211FF4          10      LD  HL,KBUF
0011DE 51DE CD8443          17      CALL    MSX
0011E1 51E1 18F1            12      JR  GETL1
       51E3                     GETL1V:
0011E3 51E3 5F               4      LD  E,A
0011E4 51E4 FE08             7      CP  8
0011E6 51E6 CC8052          17      CALL    Z,CTRL02
0011E9 51E9 FE20             7      CP  020H
0011EB 51EB D4AC52          17      CALL    NC,INSERT
0011EE 51EE CD1451          17      CALL    MSGA1
                                
0011F1 51F1 7B               4      LD  A,E
0011F2 51F2 FE0D             7      CP  00DH
0011F4 51F4 20DE            12      JR  NZ,GETL1
                                
0011F6 51F6 111FF4          10      LD  DE,KBUF
0011F9 51F9 3AB0F3          13      LD  A,(LINLEN)
0011FC 51FC 47               4      LD  B,A
0011FD 51FD CD8E54          17      CALL    ZERO_MEMORY_DE
                                
001200 5200 2ACAFB          16      LD  HL,(FSTPOS)
001203 5203 3ADCF3          13      LD  A,(CSRY)
001206 5206 6F               4      LD  L,A
001207 5207 E5              11      PUSH    HL
001208 5208 CDDD52          17      CALL    LOC0
00120B 520B 4D               4      LD  C,L
00120C 520C 44               4      LD  B,H
00120D 520D E1              10      POP HL
00120E 520E 3AB0F3          13      LD  A,(LINLEN)
001211 5211 94               4      SUB H
001212 5212 3D               4      DEC A
001213 5213 5F               4      LD  E,A
001214 5214 211FF4          10      LD  HL,KBUF
       5217                     GETL2:
001217 5217 CD7052          17      CALL    _SCRN
00121A 521A 03               6      INC BC
00121B 521B 77               7      LD  (HL),A
00121C 521C 23               6      INC HL
00121D 521D 1D               4      DEC E
00121E 521E 20F7            12      JR  NZ,GETL2
001220 5220 CD3151          17      CALL    MSG_CR
                                
001223 5223 FDE1            14      POP IY
001225 5225 DDE1            14      POP IX
       5227                     GETL3:
001227 5227 2B               6      DEC HL
001228 5228 7E               7      LD  A,(HL)
001229 5229 FE21             7      CP  021H
00122B 522B D0              11      RET NC
00122C 522C 3600            10      LD  (HL),0
00122E 522E 15               4      DEC D
00122F 522F 20F6            12      JR  NZ,GETL3
001231 5231 C9              10      RET
                                
       5232                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       5232                     CONSTX:
       5232                     CPM_CONST:
001232 5232 C5              11      PUSH    BC
001233 5233 D5              11      PUSH    DE
001234 5234 E5              11      PUSH    HL
001235 5235 DDE5            15      PUSH    IX
001237 5237 DD219C00        14      LD  IX,CHSNS
00123B 523B CDFA42          17      CALL    CALSLT_R
00123E 523E DDE1            14      POP IX
001240 5240 E1              10      POP HL
001241 5241 D1              10      POP DE
001242 5242 C1              10      POP BC
001243 5243 C9              10      RET
                                
       5244                     _SYS2A:     ;(BDOS)日付の獲得
001244 5244 AF               4      XOR A
001245 5245 57               4      LD  D,A
001246 5246 5F               4      LD  E,A
001247 5247 67               4      LD  H,A
001248 5248 6F               4      LD  L,A
001249 5249 C9              10      RET
                                
       524A                     _SYS2C:     ;(BDOS)時刻の獲得
00124A 524A AF               4      XOR A
00124B 524B 57               4      LD  D,A
00124C 524C 5F               4      LD  E,A
00124D 524D 67               4      LD  H,A
00124E 524E 6F               4      LD  L,A
00124F 524F C9              10      RET
                                
       5250                     POS:
001250 5250 F5              11      PUSH    AF
001251 5251 2ADCF3          16      LD  HL,(CSRY)
001254 5254 7D               4      LD  A,L
001255 5255 6C               4      LD  L,H
001256 5256 67               4      LD  H,A
001257 5257 2C               4      INC L
001258 5258 24               4      INC H
001259 5259 F1              10      POP AF
00125A 525A C9              10      RET
                                
       525B                     LOC:
00125B 525B F5              11      PUSH    AF
00125C 525C E5              11      PUSH    HL
00125D 525D 7D               4      LD  A,L
00125E 525E 6C               4      LD  L,H
00125F 525F 67               4      LD  H,A
001260 5260 2D               4      DEC L
001261 5261 25               4      DEC H
001262 5262 DDE5            15      PUSH    IX
001264 5264 DD21C600        14      LD  IX,POSIT
001268 5268 CDFA42          17      CALL    CALSLT_R
00126B 526B DDE1            14      POP IX
00126D 526D E1              10      POP HL
00126E 526E F1              10      POP AF
00126F 526F C9              10      RET
                                
       5270                     _SCRN:
       5270                     SCRN:
001270 5270 E5              11      PUSH    HL
001271 5271 DDE5            15      PUSH    IX
                                
001273 5273 69               4      LD  L,C
001274 5274 60               4      LD  H,B
001275 5275 DD214A00        14      LD  IX,RDVRM
001279 5279 CDFA42          17      CALL    CALSLT_R
                                
00127C 527C DDE1            14      POP IX
00127E 527E E1              10      POP HL
00127F 527F C9              10      RET
                                
       5280                     CTRL02:
001280 5280 F5              11      PUSH    AF
001281 5281 D5              11      PUSH    DE
001282 5282 2ADCF3          16      LD  HL,(CSRY)
001285 5285 3AB0F3          13      LD  A,(LINLEN)
001288 5288 4F               4      LD  C,A
001289 5289 94               4      SUB H   ;CSRX
00128A 528A C602             7      ADD A,2
00128C 528C 47               4      LD  B,A ;カーソルより右の文字数
00128D 528D 61               4      LD  H,C ;LINLEN
00128E 528E C5              11      PUSH    BC
00128F 528F CDDD52          17      CALL    LOC0
001292 5292 C1              10      POP BC
                                
001293 5293 1620             7      LD  D,020H
       5295                     C8X1:
001295 5295 DD214A00        14      LD  IX,RDVRM
001299 5299 CDFA42          17      CALL    CALSLT_R
00129C 529C 4F               4      LD  C,A
00129D 529D 7A               4      LD  A,D
00129E 529E DD214D00        14      LD  IX,WRTVRM
0012A2 52A2 CDFA42          17      CALL    CALSLT_R
0012A5 52A5 2B               6      DEC HL
0012A6 52A6 51               4      LD  D,C
0012A7 52A7 10EC            13      DJNZ    C8X1
0012A9 52A9 D1              10      POP DE
0012AA 52AA F1              10      POP AF
0012AB 52AB C9              10      RET
                                
       52AC                     INSERT:
0012AC 52AC F5              11      PUSH    AF
0012AD 52AD D5              11      PUSH    DE
0012AE 52AE 2ADCF3          16      LD  HL,(CSRY)
0012B1 52B1 3AB0F3          13      LD  A,(LINLEN)
0012B4 52B4 4F               4      LD  C,A
0012B5 52B5 94               4      SUB H   ;CSRX
0012B6 52B6 3C               4      INC A
0012B7 52B7 47               4      LD  B,A ;カーソルより右の文字数
0012B8 52B8 C5              11      PUSH    BC
0012B9 52B9 CDDD52          17      CALL    LOC0
0012BC 52BC C1              10      POP BC
                                
0012BD 52BD 1620             7      LD  D,020H
       52BF                     INS1:
0012BF 52BF DD214A00        14      LD  IX,RDVRM
0012C3 52C3 CDFA42          17      CALL    CALSLT_R
0012C6 52C6 4F               4      LD  C,A
0012C7 52C7 7A               4      LD  A,D
0012C8 52C8 DD214D00        14      LD  IX,WRTVRM
0012CC 52CC CDFA42          17      CALL    CALSLT_R
0012CF 52CF 23               6      INC HL
0012D0 52D0 51               4      LD  D,C
0012D1 52D1 10EC            13      DJNZ    INS1
0012D3 52D3 D1              10      POP DE
0012D4 52D4 F1              10      POP AF
0012D5 52D5 C9              10      RET
                                
       52D6                     CONOUT1:
0012D6 52D6 59               4      LD  E,C
0012D7 52D7 C30A51          10      JP  _PRINT
                                
       52DA                     GETVRAM:
0012DA 52DA 2ADCF3          16      LD  HL,(CSRY)
       52DD                     LOC0:
0012DD 52DD 2D               4      DEC L
0012DE 52DE 25               4      DEC H
0012DF 52DF 4C               4      LD  C,H ;CSRX-1
0012E0 52E0 5D               4      LD  E,L ;CSRY-1
       52E1                     LOC1:
0012E1 52E1 3AB0F3          13      LD  A,(LINLEN)
0012E4 52E4 67               4      LD  H,A
0012E5 52E5 1600             7      LD  D,0
0012E7 52E7 6A               4      LD  L,D ;0
0012E8 52E8 0608             7      LD  B,8
       52EA                     LOC2:
0012EA 52EA 29              11      ADD HL,HL
0012EB 52EB 3001            12      JR  NC,LOC3
0012ED 52ED 19              11      ADD HL,DE
       52EE                     LOC3:
0012EE 52EE 10FA            13      DJNZ    LOC2
0012F0 52F0 09              11      ADD HL,BC
0012F1 52F1 C9              10      RET
                                
       52F2                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0012F2 52F2 212200          10      LD  HL,00022H
0012F5 52F5 AF               4      XOR A
0012F6 52F6 7D               4      LD  A,L
0012F7 52F7 C9              10      RET
                                
       52F8                     _SYS0D:     ;(BDOS)ディスク・リセット
0012F8 52F8 218000          10      LD  HL,00080H
0012FB 52FB 2230F1          16      LD  (_DTA),HL
0012FE 52FE C9              10      RET
                                
       52FF                     _SYS0E:     ;(BDOS)カレントドライブの設定
0012FF 52FF 7B               4      LD  A,E
001300 5300 FE02             7      CP  2
001302 5302 D0              11      RET NC
001303 5303 3246F1          13      LD  (_DVSW),A
001306 5306 C9              10      RET
                                
       5307                     _SYS0F:     ;(BDOS)ファイルのオープン
001307 5307 D5              11      PUSH    DE
001308 5308 FDE1            14      POP IY
00130A 530A CD7554          17      CALL    INIT_FILE
00130D 530D CD934B          17      CALL    ROM_OPEN
001310 5310 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
001312 5312 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
001316 5316 FDE5            15      PUSH    IY
001318 5318 D1              10      POP DE
001319 5319 13               6      INC DE
00131A 531A 010B00          10      LD  BC,11
00131D 531D EDB0                    LDIR
                                ;               Attribute
00131F 531F 7E               7      LD  A,(HL)
001320 5320 FD770D          19      LD  (IY+13),A
                                ;               TIME
001323 5323 110B00          10      LD  DE,11
001326 5326 19              11      ADD HL,DE
001327 5327 7E               7      LD  A,(HL)
001328 5328 23               6      INC HL
001329 5329 FD7716          19      LD  (IY+22),A
00132C 532C 7E               7      LD  A,(HL)
00132D 532D 23               6      INC HL
00132E 532E FD7717          19      LD  (IY+23),A
                                ;               DATE
001331 5331 7E               7      LD  A,(HL)
001332 5332 23               6      INC HL
001333 5333 FD7714          19      LD  (IY+20),A
001336 5336 7E               7      LD  A,(HL)
001337 5337 23               6      INC HL
001338 5338 FD7715          19      LD  (IY+21),A
                                ;               First cluster
00133B 533B 7E               7      LD  A,(HL)
00133C 533C 23               6      INC HL
00133D 533D FD771A          19      LD  (IY+26),A
001340 5340 7E               7      LD  A,(HL)
001341 5341 23               6      INC HL
001342 5342 FD771B          19      LD  (IY+27),A
                                ;               SIZE
001345 5345 7E               7      LD  A,(HL)
001346 5346 23               6      INC HL
001347 5347 FD7710          19      LD  (IY+16),A
00134A 534A 7E               7      LD  A,(HL)
00134B 534B 23               6      INC HL
00134C 534C FD7711          19      LD  (IY+17),A
00134F 534F 7E               7      LD  A,(HL)
001350 5350 23               6      INC HL
001351 5351 FD7712          19      LD  (IY+18),A
001354 5354 7E               7      LD  A,(HL)
001355 5355 FD7713          19      LD  (IY+19),A
001358 5358 AF               4      XOR A
001359 5359 FD770C          19      LD  (IY+12),A
00135C 535C C9              10      RET
                                
       535D                     _SYS10:     ;(BDOS)ファイルのクローズ
00135D 535D AF               4      XOR A
00135E 535E C9              10      RET
                                
       535F                     S11X1:
00135F 535F FD7119          19      LD  (IY+25),C       ;RootEntCnt
001362 5362 FD750E          19      LD  (IY+14),L
001365 5365 FD740F          19      LD  (IY+15),H
       5368                     SCF_FF_RET:
001368 5368 37               4      SCF
001369 5369 9F               4      SBC A,A
00136A 536A C9              10      RET
                                
       536B                     _SYS11:     ;(BDOS)最初のファイルの検索
00136B 536B ED5333F1        20      LD  (_FCB),DE
00136F 536F D5              11      PUSH    DE
001370 5370 FDE1            14      POP IY
001372 5372 CD7554          17      CALL    INIT_FILE
001375 5375 CDE54D          17      CALL    GET_DIR_DAT
       5378                     S12X1:
001378 5378 CDAF4B          17      CALL    FILESE
00137B 537B 30E2            12      JR  NC,S11X1
00137D 537D 0D               4      DEC C
00137E 537E FD7119          19      LD  (IY+25),C       ;RootEntCnt
001381 5381 FDCB0D66        20      BIT 4,(IY+13)
001385 5385 2809            12      JR  Z,S12X2
001387 5387 E5              11      PUSH    HL
001388 5388 DDE1            14      POP IX
00138A 538A DDCB0E66        20      BIT 4,(IX+1+13)
00138E 538E 28E8            12      JR  Z,S12X1
       5390                     S12X2:
001390 5390 012000          10      LD  BC,32
001393 5393 ED5B30F1        20      LD  DE,(_DTA)
001397 5397 AF               4      XOR A
001398 5398 12               7      LD  (DE),A      ;ドライブ番号
001399 5399 13               6      INC DE
00139A 539A EDB0                    LDIR            ;ディレクトリエントリ
00139C 539C FD750E          19      LD  (IY+14),L
00139F 539F FD740F          19      LD  (IY+15),H
0013A2 53A2 C9              10      RET
                                
       53A3                     _SYS12:
0013A3 53A3 FD2A33F1        20      LD  IY,(_FCB)
0013A7 53A7 FDE5            15      PUSH    IY
0013A9 53A9 D1              10      POP DE
0013AA 53AA CD7554          17      CALL    INIT_FILE
                                
0013AD 53AD FD6E0E          19      LD  L,(IY+14)
0013B0 53B0 FD660F          19      LD  H,(IY+15)
0013B3 53B3 FD4E19          19      LD  C,(IY+25)
0013B6 53B6 18C0            12      JR  S12X1
                                
       53B8                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0013B8 53B8 CDCB4D          17      CALL    SET_FCB
0013BB 53BB CD994D          17      CALL    GETSEQ
0013BE 53BE CD864D          17      CALL    RB_READ
0013C1 53C1 E5              11      PUSH    HL
0013C2 53C2 CDA64D          17      CALL    SETSEQ
0013C5 53C5 E1              10      POP HL
       53C6                     SREAD:
0013C6 53C6 C601             7      ADD A,001H
0013C8 53C8 D8              11      RET C
                                
0013C9 53C9 7D               4      LD  A,L
0013CA 53CA D601             7      SUB 001H
0013CC 53CC 9F               4      SBC A,A
0013CD 53CD E603             7      AND 3
0013CF 53CF 1F               4      RRA
0013D0 53D0 C9              10      RET
                                
       53D1                     _SYS18:     ;(BDOS)ログインベクトルの獲得
0013D1 53D1 210100          10      LD  HL,00001H
0013D4 53D4 AF               4      XOR A
0013D5 53D5 C9              10      RET
                                
       53D6                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
0013D6 53D6 3A46F1          13      LD  A,(_DVSW)
0013D9 53D9 C9              10      RET
                                
       53DA                     _SYS1A:     ;(BDOS)DTAの設定
0013DA 53DA ED5330F1        20      LD  (_DTA),DE
0013DE 53DE AF               4      XOR A
0013DF 53DF C9              10      RET
                                
       53E0                     _SYS1B:     ;(BDOS)ディスク情報の獲得
0013E0 53E0 010002          10      LD  BC,512
0013E3 53E3 11C302          10      LD  DE,707
0013E6 53E6 210000          10      LD  HL,0
0013E9 53E9 DD2135F1        14      LD  IX,_BUF
0013ED 53ED FD2135F1        14      LD  IY,_BUF
0013F1 53F1 FD3600F9        19      LD  (IY+0),0F9H
0013F5 53F5 3E02             7      LD  A,2
0013F7 53F7 C9              10      RET
                                
       53F8                     _SYS21:     ;(BDOS)ランダムな読み出し
0013F8 53F8 CDCB4D          17      CALL    SET_FCB
                                
0013FB 53FB FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0013FE 53FE FD6622          19      LD  H,(IY+34)
                                
001401 5401 CD864D          17      CALL    RB_READ
001404 5404 18C0            12      JR  SREAD
                                
       5406                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
001406 5406 CD0753          17      CALL    _SYS0F
001409 5409 D8              11      RET C
                                
00140A 540A D5              11      PUSH    DE      ;EX DE,IY
00140B 540B FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00140D 540D CDBB4D          17      CALL    GETSIZE
       5410                     _S24X1:
001410 5410 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001413 5413 FD7422          19      LD  (IY+34),H
001416 5416 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
00141A 541A FDE3            23      EX  (SP),IY     ;
00141C 541C D1              10      POP DE      ;
                                
00141D 541D AF               4      XOR A
00141E 541E C9              10      RET
                                
       541F                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
00141F 541F E5              11      PUSH    HL
001420 5420 D5              11      PUSH    DE      ;EX DE,IY
001421 5421 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001423 5423 CD994D          17      CALL    GETSEQ
001426 5426 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       5428                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001428 5428 CDCB4D          17      CALL    SET_FCB
00142B 542B E5              11      PUSH    HL
00142C 542C FD6E21          19      LD  L,(IY+33)
00142F 542F FD6622          19      LD  H,(IY+34)
001432 5432 2226F1          16      LD  (RR_LOW),HL
001435 5435 FD6E23          19      LD  L,(IY+35)
001438 5438 FD6624          19      LD  H,(IY+36)
00143B 543B 2228F1          16      LD  (RR_HIGH),HL
00143E 543E E1              10      POP HL
00143F 543F CD7349          17      CALL    ROM_READ
001442 5442 ED5B26F1        20      LD  DE,(RR_LOW)
001446 5446 FD7321          19      LD  (IY+33),E
001449 5449 FD7222          19      LD  (IY+34),D
00144C 544C ED5B28F1        20      LD  DE,(RR_HIGH)
001450 5450 FD7323          19      LD  (IY+35),E
001453 5453 FD7224          19      LD  (IY+36),D
001456 5456 9F               4      SBC A,A
001457 5457 C9              10      RET
                                
       5458                     _SYS2F:
001458 5458 44               4      LD  B,H
001459 5459 2A30F1          16      LD  HL,(_DTA)
00145C 545C C3D04E          10      JP  DISKIO
                                
       545F                     _SYS5A:
00145F 545F 0600             7      LD  B,0
001461 5461 D5              11      PUSH    DE
001462 5462 DDE1            14      POP IX
       5464                     _SX5A1:
001464 5464 1A               7      LD  A,(DE)
001465 5465 B7               4      OR  A
001466 5466 2804            12      JR  Z,_SX5A2
001468 5468 13               6      INC DE
001469 5469 04               4      INC B
00146A 546A 18F8            12      JR  _SX5A1
                                
       546C                     _SX5A2:
00146C 546C 78               4      LD  A,B
00146D 546D CD3E4A          17      CALL    FILE_BDOS
001470 5470 CD6B4E          17      CALL    ROM_CD
001473 5473 9F               4      SBC A,A
001474 5474 C9              10      RET
                                
       5475                     INIT_FILE:
001475 5475 EB               4      EX  DE,HL
001476 5476 1150F1          10      LD  DE,FDRV
001479 5479 010C00          10      LD  BC,1+8+3
00147C 547C EDB0                    LDIR
00147E 547E CDA650          17      CALL    GET_DISK_BANK_FDRV
001481 5481 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
001484 5484 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
001487 5487 2A5CF1          16      LD  HL,(_CD)
00148A 548A 225EF1          16      LD  (_CDX),HL           ;カレントディレクトリ
00148D 548D C9              10      RET
                                
       548E                     ZERO_MEMORY_DE:
00148E 548E AF               4      XOR A
       548F                     FILL_MEMORY_DE:
00148F 548F 12               7      LD  (DE),A
001490 5490 13               6      INC DE
001491 5491 10FC            13      DJNZ    FILL_MEMORY_DE
001493 5493 C9              10      RET
                                
001494 5494                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 F7500D513E51F750        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 F750F75043518451        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 4B51F7509E513252        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 F252F852FF520753        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 5D536B53A353F750        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 B853F750F750F750        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 D153D653DA53E053        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 F750F750F7500654        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 1F54F750F7502854        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 F750F7504452F750        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 4A52F750F7505854        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 F750F7505F54F750        DW  _ERROR,_ERROR,_SYS5A,_ERROR
001FB8 5FB8 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 F750F750F750F750        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM32.ASM:UTF_8]
