                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
       0001                     USE_MORMAL32K_OR_ASCII16        EQU 1   ;ノーマル32KB/ASCII-16K ROMを作成する
                                
                                    INCLUDE "DISKROM.ASM"
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       269A                     DECADD  EQU 0269AH
       27E6                     DECMUL  EQU 027E6H
       2F8A                     FRCINT  EQU 02F8AH
                                
       303A                     FRCDBL  EQU 0303AH
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F847                     ARG EQU 0F847H
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FDDB                     H_PINL  EQU 0FDDBH
                                
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                            ;ASCII-16K
       6000                     ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
       7000                     ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
                                BANK0_SEL EQU   06000H  ;6000-67FF
                                BANK1_SEL EQU   06800H  ;6800-6FFF
                                BANK2_SEL EQU   07000H  ;7000-77FF
                                BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
                                KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
                                KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
                                KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
                                KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
                                KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
                                KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
                                KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
       F280                     ISC EQU 0F280H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F280                     SP32    EQU 0F280H
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM    ; Main program execution address.
000004 4004 124F                    DW  STATEMENT   ; STATEMENT
000006 4006 4250                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C39A51          10      JP  DISKIO
000013 4013 C3E051          10      JP  DSKCHG
000016 4016 C33652          10      JP  GETDPB
000019 4019 C32953          10      JP  CHOICE
00001C 401C C32D53          10      JP  DSKFMT
00001F 401F C32F53          10      JP  DSKSTP
000022 4022 C33053          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C32D53          10      JP  DSKFMT
000029 4029 C32F53          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C36953          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.4.2.2",0
            204449534B20524F    
            4D204C6974652076    
            302E342E322E3200    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 AF               4      XOR A
000107 4107 2100F3          10      LD  HL,0F300H
00010A 410A 0668             7      LD  B,068H
00010C 410C CDCB4B          17      CALL    FILL_MEMORY
                                
00010F 410F 3E01             7      LD  A,1
000111 4111 3221FB          13      LD  (DRVTBL),A
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
000114 4114 2A74F6          16      LD  HL,(STKTOP) ;起動時の空き容量表示の為
000117 4117 01C0FE          10      LD  BC,-00140H
00011A 411A 09              11      ADD HL,BC
00011B 411B 2274F6          16      LD  (STKTOP),HL
                                #else
                                    LD  HL,STKTOP+1 ;起動時の空き容量表示の為
                                    DEC (HL)
                                #endif
                                
00011E 411E AF               4      XOR A
00011F 411F 32EAF2          13      LD  (_DVSW),A
000122 4122 3D               4      DEC A       ;0FFH
000123 4123 3299FD          13      LD  (DEVICE),A
                                
000126 4126 21E542          10      LD  HL,AT_ISC
000129 4129 1180F2          10      LD  DE,ISC
00012C 412C 018800          10      LD  BC,ISC_E-ISC
00012F 412F EDB0                    LDIR
                                    
000131 4131 3EC3             7      LD  A,0C3H      ;JP
000133 4133 3243FF          13      LD  (H_GONE),A
000136 4136 327DF3          13      LD  (BDOS),A
000139 4139 326BF3          13      LD  (RAMUSE),A
00013C 413C 3268F3          13      LD  (ROMUSE),A
00013F 413F 2180F2          10      LD  HL,REPLACE_COMMAND
000142 4142 2244FF          16      LD  (H_GONE+1),HL
000145 4145 2131F3          10      LD  HL,H_BDOS
000148 4148 227EF3          16      LD  (BDOS+1),HL
00014B 414B 21ABF2          10      LD  HL,RAMUSE1
00014E 414E 226CF3          16      LD  (RAMUSE+1),HL
000151 4151 21BEF2          10      LD  HL,ROMUSE1
000154 4154 2269F3          16      LD  (ROMUSE+1),HL
                                
000157 4157 3E                      DB  03EH
000158 4158 F7              12      RST 30H
000159 4159 3271FE          13      LD  (H_BINS),A
00015C 415C 3276FE          13      LD  (H_BINL),A
00015F 415F 327BFE          13      LD  (H_FILE),A
000162 4162 3231F3          13      LD  (H_BDOS),A
000165 4165 32DBFD          13      LD  (H_PINL),A
000168 4168 32A7FF          13      LD  (H_PHYD),A
                                
00016B 416B CD3142          17      CALL    GTSL1_
00016E 416E 3297F2          13      LD  (ROM_SLT),A
000171 4171 32A7F2          13      LD  (ROM_SLT_COPY),A
000174 4174 3272FE          13      LD  (H_BINS+1),A
000177 4177 3277FE          13      LD  (H_BINL+1),A
00017A 417A 327CFE          13      LD  (H_FILE+1),A
00017D 417D 3232F3          13      LD  (H_BDOS+1),A
000180 4180 32DCFD          13      LD  (H_PINL+1),A
000183 4183 32A8FF          13      LD  (H_PHYD+1),A
000186 4186 3222FB          13      LD  (DRVTBL+1),A
000189 4189 3248F3          13      LD  (MASTERS),A
                                
00018C 418C 21B745          10      LD  HL,ROM_LOAD
00018F 418F 2273FE          16      LD  (H_BINS+2),HL
000192 4192 216847          10      LD  HL,ROM_RUN
000195 4195 2278FE          16      LD  (H_BINL+2),HL
000198 4198 217647          10      LD  HL,ROM_FILES
00019B 419B 227DFE          16      LD  (H_FILE+2),HL
00019E 419E 21CE53          10      LD  HL,ROM_BDOS
0001A1 41A1 2233F3          16      LD  (H_BDOS+2),HL
0001A4 41A4 21AA43          10      LD  HL,ROM_BOOT
0001A7 41A7 22DDFD          16      LD  (H_PINL+2),HL
0001AA 41AA 219A51          10      LD  HL,DISKIO
0001AD 41AD 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001B0 41B0 3E                      DB  03EH
0001B1 41B1 C9              10      RET
0001B2 41B2 327FFE          13      LD  (H_FILE+4),A
0001B5 41B5 3275FE          13      LD  (H_BINS+4),A
0001B8 41B8 327AFE          13      LD  (H_BINL+4),A
0001BB 41BB 3235F3          13      LD  (H_BDOS+4),A
0001BE 41BE 32DFFD          13      LD  (H_PINL+4),A
0001C1 41C1 32ABFF          13      LD  (H_PHYD+4),A
                                
0001C4 41C4 AF               4      XOR A
                                #if exists USE_MORMAL32K_OR_ASCII16
0001C5 41C5 320060          13      LD  (ASCII16_BANK0_SEL),A       ;似非RAM対策でバンク0を設定
0001C8 41C8 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK0_SEL),A           ;似非RAM対策でバンク0を設定
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001CB 41CB 3A0060          13      LD  A,(BANK1_ADR)
0001CE 41CE FE41             7      CP  'A'
                                #if exists USE_MORMAL32K_OR_ASCII16
0001D0 41D0 284E            12      JR  Z,NOT_BANK_TYPE
0001D2 41D2 3E01             7      LD  A,DISK_BANK
0001D4 41D4 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    JR  NZ,NOT_BANK_TYPE
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001D7 41D7 CD3801          17      CALL    RSLREG      ;read primary slot #
0001DA 41DA 07               4      RLCA
0001DB 41DB 07               4      RLCA
0001DC 41DC F5              11      PUSH    AF
0001DD 41DD 1605             7      LD  D,4+1
0001DF 41DF CD3842          17      CALL    GTSL2_
0001E2 41E2 3244F3          13      LD  (RAMAD3),A
0001E5 41E5 F1              10      POP AF
0001E6 41E6 07               4      RLCA
0001E7 41E7 07               4      RLCA
0001E8 41E8 1603             7      LD  D,2+1
0001EA 41EA CD3842          17      CALL    GTSL2_
0001ED 41ED 2680             7      LD  H,080H
0001EF 41EF CD5542          17      CALL    CHK_RAM
0001F2 41F2 3243F3          13      LD  (RAMAD2),A
       41F5                     RAMCHK2:
0001F5 41F5 3A44F3          13      LD  A,(RAMAD3)
0001F8 41F8 2640             7      LD  H,040H
0001FA 41FA CD5542          17      CALL    CHK_RAM
0001FD 41FD 3242F3          13      LD  (RAMAD1),A
       4200                     RAMCHK1:
000200 4200 3A44F3          13      LD  A,(RAMAD3)
000203 4203 2600             7      LD  H,00H
000205 4205 CD5542          17      CALL    CHK_RAM
000208 4208 3241F3          13      LD  (RAMAD0),A
       420B                     RAMCHK0:
00020B 420B 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
00020E 420E 010F00          10      LD  BC,0000FH       ;切り上げ
000211 4211 09              11      ADD HL,BC
000212 4212 7D               4      LD  A,L
                                
000213 4213 0604             7      LD  B,4
       4215                     B_DRIVE1:
000215 4215 CB3C             8      SRL H
000217 4217 1F               4      RRA
000218 4218 10FB            13      DJNZ    B_DRIVE1
                                
00021A 421A C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
00021C 421C 32E9F2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
00021F 421F C9              10      RET
                                
       4220                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
000220 4220 21ED43          10      LD  HL,MSG_ERROR_ROM_MODE
000223 4223 CD7043          17      CALL    MSX
000226 4226 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00022A 422A DD219F00        14      LD  IX,CHGET
00022E 422E C31C00          10      JP  _CALSLT
                                
       4231                     GTSL1_:             ;自分のいるスロットを知る
000231 4231 CD3801          17      CALL    RSLREG      ;read primary slot #
000234 4234 0F               4      RRCA
000235 4235 0F               4      RRCA
000236 4236 1601             7      LD  D,1
       4238                     GTSL2_:
000238 4238 E603             7      AND 3       ;[A]=000000PP
00023A 423A 5F               4      LD  E,A     ;[E]=000000PP
00023B 423B 21C1FC          10      LD  HL,EXPTBL
00023E 423E 85               4      ADD A,L     ;桁上りは無い
00023F 423F 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000240 4240 7B               4      LD  A,E     ;[A]=000000PP
000241 4241 CB7E            13      BIT 7,(HL)
000243 4243 C8              11      RET Z
000244 4244 7D               4      LD  A,L     ;point to SLTTBL entry
000245 4245 C604             7      ADD A,4     ;桁上りは無い
000247 4247 6F               4      LD  L,A
000248 4248 7E               7      LD  A,(HL)      ;get currently expansion slot register
       4249                     GTSL3_:
000249 4249 15               4      DEC D
00024A 424A 2803            12      JR  Z,GTSL4_:
00024C 424C 0F               4      RRCA
00024D 424D 18FA            12      JR  GTSL3_:
       424F                     GTSL4_:
00024F 424F E60C             7      AND 00CH        ;[A] = 0000SS00
000251 4251 B3               4      OR  E       ;[A] = 0000SSPP
000252 4252 F680             7      OR  080H        ;[A] = 1000SSPP
000254 4254 C9              10      RET
                                
       4255                     CHK_RAM:
000255 4255 E5              11      PUSH    HL
000256 4256 CDAA42          17      CALL    CHK_RAM0
000259 4259 E1              10      POP HL
00025A 425A C8              11      RET Z
00025B 425B 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
00025E 425E E680             7      AND 080H
000260 4260 CD8142          17      CALL    CHK_RAM_SLT
000263 4263 C8              11      RET Z
000264 4264 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000267 4267 E680             7      AND 080H
000269 4269 C601             7      ADD A,1
00026B 426B CD8142          17      CALL    CHK_RAM_SLT
00026E 426E C8              11      RET Z
00026F 426F 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000272 4272 E680             7      AND 080H
000274 4274 C602             7      ADD A,2
000276 4276 CD8142          17      CALL    CHK_RAM_SLT
000279 4279 C8              11      RET Z
00027A 427A 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
00027D 427D E680             7      AND 080H
00027F 427F C603             7      ADD A,3
       4281                     CHK_RAM_SLT:
000281 4281 E5              11      PUSH    HL
000282 4282 CDAA42          17      CALL    CHK_RAM0        ;スロット#X or X-0
000285 4285 E1              10      POP HL
000286 4286 C8              11      RET Z
000287 4287 CB79             8      BIT 7,C
000289 4289 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
00028B 428B 79               4      LD  A,C
00028C 428C C604             7      ADD A,4*1           ;スロット#X-1
00028E 428E E5              11      PUSH    HL
00028F 428F CDAA42          17      CALL    CHK_RAM0
000292 4292 E1              10      POP HL
000293 4293 C8              11      RET Z
000294 4294 79               4      LD  A,C
000295 4295 C608             7      ADD A,4*2           ;スロット#X-2
000297 4297 E5              11      PUSH    HL
000298 4298 CDAA42          17      CALL    CHK_RAM0
00029B 429B E1              10      POP HL
00029C 429C C8              11      RET Z
00029D 429D 79               4      LD  A,C
00029E 429E C60C             7      ADD A,4*3           ;スロット#X-3
0002A0 42A0 E5              11      PUSH    HL
0002A1 42A1 CDAA42          17      CALL    CHK_RAM0
0002A4 42A4 E1              10      POP HL
       42A5                     CHK_RAM_E:
0002A5 42A5 AF               4      XOR A
0002A6 42A6 3C               4      INC A           ;ZF=0にする
0002A7 42A7 3E00             7      LD  A,0
0002A9 42A9 C9              10      RET
                                
       42AA                     CHK_RAM0:
0002AA 42AA 4F               4      LD  C,A
0002AB 42AB 3A97F2          13      LD  A,(ROM_SLT)
0002AE 42AE B9               4      CP  C
0002AF 42AF 28F4            12      JR  Z,CHK_RAM_E
0002B1 42B1 2E00             7      LD  L,0
       42B3                     CHK_RAM1:
0002B3 42B3 79               4      LD  A,C
0002B4 42B4 CDA243          17      CALL    RDSLTX
0002B7 42B7 C6E5             7      ADD A,0E5H
0002B9 42B9 47               4      LD  B,A
0002BA 42BA 5F               4      LD  E,A
0002BB 42BB 79               4      LD  A,C
0002BC 42BC C5              11      PUSH    BC
0002BD 42BD CD1400          17      CALL    _WRSLT
0002C0 42C0 C1              10      POP BC
0002C1 42C1 79               4      LD  A,C
0002C2 42C2 CDA243          17      CALL    RDSLTX
0002C5 42C5 B8               4      CP  B
0002C6 42C6 C0              11      RET NZ
0002C7 42C7 D6E5             7      SUB 0E5H
0002C9 42C9 79               4      LD  A,C
0002CA 42CA 5F               4      LD  E,A
0002CB 42CB C5              11      PUSH    BC
0002CC 42CC CD1400          17      CALL    _WRSLT
0002CF 42CF C1              10      POP BC
0002D0 42D0 24               4      INC H
0002D1 42D1 7D               4      LD  A,L
0002D2 42D2 C604             7      ADD A,4
0002D4 42D4 6F               4      LD  L,A
0002D5 42D5 20DC            12      JR  NZ,CHK_RAM1
0002D7 42D7 79               4      LD  A,C     ;ZF=1のハズ
0002D8 42D8 C9              10      RET
                                
       42D9                     CALSLT_R:
0002D9 42D9 C5              11      PUSH    BC
0002DA 42DA E5              11      PUSH    HL
0002DB 42DB FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0002DF 42DF CD1C00          17      CALL    _CALSLT
0002E2 42E2 E1              10      POP HL
0002E3 42E3 C1              10      POP BC
0002E4 42E4 C9              10      RET
                                
       42E5                     AT_ISC:
0002E5 F280                         ORG ISC,AT_ISC-RUN
       F280                     REPLACE_COMMAND:
0002E5 F280 FEB7             7      CP  0B7H            ;FILES
0002E7 F282 CC7BFE          17      CALL    Z,H_FILE
0002EA F285 FEB5             7      CP  0B5H            ;LOAD
0002EC F287 CA71FE          10      JP  Z,H_BINS
0002EF F28A FE8A             7      CP  08AH            ;RUN
0002F1 F28C CA76FE          10      JP  Z,H_BINL
0002F4 F28F FED6             7      CP  0D6H            ;COPY
0002F6 F291 2813            12      JR  Z,FIX_COPY
0002F8 F293 FECF             7      CP  0CFH            ;BLOAD
0002FA F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
0002FB F296 F7              12      RST 30H
       F297                     ROM_SLT:
0002FC F297 00                      DB  0
0002FD F298 9946                    DW  ROM_BLOAD
0002FF F29A F5              11      PUSH    AF
000300 F29B E5              11      PUSH    HL
000301 F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
000304 F29F E1              10      POP HL
000305 F2A0 F1              10      POP AF
000306 F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
000308 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
00030A F2A5 C9              10      RET
       F2A6                     FIX_COPY:
00030B F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
00030C F2A7 00                      DB  0
00030D F2A8 1848                    DW  ROM_COPY
00030F F2AA C9              10      RET
       F2AB                     RAMUSE1:
000310 F2AB 3A42F3          13      LD  A,(RAMAD1)
       F2AE                     ROMUSE2:
000313 F2AE C32400          10      JP  _ENASLT
       F2B1                     CAL_MP:
000316 F2B1 2640             7      LD  H,040H
000318 F2B3 3AC1FC          13      LD  A,(EXPTBL)
00031B F2B6 CD2400          17      CALL    _ENASLT
00031E F2B9 CD1C00          17      CALL    _CALSLT
000321 F2BC 2640             7      LD  H,040H
       F2BE                     ROMUSE1:
000323 F2BE 3A97F2          13      LD  A,(ROM_SLT)
000326 F2C1 18EB            12      JR  ROMUSE2
                                
       F2C3                     _RESULT:
000328 F2C3 00                      DB  0
       F2C4                     _BANK:
000329 F2C4 00                      DB  0
       F2C5                     _BANK1:
00032A F2C5 00                      DB  0
       F2C6                     CLSZ:               ;クラスタサイズ
00032B F2C6 0004                    DW  1024
       F2C7                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2C8                     SECSZ:              ;セクタサイズ
00032D F2C8 0002                    DW  512
       F2C9                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2CA                     RR_LOW:
00032F F2CA 0000                    DW  0
       F2CB                     RR_MID  EQU $-1
       F2CC                     RR_HIGH:
000331 F2CC 0000                    DW  0
       F2CE                     _CLPS:
000333 F2CE 0000                    DW  0
       F2D0                     _LEFT:
000335 F2D0 0000                    DW  0
       F2D2                     _DTPS:
000337 F2D2 0000                    DW  0
       F2D4                     _DTA:
000339 F2D4 0000                    DW  0
       F2D6                     FLG_LDIR:
00033B F2D6 00                      DB  0
       F2D7                     _FCB:
00033C F2D7 0000                    DW  0
       F2D9                     _BUF:
       F2D9                     _BUF_LO:        ;LOGICAL OPERATION
00033E F2D9 00                      DB  0
       F2DA                     _BUF_ST:
00033F F2DA 0000                    DW  0
       F2DC                     _BUF_EN:
000341 F2DC 0000                    DW  0
       F2DE                     _BUF_EX:
       F2DE                     _BUF_W:
000343 F2DE 0000                    DW  0
       F2E0                     _BUF_H:
000345 F2E0 0000                    DW  0
       F2E2                     _BUF_X:
000347 F2E2 0000                    DW  0
       F2E4                     _BUF_Y:
000349 F2E4 00                      DB  0
       F2E5                     _BUF_P:
00034A F2E5 00                      DB  0
       F2E6                     _BUF_O:
00034B F2E6 00                      DB  0
       F2E7                     DTAX:
00034C F2E7 0000                    DW  0
       F2E9                     B_DRIVE:
00034E F2E9 00                      DB  0
       F2EA                     _DVSW:          ;カレントドライブ
00034F F2EA 00                      DB  0
       F2EB                     _CD:            ;カレントディレクトリ
000350 F2EB 0000                    DW  0
       F2ED                     DIRENT1:
000352 F2ED 0000                    DW  0
       F2EF                     _DIR_BANK:
000354 F2EF 00                      DB  0
       F2F0                     LEFTX:
000355 F2F0 0000                    DW  0
       F2F2                     PARAM0:
000357 F2F2 0000                    DW  0
       F2F4                     PARAM1:
000359 F2F4 0000                    DW  0
       F2F6                     _CDX:
00035B F2F6 0000                    DW  0
       F2F8                     FDRV:
00035D F2F8 00                      DB  0
       F2F9                     FNAME:
00035E F2F9                         DS  8+3
       F304                     _HL:
000369 F304 0000                    DW  0
       F306                     _SP:
00036B F306 0000                    DW  0
       F307                     _SP_H   EQU $-1
       F308                     ISC_E:
00036D 436D                         ORG $$+RUN          ;$DEPHASE
                                
       436D                     MSX1:
00036D 436D CDE753          17      CALL    MSGA1
       4370                     MSX:
000370 4370 7E               7      LD  A,(HL)
000371 4371 23               6      INC HL
000372 4372 B7               4      OR  A
000373 4373 20F8            12      JR  NZ,MSX1
000375 4375 C9              10      RET
                                
       4376                     PRTHX:
000376 4376 F5              11      PUSH    AF
000377 4377 07               4      RLCA
000378 4378 07               4      RLCA
000379 4379 07               4      RLCA
00037A 437A 07               4      RLCA
00037B 437B CD7F43          17      CALL    PRTA2
00037E 437E F1              10      POP AF
       437F                     PRTA2:
00037F 437F CD8543          17      CALL    ASC
000382 4382 C3E353          10      JP  MSG_A
                                    
       4385                     ASC:
000385 4385 E60F             7      AND $0F
000387 4387 F630             7      OR  $30
000389 4389 FE3A             7      CP  $3A
00038B 438B D8              11      RET C
00038C 438C C607             7      ADD A,7
00038E 438E C9              10      RET
                                
       438F                     MSN:
                                #if exists USE_MORMAL32K_OR_ASCII16
00038F 438F CD9B43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000392 4392 23               6      INC HL
000393 4393 CDE353          17      CALL    MSG_A
000396 4396 10F7            13      DJNZ    MSN
000398 4398 C9              10      RET
                                
       4399                     RDSLT_ROM3:
000399 4399 7E               7      LD  A,(HL)
00039A 439A C9              10      RET
       439B                     RDSLT_ROM:
00039B 439B CB7C             8      BIT 7,H
00039D 439D 28FA            12      JR  Z,RDSLT_ROM3
       439F                     RDSLT_ROM2:
00039F 439F 3A97F2          13      LD  A,(ROM_SLT)
       43A2                     RDSLTX:
0003A2 43A2 C5              11      PUSH    BC
0003A3 43A3 D5              11      PUSH    DE
0003A4 43A4 CD0C00          17      CALL    _RDSLT
0003A7 43A7 D1              10      POP DE
0003A8 43A8 C1              10      POP BC
0003A9 43A9 C9              10      RET
                                
       43AA                     ROM_BOOT:
0003AA 43AA 3E                      DB  03EH
0003AB 43AB C9              10      RET
0003AC 43AC 32DBFD          13      LD  (H_PINL),A
0003AF 43AF 3ACAFF          13      LD  A,(EXTBIO)
0003B2 43B2 FEF7             7      CP  0F7H        ;RST 30H
0003B4 43B4 280A            12      JR  Z,EXTBIO_OK
0003B6 43B6 3E                      DB  03EH
0003B7 43B7 C9              10      RET
0003B8 43B8 21CAFF          10      LD  HL,EXTBIO
0003BB 43BB 061D             7      LD  B,29
0003BD 43BD CDCB4B          17      CALL    FILL_MEMORY
       43C0                     EXTBIO_OK:
0003C0 43C0 210A44          10      LD  HL,DELOK
0003C3 43C3 CD7043          17      CALL    MSX
                                
0003C6 43C6 AF               4      XOR A
0003C7 43C7 3240F3          13      LD  (REBOOT),A
0003CA 43CA 2A48FC          16      LD  HL,(BOTTOM)
0003CD 43CD 110040          10      LD  DE,16384
0003D0 43D0 19              11      ADD HL,DE
0003D1 43D1 3817            12      JR  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
0003D3 43D3 57               4      LD  D,A
0003D4 43D4 0601             7      LD  B,1
0003D6 43D6 2100C0          10      LD  HL,0C000H
0003D9 43D9 CD9A51          17      CALL    DISKIO
                                
0003DC 43DC 116BF3          10      LD  DE,RAMUSE
0003DF 43DF AF               4      XOR A
0003E0 43E0 CD1EC0          17      CALL    0C01EH
0003E3 43E3 116BF3          10      LD  DE,RAMUSE
0003E6 43E6 37               4      SCF
0003E7 43E7 CD1EC0          17      CALL    0C01EH
       43EA                     BOOT1:
0003EA 43EA C33053          10      JP  BASENT
                                
       43ED                     MSG_ERROR_ROM_MODE:
                                #if exists USE_MORMAL32K_OR_ASCII16
0003ED 43ED 4E6F726D616C2052        DB  "Normal ROM/ASCII-16K only!",13,10
            4F4D2F4153434949    
            2D31364B206F6E6C    
            79210D0A            
                                #else
                                    DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
                                #endif
       4409                     NULL:
000409 4409 00                      DB  0
       440A                     DELOK:
00040A 440A 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       440E                     ROM_LDIR:
00040E 440E 3AD6F2          13      LD  A,(FLG_LDIR)
000411 4411 B7               4      OR  A
000412 4412 206A            12      JR  NZ,ROM_LDIRVM
000414 4414 CB7A             8      BIT 7,D
000416 4416 CAAE44          10      JP  Z,ROM_LDIRSLT
                                #if exists USE_MORMAL32K_OR_ASCII16
       4419                     LDIRA:
000419 4419 F3               4      DI
00041A 441A ED7306F3        20      LD  (_SP),SP
00041E 441E 3A07F3          13      LD  A,(_SP_H)
000421 4421 FEC0             7      CP  0C0H
000423 4423 3003            12      JR  NC,SPJ1
000425 4425 3180F2          10      LD  SP,SP32
       4428                     SPJ1:
       4428                     LDIR1:
000428 4428 78               4      LD  A,B
000429 4429 B1               4      OR  C
00042A 442A 284D            12      JR  Z,LDIRE
                                
00042C 442C C5              11      PUSH    BC
00042D 442D D5              11      PUSH    DE
00042E 442E E5              11      PUSH    HL
00042F 442F 3A97F2          13      LD  A,(ROM_SLT)
000432 4432 2680             7      LD  H,080H
000434 4434 CD2400          17      CALL    _ENASLT
000437 4437 E1              10      POP HL
000438 4438 D1              10      POP DE
000439 4439 C1              10      POP BC
       443A                     LDIR2:
00043A 443A 7A               4      LD  A,D
00043B 443B FEC0             7      CP  0C0H
00043D 443D 302C            12      JR  NC,LDIR4
                                
00043F 443F C5              11      PUSH    BC
000440 4440 D5              11      PUSH    DE
000441 4441 115EF5          10      LD  DE,BUF
                                
000444 4444 78               4      LD  A,B
000445 4445 B7               4      OR  A
000446 4446 2803            12      JR  Z,LDIR3
000448 4448 010001          10      LD  BC,00100H
       444B                     LDIR3:
00044B 444B C5              11      PUSH    BC
00044C 444C EDB0                    LDIR
00044E 444E 2204F3          16      LD  (_HL),HL
                                
000451 4451 3A43F3          13      LD  A,(RAMAD2)
000454 4454 2680             7      LD  H,080H
000456 4456 CD2400          17      CALL    _ENASLT
                                
000459 4459 C1              10      POP BC
00045A 445A D1              10      POP DE
00045B 445B 215EF5          10      LD  HL,BUF
00045E 445E EDB0                    LDIR
                                
000460 4460 2A04F3          16      LD  HL,(_HL)
000463 4463 C1              10      POP BC
000464 4464 78               4      LD  A,B
000465 4465 B7               4      OR  A
000466 4466 2811            12      JR  Z,LDIRE
000468 4468 05               4      DEC B
000469 4469 18BD            12      JR  LDIR1
       446B                     LDIR4:
                                #endif
00046B 446B EDB0                    LDIR
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
       446D                     LDIRE2:
00046D 446D D5              11      PUSH    DE
00046E 446E E5              11      PUSH    HL
00046F 446F 3A43F3          13      LD  A,(RAMAD2)
000472 4472 2680             7      LD  H,080H
000474 4474 CD2400          17      CALL    _ENASLT
000477 4477 E1              10      POP HL
000478 4478 D1              10      POP DE
       4479                     LDIRE:
000479 4479 ED7B06F3        20      LD  SP,(_SP)
                                #endif
00047D 447D C9              10      RET
                                
       447E                     ROM_LDIRVM:
                                #if exists USE_MORMAL32K_OR_ASCII16
00047E 447E F3               4      DI
00047F 447F ED7306F3        20      LD  (_SP),SP
000483 4483 3A07F3          13      LD  A,(_SP_H)
000486 4486 FEC0             7      CP  0C0H
000488 4488 3003            12      JR  NC,SPJ2
00048A 448A 3180F2          10      LD  SP,SP32
       448D                     SPJ2:
00048D 448D C5              11      PUSH    BC
00048E 448E D5              11      PUSH    DE
00048F 448F E5              11      PUSH    HL
000490 4490 3A97F2          13      LD  A,(ROM_SLT)
000493 4493 2680             7      LD  H,080H
000495 4495 CD2400          17      CALL    _ENASLT
000498 4498 E1              10      POP HL
000499 4499 D1              10      POP DE
00049A 449A C1              10      POP BC
                                #endif
00049B 449B C5              11      PUSH    BC
00049C 449C D5              11      PUSH    DE
00049D 449D FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0004A1 44A1 DD215C00        14      LD  IX,LDIRVM
0004A5 44A5 CD1C00          17      CALL    _CALSLT
0004A8 44A8 E1              10      POP HL
0004A9 44A9 C1              10      POP BC
0004AA 44AA 09              11      ADD HL,BC
0004AB 44AB EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
0004AC 44AC 18BF            12      JR  LDIRE2
                                #else
                                    RET
                                #endif
                                
       44AE                     ROM_LDIRSLT:
                                #if exists USE_MORMAL32K_OR_ASCII16
0004AE 44AE F3               4      DI
0004AF 44AF ED7306F3        20      LD  (_SP),SP
0004B3 44B3 3A07F3          13      LD  A,(_SP_H)
0004B6 44B6 FEC0             7      CP  0C0H
0004B8 44B8 3003            12      JR  NC,SPJ3
0004BA 44BA 3180F2          10      LD  SP,SP32
       44BD                     SPJ3:
0004BD 44BD C5              11      PUSH    BC
0004BE 44BE D5              11      PUSH    DE
0004BF 44BF E5              11      PUSH    HL
0004C0 44C0 3A97F2          13      LD  A,(ROM_SLT)
0004C3 44C3 2680             7      LD  H,080H
0004C5 44C5 CD2400          17      CALL    _ENASLT
0004C8 44C8 E1              10      POP HL
0004C9 44C9 D1              10      POP DE
0004CA 44CA C1              10      POP BC
                                #endif
       44CB                     ROM_LDIRSLT1:
0004CB 44CB EB               4      EX  DE,HL
       44CC                     RLDIRSLT1:
0004CC 44CC CB7C             8      BIT 7,H
0004CE 44CE 2021            12      JR  NZ,RLDIRSLT_EXIT
0004D0 44D0 1A               7      LD  A,(DE)
0004D1 44D1 13               6      INC DE
0004D2 44D2 C5              11      PUSH    BC
0004D3 44D3 D5              11      PUSH    DE
0004D4 44D4 E5              11      PUSH    HL
0004D5 44D5 5F               4      LD  E,A
                                
0004D6 44D6 0141F3          10      LD  BC,RAMAD0
0004D9 44D9 7C               4      LD  A,H
0004DA 44DA 07               4      RLCA
0004DB 44DB 07               4      RLCA
0004DC 44DC E603             7      AND 3
0004DE 44DE 81               4      ADD A,C
0004DF 44DF 4F               4      LD  C,A
0004E0 44E0 0A               7      LD  A,(BC)
       44E1                     RLDIRSLT2:
0004E1 44E1 CD1400          17      CALL    _WRSLT
0004E4 44E4 08               4      EX  AF,AF'
0004E5 44E5 E1              10      POP HL
0004E6 44E6 D1              10      POP DE
0004E7 44E7 C1              10      POP BC
0004E8 44E8 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0004EA 44EA EACC44          10      JP  PE,RLDIRSLT1
0004ED 44ED EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
0004EE 44EE C36D44          10      JP  LDIRE2
       44F1                     RLDIRSLT_EXIT:
0004F1 44F1 EB               4      EX  DE,HL
0004F2 44F2 C32844          10      JP  LDIR1
                                #else
                                    RET
                                RLDIRSLT_EXIT:
                                    EX  DE,HL
                                    LDIR
                                    RET
                                #endif
                                
       44F5                     END_OF_LINE:
0004F5 44F5 215EF5          10      LD  HL,BUF
       44F8                     EOL1:
0004F8 44F8 7E               7      LD  A,(HL)
0004F9 44F9 C8              11      RET Z
0004FA 44FA FE0D             7      CP  00DH
0004FC 44FC 2807            12      JR  Z,EOLE
0004FE 44FE FE0A             7      CP  00AH
000500 4500 2803            12      JR  Z,EOLE
000502 4502 23               6      INC HL
000503 4503 18F3            12      JR  EOL1
       4505                     EOLE:
000505 4505 3600            10      LD  (HL),0
000507 4507 23               6      INC HL
000508 4508 7E               7      LD  A,(HL)
000509 4509 FE0A             7      CP  00AH
00050B 450B C0              11      RET NZ
00050C 450C 23               6      INC HL
00050D 450D C9              10      RET
                                
       450E                     ROM_LOAD_ASCII:
00050E 450E 210000          10      LD  HL,0
000511 4511 22DAF2          16      LD  (_BUF_ST),HL    ;読み出し位置
000514 4514 2A76F6          16      LD  HL,(TXTTAB)
000517 4517 22DCF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
00051A 451A 215EF5          10      LD  HL,BUF
00051D 451D 22D4F2          16      LD  (_DTA),HL
       4520                     RLOAD_A1:
000520 4520 2ADAF2          16      LD  HL,(_BUF_ST)
000523 4523 22CAF2          16      LD  (RR_LOW),HL
000526 4526 210201          10      LD  HL,258
000529 4529 CD384A          17      CALL    ROM_READ
00052C 452C 7C               4      LD  A,H
00052D 452D B5               4      OR  L
00052E 452E 2879            12      JR  Z,RLOAD_AEND
000530 4530 015EF5          10      LD  BC,BUF
000533 4533 09              11      ADD HL,BC
000534 4534 3600            10      LD  (HL),0
000536 4536 CDF544          17      CALL    END_OF_LINE
000539 4539 015EF5          10      LD  BC,BUF
00053C 453C A7               4      AND A
00053D 453D ED42            15      SBC HL,BC
00053F 453F 2810            12      JR  Z,RLOAD_A2
000541 4541 4D               4      LD  C,L
000542 4542 44               4      LD  B,H
000543 4543 ED5BDAF2        20      LD  DE,(_BUF_ST)
000547 4547 19              11      ADD HL,DE
000548 4548 22DAF2          16      LD  (_BUF_ST),HL
00054B 454B 3A5EF5          13      LD  A,(BUF)
00054E 454E B7               4      OR  A
00054F 454F 28CF            12      JR  Z,RLOAD_A1
       4551                     RLOAD_A2:
000551 4551 115EF5          10      LD  DE,BUF
000554 4554 CD024C          17      CALL    SPCUTEX
000557 4557 1A               7      LD  A,(DE)
000558 4558 B7               4      OR  A
000559 4559 284E            12      JR  Z,RLOAD_AEND
00055B 455B CD144C          17      CALL    GETNUM
00055E 455E 7C               4      LD  A,H
00055F 455F B5               4      OR  L
000560 4560 CA8046          10      JP  Z,ERROR_DIRECT_IN_FILE
000563 4563 DD2ADCF2        20      LD  IX,(_BUF_EN)
000567 4567 DD7502          19      LD  (IX+2),L
00056A 456A DD7403          19      LD  (IX+3),H
                                
00056D 456D CDFB4B          17      CALL    SPCUT
000570 4570 EB               4      EX  DE,HL
000571 4571 DDE5            15      PUSH    IX
000573 4573 DD21B242        14      LD  IX,CRUNCH
000577 4577 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00057B 457B CD1C00          17      CALL    _CALSLT
00057E 457E DDE1            14      POP IX
000580 4580 EB               4      EX  DE,HL
000581 4581 111FF4          10      LD  DE,KBUF
000584 4584 37               4      SCF
000585 4585 ED52            15      SBC HL,DE
000587 4587 CA8046          10      JP  Z,ERROR_DIRECT_IN_FILE
00058A 458A DA8046          10      JP  C,ERROR_DIRECT_IN_FILE
00058D 458D 4D               4      LD  C,L
00058E 458E 44               4      LD  B,H
00058F 458F 2ADCF2          16      LD  HL,(_BUF_EN)
000592 4592 110400          10      LD  DE,4
000595 4595 19              11      ADD HL,DE
000596 4596 111FF4          10      LD  DE,KBUF
                                
000599 4599 EB               4      EX  DE,HL
00059A 459A EDB0                    LDIR
00059C 459C EB               4      EX  DE,HL
                                
00059D 459D DD7500          19      LD  (IX+0),L
0005A0 45A0 DD7401          19      LD  (IX+1),H
0005A3 45A3 22DCF2          16      LD  (_BUF_EN),HL
0005A6 45A6 C32045          10      JP  RLOAD_A1
                                
       45A9                     RLOAD_AEND:
0005A9 45A9 2ADCF2          16      LD  HL,(_BUF_EN)
0005AC 45AC AF               4      XOR A
0005AD 45AD 77               7      LD  (HL),A
0005AE 45AE 23               6      INC HL
0005AF 45AF 77               7      LD  (HL),A
0005B0 45B0 23               6      INC HL
0005B1 45B1 22DCF2          16      LD  (_BUF_EN),HL
0005B4 45B4 C34346          10      JP  RLOAD_END1
                                
       45B7                     ROM_LOAD:
0005B7 45B7 CDE647          17      CALL    INIT_PARAM
0005BA 45BA 7E               7      LD  A,(HL)
0005BB 45BB FE2C             7      CP  ','
0005BD 45BD 2003            12      JR  NZ,ROM_LOAD0
0005BF 45BF 23               6      INC HL
0005C0 45C0 7E               7      LD  A,(HL)
0005C1 45C1 2B               6      DEC HL
       45C2                     ROM_LOAD0:
0005C2 45C2 32BEFC          13      LD  (RUNBNF),A
0005C5 45C5 CDD94A          17      CALL    FILE_B
0005C8 45C8 3AF9F2          13      LD  A,(FNAME)
0005CB 45CB FE20             7      CP  020H
0005CD 45CD CAD44A          10      JP  Z,ROM_ORG
                                
0005D0 45D0 CD6B4C          17      CALL    ROM_OPEN
0005D3 45D3 DA8C46          10      JP  C,ERROR_FILE_NOT_FOUND
       45D6                     ROM_LOAD1:
0005D6 45D6 21D9F2          10      LD  HL,_BUF
0005D9 45D9 22D4F2          16      LD  (_DTA),HL
0005DC 45DC 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
0005DF 45DF CD384A          17      CALL    ROM_READ
0005E2 45E2 3AD9F2          13      LD  A,(_BUF)
0005E5 45E5 3C               4      INC A
0005E6 45E6 C20E45          10      JP  NZ,ROM_LOAD_ASCII
0005E9 45E9 2A76F6          16      LD  HL,(TXTTAB)
0005EC 45EC 22D4F2          16      LD  (_DTA),HL
0005EF 45EF EB               4      EX  DE,HL
0005F0 45F0 2100FF          10      LD  HL,-256
0005F3 45F3 39              11      ADD HL,SP
0005F4 45F4 ED52            15      SBC HL,DE
0005F6 45F6 CD384A          17      CALL    ROM_READ
0005F9 45F9 ED5BD4F2        20      LD  DE,(_DTA)
0005FD 45FD 19              11      ADD HL,DE
0005FE 45FE E5              11      PUSH    HL
0005FF 45FF 2A76F6          16      LD  HL,(TXTTAB)
       4602                     ROM_LOAD2:          ;リンクポインタをFIX
000602 4602 E5              11      PUSH    HL
000603 4603 DDE1            14      POP IX
000605 4605 7E               7      LD  A,(HL)      ;リンクポインタL
000606 4606 23               6      INC HL
000607 4607 B6               7      OR  (HL)        ;リンクポインタH
000608 4608 23               6      INC HL
000609 4609 2837            12      JR  Z,RLOAD_END0
00060B 460B 23               6      INC HL      ;行番号
00060C 460C 23               6      INC HL      ;行番号
       460D                     ROM_LOAD3:
00060D 460D 7E               7      LD  A,(HL)
00060E 460E 23               6      INC HL
00060F 460F FE0B             7      CP  00BH        ;8進数(&O)
000611 4611 2822            12      JR  Z,INC_HL2
000613 4613 FE0C             7      CP  00CH        ;16進数(&H)
000615 4615 281E            12      JR  Z,INC_HL2
000617 4617 FE0D             7      CP  00DH        ;行番号(RUN後)
000619 4619 281A            12      JR  Z,INC_HL2
00061B 461B FE0E             7      CP  00EH        ;行番号(RUN前)
00061D 461D 2816            12      JR  Z,INC_HL2
00061F 461F FE0F             7      CP  00FH        ;10～255の整数(%)
000621 4621 2813            12      JR  Z,INC_HL1
000623 4623 FE1C             7      CP  01CH        ;256～65535の整数(%)
000625 4625 280E            12      JR  Z,INC_HL2
000627 4627 FE1D             7      CP  01DH        ;単精度実数(!)
000629 4629 2808            12      JR  Z,INC_HL4
00062B 462B FE1F             7      CP  01FH        ;倍制度実数(#)
00062D 462D 2008            12      JR  NZ,INC_HL0
00062F 462F 23               6      INC HL
000630 4630 23               6      INC HL
000631 4631 23               6      INC HL
000632 4632 23               6      INC HL
       4633                     INC_HL4:
000633 4633 23               6      INC HL
000634 4634 23               6      INC HL
       4635                     INC_HL2:
000635 4635 23               6      INC HL
       4636                     INC_HL1:
000636 4636 23               6      INC HL
       4637                     INC_HL0:
000637 4637 B7               4      OR  A
000638 4638 20D3            12      JR  NZ,ROM_LOAD3
00063A 463A DD7500          19      LD  (IX+0),L
00063D 463D DD7401          19      LD  (IX+1),H
000640 4640 18C0            12      JR  ROM_LOAD2
       4642                     RLOAD_END0:
000642 4642 E1              10      POP HL
       4643                     RLOAD_END1:
000643 4643 22C2F6          16      LD  (VARTAB),HL
000646 4646 22C4F6          16      LD  (ARYTAB),HL
000649 4649 22C6F6          16      LD  (STREND),HL
                                
00064C 464C 3ABEFC          13      LD  A,(RUNBNF)
00064F 464F CD554C          17      CALL    CAP
000652 4652 FE52             7      CP  'R'
000654 4654 280E            12      JR  Z,RLOAD_END2
000656 4656 AF               4      XOR A
000657 4657 21DCF2          10      LD  HL,_BUF+3
00065A 465A 77               7      LD  (HL),A      ;3
00065B 465B 2B               6      DEC HL
00065C 465C 77               7      LD  (HL),A      ;2
00065D 465D 2B               6      DEC HL
00065E 465E 77               7      LD  (HL),A      ;1
00065F 465F 2B               6      DEC HL
000660 4660 3E8F             7      LD  A,08FH      ;REM
000662 4662 77               7      LD  (HL),A      ;0
000663 4663 C9              10      RET
       4664                     RLOAD_END2:
000664 4664 D5              11      PUSH    DE
000665 4665 ED5B76F6        20      LD  DE,(TXTTAB)
000669 4669 1B               6      DEC DE
00066A 466A AF               4      XOR A
00066B 466B 21DFF2          10      LD  HL,_BUF+6
00066E 466E 77               7      LD  (HL),A      ;6
00066F 466F 2B               6      DEC HL
000670 4670 77               7      LD  (HL),A      ;5
000671 4671 2B               6      DEC HL
000672 4672 77               7      LD  (HL),A      ;4
000673 4673 2B               6      DEC HL
000674 4674 72               7      LD  (HL),D      ;3 行番号H
000675 4675 2B               6      DEC HL
000676 4676 73               7      LD  (HL),E      ;2 行番号L
000677 4677 2B               6      DEC HL
000678 4678 360D            10      LD  (HL),00DH   ;1 行番号(RUN後)
00067A 467A 2B               6      DEC HL
00067B 467B 3E89             7      LD  A,089H      ;GOTO
00067D 467D 77               7      LD  (HL),A      ;0
00067E 467E D1              10      POP DE
00067F 467F C9              10      RET
                                
       4680                     ERROR_DIRECT_IN_FILE:
000680 4680 1E39             7      LD  E,57            ;Direct statement in file
000682 4682 01                      DB  1           ;LD BC,
       4683                     ERROR_DEVICE_IO_ERROR:
000683 4683 1E13             7      LD  E,19            ;Device I/O error
000685 4685 01                      DB  1           ;LD BC,
       4686                     ERROR_INTERNAL_ERROR:
000686 4686 1E33             7      LD  E,51            ;Internal error
000688 4688 01                      DB  1           ;LD BC,
       4689                     ERROR_FILE_NOT_OPEN:
000689 4689 1E3B             7      LD  E,59            ;File not OPEN
00068B 468B 01                      DB  1           ;LD BC,
       468C                     ERROR_FILE_NOT_FOUND:
00068C 468C 1E35             7      LD  E,53            ;File not found
       468E                     ERROR:
00068E 468E FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000692 4692 DD216F40        14      LD  IX,ERRHAND
000696 4696 C31C00          10      JP  _CALSLT
                                
       4699                     ROM_BLOAD:
000699 4699 CDE647          17      CALL    INIT_PARAM
00069C 469C CDD94A          17      CALL    FILE_B
00069F 469F CD6B4C          17      CALL    ROM_OPEN
0006A2 46A2 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
0006A4 46A4 21D9F2          10      LD  HL,_BUF
0006A7 46A7 22D4F2          16      LD  (_DTA),HL
0006AA 46AA 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
0006AD 46AD CD384A          17      CALL    ROM_READ
0006B0 46B0 3AD9F2          13      LD  A,(_BUF)
0006B3 46B3 FEFE             7      CP  0FEH
0006B5 46B5 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
0006B7 46B7 21A5F2          10      LD  HL,BLOAD_RET
0006BA 46BA 229DF2          16      LD  (SWC_BLOAD),HL
                                
0006BD 46BD 2AF4F2          16      LD  HL,(PARAM1)
0006C0 46C0 7E               7      LD  A,(HL)
0006C1 46C1 FE2C             7      CP  ','
0006C3 46C3 2049            12      JR  NZ,RBREAD_MEM
0006C5 46C5 23               6      INC HL
0006C6 46C6 7E               7      LD  A,(HL)
0006C7 46C7 CD554C          17      CALL    CAP
0006CA 46CA 32BEFC          13      LD  (RUNBNF),A
0006CD 46CD FE52             7      CP  'R'     ;R,Sスイッチじゃ無い場合はオフセット値として処理する
0006CF 46CF 2808            12      JR  Z,RBOS1
0006D1 46D1 FE53             7      CP  'S'
0006D3 46D3 2804            12      JR  Z,RBOS1
0006D5 46D5 FE2C             7      CP  ','
0006D7 46D7 200D            12      JR  NZ,RBOS2
       46D9                     RBOS1:
0006D9 46D9 7E               7      LD  A,(HL)
0006DA 46DA 23               6      INC HL
0006DB 46DB B7               4      OR  A
0006DC 46DC 2824            12      JR  Z,RBREAD_OSE
0006DE 46DE FE3A             7      CP  ':'
0006E0 46E0 2820            12      JR  Z,RBREAD_OSE
0006E2 46E2 FE2C             7      CP  ','     ;次のパラメータを探す
0006E4 46E4 20F3            12      JR  NZ,RBOS1
       46E6                     RBOS2:              ;オフセット
0006E6 46E6 22F4F2          16      LD  (PARAM1),HL
0006E9 46E9 7E               7      LD  A,(HL)
0006EA 46EA B7               4      OR  A
0006EB 46EB 2815            12      JR  Z,RBREAD_OSE
0006ED 46ED DD212F54        14      LD  IX,FRMQNT
0006F1 46F1 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0006F5 46F5 CD1C00          17      CALL    _CALSLT
0006F8 46F8 22F4F2          16      LD  (PARAM1),HL
0006FB 46FB 2ADAF2          16      LD  HL,(_BUF_ST)
0006FE 46FE 19              11      ADD HL,DE
0006FF 46FF 22DAF2          16      LD  (_BUF_ST),HL
       4702                     RBREAD_OSE:
000702 4702 3ABEFC          13      LD  A,(RUNBNF)
000705 4705 FE53             7      CP  'S'
000707 4707 2005            12      JR  NZ,RBREAD_MEM
000709 4709 3E01             7      LD  A,1
00070B 470B 32D6F2          13      LD  (FLG_LDIR),A
       470E                     RBREAD_MEM:
00070E 470E 2ADAF2          16      LD  HL,(_BUF_ST)
000711 4711 22BFFC          16      LD  (SAVENT),HL
000714 4714 22D4F2          16      LD  (_DTA),HL
000717 4717 21FFFF          10      LD  HL,0FFFFH
00071A 471A CD384A          17      CALL    ROM_READ
00071D 471D AF               4      XOR A
00071E 471E 32D6F2          13      LD  (FLG_LDIR),A
000721 4721 3ABEFC          13      LD  A,(RUNBNF)
000724 4724 FE52             7      CP  'R'
000726 4726 2006            12      JR  NZ,RBREAD1
000728 4728 2ADEF2          16      LD  HL,(_BUF_EX)
00072B 472B 229DF2          16      LD  (SWC_BLOAD),HL
       472E                     RBREAD1:
       472E                     ROM_NEXT:
00072E 472E 2AF4F2          16      LD  HL,(PARAM1)
000731 4731 7E               7      LD  A,(HL)
000732 4732 2B               6      DEC HL
000733 4733 B7               4      OR  A
000734 4734 2805            12      JR  Z,ROM_NEXT1
000736 4736 FE3A             7      CP  ':'
000738 4738 2801            12      JR  Z,ROM_NEXT1
00073A 473A 23               6      INC HL
       473B                     ROM_NEXT1:
00073B 473B 5D               4      LD  E,L
00073C 473C 54               4      LD  D,H
                                
00073D 473D CD2B4C          17      CALL    SEARCH_END
000740 4740 B7               4      OR  A
000741 4741 2821            12      JR  Z,REM
       4743                     RN3:                    ;マルチステートメントの処理
000743 4743 7E               7      LD  A,(HL)
                                
000744 4744 FEB5             7      CP  0B5H            ;LOAD
000746 4746 CAB745          10      JP  Z,ROM_LOAD
000749 4749 FE8A             7      CP  08AH            ;RUN
00074B 474B 281B            12      JR  Z,ROM_RUN
00074D 474D FEB7             7      CP  0B7H            ;FILES
00074F 474F 2825            12      JR  Z,ROM_FILES
000751 4751 FED6             7      CP  0D6H            ;COPY
000753 4753 CA1848          10      JP  Z,ROM_COPY
000756 4756 FE20             7      CP  020H
000758 4758 2807            12      JR  Z,RN_SP
                                
00075A 475A 3E28             7      LD  A,028H          ;JR Z,
00075C 475C 32A3F2          13      LD  (SWC_BLOAD_M),A
00075F 475F 7E               7      LD  A,(HL)
000760 4760 C9              10      RET
       4761                     RN_SP:
000761 4761 23               6      INC HL
000762 4762 18DF            12      JR  RN3
                                
       4764                     REM:
000764 4764 EB               4      EX  DE,HL
000765 4765 3E8F             7      LD  A,08FH          ;REM
000767 4767 C9              10      RET
                                
       4768                     ROM_RUN:
000768 4768 23               6      INC HL
000769 4769 7E               7      LD  A,(HL)
00076A 476A 2B               6      DEC HL
00076B 476B B7               4      OR  A
00076C 476C C4B745          17      CALL    NZ,ROM_LOAD
00076F 476F FE8F             7      CP  08FH            ;REM
000771 4771 3E8A             7      LD  A,08AH          ;RUN
000773 4773 C0              11      RET NZ
000774 4774 77               7      LD  (HL),A
000775 4775 C9              10      RET
                                
       4776                     ROM_FILES:
000776 4776 CDE647          17      CALL    INIT_PARAM
000779 4779 CDD94A          17      CALL    FILE_B
00077C 477C CD6D53          17      CALL    GET_DISK_BANK_FDRV
00077F 477F 3AC9F2          13      LD  A,(SECSZ_H)
000782 4782 CD2B52          17      CALL    IS_BPB1
000785 4785 DA8346          10      JP  C,ERROR_DEVICE_IO_ERROR
000788 4788 3AF9F2          13      LD  A,(FNAME)
00078B 478B FE21             7      CP  021H
00078D 478D 3005            12      JR  NC,RFILES0
00078F 478F 060B             7      LD  B,11
000791 4791 CDBF4B          17      CALL    FILE10
       4794                     RFILES0:
000794 4794 CDC74E          17      CALL    GET_DIR_DAT
       4797                     RFILES1:
000797 4797 CD874C          17      CALL    FILESE
00079A 479A 3045            12      JR  NC,RFILES_NOT_MATCH
       479C                     RFILES_DISP:
00079C 479C E5              11      PUSH    HL
00079D 479D 110B00          10      LD  DE,0000BH   ;属性
0007A0 47A0 19              11      ADD HL,DE
                                #if exists USE_MORMAL32K_OR_ASCII16
0007A1 47A1 CD9B43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
0007A4 47A4 E1              10      POP HL
0007A5 47A5 CB4F             8      BIT 1,A     ;不可視属性
0007A7 47A7 2035            12      JR  NZ,RFILES_NEXT
0007A9 47A9 E5              11      PUSH    HL
0007AA 47AA 0608             7      LD  B,8
0007AC 47AC CD8F43          17      CALL    MSN
                                #if exists USE_MORMAL32K_OR_ASCII16
0007AF 47AF CD9B43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
0007B2 47B2 FE20             7      CP  020H
0007B4 47B4 F5              11      PUSH    AF
0007B5 47B5 3E2E             7      LD  A,'.'
0007B7 47B7 C4E353          17      CALL    NZ,MSG_A
0007BA 47BA 0603             7      LD  B,3
0007BC 47BC CD8F43          17      CALL    MSN
0007BF 47BF F1              10      POP AF
0007C0 47C0 CCE353          17      CALL    Z,MSG_A
0007C3 47C3 3ADDF3          13      LD  A,(CSRX)
0007C6 47C6 47               4      LD  B,A
0007C7 47C7 3AB0F3          13      LD  A,(LINLEN)
0007CA 47CA 90               4      SUB B
0007CB 47CB FE0C             7      CP  12
0007CD 47CD 3009            12      JR  NC,RFILES2
0007CF 47CF 3E0D             7      LD  A,00DH      ;改行
0007D1 47D1 CDE353          17      CALL    MSG_A
0007D4 47D4 3E0A             7      LD  A,00AH
0007D6 47D6 1802            12      JR  RFILES3
       47D8                     RFILES2:
0007D8 47D8 3E20             7      LD  A,020H
       47DA                     RFILES3:
0007DA 47DA CDE353          17      CALL    MSG_A
0007DD 47DD E1              10      POP HL
       47DE                     RFILES_NEXT:
0007DE 47DE CDA54C          17      CALL    FNEXT
       47E1                     RFILES_NOT_MATCH:
0007E1 47E1 20B4            12      JR  NZ,RFILES1
0007E3 47E3 C32E47          10      JP  ROM_NEXT
                                
       47E6                     INIT_PARAM:
0007E6 47E6 22F2F2          16      LD  (PARAM0),HL
0007E9 47E9 22F4F2          16      LD  (PARAM1),HL
0007EC 47EC EB               4      EX  DE,HL
0007ED 47ED 32BEFC          13      LD  (RUNBNF),A
0007F0 47F0 3263F6          13      LD  (VALTYP),A
0007F3 47F3 E5              11      PUSH    HL
0007F4 47F4 2AEBF2          16      LD  HL,(_CD)
0007F7 47F7 22F6F2          16      LD  (_CDX),HL
0007FA 47FA E1              10      POP HL
0007FB 47FB 13               6      INC DE
0007FC 47FC CDFB4B          17      CALL    SPCUT
0007FF 47FF 1A               7      LD  A,(DE)
000800 4800 B7               4      OR  A
000801 4801 C8              11      RET Z
000802 4802 FE3A             7      CP  ':'
000804 4804 C8              11      RET Z
000805 4805 FE28             7      CP  '('
000807 4807 C8              11      RET Z
000808 4808 EB               4      EX  DE,HL
000809 4809 DD21644C        14      LD  IX,FRMEVL
00080D 480D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000811 4811 CD1C00          17      CALL    _CALSLT
000814 4814 22F4F2          16      LD  (PARAM1),HL
000817 4817 C9              10      RET
                                
       4818                     ROM_COPY:
000818 4818 CDE647          17      CALL    INIT_PARAM
00081B 481B 3A63F6          13      LD  A,(VALTYP)
00081E 481E FE03             7      CP  3       ;string
000820 4820 C2D44A          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
000823 4823 CDD94A          17      CALL    FILE_B
000826 4826 CD6B4C          17      CALL    ROM_OPEN
000829 4829 DA8C46          10      JP  C,ERROR_FILE_NOT_FOUND
                                
00082C 482C 21DEF2          10      LD  HL,_BUF_W
00082F 482F 22D4F2          16      LD  (_DTA),HL
000832 4832 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
000835 4835 CD384A          17      CALL    ROM_READ
                                
000838 4838 AF               4      XOR A
000839 4839 32D9F2          13      LD  (_BUF_LO),A     ;PSET
00083C 483C 32E6F2          13      LD  (_BUF_O),A      ;向き
                                
00083F 483F 2AF4F2          16      LD  HL,(PARAM1)
       4842                     RCP_PARAM1:
000842 4842 7E               7      LD  A,(HL)
000843 4843 23               6      INC HL
000844 4844 B7               4      OR  A
000845 4845 CA3B47          10      JP  Z,ROM_NEXT1
000848 4848 FE3A             7      CP  ':'
00084A 484A CA3B47          10      JP  Z,ROM_NEXT1
00084D 484D FE2C             7      CP  ','
00084F 484F 2012            12      JR  NZ,RCP_PARAM1_
                                
000851 4851 DD212F54        14      LD  IX,FRMQNT
000855 4855 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000859 4859 CD1C00          17      CALL    _CALSLT
00085C 485C 7B               4      LD  A,E
00085D 485D 87               4      ADD A,A
00085E 485E 87               4      ADD A,A
00085F 485F 32E6F2          13      LD  (_BUF_O),A
000862 4862 7E               7      LD  A,(HL)
       4863                     RCP_PARAM1_:
000863 4863 FE28             7      CP  '('
000865 4865 20DB            12      JR  NZ,RCP_PARAM1
000867 4867 DD212F54        14      LD  IX,FRMQNT
00086B 486B FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00086F 486F CD1C00          17      CALL    _CALSLT
                                
000872 4872 ED53E2F2        20      LD  (_BUF_X),DE
                                
       4876                     RCP_PARAM2:
000876 4876 23               6      INC HL
000877 4877 7E               7      LD  A,(HL)
000878 4878 FE20             7      CP  020H
00087A 487A 28FA            12      JR  Z,RCP_PARAM2
00087C 487C FE2C             7      CP  ','
00087E 487E 28F6            12      JR  Z,RCP_PARAM2
                                
000880 4880 DD212F54        14      LD  IX,FRMQNT
000884 4884 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000888 4888 CD1C00          17      CALL    _CALSLT
                                
00088B 488B 3AF6FA          13      LD  A,(ACPAGE)
00088E 488E 57               4      LD  D,A
00088F 488F ED53E4F2        20      LD  (_BUF_Y),DE
       4893                     RCP_PARAM3:
000893 4893 23               6      INC HL
000894 4894 7E               7      LD  A,(HL)
000895 4895 FE20             7      CP  020H
000897 4897 28FA            12      JR  Z,RCP_PARAM3
000899 4899 FE29             7      CP  ')'
00089B 489B 28F6            12      JR  Z,RCP_PARAM3
00089D 489D FE2C             7      CP  ','
00089F 489F 2033            12      JR  NZ,RCP_ST
                                
0008A1 48A1 23               6      INC HL
0008A2 48A2 DD212F54        14      LD  IX,FRMQNT
0008A6 48A6 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0008AA 48AA CD1C00          17      CALL    _CALSLT
                                
0008AD 48AD 7B               4      LD  A,E
0008AE 48AE 32E5F2          13      LD  (_BUF_P),A
                                
       48B1                     RCP_PARAM4:
0008B1 48B1 7E               7      LD  A,(HL)
0008B2 48B2 23               6      INC HL
0008B3 48B3 FE20             7      CP  020H
0008B5 48B5 28FA            12      JR  Z,RCP_PARAM4
                                
0008B7 48B7 FE2C             7      CP  ','
0008B9 48B9 2019            12      JR  NZ,RCP_ST
                                
0008BB 48BB 7E               7      LD  A,(HL)
0008BC 48BC 0604             7      LD  B,4
0008BE 48BE FEC3             7      CP  0C3H        ;PRESET
0008C0 48C0 280E            12      JR  Z,RCP_LO
0008C2 48C2 05               4      DEC B       ;3
0008C3 48C3 D6F8             7      SUB 0F8H        ;XOR
0008C5 48C5 2809            12      JR  Z,RCP_LO
0008C7 48C7 05               4      DEC B       ;2
0008C8 48C8 3C               4      INC A       ;OR
0008C9 48C9 2805            12      JR  Z,RCP_LO
0008CB 48CB 05               4      DEC B       ;1
0008CC 48CC 3C               4      INC A       ;AND
0008CD 48CD 2801            12      JR  Z,RCP_LO
0008CF 48CF 05               4      DEC B       ;0
                                                ;PSET
       48D0                     RCP_LO:
0008D0 48D0 78               4      LD  A,B
0008D1 48D1 32D9F2          13      LD  (_BUF_LO),A
       48D4                     RCP_ST:
0008D4 48D4 2AC6F6          16      LD  HL,(STREND)
0008D7 48D7 22D4F2          16      LD  (_DTA),HL
0008DA 48DA EB               4      EX  DE,HL
0008DB 48DB 2100FE          10      LD  HL,-512
0008DE 48DE 39              11      ADD HL,SP
0008DF 48DF AF               4      XOR A
0008E0 48E0 ED52            15      SBC HL,DE
0008E2 48E2 3008            12      JR  NC,RCP0
0008E4 48E4 215EF5          10      LD  HL,BUF
0008E7 48E7 22D4F2          16      LD  (_DTA),HL
0008EA 48EA 6F               4      LD  L,A ;0
0008EB 48EB 67               4      LD  H,A ;0
       48EC                     RCP0:
0008EC 48EC 24               4      INC H
0008ED 48ED 22DCF2          16      LD  (_BUF_EN),HL
       48F0                     RCP1:
0008F0 48F0 F3               4      DI
0008F1 48F1 CDC649          17      CALL    WAIT_VDP
                                
0008F4 48F4 3A0700          13      LD  A,(WRVDP)
0008F7 48F7 4F               4      LD  C,A
0008F8 48F8 0C               4      INC C       ;C := PORT#1's address(WR)
0008F9 48F9 3E24             7      LD  A,36
0008FB 48FB ED79            12      OUT (C),A
0008FD 48FD 3E91             7      LD  A,080H+17
0008FF 48FF ED79            12      OUT (C),A       ;R#17 := 36
                                
000901 4901 0C               4      INC C
000902 4902 0C               4      INC C       ;C := PORT#3's address(WR)
000903 4903 2AE2F2          16      LD  HL,(_BUF_X)
000906 4906 ED69            12      OUT (C),L       ;R#36 DX
000908 4908 ED61            12      OUT (C),H       ;R#37
00090A 490A 2AE4F2          16      LD  HL,(_BUF_Y)
00090D 490D ED69            12      OUT (C),L       ;R#38 DY
00090F 490F ED61            12      OUT (C),H       ;R#39
000911 4911 2ADEF2          16      LD  HL,(_BUF_W)
000914 4914 ED69            12      OUT (C),L       ;R#40 NX
000916 4916 ED61            12      OUT (C),H       ;R#41
000918 4918 2AE0F2          16      LD  HL,(_BUF_H)
00091B 491B ED69            12      OUT (C),L       ;R#42 NY
00091D 491D ED61            12      OUT (C),H       ;R#43
                                
00091F 491F DD2AAFFC        20      LD  IX,(SCRMOD)
000923 4923 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000926 4926 B7               4      OR  A
000927 4927 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000929 4929 DD7D             9      LD  A,IXL
00092B 492B FE08             7      CP  8
00092D 492D 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
00092F 492F FE06             7      CP  6
000931 4931 2AE2F2          16      LD  HL,(_BUF_X)
000934 4934 3ADEF2          13      LD  A,(_BUF_W)
000937 4937 2005            12      JR  NZ,SCR57
000939 4939 B5               4      OR  L       ;スクリーン6
00093A 493A E603             7      AND 3
00093C 493C 200D            12      JR  NZ,USE_LMMC
       493E                     SCR57:              ;スクリーン5,7
00093E 493E B5               4      OR  L
00093F 493F E601             7      AND 1
000941 4941 2008            12      JR  NZ,USE_LMMC
       4943                     USE_HMMC:
000943 4943 DD2E08          10      LD  IXL,8
       4946                     USE_HMMC8:
000946 4946 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
000948 4948 32D9F2          13      LD  (_BUF_LO),A
       494B                     USE_LMMC:
00094B 494B 110000          10      LD  DE,0
00094E 494E 06FF             7      LD  B,-1
000950 4950 CDF149          17      CALL    GET_PIXEL
000953 4953 ED79            12      OUT (C),A       ;R#44 first DATA
000955 4955 3AE6F2          13      LD  A,(_BUF_O)
000958 4958 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
00095A 495A 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00095D 495D F6B0             7      OR  0B0H        ;R#46 LMMC command
00095F 495F ED79            12      OUT (C),A
                                
000961 4961 FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
000963 4963 0D               4      DEC C
000964 4964 0D               4      DEC C       ;C := PORT#1's address(WR)
000965 4965 3EAC             7      LD  A,080H+44
000967 4967 ED79            12      OUT (C),A
000969 4969 3E91             7      LD  A,080H+17
00096B 496B ED79            12      OUT (C),A       ;R#17 := 44
                                
00096D 496D 3A0600          13      LD  A,(RDVDP)
000970 4970 3C               4      INC A
000971 4971 FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
000973 4973 3E02             7      LD  A,2
000975 4975 ED79            12      OUT (C),A
000977 4977 3E8F             7      LD  A,08FH
000979 4979 ED79            12      OUT (C),A
00097B 497B 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00097E 497E E640             7      AND 040H
000980 4980 201C            12      JR  NZ,LOOP_HMMC
       4982                     LOOP_COPY:
000982 4982 CDF149          17      CALL    GET_PIXEL
000985 4985 08               4      EX  AF,AF'
000986 4986 FD4C             9      LD  C,IYH
       4988                     LOOP_COPY1:
000988 4988 ED78            12      IN  A,(C)
00098A 498A 0F               4      RRCA            ;RRCAではサインフラグは変化しない
00098B 498B 300A            12      JR  NC,EXIT_COPY    ;check CE bit
00098D 498D F28849          10      JP  P,LOOP_COPY1    ;check TR bit
000990 4990 08               4      EX  AF,AF'
000991 4991 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000993 4993 ED79            12      OUT (C),A
000995 4995 18EB            12      JR  LOOP_COPY
                                
       4997                     EXIT_COPY:
000997 4997 CDCE49          17      CALL    GET_STATUS_0
00099A 499A FB               4      EI
00099B 499B C32E47          10      JP  ROM_NEXT
                                
       499E                     LOOP_HMMC:
00099E 499E F3               4      DI          ;必要
00099F 499F FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
0009A1 49A1 43               4      LD  B,E
0009A2 49A2 7B               4      LD  A,E
0009A3 49A3 B7               4      OR  A
0009A4 49A4 2802            12      JR  Z,LOOP_HMMC1
0009A6 49A6 EDB3                    OTIR
       49A8                     LOOP_HMMC1:
0009A8 49A8 14               4      INC D
       49A9                     LOOP_HMMC2:
0009A9 49A9 15               4      DEC D
0009AA 49AA 2805            12      JR  Z,LOOP_HMMC3
0009AC 49AC EDB3                    OTIR
0009AE 49AE C3A949          10      JP  LOOP_HMMC2
       49B1                     LOOP_HMMC3:
0009B1 49B1 ED78            12      IN  A,(C)
0009B3 49B3 0F               4      RRCA
0009B4 49B4 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
0009B6 49B6 2ADCF2          16      LD  HL,(_BUF_EN)
0009B9 49B9 CD384A          17      CALL    ROM_READ
0009BC 49BC EB               4      EX  DE,HL
0009BD 49BD 2AD4F2          16      LD  HL,(_DTA)
0009C0 49C0 7A               4      LD  A,D
0009C1 49C1 B3               4      OR  E
0009C2 49C2 20DA            12      JR  NZ,LOOP_HMMC
0009C4 49C4 18C2            12      JR  LOOP_COPY1
                                    
       49C6                     WAIT_VDP:
0009C6 49C6 3E02             7      LD  A,2
0009C8 49C8 CDCF49          17      CALL    GET_STATUS
0009CB 49CB 0F               4      RRCA
0009CC 49CC 38F8            12      JR  C,WAIT_VDP
       49CE                     GET_STATUS_0:
0009CE 49CE AF               4      XOR A
       49CF                     GET_STATUS:
0009CF 49CF C5              11      PUSH    BC
0009D0 49D0 ED4B0600        20      LD  BC,(RDVDP)
0009D4 49D4 0C               4      INC C
0009D5 49D5 ED79            12      OUT (C),A
0009D7 49D7 3E8F             7      LD  A,08FH
0009D9 49D9 ED79            12      OUT (C),A
0009DB 49DB ED78            12      IN  A,(C)
0009DD 49DD C1              10      POP BC
0009DE 49DE C9              10      RET
                                
       49DF                     GET_PIXEL256:
0009DF 49DF 7A               4      LD  A,D
0009E0 49E0 B3               4      OR  E
0009E1 49E1 200A            12      JR  NZ,GET_PIXEL1
0009E3 49E3 2ADCF2          16      LD  HL,(_BUF_EN)
0009E6 49E6 CD384A          17      CALL    ROM_READ
0009E9 49E9 EB               4      EX  DE,HL
0009EA 49EA 2AD4F2          16      LD  HL,(_DTA)
       49ED                     GET_PIXEL1:
0009ED 49ED 7E               7      LD  A,(HL)
0009EE 49EE 23               6      INC HL
0009EF 49EF 1B               6      DEC DE
0009F0 49F0 C9              10      RET
                                
       49F1                     GET_PIXEL:
0009F1 49F1 DD7D             9      LD  A,IXL
0009F3 49F3 FE08             7      CP  8
0009F5 49F5 28E8            12      JR  Z,GET_PIXEL256
0009F7 49F7 04               4      INC B
0009F8 49F8 FE06             7      CP  6
0009FA 49FA 282E            12      JR  Z,GET_PIXEL4
                                
0009FC 49FC CB40             8      BIT 0,B
0009FE 49FE 20ED            12      JR  NZ,GET_PIXEL1
                                
000A00 4A00 7A               4      LD  A,D
000A01 4A01 B3               4      OR  E
000A02 4A02 200A            12      JR  NZ,GET_PIXEL2
                                
000A04 4A04 2ADCF2          16      LD  HL,(_BUF_EN)
000A07 4A07 CD384A          17      CALL    ROM_READ
000A0A 4A0A EB               4      EX  DE,HL
000A0B 4A0B 2AD4F2          16      LD  HL,(_DTA)
                                
       4A0E                     GET_PIXEL2:
000A0E 4A0E 7E               7      LD  A,(HL)
000A0F 4A0F 0F               4      RRCA
000A10 4A10 0F               4      RRCA
000A11 4A11 0F               4      RRCA
000A12 4A12 0F               4      RRCA
000A13 4A13 C9              10      RET
                                
       4A14                     GET_PIXEL3:
000A14 4A14 7A               4      LD  A,D
000A15 4A15 B3               4      OR  E
000A16 4A16 200A            12      JR  NZ,GET_PIXEL5
                                
000A18 4A18 2ADCF2          16      LD  HL,(_BUF_EN)
000A1B 4A1B CD384A          17      CALL    ROM_READ
000A1E 4A1E EB               4      EX  DE,HL
000A1F 4A1F 2AD4F2          16      LD  HL,(_DTA)
       4A22                     GET_PIXEL5:
000A22 4A22 7E               7      LD  A,(HL)
000A23 4A23 0F               4      RRCA
000A24 4A24 0F               4      RRCA
000A25 4A25 0F               4      RRCA
000A26 4A26 0F               4      RRCA
000A27 4A27 0F               4      RRCA
000A28 4A28 0F               4      RRCA
000A29 4A29 C9              10      RET
                                
       4A2A                     GET_PIXEL4:
000A2A 4A2A 78               4      LD  A,B
000A2B 4A2B E603             7      AND 3   ;+0
000A2D 4A2D 28E5            12      JR  Z,GET_PIXEL3
000A2F 4A2F 3D               4      DEC A   ;+1
000A30 4A30 28DC            12      JR  Z,GET_PIXEL2
000A32 4A32 3D               4      DEC A   ;+2
000A33 4A33 7E               7      LD  A,(HL)
000A34 4A34 C0              11      RET NZ
000A35 4A35 0F               4      RRCA        ;+3
000A36 4A36 0F               4      RRCA
000A37 4A37 C9              10      RET
                                
       4A38                     ROM_READ:
000A38 4A38 E5              11      PUSH    HL
000A39 4A39 D5              11      PUSH    DE
000A3A 4A3A C5              11      PUSH    BC
000A3B 4A3B FDE5            15      PUSH    IY
000A3D 4A3D 22F0F2          16      LD  (LEFTX),HL
000A40 4A40 2AD4F2          16      LD  HL,(_DTA)
000A43 4A43 22E7F2          16      LD  (DTAX),HL
000A46 4A46 2AF0F2          16      LD  HL,(LEFTX)
                                
000A49 4A49 CDEC4C          17      CALL    RBX1
000A4C 4A4C 3870            12      JR  C,RBRERR1
000A4E 4A4E 79               4      LD  A,C
000A4F 4A4F EB               4      EX  DE,HL
000A50 4A50 ED52            15      SBC HL,DE       ;CP 0HL,CDE
000A52 4A52 19              11      ADD HL,DE
000A53 4A53 DE00             7      SBC A,000H
000A55 4A55 3801            12      JR  C,RBR1
000A57 4A57 EB               4      EX  DE,HL
       4A58                     RBR1:
000A58 4A58 9F               4      SBC A,A
000A59 4A59 E601             7      AND 1
000A5B 4A5B 32C3F2          13      LD  (_RESULT),A
000A5E 4A5E 7C               4      LD  A,H
000A5F 4A5F B5               4      OR  L
000A60 4A60 CAB44A          10      JP  Z,RBREND0
                                
000A63 4A63 22D0F2          16      LD  (_LEFT),HL  ;Read record byte
000A66 4A66 22F0F2          16      LD  (LEFTX),HL
                                
000A69 4A69 CD1F4D          17      CALL    RBX2
000A6C 4A6C 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000A6E 4A6E CD324D          17      CALL    RBXA
000A71 4A71 DACA4A          10      JP  C,RBRERR
000A74 4A74 C5              11      PUSH    BC
000A75 4A75 CD0E44          17      CALL    ROM_LDIR
000A78 4A78 ED53E7F2        20      LD  (DTAX),DE
000A7C 4A7C 2AF0F2          16      LD  HL,(LEFTX)
000A7F 4A7F D1              10      POP DE
000A80 4A80 A7               4      AND A
000A81 4A81 ED52            15      SBC HL,DE
000A83 4A83 22F0F2          16      LD  (LEFTX),HL
000A86 4A86 2829            12      JR  Z,RBREND
                                
       4A88                     RBRB:
000A88 4A88 CD6B4D          17      CALL    RBXB
000A8B 4A8B 2818            12      JR  Z,RBRC
       4A8D                     RBRB1:
000A8D 4A8D C5              11      PUSH    BC
000A8E 4A8E D5              11      PUSH    DE
000A8F 4A8F CD1C4E          17      CALL    CLUST
000A92 4A92 EB               4      EX  DE,HL
000A93 4A93 ED4BC6F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000A97 4A97 CD0E44          17      CALL    ROM_LDIR
000A9A 4A9A EB               4      EX  DE,HL
000A9B 4A9B D1              10      POP DE
000A9C 4A9C C1              10      POP BC
000A9D 4A9D CDF94D          17      CALL    GNCL
000AA0 4AA0 DACA4A          10      JP  C,RBRERR
000AA3 4AA3 10E8            13      DJNZ    RBRB1
       4AA5                     RBRC:
000AA5 4AA5 CD834D          17      CALL    RBXC
000AA8 4AA8 2807            12      JR  Z,RBREND
                                
000AAA 4AAA CD1C4E          17      CALL    CLUST
000AAD 4AAD EB               4      EX  DE,HL
000AAE 4AAE CD0E44          17      CALL    ROM_LDIR
       4AB1                     RBREND:
000AB1 4AB1 CD8F4D          17      CALL    RBXEND
       4AB4                     RBREND0:
000AB4 4AB4 FDE1            14      POP IY
000AB6 4AB6 C1              10      POP BC
000AB7 4AB7 D1              10      POP DE
000AB8 4AB8 F1              10      POP AF  ;(HL)
000AB9 4AB9 AF               4      XOR A
000ABA 4ABA 3AC3F2          13      LD  A,(_RESULT)
000ABD 4ABD C9              10      RET
                                
       4ABE                     RBRERR1:
000ABE 4ABE 3E01             7      LD  A,001H
       4AC0                     RBRERR2:
000AC0 4AC0 FDE1            14      POP IY
000AC2 4AC2 C1              10      POP BC
000AC3 4AC3 D1              10      POP DE
000AC4 4AC4 E1              10      POP HL
000AC5 4AC5 37               4      SCF
000AC6 4AC6 210000          10      LD  HL,0
000AC9 4AC9 C9              10      RET
       4ACA                     RBRERR:
000ACA 4ACA 3EFF             7      LD  A,0FFH
000ACC 4ACC 18F2            12      JR  RBRERR2
                                
       4ACE                     FILE_DD:
000ACE 4ACE E1              10      POP HL
000ACF 4ACF 3E                      DB  03EH
000AD0 4AD0 C9              10      RET
000AD1 4AD1 32A3F2          13      LD  (SWC_BLOAD_M),A
       4AD4                     ROM_ORG:
000AD4 4AD4 2AF2F2          16      LD  HL,(PARAM0)
000AD7 4AD7 7E               7      LD  A,(HL)
000AD8 4AD8 C9              10      RET
       4AD9                     FILE_B:
000AD9 4AD9 AF               4      XOR A
000ADA 4ADA 32F8F2          13      LD  (FDRV),A
000ADD 4ADD 1E00             7      LD  E,0
000ADF 4ADF 3A63F6          13      LD  A,(VALTYP)
000AE2 4AE2 FE03             7      CP  3       ;string
000AE4 4AE4 C27C4B          10      JP  NZ,FILED
                                
000AE7 4AE7 DD21D067        14      LD  IX,FRESTR
000AEB 4AEB FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000AEF 4AEF CD1C00          17      CALL    _CALSLT
000AF2 4AF2 E5              11      PUSH    HL
000AF3 4AF3 DDE1            14      POP IX
                                
000AF5 4AF5 DD5E00          19      LD  E,(IX+0)
000AF8 4AF8 DD7E01          19      LD  A,(IX+1)
000AFB 4AFB DD5602          19      LD  D,(IX+2)
000AFE 4AFE DD62             9      LD  IXH,D
000B00 4B00 DD6F             9      LD  IXL,A
000B02 4B02 7B               4      LD  A,E
       4B03                     FILE_BDOS:
000B03 4B03 FE04             7      CP  4
000B05 4B05 3808            12      JR  C,FILEB1
000B07 4B07 DD7E03          19      LD  A,(IX+3)
000B0A 4B0A FE3A             7      CP  ':'
000B0C 4B0C 28C0            12      JR  Z,FILE_DD
000B0E 4B0E 7B               4      LD  A,E
       4B0F                     FILEB1:
000B0F 4B0F FE02             7      CP  2
000B11 4B11 3818            12      JR  C,DEVI1
000B13 4B13 DD7E01          19      LD  A,(IX+1)
000B16 4B16 FE3A             7      CP  ':'
000B18 4B18 2011            12      JR  NZ,DEVI1
000B1A 4B1A DD7E00          19      LD  A,(IX+0)        ;DRIVE
000B1D 4B1D CD554C          17      CALL    CAP
000B20 4B20 D640             7      SUB '@'
000B22 4B22 DD23            10      INC IX
000B24 4B24 DD23            10      INC IX
000B26 4B26 1D               4      DEC E
000B27 4B27 1D               4      DEC E
000B28 4B28 32F8F2          13      LD  (FDRV),A
       4B2B                     DEVI1:
000B2B 4B2B DD7E00          19      LD  A,(IX+0)
000B2E 4B2E D65C             7      SUB 05CH        ;\
000B30 4B30 2008            12      JR  NZ,NOROOT
000B32 4B32 6F               4      LD  L,A
000B33 4B33 67               4      LD  H,A
000B34 4B34 22F6F2          16      LD  (_CDX),HL
000B37 4B37 DD23            10      INC IX
000B39 4B39 1D               4      DEC E
       4B3A                     NOROOT:
                                
       4B3A                     SETDIR:
000B3A 4B3A CD7C4B          17      CALL    FILED
000B3D 4B3D DD7E00          19      LD  A,(IX+0)
000B40 4B40 FE5C             7      CP  05CH        ;\
000B42 4B42 C0              11      RET NZ
000B43 4B43 DD23            10      INC IX
000B45 4B45 1D               4      DEC E
000B46 4B46 3AF9F2          13      LD  A,(FNAME)
000B49 4B49 FE20             7      CP  020H        ;. の処理
000B4B 4B4B 28ED            12      JR  Z,SETDIR
                                
000B4D 4B4D CD6B4C          17      CALL    ROM_OPEN
000B50 4B50 B7               4      OR  A
000B51 4B51 C0              11      RET NZ
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
000B52 4B52 D5              11      PUSH    DE
000B53 4B53 2AEDF2          16      LD  HL,(DIRENT1)
000B56 4B56 110B00          10      LD  DE,0000BH   ;属性(アトリビュート)
000B59 4B59 19              11      ADD HL,DE
000B5A 4B5A CD9B43          17      CALL    RDSLT_ROM
000B5D 4B5D D1              10      POP DE
000B5E 4B5E CB67             8      BIT 4,A     ;ディレクトリ
                                #else
                                    LD  IY,(DIRENT1)
                                    BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000B60 4B60 C8              11      RET Z
000B61 4B61 CDC34B          17      CALL    FILEI
                                #if exists USE_MORMAL32K_OR_ASCII16
000B64 4B64 D5              11      PUSH    DE
000B65 4B65 2AEDF2          16      LD  HL,(DIRENT1)
000B68 4B68 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000B6B 4B6B 19              11      ADD HL,DE
000B6C 4B6C CD9B43          17      CALL    RDSLT_ROM
000B6F 4B6F 23               6      INC HL
000B70 4B70 5F               4      LD  E,A
000B71 4B71 CD9B43          17      CALL    RDSLT_ROM
000B74 4B74 57               4      LD  D,A
000B75 4B75 EB               4      EX  DE,HL
000B76 4B76 D1              10      POP DE
                                #else
                                    LD  L,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  H,(IY+01BH)
                                #endif
000B77 4B77 22F6F2          16      LD  (_CDX),HL
000B7A 4B7A 18BE            12      JR  SETDIR
                                
       4B7C                     FILED:
000B7C 4B7C CDC34B          17      CALL    FILEI
000B7F 4B7F 21F9F2          10      LD  HL,FNAME
                                
000B82 4B82 0608             7      LD  B,8
       4B84                     FILE2:
000B84 4B84 CDD04B          17      CALL    CCHKF
000B87 4B87 C8              11      RET Z
000B88 4B88 FE2A             7      CP  '*'
000B8A 4B8A 282E            12      JR  Z,FILE9
000B8C 4B8C FE2E             7      CP  '.'
000B8E 4B8E 280C            12      JR  Z,FILE4
000B90 4B90 77               7      LD  (HL),A
000B91 4B91 23               6      INC HL
000B92 4B92 10F0            13      DJNZ    FILE2
                                
       4B94                     FILE3:
000B94 4B94 CDD04B          17      CALL    CCHKF
000B97 4B97 C8              11      RET Z
000B98 4B98 FE2E             7      CP  '.'
000B9A 4B9A 20F8            12      JR  NZ,FILE3
                                
       4B9C                     FILE4:
000B9C 4B9C 2101F3          10      LD  HL,FNAME+8
000B9F 4B9F 0603             7      LD  B,3
                                
       4BA1                     FILE4L:
000BA1 4BA1 CDD04B          17      CALL    CCHKF
000BA4 4BA4 C8              11      RET Z
000BA5 4BA5 FE2E             7      CP  '.'
000BA7 4BA7 2008            12      JR  NZ,FILE12
000BA9 4BA9 32F9F2          13      LD  (FNAME),A   ;Parent directory(..)
000BAC 4BAC 32FAF2          13      LD  (FNAME+1),A
000BAF 4BAF 3E20             7      LD  A,020H
       4BB1                     FILE12:
000BB1 4BB1 FE2A             7      CP  '*'
000BB3 4BB3 280A            12      JR  Z,FILE10
000BB5 4BB5 77               7      LD  (HL),A
000BB6 4BB6 23               6      INC HL
000BB7 4BB7 10E8            13      DJNZ    FILE4L
000BB9 4BB9 C9              10      RET
                                
       4BBA                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000BBA 4BBA CDBF4B          17      CALL    FILE10
000BBD 4BBD 18D5            12      JR  FILE3
                                
       4BBF                     FILE10:
000BBF 4BBF 3E3F             7      LD  A,'?'
000BC1 4BC1 1808            12      JR  FILL_MEMORY
       4BC3                     FILEI:              ;名前＋拡張子をスペースで初期化
000BC3 4BC3 3E20             7      LD  A,020H
000BC5 4BC5 01000B          10      LD  BC,11*256   ;C=0にしておく
000BC8 4BC8 21F9F2          10      LD  HL,FNAME
       4BCB                     FILL_MEMORY:            ;HLからBバイトAで埋める
000BCB 4BCB 77               7      LD  (HL),A
000BCC 4BCC 23               6      INC HL
000BCD 4BCD 10FC            13      DJNZ    FILL_MEMORY
000BCF 4BCF C9              10      RET
                                
       4BD0                     CCHKF:
000BD0 4BD0 7B               4      LD  A,E
000BD1 4BD1 B7               4      OR  A
000BD2 4BD2 C8              11      RET Z
000BD3 4BD3 DD7E00          19      LD  A,(IX+0)
000BD6 4BD6 CDDD4B          17      CALL    CCHK2
000BD9 4BD9 C8              11      RET Z
000BDA 4BDA C3404C          10      JP  FKAN
                                
       4BDD                     CCHK2:
000BDD 4BDD 0C               4      INC C
000BDE 4BDE 0D               4      DEC C
000BDF 4BDF C0              11      RET NZ
       4BE0                     CCHK3:              ;ZF=1 で使えない文字
000BE0 4BE0 FE2B             7      CP  '+'
000BE2 4BE2 C8              11      RET Z
000BE3 4BE3 FE2C             7      CP  ','
000BE5 4BE5 C8              11      RET Z
000BE6 4BE6 FE2F             7      CP  '/'
000BE8 4BE8 C8              11      RET Z
000BE9 4BE9 FE3A             7      CP  ':'
000BEB 4BEB C8              11      RET Z
000BEC 4BEC FE3B             7      CP  ';'
000BEE 4BEE C8              11      RET Z
000BEF 4BEF FE3D             7      CP  '='
000BF1 4BF1 C8              11      RET Z
000BF2 4BF2 FE5C             7      CP  05CH    ;\
000BF4 4BF4 C8              11      RET Z
000BF5 4BF5 FE1F             7      CP  01FH
000BF7 4BF7 D0              11      RET NC
000BF8 4BF8 BF               4      CP  A       ;Z=1
000BF9 4BF9 C9              10      RET
                                
       4BFA                     SS1:
000BFA 4BFA 13               6      INC DE
       4BFB                     SPCUT:              ;スペースをカット
000BFB 4BFB 1A               7      LD  A,(DE)
000BFC 4BFC FE20             7      CP  020H
000BFE 4BFE 28FA            12      JR  Z,SS1
000C00 4C00 C9              10      RET
                                
       4C01                     SCREOF1:
000C01 4C01 13               6      INC DE
       4C02                     SPCUTEX:            ;スペース改行などをカット
000C02 4C02 1A               7      LD  A,(DE)
000C03 4C03 FE20             7      CP  020H
000C05 4C05 28FA            12      JR  Z,SCREOF1
000C07 4C07 FE0D             7      CP  00DH
000C09 4C09 28F6            12      JR  Z,SCREOF1
000C0B 4C0B FE0A             7      CP  00AH
000C0D 4C0D 28F2            12      JR  Z,SCREOF1
000C0F 4C0F FE1A             7      CP  01AH
000C11 4C11 28EE            12      JR  Z,SCREOF1
000C13 4C13 C9              10      RET
                                
       4C14                     GETNUM:
000C14 4C14 210000          10      LD  HL,0
       4C17                     GETNUM1:
000C17 4C17 1A               7      LD  A,(DE)
000C18 4C18 13               6      INC DE
000C19 4C19 D630             7      SUB '0'
000C1B 4C1B D8              11      RET C
000C1C 4C1C FE0A             7      CP  10
000C1E 4C1E D0              11      RET NC
000C1F 4C1F 4D               4      LD  C,L
000C20 4C20 44               4      LD  B,H
000C21 4C21 29              11      ADD HL,HL   ;*2
000C22 4C22 29              11      ADD HL,HL   ;*4
000C23 4C23 09              11      ADD HL,BC   ;*5
000C24 4C24 29              11      ADD HL,HL   ;*10
000C25 4C25 4F               4      LD  C,A
000C26 4C26 0600             7      LD  B,0
000C28 4C28 09              11      ADD HL,BC
000C29 4C29 18EC            12      JR  GETNUM1
                                
       4C2B                     SEARCH_END:
000C2B 4C2B 7E               7      LD  A,(HL)
       4C2C                     SEARCH_END1:
000C2C 4C2C 23               6      INC HL
000C2D 4C2D B7               4      OR  A
000C2E 4C2E C8              11      RET Z
000C2F 4C2F FE3A             7      CP  ':'
000C31 4C31 20F8            12      JR  NZ,SEARCH_END
000C33 4C33 7E               7      LD  A,(HL)
000C34 4C34 FE3A             7      CP  ':'
000C36 4C36 28F4            12      JR  Z,SEARCH_END1
000C38 4C38 C9              10      RET
                                
       4C39                     FKANC:
000C39 4C39 CB41             8      BIT 0,C
000C3B 4C3B CC5E4C          17      CALL    Z,CAP2
000C3E 4C3E 1803            12      JR  FKANX
       4C40                     FKAN:           ;漢字チェック
000C40 4C40 DD23            10      INC IX
000C42 4C42 1D               4      DEC E
       4C43                     FKANX:
000C43 4C43 CB41             8      BIT 0,C
000C45 4C45 CB81             8      RES 0,C
000C47 4C47 C0              11      RET NZ
000C48 4C48 FE80             7      CP  080H
000C4A 4C4A D8              11      RET C
000C4B 4C4B FEA0             7      CP  0A0H
000C4D 4C4D 3803            12      JR  C,FKAN1
000C4F 4C4F FEE0             7      CP  0E0H
000C51 4C51 D8              11      RET C
       4C52                     FKAN1:
000C52 4C52 0C               4      INC C
000C53 4C53 A7               4      AND A
000C54 4C54 C9              10      RET
                                
       4C55                     CAP:
000C55 4C55 FE61             7      CP  'a'
000C57 4C57 D8              11      RET C
000C58 4C58 FE7B             7      CP  'z'+1
000C5A 4C5A D0              11      RET NC
000C5B 4C5B D620             7      SUB 020H
000C5D 4C5D C9              10      RET
       4C5E                     CAP2:
000C5E 4C5E CD554C          17      CALL    CAP
       4C61                     CAP3:               ;
000C61 4C61 FE05             7      CP  5
000C63 4C63 2803            12      JR  Z,CAP4
000C65 4C65 FE21             7      CP  021H
000C67 4C67 C9              10      RET
       4C68                     CAP4:
000C68 4C68 3EE5             7      LD  A,0E5H
000C6A 4C6A C9              10      RET
                                
       4C6B                     ROM_OPEN:
000C6B 4C6B CD6D53          17      CALL    GET_DISK_BANK_FDRV
                                
000C6E 4C6E CDC74E          17      CALL    GET_DIR_DAT
000C71 4C71 D5              11      PUSH    DE
000C72 4C72 CD874C          17      CALL    FILESE
000C75 4C75 D1              10      POP DE
000C76 4C76 3F               4      CCF
000C77 4C77 D8              11      RET C
000C78 4C78 22EDF2          16      LD  (DIRENT1),HL
000C7B 4C7B E5              11      PUSH    HL
000C7C 4C7C 210000          10      LD  HL,0
000C7F 4C7F 22CAF2          16      LD  (RR_LOW),HL
000C82 4C82 22CCF2          16      LD  (RR_HIGH),HL
000C85 4C85 E1              10      POP HL
000C86 4C86 C9              10      RET
                                
       4C87                     FILESE:
       4C87                     FILESE0:
                                #if exists USE_MORMAL32K_OR_ASCII16
000C87 4C87 CD9B43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000C8A 4C8A B7               4      OR  A
000C8B 4C8B C8              11      RET Z       ;END:ZF=1 CF=0
000C8C 4C8C FEE5             7      CP  0E5H
000C8E 4C8E 280D            12      JR  Z,FILESE1
000C90 4C90 11F9F2          10      LD  DE,FNAME
000C93 4C93 E5              11      PUSH    HL
000C94 4C94 CDC34C          17      CALL    CPFILE
000C97 4C97 CCE64C          17      CALL    Z,CPFILE2
000C9A 4C9A E1              10      POP HL
000C9B 4C9B 37               4      SCF
000C9C 4C9C C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4C9D                     FILESE1:
000C9D 4C9D CDA54C          17      CALL    FNEXT
000CA0 4CA0 20E5            12      JR  NZ,FILESE0
000CA2 4CA2 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000CA4 4CA4 C9              10      RET
                                
       4CA5                     FNEXT:
000CA5 4CA5 112000          10      LD  DE,020H
000CA8 4CA8 19              11      ADD HL,DE
000CA9 4CA9 ED5BF6F2        20      LD  DE,(_CDX)
000CAD 4CAD 7A               4      LD  A,D
000CAE 4CAE B3               4      OR  E
000CAF 4CAF 2002            12      JR  NZ,FNEXT_SUBDIR
000CB1 4CB1 0D               4      DEC C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
                                    PUSH    AF      ;※フラグを保存する必要あり
                                    BIT 7,H
                                    JR  Z,CHECK_DIR_PAGE1
                                    LD  A,H
                                    SUB 020H
                                    LD  H,A
                                    LD  A,(_DIR_BANK)
                                    INC A
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_DIR_BANK),A
                                CHECK_DIR_PAGE1:
                                    POP AF
                                #endif
000CB2 4CB2 C9              10      RET
                                
       4CB3                     FNEXT_SUBDIR:           ;サブディレクトリ
000CB3 4CB3 0D               4      DEC C
000CB4 4CB4 C0              11      RET NZ
                                
000CB5 4CB5 ED5BF6F2        20      LD  DE,(_CDX)
000CB9 4CB9 CDF94D          17      CALL    GNCL
000CBC 4CBC EB               4      EX  DE,HL
000CBD 4CBD 22F6F2          16      LD  (_CDX),HL
000CC0 4CC0 C3004F          10      JP  GET_SUBDIR
                                
       4CC3                     CPFILE:
000CC3 4CC3 C5              11      PUSH    BC
000CC4 4CC4 01000B          10      LD  BC,00B00H
       4CC7                     CPSTR1:
000CC7 4CC7 1A               7      LD  A,(DE)
000CC8 4CC8 FE3F             7      CP  '?'     ;Wild card
000CCA 4CCA 2814            12      JR  Z,CPSTR2
                                #if exists USE_MORMAL32K_OR_ASCII16
000CCC 4CCC CD9B43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000CCF 4CCF CD394C          17      CALL    FKANC
000CD2 4CD2 E5              11      PUSH    HL
000CD3 4CD3 67               4      LD  H,A
000CD4 4CD4 1A               7      LD  A,(DE)
000CD5 4CD5 CB01             8      RLC C
000CD7 4CD7 CD394C          17      CALL    FKANC
000CDA 4CDA CB09             8      RRC C
000CDC 4CDC BC               4      CP  H       ;CP (HL),(DE)
000CDD 4CDD E1              10      POP HL
000CDE 4CDE 2004            12      JR  NZ,CPSTR3
       4CE0                     CPSTR2:
000CE0 4CE0 13               6      INC DE
000CE1 4CE1 23               6      INC HL
000CE2 4CE2 10E3            13      DJNZ    CPSTR1
       4CE4                     CPSTR3:
000CE4 4CE4 C1              10      POP BC
000CE5 4CE5 C9              10      RET
                                
       4CE6                     CPFILE2:
                                #if exists USE_MORMAL32K_OR_ASCII16
000CE6 4CE6 CD9B43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000CE9 4CE9 E608             7      AND 008H    ;~0F7H
000CEB 4CEB C9              10      RET
                                
       4CEC                     RBX1:
000CEC 4CEC E5              11      PUSH    HL      ;Record byte
                                
000CED 4CED ED5BCAF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000CF1 4CF1 3ACDF2          13      LD  A,(RR_HIGH+1)
000CF4 4CF4 4F               4      LD  C,A
                                
000CF5 4CF5 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
000CF8 4CF8 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
000CFB 4CFB D5              11      PUSH    DE
000CFC 4CFC 2AEDF2          16      LD  HL,(DIRENT1)
000CFF 4CFF 111C00          10      LD  DE,0001CH
000D02 4D02 19              11      ADD HL,DE
000D03 4D03 CD9B43          17      CALL    RDSLT_ROM
000D06 4D06 23               6      INC HL
000D07 4D07 5F               4      LD  E,A
000D08 4D08 CD9B43          17      CALL    RDSLT_ROM
000D0B 4D0B 23               6      INC HL
000D0C 4D0C 57               4      LD  D,A
000D0D 4D0D CD9B43          17      CALL    RDSLT_ROM
000D10 4D10 EB               4      EX  DE,HL       ;AHL=File size
000D11 4D11 D1              10      POP DE
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  L,(IY+01CH) ;AHL=File size
                                    LD  H,(IY+01DH)
                                    LD  A,(IY+01EH)
                                #endif
                                
000D12 4D12 A7               4      AND A
000D13 4D13 ED52            15      SBC HL,DE
000D15 4D15 99               4      SBC A,C
000D16 4D16 D1              10      POP DE
                                
000D17 4D17 D8              11      RET C
000D18 4D18 4F               4      LD  C,A
000D19 4D19 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000D1A 4D1A B2               4      OR  D
000D1B 4D1B B3               4      OR  E
000D1C 4D1C C0              11      RET NZ
000D1D 4D1D 37               4      SCF
000D1E 4D1E C9              10      RET
                                
       4D1F                     RBX2:
000D1F 4D1F ED4BCBF2        20      LD  BC,(RR_LOW+1)
000D23 4D23 CDA44D          17      CALL    RWXR
000D26 4D26 3AC7F2          13      LD  A,(CLSZ_H)
000D29 4D29 3D               4      DEC A
000D2A 4D2A E5              11      PUSH    HL
000D2B 4D2B 2ACAF2          16      LD  HL,(RR_LOW)
000D2E 4D2E A4               4      AND H
000D2F 4D2F B5               4      OR  L
000D30 4D30 E1              10      POP HL
000D31 4D31 C9              10      RET
                                
       4D32                     RBXA:
000D32 4D32 D5              11      PUSH    DE
000D33 4D33 CD1C4E          17      CALL    CLUST
000D36 4D36 ED53D2F2        20      LD  (_DTPS),DE
000D3A 4D3A D1              10      POP DE
000D3B 4D3B CDF94D          17      CALL    GNCL
000D3E 4D3E D8              11      RET C
000D3F 4D3F ED53CEF2        20      LD  (_CLPS),DE
                                
000D43 4D43 ED4BCAF2        20      LD  BC,(RR_LOW)
000D47 4D47 2AC6F2          16      LD  HL,(CLSZ)
000D4A 4D4A 7C               4      LD  A,H
000D4B 4D4B 3D               4      DEC A
000D4C 4D4C A0               4      AND B
000D4D 4D4D 47               4      LD  B,A
000D4E 4D4E ED42            15      SBC HL,BC       ;remaining cluster
                                
000D50 4D50 ED5BF0F2        20      LD  DE,(LEFTX)
000D54 4D54 ED52            15      SBC HL,DE       ;CP HL,DE
000D56 4D56 19              11      ADD HL,DE
000D57 4D57 3801            12      JR  C,RBXA1
000D59 4D59 EB               4      EX  DE,HL
       4D5A                     RBXA1:
000D5A 4D5A 3AC4F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_MORMAL32K_OR_ASCII16
000D5D 4D5D 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000D60 4D60 E5              11      PUSH    HL
000D61 4D61 2AD2F2          16      LD  HL,(_DTPS)
000D64 4D64 09              11      ADD HL,BC
000D65 4D65 ED5BE7F2        20      LD  DE,(DTAX)
000D69 4D69 C1              10      POP BC
000D6A 4D6A C9              10      RET
                                
       4D6B                     RBXB:
000D6B 4D6B 2AE7F2          16      LD  HL,(DTAX)
000D6E 4D6E ED5BCEF2        20      LD  DE,(_CLPS)
000D72 4D72 3AF1F2          13      LD  A,(LEFTX+1)
000D75 4D75 47               4      LD  B,A
000D76 4D76 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4D79                     RBXB1:
000D79 4D79 1F               4      RRA     ;->CF
000D7A 4D7A 3804            12      JR  C,RBXB2
000D7C 4D7C CB38             8      SRL B   ;B=B/2
000D7E 4D7E 18F9            12      JR  RBXB1
       4D80                     RBXB2:
000D80 4D80 78               4      LD  A,B
000D81 4D81 B7               4      OR  A
000D82 4D82 C9              10      RET
                                
       4D83                     RBXC:
000D83 4D83 ED4BF0F2        20      LD  BC,(LEFTX)
000D87 4D87 3AC7F2          13      LD  A,(CLSZ_H)
000D8A 4D8A 3D               4      DEC A
000D8B 4D8B A0               4      AND B
000D8C 4D8C 47               4      LD  B,A
000D8D 4D8D B1               4      OR  C
000D8E 4D8E C9              10      RET
                                
       4D8F                     RBXEND:
000D8F 4D8F ED5BD0F2        20      LD  DE,(_LEFT)
000D93 4D93 2ACAF2          16      LD  HL,(RR_LOW)
000D96 4D96 3ACDF2          13      LD  A,(RR_HIGH+1)
000D99 4D99 19              11      ADD HL,DE
000D9A 4D9A CE00             7      ADC A,0
000D9C 4D9C 22CAF2          16      LD  (RR_LOW),HL
000D9F 4D9F 32CDF2          13      LD  (RR_HIGH+1),A
000DA2 4DA2 EB               4      EX  DE,HL       ;HL=Read byte
000DA3 4DA3 C9              10      RET 
                                
       4DA4                     RWXR:
000DA4 4DA4 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4DA7                     L_RWX:
000DA7 4DA7 1F               4      RRA     ;->CF
000DA8 4DA8 3806            12      JR  C,E_RWX
000DAA 4DAA CB38             8      SRL B   ;BC=BC/2
000DAC 4DAC CB19             8      RR  C   ;
000DAE 4DAE 18F7            12      JR  L_RWX
       4DB0                     E_RWX:
000DB0 4DB0 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
000DB3 4DB3 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
000DB6 4DB6 E5              11      PUSH    HL
000DB7 4DB7 2AEDF2          16      LD  HL,(DIRENT1)
000DBA 4DBA 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000DBD 4DBD 19              11      ADD HL,DE
000DBE 4DBE CD9B43          17      CALL    RDSLT_ROM
000DC1 4DC1 23               6      INC HL
000DC2 4DC2 5F               4      LD  E,A
000DC3 4DC3 CD9B43          17      CALL    RDSLT_ROM
000DC6 4DC6 23               6      INC HL
000DC7 4DC7 57               4      LD  D,A
000DC8 4DC8 E1              10      POP HL
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  E,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  D,(IY+01BH)
                                #endif
000DC9 4DC9 CD6D53          17      CALL    GET_DISK_BANK_FDRV
       4DCC                     RWX1:
000DCC 4DCC ED53CEF2        20      LD  (_CLPS),DE
000DD0 4DD0 7A               4      LD  A,D
000DD1 4DD1 B3               4      OR  E
000DD2 4DD2 37               4      SCF
000DD3 4DD3 C8              11      RET Z
                                
000DD4 4DD4 78               4      LD  A,B
000DD5 4DD5 B1               4      OR  C
000DD6 4DD6 C8              11      RET Z
                                
000DD7 4DD7 CDF94D          17      CALL    GNCL
000DDA 4DDA D8              11      RET C
000DDB 4DDB 0B               6      DEC BC
000DDC 4DDC CD604E          17      CALL    ENDCL
000DDF 4DDF 38EB            12      JR  C,RWX1
000DE1 4DE1 37               4      SCF
000DE2 4DE2 C9              10      RET
                                
       4DE3                     NCL3:
000DE3 4DE3 CD6D53          17      CALL    GET_DISK_BANK_FDRV
000DE6 4DE6 6B               4      LD  L,E
000DE7 4DE7 62               4      LD  H,D
000DE8 4DE8 CB3C             8      SRL H
000DEA 4DEA CB1D             8      RR  L
000DEC 4DEC 1F               4      RRA
000DED 4DED 19              11      ADD HL,DE
000DEE 4DEE 010060          10      LD  BC,BANK1_ADR
000DF1 4DF1 09              11      ADD HL,BC
000DF2 4DF2 ED4BC8F2        20      LD  BC,(SECSZ)
000DF6 4DF6 09              11      ADD HL,BC
000DF7 4DF7 17               4      RLA
000DF8 4DF8 C9              10      RET
                                
       4DF9                     GNCL:
000DF9 4DF9 7A               4      LD  A,D
000DFA 4DFA B3               4      OR  E
000DFB 4DFB 37               4      SCF
000DFC 4DFC C8              11      RET Z
000DFD 4DFD C5              11      PUSH    BC
000DFE 4DFE E5              11      PUSH    HL
000DFF 4DFF CDE34D          17      CALL    NCL3
000E02 4E02 3809            12      JR  C,GNC1
000E04 4E04 5E               7      LD  E,(HL)
000E05 4E05 23               6      INC HL
000E06 4E06 7E               7      LD  A,(HL)
000E07 4E07 E60F             7      AND 00FH
000E09 4E09 57               4      LD  D,A
000E0A 4E0A E1              10      POP HL
000E0B 4E0B C1              10      POP BC
000E0C 4E0C C9              10      RET
       4E0D                     GNC1:
000E0D 4E0D 7E               7      LD  A,(HL)
000E0E 4E0E 23               6      INC HL
000E0F 4E0F 56               7      LD  D,(HL)
000E10 4E10 0604             7      LD  B,4
       4E12                     GNC1L:
000E12 4E12 CB3A             8      SRL D
000E14 4E14 1F               4      RRA
000E15 4E15 10FB            13      DJNZ    GNC1L
                                
000E17 4E17 5F               4      LD  E,A
000E18 4E18 E1              10      POP HL
000E19 4E19 C1              10      POP BC
000E1A 4E1A A7               4      AND A
000E1B 4E1B C9              10      RET
                                
       4E1C                     CLUST:
000E1C 4E1C EB               4      EX  DE,HL
       4E1D                     CLUST_HL:
000E1D 4E1D 2B               6      DEC HL
000E1E 4E1E 2B               6      DEC HL
000E1F 4E1F C5              11      PUSH    BC
000E20 4E20 3AC7F2          13      LD  A,(CLSZ_H)
000E23 4E23 CD9A53          17      CALL    MUL_AHL
                                
000E26 4E26 CDE14E          17      CALL    GET_DIR_POS
000E29 4E29 4F               4      LD  C,A
000E2A 4E2A 0600             7      LD  B,0
000E2C 4E2C 09              11      ADD HL,BC
                                
000E2D 4E2D ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
000E31 4E31 CB38             8      SRL B
000E33 4E33 CB19             8      RR  C           ;/2
000E35 4E35 CB38             8      SRL B
000E37 4E37 CB19             8      RR  C           ;/4
000E39 4E39 CB38             8      SRL B
000E3B 4E3B CB19             8      RR  C           ;/8
000E3D 4E3D 09              11      ADD HL,BC
                                #if exists USE_MORMAL32K_OR_ASCII16
000E3E 4E3E 7D               4      LD  A,L
000E3F 4E3F 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
000E42 4E42 09              11      ADD HL,BC
000E43 4E43 3013            12      JR  NC,CLUST2
000E45 4E45 4D               4      LD  C,L     ;C=読み出し元
000E46 4E46 29              11      ADD HL,HL   ;64KB→32KB
000E47 4E47 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
000E48 4E48 CD6D53          17      CALL    GET_DISK_BANK_FDRV
000E4B 4E4B 84               4      ADD A,H
000E4C 4E4C 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
000E4F 4E4F 32C4F2          13      LD  (_BANK),A
000E52 4E52 69               4      LD  L,C     ;C=読み出し元
000E53 4E53 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
000E55 4E55 A5               4      AND L
000E56 4E56 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB
                                    ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
                                    AND L
                                #endif
       4E58                     CLUST2:
000E58 4E58 C660             7      ADD A,high BANK1_ADR
000E5A 4E5A 67               4      LD  H,A
000E5B 4E5B 2E00             7      LD  L,0
000E5D 4E5D EB               4      EX  DE,HL
000E5E 4E5E C1              10      POP BC
000E5F 4E5F C9              10      RET
                                
       4E60                     ENDCL:
000E60 4E60 7A               4      LD  A,D ;END CLUSTER
000E61 4E61 FE0F             7      CP  00FH    ;FAT12の最大値
000E63 4E63 C0              11      RET NZ
000E64 4E64 7B               4      LD  A,E
000E65 4E65 FEF7             7      CP  0F7H
000E67 4E67 C9              10      RET
                                
       4E68                     RB_READ:
000E68 4E68 AF               4      XOR A   ;HLA = HL*128
000E69 4E69 CB3C             8      SRL H
000E6B 4E6B CB1D             8      RR  L
000E6D 4E6D 1F               4      RRA
000E6E 4E6E 32CAF2          13      LD  (RR_LOW),A
000E71 4E71 22CBF2          16      LD  (RR_MID),HL
000E74 4E74 218000          10      LD  HL,128
                                
000E77 4E77 CD384A          17      CALL    ROM_READ
000E7A 4E7A C9              10      RET
                                
       4E7B                     GETSEQ:
000E7B 4E7B FD6E20          19      LD  L,(IY+32)
000E7E 4E7E FD660C          19      LD  H,(IY+12)
                                
000E81 4E81 CB25             8      SLA L
                                
000E83 4E83 CB3C             8      SRL H
000E85 4E85 CB1D             8      RR  L
000E87 4E87 C9              10      RET
                                
       4E88                     SETSEQ:
000E88 4E88 F5              11      PUSH    AF
000E89 4E89 3ACAF2          13      LD  A,(RR_LOW)
000E8C 4E8C 2ACBF2          16      LD  HL,(RR_MID)
                                
000E8F 4E8F CDA64E          17      CALL    SSQ1
                                
000E92 4E92 29              11      ADD HL,HL
000E93 4E93 CB3D             8      SRL L
000E95 4E95 FD7520          19      LD  (IY+32),L
000E98 4E98 FD740C          19      LD  (IY+12),H
000E9B 4E9B F1              10      POP AF
000E9C 4E9C C9              10      RET
                                
       4E9D                     GETSIZE:
000E9D 4E9D FD7E10          19      LD  A,(IY+16)
000EA0 4EA0 FD6E11          19      LD  L,(IY+17)
000EA3 4EA3 FD6612          19      LD  H,(IY+18)
       4EA6                     SSQ1:
000EA6 4EA6 87               4      ADD A,A
000EA7 4EA7 ED6A            15      ADC HL,HL
000EA9 4EA9 B7               4      OR  A
000EAA 4EAA C8              11      RET Z
000EAB 4EAB 23               6      INC HL
000EAC 4EAC C9              10      RET
                                
       4EAD                     SET_FCB:
000EAD 4EAD D5              11      PUSH    DE
000EAE 4EAE FDE1            14      POP IY
000EB0 4EB0 FD7E1C          19      LD  A,(IY+28)
000EB3 4EB3 FEFF             7      CP  0FFH
000EB5 4EB5 200C            12      JR  NZ,POPAF_SCF_FF_RET
000EB7 4EB7 E5              11      PUSH    HL
000EB8 4EB8 FD6E1A          19      LD  L,(IY+26)
000EBB 4EBB FD661B          19      LD  H,(IY+27)
000EBE 4EBE 22CEF2          16      LD  (_CLPS),HL
000EC1 4EC1 E1              10      POP HL
000EC2 4EC2 C9              10      RET
                                
       4EC3                     POPAF_SCF_FF_RET:
000EC3 4EC3 F1              10      POP AF
000EC4 4EC4 37               4      SCF
000EC5 4EC5 9F               4      SBC A,A
000EC6 4EC6 C9              10      RET
                                
       4EC7                     GET_DIR_DAT:
000EC7 4EC7 2AF6F2          16      LD  HL,(_CDX)
000ECA 4ECA 7C               4      LD  A,H
000ECB 4ECB B5               4      OR  L
000ECC 4ECC 2032            12      JR  NZ,GET_SUBDIR
000ECE 4ECE CDE14E          17      CALL    GET_DIR_POS
000ED1 4ED1 C660             7      ADD A,high BANK1_ADR
000ED3 4ED3 2E00             7      LD  L,0
000ED5 4ED5 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                    CALL    CHECK_DIR_PAGE
                                #endif
000ED6 4ED6 3AC5F2          13      LD  A,(_BANK1)
000ED9 4ED9 32EFF2          13      LD  (_DIR_BANK),A
                                
000EDC 4EDC 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000EDF 4EDF 4F               4      LD  C,A
000EE0 4EE0 C9              10      RET
                                
       4EE1                     GET_DIR_POS:                ;ルートディレクトリ
000EE1 4EE1 CD6D53          17      CALL    GET_DISK_BANK_FDRV
000EE4 4EE4 32C5F2          13      LD  (_BANK1),A
000EE7 4EE7 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000EEA 4EEA 47               4      LD  B,A
000EEB 4EEB 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000EEE 4EEE 4F               4      LD  C,A
000EEF 4EEF 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4EF2                     GET_DIR_POS1:
000EF2 4EF2 81               4      ADD A,C
000EF3 4EF3 10FD            13      DJNZ    GET_DIR_POS1
                                
000EF5 4EF5 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
000EF9 4EF9 37               4      SCF     ;無限ループ回避
       4EFA                     L_MDP:
000EFA 4EFA CB18             8      RR  B   ;->CF
000EFC 4EFC D8              11      RET C
000EFD 4EFD 87               4      ADD A,A
000EFE 4EFE 18FA            12      JR  L_MDP
                                
       4F00                     GET_SUBDIR:             ;サブディレクトリ
000F00 4F00 CD1D4E          17      CALL    CLUST_HL
000F03 4F03 EB               4      EX  DE,HL
000F04 4F04 3AC4F2          13      LD  A,(_BANK)
000F07 4F07 32EFF2          13      LD  (_DIR_BANK),A
000F0A 4F0A 3AC7F2          13      LD  A,(CLSZ_H)
000F0D 4F0D 87               4      ADD A,A     ;*2
000F0E 4F0E 87               4      ADD A,A     ;*4
000F0F 4F0F 87               4      ADD A,A     ;*8
000F10 4F10 4F               4      LD  C,A
000F11 4F11 C9              10      RET
                                
       4F12                     STATEMENT:
000F12 4F12 117F51          10      LD  DE,STR_CHDIR
000F15 4F15 CD6551          17      CALL    CPPROCNM
000F18 4F18 2812            12      JR  Z,_CHDIR
000F1A 4F1A 118551          10      LD  DE,STR_CHDRV
000F1D 4F1D CD6551          17      CALL    CPPROCNM
000F20 4F20 281C            12      JR  Z,_CHDRV
000F22 4F22 118B51          10      LD  DE,STR_RAMDISK
000F25 4F25 CD6551          17      CALL    CPPROCNM
000F28 4F28 2829            12      JR  Z,_RAMDISK
000F2A 4F2A 37               4      SCF
000F2B 4F2B C9              10      RET
       4F2C                     _CHDIR:
000F2C 4F2C 7E               7      LD  A,(HL)
000F2D 4F2D FE28             7      CP  '('
000F2F 4F2F 37               4      SCF
000F30 4F30 C0              11      RET NZ
000F31 4F31 CDE647          17      CALL    INIT_PARAM
000F34 4F34 CDD94A          17      CALL    FILE_B
000F37 4F37 CD674F          17      CALL    ROM_CD
000F3A 4F3A D0              11      RET NC
000F3B 4F3B C38C46          10      JP  ERROR_FILE_NOT_FOUND
                                
       4F3E                     _CHDRV:
000F3E 4F3E 7E               7      LD  A,(HL)
000F3F 4F3F FE28             7      CP  '('
000F41 4F41 37               4      SCF
000F42 4F42 C0              11      RET NZ
000F43 4F43 CDE647          17      CALL    INIT_PARAM
000F46 4F46 E5              11      PUSH    HL
000F47 4F47 CDD94A          17      CALL    FILE_B
000F4A 4F4A E1              10      POP HL
000F4B 4F4B 23               6      INC HL
000F4C 4F4C 3AF8F2          13      LD  A,(FDRV)
000F4F 4F4F 3D               4      DEC A
000F50 4F50 C3D355          10      JP  _SYS0EX1
                                
       4F53                     _RAMDISK:
000F53 4F53 7E               7      LD  A,(HL)
000F54 4F54 FE28             7      CP  '('
000F56 4F56 37               4      SCF
000F57 4F57 C0              11      RET NZ
000F58 4F58 23               6      INC HL
000F59 4F59 DD212F54        14      LD  IX,FRMQNT
000F5D 4F5D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000F61 4F61 CD1C00          17      CALL    _CALSLT
                                ;   LD  A,(HOKVLD)  ;bit0: 拡張 BIOSの存在
                                ;   CPL
                                ;   AND 1
                                ;   LD  A,D
                                ;   OR  E
                                ;   JP  NZ,ERROR_INTERNAL_ERROR
                                ;   PUSH    HL      ;EXTBIOもDISK BIOSで初期化してそう
                                ;   XOR A
                                ;   LD  DE,0401H    ;D=マッパサポートルチン(4) E=機能番号(1)
                                ;   CALL    EXTBIO
                                ;   POP HL
                                ;   OR  A
                                ;   JP  Z,ERROR_INTERNAL_ERROR
000F64 4F64 23               6      INC HL
000F65 4F65 AF               4      XOR A
000F66 4F66 C9              10      RET
                                
       4F67                     ROM_CD:
000F67 4F67 3AF9F2          13      LD  A,(FNAME)
000F6A 4F6A FE20             7      CP  020H
000F6C 4F6C 2835            12      JR  Z,CD1
000F6E 4F6E CD6B4C          17      CALL    ROM_OPEN
000F71 4F71 D8              11      RET C
                                #if exists USE_MORMAL32K_OR_ASCII16
000F72 4F72 D5              11      PUSH    DE
000F73 4F73 2AEDF2          16      LD  HL,(DIRENT1)
000F76 4F76 110B00          10      LD  DE,0000BH   ;属性(アトリビュート)
000F79 4F79 19              11      ADD HL,DE
000F7A 4F7A CD9B43          17      CALL    RDSLT_ROM
000F7D 4F7D D1              10      POP DE
000F7E 4F7E CB67             8      BIT 4,A     ;ディレクトリ
000F80 4F80 CA8C46          10      JP  Z,ERROR_FILE_NOT_FOUND
000F83 4F83 D5              11      PUSH    DE
000F84 4F84 2AEDF2          16      LD  HL,(DIRENT1)
000F87 4F87 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000F8A 4F8A 19              11      ADD HL,DE
000F8B 4F8B CD9B43          17      CALL    RDSLT_ROM
000F8E 4F8E 23               6      INC HL
000F8F 4F8F 5F               4      LD  E,A
000F90 4F90 CD9B43          17      CALL    RDSLT_ROM
000F93 4F93 57               4      LD  D,A
000F94 4F94 EB               4      EX  DE,HL
000F95 4F95 D1              10      POP DE
                                #else
                                    LD  IY,(DIRENT1)
                                    BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    LD  L,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  H,(IY+01BH)
                                #endif
       4F96                     CD2:
000F96 4F96 22EBF2          16      LD  (_CD),HL
000F99 4F99 2AF4F2          16      LD  HL,(PARAM1)
       4F9C                     CD_SKIP:
000F9C 4F9C 7E               7      LD  A,(HL)
000F9D 4F9D 23               6      INC HL
000F9E 4F9E FE21             7      CP  021H
000FA0 4FA0 38FA            12      JR  C,CD_SKIP
000FA2 4FA2 C9              10      RET
       4FA3                     CD1:
000FA3 4FA3 2AF6F2          16      LD  HL,(_CDX)
000FA6 4FA6 18EE            12      JR  CD2
                                
       4FA8                     GET_BASIC_FCB:
000FA8 4FA8 D5              11      PUSH    DE
000FA9 4FA9 23               6      INC HL  ;+1
000FAA 4FAA 5E               7      LD  E,(HL)  ;FCB[1]
000FAB 4FAB 23               6      INC HL  ;+2
000FAC 4FAC 56               7      LD  D,(HL)  ;FCB[2]
000FAD 4FAD 23               6      INC HL  ;+3
000FAE 4FAE ED53EDF2        20      LD  (DIRENT1),DE
                                            ;FCB[3] backup char
000FB2 4FB2 23               6      INC HL  ;+4
                                            ;FCB[4]
000FB3 4FB3 23               6      INC HL  ;+5
000FB4 4FB4 7E               7      LD  A,(HL)  ;FCB[5]
000FB5 4FB5 23               6      INC HL  ;+6
000FB6 4FB6 32EFF2          13      LD  (_DIR_BANK),A
000FB9 4FB9 5E               7      LD  E,(HL)  ;FCB[6]
000FBA 4FBA 23               6      INC HL  ;+7
000FBB 4FBB 56               7      LD  D,(HL)  ;FCB[7]
000FBC 4FBC 23               6      INC HL  ;+8
000FBD 4FBD ED53CAF2        20      LD  (RR_LOW),DE
000FC1 4FC1 7E               7      LD  A,(HL)  ;FCB[8]
000FC2 4FC2 23               6      INC HL  ;+9
000FC3 4FC3 32CCF2          13      LD  (RR_HIGH),A
000FC6 4FC6 22D4F2          16      LD  (_DTA),HL   ;FCB[9]
000FC9 4FC9 D1              10      POP DE
000FCA 4FCA C9              10      RET
                                
       4FCB                     SET_BASIC_FCB:
000FCB 4FCB E5              11      PUSH    HL
000FCC 4FCC 2A64F8          16      LD  HL,(PTRFIL)
000FCF 4FCF 23               6      INC HL  ;+1
000FD0 4FD0 D5              11      PUSH    DE
000FD1 4FD1 ED5BEDF2        20      LD  DE,(DIRENT1)
000FD5 4FD5 73               7      LD  (HL),E  ;FCB[1]
000FD6 4FD6 23               6      INC HL  ;+2
000FD7 4FD7 72               7      LD  (HL),D  ;FCB[2]
000FD8 4FD8 23               6      INC HL  ;+3
000FD9 4FD9 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
000FDA 4FDA 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
000FDB 4FDB 23               6      INC HL  ;+5
000FDC 4FDC 3AEFF2          13      LD  A,(_DIR_BANK)
000FDF 4FDF 77               7      LD  (HL),A  ;FCB[5]
000FE0 4FE0 23               6      INC HL  ;+6
000FE1 4FE1 ED5BCAF2        20      LD  DE,(RR_LOW)
000FE5 4FE5 73               7      LD  (HL),E  ;FCB[6]
000FE6 4FE6 23               6      INC HL  ;+7
000FE7 4FE7 72               7      LD  (HL),D  ;FCB[7]
000FE8 4FE8 23               6      INC HL  ;+8
000FE9 4FE9 3ACCF2          13      LD  A,(RR_HIGH)
000FEC 4FEC 77               7      LD  (HL),A  ;FCB[8]
000FED 4FED D1              10      POP DE
000FEE 4FEE E1              10      POP HL
000FEF 4FEF C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_18:BACKUP
                                ;in
                                ;   C : backup charactor
                                ;   HL: FBC pointer
                                ;out
       4FF0                     DEVICE_18_BACKUP:
000FF0 4FF0 D5              11      PUSH    DE
000FF1 4FF1 E5              11      PUSH    HL
000FF2 4FF2 110300          10      LD  DE,3
000FF5 4FF5 19              11      ADD HL,DE
000FF6 4FF6 71               7      LD  (HL),C
000FF7 4FF7 E1              10      POP HL
000FF8 4FF8 D1              10      POP DE
000FF9 4FF9 C9              10      RET
                                
       4FFA                     DEVICE_CHECK:
000FFA 4FFA 23               6      INC HL
000FFB 4FFB 7E               7      LD  A,(HL)
000FFC 4FFC 2B               6      DEC HL
000FFD 4FFD B7               4      OR  A
000FFE 4FFE C8              11      RET Z
000FFF 4FFF 119351          10      LD  DE,STR_ROM
001002 5002 CD6551          17      CALL    CPPROCNM
001005 5005 2802            12      JR  Z,DEVICE_OK
001007 5007 37               4      SCF
001008 5008 C9              10      RET
       5009                     DEVICE_OK:
001009 5009 AF               4      XOR A
00100A 500A C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファ
                                
       500B                     DEVICE_0_OPEN:
00100B 500B 7B               4      LD  A,E
00100C 500C FE02             7      CP  2       ;FOR OUTPUT
00100E 500E 281B            12      JR  Z,OPEN2
001010 5010 D5              11      PUSH    DE
001011 5011 E5              11      push    hl
                                ;
001012 5012 3E01             7      LD  A,1     ;ドライブA
001014 5014 32F8F2          13      LD  (FDRV),A
001017 5017 2166F8          10      LD  HL,FILNAM
00101A 501A 11F9F2          10      LD  DE,FNAME
00101D 501D 010B00          10      LD  BC,8+3
001020 5020 CD5057          17      CALL    INIT_FILE1
001023 5023 CD6B4C          17      CALL    ROM_OPEN
001026 5026 DA8C46          10      JP  C,ERROR_FILE_NOT_FOUND
001029 5029 E1              10      pop hl
00102A 502A D1              10      POP DE
       502B                     OPEN2:
00102B 502B 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
00102E 502E 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
00102F 502F AF               4      XOR A
001030 5030 32F0F2          13      LD  (LEFTX),A
001033 5033 CDCB4F          17      CALL    SET_BASIC_FCB
001036 5036 7B               4      ld  a,e
001037 5037 FE08             7      cp  8
001039 5039 3F               4      ccf
00103A 503A C9              10      ret
                                
       503B                     DEVICE_2_CLOSE:
00103B 503B AF               4      XOR A
                                ;   LD  (HL),A
00103C 503C 6F               4      LD  L,A
00103D 503D 67               4      LD  H,A
00103E 503E 2264F8          16      LD  (PTRFIL),HL
001041 5041 C9              10      RET
                                
       5042                     DEVICE_ENTRY:
001042 5042 FE08             7      CP  8
001044 5044 2826            12      JR  Z,DEVICE_8_SIN
001046 5046 3C               4      INC A
001047 5047 28B1            12      JR  Z,DEVICE_CHECK:
001049 5049 3D               4      DEC A
00104A 504A 28BF            12      JR  Z,DEVICE_0_OPEN
00104C 504C FE0E             7      CP  14
00104E 504E 2860            12      JR  Z,DEVICE_14_EOF
001050 5050 FE04             7      CP  4
001052 5052 2834            12      JR  Z,DEVICE_4_RANDOM
001054 5054 FE0A             7      CP  10
001056 5056 2850            12      JR  Z,DEVICE_10_LOC
001058 5058 FE0C             7      CP  12
00105A 505A 2878            12      JR  Z,DEVICE_12_LOF
00105C 505C FE02             7      CP  2
00105E 505E 2890            12      JR  Z,DEVICE_18_BACKUP  
001060 5060 FE02             7      CP  2
001062 5062 28D7            12      JR  Z,DEVICE_2_CLOSE
001064 5064 FE06             7      CP  6
001066 5066 2802            12      JR  Z,DEVICE_6_SOUT
001068 5068 37               4      SCF
001069 5069 C9              10      RET
                                
       506A                     DEVICE_6_SOUT:
00106A 506A AF               4      XOR A
00106B 506B C9              10      RET
                                
       506C                     DEVICE_8_SIN:
00106C 506C CDA84F          17      CALL    GET_BASIC_FCB
00106F 506F 210100          10      LD  HL,1
001072 5072 CD384A          17      CALL    ROM_READ
001075 5075 7C               4      LD  A,H
001076 5076 B5               4      OR  L
001077 5077 280D            12      JR  Z,CCF_RET
001079 5079 2AD4F2          16      LD  HL,(_DTA)
00107C 507C 7E               7      LD  A,(HL)
00107D 507D F5              11      PUSH    AF
00107E 507E CDCB4F          17      CALL    SET_BASIC_FCB
001081 5081 F1              10      POP AF
001082 5082 FE0A             7      CP  00AH
001084 5084 C8              11      RET Z   ;ZF=separate
                                ;   CP  01AH
                                ;   JR  Z,SCF_RET
001085 5085 37               4      SCF     ;
       5086                     CCF_RET:
001086 5086 3F               4      CCF     ;ZF=0 CF=0にしたい
001087 5087 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_4:RANDOM
                                ;in
                                ;   A : 4
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
       5088                     DEVICE_4_RANDOM:
001088 5088 D5              11      PUSH    DE
001089 5089 CDA84F          17      CALL    GET_BASIC_FCB
00108C 508C DDE5            15      PUSH    IX
00108E 508E DD218A2F        14      LD  IX,FRCINT
001092 5092 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001096 5096 CDB1F2          17      CALL    CAL_MP
001099 5099 DDE1            14      POP IX
00109B 509B 2AF8F7          16      LD  HL,(DACDAT)
00109E 509E 22CAF2          16      LD  (RR_LOW),HL
0010A1 50A1 AF               4      XOR A
0010A2 50A2 CDCB4F          17      CALL    SET_BASIC_FCB
0010A5 50A5 D1              10      POP DE
0010A6 50A6 AF               4      XOR A
0010A7 50A7 C9              10      RET
                                
                                ;FUNC_10:LOC
                                ;in
                                ;   A : 10
                                ;out
                                ;   DAC    : value of received bytes
                                ;   VALTYP : DAC type
       50A8                     DEVICE_10_LOC:
0010A8 50A8 CDA84F          17      CALL    GET_BASIC_FCB
0010AB 50AB 2ACAF2          16      LD  HL,(RR_LOW)
0010AE 50AE 1844            12      JR  RETURN_TYPE8_AHL
                                
                                ;--------------------------------------
                                ;FUNC_14:EOF
                                ;in
                                ;   A : 14
                                ;out
                                ;   DAC    : value of EOF value (EOF=-1)
                                ;   VALTYP : DAC type
       50B0                     DEVICE_14_EOF:
0010B0 50B0 CDA84F          17      CALL    GET_BASIC_FCB
0010B3 50B3 CDEC4C          17      CALL    RBX1
0010B6 50B6 3810            12      JR  C,DEVICE_14_EOF1
0010B8 50B8 210100          10      LD  HL,1
0010BB 50BB CD384A          17      CALL    ROM_READ
0010BE 50BE 2AD4F2          16      LD  HL,(_DTA)
0010C1 50C1 7E               7      LD  A,(HL)
0010C2 50C2 FE1A             7      CP  01AH
0010C4 50C4 37               4      SCF
0010C5 50C5 2801            12      JR  Z,DEVICE_14_EOF1
0010C7 50C7 3F               4      CCF
       50C8                     DEVICE_14_EOF1:
0010C8 50C8 9F               4      SBC A,A
0010C9 50C9 6F               4      LD  L,A
0010CA 50CA 67               4      LD  H,A
       50CB                     return_type2_hl:
0010CB 50CB 22F8F7          16      ld  (DACDAT),hl
0010CE 50CE 3E02             7      ld  a,2
0010D0 50D0 3263F6          13      ld  (VALTYP),a
0010D3 50D3 C9              10      ret
                                
                                ;--------------------------------------
                                ;FUNC_16:FPOS
                                ;in
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
                                ;   illegal function call
                                
                                ;--------------------------------------
                                ;FUNC_12:LOF
                                ;in
                                ;   A : 12
                                ;out
                                ;   DAC    : value of LOC+RSIQLN
                                ;   VALTYP : DAC type
       50D4                     DEVICE_12_LOF:
0010D4 50D4 CDA84F          17      CALL    GET_BASIC_FCB
                                
0010D7 50D7 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
0010DA 50DA 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
0010DD 50DD D5              11      PUSH    DE
0010DE 50DE 2AEDF2          16      LD  HL,(DIRENT1)
0010E1 50E1 111C00          10      LD  DE,0001CH
0010E4 50E4 19              11      ADD HL,DE
0010E5 50E5 CD9B43          17      CALL    RDSLT_ROM
0010E8 50E8 23               6      INC HL
0010E9 50E9 5F               4      LD  E,A
0010EA 50EA CD9B43          17      CALL    RDSLT_ROM
0010ED 50ED 23               6      INC HL
0010EE 50EE 57               4      LD  D,A
0010EF 50EF CD9B43          17      CALL    RDSLT_ROM
0010F2 50F2 EB               4      EX  DE,HL       ;AHL=File size
0010F3 50F3 D1              10      POP DE
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  L,(IY+01CH) ;AHL=File size
                                    LD  H,(IY+01DH)
                                    LD  A,(IY+01EH)
                                #endif
       50F4                     RETURN_TYPE8_AHL:
0010F4 50F4 B7               4      OR  A
0010F5 50F5 2004            12      JR  NZ,RT8AHL1
0010F7 50F7 CB7C             8      BIT 7,H
0010F9 50F9 28D0            12      JR  Z,return_type2_hl
       50FB                     RT8AHL1:
0010FB 50FB E5              11      PUSH    HL
0010FC 50FC 29              11      ADD HL,HL
0010FD 50FD 8F               4      ADC A,A
0010FE 50FE 32F8F7          13      LD  (DACDAT),A
001101 5101 3E00             7      LD  A,0
001103 5103 8F               4      ADC A,A
001104 5104 32F9F7          13      LD  (DACDAT+1),A
                                
001107 5107 3E02             7      LD  A,2
001109 5109 3263F6          13      LD  (VALTYP),A
00110C 510C DD213A30        14      LD  IX,FRCDBL
001110 5110 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001114 5114 CDB1F2          17      CALL    CAL_MP
                                
001117 5117 215D51          10      LD  HL,DBL32768
00111A 511A 1147F8          10      LD  DE,ARG
00111D 511D 010800          10      LD  BC,8
001120 5120 EDB0                    LDIR
                                
001122 5122 DD21E627        14      LD  IX,DECMUL
001126 5126 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00112A 512A CDB1F2          17      CALL    CAL_MP
                                
00112D 512D 21F6F7          10      LD  HL,DAC
001130 5130 1147F8          10      LD  DE,ARG
001133 5133 010800          10      LD  BC,8
001136 5136 EDB0                    LDIR
                                
001138 5138 E1              10      POP HL
001139 5139 22F8F7          16      LD  (DACDAT),HL
                                
00113C 513C 3E02             7      LD  A,2
00113E 513E 3263F6          13      LD  (VALTYP),A
001141 5141 DD213A30        14      LD  IX,FRCDBL
001145 5145 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001149 5149 CDB1F2          17      CALL    CAL_MP
                                
00114C 514C DD219A26        14      LD  IX,DECADD
001150 5150 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001154 5154 CDB1F2          17      CALL    CAL_MP
                                
001157 5157 3E08             7      LD  A,8
001159 5159 3263F6          13      LD  (VALTYP),A
00115C 515C C9              10      RET
                                
       515D                     DBL32768:
00115D 515D 4532768000000000        DB  045H,032H,076H,080H,0,0,0,0
                                
       5165                     CPPROCNM:
001165 5165 E5              11      PUSH    HL
001166 5166 2189FD          10      LD  HL,PROCNM
       5169                     CPPROCNM1:
001169 5169 1A               7      LD  A,(DE)
00116A 516A 13               6      INC DE
00116B 516B BE               7      CP  (HL)
00116C 516C 23               6      INC HL
00116D 516D 2003            12      JR  NZ,CPPROCNM2
00116F 516F B7               4      OR  A
001170 5170 20F7            12      JR  NZ,CPPROCNM1
       5172                     CPPROCNM2:
001172 5172 E1              10      POP HL
001173 5173 C9              10      RET
                                
       5174                     WILDCARD:
001174 5174 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       517F                     STR_CHDIR:
00117F 517F 434844495200            DB  "CHDIR",0
       5185                     STR_CHDRV:
001185 5185 434844525600            DB  "CHDRV",0
       518B                     STR_RAMDISK:
00118B 518B 52414D4449534B00        DB  "RAMDISK",0
       5193                     STR_ROM:
001193 5193 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       5197                     ERROR_WRITE_PROTECTED:
001197 5197 3E00             7      LD  A,0     ;Write protected
001199 5199 C9              10      RET
       519A                     DISKIO:
00119A 519A 38FB            12      JR  C,ERROR_WRITE_PROTECTED
00119C 519C 48               4      LD  C,B
00119D 519D CD7753          17      CALL    GET_DISK_BANK
       51A0                     SETMAP1:        
0011A0 51A0 E5              11      PUSH    HL
       51A1                     DISKIO1:
0011A1 51A1 C5              11      PUSH    BC      ;B=残りのセクタ数
0011A2 51A2 D5              11      PUSH    DE      ;DE=セクタ番号
0011A3 51A3 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
0011A4 51A4 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
0011A5 51A5 F5              11      PUSH    AF
0011A6 51A6 3AC9F2          13      LD  A,(SECSZ_H)
0011A9 51A9 CD9A53          17      CALL    MUL_AHL
0011AC 51AC F1              10      POP AF
                                #if exists USE_MORMAL32K_OR_ASCII16
0011AD 51AD 7D               4      LD  A,L
0011AE 51AE C5              11      PUSH    BC
0011AF 51AF 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
0011B2 51B2 09              11      ADD HL,BC
0011B3 51B3 C1              10      POP BC
0011B4 51B4 3013            12      JR  NC,DISKIO2
0011B6 51B6 4D               4      LD  C,L     ;C=読み出し元
0011B7 51B7 29              11      ADD HL,HL   ;64KB→32KB
0011B8 51B8 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
0011B9 51B9 CD6D53          17      CALL    GET_DISK_BANK_FDRV
0011BC 51BC 84               4      ADD A,H
0011BD 51BD 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
0011C0 51C0 32C4F2          13      LD  (_BANK),A
0011C3 51C3 69               4      LD  L,C     ;C=読み出し元
0011C4 51C4 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
0011C6 51C6 A5               4      AND L
0011C7 51C7 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL       ;64KB→32KB
                                    ADD HL,HL       ;32KB→16KB
                                    ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  A,C     ;C=読み出し元
                                    AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       51C9                     DISKIO2:
0011C9 51C9 C660             7      ADD A,high BANK1_ADR
0011CB 51CB 67               4      LD  H,A
0011CC 51CC ED4BC8F2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
0011D0 51D0 69               4      LD  L,C     ;C=0
0011D1 51D1 CD0E44          17      CALL    ROM_LDIR
0011D4 51D4 EB               4      EX  DE,HL
0011D5 51D5 F1              10      POP AF
0011D6 51D6 D1              10      POP DE
0011D7 51D7 13               6      INC DE
0011D8 51D8 C1              10      POP BC
0011D9 51D9 10C6            13      DJNZ    DISKIO1
0011DB 51DB 41               4      LD  B,C
                                
0011DC 51DC E1              10      POP HL
0011DD 51DD AF               4      XOR A
                                
0011DE 51DE FB               4      EI
0011DF 51DF C9              10      RET
                                
       51E0                     DSKCHG:
0011E0 51E0 CD1952          17      CALL    IS_BPB
0011E3 51E3 3824            12      JR  C,NOTREADY
0011E5 51E5 3A23FB          13      LD  A,(DRVTBL+2)
0011E8 51E8 B7               4      OR  A
0011E9 51E9 201A            12      JR  NZ,DSKCHG1
0011EB 51EB 3A21FB          13      LD  A,(DRVTBL)
0011EE 51EE FE02             7      CP  2
0011F0 51F0 2013            12      JR  NZ,DSKCHG1
0011F2 51F2 CD1952          17      CALL    IS_BPB
0011F5 51F5 300E            12      JR  NC,DSKCHG1
0011F7 51F7 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
0011F9 51F9 3221FB          13      LD  (DRVTBL),A
0011FC 51FC 3223FB          13      LD  (DRVTBL+2),A
0011FF 51FF 3A48F3          13      LD  A,(MASTERS)
001202 5202 3224FB          13      LD  (DRVTBL+3),A
       5205                     DSKCHG1:
001205 5205 AF               4      XOR A
001206 5206 0601             7      LD  B,1
001208 5208 C9              10      RET
       5209                     NOTREADY:
001209 5209 3E02             7      LD  A,2
00120B 520B 37               4      SCF
00120C 520C C9              10      RET
                                
       520D                     NO_BPB:
00120D 520D E1              10      POP HL
00120E 520E 23               6      INC HL
00120F 520F 11A053          10      LD  DE,DPB2DD
001212 5212 011200          10      LD  BC,DPB2DD_E-DPB2DD
001215 5215 EDB0                    LDIR
001217 5217 AF               4      XOR A
001218 5218 C9              10      RET
                                
       5219                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
001219 5219 CD7753          17      CALL    GET_DISK_BANK
                                
00121C 521C 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
00121F 521F FE01             7      CP  1
001221 5221 D8              11      RET C
                                
001222 5222 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
001225 5225 C6FF             7      ADD A,0FFH
001227 5227 D8              11      RET C
                                
001228 5228 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       522B                     IS_BPB1:
00122B 522B FE01             7      CP  1
00122D 522D C8              11      RET Z
00122E 522E FE02             7      CP  2
001230 5230 C8              11      RET Z
001231 5231 FE04             7      CP  4
001233 5233 C8              11      RET Z
001234 5234 37               4      SCF
001235 5235 C9              10      RET
                                
       5236                     GETDPB:
001236 5236 E5              11      PUSH    HL
001237 5237 CD7753          17      CALL    GET_DISK_BANK
                                
00123A 523A 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
00123D 523D B7               4      OR  A
00123E 523E 28CD            12      JR  Z,NO_BPB
001240 5240 DDE1            14      POP IX
001242 5242 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
001245 5245 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
001248 5248 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
00124B 524B 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
00124E 524E DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
001251 5251 87               4      ADD A,A
001252 5252 87               4      ADD A,A
001253 5253 87               4      ADD A,A
001254 5254 3D               4      DEC A
001255 5255 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
001258 5258 06FF             7      LD  B,-1
00125A 525A A7               4      AND A           ;無限ループ阻止
       525B                     GETDPB1:
00125B 525B 04               4      INC B
00125C 525C 1F               4      RRA
00125D 525D 38FC            12      JR  C,GETDPB1
00125F 525F DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
001262 5262 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
001265 5265 3D               4      DEC A
001266 5266 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
001269 5269 A7               4      AND A           ;無限ループ阻止
00126A 526A 06FF             7      LD  B,-1
       526C                     GETDPB2:
00126C 526C 04               4      INC B
00126D 526D 1F               4      RRA
00126E 526E 38FC            12      JR  C,GETDPB2
001270 5270 04               4      INC B
001271 5271 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
001274 5274 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
001277 5277 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
00127A 527A DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
00127D 527D 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
001280 5280 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
001283 5283 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
001286 5286 DD770B          19      LD  (IX+11),A       ;MAXENT
                                
001289 5289 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
00128D 528D DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
001290 5290 DD460A          19      LD  B,(IX+10)       ;FATCNT
001293 5293 210000          10      LD  HL,0
       5296                     GETDPB3:
001296 5296 19              11      ADD HL,DE
001297 5297 10FD            13      DJNZ    GETDPB3
       5299                     GETDPB4:
001299 5299 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
00129C 529C DD5609          19      LD  D,(IX+9)        ;FIRFAT
00129F 529F 19              11      ADD HL,DE
0012A0 52A0 DD7511          19      LD  (IX+17),L       ;FIRDIR
0012A3 52A3 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
0012A6 52A6 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0012A9 52A9 87               4      ADD A,A
0012AA 52AA 87               4      ADD A,A
0012AB 52AB DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       52AE                     GETDPB5:
0012AE 52AE CB3B             8      SRL E
0012B0 52B0 1F               4      RRA
0012B1 52B1 30FB            12      JR  NC,GETDPB5
0012B3 52B3 1600             7      LD  D,0
0012B5 52B5 19              11      ADD HL,DE
0012B6 52B6 DD750C          19      LD  (IX+12),L       ;FIRREC
0012B9 52B9 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
0012BC 52BC 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
0012BF 52BF DD5E0C          19      LD  E,(IX+12)       ;FIRREC
0012C2 52C2 DD560D          19      LD  D,(IX+13)       ;FIRREC
0012C5 52C5 A7               4      AND A
0012C6 52C6 ED52            15      SBC HL,DE
                                
0012C8 52C8 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
0012CB 52CB 3C               4      INC A
0012CC 52CC 37               4      SCF             ;無限ループ阻止
       52CD                     GETDPB6:
0012CD 52CD 1F               4      RRA
0012CE 52CE 3806            12      JR  C,GETDPB7
0012D0 52D0 CB3C             8      SRL H
0012D2 52D2 CB1D             8      RR  L
0012D4 52D4 18F7            12      JR  GETDPB6
       52D6                     GETDPB7:
0012D6 52D6 23               6      INC HL
0012D7 52D7 DD750E          19      LD  (IX+14),L       ;MAXCLUS
0012DA 52DA DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       52DD                     GETDPBD1:
0012DD 52DD DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0012E0 52E0 E6FC             7      AND 0FCH
0012E2 52E2 C8              11      RET Z
                                
0012E3 52E3 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
0012E7 52E7 37               4      SCF
0012E8 52E8 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
0012EC 52EC DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
0012EF 52EF DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
0012F3 52F3 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
0012F7 52F7 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
0012FB 52FB DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
0012FF 52FF DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
001303 5303 DDCB1126        23      SLA (IX+17)         ;FIRDIR
001307 5307 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
00130B 530B DD6E11          19      LD  L,(IX+17)       ;FIRDIR
00130E 530E DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
001311 5311 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001314 5314 87               4      ADD A,A
001315 5315 87               4      ADD A,A
001316 5316 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       5319                     GETDPBD5:
001319 5319 CB3B             8      SRL E
00131B 531B 1F               4      RRA
00131C 531C 30FB            12      JR  NC,GETDPBD5
00131E 531E 1600             7      LD  D,0
001320 5320 19              11      ADD HL,DE
001321 5321 DD750C          19      LD  (IX+12),L       ;FIRREC
001324 5324 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001327 5327 18B4            12      JR  GETDPBD1
                                
       5329                     CHOICE:
001329 5329 210000          10      LD  HL,0
00132C 532C C9              10      RET
                                
       532D                     DSKFMT:
00132D 532D AF               4      XOR A
00132E 532E 37               4      SCF
       532F                     DSKSTP:
00132F 532F C9              10      RET
                                
       5330                     BASENT:
001330 5330 2A74F6          16      LD  HL,(STKTOP)
001333 5333 3A40F3          13      LD  A,(REBOOT)
001336 5336 C6FF             7      ADD A,0FFH
001338 5338 3811            12      JR  C,REBOOT1
00133A 533A 21B253          10      LD  HL,AUTOEXEC
00133D 533D 11F8F2          10      LD  DE,FDRV
001340 5340 010C00          10      LD  BC,1+8+3
001343 5343 EDB0                    LDIR
001345 5345 CD6B4C          17      CALL    ROM_OPEN
001348 5348 D4D645          17      CALL    NC,ROM_LOAD1
       534B                     REBOOT1:
00134B 534B 21BE53          10      LD  HL,CMD_RUN
00134E 534E 111FF4          10      LD  DE,KBUF
001351 5351 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
001354 5354 D5              11      PUSH    DE
001355 5355 EDB0                    LDIR
001357 5357 3004            12      JR  NC,REBOOT2
001359 5359 AF               4      XOR A
00135A 535A 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       535D                     REBOOT2:
00135D 535D E1              10      POP HL
00135E 535E FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
001362 5362 DD210146        14      LD  IX,NEWSTT
001366 5366 C31C00          10      JP  _CALSLT
                                
       5369                     GETSLT:
001369 5369 3A22FB          13      LD  A,(DRVTBL+1)
00136C 536C C9              10      RET
                                
       536D                     GET_DISK_BANK_FDRV:
00136D 536D 3AF8F2          13      LD  A,(FDRV)
001370 5370 D601             7      SUB 1
001372 5372 3003            12      JR  NC,GET_DISK_BANK
001374 5374 3AEAF2          13      LD  A,(_DVSW)
       5377                     GET_DISK_BANK:
001377 5377 FE07             7      CP  7       ;H:
001379 5379 2801            12      JR  Z,SET_DISK_BANK_A
00137B 537B B7               4      OR  A       ;A=DRIVE
       537C                     SET_DISK_BANK_A:
00137C 537C 3E01             7      LD  A,DISK_BANK
00137E 537E 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
001380 5380 3AE9F2          13      LD  A,(B_DRIVE)
                                #endif
       5383                     SET_DISK_BANK:
                                #if exists USE_MORMAL32K_OR_ASCII16
001383 5383 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
001386 5386 F5              11      PUSH    AF
001387 5387 E5              11      PUSH    HL
001388 5388 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
00138B 538B 22C8F2          16      LD  (SECSZ),HL
00138E 538E 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
001391 5391 CD9A53          17      CALL    MUL_AHL
001394 5394 22C6F2          16      LD  (CLSZ),HL
001397 5397 E1              10      POP HL
001398 5398 F1              10      POP AF
001399 5399 C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       539A                     MUL_AHL:
00139A 539A 37               4      SCF     ;無限ループ回避
       539B                     MUL_AHL1:
00139B 539B 1F               4      RRA     ;->CF
00139C 539C D8              11      RET C
00139D 539D 29              11      ADD HL,HL
00139E 539E 18FB            12      JR  MUL_AHL1
                                
       53A0                     DPB2DD:
0013A0 53A0 F9                      DB  0F9H    ;MEDIA
0013A1 53A1 0002                    DW  00200H  ;SECSIZ
0013A3 53A3 0F                      DB  00FH    ;DIRMSK
0013A4 53A4 04                      DB  004H    ;DIRSHFT
0013A5 53A5 01                      DB  001H    ;CLUSMSK
0013A6 53A6 02                      DB  002H    ;CLUSSHFT
0013A7 53A7 0100                    DW  00001H  ;FIRFAT
0013A9 53A9 02                      DB  002H    ;FATCNT
0013AA 53AA 70                      DB  070H    ;MAXENT
0013AB 53AB 0E00                    DW  0000EH  ;FIRREC
0013AD 53AD CA02                    DW  002CAH  ;MAXCLUS
0013AF 53AF 03                      DB  003H    ;FATSIZ
0013B0 53B0 0700                    DW  0007H   ;FIRDIR
       53B2                     DPB2DD_E:
                                
       53B2                     AUTOEXEC:
0013B2 53B2 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       53BE                     CMD_RUN:
0013BE 53BE 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
                                #if exists USE_MORMAL32K_OR_ASCII16
0013C4 53C4 80F2                    DW  0F280H
                                #else
                                    DW  0F240H
                                #endif
       53C6                     CMD_CLEAR_E:
0013C6 53C6 3A8A00                  DB  03AH,08AH,0         ;RUN
       53C9                     CMD_RUN_E:
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       53C9                     POP_HL_ERROR:
0013C9 53C9 E1              10      POP     HL
       53CA                     _ERROR:
0013CA 53CA 0600             7      LD  B,0
0013CC 53CC A7               4      AND A
0013CD 53CD C9              10      RET
                                
       53CE                     ROM_BDOS:
0013CE 53CE E5              11      PUSH    HL
0013CF 53CF 79               4      LD  A,C
0013D0 53D0 87               4      ADD A,A
0013D1 53D1 38F7            12      JR  C,_ERROR
0013D3 53D3 6F               4      LD  L,A
0013D4 53D4 265F             7      LD  H,high STABLE
0013D6 53D6 7E               7      LD  A,(HL)
0013D7 53D7 2C               4      INC L
0013D8 53D8 66               7      LD  H,(HL)
0013D9 53D9 6F               4      LD  L,A
0013DA 53DA E3              19      EX  (SP),HL
0013DB 53DB 79               4      LD  A,C
0013DC 53DC C9              10      RET
                                
       53DD                     _PRINT:
       53DD                     PRINT:
0013DD 53DD 7B               4      LD  A,E
0013DE 53DE 1803            12      JR  MSG_A
                                
       53E0                     _SYS01:     ;(BDOS)コンソール入力
0013E0 53E0 CD5754          17      CALL    _SYS07
       53E3                     MSG_A:
0013E3 53E3 FE03             7      CP  3
0013E5 53E5 2814            12      JR  Z,MSG_BR
       53E7                     MSGA1:
0013E7 53E7 F5              11      PUSH    AF
0013E8 53E8 C5              11      PUSH    BC
0013E9 53E9 D5              11      PUSH    DE
0013EA 53EA E5              11      PUSH    HL
0013EB 53EB DDE5            15      PUSH    IX
0013ED 53ED DD21A200        14      LD  IX,CHPUT
0013F1 53F1 CDD942          17      CALL    CALSLT_R
0013F4 53F4 DDE1            14      POP IX
0013F6 53F6 E1              10      POP HL
0013F7 53F7 D1              10      POP DE
0013F8 53F8 C1              10      POP BC
       53F9                     MSGA2:
0013F9 53F9 F1              10      POP AF
0013FA 53FA C9              10      RET
       53FB                     MSG_BR:
0013FB 53FB F5              11      PUSH    AF
0013FC 53FC 3ADDF3          13      LD  A,(CSRX)
0013FF 53FF FE02             7      CP  2
001401 5401 38F6            12      JR  C,MSGA2
001403 5403 F1              10      POP AF
       5404                     MSG_CR:
001404 5404 F5              11      PUSH    AF
001405 5405 3E0D             7      LD  A,00DH
001407 5407 CDE753          17      CALL    MSGA1
00140A 540A 3E0A             7      LD  A,00AH
00140C 540C CDE753          17      CALL    MSGA1
00140F 540F F1              10      POP AF
001410 5410 C9              10      RET
                                
       5411                     _SYS02:     ;(BDOS)コンソール出力
001411 5411 CD2C54          17      CALL    BREAK
001414 5414 1805            12      JR  PRINTX
                                
       5416                     _SYS06:     ;(BDOS)コンソール直接入出力
001416 5416 7B               4      LD  A,E
001417 5417 3C               4      INC A
001418 5418 CA6B54          10      JP  Z,_INKEY
       541B                     PRINTX:
00141B 541B C3DD53          10      JP  _PRINT
                                
       541E                     _SYS08:     ;(BDOS)エコーなしコンソール入力
00141E 541E CD5754          17      CALL    _SYS07
001421 5421 FE03             7      CP  3
001423 5423 CC2C54          17      CALL    Z,_BREAK
001426 5426 FE13             7      CP  013H        ;CTRL+S
001428 5428 C0              11      RET NZ
       5429                     PAUSE:
001429 5429 CD4354          17      CALL    KEYBC
                                
       542C                     _BREAK:
       542C                     BREAK:
00142C 542C F5              11      PUSH    AF
00142D 542D C5              11      PUSH    BC
00142E 542E D5              11      PUSH    DE
00142F 542F E5              11      PUSH    HL
001430 5430 DDE5            15      PUSH    IX
001432 5432 DD21B700        14      LD  IX,BREAKX
001436 5436 CDD942          17      CALL    CALSLT_R
001439 5439 DDE1            14      POP IX
00143B 543B E1              10      POP HL
00143C 543C D1              10      POP DE
00143D 543D C1              10      POP BC
00143E 543E DC2C54          17      CALL    C,_BREAK
001441 5441 F1              10      POP AF
001442 5442 C9              10      RET
       5443                     KEYBC:
001443 5443 F5              11      PUSH    AF
001444 5444 C5              11      PUSH    BC
001445 5445 D5              11      PUSH    DE
001446 5446 E5              11      PUSH    HL
001447 5447 DDE5            15      PUSH    IX
001449 5449 DD215601        14      LD  IX,KILBUF
00144D 544D CDD942          17      CALL    CALSLT_R
001450 5450 DDE1            14      POP IX
001452 5452 E1              10      POP HL
001453 5453 D1              10      POP DE
001454 5454 C1              10      POP BC
001455 5455 F1              10      POP AF
001456 5456 C9              10      RET
                                
       5457                     _SYS07:
       5457                     FLGET:
001457 5457 C5              11      PUSH    BC
001458 5458 D5              11      PUSH    DE
001459 5459 E5              11      PUSH    HL
00145A 545A DDE5            15      PUSH    IX
00145C 545C DD219F00        14      LD  IX,CHGET
001460 5460 CDD942          17      CALL    CALSLT_R
001463 5463 DDE1            14      POP IX
001465 5465 E1              10      POP HL
001466 5466 D1              10      POP DE
001467 5467 C1              10      POP BC
001468 5468 FE03             7      CP  3
00146A 546A C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       546B                     _INKEY:
       546B                     INKEY:
00146B 546B CD0555          17      CALL    CPM_CONST
00146E 546E C8              11      RET Z
00146F 546F 18E6            12      JR  FLGET
                                
       5471                     _SYS0A:     ;(BDOS)文字列入力
001471 5471 C5              11      PUSH    BC
001472 5472 E5              11      PUSH    HL
001473 5473 D5              11      PUSH    DE
001474 5474 CD9D54          17      CALL    GETL
001477 5477 111FF4          10      LD  DE,KBUF
00147A 547A E1              10      POP HL
00147B 547B E5              11      PUSH    HL
00147C 547C 0E00             7      LD  C,0
00147E 547E 3004            12      JR  NC,SAX0
001480 5480 23               6      INC HL
001481 5481 23               6      INC HL
001482 5482 1808            12      JR  SAX4
       5484                     SAX0:
001484 5484 46               7      LD  B,(HL)
001485 5485 23               6      INC HL
       5486                     SAX1:
001486 5486 23               6      INC HL
001487 5487 1A               7      LD  A,(DE)
001488 5488 13               6      INC DE
001489 5489 B7               4      OR  A
00148A 548A 2004            12      JR  NZ,SAX2
       548C                     SAX4:
00148C 548C 360D            10      LD  (HL),00DH
00148E 548E 1804            12      JR  SAX3
       5490                     SAX2:
001490 5490 77               7      LD  (HL),A
001491 5491 0C               4      INC C
001492 5492 10F2            13      DJNZ    SAX1
       5494                     SAX3:
001494 5494 D1              10      POP DE
001495 5495 79               4      LD  A,C
001496 5496 13               6      INC DE
001497 5497 12               7      LD  (DE),A
001498 5498 1B               6      DEC DE
001499 5499 E1              10      POP HL
00149A 549A C1              10      POP BC
00149B 549B A7               4      AND A
00149C 549C C9              10      RET
       549D                     GETL:
00149D 549D DDE5            15      PUSH    IX
00149F 549F FDE5            15      PUSH    IY
                                
0014A1 54A1 2ADCF3          16      LD  HL,(CSRY)
0014A4 54A4 22CAFB          16      LD  (FSTPOS),HL
       54A7                     GETL1:
0014A7 54A7 CD1E54          17      CALL    _SYS08
0014AA 54AA FE09             7      CP  9
0014AC 54AC 2008            12      JR  NZ,GETL1V
0014AE 54AE 211FF4          10      LD  HL,KBUF
0014B1 54B1 CD7043          17      CALL    MSX
0014B4 54B4 18F1            12      JR  GETL1
       54B6                     GETL1V:
0014B6 54B6 5F               4      LD  E,A
0014B7 54B7 FE08             7      CP  8
0014B9 54B9 CC5355          17      CALL    Z,CTRL02
0014BC 54BC FE20             7      CP  020H
0014BE 54BE D47F55          17      CALL    NC,INSERT
0014C1 54C1 CDE753          17      CALL    MSGA1
                                
0014C4 54C4 7B               4      LD  A,E
0014C5 54C5 FE0D             7      CP  00DH
0014C7 54C7 20DE            12      JR  NZ,GETL1
                                
0014C9 54C9 111FF4          10      LD  DE,KBUF
0014CC 54CC 3AB0F3          13      LD  A,(LINLEN)
0014CF 54CF 47               4      LD  B,A
0014D0 54D0 CD5F57          17      CALL    ZERO_MEMORY_DE
                                
0014D3 54D3 2ACAFB          16      LD  HL,(FSTPOS)
0014D6 54D6 3ADCF3          13      LD  A,(CSRY)
0014D9 54D9 6F               4      LD  L,A
0014DA 54DA E5              11      PUSH    HL
0014DB 54DB CDB055          17      CALL    LOC0
0014DE 54DE 4D               4      LD  C,L
0014DF 54DF 44               4      LD  B,H
0014E0 54E0 E1              10      POP HL
0014E1 54E1 3AB0F3          13      LD  A,(LINLEN)
0014E4 54E4 94               4      SUB H
0014E5 54E5 3D               4      DEC A
0014E6 54E6 5F               4      LD  E,A
0014E7 54E7 211FF4          10      LD  HL,KBUF
       54EA                     GETL2:
0014EA 54EA CD4355          17      CALL    _SCRN
0014ED 54ED 03               6      INC BC
0014EE 54EE 77               7      LD  (HL),A
0014EF 54EF 23               6      INC HL
0014F0 54F0 1D               4      DEC E
0014F1 54F1 20F7            12      JR  NZ,GETL2
0014F3 54F3 CD0454          17      CALL    MSG_CR
                                
0014F6 54F6 FDE1            14      POP IY
0014F8 54F8 DDE1            14      POP IX
       54FA                     GETL3:
0014FA 54FA 2B               6      DEC HL
0014FB 54FB 7E               7      LD  A,(HL)
0014FC 54FC FE21             7      CP  021H
0014FE 54FE D0              11      RET NC
0014FF 54FF 3600            10      LD  (HL),0
001501 5501 15               4      DEC D
001502 5502 20F6            12      JR  NZ,GETL3
001504 5504 C9              10      RET
                                
       5505                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       5505                     CONSTX:
       5505                     CPM_CONST:
001505 5505 C5              11      PUSH    BC
001506 5506 D5              11      PUSH    DE
001507 5507 E5              11      PUSH    HL
001508 5508 DDE5            15      PUSH    IX
00150A 550A DD219C00        14      LD  IX,CHSNS
00150E 550E CDD942          17      CALL    CALSLT_R
001511 5511 DDE1            14      POP IX
001513 5513 E1              10      POP HL
001514 5514 D1              10      POP DE
001515 5515 C1              10      POP BC
001516 5516 C9              10      RET
                                
       5517                     _SYS2A:     ;(BDOS)日付の獲得
001517 5517 AF               4      XOR A
001518 5518 57               4      LD  D,A
001519 5519 5F               4      LD  E,A
00151A 551A 67               4      LD  H,A
00151B 551B 6F               4      LD  L,A
00151C 551C C9              10      RET
                                
       551D                     _SYS2C:     ;(BDOS)時刻の獲得
00151D 551D AF               4      XOR A
00151E 551E 57               4      LD  D,A
00151F 551F 5F               4      LD  E,A
001520 5520 67               4      LD  H,A
001521 5521 6F               4      LD  L,A
001522 5522 C9              10      RET
                                
       5523                     POS:
001523 5523 F5              11      PUSH    AF
001524 5524 2ADCF3          16      LD  HL,(CSRY)
001527 5527 7D               4      LD  A,L
001528 5528 6C               4      LD  L,H
001529 5529 67               4      LD  H,A
00152A 552A 2C               4      INC L
00152B 552B 24               4      INC H
00152C 552C F1              10      POP AF
00152D 552D C9              10      RET
                                
       552E                     LOC:
00152E 552E F5              11      PUSH    AF
00152F 552F E5              11      PUSH    HL
001530 5530 7D               4      LD  A,L
001531 5531 6C               4      LD  L,H
001532 5532 67               4      LD  H,A
001533 5533 2D               4      DEC L
001534 5534 25               4      DEC H
001535 5535 DDE5            15      PUSH    IX
001537 5537 DD21C600        14      LD  IX,POSIT
00153B 553B CDD942          17      CALL    CALSLT_R
00153E 553E DDE1            14      POP IX
001540 5540 E1              10      POP HL
001541 5541 F1              10      POP AF
001542 5542 C9              10      RET
                                
       5543                     _SCRN:
       5543                     SCRN:
001543 5543 E5              11      PUSH    HL
001544 5544 DDE5            15      PUSH    IX
                                
001546 5546 69               4      LD  L,C
001547 5547 60               4      LD  H,B
001548 5548 DD214A00        14      LD  IX,RDVRM
00154C 554C CDD942          17      CALL    CALSLT_R
                                
00154F 554F DDE1            14      POP IX
001551 5551 E1              10      POP HL
001552 5552 C9              10      RET
                                
       5553                     CTRL02:
001553 5553 F5              11      PUSH    AF
001554 5554 D5              11      PUSH    DE
001555 5555 2ADCF3          16      LD  HL,(CSRY)
001558 5558 3AB0F3          13      LD  A,(LINLEN)
00155B 555B 4F               4      LD  C,A
00155C 555C 94               4      SUB H   ;CSRX
00155D 555D C602             7      ADD A,2
00155F 555F 47               4      LD  B,A ;カーソルより右の文字数
001560 5560 61               4      LD  H,C ;LINLEN
001561 5561 C5              11      PUSH    BC
001562 5562 CDB055          17      CALL    LOC0
001565 5565 C1              10      POP BC
                                
001566 5566 1620             7      LD  D,020H
       5568                     C8X1:
001568 5568 DD214A00        14      LD  IX,RDVRM
00156C 556C CDD942          17      CALL    CALSLT_R
00156F 556F 4F               4      LD  C,A
001570 5570 7A               4      LD  A,D
001571 5571 DD214D00        14      LD  IX,WRTVRM
001575 5575 CDD942          17      CALL    CALSLT_R
001578 5578 2B               6      DEC HL
001579 5579 51               4      LD  D,C
00157A 557A 10EC            13      DJNZ    C8X1
00157C 557C D1              10      POP DE
00157D 557D F1              10      POP AF
00157E 557E C9              10      RET
                                
       557F                     INSERT:
00157F 557F F5              11      PUSH    AF
001580 5580 D5              11      PUSH    DE
001581 5581 2ADCF3          16      LD  HL,(CSRY)
001584 5584 3AB0F3          13      LD  A,(LINLEN)
001587 5587 4F               4      LD  C,A
001588 5588 94               4      SUB H   ;CSRX
001589 5589 3C               4      INC A
00158A 558A 47               4      LD  B,A ;カーソルより右の文字数
00158B 558B C5              11      PUSH    BC
00158C 558C CDB055          17      CALL    LOC0
00158F 558F C1              10      POP BC
                                
001590 5590 1620             7      LD  D,020H
       5592                     INS1:
001592 5592 DD214A00        14      LD  IX,RDVRM
001596 5596 CDD942          17      CALL    CALSLT_R
001599 5599 4F               4      LD  C,A
00159A 559A 7A               4      LD  A,D
00159B 559B DD214D00        14      LD  IX,WRTVRM
00159F 559F CDD942          17      CALL    CALSLT_R
0015A2 55A2 23               6      INC HL
0015A3 55A3 51               4      LD  D,C
0015A4 55A4 10EC            13      DJNZ    INS1
0015A6 55A6 D1              10      POP DE
0015A7 55A7 F1              10      POP AF
0015A8 55A8 C9              10      RET
                                
       55A9                     CONOUT1:
0015A9 55A9 59               4      LD  E,C
0015AA 55AA C3DD53          10      JP  _PRINT
                                
       55AD                     GETVRAM:
0015AD 55AD 2ADCF3          16      LD  HL,(CSRY)
       55B0                     LOC0:
0015B0 55B0 2D               4      DEC L
0015B1 55B1 25               4      DEC H
0015B2 55B2 4C               4      LD  C,H ;CSRX-1
0015B3 55B3 5D               4      LD  E,L ;CSRY-1
       55B4                     LOC1:
0015B4 55B4 3AB0F3          13      LD  A,(LINLEN)
0015B7 55B7 67               4      LD  H,A
0015B8 55B8 1600             7      LD  D,0
0015BA 55BA 6A               4      LD  L,D ;0
0015BB 55BB 0608             7      LD  B,8
       55BD                     LOC2:
0015BD 55BD 29              11      ADD HL,HL
0015BE 55BE 3001            12      JR  NC,LOC3
0015C0 55C0 19              11      ADD HL,DE
       55C1                     LOC3:
0015C1 55C1 10FA            13      DJNZ    LOC2
0015C3 55C3 09              11      ADD HL,BC
0015C4 55C4 C9              10      RET
                                
       55C5                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0015C5 55C5 212200          10      LD  HL,00022H
0015C8 55C8 AF               4      XOR A
0015C9 55C9 7D               4      LD  A,L
0015CA 55CA C9              10      RET
                                
       55CB                     _SYS0D:     ;(BDOS)ディスク・リセット
0015CB 55CB 218000          10      LD  HL,00080H
0015CE 55CE 22D4F2          16      LD  (_DTA),HL
0015D1 55D1 C9              10      RET
                                
       55D2                     _SYS0E:     ;(BDOS)カレントドライブの設定
0015D2 55D2 7B               4      LD  A,E
       55D3                     _SYS0EX1:
0015D3 55D3 FE08             7      CP  8
0015D5 55D5 3F               4      CCF
0015D6 55D6 D8              11      RET C
0015D7 55D7 32EAF2          13      LD  (_DVSW),A
0015DA 55DA C9              10      RET
                                
       55DB                     _SYS0F:     ;(BDOS)ファイルのオープン
0015DB 55DB D5              11      PUSH    DE
0015DC 55DC FDE1            14      POP IY
0015DE 55DE CD4957          17      CALL    INIT_FILE
0015E1 55E1 CD6B4C          17      CALL    ROM_OPEN
0015E4 55E4 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
0015E6 55E6 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
0015EA 55EA FDE5            15      PUSH    IY
0015EC 55EC D1              10      POP DE
0015ED 55ED 13               6      INC DE
0015EE 55EE 010B00          10      LD  BC,11
0015F1 55F1 EDB0                    LDIR
                                ;               Attribute
0015F3 55F3 7E               7      LD  A,(HL)
0015F4 55F4 FD770D          19      LD  (IY+13),A
                                ;               TIME
0015F7 55F7 110B00          10      LD  DE,11
0015FA 55FA 19              11      ADD HL,DE
0015FB 55FB 7E               7      LD  A,(HL)
0015FC 55FC 23               6      INC HL
0015FD 55FD FD7716          19      LD  (IY+22),A
001600 5600 7E               7      LD  A,(HL)
001601 5601 23               6      INC HL
001602 5602 FD7717          19      LD  (IY+23),A
                                ;               DATE
001605 5605 7E               7      LD  A,(HL)
001606 5606 23               6      INC HL
001607 5607 FD7714          19      LD  (IY+20),A
00160A 560A 7E               7      LD  A,(HL)
00160B 560B 23               6      INC HL
00160C 560C FD7715          19      LD  (IY+21),A
                                ;               First cluster
00160F 560F 7E               7      LD  A,(HL)
001610 5610 23               6      INC HL
001611 5611 FD771A          19      LD  (IY+26),A
001614 5614 7E               7      LD  A,(HL)
001615 5615 23               6      INC HL
001616 5616 FD771B          19      LD  (IY+27),A
                                ;               SIZE
001619 5619 7E               7      LD  A,(HL)
00161A 561A 23               6      INC HL
00161B 561B FD7710          19      LD  (IY+16),A
00161E 561E 7E               7      LD  A,(HL)
00161F 561F 23               6      INC HL
001620 5620 FD7711          19      LD  (IY+17),A
001623 5623 7E               7      LD  A,(HL)
001624 5624 23               6      INC HL
001625 5625 FD7712          19      LD  (IY+18),A
001628 5628 7E               7      LD  A,(HL)
001629 5629 FD7713          19      LD  (IY+19),A
00162C 562C AF               4      XOR A
00162D 562D FD770C          19      LD  (IY+12),A
001630 5630 C9              10      RET
                                
       5631                     _SYS10:     ;(BDOS)ファイルのクローズ
001631 5631 AF               4      XOR A
001632 5632 C9              10      RET
                                
       5633                     S11X1:
001633 5633 FD7119          19      LD  (IY+25),C       ;RootEntCnt
001636 5636 FD750E          19      LD  (IY+14),L
001639 5639 FD740F          19      LD  (IY+15),H
       563C                     SCF_FF_RET:
00163C 563C 37               4      SCF
00163D 563D 9F               4      SBC A,A
00163E 563E C9              10      RET
                                
       563F                     _SYS11:     ;(BDOS)最初のファイルの検索
00163F 563F ED53D7F2        20      LD  (_FCB),DE
001643 5643 D5              11      PUSH    DE
001644 5644 FDE1            14      POP IY
001646 5646 CD4957          17      CALL    INIT_FILE
001649 5649 CDC74E          17      CALL    GET_DIR_DAT
       564C                     S12X1:
00164C 564C CD874C          17      CALL    FILESE
00164F 564F 30E2            12      JR  NC,S11X1
001651 5651 0D               4      DEC C
001652 5652 FD7119          19      LD  (IY+25),C       ;RootEntCnt
001655 5655 FDCB0D66        20      BIT 4,(IY+13)
001659 5659 2809            12      JR  Z,S12X2
00165B 565B E5              11      PUSH    HL
00165C 565C DDE1            14      POP IX
00165E 565E DDCB0E66        20      BIT 4,(IX+1+13)
001662 5662 28E8            12      JR  Z,S12X1
       5664                     S12X2:
001664 5664 012000          10      LD  BC,32
001667 5667 ED5BD4F2        20      LD  DE,(_DTA)
00166B 566B AF               4      XOR A
00166C 566C 12               7      LD  (DE),A      ;ドライブ番号
00166D 566D 13               6      INC DE
00166E 566E EDB0                    LDIR            ;ディレクトリエントリ
001670 5670 FD750E          19      LD  (IY+14),L
001673 5673 FD740F          19      LD  (IY+15),H
001676 5676 C9              10      RET
                                
       5677                     _SYS12:
001677 5677 FD2AD7F2        20      LD  IY,(_FCB)
00167B 567B FDE5            15      PUSH    IY
00167D 567D D1              10      POP DE
00167E 567E CD4957          17      CALL    INIT_FILE
                                
001681 5681 FD6E0E          19      LD  L,(IY+14)
001684 5684 FD660F          19      LD  H,(IY+15)
001687 5687 FD4E19          19      LD  C,(IY+25)
00168A 568A 18C0            12      JR  S12X1
                                
       568C                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
00168C 568C CDAD4E          17      CALL    SET_FCB
00168F 568F CD7B4E          17      CALL    GETSEQ
001692 5692 CD684E          17      CALL    RB_READ
001695 5695 E5              11      PUSH    HL
001696 5696 CD884E          17      CALL    SETSEQ
001699 5699 E1              10      POP HL
       569A                     SREAD:
00169A 569A C601             7      ADD A,001H
00169C 569C D8              11      RET C
                                
00169D 569D 7D               4      LD  A,L
00169E 569E D601             7      SUB 001H
0016A0 56A0 9F               4      SBC A,A
0016A1 56A1 E603             7      AND 3
0016A3 56A3 1F               4      RRA
0016A4 56A4 C9              10      RET
                                
       56A5                     _SYS18:     ;(BDOS)ログインベクトルの獲得
0016A5 56A5 210100          10      LD  HL,00001H
0016A8 56A8 AF               4      XOR A
0016A9 56A9 C9              10      RET
                                
       56AA                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
0016AA 56AA 3AEAF2          13      LD  A,(_DVSW)
0016AD 56AD C9              10      RET
                                
       56AE                     _SYS1A:     ;(BDOS)DTAの設定
0016AE 56AE ED53D4F2        20      LD  (_DTA),DE
0016B2 56B2 AF               4      XOR A
0016B3 56B3 C9              10      RET
                                
       56B4                     _SYS1B:     ;(BDOS)ディスク情報の獲得
0016B4 56B4 010002          10      LD  BC,512
0016B7 56B7 11C302          10      LD  DE,707
0016BA 56BA 210000          10      LD  HL,0
0016BD 56BD DD21D9F2        14      LD  IX,_BUF
0016C1 56C1 FD21D9F2        14      LD  IY,_BUF
0016C5 56C5 FD3600F9        19      LD  (IY+0),0F9H
0016C9 56C9 3E02             7      LD  A,2
0016CB 56CB C9              10      RET
                                
       56CC                     _SYS21:     ;(BDOS)ランダムな読み出し
0016CC 56CC CDAD4E          17      CALL    SET_FCB
                                
0016CF 56CF FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0016D2 56D2 FD6622          19      LD  H,(IY+34)
                                
0016D5 56D5 CD684E          17      CALL    RB_READ
0016D8 56D8 18C0            12      JR  SREAD
                                
       56DA                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
0016DA 56DA CDDB55          17      CALL    _SYS0F
0016DD 56DD D8              11      RET C
                                
0016DE 56DE D5              11      PUSH    DE      ;EX DE,IY
0016DF 56DF FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0016E1 56E1 CD9D4E          17      CALL    GETSIZE
       56E4                     _S24X1:
0016E4 56E4 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
0016E7 56E7 FD7422          19      LD  (IY+34),H
0016EA 56EA FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
0016EE 56EE FDE3            23      EX  (SP),IY     ;
0016F0 56F0 D1              10      POP DE      ;
                                
0016F1 56F1 AF               4      XOR A
0016F2 56F2 C9              10      RET
                                
       56F3                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
0016F3 56F3 E5              11      PUSH    HL
0016F4 56F4 D5              11      PUSH    DE      ;EX DE,IY
0016F5 56F5 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0016F7 56F7 CD7B4E          17      CALL    GETSEQ
0016FA 56FA 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       56FC                     _SYS27:     ;(BDOS)ランダムブロック読み込み
0016FC 56FC CDAD4E          17      CALL    SET_FCB
0016FF 56FF E5              11      PUSH    HL
001700 5700 FD6E21          19      LD  L,(IY+33)
001703 5703 FD6622          19      LD  H,(IY+34)
001706 5706 22CAF2          16      LD  (RR_LOW),HL
001709 5709 FD6E23          19      LD  L,(IY+35)
00170C 570C FD6624          19      LD  H,(IY+36)
00170F 570F 22CCF2          16      LD  (RR_HIGH),HL
001712 5712 E1              10      POP HL
001713 5713 CD384A          17      CALL    ROM_READ
001716 5716 ED5BCAF2        20      LD  DE,(RR_LOW)
00171A 571A FD7321          19      LD  (IY+33),E
00171D 571D FD7222          19      LD  (IY+34),D
001720 5720 ED5BCCF2        20      LD  DE,(RR_HIGH)
001724 5724 FD7323          19      LD  (IY+35),E
001727 5727 FD7224          19      LD  (IY+36),D
00172A 572A 9F               4      SBC A,A
00172B 572B C9              10      RET
                                
       572C                     _SYS2F:
00172C 572C 44               4      LD  B,H
00172D 572D 2AD4F2          16      LD  HL,(_DTA)
001730 5730 C39A51          10      JP  DISKIO
                                
       5733                     _SYS5A:
001733 5733 0600             7      LD  B,0
001735 5735 D5              11      PUSH    DE
001736 5736 DDE1            14      POP IX
       5738                     _SX5A1:
001738 5738 1A               7      LD  A,(DE)
001739 5739 B7               4      OR  A
00173A 573A 2804            12      JR  Z,_SX5A2
00173C 573C 13               6      INC DE
00173D 573D 04               4      INC B
00173E 573E 18F8            12      JR  _SX5A1
                                
       5740                     _SX5A2:
001740 5740 78               4      LD  A,B
001741 5741 CD034B          17      CALL    FILE_BDOS
001744 5744 CD674F          17      CALL    ROM_CD
001747 5747 9F               4      SBC A,A
001748 5748 C9              10      RET
                                
       5749                     INIT_FILE:
001749 5749 EB               4      EX  DE,HL
00174A 574A 11F8F2          10      LD  DE,FDRV
00174D 574D 010C00          10      LD  BC,1+8+3
       5750                     INIT_FILE1:
001750 5750 EDB0                    LDIR
001752 5752 CD6D53          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_MORMAL32K_OR_ASCII16
001755 5755 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
001758 5758 2AEBF2          16      LD  HL,(_CD)
00175B 575B 22F6F2          16      LD  (_CDX),HL           ;カレントディレクトリ
00175E 575E C9              10      RET
                                
       575F                     ZERO_MEMORY_DE:
00175F 575F AF               4      XOR A
       5760                     FILL_MEMORY_DE:
001760 5760 12               7      LD  (DE),A
001761 5761 13               6      INC DE
001762 5762 10FC            13      DJNZ    FILL_MEMORY_DE
001764 5764 C9              10      RET
                                
001765 5765                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 CA53E0531154CA53        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 CA53CA5316545754        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 1E54CA5371540555        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 C555CB55D255DB55        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 31563F567756CA53        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 8C56CA53CA53CA53        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 A556AA56AE56B456        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 CA53CA53CA53DA56        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 F356CA53CA53FC56        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 CA53CA531755CA53        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 1D55CA53CA532C57        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 CA53CA533357CA53        DW  _ERROR,_ERROR,_SYS5A,_ERROR
001FB8 5FB8 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 CA53CA53CA53CA53        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
[EOF:DISKROM32.ASM:UTF_8]
