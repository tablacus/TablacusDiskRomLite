                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
       0001                     USE_MORMAL32K_OR_ASCII16        EQU 1   ;ノーマル32KB/ASCII-16K ROMを作成する
                                
                                    INCLUDE "DISKROM.ASM"
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FDDB                     H_PINL  EQU 0FDDBH
                                
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                            ;ASCII-16K
       6000                     ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
       7000                     ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
                                BANK0_SEL EQU   06000H  ;6000-67FF
                                BANK1_SEL EQU   06800H  ;6800-6FFF
                                BANK2_SEL EQU   07000H  ;7000-77FF
                                BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
                                KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
                                KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
                                KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
                                KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
                                KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
                                KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
                                KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
       F280                     ISC EQU 0F280H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F280                     SP32    EQU 0F280H
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM    ; Main program execution address.
000004 4004 024F                    DW  STATEMENT   ; STATEMENT
000006 4006 2E50                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C3B950          10      JP  DISKIO
000013 4013 C3FF50          10      JP  DSKCHG
000016 4016 C35551          10      JP  GETDPB
000019 4019 C34852          10      JP  CHOICE
00001C 401C C34C52          10      JP  DSKFMT
00001F 401F C34E52          10      JP  DSKSTP
000022 4022 C34F52          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C34C52          10      JP  DSKFMT
000029 4029 C34E52          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C38852          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.4.2.0",0
            204449534B20524F    
            4D204C6974652076    
            302E342E322E3000    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 AF               4      XOR A
000107 4107 2100F3          10      LD  HL,0F300H
00010A 410A 0668             7      LD  B,068H
00010C 410C CDBB4B          17      CALL    FILL_MEMORY
                                
00010F 410F 3E01             7      LD  A,1
000111 4111 3221FB          13      LD  (DRVTBL),A
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
000114 4114 2A74F6          16      LD  HL,(STKTOP) ;起動時の空き容量表示の為
000117 4117 01C0FE          10      LD  BC,-00140H
00011A 411A 09              11      ADD HL,BC
00011B 411B 2274F6          16      LD  (STKTOP),HL
                                #else
                                    LD  HL,STKTOP+1 ;起動時の空き容量表示の為
                                    DEC (HL)
                                #endif
                                
00011E 411E AF               4      XOR A
00011F 411F 32DDF2          13      LD  (_DVSW),A
000122 4122 3D               4      DEC A       ;0FFH
000123 4123 3299FD          13      LD  (DEVICE),A
                                
000126 4126 21E242          10      LD  HL,AT_ISC
000129 4129 1180F2          10      LD  DE,ISC
00012C 412C 017B00          10      LD  BC,ISC_E-ISC
00012F 412F EDB0                    LDIR
                                    
000131 4131 3EC3             7      LD  A,0C3H      ;JP
000133 4133 3243FF          13      LD  (H_GONE),A
000136 4136 327DF3          13      LD  (BDOS),A
000139 4139 326BF3          13      LD  (RAMUSE),A
00013C 413C 3268F3          13      LD  (ROMUSE),A
00013F 413F 2180F2          10      LD  HL,REPLACE_COMMAND
000142 4142 2244FF          16      LD  (H_GONE+1),HL
000145 4145 2131F3          10      LD  HL,H_BDOS
000148 4148 227EF3          16      LD  (BDOS+1),HL
00014B 414B 21B0F2          10      LD  HL,RAMUSE1
00014E 414E 226CF3          16      LD  (RAMUSE+1),HL
000151 4151 21ABF2          10      LD  HL,ROMUSE1
000154 4154 2269F3          16      LD  (ROMUSE+1),HL
                                
000157 4157 3E                      DB  03EH
000158 4158 F7              12      RST 30H
000159 4159 3271FE          13      LD  (H_BINS),A
00015C 415C 3276FE          13      LD  (H_BINL),A
00015F 415F 327BFE          13      LD  (H_FILE),A
000162 4162 3231F3          13      LD  (H_BDOS),A
000165 4165 32DBFD          13      LD  (H_PINL),A
000168 4168 32A7FF          13      LD  (H_PHYD),A
                                
00016B 416B CD2E42          17      CALL    GTSL1_
00016E 416E 3297F2          13      LD  (ROM_SLT),A
000171 4171 32A7F2          13      LD  (ROM_SLT_COPY),A
000174 4174 3272FE          13      LD  (H_BINS+1),A
000177 4177 3277FE          13      LD  (H_BINL+1),A
00017A 417A 327CFE          13      LD  (H_FILE+1),A
00017D 417D 3232F3          13      LD  (H_BDOS+1),A
000180 4180 32DCFD          13      LD  (H_PINL+1),A
000183 4183 32A8FF          13      LD  (H_PHYD+1),A
000186 4186 3222FB          13      LD  (DRVTBL+1),A
000189 4189 3248F3          13      LD  (MASTERS),A
                                
00018C 418C 21A745          10      LD  HL,ROM_LOAD
00018F 418F 2273FE          16      LD  (H_BINS+2),HL
000192 4192 215847          10      LD  HL,ROM_RUN
000195 4195 2278FE          16      LD  (H_BINL+2),HL
000198 4198 216647          10      LD  HL,ROM_FILES
00019B 419B 227DFE          16      LD  (H_FILE+2),HL
00019E 419E 21ED52          10      LD  HL,ROM_BDOS
0001A1 41A1 2233F3          16      LD  (H_BDOS+2),HL
0001A4 41A4 219A43          10      LD  HL,ROM_BOOT
0001A7 41A7 22DDFD          16      LD  (H_PINL+2),HL
0001AA 41AA 21B950          10      LD  HL,DISKIO
0001AD 41AD 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001B0 41B0 3E                      DB  03EH
0001B1 41B1 C9              10      RET
0001B2 41B2 327FFE          13      LD  (H_FILE+4),A
0001B5 41B5 3275FE          13      LD  (H_BINS+4),A
0001B8 41B8 327AFE          13      LD  (H_BINL+4),A
0001BB 41BB 3235F3          13      LD  (H_BDOS+4),A
0001BE 41BE 32DFFD          13      LD  (H_PINL+4),A
0001C1 41C1 32ABFF          13      LD  (H_PHYD+4),A
                                
0001C4 41C4 AF               4      XOR A
                                #if exists USE_MORMAL32K_OR_ASCII16
0001C5 41C5 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001C8 41C8 3A0060          13      LD  A,(BANK1_ADR)
0001CB 41CB FE41             7      CP  'A'
                                #if exists USE_MORMAL32K_OR_ASCII16
0001CD 41CD 284E            12      JR  Z,NOT_BANK_TYPE
0001CF 41CF 3E01             7      LD  A,DISK_BANK
0001D1 41D1 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    JR  NZ,NOT_BANK_TYPE
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001D4 41D4 CD3801          17      CALL    RSLREG      ;read primary slot #
0001D7 41D7 07               4      RLCA
0001D8 41D8 07               4      RLCA
0001D9 41D9 F5              11      PUSH    AF
0001DA 41DA 1605             7      LD  D,4+1
0001DC 41DC CD3542          17      CALL    GTSL2_
0001DF 41DF 3244F3          13      LD  (RAMAD3),A
0001E2 41E2 F1              10      POP AF
0001E3 41E3 07               4      RLCA
0001E4 41E4 07               4      RLCA
0001E5 41E5 1603             7      LD  D,2+1
0001E7 41E7 CD3542          17      CALL    GTSL2_
0001EA 41EA 2680             7      LD  H,080H
0001EC 41EC CD5242          17      CALL    CHK_RAM
0001EF 41EF 3243F3          13      LD  (RAMAD2),A
       41F2                     RAMCHK2:
0001F2 41F2 3A44F3          13      LD  A,(RAMAD3)
0001F5 41F5 2640             7      LD  H,040H
0001F7 41F7 CD5242          17      CALL    CHK_RAM
0001FA 41FA 3242F3          13      LD  (RAMAD1),A
       41FD                     RAMCHK1:
0001FD 41FD 3A44F3          13      LD  A,(RAMAD3)
000200 4200 2600             7      LD  H,00H
000202 4202 CD5242          17      CALL    CHK_RAM
000205 4205 3241F3          13      LD  (RAMAD0),A
       4208                     RAMCHK0:
000208 4208 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
00020B 420B 010F00          10      LD  BC,0000FH       ;切り上げ
00020E 420E 09              11      ADD HL,BC
00020F 420F 7D               4      LD  A,L
                                
000210 4210 0604             7      LD  B,4
       4212                     B_DRIVE1:
000212 4212 CB3C             8      SRL H
000214 4214 1F               4      RRA
000215 4215 10FB            13      DJNZ    B_DRIVE1
                                
000217 4217 C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000219 4219 32DCF2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
00021C 421C C9              10      RET
                                
       421D                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
00021D 421D 21DD43          10      LD  HL,MSG_ERROR_ROM_MODE
000220 4220 CD6043          17      CALL    MSX
000223 4223 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000227 4227 DD219F00        14      LD  IX,CHGET
00022B 422B C31C00          10      JP  _CALSLT
                                
       422E                     GTSL1_:             ;自分のいるスロットを知る
00022E 422E CD3801          17      CALL    RSLREG      ;read primary slot #
000231 4231 0F               4      RRCA
000232 4232 0F               4      RRCA
000233 4233 1601             7      LD  D,1
       4235                     GTSL2_:
000235 4235 E603             7      AND 3       ;[A]=000000PP
000237 4237 5F               4      LD  E,A     ;[E]=000000PP
000238 4238 21C1FC          10      LD  HL,EXPTBL
00023B 423B 85               4      ADD A,L     ;桁上りは無い
00023C 423C 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
00023D 423D 7B               4      LD  A,E     ;[A]=000000PP
00023E 423E CB7E            13      BIT 7,(HL)
000240 4240 C8              11      RET Z
000241 4241 7D               4      LD  A,L     ;point to SLTTBL entry
000242 4242 C604             7      ADD A,4     ;桁上りは無い
000244 4244 6F               4      LD  L,A
000245 4245 7E               7      LD  A,(HL)      ;get currently expansion slot register
       4246                     GTSL3_:
000246 4246 15               4      DEC D
000247 4247 2803            12      JR  Z,GTSL4_:
000249 4249 0F               4      RRCA
00024A 424A 18FA            12      JR  GTSL3_:
       424C                     GTSL4_:
00024C 424C E60C             7      AND 00CH        ;[A] = 0000SS00
00024E 424E B3               4      OR  E       ;[A] = 0000SSPP
00024F 424F F680             7      OR  080H        ;[A] = 1000SSPP
000251 4251 C9              10      RET
                                
       4252                     CHK_RAM:
000252 4252 E5              11      PUSH    HL
000253 4253 CDA742          17      CALL    CHK_RAM0
000256 4256 E1              10      POP HL
000257 4257 C8              11      RET Z
000258 4258 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
00025B 425B E680             7      AND 080H
00025D 425D CD7E42          17      CALL    CHK_RAM_SLT
000260 4260 C8              11      RET Z
000261 4261 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000264 4264 E680             7      AND 080H
000266 4266 C601             7      ADD A,1
000268 4268 CD7E42          17      CALL    CHK_RAM_SLT
00026B 426B C8              11      RET Z
00026C 426C 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00026F 426F E680             7      AND 080H
000271 4271 C602             7      ADD A,2
000273 4273 CD7E42          17      CALL    CHK_RAM_SLT
000276 4276 C8              11      RET Z
000277 4277 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
00027A 427A E680             7      AND 080H
00027C 427C C603             7      ADD A,3
       427E                     CHK_RAM_SLT:
00027E 427E E5              11      PUSH    HL
00027F 427F CDA742          17      CALL    CHK_RAM0        ;スロット#X or X-0
000282 4282 E1              10      POP HL
000283 4283 C8              11      RET Z
000284 4284 CB79             8      BIT 7,C
000286 4286 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000288 4288 79               4      LD  A,C
000289 4289 C604             7      ADD A,4*1           ;スロット#X-1
00028B 428B E5              11      PUSH    HL
00028C 428C CDA742          17      CALL    CHK_RAM0
00028F 428F E1              10      POP HL
000290 4290 C8              11      RET Z
000291 4291 79               4      LD  A,C
000292 4292 C608             7      ADD A,4*2           ;スロット#X-2
000294 4294 E5              11      PUSH    HL
000295 4295 CDA742          17      CALL    CHK_RAM0
000298 4298 E1              10      POP HL
000299 4299 C8              11      RET Z
00029A 429A 79               4      LD  A,C
00029B 429B C60C             7      ADD A,4*3           ;スロット#X-3
00029D 429D E5              11      PUSH    HL
00029E 429E CDA742          17      CALL    CHK_RAM0
0002A1 42A1 E1              10      POP HL
       42A2                     CHK_RAM_E:
0002A2 42A2 AF               4      XOR A
0002A3 42A3 3C               4      INC A           ;ZF=0にする
0002A4 42A4 3E00             7      LD  A,0
0002A6 42A6 C9              10      RET
                                
       42A7                     CHK_RAM0:
0002A7 42A7 4F               4      LD  C,A
0002A8 42A8 3A97F2          13      LD  A,(ROM_SLT)
0002AB 42AB B9               4      CP  C
0002AC 42AC 28F4            12      JR  Z,CHK_RAM_E
0002AE 42AE 2E00             7      LD  L,0
       42B0                     CHK_RAM1:
0002B0 42B0 79               4      LD  A,C
0002B1 42B1 CD9243          17      CALL    RDSLTX
0002B4 42B4 C6E5             7      ADD A,0E5H
0002B6 42B6 47               4      LD  B,A
0002B7 42B7 5F               4      LD  E,A
0002B8 42B8 79               4      LD  A,C
0002B9 42B9 C5              11      PUSH    BC
0002BA 42BA CD1400          17      CALL    _WRSLT
0002BD 42BD C1              10      POP BC
0002BE 42BE 79               4      LD  A,C
0002BF 42BF CD9243          17      CALL    RDSLTX
0002C2 42C2 B8               4      CP  B
0002C3 42C3 C0              11      RET NZ
0002C4 42C4 D6E5             7      SUB 0E5H
0002C6 42C6 79               4      LD  A,C
0002C7 42C7 5F               4      LD  E,A
0002C8 42C8 C5              11      PUSH    BC
0002C9 42C9 CD1400          17      CALL    _WRSLT
0002CC 42CC C1              10      POP BC
0002CD 42CD 24               4      INC H
0002CE 42CE 7D               4      LD  A,L
0002CF 42CF C604             7      ADD A,4
0002D1 42D1 6F               4      LD  L,A
0002D2 42D2 20DC            12      JR  NZ,CHK_RAM1
0002D4 42D4 79               4      LD  A,C     ;ZF=1のハズ
0002D5 42D5 C9              10      RET
                                
       42D6                     CALSLT_R:
0002D6 42D6 C5              11      PUSH    BC
0002D7 42D7 E5              11      PUSH    HL
0002D8 42D8 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0002DC 42DC CD1C00          17      CALL    _CALSLT
0002DF 42DF E1              10      POP HL
0002E0 42E0 C1              10      POP BC
0002E1 42E1 C9              10      RET
                                
       42E2                     AT_ISC:
0002E2 F280                         ORG ISC,AT_ISC-RUN
       F280                     REPLACE_COMMAND:
0002E2 F280 FEB7             7      CP  0B7H            ;FILES
0002E4 F282 CC7BFE          17      CALL    Z,H_FILE
0002E7 F285 FEB5             7      CP  0B5H            ;LOAD
0002E9 F287 CA71FE          10      JP  Z,H_BINS
0002EC F28A FE8A             7      CP  08AH            ;RUN
0002EE F28C CA76FE          10      JP  Z,H_BINL
0002F1 F28F FED6             7      CP  0D6H            ;COPY
0002F3 F291 2813            12      JR  Z,FIX_COPY
0002F5 F293 FECF             7      CP  0CFH            ;BLOAD
0002F7 F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
0002F8 F296 F7              12      RST 30H
       F297                     ROM_SLT:
0002F9 F297 00                      DB  0
0002FA F298 8946                    DW  ROM_BLOAD
0002FC F29A F5              11      PUSH    AF
0002FD F29B E5              11      PUSH    HL
0002FE F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
000301 F29F E1              10      POP HL
000302 F2A0 F1              10      POP AF
000303 F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
000305 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
000307 F2A5 C9              10      RET
       F2A6                     FIX_COPY:
000308 F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
000309 F2A7 00                      DB  0
00030A F2A8 0848                    DW  ROM_COPY
00030C F2AA C9              10      RET
       F2AB                     ROMUSE1:
00030D F2AB 3A97F2          13      LD  A,(ROM_SLT)
000310 F2AE 1803            12      JR  ROMUSE2
       F2B0                     RAMUSE1:
000312 F2B0 3A42F3          13      LD  A,(RAMAD1)
       F2B3                     ROMUSE2:
000315 F2B3 C32400          10      JP  _ENASLT
                                
       F2B6                     _RESULT:
000318 F2B6 00                      DB  0
       F2B7                     _BANK:
000319 F2B7 00                      DB  0
       F2B8                     _BANK1:
00031A F2B8 00                      DB  0
       F2B9                     CLSZ:               ;クラスタサイズ
00031B F2B9 0004                    DW  1024
       F2BA                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2BB                     SECSZ:              ;セクタサイズ
00031D F2BB 0002                    DW  512
       F2BC                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2BD                     RR_LOW:
00031F F2BD 0000                    DW  0
       F2BE                     RR_MID  EQU $-1
       F2BF                     RR_HIGH:
000321 F2BF 0000                    DW  0
       F2C1                     _CLPS:
000323 F2C1 0000                    DW  0
       F2C3                     _LEFT:
000325 F2C3 0000                    DW  0
       F2C5                     _DTPS:
000327 F2C5 0000                    DW  0
       F2C7                     _DTA:
000329 F2C7 0000                    DW  0
       F2C9                     FLG_LDIR:
00032B F2C9 00                      DB  0
       F2CA                     _FCB:
00032C F2CA 0000                    DW  0
       F2CC                     _BUF:
       F2CC                     _BUF_LO:        ;LOGICAL OPERATION
00032E F2CC 00                      DB  0
       F2CD                     _BUF_ST:
00032F F2CD 0000                    DW  0
       F2CF                     _BUF_EN:
000331 F2CF 0000                    DW  0
       F2D1                     _BUF_EX:
       F2D1                     _BUF_W:
000333 F2D1 0000                    DW  0
       F2D3                     _BUF_H:
000335 F2D3 0000                    DW  0
       F2D5                     _BUF_X:
000337 F2D5 0000                    DW  0
       F2D7                     _BUF_Y:
000339 F2D7 00                      DB  0
       F2D8                     _BUF_P:
00033A F2D8 00                      DB  0
       F2D9                     _BUF_O:
00033B F2D9 00                      DB  0
       F2DA                     DTAX:
00033C F2DA 0000                    DW  0
       F2DC                     B_DRIVE:
00033E F2DC 00                      DB  0
       F2DD                     _DVSW:          ;カレントドライブ
00033F F2DD 00                      DB  0
       F2DE                     _CD:            ;カレントディレクトリ
000340 F2DE 0000                    DW  0
       F2E0                     DIRENT1:
000342 F2E0 0000                    DW  0
       F2E2                     _DIR_BANK:
000344 F2E2 00                      DB  0
       F2E3                     LEFTX:
000345 F2E3 0000                    DW  0
       F2E5                     PARAM0:
000347 F2E5 0000                    DW  0
       F2E7                     PARAM1:
000349 F2E7 0000                    DW  0
       F2E9                     _CDX:
00034B F2E9 0000                    DW  0
       F2EB                     FDRV:
00034D F2EB 00                      DB  0
       F2EC                     FNAME:
00034E F2EC                         DS  8+3
       F2F7                     _HL:
000359 F2F7 0000                    DW  0
       F2F9                     _SP:
00035B F2F9 0000                    DW  0
       F2FA                     _SP_H   EQU $-1
       F2FB                     ISC_E:
00035D 435D                         ORG $$+RUN          ;$DEPHASE
                                
       435D                     MSX1:
00035D 435D CD0653          17      CALL    MSGA1
       4360                     MSX:
000360 4360 7E               7      LD  A,(HL)
000361 4361 23               6      INC HL
000362 4362 B7               4      OR  A
000363 4363 20F8            12      JR  NZ,MSX1
000365 4365 C9              10      RET
                                
       4366                     PRTHX:
000366 4366 F5              11      PUSH    AF
000367 4367 07               4      RLCA
000368 4368 07               4      RLCA
000369 4369 07               4      RLCA
00036A 436A 07               4      RLCA
00036B 436B CD6F43          17      CALL    PRTA2
00036E 436E F1              10      POP AF
       436F                     PRTA2:
00036F 436F CD7543          17      CALL    ASC
000372 4372 C30253          10      JP  MSG_A
                                    
       4375                     ASC:
000375 4375 E60F             7      AND $0F
000377 4377 F630             7      OR  $30
000379 4379 FE3A             7      CP  $3A
00037B 437B D8              11      RET C
00037C 437C C607             7      ADD A,7
00037E 437E C9              10      RET
                                
       437F                     MSN:
                                #if exists USE_MORMAL32K_OR_ASCII16
00037F 437F CD8B43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000382 4382 23               6      INC HL
000383 4383 CD0253          17      CALL    MSG_A
000386 4386 10F7            13      DJNZ    MSN
000388 4388 C9              10      RET
                                
       4389                     RDSLT_ROM3:
000389 4389 7E               7      LD  A,(HL)
00038A 438A C9              10      RET
       438B                     RDSLT_ROM:
00038B 438B CB7C             8      BIT 7,H
00038D 438D 28FA            12      JR  Z,RDSLT_ROM3
       438F                     RDSLT_ROM2:
00038F 438F 3A97F2          13      LD  A,(ROM_SLT)
       4392                     RDSLTX:
000392 4392 C5              11      PUSH    BC
000393 4393 D5              11      PUSH    DE
000394 4394 CD0C00          17      CALL    _RDSLT
000397 4397 D1              10      POP DE
000398 4398 C1              10      POP BC
000399 4399 C9              10      RET
                                
       439A                     ROM_BOOT:
00039A 439A 3E                      DB  03EH
00039B 439B C9              10      RET
00039C 439C 32DBFD          13      LD  (H_PINL),A
00039F 439F 3ACAFF          13      LD  A,(EXTBIO)
0003A2 43A2 FEF7             7      CP  0F7H        ;RST 30H
0003A4 43A4 280A            12      JR  Z,EXTBIO_OK
0003A6 43A6 3E                      DB  03EH
0003A7 43A7 C9              10      RET
0003A8 43A8 21CAFF          10      LD  HL,EXTBIO
0003AB 43AB 061D             7      LD  B,29
0003AD 43AD CDBB4B          17      CALL    FILL_MEMORY
       43B0                     EXTBIO_OK:
0003B0 43B0 21FA43          10      LD  HL,DELOK
0003B3 43B3 CD6043          17      CALL    MSX
                                
0003B6 43B6 AF               4      XOR A
0003B7 43B7 3240F3          13      LD  (REBOOT),A
0003BA 43BA 2A48FC          16      LD  HL,(BOTTOM)
0003BD 43BD 110040          10      LD  DE,16384
0003C0 43C0 19              11      ADD HL,DE
0003C1 43C1 3817            12      JR  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
0003C3 43C3 57               4      LD  D,A
0003C4 43C4 0601             7      LD  B,1
0003C6 43C6 2100C0          10      LD  HL,0C000H
0003C9 43C9 CDB950          17      CALL    DISKIO
                                
0003CC 43CC 116BF3          10      LD  DE,RAMUSE
0003CF 43CF AF               4      XOR A
0003D0 43D0 CD1EC0          17      CALL    0C01EH
0003D3 43D3 116BF3          10      LD  DE,RAMUSE
0003D6 43D6 37               4      SCF
0003D7 43D7 CD1EC0          17      CALL    0C01EH
       43DA                     BOOT1:
0003DA 43DA C34F52          10      JP  BASENT
                                
       43DD                     MSG_ERROR_ROM_MODE:
                                #if exists USE_MORMAL32K_OR_ASCII16
0003DD 43DD 4E6F726D616C2052        DB  "Normal ROM/ASCII-16K only!",13,10
            4F4D2F4153434949    
            2D31364B206F6E6C    
            79210D0A            
                                #else
                                    DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
                                #endif
       43F9                     NULL:
0003F9 43F9 00                      DB  0
       43FA                     DELOK:
0003FA 43FA 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       43FE                     ROM_LDIR:
0003FE 43FE 3AC9F2          13      LD  A,(FLG_LDIR)
000401 4401 B7               4      OR  A
000402 4402 206A            12      JR  NZ,ROM_LDIRVM
000404 4404 CB7A             8      BIT 7,D
000406 4406 CA9E44          10      JP  Z,ROM_LDIRSLT
                                #if exists USE_MORMAL32K_OR_ASCII16
       4409                     LDIRA:
000409 4409 F3               4      DI
00040A 440A ED73F9F2        20      LD  (_SP),SP
00040E 440E 3AFAF2          13      LD  A,(_SP_H)
000411 4411 FEC0             7      CP  0C0H
000413 4413 3003            12      JR  NC,SPJ1
000415 4415 3180F2          10      LD  SP,SP32
       4418                     SPJ1:
       4418                     LDIR1:
000418 4418 78               4      LD  A,B
000419 4419 B1               4      OR  C
00041A 441A 284D            12      JR  Z,LDIRE
                                
00041C 441C C5              11      PUSH    BC
00041D 441D D5              11      PUSH    DE
00041E 441E E5              11      PUSH    HL
00041F 441F 3A97F2          13      LD  A,(ROM_SLT)
000422 4422 2680             7      LD  H,080H
000424 4424 CD2400          17      CALL    _ENASLT
000427 4427 E1              10      POP HL
000428 4428 D1              10      POP DE
000429 4429 C1              10      POP BC
       442A                     LDIR2:
00042A 442A 7A               4      LD  A,D
00042B 442B FEC0             7      CP  0C0H
00042D 442D 302C            12      JR  NC,LDIR4
                                
00042F 442F C5              11      PUSH    BC
000430 4430 D5              11      PUSH    DE
000431 4431 115EF5          10      LD  DE,BUF
                                
000434 4434 78               4      LD  A,B
000435 4435 B7               4      OR  A
000436 4436 2803            12      JR  Z,LDIR3
000438 4438 010001          10      LD  BC,00100H
       443B                     LDIR3:
00043B 443B C5              11      PUSH    BC
00043C 443C EDB0                    LDIR
00043E 443E 22F7F2          16      LD  (_HL),HL
                                
000441 4441 3A43F3          13      LD  A,(RAMAD2)
000444 4444 2680             7      LD  H,080H
000446 4446 CD2400          17      CALL    _ENASLT
                                
000449 4449 C1              10      POP BC
00044A 444A D1              10      POP DE
00044B 444B 215EF5          10      LD  HL,BUF
00044E 444E EDB0                    LDIR
                                
000450 4450 2AF7F2          16      LD  HL,(_HL)
000453 4453 C1              10      POP BC
000454 4454 78               4      LD  A,B
000455 4455 B7               4      OR  A
000456 4456 2811            12      JR  Z,LDIRE
000458 4458 05               4      DEC B
000459 4459 18BD            12      JR  LDIR1
       445B                     LDIR4:
                                #endif
00045B 445B EDB0                    LDIR
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
       445D                     LDIRE2:
00045D 445D D5              11      PUSH    DE
00045E 445E E5              11      PUSH    HL
00045F 445F 3A43F3          13      LD  A,(RAMAD2)
000462 4462 2680             7      LD  H,080H
000464 4464 CD2400          17      CALL    _ENASLT
000467 4467 E1              10      POP HL
000468 4468 D1              10      POP DE
       4469                     LDIRE:
000469 4469 ED7BF9F2        20      LD  SP,(_SP)
                                #endif
00046D 446D C9              10      RET
                                
       446E                     ROM_LDIRVM:
                                #if exists USE_MORMAL32K_OR_ASCII16
00046E 446E F3               4      DI
00046F 446F ED73F9F2        20      LD  (_SP),SP
000473 4473 3AFAF2          13      LD  A,(_SP_H)
000476 4476 FEC0             7      CP  0C0H
000478 4478 3003            12      JR  NC,SPJ2
00047A 447A 3180F2          10      LD  SP,SP32
       447D                     SPJ2:
00047D 447D C5              11      PUSH    BC
00047E 447E D5              11      PUSH    DE
00047F 447F E5              11      PUSH    HL
000480 4480 3A97F2          13      LD  A,(ROM_SLT)
000483 4483 2680             7      LD  H,080H
000485 4485 CD2400          17      CALL    _ENASLT
000488 4488 E1              10      POP HL
000489 4489 D1              10      POP DE
00048A 448A C1              10      POP BC
                                #endif
00048B 448B C5              11      PUSH    BC
00048C 448C D5              11      PUSH    DE
00048D 448D FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000491 4491 DD215C00        14      LD  IX,LDIRVM
000495 4495 CD1C00          17      CALL    _CALSLT
000498 4498 E1              10      POP HL
000499 4499 C1              10      POP BC
00049A 449A 09              11      ADD HL,BC
00049B 449B EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
00049C 449C 18BF            12      JR  LDIRE2
                                #else
                                    RET
                                #endif
                                
       449E                     ROM_LDIRSLT:
                                #if exists USE_MORMAL32K_OR_ASCII16
00049E 449E F3               4      DI
00049F 449F ED73F9F2        20      LD  (_SP),SP
0004A3 44A3 3AFAF2          13      LD  A,(_SP_H)
0004A6 44A6 FEC0             7      CP  0C0H
0004A8 44A8 3003            12      JR  NC,SPJ3
0004AA 44AA 3180F2          10      LD  SP,SP32
       44AD                     SPJ3:
0004AD 44AD C5              11      PUSH    BC
0004AE 44AE D5              11      PUSH    DE
0004AF 44AF E5              11      PUSH    HL
0004B0 44B0 3A97F2          13      LD  A,(ROM_SLT)
0004B3 44B3 2680             7      LD  H,080H
0004B5 44B5 CD2400          17      CALL    _ENASLT
0004B8 44B8 E1              10      POP HL
0004B9 44B9 D1              10      POP DE
0004BA 44BA C1              10      POP BC
                                #endif
       44BB                     ROM_LDIRSLT1:
0004BB 44BB EB               4      EX  DE,HL
       44BC                     RLDIRSLT1:
0004BC 44BC CB7C             8      BIT 7,H
0004BE 44BE 2021            12      JR  NZ,RLDIRSLT_EXIT
0004C0 44C0 1A               7      LD  A,(DE)
0004C1 44C1 13               6      INC DE
0004C2 44C2 C5              11      PUSH    BC
0004C3 44C3 D5              11      PUSH    DE
0004C4 44C4 E5              11      PUSH    HL
0004C5 44C5 5F               4      LD  E,A
                                
0004C6 44C6 0141F3          10      LD  BC,RAMAD0
0004C9 44C9 7C               4      LD  A,H
0004CA 44CA 07               4      RLCA
0004CB 44CB 07               4      RLCA
0004CC 44CC E603             7      AND 3
0004CE 44CE 81               4      ADD A,C
0004CF 44CF 4F               4      LD  C,A
0004D0 44D0 0A               7      LD  A,(BC)
       44D1                     RLDIRSLT2:
0004D1 44D1 CD1400          17      CALL    _WRSLT
0004D4 44D4 08               4      EX  AF,AF'
0004D5 44D5 E1              10      POP HL
0004D6 44D6 D1              10      POP DE
0004D7 44D7 C1              10      POP BC
0004D8 44D8 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0004DA 44DA EABC44          10      JP  PE,RLDIRSLT1
0004DD 44DD EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
0004DE 44DE C35D44          10      JP  LDIRE2
       44E1                     RLDIRSLT_EXIT:
0004E1 44E1 EB               4      EX  DE,HL
0004E2 44E2 C31844          10      JP  LDIR1
                                #else
                                    RET
                                RLDIRSLT_EXIT:
                                    EX  DE,HL
                                    LDIR
                                    RET
                                #endif
                                
       44E5                     END_OF_LINE:
0004E5 44E5 215EF5          10      LD  HL,BUF
       44E8                     EOL1:
0004E8 44E8 7E               7      LD  A,(HL)
0004E9 44E9 C8              11      RET Z
0004EA 44EA FE0D             7      CP  00DH
0004EC 44EC 2807            12      JR  Z,EOLE
0004EE 44EE FE0A             7      CP  00AH
0004F0 44F0 2803            12      JR  Z,EOLE
0004F2 44F2 23               6      INC HL
0004F3 44F3 18F3            12      JR  EOL1
       44F5                     EOLE:
0004F5 44F5 3600            10      LD  (HL),0
0004F7 44F7 23               6      INC HL
0004F8 44F8 7E               7      LD  A,(HL)
0004F9 44F9 FE0A             7      CP  00AH
0004FB 44FB C0              11      RET NZ
0004FC 44FC 23               6      INC HL
0004FD 44FD C9              10      RET
                                
       44FE                     ROM_LOAD_ASCII:
0004FE 44FE 210000          10      LD  HL,0
000501 4501 22CDF2          16      LD  (_BUF_ST),HL    ;読み出し位置
000504 4504 2A76F6          16      LD  HL,(TXTTAB)
000507 4507 22CFF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
00050A 450A 215EF5          10      LD  HL,BUF
00050D 450D 22C7F2          16      LD  (_DTA),HL
       4510                     RLOAD_A1:
000510 4510 2ACDF2          16      LD  HL,(_BUF_ST)
000513 4513 22BDF2          16      LD  (RR_LOW),HL
000516 4516 210201          10      LD  HL,258
000519 4519 CD284A          17      CALL    ROM_READ
00051C 451C 7C               4      LD  A,H
00051D 451D B5               4      OR  L
00051E 451E 2879            12      JR  Z,RLOAD_AEND
000520 4520 015EF5          10      LD  BC,BUF
000523 4523 09              11      ADD HL,BC
000524 4524 3600            10      LD  (HL),0
000526 4526 CDE544          17      CALL    END_OF_LINE
000529 4529 015EF5          10      LD  BC,BUF
00052C 452C A7               4      AND A
00052D 452D ED42            15      SBC HL,BC
00052F 452F 2810            12      JR  Z,RLOAD_A2
000531 4531 4D               4      LD  C,L
000532 4532 44               4      LD  B,H
000533 4533 ED5BCDF2        20      LD  DE,(_BUF_ST)
000537 4537 19              11      ADD HL,DE
000538 4538 22CDF2          16      LD  (_BUF_ST),HL
00053B 453B 3A5EF5          13      LD  A,(BUF)
00053E 453E B7               4      OR  A
00053F 453F 28CF            12      JR  Z,RLOAD_A1
       4541                     RLOAD_A2:
000541 4541 115EF5          10      LD  DE,BUF
000544 4544 CDF24B          17      CALL    SPCUTEX
000547 4547 1A               7      LD  A,(DE)
000548 4548 B7               4      OR  A
000549 4549 284E            12      JR  Z,RLOAD_AEND
00054B 454B CD044C          17      CALL    GETNUM
00054E 454E 7C               4      LD  A,H
00054F 454F B5               4      OR  L
000550 4550 CA7046          10      JP  Z,ERROR_DIRECT_IN_FILE
000553 4553 DD2ACFF2        20      LD  IX,(_BUF_EN)
000557 4557 DD7502          19      LD  (IX+2),L
00055A 455A DD7403          19      LD  (IX+3),H
                                
00055D 455D CDEB4B          17      CALL    SPCUT
000560 4560 EB               4      EX  DE,HL
000561 4561 DDE5            15      PUSH    IX
000563 4563 DD21B242        14      LD  IX,CRUNCH
000567 4567 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00056B 456B CD1C00          17      CALL    _CALSLT
00056E 456E DDE1            14      POP IX
000570 4570 EB               4      EX  DE,HL
000571 4571 111FF4          10      LD  DE,KBUF
000574 4574 37               4      SCF
000575 4575 ED52            15      SBC HL,DE
000577 4577 CA7046          10      JP  Z,ERROR_DIRECT_IN_FILE
00057A 457A DA7046          10      JP  C,ERROR_DIRECT_IN_FILE
00057D 457D 4D               4      LD  C,L
00057E 457E 44               4      LD  B,H
00057F 457F 2ACFF2          16      LD  HL,(_BUF_EN)
000582 4582 110400          10      LD  DE,4
000585 4585 19              11      ADD HL,DE
000586 4586 111FF4          10      LD  DE,KBUF
                                
000589 4589 EB               4      EX  DE,HL
00058A 458A EDB0                    LDIR
00058C 458C EB               4      EX  DE,HL
                                
00058D 458D DD7500          19      LD  (IX+0),L
000590 4590 DD7401          19      LD  (IX+1),H
000593 4593 22CFF2          16      LD  (_BUF_EN),HL
000596 4596 C31045          10      JP  RLOAD_A1
                                
       4599                     RLOAD_AEND:
000599 4599 2ACFF2          16      LD  HL,(_BUF_EN)
00059C 459C AF               4      XOR A
00059D 459D 77               7      LD  (HL),A
00059E 459E 23               6      INC HL
00059F 459F 77               7      LD  (HL),A
0005A0 45A0 23               6      INC HL
0005A1 45A1 22CFF2          16      LD  (_BUF_EN),HL
0005A4 45A4 C33346          10      JP  RLOAD_END1
                                
       45A7                     ROM_LOAD:
0005A7 45A7 CDD647          17      CALL    INIT_PARAM
0005AA 45AA 7E               7      LD  A,(HL)
0005AB 45AB FE2C             7      CP  ','
0005AD 45AD 2003            12      JR  NZ,ROM_LOAD0
0005AF 45AF 23               6      INC HL
0005B0 45B0 7E               7      LD  A,(HL)
0005B1 45B1 2B               6      DEC HL
       45B2                     ROM_LOAD0:
0005B2 45B2 32BEFC          13      LD  (RUNBNF),A
0005B5 45B5 CDC94A          17      CALL    FILE_B
0005B8 45B8 3AECF2          13      LD  A,(FNAME)
0005BB 45BB FE20             7      CP  020H
0005BD 45BD CAC44A          10      JP  Z,ROM_ORG
                                
0005C0 45C0 CD5B4C          17      CALL    ROM_OPEN
0005C3 45C3 DA7C46          10      JP  C,ERROR_FILE_NOT_FOUND
       45C6                     ROM_LOAD1:
0005C6 45C6 21CCF2          10      LD  HL,_BUF
0005C9 45C9 22C7F2          16      LD  (_DTA),HL
0005CC 45CC 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
0005CF 45CF CD284A          17      CALL    ROM_READ
0005D2 45D2 3ACCF2          13      LD  A,(_BUF)
0005D5 45D5 3C               4      INC A
0005D6 45D6 C2FE44          10      JP  NZ,ROM_LOAD_ASCII
0005D9 45D9 2A76F6          16      LD  HL,(TXTTAB)
0005DC 45DC 22C7F2          16      LD  (_DTA),HL
0005DF 45DF EB               4      EX  DE,HL
0005E0 45E0 2100FF          10      LD  HL,-256
0005E3 45E3 39              11      ADD HL,SP
0005E4 45E4 ED52            15      SBC HL,DE
0005E6 45E6 CD284A          17      CALL    ROM_READ
0005E9 45E9 ED5BC7F2        20      LD  DE,(_DTA)
0005ED 45ED 19              11      ADD HL,DE
0005EE 45EE E5              11      PUSH    HL
0005EF 45EF 2A76F6          16      LD  HL,(TXTTAB)
       45F2                     ROM_LOAD2:          ;リンクポインタをFIX
0005F2 45F2 E5              11      PUSH    HL
0005F3 45F3 DDE1            14      POP IX
0005F5 45F5 7E               7      LD  A,(HL)      ;リンクポインタL
0005F6 45F6 23               6      INC HL
0005F7 45F7 B6               7      OR  (HL)        ;リンクポインタH
0005F8 45F8 23               6      INC HL
0005F9 45F9 2837            12      JR  Z,RLOAD_END0
0005FB 45FB 23               6      INC HL      ;行番号
0005FC 45FC 23               6      INC HL      ;行番号
       45FD                     ROM_LOAD3:
0005FD 45FD 7E               7      LD  A,(HL)
0005FE 45FE 23               6      INC HL
0005FF 45FF FE0B             7      CP  00BH        ;8進数(&O)
000601 4601 2822            12      JR  Z,INC_HL2
000603 4603 FE0C             7      CP  00CH        ;16進数(&H)
000605 4605 281E            12      JR  Z,INC_HL2
000607 4607 FE0D             7      CP  00DH        ;行番号(RUN後)
000609 4609 281A            12      JR  Z,INC_HL2
00060B 460B FE0E             7      CP  00EH        ;行番号(RUN前)
00060D 460D 2816            12      JR  Z,INC_HL2
00060F 460F FE0F             7      CP  00FH        ;10～255の整数(%)
000611 4611 2813            12      JR  Z,INC_HL1
000613 4613 FE1C             7      CP  01CH        ;256～65535の整数(%)
000615 4615 280E            12      JR  Z,INC_HL2
000617 4617 FE1D             7      CP  01DH        ;単精度実数(!)
000619 4619 2808            12      JR  Z,INC_HL4
00061B 461B FE1F             7      CP  01FH        ;倍制度実数(#)
00061D 461D 2008            12      JR  NZ,INC_HL0
00061F 461F 23               6      INC HL
000620 4620 23               6      INC HL
000621 4621 23               6      INC HL
000622 4622 23               6      INC HL
       4623                     INC_HL4:
000623 4623 23               6      INC HL
000624 4624 23               6      INC HL
       4625                     INC_HL2:
000625 4625 23               6      INC HL
       4626                     INC_HL1:
000626 4626 23               6      INC HL
       4627                     INC_HL0:
000627 4627 B7               4      OR  A
000628 4628 20D3            12      JR  NZ,ROM_LOAD3
00062A 462A DD7500          19      LD  (IX+0),L
00062D 462D DD7401          19      LD  (IX+1),H
000630 4630 18C0            12      JR  ROM_LOAD2
       4632                     RLOAD_END0:
000632 4632 E1              10      POP HL
       4633                     RLOAD_END1:
000633 4633 22C2F6          16      LD  (VARTAB),HL
000636 4636 22C4F6          16      LD  (ARYTAB),HL
000639 4639 22C6F6          16      LD  (STREND),HL
                                
00063C 463C 3ABEFC          13      LD  A,(RUNBNF)
00063F 463F CD454C          17      CALL    CAP
000642 4642 FE52             7      CP  'R'
000644 4644 280E            12      JR  Z,RLOAD_END2
000646 4646 AF               4      XOR A
000647 4647 21CFF2          10      LD  HL,_BUF+3
00064A 464A 77               7      LD  (HL),A      ;3
00064B 464B 2B               6      DEC HL
00064C 464C 77               7      LD  (HL),A      ;2
00064D 464D 2B               6      DEC HL
00064E 464E 77               7      LD  (HL),A      ;1
00064F 464F 2B               6      DEC HL
000650 4650 3E8F             7      LD  A,08FH      ;REM
000652 4652 77               7      LD  (HL),A      ;0
000653 4653 C9              10      RET
       4654                     RLOAD_END2:
000654 4654 D5              11      PUSH    DE
000655 4655 ED5B76F6        20      LD  DE,(TXTTAB)
000659 4659 1B               6      DEC DE
00065A 465A AF               4      XOR A
00065B 465B 21D2F2          10      LD  HL,_BUF+6
00065E 465E 77               7      LD  (HL),A      ;6
00065F 465F 2B               6      DEC HL
000660 4660 77               7      LD  (HL),A      ;5
000661 4661 2B               6      DEC HL
000662 4662 77               7      LD  (HL),A      ;4
000663 4663 2B               6      DEC HL
000664 4664 72               7      LD  (HL),D      ;3 行番号H
000665 4665 2B               6      DEC HL
000666 4666 73               7      LD  (HL),E      ;2 行番号L
000667 4667 2B               6      DEC HL
000668 4668 360D            10      LD  (HL),00DH   ;1 行番号(RUN後)
00066A 466A 2B               6      DEC HL
00066B 466B 3E89             7      LD  A,089H      ;GOTO
00066D 466D 77               7      LD  (HL),A      ;0
00066E 466E D1              10      POP DE
00066F 466F C9              10      RET
                                
       4670                     ERROR_DIRECT_IN_FILE:
000670 4670 1E39             7      LD  E,57            ;Direct statement in file
000672 4672 01                      DB  1           ;LD BC,
       4673                     ERROR_DEVICE_IO_ERROR:
000673 4673 1E13             7      LD  E,19            ;Device I/O error
000675 4675 01                      DB  1           ;LD BC,
       4676                     ERROR_INTERNAL_ERROR:
000676 4676 1E33             7      LD  E,51            ;Internal error
000678 4678 01                      DB  1           ;LD BC,
       4679                     ERROR_FILE_NOT_OPEN:
000679 4679 1E3B             7      LD  E,59            ;File not OPEN
00067B 467B 01                      DB  1           ;LD BC,
       467C                     ERROR_FILE_NOT_FOUND:
00067C 467C 1E35             7      LD  E,53            ;File not found
       467E                     ERROR:
00067E 467E FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000682 4682 DD216F40        14      LD  IX,ERRHAND
000686 4686 C31C00          10      JP  _CALSLT
                                
       4689                     ROM_BLOAD:
000689 4689 CDD647          17      CALL    INIT_PARAM
00068C 468C CDC94A          17      CALL    FILE_B
00068F 468F CD5B4C          17      CALL    ROM_OPEN
000692 4692 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000694 4694 21CCF2          10      LD  HL,_BUF
000697 4697 22C7F2          16      LD  (_DTA),HL
00069A 469A 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
00069D 469D CD284A          17      CALL    ROM_READ
0006A0 46A0 3ACCF2          13      LD  A,(_BUF)
0006A3 46A3 FEFE             7      CP  0FEH
0006A5 46A5 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
0006A7 46A7 21A5F2          10      LD  HL,BLOAD_RET
0006AA 46AA 229DF2          16      LD  (SWC_BLOAD),HL
                                
0006AD 46AD 2AE7F2          16      LD  HL,(PARAM1)
0006B0 46B0 7E               7      LD  A,(HL)
0006B1 46B1 FE2C             7      CP  ','
0006B3 46B3 2049            12      JR  NZ,RBREAD_MEM
0006B5 46B5 23               6      INC HL
0006B6 46B6 7E               7      LD  A,(HL)
0006B7 46B7 CD454C          17      CALL    CAP
0006BA 46BA 32BEFC          13      LD  (RUNBNF),A
0006BD 46BD FE52             7      CP  'R'     ;R,Sスイッチじゃ無い場合はオフセット値として処理する
0006BF 46BF 2808            12      JR  Z,RBOS1
0006C1 46C1 FE53             7      CP  'S'
0006C3 46C3 2804            12      JR  Z,RBOS1
0006C5 46C5 FE2C             7      CP  ','
0006C7 46C7 200D            12      JR  NZ,RBOS2
       46C9                     RBOS1:
0006C9 46C9 7E               7      LD  A,(HL)
0006CA 46CA 23               6      INC HL
0006CB 46CB B7               4      OR  A
0006CC 46CC 2824            12      JR  Z,RBREAD_OSE
0006CE 46CE FE3A             7      CP  ':'
0006D0 46D0 2820            12      JR  Z,RBREAD_OSE
0006D2 46D2 FE2C             7      CP  ','     ;次のパラメータを探す
0006D4 46D4 20F3            12      JR  NZ,RBOS1
       46D6                     RBOS2:              ;オフセット
0006D6 46D6 22E7F2          16      LD  (PARAM1),HL
0006D9 46D9 7E               7      LD  A,(HL)
0006DA 46DA B7               4      OR  A
0006DB 46DB 2815            12      JR  Z,RBREAD_OSE
0006DD 46DD DD212F54        14      LD  IX,FRMQNT
0006E1 46E1 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0006E5 46E5 CD1C00          17      CALL    _CALSLT
0006E8 46E8 22E7F2          16      LD  (PARAM1),HL
0006EB 46EB 2ACDF2          16      LD  HL,(_BUF_ST)
0006EE 46EE 19              11      ADD HL,DE
0006EF 46EF 22CDF2          16      LD  (_BUF_ST),HL
       46F2                     RBREAD_OSE:
0006F2 46F2 3ABEFC          13      LD  A,(RUNBNF)
0006F5 46F5 FE53             7      CP  'S'
0006F7 46F7 2005            12      JR  NZ,RBREAD_MEM
0006F9 46F9 3E01             7      LD  A,1
0006FB 46FB 32C9F2          13      LD  (FLG_LDIR),A
       46FE                     RBREAD_MEM:
0006FE 46FE 2ACDF2          16      LD  HL,(_BUF_ST)
000701 4701 22BFFC          16      LD  (SAVENT),HL
000704 4704 22C7F2          16      LD  (_DTA),HL
000707 4707 21FFFF          10      LD  HL,0FFFFH
00070A 470A CD284A          17      CALL    ROM_READ
00070D 470D AF               4      XOR A
00070E 470E 32C9F2          13      LD  (FLG_LDIR),A
000711 4711 3ABEFC          13      LD  A,(RUNBNF)
000714 4714 FE52             7      CP  'R'
000716 4716 2006            12      JR  NZ,RBREAD1
000718 4718 2AD1F2          16      LD  HL,(_BUF_EX)
00071B 471B 229DF2          16      LD  (SWC_BLOAD),HL
       471E                     RBREAD1:
       471E                     ROM_NEXT:
00071E 471E 2AE7F2          16      LD  HL,(PARAM1)
000721 4721 7E               7      LD  A,(HL)
000722 4722 2B               6      DEC HL
000723 4723 B7               4      OR  A
000724 4724 2805            12      JR  Z,ROM_NEXT1
000726 4726 FE3A             7      CP  ':'
000728 4728 2801            12      JR  Z,ROM_NEXT1
00072A 472A 23               6      INC HL
       472B                     ROM_NEXT1:
00072B 472B 5D               4      LD  E,L
00072C 472C 54               4      LD  D,H
                                
00072D 472D CD1B4C          17      CALL    SEARCH_END
000730 4730 B7               4      OR  A
000731 4731 2821            12      JR  Z,REM
       4733                     RN3:                    ;マルチステートメントの処理
000733 4733 7E               7      LD  A,(HL)
                                
000734 4734 FEB5             7      CP  0B5H            ;LOAD
000736 4736 CAA745          10      JP  Z,ROM_LOAD
000739 4739 FE8A             7      CP  08AH            ;RUN
00073B 473B 281B            12      JR  Z,ROM_RUN
00073D 473D FEB7             7      CP  0B7H            ;FILES
00073F 473F 2825            12      JR  Z,ROM_FILES
000741 4741 FED6             7      CP  0D6H            ;COPY
000743 4743 CA0848          10      JP  Z,ROM_COPY
000746 4746 FE20             7      CP  020H
000748 4748 2807            12      JR  Z,RN_SP
                                
00074A 474A 3E28             7      LD  A,028H          ;JR Z,
00074C 474C 32A3F2          13      LD  (SWC_BLOAD_M),A
00074F 474F 7E               7      LD  A,(HL)
000750 4750 C9              10      RET
       4751                     RN_SP:
000751 4751 23               6      INC HL
000752 4752 18DF            12      JR  RN3
                                
       4754                     REM:
000754 4754 EB               4      EX  DE,HL
000755 4755 3E8F             7      LD  A,08FH          ;REM
000757 4757 C9              10      RET
                                
       4758                     ROM_RUN:
000758 4758 23               6      INC HL
000759 4759 7E               7      LD  A,(HL)
00075A 475A 2B               6      DEC HL
00075B 475B B7               4      OR  A
00075C 475C C4A745          17      CALL    NZ,ROM_LOAD
00075F 475F FE8F             7      CP  08FH            ;REM
000761 4761 3E8A             7      LD  A,08AH          ;RUN
000763 4763 C0              11      RET NZ
000764 4764 77               7      LD  (HL),A
000765 4765 C9              10      RET
                                
       4766                     ROM_FILES:
000766 4766 CDD647          17      CALL    INIT_PARAM
000769 4769 CDC94A          17      CALL    FILE_B
00076C 476C CD8C52          17      CALL    GET_DISK_BANK_FDRV
00076F 476F 3ABCF2          13      LD  A,(SECSZ_H)
000772 4772 CD4A51          17      CALL    IS_BPB1
000775 4775 DA7346          10      JP  C,ERROR_DEVICE_IO_ERROR
000778 4778 3AECF2          13      LD  A,(FNAME)
00077B 477B FE21             7      CP  021H
00077D 477D 3005            12      JR  NC,RFILES0
00077F 477F 060B             7      LD  B,11
000781 4781 CDAF4B          17      CALL    FILE10
       4784                     RFILES0:
000784 4784 CDB74E          17      CALL    GET_DIR_DAT
       4787                     RFILES1:
000787 4787 CD774C          17      CALL    FILESE
00078A 478A 3045            12      JR  NC,RFILES_NOT_MATCH
       478C                     RFILES_DISP:
00078C 478C E5              11      PUSH    HL
00078D 478D 110B00          10      LD  DE,0000BH   ;属性
000790 4790 19              11      ADD HL,DE
                                #if exists USE_MORMAL32K_OR_ASCII16
000791 4791 CD8B43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000794 4794 E1              10      POP HL
000795 4795 CB4F             8      BIT 1,A     ;不可視属性
000797 4797 2035            12      JR  NZ,RFILES_NEXT
000799 4799 E5              11      PUSH    HL
00079A 479A 0608             7      LD  B,8
00079C 479C CD7F43          17      CALL    MSN
                                #if exists USE_MORMAL32K_OR_ASCII16
00079F 479F CD8B43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
0007A2 47A2 FE20             7      CP  020H
0007A4 47A4 F5              11      PUSH    AF
0007A5 47A5 3E2E             7      LD  A,'.'
0007A7 47A7 C40253          17      CALL    NZ,MSG_A
0007AA 47AA 0603             7      LD  B,3
0007AC 47AC CD7F43          17      CALL    MSN
0007AF 47AF F1              10      POP AF
0007B0 47B0 CC0253          17      CALL    Z,MSG_A
0007B3 47B3 3ADDF3          13      LD  A,(CSRX)
0007B6 47B6 47               4      LD  B,A
0007B7 47B7 3AB0F3          13      LD  A,(LINLEN)
0007BA 47BA 90               4      SUB B
0007BB 47BB FE0C             7      CP  12
0007BD 47BD 3009            12      JR  NC,RFILES2
0007BF 47BF 3E0D             7      LD  A,00DH      ;改行
0007C1 47C1 CD0253          17      CALL    MSG_A
0007C4 47C4 3E0A             7      LD  A,00AH
0007C6 47C6 1802            12      JR  RFILES3
       47C8                     RFILES2:
0007C8 47C8 3E20             7      LD  A,020H
       47CA                     RFILES3:
0007CA 47CA CD0253          17      CALL    MSG_A
0007CD 47CD E1              10      POP HL
       47CE                     RFILES_NEXT:
0007CE 47CE CD954C          17      CALL    FNEXT
       47D1                     RFILES_NOT_MATCH:
0007D1 47D1 20B4            12      JR  NZ,RFILES1
0007D3 47D3 C31E47          10      JP  ROM_NEXT
                                
       47D6                     INIT_PARAM:
0007D6 47D6 22E5F2          16      LD  (PARAM0),HL
0007D9 47D9 22E7F2          16      LD  (PARAM1),HL
0007DC 47DC EB               4      EX  DE,HL
0007DD 47DD 32BEFC          13      LD  (RUNBNF),A
0007E0 47E0 3263F6          13      LD  (VALTYP),A
0007E3 47E3 E5              11      PUSH    HL
0007E4 47E4 2ADEF2          16      LD  HL,(_CD)
0007E7 47E7 22E9F2          16      LD  (_CDX),HL
0007EA 47EA E1              10      POP HL
0007EB 47EB 13               6      INC DE
0007EC 47EC CDEB4B          17      CALL    SPCUT
0007EF 47EF 1A               7      LD  A,(DE)
0007F0 47F0 B7               4      OR  A
0007F1 47F1 C8              11      RET Z
0007F2 47F2 FE3A             7      CP  ':'
0007F4 47F4 C8              11      RET Z
0007F5 47F5 FE28             7      CP  '('
0007F7 47F7 C8              11      RET Z
0007F8 47F8 EB               4      EX  DE,HL
0007F9 47F9 DD21644C        14      LD  IX,FRMEVL
0007FD 47FD FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000801 4801 CD1C00          17      CALL    _CALSLT
000804 4804 22E7F2          16      LD  (PARAM1),HL
000807 4807 C9              10      RET
                                
       4808                     ROM_COPY:
000808 4808 CDD647          17      CALL    INIT_PARAM
00080B 480B 3A63F6          13      LD  A,(VALTYP)
00080E 480E FE03             7      CP  3       ;string
000810 4810 C2C44A          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
000813 4813 CDC94A          17      CALL    FILE_B
000816 4816 CD5B4C          17      CALL    ROM_OPEN
000819 4819 DA7C46          10      JP  C,ERROR_FILE_NOT_FOUND
                                
00081C 481C 21D1F2          10      LD  HL,_BUF_W
00081F 481F 22C7F2          16      LD  (_DTA),HL
000822 4822 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
000825 4825 CD284A          17      CALL    ROM_READ
                                
000828 4828 AF               4      XOR A
000829 4829 32CCF2          13      LD  (_BUF_LO),A     ;PSET
00082C 482C 32D9F2          13      LD  (_BUF_O),A      ;向き
                                
00082F 482F 2AE7F2          16      LD  HL,(PARAM1)
       4832                     RCP_PARAM1:
000832 4832 7E               7      LD  A,(HL)
000833 4833 23               6      INC HL
000834 4834 B7               4      OR  A
000835 4835 CA2B47          10      JP  Z,ROM_NEXT1
000838 4838 FE3A             7      CP  ':'
00083A 483A CA2B47          10      JP  Z,ROM_NEXT1
00083D 483D FE2C             7      CP  ','
00083F 483F 2012            12      JR  NZ,RCP_PARAM1_
                                
000841 4841 DD212F54        14      LD  IX,FRMQNT
000845 4845 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000849 4849 CD1C00          17      CALL    _CALSLT
00084C 484C 7B               4      LD  A,E
00084D 484D 87               4      ADD A,A
00084E 484E 87               4      ADD A,A
00084F 484F 32D9F2          13      LD  (_BUF_O),A
000852 4852 7E               7      LD  A,(HL)
       4853                     RCP_PARAM1_:
000853 4853 FE28             7      CP  '('
000855 4855 20DB            12      JR  NZ,RCP_PARAM1
000857 4857 DD212F54        14      LD  IX,FRMQNT
00085B 485B FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00085F 485F CD1C00          17      CALL    _CALSLT
                                
000862 4862 ED53D5F2        20      LD  (_BUF_X),DE
                                
       4866                     RCP_PARAM2:
000866 4866 23               6      INC HL
000867 4867 7E               7      LD  A,(HL)
000868 4868 FE20             7      CP  020H
00086A 486A 28FA            12      JR  Z,RCP_PARAM2
00086C 486C FE2C             7      CP  ','
00086E 486E 28F6            12      JR  Z,RCP_PARAM2
                                
000870 4870 DD212F54        14      LD  IX,FRMQNT
000874 4874 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000878 4878 CD1C00          17      CALL    _CALSLT
                                
00087B 487B 3AF6FA          13      LD  A,(ACPAGE)
00087E 487E 57               4      LD  D,A
00087F 487F ED53D7F2        20      LD  (_BUF_Y),DE
       4883                     RCP_PARAM3:
000883 4883 23               6      INC HL
000884 4884 7E               7      LD  A,(HL)
000885 4885 FE20             7      CP  020H
000887 4887 28FA            12      JR  Z,RCP_PARAM3
000889 4889 FE29             7      CP  ')'
00088B 488B 28F6            12      JR  Z,RCP_PARAM3
00088D 488D FE2C             7      CP  ','
00088F 488F 2033            12      JR  NZ,RCP_ST
                                
000891 4891 23               6      INC HL
000892 4892 DD212F54        14      LD  IX,FRMQNT
000896 4896 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00089A 489A CD1C00          17      CALL    _CALSLT
                                
00089D 489D 7B               4      LD  A,E
00089E 489E 32D8F2          13      LD  (_BUF_P),A
                                
       48A1                     RCP_PARAM4:
0008A1 48A1 7E               7      LD  A,(HL)
0008A2 48A2 23               6      INC HL
0008A3 48A3 FE20             7      CP  020H
0008A5 48A5 28FA            12      JR  Z,RCP_PARAM4
                                
0008A7 48A7 FE2C             7      CP  ','
0008A9 48A9 2019            12      JR  NZ,RCP_ST
                                
0008AB 48AB 7E               7      LD  A,(HL)
0008AC 48AC 0604             7      LD  B,4
0008AE 48AE FEC3             7      CP  0C3H        ;PRESET
0008B0 48B0 280E            12      JR  Z,RCP_LO
0008B2 48B2 05               4      DEC B       ;3
0008B3 48B3 D6F8             7      SUB 0F8H        ;XOR
0008B5 48B5 2809            12      JR  Z,RCP_LO
0008B7 48B7 05               4      DEC B       ;2
0008B8 48B8 3C               4      INC A       ;OR
0008B9 48B9 2805            12      JR  Z,RCP_LO
0008BB 48BB 05               4      DEC B       ;1
0008BC 48BC 3C               4      INC A       ;AND
0008BD 48BD 2801            12      JR  Z,RCP_LO
0008BF 48BF 05               4      DEC B       ;0
                                                ;PSET
       48C0                     RCP_LO:
0008C0 48C0 78               4      LD  A,B
0008C1 48C1 32CCF2          13      LD  (_BUF_LO),A
       48C4                     RCP_ST:
0008C4 48C4 2AC6F6          16      LD  HL,(STREND)
0008C7 48C7 22C7F2          16      LD  (_DTA),HL
0008CA 48CA EB               4      EX  DE,HL
0008CB 48CB 2100FE          10      LD  HL,-512
0008CE 48CE 39              11      ADD HL,SP
0008CF 48CF AF               4      XOR A
0008D0 48D0 ED52            15      SBC HL,DE
0008D2 48D2 3008            12      JR  NC,RCP0
0008D4 48D4 215EF5          10      LD  HL,BUF
0008D7 48D7 22C7F2          16      LD  (_DTA),HL
0008DA 48DA 6F               4      LD  L,A ;0
0008DB 48DB 67               4      LD  H,A ;0
       48DC                     RCP0:
0008DC 48DC 24               4      INC H
0008DD 48DD 22CFF2          16      LD  (_BUF_EN),HL
       48E0                     RCP1:
0008E0 48E0 F3               4      DI
0008E1 48E1 CDB649          17      CALL    WAIT_VDP
                                
0008E4 48E4 3A0700          13      LD  A,(WRVDP)
0008E7 48E7 4F               4      LD  C,A
0008E8 48E8 0C               4      INC C       ;C := PORT#1's address(WR)
0008E9 48E9 3E24             7      LD  A,36
0008EB 48EB ED79            12      OUT (C),A
0008ED 48ED 3E91             7      LD  A,080H+17
0008EF 48EF ED79            12      OUT (C),A       ;R#17 := 36
                                
0008F1 48F1 0C               4      INC C
0008F2 48F2 0C               4      INC C       ;C := PORT#3's address(WR)
0008F3 48F3 2AD5F2          16      LD  HL,(_BUF_X)
0008F6 48F6 ED69            12      OUT (C),L       ;R#36 DX
0008F8 48F8 ED61            12      OUT (C),H       ;R#37
0008FA 48FA 2AD7F2          16      LD  HL,(_BUF_Y)
0008FD 48FD ED69            12      OUT (C),L       ;R#38 DY
0008FF 48FF ED61            12      OUT (C),H       ;R#39
000901 4901 2AD1F2          16      LD  HL,(_BUF_W)
000904 4904 ED69            12      OUT (C),L       ;R#40 NX
000906 4906 ED61            12      OUT (C),H       ;R#41
000908 4908 2AD3F2          16      LD  HL,(_BUF_H)
00090B 490B ED69            12      OUT (C),L       ;R#42 NY
00090D 490D ED61            12      OUT (C),H       ;R#43
                                
00090F 490F DD2AAFFC        20      LD  IX,(SCRMOD)
000913 4913 3ACCF2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000916 4916 B7               4      OR  A
000917 4917 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000919 4919 DD7D             9      LD  A,IXL
00091B 491B FE08             7      CP  8
00091D 491D 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
00091F 491F FE06             7      CP  6
000921 4921 2AD5F2          16      LD  HL,(_BUF_X)
000924 4924 3AD1F2          13      LD  A,(_BUF_W)
000927 4927 2005            12      JR  NZ,SCR57
000929 4929 B5               4      OR  L       ;スクリーン6
00092A 492A E603             7      AND 3
00092C 492C 200D            12      JR  NZ,USE_LMMC
       492E                     SCR57:              ;スクリーン5,7
00092E 492E B5               4      OR  L
00092F 492F E601             7      AND 1
000931 4931 2008            12      JR  NZ,USE_LMMC
       4933                     USE_HMMC:
000933 4933 DD2E08          10      LD  IXL,8
       4936                     USE_HMMC8:
000936 4936 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
000938 4938 32CCF2          13      LD  (_BUF_LO),A
       493B                     USE_LMMC:
00093B 493B 110000          10      LD  DE,0
00093E 493E 06FF             7      LD  B,-1
000940 4940 CDE149          17      CALL    GET_PIXEL
000943 4943 ED79            12      OUT (C),A       ;R#44 first DATA
000945 4945 3AD9F2          13      LD  A,(_BUF_O)
000948 4948 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
00094A 494A 3ACCF2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00094D 494D F6B0             7      OR  0B0H        ;R#46 LMMC command
00094F 494F ED79            12      OUT (C),A
                                
000951 4951 FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
000953 4953 0D               4      DEC C
000954 4954 0D               4      DEC C       ;C := PORT#1's address(WR)
000955 4955 3EAC             7      LD  A,080H+44
000957 4957 ED79            12      OUT (C),A
000959 4959 3E91             7      LD  A,080H+17
00095B 495B ED79            12      OUT (C),A       ;R#17 := 44
                                
00095D 495D 3A0600          13      LD  A,(RDVDP)
000960 4960 3C               4      INC A
000961 4961 FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
000963 4963 3E02             7      LD  A,2
000965 4965 ED79            12      OUT (C),A
000967 4967 3E8F             7      LD  A,08FH
000969 4969 ED79            12      OUT (C),A
00096B 496B 3ACCF2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00096E 496E E640             7      AND 040H
000970 4970 201C            12      JR  NZ,LOOP_HMMC
       4972                     LOOP_COPY:
000972 4972 CDE149          17      CALL    GET_PIXEL
000975 4975 08               4      EX  AF,AF'
000976 4976 FD4C             9      LD  C,IYH
       4978                     LOOP_COPY1:
000978 4978 ED78            12      IN  A,(C)
00097A 497A 0F               4      RRCA            ;RRCAではサインフラグは変化しない
00097B 497B 300A            12      JR  NC,EXIT_COPY    ;check CE bit
00097D 497D F27849          10      JP  P,LOOP_COPY1    ;check TR bit
000980 4980 08               4      EX  AF,AF'
000981 4981 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000983 4983 ED79            12      OUT (C),A
000985 4985 18EB            12      JR  LOOP_COPY
                                
       4987                     EXIT_COPY:
000987 4987 CDBE49          17      CALL    GET_STATUS_0
00098A 498A FB               4      EI
00098B 498B C31E47          10      JP  ROM_NEXT
                                
       498E                     LOOP_HMMC:
00098E 498E F3               4      DI          ;必要
00098F 498F FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000991 4991 43               4      LD  B,E
000992 4992 7B               4      LD  A,E
000993 4993 B7               4      OR  A
000994 4994 2802            12      JR  Z,LOOP_HMMC1
000996 4996 EDB3                    OTIR
       4998                     LOOP_HMMC1:
000998 4998 14               4      INC D
       4999                     LOOP_HMMC2:
000999 4999 15               4      DEC D
00099A 499A 2805            12      JR  Z,LOOP_HMMC3
00099C 499C EDB3                    OTIR
00099E 499E C39949          10      JP  LOOP_HMMC2
       49A1                     LOOP_HMMC3:
0009A1 49A1 ED78            12      IN  A,(C)
0009A3 49A3 0F               4      RRCA
0009A4 49A4 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
0009A6 49A6 2ACFF2          16      LD  HL,(_BUF_EN)
0009A9 49A9 CD284A          17      CALL    ROM_READ
0009AC 49AC EB               4      EX  DE,HL
0009AD 49AD 2AC7F2          16      LD  HL,(_DTA)
0009B0 49B0 7A               4      LD  A,D
0009B1 49B1 B3               4      OR  E
0009B2 49B2 20DA            12      JR  NZ,LOOP_HMMC
0009B4 49B4 18C2            12      JR  LOOP_COPY1
                                    
       49B6                     WAIT_VDP:
0009B6 49B6 3E02             7      LD  A,2
0009B8 49B8 CDBF49          17      CALL    GET_STATUS
0009BB 49BB 0F               4      RRCA
0009BC 49BC 38F8            12      JR  C,WAIT_VDP
       49BE                     GET_STATUS_0:
0009BE 49BE AF               4      XOR A
       49BF                     GET_STATUS:
0009BF 49BF C5              11      PUSH    BC
0009C0 49C0 ED4B0600        20      LD  BC,(RDVDP)
0009C4 49C4 0C               4      INC C
0009C5 49C5 ED79            12      OUT (C),A
0009C7 49C7 3E8F             7      LD  A,08FH
0009C9 49C9 ED79            12      OUT (C),A
0009CB 49CB ED78            12      IN  A,(C)
0009CD 49CD C1              10      POP BC
0009CE 49CE C9              10      RET
                                
       49CF                     GET_PIXEL256:
0009CF 49CF 7A               4      LD  A,D
0009D0 49D0 B3               4      OR  E
0009D1 49D1 200A            12      JR  NZ,GET_PIXEL1
0009D3 49D3 2ACFF2          16      LD  HL,(_BUF_EN)
0009D6 49D6 CD284A          17      CALL    ROM_READ
0009D9 49D9 EB               4      EX  DE,HL
0009DA 49DA 2AC7F2          16      LD  HL,(_DTA)
       49DD                     GET_PIXEL1:
0009DD 49DD 7E               7      LD  A,(HL)
0009DE 49DE 23               6      INC HL
0009DF 49DF 1B               6      DEC DE
0009E0 49E0 C9              10      RET
                                
       49E1                     GET_PIXEL:
0009E1 49E1 DD7D             9      LD  A,IXL
0009E3 49E3 FE08             7      CP  8
0009E5 49E5 28E8            12      JR  Z,GET_PIXEL256
0009E7 49E7 04               4      INC B
0009E8 49E8 FE06             7      CP  6
0009EA 49EA 282E            12      JR  Z,GET_PIXEL4
                                
0009EC 49EC CB40             8      BIT 0,B
0009EE 49EE 20ED            12      JR  NZ,GET_PIXEL1
                                
0009F0 49F0 7A               4      LD  A,D
0009F1 49F1 B3               4      OR  E
0009F2 49F2 200A            12      JR  NZ,GET_PIXEL2
                                
0009F4 49F4 2ACFF2          16      LD  HL,(_BUF_EN)
0009F7 49F7 CD284A          17      CALL    ROM_READ
0009FA 49FA EB               4      EX  DE,HL
0009FB 49FB 2AC7F2          16      LD  HL,(_DTA)
                                
       49FE                     GET_PIXEL2:
0009FE 49FE 7E               7      LD  A,(HL)
0009FF 49FF 0F               4      RRCA
000A00 4A00 0F               4      RRCA
000A01 4A01 0F               4      RRCA
000A02 4A02 0F               4      RRCA
000A03 4A03 C9              10      RET
                                
       4A04                     GET_PIXEL3:
000A04 4A04 7A               4      LD  A,D
000A05 4A05 B3               4      OR  E
000A06 4A06 200A            12      JR  NZ,GET_PIXEL5
                                
000A08 4A08 2ACFF2          16      LD  HL,(_BUF_EN)
000A0B 4A0B CD284A          17      CALL    ROM_READ
000A0E 4A0E EB               4      EX  DE,HL
000A0F 4A0F 2AC7F2          16      LD  HL,(_DTA)
       4A12                     GET_PIXEL5:
000A12 4A12 7E               7      LD  A,(HL)
000A13 4A13 0F               4      RRCA
000A14 4A14 0F               4      RRCA
000A15 4A15 0F               4      RRCA
000A16 4A16 0F               4      RRCA
000A17 4A17 0F               4      RRCA
000A18 4A18 0F               4      RRCA
000A19 4A19 C9              10      RET
                                
       4A1A                     GET_PIXEL4:
000A1A 4A1A 78               4      LD  A,B
000A1B 4A1B E603             7      AND 3   ;+0
000A1D 4A1D 28E5            12      JR  Z,GET_PIXEL3
000A1F 4A1F 3D               4      DEC A   ;+1
000A20 4A20 28DC            12      JR  Z,GET_PIXEL2
000A22 4A22 3D               4      DEC A   ;+2
000A23 4A23 7E               7      LD  A,(HL)
000A24 4A24 C0              11      RET NZ
000A25 4A25 0F               4      RRCA        ;+3
000A26 4A26 0F               4      RRCA
000A27 4A27 C9              10      RET
                                
       4A28                     ROM_READ:
000A28 4A28 E5              11      PUSH    HL
000A29 4A29 D5              11      PUSH    DE
000A2A 4A2A C5              11      PUSH    BC
000A2B 4A2B FDE5            15      PUSH    IY
000A2D 4A2D 22E3F2          16      LD  (LEFTX),HL
000A30 4A30 2AC7F2          16      LD  HL,(_DTA)
000A33 4A33 22DAF2          16      LD  (DTAX),HL
000A36 4A36 2AE3F2          16      LD  HL,(LEFTX)
                                
000A39 4A39 CDDC4C          17      CALL    RBX1
000A3C 4A3C 3870            12      JR  C,RBRERR1
000A3E 4A3E 79               4      LD  A,C
000A3F 4A3F EB               4      EX  DE,HL
000A40 4A40 ED52            15      SBC HL,DE       ;CP 0HL,CDE
000A42 4A42 19              11      ADD HL,DE
000A43 4A43 DE00             7      SBC A,000H
000A45 4A45 3801            12      JR  C,RBR1
000A47 4A47 EB               4      EX  DE,HL
       4A48                     RBR1:
000A48 4A48 9F               4      SBC A,A
000A49 4A49 E601             7      AND 1
000A4B 4A4B 32B6F2          13      LD  (_RESULT),A
000A4E 4A4E 7C               4      LD  A,H
000A4F 4A4F B5               4      OR  L
000A50 4A50 CAA44A          10      JP  Z,RBREND0
                                
000A53 4A53 22C3F2          16      LD  (_LEFT),HL  ;Read record byte
000A56 4A56 22E3F2          16      LD  (LEFTX),HL
                                
000A59 4A59 CD0F4D          17      CALL    RBX2
000A5C 4A5C 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000A5E 4A5E CD224D          17      CALL    RBXA
000A61 4A61 DABA4A          10      JP  C,RBRERR
000A64 4A64 C5              11      PUSH    BC
000A65 4A65 CDFE43          17      CALL    ROM_LDIR
000A68 4A68 ED53DAF2        20      LD  (DTAX),DE
000A6C 4A6C 2AE3F2          16      LD  HL,(LEFTX)
000A6F 4A6F D1              10      POP DE
000A70 4A70 A7               4      AND A
000A71 4A71 ED52            15      SBC HL,DE
000A73 4A73 22E3F2          16      LD  (LEFTX),HL
000A76 4A76 2829            12      JR  Z,RBREND
                                
       4A78                     RBRB:
000A78 4A78 CD5B4D          17      CALL    RBXB
000A7B 4A7B 2818            12      JR  Z,RBRC
       4A7D                     RBRB1:
000A7D 4A7D C5              11      PUSH    BC
000A7E 4A7E D5              11      PUSH    DE
000A7F 4A7F CD0C4E          17      CALL    CLUST
000A82 4A82 EB               4      EX  DE,HL
000A83 4A83 ED4BB9F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000A87 4A87 CDFE43          17      CALL    ROM_LDIR
000A8A 4A8A EB               4      EX  DE,HL
000A8B 4A8B D1              10      POP DE
000A8C 4A8C C1              10      POP BC
000A8D 4A8D CDE94D          17      CALL    GNCL
000A90 4A90 DABA4A          10      JP  C,RBRERR
000A93 4A93 10E8            13      DJNZ    RBRB1
       4A95                     RBRC:
000A95 4A95 CD734D          17      CALL    RBXC
000A98 4A98 2807            12      JR  Z,RBREND
                                
000A9A 4A9A CD0C4E          17      CALL    CLUST
000A9D 4A9D EB               4      EX  DE,HL
000A9E 4A9E CDFE43          17      CALL    ROM_LDIR
       4AA1                     RBREND:
000AA1 4AA1 CD7F4D          17      CALL    RBXEND
       4AA4                     RBREND0:
000AA4 4AA4 FDE1            14      POP IY
000AA6 4AA6 C1              10      POP BC
000AA7 4AA7 D1              10      POP DE
000AA8 4AA8 F1              10      POP AF  ;(HL)
000AA9 4AA9 AF               4      XOR A
000AAA 4AAA 3AB6F2          13      LD  A,(_RESULT)
000AAD 4AAD C9              10      RET
                                
       4AAE                     RBRERR1:
000AAE 4AAE 3E01             7      LD  A,001H
       4AB0                     RBRERR2:
000AB0 4AB0 FDE1            14      POP IY
000AB2 4AB2 C1              10      POP BC
000AB3 4AB3 D1              10      POP DE
000AB4 4AB4 E1              10      POP HL
000AB5 4AB5 37               4      SCF
000AB6 4AB6 210000          10      LD  HL,0
000AB9 4AB9 C9              10      RET
       4ABA                     RBRERR:
000ABA 4ABA 3EFF             7      LD  A,0FFH
000ABC 4ABC 18F2            12      JR  RBRERR2
                                
       4ABE                     FILE_DD:
000ABE 4ABE E1              10      POP HL
000ABF 4ABF 3E                      DB  03EH
000AC0 4AC0 C9              10      RET
000AC1 4AC1 32A3F2          13      LD  (SWC_BLOAD_M),A
       4AC4                     ROM_ORG:
000AC4 4AC4 2AE5F2          16      LD  HL,(PARAM0)
000AC7 4AC7 7E               7      LD  A,(HL)
000AC8 4AC8 C9              10      RET
       4AC9                     FILE_B:
000AC9 4AC9 AF               4      XOR A
000ACA 4ACA 32EBF2          13      LD  (FDRV),A
000ACD 4ACD 1E00             7      LD  E,0
000ACF 4ACF 3A63F6          13      LD  A,(VALTYP)
000AD2 4AD2 FE03             7      CP  3       ;string
000AD4 4AD4 C26C4B          10      JP  NZ,FILED
                                
000AD7 4AD7 DD21D067        14      LD  IX,FRESTR
000ADB 4ADB FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000ADF 4ADF CD1C00          17      CALL    _CALSLT
000AE2 4AE2 E5              11      PUSH    HL
000AE3 4AE3 DDE1            14      POP IX
                                
000AE5 4AE5 DD5E00          19      LD  E,(IX+0)
000AE8 4AE8 DD7E01          19      LD  A,(IX+1)
000AEB 4AEB DD5602          19      LD  D,(IX+2)
000AEE 4AEE DD62             9      LD  IXH,D
000AF0 4AF0 DD6F             9      LD  IXL,A
000AF2 4AF2 7B               4      LD  A,E
       4AF3                     FILE_BDOS:
000AF3 4AF3 FE04             7      CP  4
000AF5 4AF5 3808            12      JR  C,FILEB1
000AF7 4AF7 DD7E03          19      LD  A,(IX+3)
000AFA 4AFA FE3A             7      CP  ':'
000AFC 4AFC 28C0            12      JR  Z,FILE_DD
000AFE 4AFE 7B               4      LD  A,E
       4AFF                     FILEB1:
000AFF 4AFF FE02             7      CP  2
000B01 4B01 3818            12      JR  C,DEVI1
000B03 4B03 DD7E01          19      LD  A,(IX+1)
000B06 4B06 FE3A             7      CP  ':'
000B08 4B08 2011            12      JR  NZ,DEVI1
000B0A 4B0A DD7E00          19      LD  A,(IX+0)        ;DRIVE
000B0D 4B0D CD454C          17      CALL    CAP
000B10 4B10 D640             7      SUB '@'
000B12 4B12 DD23            10      INC IX
000B14 4B14 DD23            10      INC IX
000B16 4B16 1D               4      DEC E
000B17 4B17 1D               4      DEC E
000B18 4B18 32EBF2          13      LD  (FDRV),A
       4B1B                     DEVI1:
000B1B 4B1B DD7E00          19      LD  A,(IX+0)
000B1E 4B1E D65C             7      SUB 05CH        ;\
000B20 4B20 2008            12      JR  NZ,NOROOT
000B22 4B22 6F               4      LD  L,A
000B23 4B23 67               4      LD  H,A
000B24 4B24 22E9F2          16      LD  (_CDX),HL
000B27 4B27 DD23            10      INC IX
000B29 4B29 1D               4      DEC E
       4B2A                     NOROOT:
                                
       4B2A                     SETDIR:
000B2A 4B2A CD6C4B          17      CALL    FILED
000B2D 4B2D DD7E00          19      LD  A,(IX+0)
000B30 4B30 FE5C             7      CP  05CH        ;\
000B32 4B32 C0              11      RET NZ
000B33 4B33 DD23            10      INC IX
000B35 4B35 1D               4      DEC E
000B36 4B36 3AECF2          13      LD  A,(FNAME)
000B39 4B39 FE20             7      CP  020H        ;. の処理
000B3B 4B3B 28ED            12      JR  Z,SETDIR
                                
000B3D 4B3D CD5B4C          17      CALL    ROM_OPEN
000B40 4B40 B7               4      OR  A
000B41 4B41 C0              11      RET NZ
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
000B42 4B42 D5              11      PUSH    DE
000B43 4B43 2AE0F2          16      LD  HL,(DIRENT1)
000B46 4B46 110B00          10      LD  DE,0000BH   ;属性(アトリビュート)
000B49 4B49 19              11      ADD HL,DE
000B4A 4B4A CD8B43          17      CALL    RDSLT_ROM
000B4D 4B4D D1              10      POP DE
000B4E 4B4E CB67             8      BIT 4,A     ;ディレクトリ
                                #else
                                    LD  IY,(DIRENT1)
                                    BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000B50 4B50 C8              11      RET Z
000B51 4B51 CDB34B          17      CALL    FILEI
                                #if exists USE_MORMAL32K_OR_ASCII16
000B54 4B54 D5              11      PUSH    DE
000B55 4B55 2AE0F2          16      LD  HL,(DIRENT1)
000B58 4B58 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000B5B 4B5B 19              11      ADD HL,DE
000B5C 4B5C CD8B43          17      CALL    RDSLT_ROM
000B5F 4B5F 23               6      INC HL
000B60 4B60 5F               4      LD  E,A
000B61 4B61 CD8B43          17      CALL    RDSLT_ROM
000B64 4B64 57               4      LD  D,A
000B65 4B65 EB               4      EX  DE,HL
000B66 4B66 D1              10      POP DE
                                #else
                                    LD  L,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  H,(IY+01BH)
                                #endif
000B67 4B67 22E9F2          16      LD  (_CDX),HL
000B6A 4B6A 18BE            12      JR  SETDIR
                                
       4B6C                     FILED:
000B6C 4B6C CDB34B          17      CALL    FILEI
000B6F 4B6F 21ECF2          10      LD  HL,FNAME
                                
000B72 4B72 0608             7      LD  B,8
       4B74                     FILE2:
000B74 4B74 CDC04B          17      CALL    CCHKF
000B77 4B77 C8              11      RET Z
000B78 4B78 FE2A             7      CP  '*'
000B7A 4B7A 282E            12      JR  Z,FILE9
000B7C 4B7C FE2E             7      CP  '.'
000B7E 4B7E 280C            12      JR  Z,FILE4
000B80 4B80 77               7      LD  (HL),A
000B81 4B81 23               6      INC HL
000B82 4B82 10F0            13      DJNZ    FILE2
                                
       4B84                     FILE3:
000B84 4B84 CDC04B          17      CALL    CCHKF
000B87 4B87 C8              11      RET Z
000B88 4B88 FE2E             7      CP  '.'
000B8A 4B8A 20F8            12      JR  NZ,FILE3
                                
       4B8C                     FILE4:
000B8C 4B8C 21F4F2          10      LD  HL,FNAME+8
000B8F 4B8F 0603             7      LD  B,3
                                
       4B91                     FILE4L:
000B91 4B91 CDC04B          17      CALL    CCHKF
000B94 4B94 C8              11      RET Z
000B95 4B95 FE2E             7      CP  '.'
000B97 4B97 2008            12      JR  NZ,FILE12
000B99 4B99 32ECF2          13      LD  (FNAME),A   ;Parent directory(..)
000B9C 4B9C 32EDF2          13      LD  (FNAME+1),A
000B9F 4B9F 3E20             7      LD  A,020H
       4BA1                     FILE12:
000BA1 4BA1 FE2A             7      CP  '*'
000BA3 4BA3 280A            12      JR  Z,FILE10
000BA5 4BA5 77               7      LD  (HL),A
000BA6 4BA6 23               6      INC HL
000BA7 4BA7 10E8            13      DJNZ    FILE4L
000BA9 4BA9 C9              10      RET
                                
       4BAA                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000BAA 4BAA CDAF4B          17      CALL    FILE10
000BAD 4BAD 18D5            12      JR  FILE3
                                
       4BAF                     FILE10:
000BAF 4BAF 3E3F             7      LD  A,'?'
000BB1 4BB1 1808            12      JR  FILL_MEMORY
       4BB3                     FILEI:              ;名前＋拡張子をスペースで初期化
000BB3 4BB3 3E20             7      LD  A,020H
000BB5 4BB5 01000B          10      LD  BC,11*256   ;C=0にしておく
000BB8 4BB8 21ECF2          10      LD  HL,FNAME
       4BBB                     FILL_MEMORY:            ;HLからBバイトAで埋める
000BBB 4BBB 77               7      LD  (HL),A
000BBC 4BBC 23               6      INC HL
000BBD 4BBD 10FC            13      DJNZ    FILL_MEMORY
000BBF 4BBF C9              10      RET
                                
       4BC0                     CCHKF:
000BC0 4BC0 7B               4      LD  A,E
000BC1 4BC1 B7               4      OR  A
000BC2 4BC2 C8              11      RET Z
000BC3 4BC3 DD7E00          19      LD  A,(IX+0)
000BC6 4BC6 CDCD4B          17      CALL    CCHK2
000BC9 4BC9 C8              11      RET Z
000BCA 4BCA C3304C          10      JP  FKAN
                                
       4BCD                     CCHK2:
000BCD 4BCD 0C               4      INC C
000BCE 4BCE 0D               4      DEC C
000BCF 4BCF C0              11      RET NZ
       4BD0                     CCHK3:              ;ZF=1 で使えない文字
000BD0 4BD0 FE2B             7      CP  '+'
000BD2 4BD2 C8              11      RET Z
000BD3 4BD3 FE2C             7      CP  ','
000BD5 4BD5 C8              11      RET Z
000BD6 4BD6 FE2F             7      CP  '/'
000BD8 4BD8 C8              11      RET Z
000BD9 4BD9 FE3A             7      CP  ':'
000BDB 4BDB C8              11      RET Z
000BDC 4BDC FE3B             7      CP  ';'
000BDE 4BDE C8              11      RET Z
000BDF 4BDF FE3D             7      CP  '='
000BE1 4BE1 C8              11      RET Z
000BE2 4BE2 FE5C             7      CP  05CH    ;\
000BE4 4BE4 C8              11      RET Z
000BE5 4BE5 FE1F             7      CP  01FH
000BE7 4BE7 D0              11      RET NC
000BE8 4BE8 BF               4      CP  A       ;Z=1
000BE9 4BE9 C9              10      RET
                                
       4BEA                     SS1:
000BEA 4BEA 13               6      INC DE
       4BEB                     SPCUT:              ;スペースをカット
000BEB 4BEB 1A               7      LD  A,(DE)
000BEC 4BEC FE20             7      CP  020H
000BEE 4BEE 28FA            12      JR  Z,SS1
000BF0 4BF0 C9              10      RET
                                
       4BF1                     SCREOF1:
000BF1 4BF1 13               6      INC DE
       4BF2                     SPCUTEX:            ;スペース改行などをカット
000BF2 4BF2 1A               7      LD  A,(DE)
000BF3 4BF3 FE20             7      CP  020H
000BF5 4BF5 28FA            12      JR  Z,SCREOF1
000BF7 4BF7 FE0D             7      CP  00DH
000BF9 4BF9 28F6            12      JR  Z,SCREOF1
000BFB 4BFB FE0A             7      CP  00AH
000BFD 4BFD 28F2            12      JR  Z,SCREOF1
000BFF 4BFF FE1A             7      CP  01AH
000C01 4C01 28EE            12      JR  Z,SCREOF1
000C03 4C03 C9              10      RET
                                
       4C04                     GETNUM:
000C04 4C04 210000          10      LD  HL,0
       4C07                     GETNUM1:
000C07 4C07 1A               7      LD  A,(DE)
000C08 4C08 13               6      INC DE
000C09 4C09 D630             7      SUB '0'
000C0B 4C0B D8              11      RET C
000C0C 4C0C FE0A             7      CP  10
000C0E 4C0E D0              11      RET NC
000C0F 4C0F 4D               4      LD  C,L
000C10 4C10 44               4      LD  B,H
000C11 4C11 29              11      ADD HL,HL   ;*2
000C12 4C12 29              11      ADD HL,HL   ;*4
000C13 4C13 09              11      ADD HL,BC   ;*5
000C14 4C14 29              11      ADD HL,HL   ;*10
000C15 4C15 4F               4      LD  C,A
000C16 4C16 0600             7      LD  B,0
000C18 4C18 09              11      ADD HL,BC
000C19 4C19 18EC            12      JR  GETNUM1
                                
       4C1B                     SEARCH_END:
000C1B 4C1B 7E               7      LD  A,(HL)
       4C1C                     SEARCH_END1:
000C1C 4C1C 23               6      INC HL
000C1D 4C1D B7               4      OR  A
000C1E 4C1E C8              11      RET Z
000C1F 4C1F FE3A             7      CP  ':'
000C21 4C21 20F8            12      JR  NZ,SEARCH_END
000C23 4C23 7E               7      LD  A,(HL)
000C24 4C24 FE3A             7      CP  ':'
000C26 4C26 28F4            12      JR  Z,SEARCH_END1
000C28 4C28 C9              10      RET
                                
       4C29                     FKANC:
000C29 4C29 CB41             8      BIT 0,C
000C2B 4C2B CC4E4C          17      CALL    Z,CAP2
000C2E 4C2E 1803            12      JR  FKANX
       4C30                     FKAN:           ;漢字チェック
000C30 4C30 DD23            10      INC IX
000C32 4C32 1D               4      DEC E
       4C33                     FKANX:
000C33 4C33 CB41             8      BIT 0,C
000C35 4C35 CB81             8      RES 0,C
000C37 4C37 C0              11      RET NZ
000C38 4C38 FE80             7      CP  080H
000C3A 4C3A D8              11      RET C
000C3B 4C3B FEA0             7      CP  0A0H
000C3D 4C3D 3803            12      JR  C,FKAN1
000C3F 4C3F FEE0             7      CP  0E0H
000C41 4C41 D8              11      RET C
       4C42                     FKAN1:
000C42 4C42 0C               4      INC C
000C43 4C43 A7               4      AND A
000C44 4C44 C9              10      RET
                                
       4C45                     CAP:
000C45 4C45 FE61             7      CP  'a'
000C47 4C47 D8              11      RET C
000C48 4C48 FE7B             7      CP  'z'+1
000C4A 4C4A D0              11      RET NC
000C4B 4C4B D620             7      SUB 020H
000C4D 4C4D C9              10      RET
       4C4E                     CAP2:
000C4E 4C4E CD454C          17      CALL    CAP
       4C51                     CAP3:               ;
000C51 4C51 FE05             7      CP  5
000C53 4C53 2803            12      JR  Z,CAP4
000C55 4C55 FE21             7      CP  021H
000C57 4C57 C9              10      RET
       4C58                     CAP4:
000C58 4C58 3EE5             7      LD  A,0E5H
000C5A 4C5A C9              10      RET
                                
       4C5B                     ROM_OPEN:
000C5B 4C5B CD8C52          17      CALL    GET_DISK_BANK_FDRV
                                
000C5E 4C5E CDB74E          17      CALL    GET_DIR_DAT
000C61 4C61 D5              11      PUSH    DE
000C62 4C62 CD774C          17      CALL    FILESE
000C65 4C65 D1              10      POP DE
000C66 4C66 3F               4      CCF
000C67 4C67 D8              11      RET C
000C68 4C68 22E0F2          16      LD  (DIRENT1),HL
000C6B 4C6B E5              11      PUSH    HL
000C6C 4C6C 210000          10      LD  HL,0
000C6F 4C6F 22BDF2          16      LD  (RR_LOW),HL
000C72 4C72 22BFF2          16      LD  (RR_HIGH),HL
000C75 4C75 E1              10      POP HL
000C76 4C76 C9              10      RET
                                
       4C77                     FILESE:
       4C77                     FILESE0:
                                #if exists USE_MORMAL32K_OR_ASCII16
000C77 4C77 CD8B43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000C7A 4C7A B7               4      OR  A
000C7B 4C7B C8              11      RET Z       ;END:ZF=1 CF=0
000C7C 4C7C FEE5             7      CP  0E5H
000C7E 4C7E 280D            12      JR  Z,FILESE1
000C80 4C80 11ECF2          10      LD  DE,FNAME
000C83 4C83 E5              11      PUSH    HL
000C84 4C84 CDB34C          17      CALL    CPFILE
000C87 4C87 CCD64C          17      CALL    Z,CPFILE2
000C8A 4C8A E1              10      POP HL
000C8B 4C8B 37               4      SCF
000C8C 4C8C C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4C8D                     FILESE1:
000C8D 4C8D CD954C          17      CALL    FNEXT
000C90 4C90 20E5            12      JR  NZ,FILESE0
000C92 4C92 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000C94 4C94 C9              10      RET
                                
       4C95                     FNEXT:
000C95 4C95 112000          10      LD  DE,020H
000C98 4C98 19              11      ADD HL,DE
000C99 4C99 ED5BE9F2        20      LD  DE,(_CDX)
000C9D 4C9D 7A               4      LD  A,D
000C9E 4C9E B3               4      OR  E
000C9F 4C9F 2002            12      JR  NZ,FNEXT_SUBDIR
000CA1 4CA1 0D               4      DEC C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
                                    PUSH    AF      ;※フラグを保存する必要あり
                                    BIT 7,H
                                    JR  Z,CHECK_DIR_PAGE1
                                    LD  A,H
                                    SUB 020H
                                    LD  H,A
                                    LD  A,(_DIR_BANK)
                                    INC A
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_DIR_BANK),A
                                CHECK_DIR_PAGE1:
                                    POP AF
                                #endif
000CA2 4CA2 C9              10      RET
                                
       4CA3                     FNEXT_SUBDIR:           ;サブディレクトリ
000CA3 4CA3 0D               4      DEC C
000CA4 4CA4 C0              11      RET NZ
                                
000CA5 4CA5 ED5BE9F2        20      LD  DE,(_CDX)
000CA9 4CA9 CDE94D          17      CALL    GNCL
000CAC 4CAC EB               4      EX  DE,HL
000CAD 4CAD 22E9F2          16      LD  (_CDX),HL
000CB0 4CB0 C3F04E          10      JP  GET_SUBDIR
                                
       4CB3                     CPFILE:
000CB3 4CB3 C5              11      PUSH    BC
000CB4 4CB4 01000B          10      LD  BC,00B00H
       4CB7                     CPSTR1:
000CB7 4CB7 1A               7      LD  A,(DE)
000CB8 4CB8 FE3F             7      CP  '?'     ;Wild card
000CBA 4CBA 2814            12      JR  Z,CPSTR2
                                #if exists USE_MORMAL32K_OR_ASCII16
000CBC 4CBC CD8B43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000CBF 4CBF CD294C          17      CALL    FKANC
000CC2 4CC2 E5              11      PUSH    HL
000CC3 4CC3 67               4      LD  H,A
000CC4 4CC4 1A               7      LD  A,(DE)
000CC5 4CC5 CB01             4      RLC C
000CC7 4CC7 CD294C          17      CALL    FKANC
000CCA 4CCA CB09             4      RRC C
000CCC 4CCC BC               4      CP  H       ;CP (HL),(DE)
000CCD 4CCD E1              10      POP HL
000CCE 4CCE 2004            12      JR  NZ,CPSTR3
       4CD0                     CPSTR2:
000CD0 4CD0 13               6      INC DE
000CD1 4CD1 23               6      INC HL
000CD2 4CD2 10E3            13      DJNZ    CPSTR1
       4CD4                     CPSTR3:
000CD4 4CD4 C1              10      POP BC
000CD5 4CD5 C9              10      RET
                                
       4CD6                     CPFILE2:
                                #if exists USE_MORMAL32K_OR_ASCII16
000CD6 4CD6 CD8B43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000CD9 4CD9 E608             7      AND 008H    ;~0F7H
000CDB 4CDB C9              10      RET
                                
       4CDC                     RBX1:
000CDC 4CDC E5              11      PUSH    HL      ;Record byte
                                
000CDD 4CDD ED5BBDF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000CE1 4CE1 3AC0F2          13      LD  A,(RR_HIGH+1)
000CE4 4CE4 4F               4      LD  C,A
                                
000CE5 4CE5 3AE2F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
000CE8 4CE8 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
000CEB 4CEB D5              11      PUSH    DE
000CEC 4CEC 2AE0F2          16      LD  HL,(DIRENT1)
000CEF 4CEF 111C00          10      LD  DE,0001CH
000CF2 4CF2 19              11      ADD HL,DE
000CF3 4CF3 CD8B43          17      CALL    RDSLT_ROM
000CF6 4CF6 23               6      INC HL
000CF7 4CF7 5F               4      LD  E,A
000CF8 4CF8 CD8B43          17      CALL    RDSLT_ROM
000CFB 4CFB 23               6      INC HL
000CFC 4CFC 57               4      LD  D,A
000CFD 4CFD CD8B43          17      CALL    RDSLT_ROM
000D00 4D00 EB               4      EX  DE,HL       ;AHL=File size
000D01 4D01 D1              10      POP DE
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  L,(IY+01CH) ;AHL=File size
                                    LD  H,(IY+01DH)
                                    LD  A,(IY+01EH)
                                #endif
                                
000D02 4D02 A7               4      AND A
000D03 4D03 ED52            15      SBC HL,DE
000D05 4D05 99               4      SBC A,C
000D06 4D06 D1              10      POP DE
                                
000D07 4D07 D8              11      RET C
000D08 4D08 4F               4      LD  C,A
000D09 4D09 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000D0A 4D0A B2               4      OR  D
000D0B 4D0B B3               4      OR  E
000D0C 4D0C C0              11      RET NZ
000D0D 4D0D 37               4      SCF
000D0E 4D0E C9              10      RET
                                
       4D0F                     RBX2:
000D0F 4D0F ED4BBEF2        20      LD  BC,(RR_LOW+1)
000D13 4D13 CD944D          17      CALL    RWXR
000D16 4D16 3ABAF2          13      LD  A,(CLSZ_H)
000D19 4D19 3D               4      DEC A
000D1A 4D1A E5              11      PUSH    HL
000D1B 4D1B 2ABDF2          16      LD  HL,(RR_LOW)
000D1E 4D1E A4               4      AND H
000D1F 4D1F B5               4      OR  L
000D20 4D20 E1              10      POP HL
000D21 4D21 C9              10      RET
                                
       4D22                     RBXA:
000D22 4D22 D5              11      PUSH    DE
000D23 4D23 CD0C4E          17      CALL    CLUST
000D26 4D26 ED53C5F2        20      LD  (_DTPS),DE
000D2A 4D2A D1              10      POP DE
000D2B 4D2B CDE94D          17      CALL    GNCL
000D2E 4D2E D8              11      RET C
000D2F 4D2F ED53C1F2        20      LD  (_CLPS),DE
                                
000D33 4D33 ED4BBDF2        20      LD  BC,(RR_LOW)
000D37 4D37 2AB9F2          16      LD  HL,(CLSZ)
000D3A 4D3A 7C               4      LD  A,H
000D3B 4D3B 3D               4      DEC A
000D3C 4D3C A0               4      AND B
000D3D 4D3D 47               4      LD  B,A
000D3E 4D3E ED42            15      SBC HL,BC       ;remaining cluster
                                
000D40 4D40 ED5BE3F2        20      LD  DE,(LEFTX)
000D44 4D44 ED52            15      SBC HL,DE       ;CP HL,DE
000D46 4D46 19              11      ADD HL,DE
000D47 4D47 3801            12      JR  C,RBXA1
000D49 4D49 EB               4      EX  DE,HL
       4D4A                     RBXA1:
000D4A 4D4A 3AB7F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_MORMAL32K_OR_ASCII16
000D4D 4D4D 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000D50 4D50 E5              11      PUSH    HL
000D51 4D51 2AC5F2          16      LD  HL,(_DTPS)
000D54 4D54 09              11      ADD HL,BC
000D55 4D55 ED5BDAF2        20      LD  DE,(DTAX)
000D59 4D59 C1              10      POP BC
000D5A 4D5A C9              10      RET
                                
       4D5B                     RBXB:
000D5B 4D5B 2ADAF2          16      LD  HL,(DTAX)
000D5E 4D5E ED5BC1F2        20      LD  DE,(_CLPS)
000D62 4D62 3AE4F2          13      LD  A,(LEFTX+1)
000D65 4D65 47               4      LD  B,A
000D66 4D66 3ABAF2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4D69                     RBXB1:
000D69 4D69 1F               4      RRA     ;->CF
000D6A 4D6A 3804            12      JR  C,RBXB2
000D6C 4D6C CB38             8      SRL B   ;B=B/2
000D6E 4D6E 18F9            12      JR  RBXB1
       4D70                     RBXB2:
000D70 4D70 78               4      LD  A,B
000D71 4D71 B7               4      OR  A
000D72 4D72 C9              10      RET
                                
       4D73                     RBXC:
000D73 4D73 ED4BE3F2        20      LD  BC,(LEFTX)
000D77 4D77 3ABAF2          13      LD  A,(CLSZ_H)
000D7A 4D7A 3D               4      DEC A
000D7B 4D7B A0               4      AND B
000D7C 4D7C 47               4      LD  B,A
000D7D 4D7D B1               4      OR  C
000D7E 4D7E C9              10      RET
                                
       4D7F                     RBXEND:
000D7F 4D7F ED5BC3F2        20      LD  DE,(_LEFT)
000D83 4D83 2ABDF2          16      LD  HL,(RR_LOW)
000D86 4D86 3AC0F2          13      LD  A,(RR_HIGH+1)
000D89 4D89 19              11      ADD HL,DE
000D8A 4D8A CE00             7      ADC A,0
000D8C 4D8C 22BDF2          16      LD  (RR_LOW),HL
000D8F 4D8F 32C0F2          13      LD  (RR_HIGH+1),A
000D92 4D92 EB               4      EX  DE,HL       ;HL=Read byte
000D93 4D93 C9              10      RET 
                                
       4D94                     RWXR:
000D94 4D94 3ABAF2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4D97                     L_RWX:
000D97 4D97 1F               4      RRA     ;->CF
000D98 4D98 3806            12      JR  C,E_RWX
000D9A 4D9A CB38             8      SRL B   ;BC=BC/2
000D9C 4D9C CB19             8      RR  C   ;
000D9E 4D9E 18F7            12      JR  L_RWX
       4DA0                     E_RWX:
000DA0 4DA0 3AE2F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
000DA3 4DA3 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
000DA6 4DA6 E5              11      PUSH    HL
000DA7 4DA7 2AE0F2          16      LD  HL,(DIRENT1)
000DAA 4DAA 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000DAD 4DAD 19              11      ADD HL,DE
000DAE 4DAE CD8B43          17      CALL    RDSLT_ROM
000DB1 4DB1 23               6      INC HL
000DB2 4DB2 5F               4      LD  E,A
000DB3 4DB3 CD8B43          17      CALL    RDSLT_ROM
000DB6 4DB6 23               6      INC HL
000DB7 4DB7 57               4      LD  D,A
000DB8 4DB8 E1              10      POP HL
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  E,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  D,(IY+01BH)
                                #endif
000DB9 4DB9 CD8C52          17      CALL    GET_DISK_BANK_FDRV
       4DBC                     RWX1:
000DBC 4DBC ED53C1F2        20      LD  (_CLPS),DE
000DC0 4DC0 7A               4      LD  A,D
000DC1 4DC1 B3               4      OR  E
000DC2 4DC2 37               4      SCF
000DC3 4DC3 C8              11      RET Z
                                
000DC4 4DC4 78               4      LD  A,B
000DC5 4DC5 B1               4      OR  C
000DC6 4DC6 C8              11      RET Z
                                
000DC7 4DC7 CDE94D          17      CALL    GNCL
000DCA 4DCA D8              11      RET C
000DCB 4DCB 0B               6      DEC BC
000DCC 4DCC CD504E          17      CALL    ENDCL
000DCF 4DCF 38EB            12      JR  C,RWX1
000DD1 4DD1 37               4      SCF
000DD2 4DD2 C9              10      RET
                                
       4DD3                     NCL3:
000DD3 4DD3 CD8C52          17      CALL    GET_DISK_BANK_FDRV
000DD6 4DD6 6B               4      LD  L,E
000DD7 4DD7 62               4      LD  H,D
000DD8 4DD8 CB3C             8      SRL H
000DDA 4DDA CB1D             8      RR  L
000DDC 4DDC 1F               4      RRA
000DDD 4DDD 19              11      ADD HL,DE
000DDE 4DDE 010060          10      LD  BC,BANK1_ADR
000DE1 4DE1 09              11      ADD HL,BC
000DE2 4DE2 ED4BBBF2        20      LD  BC,(SECSZ)
000DE6 4DE6 09              11      ADD HL,BC
000DE7 4DE7 17               4      RLA
000DE8 4DE8 C9              10      RET
                                
       4DE9                     GNCL:
000DE9 4DE9 7A               4      LD  A,D
000DEA 4DEA B3               4      OR  E
000DEB 4DEB 37               4      SCF
000DEC 4DEC C8              11      RET Z
000DED 4DED C5              11      PUSH    BC
000DEE 4DEE E5              11      PUSH    HL
000DEF 4DEF CDD34D          17      CALL    NCL3
000DF2 4DF2 3809            12      JR  C,GNC1
000DF4 4DF4 5E               7      LD  E,(HL)
000DF5 4DF5 23               6      INC HL
000DF6 4DF6 7E               7      LD  A,(HL)
000DF7 4DF7 E60F             7      AND 00FH
000DF9 4DF9 57               4      LD  D,A
000DFA 4DFA E1              10      POP HL
000DFB 4DFB C1              10      POP BC
000DFC 4DFC C9              10      RET
       4DFD                     GNC1:
000DFD 4DFD 7E               7      LD  A,(HL)
000DFE 4DFE 23               6      INC HL
000DFF 4DFF 56               7      LD  D,(HL)
000E00 4E00 0604             7      LD  B,4
       4E02                     GNC1L:
000E02 4E02 CB3A             8      SRL D
000E04 4E04 1F               4      RRA
000E05 4E05 10FB            13      DJNZ    GNC1L
                                
000E07 4E07 5F               4      LD  E,A
000E08 4E08 E1              10      POP HL
000E09 4E09 C1              10      POP BC
000E0A 4E0A A7               4      AND A
000E0B 4E0B C9              10      RET
                                
       4E0C                     CLUST:
000E0C 4E0C EB               4      EX  DE,HL
       4E0D                     CLUST_HL:
000E0D 4E0D 2B               6      DEC HL
000E0E 4E0E 2B               6      DEC HL
000E0F 4E0F C5              11      PUSH    BC
000E10 4E10 3ABAF2          13      LD  A,(CLSZ_H)
000E13 4E13 CDB952          17      CALL    MUL_AHL
                                
000E16 4E16 CDD14E          17      CALL    GET_DIR_POS
000E19 4E19 4F               4      LD  C,A
000E1A 4E1A 0600             7      LD  B,0
000E1C 4E1C 09              11      ADD HL,BC
                                
000E1D 4E1D ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
000E21 4E21 CB38             8      SRL B
000E23 4E23 CB19             8      RR  C           ;/2
000E25 4E25 CB38             8      SRL B
000E27 4E27 CB19             8      RR  C           ;/4
000E29 4E29 CB38             8      SRL B
000E2B 4E2B CB19             8      RR  C           ;/8
000E2D 4E2D 09              11      ADD HL,BC
                                #if exists USE_MORMAL32K_OR_ASCII16
000E2E 4E2E 7D               4      LD  A,L
000E2F 4E2F 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
000E32 4E32 09              11      ADD HL,BC
000E33 4E33 3013            12      JR  NC,CLUST2
000E35 4E35 4D               4      LD  C,L     ;C=読み出し元
000E36 4E36 29              11      ADD HL,HL   ;64KB→32KB
000E37 4E37 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
000E38 4E38 CD8C52          17      CALL    GET_DISK_BANK_FDRV
000E3B 4E3B 84               4      ADD A,H
000E3C 4E3C 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
000E3F 4E3F 32B7F2          13      LD  (_BANK),A
000E42 4E42 69               4      LD  L,C     ;C=読み出し元
000E43 4E43 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
000E45 4E45 A5               4      AND L
000E46 4E46 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB
                                    ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
                                    AND L
                                #endif
       4E48                     CLUST2:
000E48 4E48 C660             7      ADD A,high BANK1_ADR
000E4A 4E4A 67               4      LD  H,A
000E4B 4E4B 2E00             7      LD  L,0
000E4D 4E4D EB               4      EX  DE,HL
000E4E 4E4E C1              10      POP BC
000E4F 4E4F C9              10      RET
                                
       4E50                     ENDCL:
000E50 4E50 7A               4      LD  A,D ;END CLUSTER
000E51 4E51 FE0F             7      CP  00FH    ;FAT12の最大値
000E53 4E53 C0              11      RET NZ
000E54 4E54 7B               4      LD  A,E
000E55 4E55 FEF7             7      CP  0F7H
000E57 4E57 C9              10      RET
                                
       4E58                     RB_READ:
000E58 4E58 AF               4      XOR A   ;HLA = HL*128
000E59 4E59 CB3C             8      SRL H
000E5B 4E5B CB1D             8      RR  L
000E5D 4E5D 1F               4      RRA
000E5E 4E5E 32BDF2          13      LD  (RR_LOW),A
000E61 4E61 22BEF2          16      LD  (RR_MID),HL
000E64 4E64 218000          10      LD  HL,128
                                
000E67 4E67 CD284A          17      CALL    ROM_READ
000E6A 4E6A C9              10      RET
                                
       4E6B                     GETSEQ:
000E6B 4E6B FD6E20          19      LD  L,(IY+32)
000E6E 4E6E FD660C          19      LD  H,(IY+12)
                                
000E71 4E71 CB25             8      SLA L
                                
000E73 4E73 CB3C             8      SRL H
000E75 4E75 CB1D             8      RR  L
000E77 4E77 C9              10      RET
                                
       4E78                     SETSEQ:
000E78 4E78 F5              11      PUSH    AF
000E79 4E79 3ABDF2          13      LD  A,(RR_LOW)
000E7C 4E7C 2ABEF2          16      LD  HL,(RR_MID)
                                
000E7F 4E7F CD964E          17      CALL    SSQ1
                                
000E82 4E82 29              11      ADD HL,HL
000E83 4E83 CB3D             8      SRL L
000E85 4E85 FD7520          19      LD  (IY+32),L
000E88 4E88 FD740C          19      LD  (IY+12),H
000E8B 4E8B F1              10      POP AF
000E8C 4E8C C9              10      RET
                                
       4E8D                     GETSIZE:
000E8D 4E8D FD7E10          19      LD  A,(IY+16)
000E90 4E90 FD6E11          19      LD  L,(IY+17)
000E93 4E93 FD6612          19      LD  H,(IY+18)
       4E96                     SSQ1:
000E96 4E96 87               4      ADD A,A
000E97 4E97 ED6A            15      ADC HL,HL
000E99 4E99 B7               4      OR  A
000E9A 4E9A C8              11      RET Z
000E9B 4E9B 23               6      INC HL
000E9C 4E9C C9              10      RET
                                
       4E9D                     SET_FCB:
000E9D 4E9D D5              11      PUSH    DE
000E9E 4E9E FDE1            14      POP IY
000EA0 4EA0 FD7E1C          19      LD  A,(IY+28)
000EA3 4EA3 FEFF             7      CP  0FFH
000EA5 4EA5 200C            12      JR  NZ,POPAF_SCF_FF_RET
000EA7 4EA7 E5              11      PUSH    HL
000EA8 4EA8 FD6E1A          19      LD  L,(IY+26)
000EAB 4EAB FD661B          19      LD  H,(IY+27)
000EAE 4EAE 22C1F2          16      LD  (_CLPS),HL
000EB1 4EB1 E1              10      POP HL
000EB2 4EB2 C9              10      RET
                                
       4EB3                     POPAF_SCF_FF_RET:
000EB3 4EB3 F1              10      POP AF
000EB4 4EB4 37               4      SCF
000EB5 4EB5 9F               4      SBC A,A
000EB6 4EB6 C9              10      RET
                                
       4EB7                     GET_DIR_DAT:
000EB7 4EB7 2AE9F2          16      LD  HL,(_CDX)
000EBA 4EBA 7C               4      LD  A,H
000EBB 4EBB B5               4      OR  L
000EBC 4EBC 2032            12      JR  NZ,GET_SUBDIR
000EBE 4EBE CDD14E          17      CALL    GET_DIR_POS
000EC1 4EC1 C660             7      ADD A,high BANK1_ADR
000EC3 4EC3 2E00             7      LD  L,0
000EC5 4EC5 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                    CALL    CHECK_DIR_PAGE
                                #endif
000EC6 4EC6 3AB8F2          13      LD  A,(_BANK1)
000EC9 4EC9 32E2F2          13      LD  (_DIR_BANK),A
                                
000ECC 4ECC 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000ECF 4ECF 4F               4      LD  C,A
000ED0 4ED0 C9              10      RET
                                
       4ED1                     GET_DIR_POS:                ;ルートディレクトリ
000ED1 4ED1 CD8C52          17      CALL    GET_DISK_BANK_FDRV
000ED4 4ED4 32B8F2          13      LD  (_BANK1),A
000ED7 4ED7 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000EDA 4EDA 47               4      LD  B,A
000EDB 4EDB 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000EDE 4EDE 4F               4      LD  C,A
000EDF 4EDF 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4EE2                     GET_DIR_POS1:
000EE2 4EE2 81               4      ADD A,C
000EE3 4EE3 10FD            13      DJNZ    GET_DIR_POS1
                                
000EE5 4EE5 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
000EE9 4EE9 37               4      SCF     ;無限ループ回避
       4EEA                     L_MDP:
000EEA 4EEA CB18             8      RR  B   ;->CF
000EEC 4EEC D8              11      RET C
000EED 4EED 87               4      ADD A,A
000EEE 4EEE 18FA            12      JR  L_MDP
                                
       4EF0                     GET_SUBDIR:             ;サブディレクトリ
000EF0 4EF0 CD0D4E          17      CALL    CLUST_HL
000EF3 4EF3 EB               4      EX  DE,HL
000EF4 4EF4 3AB7F2          13      LD  A,(_BANK)
000EF7 4EF7 32E2F2          13      LD  (_DIR_BANK),A
000EFA 4EFA 3ABAF2          13      LD  A,(CLSZ_H)
000EFD 4EFD 87               4      ADD A,A     ;*2
000EFE 4EFE 87               4      ADD A,A     ;*4
000EFF 4EFF 87               4      ADD A,A     ;*8
000F00 4F00 4F               4      LD  C,A
000F01 4F01 C9              10      RET
                                
       4F02                     STATEMENT:
000F02 4F02 119E50          10      LD  DE,STR_CHDIR
000F05 4F05 CD8450          17      CALL    CPPROCNM
000F08 4F08 2812            12      JR  Z,_CHDIR
000F0A 4F0A 11A450          10      LD  DE,STR_CHDRV
000F0D 4F0D CD8450          17      CALL    CPPROCNM
000F10 4F10 281C            12      JR  Z,_CHDRV
000F12 4F12 11AA50          10      LD  DE,STR_RAMDISK
000F15 4F15 CD8450          17      CALL    CPPROCNM
000F18 4F18 2829            12      JR  Z,_RAMDISK
000F1A 4F1A 37               4      SCF
000F1B 4F1B C9              10      RET
       4F1C                     _CHDIR:
000F1C 4F1C 7E               7      LD  A,(HL)
000F1D 4F1D FE28             7      CP  '('
000F1F 4F1F 37               4      SCF
000F20 4F20 C0              11      RET NZ
000F21 4F21 CDD647          17      CALL    INIT_PARAM
000F24 4F24 CDC94A          17      CALL    FILE_B
000F27 4F27 CD574F          17      CALL    ROM_CD
000F2A 4F2A D0              11      RET NC
000F2B 4F2B C37C46          10      JP  ERROR_FILE_NOT_FOUND
                                
       4F2E                     _CHDRV:
000F2E 4F2E 7E               7      LD  A,(HL)
000F2F 4F2F FE28             7      CP  '('
000F31 4F31 37               4      SCF
000F32 4F32 C0              11      RET NZ
000F33 4F33 CDD647          17      CALL    INIT_PARAM
000F36 4F36 E5              11      PUSH    HL
000F37 4F37 CDC94A          17      CALL    FILE_B
000F3A 4F3A E1              10      POP HL
000F3B 4F3B 23               6      INC HL
000F3C 4F3C 3AEBF2          13      LD  A,(FDRV)
000F3F 4F3F 3D               4      DEC A
000F40 4F40 C3F254          10      JP  _SYS0EX1
                                
       4F43                     _RAMDISK:
000F43 4F43 7E               7      LD  A,(HL)
000F44 4F44 FE28             7      CP  '('
000F46 4F46 37               4      SCF
000F47 4F47 C0              11      RET NZ
000F48 4F48 23               6      INC HL
000F49 4F49 DD212F54        14      LD  IX,FRMQNT
000F4D 4F4D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000F51 4F51 CD1C00          17      CALL    _CALSLT
                                ;   LD  A,(HOKVLD)  ;bit0: 拡張 BIOSの存在
                                ;   CPL
                                ;   AND 1
                                ;   LD  A,D
                                ;   OR  E
                                ;   JP  NZ,ERROR_INTERNAL_ERROR
                                ;   PUSH    HL      ;EXTBIOもDISK BIOSで初期化してそう
                                ;   XOR A
                                ;   LD  DE,0401H    ;D=マッパサポートルチン(4) E=機能番号(1)
                                ;   CALL    EXTBIO
                                ;   POP HL
                                ;   OR  A
                                ;   JP  Z,ERROR_INTERNAL_ERROR
000F54 4F54 23               6      INC HL
000F55 4F55 AF               4      XOR A
000F56 4F56 C9              10      RET
                                
       4F57                     ROM_CD:
000F57 4F57 3AECF2          13      LD  A,(FNAME)
000F5A 4F5A FE20             7      CP  020H
000F5C 4F5C 2835            12      JR  Z,CD1
000F5E 4F5E CD5B4C          17      CALL    ROM_OPEN
000F61 4F61 D8              11      RET C
                                #if exists USE_MORMAL32K_OR_ASCII16
000F62 4F62 D5              11      PUSH    DE
000F63 4F63 2AE0F2          16      LD  HL,(DIRENT1)
000F66 4F66 110B00          10      LD  DE,0000BH   ;属性(アトリビュート)
000F69 4F69 19              11      ADD HL,DE
000F6A 4F6A CD8B43          17      CALL    RDSLT_ROM
000F6D 4F6D D1              10      POP DE
000F6E 4F6E CB67             8      BIT 4,A     ;ディレクトリ
000F70 4F70 CA7C46          10      JP  Z,ERROR_FILE_NOT_FOUND
000F73 4F73 D5              11      PUSH    DE
000F74 4F74 2AE0F2          16      LD  HL,(DIRENT1)
000F77 4F77 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000F7A 4F7A 19              11      ADD HL,DE
000F7B 4F7B CD8B43          17      CALL    RDSLT_ROM
000F7E 4F7E 23               6      INC HL
000F7F 4F7F 5F               4      LD  E,A
000F80 4F80 CD8B43          17      CALL    RDSLT_ROM
000F83 4F83 57               4      LD  D,A
000F84 4F84 EB               4      EX  DE,HL
000F85 4F85 D1              10      POP DE
                                #else
                                    LD  IY,(DIRENT1)
                                    BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    LD  L,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  H,(IY+01BH)
                                #endif
       4F86                     CD2:
000F86 4F86 22DEF2          16      LD  (_CD),HL
000F89 4F89 2AE7F2          16      LD  HL,(PARAM1)
       4F8C                     CD_SKIP:
000F8C 4F8C 7E               7      LD  A,(HL)
000F8D 4F8D 23               6      INC HL
000F8E 4F8E FE21             7      CP  021H
000F90 4F90 38FA            12      JR  C,CD_SKIP
000F92 4F92 C9              10      RET
       4F93                     CD1:
000F93 4F93 2AE9F2          16      LD  HL,(_CDX)
000F96 4F96 18EE            12      JR  CD2
                                
       4F98                     GET_BASIC_FCB:
000F98 4F98 D5              11      PUSH    DE
000F99 4F99 23               6      INC HL  ;+1
000F9A 4F9A 5E               7      LD  E,(HL)  ;FCB[1]
000F9B 4F9B 23               6      INC HL  ;+2
000F9C 4F9C 56               7      LD  D,(HL)  ;FCB[2]
000F9D 4F9D 23               6      INC HL  ;+3
000F9E 4F9E ED53E0F2        20      LD  (DIRENT1),DE
                                            ;FCB[3]
000FA2 4FA2 23               6      INC HL  ;+4
                                            ;FCB[4]
000FA3 4FA3 23               6      INC HL  ;+5
000FA4 4FA4 7E               7      LD  A,(HL)  ;FCB[5]
000FA5 4FA5 23               6      INC HL  ;+6
000FA6 4FA6 32E2F2          13      LD  (_DIR_BANK),A
000FA9 4FA9 5E               7      LD  E,(HL)  ;FCB[6]
000FAA 4FAA 23               6      INC HL  ;+7
000FAB 4FAB 56               7      LD  D,(HL)  ;FCB[7]
000FAC 4FAC 23               6      INC HL  ;+8
000FAD 4FAD ED53BDF2        20      LD  (RR_LOW),DE
000FB1 4FB1 7E               7      LD  A,(HL)  ;FCB[8]
000FB2 4FB2 23               6      INC HL  ;+9
000FB3 4FB3 32BFF2          13      LD  (RR_HIGH),A
000FB6 4FB6 7E               7      LD  A,(HL)  ;FCB[9]
000FB7 4FB7 23               6      INC HL  ;+10
000FB8 4FB8 22C7F2          16      LD  (_DTA),HL   ;FCB[10]
000FBB 4FBB D1              10      POP DE
000FBC 4FBC C9              10      RET
                                
       4FBD                     SET_BASIC_FCB:
000FBD 4FBD E5              11      PUSH    HL
000FBE 4FBE 2A64F8          16      LD  HL,(PTRFIL)
000FC1 4FC1 23               6      INC HL  ;+1
000FC2 4FC2 D5              11      PUSH    DE
000FC3 4FC3 ED5BE0F2        20      LD  DE,(DIRENT1)
000FC7 4FC7 73               7      LD  (HL),E  ;FCB[1]
000FC8 4FC8 23               6      INC HL  ;+2
000FC9 4FC9 72               7      LD  (HL),D  ;FCB[2]
000FCA 4FCA 23               6      INC HL  ;+3
000FCB 4FCB AF               4      XOR A
000FCC 4FCC 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
000FCD 4FCD 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
000FCE 4FCE 23               6      INC HL  ;+5
000FCF 4FCF 3AE2F2          13      LD  A,(_DIR_BANK)
000FD2 4FD2 77               7      LD  (HL),A  ;FCB[5]
000FD3 4FD3 23               6      INC HL  ;+6
000FD4 4FD4 ED5BBDF2        20      LD  DE,(RR_LOW)
000FD8 4FD8 73               7      LD  (HL),E  ;FCB[6]
000FD9 4FD9 23               6      INC HL  ;+7
000FDA 4FDA 72               7      LD  (HL),D  ;FCB[7]
000FDB 4FDB 23               6      INC HL  ;+8
000FDC 4FDC 3ABFF2          13      LD  A,(RR_HIGH)
000FDF 4FDF 77               7      LD  (HL),A  ;FCB[8]
000FE0 4FE0 23               6      INC HL  ;+9
000FE1 4FE1 3600            10      LD  (HL),0  ;FCB[9]
000FE3 4FE3 D1              10      POP DE
000FE4 4FE4 E1              10      POP HL
000FE5 4FE5 C9              10      RET
                                
       4FE6                     DEVICE_CHECK:
000FE6 4FE6 23               6      INC HL
000FE7 4FE7 7E               7      LD  A,(HL)
000FE8 4FE8 2B               6      DEC HL
000FE9 4FE9 B7               4      OR  A
000FEA 4FEA C8              11      RET Z
000FEB 4FEB 11B250          10      LD  DE,STR_ROM
000FEE 4FEE CD8450          17      CALL    CPPROCNM
000FF1 4FF1 2802            12      JR  Z,DEVICE_OK
000FF3 4FF3 37               4      SCF
000FF4 4FF4 C9              10      RET
       4FF5                     DEVICE_OK:
000FF5 4FF5 AF               4      XOR A
000FF6 4FF6 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファインデックス
                                ; +10: バッファ
                                
       4FF7                     DEVICE_0_OPEN:
000FF7 4FF7 7B               4      LD  A,E
000FF8 4FF8 FE02             7      CP  2       ;FOR OUTPUT
000FFA 4FFA 281B            12      JR  Z,OPEN2
000FFC 4FFC D5              11      PUSH    DE
000FFD 4FFD E5              11      push    hl
                                ;
000FFE 4FFE 3E01             7      LD  A,1     ;ドライブA
001000 5000 32EBF2          13      LD  (FDRV),A
001003 5003 2166F8          10      LD  HL,FILNAM
001006 5006 11ECF2          10      LD  DE,FNAME
001009 5009 010B00          10      LD  BC,8+3
00100C 500C CD6F56          17      CALL    INIT_FILE1
00100F 500F CD5B4C          17      CALL    ROM_OPEN
001012 5012 DA7C46          10      JP  C,ERROR_FILE_NOT_FOUND
001015 5015 E1              10      pop hl
001016 5016 D1              10      POP DE
       5017                     OPEN2:
001017 5017 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
00101A 501A 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
00101B 501B AF               4      XOR A
00101C 501C 32E3F2          13      LD  (LEFTX),A
00101F 501F CDBD4F          17      CALL    SET_BASIC_FCB
001022 5022 7B               4      ld  a,e
001023 5023 FE08             7      cp  8
001025 5025 3F               4      ccf
001026 5026 C9              10      ret
                                
       5027                     DEVICE_2_CLOSE:
001027 5027 AF               4      XOR A
                                ;   LD  (HL),A
001028 5028 6F               4      LD  L,A
001029 5029 67               4      LD  H,A
00102A 502A 2264F8          16      LD  (PTRFIL),HL
00102D 502D C9              10      RET
                                
       502E                     DEVICE_ENTRY:
00102E 502E FE08             7      CP  8
001030 5030 2812            12      JR  Z,DEVICE_8_SIN
001032 5032 3C               4      INC A
001033 5033 28B1            12      JR  Z,DEVICE_CHECK:
001035 5035 3D               4      DEC A
001036 5036 28BF            12      JR  Z,DEVICE_0_OPEN
001038 5038 FE02             7      CP  2
00103A 503A 28EB            12      JR  Z,DEVICE_2_CLOSE
00103C 503C FE06             7      CP  6
00103E 503E 2802            12      JR  Z,DEVICE_6_SOUT
001040 5040 37               4      SCF
001041 5041 C9              10      RET
                                
       5042                     DEVICE_6_SOUT:
001042 5042 AF               4      XOR A
001043 5043 C9              10      RET
                                
       5044                     DEVICE_8_SIN:
001044 5044 CD984F          17      CALL    GET_BASIC_FCB
001047 5047 E67F             7      AND 127
001049 5049 281D            12      JR  Z,SIN_READ_DISK
00104B 504B 2AC7F2          16      LD  HL,(_DTA)
00104E 504E 2B               6      DEC HL
00104F 504F 34              11      INC (HL)
001050 5050 3C               4      INC A   ;(INC HL)
001051 5051 85               4      ADD A,L ;ADD HL,A
001052 5052 6F               4      LD  L,A ;
001053 5053 8C               4      ADC A,H ;
001054 5054 95               4      SUB L   ;
001055 5055 67               4      LD  H,A ;
       5056                     SIN_READ1:
001056 5056 7E               7      LD  A,(HL)
001057 5057 FE0A             7      CP  00AH
001059 5059 C8              11      RET Z   ;ZF=separate
00105A 505A FE1A             7      CP  01AH
00105C 505C 2803            12      JR  Z,SIN_EOF
00105E 505E 37               4      SCF
00105F 505F 3F               4      CCF     ;ZF=0 CF=0にしたい
001060 5060 C9              10      RET
       5061                     SIN_EOF:
001061 5061 2AC7F2          16      LD  HL,(_DTA)
001064 5064 2B               6      DEC HL
001065 5065 35              11      DEC (HL)
       5066                     SCF_RET:
001066 5066 37               4      SCF
001067 5067 C9              10      RET
                                
       5068                     SIN_READ_DISK:
001068 5068 218000          10      LD  HL,128
00106B 506B CD284A          17      CALL    ROM_READ
00106E 506E CDBD4F          17      CALL    SET_BASIC_FCB
001071 5071 7C               4      LD  A,H
001072 5072 B5               4      OR  L
001073 5073 28F1            12      JR  Z,SCF_RET
001075 5075 ED5BC7F2        20      LD  DE,(_DTA)
001079 5079 19              11      ADD HL,DE
00107A 507A 361A            10      LD  (HL),01AH
00107C 507C 2AC7F2          16      LD  HL,(_DTA)
00107F 507F 2B               6      DEC HL
001080 5080 34              11      INC (HL)
001081 5081 23               6      INC HL
001082 5082 18D2            12      JR  SIN_READ1
                                
       5084                     CPPROCNM:
001084 5084 E5              11      PUSH    HL
001085 5085 2189FD          10      LD  HL,PROCNM
       5088                     CPPROCNM1:
001088 5088 1A               7      LD  A,(DE)
001089 5089 13               6      INC DE
00108A 508A BE               7      CP  (HL)
00108B 508B 23               6      INC HL
00108C 508C 2003            12      JR  NZ,CPPROCNM2
00108E 508E B7               4      OR  A
00108F 508F 20F7            12      JR  NZ,CPPROCNM1
       5091                     CPPROCNM2:
001091 5091 E1              10      POP HL
001092 5092 C9              10      RET
                                
       5093                     WILDCARD:
001093 5093 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       509E                     STR_CHDIR:
00109E 509E 434844495200            DB  "CHDIR",0
       50A4                     STR_CHDRV:
0010A4 50A4 434844525600            DB  "CHDRV",0
       50AA                     STR_RAMDISK:
0010AA 50AA 52414D4449534B00        DB  "RAMDISK",0
       50B2                     STR_ROM:
0010B2 50B2 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       50B6                     ERROR_WRITE_PROTECTED:
0010B6 50B6 3E00             7      LD  A,0     ;Write protected
0010B8 50B8 C9              10      RET
       50B9                     DISKIO:
0010B9 50B9 38FB            12      JR  C,ERROR_WRITE_PROTECTED
0010BB 50BB 48               4      LD  C,B
0010BC 50BC CD9652          17      CALL    GET_DISK_BANK
       50BF                     SETMAP1:        
0010BF 50BF E5              11      PUSH    HL
       50C0                     DISKIO1:
0010C0 50C0 C5              11      PUSH    BC      ;B=残りのセクタ数
0010C1 50C1 D5              11      PUSH    DE      ;DE=セクタ番号
0010C2 50C2 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
0010C3 50C3 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
0010C4 50C4 F5              11      PUSH    AF
0010C5 50C5 3ABCF2          13      LD  A,(SECSZ_H)
0010C8 50C8 CDB952          17      CALL    MUL_AHL
0010CB 50CB F1              10      POP AF
                                #if exists USE_MORMAL32K_OR_ASCII16
0010CC 50CC 7D               4      LD  A,L
0010CD 50CD C5              11      PUSH    BC
0010CE 50CE 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
0010D1 50D1 09              11      ADD HL,BC
0010D2 50D2 C1              10      POP BC
0010D3 50D3 3013            12      JR  NC,DISKIO2
0010D5 50D5 4D               4      LD  C,L     ;C=読み出し元
0010D6 50D6 29              11      ADD HL,HL   ;64KB→32KB
0010D7 50D7 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
0010D8 50D8 CD8C52          17      CALL    GET_DISK_BANK_FDRV
0010DB 50DB 84               4      ADD A,H
0010DC 50DC 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
0010DF 50DF 32B7F2          13      LD  (_BANK),A
0010E2 50E2 69               4      LD  L,C     ;C=読み出し元
0010E3 50E3 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
0010E5 50E5 A5               4      AND L
0010E6 50E6 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL       ;64KB→32KB
                                    ADD HL,HL       ;32KB→16KB
                                    ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  A,C     ;C=読み出し元
                                    AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       50E8                     DISKIO2:
0010E8 50E8 C660             7      ADD A,high BANK1_ADR
0010EA 50EA 67               4      LD  H,A
0010EB 50EB ED4BBBF2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
0010EF 50EF 69               4      LD  L,C     ;C=0
0010F0 50F0 CDFE43          17      CALL    ROM_LDIR
0010F3 50F3 EB               4      EX  DE,HL
0010F4 50F4 F1              10      POP AF
0010F5 50F5 D1              10      POP DE
0010F6 50F6 13               6      INC DE
0010F7 50F7 C1              10      POP BC
0010F8 50F8 10C6            13      DJNZ    DISKIO1
0010FA 50FA 41               4      LD  B,C
                                
0010FB 50FB E1              10      POP HL
0010FC 50FC AF               4      XOR A
                                
0010FD 50FD FB               4      EI
0010FE 50FE C9              10      RET
                                
       50FF                     DSKCHG:
0010FF 50FF CD3851          17      CALL    IS_BPB
001102 5102 3824            12      JR  C,NOTREADY
001104 5104 3A23FB          13      LD  A,(DRVTBL+2)
001107 5107 B7               4      OR  A
001108 5108 201A            12      JR  NZ,DSKCHG1
00110A 510A 3A21FB          13      LD  A,(DRVTBL)
00110D 510D FE02             7      CP  2
00110F 510F 2013            12      JR  NZ,DSKCHG1
001111 5111 CD3851          17      CALL    IS_BPB
001114 5114 300E            12      JR  NC,DSKCHG1
001116 5116 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
001118 5118 3221FB          13      LD  (DRVTBL),A
00111B 511B 3223FB          13      LD  (DRVTBL+2),A
00111E 511E 3A48F3          13      LD  A,(MASTERS)
001121 5121 3224FB          13      LD  (DRVTBL+3),A
       5124                     DSKCHG1:
001124 5124 AF               4      XOR A
001125 5125 0601             7      LD  B,1
001127 5127 C9              10      RET
       5128                     NOTREADY:
001128 5128 3E02             7      LD  A,2
00112A 512A 37               4      SCF
00112B 512B C9              10      RET
                                
       512C                     NO_BPB:
00112C 512C E1              10      POP HL
00112D 512D 23               6      INC HL
00112E 512E 11BF52          10      LD  DE,DPB2DD
001131 5131 011200          10      LD  BC,DPB2DD_E-DPB2DD
001134 5134 EDB0                    LDIR
001136 5136 AF               4      XOR A
001137 5137 C9              10      RET
                                
       5138                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
001138 5138 CD9652          17      CALL    GET_DISK_BANK
                                
00113B 513B 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
00113E 513E FE01             7      CP  1
001140 5140 D8              11      RET C
                                
001141 5141 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
001144 5144 C6FF             7      ADD A,0FFH
001146 5146 D8              11      RET C
                                
001147 5147 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       514A                     IS_BPB1:
00114A 514A FE01             7      CP  1
00114C 514C C8              11      RET Z
00114D 514D FE02             7      CP  2
00114F 514F C8              11      RET Z
001150 5150 FE04             7      CP  4
001152 5152 C8              11      RET Z
001153 5153 37               4      SCF
001154 5154 C9              10      RET
                                
       5155                     GETDPB:
001155 5155 E5              11      PUSH    HL
001156 5156 CD9652          17      CALL    GET_DISK_BANK
                                
001159 5159 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
00115C 515C B7               4      OR  A
00115D 515D 28CD            12      JR  Z,NO_BPB
00115F 515F DDE1            14      POP IX
001161 5161 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
001164 5164 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
001167 5167 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
00116A 516A 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
00116D 516D DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
001170 5170 87               4      ADD A,A
001171 5171 87               4      ADD A,A
001172 5172 87               4      ADD A,A
001173 5173 3D               4      DEC A
001174 5174 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
001177 5177 06FF             7      LD  B,-1
001179 5179 A7               4      AND A           ;無限ループ阻止
       517A                     GETDPB1:
00117A 517A 04               4      INC B
00117B 517B 1F               4      RRA
00117C 517C 38FC            12      JR  C,GETDPB1
00117E 517E DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
001181 5181 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
001184 5184 3D               4      DEC A
001185 5185 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
001188 5188 A7               4      AND A           ;無限ループ阻止
001189 5189 06FF             7      LD  B,-1
       518B                     GETDPB2:
00118B 518B 04               4      INC B
00118C 518C 1F               4      RRA
00118D 518D 38FC            12      JR  C,GETDPB2
00118F 518F 04               4      INC B
001190 5190 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
001193 5193 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
001196 5196 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
001199 5199 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
00119C 519C 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
00119F 519F DD770A          19      LD  (IX+10),A       ;FATCNT
                                
0011A2 51A2 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
0011A5 51A5 DD770B          19      LD  (IX+11),A       ;MAXENT
                                
0011A8 51A8 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
0011AC 51AC DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
0011AF 51AF DD460A          19      LD  B,(IX+10)       ;FATCNT
0011B2 51B2 210000          10      LD  HL,0
       51B5                     GETDPB3:
0011B5 51B5 19              11      ADD HL,DE
0011B6 51B6 10FD            13      DJNZ    GETDPB3
       51B8                     GETDPB4:
0011B8 51B8 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
0011BB 51BB DD5609          19      LD  D,(IX+9)        ;FIRFAT
0011BE 51BE 19              11      ADD HL,DE
0011BF 51BF DD7511          19      LD  (IX+17),L       ;FIRDIR
0011C2 51C2 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
0011C5 51C5 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0011C8 51C8 87               4      ADD A,A
0011C9 51C9 87               4      ADD A,A
0011CA 51CA DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       51CD                     GETDPB5:
0011CD 51CD CB3B             8      SRL E
0011CF 51CF 1F               4      RRA
0011D0 51D0 30FB            12      JR  NC,GETDPB5
0011D2 51D2 1600             7      LD  D,0
0011D4 51D4 19              11      ADD HL,DE
0011D5 51D5 DD750C          19      LD  (IX+12),L       ;FIRREC
0011D8 51D8 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
0011DB 51DB 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
0011DE 51DE DD5E0C          19      LD  E,(IX+12)       ;FIRREC
0011E1 51E1 DD560D          19      LD  D,(IX+13)       ;FIRREC
0011E4 51E4 A7               4      AND A
0011E5 51E5 ED52            15      SBC HL,DE
                                
0011E7 51E7 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
0011EA 51EA 3C               4      INC A
0011EB 51EB 37               4      SCF             ;無限ループ阻止
       51EC                     GETDPB6:
0011EC 51EC 1F               4      RRA
0011ED 51ED 3806            12      JR  C,GETDPB7
0011EF 51EF CB3C             8      SRL H
0011F1 51F1 CB1D             8      RR  L
0011F3 51F3 18F7            12      JR  GETDPB6
       51F5                     GETDPB7:
0011F5 51F5 23               6      INC HL
0011F6 51F6 DD750E          19      LD  (IX+14),L       ;MAXCLUS
0011F9 51F9 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       51FC                     GETDPBD1:
0011FC 51FC DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0011FF 51FF E6FC             7      AND 0FCH
001201 5201 C8              11      RET Z
                                
001202 5202 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
001206 5206 37               4      SCF
001207 5207 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
00120B 520B DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
00120E 520E DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
001212 5212 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
001216 5216 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
00121A 521A DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
00121E 521E DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
001222 5222 DDCB1126        23      SLA (IX+17)         ;FIRDIR
001226 5226 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
00122A 522A DD6E11          19      LD  L,(IX+17)       ;FIRDIR
00122D 522D DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
001230 5230 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001233 5233 87               4      ADD A,A
001234 5234 87               4      ADD A,A
001235 5235 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       5238                     GETDPBD5:
001238 5238 CB3B             8      SRL E
00123A 523A 1F               4      RRA
00123B 523B 30FB            12      JR  NC,GETDPBD5
00123D 523D 1600             7      LD  D,0
00123F 523F 19              11      ADD HL,DE
001240 5240 DD750C          19      LD  (IX+12),L       ;FIRREC
001243 5243 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001246 5246 18B4            12      JR  GETDPBD1
                                
       5248                     CHOICE:
001248 5248 210000          10      LD  HL,0
00124B 524B C9              10      RET
                                
       524C                     DSKFMT:
00124C 524C AF               4      XOR A
00124D 524D 37               4      SCF
       524E                     DSKSTP:
00124E 524E C9              10      RET
                                
       524F                     BASENT:
00124F 524F 2A74F6          16      LD  HL,(STKTOP)
001252 5252 3A40F3          13      LD  A,(REBOOT)
001255 5255 C6FF             7      ADD A,0FFH
001257 5257 3811            12      JR  C,REBOOT1
001259 5259 21D152          10      LD  HL,AUTOEXEC
00125C 525C 11EBF2          10      LD  DE,FDRV
00125F 525F 010C00          10      LD  BC,1+8+3
001262 5262 EDB0                    LDIR
001264 5264 CD5B4C          17      CALL    ROM_OPEN
001267 5267 D4C645          17      CALL    NC,ROM_LOAD1
       526A                     REBOOT1:
00126A 526A 21DD52          10      LD  HL,CMD_RUN
00126D 526D 111FF4          10      LD  DE,KBUF
001270 5270 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
001273 5273 D5              11      PUSH    DE
001274 5274 EDB0                    LDIR
001276 5276 3004            12      JR  NC,REBOOT2
001278 5278 AF               4      XOR A
001279 5279 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       527C                     REBOOT2:
00127C 527C E1              10      POP HL
00127D 527D FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
001281 5281 DD210146        14      LD  IX,NEWSTT
001285 5285 C31C00          10      JP  _CALSLT
                                
       5288                     GETSLT:
001288 5288 3A22FB          13      LD  A,(DRVTBL+1)
00128B 528B C9              10      RET
                                
       528C                     GET_DISK_BANK_FDRV:
00128C 528C 3AEBF2          13      LD  A,(FDRV)
00128F 528F D601             7      SUB 1
001291 5291 3003            12      JR  NC,GET_DISK_BANK
001293 5293 3ADDF2          13      LD  A,(_DVSW)
       5296                     GET_DISK_BANK:
001296 5296 FE07             7      CP  7       ;H:
001298 5298 2801            12      JR  Z,SET_DISK_BANK_A
00129A 529A B7               4      OR  A       ;A=DRIVE
       529B                     SET_DISK_BANK_A:
00129B 529B 3E01             7      LD  A,DISK_BANK
00129D 529D 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
00129F 529F 3ADCF2          13      LD  A,(B_DRIVE)
                                #endif
       52A2                     SET_DISK_BANK:
                                #if exists USE_MORMAL32K_OR_ASCII16
0012A2 52A2 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0012A5 52A5 F5              11      PUSH    AF
0012A6 52A6 E5              11      PUSH    HL
0012A7 52A7 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
0012AA 52AA 22BBF2          16      LD  (SECSZ),HL
0012AD 52AD 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0012B0 52B0 CDB952          17      CALL    MUL_AHL
0012B3 52B3 22B9F2          16      LD  (CLSZ),HL
0012B6 52B6 E1              10      POP HL
0012B7 52B7 F1              10      POP AF
0012B8 52B8 C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       52B9                     MUL_AHL:
0012B9 52B9 37               4      SCF     ;無限ループ回避
       52BA                     MUL_AHL1:
0012BA 52BA 1F               4      RRA     ;->CF
0012BB 52BB D8              11      RET C
0012BC 52BC 29              11      ADD HL,HL
0012BD 52BD 18FB            12      JR  MUL_AHL1
                                
       52BF                     DPB2DD:
0012BF 52BF F9                      DB  0F9H    ;MEDIA
0012C0 52C0 0002                    DW  00200H  ;SECSIZ
0012C2 52C2 0F                      DB  00FH    ;DIRMSK
0012C3 52C3 04                      DB  004H    ;DIRSHFT
0012C4 52C4 01                      DB  001H    ;CLUSMSK
0012C5 52C5 02                      DB  002H    ;CLUSSHFT
0012C6 52C6 0100                    DW  00001H  ;FIRFAT
0012C8 52C8 02                      DB  002H    ;FATCNT
0012C9 52C9 70                      DB  070H    ;MAXENT
0012CA 52CA 0E00                    DW  0000EH  ;FIRREC
0012CC 52CC CA02                    DW  002CAH  ;MAXCLUS
0012CE 52CE 03                      DB  003H    ;FATSIZ
0012CF 52CF 0700                    DW  0007H   ;FIRDIR
       52D1                     DPB2DD_E:
                                
       52D1                     AUTOEXEC:
0012D1 52D1 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       52DD                     CMD_RUN:
0012DD 52DD 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
                                #if exists USE_MORMAL32K_OR_ASCII16
0012E3 52E3 80F2                    DW  0F280H
                                #else
                                    DW  0F240H
                                #endif
       52E5                     CMD_CLEAR_E:
0012E5 52E5 3A8A00                  DB  03AH,08AH,0         ;RUN
       52E8                     CMD_RUN_E:
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       52E8                     POP_HL_ERROR:
0012E8 52E8 E1              10      POP     HL
       52E9                     _ERROR:
0012E9 52E9 0600             7      LD  B,0
0012EB 52EB A7               4      AND A
0012EC 52EC C9              10      RET
                                
       52ED                     ROM_BDOS:
0012ED 52ED E5              11      PUSH    HL
0012EE 52EE 79               4      LD  A,C
0012EF 52EF 87               4      ADD A,A
0012F0 52F0 38F7            12      JR  C,_ERROR
0012F2 52F2 6F               4      LD  L,A
0012F3 52F3 265F             7      LD  H,high STABLE
0012F5 52F5 7E               7      LD  A,(HL)
0012F6 52F6 2C               4      INC L
0012F7 52F7 66               7      LD  H,(HL)
0012F8 52F8 6F               4      LD  L,A
0012F9 52F9 E3              19      EX  (SP),HL
0012FA 52FA 79               4      LD  A,C
0012FB 52FB C9              10      RET
                                
       52FC                     _PRINT:
       52FC                     PRINT:
0012FC 52FC 7B               4      LD  A,E
0012FD 52FD 1803            12      JR  MSG_A
                                
       52FF                     _SYS01:     ;(BDOS)コンソール入力
0012FF 52FF CD7653          17      CALL    _SYS07
       5302                     MSG_A:
001302 5302 FE03             7      CP  3
001304 5304 2814            12      JR  Z,MSG_BR
       5306                     MSGA1:
001306 5306 F5              11      PUSH    AF
001307 5307 C5              11      PUSH    BC
001308 5308 D5              11      PUSH    DE
001309 5309 E5              11      PUSH    HL
00130A 530A DDE5            15      PUSH    IX
00130C 530C DD21A200        14      LD  IX,CHPUT
001310 5310 CDD642          17      CALL    CALSLT_R
001313 5313 DDE1            14      POP IX
001315 5315 E1              10      POP HL
001316 5316 D1              10      POP DE
001317 5317 C1              10      POP BC
       5318                     MSGA2:
001318 5318 F1              10      POP AF
001319 5319 C9              10      RET
       531A                     MSG_BR:
00131A 531A F5              11      PUSH    AF
00131B 531B 3ADDF3          13      LD  A,(CSRX)
00131E 531E FE02             7      CP  2
001320 5320 38F6            12      JR  C,MSGA2
001322 5322 F1              10      POP AF
       5323                     MSG_CR:
001323 5323 F5              11      PUSH    AF
001324 5324 3E0D             7      LD  A,00DH
001326 5326 CD0653          17      CALL    MSGA1
001329 5329 3E0A             7      LD  A,00AH
00132B 532B CD0653          17      CALL    MSGA1
00132E 532E F1              10      POP AF
00132F 532F C9              10      RET
                                
       5330                     _SYS02:     ;(BDOS)コンソール出力
001330 5330 CD4B53          17      CALL    BREAK
001333 5333 1805            12      JR  PRINTX
                                
       5335                     _SYS06:     ;(BDOS)コンソール直接入出力
001335 5335 7B               4      LD  A,E
001336 5336 3C               4      INC A
001337 5337 CA8A53          10      JP  Z,_INKEY
       533A                     PRINTX:
00133A 533A C3FC52          10      JP  _PRINT
                                
       533D                     _SYS08:     ;(BDOS)エコーなしコンソール入力
00133D 533D CD7653          17      CALL    _SYS07
001340 5340 FE03             7      CP  3
001342 5342 CC4B53          17      CALL    Z,_BREAK
001345 5345 FE13             7      CP  013H        ;CTRL+S
001347 5347 C0              11      RET NZ
       5348                     PAUSE:
001348 5348 CD6253          17      CALL    KEYBC
                                
       534B                     _BREAK:
       534B                     BREAK:
00134B 534B F5              11      PUSH    AF
00134C 534C C5              11      PUSH    BC
00134D 534D D5              11      PUSH    DE
00134E 534E E5              11      PUSH    HL
00134F 534F DDE5            15      PUSH    IX
001351 5351 DD21B700        14      LD  IX,BREAKX
001355 5355 CDD642          17      CALL    CALSLT_R
001358 5358 DDE1            14      POP IX
00135A 535A E1              10      POP HL
00135B 535B D1              10      POP DE
00135C 535C C1              10      POP BC
00135D 535D DC4B53          17      CALL    C,_BREAK
001360 5360 F1              10      POP AF
001361 5361 C9              10      RET
       5362                     KEYBC:
001362 5362 F5              11      PUSH    AF
001363 5363 C5              11      PUSH    BC
001364 5364 D5              11      PUSH    DE
001365 5365 E5              11      PUSH    HL
001366 5366 DDE5            15      PUSH    IX
001368 5368 DD215601        14      LD  IX,KILBUF
00136C 536C CDD642          17      CALL    CALSLT_R
00136F 536F DDE1            14      POP IX
001371 5371 E1              10      POP HL
001372 5372 D1              10      POP DE
001373 5373 C1              10      POP BC
001374 5374 F1              10      POP AF
001375 5375 C9              10      RET
                                
       5376                     _SYS07:
       5376                     FLGET:
001376 5376 C5              11      PUSH    BC
001377 5377 D5              11      PUSH    DE
001378 5378 E5              11      PUSH    HL
001379 5379 DDE5            15      PUSH    IX
00137B 537B DD219F00        14      LD  IX,CHGET
00137F 537F CDD642          17      CALL    CALSLT_R
001382 5382 DDE1            14      POP IX
001384 5384 E1              10      POP HL
001385 5385 D1              10      POP DE
001386 5386 C1              10      POP BC
001387 5387 FE03             7      CP  3
001389 5389 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       538A                     _INKEY:
       538A                     INKEY:
00138A 538A CD2454          17      CALL    CPM_CONST
00138D 538D C8              11      RET Z
00138E 538E 18E6            12      JR  FLGET
                                
       5390                     _SYS0A:     ;(BDOS)文字列入力
001390 5390 C5              11      PUSH    BC
001391 5391 E5              11      PUSH    HL
001392 5392 D5              11      PUSH    DE
001393 5393 CDBC53          17      CALL    GETL
001396 5396 111FF4          10      LD  DE,KBUF
001399 5399 E1              10      POP HL
00139A 539A E5              11      PUSH    HL
00139B 539B 0E00             7      LD  C,0
00139D 539D 3004            12      JR  NC,SAX0
00139F 539F 23               6      INC HL
0013A0 53A0 23               6      INC HL
0013A1 53A1 1808            12      JR  SAX4
       53A3                     SAX0:
0013A3 53A3 46               7      LD  B,(HL)
0013A4 53A4 23               6      INC HL
       53A5                     SAX1:
0013A5 53A5 23               6      INC HL
0013A6 53A6 1A               7      LD  A,(DE)
0013A7 53A7 13               6      INC DE
0013A8 53A8 B7               4      OR  A
0013A9 53A9 2004            12      JR  NZ,SAX2
       53AB                     SAX4:
0013AB 53AB 360D            10      LD  (HL),00DH
0013AD 53AD 1804            12      JR  SAX3
       53AF                     SAX2:
0013AF 53AF 77               7      LD  (HL),A
0013B0 53B0 0C               4      INC C
0013B1 53B1 10F2            13      DJNZ    SAX1
       53B3                     SAX3:
0013B3 53B3 D1              10      POP DE
0013B4 53B4 79               4      LD  A,C
0013B5 53B5 13               6      INC DE
0013B6 53B6 12               7      LD  (DE),A
0013B7 53B7 1B               6      DEC DE
0013B8 53B8 E1              10      POP HL
0013B9 53B9 C1              10      POP BC
0013BA 53BA A7               4      AND A
0013BB 53BB C9              10      RET
       53BC                     GETL:
0013BC 53BC DDE5            15      PUSH    IX
0013BE 53BE FDE5            15      PUSH    IY
                                
0013C0 53C0 2ADCF3          16      LD  HL,(CSRY)
0013C3 53C3 22CAFB          16      LD  (FSTPOS),HL
       53C6                     GETL1:
0013C6 53C6 CD3D53          17      CALL    _SYS08
0013C9 53C9 FE09             7      CP  9
0013CB 53CB 2008            12      JR  NZ,GETL1V
0013CD 53CD 211FF4          10      LD  HL,KBUF
0013D0 53D0 CD6043          17      CALL    MSX
0013D3 53D3 18F1            12      JR  GETL1
       53D5                     GETL1V:
0013D5 53D5 5F               4      LD  E,A
0013D6 53D6 FE08             7      CP  8
0013D8 53D8 CC7254          17      CALL    Z,CTRL02
0013DB 53DB FE20             7      CP  020H
0013DD 53DD D49E54          17      CALL    NC,INSERT
0013E0 53E0 CD0653          17      CALL    MSGA1
                                
0013E3 53E3 7B               4      LD  A,E
0013E4 53E4 FE0D             7      CP  00DH
0013E6 53E6 20DE            12      JR  NZ,GETL1
                                
0013E8 53E8 111FF4          10      LD  DE,KBUF
0013EB 53EB 3AB0F3          13      LD  A,(LINLEN)
0013EE 53EE 47               4      LD  B,A
0013EF 53EF CD7E56          17      CALL    ZERO_MEMORY_DE
                                
0013F2 53F2 2ACAFB          16      LD  HL,(FSTPOS)
0013F5 53F5 3ADCF3          13      LD  A,(CSRY)
0013F8 53F8 6F               4      LD  L,A
0013F9 53F9 E5              11      PUSH    HL
0013FA 53FA CDCF54          17      CALL    LOC0
0013FD 53FD 4D               4      LD  C,L
0013FE 53FE 44               4      LD  B,H
0013FF 53FF E1              10      POP HL
001400 5400 3AB0F3          13      LD  A,(LINLEN)
001403 5403 94               4      SUB H
001404 5404 3D               4      DEC A
001405 5405 5F               4      LD  E,A
001406 5406 211FF4          10      LD  HL,KBUF
       5409                     GETL2:
001409 5409 CD6254          17      CALL    _SCRN
00140C 540C 03               6      INC BC
00140D 540D 77               7      LD  (HL),A
00140E 540E 23               6      INC HL
00140F 540F 1D               4      DEC E
001410 5410 20F7            12      JR  NZ,GETL2
001412 5412 CD2353          17      CALL    MSG_CR
                                
001415 5415 FDE1            14      POP IY
001417 5417 DDE1            14      POP IX
       5419                     GETL3:
001419 5419 2B               6      DEC HL
00141A 541A 7E               7      LD  A,(HL)
00141B 541B FE21             7      CP  021H
00141D 541D D0              11      RET NC
00141E 541E 3600            10      LD  (HL),0
001420 5420 15               4      DEC D
001421 5421 20F6            12      JR  NZ,GETL3
001423 5423 C9              10      RET
                                
       5424                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       5424                     CONSTX:
       5424                     CPM_CONST:
001424 5424 C5              11      PUSH    BC
001425 5425 D5              11      PUSH    DE
001426 5426 E5              11      PUSH    HL
001427 5427 DDE5            15      PUSH    IX
001429 5429 DD219C00        14      LD  IX,CHSNS
00142D 542D CDD642          17      CALL    CALSLT_R
001430 5430 DDE1            14      POP IX
001432 5432 E1              10      POP HL
001433 5433 D1              10      POP DE
001434 5434 C1              10      POP BC
001435 5435 C9              10      RET
                                
       5436                     _SYS2A:     ;(BDOS)日付の獲得
001436 5436 AF               4      XOR A
001437 5437 57               4      LD  D,A
001438 5438 5F               4      LD  E,A
001439 5439 67               4      LD  H,A
00143A 543A 6F               4      LD  L,A
00143B 543B C9              10      RET
                                
       543C                     _SYS2C:     ;(BDOS)時刻の獲得
00143C 543C AF               4      XOR A
00143D 543D 57               4      LD  D,A
00143E 543E 5F               4      LD  E,A
00143F 543F 67               4      LD  H,A
001440 5440 6F               4      LD  L,A
001441 5441 C9              10      RET
                                
       5442                     POS:
001442 5442 F5              11      PUSH    AF
001443 5443 2ADCF3          16      LD  HL,(CSRY)
001446 5446 7D               4      LD  A,L
001447 5447 6C               4      LD  L,H
001448 5448 67               4      LD  H,A
001449 5449 2C               4      INC L
00144A 544A 24               4      INC H
00144B 544B F1              10      POP AF
00144C 544C C9              10      RET
                                
       544D                     LOC:
00144D 544D F5              11      PUSH    AF
00144E 544E E5              11      PUSH    HL
00144F 544F 7D               4      LD  A,L
001450 5450 6C               4      LD  L,H
001451 5451 67               4      LD  H,A
001452 5452 2D               4      DEC L
001453 5453 25               4      DEC H
001454 5454 DDE5            15      PUSH    IX
001456 5456 DD21C600        14      LD  IX,POSIT
00145A 545A CDD642          17      CALL    CALSLT_R
00145D 545D DDE1            14      POP IX
00145F 545F E1              10      POP HL
001460 5460 F1              10      POP AF
001461 5461 C9              10      RET
                                
       5462                     _SCRN:
       5462                     SCRN:
001462 5462 E5              11      PUSH    HL
001463 5463 DDE5            15      PUSH    IX
                                
001465 5465 69               4      LD  L,C
001466 5466 60               4      LD  H,B
001467 5467 DD214A00        14      LD  IX,RDVRM
00146B 546B CDD642          17      CALL    CALSLT_R
                                
00146E 546E DDE1            14      POP IX
001470 5470 E1              10      POP HL
001471 5471 C9              10      RET
                                
       5472                     CTRL02:
001472 5472 F5              11      PUSH    AF
001473 5473 D5              11      PUSH    DE
001474 5474 2ADCF3          16      LD  HL,(CSRY)
001477 5477 3AB0F3          13      LD  A,(LINLEN)
00147A 547A 4F               4      LD  C,A
00147B 547B 94               4      SUB H   ;CSRX
00147C 547C C602             7      ADD A,2
00147E 547E 47               4      LD  B,A ;カーソルより右の文字数
00147F 547F 61               4      LD  H,C ;LINLEN
001480 5480 C5              11      PUSH    BC
001481 5481 CDCF54          17      CALL    LOC0
001484 5484 C1              10      POP BC
                                
001485 5485 1620             7      LD  D,020H
       5487                     C8X1:
001487 5487 DD214A00        14      LD  IX,RDVRM
00148B 548B CDD642          17      CALL    CALSLT_R
00148E 548E 4F               4      LD  C,A
00148F 548F 7A               4      LD  A,D
001490 5490 DD214D00        14      LD  IX,WRTVRM
001494 5494 CDD642          17      CALL    CALSLT_R
001497 5497 2B               6      DEC HL
001498 5498 51               4      LD  D,C
001499 5499 10EC            13      DJNZ    C8X1
00149B 549B D1              10      POP DE
00149C 549C F1              10      POP AF
00149D 549D C9              10      RET
                                
       549E                     INSERT:
00149E 549E F5              11      PUSH    AF
00149F 549F D5              11      PUSH    DE
0014A0 54A0 2ADCF3          16      LD  HL,(CSRY)
0014A3 54A3 3AB0F3          13      LD  A,(LINLEN)
0014A6 54A6 4F               4      LD  C,A
0014A7 54A7 94               4      SUB H   ;CSRX
0014A8 54A8 3C               4      INC A
0014A9 54A9 47               4      LD  B,A ;カーソルより右の文字数
0014AA 54AA C5              11      PUSH    BC
0014AB 54AB CDCF54          17      CALL    LOC0
0014AE 54AE C1              10      POP BC
                                
0014AF 54AF 1620             7      LD  D,020H
       54B1                     INS1:
0014B1 54B1 DD214A00        14      LD  IX,RDVRM
0014B5 54B5 CDD642          17      CALL    CALSLT_R
0014B8 54B8 4F               4      LD  C,A
0014B9 54B9 7A               4      LD  A,D
0014BA 54BA DD214D00        14      LD  IX,WRTVRM
0014BE 54BE CDD642          17      CALL    CALSLT_R
0014C1 54C1 23               6      INC HL
0014C2 54C2 51               4      LD  D,C
0014C3 54C3 10EC            13      DJNZ    INS1
0014C5 54C5 D1              10      POP DE
0014C6 54C6 F1              10      POP AF
0014C7 54C7 C9              10      RET
                                
       54C8                     CONOUT1:
0014C8 54C8 59               4      LD  E,C
0014C9 54C9 C3FC52          10      JP  _PRINT
                                
       54CC                     GETVRAM:
0014CC 54CC 2ADCF3          16      LD  HL,(CSRY)
       54CF                     LOC0:
0014CF 54CF 2D               4      DEC L
0014D0 54D0 25               4      DEC H
0014D1 54D1 4C               4      LD  C,H ;CSRX-1
0014D2 54D2 5D               4      LD  E,L ;CSRY-1
       54D3                     LOC1:
0014D3 54D3 3AB0F3          13      LD  A,(LINLEN)
0014D6 54D6 67               4      LD  H,A
0014D7 54D7 1600             7      LD  D,0
0014D9 54D9 6A               4      LD  L,D ;0
0014DA 54DA 0608             7      LD  B,8
       54DC                     LOC2:
0014DC 54DC 29              11      ADD HL,HL
0014DD 54DD 3001            12      JR  NC,LOC3
0014DF 54DF 19              11      ADD HL,DE
       54E0                     LOC3:
0014E0 54E0 10FA            13      DJNZ    LOC2
0014E2 54E2 09              11      ADD HL,BC
0014E3 54E3 C9              10      RET
                                
       54E4                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0014E4 54E4 212200          10      LD  HL,00022H
0014E7 54E7 AF               4      XOR A
0014E8 54E8 7D               4      LD  A,L
0014E9 54E9 C9              10      RET
                                
       54EA                     _SYS0D:     ;(BDOS)ディスク・リセット
0014EA 54EA 218000          10      LD  HL,00080H
0014ED 54ED 22C7F2          16      LD  (_DTA),HL
0014F0 54F0 C9              10      RET
                                
       54F1                     _SYS0E:     ;(BDOS)カレントドライブの設定
0014F1 54F1 7B               4      LD  A,E
       54F2                     _SYS0EX1:
0014F2 54F2 FE08             7      CP  8
0014F4 54F4 3F               4      CCF
0014F5 54F5 D8              11      RET C
0014F6 54F6 32DDF2          13      LD  (_DVSW),A
0014F9 54F9 C9              10      RET
                                
       54FA                     _SYS0F:     ;(BDOS)ファイルのオープン
0014FA 54FA D5              11      PUSH    DE
0014FB 54FB FDE1            14      POP IY
0014FD 54FD CD6856          17      CALL    INIT_FILE
001500 5500 CD5B4C          17      CALL    ROM_OPEN
001503 5503 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
001505 5505 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
001509 5509 FDE5            15      PUSH    IY
00150B 550B D1              10      POP DE
00150C 550C 13               6      INC DE
00150D 550D 010B00          10      LD  BC,11
001510 5510 EDB0                    LDIR
                                ;               Attribute
001512 5512 7E               7      LD  A,(HL)
001513 5513 FD770D          19      LD  (IY+13),A
                                ;               TIME
001516 5516 110B00          10      LD  DE,11
001519 5519 19              11      ADD HL,DE
00151A 551A 7E               7      LD  A,(HL)
00151B 551B 23               6      INC HL
00151C 551C FD7716          19      LD  (IY+22),A
00151F 551F 7E               7      LD  A,(HL)
001520 5520 23               6      INC HL
001521 5521 FD7717          19      LD  (IY+23),A
                                ;               DATE
001524 5524 7E               7      LD  A,(HL)
001525 5525 23               6      INC HL
001526 5526 FD7714          19      LD  (IY+20),A
001529 5529 7E               7      LD  A,(HL)
00152A 552A 23               6      INC HL
00152B 552B FD7715          19      LD  (IY+21),A
                                ;               First cluster
00152E 552E 7E               7      LD  A,(HL)
00152F 552F 23               6      INC HL
001530 5530 FD771A          19      LD  (IY+26),A
001533 5533 7E               7      LD  A,(HL)
001534 5534 23               6      INC HL
001535 5535 FD771B          19      LD  (IY+27),A
                                ;               SIZE
001538 5538 7E               7      LD  A,(HL)
001539 5539 23               6      INC HL
00153A 553A FD7710          19      LD  (IY+16),A
00153D 553D 7E               7      LD  A,(HL)
00153E 553E 23               6      INC HL
00153F 553F FD7711          19      LD  (IY+17),A
001542 5542 7E               7      LD  A,(HL)
001543 5543 23               6      INC HL
001544 5544 FD7712          19      LD  (IY+18),A
001547 5547 7E               7      LD  A,(HL)
001548 5548 FD7713          19      LD  (IY+19),A
00154B 554B AF               4      XOR A
00154C 554C FD770C          19      LD  (IY+12),A
00154F 554F C9              10      RET
                                
       5550                     _SYS10:     ;(BDOS)ファイルのクローズ
001550 5550 AF               4      XOR A
001551 5551 C9              10      RET
                                
       5552                     S11X1:
001552 5552 FD7119          19      LD  (IY+25),C       ;RootEntCnt
001555 5555 FD750E          19      LD  (IY+14),L
001558 5558 FD740F          19      LD  (IY+15),H
       555B                     SCF_FF_RET:
00155B 555B 37               4      SCF
00155C 555C 9F               4      SBC A,A
00155D 555D C9              10      RET
                                
       555E                     _SYS11:     ;(BDOS)最初のファイルの検索
00155E 555E ED53CAF2        20      LD  (_FCB),DE
001562 5562 D5              11      PUSH    DE
001563 5563 FDE1            14      POP IY
001565 5565 CD6856          17      CALL    INIT_FILE
001568 5568 CDB74E          17      CALL    GET_DIR_DAT
       556B                     S12X1:
00156B 556B CD774C          17      CALL    FILESE
00156E 556E 30E2            12      JR  NC,S11X1
001570 5570 0D               4      DEC C
001571 5571 FD7119          19      LD  (IY+25),C       ;RootEntCnt
001574 5574 FDCB0D66        20      BIT 4,(IY+13)
001578 5578 2809            12      JR  Z,S12X2
00157A 557A E5              11      PUSH    HL
00157B 557B DDE1            14      POP IX
00157D 557D DDCB0E66        20      BIT 4,(IX+1+13)
001581 5581 28E8            12      JR  Z,S12X1
       5583                     S12X2:
001583 5583 012000          10      LD  BC,32
001586 5586 ED5BC7F2        20      LD  DE,(_DTA)
00158A 558A AF               4      XOR A
00158B 558B 12               7      LD  (DE),A      ;ドライブ番号
00158C 558C 13               6      INC DE
00158D 558D EDB0                    LDIR            ;ディレクトリエントリ
00158F 558F FD750E          19      LD  (IY+14),L
001592 5592 FD740F          19      LD  (IY+15),H
001595 5595 C9              10      RET
                                
       5596                     _SYS12:
001596 5596 FD2ACAF2        20      LD  IY,(_FCB)
00159A 559A FDE5            15      PUSH    IY
00159C 559C D1              10      POP DE
00159D 559D CD6856          17      CALL    INIT_FILE
                                
0015A0 55A0 FD6E0E          19      LD  L,(IY+14)
0015A3 55A3 FD660F          19      LD  H,(IY+15)
0015A6 55A6 FD4E19          19      LD  C,(IY+25)
0015A9 55A9 18C0            12      JR  S12X1
                                
       55AB                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0015AB 55AB CD9D4E          17      CALL    SET_FCB
0015AE 55AE CD6B4E          17      CALL    GETSEQ
0015B1 55B1 CD584E          17      CALL    RB_READ
0015B4 55B4 E5              11      PUSH    HL
0015B5 55B5 CD784E          17      CALL    SETSEQ
0015B8 55B8 E1              10      POP HL
       55B9                     SREAD:
0015B9 55B9 C601             7      ADD A,001H
0015BB 55BB D8              11      RET C
                                
0015BC 55BC 7D               4      LD  A,L
0015BD 55BD D601             7      SUB 001H
0015BF 55BF 9F               4      SBC A,A
0015C0 55C0 E603             7      AND 3
0015C2 55C2 1F               4      RRA
0015C3 55C3 C9              10      RET
                                
       55C4                     _SYS18:     ;(BDOS)ログインベクトルの獲得
0015C4 55C4 210100          10      LD  HL,00001H
0015C7 55C7 AF               4      XOR A
0015C8 55C8 C9              10      RET
                                
       55C9                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
0015C9 55C9 3ADDF2          13      LD  A,(_DVSW)
0015CC 55CC C9              10      RET
                                
       55CD                     _SYS1A:     ;(BDOS)DTAの設定
0015CD 55CD ED53C7F2        20      LD  (_DTA),DE
0015D1 55D1 AF               4      XOR A
0015D2 55D2 C9              10      RET
                                
       55D3                     _SYS1B:     ;(BDOS)ディスク情報の獲得
0015D3 55D3 010002          10      LD  BC,512
0015D6 55D6 11C302          10      LD  DE,707
0015D9 55D9 210000          10      LD  HL,0
0015DC 55DC DD21CCF2        14      LD  IX,_BUF
0015E0 55E0 FD21CCF2        14      LD  IY,_BUF
0015E4 55E4 FD3600F9        19      LD  (IY+0),0F9H
0015E8 55E8 3E02             7      LD  A,2
0015EA 55EA C9              10      RET
                                
       55EB                     _SYS21:     ;(BDOS)ランダムな読み出し
0015EB 55EB CD9D4E          17      CALL    SET_FCB
                                
0015EE 55EE FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0015F1 55F1 FD6622          19      LD  H,(IY+34)
                                
0015F4 55F4 CD584E          17      CALL    RB_READ
0015F7 55F7 18C0            12      JR  SREAD
                                
       55F9                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
0015F9 55F9 CDFA54          17      CALL    _SYS0F
0015FC 55FC D8              11      RET C
                                
0015FD 55FD D5              11      PUSH    DE      ;EX DE,IY
0015FE 55FE FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001600 5600 CD8D4E          17      CALL    GETSIZE
       5603                     _S24X1:
001603 5603 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001606 5606 FD7422          19      LD  (IY+34),H
001609 5609 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
00160D 560D FDE3            23      EX  (SP),IY     ;
00160F 560F D1              10      POP DE      ;
                                
001610 5610 AF               4      XOR A
001611 5611 C9              10      RET
                                
       5612                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
001612 5612 E5              11      PUSH    HL
001613 5613 D5              11      PUSH    DE      ;EX DE,IY
001614 5614 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001616 5616 CD6B4E          17      CALL    GETSEQ
001619 5619 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       561B                     _SYS27:     ;(BDOS)ランダムブロック読み込み
00161B 561B CD9D4E          17      CALL    SET_FCB
00161E 561E E5              11      PUSH    HL
00161F 561F FD6E21          19      LD  L,(IY+33)
001622 5622 FD6622          19      LD  H,(IY+34)
001625 5625 22BDF2          16      LD  (RR_LOW),HL
001628 5628 FD6E23          19      LD  L,(IY+35)
00162B 562B FD6624          19      LD  H,(IY+36)
00162E 562E 22BFF2          16      LD  (RR_HIGH),HL
001631 5631 E1              10      POP HL
001632 5632 CD284A          17      CALL    ROM_READ
001635 5635 ED5BBDF2        20      LD  DE,(RR_LOW)
001639 5639 FD7321          19      LD  (IY+33),E
00163C 563C FD7222          19      LD  (IY+34),D
00163F 563F ED5BBFF2        20      LD  DE,(RR_HIGH)
001643 5643 FD7323          19      LD  (IY+35),E
001646 5646 FD7224          19      LD  (IY+36),D
001649 5649 9F               4      SBC A,A
00164A 564A C9              10      RET
                                
       564B                     _SYS2F:
00164B 564B 44               4      LD  B,H
00164C 564C 2AC7F2          16      LD  HL,(_DTA)
00164F 564F C3B950          10      JP  DISKIO
                                
       5652                     _SYS5A:
001652 5652 0600             7      LD  B,0
001654 5654 D5              11      PUSH    DE
001655 5655 DDE1            14      POP IX
       5657                     _SX5A1:
001657 5657 1A               7      LD  A,(DE)
001658 5658 B7               4      OR  A
001659 5659 2804            12      JR  Z,_SX5A2
00165B 565B 13               6      INC DE
00165C 565C 04               4      INC B
00165D 565D 18F8            12      JR  _SX5A1
                                
       565F                     _SX5A2:
00165F 565F 78               4      LD  A,B
001660 5660 CDF34A          17      CALL    FILE_BDOS
001663 5663 CD574F          17      CALL    ROM_CD
001666 5666 9F               4      SBC A,A
001667 5667 C9              10      RET
                                
       5668                     INIT_FILE:
001668 5668 EB               4      EX  DE,HL
001669 5669 11EBF2          10      LD  DE,FDRV
00166C 566C 010C00          10      LD  BC,1+8+3
       566F                     INIT_FILE1:
00166F 566F EDB0                    LDIR
001671 5671 CD8C52          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_MORMAL32K_OR_ASCII16
001674 5674 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
001677 5677 2ADEF2          16      LD  HL,(_CD)
00167A 567A 22E9F2          16      LD  (_CDX),HL           ;カレントディレクトリ
00167D 567D C9              10      RET
                                
       567E                     ZERO_MEMORY_DE:
00167E 567E AF               4      XOR A
       567F                     FILL_MEMORY_DE:
00167F 567F 12               7      LD  (DE),A
001680 5680 13               6      INC DE
001681 5681 10FC            13      DJNZ    FILL_MEMORY_DE
001683 5683 C9              10      RET
                                
001684 5684                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 E952FF523053E952        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 E952E95235537653        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 3D53E95290532454        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 E454EA54F154FA54        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 50555E559655E952        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 AB55E952E952E952        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 C455C955CD55D355        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 E952E952E952F955        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 1256E952E9521B56        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 E952E9523654E952        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 3C54E952E9524B56        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 E952E9525256E952        DW  _ERROR,_ERROR,_SYS5A,_ERROR
001FB8 5FB8 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 E952E952E952E952        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
[EOF:DISKROM32.ASM:UTF_8]
