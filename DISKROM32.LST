                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
       0001                     USE_MORMAL32K_OR_ASCII16        EQU 1   ;ノーマル32KB/ASCII-16K ROMを作成する
                                
                                    INCLUDE "DISKROM.ASM"
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
       0159                     CALBAS  EQU 00159H
                                
       269A                     DECADD  EQU 0269AH
       27E6                     DECMUL  EQU 027E6H
       2F8A                     FRCINT  EQU 02F8AH
                                
       303A                     FRCDBL  EQU 0303AH
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
       7D17                     ST_BAS  EQU 07D17H
                                
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F847                     ARG EQU 0F847H
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCC9                     SLTATR  EQU 0FCC9H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
       FD99                     DEVICE  EQU 0FD99H
                                
       FDDB                     H_PINL  EQU 0FDDBH
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                            ;ASCII-16K
       6000                     ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
       7000                     ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
                                BANK0_SEL EQU   06000H  ;6000-67FF
                                BANK1_SEL EQU   06800H  ;6800-6FFF
                                BANK2_SEL EQU   07000H  ;7000-77FF
                                BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
                                KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
                                KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
                                KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
                                KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
                                KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
                                KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
                                KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
       F280                     ISC EQU 0F280H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F280                     SP32    EQU 0F280H
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM    ; Main program execution address.
000004 4004 354F                    DW  STATEMENT   ; STATEMENT
000006 4006 6550                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C3BD51          10      JP  DISKIO
000013 4013 C30352          10      JP  DSKCHG
000016 4016 C35952          10      JP  GETDPB
000019 4019 C34C53          10      JP  CHOICE
00001C 401C C35053          10      JP  DSKFMT
00001F 401F C35253          10      JP  DSKSTP
000022 4022 C35353          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C35053          10      JP  DSKFMT
000029 4029 C35253          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C38C53          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.5.0.0",0
            204449534B20524F    
            4D204C6974652076    
            302E352E302E3000    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 AF               4      XOR A
000107 4107 2100F3          10      LD  HL,0F300H
00010A 410A 0668             7      LD  B,068H
00010C 410C CDEE4B          17      CALL    FILL_MEMORY
                                
00010F 410F 3E01             7      LD  A,1
000111 4111 3221FB          13      LD  (DRVTBL),A
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
000114 4114 2A74F6          16      LD  HL,(STKTOP) ;起動時の空き容量表示の為
000117 4117 01C0FE          10      LD  BC,-00140H
00011A 411A 09              11      ADD HL,BC
00011B 411B 2274F6          16      LD  (STKTOP),HL
                                #else
                                    LD  HL,STKTOP+1 ;起動時の空き容量表示の為
                                    DEC (HL)
                                #endif
                                
00011E 411E AF               4      XOR A
00011F 411F 32EAF2          13      LD  (_DVSW),A
000122 4122 3D               4      DEC A       ;0FFH
000123 4123 3299FD          13      LD  (DEVICE),A
                                
000126 4126 210843          10      LD  HL,AT_ISC
000129 4129 1180F2          10      LD  DE,ISC
00012C 412C 018800          10      LD  BC,ISC_E-ISC
00012F 412F EDB0                    LDIR
                                    
000131 4131 3EC3             7      LD  A,0C3H      ;JP
000133 4133 3243FF          13      LD  (H_GONE),A
000136 4136 327DF3          13      LD  (BDOS),A
000139 4139 326BF3          13      LD  (RAMUSE),A
00013C 413C 3268F3          13      LD  (ROMUSE),A
00013F 413F 2180F2          10      LD  HL,REPLACE_COMMAND
000142 4142 2244FF          16      LD  (H_GONE+1),HL
000145 4145 2131F3          10      LD  HL,H_BDOS
000148 4148 227EF3          16      LD  (BDOS+1),HL
00014B 414B 21ABF2          10      LD  HL,RAMUSE1
00014E 414E 226CF3          16      LD  (RAMUSE+1),HL
000151 4151 21BEF2          10      LD  HL,ROMUSE1
000154 4154 2269F3          16      LD  (ROMUSE+1),HL
                                
000157 4157 3E                      DB  03EH
000158 4158 F7              12      RST 30H
000159 4159 3271FE          13      LD  (H_BINS),A
00015C 415C 3276FE          13      LD  (H_BINL),A
00015F 415F 327BFE          13      LD  (H_FILE),A
000162 4162 3231F3          13      LD  (H_BDOS),A
000165 4165 32DBFD          13      LD  (H_PINL),A
000168 4168 32A7FF          13      LD  (H_PHYD),A
                                
00016B 416B CD5442          17      CALL    GTSL1_
00016E 416E 3297F2          13      LD  (ROM_SLT),A
000171 4171 32A7F2          13      LD  (ROM_SLT_COPY),A
000174 4174 3272FE          13      LD  (H_BINS+1),A
000177 4177 3277FE          13      LD  (H_BINL+1),A
00017A 417A 327CFE          13      LD  (H_FILE+1),A
00017D 417D 3232F3          13      LD  (H_BDOS+1),A
000180 4180 32DCFD          13      LD  (H_PINL+1),A
000183 4183 32A8FF          13      LD  (H_PHYD+1),A
000186 4186 3222FB          13      LD  (DRVTBL+1),A
000189 4189 3248F3          13      LD  (MASTERS),A
                                
00018C 418C 21DA45          10      LD  HL,ROM_LOAD
00018F 418F 2273FE          16      LD  (H_BINS+2),HL
000192 4192 218B47          10      LD  HL,ROM_RUN
000195 4195 2278FE          16      LD  (H_BINL+2),HL
000198 4198 219947          10      LD  HL,ROM_FILES
00019B 419B 227DFE          16      LD  (H_FILE+2),HL
00019E 419E 21F153          10      LD  HL,ROM_BDOS
0001A1 41A1 2233F3          16      LD  (H_BDOS+2),HL
0001A4 41A4 21CD43          10      LD  HL,ROM_BOOT
0001A7 41A7 22DDFD          16      LD  (H_PINL+2),HL
0001AA 41AA 21BD51          10      LD  HL,DISKIO
0001AD 41AD 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001B0 41B0 3E                      DB  03EH
0001B1 41B1 C9              10      RET
0001B2 41B2 327FFE          13      LD  (H_FILE+4),A
0001B5 41B5 3275FE          13      LD  (H_BINS+4),A
0001B8 41B8 327AFE          13      LD  (H_BINL+4),A
0001BB 41BB 3235F3          13      LD  (H_BDOS+4),A
0001BE 41BE 32DFFD          13      LD  (H_PINL+4),A
0001C1 41C1 32ABFF          13      LD  (H_PHYD+4),A
                                
0001C4 41C4 AF               4      XOR A
                                #if exists USE_MORMAL32K_OR_ASCII16
0001C5 41C5 320060          13      LD  (ASCII16_BANK0_SEL),A       ;似非RAM対策でバンク0を設定
0001C8 41C8 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK0_SEL),A           ;似非RAM対策でバンク0を設定
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001CB 41CB 3A0060          13      LD  A,(BANK1_ADR)
0001CE 41CE FE41             7      CP  'A'
                                #if exists USE_MORMAL32K_OR_ASCII16
0001D0 41D0 2871            12      JR  Z,NOT_BANK_TYPE
0001D2 41D2 3E01             7      LD  A,DISK_BANK
0001D4 41D4 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    JR  NZ,NOT_BANK_TYPE
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001D7 41D7 CD3801          17      CALL    RSLREG      ;read primary slot #
0001DA 41DA 07               4      RLCA
0001DB 41DB 07               4      RLCA
0001DC 41DC F5              11      PUSH    AF
0001DD 41DD 1605             7      LD  D,4+1
0001DF 41DF CD5B42          17      CALL    GTSL2_
0001E2 41E2 3244F3          13      LD  (RAMAD3),A
0001E5 41E5 F1              10      POP AF
0001E6 41E6 07               4      RLCA
0001E7 41E7 07               4      RLCA
0001E8 41E8 1603             7      LD  D,2+1
0001EA 41EA CD5B42          17      CALL    GTSL2_
0001ED 41ED 2680             7      LD  H,080H
0001EF 41EF CD7842          17      CALL    CHK_RAM
0001F2 41F2 3243F3          13      LD  (RAMAD2),A
       41F5                     RAMCHK2:
0001F5 41F5 3A44F3          13      LD  A,(RAMAD3)
0001F8 41F8 2640             7      LD  H,040H
0001FA 41FA CD7842          17      CALL    CHK_RAM
0001FD 41FD 3242F3          13      LD  (RAMAD1),A
       4200                     RAMCHK1:
000200 4200 3A44F3          13      LD  A,(RAMAD3)
000203 4203 2600             7      LD  H,00H
000205 4205 CD7842          17      CALL    CHK_RAM
000208 4208 3241F3          13      LD  (RAMAD0),A
       420B                     RAMCHK0:
00020B 420B 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
00020E 420E 010F00          10      LD  BC,0000FH       ;切り上げ
000211 4211 09              11      ADD HL,BC
000212 4212 7D               4      LD  A,L
                                
000213 4213 0604             7      LD  B,4
       4215                     B_DRIVE1:
000215 4215 CB3C             8      SRL H
000217 4217 1F               4      RRA
000218 4218 10FB            13      DJNZ    B_DRIVE1
                                
00021A 421A C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
00021C 421C 32E9F2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
                                    ;拡張スロットの選択を設定する
00021F 421F 3A97F2          13      LD  A,(ROM_SLT)
000222 4222 57               4      LD  D,A
000223 4223 E60C             7      AND 00CH
000225 4225 5F               4      LD  E,A
000226 4226 7A               4      LD  A,D
000227 4227 E603             7      AND 3
000229 4229 87               4      ADD A,A
00022A 422A 87               4      ADD A,A
00022B 422B 87               4      ADD A,A
00022C 422C 37               4      SCF
00022D 422D 8F               4      ADC A,A
00022E 422E B3               4      OR  E
00022F 422F 5F               4      LD  E,A
000230 4230 1600             7      LD  D,0
000232 4232 21C9FC          10      LD  HL,SLTATR
000235 4235 19              11      ADD HL,DE
000236 4236 3660            10      LD  (HL),060H
000238 4238 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00023C 423C DD21177D        14      LD  IX,ST_BAS   ;continue start of MSX-BASIC without executing BASIC programs in ROM
000240 4240 C35901          10      JP  CALBAS
                                
       4243                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
000243 4243 211044          10      LD  HL,MSG_ERROR_ROM_MODE
000246 4246 CD9343          17      CALL    MSX
000249 4249 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00024D 424D DD219F00        14      LD  IX,CHGET
000251 4251 C31C00          10      JP  _CALSLT
                                
       4254                     GTSL1_:             ;自分のいるスロットを知る
000254 4254 CD3801          17      CALL    RSLREG      ;read primary slot #
000257 4257 0F               4      RRCA
000258 4258 0F               4      RRCA
000259 4259 1601             7      LD  D,1
       425B                     GTSL2_:
00025B 425B E603             7      AND 3       ;[A]=000000PP
00025D 425D 5F               4      LD  E,A     ;[E]=000000PP
00025E 425E 21C1FC          10      LD  HL,EXPTBL
000261 4261 85               4      ADD A,L     ;桁上りは無い
000262 4262 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000263 4263 7B               4      LD  A,E     ;[A]=000000PP
000264 4264 CB7E            13      BIT 7,(HL)
000266 4266 C8              11      RET Z
000267 4267 7D               4      LD  A,L     ;point to SLTTBL entry
000268 4268 C604             7      ADD A,4     ;桁上りは無い
00026A 426A 6F               4      LD  L,A
00026B 426B 7E               7      LD  A,(HL)      ;get currently expansion slot register
       426C                     GTSL3_:
00026C 426C 15               4      DEC D
00026D 426D 2803            12      JR  Z,GTSL4_:
00026F 426F 0F               4      RRCA
000270 4270 18FA            12      JR  GTSL3_:
       4272                     GTSL4_:
000272 4272 E60C             7      AND 00CH        ;[A] = 0000SS00
000274 4274 B3               4      OR  E       ;[A] = 0000SSPP
000275 4275 F680             7      OR  080H        ;[A] = 1000SSPP
000277 4277 C9              10      RET
                                
       4278                     CHK_RAM:
000278 4278 E5              11      PUSH    HL
000279 4279 CDCD42          17      CALL    CHK_RAM0
00027C 427C E1              10      POP HL
00027D 427D C8              11      RET Z
00027E 427E 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000281 4281 E680             7      AND 080H
000283 4283 CDA442          17      CALL    CHK_RAM_SLT
000286 4286 C8              11      RET Z
000287 4287 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
00028A 428A E680             7      AND 080H
00028C 428C C601             7      ADD A,1
00028E 428E CDA442          17      CALL    CHK_RAM_SLT
000291 4291 C8              11      RET Z
000292 4292 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000295 4295 E680             7      AND 080H
000297 4297 C602             7      ADD A,2
000299 4299 CDA442          17      CALL    CHK_RAM_SLT
00029C 429C C8              11      RET Z
00029D 429D 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
0002A0 42A0 E680             7      AND 080H
0002A2 42A2 C603             7      ADD A,3
       42A4                     CHK_RAM_SLT:
0002A4 42A4 E5              11      PUSH    HL
0002A5 42A5 CDCD42          17      CALL    CHK_RAM0        ;スロット#X or X-0
0002A8 42A8 E1              10      POP HL
0002A9 42A9 C8              11      RET Z
0002AA 42AA CB79             8      BIT 7,C
0002AC 42AC 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
0002AE 42AE 79               4      LD  A,C
0002AF 42AF C604             7      ADD A,4*1           ;スロット#X-1
0002B1 42B1 E5              11      PUSH    HL
0002B2 42B2 CDCD42          17      CALL    CHK_RAM0
0002B5 42B5 E1              10      POP HL
0002B6 42B6 C8              11      RET Z
0002B7 42B7 79               4      LD  A,C
0002B8 42B8 C608             7      ADD A,4*2           ;スロット#X-2
0002BA 42BA E5              11      PUSH    HL
0002BB 42BB CDCD42          17      CALL    CHK_RAM0
0002BE 42BE E1              10      POP HL
0002BF 42BF C8              11      RET Z
0002C0 42C0 79               4      LD  A,C
0002C1 42C1 C60C             7      ADD A,4*3           ;スロット#X-3
0002C3 42C3 E5              11      PUSH    HL
0002C4 42C4 CDCD42          17      CALL    CHK_RAM0
0002C7 42C7 E1              10      POP HL
       42C8                     CHK_RAM_E:
0002C8 42C8 AF               4      XOR A
0002C9 42C9 3C               4      INC A           ;ZF=0にする
0002CA 42CA 3E00             7      LD  A,0
0002CC 42CC C9              10      RET
                                
       42CD                     CHK_RAM0:
0002CD 42CD 4F               4      LD  C,A
0002CE 42CE 3A97F2          13      LD  A,(ROM_SLT)
0002D1 42D1 B9               4      CP  C
0002D2 42D2 28F4            12      JR  Z,CHK_RAM_E
0002D4 42D4 2E00             7      LD  L,0
       42D6                     CHK_RAM1:
0002D6 42D6 79               4      LD  A,C
0002D7 42D7 CDC543          17      CALL    RDSLTX
0002DA 42DA C6E5             7      ADD A,0E5H
0002DC 42DC 47               4      LD  B,A
0002DD 42DD 5F               4      LD  E,A
0002DE 42DE 79               4      LD  A,C
0002DF 42DF C5              11      PUSH    BC
0002E0 42E0 CD1400          17      CALL    _WRSLT
0002E3 42E3 C1              10      POP BC
0002E4 42E4 79               4      LD  A,C
0002E5 42E5 CDC543          17      CALL    RDSLTX
0002E8 42E8 B8               4      CP  B
0002E9 42E9 C0              11      RET NZ
0002EA 42EA D6E5             7      SUB 0E5H
0002EC 42EC 79               4      LD  A,C
0002ED 42ED 5F               4      LD  E,A
0002EE 42EE C5              11      PUSH    BC
0002EF 42EF CD1400          17      CALL    _WRSLT
0002F2 42F2 C1              10      POP BC
0002F3 42F3 24               4      INC H
0002F4 42F4 7D               4      LD  A,L
0002F5 42F5 C604             7      ADD A,4
0002F7 42F7 6F               4      LD  L,A
0002F8 42F8 20DC            12      JR  NZ,CHK_RAM1
0002FA 42FA 79               4      LD  A,C     ;ZF=1のハズ
0002FB 42FB C9              10      RET
                                
       42FC                     CALSLT_R:
0002FC 42FC C5              11      PUSH    BC
0002FD 42FD E5              11      PUSH    HL
0002FE 42FE FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000302 4302 CD1C00          17      CALL    _CALSLT
000305 4305 E1              10      POP HL
000306 4306 C1              10      POP BC
000307 4307 C9              10      RET
                                
       4308                     AT_ISC:
000308 F280                         ORG ISC,AT_ISC-RUN
       F280                     REPLACE_COMMAND:
000308 F280 FEB7             7      CP  0B7H            ;FILES
00030A F282 CC7BFE          17      CALL    Z,H_FILE
00030D F285 FEB5             7      CP  0B5H            ;LOAD
00030F F287 CA71FE          10      JP  Z,H_BINS
000312 F28A FE8A             7      CP  08AH            ;RUN
000314 F28C CA76FE          10      JP  Z,H_BINL
000317 F28F FED6             7      CP  0D6H            ;COPY
000319 F291 2813            12      JR  Z,FIX_COPY
00031B F293 FECF             7      CP  0CFH            ;BLOAD
00031D F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
00031E F296 F7              12      RST 30H
       F297                     ROM_SLT:
00031F F297 00                      DB  0
000320 F298 BC46                    DW  ROM_BLOAD
000322 F29A F5              11      PUSH    AF
000323 F29B E5              11      PUSH    HL
000324 F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
000327 F29F E1              10      POP HL
000328 F2A0 F1              10      POP AF
000329 F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
00032B F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
00032D F2A5 C9              10      RET
       F2A6                     FIX_COPY:
00032E F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
00032F F2A7 00                      DB  0
000330 F2A8 3B48                    DW  ROM_COPY
000332 F2AA C9              10      RET
       F2AB                     RAMUSE1:
000333 F2AB 3A42F3          13      LD  A,(RAMAD1)
       F2AE                     ROMUSE2:
000336 F2AE C32400          10      JP  _ENASLT
       F2B1                     CAL_MP:
000339 F2B1 2640             7      LD  H,040H
00033B F2B3 3AC1FC          13      LD  A,(EXPTBL)
00033E F2B6 CD2400          17      CALL    _ENASLT
000341 F2B9 CD1C00          17      CALL    _CALSLT
000344 F2BC 2640             7      LD  H,040H
       F2BE                     ROMUSE1:
000346 F2BE 3A97F2          13      LD  A,(ROM_SLT)
000349 F2C1 18EB            12      JR  ROMUSE2
                                
       F2C3                     _RESULT:
00034B F2C3 00                      DB  0
       F2C4                     _BANK:
00034C F2C4 00                      DB  0
       F2C5                     _BANK1:
00034D F2C5 00                      DB  0
       F2C6                     CLSZ:               ;クラスタサイズ
00034E F2C6 0004                    DW  1024
       F2C7                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2C8                     SECSZ:              ;セクタサイズ
000350 F2C8 0002                    DW  512
       F2C9                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2CA                     RR_LOW:
000352 F2CA 0000                    DW  0
       F2CB                     RR_MID  EQU $-1
       F2CC                     RR_HIGH:
000354 F2CC 0000                    DW  0
       F2CE                     _CLPS:
000356 F2CE 0000                    DW  0
       F2D0                     _LEFT:
000358 F2D0 0000                    DW  0
       F2D2                     _DTPS:
00035A F2D2 0000                    DW  0
       F2D4                     _DTA:
00035C F2D4 0000                    DW  0
       F2D6                     FLG_LDIR:
00035E F2D6 00                      DB  0
       F2D7                     _FCB:
00035F F2D7 0000                    DW  0
       F2D9                     _BUF:
       F2D9                     _BUF_LO:        ;LOGICAL OPERATION
000361 F2D9 00                      DB  0
       F2DA                     _BUF_ST:
000362 F2DA 0000                    DW  0
       F2DC                     _BUF_EN:
000364 F2DC 0000                    DW  0
       F2DE                     _BUF_EX:
       F2DE                     _BUF_W:
000366 F2DE 0000                    DW  0
       F2E0                     _BUF_H:
000368 F2E0 0000                    DW  0
       F2E2                     _BUF_X:
00036A F2E2 0000                    DW  0
       F2E4                     _BUF_Y:
00036C F2E4 00                      DB  0
       F2E5                     _BUF_P:
00036D F2E5 00                      DB  0
       F2E6                     _BUF_O:
00036E F2E6 00                      DB  0
       F2E7                     DTAX:
00036F F2E7 0000                    DW  0
       F2E9                     B_DRIVE:
000371 F2E9 00                      DB  0
       F2EA                     _DVSW:          ;カレントドライブ
000372 F2EA 00                      DB  0
       F2EB                     _CD:            ;カレントディレクトリ
000373 F2EB 0000                    DW  0
       F2ED                     DIRENT1:
000375 F2ED 0000                    DW  0
       F2EF                     _DIR_BANK:
000377 F2EF 00                      DB  0
       F2F0                     LEFTX:
000378 F2F0 0000                    DW  0
       F2F2                     PARAM0:
00037A F2F2 0000                    DW  0
       F2F4                     PARAM1:
00037C F2F4 0000                    DW  0
       F2F6                     _CDX:
00037E F2F6 0000                    DW  0
       F2F8                     FDRV:
000380 F2F8 00                      DB  0
       F2F9                     FNAME:
000381 F2F9                         DS  8+3
       F304                     _HL:
00038C F304 0000                    DW  0
       F306                     _SP:
00038E F306 0000                    DW  0
       F307                     _SP_H   EQU $-1
       F308                     ISC_E:
000390 4390                         ORG $$+RUN          ;$DEPHASE
                                
       4390                     MSX1:
000390 4390 CD0A54          17      CALL    MSGA1
       4393                     MSX:
000393 4393 7E               7      LD  A,(HL)
000394 4394 23               6      INC HL
000395 4395 B7               4      OR  A
000396 4396 20F8            12      JR  NZ,MSX1
000398 4398 C9              10      RET
                                
       4399                     PRTHX:
000399 4399 F5              11      PUSH    AF
00039A 439A 07               4      RLCA
00039B 439B 07               4      RLCA
00039C 439C 07               4      RLCA
00039D 439D 07               4      RLCA
00039E 439E CDA243          17      CALL    PRTA2
0003A1 43A1 F1              10      POP AF
       43A2                     PRTA2:
0003A2 43A2 CDA843          17      CALL    ASC
0003A5 43A5 C30654          10      JP  MSG_A
                                    
       43A8                     ASC:
0003A8 43A8 E60F             7      AND $0F
0003AA 43AA F630             7      OR  $30
0003AC 43AC FE3A             7      CP  $3A
0003AE 43AE D8              11      RET C
0003AF 43AF C607             7      ADD A,7
0003B1 43B1 C9              10      RET
                                
       43B2                     MSN:
                                #if exists USE_MORMAL32K_OR_ASCII16
0003B2 43B2 CDBE43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
0003B5 43B5 23               6      INC HL
0003B6 43B6 CD0654          17      CALL    MSG_A
0003B9 43B9 10F7            13      DJNZ    MSN
0003BB 43BB C9              10      RET
                                
       43BC                     RDSLT_ROM3:
0003BC 43BC 7E               7      LD  A,(HL)
0003BD 43BD C9              10      RET
       43BE                     RDSLT_ROM:
0003BE 43BE CB7C             8      BIT 7,H
0003C0 43C0 28FA            12      JR  Z,RDSLT_ROM3
       43C2                     RDSLT_ROM2:
0003C2 43C2 3A97F2          13      LD  A,(ROM_SLT)
       43C5                     RDSLTX:
0003C5 43C5 C5              11      PUSH    BC
0003C6 43C6 D5              11      PUSH    DE
0003C7 43C7 CD0C00          17      CALL    _RDSLT
0003CA 43CA D1              10      POP DE
0003CB 43CB C1              10      POP BC
0003CC 43CC C9              10      RET
                                
       43CD                     ROM_BOOT:
0003CD 43CD 3E                      DB  03EH
0003CE 43CE C9              10      RET
0003CF 43CF 32DBFD          13      LD  (H_PINL),A
0003D2 43D2 3ACAFF          13      LD  A,(EXTBIO)
0003D5 43D5 FEF7             7      CP  0F7H        ;RST 30H
0003D7 43D7 280A            12      JR  Z,EXTBIO_OK
0003D9 43D9 3E                      DB  03EH
0003DA 43DA C9              10      RET
0003DB 43DB 21CAFF          10      LD  HL,EXTBIO
0003DE 43DE 061D             7      LD  B,29
0003E0 43E0 CDEE4B          17      CALL    FILL_MEMORY
       43E3                     EXTBIO_OK:
0003E3 43E3 212D44          10      LD  HL,DELOK
0003E6 43E6 CD9343          17      CALL    MSX
                                
0003E9 43E9 AF               4      XOR A
0003EA 43EA 3240F3          13      LD  (REBOOT),A
0003ED 43ED 2A48FC          16      LD  HL,(BOTTOM)
0003F0 43F0 110040          10      LD  DE,16384
0003F3 43F3 19              11      ADD HL,DE
0003F4 43F4 3817            12      JR  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
0003F6 43F6 57               4      LD  D,A
0003F7 43F7 0601             7      LD  B,1
0003F9 43F9 2100C0          10      LD  HL,0C000H
0003FC 43FC CDBD51          17      CALL    DISKIO
                                
0003FF 43FF 116BF3          10      LD  DE,RAMUSE
000402 4402 AF               4      XOR A
000403 4403 CD1EC0          17      CALL    0C01EH
000406 4406 116BF3          10      LD  DE,RAMUSE
000409 4409 37               4      SCF
00040A 440A CD1EC0          17      CALL    0C01EH
       440D                     BOOT1:
00040D 440D C35353          10      JP  BASENT
                                
       4410                     MSG_ERROR_ROM_MODE:
                                #if exists USE_MORMAL32K_OR_ASCII16
000410 4410 4E6F726D616C2052        DB  "Normal ROM/ASCII-16K only!",13,10
            4F4D2F4153434949    
            2D31364B206F6E6C    
            79210D0A            
                                #else
                                    DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
                                #endif
       442C                     NULL:
00042C 442C 00                      DB  0
       442D                     DELOK:
00042D 442D 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       4431                     ROM_LDIR:
000431 4431 3AD6F2          13      LD  A,(FLG_LDIR)
000434 4434 B7               4      OR  A
000435 4435 206A            12      JR  NZ,ROM_LDIRVM
000437 4437 CB7A             8      BIT 7,D
000439 4439 CAD144          10      JP  Z,ROM_LDIRSLT
                                #if exists USE_MORMAL32K_OR_ASCII16
       443C                     LDIRA:
00043C 443C F3               4      DI
00043D 443D ED7306F3        20      LD  (_SP),SP
000441 4441 3A07F3          13      LD  A,(_SP_H)
000444 4444 FEC0             7      CP  0C0H
000446 4446 3003            12      JR  NC,SPJ1
000448 4448 3180F2          10      LD  SP,SP32
       444B                     SPJ1:
       444B                     LDIR1:
00044B 444B 78               4      LD  A,B
00044C 444C B1               4      OR  C
00044D 444D 284D            12      JR  Z,LDIRE
                                
00044F 444F C5              11      PUSH    BC
000450 4450 D5              11      PUSH    DE
000451 4451 E5              11      PUSH    HL
000452 4452 3A97F2          13      LD  A,(ROM_SLT)
000455 4455 2680             7      LD  H,080H
000457 4457 CD2400          17      CALL    _ENASLT
00045A 445A E1              10      POP HL
00045B 445B D1              10      POP DE
00045C 445C C1              10      POP BC
       445D                     LDIR2:
00045D 445D 7A               4      LD  A,D
00045E 445E FEC0             7      CP  0C0H
000460 4460 302C            12      JR  NC,LDIR4
                                
000462 4462 C5              11      PUSH    BC
000463 4463 D5              11      PUSH    DE
000464 4464 115EF5          10      LD  DE,BUF
                                
000467 4467 78               4      LD  A,B
000468 4468 B7               4      OR  A
000469 4469 2803            12      JR  Z,LDIR3
00046B 446B 010001          10      LD  BC,00100H
       446E                     LDIR3:
00046E 446E C5              11      PUSH    BC
00046F 446F EDB0                    LDIR
000471 4471 2204F3          16      LD  (_HL),HL
                                
000474 4474 3A43F3          13      LD  A,(RAMAD2)
000477 4477 2680             7      LD  H,080H
000479 4479 CD2400          17      CALL    _ENASLT
                                
00047C 447C C1              10      POP BC
00047D 447D D1              10      POP DE
00047E 447E 215EF5          10      LD  HL,BUF
000481 4481 EDB0                    LDIR
                                
000483 4483 2A04F3          16      LD  HL,(_HL)
000486 4486 C1              10      POP BC
000487 4487 78               4      LD  A,B
000488 4488 B7               4      OR  A
000489 4489 2811            12      JR  Z,LDIRE
00048B 448B 05               4      DEC B
00048C 448C 18BD            12      JR  LDIR1
       448E                     LDIR4:
                                #endif
00048E 448E EDB0                    LDIR
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
       4490                     LDIRE2:
000490 4490 D5              11      PUSH    DE
000491 4491 E5              11      PUSH    HL
000492 4492 3A43F3          13      LD  A,(RAMAD2)
000495 4495 2680             7      LD  H,080H
000497 4497 CD2400          17      CALL    _ENASLT
00049A 449A E1              10      POP HL
00049B 449B D1              10      POP DE
       449C                     LDIRE:
00049C 449C ED7B06F3        20      LD  SP,(_SP)
                                #endif
0004A0 44A0 C9              10      RET
                                
       44A1                     ROM_LDIRVM:
                                #if exists USE_MORMAL32K_OR_ASCII16
0004A1 44A1 F3               4      DI
0004A2 44A2 ED7306F3        20      LD  (_SP),SP
0004A6 44A6 3A07F3          13      LD  A,(_SP_H)
0004A9 44A9 FEC0             7      CP  0C0H
0004AB 44AB 3003            12      JR  NC,SPJ2
0004AD 44AD 3180F2          10      LD  SP,SP32
       44B0                     SPJ2:
0004B0 44B0 C5              11      PUSH    BC
0004B1 44B1 D5              11      PUSH    DE
0004B2 44B2 E5              11      PUSH    HL
0004B3 44B3 3A97F2          13      LD  A,(ROM_SLT)
0004B6 44B6 2680             7      LD  H,080H
0004B8 44B8 CD2400          17      CALL    _ENASLT
0004BB 44BB E1              10      POP HL
0004BC 44BC D1              10      POP DE
0004BD 44BD C1              10      POP BC
                                #endif
0004BE 44BE C5              11      PUSH    BC
0004BF 44BF D5              11      PUSH    DE
0004C0 44C0 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0004C4 44C4 DD215C00        14      LD  IX,LDIRVM
0004C8 44C8 CD1C00          17      CALL    _CALSLT
0004CB 44CB E1              10      POP HL
0004CC 44CC C1              10      POP BC
0004CD 44CD 09              11      ADD HL,BC
0004CE 44CE EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
0004CF 44CF 18BF            12      JR  LDIRE2
                                #else
                                    RET
                                #endif
                                
       44D1                     ROM_LDIRSLT:
                                #if exists USE_MORMAL32K_OR_ASCII16
0004D1 44D1 F3               4      DI
0004D2 44D2 ED7306F3        20      LD  (_SP),SP
0004D6 44D6 3A07F3          13      LD  A,(_SP_H)
0004D9 44D9 FEC0             7      CP  0C0H
0004DB 44DB 3003            12      JR  NC,SPJ3
0004DD 44DD 3180F2          10      LD  SP,SP32
       44E0                     SPJ3:
0004E0 44E0 C5              11      PUSH    BC
0004E1 44E1 D5              11      PUSH    DE
0004E2 44E2 E5              11      PUSH    HL
0004E3 44E3 3A97F2          13      LD  A,(ROM_SLT)
0004E6 44E6 2680             7      LD  H,080H
0004E8 44E8 CD2400          17      CALL    _ENASLT
0004EB 44EB E1              10      POP HL
0004EC 44EC D1              10      POP DE
0004ED 44ED C1              10      POP BC
                                #endif
       44EE                     ROM_LDIRSLT1:
0004EE 44EE EB               4      EX  DE,HL
       44EF                     RLDIRSLT1:
0004EF 44EF CB7C             8      BIT 7,H
0004F1 44F1 2021            12      JR  NZ,RLDIRSLT_EXIT
0004F3 44F3 1A               7      LD  A,(DE)
0004F4 44F4 13               6      INC DE
0004F5 44F5 C5              11      PUSH    BC
0004F6 44F6 D5              11      PUSH    DE
0004F7 44F7 E5              11      PUSH    HL
0004F8 44F8 5F               4      LD  E,A
                                
0004F9 44F9 0141F3          10      LD  BC,RAMAD0
0004FC 44FC 7C               4      LD  A,H
0004FD 44FD 07               4      RLCA
0004FE 44FE 07               4      RLCA
0004FF 44FF E603             7      AND 3
000501 4501 81               4      ADD A,C
000502 4502 4F               4      LD  C,A
000503 4503 0A               7      LD  A,(BC)
       4504                     RLDIRSLT2:
000504 4504 CD1400          17      CALL    _WRSLT
000507 4507 08               4      EX  AF,AF'
000508 4508 E1              10      POP HL
000509 4509 D1              10      POP DE
00050A 450A C1              10      POP BC
00050B 450B EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00050D 450D EAEF44          10      JP  PE,RLDIRSLT1
000510 4510 EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
000511 4511 C39044          10      JP  LDIRE2
       4514                     RLDIRSLT_EXIT:
000514 4514 EB               4      EX  DE,HL
000515 4515 C34B44          10      JP  LDIR1
                                #else
                                    RET
                                RLDIRSLT_EXIT:
                                    EX  DE,HL
                                    LDIR
                                    RET
                                #endif
                                
       4518                     END_OF_LINE:
000518 4518 215EF5          10      LD  HL,BUF
       451B                     EOL1:
00051B 451B 7E               7      LD  A,(HL)
00051C 451C C8              11      RET Z
00051D 451D FE0D             7      CP  00DH
00051F 451F 2807            12      JR  Z,EOLE
000521 4521 FE0A             7      CP  00AH
000523 4523 2803            12      JR  Z,EOLE
000525 4525 23               6      INC HL
000526 4526 18F3            12      JR  EOL1
       4528                     EOLE:
000528 4528 3600            10      LD  (HL),0
00052A 452A 23               6      INC HL
00052B 452B 7E               7      LD  A,(HL)
00052C 452C FE0A             7      CP  00AH
00052E 452E C0              11      RET NZ
00052F 452F 23               6      INC HL
000530 4530 C9              10      RET
                                
       4531                     ROM_LOAD_ASCII:
000531 4531 210000          10      LD  HL,0
000534 4534 22DAF2          16      LD  (_BUF_ST),HL    ;読み出し位置
000537 4537 2A76F6          16      LD  HL,(TXTTAB)
00053A 453A 22DCF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
00053D 453D 215EF5          10      LD  HL,BUF
000540 4540 22D4F2          16      LD  (_DTA),HL
       4543                     RLOAD_A1:
000543 4543 2ADAF2          16      LD  HL,(_BUF_ST)
000546 4546 22CAF2          16      LD  (RR_LOW),HL
000549 4549 210201          10      LD  HL,258
00054C 454C CD5B4A          17      CALL    ROM_READ
00054F 454F 7C               4      LD  A,H
000550 4550 B5               4      OR  L
000551 4551 2879            12      JR  Z,RLOAD_AEND
000553 4553 015EF5          10      LD  BC,BUF
000556 4556 09              11      ADD HL,BC
000557 4557 3600            10      LD  (HL),0
000559 4559 CD1845          17      CALL    END_OF_LINE
00055C 455C 015EF5          10      LD  BC,BUF
00055F 455F A7               4      AND A
000560 4560 ED42            15      SBC HL,BC
000562 4562 2810            12      JR  Z,RLOAD_A2
000564 4564 4D               4      LD  C,L
000565 4565 44               4      LD  B,H
000566 4566 ED5BDAF2        20      LD  DE,(_BUF_ST)
00056A 456A 19              11      ADD HL,DE
00056B 456B 22DAF2          16      LD  (_BUF_ST),HL
00056E 456E 3A5EF5          13      LD  A,(BUF)
000571 4571 B7               4      OR  A
000572 4572 28CF            12      JR  Z,RLOAD_A1
       4574                     RLOAD_A2:
000574 4574 115EF5          10      LD  DE,BUF
000577 4577 CD254C          17      CALL    SPCUTEX
00057A 457A 1A               7      LD  A,(DE)
00057B 457B B7               4      OR  A
00057C 457C 284E            12      JR  Z,RLOAD_AEND
00057E 457E CD374C          17      CALL    GETNUM
000581 4581 7C               4      LD  A,H
000582 4582 B5               4      OR  L
000583 4583 CAA346          10      JP  Z,ERROR_DIRECT_IN_FILE
000586 4586 DD2ADCF2        20      LD  IX,(_BUF_EN)
00058A 458A DD7502          19      LD  (IX+2),L
00058D 458D DD7403          19      LD  (IX+3),H
                                
000590 4590 CD1E4C          17      CALL    SPCUT
000593 4593 EB               4      EX  DE,HL
000594 4594 DDE5            15      PUSH    IX
000596 4596 DD21B242        14      LD  IX,CRUNCH
00059A 459A FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00059E 459E CD1C00          17      CALL    _CALSLT
0005A1 45A1 DDE1            14      POP IX
0005A3 45A3 EB               4      EX  DE,HL
0005A4 45A4 111FF4          10      LD  DE,KBUF
0005A7 45A7 37               4      SCF
0005A8 45A8 ED52            15      SBC HL,DE
0005AA 45AA CAA346          10      JP  Z,ERROR_DIRECT_IN_FILE
0005AD 45AD DAA346          10      JP  C,ERROR_DIRECT_IN_FILE
0005B0 45B0 4D               4      LD  C,L
0005B1 45B1 44               4      LD  B,H
0005B2 45B2 2ADCF2          16      LD  HL,(_BUF_EN)
0005B5 45B5 110400          10      LD  DE,4
0005B8 45B8 19              11      ADD HL,DE
0005B9 45B9 111FF4          10      LD  DE,KBUF
                                
0005BC 45BC EB               4      EX  DE,HL
0005BD 45BD EDB0                    LDIR
0005BF 45BF EB               4      EX  DE,HL
                                
0005C0 45C0 DD7500          19      LD  (IX+0),L
0005C3 45C3 DD7401          19      LD  (IX+1),H
0005C6 45C6 22DCF2          16      LD  (_BUF_EN),HL
0005C9 45C9 C34345          10      JP  RLOAD_A1
                                
       45CC                     RLOAD_AEND:
0005CC 45CC 2ADCF2          16      LD  HL,(_BUF_EN)
0005CF 45CF AF               4      XOR A
0005D0 45D0 77               7      LD  (HL),A
0005D1 45D1 23               6      INC HL
0005D2 45D2 77               7      LD  (HL),A
0005D3 45D3 23               6      INC HL
0005D4 45D4 22DCF2          16      LD  (_BUF_EN),HL
0005D7 45D7 C36646          10      JP  RLOAD_END1
                                
       45DA                     ROM_LOAD:
0005DA 45DA CD0948          17      CALL    INIT_PARAM
0005DD 45DD 7E               7      LD  A,(HL)
0005DE 45DE FE2C             7      CP  ','
0005E0 45E0 2003            12      JR  NZ,ROM_LOAD0
0005E2 45E2 23               6      INC HL
0005E3 45E3 7E               7      LD  A,(HL)
0005E4 45E4 2B               6      DEC HL
       45E5                     ROM_LOAD0:
0005E5 45E5 32BEFC          13      LD  (RUNBNF),A
0005E8 45E8 CDFC4A          17      CALL    FILE_B
0005EB 45EB 3AF9F2          13      LD  A,(FNAME)
0005EE 45EE FE20             7      CP  020H
0005F0 45F0 CAF74A          10      JP  Z,ROM_ORG
                                
0005F3 45F3 CD8E4C          17      CALL    ROM_OPEN
0005F6 45F6 DAAF46          10      JP  C,ERROR_FILE_NOT_FOUND
       45F9                     ROM_LOAD1:
0005F9 45F9 21D9F2          10      LD  HL,_BUF
0005FC 45FC 22D4F2          16      LD  (_DTA),HL
0005FF 45FF 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
000602 4602 CD5B4A          17      CALL    ROM_READ
000605 4605 3AD9F2          13      LD  A,(_BUF)
000608 4608 3C               4      INC A
000609 4609 C23145          10      JP  NZ,ROM_LOAD_ASCII
00060C 460C 2A76F6          16      LD  HL,(TXTTAB)
00060F 460F 22D4F2          16      LD  (_DTA),HL
000612 4612 EB               4      EX  DE,HL
000613 4613 2100FF          10      LD  HL,-256
000616 4616 39              11      ADD HL,SP
000617 4617 ED52            15      SBC HL,DE
000619 4619 CD5B4A          17      CALL    ROM_READ
00061C 461C ED5BD4F2        20      LD  DE,(_DTA)
000620 4620 19              11      ADD HL,DE
000621 4621 E5              11      PUSH    HL
000622 4622 2A76F6          16      LD  HL,(TXTTAB)
       4625                     ROM_LOAD2:          ;リンクポインタをFIX
000625 4625 E5              11      PUSH    HL
000626 4626 DDE1            14      POP IX
000628 4628 7E               7      LD  A,(HL)      ;リンクポインタL
000629 4629 23               6      INC HL
00062A 462A B6               7      OR  (HL)        ;リンクポインタH
00062B 462B 23               6      INC HL
00062C 462C 2837            12      JR  Z,RLOAD_END0
00062E 462E 23               6      INC HL      ;行番号
00062F 462F 23               6      INC HL      ;行番号
       4630                     ROM_LOAD3:
000630 4630 7E               7      LD  A,(HL)
000631 4631 23               6      INC HL
000632 4632 FE0B             7      CP  00BH        ;8進数(&O)
000634 4634 2822            12      JR  Z,INC_HL2
000636 4636 FE0C             7      CP  00CH        ;16進数(&H)
000638 4638 281E            12      JR  Z,INC_HL2
00063A 463A FE0D             7      CP  00DH        ;行番号(RUN後)
00063C 463C 281A            12      JR  Z,INC_HL2
00063E 463E FE0E             7      CP  00EH        ;行番号(RUN前)
000640 4640 2816            12      JR  Z,INC_HL2
000642 4642 FE0F             7      CP  00FH        ;10～255の整数(%)
000644 4644 2813            12      JR  Z,INC_HL1
000646 4646 FE1C             7      CP  01CH        ;256～65535の整数(%)
000648 4648 280E            12      JR  Z,INC_HL2
00064A 464A FE1D             7      CP  01DH        ;単精度実数(!)
00064C 464C 2808            12      JR  Z,INC_HL4
00064E 464E FE1F             7      CP  01FH        ;倍制度実数(#)
000650 4650 2008            12      JR  NZ,INC_HL0
000652 4652 23               6      INC HL
000653 4653 23               6      INC HL
000654 4654 23               6      INC HL
000655 4655 23               6      INC HL
       4656                     INC_HL4:
000656 4656 23               6      INC HL
000657 4657 23               6      INC HL
       4658                     INC_HL2:
000658 4658 23               6      INC HL
       4659                     INC_HL1:
000659 4659 23               6      INC HL
       465A                     INC_HL0:
00065A 465A B7               4      OR  A
00065B 465B 20D3            12      JR  NZ,ROM_LOAD3
00065D 465D DD7500          19      LD  (IX+0),L
000660 4660 DD7401          19      LD  (IX+1),H
000663 4663 18C0            12      JR  ROM_LOAD2
       4665                     RLOAD_END0:
000665 4665 E1              10      POP HL
       4666                     RLOAD_END1:
000666 4666 22C2F6          16      LD  (VARTAB),HL
000669 4669 22C4F6          16      LD  (ARYTAB),HL
00066C 466C 22C6F6          16      LD  (STREND),HL
                                
00066F 466F 3ABEFC          13      LD  A,(RUNBNF)
000672 4672 CD784C          17      CALL    CAP
000675 4675 FE52             7      CP  'R'
000677 4677 280E            12      JR  Z,RLOAD_END2
000679 4679 AF               4      XOR A
00067A 467A 21DCF2          10      LD  HL,_BUF+3
00067D 467D 77               7      LD  (HL),A      ;3
00067E 467E 2B               6      DEC HL
00067F 467F 77               7      LD  (HL),A      ;2
000680 4680 2B               6      DEC HL
000681 4681 77               7      LD  (HL),A      ;1
000682 4682 2B               6      DEC HL
000683 4683 3E8F             7      LD  A,08FH      ;REM
000685 4685 77               7      LD  (HL),A      ;0
000686 4686 C9              10      RET
       4687                     RLOAD_END2:
000687 4687 D5              11      PUSH    DE
000688 4688 ED5B76F6        20      LD  DE,(TXTTAB)
00068C 468C 1B               6      DEC DE
00068D 468D AF               4      XOR A
00068E 468E 21DFF2          10      LD  HL,_BUF+6
000691 4691 77               7      LD  (HL),A      ;6
000692 4692 2B               6      DEC HL
000693 4693 77               7      LD  (HL),A      ;5
000694 4694 2B               6      DEC HL
000695 4695 77               7      LD  (HL),A      ;4
000696 4696 2B               6      DEC HL
000697 4697 72               7      LD  (HL),D      ;3 行番号H
000698 4698 2B               6      DEC HL
000699 4699 73               7      LD  (HL),E      ;2 行番号L
00069A 469A 2B               6      DEC HL
00069B 469B 360D            10      LD  (HL),00DH   ;1 行番号(RUN後)
00069D 469D 2B               6      DEC HL
00069E 469E 3E89             7      LD  A,089H      ;GOTO
0006A0 46A0 77               7      LD  (HL),A      ;0
0006A1 46A1 D1              10      POP DE
0006A2 46A2 C9              10      RET
                                
       46A3                     ERROR_DIRECT_IN_FILE:
0006A3 46A3 1E39             7      LD  E,57            ;Direct statement in file
0006A5 46A5 01                      DB  1           ;LD BC,
       46A6                     ERROR_DEVICE_IO_ERROR:
0006A6 46A6 1E13             7      LD  E,19            ;Device I/O error
0006A8 46A8 01                      DB  1           ;LD BC,
       46A9                     ERROR_INTERNAL_ERROR:
0006A9 46A9 1E33             7      LD  E,51            ;Internal error
0006AB 46AB 01                      DB  1           ;LD BC,
       46AC                     ERROR_FILE_NOT_OPEN:
0006AC 46AC 1E3B             7      LD  E,59            ;File not OPEN
0006AE 46AE 01                      DB  1           ;LD BC,
       46AF                     ERROR_FILE_NOT_FOUND:
0006AF 46AF 1E35             7      LD  E,53            ;File not found
       46B1                     ERROR:
0006B1 46B1 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0006B5 46B5 DD216F40        14      LD  IX,ERRHAND
0006B9 46B9 C31C00          10      JP  _CALSLT
                                
       46BC                     ROM_BLOAD:
0006BC 46BC CD0948          17      CALL    INIT_PARAM
0006BF 46BF CDFC4A          17      CALL    FILE_B
0006C2 46C2 CD8E4C          17      CALL    ROM_OPEN
0006C5 46C5 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
0006C7 46C7 21D9F2          10      LD  HL,_BUF
0006CA 46CA 22D4F2          16      LD  (_DTA),HL
0006CD 46CD 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
0006D0 46D0 CD5B4A          17      CALL    ROM_READ
0006D3 46D3 3AD9F2          13      LD  A,(_BUF)
0006D6 46D6 FEFE             7      CP  0FEH
0006D8 46D8 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
0006DA 46DA 21A5F2          10      LD  HL,BLOAD_RET
0006DD 46DD 229DF2          16      LD  (SWC_BLOAD),HL
                                
0006E0 46E0 2AF4F2          16      LD  HL,(PARAM1)
0006E3 46E3 7E               7      LD  A,(HL)
0006E4 46E4 FE2C             7      CP  ','
0006E6 46E6 2049            12      JR  NZ,RBREAD_MEM
0006E8 46E8 23               6      INC HL
0006E9 46E9 7E               7      LD  A,(HL)
0006EA 46EA CD784C          17      CALL    CAP
0006ED 46ED 32BEFC          13      LD  (RUNBNF),A
0006F0 46F0 FE52             7      CP  'R'     ;R,Sスイッチじゃ無い場合はオフセット値として処理する
0006F2 46F2 2808            12      JR  Z,RBOS1
0006F4 46F4 FE53             7      CP  'S'
0006F6 46F6 2804            12      JR  Z,RBOS1
0006F8 46F8 FE2C             7      CP  ','
0006FA 46FA 200D            12      JR  NZ,RBOS2
       46FC                     RBOS1:
0006FC 46FC 7E               7      LD  A,(HL)
0006FD 46FD 23               6      INC HL
0006FE 46FE B7               4      OR  A
0006FF 46FF 2824            12      JR  Z,RBREAD_OSE
000701 4701 FE3A             7      CP  ':'
000703 4703 2820            12      JR  Z,RBREAD_OSE
000705 4705 FE2C             7      CP  ','     ;次のパラメータを探す
000707 4707 20F3            12      JR  NZ,RBOS1
       4709                     RBOS2:              ;オフセット
000709 4709 22F4F2          16      LD  (PARAM1),HL
00070C 470C 7E               7      LD  A,(HL)
00070D 470D B7               4      OR  A
00070E 470E 2815            12      JR  Z,RBREAD_OSE
000710 4710 DD212F54        14      LD  IX,FRMQNT
000714 4714 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000718 4718 CD1C00          17      CALL    _CALSLT
00071B 471B 22F4F2          16      LD  (PARAM1),HL
00071E 471E 2ADAF2          16      LD  HL,(_BUF_ST)
000721 4721 19              11      ADD HL,DE
000722 4722 22DAF2          16      LD  (_BUF_ST),HL
       4725                     RBREAD_OSE:
000725 4725 3ABEFC          13      LD  A,(RUNBNF)
000728 4728 FE53             7      CP  'S'
00072A 472A 2005            12      JR  NZ,RBREAD_MEM
00072C 472C 3E01             7      LD  A,1
00072E 472E 32D6F2          13      LD  (FLG_LDIR),A
       4731                     RBREAD_MEM:
000731 4731 2ADAF2          16      LD  HL,(_BUF_ST)
000734 4734 22BFFC          16      LD  (SAVENT),HL
000737 4737 22D4F2          16      LD  (_DTA),HL
00073A 473A 21FFFF          10      LD  HL,0FFFFH
00073D 473D CD5B4A          17      CALL    ROM_READ
000740 4740 AF               4      XOR A
000741 4741 32D6F2          13      LD  (FLG_LDIR),A
000744 4744 3ABEFC          13      LD  A,(RUNBNF)
000747 4747 FE52             7      CP  'R'
000749 4749 2006            12      JR  NZ,RBREAD1
00074B 474B 2ADEF2          16      LD  HL,(_BUF_EX)
00074E 474E 229DF2          16      LD  (SWC_BLOAD),HL
       4751                     RBREAD1:
       4751                     ROM_NEXT:
000751 4751 2AF4F2          16      LD  HL,(PARAM1)
000754 4754 7E               7      LD  A,(HL)
000755 4755 2B               6      DEC HL
000756 4756 B7               4      OR  A
000757 4757 2805            12      JR  Z,ROM_NEXT1
000759 4759 FE3A             7      CP  ':'
00075B 475B 2801            12      JR  Z,ROM_NEXT1
00075D 475D 23               6      INC HL
       475E                     ROM_NEXT1:
00075E 475E 5D               4      LD  E,L
00075F 475F 54               4      LD  D,H
                                
000760 4760 CD4E4C          17      CALL    SEARCH_END
000763 4763 B7               4      OR  A
000764 4764 2821            12      JR  Z,REM
       4766                     RN3:                    ;マルチステートメントの処理
000766 4766 7E               7      LD  A,(HL)
                                
000767 4767 FEB5             7      CP  0B5H            ;LOAD
000769 4769 CADA45          10      JP  Z,ROM_LOAD
00076C 476C FE8A             7      CP  08AH            ;RUN
00076E 476E 281B            12      JR  Z,ROM_RUN
000770 4770 FEB7             7      CP  0B7H            ;FILES
000772 4772 2825            12      JR  Z,ROM_FILES
000774 4774 FED6             7      CP  0D6H            ;COPY
000776 4776 CA3B48          10      JP  Z,ROM_COPY
000779 4779 FE20             7      CP  020H
00077B 477B 2807            12      JR  Z,RN_SP
                                
00077D 477D 3E28             7      LD  A,028H          ;JR Z,
00077F 477F 32A3F2          13      LD  (SWC_BLOAD_M),A
000782 4782 7E               7      LD  A,(HL)
000783 4783 C9              10      RET
       4784                     RN_SP:
000784 4784 23               6      INC HL
000785 4785 18DF            12      JR  RN3
                                
       4787                     REM:
000787 4787 EB               4      EX  DE,HL
000788 4788 3E8F             7      LD  A,08FH          ;REM
00078A 478A C9              10      RET
                                
       478B                     ROM_RUN:
00078B 478B 23               6      INC HL
00078C 478C 7E               7      LD  A,(HL)
00078D 478D 2B               6      DEC HL
00078E 478E B7               4      OR  A
00078F 478F C4DA45          17      CALL    NZ,ROM_LOAD
000792 4792 FE8F             7      CP  08FH            ;REM
000794 4794 3E8A             7      LD  A,08AH          ;RUN
000796 4796 C0              11      RET NZ
000797 4797 77               7      LD  (HL),A
000798 4798 C9              10      RET
                                
       4799                     ROM_FILES:
000799 4799 CD0948          17      CALL    INIT_PARAM
00079C 479C CDFC4A          17      CALL    FILE_B
00079F 479F CD9053          17      CALL    GET_DISK_BANK_FDRV
0007A2 47A2 3AC9F2          13      LD  A,(SECSZ_H)
0007A5 47A5 CD4E52          17      CALL    IS_BPB1
0007A8 47A8 DAA646          10      JP  C,ERROR_DEVICE_IO_ERROR
0007AB 47AB 3AF9F2          13      LD  A,(FNAME)
0007AE 47AE FE21             7      CP  021H
0007B0 47B0 3005            12      JR  NC,RFILES0
0007B2 47B2 060B             7      LD  B,11
0007B4 47B4 CDE24B          17      CALL    FILE10
       47B7                     RFILES0:
0007B7 47B7 CDEA4E          17      CALL    GET_DIR_DAT
       47BA                     RFILES1:
0007BA 47BA CDAA4C          17      CALL    FILESE
0007BD 47BD 3045            12      JR  NC,RFILES_NOT_MATCH
       47BF                     RFILES_DISP:
0007BF 47BF E5              11      PUSH    HL
0007C0 47C0 110B00          10      LD  DE,0000BH   ;属性
0007C3 47C3 19              11      ADD HL,DE
                                #if exists USE_MORMAL32K_OR_ASCII16
0007C4 47C4 CDBE43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
0007C7 47C7 E1              10      POP HL
0007C8 47C8 CB4F             8      BIT 1,A     ;不可視属性
0007CA 47CA 2035            12      JR  NZ,RFILES_NEXT
0007CC 47CC E5              11      PUSH    HL
0007CD 47CD 0608             7      LD  B,8
0007CF 47CF CDB243          17      CALL    MSN
                                #if exists USE_MORMAL32K_OR_ASCII16
0007D2 47D2 CDBE43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
0007D5 47D5 FE20             7      CP  020H
0007D7 47D7 F5              11      PUSH    AF
0007D8 47D8 3E2E             7      LD  A,'.'
0007DA 47DA C40654          17      CALL    NZ,MSG_A
0007DD 47DD 0603             7      LD  B,3
0007DF 47DF CDB243          17      CALL    MSN
0007E2 47E2 F1              10      POP AF
0007E3 47E3 CC0654          17      CALL    Z,MSG_A
0007E6 47E6 3ADDF3          13      LD  A,(CSRX)
0007E9 47E9 47               4      LD  B,A
0007EA 47EA 3AB0F3          13      LD  A,(LINLEN)
0007ED 47ED 90               4      SUB B
0007EE 47EE FE0C             7      CP  12
0007F0 47F0 3009            12      JR  NC,RFILES2
0007F2 47F2 3E0D             7      LD  A,00DH      ;改行
0007F4 47F4 CD0654          17      CALL    MSG_A
0007F7 47F7 3E0A             7      LD  A,00AH
0007F9 47F9 1802            12      JR  RFILES3
       47FB                     RFILES2:
0007FB 47FB 3E20             7      LD  A,020H
       47FD                     RFILES3:
0007FD 47FD CD0654          17      CALL    MSG_A
000800 4800 E1              10      POP HL
       4801                     RFILES_NEXT:
000801 4801 CDC84C          17      CALL    FNEXT
       4804                     RFILES_NOT_MATCH:
000804 4804 20B4            12      JR  NZ,RFILES1
000806 4806 C35147          10      JP  ROM_NEXT
                                
       4809                     INIT_PARAM:
000809 4809 22F2F2          16      LD  (PARAM0),HL
00080C 480C 22F4F2          16      LD  (PARAM1),HL
00080F 480F EB               4      EX  DE,HL
000810 4810 32BEFC          13      LD  (RUNBNF),A
000813 4813 3263F6          13      LD  (VALTYP),A
000816 4816 E5              11      PUSH    HL
000817 4817 2AEBF2          16      LD  HL,(_CD)
00081A 481A 22F6F2          16      LD  (_CDX),HL
00081D 481D E1              10      POP HL
00081E 481E 13               6      INC DE
00081F 481F CD1E4C          17      CALL    SPCUT
000822 4822 1A               7      LD  A,(DE)
000823 4823 B7               4      OR  A
000824 4824 C8              11      RET Z
000825 4825 FE3A             7      CP  ':'
000827 4827 C8              11      RET Z
000828 4828 FE28             7      CP  '('
00082A 482A C8              11      RET Z
00082B 482B EB               4      EX  DE,HL
00082C 482C DD21644C        14      LD  IX,FRMEVL
000830 4830 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000834 4834 CD1C00          17      CALL    _CALSLT
000837 4837 22F4F2          16      LD  (PARAM1),HL
00083A 483A C9              10      RET
                                
       483B                     ROM_COPY:
00083B 483B CD0948          17      CALL    INIT_PARAM
00083E 483E 3A63F6          13      LD  A,(VALTYP)
000841 4841 FE03             7      CP  3       ;string
000843 4843 C2F74A          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
000846 4846 CDFC4A          17      CALL    FILE_B
000849 4849 CD8E4C          17      CALL    ROM_OPEN
00084C 484C DAAF46          10      JP  C,ERROR_FILE_NOT_FOUND
                                
00084F 484F 21DEF2          10      LD  HL,_BUF_W
000852 4852 22D4F2          16      LD  (_DTA),HL
000855 4855 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
000858 4858 CD5B4A          17      CALL    ROM_READ
                                
00085B 485B AF               4      XOR A
00085C 485C 32D9F2          13      LD  (_BUF_LO),A     ;PSET
00085F 485F 32E6F2          13      LD  (_BUF_O),A      ;向き
                                
000862 4862 2AF4F2          16      LD  HL,(PARAM1)
       4865                     RCP_PARAM1:
000865 4865 7E               7      LD  A,(HL)
000866 4866 23               6      INC HL
000867 4867 B7               4      OR  A
000868 4868 CA5E47          10      JP  Z,ROM_NEXT1
00086B 486B FE3A             7      CP  ':'
00086D 486D CA5E47          10      JP  Z,ROM_NEXT1
000870 4870 FE2C             7      CP  ','
000872 4872 2012            12      JR  NZ,RCP_PARAM1_
                                
000874 4874 DD212F54        14      LD  IX,FRMQNT
000878 4878 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00087C 487C CD1C00          17      CALL    _CALSLT
00087F 487F 7B               4      LD  A,E
000880 4880 87               4      ADD A,A
000881 4881 87               4      ADD A,A
000882 4882 32E6F2          13      LD  (_BUF_O),A
000885 4885 7E               7      LD  A,(HL)
       4886                     RCP_PARAM1_:
000886 4886 FE28             7      CP  '('
000888 4888 20DB            12      JR  NZ,RCP_PARAM1
00088A 488A DD212F54        14      LD  IX,FRMQNT
00088E 488E FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000892 4892 CD1C00          17      CALL    _CALSLT
                                
000895 4895 ED53E2F2        20      LD  (_BUF_X),DE
                                
       4899                     RCP_PARAM2:
000899 4899 23               6      INC HL
00089A 489A 7E               7      LD  A,(HL)
00089B 489B FE20             7      CP  020H
00089D 489D 28FA            12      JR  Z,RCP_PARAM2
00089F 489F FE2C             7      CP  ','
0008A1 48A1 28F6            12      JR  Z,RCP_PARAM2
                                
0008A3 48A3 DD212F54        14      LD  IX,FRMQNT
0008A7 48A7 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0008AB 48AB CD1C00          17      CALL    _CALSLT
                                
0008AE 48AE 3AF6FA          13      LD  A,(ACPAGE)
0008B1 48B1 57               4      LD  D,A
0008B2 48B2 ED53E4F2        20      LD  (_BUF_Y),DE
       48B6                     RCP_PARAM3:
0008B6 48B6 23               6      INC HL
0008B7 48B7 7E               7      LD  A,(HL)
0008B8 48B8 FE20             7      CP  020H
0008BA 48BA 28FA            12      JR  Z,RCP_PARAM3
0008BC 48BC FE29             7      CP  ')'
0008BE 48BE 28F6            12      JR  Z,RCP_PARAM3
0008C0 48C0 FE2C             7      CP  ','
0008C2 48C2 2033            12      JR  NZ,RCP_ST
                                
0008C4 48C4 23               6      INC HL
0008C5 48C5 DD212F54        14      LD  IX,FRMQNT
0008C9 48C9 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0008CD 48CD CD1C00          17      CALL    _CALSLT
                                
0008D0 48D0 7B               4      LD  A,E
0008D1 48D1 32E5F2          13      LD  (_BUF_P),A
                                
       48D4                     RCP_PARAM4:
0008D4 48D4 7E               7      LD  A,(HL)
0008D5 48D5 23               6      INC HL
0008D6 48D6 FE20             7      CP  020H
0008D8 48D8 28FA            12      JR  Z,RCP_PARAM4
                                
0008DA 48DA FE2C             7      CP  ','
0008DC 48DC 2019            12      JR  NZ,RCP_ST
                                
0008DE 48DE 7E               7      LD  A,(HL)
0008DF 48DF 0604             7      LD  B,4
0008E1 48E1 FEC3             7      CP  0C3H        ;PRESET
0008E3 48E3 280E            12      JR  Z,RCP_LO
0008E5 48E5 05               4      DEC B       ;3
0008E6 48E6 D6F8             7      SUB 0F8H        ;XOR
0008E8 48E8 2809            12      JR  Z,RCP_LO
0008EA 48EA 05               4      DEC B       ;2
0008EB 48EB 3C               4      INC A       ;OR
0008EC 48EC 2805            12      JR  Z,RCP_LO
0008EE 48EE 05               4      DEC B       ;1
0008EF 48EF 3C               4      INC A       ;AND
0008F0 48F0 2801            12      JR  Z,RCP_LO
0008F2 48F2 05               4      DEC B       ;0
                                                ;PSET
       48F3                     RCP_LO:
0008F3 48F3 78               4      LD  A,B
0008F4 48F4 32D9F2          13      LD  (_BUF_LO),A
       48F7                     RCP_ST:
0008F7 48F7 2AC6F6          16      LD  HL,(STREND)
0008FA 48FA 22D4F2          16      LD  (_DTA),HL
0008FD 48FD EB               4      EX  DE,HL
0008FE 48FE 2100FE          10      LD  HL,-512
000901 4901 39              11      ADD HL,SP
000902 4902 AF               4      XOR A
000903 4903 ED52            15      SBC HL,DE
000905 4905 3008            12      JR  NC,RCP0
000907 4907 215EF5          10      LD  HL,BUF
00090A 490A 22D4F2          16      LD  (_DTA),HL
00090D 490D 6F               4      LD  L,A ;0
00090E 490E 67               4      LD  H,A ;0
       490F                     RCP0:
00090F 490F 24               4      INC H
000910 4910 22DCF2          16      LD  (_BUF_EN),HL
       4913                     RCP1:
000913 4913 F3               4      DI
000914 4914 CDE949          17      CALL    WAIT_VDP
                                
000917 4917 3A0700          13      LD  A,(WRVDP)
00091A 491A 4F               4      LD  C,A
00091B 491B 0C               4      INC C       ;C := PORT#1's address(WR)
00091C 491C 3E24             7      LD  A,36
00091E 491E ED79            12      OUT (C),A
000920 4920 3E91             7      LD  A,080H+17
000922 4922 ED79            12      OUT (C),A       ;R#17 := 36
                                
000924 4924 0C               4      INC C
000925 4925 0C               4      INC C       ;C := PORT#3's address(WR)
000926 4926 2AE2F2          16      LD  HL,(_BUF_X)
000929 4929 ED69            12      OUT (C),L       ;R#36 DX
00092B 492B ED61            12      OUT (C),H       ;R#37
00092D 492D 2AE4F2          16      LD  HL,(_BUF_Y)
000930 4930 ED69            12      OUT (C),L       ;R#38 DY
000932 4932 ED61            12      OUT (C),H       ;R#39
000934 4934 2ADEF2          16      LD  HL,(_BUF_W)
000937 4937 ED69            12      OUT (C),L       ;R#40 NX
000939 4939 ED61            12      OUT (C),H       ;R#41
00093B 493B 2AE0F2          16      LD  HL,(_BUF_H)
00093E 493E ED69            12      OUT (C),L       ;R#42 NY
000940 4940 ED61            12      OUT (C),H       ;R#43
                                
000942 4942 DD2AAFFC        20      LD  IX,(SCRMOD)
000946 4946 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000949 4949 B7               4      OR  A
00094A 494A 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
00094C 494C DD7D             9      LD  A,IXL
00094E 494E FE08             7      CP  8
000950 4950 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
000952 4952 FE06             7      CP  6
000954 4954 2AE2F2          16      LD  HL,(_BUF_X)
000957 4957 3ADEF2          13      LD  A,(_BUF_W)
00095A 495A 2005            12      JR  NZ,SCR57
00095C 495C B5               4      OR  L       ;スクリーン6
00095D 495D E603             7      AND 3
00095F 495F 200D            12      JR  NZ,USE_LMMC
       4961                     SCR57:              ;スクリーン5,7
000961 4961 B5               4      OR  L
000962 4962 E601             7      AND 1
000964 4964 2008            12      JR  NZ,USE_LMMC
       4966                     USE_HMMC:
000966 4966 DD2E08          10      LD  IXL,8
       4969                     USE_HMMC8:
000969 4969 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
00096B 496B 32D9F2          13      LD  (_BUF_LO),A
       496E                     USE_LMMC:
00096E 496E 110000          10      LD  DE,0
000971 4971 06FF             7      LD  B,-1
000973 4973 CD144A          17      CALL    GET_PIXEL
000976 4976 ED79            12      OUT (C),A       ;R#44 first DATA
000978 4978 3AE6F2          13      LD  A,(_BUF_O)
00097B 497B ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
00097D 497D 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000980 4980 F6B0             7      OR  0B0H        ;R#46 LMMC command
000982 4982 ED79            12      OUT (C),A
                                
000984 4984 FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
000986 4986 0D               4      DEC C
000987 4987 0D               4      DEC C       ;C := PORT#1's address(WR)
000988 4988 3EAC             7      LD  A,080H+44
00098A 498A ED79            12      OUT (C),A
00098C 498C 3E91             7      LD  A,080H+17
00098E 498E ED79            12      OUT (C),A       ;R#17 := 44
                                
000990 4990 3A0600          13      LD  A,(RDVDP)
000993 4993 3C               4      INC A
000994 4994 FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
000996 4996 3E02             7      LD  A,2
000998 4998 ED79            12      OUT (C),A
00099A 499A 3E8F             7      LD  A,08FH
00099C 499C ED79            12      OUT (C),A
00099E 499E 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0009A1 49A1 E640             7      AND 040H
0009A3 49A3 201C            12      JR  NZ,LOOP_HMMC
       49A5                     LOOP_COPY:
0009A5 49A5 CD144A          17      CALL    GET_PIXEL
0009A8 49A8 08               4      EX  AF,AF'
0009A9 49A9 FD4C             9      LD  C,IYH
       49AB                     LOOP_COPY1:
0009AB 49AB ED78            12      IN  A,(C)
0009AD 49AD 0F               4      RRCA            ;RRCAではサインフラグは変化しない
0009AE 49AE 300A            12      JR  NC,EXIT_COPY    ;check CE bit
0009B0 49B0 F2AB49          10      JP  P,LOOP_COPY1    ;check TR bit
0009B3 49B3 08               4      EX  AF,AF'
0009B4 49B4 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
0009B6 49B6 ED79            12      OUT (C),A
0009B8 49B8 18EB            12      JR  LOOP_COPY
                                
       49BA                     EXIT_COPY:
0009BA 49BA CDF149          17      CALL    GET_STATUS_0
0009BD 49BD FB               4      EI
0009BE 49BE C35147          10      JP  ROM_NEXT
                                
       49C1                     LOOP_HMMC:
0009C1 49C1 F3               4      DI          ;必要
0009C2 49C2 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
0009C4 49C4 43               4      LD  B,E
0009C5 49C5 7B               4      LD  A,E
0009C6 49C6 B7               4      OR  A
0009C7 49C7 2802            12      JR  Z,LOOP_HMMC1
0009C9 49C9 EDB3                    OTIR
       49CB                     LOOP_HMMC1:
0009CB 49CB 14               4      INC D
       49CC                     LOOP_HMMC2:
0009CC 49CC 15               4      DEC D
0009CD 49CD 2805            12      JR  Z,LOOP_HMMC3
0009CF 49CF EDB3                    OTIR
0009D1 49D1 C3CC49          10      JP  LOOP_HMMC2
       49D4                     LOOP_HMMC3:
0009D4 49D4 ED78            12      IN  A,(C)
0009D6 49D6 0F               4      RRCA
0009D7 49D7 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
0009D9 49D9 2ADCF2          16      LD  HL,(_BUF_EN)
0009DC 49DC CD5B4A          17      CALL    ROM_READ
0009DF 49DF EB               4      EX  DE,HL
0009E0 49E0 2AD4F2          16      LD  HL,(_DTA)
0009E3 49E3 7A               4      LD  A,D
0009E4 49E4 B3               4      OR  E
0009E5 49E5 20DA            12      JR  NZ,LOOP_HMMC
0009E7 49E7 18C2            12      JR  LOOP_COPY1
                                    
       49E9                     WAIT_VDP:
0009E9 49E9 3E02             7      LD  A,2
0009EB 49EB CDF249          17      CALL    GET_STATUS
0009EE 49EE 0F               4      RRCA
0009EF 49EF 38F8            12      JR  C,WAIT_VDP
       49F1                     GET_STATUS_0:
0009F1 49F1 AF               4      XOR A
       49F2                     GET_STATUS:
0009F2 49F2 C5              11      PUSH    BC
0009F3 49F3 ED4B0600        20      LD  BC,(RDVDP)
0009F7 49F7 0C               4      INC C
0009F8 49F8 ED79            12      OUT (C),A
0009FA 49FA 3E8F             7      LD  A,08FH
0009FC 49FC ED79            12      OUT (C),A
0009FE 49FE ED78            12      IN  A,(C)
000A00 4A00 C1              10      POP BC
000A01 4A01 C9              10      RET
                                
       4A02                     GET_PIXEL256:
000A02 4A02 7A               4      LD  A,D
000A03 4A03 B3               4      OR  E
000A04 4A04 200A            12      JR  NZ,GET_PIXEL1
000A06 4A06 2ADCF2          16      LD  HL,(_BUF_EN)
000A09 4A09 CD5B4A          17      CALL    ROM_READ
000A0C 4A0C EB               4      EX  DE,HL
000A0D 4A0D 2AD4F2          16      LD  HL,(_DTA)
       4A10                     GET_PIXEL1:
000A10 4A10 7E               7      LD  A,(HL)
000A11 4A11 23               6      INC HL
000A12 4A12 1B               6      DEC DE
000A13 4A13 C9              10      RET
                                
       4A14                     GET_PIXEL:
000A14 4A14 DD7D             9      LD  A,IXL
000A16 4A16 FE08             7      CP  8
000A18 4A18 28E8            12      JR  Z,GET_PIXEL256
000A1A 4A1A 04               4      INC B
000A1B 4A1B FE06             7      CP  6
000A1D 4A1D 282E            12      JR  Z,GET_PIXEL4
                                
000A1F 4A1F CB40             8      BIT 0,B
000A21 4A21 20ED            12      JR  NZ,GET_PIXEL1
                                
000A23 4A23 7A               4      LD  A,D
000A24 4A24 B3               4      OR  E
000A25 4A25 200A            12      JR  NZ,GET_PIXEL2
                                
000A27 4A27 2ADCF2          16      LD  HL,(_BUF_EN)
000A2A 4A2A CD5B4A          17      CALL    ROM_READ
000A2D 4A2D EB               4      EX  DE,HL
000A2E 4A2E 2AD4F2          16      LD  HL,(_DTA)
                                
       4A31                     GET_PIXEL2:
000A31 4A31 7E               7      LD  A,(HL)
000A32 4A32 0F               4      RRCA
000A33 4A33 0F               4      RRCA
000A34 4A34 0F               4      RRCA
000A35 4A35 0F               4      RRCA
000A36 4A36 C9              10      RET
                                
       4A37                     GET_PIXEL3:
000A37 4A37 7A               4      LD  A,D
000A38 4A38 B3               4      OR  E
000A39 4A39 200A            12      JR  NZ,GET_PIXEL5
                                
000A3B 4A3B 2ADCF2          16      LD  HL,(_BUF_EN)
000A3E 4A3E CD5B4A          17      CALL    ROM_READ
000A41 4A41 EB               4      EX  DE,HL
000A42 4A42 2AD4F2          16      LD  HL,(_DTA)
       4A45                     GET_PIXEL5:
000A45 4A45 7E               7      LD  A,(HL)
000A46 4A46 0F               4      RRCA
000A47 4A47 0F               4      RRCA
000A48 4A48 0F               4      RRCA
000A49 4A49 0F               4      RRCA
000A4A 4A4A 0F               4      RRCA
000A4B 4A4B 0F               4      RRCA
000A4C 4A4C C9              10      RET
                                
       4A4D                     GET_PIXEL4:
000A4D 4A4D 78               4      LD  A,B
000A4E 4A4E E603             7      AND 3   ;+0
000A50 4A50 28E5            12      JR  Z,GET_PIXEL3
000A52 4A52 3D               4      DEC A   ;+1
000A53 4A53 28DC            12      JR  Z,GET_PIXEL2
000A55 4A55 3D               4      DEC A   ;+2
000A56 4A56 7E               7      LD  A,(HL)
000A57 4A57 C0              11      RET NZ
000A58 4A58 0F               4      RRCA        ;+3
000A59 4A59 0F               4      RRCA
000A5A 4A5A C9              10      RET
                                
       4A5B                     ROM_READ:
000A5B 4A5B E5              11      PUSH    HL
000A5C 4A5C D5              11      PUSH    DE
000A5D 4A5D C5              11      PUSH    BC
000A5E 4A5E FDE5            15      PUSH    IY
000A60 4A60 22F0F2          16      LD  (LEFTX),HL
000A63 4A63 2AD4F2          16      LD  HL,(_DTA)
000A66 4A66 22E7F2          16      LD  (DTAX),HL
000A69 4A69 2AF0F2          16      LD  HL,(LEFTX)
                                
000A6C 4A6C CD0F4D          17      CALL    RBX1
000A6F 4A6F 3870            12      JR  C,RBRERR1
000A71 4A71 79               4      LD  A,C
000A72 4A72 EB               4      EX  DE,HL
000A73 4A73 ED52            15      SBC HL,DE       ;CP 0HL,CDE
000A75 4A75 19              11      ADD HL,DE
000A76 4A76 DE00             7      SBC A,000H
000A78 4A78 3801            12      JR  C,RBR1
000A7A 4A7A EB               4      EX  DE,HL
       4A7B                     RBR1:
000A7B 4A7B 9F               4      SBC A,A
000A7C 4A7C E601             7      AND 1
000A7E 4A7E 32C3F2          13      LD  (_RESULT),A
000A81 4A81 7C               4      LD  A,H
000A82 4A82 B5               4      OR  L
000A83 4A83 CAD74A          10      JP  Z,RBREND0
                                
000A86 4A86 22D0F2          16      LD  (_LEFT),HL  ;Read record byte
000A89 4A89 22F0F2          16      LD  (LEFTX),HL
                                
000A8C 4A8C CD424D          17      CALL    RBX2
000A8F 4A8F 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000A91 4A91 CD554D          17      CALL    RBXA
000A94 4A94 DAED4A          10      JP  C,RBRERR
000A97 4A97 C5              11      PUSH    BC
000A98 4A98 CD3144          17      CALL    ROM_LDIR
000A9B 4A9B ED53E7F2        20      LD  (DTAX),DE
000A9F 4A9F 2AF0F2          16      LD  HL,(LEFTX)
000AA2 4AA2 D1              10      POP DE
000AA3 4AA3 A7               4      AND A
000AA4 4AA4 ED52            15      SBC HL,DE
000AA6 4AA6 22F0F2          16      LD  (LEFTX),HL
000AA9 4AA9 2829            12      JR  Z,RBREND
                                
       4AAB                     RBRB:
000AAB 4AAB CD8E4D          17      CALL    RBXB
000AAE 4AAE 2818            12      JR  Z,RBRC
       4AB0                     RBRB1:
000AB0 4AB0 C5              11      PUSH    BC
000AB1 4AB1 D5              11      PUSH    DE
000AB2 4AB2 CD3F4E          17      CALL    CLUST
000AB5 4AB5 EB               4      EX  DE,HL
000AB6 4AB6 ED4BC6F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000ABA 4ABA CD3144          17      CALL    ROM_LDIR
000ABD 4ABD EB               4      EX  DE,HL
000ABE 4ABE D1              10      POP DE
000ABF 4ABF C1              10      POP BC
000AC0 4AC0 CD1C4E          17      CALL    GNCL
000AC3 4AC3 DAED4A          10      JP  C,RBRERR
000AC6 4AC6 10E8            13      DJNZ    RBRB1
       4AC8                     RBRC:
000AC8 4AC8 CDA64D          17      CALL    RBXC
000ACB 4ACB 2807            12      JR  Z,RBREND
                                
000ACD 4ACD CD3F4E          17      CALL    CLUST
000AD0 4AD0 EB               4      EX  DE,HL
000AD1 4AD1 CD3144          17      CALL    ROM_LDIR
       4AD4                     RBREND:
000AD4 4AD4 CDB24D          17      CALL    RBXEND
       4AD7                     RBREND0:
000AD7 4AD7 FDE1            14      POP IY
000AD9 4AD9 C1              10      POP BC
000ADA 4ADA D1              10      POP DE
000ADB 4ADB F1              10      POP AF  ;(HL)
000ADC 4ADC AF               4      XOR A
000ADD 4ADD 3AC3F2          13      LD  A,(_RESULT)
000AE0 4AE0 C9              10      RET
                                
       4AE1                     RBRERR1:
000AE1 4AE1 3E01             7      LD  A,001H
       4AE3                     RBRERR2:
000AE3 4AE3 FDE1            14      POP IY
000AE5 4AE5 C1              10      POP BC
000AE6 4AE6 D1              10      POP DE
000AE7 4AE7 E1              10      POP HL
000AE8 4AE8 37               4      SCF
000AE9 4AE9 210000          10      LD  HL,0
000AEC 4AEC C9              10      RET
       4AED                     RBRERR:
000AED 4AED 3EFF             7      LD  A,0FFH
000AEF 4AEF 18F2            12      JR  RBRERR2
                                
       4AF1                     FILE_DD:
000AF1 4AF1 E1              10      POP HL
000AF2 4AF2 3E                      DB  03EH
000AF3 4AF3 C9              10      RET
000AF4 4AF4 32A3F2          13      LD  (SWC_BLOAD_M),A
       4AF7                     ROM_ORG:
000AF7 4AF7 2AF2F2          16      LD  HL,(PARAM0)
000AFA 4AFA 7E               7      LD  A,(HL)
000AFB 4AFB C9              10      RET
       4AFC                     FILE_B:
000AFC 4AFC AF               4      XOR A
000AFD 4AFD 32F8F2          13      LD  (FDRV),A
000B00 4B00 1E00             7      LD  E,0
000B02 4B02 3A63F6          13      LD  A,(VALTYP)
000B05 4B05 FE03             7      CP  3       ;string
000B07 4B07 C29F4B          10      JP  NZ,FILED
                                
000B0A 4B0A DD21D067        14      LD  IX,FRESTR
000B0E 4B0E FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000B12 4B12 CD1C00          17      CALL    _CALSLT
000B15 4B15 E5              11      PUSH    HL
000B16 4B16 DDE1            14      POP IX
                                
000B18 4B18 DD5E00          19      LD  E,(IX+0)
000B1B 4B1B DD7E01          19      LD  A,(IX+1)
000B1E 4B1E DD5602          19      LD  D,(IX+2)
000B21 4B21 DD62             9      LD  IXH,D
000B23 4B23 DD6F             9      LD  IXL,A
000B25 4B25 7B               4      LD  A,E
       4B26                     FILE_BDOS:
000B26 4B26 FE04             7      CP  4
000B28 4B28 3808            12      JR  C,FILEB1
000B2A 4B2A DD7E03          19      LD  A,(IX+3)
000B2D 4B2D FE3A             7      CP  ':'
000B2F 4B2F 28C0            12      JR  Z,FILE_DD
000B31 4B31 7B               4      LD  A,E
       4B32                     FILEB1:
000B32 4B32 FE02             7      CP  2
000B34 4B34 3818            12      JR  C,DEVI1
000B36 4B36 DD7E01          19      LD  A,(IX+1)
000B39 4B39 FE3A             7      CP  ':'
000B3B 4B3B 2011            12      JR  NZ,DEVI1
000B3D 4B3D DD7E00          19      LD  A,(IX+0)        ;DRIVE
000B40 4B40 CD784C          17      CALL    CAP
000B43 4B43 D640             7      SUB '@'
000B45 4B45 DD23            10      INC IX
000B47 4B47 DD23            10      INC IX
000B49 4B49 1D               4      DEC E
000B4A 4B4A 1D               4      DEC E
000B4B 4B4B 32F8F2          13      LD  (FDRV),A
       4B4E                     DEVI1:
000B4E 4B4E DD7E00          19      LD  A,(IX+0)
000B51 4B51 D65C             7      SUB 05CH        ;\
000B53 4B53 2008            12      JR  NZ,NOROOT
000B55 4B55 6F               4      LD  L,A
000B56 4B56 67               4      LD  H,A
000B57 4B57 22F6F2          16      LD  (_CDX),HL
000B5A 4B5A DD23            10      INC IX
000B5C 4B5C 1D               4      DEC E
       4B5D                     NOROOT:
                                
       4B5D                     SETDIR:
000B5D 4B5D CD9F4B          17      CALL    FILED
000B60 4B60 DD7E00          19      LD  A,(IX+0)
000B63 4B63 FE5C             7      CP  05CH        ;\
000B65 4B65 C0              11      RET NZ
000B66 4B66 DD23            10      INC IX
000B68 4B68 1D               4      DEC E
000B69 4B69 3AF9F2          13      LD  A,(FNAME)
000B6C 4B6C FE20             7      CP  020H        ;. の処理
000B6E 4B6E 28ED            12      JR  Z,SETDIR
                                
000B70 4B70 CD8E4C          17      CALL    ROM_OPEN
000B73 4B73 B7               4      OR  A
000B74 4B74 C0              11      RET NZ
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
000B75 4B75 D5              11      PUSH    DE
000B76 4B76 2AEDF2          16      LD  HL,(DIRENT1)
000B79 4B79 110B00          10      LD  DE,0000BH   ;属性(アトリビュート)
000B7C 4B7C 19              11      ADD HL,DE
000B7D 4B7D CDBE43          17      CALL    RDSLT_ROM
000B80 4B80 D1              10      POP DE
000B81 4B81 CB67             8      BIT 4,A     ;ディレクトリ
                                #else
                                    LD  IY,(DIRENT1)
                                    BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000B83 4B83 C8              11      RET Z
000B84 4B84 CDE64B          17      CALL    FILEI
                                #if exists USE_MORMAL32K_OR_ASCII16
000B87 4B87 D5              11      PUSH    DE
000B88 4B88 2AEDF2          16      LD  HL,(DIRENT1)
000B8B 4B8B 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000B8E 4B8E 19              11      ADD HL,DE
000B8F 4B8F CDBE43          17      CALL    RDSLT_ROM
000B92 4B92 23               6      INC HL
000B93 4B93 5F               4      LD  E,A
000B94 4B94 CDBE43          17      CALL    RDSLT_ROM
000B97 4B97 57               4      LD  D,A
000B98 4B98 EB               4      EX  DE,HL
000B99 4B99 D1              10      POP DE
                                #else
                                    LD  L,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  H,(IY+01BH)
                                #endif
000B9A 4B9A 22F6F2          16      LD  (_CDX),HL
000B9D 4B9D 18BE            12      JR  SETDIR
                                
       4B9F                     FILED:
000B9F 4B9F CDE64B          17      CALL    FILEI
000BA2 4BA2 21F9F2          10      LD  HL,FNAME
                                
000BA5 4BA5 0608             7      LD  B,8
       4BA7                     FILE2:
000BA7 4BA7 CDF34B          17      CALL    CCHKF
000BAA 4BAA C8              11      RET Z
000BAB 4BAB FE2A             7      CP  '*'
000BAD 4BAD 282E            12      JR  Z,FILE9
000BAF 4BAF FE2E             7      CP  '.'
000BB1 4BB1 280C            12      JR  Z,FILE4
000BB3 4BB3 77               7      LD  (HL),A
000BB4 4BB4 23               6      INC HL
000BB5 4BB5 10F0            13      DJNZ    FILE2
                                
       4BB7                     FILE3:
000BB7 4BB7 CDF34B          17      CALL    CCHKF
000BBA 4BBA C8              11      RET Z
000BBB 4BBB FE2E             7      CP  '.'
000BBD 4BBD 20F8            12      JR  NZ,FILE3
                                
       4BBF                     FILE4:
000BBF 4BBF 2101F3          10      LD  HL,FNAME+8
000BC2 4BC2 0603             7      LD  B,3
                                
       4BC4                     FILE4L:
000BC4 4BC4 CDF34B          17      CALL    CCHKF
000BC7 4BC7 C8              11      RET Z
000BC8 4BC8 FE2E             7      CP  '.'
000BCA 4BCA 2008            12      JR  NZ,FILE12
000BCC 4BCC 32F9F2          13      LD  (FNAME),A   ;Parent directory(..)
000BCF 4BCF 32FAF2          13      LD  (FNAME+1),A
000BD2 4BD2 3E20             7      LD  A,020H
       4BD4                     FILE12:
000BD4 4BD4 FE2A             7      CP  '*'
000BD6 4BD6 280A            12      JR  Z,FILE10
000BD8 4BD8 77               7      LD  (HL),A
000BD9 4BD9 23               6      INC HL
000BDA 4BDA 10E8            13      DJNZ    FILE4L
000BDC 4BDC C9              10      RET
                                
       4BDD                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000BDD 4BDD CDE24B          17      CALL    FILE10
000BE0 4BE0 18D5            12      JR  FILE3
                                
       4BE2                     FILE10:
000BE2 4BE2 3E3F             7      LD  A,'?'
000BE4 4BE4 1808            12      JR  FILL_MEMORY
       4BE6                     FILEI:              ;名前＋拡張子をスペースで初期化
000BE6 4BE6 3E20             7      LD  A,020H
000BE8 4BE8 01000B          10      LD  BC,11*256   ;C=0にしておく
000BEB 4BEB 21F9F2          10      LD  HL,FNAME
       4BEE                     FILL_MEMORY:            ;HLからBバイトAで埋める
000BEE 4BEE 77               7      LD  (HL),A
000BEF 4BEF 23               6      INC HL
000BF0 4BF0 10FC            13      DJNZ    FILL_MEMORY
000BF2 4BF2 C9              10      RET
                                
       4BF3                     CCHKF:
000BF3 4BF3 7B               4      LD  A,E
000BF4 4BF4 B7               4      OR  A
000BF5 4BF5 C8              11      RET Z
000BF6 4BF6 DD7E00          19      LD  A,(IX+0)
000BF9 4BF9 CD004C          17      CALL    CCHK2
000BFC 4BFC C8              11      RET Z
000BFD 4BFD C3634C          10      JP  FKAN
                                
       4C00                     CCHK2:
000C00 4C00 0C               4      INC C
000C01 4C01 0D               4      DEC C
000C02 4C02 C0              11      RET NZ
       4C03                     CCHK3:              ;ZF=1 で使えない文字
000C03 4C03 FE2B             7      CP  '+'
000C05 4C05 C8              11      RET Z
000C06 4C06 FE2C             7      CP  ','
000C08 4C08 C8              11      RET Z
000C09 4C09 FE2F             7      CP  '/'
000C0B 4C0B C8              11      RET Z
000C0C 4C0C FE3A             7      CP  ':'
000C0E 4C0E C8              11      RET Z
000C0F 4C0F FE3B             7      CP  ';'
000C11 4C11 C8              11      RET Z
000C12 4C12 FE3D             7      CP  '='
000C14 4C14 C8              11      RET Z
000C15 4C15 FE5C             7      CP  05CH    ;\
000C17 4C17 C8              11      RET Z
000C18 4C18 FE1F             7      CP  01FH
000C1A 4C1A D0              11      RET NC
000C1B 4C1B BF               4      CP  A       ;Z=1
000C1C 4C1C C9              10      RET
                                
       4C1D                     SS1:
000C1D 4C1D 13               6      INC DE
       4C1E                     SPCUT:              ;スペースをカット
000C1E 4C1E 1A               7      LD  A,(DE)
000C1F 4C1F FE20             7      CP  020H
000C21 4C21 28FA            12      JR  Z,SS1
000C23 4C23 C9              10      RET
                                
       4C24                     SCREOF1:
000C24 4C24 13               6      INC DE
       4C25                     SPCUTEX:            ;スペース改行などをカット
000C25 4C25 1A               7      LD  A,(DE)
000C26 4C26 FE20             7      CP  020H
000C28 4C28 28FA            12      JR  Z,SCREOF1
000C2A 4C2A FE0D             7      CP  00DH
000C2C 4C2C 28F6            12      JR  Z,SCREOF1
000C2E 4C2E FE0A             7      CP  00AH
000C30 4C30 28F2            12      JR  Z,SCREOF1
000C32 4C32 FE1A             7      CP  01AH
000C34 4C34 28EE            12      JR  Z,SCREOF1
000C36 4C36 C9              10      RET
                                
       4C37                     GETNUM:
000C37 4C37 210000          10      LD  HL,0
       4C3A                     GETNUM1:
000C3A 4C3A 1A               7      LD  A,(DE)
000C3B 4C3B 13               6      INC DE
000C3C 4C3C D630             7      SUB '0'
000C3E 4C3E D8              11      RET C
000C3F 4C3F FE0A             7      CP  10
000C41 4C41 D0              11      RET NC
000C42 4C42 4D               4      LD  C,L
000C43 4C43 44               4      LD  B,H
000C44 4C44 29              11      ADD HL,HL   ;*2
000C45 4C45 29              11      ADD HL,HL   ;*4
000C46 4C46 09              11      ADD HL,BC   ;*5
000C47 4C47 29              11      ADD HL,HL   ;*10
000C48 4C48 4F               4      LD  C,A
000C49 4C49 0600             7      LD  B,0
000C4B 4C4B 09              11      ADD HL,BC
000C4C 4C4C 18EC            12      JR  GETNUM1
                                
       4C4E                     SEARCH_END:
000C4E 4C4E 7E               7      LD  A,(HL)
       4C4F                     SEARCH_END1:
000C4F 4C4F 23               6      INC HL
000C50 4C50 B7               4      OR  A
000C51 4C51 C8              11      RET Z
000C52 4C52 FE3A             7      CP  ':'
000C54 4C54 20F8            12      JR  NZ,SEARCH_END
000C56 4C56 7E               7      LD  A,(HL)
000C57 4C57 FE3A             7      CP  ':'
000C59 4C59 28F4            12      JR  Z,SEARCH_END1
000C5B 4C5B C9              10      RET
                                
       4C5C                     FKANC:
000C5C 4C5C CB41             8      BIT 0,C
000C5E 4C5E CC814C          17      CALL    Z,CAP2
000C61 4C61 1803            12      JR  FKANX
       4C63                     FKAN:           ;漢字チェック
000C63 4C63 DD23            10      INC IX
000C65 4C65 1D               4      DEC E
       4C66                     FKANX:
000C66 4C66 CB41             8      BIT 0,C
000C68 4C68 CB81             8      RES 0,C
000C6A 4C6A C0              11      RET NZ
000C6B 4C6B FE80             7      CP  080H
000C6D 4C6D D8              11      RET C
000C6E 4C6E FEA0             7      CP  0A0H
000C70 4C70 3803            12      JR  C,FKAN1
000C72 4C72 FEE0             7      CP  0E0H
000C74 4C74 D8              11      RET C
       4C75                     FKAN1:
000C75 4C75 0C               4      INC C
000C76 4C76 A7               4      AND A
000C77 4C77 C9              10      RET
                                
       4C78                     CAP:
000C78 4C78 FE61             7      CP  'a'
000C7A 4C7A D8              11      RET C
000C7B 4C7B FE7B             7      CP  'z'+1
000C7D 4C7D D0              11      RET NC
000C7E 4C7E D620             7      SUB 020H
000C80 4C80 C9              10      RET
       4C81                     CAP2:
000C81 4C81 CD784C          17      CALL    CAP
       4C84                     CAP3:               ;
000C84 4C84 FE05             7      CP  5
000C86 4C86 2803            12      JR  Z,CAP4
000C88 4C88 FE21             7      CP  021H
000C8A 4C8A C9              10      RET
       4C8B                     CAP4:
000C8B 4C8B 3EE5             7      LD  A,0E5H
000C8D 4C8D C9              10      RET
                                
       4C8E                     ROM_OPEN:
000C8E 4C8E CD9053          17      CALL    GET_DISK_BANK_FDRV
                                
000C91 4C91 CDEA4E          17      CALL    GET_DIR_DAT
000C94 4C94 D5              11      PUSH    DE
000C95 4C95 CDAA4C          17      CALL    FILESE
000C98 4C98 D1              10      POP DE
000C99 4C99 3F               4      CCF
000C9A 4C9A D8              11      RET C
000C9B 4C9B 22EDF2          16      LD  (DIRENT1),HL
000C9E 4C9E E5              11      PUSH    HL
000C9F 4C9F 210000          10      LD  HL,0
000CA2 4CA2 22CAF2          16      LD  (RR_LOW),HL
000CA5 4CA5 22CCF2          16      LD  (RR_HIGH),HL
000CA8 4CA8 E1              10      POP HL
000CA9 4CA9 C9              10      RET
                                
       4CAA                     FILESE:
       4CAA                     FILESE0:
                                #if exists USE_MORMAL32K_OR_ASCII16
000CAA 4CAA CDBE43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000CAD 4CAD B7               4      OR  A
000CAE 4CAE C8              11      RET Z       ;END:ZF=1 CF=0
000CAF 4CAF FEE5             7      CP  0E5H
000CB1 4CB1 280D            12      JR  Z,FILESE1
000CB3 4CB3 11F9F2          10      LD  DE,FNAME
000CB6 4CB6 E5              11      PUSH    HL
000CB7 4CB7 CDE64C          17      CALL    CPFILE
000CBA 4CBA CC094D          17      CALL    Z,CPFILE2
000CBD 4CBD E1              10      POP HL
000CBE 4CBE 37               4      SCF
000CBF 4CBF C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4CC0                     FILESE1:
000CC0 4CC0 CDC84C          17      CALL    FNEXT
000CC3 4CC3 20E5            12      JR  NZ,FILESE0
000CC5 4CC5 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000CC7 4CC7 C9              10      RET
                                
       4CC8                     FNEXT:
000CC8 4CC8 112000          10      LD  DE,020H
000CCB 4CCB 19              11      ADD HL,DE
000CCC 4CCC ED5BF6F2        20      LD  DE,(_CDX)
000CD0 4CD0 7A               4      LD  A,D
000CD1 4CD1 B3               4      OR  E
000CD2 4CD2 2002            12      JR  NZ,FNEXT_SUBDIR
000CD4 4CD4 0D               4      DEC C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
                                    PUSH    AF      ;※フラグを保存する必要あり
                                    BIT 7,H
                                    JR  Z,CHECK_DIR_PAGE1
                                    LD  A,H
                                    SUB 020H
                                    LD  H,A
                                    LD  A,(_DIR_BANK)
                                    INC A
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_DIR_BANK),A
                                CHECK_DIR_PAGE1:
                                    POP AF
                                #endif
000CD5 4CD5 C9              10      RET
                                
       4CD6                     FNEXT_SUBDIR:           ;サブディレクトリ
000CD6 4CD6 0D               4      DEC C
000CD7 4CD7 C0              11      RET NZ
                                
000CD8 4CD8 ED5BF6F2        20      LD  DE,(_CDX)
000CDC 4CDC CD1C4E          17      CALL    GNCL
000CDF 4CDF EB               4      EX  DE,HL
000CE0 4CE0 22F6F2          16      LD  (_CDX),HL
000CE3 4CE3 C3234F          10      JP  GET_SUBDIR
                                
       4CE6                     CPFILE:
000CE6 4CE6 C5              11      PUSH    BC
000CE7 4CE7 01000B          10      LD  BC,00B00H
       4CEA                     CPSTR1:
000CEA 4CEA 1A               7      LD  A,(DE)
000CEB 4CEB FE3F             7      CP  '?'     ;Wild card
000CED 4CED 2814            12      JR  Z,CPSTR2
                                #if exists USE_MORMAL32K_OR_ASCII16
000CEF 4CEF CDBE43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000CF2 4CF2 CD5C4C          17      CALL    FKANC
000CF5 4CF5 E5              11      PUSH    HL
000CF6 4CF6 67               4      LD  H,A
000CF7 4CF7 1A               7      LD  A,(DE)
000CF8 4CF8 CB01             8      RLC C
000CFA 4CFA CD5C4C          17      CALL    FKANC
000CFD 4CFD CB09             8      RRC C
000CFF 4CFF BC               4      CP  H       ;CP (HL),(DE)
000D00 4D00 E1              10      POP HL
000D01 4D01 2004            12      JR  NZ,CPSTR3
       4D03                     CPSTR2:
000D03 4D03 13               6      INC DE
000D04 4D04 23               6      INC HL
000D05 4D05 10E3            13      DJNZ    CPSTR1
       4D07                     CPSTR3:
000D07 4D07 C1              10      POP BC
000D08 4D08 C9              10      RET
                                
       4D09                     CPFILE2:
                                #if exists USE_MORMAL32K_OR_ASCII16
000D09 4D09 CDBE43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000D0C 4D0C E608             7      AND 008H    ;~0F7H
000D0E 4D0E C9              10      RET
                                
       4D0F                     RBX1:
000D0F 4D0F E5              11      PUSH    HL      ;Record byte
                                
000D10 4D10 ED5BCAF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000D14 4D14 3ACDF2          13      LD  A,(RR_HIGH+1)
000D17 4D17 4F               4      LD  C,A
                                
000D18 4D18 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
000D1B 4D1B 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
000D1E 4D1E D5              11      PUSH    DE
000D1F 4D1F 2AEDF2          16      LD  HL,(DIRENT1)
000D22 4D22 111C00          10      LD  DE,0001CH
000D25 4D25 19              11      ADD HL,DE
000D26 4D26 CDBE43          17      CALL    RDSLT_ROM
000D29 4D29 23               6      INC HL
000D2A 4D2A 5F               4      LD  E,A
000D2B 4D2B CDBE43          17      CALL    RDSLT_ROM
000D2E 4D2E 23               6      INC HL
000D2F 4D2F 57               4      LD  D,A
000D30 4D30 CDBE43          17      CALL    RDSLT_ROM
000D33 4D33 EB               4      EX  DE,HL       ;AHL=File size
000D34 4D34 D1              10      POP DE
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  L,(IY+01CH) ;AHL=File size
                                    LD  H,(IY+01DH)
                                    LD  A,(IY+01EH)
                                #endif
                                
000D35 4D35 A7               4      AND A
000D36 4D36 ED52            15      SBC HL,DE
000D38 4D38 99               4      SBC A,C
000D39 4D39 D1              10      POP DE
                                
000D3A 4D3A D8              11      RET C
000D3B 4D3B 4F               4      LD  C,A
000D3C 4D3C EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000D3D 4D3D B2               4      OR  D
000D3E 4D3E B3               4      OR  E
000D3F 4D3F C0              11      RET NZ
000D40 4D40 37               4      SCF
000D41 4D41 C9              10      RET
                                
       4D42                     RBX2:
000D42 4D42 ED4BCBF2        20      LD  BC,(RR_LOW+1)
000D46 4D46 CDC74D          17      CALL    RWXR
000D49 4D49 3AC7F2          13      LD  A,(CLSZ_H)
000D4C 4D4C 3D               4      DEC A
000D4D 4D4D E5              11      PUSH    HL
000D4E 4D4E 2ACAF2          16      LD  HL,(RR_LOW)
000D51 4D51 A4               4      AND H
000D52 4D52 B5               4      OR  L
000D53 4D53 E1              10      POP HL
000D54 4D54 C9              10      RET
                                
       4D55                     RBXA:
000D55 4D55 D5              11      PUSH    DE
000D56 4D56 CD3F4E          17      CALL    CLUST
000D59 4D59 ED53D2F2        20      LD  (_DTPS),DE
000D5D 4D5D D1              10      POP DE
000D5E 4D5E CD1C4E          17      CALL    GNCL
000D61 4D61 D8              11      RET C
000D62 4D62 ED53CEF2        20      LD  (_CLPS),DE
                                
000D66 4D66 ED4BCAF2        20      LD  BC,(RR_LOW)
000D6A 4D6A 2AC6F2          16      LD  HL,(CLSZ)
000D6D 4D6D 7C               4      LD  A,H
000D6E 4D6E 3D               4      DEC A
000D6F 4D6F A0               4      AND B
000D70 4D70 47               4      LD  B,A
000D71 4D71 ED42            15      SBC HL,BC       ;remaining cluster
                                
000D73 4D73 ED5BF0F2        20      LD  DE,(LEFTX)
000D77 4D77 ED52            15      SBC HL,DE       ;CP HL,DE
000D79 4D79 19              11      ADD HL,DE
000D7A 4D7A 3801            12      JR  C,RBXA1
000D7C 4D7C EB               4      EX  DE,HL
       4D7D                     RBXA1:
000D7D 4D7D 3AC4F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_MORMAL32K_OR_ASCII16
000D80 4D80 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000D83 4D83 E5              11      PUSH    HL
000D84 4D84 2AD2F2          16      LD  HL,(_DTPS)
000D87 4D87 09              11      ADD HL,BC
000D88 4D88 ED5BE7F2        20      LD  DE,(DTAX)
000D8C 4D8C C1              10      POP BC
000D8D 4D8D C9              10      RET
                                
       4D8E                     RBXB:
000D8E 4D8E 2AE7F2          16      LD  HL,(DTAX)
000D91 4D91 ED5BCEF2        20      LD  DE,(_CLPS)
000D95 4D95 3AF1F2          13      LD  A,(LEFTX+1)
000D98 4D98 47               4      LD  B,A
000D99 4D99 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4D9C                     RBXB1:
000D9C 4D9C 1F               4      RRA     ;->CF
000D9D 4D9D 3804            12      JR  C,RBXB2
000D9F 4D9F CB38             8      SRL B   ;B=B/2
000DA1 4DA1 18F9            12      JR  RBXB1
       4DA3                     RBXB2:
000DA3 4DA3 78               4      LD  A,B
000DA4 4DA4 B7               4      OR  A
000DA5 4DA5 C9              10      RET
                                
       4DA6                     RBXC:
000DA6 4DA6 ED4BF0F2        20      LD  BC,(LEFTX)
000DAA 4DAA 3AC7F2          13      LD  A,(CLSZ_H)
000DAD 4DAD 3D               4      DEC A
000DAE 4DAE A0               4      AND B
000DAF 4DAF 47               4      LD  B,A
000DB0 4DB0 B1               4      OR  C
000DB1 4DB1 C9              10      RET
                                
       4DB2                     RBXEND:
000DB2 4DB2 ED5BD0F2        20      LD  DE,(_LEFT)
000DB6 4DB6 2ACAF2          16      LD  HL,(RR_LOW)
000DB9 4DB9 3ACDF2          13      LD  A,(RR_HIGH+1)
000DBC 4DBC 19              11      ADD HL,DE
000DBD 4DBD CE00             7      ADC A,0
000DBF 4DBF 22CAF2          16      LD  (RR_LOW),HL
000DC2 4DC2 32CDF2          13      LD  (RR_HIGH+1),A
000DC5 4DC5 EB               4      EX  DE,HL       ;HL=Read byte
000DC6 4DC6 C9              10      RET 
                                
       4DC7                     RWXR:
000DC7 4DC7 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4DCA                     L_RWX:
000DCA 4DCA 1F               4      RRA     ;->CF
000DCB 4DCB 3806            12      JR  C,E_RWX
000DCD 4DCD CB38             8      SRL B   ;BC=BC/2
000DCF 4DCF CB19             8      RR  C   ;
000DD1 4DD1 18F7            12      JR  L_RWX
       4DD3                     E_RWX:
000DD3 4DD3 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
000DD6 4DD6 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
000DD9 4DD9 E5              11      PUSH    HL
000DDA 4DDA 2AEDF2          16      LD  HL,(DIRENT1)
000DDD 4DDD 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000DE0 4DE0 19              11      ADD HL,DE
000DE1 4DE1 CDBE43          17      CALL    RDSLT_ROM
000DE4 4DE4 23               6      INC HL
000DE5 4DE5 5F               4      LD  E,A
000DE6 4DE6 CDBE43          17      CALL    RDSLT_ROM
000DE9 4DE9 23               6      INC HL
000DEA 4DEA 57               4      LD  D,A
000DEB 4DEB E1              10      POP HL
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  E,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  D,(IY+01BH)
                                #endif
000DEC 4DEC CD9053          17      CALL    GET_DISK_BANK_FDRV
       4DEF                     RWX1:
000DEF 4DEF ED53CEF2        20      LD  (_CLPS),DE
000DF3 4DF3 7A               4      LD  A,D
000DF4 4DF4 B3               4      OR  E
000DF5 4DF5 37               4      SCF
000DF6 4DF6 C8              11      RET Z
                                
000DF7 4DF7 78               4      LD  A,B
000DF8 4DF8 B1               4      OR  C
000DF9 4DF9 C8              11      RET Z
                                
000DFA 4DFA CD1C4E          17      CALL    GNCL
000DFD 4DFD D8              11      RET C
000DFE 4DFE 0B               6      DEC BC
000DFF 4DFF CD834E          17      CALL    ENDCL
000E02 4E02 38EB            12      JR  C,RWX1
000E04 4E04 37               4      SCF
000E05 4E05 C9              10      RET
                                
       4E06                     NCL3:
000E06 4E06 CD9053          17      CALL    GET_DISK_BANK_FDRV
000E09 4E09 6B               4      LD  L,E
000E0A 4E0A 62               4      LD  H,D
000E0B 4E0B CB3C             8      SRL H
000E0D 4E0D CB1D             8      RR  L
000E0F 4E0F 1F               4      RRA
000E10 4E10 19              11      ADD HL,DE
000E11 4E11 010060          10      LD  BC,BANK1_ADR
000E14 4E14 09              11      ADD HL,BC
000E15 4E15 ED4BC8F2        20      LD  BC,(SECSZ)
000E19 4E19 09              11      ADD HL,BC
000E1A 4E1A 17               4      RLA
000E1B 4E1B C9              10      RET
                                
       4E1C                     GNCL:
000E1C 4E1C 7A               4      LD  A,D
000E1D 4E1D B3               4      OR  E
000E1E 4E1E 37               4      SCF
000E1F 4E1F C8              11      RET Z
000E20 4E20 C5              11      PUSH    BC
000E21 4E21 E5              11      PUSH    HL
000E22 4E22 CD064E          17      CALL    NCL3
000E25 4E25 3809            12      JR  C,GNC1
000E27 4E27 5E               7      LD  E,(HL)
000E28 4E28 23               6      INC HL
000E29 4E29 7E               7      LD  A,(HL)
000E2A 4E2A E60F             7      AND 00FH
000E2C 4E2C 57               4      LD  D,A
000E2D 4E2D E1              10      POP HL
000E2E 4E2E C1              10      POP BC
000E2F 4E2F C9              10      RET
       4E30                     GNC1:
000E30 4E30 7E               7      LD  A,(HL)
000E31 4E31 23               6      INC HL
000E32 4E32 56               7      LD  D,(HL)
000E33 4E33 0604             7      LD  B,4
       4E35                     GNC1L:
000E35 4E35 CB3A             8      SRL D
000E37 4E37 1F               4      RRA
000E38 4E38 10FB            13      DJNZ    GNC1L
                                
000E3A 4E3A 5F               4      LD  E,A
000E3B 4E3B E1              10      POP HL
000E3C 4E3C C1              10      POP BC
000E3D 4E3D A7               4      AND A
000E3E 4E3E C9              10      RET
                                
       4E3F                     CLUST:
000E3F 4E3F EB               4      EX  DE,HL
       4E40                     CLUST_HL:
000E40 4E40 2B               6      DEC HL
000E41 4E41 2B               6      DEC HL
000E42 4E42 C5              11      PUSH    BC
000E43 4E43 3AC7F2          13      LD  A,(CLSZ_H)
000E46 4E46 CDBD53          17      CALL    MUL_AHL
                                
000E49 4E49 CD044F          17      CALL    GET_DIR_POS
000E4C 4E4C 4F               4      LD  C,A
000E4D 4E4D 0600             7      LD  B,0
000E4F 4E4F 09              11      ADD HL,BC
                                
000E50 4E50 ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
000E54 4E54 CB38             8      SRL B
000E56 4E56 CB19             8      RR  C           ;/2
000E58 4E58 CB38             8      SRL B
000E5A 4E5A CB19             8      RR  C           ;/4
000E5C 4E5C CB38             8      SRL B
000E5E 4E5E CB19             8      RR  C           ;/8
000E60 4E60 09              11      ADD HL,BC
                                #if exists USE_MORMAL32K_OR_ASCII16
000E61 4E61 7D               4      LD  A,L
000E62 4E62 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
000E65 4E65 09              11      ADD HL,BC
000E66 4E66 3013            12      JR  NC,CLUST2
000E68 4E68 4D               4      LD  C,L     ;C=読み出し元
000E69 4E69 29              11      ADD HL,HL   ;64KB→32KB
000E6A 4E6A 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
000E6B 4E6B CD9053          17      CALL    GET_DISK_BANK_FDRV
000E6E 4E6E 84               4      ADD A,H
000E6F 4E6F 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
000E72 4E72 32C4F2          13      LD  (_BANK),A
000E75 4E75 69               4      LD  L,C     ;C=読み出し元
000E76 4E76 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
000E78 4E78 A5               4      AND L
000E79 4E79 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB
                                    ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
                                    AND L
                                #endif
       4E7B                     CLUST2:
000E7B 4E7B C660             7      ADD A,high BANK1_ADR
000E7D 4E7D 67               4      LD  H,A
000E7E 4E7E 2E00             7      LD  L,0
000E80 4E80 EB               4      EX  DE,HL
000E81 4E81 C1              10      POP BC
000E82 4E82 C9              10      RET
                                
       4E83                     ENDCL:
000E83 4E83 7A               4      LD  A,D ;END CLUSTER
000E84 4E84 FE0F             7      CP  00FH    ;FAT12の最大値
000E86 4E86 C0              11      RET NZ
000E87 4E87 7B               4      LD  A,E
000E88 4E88 FEF7             7      CP  0F7H
000E8A 4E8A C9              10      RET
                                
       4E8B                     RB_READ:
000E8B 4E8B AF               4      XOR A   ;HLA = HL*128
000E8C 4E8C CB3C             8      SRL H
000E8E 4E8E CB1D             8      RR  L
000E90 4E90 1F               4      RRA
000E91 4E91 32CAF2          13      LD  (RR_LOW),A
000E94 4E94 22CBF2          16      LD  (RR_MID),HL
000E97 4E97 218000          10      LD  HL,128
                                
000E9A 4E9A CD5B4A          17      CALL    ROM_READ
000E9D 4E9D C9              10      RET
                                
       4E9E                     GETSEQ:
000E9E 4E9E FD6E20          19      LD  L,(IY+32)
000EA1 4EA1 FD660C          19      LD  H,(IY+12)
                                
000EA4 4EA4 CB25             8      SLA L
                                
000EA6 4EA6 CB3C             8      SRL H
000EA8 4EA8 CB1D             8      RR  L
000EAA 4EAA C9              10      RET
                                
       4EAB                     SETSEQ:
000EAB 4EAB F5              11      PUSH    AF
000EAC 4EAC 3ACAF2          13      LD  A,(RR_LOW)
000EAF 4EAF 2ACBF2          16      LD  HL,(RR_MID)
                                
000EB2 4EB2 CDC94E          17      CALL    SSQ1
                                
000EB5 4EB5 29              11      ADD HL,HL
000EB6 4EB6 CB3D             8      SRL L
000EB8 4EB8 FD7520          19      LD  (IY+32),L
000EBB 4EBB FD740C          19      LD  (IY+12),H
000EBE 4EBE F1              10      POP AF
000EBF 4EBF C9              10      RET
                                
       4EC0                     GETSIZE:
000EC0 4EC0 FD7E10          19      LD  A,(IY+16)
000EC3 4EC3 FD6E11          19      LD  L,(IY+17)
000EC6 4EC6 FD6612          19      LD  H,(IY+18)
       4EC9                     SSQ1:
000EC9 4EC9 87               4      ADD A,A
000ECA 4ECA ED6A            15      ADC HL,HL
000ECC 4ECC B7               4      OR  A
000ECD 4ECD C8              11      RET Z
000ECE 4ECE 23               6      INC HL
000ECF 4ECF C9              10      RET
                                
       4ED0                     SET_FCB:
000ED0 4ED0 D5              11      PUSH    DE
000ED1 4ED1 FDE1            14      POP IY
000ED3 4ED3 FD7E1C          19      LD  A,(IY+28)
000ED6 4ED6 FEFF             7      CP  0FFH
000ED8 4ED8 200C            12      JR  NZ,POPAF_SCF_FF_RET
000EDA 4EDA E5              11      PUSH    HL
000EDB 4EDB FD6E1A          19      LD  L,(IY+26)
000EDE 4EDE FD661B          19      LD  H,(IY+27)
000EE1 4EE1 22CEF2          16      LD  (_CLPS),HL
000EE4 4EE4 E1              10      POP HL
000EE5 4EE5 C9              10      RET
                                
       4EE6                     POPAF_SCF_FF_RET:
000EE6 4EE6 F1              10      POP AF
000EE7 4EE7 37               4      SCF
000EE8 4EE8 9F               4      SBC A,A
000EE9 4EE9 C9              10      RET
                                
       4EEA                     GET_DIR_DAT:
000EEA 4EEA 2AF6F2          16      LD  HL,(_CDX)
000EED 4EED 7C               4      LD  A,H
000EEE 4EEE B5               4      OR  L
000EEF 4EEF 2032            12      JR  NZ,GET_SUBDIR
000EF1 4EF1 CD044F          17      CALL    GET_DIR_POS
000EF4 4EF4 C660             7      ADD A,high BANK1_ADR
000EF6 4EF6 2E00             7      LD  L,0
000EF8 4EF8 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                    CALL    CHECK_DIR_PAGE
                                #endif
000EF9 4EF9 3AC5F2          13      LD  A,(_BANK1)
000EFC 4EFC 32EFF2          13      LD  (_DIR_BANK),A
                                
000EFF 4EFF 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000F02 4F02 4F               4      LD  C,A
000F03 4F03 C9              10      RET
                                
       4F04                     GET_DIR_POS:                ;ルートディレクトリ
000F04 4F04 CD9053          17      CALL    GET_DISK_BANK_FDRV
000F07 4F07 32C5F2          13      LD  (_BANK1),A
000F0A 4F0A 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000F0D 4F0D 47               4      LD  B,A
000F0E 4F0E 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000F11 4F11 4F               4      LD  C,A
000F12 4F12 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4F15                     GET_DIR_POS1:
000F15 4F15 81               4      ADD A,C
000F16 4F16 10FD            13      DJNZ    GET_DIR_POS1
                                
000F18 4F18 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
000F1C 4F1C 37               4      SCF     ;無限ループ回避
       4F1D                     L_MDP:
000F1D 4F1D CB18             8      RR  B   ;->CF
000F1F 4F1F D8              11      RET C
000F20 4F20 87               4      ADD A,A
000F21 4F21 18FA            12      JR  L_MDP
                                
       4F23                     GET_SUBDIR:             ;サブディレクトリ
000F23 4F23 CD404E          17      CALL    CLUST_HL
000F26 4F26 EB               4      EX  DE,HL
000F27 4F27 3AC4F2          13      LD  A,(_BANK)
000F2A 4F2A 32EFF2          13      LD  (_DIR_BANK),A
000F2D 4F2D 3AC7F2          13      LD  A,(CLSZ_H)
000F30 4F30 87               4      ADD A,A     ;*2
000F31 4F31 87               4      ADD A,A     ;*4
000F32 4F32 87               4      ADD A,A     ;*8
000F33 4F33 4F               4      LD  C,A
000F34 4F34 C9              10      RET
                                
       4F35                     STATEMENT:
000F35 4F35 11A251          10      LD  DE,STR_CHDIR
000F38 4F38 CD8851          17      CALL    CPPROCNM
000F3B 4F3B 2812            12      JR  Z,_CHDIR
000F3D 4F3D 11A851          10      LD  DE,STR_CHDRV
000F40 4F40 CD8851          17      CALL    CPPROCNM
000F43 4F43 281C            12      JR  Z,_CHDRV
000F45 4F45 11AE51          10      LD  DE,STR_RAMDISK
000F48 4F48 CD8851          17      CALL    CPPROCNM
000F4B 4F4B 2829            12      JR  Z,_RAMDISK
000F4D 4F4D 37               4      SCF
000F4E 4F4E C9              10      RET
       4F4F                     _CHDIR:
000F4F 4F4F 7E               7      LD  A,(HL)
000F50 4F50 FE28             7      CP  '('
000F52 4F52 37               4      SCF
000F53 4F53 C0              11      RET NZ
000F54 4F54 CD0948          17      CALL    INIT_PARAM
000F57 4F57 CDFC4A          17      CALL    FILE_B
000F5A 4F5A CD8A4F          17      CALL    ROM_CD
000F5D 4F5D D0              11      RET NC
000F5E 4F5E C3AF46          10      JP  ERROR_FILE_NOT_FOUND
                                
       4F61                     _CHDRV:
000F61 4F61 7E               7      LD  A,(HL)
000F62 4F62 FE28             7      CP  '('
000F64 4F64 37               4      SCF
000F65 4F65 C0              11      RET NZ
000F66 4F66 CD0948          17      CALL    INIT_PARAM
000F69 4F69 E5              11      PUSH    HL
000F6A 4F6A CDFC4A          17      CALL    FILE_B
000F6D 4F6D E1              10      POP HL
000F6E 4F6E 23               6      INC HL
000F6F 4F6F 3AF8F2          13      LD  A,(FDRV)
000F72 4F72 3D               4      DEC A
000F73 4F73 C3F655          10      JP  _SYS0EX1
                                
       4F76                     _RAMDISK:
000F76 4F76 7E               7      LD  A,(HL)
000F77 4F77 FE28             7      CP  '('
000F79 4F79 37               4      SCF
000F7A 4F7A C0              11      RET NZ
000F7B 4F7B 23               6      INC HL
000F7C 4F7C DD212F54        14      LD  IX,FRMQNT
000F80 4F80 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000F84 4F84 CD1C00          17      CALL    _CALSLT
                                ;   LD  A,(HOKVLD)  ;bit0: 拡張 BIOSの存在
                                ;   CPL
                                ;   AND 1
                                ;   LD  A,D
                                ;   OR  E
                                ;   JP  NZ,ERROR_INTERNAL_ERROR
                                ;   PUSH    HL      ;EXTBIOもDISK BIOSで初期化してそう
                                ;   XOR A
                                ;   LD  DE,0401H    ;D=マッパサポートルチン(4) E=機能番号(1)
                                ;   CALL    EXTBIO
                                ;   POP HL
                                ;   OR  A
                                ;   JP  Z,ERROR_INTERNAL_ERROR
000F87 4F87 23               6      INC HL
000F88 4F88 AF               4      XOR A
000F89 4F89 C9              10      RET
                                
       4F8A                     ROM_CD:
000F8A 4F8A 3AF9F2          13      LD  A,(FNAME)
000F8D 4F8D FE20             7      CP  020H
000F8F 4F8F 2835            12      JR  Z,CD1
000F91 4F91 CD8E4C          17      CALL    ROM_OPEN
000F94 4F94 D8              11      RET C
                                #if exists USE_MORMAL32K_OR_ASCII16
000F95 4F95 D5              11      PUSH    DE
000F96 4F96 2AEDF2          16      LD  HL,(DIRENT1)
000F99 4F99 110B00          10      LD  DE,0000BH   ;属性(アトリビュート)
000F9C 4F9C 19              11      ADD HL,DE
000F9D 4F9D CDBE43          17      CALL    RDSLT_ROM
000FA0 4FA0 D1              10      POP DE
000FA1 4FA1 CB67             8      BIT 4,A     ;ディレクトリ
000FA3 4FA3 CAAF46          10      JP  Z,ERROR_FILE_NOT_FOUND
000FA6 4FA6 D5              11      PUSH    DE
000FA7 4FA7 2AEDF2          16      LD  HL,(DIRENT1)
000FAA 4FAA 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000FAD 4FAD 19              11      ADD HL,DE
000FAE 4FAE CDBE43          17      CALL    RDSLT_ROM
000FB1 4FB1 23               6      INC HL
000FB2 4FB2 5F               4      LD  E,A
000FB3 4FB3 CDBE43          17      CALL    RDSLT_ROM
000FB6 4FB6 57               4      LD  D,A
000FB7 4FB7 EB               4      EX  DE,HL
000FB8 4FB8 D1              10      POP DE
                                #else
                                    LD  IY,(DIRENT1)
                                    BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    LD  L,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  H,(IY+01BH)
                                #endif
       4FB9                     CD2:
000FB9 4FB9 22EBF2          16      LD  (_CD),HL
000FBC 4FBC 2AF4F2          16      LD  HL,(PARAM1)
       4FBF                     CD_SKIP:
000FBF 4FBF 7E               7      LD  A,(HL)
000FC0 4FC0 23               6      INC HL
000FC1 4FC1 FE21             7      CP  021H
000FC3 4FC3 38FA            12      JR  C,CD_SKIP
000FC5 4FC5 C9              10      RET
       4FC6                     CD1:
000FC6 4FC6 2AF6F2          16      LD  HL,(_CDX)
000FC9 4FC9 18EE            12      JR  CD2
                                
       4FCB                     GET_BASIC_FCB:
000FCB 4FCB D5              11      PUSH    DE
000FCC 4FCC 23               6      INC HL  ;+1
000FCD 4FCD 5E               7      LD  E,(HL)  ;FCB[1]
000FCE 4FCE 23               6      INC HL  ;+2
000FCF 4FCF 56               7      LD  D,(HL)  ;FCB[2]
000FD0 4FD0 23               6      INC HL  ;+3
000FD1 4FD1 ED53EDF2        20      LD  (DIRENT1),DE
                                            ;FCB[3] backup char
000FD5 4FD5 23               6      INC HL  ;+4
                                            ;FCB[4]
000FD6 4FD6 23               6      INC HL  ;+5
000FD7 4FD7 7E               7      LD  A,(HL)  ;FCB[5]
000FD8 4FD8 23               6      INC HL  ;+6
000FD9 4FD9 32EFF2          13      LD  (_DIR_BANK),A
000FDC 4FDC 5E               7      LD  E,(HL)  ;FCB[6]
000FDD 4FDD 23               6      INC HL  ;+7
000FDE 4FDE 56               7      LD  D,(HL)  ;FCB[7]
000FDF 4FDF 23               6      INC HL  ;+8
000FE0 4FE0 ED53CAF2        20      LD  (RR_LOW),DE
000FE4 4FE4 7E               7      LD  A,(HL)  ;FCB[8]
000FE5 4FE5 23               6      INC HL  ;+9
000FE6 4FE6 32CCF2          13      LD  (RR_HIGH),A
000FE9 4FE9 22D4F2          16      LD  (_DTA),HL   ;FCB[9]
000FEC 4FEC D1              10      POP DE
000FED 4FED C9              10      RET
                                
       4FEE                     SET_BASIC_FCB:
000FEE 4FEE E5              11      PUSH    HL
000FEF 4FEF 2A64F8          16      LD  HL,(PTRFIL)
000FF2 4FF2 23               6      INC HL  ;+1
000FF3 4FF3 D5              11      PUSH    DE
000FF4 4FF4 ED5BEDF2        20      LD  DE,(DIRENT1)
000FF8 4FF8 73               7      LD  (HL),E  ;FCB[1]
000FF9 4FF9 23               6      INC HL  ;+2
000FFA 4FFA 72               7      LD  (HL),D  ;FCB[2]
000FFB 4FFB 23               6      INC HL  ;+3
000FFC 4FFC 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
000FFD 4FFD 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
000FFE 4FFE 23               6      INC HL  ;+5
000FFF 4FFF 3AEFF2          13      LD  A,(_DIR_BANK)
001002 5002 77               7      LD  (HL),A  ;FCB[5]
001003 5003 23               6      INC HL  ;+6
001004 5004 ED5BCAF2        20      LD  DE,(RR_LOW)
001008 5008 73               7      LD  (HL),E  ;FCB[6]
001009 5009 23               6      INC HL  ;+7
00100A 500A 72               7      LD  (HL),D  ;FCB[7]
00100B 500B 23               6      INC HL  ;+8
00100C 500C 3ACCF2          13      LD  A,(RR_HIGH)
00100F 500F 77               7      LD  (HL),A  ;FCB[8]
001010 5010 D1              10      POP DE
001011 5011 E1              10      POP HL
001012 5012 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_18:BACKUP
                                ;in
                                ;   C : backup charactor
                                ;   HL: FBC pointer
                                ;out
       5013                     DEVICE_18_BACKUP:
001013 5013 D5              11      PUSH    DE
001014 5014 E5              11      PUSH    HL
001015 5015 110300          10      LD  DE,3
001018 5018 19              11      ADD HL,DE
001019 5019 71               7      LD  (HL),C
00101A 501A E1              10      POP HL
00101B 501B D1              10      POP DE
00101C 501C C9              10      RET
                                
       501D                     DEVICE_CHECK:
00101D 501D 3A8AFD          13      LD  A,(PROCNM+1)
001020 5020 B7               4      OR  A
001021 5021 C8              11      RET Z
001022 5022 11B651          10      LD  DE,STR_ROM
001025 5025 CD8851          17      CALL    CPPROCNM
001028 5028 2802            12      JR  Z,DEVICE_OK
00102A 502A 37               4      SCF
00102B 502B C9              10      RET
       502C                     DEVICE_OK:
00102C 502C AF               4      XOR A
00102D 502D C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファ
                                
       502E                     DEVICE_0_OPEN:
00102E 502E 7B               4      LD  A,E
00102F 502F FE02             7      CP  2       ;FOR OUTPUT
001031 5031 281B            12      JR  Z,OPEN2
001033 5033 D5              11      PUSH    DE
001034 5034 E5              11      push    hl
                                ;
001035 5035 3E01             7      LD  A,1     ;ドライブA
001037 5037 32F8F2          13      LD  (FDRV),A
00103A 503A 2166F8          10      LD  HL,FILNAM
00103D 503D 11F9F2          10      LD  DE,FNAME
001040 5040 010B00          10      LD  BC,8+3
001043 5043 CD7357          17      CALL    INIT_FILE1
001046 5046 CD8E4C          17      CALL    ROM_OPEN
001049 5049 DAAF46          10      JP  C,ERROR_FILE_NOT_FOUND
00104C 504C E1              10      pop hl
00104D 504D D1              10      POP DE
       504E                     OPEN2:
00104E 504E 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
001051 5051 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
001052 5052 AF               4      XOR A
001053 5053 32F0F2          13      LD  (LEFTX),A
001056 5056 CDEE4F          17      CALL    SET_BASIC_FCB
001059 5059 7B               4      ld  a,e
00105A 505A FE08             7      cp  8
00105C 505C 3F               4      ccf
00105D 505D C9              10      ret
                                
       505E                     DEVICE_2_CLOSE:
00105E 505E AF               4      XOR A
                                ;   LD  (HL),A
00105F 505F 6F               4      LD  L,A
001060 5060 67               4      LD  H,A
001061 5061 2264F8          16      LD  (PTRFIL),HL
001064 5064 C9              10      RET
                                
       5065                     DEVICE_ENTRY:
001065 5065 FE08             7      CP  8
001067 5067 2826            12      JR  Z,DEVICE_8_SIN
001069 5069 3C               4      INC A
00106A 506A 28B1            12      JR  Z,DEVICE_CHECK:
00106C 506C 3D               4      DEC A
00106D 506D 28BF            12      JR  Z,DEVICE_0_OPEN
00106F 506F FE0E             7      CP  14
001071 5071 2860            12      JR  Z,DEVICE_14_EOF
001073 5073 FE04             7      CP  4
001075 5075 2834            12      JR  Z,DEVICE_4_RANDOM
001077 5077 FE0A             7      CP  10
001079 5079 2850            12      JR  Z,DEVICE_10_LOC
00107B 507B FE0C             7      CP  12
00107D 507D 2878            12      JR  Z,DEVICE_12_LOF
00107F 507F FE02             7      CP  2
001081 5081 2890            12      JR  Z,DEVICE_18_BACKUP  
001083 5083 FE02             7      CP  2
001085 5085 28D7            12      JR  Z,DEVICE_2_CLOSE
001087 5087 FE06             7      CP  6
001089 5089 2802            12      JR  Z,DEVICE_6_SOUT
00108B 508B 37               4      SCF
00108C 508C C9              10      RET
                                
       508D                     DEVICE_6_SOUT:
00108D 508D AF               4      XOR A
00108E 508E C9              10      RET
                                
       508F                     DEVICE_8_SIN:
00108F 508F CDCB4F          17      CALL    GET_BASIC_FCB
001092 5092 210100          10      LD  HL,1
001095 5095 CD5B4A          17      CALL    ROM_READ
001098 5098 7C               4      LD  A,H
001099 5099 B5               4      OR  L
00109A 509A 280D            12      JR  Z,CCF_RET
00109C 509C 2AD4F2          16      LD  HL,(_DTA)
00109F 509F 7E               7      LD  A,(HL)
0010A0 50A0 F5              11      PUSH    AF
0010A1 50A1 CDEE4F          17      CALL    SET_BASIC_FCB
0010A4 50A4 F1              10      POP AF
0010A5 50A5 FE0A             7      CP  00AH
0010A7 50A7 C8              11      RET Z   ;ZF=separate
                                ;   CP  01AH
                                ;   JR  Z,SCF_RET
0010A8 50A8 37               4      SCF     ;
       50A9                     CCF_RET:
0010A9 50A9 3F               4      CCF     ;ZF=0 CF=0にしたい
0010AA 50AA C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_4:RANDOM
                                ;in
                                ;   A : 4
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
       50AB                     DEVICE_4_RANDOM:
0010AB 50AB D5              11      PUSH    DE
0010AC 50AC CDCB4F          17      CALL    GET_BASIC_FCB
0010AF 50AF DDE5            15      PUSH    IX
0010B1 50B1 DD218A2F        14      LD  IX,FRCINT
0010B5 50B5 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0010B9 50B9 CDB1F2          17      CALL    CAL_MP
0010BC 50BC DDE1            14      POP IX
0010BE 50BE 2AF8F7          16      LD  HL,(DACDAT)
0010C1 50C1 22CAF2          16      LD  (RR_LOW),HL
0010C4 50C4 AF               4      XOR A
0010C5 50C5 CDEE4F          17      CALL    SET_BASIC_FCB
0010C8 50C8 D1              10      POP DE
0010C9 50C9 AF               4      XOR A
0010CA 50CA C9              10      RET
                                
                                ;FUNC_10:LOC
                                ;in
                                ;   A : 10
                                ;out
                                ;   DAC    : value of received bytes
                                ;   VALTYP : DAC type
       50CB                     DEVICE_10_LOC:
0010CB 50CB CDCB4F          17      CALL    GET_BASIC_FCB
0010CE 50CE 2ACAF2          16      LD  HL,(RR_LOW)
0010D1 50D1 1844            12      JR  RETURN_TYPE8_AHL
                                
                                ;--------------------------------------
                                ;FUNC_14:EOF
                                ;in
                                ;   A : 14
                                ;out
                                ;   DAC    : value of EOF value (EOF=-1)
                                ;   VALTYP : DAC type
       50D3                     DEVICE_14_EOF:
0010D3 50D3 CDCB4F          17      CALL    GET_BASIC_FCB
0010D6 50D6 CD0F4D          17      CALL    RBX1
0010D9 50D9 3810            12      JR  C,DEVICE_14_EOF1
0010DB 50DB 210100          10      LD  HL,1
0010DE 50DE CD5B4A          17      CALL    ROM_READ
0010E1 50E1 2AD4F2          16      LD  HL,(_DTA)
0010E4 50E4 7E               7      LD  A,(HL)
0010E5 50E5 FE1A             7      CP  01AH
0010E7 50E7 37               4      SCF
0010E8 50E8 2801            12      JR  Z,DEVICE_14_EOF1
0010EA 50EA 3F               4      CCF
       50EB                     DEVICE_14_EOF1:
0010EB 50EB 9F               4      SBC A,A
0010EC 50EC 6F               4      LD  L,A
0010ED 50ED 67               4      LD  H,A
       50EE                     return_type2_hl:
0010EE 50EE 22F8F7          16      ld  (DACDAT),hl
0010F1 50F1 3E02             7      ld  a,2
0010F3 50F3 3263F6          13      ld  (VALTYP),a
0010F6 50F6 C9              10      ret
                                
                                ;--------------------------------------
                                ;FUNC_16:FPOS
                                ;in
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
                                ;   illegal function call
                                
                                ;--------------------------------------
                                ;FUNC_12:LOF
                                ;in
                                ;   A : 12
                                ;out
                                ;   DAC    : value of LOC+RSIQLN
                                ;   VALTYP : DAC type
       50F7                     DEVICE_12_LOF:
0010F7 50F7 CDCB4F          17      CALL    GET_BASIC_FCB
                                
0010FA 50FA 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
0010FD 50FD 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
001100 5100 D5              11      PUSH    DE
001101 5101 2AEDF2          16      LD  HL,(DIRENT1)
001104 5104 111C00          10      LD  DE,0001CH
001107 5107 19              11      ADD HL,DE
001108 5108 CDBE43          17      CALL    RDSLT_ROM
00110B 510B 23               6      INC HL
00110C 510C 5F               4      LD  E,A
00110D 510D CDBE43          17      CALL    RDSLT_ROM
001110 5110 23               6      INC HL
001111 5111 57               4      LD  D,A
001112 5112 CDBE43          17      CALL    RDSLT_ROM
001115 5115 EB               4      EX  DE,HL       ;AHL=File size
001116 5116 D1              10      POP DE
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  L,(IY+01CH) ;AHL=File size
                                    LD  H,(IY+01DH)
                                    LD  A,(IY+01EH)
                                #endif
       5117                     RETURN_TYPE8_AHL:
001117 5117 B7               4      OR  A
001118 5118 2004            12      JR  NZ,RT8AHL1
00111A 511A CB7C             8      BIT 7,H
00111C 511C 28D0            12      JR  Z,return_type2_hl
       511E                     RT8AHL1:
00111E 511E E5              11      PUSH    HL
00111F 511F 29              11      ADD HL,HL
001120 5120 8F               4      ADC A,A
001121 5121 32F8F7          13      LD  (DACDAT),A
001124 5124 3E00             7      LD  A,0
001126 5126 8F               4      ADC A,A
001127 5127 32F9F7          13      LD  (DACDAT+1),A
                                
00112A 512A 3E02             7      LD  A,2
00112C 512C 3263F6          13      LD  (VALTYP),A
00112F 512F DD213A30        14      LD  IX,FRCDBL
001133 5133 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001137 5137 CDB1F2          17      CALL    CAL_MP
                                
00113A 513A 218051          10      LD  HL,DBL32768
00113D 513D 1147F8          10      LD  DE,ARG
001140 5140 010800          10      LD  BC,8
001143 5143 EDB0                    LDIR
                                
001145 5145 DD21E627        14      LD  IX,DECMUL
001149 5149 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00114D 514D CDB1F2          17      CALL    CAL_MP
                                
001150 5150 21F6F7          10      LD  HL,DAC
001153 5153 1147F8          10      LD  DE,ARG
001156 5156 010800          10      LD  BC,8
001159 5159 EDB0                    LDIR
                                
00115B 515B E1              10      POP HL
00115C 515C 22F8F7          16      LD  (DACDAT),HL
                                
00115F 515F 3E02             7      LD  A,2
001161 5161 3263F6          13      LD  (VALTYP),A
001164 5164 DD213A30        14      LD  IX,FRCDBL
001168 5168 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00116C 516C CDB1F2          17      CALL    CAL_MP
                                
00116F 516F DD219A26        14      LD  IX,DECADD
001173 5173 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001177 5177 CDB1F2          17      CALL    CAL_MP
                                
00117A 517A 3E08             7      LD  A,8
00117C 517C 3263F6          13      LD  (VALTYP),A
00117F 517F C9              10      RET
                                
       5180                     DBL32768:
001180 5180 4532768000000000        DB  045H,032H,076H,080H,0,0,0,0
                                
       5188                     CPPROCNM:
001188 5188 E5              11      PUSH    HL
001189 5189 2189FD          10      LD  HL,PROCNM
       518C                     CPPROCNM1:
00118C 518C 1A               7      LD  A,(DE)
00118D 518D 13               6      INC DE
00118E 518E BE               7      CP  (HL)
00118F 518F 23               6      INC HL
001190 5190 2003            12      JR  NZ,CPPROCNM2
001192 5192 B7               4      OR  A
001193 5193 20F7            12      JR  NZ,CPPROCNM1
       5195                     CPPROCNM2:
001195 5195 E1              10      POP HL
001196 5196 C9              10      RET
                                
       5197                     WILDCARD:
001197 5197 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       51A2                     STR_CHDIR:
0011A2 51A2 434844495200            DB  "CHDIR",0
       51A8                     STR_CHDRV:
0011A8 51A8 434844525600            DB  "CHDRV",0
       51AE                     STR_RAMDISK:
0011AE 51AE 52414D4449534B00        DB  "RAMDISK",0
       51B6                     STR_ROM:
0011B6 51B6 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       51BA                     ERROR_WRITE_PROTECTED:
0011BA 51BA 3E00             7      LD  A,0     ;Write protected
0011BC 51BC C9              10      RET
       51BD                     DISKIO:
0011BD 51BD 38FB            12      JR  C,ERROR_WRITE_PROTECTED
0011BF 51BF 48               4      LD  C,B
0011C0 51C0 CD9A53          17      CALL    GET_DISK_BANK
       51C3                     SETMAP1:        
0011C3 51C3 E5              11      PUSH    HL
       51C4                     DISKIO1:
0011C4 51C4 C5              11      PUSH    BC      ;B=残りのセクタ数
0011C5 51C5 D5              11      PUSH    DE      ;DE=セクタ番号
0011C6 51C6 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
0011C7 51C7 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
0011C8 51C8 F5              11      PUSH    AF
0011C9 51C9 3AC9F2          13      LD  A,(SECSZ_H)
0011CC 51CC CDBD53          17      CALL    MUL_AHL
0011CF 51CF F1              10      POP AF
                                #if exists USE_MORMAL32K_OR_ASCII16
0011D0 51D0 7D               4      LD  A,L
0011D1 51D1 C5              11      PUSH    BC
0011D2 51D2 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
0011D5 51D5 09              11      ADD HL,BC
0011D6 51D6 C1              10      POP BC
0011D7 51D7 3013            12      JR  NC,DISKIO2
0011D9 51D9 4D               4      LD  C,L     ;C=読み出し元
0011DA 51DA 29              11      ADD HL,HL   ;64KB→32KB
0011DB 51DB 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
0011DC 51DC CD9053          17      CALL    GET_DISK_BANK_FDRV
0011DF 51DF 84               4      ADD A,H
0011E0 51E0 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
0011E3 51E3 32C4F2          13      LD  (_BANK),A
0011E6 51E6 69               4      LD  L,C     ;C=読み出し元
0011E7 51E7 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
0011E9 51E9 A5               4      AND L
0011EA 51EA C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL       ;64KB→32KB
                                    ADD HL,HL       ;32KB→16KB
                                    ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  A,C     ;C=読み出し元
                                    AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       51EC                     DISKIO2:
0011EC 51EC C660             7      ADD A,high BANK1_ADR
0011EE 51EE 67               4      LD  H,A
0011EF 51EF ED4BC8F2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
0011F3 51F3 69               4      LD  L,C     ;C=0
0011F4 51F4 CD3144          17      CALL    ROM_LDIR
0011F7 51F7 EB               4      EX  DE,HL
0011F8 51F8 F1              10      POP AF
0011F9 51F9 D1              10      POP DE
0011FA 51FA 13               6      INC DE
0011FB 51FB C1              10      POP BC
0011FC 51FC 10C6            13      DJNZ    DISKIO1
0011FE 51FE 41               4      LD  B,C
                                
0011FF 51FF E1              10      POP HL
001200 5200 AF               4      XOR A
                                
001201 5201 FB               4      EI
001202 5202 C9              10      RET
                                
       5203                     DSKCHG:
001203 5203 CD3C52          17      CALL    IS_BPB
001206 5206 3824            12      JR  C,NOTREADY
001208 5208 3A23FB          13      LD  A,(DRVTBL+2)
00120B 520B B7               4      OR  A
00120C 520C 201A            12      JR  NZ,DSKCHG1
00120E 520E 3A21FB          13      LD  A,(DRVTBL)
001211 5211 FE02             7      CP  2
001213 5213 2013            12      JR  NZ,DSKCHG1
001215 5215 CD3C52          17      CALL    IS_BPB
001218 5218 300E            12      JR  NC,DSKCHG1
00121A 521A 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
00121C 521C 3221FB          13      LD  (DRVTBL),A
00121F 521F 3223FB          13      LD  (DRVTBL+2),A
001222 5222 3A48F3          13      LD  A,(MASTERS)
001225 5225 3224FB          13      LD  (DRVTBL+3),A
       5228                     DSKCHG1:
001228 5228 AF               4      XOR A
001229 5229 0601             7      LD  B,1
00122B 522B C9              10      RET
       522C                     NOTREADY:
00122C 522C 3E02             7      LD  A,2
00122E 522E 37               4      SCF
00122F 522F C9              10      RET
                                
       5230                     NO_BPB:
001230 5230 E1              10      POP HL
001231 5231 23               6      INC HL
001232 5232 11C353          10      LD  DE,DPB2DD
001235 5235 011200          10      LD  BC,DPB2DD_E-DPB2DD
001238 5238 EDB0                    LDIR
00123A 523A AF               4      XOR A
00123B 523B C9              10      RET
                                
       523C                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
00123C 523C CD9A53          17      CALL    GET_DISK_BANK
                                
00123F 523F 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
001242 5242 FE01             7      CP  1
001244 5244 D8              11      RET C
                                
001245 5245 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
001248 5248 C6FF             7      ADD A,0FFH
00124A 524A D8              11      RET C
                                
00124B 524B 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       524E                     IS_BPB1:
00124E 524E FE01             7      CP  1
001250 5250 C8              11      RET Z
001251 5251 FE02             7      CP  2
001253 5253 C8              11      RET Z
001254 5254 FE04             7      CP  4
001256 5256 C8              11      RET Z
001257 5257 37               4      SCF
001258 5258 C9              10      RET
                                
       5259                     GETDPB:
001259 5259 E5              11      PUSH    HL
00125A 525A CD9A53          17      CALL    GET_DISK_BANK
                                
00125D 525D 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
001260 5260 B7               4      OR  A
001261 5261 28CD            12      JR  Z,NO_BPB
001263 5263 DDE1            14      POP IX
001265 5265 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
001268 5268 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
00126B 526B DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
00126E 526E 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
001271 5271 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
001274 5274 87               4      ADD A,A
001275 5275 87               4      ADD A,A
001276 5276 87               4      ADD A,A
001277 5277 3D               4      DEC A
001278 5278 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
00127B 527B 06FF             7      LD  B,-1
00127D 527D A7               4      AND A           ;無限ループ阻止
       527E                     GETDPB1:
00127E 527E 04               4      INC B
00127F 527F 1F               4      RRA
001280 5280 38FC            12      JR  C,GETDPB1
001282 5282 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
001285 5285 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
001288 5288 3D               4      DEC A
001289 5289 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
00128C 528C A7               4      AND A           ;無限ループ阻止
00128D 528D 06FF             7      LD  B,-1
       528F                     GETDPB2:
00128F 528F 04               4      INC B
001290 5290 1F               4      RRA
001291 5291 38FC            12      JR  C,GETDPB2
001293 5293 04               4      INC B
001294 5294 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
001297 5297 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
00129A 529A DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
00129D 529D DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
0012A0 52A0 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
0012A3 52A3 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
0012A6 52A6 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
0012A9 52A9 DD770B          19      LD  (IX+11),A       ;MAXENT
                                
0012AC 52AC ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
0012B0 52B0 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
0012B3 52B3 DD460A          19      LD  B,(IX+10)       ;FATCNT
0012B6 52B6 210000          10      LD  HL,0
       52B9                     GETDPB3:
0012B9 52B9 19              11      ADD HL,DE
0012BA 52BA 10FD            13      DJNZ    GETDPB3
       52BC                     GETDPB4:
0012BC 52BC DD5E08          19      LD  E,(IX+8)        ;FIRFAT
0012BF 52BF DD5609          19      LD  D,(IX+9)        ;FIRFAT
0012C2 52C2 19              11      ADD HL,DE
0012C3 52C3 DD7511          19      LD  (IX+17),L       ;FIRDIR
0012C6 52C6 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
0012C9 52C9 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0012CC 52CC 87               4      ADD A,A
0012CD 52CD 87               4      ADD A,A
0012CE 52CE DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       52D1                     GETDPB5:
0012D1 52D1 CB3B             8      SRL E
0012D3 52D3 1F               4      RRA
0012D4 52D4 30FB            12      JR  NC,GETDPB5
0012D6 52D6 1600             7      LD  D,0
0012D8 52D8 19              11      ADD HL,DE
0012D9 52D9 DD750C          19      LD  (IX+12),L       ;FIRREC
0012DC 52DC DD740D          19      LD  (IX+13),H       ;FIRREC
                                
0012DF 52DF 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
0012E2 52E2 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
0012E5 52E5 DD560D          19      LD  D,(IX+13)       ;FIRREC
0012E8 52E8 A7               4      AND A
0012E9 52E9 ED52            15      SBC HL,DE
                                
0012EB 52EB DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
0012EE 52EE 3C               4      INC A
0012EF 52EF 37               4      SCF             ;無限ループ阻止
       52F0                     GETDPB6:
0012F0 52F0 1F               4      RRA
0012F1 52F1 3806            12      JR  C,GETDPB7
0012F3 52F3 CB3C             8      SRL H
0012F5 52F5 CB1D             8      RR  L
0012F7 52F7 18F7            12      JR  GETDPB6
       52F9                     GETDPB7:
0012F9 52F9 23               6      INC HL
0012FA 52FA DD750E          19      LD  (IX+14),L       ;MAXCLUS
0012FD 52FD DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       5300                     GETDPBD1:
001300 5300 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001303 5303 E6FC             7      AND 0FCH
001305 5305 C8              11      RET Z
                                
001306 5306 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
00130A 530A 37               4      SCF
00130B 530B DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
00130F 530F DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
001312 5312 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
001316 5316 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
00131A 531A DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
00131E 531E DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
001322 5322 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
001326 5326 DDCB1126        23      SLA (IX+17)         ;FIRDIR
00132A 532A DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
00132E 532E DD6E11          19      LD  L,(IX+17)       ;FIRDIR
001331 5331 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
001334 5334 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001337 5337 87               4      ADD A,A
001338 5338 87               4      ADD A,A
001339 5339 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       533C                     GETDPBD5:
00133C 533C CB3B             8      SRL E
00133E 533E 1F               4      RRA
00133F 533F 30FB            12      JR  NC,GETDPBD5
001341 5341 1600             7      LD  D,0
001343 5343 19              11      ADD HL,DE
001344 5344 DD750C          19      LD  (IX+12),L       ;FIRREC
001347 5347 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
00134A 534A 18B4            12      JR  GETDPBD1
                                
       534C                     CHOICE:
00134C 534C 210000          10      LD  HL,0
00134F 534F C9              10      RET
                                
       5350                     DSKFMT:
001350 5350 AF               4      XOR A
001351 5351 37               4      SCF
       5352                     DSKSTP:
001352 5352 C9              10      RET
                                
       5353                     BASENT:
001353 5353 2A74F6          16      LD  HL,(STKTOP)
001356 5356 3A40F3          13      LD  A,(REBOOT)
001359 5359 C6FF             7      ADD A,0FFH
00135B 535B 3811            12      JR  C,REBOOT1
00135D 535D 21D553          10      LD  HL,AUTOEXEC
001360 5360 11F8F2          10      LD  DE,FDRV
001363 5363 010C00          10      LD  BC,1+8+3
001366 5366 EDB0                    LDIR
001368 5368 CD8E4C          17      CALL    ROM_OPEN
00136B 536B D4F945          17      CALL    NC,ROM_LOAD1
       536E                     REBOOT1:
00136E 536E 21E153          10      LD  HL,CMD_RUN
001371 5371 111FF4          10      LD  DE,KBUF
001374 5374 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
001377 5377 D5              11      PUSH    DE
001378 5378 EDB0                    LDIR
00137A 537A 3004            12      JR  NC,REBOOT2
00137C 537C AF               4      XOR A
00137D 537D 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       5380                     REBOOT2:
001380 5380 E1              10      POP HL
001381 5381 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
001385 5385 DD210146        14      LD  IX,NEWSTT
001389 5389 C31C00          10      JP  _CALSLT
                                
       538C                     GETSLT:
00138C 538C 3A22FB          13      LD  A,(DRVTBL+1)
00138F 538F C9              10      RET
                                
       5390                     GET_DISK_BANK_FDRV:
001390 5390 3AF8F2          13      LD  A,(FDRV)
001393 5393 D601             7      SUB 1
001395 5395 3003            12      JR  NC,GET_DISK_BANK
001397 5397 3AEAF2          13      LD  A,(_DVSW)
       539A                     GET_DISK_BANK:
00139A 539A FE07             7      CP  7       ;H:
00139C 539C 2801            12      JR  Z,SET_DISK_BANK_A
00139E 539E B7               4      OR  A       ;A=DRIVE
       539F                     SET_DISK_BANK_A:
00139F 539F 3E01             7      LD  A,DISK_BANK
0013A1 53A1 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
0013A3 53A3 3AE9F2          13      LD  A,(B_DRIVE)
                                #endif
       53A6                     SET_DISK_BANK:
                                #if exists USE_MORMAL32K_OR_ASCII16
0013A6 53A6 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0013A9 53A9 F5              11      PUSH    AF
0013AA 53AA E5              11      PUSH    HL
0013AB 53AB 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
0013AE 53AE 22C8F2          16      LD  (SECSZ),HL
0013B1 53B1 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0013B4 53B4 CDBD53          17      CALL    MUL_AHL
0013B7 53B7 22C6F2          16      LD  (CLSZ),HL
0013BA 53BA E1              10      POP HL
0013BB 53BB F1              10      POP AF
0013BC 53BC C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       53BD                     MUL_AHL:
0013BD 53BD 37               4      SCF     ;無限ループ回避
       53BE                     MUL_AHL1:
0013BE 53BE 1F               4      RRA     ;->CF
0013BF 53BF D8              11      RET C
0013C0 53C0 29              11      ADD HL,HL
0013C1 53C1 18FB            12      JR  MUL_AHL1
                                
       53C3                     DPB2DD:
0013C3 53C3 F9                      DB  0F9H    ;MEDIA
0013C4 53C4 0002                    DW  00200H  ;SECSIZ
0013C6 53C6 0F                      DB  00FH    ;DIRMSK
0013C7 53C7 04                      DB  004H    ;DIRSHFT
0013C8 53C8 01                      DB  001H    ;CLUSMSK
0013C9 53C9 02                      DB  002H    ;CLUSSHFT
0013CA 53CA 0100                    DW  00001H  ;FIRFAT
0013CC 53CC 02                      DB  002H    ;FATCNT
0013CD 53CD 70                      DB  070H    ;MAXENT
0013CE 53CE 0E00                    DW  0000EH  ;FIRREC
0013D0 53D0 CA02                    DW  002CAH  ;MAXCLUS
0013D2 53D2 03                      DB  003H    ;FATSIZ
0013D3 53D3 0700                    DW  0007H   ;FIRDIR
       53D5                     DPB2DD_E:
                                
       53D5                     AUTOEXEC:
0013D5 53D5 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       53E1                     CMD_RUN:
0013E1 53E1 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
                                #if exists USE_MORMAL32K_OR_ASCII16
0013E7 53E7 80F2                    DW  0F280H
                                #else
                                    DW  0F240H
                                #endif
       53E9                     CMD_CLEAR_E:
0013E9 53E9 3A8A00                  DB  03AH,08AH,0         ;RUN
       53EC                     CMD_RUN_E:
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       53EC                     POP_HL_ERROR:
0013EC 53EC E1              10      POP     HL
       53ED                     _ERROR:
0013ED 53ED 0600             7      LD  B,0
0013EF 53EF A7               4      AND A
0013F0 53F0 C9              10      RET
                                
       53F1                     ROM_BDOS:
0013F1 53F1 E5              11      PUSH    HL
0013F2 53F2 79               4      LD  A,C
0013F3 53F3 87               4      ADD A,A
0013F4 53F4 38F7            12      JR  C,_ERROR
0013F6 53F6 6F               4      LD  L,A
0013F7 53F7 265F             7      LD  H,high STABLE
0013F9 53F9 7E               7      LD  A,(HL)
0013FA 53FA 2C               4      INC L
0013FB 53FB 66               7      LD  H,(HL)
0013FC 53FC 6F               4      LD  L,A
0013FD 53FD E3              19      EX  (SP),HL
0013FE 53FE 79               4      LD  A,C
0013FF 53FF C9              10      RET
                                
       5400                     _PRINT:
       5400                     PRINT:
001400 5400 7B               4      LD  A,E
001401 5401 1803            12      JR  MSG_A
                                
       5403                     _SYS01:     ;(BDOS)コンソール入力
001403 5403 CD7A54          17      CALL    _SYS07
       5406                     MSG_A:
001406 5406 FE03             7      CP  3
001408 5408 2814            12      JR  Z,MSG_BR
       540A                     MSGA1:
00140A 540A F5              11      PUSH    AF
00140B 540B C5              11      PUSH    BC
00140C 540C D5              11      PUSH    DE
00140D 540D E5              11      PUSH    HL
00140E 540E DDE5            15      PUSH    IX
001410 5410 DD21A200        14      LD  IX,CHPUT
001414 5414 CDFC42          17      CALL    CALSLT_R
001417 5417 DDE1            14      POP IX
001419 5419 E1              10      POP HL
00141A 541A D1              10      POP DE
00141B 541B C1              10      POP BC
       541C                     MSGA2:
00141C 541C F1              10      POP AF
00141D 541D C9              10      RET
       541E                     MSG_BR:
00141E 541E F5              11      PUSH    AF
00141F 541F 3ADDF3          13      LD  A,(CSRX)
001422 5422 FE02             7      CP  2
001424 5424 38F6            12      JR  C,MSGA2
001426 5426 F1              10      POP AF
       5427                     MSG_CR:
001427 5427 F5              11      PUSH    AF
001428 5428 3E0D             7      LD  A,00DH
00142A 542A CD0A54          17      CALL    MSGA1
00142D 542D 3E0A             7      LD  A,00AH
00142F 542F CD0A54          17      CALL    MSGA1
001432 5432 F1              10      POP AF
001433 5433 C9              10      RET
                                
       5434                     _SYS02:     ;(BDOS)コンソール出力
001434 5434 CD4F54          17      CALL    BREAK
001437 5437 1805            12      JR  PRINTX
                                
       5439                     _SYS06:     ;(BDOS)コンソール直接入出力
001439 5439 7B               4      LD  A,E
00143A 543A 3C               4      INC A
00143B 543B CA8E54          10      JP  Z,_INKEY
       543E                     PRINTX:
00143E 543E C30054          10      JP  _PRINT
                                
       5441                     _SYS08:     ;(BDOS)エコーなしコンソール入力
001441 5441 CD7A54          17      CALL    _SYS07
001444 5444 FE03             7      CP  3
001446 5446 CC4F54          17      CALL    Z,_BREAK
001449 5449 FE13             7      CP  013H        ;CTRL+S
00144B 544B C0              11      RET NZ
       544C                     PAUSE:
00144C 544C CD6654          17      CALL    KEYBC
                                
       544F                     _BREAK:
       544F                     BREAK:
00144F 544F F5              11      PUSH    AF
001450 5450 C5              11      PUSH    BC
001451 5451 D5              11      PUSH    DE
001452 5452 E5              11      PUSH    HL
001453 5453 DDE5            15      PUSH    IX
001455 5455 DD21B700        14      LD  IX,BREAKX
001459 5459 CDFC42          17      CALL    CALSLT_R
00145C 545C DDE1            14      POP IX
00145E 545E E1              10      POP HL
00145F 545F D1              10      POP DE
001460 5460 C1              10      POP BC
001461 5461 DC4F54          17      CALL    C,_BREAK
001464 5464 F1              10      POP AF
001465 5465 C9              10      RET
       5466                     KEYBC:
001466 5466 F5              11      PUSH    AF
001467 5467 C5              11      PUSH    BC
001468 5468 D5              11      PUSH    DE
001469 5469 E5              11      PUSH    HL
00146A 546A DDE5            15      PUSH    IX
00146C 546C DD215601        14      LD  IX,KILBUF
001470 5470 CDFC42          17      CALL    CALSLT_R
001473 5473 DDE1            14      POP IX
001475 5475 E1              10      POP HL
001476 5476 D1              10      POP DE
001477 5477 C1              10      POP BC
001478 5478 F1              10      POP AF
001479 5479 C9              10      RET
                                
       547A                     _SYS07:
       547A                     FLGET:
00147A 547A C5              11      PUSH    BC
00147B 547B D5              11      PUSH    DE
00147C 547C E5              11      PUSH    HL
00147D 547D DDE5            15      PUSH    IX
00147F 547F DD219F00        14      LD  IX,CHGET
001483 5483 CDFC42          17      CALL    CALSLT_R
001486 5486 DDE1            14      POP IX
001488 5488 E1              10      POP HL
001489 5489 D1              10      POP DE
00148A 548A C1              10      POP BC
00148B 548B FE03             7      CP  3
00148D 548D C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       548E                     _INKEY:
       548E                     INKEY:
00148E 548E CD2855          17      CALL    CPM_CONST
001491 5491 C8              11      RET Z
001492 5492 18E6            12      JR  FLGET
                                
       5494                     _SYS0A:     ;(BDOS)文字列入力
001494 5494 C5              11      PUSH    BC
001495 5495 E5              11      PUSH    HL
001496 5496 D5              11      PUSH    DE
001497 5497 CDC054          17      CALL    GETL
00149A 549A 111FF4          10      LD  DE,KBUF
00149D 549D E1              10      POP HL
00149E 549E E5              11      PUSH    HL
00149F 549F 0E00             7      LD  C,0
0014A1 54A1 3004            12      JR  NC,SAX0
0014A3 54A3 23               6      INC HL
0014A4 54A4 23               6      INC HL
0014A5 54A5 1808            12      JR  SAX4
       54A7                     SAX0:
0014A7 54A7 46               7      LD  B,(HL)
0014A8 54A8 23               6      INC HL
       54A9                     SAX1:
0014A9 54A9 23               6      INC HL
0014AA 54AA 1A               7      LD  A,(DE)
0014AB 54AB 13               6      INC DE
0014AC 54AC B7               4      OR  A
0014AD 54AD 2004            12      JR  NZ,SAX2
       54AF                     SAX4:
0014AF 54AF 360D            10      LD  (HL),00DH
0014B1 54B1 1804            12      JR  SAX3
       54B3                     SAX2:
0014B3 54B3 77               7      LD  (HL),A
0014B4 54B4 0C               4      INC C
0014B5 54B5 10F2            13      DJNZ    SAX1
       54B7                     SAX3:
0014B7 54B7 D1              10      POP DE
0014B8 54B8 79               4      LD  A,C
0014B9 54B9 13               6      INC DE
0014BA 54BA 12               7      LD  (DE),A
0014BB 54BB 1B               6      DEC DE
0014BC 54BC E1              10      POP HL
0014BD 54BD C1              10      POP BC
0014BE 54BE A7               4      AND A
0014BF 54BF C9              10      RET
       54C0                     GETL:
0014C0 54C0 DDE5            15      PUSH    IX
0014C2 54C2 FDE5            15      PUSH    IY
                                
0014C4 54C4 2ADCF3          16      LD  HL,(CSRY)
0014C7 54C7 22CAFB          16      LD  (FSTPOS),HL
       54CA                     GETL1:
0014CA 54CA CD4154          17      CALL    _SYS08
0014CD 54CD FE09             7      CP  9
0014CF 54CF 2008            12      JR  NZ,GETL1V
0014D1 54D1 211FF4          10      LD  HL,KBUF
0014D4 54D4 CD9343          17      CALL    MSX
0014D7 54D7 18F1            12      JR  GETL1
       54D9                     GETL1V:
0014D9 54D9 5F               4      LD  E,A
0014DA 54DA FE08             7      CP  8
0014DC 54DC CC7655          17      CALL    Z,CTRL02
0014DF 54DF FE20             7      CP  020H
0014E1 54E1 D4A255          17      CALL    NC,INSERT
0014E4 54E4 CD0A54          17      CALL    MSGA1
                                
0014E7 54E7 7B               4      LD  A,E
0014E8 54E8 FE0D             7      CP  00DH
0014EA 54EA 20DE            12      JR  NZ,GETL1
                                
0014EC 54EC 111FF4          10      LD  DE,KBUF
0014EF 54EF 3AB0F3          13      LD  A,(LINLEN)
0014F2 54F2 47               4      LD  B,A
0014F3 54F3 CD8257          17      CALL    ZERO_MEMORY_DE
                                
0014F6 54F6 2ACAFB          16      LD  HL,(FSTPOS)
0014F9 54F9 3ADCF3          13      LD  A,(CSRY)
0014FC 54FC 6F               4      LD  L,A
0014FD 54FD E5              11      PUSH    HL
0014FE 54FE CDD355          17      CALL    LOC0
001501 5501 4D               4      LD  C,L
001502 5502 44               4      LD  B,H
001503 5503 E1              10      POP HL
001504 5504 3AB0F3          13      LD  A,(LINLEN)
001507 5507 94               4      SUB H
001508 5508 3D               4      DEC A
001509 5509 5F               4      LD  E,A
00150A 550A 211FF4          10      LD  HL,KBUF
       550D                     GETL2:
00150D 550D CD6655          17      CALL    _SCRN
001510 5510 03               6      INC BC
001511 5511 77               7      LD  (HL),A
001512 5512 23               6      INC HL
001513 5513 1D               4      DEC E
001514 5514 20F7            12      JR  NZ,GETL2
001516 5516 CD2754          17      CALL    MSG_CR
                                
001519 5519 FDE1            14      POP IY
00151B 551B DDE1            14      POP IX
       551D                     GETL3:
00151D 551D 2B               6      DEC HL
00151E 551E 7E               7      LD  A,(HL)
00151F 551F FE21             7      CP  021H
001521 5521 D0              11      RET NC
001522 5522 3600            10      LD  (HL),0
001524 5524 15               4      DEC D
001525 5525 20F6            12      JR  NZ,GETL3
001527 5527 C9              10      RET
                                
       5528                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       5528                     CONSTX:
       5528                     CPM_CONST:
001528 5528 C5              11      PUSH    BC
001529 5529 D5              11      PUSH    DE
00152A 552A E5              11      PUSH    HL
00152B 552B DDE5            15      PUSH    IX
00152D 552D DD219C00        14      LD  IX,CHSNS
001531 5531 CDFC42          17      CALL    CALSLT_R
001534 5534 DDE1            14      POP IX
001536 5536 E1              10      POP HL
001537 5537 D1              10      POP DE
001538 5538 C1              10      POP BC
001539 5539 C9              10      RET
                                
       553A                     _SYS2A:     ;(BDOS)日付の獲得
00153A 553A AF               4      XOR A
00153B 553B 57               4      LD  D,A
00153C 553C 5F               4      LD  E,A
00153D 553D 67               4      LD  H,A
00153E 553E 6F               4      LD  L,A
00153F 553F C9              10      RET
                                
       5540                     _SYS2C:     ;(BDOS)時刻の獲得
001540 5540 AF               4      XOR A
001541 5541 57               4      LD  D,A
001542 5542 5F               4      LD  E,A
001543 5543 67               4      LD  H,A
001544 5544 6F               4      LD  L,A
001545 5545 C9              10      RET
                                
       5546                     POS:
001546 5546 F5              11      PUSH    AF
001547 5547 2ADCF3          16      LD  HL,(CSRY)
00154A 554A 7D               4      LD  A,L
00154B 554B 6C               4      LD  L,H
00154C 554C 67               4      LD  H,A
00154D 554D 2C               4      INC L
00154E 554E 24               4      INC H
00154F 554F F1              10      POP AF
001550 5550 C9              10      RET
                                
       5551                     LOC:
001551 5551 F5              11      PUSH    AF
001552 5552 E5              11      PUSH    HL
001553 5553 7D               4      LD  A,L
001554 5554 6C               4      LD  L,H
001555 5555 67               4      LD  H,A
001556 5556 2D               4      DEC L
001557 5557 25               4      DEC H
001558 5558 DDE5            15      PUSH    IX
00155A 555A DD21C600        14      LD  IX,POSIT
00155E 555E CDFC42          17      CALL    CALSLT_R
001561 5561 DDE1            14      POP IX
001563 5563 E1              10      POP HL
001564 5564 F1              10      POP AF
001565 5565 C9              10      RET
                                
       5566                     _SCRN:
       5566                     SCRN:
001566 5566 E5              11      PUSH    HL
001567 5567 DDE5            15      PUSH    IX
                                
001569 5569 69               4      LD  L,C
00156A 556A 60               4      LD  H,B
00156B 556B DD214A00        14      LD  IX,RDVRM
00156F 556F CDFC42          17      CALL    CALSLT_R
                                
001572 5572 DDE1            14      POP IX
001574 5574 E1              10      POP HL
001575 5575 C9              10      RET
                                
       5576                     CTRL02:
001576 5576 F5              11      PUSH    AF
001577 5577 D5              11      PUSH    DE
001578 5578 2ADCF3          16      LD  HL,(CSRY)
00157B 557B 3AB0F3          13      LD  A,(LINLEN)
00157E 557E 4F               4      LD  C,A
00157F 557F 94               4      SUB H   ;CSRX
001580 5580 C602             7      ADD A,2
001582 5582 47               4      LD  B,A ;カーソルより右の文字数
001583 5583 61               4      LD  H,C ;LINLEN
001584 5584 C5              11      PUSH    BC
001585 5585 CDD355          17      CALL    LOC0
001588 5588 C1              10      POP BC
                                
001589 5589 1620             7      LD  D,020H
       558B                     C8X1:
00158B 558B DD214A00        14      LD  IX,RDVRM
00158F 558F CDFC42          17      CALL    CALSLT_R
001592 5592 4F               4      LD  C,A
001593 5593 7A               4      LD  A,D
001594 5594 DD214D00        14      LD  IX,WRTVRM
001598 5598 CDFC42          17      CALL    CALSLT_R
00159B 559B 2B               6      DEC HL
00159C 559C 51               4      LD  D,C
00159D 559D 10EC            13      DJNZ    C8X1
00159F 559F D1              10      POP DE
0015A0 55A0 F1              10      POP AF
0015A1 55A1 C9              10      RET
                                
       55A2                     INSERT:
0015A2 55A2 F5              11      PUSH    AF
0015A3 55A3 D5              11      PUSH    DE
0015A4 55A4 2ADCF3          16      LD  HL,(CSRY)
0015A7 55A7 3AB0F3          13      LD  A,(LINLEN)
0015AA 55AA 4F               4      LD  C,A
0015AB 55AB 94               4      SUB H   ;CSRX
0015AC 55AC 3C               4      INC A
0015AD 55AD 47               4      LD  B,A ;カーソルより右の文字数
0015AE 55AE C5              11      PUSH    BC
0015AF 55AF CDD355          17      CALL    LOC0
0015B2 55B2 C1              10      POP BC
                                
0015B3 55B3 1620             7      LD  D,020H
       55B5                     INS1:
0015B5 55B5 DD214A00        14      LD  IX,RDVRM
0015B9 55B9 CDFC42          17      CALL    CALSLT_R
0015BC 55BC 4F               4      LD  C,A
0015BD 55BD 7A               4      LD  A,D
0015BE 55BE DD214D00        14      LD  IX,WRTVRM
0015C2 55C2 CDFC42          17      CALL    CALSLT_R
0015C5 55C5 23               6      INC HL
0015C6 55C6 51               4      LD  D,C
0015C7 55C7 10EC            13      DJNZ    INS1
0015C9 55C9 D1              10      POP DE
0015CA 55CA F1              10      POP AF
0015CB 55CB C9              10      RET
                                
       55CC                     CONOUT1:
0015CC 55CC 59               4      LD  E,C
0015CD 55CD C30054          10      JP  _PRINT
                                
       55D0                     GETVRAM:
0015D0 55D0 2ADCF3          16      LD  HL,(CSRY)
       55D3                     LOC0:
0015D3 55D3 2D               4      DEC L
0015D4 55D4 25               4      DEC H
0015D5 55D5 4C               4      LD  C,H ;CSRX-1
0015D6 55D6 5D               4      LD  E,L ;CSRY-1
       55D7                     LOC1:
0015D7 55D7 3AB0F3          13      LD  A,(LINLEN)
0015DA 55DA 67               4      LD  H,A
0015DB 55DB 1600             7      LD  D,0
0015DD 55DD 6A               4      LD  L,D ;0
0015DE 55DE 0608             7      LD  B,8
       55E0                     LOC2:
0015E0 55E0 29              11      ADD HL,HL
0015E1 55E1 3001            12      JR  NC,LOC3
0015E3 55E3 19              11      ADD HL,DE
       55E4                     LOC3:
0015E4 55E4 10FA            13      DJNZ    LOC2
0015E6 55E6 09              11      ADD HL,BC
0015E7 55E7 C9              10      RET
                                
       55E8                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0015E8 55E8 212200          10      LD  HL,00022H
0015EB 55EB AF               4      XOR A
0015EC 55EC 7D               4      LD  A,L
0015ED 55ED C9              10      RET
                                
       55EE                     _SYS0D:     ;(BDOS)ディスク・リセット
0015EE 55EE 218000          10      LD  HL,00080H
0015F1 55F1 22D4F2          16      LD  (_DTA),HL
0015F4 55F4 C9              10      RET
                                
       55F5                     _SYS0E:     ;(BDOS)カレントドライブの設定
0015F5 55F5 7B               4      LD  A,E
       55F6                     _SYS0EX1:
0015F6 55F6 FE08             7      CP  8
0015F8 55F8 3F               4      CCF
0015F9 55F9 D8              11      RET C
0015FA 55FA 32EAF2          13      LD  (_DVSW),A
0015FD 55FD C9              10      RET
                                
       55FE                     _SYS0F:     ;(BDOS)ファイルのオープン
0015FE 55FE D5              11      PUSH    DE
0015FF 55FF FDE1            14      POP IY
001601 5601 CD6C57          17      CALL    INIT_FILE
001604 5604 CD8E4C          17      CALL    ROM_OPEN
001607 5607 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
001609 5609 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
00160D 560D FDE5            15      PUSH    IY
00160F 560F D1              10      POP DE
001610 5610 13               6      INC DE
001611 5611 010B00          10      LD  BC,11
001614 5614 EDB0                    LDIR
                                ;               Attribute
001616 5616 7E               7      LD  A,(HL)
001617 5617 FD770D          19      LD  (IY+13),A
                                ;               TIME
00161A 561A 110B00          10      LD  DE,11
00161D 561D 19              11      ADD HL,DE
00161E 561E 7E               7      LD  A,(HL)
00161F 561F 23               6      INC HL
001620 5620 FD7716          19      LD  (IY+22),A
001623 5623 7E               7      LD  A,(HL)
001624 5624 23               6      INC HL
001625 5625 FD7717          19      LD  (IY+23),A
                                ;               DATE
001628 5628 7E               7      LD  A,(HL)
001629 5629 23               6      INC HL
00162A 562A FD7714          19      LD  (IY+20),A
00162D 562D 7E               7      LD  A,(HL)
00162E 562E 23               6      INC HL
00162F 562F FD7715          19      LD  (IY+21),A
                                ;               First cluster
001632 5632 7E               7      LD  A,(HL)
001633 5633 23               6      INC HL
001634 5634 FD771A          19      LD  (IY+26),A
001637 5637 7E               7      LD  A,(HL)
001638 5638 23               6      INC HL
001639 5639 FD771B          19      LD  (IY+27),A
                                ;               SIZE
00163C 563C 7E               7      LD  A,(HL)
00163D 563D 23               6      INC HL
00163E 563E FD7710          19      LD  (IY+16),A
001641 5641 7E               7      LD  A,(HL)
001642 5642 23               6      INC HL
001643 5643 FD7711          19      LD  (IY+17),A
001646 5646 7E               7      LD  A,(HL)
001647 5647 23               6      INC HL
001648 5648 FD7712          19      LD  (IY+18),A
00164B 564B 7E               7      LD  A,(HL)
00164C 564C FD7713          19      LD  (IY+19),A
00164F 564F AF               4      XOR A
001650 5650 FD770C          19      LD  (IY+12),A
001653 5653 C9              10      RET
                                
       5654                     _SYS10:     ;(BDOS)ファイルのクローズ
001654 5654 AF               4      XOR A
001655 5655 C9              10      RET
                                
       5656                     S11X1:
001656 5656 FD7119          19      LD  (IY+25),C       ;RootEntCnt
001659 5659 FD750E          19      LD  (IY+14),L
00165C 565C FD740F          19      LD  (IY+15),H
       565F                     SCF_FF_RET:
00165F 565F 37               4      SCF
001660 5660 9F               4      SBC A,A
001661 5661 C9              10      RET
                                
       5662                     _SYS11:     ;(BDOS)最初のファイルの検索
001662 5662 ED53D7F2        20      LD  (_FCB),DE
001666 5666 D5              11      PUSH    DE
001667 5667 FDE1            14      POP IY
001669 5669 CD6C57          17      CALL    INIT_FILE
00166C 566C CDEA4E          17      CALL    GET_DIR_DAT
       566F                     S12X1:
00166F 566F CDAA4C          17      CALL    FILESE
001672 5672 30E2            12      JR  NC,S11X1
001674 5674 0D               4      DEC C
001675 5675 FD7119          19      LD  (IY+25),C       ;RootEntCnt
001678 5678 FDCB0D66        20      BIT 4,(IY+13)
00167C 567C 2809            12      JR  Z,S12X2
00167E 567E E5              11      PUSH    HL
00167F 567F DDE1            14      POP IX
001681 5681 DDCB0E66        20      BIT 4,(IX+1+13)
001685 5685 28E8            12      JR  Z,S12X1
       5687                     S12X2:
001687 5687 012000          10      LD  BC,32
00168A 568A ED5BD4F2        20      LD  DE,(_DTA)
00168E 568E AF               4      XOR A
00168F 568F 12               7      LD  (DE),A      ;ドライブ番号
001690 5690 13               6      INC DE
001691 5691 EDB0                    LDIR            ;ディレクトリエントリ
001693 5693 FD750E          19      LD  (IY+14),L
001696 5696 FD740F          19      LD  (IY+15),H
001699 5699 C9              10      RET
                                
       569A                     _SYS12:
00169A 569A FD2AD7F2        20      LD  IY,(_FCB)
00169E 569E FDE5            15      PUSH    IY
0016A0 56A0 D1              10      POP DE
0016A1 56A1 CD6C57          17      CALL    INIT_FILE
                                
0016A4 56A4 FD6E0E          19      LD  L,(IY+14)
0016A7 56A7 FD660F          19      LD  H,(IY+15)
0016AA 56AA FD4E19          19      LD  C,(IY+25)
0016AD 56AD 18C0            12      JR  S12X1
                                
       56AF                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0016AF 56AF CDD04E          17      CALL    SET_FCB
0016B2 56B2 CD9E4E          17      CALL    GETSEQ
0016B5 56B5 CD8B4E          17      CALL    RB_READ
0016B8 56B8 E5              11      PUSH    HL
0016B9 56B9 CDAB4E          17      CALL    SETSEQ
0016BC 56BC E1              10      POP HL
       56BD                     SREAD:
0016BD 56BD C601             7      ADD A,001H
0016BF 56BF D8              11      RET C
                                
0016C0 56C0 7D               4      LD  A,L
0016C1 56C1 D601             7      SUB 001H
0016C3 56C3 9F               4      SBC A,A
0016C4 56C4 E603             7      AND 3
0016C6 56C6 1F               4      RRA
0016C7 56C7 C9              10      RET
                                
       56C8                     _SYS18:     ;(BDOS)ログインベクトルの獲得
0016C8 56C8 210100          10      LD  HL,00001H
0016CB 56CB AF               4      XOR A
0016CC 56CC C9              10      RET
                                
       56CD                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
0016CD 56CD 3AEAF2          13      LD  A,(_DVSW)
0016D0 56D0 C9              10      RET
                                
       56D1                     _SYS1A:     ;(BDOS)DTAの設定
0016D1 56D1 ED53D4F2        20      LD  (_DTA),DE
0016D5 56D5 AF               4      XOR A
0016D6 56D6 C9              10      RET
                                
       56D7                     _SYS1B:     ;(BDOS)ディスク情報の獲得
0016D7 56D7 010002          10      LD  BC,512
0016DA 56DA 11C302          10      LD  DE,707
0016DD 56DD 210000          10      LD  HL,0
0016E0 56E0 DD21D9F2        14      LD  IX,_BUF
0016E4 56E4 FD21D9F2        14      LD  IY,_BUF
0016E8 56E8 FD3600F9        19      LD  (IY+0),0F9H
0016EC 56EC 3E02             7      LD  A,2
0016EE 56EE C9              10      RET
                                
       56EF                     _SYS21:     ;(BDOS)ランダムな読み出し
0016EF 56EF CDD04E          17      CALL    SET_FCB
                                
0016F2 56F2 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0016F5 56F5 FD6622          19      LD  H,(IY+34)
                                
0016F8 56F8 CD8B4E          17      CALL    RB_READ
0016FB 56FB 18C0            12      JR  SREAD
                                
       56FD                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
0016FD 56FD CDFE55          17      CALL    _SYS0F
001700 5700 D8              11      RET C
                                
001701 5701 D5              11      PUSH    DE      ;EX DE,IY
001702 5702 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001704 5704 CDC04E          17      CALL    GETSIZE
       5707                     _S24X1:
001707 5707 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
00170A 570A FD7422          19      LD  (IY+34),H
00170D 570D FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
001711 5711 FDE3            23      EX  (SP),IY     ;
001713 5713 D1              10      POP DE      ;
                                
001714 5714 AF               4      XOR A
001715 5715 C9              10      RET
                                
       5716                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
001716 5716 E5              11      PUSH    HL
001717 5717 D5              11      PUSH    DE      ;EX DE,IY
001718 5718 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00171A 571A CD9E4E          17      CALL    GETSEQ
00171D 571D 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       571F                     _SYS27:     ;(BDOS)ランダムブロック読み込み
00171F 571F CDD04E          17      CALL    SET_FCB
001722 5722 E5              11      PUSH    HL
001723 5723 FD6E21          19      LD  L,(IY+33)
001726 5726 FD6622          19      LD  H,(IY+34)
001729 5729 22CAF2          16      LD  (RR_LOW),HL
00172C 572C FD6E23          19      LD  L,(IY+35)
00172F 572F FD6624          19      LD  H,(IY+36)
001732 5732 22CCF2          16      LD  (RR_HIGH),HL
001735 5735 E1              10      POP HL
001736 5736 CD5B4A          17      CALL    ROM_READ
001739 5739 ED5BCAF2        20      LD  DE,(RR_LOW)
00173D 573D FD7321          19      LD  (IY+33),E
001740 5740 FD7222          19      LD  (IY+34),D
001743 5743 ED5BCCF2        20      LD  DE,(RR_HIGH)
001747 5747 FD7323          19      LD  (IY+35),E
00174A 574A FD7224          19      LD  (IY+36),D
00174D 574D 9F               4      SBC A,A
00174E 574E C9              10      RET
                                
       574F                     _SYS2F:
00174F 574F 44               4      LD  B,H
001750 5750 2AD4F2          16      LD  HL,(_DTA)
001753 5753 C3BD51          10      JP  DISKIO
                                
       5756                     _SYS5A:
001756 5756 0600             7      LD  B,0
001758 5758 D5              11      PUSH    DE
001759 5759 DDE1            14      POP IX
       575B                     _SX5A1:
00175B 575B 1A               7      LD  A,(DE)
00175C 575C B7               4      OR  A
00175D 575D 2804            12      JR  Z,_SX5A2
00175F 575F 13               6      INC DE
001760 5760 04               4      INC B
001761 5761 18F8            12      JR  _SX5A1
                                
       5763                     _SX5A2:
001763 5763 78               4      LD  A,B
001764 5764 CD264B          17      CALL    FILE_BDOS
001767 5767 CD8A4F          17      CALL    ROM_CD
00176A 576A 9F               4      SBC A,A
00176B 576B C9              10      RET
                                
       576C                     INIT_FILE:
00176C 576C EB               4      EX  DE,HL
00176D 576D 11F8F2          10      LD  DE,FDRV
001770 5770 010C00          10      LD  BC,1+8+3
       5773                     INIT_FILE1:
001773 5773 EDB0                    LDIR
001775 5775 CD9053          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_MORMAL32K_OR_ASCII16
001778 5778 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
00177B 577B 2AEBF2          16      LD  HL,(_CD)
00177E 577E 22F6F2          16      LD  (_CDX),HL           ;カレントディレクトリ
001781 5781 C9              10      RET
                                
       5782                     ZERO_MEMORY_DE:
001782 5782 AF               4      XOR A
       5783                     FILL_MEMORY_DE:
001783 5783 12               7      LD  (DE),A
001784 5784 13               6      INC DE
001785 5785 10FC            13      DJNZ    FILL_MEMORY_DE
001787 5787 C9              10      RET
                                
001788 5788                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 ED5303543454ED53        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 ED53ED5339547A54        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 4154ED5394542855        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 E855EE55F555FE55        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 545662569A56ED53        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 AF56ED53ED53ED53        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 C856CD56D156D756        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 ED53ED53ED53FD56        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 1657ED53ED531F57        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 ED53ED533A55ED53        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 4055ED53ED534F57        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 ED53ED535657ED53        DW  _ERROR,_ERROR,_SYS5A,_ERROR
001FB8 5FB8 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 ED53ED53ED53ED53        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
[EOF:DISKROM32.ASM:UTF_8]
