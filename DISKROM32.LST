                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
       0001                     USE_MORMAL32K_OR_ASCII16        EQU 1   ;ノーマル32KB/ASCII-16K ROMを作成する
                                
                                    INCLUDE "DISKROM.ASM"
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FDDB                     H_PINL  EQU 0FDDBH
                                
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                            ;ASCII-16K
       6000                     ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
       7000                     ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
                                BANK0_SEL EQU   06000H  ;6000-67FF
                                BANK1_SEL EQU   06800H  ;6800-6FFF
                                BANK2_SEL EQU   07000H  ;7000-77FF
                                BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
                                KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
                                KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
                                KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
                                KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
                                KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
                                KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
                                KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
       F280                     ISC EQU 0F280H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F280                     SP32    EQU 0F280H
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM    ; Main program execution address.
000004 4004 014F                    DW  STATEMENT   ; STATEMENT
000006 4006 1250                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C39350          10      JP  DISKIO
000013 4013 C3D950          10      JP  DSKCHG
000016 4016 C32F51          10      JP  GETDPB
000019 4019 C32252          10      JP  CHOICE
00001C 401C C32652          10      JP  DSKFMT
00001F 401F C32852          10      JP  DSKSTP
000022 4022 C32952          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C32652          10      JP  DSKFMT
000029 4029 C32852          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C36252          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.4.1.0",0
            204449534B20524F    
            4D204C6974652076    
            302E342E312E3000    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 AF               4      XOR A
000107 4107 2100F3          10      LD  HL,0F300H
00010A 410A 0668             7      LD  B,068H
00010C 410C CDBA4B          17      CALL    FILL_MEMORY
                                
00010F 410F 3E01             7      LD  A,1
000111 4111 3221FB          13      LD  (DRVTBL),A
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
000114 4114 2A74F6          16      LD  HL,(STKTOP) ;起動時の空き容量表示の為
000117 4117 01C0FE          10      LD  BC,-00140H
00011A 411A 09              11      ADD HL,BC
00011B 411B 2274F6          16      LD  (STKTOP),HL
                                #else
                                    LD  HL,STKTOP+1 ;起動時の空き容量表示の為
                                    DEC (HL)
                                #endif
                                
00011E 411E AF               4      XOR A
00011F 411F 32DDF2          13      LD  (_DVSW),A
000122 4122 3D               4      DEC A       ;0FFH
000123 4123 3299FD          13      LD  (DEVICE),A
                                
000126 4126 21E242          10      LD  HL,AT_ISC
000129 4129 1180F2          10      LD  DE,ISC
00012C 412C 017B00          10      LD  BC,ISC_E-ISC
00012F 412F EDB0                    LDIR
                                    
000131 4131 3EC3             7      LD  A,0C3H      ;JP
000133 4133 3243FF          13      LD  (H_GONE),A
000136 4136 327DF3          13      LD  (BDOS),A
000139 4139 326BF3          13      LD  (RAMUSE),A
00013C 413C 3268F3          13      LD  (ROMUSE),A
00013F 413F 2180F2          10      LD  HL,REPLACE_COMMAND
000142 4142 2244FF          16      LD  (H_GONE+1),HL
000145 4145 2131F3          10      LD  HL,H_BDOS
000148 4148 227EF3          16      LD  (BDOS+1),HL
00014B 414B 21B0F2          10      LD  HL,RAMUSE1
00014E 414E 226CF3          16      LD  (RAMUSE+1),HL
000151 4151 21ABF2          10      LD  HL,ROMUSE1
000154 4154 2269F3          16      LD  (ROMUSE+1),HL
                                
000157 4157 3E                      DB  03EH
000158 4158 F7              12      RST 30H
000159 4159 3271FE          13      LD  (H_BINS),A
00015C 415C 3276FE          13      LD  (H_BINL),A
00015F 415F 327BFE          13      LD  (H_FILE),A
000162 4162 3231F3          13      LD  (H_BDOS),A
000165 4165 32DBFD          13      LD  (H_PINL),A
000168 4168 32A7FF          13      LD  (H_PHYD),A
                                
00016B 416B CD2E42          17      CALL    GTSL1_
00016E 416E 3297F2          13      LD  (ROM_SLT),A
000171 4171 32A7F2          13      LD  (ROM_SLT_COPY),A
000174 4174 3272FE          13      LD  (H_BINS+1),A
000177 4177 3277FE          13      LD  (H_BINL+1),A
00017A 417A 327CFE          13      LD  (H_FILE+1),A
00017D 417D 3232F3          13      LD  (H_BDOS+1),A
000180 4180 32DCFD          13      LD  (H_PINL+1),A
000183 4183 32A8FF          13      LD  (H_PHYD+1),A
000186 4186 3222FB          13      LD  (DRVTBL+1),A
000189 4189 3248F3          13      LD  (MASTERS),A
                                
00018C 418C 21A745          10      LD  HL,ROM_LOAD
00018F 418F 2273FE          16      LD  (H_BINS+2),HL
000192 4192 215747          10      LD  HL,ROM_RUN
000195 4195 2278FE          16      LD  (H_BINL+2),HL
000198 4198 216547          10      LD  HL,ROM_FILES
00019B 419B 227DFE          16      LD  (H_FILE+2),HL
00019E 419E 21C352          10      LD  HL,ROM_BDOS
0001A1 41A1 2233F3          16      LD  (H_BDOS+2),HL
0001A4 41A4 219A43          10      LD  HL,ROM_BOOT
0001A7 41A7 22DDFD          16      LD  (H_PINL+2),HL
0001AA 41AA 219350          10      LD  HL,DISKIO
0001AD 41AD 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001B0 41B0 3E                      DB  03EH
0001B1 41B1 C9              10      RET
0001B2 41B2 327FFE          13      LD  (H_FILE+4),A
0001B5 41B5 3275FE          13      LD  (H_BINS+4),A
0001B8 41B8 327AFE          13      LD  (H_BINL+4),A
0001BB 41BB 3235F3          13      LD  (H_BDOS+4),A
0001BE 41BE 32DFFD          13      LD  (H_PINL+4),A
0001C1 41C1 32ABFF          13      LD  (H_PHYD+4),A
                                
0001C4 41C4 AF               4      XOR A
                                #if exists USE_MORMAL32K_OR_ASCII16
0001C5 41C5 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001C8 41C8 3A0060          13      LD  A,(BANK1_ADR)
0001CB 41CB FE41             7      CP  'A'
                                #if exists USE_MORMAL32K_OR_ASCII16
0001CD 41CD 284E            12      JR  Z,NOT_BANK_TYPE
0001CF 41CF 3E01             7      LD  A,DISK_BANK
0001D1 41D1 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    JR  NZ,NOT_BANK_TYPE
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001D4 41D4 CD3801          17      CALL    RSLREG      ;read primary slot #
0001D7 41D7 07               4      RLCA
0001D8 41D8 07               4      RLCA
0001D9 41D9 F5              11      PUSH    AF
0001DA 41DA 1605             7      LD  D,4+1
0001DC 41DC CD3542          17      CALL    GTSL2_
0001DF 41DF 3244F3          13      LD  (RAMAD3),A
0001E2 41E2 F1              10      POP AF
0001E3 41E3 07               4      RLCA
0001E4 41E4 07               4      RLCA
0001E5 41E5 1603             7      LD  D,2+1
0001E7 41E7 CD3542          17      CALL    GTSL2_
0001EA 41EA 2680             7      LD  H,080H
0001EC 41EC CD5242          17      CALL    CHK_RAM
0001EF 41EF 3243F3          13      LD  (RAMAD2),A
       41F2                     RAMCHK2:
0001F2 41F2 3A44F3          13      LD  A,(RAMAD3)
0001F5 41F5 2640             7      LD  H,040H
0001F7 41F7 CD5242          17      CALL    CHK_RAM
0001FA 41FA 3242F3          13      LD  (RAMAD1),A
       41FD                     RAMCHK1:
0001FD 41FD 3A44F3          13      LD  A,(RAMAD3)
000200 4200 2600             7      LD  H,00H
000202 4202 CD5242          17      CALL    CHK_RAM
000205 4205 3241F3          13      LD  (RAMAD0),A
       4208                     RAMCHK0:
000208 4208 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
00020B 420B 010F00          10      LD  BC,0000FH       ;切り上げ
00020E 420E 09              11      ADD HL,BC
00020F 420F 7D               4      LD  A,L
                                
000210 4210 0604             7      LD  B,4
       4212                     B_DRIVE1:
000212 4212 CB3C             8      SRL H
000214 4214 1F               4      RRA
000215 4215 10FB            13      DJNZ    B_DRIVE1
                                
000217 4217 C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000219 4219 32DCF2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
00021C 421C C9              10      RET
                                
       421D                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
00021D 421D 21DD43          10      LD  HL,MSG_ERROR_ROM_MODE
000220 4220 CD6043          17      CALL    MSX
000223 4223 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000227 4227 DD219F00        14      LD  IX,CHGET
00022B 422B C31C00          10      JP  _CALSLT
                                
       422E                     GTSL1_:             ;自分のいるスロットを知る
00022E 422E CD3801          17      CALL    RSLREG      ;read primary slot #
000231 4231 0F               4      RRCA
000232 4232 0F               4      RRCA
000233 4233 1601             7      LD  D,1
       4235                     GTSL2_:
000235 4235 E603             7      AND 3       ;[A]=000000PP
000237 4237 5F               4      LD  E,A     ;[E]=000000PP
000238 4238 21C1FC          10      LD  HL,EXPTBL
00023B 423B 85               4      ADD A,L     ;桁上りは無い
00023C 423C 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
00023D 423D 7B               4      LD  A,E     ;[A]=000000PP
00023E 423E CB7E            13      BIT 7,(HL)
000240 4240 C8              11      RET Z
000241 4241 7D               4      LD  A,L     ;point to SLTTBL entry
000242 4242 C604             7      ADD A,4     ;桁上りは無い
000244 4244 6F               4      LD  L,A
000245 4245 7E               7      LD  A,(HL)      ;get currently expansion slot register
       4246                     GTSL3_:
000246 4246 15               4      DEC D
000247 4247 2803            12      JR  Z,GTSL4_:
000249 4249 0F               4      RRCA
00024A 424A 18FA            12      JR  GTSL3_:
       424C                     GTSL4_:
00024C 424C E60C             7      AND 00CH        ;[A] = 0000SS00
00024E 424E B3               4      OR  E       ;[A] = 0000SSPP
00024F 424F F680             7      OR  080H        ;[A] = 1000SSPP
000251 4251 C9              10      RET
                                
       4252                     CHK_RAM:
000252 4252 E5              11      PUSH    HL
000253 4253 CDA742          17      CALL    CHK_RAM0
000256 4256 E1              10      POP HL
000257 4257 C8              11      RET Z
000258 4258 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
00025B 425B E680             7      AND 080H
00025D 425D CD7E42          17      CALL    CHK_RAM_SLT
000260 4260 C8              11      RET Z
000261 4261 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000264 4264 E680             7      AND 080H
000266 4266 C601             7      ADD A,1
000268 4268 CD7E42          17      CALL    CHK_RAM_SLT
00026B 426B C8              11      RET Z
00026C 426C 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00026F 426F E680             7      AND 080H
000271 4271 C602             7      ADD A,2
000273 4273 CD7E42          17      CALL    CHK_RAM_SLT
000276 4276 C8              11      RET Z
000277 4277 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
00027A 427A E680             7      AND 080H
00027C 427C C603             7      ADD A,3
       427E                     CHK_RAM_SLT:
00027E 427E E5              11      PUSH    HL
00027F 427F CDA742          17      CALL    CHK_RAM0        ;スロット#X or X-0
000282 4282 E1              10      POP HL
000283 4283 C8              11      RET Z
000284 4284 CB79             8      BIT 7,C
000286 4286 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000288 4288 79               4      LD  A,C
000289 4289 C604             7      ADD A,4*1           ;スロット#X-1
00028B 428B E5              11      PUSH    HL
00028C 428C CDA742          17      CALL    CHK_RAM0
00028F 428F E1              10      POP HL
000290 4290 C8              11      RET Z
000291 4291 79               4      LD  A,C
000292 4292 C608             7      ADD A,4*2           ;スロット#X-2
000294 4294 E5              11      PUSH    HL
000295 4295 CDA742          17      CALL    CHK_RAM0
000298 4298 E1              10      POP HL
000299 4299 C8              11      RET Z
00029A 429A 79               4      LD  A,C
00029B 429B C60C             7      ADD A,4*3           ;スロット#X-3
00029D 429D E5              11      PUSH    HL
00029E 429E CDA742          17      CALL    CHK_RAM0
0002A1 42A1 E1              10      POP HL
       42A2                     CHK_RAM_E:
0002A2 42A2 AF               4      XOR A
0002A3 42A3 3C               4      INC A           ;ZF=0にする
0002A4 42A4 3E00             7      LD  A,0
0002A6 42A6 C9              10      RET
                                
       42A7                     CHK_RAM0:
0002A7 42A7 4F               4      LD  C,A
0002A8 42A8 3A97F2          13      LD  A,(ROM_SLT)
0002AB 42AB B9               4      CP  C
0002AC 42AC 28F4            12      JR  Z,CHK_RAM_E
0002AE 42AE 2E00             7      LD  L,0
       42B0                     CHK_RAM1:
0002B0 42B0 79               4      LD  A,C
0002B1 42B1 CD9243          17      CALL    RDSLTX
0002B4 42B4 C6E5             7      ADD A,0E5H
0002B6 42B6 47               4      LD  B,A
0002B7 42B7 5F               4      LD  E,A
0002B8 42B8 79               4      LD  A,C
0002B9 42B9 C5              11      PUSH    BC
0002BA 42BA CD1400          17      CALL    _WRSLT
0002BD 42BD C1              10      POP BC
0002BE 42BE 79               4      LD  A,C
0002BF 42BF CD9243          17      CALL    RDSLTX
0002C2 42C2 B8               4      CP  B
0002C3 42C3 C0              11      RET NZ
0002C4 42C4 D6E5             7      SUB 0E5H
0002C6 42C6 79               4      LD  A,C
0002C7 42C7 5F               4      LD  E,A
0002C8 42C8 C5              11      PUSH    BC
0002C9 42C9 CD1400          17      CALL    _WRSLT
0002CC 42CC C1              10      POP BC
0002CD 42CD 24               4      INC H
0002CE 42CE 7D               4      LD  A,L
0002CF 42CF C604             7      ADD A,4
0002D1 42D1 6F               4      LD  L,A
0002D2 42D2 20DC            12      JR  NZ,CHK_RAM1
0002D4 42D4 79               4      LD  A,C     ;ZF=1のハズ
0002D5 42D5 C9              10      RET
                                
       42D6                     CALSLT_R:
0002D6 42D6 C5              11      PUSH    BC
0002D7 42D7 E5              11      PUSH    HL
0002D8 42D8 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0002DC 42DC CD1C00          17      CALL    _CALSLT
0002DF 42DF E1              10      POP HL
0002E0 42E0 C1              10      POP BC
0002E1 42E1 C9              10      RET
                                
       42E2                     AT_ISC:
0002E2 F280                         ORG ISC,AT_ISC-RUN
       F280                     REPLACE_COMMAND:
0002E2 F280 FEB7             7      CP  0B7H            ;FILES
0002E4 F282 CC7BFE          17      CALL    Z,H_FILE
0002E7 F285 FEB5             7      CP  0B5H            ;LOAD
0002E9 F287 CA71FE          10      JP  Z,H_BINS
0002EC F28A FE8A             7      CP  08AH            ;RUN
0002EE F28C CA76FE          10      JP  Z,H_BINL
0002F1 F28F FED6             7      CP  0D6H            ;COPY
0002F3 F291 2813            12      JR  Z,FIX_COPY
0002F5 F293 FECF             7      CP  0CFH            ;BLOAD
0002F7 F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
0002F8 F296 F7              12      RST 30H
       F297                     ROM_SLT:
0002F9 F297 00                      DB  0
0002FA F298 8946                    DW  ROM_BLOAD
0002FC F29A F5              11      PUSH    AF
0002FD F29B E5              11      PUSH    HL
0002FE F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
000301 F29F E1              10      POP HL
000302 F2A0 F1              10      POP AF
000303 F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
000305 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
000307 F2A5 C9              10      RET
       F2A6                     FIX_COPY:
000308 F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
000309 F2A7 00                      DB  0
00030A F2A8 0748                    DW  ROM_COPY
00030C F2AA C9              10      RET
       F2AB                     ROMUSE1:
00030D F2AB 3A97F2          13      LD  A,(ROM_SLT)
000310 F2AE 1803            12      JR  ROMUSE2
       F2B0                     RAMUSE1:
000312 F2B0 3A42F3          13      LD  A,(RAMAD1)
       F2B3                     ROMUSE2:
000315 F2B3 C32400          10      JP  _ENASLT
                                
       F2B6                     _RESULT:
000318 F2B6 00                      DB  0
       F2B7                     _BANK:
000319 F2B7 00                      DB  0
       F2B8                     _BANK1:
00031A F2B8 00                      DB  0
       F2B9                     CLSZ:               ;クラスタサイズ
00031B F2B9 0004                    DW  1024
       F2BA                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2BB                     SECSZ:              ;セクタサイズ
00031D F2BB 0002                    DW  512
       F2BC                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2BD                     RR_LOW:
00031F F2BD 0000                    DW  0
       F2BE                     RR_MID  EQU $-1
       F2BF                     RR_HIGH:
000321 F2BF 0000                    DW  0
       F2C1                     _CLPS:
000323 F2C1 0000                    DW  0
       F2C3                     _LEFT:
000325 F2C3 0000                    DW  0
       F2C5                     _DTPS:
000327 F2C5 0000                    DW  0
       F2C7                     _DTA:
000329 F2C7 0000                    DW  0
       F2C9                     FLG_LDIR:
00032B F2C9 00                      DB  0
       F2CA                     _FCB:
00032C F2CA 0000                    DW  0
       F2CC                     _BUF:
       F2CC                     _BUF_LO:        ;LOGICAL OPERATION
00032E F2CC 00                      DB  0
       F2CD                     _BUF_ST:
00032F F2CD 0000                    DW  0
       F2CF                     _BUF_EN:
000331 F2CF 0000                    DW  0
       F2D1                     _BUF_EX:
       F2D1                     _BUF_W:
000333 F2D1 0000                    DW  0
       F2D3                     _BUF_H:
000335 F2D3 0000                    DW  0
       F2D5                     _BUF_X:
000337 F2D5 0000                    DW  0
       F2D7                     _BUF_Y:
000339 F2D7 00                      DB  0
       F2D8                     _BUF_P:
00033A F2D8 00                      DB  0
       F2D9                     _BUF_O:
00033B F2D9 00                      DB  0
       F2DA                     DTAX:
00033C F2DA 0000                    DW  0
       F2DC                     B_DRIVE:
00033E F2DC 00                      DB  0
       F2DD                     _DVSW:          ;カレントドライブ
00033F F2DD 00                      DB  0
       F2DE                     _CD:            ;カレントディレクトリ
000340 F2DE 0000                    DW  0
       F2E0                     DIRENT1:
000342 F2E0 0000                    DW  0
       F2E2                     _DIR_BANK:
000344 F2E2 00                      DB  0
       F2E3                     LEFTX:
000345 F2E3 0000                    DW  0
       F2E5                     PARAM0:
000347 F2E5 0000                    DW  0
       F2E7                     PARAM1:
000349 F2E7 0000                    DW  0
       F2E9                     _CDX:
00034B F2E9 0000                    DW  0
       F2EB                     FDRV:
00034D F2EB 00                      DB  0
       F2EC                     FNAME:
00034E F2EC                         DS  8+3
       F2F7                     _HL:
000359 F2F7 0000                    DW  0
       F2F9                     _SP:
00035B F2F9 0000                    DW  0
       F2FA                     _SP_H   EQU $-1
       F2FB                     ISC_E:
00035D 435D                         ORG $$+RUN          ;$DEPHASE
                                
       435D                     MSX1:
00035D 435D CDDC52          17      CALL    MSGA1
       4360                     MSX:
000360 4360 7E               7      LD  A,(HL)
000361 4361 23               6      INC HL
000362 4362 B7               4      OR  A
000363 4363 20F8            12      JR  NZ,MSX1
000365 4365 C9              10      RET
                                
       4366                     PRTHX:
000366 4366 F5              11      PUSH    AF
000367 4367 07               4      RLCA
000368 4368 07               4      RLCA
000369 4369 07               4      RLCA
00036A 436A 07               4      RLCA
00036B 436B CD6F43          17      CALL    PRTA2
00036E 436E F1              10      POP AF
       436F                     PRTA2:
00036F 436F CD7543          17      CALL    ASC
000372 4372 C3D852          10      JP  MSG_A
                                    
       4375                     ASC:
000375 4375 E60F             7      AND $0F
000377 4377 F630             7      OR  $30
000379 4379 FE3A             7      CP  $3A
00037B 437B D8              11      RET C
00037C 437C C607             7      ADD A,7
00037E 437E C9              10      RET
                                
       437F                     MSN:
                                #if exists USE_MORMAL32K_OR_ASCII16
00037F 437F CD8B43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000382 4382 23               6      INC HL
000383 4383 CDD852          17      CALL    MSG_A
000386 4386 10F7            13      DJNZ    MSN
000388 4388 C9              10      RET
                                
       4389                     RDSLT_ROM3:
000389 4389 7E               7      LD  A,(HL)
00038A 438A C9              10      RET
       438B                     RDSLT_ROM:
00038B 438B CB7C             8      BIT 7,H
00038D 438D 28FA            12      JR  Z,RDSLT_ROM3
       438F                     RDSLT_ROM2:
00038F 438F 3A97F2          13      LD  A,(ROM_SLT)
       4392                     RDSLTX:
000392 4392 C5              11      PUSH    BC
000393 4393 D5              11      PUSH    DE
000394 4394 CD0C00          17      CALL    _RDSLT
000397 4397 D1              10      POP DE
000398 4398 C1              10      POP BC
000399 4399 C9              10      RET
                                
       439A                     ROM_BOOT:
00039A 439A 3E                      DB  03EH
00039B 439B C9              10      RET
00039C 439C 32DBFD          13      LD  (H_PINL),A
00039F 439F 3ACAFF          13      LD  A,(EXTBIO)
0003A2 43A2 FEF7             7      CP  0F7H        ;RST 30H
0003A4 43A4 280A            12      JR  Z,EXTBIO_OK
0003A6 43A6 3E                      DB  03EH
0003A7 43A7 C9              10      RET
0003A8 43A8 21CAFF          10      LD  HL,EXTBIO
0003AB 43AB 061D             7      LD  B,29
0003AD 43AD CDBA4B          17      CALL    FILL_MEMORY
       43B0                     EXTBIO_OK:
0003B0 43B0 21FA43          10      LD  HL,DELOK
0003B3 43B3 CD6043          17      CALL    MSX
                                
0003B6 43B6 AF               4      XOR A
0003B7 43B7 3240F3          13      LD  (REBOOT),A
0003BA 43BA 2A48FC          16      LD  HL,(BOTTOM)
0003BD 43BD 110040          10      LD  DE,16384
0003C0 43C0 19              11      ADD HL,DE
0003C1 43C1 3817            12      JR  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
0003C3 43C3 57               4      LD  D,A
0003C4 43C4 0601             7      LD  B,1
0003C6 43C6 2100C0          10      LD  HL,0C000H
0003C9 43C9 CD9350          17      CALL    DISKIO
                                
0003CC 43CC 116BF3          10      LD  DE,RAMUSE
0003CF 43CF AF               4      XOR A
0003D0 43D0 CD1EC0          17      CALL    0C01EH
0003D3 43D3 116BF3          10      LD  DE,RAMUSE
0003D6 43D6 37               4      SCF
0003D7 43D7 CD1EC0          17      CALL    0C01EH
       43DA                     BOOT1:
0003DA 43DA C32952          10      JP  BASENT
                                
       43DD                     MSG_ERROR_ROM_MODE:
                                #if exists USE_MORMAL32K_OR_ASCII16
0003DD 43DD 4E6F726D616C2052        DB  "Normal ROM/ASCII-16K only!",13,10
            4F4D2F4153434949    
            2D31364B206F6E6C    
            79210D0A            
                                #else
                                    DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
                                #endif
       43F9                     NULL:
0003F9 43F9 00                      DB  0
       43FA                     DELOK:
0003FA 43FA 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       43FE                     ROM_LDIR:
0003FE 43FE 3AC9F2          13      LD  A,(FLG_LDIR)
000401 4401 B7               4      OR  A
000402 4402 206A            12      JR  NZ,ROM_LDIRVM
000404 4404 CB7A             8      BIT 7,D
000406 4406 CA9E44          10      JP  Z,ROM_LDIRSLT
                                #if exists USE_MORMAL32K_OR_ASCII16
       4409                     LDIRA:
000409 4409 F3               4      DI
00040A 440A ED73F9F2        20      LD  (_SP),SP
00040E 440E 3AFAF2          13      LD  A,(_SP_H)
000411 4411 FEC0             7      CP  0C0H
000413 4413 3003            12      JR  NC,SPJ1
000415 4415 3180F2          10      LD  SP,SP32
       4418                     SPJ1:
       4418                     LDIR1:
000418 4418 78               4      LD  A,B
000419 4419 B1               4      OR  C
00041A 441A 284D            12      JR  Z,LDIRE
                                
00041C 441C C5              11      PUSH    BC
00041D 441D D5              11      PUSH    DE
00041E 441E E5              11      PUSH    HL
00041F 441F 3A97F2          13      LD  A,(ROM_SLT)
000422 4422 2680             7      LD  H,080H
000424 4424 CD2400          17      CALL    _ENASLT
000427 4427 E1              10      POP HL
000428 4428 D1              10      POP DE
000429 4429 C1              10      POP BC
       442A                     LDIR2:
00042A 442A 7A               4      LD  A,D
00042B 442B FEC0             7      CP  0C0H
00042D 442D 302C            12      JR  NC,LDIR4
                                
00042F 442F C5              11      PUSH    BC
000430 4430 D5              11      PUSH    DE
000431 4431 115EF5          10      LD  DE,BUF
                                
000434 4434 78               4      LD  A,B
000435 4435 B7               4      OR  A
000436 4436 2803            12      JR  Z,LDIR3
000438 4438 010001          10      LD  BC,00100H
       443B                     LDIR3:
00043B 443B C5              11      PUSH    BC
00043C 443C EDB0                    LDIR
00043E 443E 22F7F2          16      LD  (_HL),HL
                                
000441 4441 3A43F3          13      LD  A,(RAMAD2)
000444 4444 2680             7      LD  H,080H
000446 4446 CD2400          17      CALL    _ENASLT
                                
000449 4449 C1              10      POP BC
00044A 444A D1              10      POP DE
00044B 444B 215EF5          10      LD  HL,BUF
00044E 444E EDB0                    LDIR
                                
000450 4450 2AF7F2          16      LD  HL,(_HL)
000453 4453 C1              10      POP BC
000454 4454 78               4      LD  A,B
000455 4455 B7               4      OR  A
000456 4456 2811            12      JR  Z,LDIRE
000458 4458 05               4      DEC B
000459 4459 18BD            12      JR  LDIR1
       445B                     LDIR4:
                                #endif
00045B 445B EDB0                    LDIR
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
       445D                     LDIRE2:
00045D 445D D5              11      PUSH    DE
00045E 445E E5              11      PUSH    HL
00045F 445F 3A43F3          13      LD  A,(RAMAD2)
000462 4462 2680             7      LD  H,080H
000464 4464 CD2400          17      CALL    _ENASLT
000467 4467 E1              10      POP HL
000468 4468 D1              10      POP DE
       4469                     LDIRE:
000469 4469 ED7BF9F2        20      LD  SP,(_SP)
                                #endif
00046D 446D C9              10      RET
                                
       446E                     ROM_LDIRVM:
                                #if exists USE_MORMAL32K_OR_ASCII16
00046E 446E F3               4      DI
00046F 446F ED73F9F2        20      LD  (_SP),SP
000473 4473 3AFAF2          13      LD  A,(_SP_H)
000476 4476 FEC0             7      CP  0C0H
000478 4478 3003            12      JR  NC,SPJ2
00047A 447A 3180F2          10      LD  SP,SP32
       447D                     SPJ2:
00047D 447D C5              11      PUSH    BC
00047E 447E D5              11      PUSH    DE
00047F 447F E5              11      PUSH    HL
000480 4480 3A97F2          13      LD  A,(ROM_SLT)
000483 4483 2680             7      LD  H,080H
000485 4485 CD2400          17      CALL    _ENASLT
000488 4488 E1              10      POP HL
000489 4489 D1              10      POP DE
00048A 448A C1              10      POP BC
                                #endif
00048B 448B C5              11      PUSH    BC
00048C 448C D5              11      PUSH    DE
00048D 448D FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000491 4491 DD215C00        14      LD  IX,LDIRVM
000495 4495 CD1C00          17      CALL    _CALSLT
000498 4498 E1              10      POP HL
000499 4499 C1              10      POP BC
00049A 449A 09              11      ADD HL,BC
00049B 449B EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
00049C 449C 18BF            12      JR  LDIRE2
                                #else
                                    RET
                                #endif
                                
       449E                     ROM_LDIRSLT:
                                #if exists USE_MORMAL32K_OR_ASCII16
00049E 449E F3               4      DI
00049F 449F ED73F9F2        20      LD  (_SP),SP
0004A3 44A3 3AFAF2          13      LD  A,(_SP_H)
0004A6 44A6 FEC0             7      CP  0C0H
0004A8 44A8 3003            12      JR  NC,SPJ3
0004AA 44AA 3180F2          10      LD  SP,SP32
       44AD                     SPJ3:
0004AD 44AD C5              11      PUSH    BC
0004AE 44AE D5              11      PUSH    DE
0004AF 44AF E5              11      PUSH    HL
0004B0 44B0 3A97F2          13      LD  A,(ROM_SLT)
0004B3 44B3 2680             7      LD  H,080H
0004B5 44B5 CD2400          17      CALL    _ENASLT
0004B8 44B8 E1              10      POP HL
0004B9 44B9 D1              10      POP DE
0004BA 44BA C1              10      POP BC
                                #endif
       44BB                     ROM_LDIRSLT1:
0004BB 44BB EB               4      EX  DE,HL
       44BC                     RLDIRSLT1:
0004BC 44BC CB7C             8      BIT 7,H
0004BE 44BE 2021            12      JR  NZ,RLDIRSLT_EXIT
0004C0 44C0 1A               7      LD  A,(DE)
0004C1 44C1 13               6      INC DE
0004C2 44C2 C5              11      PUSH    BC
0004C3 44C3 D5              11      PUSH    DE
0004C4 44C4 E5              11      PUSH    HL
0004C5 44C5 5F               4      LD  E,A
                                
0004C6 44C6 0141F3          10      LD  BC,RAMAD0
0004C9 44C9 7C               4      LD  A,H
0004CA 44CA 07               4      RLCA
0004CB 44CB 07               4      RLCA
0004CC 44CC E603             7      AND 3
0004CE 44CE 81               4      ADD A,C
0004CF 44CF 4F               4      LD  C,A
0004D0 44D0 0A               7      LD  A,(BC)
       44D1                     RLDIRSLT2:
0004D1 44D1 CD1400          17      CALL    _WRSLT
0004D4 44D4 08               4      EX  AF,AF'
0004D5 44D5 E1              10      POP HL
0004D6 44D6 D1              10      POP DE
0004D7 44D7 C1              10      POP BC
0004D8 44D8 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0004DA 44DA EABC44          10      JP  PE,RLDIRSLT1
0004DD 44DD EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
0004DE 44DE C35D44          10      JP  LDIRE2
       44E1                     RLDIRSLT_EXIT:
0004E1 44E1 EB               4      EX  DE,HL
0004E2 44E2 C31844          10      JP  LDIR1
                                #else
                                    RET
                                RLDIRSLT_EXIT:
                                    EX  DE,HL
                                    LDIR
                                    RET
                                #endif
                                
       44E5                     END_OF_LINE:
0004E5 44E5 215EF5          10      LD  HL,BUF
       44E8                     EOL1:
0004E8 44E8 7E               7      LD  A,(HL)
0004E9 44E9 C8              11      RET Z
0004EA 44EA FE0D             7      CP  00DH
0004EC 44EC 2807            12      JR  Z,EOLE
0004EE 44EE FE0A             7      CP  00AH
0004F0 44F0 2803            12      JR  Z,EOLE
0004F2 44F2 23               6      INC HL
0004F3 44F3 18F3            12      JR  EOL1
       44F5                     EOLE:
0004F5 44F5 3600            10      LD  (HL),0
0004F7 44F7 23               6      INC HL
0004F8 44F8 7E               7      LD  A,(HL)
0004F9 44F9 FE0A             7      CP  00AH
0004FB 44FB C0              11      RET NZ
0004FC 44FC 23               6      INC HL
0004FD 44FD C9              10      RET
                                
       44FE                     ROM_LOAD_ASCII:
0004FE 44FE 210000          10      LD  HL,0
000501 4501 22CDF2          16      LD  (_BUF_ST),HL    ;読み出し位置
000504 4504 2A76F6          16      LD  HL,(TXTTAB)
000507 4507 22CFF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
00050A 450A 215EF5          10      LD  HL,BUF
00050D 450D 22C7F2          16      LD  (_DTA),HL
       4510                     RLOAD_A1:
000510 4510 2ACDF2          16      LD  HL,(_BUF_ST)
000513 4513 22BDF2          16      LD  (RR_LOW),HL
000516 4516 210201          10      LD  HL,258
000519 4519 CD274A          17      CALL    ROM_READ
00051C 451C 7C               4      LD  A,H
00051D 451D B5               4      OR  L
00051E 451E 2879            12      JR  Z,RLOAD_AEND
000520 4520 015EF5          10      LD  BC,BUF
000523 4523 09              11      ADD HL,BC
000524 4524 3600            10      LD  (HL),0
000526 4526 CDE544          17      CALL    END_OF_LINE
000529 4529 015EF5          10      LD  BC,BUF
00052C 452C A7               4      AND A
00052D 452D ED42            15      SBC HL,BC
00052F 452F 2810            12      JR  Z,RLOAD_A2
000531 4531 4D               4      LD  C,L
000532 4532 44               4      LD  B,H
000533 4533 ED5BCDF2        20      LD  DE,(_BUF_ST)
000537 4537 19              11      ADD HL,DE
000538 4538 22CDF2          16      LD  (_BUF_ST),HL
00053B 453B 3A5EF5          13      LD  A,(BUF)
00053E 453E B7               4      OR  A
00053F 453F 28CF            12      JR  Z,RLOAD_A1
       4541                     RLOAD_A2:
000541 4541 115EF5          10      LD  DE,BUF
000544 4544 CDF14B          17      CALL    SPCUTEX
000547 4547 1A               7      LD  A,(DE)
000548 4548 B7               4      OR  A
000549 4549 284E            12      JR  Z,RLOAD_AEND
00054B 454B CD034C          17      CALL    GETNUM
00054E 454E 7C               4      LD  A,H
00054F 454F B5               4      OR  L
000550 4550 CA7046          10      JP  Z,ERROR_DIRECT_IN_FILE
000553 4553 DD2ACFF2        20      LD  IX,(_BUF_EN)
000557 4557 DD7502          19      LD  (IX+2),L
00055A 455A DD7403          19      LD  (IX+3),H
                                
00055D 455D CDEA4B          17      CALL    SPCUT
000560 4560 EB               4      EX  DE,HL
000561 4561 DDE5            15      PUSH    IX
000563 4563 DD21B242        14      LD  IX,CRUNCH
000567 4567 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00056B 456B CD1C00          17      CALL    _CALSLT
00056E 456E DDE1            14      POP IX
000570 4570 EB               4      EX  DE,HL
000571 4571 111FF4          10      LD  DE,KBUF
000574 4574 37               4      SCF
000575 4575 ED52            15      SBC HL,DE
000577 4577 CA7046          10      JP  Z,ERROR_DIRECT_IN_FILE
00057A 457A DA7046          10      JP  C,ERROR_DIRECT_IN_FILE
00057D 457D 4D               4      LD  C,L
00057E 457E 44               4      LD  B,H
00057F 457F 2ACFF2          16      LD  HL,(_BUF_EN)
000582 4582 110400          10      LD  DE,4
000585 4585 19              11      ADD HL,DE
000586 4586 111FF4          10      LD  DE,KBUF
                                
000589 4589 EB               4      EX  DE,HL
00058A 458A EDB0                    LDIR
00058C 458C EB               4      EX  DE,HL
                                
00058D 458D DD7500          19      LD  (IX+0),L
000590 4590 DD7401          19      LD  (IX+1),H
000593 4593 22CFF2          16      LD  (_BUF_EN),HL
000596 4596 C31045          10      JP  RLOAD_A1
                                
       4599                     RLOAD_AEND:
000599 4599 2ACFF2          16      LD  HL,(_BUF_EN)
00059C 459C AF               4      XOR A
00059D 459D 77               7      LD  (HL),A
00059E 459E 23               6      INC HL
00059F 459F 77               7      LD  (HL),A
0005A0 45A0 23               6      INC HL
0005A1 45A1 22CFF2          16      LD  (_BUF_EN),HL
0005A4 45A4 C33346          10      JP  RLOAD_END1
                                
       45A7                     ROM_LOAD:
0005A7 45A7 CDD547          17      CALL    INIT_PARAM
0005AA 45AA 7E               7      LD  A,(HL)
0005AB 45AB FE2C             7      CP  ','
0005AD 45AD 2003            12      JR  NZ,ROM_LOAD0
0005AF 45AF 23               6      INC HL
0005B0 45B0 7E               7      LD  A,(HL)
0005B1 45B1 2B               6      DEC HL
       45B2                     ROM_LOAD0:
0005B2 45B2 32BEFC          13      LD  (RUNBNF),A
0005B5 45B5 CDC84A          17      CALL    FILE_B
0005B8 45B8 3AECF2          13      LD  A,(FNAME)
0005BB 45BB FE20             7      CP  020H
0005BD 45BD CAC34A          10      JP  Z,ROM_ORG
                                
0005C0 45C0 CD5A4C          17      CALL    ROM_OPEN
0005C3 45C3 DA7C46          10      JP  C,ERROR_FILE_NOT_FOUND
       45C6                     ROM_LOAD1:
0005C6 45C6 21CCF2          10      LD  HL,_BUF
0005C9 45C9 22C7F2          16      LD  (_DTA),HL
0005CC 45CC 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
0005CF 45CF CD274A          17      CALL    ROM_READ
0005D2 45D2 3ACCF2          13      LD  A,(_BUF)
0005D5 45D5 3C               4      INC A
0005D6 45D6 C2FE44          10      JP  NZ,ROM_LOAD_ASCII
0005D9 45D9 2A76F6          16      LD  HL,(TXTTAB)
0005DC 45DC 22C7F2          16      LD  (_DTA),HL
0005DF 45DF EB               4      EX  DE,HL
0005E0 45E0 2100FF          10      LD  HL,-256
0005E3 45E3 39              11      ADD HL,SP
0005E4 45E4 ED52            15      SBC HL,DE
0005E6 45E6 CD274A          17      CALL    ROM_READ
0005E9 45E9 ED5BC7F2        20      LD  DE,(_DTA)
0005ED 45ED 19              11      ADD HL,DE
0005EE 45EE E5              11      PUSH    HL
0005EF 45EF 2A76F6          16      LD  HL,(TXTTAB)
       45F2                     ROM_LOAD2:          ;リンクポインタをFIX
0005F2 45F2 E5              11      PUSH    HL
0005F3 45F3 DDE1            14      POP IX
0005F5 45F5 7E               7      LD  A,(HL)      ;リンクポインタL
0005F6 45F6 23               6      INC HL
0005F7 45F7 B6               7      OR  (HL)        ;リンクポインタH
0005F8 45F8 23               6      INC HL
0005F9 45F9 2837            12      JR  Z,RLOAD_END0
0005FB 45FB 23               6      INC HL      ;行番号
0005FC 45FC 23               6      INC HL      ;行番号
       45FD                     ROM_LOAD3:
0005FD 45FD 7E               7      LD  A,(HL)
0005FE 45FE 23               6      INC HL
0005FF 45FF FE0B             7      CP  00BH        ;8進数(&O)
000601 4601 2822            12      JR  Z,INC_HL2
000603 4603 FE0C             7      CP  00CH        ;16進数(&H)
000605 4605 281E            12      JR  Z,INC_HL2
000607 4607 FE0D             7      CP  00DH        ;行番号(RUN後)
000609 4609 281A            12      JR  Z,INC_HL2
00060B 460B FE0E             7      CP  00EH        ;行番号(RUN前)
00060D 460D 2816            12      JR  Z,INC_HL2
00060F 460F FE0F             7      CP  00FH        ;10～255の整数(%)
000611 4611 2813            12      JR  Z,INC_HL1
000613 4613 FE1C             7      CP  01CH        ;256～65535の整数(%)
000615 4615 280E            12      JR  Z,INC_HL2
000617 4617 FE1D             7      CP  01DH        ;単精度実数(!)
000619 4619 2808            12      JR  Z,INC_HL4
00061B 461B FE1F             7      CP  01FH        ;倍制度実数(#)
00061D 461D 2008            12      JR  NZ,INC_HL0
00061F 461F 23               6      INC HL
000620 4620 23               6      INC HL
000621 4621 23               6      INC HL
000622 4622 23               6      INC HL
       4623                     INC_HL4:
000623 4623 23               6      INC HL
000624 4624 23               6      INC HL
       4625                     INC_HL2:
000625 4625 23               6      INC HL
       4626                     INC_HL1:
000626 4626 23               6      INC HL
       4627                     INC_HL0:
000627 4627 B7               4      OR  A
000628 4628 20D3            12      JR  NZ,ROM_LOAD3
00062A 462A DD7500          19      LD  (IX+0),L
00062D 462D DD7401          19      LD  (IX+1),H
000630 4630 18C0            12      JR  ROM_LOAD2
       4632                     RLOAD_END0:
000632 4632 E1              10      POP HL
       4633                     RLOAD_END1:
000633 4633 22C2F6          16      LD  (VARTAB),HL
000636 4636 22C4F6          16      LD  (ARYTAB),HL
000639 4639 22C6F6          16      LD  (STREND),HL
                                
00063C 463C 3ABEFC          13      LD  A,(RUNBNF)
00063F 463F CD444C          17      CALL    CAP
000642 4642 FE52             7      CP  'R'
000644 4644 280E            12      JR  Z,RLOAD_END2
000646 4646 AF               4      XOR A
000647 4647 21CFF2          10      LD  HL,_BUF+3
00064A 464A 77               7      LD  (HL),A      ;3
00064B 464B 2B               6      DEC HL
00064C 464C 77               7      LD  (HL),A      ;2
00064D 464D 2B               6      DEC HL
00064E 464E 77               7      LD  (HL),A      ;1
00064F 464F 2B               6      DEC HL
000650 4650 3E8F             7      LD  A,08FH      ;REM
000652 4652 77               7      LD  (HL),A      ;0
000653 4653 C9              10      RET
       4654                     RLOAD_END2:
000654 4654 D5              11      PUSH    DE
000655 4655 ED5B76F6        20      LD  DE,(TXTTAB)
000659 4659 1B               6      DEC DE
00065A 465A AF               4      XOR A
00065B 465B 21D2F2          10      LD  HL,_BUF+6
00065E 465E 77               7      LD  (HL),A      ;6
00065F 465F 2B               6      DEC HL
000660 4660 77               7      LD  (HL),A      ;5
000661 4661 2B               6      DEC HL
000662 4662 77               7      LD  (HL),A      ;4
000663 4663 2B               6      DEC HL
000664 4664 72               7      LD  (HL),D      ;3 行番号H
000665 4665 2B               6      DEC HL
000666 4666 73               7      LD  (HL),E      ;2 行番号L
000667 4667 2B               6      DEC HL
000668 4668 360D            10      LD  (HL),00DH   ;1 行番号(RUN後)
00066A 466A 2B               6      DEC HL
00066B 466B 3E89             7      LD  A,089H      ;GOTO
00066D 466D 77               7      LD  (HL),A      ;0
00066E 466E D1              10      POP DE
00066F 466F C9              10      RET
                                
       4670                     ERROR_DIRECT_IN_FILE:
000670 4670 1E39             7      LD  E,57            ;Direct statement in file
000672 4672 01                      DB  1           ;LD BC,
       4673                     ERROR_DEVICE_IO_ERROR:
000673 4673 1E13             7      LD  E,19            ;Device I/O error
000675 4675 01                      DB  1           ;LD BC,
       4676                     ERROR_INTERNAL_ERROR:
000676 4676 1E33             7      LD  E,51            ;Internal error
000678 4678 01                      DB  1           ;LD BC,
       4679                     ERROR_FILE_NOT_OPEN:
000679 4679 1E3B             7      LD  E,59            ;File not OPEN
00067B 467B 01                      DB  1           ;LD BC,
       467C                     ERROR_FILE_NOT_FOUND:
00067C 467C 1E35             7      LD  E,53            ;File not found
       467E                     ERROR:
00067E 467E FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000682 4682 DD216F40        14      LD  IX,ERRHAND
000686 4686 C31C00          10      JP  _CALSLT
                                
       4689                     ROM_BLOAD:
000689 4689 CDD547          17      CALL    INIT_PARAM
00068C 468C CDC84A          17      CALL    FILE_B
00068F 468F CD5A4C          17      CALL    ROM_OPEN
000692 4692 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000694 4694 21CCF2          10      LD  HL,_BUF
000697 4697 22C7F2          16      LD  (_DTA),HL
00069A 469A 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
00069D 469D CD274A          17      CALL    ROM_READ
0006A0 46A0 3ACCF2          13      LD  A,(_BUF)
0006A3 46A3 FEFE             7      CP  0FEH
0006A5 46A5 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
0006A7 46A7 21A5F2          10      LD  HL,BLOAD_RET
0006AA 46AA 229DF2          16      LD  (SWC_BLOAD),HL
                                
0006AD 46AD 2AE7F2          16      LD  HL,(PARAM1)
0006B0 46B0 7E               7      LD  A,(HL)
0006B1 46B1 FE2C             7      CP  ','
0006B3 46B3 2048            12      JR  NZ,RBREAD_MEM
0006B5 46B5 23               6      INC HL
0006B6 46B6 7E               7      LD  A,(HL)
0006B7 46B7 CD444C          17      CALL    CAP
0006BA 46BA 32BEFC          13      LD  (RUNBNF),A
       46BD                     RBOS1:
0006BD 46BD 7E               7      LD  A,(HL)
0006BE 46BE 23               6      INC HL
0006BF 46BF B7               4      OR  A
0006C0 46C0 282F            12      JR  Z,RBREAD_OSE
0006C2 46C2 FE3A             7      CP  ':'
0006C4 46C4 282B            12      JR  Z,RBREAD_OSE
0006C6 46C6 FE2C             7      CP  ','     ;次のパラメータを探す
0006C8 46C8 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
0006CA 46CA 22E7F2          16      LD  (PARAM1),HL
0006CD 46CD 7E               7      LD  A,(HL)
0006CE 46CE B7               4      OR  A
0006CF 46CF 2820            12      JR  Z,RBREAD_OSE
0006D1 46D1 DD21644C        14      LD  IX,FRMEVL
0006D5 46D5 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0006D9 46D9 CD1C00          17      CALL    _CALSLT
0006DC 46DC 22E7F2          16      LD  (PARAM1),HL
0006DF 46DF 3A63F6          13      LD  A,(VALTYP)
0006E2 46E2 FE02             7      CP  2
0006E4 46E4 200B            12      JR  NZ,RBREAD_OSE
0006E6 46E6 2ACDF2          16      LD  HL,(_BUF_ST)
0006E9 46E9 ED5BF8F7        20      LD  DE,(DACDAT)
0006ED 46ED 19              11      ADD HL,DE
0006EE 46EE 22CDF2          16      LD  (_BUF_ST),HL
       46F1                     RBREAD_OSE:
0006F1 46F1 3ABEFC          13      LD  A,(RUNBNF)
0006F4 46F4 FE53             7      CP  'S'
0006F6 46F6 2005            12      JR  NZ,RBREAD_MEM
0006F8 46F8 3E01             7      LD  A,1
0006FA 46FA 32C9F2          13      LD  (FLG_LDIR),A
       46FD                     RBREAD_MEM:
0006FD 46FD 2ACDF2          16      LD  HL,(_BUF_ST)
000700 4700 22BFFC          16      LD  (SAVENT),HL
000703 4703 22C7F2          16      LD  (_DTA),HL
000706 4706 21FFFF          10      LD  HL,0FFFFH
000709 4709 CD274A          17      CALL    ROM_READ
00070C 470C AF               4      XOR A
00070D 470D 32C9F2          13      LD  (FLG_LDIR),A
000710 4710 3ABEFC          13      LD  A,(RUNBNF)
000713 4713 FE52             7      CP  'R'
000715 4715 2006            12      JR  NZ,RBREAD1
000717 4717 2AD1F2          16      LD  HL,(_BUF_EX)
00071A 471A 229DF2          16      LD  (SWC_BLOAD),HL
       471D                     RBREAD1:
       471D                     ROM_NEXT:
00071D 471D 2AE7F2          16      LD  HL,(PARAM1)
000720 4720 7E               7      LD  A,(HL)
000721 4721 2B               6      DEC HL
000722 4722 B7               4      OR  A
000723 4723 2805            12      JR  Z,RN1
000725 4725 FE3A             7      CP  ':'
000727 4727 2801            12      JR  Z,RN1
000729 4729 23               6      INC HL
       472A                     RN1:
00072A 472A 5D               4      LD  E,L
00072B 472B 54               4      LD  D,H
                                
00072C 472C CD1A4C          17      CALL    SEARCH_END
00072F 472F B7               4      OR  A
000730 4730 2821            12      JR  Z,REM
       4732                     RN3:                    ;マルチステートメントの処理
000732 4732 7E               7      LD  A,(HL)
                                
000733 4733 FEB5             7      CP  0B5H            ;LOAD
000735 4735 CAA745          10      JP  Z,ROM_LOAD
000738 4738 FE8A             7      CP  08AH            ;RUN
00073A 473A 281B            12      JR  Z,ROM_RUN
00073C 473C FEB7             7      CP  0B7H            ;FILES
00073E 473E 2825            12      JR  Z,ROM_FILES
000740 4740 FED6             7      CP  0D6H            ;COPY
000742 4742 CA0748          10      JP  Z,ROM_COPY
000745 4745 FE20             7      CP  020H
000747 4747 2807            12      JR  Z,RN_SP
                                
000749 4749 3E28             7      LD  A,028H          ;JR Z,
00074B 474B 32A3F2          13      LD  (SWC_BLOAD_M),A
00074E 474E 7E               7      LD  A,(HL)
00074F 474F C9              10      RET
       4750                     RN_SP:
000750 4750 23               6      INC HL
000751 4751 18DF            12      JR  RN3
                                
       4753                     REM:
000753 4753 EB               4      EX  DE,HL
000754 4754 3E8F             7      LD  A,08FH          ;REM
000756 4756 C9              10      RET
                                
       4757                     ROM_RUN:
000757 4757 23               6      INC HL
000758 4758 7E               7      LD  A,(HL)
000759 4759 2B               6      DEC HL
00075A 475A B7               4      OR  A
00075B 475B C4A745          17      CALL    NZ,ROM_LOAD
00075E 475E FE8F             7      CP  08FH            ;REM
000760 4760 3E8A             7      LD  A,08AH          ;RUN
000762 4762 C0              11      RET NZ
000763 4763 77               7      LD  (HL),A
000764 4764 C9              10      RET
                                
       4765                     ROM_FILES:
000765 4765 CDD547          17      CALL    INIT_PARAM
000768 4768 CDC84A          17      CALL    FILE_B
00076B 476B CD6652          17      CALL    GET_DISK_BANK_FDRV
00076E 476E 3ABCF2          13      LD  A,(SECSZ_H)
000771 4771 CD2451          17      CALL    IS_BPB1
000774 4774 DA7346          10      JP  C,ERROR_DEVICE_IO_ERROR
000777 4777 3AECF2          13      LD  A,(FNAME)
00077A 477A FE21             7      CP  021H
00077C 477C 3005            12      JR  NC,RFILES0
00077E 477E 060B             7      LD  B,11
000780 4780 CDAE4B          17      CALL    FILE10
       4783                     RFILES0:
000783 4783 CDB64E          17      CALL    GET_DIR_DAT
       4786                     RFILES1:
000786 4786 CD764C          17      CALL    FILESE
000789 4789 3045            12      JR  NC,RFILES_NOT_MATCH
       478B                     RFILES_DISP:
00078B 478B E5              11      PUSH    HL
00078C 478C 110B00          10      LD  DE,0000BH   ;属性
00078F 478F 19              11      ADD HL,DE
                                #if exists USE_MORMAL32K_OR_ASCII16
000790 4790 CD8B43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000793 4793 E1              10      POP HL
000794 4794 CB4F             8      BIT 1,A     ;不可視属性
000796 4796 2035            12      JR  NZ,RFILES_NEXT
000798 4798 E5              11      PUSH    HL
000799 4799 0608             7      LD  B,8
00079B 479B CD7F43          17      CALL    MSN
                                #if exists USE_MORMAL32K_OR_ASCII16
00079E 479E CD8B43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
0007A1 47A1 FE20             7      CP  020H
0007A3 47A3 F5              11      PUSH    AF
0007A4 47A4 3E2E             7      LD  A,'.'
0007A6 47A6 C4D852          17      CALL    NZ,MSG_A
0007A9 47A9 0603             7      LD  B,3
0007AB 47AB CD7F43          17      CALL    MSN
0007AE 47AE F1              10      POP AF
0007AF 47AF CCD852          17      CALL    Z,MSG_A
0007B2 47B2 3ADDF3          13      LD  A,(CSRX)
0007B5 47B5 47               4      LD  B,A
0007B6 47B6 3AB0F3          13      LD  A,(LINLEN)
0007B9 47B9 90               4      SUB B
0007BA 47BA FE0C             7      CP  12
0007BC 47BC 3009            12      JR  NC,RFILES2
0007BE 47BE 3E0D             7      LD  A,00DH      ;改行
0007C0 47C0 CDD852          17      CALL    MSG_A
0007C3 47C3 3E0A             7      LD  A,00AH
0007C5 47C5 1802            12      JR  RFILES3
       47C7                     RFILES2:
0007C7 47C7 3E20             7      LD  A,020H
       47C9                     RFILES3:
0007C9 47C9 CDD852          17      CALL    MSG_A
0007CC 47CC E1              10      POP HL
       47CD                     RFILES_NEXT:
0007CD 47CD CD944C          17      CALL    FNEXT
       47D0                     RFILES_NOT_MATCH:
0007D0 47D0 20B4            12      JR  NZ,RFILES1
0007D2 47D2 C31D47          10      JP  ROM_NEXT
                                
       47D5                     INIT_PARAM:
0007D5 47D5 22E5F2          16      LD  (PARAM0),HL
0007D8 47D8 22E7F2          16      LD  (PARAM1),HL
0007DB 47DB EB               4      EX  DE,HL
0007DC 47DC 32BEFC          13      LD  (RUNBNF),A
0007DF 47DF 3263F6          13      LD  (VALTYP),A
0007E2 47E2 E5              11      PUSH    HL
0007E3 47E3 2ADEF2          16      LD  HL,(_CD)
0007E6 47E6 22E9F2          16      LD  (_CDX),HL
0007E9 47E9 E1              10      POP HL
0007EA 47EA 13               6      INC DE
0007EB 47EB CDEA4B          17      CALL    SPCUT
0007EE 47EE 1A               7      LD  A,(DE)
0007EF 47EF B7               4      OR  A
0007F0 47F0 C8              11      RET Z
0007F1 47F1 FE3A             7      CP  ':'
0007F3 47F3 C8              11      RET Z
0007F4 47F4 FE28             7      CP  '('
0007F6 47F6 C8              11      RET Z
0007F7 47F7 EB               4      EX  DE,HL
0007F8 47F8 DD21644C        14      LD  IX,FRMEVL
0007FC 47FC FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000800 4800 CD1C00          17      CALL    _CALSLT
000803 4803 22E7F2          16      LD  (PARAM1),HL
000806 4806 C9              10      RET
                                
       4807                     ROM_COPY:
000807 4807 CDD547          17      CALL    INIT_PARAM
00080A 480A 3A63F6          13      LD  A,(VALTYP)
00080D 480D FE03             7      CP  3       ;string
00080F 480F C2C34A          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
000812 4812 CDC84A          17      CALL    FILE_B
000815 4815 CD5A4C          17      CALL    ROM_OPEN
000818 4818 DA7C46          10      JP  C,ERROR_FILE_NOT_FOUND
                                
00081B 481B 21D1F2          10      LD  HL,_BUF_W
00081E 481E 22C7F2          16      LD  (_DTA),HL
000821 4821 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
000824 4824 CD274A          17      CALL    ROM_READ
                                
000827 4827 AF               4      XOR A
000828 4828 32CCF2          13      LD  (_BUF_LO),A     ;PSET
00082B 482B 32D9F2          13      LD  (_BUF_O),A      ;向き
                                
00082E 482E 2AE7F2          16      LD  HL,(PARAM1)
       4831                     RCP_PARAM1:
000831 4831 7E               7      LD  A,(HL)
000832 4832 23               6      INC HL
000833 4833 B7               4      OR  A
000834 4834 CAC34A          10      JP  Z,ROM_ORG
000837 4837 FE3A             7      CP  ':'
000839 4839 CAC34A          10      JP  Z,ROM_ORG
00083C 483C FE2C             7      CP  ','
00083E 483E 2012            12      JR  NZ,RCP_PARAM1_
                                
000840 4840 DD212F54        14      LD  IX,FRMQNT
000844 4844 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000848 4848 CD1C00          17      CALL    _CALSLT
00084B 484B 7B               4      LD  A,E
00084C 484C 87               4      ADD A,A
00084D 484D 87               4      ADD A,A
00084E 484E 32D9F2          13      LD  (_BUF_O),A
000851 4851 7E               7      LD  A,(HL)
       4852                     RCP_PARAM1_:
000852 4852 FE28             7      CP  '('
000854 4854 20DB            12      JR  NZ,RCP_PARAM1
                                
000856 4856 DD212F54        14      LD  IX,FRMQNT
00085A 485A FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00085E 485E CD1C00          17      CALL    _CALSLT
                                
000861 4861 ED53D5F2        20      LD  (_BUF_X),DE
                                
       4865                     RCP_PARAM2:
000865 4865 23               6      INC HL
000866 4866 7E               7      LD  A,(HL)
000867 4867 FE20             7      CP  020H
000869 4869 28FA            12      JR  Z,RCP_PARAM2
00086B 486B FE2C             7      CP  ','
00086D 486D 28F6            12      JR  Z,RCP_PARAM2
                                
00086F 486F DD212F54        14      LD  IX,FRMQNT
000873 4873 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000877 4877 CD1C00          17      CALL    _CALSLT
                                
00087A 487A 3AF6FA          13      LD  A,(ACPAGE)
00087D 487D 57               4      LD  D,A
00087E 487E ED53D7F2        20      LD  (_BUF_Y),DE
       4882                     RCP_PARAM3:
000882 4882 23               6      INC HL
000883 4883 7E               7      LD  A,(HL)
000884 4884 FE20             7      CP  020H
000886 4886 28FA            12      JR  Z,RCP_PARAM3
000888 4888 FE29             7      CP  ')'
00088A 488A 28F6            12      JR  Z,RCP_PARAM3
00088C 488C FE2C             7      CP  ','
00088E 488E 2033            12      JR  NZ,RCP_ST
                                
000890 4890 23               6      INC HL
000891 4891 DD212F54        14      LD  IX,FRMQNT
000895 4895 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000899 4899 CD1C00          17      CALL    _CALSLT
                                
00089C 489C 7B               4      LD  A,E
00089D 489D 32D8F2          13      LD  (_BUF_P),A
                                
       48A0                     RCP_PARAM4:
0008A0 48A0 7E               7      LD  A,(HL)
0008A1 48A1 23               6      INC HL
0008A2 48A2 FE20             7      CP  020H
0008A4 48A4 28FA            12      JR  Z,RCP_PARAM4
                                
0008A6 48A6 FE2C             7      CP  ','
0008A8 48A8 2019            12      JR  NZ,RCP_ST
                                
0008AA 48AA 7E               7      LD  A,(HL)
0008AB 48AB 0604             7      LD  B,4
0008AD 48AD FEC3             7      CP  0C3H        ;PRESET
0008AF 48AF 280E            12      JR  Z,RCP_LO
0008B1 48B1 05               4      DEC B       ;3
0008B2 48B2 D6F8             7      SUB 0F8H        ;XOR
0008B4 48B4 2809            12      JR  Z,RCP_LO
0008B6 48B6 05               4      DEC B       ;2
0008B7 48B7 3C               4      INC A       ;OR
0008B8 48B8 2805            12      JR  Z,RCP_LO
0008BA 48BA 05               4      DEC B       ;1
0008BB 48BB 3C               4      INC A       ;AND
0008BC 48BC 2801            12      JR  Z,RCP_LO
0008BE 48BE 05               4      DEC B       ;0
                                                ;PSET
       48BF                     RCP_LO:
0008BF 48BF 78               4      LD  A,B
0008C0 48C0 32CCF2          13      LD  (_BUF_LO),A
       48C3                     RCP_ST:
0008C3 48C3 2AC6F6          16      LD  HL,(STREND)
0008C6 48C6 22C7F2          16      LD  (_DTA),HL
0008C9 48C9 EB               4      EX  DE,HL
0008CA 48CA 2100FE          10      LD  HL,-512
0008CD 48CD 39              11      ADD HL,SP
0008CE 48CE AF               4      XOR A
0008CF 48CF ED52            15      SBC HL,DE
0008D1 48D1 3008            12      JR  NC,RCP0
0008D3 48D3 215EF5          10      LD  HL,BUF
0008D6 48D6 22C7F2          16      LD  (_DTA),HL
0008D9 48D9 6F               4      LD  L,A ;0
0008DA 48DA 67               4      LD  H,A ;0
       48DB                     RCP0:
0008DB 48DB 24               4      INC H
0008DC 48DC 22CFF2          16      LD  (_BUF_EN),HL
       48DF                     RCP1:
0008DF 48DF F3               4      DI
0008E0 48E0 CDB549          17      CALL    WAIT_VDP
                                
0008E3 48E3 3A0700          13      LD  A,(WRVDP)
0008E6 48E6 4F               4      LD  C,A
0008E7 48E7 0C               4      INC C       ;C := PORT#1's address(WR)
0008E8 48E8 3E24             7      LD  A,36
0008EA 48EA ED79            12      OUT (C),A
0008EC 48EC 3E91             7      LD  A,080H+17
0008EE 48EE ED79            12      OUT (C),A       ;R#17 := 36
                                
0008F0 48F0 0C               4      INC C
0008F1 48F1 0C               4      INC C       ;C := PORT#3's address(WR)
0008F2 48F2 2AD5F2          16      LD  HL,(_BUF_X)
0008F5 48F5 ED69            12      OUT (C),L       ;R#36 DX
0008F7 48F7 ED61            12      OUT (C),H       ;R#37
0008F9 48F9 2AD7F2          16      LD  HL,(_BUF_Y)
0008FC 48FC ED69            12      OUT (C),L       ;R#38 DY
0008FE 48FE ED61            12      OUT (C),H       ;R#39
000900 4900 2AD1F2          16      LD  HL,(_BUF_W)
000903 4903 ED69            12      OUT (C),L       ;R#40 NX
000905 4905 ED61            12      OUT (C),H       ;R#41
000907 4907 2AD3F2          16      LD  HL,(_BUF_H)
00090A 490A ED69            12      OUT (C),L       ;R#42 NY
00090C 490C ED61            12      OUT (C),H       ;R#43
                                
00090E 490E DD2AAFFC        20      LD  IX,(SCRMOD)
000912 4912 3ACCF2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000915 4915 B7               4      OR  A
000916 4916 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000918 4918 DD7D             9      LD  A,IXL
00091A 491A FE08             7      CP  8
00091C 491C 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
00091E 491E FE06             7      CP  6
000920 4920 2AD5F2          16      LD  HL,(_BUF_X)
000923 4923 3AD1F2          13      LD  A,(_BUF_W)
000926 4926 2005            12      JR  NZ,SCR57
000928 4928 B5               4      OR  L       ;スクリーン6
000929 4929 E603             7      AND 3
00092B 492B 200D            12      JR  NZ,USE_LMMC
       492D                     SCR57:              ;スクリーン5,7
00092D 492D B5               4      OR  L
00092E 492E E601             7      AND 1
000930 4930 2008            12      JR  NZ,USE_LMMC
       4932                     USE_HMMC:
000932 4932 DD2E08          10      LD  IXL,8
       4935                     USE_HMMC8:
000935 4935 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
000937 4937 32CCF2          13      LD  (_BUF_LO),A
       493A                     USE_LMMC:
00093A 493A 110000          10      LD  DE,0
00093D 493D 06FF             7      LD  B,-1
00093F 493F CDE049          17      CALL    GET_PIXEL
000942 4942 ED79            12      OUT (C),A       ;R#44 first DATA
000944 4944 3AD9F2          13      LD  A,(_BUF_O)
000947 4947 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
000949 4949 3ACCF2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00094C 494C F6B0             7      OR  0B0H        ;R#46 LMMC command
00094E 494E ED79            12      OUT (C),A
                                
000950 4950 FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
000952 4952 0D               4      DEC C
000953 4953 0D               4      DEC C       ;C := PORT#1's address(WR)
000954 4954 3EAC             7      LD  A,080H+44
000956 4956 ED79            12      OUT (C),A
000958 4958 3E91             7      LD  A,080H+17
00095A 495A ED79            12      OUT (C),A       ;R#17 := 44
                                
00095C 495C 3A0600          13      LD  A,(RDVDP)
00095F 495F 3C               4      INC A
000960 4960 FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
000962 4962 3E02             7      LD  A,2
000964 4964 ED79            12      OUT (C),A
000966 4966 3E8F             7      LD  A,08FH
000968 4968 ED79            12      OUT (C),A
00096A 496A 3ACCF2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00096D 496D E640             7      AND 040H
00096F 496F 201C            12      JR  NZ,LOOP_HMMC
       4971                     LOOP_COPY:
000971 4971 CDE049          17      CALL    GET_PIXEL
000974 4974 08               4      EX  AF,AF'
000975 4975 FD4C             9      LD  C,IYH
       4977                     LOOP_COPY1:
000977 4977 ED78            12      IN  A,(C)
000979 4979 0F               4      RRCA            ;RRCAではサインフラグは変化しない
00097A 497A 300A            12      JR  NC,EXIT_COPY    ;check CE bit
00097C 497C F27749          10      JP  P,LOOP_COPY1    ;check TR bit
00097F 497F 08               4      EX  AF,AF'
000980 4980 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000982 4982 ED79            12      OUT (C),A
000984 4984 18EB            12      JR  LOOP_COPY
                                
       4986                     EXIT_COPY:
000986 4986 CDBD49          17      CALL    GET_STATUS_0
000989 4989 FB               4      EI
00098A 498A C31D47          10      JP  ROM_NEXT
                                
       498D                     LOOP_HMMC:
00098D 498D F3               4      DI          ;必要
00098E 498E FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000990 4990 43               4      LD  B,E
000991 4991 7B               4      LD  A,E
000992 4992 B7               4      OR  A
000993 4993 2802            12      JR  Z,LOOP_HMMC1
000995 4995 EDB3                    OTIR
       4997                     LOOP_HMMC1:
000997 4997 14               4      INC D
       4998                     LOOP_HMMC2:
000998 4998 15               4      DEC D
000999 4999 2805            12      JR  Z,LOOP_HMMC3
00099B 499B EDB3                    OTIR
00099D 499D C39849          10      JP  LOOP_HMMC2
       49A0                     LOOP_HMMC3:
0009A0 49A0 ED78            12      IN  A,(C)
0009A2 49A2 0F               4      RRCA
0009A3 49A3 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
0009A5 49A5 2ACFF2          16      LD  HL,(_BUF_EN)
0009A8 49A8 CD274A          17      CALL    ROM_READ
0009AB 49AB EB               4      EX  DE,HL
0009AC 49AC 2AC7F2          16      LD  HL,(_DTA)
0009AF 49AF 7A               4      LD  A,D
0009B0 49B0 B3               4      OR  E
0009B1 49B1 20DA            12      JR  NZ,LOOP_HMMC
0009B3 49B3 18C2            12      JR  LOOP_COPY1
                                    
       49B5                     WAIT_VDP:
0009B5 49B5 3E02             7      LD  A,2
0009B7 49B7 CDBE49          17      CALL    GET_STATUS
0009BA 49BA 0F               4      RRCA
0009BB 49BB 38F8            12      JR  C,WAIT_VDP
       49BD                     GET_STATUS_0:
0009BD 49BD AF               4      XOR A
       49BE                     GET_STATUS:
0009BE 49BE C5              11      PUSH    BC
0009BF 49BF ED4B0600        20      LD  BC,(RDVDP)
0009C3 49C3 0C               4      INC C
0009C4 49C4 ED79            12      OUT (C),A
0009C6 49C6 3E8F             7      LD  A,08FH
0009C8 49C8 ED79            12      OUT (C),A
0009CA 49CA ED78            12      IN  A,(C)
0009CC 49CC C1              10      POP BC
0009CD 49CD C9              10      RET
                                
       49CE                     GET_PIXEL256:
0009CE 49CE 7A               4      LD  A,D
0009CF 49CF B3               4      OR  E
0009D0 49D0 200A            12      JR  NZ,GET_PIXEL1
0009D2 49D2 2ACFF2          16      LD  HL,(_BUF_EN)
0009D5 49D5 CD274A          17      CALL    ROM_READ
0009D8 49D8 EB               4      EX  DE,HL
0009D9 49D9 2AC7F2          16      LD  HL,(_DTA)
       49DC                     GET_PIXEL1:
0009DC 49DC 7E               7      LD  A,(HL)
0009DD 49DD 23               6      INC HL
0009DE 49DE 1B               6      DEC DE
0009DF 49DF C9              10      RET
                                
       49E0                     GET_PIXEL:
0009E0 49E0 DD7D             9      LD  A,IXL
0009E2 49E2 FE08             7      CP  8
0009E4 49E4 28E8            12      JR  Z,GET_PIXEL256
0009E6 49E6 04               4      INC B
0009E7 49E7 FE06             7      CP  6
0009E9 49E9 282E            12      JR  Z,GET_PIXEL4
                                
0009EB 49EB CB40             8      BIT 0,B
0009ED 49ED 20ED            12      JR  NZ,GET_PIXEL1
                                
0009EF 49EF 7A               4      LD  A,D
0009F0 49F0 B3               4      OR  E
0009F1 49F1 200A            12      JR  NZ,GET_PIXEL2
                                
0009F3 49F3 2ACFF2          16      LD  HL,(_BUF_EN)
0009F6 49F6 CD274A          17      CALL    ROM_READ
0009F9 49F9 EB               4      EX  DE,HL
0009FA 49FA 2AC7F2          16      LD  HL,(_DTA)
                                
       49FD                     GET_PIXEL2:
0009FD 49FD 7E               7      LD  A,(HL)
0009FE 49FE 0F               4      RRCA
0009FF 49FF 0F               4      RRCA
000A00 4A00 0F               4      RRCA
000A01 4A01 0F               4      RRCA
000A02 4A02 C9              10      RET
                                
       4A03                     GET_PIXEL3:
000A03 4A03 7A               4      LD  A,D
000A04 4A04 B3               4      OR  E
000A05 4A05 200A            12      JR  NZ,GET_PIXEL5
                                
000A07 4A07 2ACFF2          16      LD  HL,(_BUF_EN)
000A0A 4A0A CD274A          17      CALL    ROM_READ
000A0D 4A0D EB               4      EX  DE,HL
000A0E 4A0E 2AC7F2          16      LD  HL,(_DTA)
       4A11                     GET_PIXEL5:
000A11 4A11 7E               7      LD  A,(HL)
000A12 4A12 0F               4      RRCA
000A13 4A13 0F               4      RRCA
000A14 4A14 0F               4      RRCA
000A15 4A15 0F               4      RRCA
000A16 4A16 0F               4      RRCA
000A17 4A17 0F               4      RRCA
000A18 4A18 C9              10      RET
                                
       4A19                     GET_PIXEL4:
000A19 4A19 78               4      LD  A,B
000A1A 4A1A E603             7      AND 3   ;+0
000A1C 4A1C 28E5            12      JR  Z,GET_PIXEL3
000A1E 4A1E 3D               4      DEC A   ;+1
000A1F 4A1F 28DC            12      JR  Z,GET_PIXEL2
000A21 4A21 3D               4      DEC A   ;+2
000A22 4A22 7E               7      LD  A,(HL)
000A23 4A23 C0              11      RET NZ
000A24 4A24 0F               4      RRCA        ;+3
000A25 4A25 0F               4      RRCA
000A26 4A26 C9              10      RET
                                
       4A27                     ROM_READ:
000A27 4A27 E5              11      PUSH    HL
000A28 4A28 D5              11      PUSH    DE
000A29 4A29 C5              11      PUSH    BC
000A2A 4A2A FDE5            15      PUSH    IY
000A2C 4A2C 22E3F2          16      LD  (LEFTX),HL
000A2F 4A2F 2AC7F2          16      LD  HL,(_DTA)
000A32 4A32 22DAF2          16      LD  (DTAX),HL
000A35 4A35 2AE3F2          16      LD  HL,(LEFTX)
                                
000A38 4A38 CDDB4C          17      CALL    RBX1
000A3B 4A3B 3870            12      JR  C,RBRERR1
000A3D 4A3D 79               4      LD  A,C
000A3E 4A3E EB               4      EX  DE,HL
000A3F 4A3F ED52            15      SBC HL,DE       ;CP 0HL,CDE
000A41 4A41 19              11      ADD HL,DE
000A42 4A42 DE00             7      SBC A,000H
000A44 4A44 3801            12      JR  C,RBR1
000A46 4A46 EB               4      EX  DE,HL
       4A47                     RBR1:
000A47 4A47 9F               4      SBC A,A
000A48 4A48 E601             7      AND 1
000A4A 4A4A 32B6F2          13      LD  (_RESULT),A
000A4D 4A4D 7C               4      LD  A,H
000A4E 4A4E B5               4      OR  L
000A4F 4A4F CAA34A          10      JP  Z,RBREND0
                                
000A52 4A52 22C3F2          16      LD  (_LEFT),HL  ;Read record byte
000A55 4A55 22E3F2          16      LD  (LEFTX),HL
                                
000A58 4A58 CD0E4D          17      CALL    RBX2
000A5B 4A5B 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000A5D 4A5D CD214D          17      CALL    RBXA
000A60 4A60 DAB94A          10      JP  C,RBRERR
000A63 4A63 C5              11      PUSH    BC
000A64 4A64 CDFE43          17      CALL    ROM_LDIR
000A67 4A67 ED53DAF2        20      LD  (DTAX),DE
000A6B 4A6B 2AE3F2          16      LD  HL,(LEFTX)
000A6E 4A6E D1              10      POP DE
000A6F 4A6F A7               4      AND A
000A70 4A70 ED52            15      SBC HL,DE
000A72 4A72 22E3F2          16      LD  (LEFTX),HL
000A75 4A75 2829            12      JR  Z,RBREND
                                
       4A77                     RBRB:
000A77 4A77 CD5A4D          17      CALL    RBXB
000A7A 4A7A 2818            12      JR  Z,RBRC
       4A7C                     RBRB1:
000A7C 4A7C C5              11      PUSH    BC
000A7D 4A7D D5              11      PUSH    DE
000A7E 4A7E CD0B4E          17      CALL    CLUST
000A81 4A81 EB               4      EX  DE,HL
000A82 4A82 ED4BB9F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000A86 4A86 CDFE43          17      CALL    ROM_LDIR
000A89 4A89 EB               4      EX  DE,HL
000A8A 4A8A D1              10      POP DE
000A8B 4A8B C1              10      POP BC
000A8C 4A8C CDE84D          17      CALL    GNCL
000A8F 4A8F DAB94A          10      JP  C,RBRERR
000A92 4A92 10E8            13      DJNZ    RBRB1
       4A94                     RBRC:
000A94 4A94 CD724D          17      CALL    RBXC
000A97 4A97 2807            12      JR  Z,RBREND
                                
000A99 4A99 CD0B4E          17      CALL    CLUST
000A9C 4A9C EB               4      EX  DE,HL
000A9D 4A9D CDFE43          17      CALL    ROM_LDIR
       4AA0                     RBREND:
000AA0 4AA0 CD7E4D          17      CALL    RBXEND
       4AA3                     RBREND0:
000AA3 4AA3 FDE1            14      POP IY
000AA5 4AA5 C1              10      POP BC
000AA6 4AA6 D1              10      POP DE
000AA7 4AA7 F1              10      POP AF  ;(HL)
000AA8 4AA8 AF               4      XOR A
000AA9 4AA9 3AB6F2          13      LD  A,(_RESULT)
000AAC 4AAC C9              10      RET
                                
       4AAD                     RBRERR1:
000AAD 4AAD 3E01             7      LD  A,001H
       4AAF                     RBRERR2:
000AAF 4AAF FDE1            14      POP IY
000AB1 4AB1 C1              10      POP BC
000AB2 4AB2 D1              10      POP DE
000AB3 4AB3 E1              10      POP HL
000AB4 4AB4 37               4      SCF
000AB5 4AB5 210000          10      LD  HL,0
000AB8 4AB8 C9              10      RET
       4AB9                     RBRERR:
000AB9 4AB9 3EFF             7      LD  A,0FFH
000ABB 4ABB 18F2            12      JR  RBRERR2
                                
       4ABD                     FILE_DD:
000ABD 4ABD E1              10      POP HL
000ABE 4ABE 3E                      DB  03EH
000ABF 4ABF C9              10      RET
000AC0 4AC0 32A3F2          13      LD  (SWC_BLOAD_M),A
       4AC3                     ROM_ORG:
000AC3 4AC3 2AE5F2          16      LD  HL,(PARAM0)
000AC6 4AC6 7E               7      LD  A,(HL)
000AC7 4AC7 C9              10      RET
       4AC8                     FILE_B:
000AC8 4AC8 AF               4      XOR A
000AC9 4AC9 32EBF2          13      LD  (FDRV),A
000ACC 4ACC 1E00             7      LD  E,0
000ACE 4ACE 3A63F6          13      LD  A,(VALTYP)
000AD1 4AD1 FE03             7      CP  3       ;string
000AD3 4AD3 C26B4B          10      JP  NZ,FILED
                                
000AD6 4AD6 DD21D067        14      LD  IX,FRESTR
000ADA 4ADA FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000ADE 4ADE CD1C00          17      CALL    _CALSLT
000AE1 4AE1 E5              11      PUSH    HL
000AE2 4AE2 DDE1            14      POP IX
                                
000AE4 4AE4 DD5E00          19      LD  E,(IX+0)
000AE7 4AE7 DD7E01          19      LD  A,(IX+1)
000AEA 4AEA DD5602          19      LD  D,(IX+2)
000AED 4AED DD62             9      LD  IXH,D
000AEF 4AEF DD6F             9      LD  IXL,A
000AF1 4AF1 7B               4      LD  A,E
       4AF2                     FILE_BDOS:
000AF2 4AF2 FE04             7      CP  4
000AF4 4AF4 3808            12      JR  C,FILEB1
000AF6 4AF6 DD7E03          19      LD  A,(IX+3)
000AF9 4AF9 FE3A             7      CP  ':'
000AFB 4AFB 28C0            12      JR  Z,FILE_DD
000AFD 4AFD 7B               4      LD  A,E
       4AFE                     FILEB1:
000AFE 4AFE FE02             7      CP  2
000B00 4B00 3818            12      JR  C,DEVI1
000B02 4B02 DD7E01          19      LD  A,(IX+1)
000B05 4B05 FE3A             7      CP  ':'
000B07 4B07 2011            12      JR  NZ,DEVI1
000B09 4B09 DD7E00          19      LD  A,(IX+0)        ;DRIVE
000B0C 4B0C CD444C          17      CALL    CAP
000B0F 4B0F D640             7      SUB '@'
000B11 4B11 DD23            10      INC IX
000B13 4B13 DD23            10      INC IX
000B15 4B15 1D               4      DEC E
000B16 4B16 1D               4      DEC E
000B17 4B17 32EBF2          13      LD  (FDRV),A
       4B1A                     DEVI1:
000B1A 4B1A DD7E00          19      LD  A,(IX+0)
000B1D 4B1D D65C             7      SUB 05CH        ;\
000B1F 4B1F 2008            12      JR  NZ,NOROOT
000B21 4B21 6F               4      LD  L,A
000B22 4B22 67               4      LD  H,A
000B23 4B23 22E9F2          16      LD  (_CDX),HL
000B26 4B26 DD23            10      INC IX
000B28 4B28 1D               4      DEC E
       4B29                     NOROOT:
                                
       4B29                     SETDIR:
000B29 4B29 CD6B4B          17      CALL    FILED
000B2C 4B2C DD7E00          19      LD  A,(IX+0)
000B2F 4B2F FE5C             7      CP  05CH        ;\
000B31 4B31 C0              11      RET NZ
000B32 4B32 DD23            10      INC IX
000B34 4B34 1D               4      DEC E
000B35 4B35 3AECF2          13      LD  A,(FNAME)
000B38 4B38 FE20             7      CP  020H        ;. の処理
000B3A 4B3A 28ED            12      JR  Z,SETDIR
                                
000B3C 4B3C CD5A4C          17      CALL    ROM_OPEN
000B3F 4B3F B7               4      OR  A
000B40 4B40 C0              11      RET NZ
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
000B41 4B41 D5              11      PUSH    DE
000B42 4B42 2AE0F2          16      LD  HL,(DIRENT1)
000B45 4B45 110B00          10      LD  DE,0000BH   ;属性(アトリビュート)
000B48 4B48 19              11      ADD HL,DE
000B49 4B49 CD8B43          17      CALL    RDSLT_ROM
000B4C 4B4C D1              10      POP DE
000B4D 4B4D CB67             8      BIT 4,A     ;ディレクトリ
                                #else
                                    LD  IY,(DIRENT1)
                                    BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000B4F 4B4F C8              11      RET Z
000B50 4B50 CDB24B          17      CALL    FILEI
                                #if exists USE_MORMAL32K_OR_ASCII16
000B53 4B53 D5              11      PUSH    DE
000B54 4B54 2AE0F2          16      LD  HL,(DIRENT1)
000B57 4B57 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000B5A 4B5A 19              11      ADD HL,DE
000B5B 4B5B CD8B43          17      CALL    RDSLT_ROM
000B5E 4B5E 23               6      INC HL
000B5F 4B5F 5F               4      LD  E,A
000B60 4B60 CD8B43          17      CALL    RDSLT_ROM
000B63 4B63 57               4      LD  D,A
000B64 4B64 EB               4      EX  DE,HL
000B65 4B65 D1              10      POP DE
                                #else
                                    LD  L,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  H,(IY+01BH)
                                #endif
000B66 4B66 22E9F2          16      LD  (_CDX),HL
000B69 4B69 18BE            12      JR  SETDIR
                                
       4B6B                     FILED:
000B6B 4B6B CDB24B          17      CALL    FILEI
000B6E 4B6E 21ECF2          10      LD  HL,FNAME
                                
000B71 4B71 0608             7      LD  B,8
       4B73                     FILE2:
000B73 4B73 CDBF4B          17      CALL    CCHKF
000B76 4B76 C8              11      RET Z
000B77 4B77 FE2A             7      CP  '*'
000B79 4B79 282E            12      JR  Z,FILE9
000B7B 4B7B FE2E             7      CP  '.'
000B7D 4B7D 280C            12      JR  Z,FILE4
000B7F 4B7F 77               7      LD  (HL),A
000B80 4B80 23               6      INC HL
000B81 4B81 10F0            13      DJNZ    FILE2
                                
       4B83                     FILE3:
000B83 4B83 CDBF4B          17      CALL    CCHKF
000B86 4B86 C8              11      RET Z
000B87 4B87 FE2E             7      CP  '.'
000B89 4B89 20F8            12      JR  NZ,FILE3
                                
       4B8B                     FILE4:
000B8B 4B8B 21F4F2          10      LD  HL,FNAME+8
000B8E 4B8E 0603             7      LD  B,3
                                
       4B90                     FILE4L:
000B90 4B90 CDBF4B          17      CALL    CCHKF
000B93 4B93 C8              11      RET Z
000B94 4B94 FE2E             7      CP  '.'
000B96 4B96 2008            12      JR  NZ,FILE12
000B98 4B98 32ECF2          13      LD  (FNAME),A   ;Parent directory(..)
000B9B 4B9B 32EDF2          13      LD  (FNAME+1),A
000B9E 4B9E 3E20             7      LD  A,020H
       4BA0                     FILE12:
000BA0 4BA0 FE2A             7      CP  '*'
000BA2 4BA2 280A            12      JR  Z,FILE10
000BA4 4BA4 77               7      LD  (HL),A
000BA5 4BA5 23               6      INC HL
000BA6 4BA6 10E8            13      DJNZ    FILE4L
000BA8 4BA8 C9              10      RET
                                
       4BA9                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000BA9 4BA9 CDAE4B          17      CALL    FILE10
000BAC 4BAC 18D5            12      JR  FILE3
                                
       4BAE                     FILE10:
000BAE 4BAE 3E3F             7      LD  A,'?'
000BB0 4BB0 1808            12      JR  FILL_MEMORY
       4BB2                     FILEI:              ;名前＋拡張子をスペースで初期化
000BB2 4BB2 3E20             7      LD  A,020H
000BB4 4BB4 01000B          10      LD  BC,11*256   ;C=0にしておく
000BB7 4BB7 21ECF2          10      LD  HL,FNAME
       4BBA                     FILL_MEMORY:            ;HLからBバイトAで埋める
000BBA 4BBA 77               7      LD  (HL),A
000BBB 4BBB 23               6      INC HL
000BBC 4BBC 10FC            13      DJNZ    FILL_MEMORY
000BBE 4BBE C9              10      RET
                                
       4BBF                     CCHKF:
000BBF 4BBF 7B               4      LD  A,E
000BC0 4BC0 B7               4      OR  A
000BC1 4BC1 C8              11      RET Z
000BC2 4BC2 DD7E00          19      LD  A,(IX+0)
000BC5 4BC5 CDCC4B          17      CALL    CCHK2
000BC8 4BC8 C8              11      RET Z
000BC9 4BC9 C32F4C          10      JP  FKAN
                                
       4BCC                     CCHK2:
000BCC 4BCC 0C               4      INC C
000BCD 4BCD 0D               4      DEC C
000BCE 4BCE C0              11      RET NZ
       4BCF                     CCHK3:              ;ZF=1 で使えない文字
000BCF 4BCF FE2B             7      CP  '+'
000BD1 4BD1 C8              11      RET Z
000BD2 4BD2 FE2C             7      CP  ','
000BD4 4BD4 C8              11      RET Z
000BD5 4BD5 FE2F             7      CP  '/'
000BD7 4BD7 C8              11      RET Z
000BD8 4BD8 FE3A             7      CP  ':'
000BDA 4BDA C8              11      RET Z
000BDB 4BDB FE3B             7      CP  ';'
000BDD 4BDD C8              11      RET Z
000BDE 4BDE FE3D             7      CP  '='
000BE0 4BE0 C8              11      RET Z
000BE1 4BE1 FE5C             7      CP  05CH    ;\
000BE3 4BE3 C8              11      RET Z
000BE4 4BE4 FE1F             7      CP  01FH
000BE6 4BE6 D0              11      RET NC
000BE7 4BE7 BF               4      CP  A       ;Z=1
000BE8 4BE8 C9              10      RET
                                
       4BE9                     SS1:
000BE9 4BE9 13               6      INC DE
       4BEA                     SPCUT:              ;スペースをカット
000BEA 4BEA 1A               7      LD  A,(DE)
000BEB 4BEB FE20             7      CP  020H
000BED 4BED 28FA            12      JR  Z,SS1
000BEF 4BEF C9              10      RET
                                
       4BF0                     SCREOF1:
000BF0 4BF0 13               6      INC DE
       4BF1                     SPCUTEX:            ;スペース改行などをカット
000BF1 4BF1 1A               7      LD  A,(DE)
000BF2 4BF2 FE20             7      CP  020H
000BF4 4BF4 28FA            12      JR  Z,SCREOF1
000BF6 4BF6 FE0D             7      CP  00DH
000BF8 4BF8 28F6            12      JR  Z,SCREOF1
000BFA 4BFA FE0A             7      CP  00AH
000BFC 4BFC 28F2            12      JR  Z,SCREOF1
000BFE 4BFE FE1A             7      CP  01AH
000C00 4C00 28EE            12      JR  Z,SCREOF1
000C02 4C02 C9              10      RET
                                
       4C03                     GETNUM:
000C03 4C03 210000          10      LD  HL,0
       4C06                     GETNUM1:
000C06 4C06 1A               7      LD  A,(DE)
000C07 4C07 13               6      INC DE
000C08 4C08 D630             7      SUB '0'
000C0A 4C0A D8              11      RET C
000C0B 4C0B FE0A             7      CP  10
000C0D 4C0D D0              11      RET NC
000C0E 4C0E 4D               4      LD  C,L
000C0F 4C0F 44               4      LD  B,H
000C10 4C10 29              11      ADD HL,HL   ;*2
000C11 4C11 29              11      ADD HL,HL   ;*4
000C12 4C12 09              11      ADD HL,BC   ;*5
000C13 4C13 29              11      ADD HL,HL   ;*10
000C14 4C14 4F               4      LD  C,A
000C15 4C15 0600             7      LD  B,0
000C17 4C17 09              11      ADD HL,BC
000C18 4C18 18EC            12      JR  GETNUM1
                                
       4C1A                     SEARCH_END:
000C1A 4C1A 7E               7      LD  A,(HL)
       4C1B                     SEARCH_END1:
000C1B 4C1B 23               6      INC HL
000C1C 4C1C B7               4      OR  A
000C1D 4C1D C8              11      RET Z
000C1E 4C1E FE3A             7      CP  ':'
000C20 4C20 20F8            12      JR  NZ,SEARCH_END
000C22 4C22 7E               7      LD  A,(HL)
000C23 4C23 FE3A             7      CP  ':'
000C25 4C25 28F4            12      JR  Z,SEARCH_END1
000C27 4C27 C9              10      RET
                                
       4C28                     FKANC:
000C28 4C28 CB41             8      BIT 0,C
000C2A 4C2A CC4D4C          17      CALL    Z,CAP2
000C2D 4C2D 1803            12      JR  FKANX
       4C2F                     FKAN:           ;漢字チェック
000C2F 4C2F DD23            10      INC IX
000C31 4C31 1D               4      DEC E
       4C32                     FKANX:
000C32 4C32 CB41             8      BIT 0,C
000C34 4C34 CB81             8      RES 0,C
000C36 4C36 C0              11      RET NZ
000C37 4C37 FE80             7      CP  080H
000C39 4C39 D8              11      RET C
000C3A 4C3A FEA0             7      CP  0A0H
000C3C 4C3C 3803            12      JR  C,FKAN1
000C3E 4C3E FEE0             7      CP  0E0H
000C40 4C40 D8              11      RET C
       4C41                     FKAN1:
000C41 4C41 0C               4      INC C
000C42 4C42 A7               4      AND A
000C43 4C43 C9              10      RET
                                
       4C44                     CAP:
000C44 4C44 FE61             7      CP  'a'
000C46 4C46 D8              11      RET C
000C47 4C47 FE7B             7      CP  'z'+1
000C49 4C49 D0              11      RET NC
000C4A 4C4A D620             7      SUB 020H
000C4C 4C4C C9              10      RET
       4C4D                     CAP2:
000C4D 4C4D CD444C          17      CALL    CAP
       4C50                     CAP3:               ;
000C50 4C50 FE05             7      CP  5
000C52 4C52 2803            12      JR  Z,CAP4
000C54 4C54 FE21             7      CP  021H
000C56 4C56 C9              10      RET
       4C57                     CAP4:
000C57 4C57 3EE5             7      LD  A,0E5H
000C59 4C59 C9              10      RET
                                
       4C5A                     ROM_OPEN:
000C5A 4C5A CD6652          17      CALL    GET_DISK_BANK_FDRV
                                
000C5D 4C5D CDB64E          17      CALL    GET_DIR_DAT
000C60 4C60 D5              11      PUSH    DE
000C61 4C61 CD764C          17      CALL    FILESE
000C64 4C64 D1              10      POP DE
000C65 4C65 3F               4      CCF
000C66 4C66 D8              11      RET C
000C67 4C67 22E0F2          16      LD  (DIRENT1),HL
000C6A 4C6A E5              11      PUSH    HL
000C6B 4C6B 210000          10      LD  HL,0
000C6E 4C6E 22BDF2          16      LD  (RR_LOW),HL
000C71 4C71 22BFF2          16      LD  (RR_HIGH),HL
000C74 4C74 E1              10      POP HL
000C75 4C75 C9              10      RET
                                
       4C76                     FILESE:
       4C76                     FILESE0:
                                #if exists USE_MORMAL32K_OR_ASCII16
000C76 4C76 CD8B43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000C79 4C79 B7               4      OR  A
000C7A 4C7A C8              11      RET Z       ;END:ZF=1 CF=0
000C7B 4C7B FEE5             7      CP  0E5H
000C7D 4C7D 280D            12      JR  Z,FILESE1
000C7F 4C7F 11ECF2          10      LD  DE,FNAME
000C82 4C82 E5              11      PUSH    HL
000C83 4C83 CDB24C          17      CALL    CPFILE
000C86 4C86 CCD54C          17      CALL    Z,CPFILE2
000C89 4C89 E1              10      POP HL
000C8A 4C8A 37               4      SCF
000C8B 4C8B C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4C8C                     FILESE1:
000C8C 4C8C CD944C          17      CALL    FNEXT
000C8F 4C8F 20E5            12      JR  NZ,FILESE0
000C91 4C91 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000C93 4C93 C9              10      RET
                                
       4C94                     FNEXT:
000C94 4C94 112000          10      LD  DE,020H
000C97 4C97 19              11      ADD HL,DE
000C98 4C98 ED5BE9F2        20      LD  DE,(_CDX)
000C9C 4C9C 7A               4      LD  A,D
000C9D 4C9D B3               4      OR  E
000C9E 4C9E 2002            12      JR  NZ,FNEXT_SUBDIR
000CA0 4CA0 0D               4      DEC C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
                                    PUSH    AF      ;※フラグを保存する必要あり
                                    BIT 7,H
                                    JR  Z,CHECK_DIR_PAGE1
                                    LD  A,H
                                    SUB 020H
                                    LD  H,A
                                    LD  A,(_DIR_BANK)
                                    INC A
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_DIR_BANK),A
                                CHECK_DIR_PAGE1:
                                    POP AF
                                #endif
000CA1 4CA1 C9              10      RET
                                
       4CA2                     FNEXT_SUBDIR:           ;サブディレクトリ
000CA2 4CA2 0D               4      DEC C
000CA3 4CA3 C0              11      RET NZ
                                
000CA4 4CA4 ED5BE9F2        20      LD  DE,(_CDX)
000CA8 4CA8 CDE84D          17      CALL    GNCL
000CAB 4CAB EB               4      EX  DE,HL
000CAC 4CAC 22E9F2          16      LD  (_CDX),HL
000CAF 4CAF C3EF4E          10      JP  GET_SUBDIR
                                
       4CB2                     CPFILE:
000CB2 4CB2 C5              11      PUSH    BC
000CB3 4CB3 01000B          10      LD  BC,00B00H
       4CB6                     CPSTR1:
000CB6 4CB6 1A               7      LD  A,(DE)
000CB7 4CB7 FE3F             7      CP  '?'     ;Wild card
000CB9 4CB9 2814            12      JR  Z,CPSTR2
                                #if exists USE_MORMAL32K_OR_ASCII16
000CBB 4CBB CD8B43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000CBE 4CBE CD284C          17      CALL    FKANC
000CC1 4CC1 E5              11      PUSH    HL
000CC2 4CC2 67               4      LD  H,A
000CC3 4CC3 1A               7      LD  A,(DE)
000CC4 4CC4 CB01             4      RLC C
000CC6 4CC6 CD284C          17      CALL    FKANC
000CC9 4CC9 CB09             4      RRC C
000CCB 4CCB BC               4      CP  H       ;CP (HL),(DE)
000CCC 4CCC E1              10      POP HL
000CCD 4CCD 2004            12      JR  NZ,CPSTR3
       4CCF                     CPSTR2:
000CCF 4CCF 13               6      INC DE
000CD0 4CD0 23               6      INC HL
000CD1 4CD1 10E3            13      DJNZ    CPSTR1
       4CD3                     CPSTR3:
000CD3 4CD3 C1              10      POP BC
000CD4 4CD4 C9              10      RET
                                
       4CD5                     CPFILE2:
                                #if exists USE_MORMAL32K_OR_ASCII16
000CD5 4CD5 CD8B43          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000CD8 4CD8 E608             7      AND 008H    ;~0F7H
000CDA 4CDA C9              10      RET
                                
       4CDB                     RBX1:
000CDB 4CDB E5              11      PUSH    HL      ;Record byte
                                
000CDC 4CDC ED5BBDF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000CE0 4CE0 3AC0F2          13      LD  A,(RR_HIGH+1)
000CE3 4CE3 4F               4      LD  C,A
                                
000CE4 4CE4 3AE2F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
000CE7 4CE7 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
000CEA 4CEA D5              11      PUSH    DE
000CEB 4CEB 2AE0F2          16      LD  HL,(DIRENT1)
000CEE 4CEE 111C00          10      LD  DE,0001CH
000CF1 4CF1 19              11      ADD HL,DE
000CF2 4CF2 CD8B43          17      CALL    RDSLT_ROM
000CF5 4CF5 23               6      INC HL
000CF6 4CF6 5F               4      LD  E,A
000CF7 4CF7 CD8B43          17      CALL    RDSLT_ROM
000CFA 4CFA 23               6      INC HL
000CFB 4CFB 57               4      LD  D,A
000CFC 4CFC CD8B43          17      CALL    RDSLT_ROM
000CFF 4CFF EB               4      EX  DE,HL       ;AHL=File size
000D00 4D00 D1              10      POP DE
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  L,(IY+01CH) ;AHL=File size
                                    LD  H,(IY+01DH)
                                    LD  A,(IY+01EH)
                                #endif
                                
000D01 4D01 A7               4      AND A
000D02 4D02 ED52            15      SBC HL,DE
000D04 4D04 99               4      SBC A,C
000D05 4D05 D1              10      POP DE
                                
000D06 4D06 D8              11      RET C
000D07 4D07 4F               4      LD  C,A
000D08 4D08 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000D09 4D09 B2               4      OR  D
000D0A 4D0A B3               4      OR  E
000D0B 4D0B C0              11      RET NZ
000D0C 4D0C 37               4      SCF
000D0D 4D0D C9              10      RET
                                
       4D0E                     RBX2:
000D0E 4D0E ED4BBEF2        20      LD  BC,(RR_LOW+1)
000D12 4D12 CD934D          17      CALL    RWXR
000D15 4D15 3ABAF2          13      LD  A,(CLSZ_H)
000D18 4D18 3D               4      DEC A
000D19 4D19 E5              11      PUSH    HL
000D1A 4D1A 2ABDF2          16      LD  HL,(RR_LOW)
000D1D 4D1D A4               4      AND H
000D1E 4D1E B5               4      OR  L
000D1F 4D1F E1              10      POP HL
000D20 4D20 C9              10      RET
                                
       4D21                     RBXA:
000D21 4D21 D5              11      PUSH    DE
000D22 4D22 CD0B4E          17      CALL    CLUST
000D25 4D25 ED53C5F2        20      LD  (_DTPS),DE
000D29 4D29 D1              10      POP DE
000D2A 4D2A CDE84D          17      CALL    GNCL
000D2D 4D2D D8              11      RET C
000D2E 4D2E ED53C1F2        20      LD  (_CLPS),DE
                                
000D32 4D32 ED4BBDF2        20      LD  BC,(RR_LOW)
000D36 4D36 2AB9F2          16      LD  HL,(CLSZ)
000D39 4D39 7C               4      LD  A,H
000D3A 4D3A 3D               4      DEC A
000D3B 4D3B A0               4      AND B
000D3C 4D3C 47               4      LD  B,A
000D3D 4D3D ED42            15      SBC HL,BC       ;remaining cluster
                                
000D3F 4D3F ED5BE3F2        20      LD  DE,(LEFTX)
000D43 4D43 ED52            15      SBC HL,DE       ;CP HL,DE
000D45 4D45 19              11      ADD HL,DE
000D46 4D46 3801            12      JR  C,RBXA1
000D48 4D48 EB               4      EX  DE,HL
       4D49                     RBXA1:
000D49 4D49 3AB7F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_MORMAL32K_OR_ASCII16
000D4C 4D4C 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000D4F 4D4F E5              11      PUSH    HL
000D50 4D50 2AC5F2          16      LD  HL,(_DTPS)
000D53 4D53 09              11      ADD HL,BC
000D54 4D54 ED5BDAF2        20      LD  DE,(DTAX)
000D58 4D58 C1              10      POP BC
000D59 4D59 C9              10      RET
                                
       4D5A                     RBXB:
000D5A 4D5A 2ADAF2          16      LD  HL,(DTAX)
000D5D 4D5D ED5BC1F2        20      LD  DE,(_CLPS)
000D61 4D61 3AE4F2          13      LD  A,(LEFTX+1)
000D64 4D64 47               4      LD  B,A
000D65 4D65 3ABAF2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4D68                     RBXB1:
000D68 4D68 1F               4      RRA     ;->CF
000D69 4D69 3804            12      JR  C,RBXB2
000D6B 4D6B CB38             8      SRL B   ;B=B/2
000D6D 4D6D 18F9            12      JR  RBXB1
       4D6F                     RBXB2:
000D6F 4D6F 78               4      LD  A,B
000D70 4D70 B7               4      OR  A
000D71 4D71 C9              10      RET
                                
       4D72                     RBXC:
000D72 4D72 ED4BE3F2        20      LD  BC,(LEFTX)
000D76 4D76 3ABAF2          13      LD  A,(CLSZ_H)
000D79 4D79 3D               4      DEC A
000D7A 4D7A A0               4      AND B
000D7B 4D7B 47               4      LD  B,A
000D7C 4D7C B1               4      OR  C
000D7D 4D7D C9              10      RET
                                
       4D7E                     RBXEND:
000D7E 4D7E ED5BC3F2        20      LD  DE,(_LEFT)
000D82 4D82 2ABDF2          16      LD  HL,(RR_LOW)
000D85 4D85 3AC0F2          13      LD  A,(RR_HIGH+1)
000D88 4D88 19              11      ADD HL,DE
000D89 4D89 CE00             7      ADC A,0
000D8B 4D8B 22BDF2          16      LD  (RR_LOW),HL
000D8E 4D8E 32C0F2          13      LD  (RR_HIGH+1),A
000D91 4D91 EB               4      EX  DE,HL       ;HL=Read byte
000D92 4D92 C9              10      RET 
                                
       4D93                     RWXR:
000D93 4D93 3ABAF2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4D96                     L_RWX:
000D96 4D96 1F               4      RRA     ;->CF
000D97 4D97 3806            12      JR  C,E_RWX
000D99 4D99 CB38             8      SRL B   ;BC=BC/2
000D9B 4D9B CB19             8      RR  C   ;
000D9D 4D9D 18F7            12      JR  L_RWX
       4D9F                     E_RWX:
000D9F 4D9F 3AE2F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
000DA2 4DA2 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
000DA5 4DA5 E5              11      PUSH    HL
000DA6 4DA6 2AE0F2          16      LD  HL,(DIRENT1)
000DA9 4DA9 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000DAC 4DAC 19              11      ADD HL,DE
000DAD 4DAD CD8B43          17      CALL    RDSLT_ROM
000DB0 4DB0 23               6      INC HL
000DB1 4DB1 5F               4      LD  E,A
000DB2 4DB2 CD8B43          17      CALL    RDSLT_ROM
000DB5 4DB5 23               6      INC HL
000DB6 4DB6 57               4      LD  D,A
000DB7 4DB7 E1              10      POP HL
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  E,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  D,(IY+01BH)
                                #endif
000DB8 4DB8 CD6652          17      CALL    GET_DISK_BANK_FDRV
       4DBB                     RWX1:
000DBB 4DBB ED53C1F2        20      LD  (_CLPS),DE
000DBF 4DBF 7A               4      LD  A,D
000DC0 4DC0 B3               4      OR  E
000DC1 4DC1 37               4      SCF
000DC2 4DC2 C8              11      RET Z
                                
000DC3 4DC3 78               4      LD  A,B
000DC4 4DC4 B1               4      OR  C
000DC5 4DC5 C8              11      RET Z
                                
000DC6 4DC6 CDE84D          17      CALL    GNCL
000DC9 4DC9 D8              11      RET C
000DCA 4DCA 0B               6      DEC BC
000DCB 4DCB CD4F4E          17      CALL    ENDCL
000DCE 4DCE 38EB            12      JR  C,RWX1
000DD0 4DD0 37               4      SCF
000DD1 4DD1 C9              10      RET
                                
       4DD2                     NCL3:
000DD2 4DD2 CD6652          17      CALL    GET_DISK_BANK_FDRV
000DD5 4DD5 6B               4      LD  L,E
000DD6 4DD6 62               4      LD  H,D
000DD7 4DD7 CB3C             8      SRL H
000DD9 4DD9 CB1D             8      RR  L
000DDB 4DDB 1F               4      RRA
000DDC 4DDC 19              11      ADD HL,DE
000DDD 4DDD 010060          10      LD  BC,BANK1_ADR
000DE0 4DE0 09              11      ADD HL,BC
000DE1 4DE1 ED4BBBF2        20      LD  BC,(SECSZ)
000DE5 4DE5 09              11      ADD HL,BC
000DE6 4DE6 17               4      RLA
000DE7 4DE7 C9              10      RET
                                
       4DE8                     GNCL:
000DE8 4DE8 7A               4      LD  A,D
000DE9 4DE9 B3               4      OR  E
000DEA 4DEA 37               4      SCF
000DEB 4DEB C8              11      RET Z
000DEC 4DEC C5              11      PUSH    BC
000DED 4DED E5              11      PUSH    HL
000DEE 4DEE CDD24D          17      CALL    NCL3
000DF1 4DF1 3809            12      JR  C,GNC1
000DF3 4DF3 5E               7      LD  E,(HL)
000DF4 4DF4 23               6      INC HL
000DF5 4DF5 7E               7      LD  A,(HL)
000DF6 4DF6 E60F             7      AND 00FH
000DF8 4DF8 57               4      LD  D,A
000DF9 4DF9 E1              10      POP HL
000DFA 4DFA C1              10      POP BC
000DFB 4DFB C9              10      RET
       4DFC                     GNC1:
000DFC 4DFC 7E               7      LD  A,(HL)
000DFD 4DFD 23               6      INC HL
000DFE 4DFE 56               7      LD  D,(HL)
000DFF 4DFF 0604             7      LD  B,4
       4E01                     GNC1L:
000E01 4E01 CB3A             8      SRL D
000E03 4E03 1F               4      RRA
000E04 4E04 10FB            13      DJNZ    GNC1L
                                
000E06 4E06 5F               4      LD  E,A
000E07 4E07 E1              10      POP HL
000E08 4E08 C1              10      POP BC
000E09 4E09 A7               4      AND A
000E0A 4E0A C9              10      RET
                                
       4E0B                     CLUST:
000E0B 4E0B EB               4      EX  DE,HL
       4E0C                     CLUST_HL:
000E0C 4E0C 2B               6      DEC HL
000E0D 4E0D 2B               6      DEC HL
000E0E 4E0E C5              11      PUSH    BC
000E0F 4E0F 3ABAF2          13      LD  A,(CLSZ_H)
000E12 4E12 CD8F52          17      CALL    MUL_AHL
                                
000E15 4E15 CDD04E          17      CALL    GET_DIR_POS
000E18 4E18 4F               4      LD  C,A
000E19 4E19 0600             7      LD  B,0
000E1B 4E1B 09              11      ADD HL,BC
                                
000E1C 4E1C ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
000E20 4E20 CB38             8      SRL B
000E22 4E22 CB19             8      RR  C           ;/2
000E24 4E24 CB38             8      SRL B
000E26 4E26 CB19             8      RR  C           ;/4
000E28 4E28 CB38             8      SRL B
000E2A 4E2A CB19             8      RR  C           ;/8
000E2C 4E2C 09              11      ADD HL,BC
                                #if exists USE_MORMAL32K_OR_ASCII16
000E2D 4E2D 7D               4      LD  A,L
000E2E 4E2E 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
000E31 4E31 09              11      ADD HL,BC
000E32 4E32 3013            12      JR  NC,CLUST2
000E34 4E34 4D               4      LD  C,L     ;C=読み出し元
000E35 4E35 29              11      ADD HL,HL   ;64KB→32KB
000E36 4E36 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
000E37 4E37 CD6652          17      CALL    GET_DISK_BANK_FDRV
000E3A 4E3A 84               4      ADD A,H
000E3B 4E3B 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
000E3E 4E3E 32B7F2          13      LD  (_BANK),A
000E41 4E41 69               4      LD  L,C     ;C=読み出し元
000E42 4E42 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
000E44 4E44 A5               4      AND L
000E45 4E45 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB
                                    ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
                                    AND L
                                #endif
       4E47                     CLUST2:
000E47 4E47 C660             7      ADD A,high BANK1_ADR
000E49 4E49 67               4      LD  H,A
000E4A 4E4A 2E00             7      LD  L,0
000E4C 4E4C EB               4      EX  DE,HL
000E4D 4E4D C1              10      POP BC
000E4E 4E4E C9              10      RET
                                
       4E4F                     ENDCL:
000E4F 4E4F 7A               4      LD  A,D ;END CLUSTER
000E50 4E50 FE0F             7      CP  00FH    ;FAT12の最大値
000E52 4E52 C0              11      RET NZ
000E53 4E53 7B               4      LD  A,E
000E54 4E54 FEF7             7      CP  0F7H
000E56 4E56 C9              10      RET
                                
       4E57                     RB_READ:
000E57 4E57 AF               4      XOR A   ;HLA = HL*128
000E58 4E58 CB3C             8      SRL H
000E5A 4E5A CB1D             8      RR  L
000E5C 4E5C 1F               4      RRA
000E5D 4E5D 32BDF2          13      LD  (RR_LOW),A
000E60 4E60 22BEF2          16      LD  (RR_MID),HL
000E63 4E63 218000          10      LD  HL,128
                                
000E66 4E66 CD274A          17      CALL    ROM_READ
000E69 4E69 C9              10      RET
                                
       4E6A                     GETSEQ:
000E6A 4E6A FD6E20          19      LD  L,(IY+32)
000E6D 4E6D FD660C          19      LD  H,(IY+12)
                                
000E70 4E70 CB25             8      SLA L
                                
000E72 4E72 CB3C             8      SRL H
000E74 4E74 CB1D             8      RR  L
000E76 4E76 C9              10      RET
                                
       4E77                     SETSEQ:
000E77 4E77 F5              11      PUSH    AF
000E78 4E78 3ABDF2          13      LD  A,(RR_LOW)
000E7B 4E7B 2ABEF2          16      LD  HL,(RR_MID)
                                
000E7E 4E7E CD954E          17      CALL    SSQ1
                                
000E81 4E81 29              11      ADD HL,HL
000E82 4E82 CB3D             8      SRL L
000E84 4E84 FD7520          19      LD  (IY+32),L
000E87 4E87 FD740C          19      LD  (IY+12),H
000E8A 4E8A F1              10      POP AF
000E8B 4E8B C9              10      RET
                                
       4E8C                     GETSIZE:
000E8C 4E8C FD7E10          19      LD  A,(IY+16)
000E8F 4E8F FD6E11          19      LD  L,(IY+17)
000E92 4E92 FD6612          19      LD  H,(IY+18)
       4E95                     SSQ1:
000E95 4E95 87               4      ADD A,A
000E96 4E96 ED6A            15      ADC HL,HL
000E98 4E98 B7               4      OR  A
000E99 4E99 C8              11      RET Z
000E9A 4E9A 23               6      INC HL
000E9B 4E9B C9              10      RET
                                
       4E9C                     SET_FCB:
000E9C 4E9C D5              11      PUSH    DE
000E9D 4E9D FDE1            14      POP IY
000E9F 4E9F FD7E1C          19      LD  A,(IY+28)
000EA2 4EA2 FEFF             7      CP  0FFH
000EA4 4EA4 200C            12      JR  NZ,POPAF_SCF_FF_RET
000EA6 4EA6 E5              11      PUSH    HL
000EA7 4EA7 FD6E1A          19      LD  L,(IY+26)
000EAA 4EAA FD661B          19      LD  H,(IY+27)
000EAD 4EAD 22C1F2          16      LD  (_CLPS),HL
000EB0 4EB0 E1              10      POP HL
000EB1 4EB1 C9              10      RET
                                
       4EB2                     POPAF_SCF_FF_RET:
000EB2 4EB2 F1              10      POP AF
000EB3 4EB3 37               4      SCF
000EB4 4EB4 9F               4      SBC A,A
000EB5 4EB5 C9              10      RET
                                
       4EB6                     GET_DIR_DAT:
000EB6 4EB6 2AE9F2          16      LD  HL,(_CDX)
000EB9 4EB9 7C               4      LD  A,H
000EBA 4EBA B5               4      OR  L
000EBB 4EBB 2032            12      JR  NZ,GET_SUBDIR
000EBD 4EBD CDD04E          17      CALL    GET_DIR_POS
000EC0 4EC0 C660             7      ADD A,high BANK1_ADR
000EC2 4EC2 2E00             7      LD  L,0
000EC4 4EC4 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                    CALL    CHECK_DIR_PAGE
                                #endif
000EC5 4EC5 3AB8F2          13      LD  A,(_BANK1)
000EC8 4EC8 32E2F2          13      LD  (_DIR_BANK),A
                                
000ECB 4ECB 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000ECE 4ECE 4F               4      LD  C,A
000ECF 4ECF C9              10      RET
                                
       4ED0                     GET_DIR_POS:                ;ルートディレクトリ
000ED0 4ED0 CD6652          17      CALL    GET_DISK_BANK_FDRV
000ED3 4ED3 32B8F2          13      LD  (_BANK1),A
000ED6 4ED6 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000ED9 4ED9 47               4      LD  B,A
000EDA 4EDA 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000EDD 4EDD 4F               4      LD  C,A
000EDE 4EDE 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4EE1                     GET_DIR_POS1:
000EE1 4EE1 81               4      ADD A,C
000EE2 4EE2 10FD            13      DJNZ    GET_DIR_POS1
                                
000EE4 4EE4 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
000EE8 4EE8 37               4      SCF     ;無限ループ回避
       4EE9                     L_MDP:
000EE9 4EE9 CB18             8      RR  B   ;->CF
000EEB 4EEB D8              11      RET C
000EEC 4EEC 87               4      ADD A,A
000EED 4EED 18FA            12      JR  L_MDP
                                
       4EEF                     GET_SUBDIR:             ;サブディレクトリ
000EEF 4EEF CD0C4E          17      CALL    CLUST_HL
000EF2 4EF2 EB               4      EX  DE,HL
000EF3 4EF3 3AB7F2          13      LD  A,(_BANK)
000EF6 4EF6 32E2F2          13      LD  (_DIR_BANK),A
000EF9 4EF9 3ABAF2          13      LD  A,(CLSZ_H)
000EFC 4EFC 87               4      ADD A,A     ;*2
000EFD 4EFD 87               4      ADD A,A     ;*4
000EFE 4EFE 87               4      ADD A,A     ;*8
000EFF 4EFF 4F               4      LD  C,A
000F00 4F00 C9              10      RET
                                
       4F01                     STATEMENT:
000F01 4F01 117C50          10      LD  DE,STR_CHDIR
000F04 4F04 CD6250          17      CALL    CPPROCNM
000F07 4F07 280A            12      JR  Z,_CHDIR
000F09 4F09 118250          10      LD  DE,STR_RAMDISK
000F0C 4F0C CD6250          17      CALL    CPPROCNM
000F0F 4F0F 2814            12      JR  Z,_RAMDISK
000F11 4F11 37               4      SCF
000F12 4F12 C9              10      RET
       4F13                     _CHDIR:
000F13 4F13 7E               7      LD  A,(HL)
000F14 4F14 FE28             7      CP  '('
000F16 4F16 37               4      SCF
000F17 4F17 C0              11      RET NZ
000F18 4F18 CDD547          17      CALL    INIT_PARAM
000F1B 4F1B CDC84A          17      CALL    FILE_B
000F1E 4F1E CD3D4F          17      CALL    ROM_CD
000F21 4F21 DA7C46          10      JP  C,ERROR_FILE_NOT_FOUND
000F24 4F24 C9              10      RET
                                
       4F25                     _RAMDISK:
000F25 4F25 7E               7      LD  A,(HL)
000F26 4F26 FE28             7      CP  '('
000F28 4F28 37               4      SCF
000F29 4F29 C0              11      RET NZ
000F2A 4F2A 23               6      INC HL
000F2B 4F2B DD212F54        14      LD  IX,FRMQNT
000F2F 4F2F FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000F33 4F33 CD1C00          17      CALL    _CALSLT
                                ;   LD  A,(HOKVLD)  ;bit0: 拡張 BIOSの存在
                                ;   CPL
                                ;   AND 1
000F36 4F36 7A               4      LD  A,D
000F37 4F37 B3               4      OR  E
000F38 4F38 C27646          10      JP  NZ,ERROR_INTERNAL_ERROR
                                ;   PUSH    HL      ;EXTBIOもDISK BIOSで初期化してそう
                                ;   LD  A,0     ;すでにA=0になっている
                                ;   LD  DE,0401H    ;D=マッパサポートルチン(4) E=機能番号(1)
                                ;   CALL    EXTBIO
                                ;   POP HL
                                ;   OR  A
                                ;   JP  Z,ERROR_INTERNAL_ERROR
000F3B 4F3B 23               6      INC HL
000F3C 4F3C C9              10      RET
                                
       4F3D                     ROM_CD:
000F3D 4F3D 3AECF2          13      LD  A,(FNAME)
000F40 4F40 FE20             7      CP  020H
000F42 4F42 2835            12      JR  Z,CD1
000F44 4F44 CD5A4C          17      CALL    ROM_OPEN
000F47 4F47 D8              11      RET C
                                #if exists USE_MORMAL32K_OR_ASCII16
000F48 4F48 D5              11      PUSH    DE
000F49 4F49 2AE0F2          16      LD  HL,(DIRENT1)
000F4C 4F4C 110B00          10      LD  DE,0000BH   ;属性(アトリビュート)
000F4F 4F4F 19              11      ADD HL,DE
000F50 4F50 CD8B43          17      CALL    RDSLT_ROM
000F53 4F53 D1              10      POP DE
000F54 4F54 CB67             8      BIT 4,A     ;ディレクトリ
000F56 4F56 CA7C46          10      JP  Z,ERROR_FILE_NOT_FOUND
000F59 4F59 D5              11      PUSH    DE
000F5A 4F5A 2AE0F2          16      LD  HL,(DIRENT1)
000F5D 4F5D 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000F60 4F60 19              11      ADD HL,DE
000F61 4F61 CD8B43          17      CALL    RDSLT_ROM
000F64 4F64 23               6      INC HL
000F65 4F65 5F               4      LD  E,A
000F66 4F66 CD8B43          17      CALL    RDSLT_ROM
000F69 4F69 57               4      LD  D,A
000F6A 4F6A EB               4      EX  DE,HL
000F6B 4F6B D1              10      POP DE
                                #else
                                    LD  IY,(DIRENT1)
                                    BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    LD  L,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  H,(IY+01BH)
                                #endif
       4F6C                     CD2:
000F6C 4F6C 22DEF2          16      LD  (_CD),HL
000F6F 4F6F 2AE7F2          16      LD  HL,(PARAM1)
       4F72                     CD_SKIP:
000F72 4F72 7E               7      LD  A,(HL)
000F73 4F73 23               6      INC HL
000F74 4F74 FE21             7      CP  021H
000F76 4F76 38FA            12      JR  C,CD_SKIP
000F78 4F78 C9              10      RET
       4F79                     CD1:
000F79 4F79 2AE9F2          16      LD  HL,(_CDX)
000F7C 4F7C 18EE            12      JR  CD2
                                
       4F7E                     GET_BASIC_FCB:
000F7E 4F7E D5              11      PUSH    DE
000F7F 4F7F 23               6      INC HL  ;+1
000F80 4F80 5E               7      LD  E,(HL)  ;FCB[1]
000F81 4F81 23               6      INC HL  ;+2
000F82 4F82 56               7      LD  D,(HL)  ;FCB[2]
000F83 4F83 23               6      INC HL  ;+3
000F84 4F84 ED53E0F2        20      LD  (DIRENT1),DE
                                            ;FCB[3]
000F88 4F88 23               6      INC HL  ;+4
                                            ;FCB[4]
000F89 4F89 23               6      INC HL  ;+5
000F8A 4F8A 7E               7      LD  A,(HL)  ;FCB[5]
000F8B 4F8B 23               6      INC HL  ;+6
000F8C 4F8C 32E2F2          13      LD  (_DIR_BANK),A
000F8F 4F8F 5E               7      LD  E,(HL)  ;FCB[6]
000F90 4F90 23               6      INC HL  ;+7
000F91 4F91 56               7      LD  D,(HL)  ;FCB[7]
000F92 4F92 23               6      INC HL  ;+8
000F93 4F93 ED53BDF2        20      LD  (RR_LOW),DE
000F97 4F97 7E               7      LD  A,(HL)  ;FCB[8]
000F98 4F98 23               6      INC HL  ;+9
000F99 4F99 32BFF2          13      LD  (RR_HIGH),A
000F9C 4F9C 7E               7      LD  A,(HL)  ;FCB[9]
000F9D 4F9D 23               6      INC HL  ;+10
000F9E 4F9E 22C7F2          16      LD  (_DTA),HL   ;FCB[10]
000FA1 4FA1 D1              10      POP DE
000FA2 4FA2 C9              10      RET
                                
       4FA3                     SET_BASIC_FCB:
000FA3 4FA3 E5              11      PUSH    HL
000FA4 4FA4 2A64F8          16      LD  HL,(PTRFIL)
000FA7 4FA7 23               6      INC HL  ;+1
000FA8 4FA8 D5              11      PUSH    DE
000FA9 4FA9 ED5BE0F2        20      LD  DE,(DIRENT1)
000FAD 4FAD 73               7      LD  (HL),E  ;FCB[1]
000FAE 4FAE 23               6      INC HL  ;+2
000FAF 4FAF 72               7      LD  (HL),D  ;FCB[2]
000FB0 4FB0 23               6      INC HL  ;+3
000FB1 4FB1 AF               4      XOR A
000FB2 4FB2 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
000FB3 4FB3 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
000FB4 4FB4 23               6      INC HL  ;+5
000FB5 4FB5 3AE2F2          13      LD  A,(_DIR_BANK)
000FB8 4FB8 77               7      LD  (HL),A  ;FCB[5]
000FB9 4FB9 23               6      INC HL  ;+6
000FBA 4FBA ED5BBDF2        20      LD  DE,(RR_LOW)
000FBE 4FBE 73               7      LD  (HL),E  ;FCB[6]
000FBF 4FBF 23               6      INC HL  ;+7
000FC0 4FC0 72               7      LD  (HL),D  ;FCB[7]
000FC1 4FC1 23               6      INC HL  ;+8
000FC2 4FC2 3ABFF2          13      LD  A,(RR_HIGH)
000FC5 4FC5 77               7      LD  (HL),A  ;FCB[8]
000FC6 4FC6 23               6      INC HL  ;+9
000FC7 4FC7 3600            10      LD  (HL),0  ;FCB[9]
000FC9 4FC9 D1              10      POP DE
000FCA 4FCA E1              10      POP HL
000FCB 4FCB C9              10      RET
                                
       4FCC                     DEVICE_CHECK:
000FCC 4FCC 118A50          10      LD  DE,STR_A
000FCF 4FCF CD6250          17      CALL    CPPROCNM
000FD2 4FD2 280A            12      JR  Z,DEVICE_OK
000FD4 4FD4 118C50          10      LD  DE,STR_ROM
000FD7 4FD7 CD6250          17      CALL    CPPROCNM
000FDA 4FDA 2802            12      JR  Z,DEVICE_OK
000FDC 4FDC 37               4      SCF
000FDD 4FDD C9              10      RET
       4FDE                     DEVICE_OK:
000FDE 4FDE AF               4      XOR A
000FDF 4FDF C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファインデックス
                                ; +10: バッファ
                                
       4FE0                     DEVICE_0_OPEN:
000FE0 4FE0 D5              11      PUSH    DE
000FE1 4FE1 E5              11      push    hl
                                ;
000FE2 4FE2 3E01             7      LD  A,1     ;ドライブA
000FE4 4FE4 32EBF2          13      LD  (FDRV),A
000FE7 4FE7 2166F8          10      LD  HL,FILNAM
000FEA 4FEA 11ECF2          10      LD  DE,FNAME
000FED 4FED 010B00          10      LD  BC,8+3
000FF0 4FF0 CD4456          17      CALL    INIT_FILE1
000FF3 4FF3 CD5A4C          17      CALL    ROM_OPEN
000FF6 4FF6 DA7C46          10      JP  C,ERROR_FILE_NOT_FOUND
000FF9 4FF9 E1              10      pop hl
000FFA 4FFA D1              10      POP DE
000FFB 4FFB 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
000FFE 4FFE 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
000FFF 4FFF AF               4      XOR A
001000 5000 32E3F2          13      LD  (LEFTX),A
001003 5003 CDA34F          17      CALL    SET_BASIC_FCB
001006 5006 7B               4      ld  a,e
001007 5007 FE08             7      cp  8
001009 5009 3F               4      ccf
00100A 500A C9              10      ret
                                
       500B                     DEVICE_2_CLOSE:
00100B 500B AF               4      XOR A
                                ;   LD  (HL),A
00100C 500C 6F               4      LD  L,A
00100D 500D 67               4      LD  H,A
00100E 500E 2264F8          16      LD  (PTRFIL),HL
001011 5011 C9              10      RET
                                
       5012                     DEVICE_ENTRY:
001012 5012 FE08             7      CP  8
001014 5014 280C            12      JR  Z,DEVICE_8_SIN
001016 5016 3C               4      INC A
001017 5017 28B3            12      JR  Z,DEVICE_CHECK:
001019 5019 3D               4      DEC A
00101A 501A 28C4            12      JR  Z,DEVICE_0_OPEN
00101C 501C FE02             7      CP  2
00101E 501E 28EB            12      JR  Z,DEVICE_2_CLOSE
001020 5020 37               4      SCF
001021 5021 C9              10      RET
                                
       5022                     DEVICE_8_SIN:
001022 5022 CD7E4F          17      CALL    GET_BASIC_FCB
001025 5025 E67F             7      AND 127
001027 5027 281D            12      JR  Z,SIN_READ_DISK
001029 5029 2AC7F2          16      LD  HL,(_DTA)
00102C 502C 2B               6      DEC HL
00102D 502D 34              11      INC (HL)
00102E 502E 3C               4      INC A   ;(INC HL)
00102F 502F 85               4      ADD A,L ;ADD HL,A
001030 5030 6F               4      LD  L,A ;
001031 5031 8C               4      ADC A,H ;
001032 5032 95               4      SUB L   ;
001033 5033 67               4      LD  H,A ;
       5034                     SIN_READ1:
001034 5034 7E               7      LD  A,(HL)
001035 5035 FE0A             7      CP  00AH
001037 5037 C8              11      RET Z   ;ZF=separate
001038 5038 FE1A             7      CP  01AH
00103A 503A 2803            12      JR  Z,SIN_EOF
00103C 503C 37               4      SCF
00103D 503D 3F               4      CCF     ;ZF=0 CF=0にしたい
00103E 503E C9              10      RET
       503F                     SIN_EOF:
00103F 503F 2AC7F2          16      LD  HL,(_DTA)
001042 5042 2B               6      DEC HL
001043 5043 35              11      DEC (HL)
       5044                     SCF_RET:
001044 5044 37               4      SCF
001045 5045 C9              10      RET
                                
       5046                     SIN_READ_DISK:
001046 5046 218000          10      LD  HL,128
001049 5049 CD274A          17      CALL    ROM_READ
00104C 504C CDA34F          17      CALL    SET_BASIC_FCB
00104F 504F 7C               4      LD  A,H
001050 5050 B5               4      OR  L
001051 5051 28F1            12      JR  Z,SCF_RET
001053 5053 ED5BC7F2        20      LD  DE,(_DTA)
001057 5057 19              11      ADD HL,DE
001058 5058 361A            10      LD  (HL),01AH
00105A 505A 2AC7F2          16      LD  HL,(_DTA)
00105D 505D 2B               6      DEC HL
00105E 505E 34              11      INC (HL)
00105F 505F 23               6      INC HL
001060 5060 18D2            12      JR  SIN_READ1
                                
       5062                     CPPROCNM:
001062 5062 E5              11      PUSH    HL
001063 5063 2189FD          10      LD  HL,PROCNM
       5066                     CPPROCNM1:
001066 5066 1A               7      LD  A,(DE)
001067 5067 13               6      INC DE
001068 5068 BE               7      CP  (HL)
001069 5069 23               6      INC HL
00106A 506A 2003            12      JR  NZ,CPPROCNM2
00106C 506C B7               4      OR  A
00106D 506D 20F7            12      JR  NZ,CPPROCNM1
       506F                     CPPROCNM2:
00106F 506F E1              10      POP HL
001070 5070 C9              10      RET
                                
       5071                     WILDCARD:
001071 5071 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       507C                     STR_CHDIR:
00107C 507C 434844495200            DB  "CHDIR",0
       5082                     STR_RAMDISK:
001082 5082 52414D4449534B00        DB  "RAMDISK",0
       508A                     STR_A:
00108A 508A 4100                    DB  "A",0
       508C                     STR_ROM:
00108C 508C 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       5090                     ERROR_WRITE_PROTECTED:
001090 5090 3E00             7      LD  A,0     ;Write protected
001092 5092 C9              10      RET
       5093                     DISKIO:
001093 5093 38FB            12      JR  C,ERROR_WRITE_PROTECTED
001095 5095 48               4      LD  C,B
001096 5096 CD7052          17      CALL    GET_DISK_BANK
       5099                     SETMAP1:        
001099 5099 E5              11      PUSH    HL
       509A                     DISKIO1:
00109A 509A C5              11      PUSH    BC      ;B=残りのセクタ数
00109B 509B D5              11      PUSH    DE      ;DE=セクタ番号
00109C 509C F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
00109D 509D EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
00109E 509E F5              11      PUSH    AF
00109F 509F 3ABCF2          13      LD  A,(SECSZ_H)
0010A2 50A2 CD8F52          17      CALL    MUL_AHL
0010A5 50A5 F1              10      POP AF
                                #if exists USE_MORMAL32K_OR_ASCII16
0010A6 50A6 7D               4      LD  A,L
0010A7 50A7 C5              11      PUSH    BC
0010A8 50A8 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
0010AB 50AB 09              11      ADD HL,BC
0010AC 50AC C1              10      POP BC
0010AD 50AD 3013            12      JR  NC,DISKIO2
0010AF 50AF 4D               4      LD  C,L     ;C=読み出し元
0010B0 50B0 29              11      ADD HL,HL   ;64KB→32KB
0010B1 50B1 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
0010B2 50B2 CD6652          17      CALL    GET_DISK_BANK_FDRV
0010B5 50B5 84               4      ADD A,H
0010B6 50B6 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
0010B9 50B9 32B7F2          13      LD  (_BANK),A
0010BC 50BC 69               4      LD  L,C     ;C=読み出し元
0010BD 50BD 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
0010BF 50BF A5               4      AND L
0010C0 50C0 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL       ;64KB→32KB
                                    ADD HL,HL       ;32KB→16KB
                                    ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  A,C     ;C=読み出し元
                                    AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       50C2                     DISKIO2:
0010C2 50C2 C660             7      ADD A,high BANK1_ADR
0010C4 50C4 67               4      LD  H,A
0010C5 50C5 ED4BBBF2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
0010C9 50C9 69               4      LD  L,C     ;C=0
0010CA 50CA CDFE43          17      CALL    ROM_LDIR
0010CD 50CD EB               4      EX  DE,HL
0010CE 50CE F1              10      POP AF
0010CF 50CF D1              10      POP DE
0010D0 50D0 13               6      INC DE
0010D1 50D1 C1              10      POP BC
0010D2 50D2 10C6            13      DJNZ    DISKIO1
0010D4 50D4 41               4      LD  B,C
                                
0010D5 50D5 E1              10      POP HL
0010D6 50D6 AF               4      XOR A
                                
0010D7 50D7 FB               4      EI
0010D8 50D8 C9              10      RET
                                
       50D9                     DSKCHG:
0010D9 50D9 CD1251          17      CALL    IS_BPB
0010DC 50DC 3824            12      JR  C,NOTREADY
0010DE 50DE 3A23FB          13      LD  A,(DRVTBL+2)
0010E1 50E1 B7               4      OR  A
0010E2 50E2 201A            12      JR  NZ,DSKCHG1
0010E4 50E4 3A21FB          13      LD  A,(DRVTBL)
0010E7 50E7 FE02             7      CP  2
0010E9 50E9 2013            12      JR  NZ,DSKCHG1
0010EB 50EB CD1251          17      CALL    IS_BPB
0010EE 50EE 300E            12      JR  NC,DSKCHG1
0010F0 50F0 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
0010F2 50F2 3221FB          13      LD  (DRVTBL),A
0010F5 50F5 3223FB          13      LD  (DRVTBL+2),A
0010F8 50F8 3A48F3          13      LD  A,(MASTERS)
0010FB 50FB 3224FB          13      LD  (DRVTBL+3),A
       50FE                     DSKCHG1:
0010FE 50FE AF               4      XOR A
0010FF 50FF 0601             7      LD  B,1
001101 5101 C9              10      RET
       5102                     NOTREADY:
001102 5102 3E02             7      LD  A,2
001104 5104 37               4      SCF
001105 5105 C9              10      RET
                                
       5106                     NO_BPB:
001106 5106 E1              10      POP HL
001107 5107 23               6      INC HL
001108 5108 119552          10      LD  DE,DPB2DD
00110B 510B 011200          10      LD  BC,DPB2DD_E-DPB2DD
00110E 510E EDB0                    LDIR
001110 5110 AF               4      XOR A
001111 5111 C9              10      RET
                                
       5112                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
001112 5112 CD7052          17      CALL    GET_DISK_BANK
                                
001115 5115 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
001118 5118 FE01             7      CP  1
00111A 511A D8              11      RET C
                                
00111B 511B 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
00111E 511E C6FF             7      ADD A,0FFH
001120 5120 D8              11      RET C
                                
001121 5121 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       5124                     IS_BPB1:
001124 5124 FE01             7      CP  1
001126 5126 C8              11      RET Z
001127 5127 FE02             7      CP  2
001129 5129 C8              11      RET Z
00112A 512A FE04             7      CP  4
00112C 512C C8              11      RET Z
00112D 512D 37               4      SCF
00112E 512E C9              10      RET
                                
       512F                     GETDPB:
00112F 512F E5              11      PUSH    HL
001130 5130 CD7052          17      CALL    GET_DISK_BANK
                                
001133 5133 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
001136 5136 B7               4      OR  A
001137 5137 28CD            12      JR  Z,NO_BPB
001139 5139 DDE1            14      POP IX
00113B 513B DD7701          19      LD  (IX+1),A        ;MEDIA
                                
00113E 513E 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
001141 5141 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
001144 5144 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
001147 5147 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
00114A 514A 87               4      ADD A,A
00114B 514B 87               4      ADD A,A
00114C 514C 87               4      ADD A,A
00114D 514D 3D               4      DEC A
00114E 514E DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
001151 5151 06FF             7      LD  B,-1
001153 5153 A7               4      AND A           ;無限ループ阻止
       5154                     GETDPB1:
001154 5154 04               4      INC B
001155 5155 1F               4      RRA
001156 5156 38FC            12      JR  C,GETDPB1
001158 5158 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
00115B 515B 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
00115E 515E 3D               4      DEC A
00115F 515F DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
001162 5162 A7               4      AND A           ;無限ループ阻止
001163 5163 06FF             7      LD  B,-1
       5165                     GETDPB2:
001165 5165 04               4      INC B
001166 5166 1F               4      RRA
001167 5167 38FC            12      JR  C,GETDPB2
001169 5169 04               4      INC B
00116A 516A DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
00116D 516D 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
001170 5170 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
001173 5173 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
001176 5176 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
001179 5179 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
00117C 517C 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
00117F 517F DD770B          19      LD  (IX+11),A       ;MAXENT
                                
001182 5182 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
001186 5186 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
001189 5189 DD460A          19      LD  B,(IX+10)       ;FATCNT
00118C 518C 210000          10      LD  HL,0
       518F                     GETDPB3:
00118F 518F 19              11      ADD HL,DE
001190 5190 10FD            13      DJNZ    GETDPB3
       5192                     GETDPB4:
001192 5192 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
001195 5195 DD5609          19      LD  D,(IX+9)        ;FIRFAT
001198 5198 19              11      ADD HL,DE
001199 5199 DD7511          19      LD  (IX+17),L       ;FIRDIR
00119C 519C DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
00119F 519F DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0011A2 51A2 87               4      ADD A,A
0011A3 51A3 87               4      ADD A,A
0011A4 51A4 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       51A7                     GETDPB5:
0011A7 51A7 CB3B             8      SRL E
0011A9 51A9 1F               4      RRA
0011AA 51AA 30FB            12      JR  NC,GETDPB5
0011AC 51AC 1600             7      LD  D,0
0011AE 51AE 19              11      ADD HL,DE
0011AF 51AF DD750C          19      LD  (IX+12),L       ;FIRREC
0011B2 51B2 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
0011B5 51B5 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
0011B8 51B8 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
0011BB 51BB DD560D          19      LD  D,(IX+13)       ;FIRREC
0011BE 51BE A7               4      AND A
0011BF 51BF ED52            15      SBC HL,DE
                                
0011C1 51C1 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
0011C4 51C4 3C               4      INC A
0011C5 51C5 37               4      SCF             ;無限ループ阻止
       51C6                     GETDPB6:
0011C6 51C6 1F               4      RRA
0011C7 51C7 3806            12      JR  C,GETDPB7
0011C9 51C9 CB3C             8      SRL H
0011CB 51CB CB1D             8      RR  L
0011CD 51CD 18F7            12      JR  GETDPB6
       51CF                     GETDPB7:
0011CF 51CF 23               6      INC HL
0011D0 51D0 DD750E          19      LD  (IX+14),L       ;MAXCLUS
0011D3 51D3 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       51D6                     GETDPBD1:
0011D6 51D6 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0011D9 51D9 E6FC             7      AND 0FCH
0011DB 51DB C8              11      RET Z
                                
0011DC 51DC DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
0011E0 51E0 37               4      SCF
0011E1 51E1 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
0011E5 51E5 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
0011E8 51E8 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
0011EC 51EC DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
0011F0 51F0 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
0011F4 51F4 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
0011F8 51F8 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
0011FC 51FC DDCB1126        23      SLA (IX+17)         ;FIRDIR
001200 5200 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
001204 5204 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
001207 5207 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
00120A 520A DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
00120D 520D 87               4      ADD A,A
00120E 520E 87               4      ADD A,A
00120F 520F DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       5212                     GETDPBD5:
001212 5212 CB3B             8      SRL E
001214 5214 1F               4      RRA
001215 5215 30FB            12      JR  NC,GETDPBD5
001217 5217 1600             7      LD  D,0
001219 5219 19              11      ADD HL,DE
00121A 521A DD750C          19      LD  (IX+12),L       ;FIRREC
00121D 521D DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001220 5220 18B4            12      JR  GETDPBD1
                                
       5222                     CHOICE:
001222 5222 210000          10      LD  HL,0
001225 5225 C9              10      RET
                                
       5226                     DSKFMT:
001226 5226 AF               4      XOR A
001227 5227 37               4      SCF
       5228                     DSKSTP:
001228 5228 C9              10      RET
                                
       5229                     BASENT:
001229 5229 2A74F6          16      LD  HL,(STKTOP)
00122C 522C 3A40F3          13      LD  A,(REBOOT)
00122F 522F C6FF             7      ADD A,0FFH
001231 5231 3811            12      JR  C,REBOOT1
001233 5233 21A752          10      LD  HL,AUTOEXEC
001236 5236 11EBF2          10      LD  DE,FDRV
001239 5239 010C00          10      LD  BC,1+8+3
00123C 523C EDB0                    LDIR
00123E 523E CD5A4C          17      CALL    ROM_OPEN
001241 5241 D4C645          17      CALL    NC,ROM_LOAD1
       5244                     REBOOT1:
001244 5244 21B352          10      LD  HL,CMD_RUN
001247 5247 111FF4          10      LD  DE,KBUF
00124A 524A 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
00124D 524D D5              11      PUSH    DE
00124E 524E EDB0                    LDIR
001250 5250 3004            12      JR  NC,REBOOT2
001252 5252 AF               4      XOR A
001253 5253 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       5256                     REBOOT2:
001256 5256 E1              10      POP HL
001257 5257 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00125B 525B DD210146        14      LD  IX,NEWSTT
00125F 525F C31C00          10      JP  _CALSLT
                                
       5262                     GETSLT:
001262 5262 3A22FB          13      LD  A,(DRVTBL+1)
001265 5265 C9              10      RET
                                
       5266                     GET_DISK_BANK_FDRV:
001266 5266 3AEBF2          13      LD  A,(FDRV)
001269 5269 D601             7      SUB 1
00126B 526B 3003            12      JR  NC,GET_DISK_BANK
00126D 526D 3ADDF2          13      LD  A,(_DVSW)
       5270                     GET_DISK_BANK:
001270 5270 B7               4      OR  A       ;A=DRIVE
001271 5271 3E01             7      LD  A,DISK_BANK
001273 5273 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
001275 5275 3ADCF2          13      LD  A,(B_DRIVE)
                                #endif
       5278                     SET_DISK_BANK:
                                #if exists USE_MORMAL32K_OR_ASCII16
001278 5278 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
00127B 527B F5              11      PUSH    AF
00127C 527C E5              11      PUSH    HL
00127D 527D 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
001280 5280 22BBF2          16      LD  (SECSZ),HL
001283 5283 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
001286 5286 CD8F52          17      CALL    MUL_AHL
001289 5289 22B9F2          16      LD  (CLSZ),HL
00128C 528C E1              10      POP HL
00128D 528D F1              10      POP AF
00128E 528E C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       528F                     MUL_AHL:
00128F 528F 37               4      SCF     ;無限ループ回避
       5290                     MUL_AHL1:
001290 5290 1F               4      RRA     ;->CF
001291 5291 D8              11      RET C
001292 5292 29              11      ADD HL,HL
001293 5293 18FB            12      JR  MUL_AHL1
                                
       5295                     DPB2DD:
001295 5295 F9                      DB  0F9H    ;MEDIA
001296 5296 0002                    DW  00200H  ;SECSIZ
001298 5298 0F                      DB  00FH    ;DIRMSK
001299 5299 04                      DB  004H    ;DIRSHFT
00129A 529A 01                      DB  001H    ;CLUSMSK
00129B 529B 02                      DB  002H    ;CLUSSHFT
00129C 529C 0100                    DW  00001H  ;FIRFAT
00129E 529E 02                      DB  002H    ;FATCNT
00129F 529F 70                      DB  070H    ;MAXENT
0012A0 52A0 0E00                    DW  0000EH  ;FIRREC
0012A2 52A2 CA02                    DW  002CAH  ;MAXCLUS
0012A4 52A4 03                      DB  003H    ;FATSIZ
0012A5 52A5 0700                    DW  0007H   ;FIRDIR
       52A7                     DPB2DD_E:
                                
       52A7                     AUTOEXEC:
0012A7 52A7 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       52B3                     CMD_RUN:
0012B3 52B3 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
                                #if exists USE_MORMAL32K_OR_ASCII16
0012B9 52B9 80F2                    DW  0F280H
                                #else
                                    DW  0F240H
                                #endif
       52BB                     CMD_CLEAR_E:
0012BB 52BB 3A8A00                  DB  03AH,08AH,0         ;RUN
       52BE                     CMD_RUN_E:
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       52BE                     POP_HL_ERROR:
0012BE 52BE E1              10      POP     HL
       52BF                     _ERROR:
0012BF 52BF 0600             7      LD  B,0
0012C1 52C1 A7               4      AND A
0012C2 52C2 C9              10      RET
                                
       52C3                     ROM_BDOS:
0012C3 52C3 E5              11      PUSH    HL
0012C4 52C4 79               4      LD  A,C
0012C5 52C5 87               4      ADD A,A
0012C6 52C6 38F7            12      JR  C,_ERROR
0012C8 52C8 6F               4      LD  L,A
0012C9 52C9 265F             7      LD  H,high STABLE
0012CB 52CB 7E               7      LD  A,(HL)
0012CC 52CC 2C               4      INC L
0012CD 52CD 66               7      LD  H,(HL)
0012CE 52CE 6F               4      LD  L,A
0012CF 52CF E3              19      EX  (SP),HL
0012D0 52D0 79               4      LD  A,C
0012D1 52D1 C9              10      RET
                                
       52D2                     _PRINT:
       52D2                     PRINT:
0012D2 52D2 7B               4      LD  A,E
0012D3 52D3 1803            12      JR  MSG_A
                                
       52D5                     _SYS01:     ;(BDOS)コンソール入力
0012D5 52D5 CD4C53          17      CALL    _SYS07
       52D8                     MSG_A:
0012D8 52D8 FE03             7      CP  3
0012DA 52DA 2814            12      JR  Z,MSG_BR
       52DC                     MSGA1:
0012DC 52DC F5              11      PUSH    AF
0012DD 52DD C5              11      PUSH    BC
0012DE 52DE D5              11      PUSH    DE
0012DF 52DF E5              11      PUSH    HL
0012E0 52E0 DDE5            15      PUSH    IX
0012E2 52E2 DD21A200        14      LD  IX,CHPUT
0012E6 52E6 CDD642          17      CALL    CALSLT_R
0012E9 52E9 DDE1            14      POP IX
0012EB 52EB E1              10      POP HL
0012EC 52EC D1              10      POP DE
0012ED 52ED C1              10      POP BC
       52EE                     MSGA2:
0012EE 52EE F1              10      POP AF
0012EF 52EF C9              10      RET
       52F0                     MSG_BR:
0012F0 52F0 F5              11      PUSH    AF
0012F1 52F1 3ADDF3          13      LD  A,(CSRX)
0012F4 52F4 FE02             7      CP  2
0012F6 52F6 38F6            12      JR  C,MSGA2
0012F8 52F8 F1              10      POP AF
       52F9                     MSG_CR:
0012F9 52F9 F5              11      PUSH    AF
0012FA 52FA 3E0D             7      LD  A,00DH
0012FC 52FC CDDC52          17      CALL    MSGA1
0012FF 52FF 3E0A             7      LD  A,00AH
001301 5301 CDDC52          17      CALL    MSGA1
001304 5304 F1              10      POP AF
001305 5305 C9              10      RET
                                
       5306                     _SYS02:     ;(BDOS)コンソール出力
001306 5306 CD2153          17      CALL    BREAK
001309 5309 1805            12      JR  PRINTX
                                
       530B                     _SYS06:     ;(BDOS)コンソール直接入出力
00130B 530B 7B               4      LD  A,E
00130C 530C 3C               4      INC A
00130D 530D CA6053          10      JP  Z,_INKEY
       5310                     PRINTX:
001310 5310 C3D252          10      JP  _PRINT
                                
       5313                     _SYS08:     ;(BDOS)エコーなしコンソール入力
001313 5313 CD4C53          17      CALL    _SYS07
001316 5316 FE03             7      CP  3
001318 5318 CC2153          17      CALL    Z,_BREAK
00131B 531B FE13             7      CP  013H        ;CTRL+S
00131D 531D C0              11      RET NZ
       531E                     PAUSE:
00131E 531E CD3853          17      CALL    KEYBC
                                
       5321                     _BREAK:
       5321                     BREAK:
001321 5321 F5              11      PUSH    AF
001322 5322 C5              11      PUSH    BC
001323 5323 D5              11      PUSH    DE
001324 5324 E5              11      PUSH    HL
001325 5325 DDE5            15      PUSH    IX
001327 5327 DD21B700        14      LD  IX,BREAKX
00132B 532B CDD642          17      CALL    CALSLT_R
00132E 532E DDE1            14      POP IX
001330 5330 E1              10      POP HL
001331 5331 D1              10      POP DE
001332 5332 C1              10      POP BC
001333 5333 DC2153          17      CALL    C,_BREAK
001336 5336 F1              10      POP AF
001337 5337 C9              10      RET
       5338                     KEYBC:
001338 5338 F5              11      PUSH    AF
001339 5339 C5              11      PUSH    BC
00133A 533A D5              11      PUSH    DE
00133B 533B E5              11      PUSH    HL
00133C 533C DDE5            15      PUSH    IX
00133E 533E DD215601        14      LD  IX,KILBUF
001342 5342 CDD642          17      CALL    CALSLT_R
001345 5345 DDE1            14      POP IX
001347 5347 E1              10      POP HL
001348 5348 D1              10      POP DE
001349 5349 C1              10      POP BC
00134A 534A F1              10      POP AF
00134B 534B C9              10      RET
                                
       534C                     _SYS07:
       534C                     FLGET:
00134C 534C C5              11      PUSH    BC
00134D 534D D5              11      PUSH    DE
00134E 534E E5              11      PUSH    HL
00134F 534F DDE5            15      PUSH    IX
001351 5351 DD219F00        14      LD  IX,CHGET
001355 5355 CDD642          17      CALL    CALSLT_R
001358 5358 DDE1            14      POP IX
00135A 535A E1              10      POP HL
00135B 535B D1              10      POP DE
00135C 535C C1              10      POP BC
00135D 535D FE03             7      CP  3
00135F 535F C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       5360                     _INKEY:
       5360                     INKEY:
001360 5360 CDFA53          17      CALL    CPM_CONST
001363 5363 C8              11      RET Z
001364 5364 18E6            12      JR  FLGET
                                
       5366                     _SYS0A:     ;(BDOS)文字列入力
001366 5366 C5              11      PUSH    BC
001367 5367 E5              11      PUSH    HL
001368 5368 D5              11      PUSH    DE
001369 5369 CD9253          17      CALL    GETL
00136C 536C 111FF4          10      LD  DE,KBUF
00136F 536F E1              10      POP HL
001370 5370 E5              11      PUSH    HL
001371 5371 0E00             7      LD  C,0
001373 5373 3004            12      JR  NC,SAX0
001375 5375 23               6      INC HL
001376 5376 23               6      INC HL
001377 5377 1808            12      JR  SAX4
       5379                     SAX0:
001379 5379 46               7      LD  B,(HL)
00137A 537A 23               6      INC HL
       537B                     SAX1:
00137B 537B 23               6      INC HL
00137C 537C 1A               7      LD  A,(DE)
00137D 537D 13               6      INC DE
00137E 537E B7               4      OR  A
00137F 537F 2004            12      JR  NZ,SAX2
       5381                     SAX4:
001381 5381 360D            10      LD  (HL),00DH
001383 5383 1804            12      JR  SAX3
       5385                     SAX2:
001385 5385 77               7      LD  (HL),A
001386 5386 0C               4      INC C
001387 5387 10F2            13      DJNZ    SAX1
       5389                     SAX3:
001389 5389 D1              10      POP DE
00138A 538A 79               4      LD  A,C
00138B 538B 13               6      INC DE
00138C 538C 12               7      LD  (DE),A
00138D 538D 1B               6      DEC DE
00138E 538E E1              10      POP HL
00138F 538F C1              10      POP BC
001390 5390 A7               4      AND A
001391 5391 C9              10      RET
       5392                     GETL:
001392 5392 DDE5            15      PUSH    IX
001394 5394 FDE5            15      PUSH    IY
                                
001396 5396 2ADCF3          16      LD  HL,(CSRY)
001399 5399 22CAFB          16      LD  (FSTPOS),HL
       539C                     GETL1:
00139C 539C CD1353          17      CALL    _SYS08
00139F 539F FE09             7      CP  9
0013A1 53A1 2008            12      JR  NZ,GETL1V
0013A3 53A3 211FF4          10      LD  HL,KBUF
0013A6 53A6 CD6043          17      CALL    MSX
0013A9 53A9 18F1            12      JR  GETL1
       53AB                     GETL1V:
0013AB 53AB 5F               4      LD  E,A
0013AC 53AC FE08             7      CP  8
0013AE 53AE CC4854          17      CALL    Z,CTRL02
0013B1 53B1 FE20             7      CP  020H
0013B3 53B3 D47454          17      CALL    NC,INSERT
0013B6 53B6 CDDC52          17      CALL    MSGA1
                                
0013B9 53B9 7B               4      LD  A,E
0013BA 53BA FE0D             7      CP  00DH
0013BC 53BC 20DE            12      JR  NZ,GETL1
                                
0013BE 53BE 111FF4          10      LD  DE,KBUF
0013C1 53C1 3AB0F3          13      LD  A,(LINLEN)
0013C4 53C4 47               4      LD  B,A
0013C5 53C5 CD5356          17      CALL    ZERO_MEMORY_DE
                                
0013C8 53C8 2ACAFB          16      LD  HL,(FSTPOS)
0013CB 53CB 3ADCF3          13      LD  A,(CSRY)
0013CE 53CE 6F               4      LD  L,A
0013CF 53CF E5              11      PUSH    HL
0013D0 53D0 CDA554          17      CALL    LOC0
0013D3 53D3 4D               4      LD  C,L
0013D4 53D4 44               4      LD  B,H
0013D5 53D5 E1              10      POP HL
0013D6 53D6 3AB0F3          13      LD  A,(LINLEN)
0013D9 53D9 94               4      SUB H
0013DA 53DA 3D               4      DEC A
0013DB 53DB 5F               4      LD  E,A
0013DC 53DC 211FF4          10      LD  HL,KBUF
       53DF                     GETL2:
0013DF 53DF CD3854          17      CALL    _SCRN
0013E2 53E2 03               6      INC BC
0013E3 53E3 77               7      LD  (HL),A
0013E4 53E4 23               6      INC HL
0013E5 53E5 1D               4      DEC E
0013E6 53E6 20F7            12      JR  NZ,GETL2
0013E8 53E8 CDF952          17      CALL    MSG_CR
                                
0013EB 53EB FDE1            14      POP IY
0013ED 53ED DDE1            14      POP IX
       53EF                     GETL3:
0013EF 53EF 2B               6      DEC HL
0013F0 53F0 7E               7      LD  A,(HL)
0013F1 53F1 FE21             7      CP  021H
0013F3 53F3 D0              11      RET NC
0013F4 53F4 3600            10      LD  (HL),0
0013F6 53F6 15               4      DEC D
0013F7 53F7 20F6            12      JR  NZ,GETL3
0013F9 53F9 C9              10      RET
                                
       53FA                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       53FA                     CONSTX:
       53FA                     CPM_CONST:
0013FA 53FA C5              11      PUSH    BC
0013FB 53FB D5              11      PUSH    DE
0013FC 53FC E5              11      PUSH    HL
0013FD 53FD DDE5            15      PUSH    IX
0013FF 53FF DD219C00        14      LD  IX,CHSNS
001403 5403 CDD642          17      CALL    CALSLT_R
001406 5406 DDE1            14      POP IX
001408 5408 E1              10      POP HL
001409 5409 D1              10      POP DE
00140A 540A C1              10      POP BC
00140B 540B C9              10      RET
                                
       540C                     _SYS2A:     ;(BDOS)日付の獲得
00140C 540C AF               4      XOR A
00140D 540D 57               4      LD  D,A
00140E 540E 5F               4      LD  E,A
00140F 540F 67               4      LD  H,A
001410 5410 6F               4      LD  L,A
001411 5411 C9              10      RET
                                
       5412                     _SYS2C:     ;(BDOS)時刻の獲得
001412 5412 AF               4      XOR A
001413 5413 57               4      LD  D,A
001414 5414 5F               4      LD  E,A
001415 5415 67               4      LD  H,A
001416 5416 6F               4      LD  L,A
001417 5417 C9              10      RET
                                
       5418                     POS:
001418 5418 F5              11      PUSH    AF
001419 5419 2ADCF3          16      LD  HL,(CSRY)
00141C 541C 7D               4      LD  A,L
00141D 541D 6C               4      LD  L,H
00141E 541E 67               4      LD  H,A
00141F 541F 2C               4      INC L
001420 5420 24               4      INC H
001421 5421 F1              10      POP AF
001422 5422 C9              10      RET
                                
       5423                     LOC:
001423 5423 F5              11      PUSH    AF
001424 5424 E5              11      PUSH    HL
001425 5425 7D               4      LD  A,L
001426 5426 6C               4      LD  L,H
001427 5427 67               4      LD  H,A
001428 5428 2D               4      DEC L
001429 5429 25               4      DEC H
00142A 542A DDE5            15      PUSH    IX
00142C 542C DD21C600        14      LD  IX,POSIT
001430 5430 CDD642          17      CALL    CALSLT_R
001433 5433 DDE1            14      POP IX
001435 5435 E1              10      POP HL
001436 5436 F1              10      POP AF
001437 5437 C9              10      RET
                                
       5438                     _SCRN:
       5438                     SCRN:
001438 5438 E5              11      PUSH    HL
001439 5439 DDE5            15      PUSH    IX
                                
00143B 543B 69               4      LD  L,C
00143C 543C 60               4      LD  H,B
00143D 543D DD214A00        14      LD  IX,RDVRM
001441 5441 CDD642          17      CALL    CALSLT_R
                                
001444 5444 DDE1            14      POP IX
001446 5446 E1              10      POP HL
001447 5447 C9              10      RET
                                
       5448                     CTRL02:
001448 5448 F5              11      PUSH    AF
001449 5449 D5              11      PUSH    DE
00144A 544A 2ADCF3          16      LD  HL,(CSRY)
00144D 544D 3AB0F3          13      LD  A,(LINLEN)
001450 5450 4F               4      LD  C,A
001451 5451 94               4      SUB H   ;CSRX
001452 5452 C602             7      ADD A,2
001454 5454 47               4      LD  B,A ;カーソルより右の文字数
001455 5455 61               4      LD  H,C ;LINLEN
001456 5456 C5              11      PUSH    BC
001457 5457 CDA554          17      CALL    LOC0
00145A 545A C1              10      POP BC
                                
00145B 545B 1620             7      LD  D,020H
       545D                     C8X1:
00145D 545D DD214A00        14      LD  IX,RDVRM
001461 5461 CDD642          17      CALL    CALSLT_R
001464 5464 4F               4      LD  C,A
001465 5465 7A               4      LD  A,D
001466 5466 DD214D00        14      LD  IX,WRTVRM
00146A 546A CDD642          17      CALL    CALSLT_R
00146D 546D 2B               6      DEC HL
00146E 546E 51               4      LD  D,C
00146F 546F 10EC            13      DJNZ    C8X1
001471 5471 D1              10      POP DE
001472 5472 F1              10      POP AF
001473 5473 C9              10      RET
                                
       5474                     INSERT:
001474 5474 F5              11      PUSH    AF
001475 5475 D5              11      PUSH    DE
001476 5476 2ADCF3          16      LD  HL,(CSRY)
001479 5479 3AB0F3          13      LD  A,(LINLEN)
00147C 547C 4F               4      LD  C,A
00147D 547D 94               4      SUB H   ;CSRX
00147E 547E 3C               4      INC A
00147F 547F 47               4      LD  B,A ;カーソルより右の文字数
001480 5480 C5              11      PUSH    BC
001481 5481 CDA554          17      CALL    LOC0
001484 5484 C1              10      POP BC
                                
001485 5485 1620             7      LD  D,020H
       5487                     INS1:
001487 5487 DD214A00        14      LD  IX,RDVRM
00148B 548B CDD642          17      CALL    CALSLT_R
00148E 548E 4F               4      LD  C,A
00148F 548F 7A               4      LD  A,D
001490 5490 DD214D00        14      LD  IX,WRTVRM
001494 5494 CDD642          17      CALL    CALSLT_R
001497 5497 23               6      INC HL
001498 5498 51               4      LD  D,C
001499 5499 10EC            13      DJNZ    INS1
00149B 549B D1              10      POP DE
00149C 549C F1              10      POP AF
00149D 549D C9              10      RET
                                
       549E                     CONOUT1:
00149E 549E 59               4      LD  E,C
00149F 549F C3D252          10      JP  _PRINT
                                
       54A2                     GETVRAM:
0014A2 54A2 2ADCF3          16      LD  HL,(CSRY)
       54A5                     LOC0:
0014A5 54A5 2D               4      DEC L
0014A6 54A6 25               4      DEC H
0014A7 54A7 4C               4      LD  C,H ;CSRX-1
0014A8 54A8 5D               4      LD  E,L ;CSRY-1
       54A9                     LOC1:
0014A9 54A9 3AB0F3          13      LD  A,(LINLEN)
0014AC 54AC 67               4      LD  H,A
0014AD 54AD 1600             7      LD  D,0
0014AF 54AF 6A               4      LD  L,D ;0
0014B0 54B0 0608             7      LD  B,8
       54B2                     LOC2:
0014B2 54B2 29              11      ADD HL,HL
0014B3 54B3 3001            12      JR  NC,LOC3
0014B5 54B5 19              11      ADD HL,DE
       54B6                     LOC3:
0014B6 54B6 10FA            13      DJNZ    LOC2
0014B8 54B8 09              11      ADD HL,BC
0014B9 54B9 C9              10      RET
                                
       54BA                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0014BA 54BA 212200          10      LD  HL,00022H
0014BD 54BD AF               4      XOR A
0014BE 54BE 7D               4      LD  A,L
0014BF 54BF C9              10      RET
                                
       54C0                     _SYS0D:     ;(BDOS)ディスク・リセット
0014C0 54C0 218000          10      LD  HL,00080H
0014C3 54C3 22C7F2          16      LD  (_DTA),HL
0014C6 54C6 C9              10      RET
                                
       54C7                     _SYS0E:     ;(BDOS)カレントドライブの設定
0014C7 54C7 7B               4      LD  A,E
0014C8 54C8 FE02             7      CP  2
0014CA 54CA D0              11      RET NC
0014CB 54CB 32DDF2          13      LD  (_DVSW),A
0014CE 54CE C9              10      RET
                                
       54CF                     _SYS0F:     ;(BDOS)ファイルのオープン
0014CF 54CF D5              11      PUSH    DE
0014D0 54D0 FDE1            14      POP IY
0014D2 54D2 CD3D56          17      CALL    INIT_FILE
0014D5 54D5 CD5A4C          17      CALL    ROM_OPEN
0014D8 54D8 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
0014DA 54DA FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
0014DE 54DE FDE5            15      PUSH    IY
0014E0 54E0 D1              10      POP DE
0014E1 54E1 13               6      INC DE
0014E2 54E2 010B00          10      LD  BC,11
0014E5 54E5 EDB0                    LDIR
                                ;               Attribute
0014E7 54E7 7E               7      LD  A,(HL)
0014E8 54E8 FD770D          19      LD  (IY+13),A
                                ;               TIME
0014EB 54EB 110B00          10      LD  DE,11
0014EE 54EE 19              11      ADD HL,DE
0014EF 54EF 7E               7      LD  A,(HL)
0014F0 54F0 23               6      INC HL
0014F1 54F1 FD7716          19      LD  (IY+22),A
0014F4 54F4 7E               7      LD  A,(HL)
0014F5 54F5 23               6      INC HL
0014F6 54F6 FD7717          19      LD  (IY+23),A
                                ;               DATE
0014F9 54F9 7E               7      LD  A,(HL)
0014FA 54FA 23               6      INC HL
0014FB 54FB FD7714          19      LD  (IY+20),A
0014FE 54FE 7E               7      LD  A,(HL)
0014FF 54FF 23               6      INC HL
001500 5500 FD7715          19      LD  (IY+21),A
                                ;               First cluster
001503 5503 7E               7      LD  A,(HL)
001504 5504 23               6      INC HL
001505 5505 FD771A          19      LD  (IY+26),A
001508 5508 7E               7      LD  A,(HL)
001509 5509 23               6      INC HL
00150A 550A FD771B          19      LD  (IY+27),A
                                ;               SIZE
00150D 550D 7E               7      LD  A,(HL)
00150E 550E 23               6      INC HL
00150F 550F FD7710          19      LD  (IY+16),A
001512 5512 7E               7      LD  A,(HL)
001513 5513 23               6      INC HL
001514 5514 FD7711          19      LD  (IY+17),A
001517 5517 7E               7      LD  A,(HL)
001518 5518 23               6      INC HL
001519 5519 FD7712          19      LD  (IY+18),A
00151C 551C 7E               7      LD  A,(HL)
00151D 551D FD7713          19      LD  (IY+19),A
001520 5520 AF               4      XOR A
001521 5521 FD770C          19      LD  (IY+12),A
001524 5524 C9              10      RET
                                
       5525                     _SYS10:     ;(BDOS)ファイルのクローズ
001525 5525 AF               4      XOR A
001526 5526 C9              10      RET
                                
       5527                     S11X1:
001527 5527 FD7119          19      LD  (IY+25),C       ;RootEntCnt
00152A 552A FD750E          19      LD  (IY+14),L
00152D 552D FD740F          19      LD  (IY+15),H
       5530                     SCF_FF_RET:
001530 5530 37               4      SCF
001531 5531 9F               4      SBC A,A
001532 5532 C9              10      RET
                                
       5533                     _SYS11:     ;(BDOS)最初のファイルの検索
001533 5533 ED53CAF2        20      LD  (_FCB),DE
001537 5537 D5              11      PUSH    DE
001538 5538 FDE1            14      POP IY
00153A 553A CD3D56          17      CALL    INIT_FILE
00153D 553D CDB64E          17      CALL    GET_DIR_DAT
       5540                     S12X1:
001540 5540 CD764C          17      CALL    FILESE
001543 5543 30E2            12      JR  NC,S11X1
001545 5545 0D               4      DEC C
001546 5546 FD7119          19      LD  (IY+25),C       ;RootEntCnt
001549 5549 FDCB0D66        20      BIT 4,(IY+13)
00154D 554D 2809            12      JR  Z,S12X2
00154F 554F E5              11      PUSH    HL
001550 5550 DDE1            14      POP IX
001552 5552 DDCB0E66        20      BIT 4,(IX+1+13)
001556 5556 28E8            12      JR  Z,S12X1
       5558                     S12X2:
001558 5558 012000          10      LD  BC,32
00155B 555B ED5BC7F2        20      LD  DE,(_DTA)
00155F 555F AF               4      XOR A
001560 5560 12               7      LD  (DE),A      ;ドライブ番号
001561 5561 13               6      INC DE
001562 5562 EDB0                    LDIR            ;ディレクトリエントリ
001564 5564 FD750E          19      LD  (IY+14),L
001567 5567 FD740F          19      LD  (IY+15),H
00156A 556A C9              10      RET
                                
       556B                     _SYS12:
00156B 556B FD2ACAF2        20      LD  IY,(_FCB)
00156F 556F FDE5            15      PUSH    IY
001571 5571 D1              10      POP DE
001572 5572 CD3D56          17      CALL    INIT_FILE
                                
001575 5575 FD6E0E          19      LD  L,(IY+14)
001578 5578 FD660F          19      LD  H,(IY+15)
00157B 557B FD4E19          19      LD  C,(IY+25)
00157E 557E 18C0            12      JR  S12X1
                                
       5580                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
001580 5580 CD9C4E          17      CALL    SET_FCB
001583 5583 CD6A4E          17      CALL    GETSEQ
001586 5586 CD574E          17      CALL    RB_READ
001589 5589 E5              11      PUSH    HL
00158A 558A CD774E          17      CALL    SETSEQ
00158D 558D E1              10      POP HL
       558E                     SREAD:
00158E 558E C601             7      ADD A,001H
001590 5590 D8              11      RET C
                                
001591 5591 7D               4      LD  A,L
001592 5592 D601             7      SUB 001H
001594 5594 9F               4      SBC A,A
001595 5595 E603             7      AND 3
001597 5597 1F               4      RRA
001598 5598 C9              10      RET
                                
       5599                     _SYS18:     ;(BDOS)ログインベクトルの獲得
001599 5599 210100          10      LD  HL,00001H
00159C 559C AF               4      XOR A
00159D 559D C9              10      RET
                                
       559E                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
00159E 559E 3ADDF2          13      LD  A,(_DVSW)
0015A1 55A1 C9              10      RET
                                
       55A2                     _SYS1A:     ;(BDOS)DTAの設定
0015A2 55A2 ED53C7F2        20      LD  (_DTA),DE
0015A6 55A6 AF               4      XOR A
0015A7 55A7 C9              10      RET
                                
       55A8                     _SYS1B:     ;(BDOS)ディスク情報の獲得
0015A8 55A8 010002          10      LD  BC,512
0015AB 55AB 11C302          10      LD  DE,707
0015AE 55AE 210000          10      LD  HL,0
0015B1 55B1 DD21CCF2        14      LD  IX,_BUF
0015B5 55B5 FD21CCF2        14      LD  IY,_BUF
0015B9 55B9 FD3600F9        19      LD  (IY+0),0F9H
0015BD 55BD 3E02             7      LD  A,2
0015BF 55BF C9              10      RET
                                
       55C0                     _SYS21:     ;(BDOS)ランダムな読み出し
0015C0 55C0 CD9C4E          17      CALL    SET_FCB
                                
0015C3 55C3 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0015C6 55C6 FD6622          19      LD  H,(IY+34)
                                
0015C9 55C9 CD574E          17      CALL    RB_READ
0015CC 55CC 18C0            12      JR  SREAD
                                
       55CE                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
0015CE 55CE CDCF54          17      CALL    _SYS0F
0015D1 55D1 D8              11      RET C
                                
0015D2 55D2 D5              11      PUSH    DE      ;EX DE,IY
0015D3 55D3 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0015D5 55D5 CD8C4E          17      CALL    GETSIZE
       55D8                     _S24X1:
0015D8 55D8 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
0015DB 55DB FD7422          19      LD  (IY+34),H
0015DE 55DE FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
0015E2 55E2 FDE3            23      EX  (SP),IY     ;
0015E4 55E4 D1              10      POP DE      ;
                                
0015E5 55E5 AF               4      XOR A
0015E6 55E6 C9              10      RET
                                
       55E7                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
0015E7 55E7 E5              11      PUSH    HL
0015E8 55E8 D5              11      PUSH    DE      ;EX DE,IY
0015E9 55E9 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0015EB 55EB CD6A4E          17      CALL    GETSEQ
0015EE 55EE 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       55F0                     _SYS27:     ;(BDOS)ランダムブロック読み込み
0015F0 55F0 CD9C4E          17      CALL    SET_FCB
0015F3 55F3 E5              11      PUSH    HL
0015F4 55F4 FD6E21          19      LD  L,(IY+33)
0015F7 55F7 FD6622          19      LD  H,(IY+34)
0015FA 55FA 22BDF2          16      LD  (RR_LOW),HL
0015FD 55FD FD6E23          19      LD  L,(IY+35)
001600 5600 FD6624          19      LD  H,(IY+36)
001603 5603 22BFF2          16      LD  (RR_HIGH),HL
001606 5606 E1              10      POP HL
001607 5607 CD274A          17      CALL    ROM_READ
00160A 560A ED5BBDF2        20      LD  DE,(RR_LOW)
00160E 560E FD7321          19      LD  (IY+33),E
001611 5611 FD7222          19      LD  (IY+34),D
001614 5614 ED5BBFF2        20      LD  DE,(RR_HIGH)
001618 5618 FD7323          19      LD  (IY+35),E
00161B 561B FD7224          19      LD  (IY+36),D
00161E 561E 9F               4      SBC A,A
00161F 561F C9              10      RET
                                
       5620                     _SYS2F:
001620 5620 44               4      LD  B,H
001621 5621 2AC7F2          16      LD  HL,(_DTA)
001624 5624 C39350          10      JP  DISKIO
                                
       5627                     _SYS5A:
001627 5627 0600             7      LD  B,0
001629 5629 D5              11      PUSH    DE
00162A 562A DDE1            14      POP IX
       562C                     _SX5A1:
00162C 562C 1A               7      LD  A,(DE)
00162D 562D B7               4      OR  A
00162E 562E 2804            12      JR  Z,_SX5A2
001630 5630 13               6      INC DE
001631 5631 04               4      INC B
001632 5632 18F8            12      JR  _SX5A1
                                
       5634                     _SX5A2:
001634 5634 78               4      LD  A,B
001635 5635 CDF24A          17      CALL    FILE_BDOS
001638 5638 CD3D4F          17      CALL    ROM_CD
00163B 563B 9F               4      SBC A,A
00163C 563C C9              10      RET
                                
       563D                     INIT_FILE:
00163D 563D EB               4      EX  DE,HL
00163E 563E 11EBF2          10      LD  DE,FDRV
001641 5641 010C00          10      LD  BC,1+8+3
       5644                     INIT_FILE1:
001644 5644 EDB0                    LDIR
001646 5646 CD6652          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_MORMAL32K_OR_ASCII16
001649 5649 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
00164C 564C 2ADEF2          16      LD  HL,(_CD)
00164F 564F 22E9F2          16      LD  (_CDX),HL           ;カレントディレクトリ
001652 5652 C9              10      RET
                                
       5653                     ZERO_MEMORY_DE:
001653 5653 AF               4      XOR A
       5654                     FILL_MEMORY_DE:
001654 5654 12               7      LD  (DE),A
001655 5655 13               6      INC DE
001656 5656 10FC            13      DJNZ    FILL_MEMORY_DE
001658 5658 C9              10      RET
                                
001659 5659                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 BF52D5520653BF52        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 BF52BF520B534C53        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 1353BF526653FA53        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 BA54C054C754CF54        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 255533556B55BF52        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 8055BF52BF52BF52        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 99559E55A255A855        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 BF52BF52BF52CE55        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 E755BF52BF52F055        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 BF52BF520C54BF52        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 1254BF52BF522056        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 BF52BF522756BF52        DW  _ERROR,_ERROR,_SYS5A,_ERROR
001FB8 5FB8 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 BF52BF52BF52BF52        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
[EOF:DISKROM32.ASM:UTF_8]
