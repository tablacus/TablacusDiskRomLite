                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       42B2                     CRUNCH  EQU 042B2H
       4C64                     FRMEVL  EQU 04C64H
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
                                ;PTRFIL EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
                                ;FILNAM EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
                                ;RSTMP  EQU 0FB03H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FEDA                     H_STKE  EQU 0FEDAH
                                
       FF43                     H_GONE  EQU 0FF43H
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                
       F0E9                     ISC EQU 0F0E9H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
[EOF:DEF.ASM:UTF_8]
                                
       0001                     USE_NORMAL_32K_ROM      EQU 1   ;ノーマル32KB ROMを作成する
                                ;USE_RAM_BLOAD_S    EQU 1   ;先頭のコメントを外すとBLOAD,SでRAMを使う
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C34A4B          10      JP  DISKIO
000013 4013 C3814B          10      JP  DSKCHG
000016 4016 C3D74B          10      JP  GETDPB
000019 4019 C3CA4C          10      JP  CHOICE
00001C 401C C3CE4C          10      JP  DSKFMT
00001F 401F C3D04C          10      JP  DSKSTP
000022 4022 C3D14C          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C3CE4C          10      JP  DSKFMT
000029 4029 C3D04C          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3D84C          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.1.4.1",0
            204449534B20524F    
            4D204C6974652076    
            302E312E342E3100    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 0180FF          10      LD  BC,-00080H
000109 4109 2A72F6          16      LD  HL,(MEMSIZ)
00010C 410C 09              11      ADD HL,BC
00010D 410D 2272F6          16      LD  (MEMSIZ),HL
000110 4110 2A74F6          16      LD  HL,(STKTOP)
000113 4113 09              11      ADD HL,BC
000114 4114 2274F6          16      LD  (STKTOP),HL
000117 4117 2180F0          10      LD  HL,0F080H
00011A 411A 1100F0          10      LD  DE,0F000H
00011D 411D 012000          10      LD  BC,00020H
000120 4120 EDB0                    LDIR
000122 4122 2180FF          10      LD  HL,-00080H
000125 4125 39              11      ADD HL,SP
000126 4126 2257F1          16      LD  (BASSTK),HL
000129 4129 ED7B57F1        20      LD  SP,(BASSTK)
                                
00012D 412D 3EFF             7      LD  A,0FFH
00012F 412F 3299FD          13      LD  (DEVICE),A
                                
000132 4132 3E01             7      LD  A,1
000134 4134 3221FB          13      LD  (DRVTBL),A
                                
000137 4137 AF               4      XOR A
000138 4138 3242F1          13      LD  (_DVSW),A
                                
00013B 413B 21DD42          10      LD  HL,AT_ISC
00013E 413E 11E9F0          10      LD  DE,ISC
000141 4141 017400          10      LD  BC,ISC_E-ISC
000144 4144 EDB0                    LDIR
                                    
000146 4146 3EC3             7      LD  A,0C3H      ;JP
000148 4148 3243FF          13      LD  (H_GONE),A
00014B 414B 327DF3          13      LD  (BDOS),A
00014E 414E 326BF3          13      LD  (RAMUSE),A
000151 4151 3268F3          13      LD  (ROMUSE),A
000154 4154 21E9F0          10      LD  HL,REPLACE_COMMAND
000157 4157 2244FF          16      LD  (H_GONE+1),HL
00015A 415A 2131F3          10      LD  HL,H_BDOS
00015D 415D 227EF3          16      LD  (BDOS+1),HL
000160 4160 2110F1          10      LD  HL,RAMUSE1
000163 4163 226CF3          16      LD  (RAMUSE+1),HL
000166 4166 210BF1          10      LD  HL,ROMUSE1
000169 4169 2269F3          16      LD  (ROMUSE+1),HL
                                
00016C 416C 3E                      DB  03EH
00016D 416D F7              12      RST 30H
00016E 416E 3271FE          13      LD  (H_BINS),A
000171 4171 3276FE          13      LD  (H_BINL),A
000174 4174 327BFE          13      LD  (H_FILE),A
000177 4177 3231F3          13      LD  (H_BDOS),A
00017A 417A 32DAFE          13      LD  (H_STKE),A
00017D 417D 32A7FF          13      LD  (H_PHYD),A
                                
000180 4180 CD2542          17      CALL    GTSL1_
000183 4183 32FCF0          13      LD  (ROM_SLT),A
000186 4186 3272FE          13      LD  (H_BINS+1),A
000189 4189 3277FE          13      LD  (H_BINL+1),A
00018C 418C 327CFE          13      LD  (H_FILE+1),A
00018F 418F 3232F3          13      LD  (H_BDOS+1),A
000192 4192 32DBFE          13      LD  (H_STKE+1),A
000195 4195 32A8FF          13      LD  (H_PHYD+1),A
000198 4198 3222FB          13      LD  (DRVTBL+1),A
00019B 419B 3248F3          13      LD  (MASTERS),A
                                
00019E 419E 217145          10      LD  HL,ROM_LOAD
0001A1 41A1 2273FE          16      LD  (H_BINS+2),HL
0001A4 41A4 218C46          10      LD  HL,ROM_RUN
0001A7 41A7 2278FE          16      LD  (H_BINL+2),HL
0001AA 41AA 219946          10      LD  HL,ROM_FILES
0001AD 41AD 227DFE          16      LD  (H_FILE+2),HL
0001B0 41B0 21214D          10      LD  HL,ROM_BDOS
0001B3 41B3 2233F3          16      LD  (H_BDOS+2),HL
0001B6 41B6 217B43          10      LD  HL,ROM_STKE
0001B9 41B9 22DCFE          16      LD  (H_STKE+2),HL
0001BC 41BC 214A4B          10      LD  HL,DISKIO
0001BF 41BF 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001C2 41C2 3E                      DB  03EH
0001C3 41C3 C9              10      RET
0001C4 41C4 327FFE          13      LD  (H_FILE+4),A
0001C7 41C7 3275FE          13      LD  (H_BINS+4),A
0001CA 41CA 327AFE          13      LD  (H_BINL+4),A
0001CD 41CD 3235F3          13      LD  (H_BDOS+4),A
0001D0 41D0 32DEFE          13      LD  (H_STKE+4),A
0001D3 41D3 32ABFF          13      LD  (H_PHYD+4),A
                                
                                #if exists USE_NORMAL_32K_ROM
                                #else
                                    XOR A
                                    LD  (BANK1_SEL),A
                                    LD  A,(BANK1_ADR)
                                    CP  'A'
                                    JR  NZ,NOT_8K_BANK
                                    LD  A,DISK_BANK
                                    LD  (BANK1_SEL),A
                                #endif
0001D6 41D6 CD3801          17      CALL    RSLREG      ;read primary slot #
0001D9 41D9 07               4      RLCA
0001DA 41DA 07               4      RLCA
0001DB 41DB F5              11      PUSH    AF
0001DC 41DC CD2A42          17      CALL    GTSL2_
0001DF 41DF 3244F3          13      LD  (RAMAD3),A
0001E2 41E2 F1              10      POP AF  
0001E3 41E3 CD2A42          17      CALL    GTSL2_
0001E6 41E6 3243F3          13      LD  (RAMAD2),A
       41E9                     RAMCHK2:
0001E9 41E9 3A44F3          13      LD  A,(RAMAD3)
0001EC 41EC 2640             7      LD  H,040H
0001EE 41EE CD4142          17      CALL    CHK_RAM
0001F1 41F1 3242F3          13      LD  (RAMAD1),A
       41F4                     RAMCHK1:
0001F4 41F4 3A44F3          13      LD  A,(RAMAD3)
0001F7 41F7 2600             7      LD  H,00H
0001F9 41F9 CD4142          17      CALL    CHK_RAM
0001FC 41FC 3241F3          13      LD  (RAMAD0),A
       41FF                     RAMCHK0:
0001FF 41FF 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
000202 4202 010F00          10      LD  BC,0000FH       ;切り上げ
000205 4205 09              11      ADD HL,BC
000206 4206 7D               4      LD  A,L
                                
000207 4207 0604             7      LD  B,4
       4209                     B_DRIVE1:
000209 4209 CB3C             8      SRL H
00020B 420B 1F               4      RRA
00020C 420C 10FB            13      DJNZ    B_DRIVE1
                                
00020E 420E C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000210 4210 3241F1          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
000213 4213 C9              10      RET
                                
       4214                     NOT_8K_BANK:
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K等)
000214 4214 21C943          10      LD  HL,MSG_ERROR_ROM_MODE
000217 4217 CD5443          17      CALL    MSX
00021A 421A FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00021E 421E DD219F00        14      LD  IX,CHGET
000222 4222 C31C00          10      JP  _CALSLT
                                
       4225                     GTSL1_:             ;自分のいるスロットを知る
000225 4225 CD3801          17      CALL    RSLREG      ;read primary slot #
000228 4228 0F               4      RRCA
000229 4229 0F               4      RRCA
       422A                     GTSL2_:
00022A 422A E603             7      AND 3       ;[A]=000000PP
00022C 422C 5F               4      LD  E,A     ;[E]=000000PP
00022D 422D 21C1FC          10      LD  HL,EXPTBL
000230 4230 85               4      ADD A,L     ;桁上りは無い
000231 4231 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000232 4232 7B               4      LD  A,E     ;[A]=000000PP
000233 4233 CB7E            13      BIT 7,(HL)
000235 4235 C8              11      RET Z
000236 4236 7D               4      LD  A,L     ;point to SLTTBL entry
000237 4237 C604             7      ADD A,4     ;桁上りは無い
000239 4239 6F               4      LD  L,A
00023A 423A 7E               7      LD  A,(HL)      ;get currently expansion slot register
00023B 423B E60C             7      AND 00CH        ;[A] = 0000SS00
00023D 423D B3               4      OR  E       ;[A] = 0000SSPP
00023E 423E F680             7      OR  080H        ;[A] = 1000SSPP
000240 4240 C9              10      RET
       4241                     GTSL1_E:
                                
       4241                     CHK_RAM:
000241 4241 E5              11      PUSH    HL
000242 4242 CD9642          17      CALL    CHK_RAM0
000245 4245 E1              10      POP HL
000246 4246 C8              11      RET Z
000247 4247 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
00024A 424A E680             7      AND 080H
00024C 424C CD6D42          17      CALL    CHK_RAM_SLT
00024F 424F C8              11      RET Z
000250 4250 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000253 4253 E680             7      AND 080H
000255 4255 C601             7      ADD A,1
000257 4257 CD6D42          17      CALL    CHK_RAM_SLT
00025A 425A C8              11      RET Z
00025B 425B 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00025E 425E E680             7      AND 080H
000260 4260 C602             7      ADD A,2
000262 4262 CD6D42          17      CALL    CHK_RAM_SLT
000265 4265 C8              11      RET Z
000266 4266 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000269 4269 E680             7      AND 080H
00026B 426B C603             7      ADD A,3
       426D                     CHK_RAM_SLT:
00026D 426D E5              11      PUSH    HL
00026E 426E CD9642          17      CALL    CHK_RAM0        ;スロット#X or X-0
000271 4271 E1              10      POP HL
000272 4272 C8              11      RET Z
000273 4273 CB79             8      BIT 7,C
000275 4275 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000277 4277 79               4      LD  A,C
000278 4278 C604             7      ADD A,4         ;スロット#X-1
00027A 427A E5              11      PUSH    HL
00027B 427B CD9642          17      CALL    CHK_RAM0
00027E 427E E1              10      POP HL
00027F 427F C8              11      RET Z
000280 4280 79               4      LD  A,C
000281 4281 C604             7      ADD A,4         ;スロット#X-2
000283 4283 E5              11      PUSH    HL
000284 4284 CD9642          17      CALL    CHK_RAM0
000287 4287 E1              10      POP HL
000288 4288 C8              11      RET Z
000289 4289 79               4      LD  A,C
00028A 428A C604             7      ADD A,4         ;スロット#X-3
00028C 428C E5              11      PUSH    HL
00028D 428D CD9642          17      CALL    CHK_RAM0
000290 4290 E1              10      POP HL
       4291                     CHK_RAM_E:
000291 4291 AF               4      XOR A
000292 4292 3C               4      INC A           ;ZF=0にする
000293 4293 3E00             7      LD  A,0
000295 4295 C9              10      RET
                                
       4296                     CHK_RAM0:
000296 4296 4F               4      LD  C,A
000297 4297 3AFCF0          13      LD  A,(ROM_SLT)
00029A 429A B9               4      CP  C
00029B 429B 28F4            12      JR  Z,CHK_RAM_E
00029D 429D 2E00             7      LD  L,0
       429F                     CHK_RAM1:
00029F 429F 79               4      LD  A,C
0002A0 42A0 DD210C00        14      LD  IX,_RDSLT
0002A4 42A4 CDD142          17      CALL    CALSLT_R
0002A7 42A7 C6E5             7      ADD A,0E5H
0002A9 42A9 47               4      LD  B,A
0002AA 42AA 5F               4      LD  E,A
0002AB 42AB 79               4      LD  A,C
0002AC 42AC DD211400        14      LD  IX,_WRSLT
0002B0 42B0 CDD142          17      CALL    CALSLT_R
0002B3 42B3 79               4      LD  A,C
0002B4 42B4 DD210C00        14      LD  IX,_RDSLT
0002B8 42B8 CDD142          17      CALL    CALSLT_R
0002BB 42BB B8               4      CP  B
0002BC 42BC C0              11      RET NZ
0002BD 42BD D6E5             7      SUB 0E5H
0002BF 42BF 79               4      LD  A,C
0002C0 42C0 5F               4      LD  E,A
0002C1 42C1 DD211400        14      LD  IX,_WRSLT
0002C5 42C5 CDD142          17      CALL    CALSLT_R
0002C8 42C8 24               4      INC H
0002C9 42C9 7D               4      LD  A,L
0002CA 42CA C604             7      ADD A,4
0002CC 42CC 6F               4      LD  L,A
0002CD 42CD 20D0            12      JR  NZ,CHK_RAM1
0002CF 42CF 79               4      LD  A,C     ;ZF=1のハズ
0002D0 42D0 C9              10      RET
                                
       42D1                     CALSLT_R:
0002D1 42D1 C5              11      PUSH    BC
0002D2 42D2 E5              11      PUSH    HL
0002D3 42D3 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0002D7 42D7 CD1C00          17      CALL    _CALSLT
0002DA 42DA E1              10      POP HL
0002DB 42DB C1              10      POP BC
0002DC 42DC C9              10      RET
                                
       42DD                     AT_ISC:
0002DD F0E9                         ORG ISC,AT_ISC-RUN
       F0E9                     REPLACE_COMMAND:
0002DD F0E9 FEB7             7      CP  0B7H            ;FILES
0002DF F0EB CC7BFE          17      CALL    Z,H_FILE
0002E2 F0EE FEB5             7      CP  0B5H            ;LOAD
0002E4 F0F0 CA71FE          10      JP  Z,H_BINS
0002E7 F0F3 FE8A             7      CP  08AH            ;RUN
0002E9 F0F5 CA76FE          10      JP  Z,H_BINL
0002EC F0F8 FECF             7      CP  0CFH            ;BLOAD
0002EE F0FA C0              11      RET NZ
       F0FB                     FIX_BLOAD:
0002EF F0FB F7              12      RST 30H
       F0FC                     ROM_SLT:
0002F0 F0FC 00                      DB  0
0002F1 F0FD CE45                    DW  ROM_BLOAD
0002F3 F0FF F5              11      PUSH    AF
0002F4 F100 E5              11      PUSH    HL
0002F5 F101 CD0AF1          17      CALL    BLOAD_RET
       F102                     SWC_BLOAD   EQU $-2
0002F8 F104 E1              10      POP HL
0002F9 F105 F1              10      POP AF
0002FA F106 FECF             7      CP  0CFH            ;BLOAD
       F108                     SWC_BLOAD_M:
0002FC F108 28DF            12      JR  Z,REPLACE_COMMAND
       F10A                     BLOAD_RET:
0002FE F10A C9              10      RET
       F10B                     ROMUSE1:
0002FF F10B 3AFCF0          13      LD  A,(ROM_SLT)
000302 F10E 1803            12      JR  ROMUSE2
       F110                     RAMUSE1:
000304 F110 3A42F3          13      LD  A,(RAMAD1)
       F113                     ROMUSE2:
000307 F113 DD212400        14      LD  IX,_ENASLT
00030B F117 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00030F F11B C31C00          10      JP  _CALSLT
                                
       F11E                     _RESULT:
000312 F11E 00                      DB  0
       F11F                     _BANK:
000313 F11F 00                      DB  0
       F120                     CLSZ:               ;クラスタサイズ
000314 F120 0004                    DW  1024
       F121                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F122                     SECSZ:              ;セクタサイズ
000316 F122 0002                    DW  512
       F123                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F124                     RR_LOW:
000318 F124 0000                    DW  0
       F125                     RR_MID  EQU $-1
       F126                     RR_HIGH:
00031A F126 0000                    DW  0
       F128                     _CLPS:
00031C F128 0000                    DW  0
       F12A                     _LEFT:
00031E F12A 0000                    DW  0
       F12C                     _DTPS:
000320 F12C 0000                    DW  0
       F12E                     _DTA:
000322 F12E 0000                    DW  0
                                #if exists USE_RAM_BLOAD_S
                                #else
       F130                     FLG_LDIR:
000324 F130 00                      DB  0
                                #endif
                                ;   BDOS
000325 F131 F7              12      RST 30H
000326 F132 00                      DB  0
000327 F133 214D                    DW  ROM_BDOS
000329 F135 C9              10      RET 
       F136                     _FCB:
00032A F136 0000                    DW  0
       F138                     _BUF:
00032C F138 00                      DB  0
       F139                     _BUF_ST:
00032D F139 0000                    DW  0
       F13B                     _BUF_EN:
00032F F13B 0000                    DW  0
       F13D                     _BUF_EX:
000331 F13D 0000                    DW  0
                                
       F13F                     DTAX:
000333 F13F 0000                    DW  0
       F141                     B_DRIVE:
000335 F141 00                      DB  0
       F142                     _DVSW:
000336 F142 00                      DB  0
       F143                     FCBX:
000337 F143 0000                    DW  0
       F145                     LEFTX:
000339 F145 0000                    DW  0
       F147                     PARAM0:
00033B F147 0000                    DW  0
       F149                     PARAM1:
00033D F149 0000                    DW  0
       F14B                     FDRV:
00033F F14B 00                      DB  0
       F14C                     FNAME:
000340 F14C                         DS  8+3
                                
       F157                     BASSTK:
00034B F157 0000                    DW  0
       F159                     _HL:
00034D F159 0000                    DW  0
       F15B                     _SP:
00034F F15B 0000                    DW  0
                                
       F15D                     ISC_E:
000351 4351                         ORG $$+RUN          ;$DEPHASE
                                
       4351                     MSX1:
000351 4351 CD3A4D          17      CALL    MSGA1
       4354                     MSX:
000354 4354 7E               7      LD  A,(HL)
000355 4355 23               6      INC HL
000356 4356 B7               4      OR  A
000357 4357 20F8            12      JR  NZ,MSX1
000359 4359 C9              10      RET
                                
       435A                     PRTHX:
00035A 435A F5              11      PUSH    AF
00035B 435B 07               4      RLCA
00035C 435C 07               4      RLCA
00035D 435D 07               4      RLCA
00035E 435E 07               4      RLCA
00035F 435F CD6343          17      CALL    PRTA2
000362 4362 F1              10      POP AF
       4363                     PRTA2:
000363 4363 CD6943          17      CALL    ASC
000366 4366 C3364D          10      JP  MSG_A
                                    
       4369                     ASC:
000369 4369 E60F             7      AND $0F
00036B 436B F630             7      OR  $30
00036D 436D FE3A             7      CP  $3A
00036F 436F D8              11      RET C
000370 4370 C607             7      ADD A,7
000372 4372 C9              10      RET
                                
       4373                     MSN:
000373 4373 7E               7      LD  A,(HL)
000374 4374 23               6      INC HL
000375 4375 CD364D          17      CALL    MSG_A
000378 4378 10F9            13      DJNZ    MSN
00037A 437A C9              10      RET
                                
       437B                     ROM_STKE:
00037B 437B 3E                      DB  03EH
00037C 437C C9              10      RET
00037D 437D 32DAFE          13      LD  (H_STKE),A
000380 4380 E5              11      PUSH    HL
000381 4381 D5              11      PUSH    DE
000382 4382 C5              11      PUSH    BC
000383 4383 181D            12      JR  BASAUTO
                                
000385 4385 AF               4      XOR A
000386 4386 5F               4      LD  E,A
000387 4387 57               4      LD  D,A
000388 4388 0601             7      LD  B,1
00038A 438A 2100C0          10      LD  HL,0C000H
00038D 438D CD4A4B          17      CALL    DISKIO
                                
000390 4390 ED7357F1        20      LD  (BASSTK),SP
000394 4394 116BF3          10      LD  DE,RAMUSE
000397 4397 AF               4      XOR A
000398 4398 CD1EC0          17      CALL    0C01EH
00039B 439B 116BF3          10      LD  DE,RAMUSE
00039E 439E 37               4      SCF
00039F 439F CD1EC0          17      CALL    0C01EH
       43A2                     BASAUTO:
0003A2 43A2 21E443          10      LD  HL,AUTOEXEC
0003A5 43A5 114BF1          10      LD  DE,FDRV
0003A8 43A8 010C00          10      LD  BC,1+8+3
0003AB 43AB EDB0                    LDIR
0003AD 43AD CDF748          17      CALL    ROM_OPEN
0003B0 43B0 3813            12      JR  C,RSTKEE
0003B2 43B2 21F043          10      LD  HL,RUN_AUTOEXEC
0003B5 43B5 11F0FB          10      LD  DE,KEYBUF
0003B8 43B8 ED53FAF3        20      LD  (GETPNT),DE
0003BC 43BC 011300          10      LD  BC,RUN_AUTOEXEC_E-RUN_AUTOEXEC
0003BF 43BF EDB0                    LDIR
0003C1 43C1 ED53F8F3        20      LD  (PUTPNT),DE
       43C5                     RSTKEE:
0003C5 43C5 C1              10      POP BC
0003C6 43C6 D1              10      POP DE
0003C7 43C7 E1              10      POP HL
0003C8 43C8 C9              10      RET
                                
       43C9                     MSG_ERROR_ROM_MODE:
0003C9 43C9 41534349492D384B        DB  "ASCII-8K/Konami-8K only!",13,10
            2F4B6F6E616D692D    
            384B206F6E6C7921    
            0D0A                
       43E3                     NULL:
0003E3 43E3 00                      DB  0
                                
       43E4                     AUTOEXEC:
0003E4 43E4 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       43F0                     RUN_AUTOEXEC:
0003F0 43F0 52554E2022415554        DB  'RUN "AUTOEXEC.BAS"',00DH
            4F455845432E4241    
            53220D              
                                ;   DB  'LOAD "AUTOEXEC.BAS"',00DH  ;テスト用
       4403                     RUN_AUTOEXEC_E:
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       4403                     ROM_LDIR:
                                #if exists USE_RAM_BLOAD_S
                                #else
000403 4403 3A30F1          13      LD  A,(FLG_LDIR)
000406 4406 B7               4      OR  A
000407 4407 2062            12      JR  NZ,ROM_LDIRVM
                                #endif
000409 4409 CB7A             8      BIT 7,D
00040B 440B CA9344          10      JP  Z,ROM_LDIRSLT
                                
                                #if exists USE_NORMAL_32K_ROM
00040E 440E ED735BF1        20      LD  (_SP),SP
000412 4412 3121FB          10      LD  SP,DRVTBL
       4415                     LDIR1:
000415 4415 78               4      LD  A,B
000416 4416 B1               4      OR  C
000417 4417 2841            12      JR  Z,LDIRE
                                
000419 4419 C5              11      PUSH    BC
00041A 441A D5              11      PUSH    DE
00041B 441B E5              11      PUSH    HL
00041C 441C 3AFCF0          13      LD  A,(ROM_SLT)
00041F 441F 2680             7      LD  H,080H
000421 4421 CD2400          17      CALL    _ENASLT
000424 4424 E1              10      POP HL
000425 4425 D1              10      POP DE
000426 4426 C1              10      POP BC
       4427                     LDIR2:
000427 4427 7A               4      LD  A,D
000428 4428 FEC0             7      CP  0C0H
00042A 442A 302C            12      JR  NC,LDIR4
                                
00042C 442C C5              11      PUSH    BC
00042D 442D D5              11      PUSH    DE
00042E 442E 115EF5          10      LD  DE,BUF
                                
000431 4431 78               4      LD  A,B
000432 4432 B7               4      OR  A
000433 4433 2803            12      JR  Z,LDIR3
000435 4435 010001          10      LD  BC,00100H
       4438                     LDIR3:
000438 4438 C5              11      PUSH    BC
000439 4439 EDB0                    LDIR
00043B 443B 2259F1          16      LD  (_HL),HL
                                
00043E 443E 3A43F3          13      LD  A,(RAMAD2)
000441 4441 2680             7      LD  H,080H
000443 4443 CD2400          17      CALL    _ENASLT
                                
000446 4446 215EF5          10      LD  HL,BUF
000449 4449 C1              10      POP BC
00044A 444A D1              10      POP DE
00044B 444B EDB0                    LDIR
                                
00044D 444D 2A59F1          16      LD  HL,(_HL)
000450 4450 C1              10      POP BC
000451 4451 78               4      LD  A,B
000452 4452 B7               4      OR  A
000453 4453 2805            12      JR  Z,LDIRE
000455 4455 05               4      DEC B
000456 4456 18BD            12      JR  LDIR1
       4458                     LDIR4:
                                #endif
000458 4458 EDB0                    LDIR
                                
                                #if exists USE_NORMAL_32K_ROM
       445A                     LDIRE:
00045A 445A D5              11      PUSH    DE
00045B 445B E5              11      PUSH    HL
00045C 445C 3A43F3          13      LD  A,(RAMAD2)
00045F 445F 2680             7      LD  H,080H
000461 4461 CD2400          17      CALL    _ENASLT
000464 4464 E1              10      POP HL
000465 4465 D1              10      POP DE
000466 4466 ED7B5BF1        20      LD  SP,(_SP)
                                #endif
00046A 446A C9              10      RET
                                
       446B                     ROM_LDIRVM:
                                #if exists USE_NORMAL_32K_ROM
00046B 446B C5              11      PUSH    BC
00046C 446C D5              11      PUSH    DE
00046D 446D E5              11      PUSH    HL
00046E 446E 3AFCF0          13      LD  A,(ROM_SLT)
000471 4471 2680             7      LD  H,080H
000473 4473 CD2400          17      CALL    _ENASLT
000476 4476 E1              10      POP HL
000477 4477 D1              10      POP DE
000478 4478 C1              10      POP BC
                                #endif
000479 4479 C5              11      PUSH    BC
00047A 447A D5              11      PUSH    DE
00047B 447B FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00047F 447F DD215C00        14      LD  IX,LDIRVM
000483 4483 CD1C00          17      CALL    _CALSLT
                                #if exists USE_NORMAL_32K_ROM
000486 4486 2680             7      LD  H,080H
000488 4488 3A43F3          13      LD  A,(RAMAD2)
00048B 448B CD2400          17      CALL    _ENASLT
                                #endif
00048E 448E E1              10      POP HL
00048F 448F C1              10      POP BC
000490 4490 09              11      ADD HL,BC
000491 4491 EB               4      EX  DE,HL
000492 4492 C9              10      RET
                                
       4493                     ROM_LDIRSLT:
000493 4493 EB               4      EX  DE,HL
       4494                     RLDIRSLT1:
000494 4494 1A               7      LD  A,(DE)
000495 4495 13               6      INC DE
000496 4496 C5              11      PUSH    BC
000497 4497 D5              11      PUSH    DE
000498 4498 E5              11      PUSH    HL
000499 4499 5F               4      LD  E,A
00049A 449A 3A42F3          13      LD  A,(RAMAD1)
00049D 449D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0004A1 44A1 DD211400        14      LD  IX,_WRSLT
0004A5 44A5 CD1C00          17      CALL    _CALSLT
0004A8 44A8 E1              10      POP HL
0004A9 44A9 D1              10      POP DE
0004AA 44AA C1              10      POP BC
0004AB 44AB EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0004AD 44AD EA9444          10      JP  PE,RLDIRSLT1
0004B0 44B0 EB               4      EX  DE,HL
0004B1 44B1 C9              10      RET
                                
       44B2                     END_OF_LINE:
0004B2 44B2 215EF5          10      LD  HL,BUF
       44B5                     EOL1:
0004B5 44B5 7E               7      LD  A,(HL)
0004B6 44B6 C8              11      RET Z
0004B7 44B7 FE0D             7      CP  00DH
0004B9 44B9 2807            12      JR  Z,EOLE
0004BB 44BB FE0A             7      CP  00AH
0004BD 44BD 2803            12      JR  Z,EOLE
0004BF 44BF 23               6      INC HL
0004C0 44C0 18F3            12      JR  EOL1
       44C2                     EOLE:
0004C2 44C2 3600            10      LD  (HL),0
0004C4 44C4 23               6      INC HL
0004C5 44C5 7E               7      LD  A,(HL)
0004C6 44C6 FE0A             7      CP  00AH
0004C8 44C8 C0              11      RET NZ
0004C9 44C9 23               6      INC HL
0004CA 44CA C9              10      RET
                                
       44CB                     ROM_LOAD_ASCII:
0004CB 44CB 210000          10      LD  HL,0
0004CE 44CE 2239F1          16      LD  (_BUF_ST),HL    ;読み出し位置
0004D1 44D1 2A76F6          16      LD  HL,(TXTTAB)
0004D4 44D4 223BF1          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
0004D7 44D7 215EF5          10      LD  HL,BUF
0004DA 44DA 222EF1          16      LD  (_DTA),HL
       44DD                     RLOAD_A1:
0004DD 44DD 2A39F1          16      LD  HL,(_BUF_ST)
0004E0 44E0 2224F1          16      LD  (RR_LOW),HL
0004E3 44E3 210201          10      LD  HL,258
0004E6 44E6 CD1747          17      CALL    ROM_READ
0004E9 44E9 7C               4      LD  A,H
0004EA 44EA B5               4      OR  L
0004EB 44EB 2877            12      JR  Z,RLOAD_AEND
0004ED 44ED 015EF5          10      LD  BC,BUF
0004F0 44F0 09              11      ADD HL,BC
0004F1 44F1 3600            10      LD  (HL),0
0004F3 44F3 CDB244          17      CALL    END_OF_LINE
0004F6 44F6 015EF5          10      LD  BC,BUF
0004F9 44F9 A7               4      AND A
0004FA 44FA ED42            15      SBC HL,BC
0004FC 44FC 2810            12      JR  Z,RLOAD_A2
0004FE 44FE 4D               4      LD  C,L
0004FF 44FF 44               4      LD  B,H
000500 4500 ED5B39F1        20      LD  DE,(_BUF_ST)
000504 4504 19              11      ADD HL,DE
000505 4505 2239F1          16      LD  (_BUF_ST),HL
000508 4508 3A5EF5          13      LD  A,(BUF)
00050B 450B B7               4      OR  A
00050C 450C 28CF            12      JR  Z,RLOAD_A1
       450E                     RLOAD_A2:
00050E 450E 115EF5          10      LD  DE,BUF
000511 4511 CD8E48          17      CALL    SPCUTEX
000514 4514 1A               7      LD  A,(DE)
000515 4515 B7               4      OR  A
000516 4516 284C            12      JR  Z,RLOAD_AEND
000518 4518 CDA048          17      CALL    GETNUM
00051B 451B 7C               4      LD  A,H
00051C 451C B5               4      OR  L
00051D 451D CABB45          10      JP  Z,ERROR_DIRECT_IN_FILE
000520 4520 DD2A3BF1        20      LD  IX,(_BUF_EN)
000524 4524 DD7502          19      LD  (IX+2),L
000527 4527 DD7403          19      LD  (IX+3),H
                                
00052A 452A CD8748          17      CALL    SPCUT
00052D 452D EB               4      EX  DE,HL
00052E 452E DDE5            15      PUSH    IX
000530 4530 DD21B242        14      LD  IX,CRUNCH
000534 4534 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000538 4538 CD1C00          17      CALL    _CALSLT
00053B 453B DDE1            14      POP IX
00053D 453D EB               4      EX  DE,HL
00053E 453E 111FF4          10      LD  DE,KBUF
000541 4541 37               4      SCF
000542 4542 ED52            15      SBC HL,DE
000544 4544 2875            12      JR  Z,ERROR_DIRECT_IN_FILE
000546 4546 3873            12      JR  C,ERROR_DIRECT_IN_FILE
000548 4548 4D               4      LD  C,L
000549 4549 44               4      LD  B,H
00054A 454A 2A3BF1          16      LD  HL,(_BUF_EN)
00054D 454D 110400          10      LD  DE,4
000550 4550 19              11      ADD HL,DE
000551 4551 111FF4          10      LD  DE,KBUF
                                
000554 4554 EB               4      EX  DE,HL
000555 4555 EDB0                    LDIR
000557 4557 EB               4      EX  DE,HL
                                
000558 4558 DD7500          19      LD  (IX+0),L
00055B 455B DD7401          19      LD  (IX+1),H
00055E 455E 223BF1          16      LD  (_BUF_EN),HL
000561 4561 C3DD44          10      JP  RLOAD_A1
                                
       4564                     RLOAD_AEND:
000564 4564 2A3BF1          16      LD  HL,(_BUF_EN)
000567 4567 AF               4      XOR A
000568 4568 77               7      LD  (HL),A
000569 4569 23               6      INC HL
00056A 456A 77               7      LD  (HL),A
00056B 456B 23               6      INC HL
00056C 456C 223BF1          16      LD  (_BUF_EN),HL
00056F 456F 1833            12      JR  RLOAD_END1
                                
       4571                     ROM_LOAD:
000571 4571 CDEC46          17      CALL    INIT_PARAM
000574 4574 CDB747          17      CALL    FILE_B
000577 4577 CDF748          17      CALL    ROM_OPEN
00057A 457A 3845            12      JR  C,ERROR_FILE_NOT_FOUND
                                
00057C 457C 2138F1          10      LD  HL,_BUF
00057F 457F 222EF1          16      LD  (_DTA),HL
000582 4582 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
000585 4585 CD1747          17      CALL    ROM_READ
000588 4588 3A38F1          13      LD  A,(_BUF)
00058B 458B 3C               4      INC A
00058C 458C C2CB44          10      JP  NZ,ROM_LOAD_ASCII
00058F 458F 2A76F6          16      LD  HL,(TXTTAB)
000592 4592 222EF1          16      LD  (_DTA),HL
000595 4595 EB               4      EX  DE,HL
000596 4596 2100FF          10      LD  HL,-256
000599 4599 39              11      ADD HL,SP
00059A 459A ED52            15      SBC HL,DE
00059C 459C CD1747          17      CALL    ROM_READ
00059F 459F ED5B2EF1        20      LD  DE,(_DTA)
0005A3 45A3 19              11      ADD HL,DE
       45A4                     RLOAD_END1:
0005A4 45A4 22C2F6          16      LD  (VARTAB),HL
0005A7 45A7 22C4F6          16      LD  (ARYTAB),HL
0005AA 45AA 22C6F6          16      LD  (STREND),HL
                                
0005AD 45AD AF               4      XOR A
0005AE 45AE 213BF1          10      LD  HL,_BUF+3
0005B1 45B1 77               7      LD  (HL),A
0005B2 45B2 2B               6      DEC HL
0005B3 45B3 77               7      LD  (HL),A
0005B4 45B4 2B               6      DEC HL
0005B5 45B5 77               7      LD  (HL),A
0005B6 45B6 2B               6      DEC HL
0005B7 45B7 3E8F             7      LD  A,08FH          ;REM
0005B9 45B9 77               7      LD  (HL),A
0005BA 45BA C9              10      RET
                                
       45BB                     ERROR_DIRECT_IN_FILE:
0005BB 45BB 1E39             7      LD  E,57            ;Direct statement in file
0005BD 45BD 01                      DB  1           ;LD BC,
       45BE                     ERROR_FILE_NOT_OPEN:
0005BE 45BE 1E3B             7      LD  E,59            ;File not OPEN
0005C0 45C0 01                      DB  1           ;LD BC,
       45C1                     ERROR_FILE_NOT_FOUND:
0005C1 45C1 1E35             7      LD  E,53            ;File not found
       45C3                     ERROR:
0005C3 45C3 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0005C7 45C7 DD216F40        14      LD  IX,ERRHAND
0005CB 45CB C31C00          10      JP  _CALSLT
                                
       45CE                     ROM_BLOAD:
0005CE 45CE CDEC46          17      CALL    INIT_PARAM
0005D1 45D1 CDB747          17      CALL    FILE_B
0005D4 45D4 CDF748          17      CALL    ROM_OPEN
0005D7 45D7 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
0005D9 45D9 2138F1          10      LD  HL,_BUF
0005DC 45DC 222EF1          16      LD  (_DTA),HL
0005DF 45DF 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
0005E2 45E2 CD1747          17      CALL    ROM_READ
0005E5 45E5 3A38F1          13      LD  A,(_BUF)
0005E8 45E8 FEFE             7      CP  0FEH
0005EA 45EA 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
0005EC 45EC 210AF1          10      LD  HL,BLOAD_RET
0005EF 45EF 2202F1          16      LD  (SWC_BLOAD),HL
                                
0005F2 45F2 2A49F1          16      LD  HL,(PARAM1)
0005F5 45F5 7E               7      LD  A,(HL)
0005F6 45F6 FE2C             7      CP  ','
0005F8 45F8 2048            12      JR  NZ,RBREAD_MEM
0005FA 45FA 23               6      INC HL
0005FB 45FB 7E               7      LD  A,(HL)
0005FC 45FC CDE148          17      CALL    CAP
0005FF 45FF 32BEFC          13      LD  (RUNBNF),A
       4602                     RBOS1:
000602 4602 7E               7      LD  A,(HL)
000603 4603 23               6      INC HL
000604 4604 B7               4      OR  A
000605 4605 282F            12      JR  Z,RBREAD_OSE
000607 4607 FE3A             7      CP  ':'
000609 4609 282B            12      JR  Z,RBREAD_OSE
00060B 460B FE2C             7      CP  ','     ;次のパラメータを探す
00060D 460D 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
00060F 460F 2249F1          16      LD  (PARAM1),HL
000612 4612 7E               7      LD  A,(HL)
000613 4613 B7               4      OR  A
000614 4614 2820            12      JR  Z,RBREAD_OSE
000616 4616 DD21644C        14      LD  IX,FRMEVL
00061A 461A FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00061E 461E CD1C00          17      CALL    _CALSLT
000621 4621 2249F1          16      LD  (PARAM1),HL
000624 4624 3A63F6          13      LD  A,(VALTYP)
000627 4627 FE02             7      CP  2
000629 4629 200B            12      JR  NZ,RBREAD_OSE
00062B 462B 2A39F1          16      LD  HL,(_BUF_ST)
00062E 462E ED5BF8F7        20      LD  DE,(DACDAT)
000632 4632 19              11      ADD HL,DE
000633 4633 2239F1          16      LD  (_BUF_ST),HL
       4636                     RBREAD_OSE:
000636 4636 3ABEFC          13      LD  A,(RUNBNF)
000639 4639 FE53             7      CP  'S'
                                #if exists USE_RAM_BLOAD_S
                                    JR  Z,ROM_BLOAD_SCREEN
                                #else
00063B 463B 2005            12      JR  NZ,RBREAD_MEM
00063D 463D 3E01             7      LD  A,1
00063F 463F 3230F1          13      LD  (FLG_LDIR),A
                                #endif
       4642                     RBREAD_MEM:
000642 4642 2A39F1          16      LD  HL,(_BUF_ST)
000645 4645 22BFFC          16      LD  (SAVENT),HL
000648 4648 222EF1          16      LD  (_DTA),HL
00064B 464B 21FFFF          10      LD  HL,0FFFFH
00064E 464E CD1747          17      CALL    ROM_READ
000651 4651 3ABEFC          13      LD  A,(RUNBNF)
000654 4654 FE52             7      CP  'R'
000656 4656 2006            12      JR  NZ,RBREAD1
000658 4658 2A3DF1          16      LD  HL,(_BUF_EX)
00065B 465B 2202F1          16      LD  (SWC_BLOAD),HL
       465E                     RBREAD1:
       465E                     ROM_NEXT:
00065E 465E 2A49F1          16      LD  HL,(PARAM1)
000661 4661 7E               7      LD  A,(HL)
000662 4662 2B               6      DEC HL
000663 4663 B7               4      OR  A
000664 4664 2805            12      JR  Z,RN1
000666 4666 FE3A             7      CP  ':'
000668 4668 2801            12      JR  Z,RN1
00066A 466A 23               6      INC HL
       466B                     RN1:
00066B 466B 5D               4      LD  E,L
00066C 466C 54               4      LD  D,H
                                
00066D 466D CDB748          17      CALL    SEARCH_END
000670 4670 B7               4      OR  A
000671 4671 2815            12      JR  Z,REM
                                                    ;マルチステートメントの処理
000673 4673 7E               7      LD  A,(HL)
                                
000674 4674 FEB5             7      CP  0B5H            ;LOAD
000676 4676 CA7145          10      JP  Z,ROM_LOAD
000679 4679 FE8A             7      CP  08AH            ;RUN
00067B 467B 280F            12      JR  Z,ROM_RUN
00067D 467D FEB7             7      CP  0B7H            ;FILES
00067F 467F 2818            12      JR  Z,ROM_FILES
000681 4681 3E28             7      LD  A,028H          ;JR Z,
000683 4683 3208F1          13      LD  (SWC_BLOAD_M),A
000686 4686 7E               7      LD  A,(HL)
000687 4687 C9              10      RET
                                
       4688                     REM:
000688 4688 EB               4      EX  DE,HL
000689 4689 3E8F             7      LD  A,08FH          ;REM
00068B 468B C9              10      RET
                                
                                #if exists USE_RAM_BLOAD_S
                                ROM_BLOAD_SCREEN:
                                    LD  HL,(STREND)
                                    LD  (_DTA),HL
                                    EX  DE,HL
                                    LD  HL,-512
                                    ADD HL,SP
                                    XOR A
                                    SBC HL,DE
                                    JR  NC,RBS0
                                    LD  HL,BUF
                                    LD  (_DTA),HL
                                    LD  L,A ;0
                                    LD  H,A ;0
                                RBS0:
                                    INC H
                                    LD  (_BUF_EN),HL
                                RBS1:
                                    LD  HL,(_BUF_EN)
                                    CALL    ROM_READ
                                    LD  A,H
                                    OR  L
                                    JR  Z,ROM_NEXT
                                
                                    PUSH    HL
                                    LD  C,L
                                    LD  B,H
                                    LD  HL,(_DTA)   ;転送元
                                    LD  DE,(_BUF_ST)    ;転送先
                                
                                    LD  IY,(EXPTBL-1)   ;メインROMスロット
                                    LD  IX,LDIRVM
                                    CALL    _CALSLT
                                
                                    LD  HL,(_BUF_ST)
                                    POP DE
                                    ADD HL,DE
                                    LD  (_BUF_ST),HL
                                    JR  RBS1
                                #endif
                                
       468C                     ROM_RUN:
00068C 468C 23               6      INC HL
00068D 468D 7E               7      LD  A,(HL)
00068E 468E 2B               6      DEC HL
00068F 468F B7               4      OR  A
000690 4690 2803            12      JR  Z,ROM_RUN1
000692 4692 CD7145          17      CALL    ROM_LOAD
       4695                     ROM_RUN1:
000695 4695 3E8A             7      LD  A,08AH          ;RUN
000697 4697 77               7      LD  (HL),A
000698 4698 C9              10      RET
                                
       4699                     ROM_FILES:
000699 4699 CDEC46          17      CALL    INIT_PARAM
00069C 469C CDB747          17      CALL    FILE_B
00069F 469F CDDC4C          17      CALL    GET_DISK_BANK_FDRV
0006A2 46A2 320068          13      LD  (BANK1_SEL),A
0006A5 46A5 3A4CF1          13      LD  A,(FNAME)
0006A8 46A8 FE21             7      CP  021H
0006AA 46AA 3005            12      JR  NC,RFILES0
0006AC 46AC 060B             7      LD  B,11
0006AE 46AE CD4B48          17      CALL    FILE10
       46B1                     RFILES0:
0006B1 46B1 CD0E4B          17      CALL    GET_DIR_DAT
       46B4                     RFILES1:
0006B4 46B4 CD1349          17      CALL    FILESE
0006B7 46B7 302E            12      JR  NC,RFILES_NOT_MATCH
       46B9                     RFILES_DISP:
0006B9 46B9 E5              11      PUSH    HL
0006BA 46BA 0608             7      LD  B,8
0006BC 46BC CD7343          17      CALL    MSN
0006BF 46BF 3E2E             7      LD  A,'.'
0006C1 46C1 CD364D          17      CALL    MSG_A
0006C4 46C4 0603             7      LD  B,3
0006C6 46C6 CD7343          17      CALL    MSN
0006C9 46C9 3ADDF3          13      LD  A,(CSRX)
0006CC 46CC 47               4      LD  B,A
0006CD 46CD 3AB0F3          13      LD  A,(LINLEN)
0006D0 46D0 90               4      SUB B
0006D1 46D1 FE0C             7      CP  12
0006D3 46D3 3009            12      JR  NC,RFILES2
0006D5 46D5 3E0D             7      LD  A,00DH      ;改行
0006D7 46D7 CD364D          17      CALL    MSG_A
0006DA 46DA 3E0A             7      LD  A,00AH
0006DC 46DC 1802            12      JR  RFILES3
       46DE                     RFILES2:
0006DE 46DE 3E20             7      LD  A,020H
       46E0                     RFILES3:
0006E0 46E0 CD364D          17      CALL    MSG_A
0006E3 46E3 E1              10      POP HL
0006E4 46E4 CD2F49          17      CALL    FNEXT
       46E7                     RFILES_NOT_MATCH:
0006E7 46E7 20CB            12      JR  NZ,RFILES1
0006E9 46E9 C35E46          10      JP  ROM_NEXT
                                
       46EC                     INIT_PARAM:
0006EC 46EC 2247F1          16      LD  (PARAM0),HL
0006EF 46EF 2249F1          16      LD  (PARAM1),HL
0006F2 46F2 EB               4      EX  DE,HL
0006F3 46F3 AF               4      XOR A
                                #if exists USE_RAM_BLOAD_S
                                #else
0006F4 46F4 3230F1          13      LD  (FLG_LDIR),A
                                #endif
0006F7 46F7 32BEFC          13      LD  (RUNBNF),A
0006FA 46FA 3263F6          13      LD  (VALTYP),A
0006FD 46FD 13               6      INC DE
0006FE 46FE CD8748          17      CALL    SPCUT
000701 4701 1A               7      LD  A,(DE)
000702 4702 B7               4      OR  A
000703 4703 C8              11      RET Z
000704 4704 FE3A             7      CP  ':'
000706 4706 C8              11      RET Z
000707 4707 EB               4      EX  DE,HL
000708 4708 DD21644C        14      LD  IX,FRMEVL
00070C 470C FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000710 4710 CD1C00          17      CALL    _CALSLT
000713 4713 2249F1          16      LD  (PARAM1),HL
000716 4716 C9              10      RET
                                
       4717                     ROM_READ:
000717 4717 E5              11      PUSH    HL
000718 4718 D5              11      PUSH    DE
000719 4719 C5              11      PUSH    BC
00071A 471A FDE5            15      PUSH    IY
00071C 471C 2245F1          16      LD  (LEFTX),HL
00071F 471F 2A2EF1          16      LD  HL,(_DTA)
000722 4722 223FF1          16      LD  (DTAX),HL
000725 4725 2A45F1          16      LD  HL,(LEFTX)
                                
000728 4728 CD5B49          17      CALL    RBX1
00072B 472B 3870            12      JR  C,RBRERR1
00072D 472D 79               4      LD  A,C
00072E 472E EB               4      EX  DE,HL
00072F 472F ED52            15      SBC HL,DE       ;CP 0HL,CDE
000731 4731 19              11      ADD HL,DE
000732 4732 DE00             7      SBC A,000H
000734 4734 3801            12      JR  C,RBR1
000736 4736 EB               4      EX  DE,HL
       4737                     RBR1:
000737 4737 9F               4      SBC A,A
000738 4738 E601             7      AND 1
00073A 473A 321EF1          13      LD  (_RESULT),A
00073D 473D 7C               4      LD  A,H
00073E 473E B5               4      OR  L
00073F 473F CA9347          10      JP  Z,RBREND0
                                
000742 4742 222AF1          16      LD  (_LEFT),HL  ;Read record byte
000745 4745 2245F1          16      LD  (LEFTX),HL
                                
000748 4748 CD8149          17      CALL    RBX2
00074B 474B 281A            12      JR  Z,RBRB
                                                ;先頭の端数
00074D 474D CD9449          17      CALL    RBXA
000750 4750 DAA947          10      JP  C,RBRERR
000753 4753 C5              11      PUSH    BC
000754 4754 CD0344          17      CALL    ROM_LDIR
000757 4757 ED533FF1        20      LD  (DTAX),DE
00075B 475B 2A45F1          16      LD  HL,(LEFTX)
00075E 475E D1              10      POP DE
00075F 475F A7               4      AND A
000760 4760 ED52            15      SBC HL,DE
000762 4762 2245F1          16      LD  (LEFTX),HL
000765 4765 2829            12      JR  Z,RBREND
                                
       4767                     RBRB:
000767 4767 CDCD49          17      CALL    RBXB
00076A 476A 2818            12      JR  Z,RBRC
       476C                     RBRB1:
00076C 476C C5              11      PUSH    BC
00076D 476D D5              11      PUSH    DE
00076E 476E CD724A          17      CALL    CLUST
000771 4771 EB               4      EX  DE,HL
000772 4772 ED4B20F1        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000776 4776 CD0344          17      CALL    ROM_LDIR
000779 4779 EB               4      EX  DE,HL
00077A 477A D1              10      POP DE
00077B 477B C1              10      POP BC
00077C 477C CD4F4A          17      CALL    GNCL
00077F 477F DAA947          10      JP  C,RBRERR
000782 4782 10E8            13      DJNZ    RBRB1
       4784                     RBRC:
000784 4784 CDE549          17      CALL    RBXC
000787 4787 2807            12      JR  Z,RBREND
                                
000789 4789 CD724A          17      CALL    CLUST
00078C 478C EB               4      EX  DE,HL
00078D 478D CD0344          17      CALL    ROM_LDIR
       4790                     RBREND:
000790 4790 CDF149          17      CALL    RBXEND
       4793                     RBREND0:
000793 4793 FDE1            14      POP IY
000795 4795 C1              10      POP BC
000796 4796 D1              10      POP DE
000797 4797 F1              10      POP AF  ;(HL)
000798 4798 AF               4      XOR A
000799 4799 3A1EF1          13      LD  A,(_RESULT)
00079C 479C C9              10      RET
                                
       479D                     RBRERR1:
00079D 479D 3E01             7      LD  A,001H
       479F                     RBRERR2:
00079F 479F FDE1            14      POP IY
0007A1 47A1 C1              10      POP BC
0007A2 47A2 D1              10      POP DE
0007A3 47A3 E1              10      POP HL
0007A4 47A4 37               4      SCF
0007A5 47A5 210000          10      LD  HL,0
0007A8 47A8 C9              10      RET
       47A9                     RBRERR:
0007A9 47A9 3EFF             7      LD  A,0FFH
0007AB 47AB 18F2            12      JR  RBRERR2
                                
       47AD                     FILE_DD:
0007AD 47AD 3E                      DB  03EH
0007AE 47AE C9              10      RET
0007AF 47AF 3208F1          13      LD  (SWC_BLOAD_M),A
0007B2 47B2 2A47F1          16      LD  HL,(PARAM0)
0007B5 47B5 7E               7      LD  A,(HL)
0007B6 47B6 C9              10      RET
       47B7                     FILE_B:
0007B7 47B7 AF               4      XOR A
0007B8 47B8 324BF1          13      LD  (FDRV),A
0007BB 47BB 1E00             7      LD  E,0
0007BD 47BD 3A63F6          13      LD  A,(VALTYP)
0007C0 47C0 FE03             7      CP  3       ;string
0007C2 47C2 2044            12      JR  NZ,FILED
                                
0007C4 47C4 DD21D067        14      LD  IX,FRESTR
0007C8 47C8 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007CC 47CC CD1C00          17      CALL    _CALSLT
0007CF 47CF E5              11      PUSH    HL
0007D0 47D0 DDE1            14      POP IX
                                
0007D2 47D2 DD5E00          19      LD  E,(IX+0)
0007D5 47D5 DD7E01          19      LD  A,(IX+1)
0007D8 47D8 DD5602          19      LD  D,(IX+2)
0007DB 47DB DD62             9      LD  IXH,D
0007DD 47DD DD6F             9      LD  IXL,A
0007DF 47DF 7B               4      LD  A,E
0007E0 47E0 FE04             7      CP  4
0007E2 47E2 3808            12      JR  C,FILEB1
0007E4 47E4 DD7E03          19      LD  A,(IX+3)
0007E7 47E7 FE3A             7      CP  ':'
0007E9 47E9 28C2            12      JR  Z,FILE_DD
0007EB 47EB 7B               4      LD  A,E
       47EC                     FILEB1:
0007EC 47EC FE02             7      CP  2
0007EE 47EE 3818            12      JR  C,FILED
0007F0 47F0 DD7E01          19      LD  A,(IX+1)
0007F3 47F3 FE3A             7      CP  ':'
0007F5 47F5 2011            12      JR  NZ,DEVI1
0007F7 47F7 DD7E00          19      LD  A,(IX+0)        ;DRIVE
0007FA 47FA CDE148          17      CALL    CAP
0007FD 47FD D640             7      SUB '@'
0007FF 47FF DD23            10      INC IX
000801 4801 DD23            10      INC IX
000803 4803 1D               4      DEC E
000804 4804 1D               4      DEC E
000805 4805 324BF1          13      LD  (FDRV),A
       4808                     DEVI1:
                                
       4808                     FILED:
000808 4808 CD4F48          17      CALL    FILEI
00080B 480B 214CF1          10      LD  HL,FNAME
                                
00080E 480E 0608             7      LD  B,8
       4810                     FILE2:
000810 4810 CD5C48          17      CALL    CCHKF
000813 4813 C8              11      RET Z
000814 4814 FE2A             7      CP  '*'
000816 4816 282E            12      JR  Z,FILE9
000818 4818 FE2E             7      CP  '.'
00081A 481A 280C            12      JR  Z,FILE4
00081C 481C 77               7      LD  (HL),A
00081D 481D 23               6      INC HL
00081E 481E 10F0            13      DJNZ    FILE2
                                
       4820                     FILE3:
000820 4820 CD5C48          17      CALL    CCHKF
000823 4823 C8              11      RET Z
000824 4824 FE2E             7      CP  '.'
000826 4826 20F8            12      JR  NZ,FILE3
                                
       4828                     FILE4:
000828 4828 2154F1          10      LD  HL,FNAME+8
00082B 482B 0603             7      LD  B,3
                                
       482D                     FILE4L:
00082D 482D CD5C48          17      CALL    CCHKF
000830 4830 C8              11      RET Z
000831 4831 FE2E             7      CP  '.'
000833 4833 2008            12      JR  NZ,FILE12
000835 4835 324CF1          13      LD  (FNAME),A   ;Parent directory(..)
000838 4838 324DF1          13      LD  (FNAME+1),A
00083B 483B 3E20             7      LD  A,020H
       483D                     FILE12:
00083D 483D FE2A             7      CP  '*'
00083F 483F 280A            12      JR  Z,FILE10
000841 4841 77               7      LD  (HL),A
000842 4842 23               6      INC HL
000843 4843 10E8            13      DJNZ    FILE4L
000845 4845 C9              10      RET
                                
       4846                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000846 4846 CD4B48          17      CALL    FILE10
000849 4849 18D5            12      JR  FILE3
                                
       484B                     FILE10:
00084B 484B 3E3F             7      LD  A,'?'
00084D 484D 1808            12      JR  FILL_MEMORY
       484F                     FILEI:              ;名前＋拡張子をスペースで初期化
00084F 484F 3E20             7      LD  A,020H
000851 4851 01000B          10      LD  BC,11*256   ;C=0にしておく
000854 4854 214CF1          10      LD  HL,FNAME
       4857                     FILL_MEMORY:            ;HLからBバイトAで埋める
000857 4857 77               7      LD  (HL),A
000858 4858 23               6      INC HL
000859 4859 10FC            13      DJNZ    FILL_MEMORY
00085B 485B C9              10      RET
                                
       485C                     CCHKF:
00085C 485C 7B               4      LD  A,E
00085D 485D B7               4      OR  A
00085E 485E C8              11      RET Z
00085F 485F DD7E00          19      LD  A,(IX+0)
000862 4862 CD6948          17      CALL    CCHK2
000865 4865 C8              11      RET Z
000866 4866 C3CC48          10      JP  FKAN
                                
       4869                     CCHK2:
000869 4869 0C               4      INC C
00086A 486A 0D               4      DEC C
00086B 486B C0              11      RET NZ
       486C                     CCHK3:              ;ZF=1 で使えない文字
00086C 486C FE2B             7      CP  '+'
00086E 486E C8              11      RET Z
00086F 486F FE2C             7      CP  ','
000871 4871 C8              11      RET Z
000872 4872 FE2F             7      CP  '/'
000874 4874 C8              11      RET Z
000875 4875 FE3A             7      CP  ':'
000877 4877 C8              11      RET Z
000878 4878 FE3B             7      CP  ';'
00087A 487A C8              11      RET Z
00087B 487B FE3D             7      CP  '='
00087D 487D C8              11      RET Z
00087E 487E FE5C             7      CP  05CH    ;\
000880 4880 C8              11      RET Z
000881 4881 FE1F             7      CP  01FH
000883 4883 D0              11      RET NC
000884 4884 BF               4      CP  A       ;Z=1
000885 4885 C9              10      RET
                                
       4886                     SS1:
000886 4886 13               6      INC DE
       4887                     SPCUT:              ;スペースをカット
000887 4887 1A               7      LD  A,(DE)
000888 4888 FE20             7      CP  020H
00088A 488A 28FA            12      JR  Z,SS1
00088C 488C C9              10      RET
                                
       488D                     SCREOF1:
00088D 488D 13               6      INC DE
       488E                     SPCUTEX:            ;スペース改行などをカット
00088E 488E 1A               7      LD  A,(DE)
00088F 488F FE20             7      CP  020H
000891 4891 28FA            12      JR  Z,SCREOF1
000893 4893 FE0D             7      CP  00DH
000895 4895 28F6            12      JR  Z,SCREOF1
000897 4897 FE0A             7      CP  00AH
000899 4899 28F2            12      JR  Z,SCREOF1
00089B 489B FE1A             7      CP  01AH
00089D 489D 28EE            12      JR  Z,SCREOF1
00089F 489F C9              10      RET
                                
       48A0                     GETNUM:
0008A0 48A0 210000          10      LD  HL,0
       48A3                     GETNUM1:
0008A3 48A3 1A               7      LD  A,(DE)
0008A4 48A4 13               6      INC DE
0008A5 48A5 D630             7      SUB '0'
0008A7 48A7 D8              11      RET C
0008A8 48A8 FE0A             7      CP  10
0008AA 48AA D0              11      RET NC
0008AB 48AB 4D               4      LD  C,L
0008AC 48AC 44               4      LD  B,H
0008AD 48AD 29              11      ADD HL,HL   ;*2
0008AE 48AE 29              11      ADD HL,HL   ;*4
0008AF 48AF 09              11      ADD HL,BC   ;*5
0008B0 48B0 29              11      ADD HL,HL   ;*10
0008B1 48B1 4F               4      LD  C,A
0008B2 48B2 0600             7      LD  B,0
0008B4 48B4 09              11      ADD HL,BC
0008B5 48B5 18EC            12      JR  GETNUM1
                                
       48B7                     SEARCH_END:
0008B7 48B7 7E               7      LD  A,(HL)
       48B8                     SEARCH_END1:
0008B8 48B8 23               6      INC HL
0008B9 48B9 B7               4      OR  A
0008BA 48BA C8              11      RET Z
0008BB 48BB FE3A             7      CP  ':'
0008BD 48BD 20F8            12      JR  NZ,SEARCH_END
0008BF 48BF 7E               7      LD  A,(HL)
0008C0 48C0 FE3A             7      CP  ':'
0008C2 48C2 28F4            12      JR  Z,SEARCH_END1
0008C4 48C4 C9              10      RET
                                
       48C5                     FKANC:
0008C5 48C5 CB41             8      BIT 0,C
0008C7 48C7 CCEA48          17      CALL    Z,CAP2
0008CA 48CA 1803            12      JR  FKANX
       48CC                     FKAN:           ;漢字チェック
0008CC 48CC DD23            10      INC IX
0008CE 48CE 1D               4      DEC E
       48CF                     FKANX:
0008CF 48CF CB41             8      BIT 0,C
0008D1 48D1 CB81             8      RES 0,C
0008D3 48D3 C0              11      RET NZ
0008D4 48D4 FE80             7      CP  080H
0008D6 48D6 D8              11      RET C
0008D7 48D7 FEA0             7      CP  0A0H
0008D9 48D9 3803            12      JR  C,FKAN1
0008DB 48DB FEE0             7      CP  0E0H
0008DD 48DD D8              11      RET C
       48DE                     FKAN1:
0008DE 48DE 0C               4      INC C
0008DF 48DF A7               4      AND A
0008E0 48E0 C9              10      RET
                                
       48E1                     CAP:
0008E1 48E1 FE61             7      CP  'a'
0008E3 48E3 D8              11      RET C
0008E4 48E4 FE7B             7      CP  'z'+1
0008E6 48E6 D0              11      RET NC
0008E7 48E7 D620             7      SUB 020H
0008E9 48E9 C9              10      RET
       48EA                     CAP2:
0008EA 48EA CDE148          17      CALL    CAP
       48ED                     CAP3:               ;
0008ED 48ED FE05             7      CP  5
0008EF 48EF 2803            12      JR  Z,CAP4
0008F1 48F1 FE21             7      CP  021H
0008F3 48F3 C9              10      RET
       48F4                     CAP4:
0008F4 48F4 3EE5             7      LD  A,0E5H
0008F6 48F6 C9              10      RET
                                
       48F7                     ROM_OPEN:
0008F7 48F7 CDDC4C          17      CALL    GET_DISK_BANK_FDRV
                                
0008FA 48FA CD0E4B          17      CALL    GET_DIR_DAT
0008FD 48FD D5              11      PUSH    DE
0008FE 48FE CD1349          17      CALL    FILESE
000901 4901 D1              10      POP DE
000902 4902 3F               4      CCF
000903 4903 D8              11      RET C
000904 4904 2243F1          16      LD  (FCBX),HL
000907 4907 E5              11      PUSH    HL
000908 4908 210000          10      LD  HL,0
00090B 490B 2224F1          16      LD  (RR_LOW),HL
00090E 490E 2226F1          16      LD  (RR_HIGH),HL
000911 4911 E1              10      POP HL
000912 4912 C9              10      RET
                                
       4913                     FILESE:
000913 4913 7E               7      LD  A,(HL)
000914 4914 B7               4      OR  A
000915 4915 C8              11      RET Z       ;END:ZF=1 CF=0
000916 4916 FEE5             7      CP  0E5H
000918 4918 280D            12      JR  Z,FILESE1
00091A 491A 114CF1          10      LD  DE,FNAME
00091D 491D E5              11      PUSH    HL
00091E 491E CD3549          17      CALL    CPFILE
000921 4921 CC5649          17      CALL    Z,CPFILE2
000924 4924 E1              10      POP HL
000925 4925 37               4      SCF
000926 4926 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4927                     FILESE1:
000927 4927 CD2F49          17      CALL    FNEXT
00092A 492A 20E7            12      JR  NZ,FILESE
       492C                     ZF0_CF0_AFF_RET:
00092C 492C F6FF             7      OR  0FFH        ;ZF=0 CF=0
00092E 492E C9              10      RET
                                
       492F                     FNEXT:
00092F 492F 112000          10      LD  DE,020H
000932 4932 19              11      ADD HL,DE
000933 4933 0D               4      DEC C
                                #if exists USE_NORMAL_32K_ROM
                                #else
                                CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
                                    PUSH    AF
                                    BIT 7,H
                                    JR  Z,CHECK_DIR_PAGE1
                                    LD  A,H
                                    SUB 020H
                                    LD  H,A
                                    LD  A,(_BANK)
                                    INC A
                                    LD  (BANK1_SEL),A
                                    LD  (_BANK),A
                                CHECK_DIR_PAGE1:
                                    POP AF
                                #endif
000934 4934 C9              10      RET
                                
       4935                     CPFILE:
000935 4935 C5              11      PUSH    BC
000936 4936 01000B          10      LD  BC,00B00H
       4939                     CPSTR1:
000939 4939 1A               7      LD  A,(DE)
00093A 493A FE3F             7      CP  '?'     ;Wild card
00093C 493C 2812            12      JR  Z,CPSTR2
00093E 493E 7E               7      LD  A,(HL)
00093F 493F CDC548          17      CALL    FKANC
000942 4942 E5              11      PUSH    HL
000943 4943 67               4      LD  H,A
000944 4944 1A               7      LD  A,(DE)
000945 4945 CB01             4      RLC C
000947 4947 CDC548          17      CALL    FKANC
00094A 494A CB09             4      RRC C
00094C 494C BC               4      CP  H       ;CP (HL),(DE)
00094D 494D E1              10      POP HL
00094E 494E 2004            12      JR  NZ,CPSTR3
       4950                     CPSTR2:
000950 4950 13               6      INC DE
000951 4951 23               6      INC HL
000952 4952 10E5            13      DJNZ    CPSTR1
       4954                     CPSTR3:
000954 4954 C1              10      POP BC
000955 4955 C9              10      RET
                                
       4956                     CPFILE2:
                                ;   LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
                                ;   OR  0E1H
000956 4956 3EE1             7      LD  A,0E1H
000958 4958 2F               4      CPL
000959 4959 A6               7      AND (HL)
00095A 495A C9              10      RET
                                
       495B                     RBX1:
00095B 495B E5              11      PUSH    HL      ;Record byte
                                
00095C 495C ED5B24F1        20      LD  DE,(RR_LOW) ;CDE=Random record
000960 4960 3A27F1          13      LD  A,(RR_HIGH+1)
000963 4963 4F               4      LD  C,A
                                
000964 4964 CDDC4C          17      CALL    GET_DISK_BANK_FDRV
                                
000967 4967 FD2A43F1        20      LD  IY,(FCBX)
00096B 496B FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
00096E 496E FD661D          19      LD  H,(IY+01DH)
000971 4971 FD7E1E          19      LD  A,(IY+01EH)
                                
000974 4974 A7               4      AND A
000975 4975 ED52            15      SBC HL,DE
000977 4977 99               4      SBC A,C
000978 4978 D1              10      POP DE
                                
000979 4979 D8              11      RET C
00097A 497A 4F               4      LD  C,A
00097B 497B EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
00097C 497C B2               4      OR  D
00097D 497D B3               4      OR  E
00097E 497E C0              11      RET NZ
00097F 497F 37               4      SCF
000980 4980 C9              10      RET
                                
       4981                     RBX2:
000981 4981 ED4B25F1        20      LD  BC,(RR_LOW+1)
000985 4985 CD064A          17      CALL    RWXR
000988 4988 3A21F1          13      LD  A,(CLSZ_H)
00098B 498B 3D               4      DEC A
00098C 498C E5              11      PUSH    HL
00098D 498D 2A24F1          16      LD  HL,(RR_LOW)
000990 4990 A4               4      AND H
000991 4991 B5               4      OR  L
000992 4992 E1              10      POP HL
000993 4993 C9              10      RET
                                
       4994                     RBXA:
000994 4994 D5              11      PUSH    DE
000995 4995 CD724A          17      CALL    CLUST
000998 4998 ED532CF1        20      LD  (_DTPS),DE
00099C 499C D1              10      POP DE
00099D 499D CD4F4A          17      CALL    GNCL
0009A0 49A0 D8              11      RET C
0009A1 49A1 ED5328F1        20      LD  (_CLPS),DE
                                
0009A5 49A5 ED4B24F1        20      LD  BC,(RR_LOW)
0009A9 49A9 2A20F1          16      LD  HL,(CLSZ)
0009AC 49AC 7C               4      LD  A,H
0009AD 49AD 3D               4      DEC A
0009AE 49AE A0               4      AND B
0009AF 49AF 47               4      LD  B,A
0009B0 49B0 ED42            15      SBC HL,BC       ;remaining cluster
                                
0009B2 49B2 ED5B45F1        20      LD  DE,(LEFTX)
0009B6 49B6 ED52            15      SBC HL,DE       ;CP HL,DE
0009B8 49B8 19              11      ADD HL,DE
0009B9 49B9 3801            12      JR  C,RBXA1
0009BB 49BB EB               4      EX  DE,HL
       49BC                     RBXA1:
0009BC 49BC 3A1FF1          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
0009BF 49BF 320068          13      LD  (BANK1_SEL),A   ;ASCII-8K/Konami-8K共通で使える
0009C2 49C2 E5              11      PUSH    HL
0009C3 49C3 2A2CF1          16      LD  HL,(_DTPS)
0009C6 49C6 09              11      ADD HL,BC
0009C7 49C7 ED5B3FF1        20      LD  DE,(DTAX)
0009CB 49CB C1              10      POP BC
0009CC 49CC C9              10      RET
                                
       49CD                     RBXB:
0009CD 49CD 2A3FF1          16      LD  HL,(DTAX)
0009D0 49D0 ED5B28F1        20      LD  DE,(_CLPS)
0009D4 49D4 3A46F1          13      LD  A,(LEFTX+1)
0009D7 49D7 47               4      LD  B,A
0009D8 49D8 3A21F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       49DB                     RBXB1:
0009DB 49DB 1F               4      RRA     ;->CF
0009DC 49DC 3804            12      JR  C,RBXB2
0009DE 49DE CB38             8      SRL B   ;B=B/2
0009E0 49E0 18F9            12      JR  RBXB1
       49E2                     RBXB2:
0009E2 49E2 78               4      LD  A,B
0009E3 49E3 B7               4      OR  A
0009E4 49E4 C9              10      RET
                                
       49E5                     RBXC:
0009E5 49E5 ED4B45F1        20      LD  BC,(LEFTX)
0009E9 49E9 3A21F1          13      LD  A,(CLSZ_H)
0009EC 49EC 3D               4      DEC A
0009ED 49ED A0               4      AND B
0009EE 49EE 47               4      LD  B,A
0009EF 49EF B1               4      OR  C
0009F0 49F0 C9              10      RET
                                
       49F1                     RBXEND:
0009F1 49F1 ED5B2AF1        20      LD  DE,(_LEFT)
0009F5 49F5 2A24F1          16      LD  HL,(RR_LOW)
0009F8 49F8 3A27F1          13      LD  A,(RR_HIGH+1)
0009FB 49FB 19              11      ADD HL,DE
0009FC 49FC CE00             7      ADC A,0
0009FE 49FE 2224F1          16      LD  (RR_LOW),HL
000A01 4A01 3227F1          13      LD  (RR_HIGH+1),A
000A04 4A04 EB               4      EX  DE,HL       ;HL=Read byte
000A05 4A05 C9              10      RET 
                                
       4A06                     RWXR:
000A06 4A06 3A21F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4A09                     L_RWX:
000A09 4A09 1F               4      RRA     ;->CF
000A0A 4A0A 3806            12      JR  C,E_RWX
000A0C 4A0C CB38             8      SRL B   ;BC=BC/2
000A0E 4A0E CB19             8      RR  C   ;
000A10 4A10 18F7            12      JR  L_RWX
       4A12                     E_RWX:
000A12 4A12 CDDC4C          17      CALL    GET_DISK_BANK_FDRV
                                
000A15 4A15 FD2A43F1        20      LD  IY,(FCBX)
000A19 4A19 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000A1C 4A1C FD561B          19      LD  D,(IY+01BH)
       4A1F                     RWX1:
000A1F 4A1F ED5328F1        20      LD  (_CLPS),DE
000A23 4A23 7A               4      LD  A,D
000A24 4A24 B3               4      OR  E
000A25 4A25 37               4      SCF
000A26 4A26 C8              11      RET Z
                                
000A27 4A27 78               4      LD  A,B
000A28 4A28 B1               4      OR  C
000A29 4A29 C8              11      RET Z
                                
000A2A 4A2A CD4F4A          17      CALL    GNCL
000A2D 4A2D D8              11      RET C
000A2E 4A2E 0B               6      DEC BC
000A2F 4A2F CDA74A          17      CALL    ENDCL
000A32 4A32 38EB            12      JR  C,RWX1
000A34 4A34 37               4      SCF
000A35 4A35 C9              10      RET
                                
       4A36                     NCL3:
000A36 4A36 CDDC4C          17      CALL    GET_DISK_BANK_FDRV
000A39 4A39 320068          13      LD  (BANK1_SEL),A
000A3C 4A3C 6B               4      LD  L,E
000A3D 4A3D 62               4      LD  H,D
000A3E 4A3E CB3C             8      SRL H
000A40 4A40 CB1D             8      RR  L
000A42 4A42 1F               4      RRA
000A43 4A43 19              11      ADD HL,DE
000A44 4A44 010060          10      LD  BC,BANK1_ADR
000A47 4A47 09              11      ADD HL,BC
000A48 4A48 ED4B22F1        20      LD  BC,(SECSZ)
000A4C 4A4C 09              11      ADD HL,BC
000A4D 4A4D 17               4      RLA
000A4E 4A4E C9              10      RET
                                
       4A4F                     GNCL:
000A4F 4A4F 7A               4      LD  A,D
000A50 4A50 B3               4      OR  E
000A51 4A51 37               4      SCF
000A52 4A52 C8              11      RET Z
000A53 4A53 C5              11      PUSH    BC
000A54 4A54 E5              11      PUSH    HL
000A55 4A55 CD364A          17      CALL    NCL3
000A58 4A58 3809            12      JR  C,GNC1
000A5A 4A5A 5E               7      LD  E,(HL)
000A5B 4A5B 23               6      INC HL
000A5C 4A5C 7E               7      LD  A,(HL)
000A5D 4A5D E60F             7      AND 00FH
000A5F 4A5F 57               4      LD  D,A
000A60 4A60 E1              10      POP HL
000A61 4A61 C1              10      POP BC
000A62 4A62 C9              10      RET
       4A63                     GNC1:
000A63 4A63 7E               7      LD  A,(HL)
000A64 4A64 23               6      INC HL
000A65 4A65 56               7      LD  D,(HL)
000A66 4A66 0604             7      LD  B,4
       4A68                     GNC1L:
000A68 4A68 CB3A             8      SRL D
000A6A 4A6A 1F               4      RRA
000A6B 4A6B 10FB            13      DJNZ    GNC1L
                                
000A6D 4A6D 5F               4      LD  E,A
000A6E 4A6E E1              10      POP HL
000A6F 4A6F C1              10      POP BC
000A70 4A70 A7               4      AND A
000A71 4A71 C9              10      RET
                                
       4A72                     CLUST:
000A72 4A72 EB               4      EX  DE,HL
000A73 4A73 C5              11      PUSH    BC
000A74 4A74 3A21F1          13      LD  A,(CLSZ_H)
000A77 4A77 CD054D          17      CALL    MUL_AHL
                                
000A7A 4A7A CD1B4B          17      CALL    GET_DIR_POS
000A7D 4A7D 4F               4      LD  C,A
000A7E 4A7E 0600             7      LD  B,0
000A80 4A80 09              11      ADD HL,BC
                                
000A81 4A81 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000A84 4A84 0F               4      RRCA
000A85 4A85 0F               4      RRCA
000A86 4A86 0F               4      RRCA
000A87 4A87 0F               4      RRCA
000A88 4A88 4F               4      LD  C,A
                                
000A89 4A89 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000A8C 4A8C FE02             7      CP  2
000A8E 4A8E 280C            12      JR  Z,CLUST1
000A90 4A90 CB01             4      RLC C
000A92 4A92 0D               4      DEC C
000A93 4A93 3A0C60          13      LD  A,(BANK1_ADR+11+1)  ;BPB_BytsPerSec High    
000A96 4A96 FE02             7      CP  2
000A98 4A98 2002            12      JR  NZ,CLUST1
000A9A 4A9A 0D               4      DEC C
000A9B 4A9B 0D               4      DEC C
       4A9C                     CLUST1:
000A9C 4A9C 0D               4      DEC C
000A9D 4A9D 09              11      ADD HL,BC
                                
                                #if exists USE_NORMAL_32K_ROM
000A9E 4A9E 7D               4      LD  A,L
                                #else
                                    PUSH    HL
                                    ADD HL,HL   ;*2
                                    ADD HL,HL   ;*4
                                    ADD HL,HL   ;*8
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (BANK1_SEL),A
                                    LD  (_BANK),A
                                    POP HL
                                    LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
                                    AND L
                                #endif
000A9F 4A9F C660             7      ADD A,high BANK1_ADR
000AA1 4AA1 67               4      LD  H,A
000AA2 4AA2 2E00             7      LD  L,0
000AA4 4AA4 EB               4      EX  DE,HL
000AA5 4AA5 C1              10      POP BC
000AA6 4AA6 C9              10      RET
                                
       4AA7                     ENDCL:
000AA7 4AA7 7A               4      LD  A,D ;END CLUSTER
000AA8 4AA8 FE0F             7      CP  00FH    ;FAT12の最大値
000AAA 4AAA C0              11      RET NZ
000AAB 4AAB 7B               4      LD  A,E
000AAC 4AAC FEF7             7      CP  0F7H
000AAE 4AAE C9              10      RET
                                
       4AAF                     RB_READ:
000AAF 4AAF AF               4      XOR A   ;HLA = HL*128
000AB0 4AB0 CB3C             8      SRL H
000AB2 4AB2 CB1D             8      RR  L
000AB4 4AB4 1F               4      RRA
000AB5 4AB5 3224F1          13      LD  (RR_LOW),A
000AB8 4AB8 2225F1          16      LD  (RR_MID),HL
000ABB 4ABB 218000          10      LD  HL,128
                                
000ABE 4ABE CD1747          17      CALL    ROM_READ
000AC1 4AC1 C9              10      RET
                                
       4AC2                     GETSEQ:
000AC2 4AC2 FD6E20          19      LD  L,(IY+32)
000AC5 4AC5 FD660C          19      LD  H,(IY+12)
                                
000AC8 4AC8 CB25             8      SLA L
                                
000ACA 4ACA CB3C             8      SRL H
000ACC 4ACC CB1D             8      RR  L
000ACE 4ACE C9              10      RET
                                
       4ACF                     SETSEQ:
000ACF 4ACF F5              11      PUSH    AF
000AD0 4AD0 3A24F1          13      LD  A,(RR_LOW)
000AD3 4AD3 2A25F1          16      LD  HL,(RR_MID)
                                
000AD6 4AD6 CDED4A          17      CALL    SSQ1
                                
000AD9 4AD9 29              11      ADD HL,HL
000ADA 4ADA CB3D             8      SRL L
000ADC 4ADC FD7520          19      LD  (IY+32),L
000ADF 4ADF FD740C          19      LD  (IY+12),H
000AE2 4AE2 F1              10      POP AF
000AE3 4AE3 C9              10      RET
                                
       4AE4                     GETSIZE:
000AE4 4AE4 FD7E10          19      LD  A,(IY+16)
000AE7 4AE7 FD6E11          19      LD  L,(IY+17)
000AEA 4AEA FD6612          19      LD  H,(IY+18)
       4AED                     SSQ1:
000AED 4AED 87               4      ADD A,A
000AEE 4AEE ED6A            15      ADC HL,HL
000AF0 4AF0 B7               4      OR  A
000AF1 4AF1 C8              11      RET Z
000AF2 4AF2 23               6      INC HL
000AF3 4AF3 C9              10      RET
                                
       4AF4                     SET_FCB:
000AF4 4AF4 D5              11      PUSH    DE
000AF5 4AF5 FDE1            14      POP IY
000AF7 4AF7 FD7E1C          19      LD  A,(IY+28)
000AFA 4AFA FEFF             7      CP  0FFH
000AFC 4AFC 200C            12      JR  NZ,POPAF_SCF_FF_RET
000AFE 4AFE E5              11      PUSH    HL
000AFF 4AFF FD6E1A          19      LD  L,(IY+26)
000B02 4B02 FD661B          19      LD  H,(IY+27)
000B05 4B05 2228F1          16      LD  (_CLPS),HL
000B08 4B08 E1              10      POP HL
000B09 4B09 C9              10      RET
                                
       4B0A                     POPAF_SCF_FF_RET:
000B0A 4B0A F1              10      POP AF
000B0B 4B0B 37               4      SCF
000B0C 4B0C 9F               4      SBC A,A
000B0D 4B0D C9              10      RET
                                
       4B0E                     GET_DIR_DAT:
000B0E 4B0E CD1B4B          17      CALL    GET_DIR_POS
000B11 4B11 C660             7      ADD A,high BANK1_ADR
000B13 4B13 2E00             7      LD  L,0
000B15 4B15 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_NORMAL_32K_ROM
                                #else
                                    CALL    CHECK_DIR_PAGE
                                #endif
000B16 4B16 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000B19 4B19 4F               4      LD  C,A
000B1A 4B1A C9              10      RET
                                
       4B1B                     GET_DIR_POS:
000B1B 4B1B CDDC4C          17      CALL    GET_DISK_BANK_FDRV
000B1E 4B1E 320068          13      LD  (BANK1_SEL),A
000B21 4B21 321FF1          13      LD  (_BANK),A
000B24 4B24 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000B27 4B27 47               4      LD  B,A
000B28 4B28 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000B2B 4B2B 4F               4      LD  C,A
000B2C 4B2C 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4B2F                     GET_DIR_POS1:
000B2F 4B2F 81               4      ADD A,C
000B30 4B30 10FD            13      DJNZ    GET_DIR_POS1
                                
000B32 4B32 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec 
       4B36                     L_MDP:
000B36 4B36 CB18             8      RR  B   ;->CF
000B38 4B38 D8              11      RET C
000B39 4B39 87               4      ADD A,A
000B3A 4B3A 18FA            12      JR  L_MDP
                                
       4B3C                     WILDCARD:
000B3C 4B3C 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4B47                     ERROR_WRITE_PROTECTED:
000B47 4B47 3E00             7      LD  A,0     ;Write protected
000B49 4B49 C9              10      RET
       4B4A                     DISKIO:
000B4A 4B4A 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000B4C 4B4C 48               4      LD  C,B
000B4D 4B4D CDE64C          17      CALL    GET_DISK_BANK
       4B50                     SETMAP1:        
000B50 4B50 E5              11      PUSH    HL
       4B51                     DISKIO1:
000B51 4B51 C5              11      PUSH    BC      ;B=残りのセクタ数
000B52 4B52 D5              11      PUSH    DE      ;DE=セクタ番号
000B53 4B53 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
000B54 4B54 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
000B55 4B55 F5              11      PUSH    AF
000B56 4B56 3A23F1          13      LD  A,(SECSZ_H)
000B59 4B59 CD054D          17      CALL    MUL_AHL
000B5C 4B5C F1              10      POP AF
000B5D 4B5D 4D               4      LD  C,L     ;C=読み出し元
000B5E 4B5E 29              11      ADD HL,HL       ;64KB→32KB
000B5F 4B5F 29              11      ADD HL,HL       ;32KB→16KB
000B60 4B60 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
000B61 4B61 84               4      ADD A,H
000B62 4B62 320068          13      LD  (BANK1_SEL),A   ;ASCII-8K/Konami-8K共通で使える
000B65 4B65 321FF1          13      LD  (_BANK),A
000B68 4B68 79               4      LD  A,C     ;C=読み出し元
000B69 4B69 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
000B6B 4B6B C660             7      ADD A,high BANK1_ADR
000B6D 4B6D 67               4      LD  H,A
000B6E 4B6E ED4B22F1        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
000B72 4B72 69               4      LD  L,C     ;C=0
000B73 4B73 EDB0                    LDIR
000B75 4B75 EB               4      EX  DE,HL
000B76 4B76 F1              10      POP AF
000B77 4B77 D1              10      POP DE
000B78 4B78 13               6      INC DE
000B79 4B79 C1              10      POP BC
000B7A 4B7A 10D5            13      DJNZ    DISKIO1
000B7C 4B7C 41               4      LD  B,C
                                
000B7D 4B7D E1              10      POP HL
000B7E 4B7E AF               4      XOR A
000B7F 4B7F FB               4      EI
000B80 4B80 C9              10      RET
                                
       4B81                     DSKCHG:
000B81 4B81 CDBA4B          17      CALL    IS_BPB
000B84 4B84 3824            12      JR  C,NOTREADY
000B86 4B86 3A23FB          13      LD  A,(DRVTBL+2)
000B89 4B89 B7               4      OR  A
000B8A 4B8A 201A            12      JR  NZ,DSKCHG1
000B8C 4B8C 3A21FB          13      LD  A,(DRVTBL)
000B8F 4B8F FE02             7      CP  2
000B91 4B91 2013            12      JR  NZ,DSKCHG1
000B93 4B93 CDBA4B          17      CALL    IS_BPB
000B96 4B96 300E            12      JR  NC,DSKCHG1
000B98 4B98 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000B9A 4B9A 3221FB          13      LD  (DRVTBL),A
000B9D 4B9D 3223FB          13      LD  (DRVTBL+2),A
000BA0 4BA0 3A48F3          13      LD  A,(MASTERS)
000BA3 4BA3 3224FB          13      LD  (DRVTBL+3),A
       4BA6                     DSKCHG1:
000BA6 4BA6 AF               4      XOR A
000BA7 4BA7 0601             7      LD  B,1
000BA9 4BA9 C9              10      RET
       4BAA                     NOTREADY:
000BAA 4BAA 3E02             7      LD  A,2
000BAC 4BAC 37               4      SCF
000BAD 4BAD C9              10      RET
                                
       4BAE                     NO_BPB:
000BAE 4BAE E1              10      POP HL
000BAF 4BAF 23               6      INC HL
000BB0 4BB0 110A4D          10      LD  DE,DPB2DD
000BB3 4BB3 011200          10      LD  BC,DPB2DD_E-DPB2DD
000BB6 4BB6 EDB0                    LDIR
000BB8 4BB8 AF               4      XOR A
000BB9 4BB9 C9              10      RET
                                
       4BBA                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000BBA 4BBA CDE64C          17      CALL    GET_DISK_BANK
                                
000BBD 4BBD 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000BC0 4BC0 FE01             7      CP  1
000BC2 4BC2 D8              11      RET C
                                
000BC3 4BC3 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000BC6 4BC6 C6FF             7      ADD A,0FFH
000BC8 4BC8 D8              11      RET C
                                
000BC9 4BC9 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
000BCC 4BCC FE01             7      CP  1
000BCE 4BCE C8              11      RET Z
000BCF 4BCF FE02             7      CP  2
000BD1 4BD1 C8              11      RET Z
000BD2 4BD2 FE04             7      CP  4
000BD4 4BD4 C8              11      RET Z
000BD5 4BD5 37               4      SCF
000BD6 4BD6 C9              10      RET
                                
       4BD7                     GETDPB:
000BD7 4BD7 E5              11      PUSH    HL
000BD8 4BD8 CDE64C          17      CALL    GET_DISK_BANK
                                
000BDB 4BDB 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000BDE 4BDE B7               4      OR  A
000BDF 4BDF 28CD            12      JR  Z,NO_BPB
000BE1 4BE1 DDE1            14      POP IX
000BE3 4BE3 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000BE6 4BE6 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000BE9 4BE9 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000BEC 4BEC 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000BEF 4BEF DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000BF2 4BF2 87               4      ADD A,A
000BF3 4BF3 87               4      ADD A,A
000BF4 4BF4 87               4      ADD A,A
000BF5 4BF5 3D               4      DEC A
000BF6 4BF6 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000BF9 4BF9 06FF             7      LD  B,-1
000BFB 4BFB A7               4      AND A           ;無限ループ阻止
       4BFC                     GETDPB1:
000BFC 4BFC 04               4      INC B
000BFD 4BFD 1F               4      RRA
000BFE 4BFE 38FC            12      JR  C,GETDPB1
000C00 4C00 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000C03 4C03 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000C06 4C06 3D               4      DEC A
000C07 4C07 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000C0A 4C0A A7               4      AND A           ;無限ループ阻止
000C0B 4C0B 06FF             7      LD  B,-1
       4C0D                     GETDPB2:
000C0D 4C0D 04               4      INC B
000C0E 4C0E 1F               4      RRA
000C0F 4C0F 38FC            12      JR  C,GETDPB2
000C11 4C11 04               4      INC B
000C12 4C12 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000C15 4C15 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
000C18 4C18 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
000C1B 4C1B DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
000C1E 4C1E 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
000C21 4C21 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000C24 4C24 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
000C27 4C27 DD770B          19      LD  (IX+11),A       ;FATCNT
                                
000C2A 4C2A ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
000C2E 4C2E DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
000C31 4C31 DD460A          19      LD  B,(IX+10)       ;FATCNT
000C34 4C34 210000          10      LD  HL,0
       4C37                     GETDPB3:
000C37 4C37 19              11      ADD HL,DE
000C38 4C38 10FD            13      DJNZ    GETDPB3
       4C3A                     GETDPB4:
000C3A 4C3A DD5E08          19      LD  E,(IX+8)        ;FIRFAT
000C3D 4C3D DD5609          19      LD  D,(IX+9)        ;FIRFAT
000C40 4C40 19              11      ADD HL,DE
000C41 4C41 DD7511          19      LD  (IX+17),L       ;FIRDIR
000C44 4C44 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000C47 4C47 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000C4A 4C4A 87               4      ADD A,A
000C4B 4C4B 87               4      ADD A,A
000C4C 4C4C DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4C4F                     GETDPB5:
000C4F 4C4F CB3B             8      SRL E
000C51 4C51 1F               4      RRA
000C52 4C52 30FB            12      JR  NC,GETDPB5
000C54 4C54 1600             7      LD  D,0
000C56 4C56 19              11      ADD HL,DE
000C57 4C57 DD750C          19      LD  (IX+12),L       ;FIRREC
000C5A 4C5A DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000C5D 4C5D 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
000C60 4C60 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
000C63 4C63 DD560D          19      LD  D,(IX+13)       ;FIRREC
000C66 4C66 A7               4      AND A
000C67 4C67 ED52            15      SBC HL,DE
                                
000C69 4C69 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
000C6C 4C6C 3C               4      INC A
000C6D 4C6D 37               4      SCF             ;無限ループ阻止
       4C6E                     GETDPB6:
000C6E 4C6E 1F               4      RRA
000C6F 4C6F 3806            12      JR  C,GETDPB7
000C71 4C71 CB3C             8      SRL H
000C73 4C73 CB1D             8      RR  L
000C75 4C75 18F7            12      JR  GETDPB6
       4C77                     GETDPB7:
000C77 4C77 23               6      INC HL
000C78 4C78 DD750E          19      LD  (IX+14),L       ;MAXCLUS
000C7B 4C7B DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       4C7E                     GETDPBD1:
000C7E 4C7E DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000C81 4C81 E6FC             7      AND 0FCH
000C83 4C83 C8              11      RET Z
                                
000C84 4C84 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
000C88 4C88 37               4      SCF
000C89 4C89 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
000C8D 4C8D DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
000C90 4C90 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
000C94 4C94 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
000C98 4C98 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
000C9C 4C9C DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
000CA0 4CA0 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
000CA4 4CA4 DDCB1126        23      SLA (IX+17)         ;FIRDIR
000CA8 4CA8 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
000CAC 4CAC DD6E11          19      LD  L,(IX+17)       ;FIRDIR
000CAF 4CAF DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
000CB2 4CB2 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000CB5 4CB5 87               4      ADD A,A
000CB6 4CB6 87               4      ADD A,A
000CB7 4CB7 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4CBA                     GETDPBD5:
000CBA 4CBA CB3B             8      SRL E
000CBC 4CBC 1F               4      RRA
000CBD 4CBD 30FB            12      JR  NC,GETDPBD5
000CBF 4CBF 1600             7      LD  D,0
000CC1 4CC1 19              11      ADD HL,DE
000CC2 4CC2 DD750C          19      LD  (IX+12),L       ;FIRREC
000CC5 4CC5 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000CC8 4CC8 18B4            12      JR  GETDPBD1
                                
       4CCA                     CHOICE:
000CCA 4CCA 210000          10      LD  HL,0
000CCD 4CCD C9              10      RET
                                
       4CCE                     DSKFMT:
000CCE 4CCE AF               4      XOR A
000CCF 4CCF 37               4      SCF
       4CD0                     DSKSTP:
000CD0 4CD0 C9              10      RET
                                
       4CD1                     BASENT:
000CD1 4CD1 ED7B57F1        20      LD  SP,(BASSTK)
000CD5 4CD5 C3A243          10      JP  BASAUTO
                                
       4CD8                     GETSLT:
000CD8 4CD8 3A22FB          13      LD  A,(DRVTBL+1)
000CDB 4CDB C9              10      RET
                                
       4CDC                     GET_DISK_BANK_FDRV:
000CDC 4CDC 3A4BF1          13      LD  A,(FDRV)
000CDF 4CDF D601             7      SUB 1
000CE1 4CE1 3003            12      JR  NC,GET_DISK_BANK
000CE3 4CE3 3A42F1          13      LD  A,(_DVSW)
       4CE6                     GET_DISK_BANK:
000CE6 4CE6 B7               4      OR  A       ;A=DRIVE
000CE7 4CE7 3E01             7      LD  A,DISK_BANK
000CE9 4CE9 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
000CEB 4CEB 3A41F1          13      LD  A,(B_DRIVE)
                                #endif
       4CEE                     SET_DISK_BANK:
000CEE 4CEE 320068          13      LD  (BANK1_SEL),A
000CF1 4CF1 F5              11      PUSH    AF
000CF2 4CF2 E5              11      PUSH    HL
000CF3 4CF3 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
000CF6 4CF6 2222F1          16      LD  (SECSZ),HL
000CF9 4CF9 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000CFC 4CFC CD054D          17      CALL    MUL_AHL
000CFF 4CFF 2220F1          16      LD  (CLSZ),HL
000D02 4D02 E1              10      POP HL
000D03 4D03 F1              10      POP AF
000D04 4D04 C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)
       4D05                     MUL_AHL:
000D05 4D05 1F               4      RRA     ;->CF
000D06 4D06 D8              11      RET C
000D07 4D07 29              11      ADD HL,HL
000D08 4D08 18FB            12      JR  MUL_AHL
                                
       4D0A                     DPB2DD:
000D0A 4D0A F9                      DB  0F9H    ;MEDIA
000D0B 4D0B 0002                    DW  00200H  ;SECSIZ
000D0D 4D0D 0F                      DB  00FH    ;DIRMSK
000D0E 4D0E 04                      DB  004H    ;DIRSHFT
000D0F 4D0F 01                      DB  001H    ;CLUSMSK
000D10 4D10 02                      DB  002H    ;CLUSSHFT
000D11 4D11 0100                    DW  00001H  ;FIRFAT
000D13 4D13 02                      DB  002H    ;FATCNT
000D14 4D14 70                      DB  070H    ;MAXENT
000D15 4D15 0E00                    DW  0000EH  ;FIRREC
000D17 4D17 CA02                    DW  002CAH  ;MAXCLUS
000D19 4D19 03                      DB  003H    ;FATSIZ
000D1A 4D1A 0700                    DW  0007H   ;FIRDIR
       4D1C                     DPB2DD_E:
                                
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       4D1C                     POP_HL_ERROR:
000D1C 4D1C E1              10      POP     HL
       4D1D                     _ERROR:
000D1D 4D1D 0600             7      LD  B,0
000D1F 4D1F A7               4      AND A
000D20 4D20 C9              10      RET
                                
       4D21                     ROM_BDOS:
000D21 4D21 E5              11      PUSH    HL
000D22 4D22 79               4      LD  A,C
000D23 4D23 87               4      ADD A,A
000D24 4D24 38F7            12      JR  C,_ERROR
000D26 4D26 6F               4      LD  L,A
000D27 4D27 265F             7      LD  H,high STABLE
000D29 4D29 7E               7      LD  A,(HL)
000D2A 4D2A 2C               4      INC L
000D2B 4D2B 66               7      LD  H,(HL)
000D2C 4D2C 6F               4      LD  L,A
000D2D 4D2D E3              19      EX  (SP),HL
000D2E 4D2E 79               4      LD  A,C
000D2F 4D2F C9              10      RET
                                
       4D30                     _PRINT:
       4D30                     PRINT:
000D30 4D30 7B               4      LD  A,E
000D31 4D31 1803            12      JR  MSG_A
                                
       4D33                     _SYS01:     ;(BDOS)コンソール入力
000D33 4D33 CDAA4D          17      CALL    _SYS07
       4D36                     MSG_A:
000D36 4D36 FE03             7      CP  3
000D38 4D38 2814            12      JR  Z,MSG_BR
       4D3A                     MSGA1:
000D3A 4D3A F5              11      PUSH    AF
000D3B 4D3B C5              11      PUSH    BC
000D3C 4D3C D5              11      PUSH    DE
000D3D 4D3D E5              11      PUSH    HL
000D3E 4D3E DDE5            15      PUSH    IX
000D40 4D40 DD21A200        14      LD  IX,CHPUT
000D44 4D44 CDD142          17      CALL    CALSLT_R
000D47 4D47 DDE1            14      POP IX
000D49 4D49 E1              10      POP HL
000D4A 4D4A D1              10      POP DE
000D4B 4D4B C1              10      POP BC
       4D4C                     MSGA2:
000D4C 4D4C F1              10      POP AF
000D4D 4D4D C9              10      RET
       4D4E                     MSG_BR:
000D4E 4D4E F5              11      PUSH    AF
000D4F 4D4F 3ADDF3          13      LD  A,(CSRX)
000D52 4D52 FE02             7      CP  2
000D54 4D54 38F6            12      JR  C,MSGA2
000D56 4D56 F1              10      POP AF
       4D57                     MSG_CR:
000D57 4D57 F5              11      PUSH    AF
000D58 4D58 3E0D             7      LD  A,00DH
000D5A 4D5A CD3A4D          17      CALL    MSGA1
000D5D 4D5D 3E0A             7      LD  A,00AH
000D5F 4D5F CD3A4D          17      CALL    MSGA1
000D62 4D62 F1              10      POP AF
000D63 4D63 C9              10      RET
                                
       4D64                     _SYS02:     ;(BDOS)コンソール出力
000D64 4D64 CD7F4D          17      CALL    BREAK
000D67 4D67 1805            12      JR  PRINTX
                                
       4D69                     _SYS06:     ;(BDOS)コンソール直接入出力
000D69 4D69 7B               4      LD  A,E
000D6A 4D6A 3C               4      INC A
000D6B 4D6B CABE4D          10      JP  Z,_INKEY
       4D6E                     PRINTX:
000D6E 4D6E C3304D          10      JP  _PRINT
                                
       4D71                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000D71 4D71 CDAA4D          17      CALL    _SYS07
000D74 4D74 FE03             7      CP  3
000D76 4D76 CC7F4D          17      CALL    Z,_BREAK
000D79 4D79 FE13             7      CP  013H        ;CTRL+S
000D7B 4D7B C0              11      RET NZ
       4D7C                     PAUSE:
000D7C 4D7C CD964D          17      CALL    KEYBC
                                
       4D7F                     _BREAK:
       4D7F                     BREAK:
000D7F 4D7F F5              11      PUSH    AF
000D80 4D80 C5              11      PUSH    BC
000D81 4D81 D5              11      PUSH    DE
000D82 4D82 E5              11      PUSH    HL
000D83 4D83 DDE5            15      PUSH    IX
000D85 4D85 DD21B700        14      LD  IX,BREAKX
000D89 4D89 CDD142          17      CALL    CALSLT_R
000D8C 4D8C DDE1            14      POP IX
000D8E 4D8E E1              10      POP HL
000D8F 4D8F D1              10      POP DE
000D90 4D90 C1              10      POP BC
000D91 4D91 DC7F4D          17      CALL    C,_BREAK
000D94 4D94 F1              10      POP AF
000D95 4D95 C9              10      RET
       4D96                     KEYBC:
000D96 4D96 F5              11      PUSH    AF
000D97 4D97 C5              11      PUSH    BC
000D98 4D98 D5              11      PUSH    DE
000D99 4D99 E5              11      PUSH    HL
000D9A 4D9A DDE5            15      PUSH    IX
000D9C 4D9C DD215601        14      LD  IX,KILBUF
000DA0 4DA0 CDD142          17      CALL    CALSLT_R
000DA3 4DA3 DDE1            14      POP IX
000DA5 4DA5 E1              10      POP HL
000DA6 4DA6 D1              10      POP DE
000DA7 4DA7 C1              10      POP BC
000DA8 4DA8 F1              10      POP AF
000DA9 4DA9 C9              10      RET
                                
       4DAA                     _SYS07:
       4DAA                     FLGET:
000DAA 4DAA C5              11      PUSH    BC
000DAB 4DAB D5              11      PUSH    DE
000DAC 4DAC E5              11      PUSH    HL
000DAD 4DAD DDE5            15      PUSH    IX
000DAF 4DAF DD219F00        14      LD  IX,CHGET
000DB3 4DB3 CDD142          17      CALL    CALSLT_R
000DB6 4DB6 DDE1            14      POP IX
000DB8 4DB8 E1              10      POP HL
000DB9 4DB9 D1              10      POP DE
000DBA 4DBA C1              10      POP BC
000DBB 4DBB FE03             7      CP  3
000DBD 4DBD C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       4DBE                     _INKEY:
       4DBE                     INKEY:
000DBE 4DBE CD584E          17      CALL    CPM_CONST
000DC1 4DC1 C8              11      RET Z
000DC2 4DC2 18E6            12      JR  FLGET
                                
       4DC4                     _SYS0A:     ;(BDOS)文字列入力
000DC4 4DC4 C5              11      PUSH    BC
000DC5 4DC5 E5              11      PUSH    HL
000DC6 4DC6 D5              11      PUSH    DE
000DC7 4DC7 CDF04D          17      CALL    GETL
000DCA 4DCA 111FF4          10      LD  DE,KBUF
000DCD 4DCD E1              10      POP HL
000DCE 4DCE E5              11      PUSH    HL
000DCF 4DCF 0E00             7      LD  C,0
000DD1 4DD1 3004            12      JR  NC,SAX0
000DD3 4DD3 23               6      INC HL
000DD4 4DD4 23               6      INC HL
000DD5 4DD5 1808            12      JR  SAX4
       4DD7                     SAX0:
000DD7 4DD7 46               7      LD  B,(HL)
000DD8 4DD8 23               6      INC HL
       4DD9                     SAX1:
000DD9 4DD9 23               6      INC HL
000DDA 4DDA 1A               7      LD  A,(DE)
000DDB 4DDB 13               6      INC DE
000DDC 4DDC B7               4      OR  A
000DDD 4DDD 2004            12      JR  NZ,SAX2
       4DDF                     SAX4:
000DDF 4DDF 360D            10      LD  (HL),00DH
000DE1 4DE1 1804            12      JR  SAX3
       4DE3                     SAX2:
000DE3 4DE3 77               7      LD  (HL),A
000DE4 4DE4 0C               4      INC C
000DE5 4DE5 10F2            13      DJNZ    SAX1
       4DE7                     SAX3:
000DE7 4DE7 D1              10      POP DE
000DE8 4DE8 79               4      LD  A,C
000DE9 4DE9 13               6      INC DE
000DEA 4DEA 12               7      LD  (DE),A
000DEB 4DEB 1B               6      DEC DE
000DEC 4DEC E1              10      POP HL
000DED 4DED C1              10      POP BC
000DEE 4DEE A7               4      AND A
000DEF 4DEF C9              10      RET
       4DF0                     GETL:
000DF0 4DF0 DDE5            15      PUSH    IX
000DF2 4DF2 FDE5            15      PUSH    IY
                                
000DF4 4DF4 2ADCF3          16      LD  HL,(CSRY)
000DF7 4DF7 22CAFB          16      LD  (FSTPOS),HL
       4DFA                     GETL1:
000DFA 4DFA CD714D          17      CALL    _SYS08
000DFD 4DFD FE09             7      CP  9
000DFF 4DFF 2008            12      JR  NZ,GETL1V
000E01 4E01 211FF4          10      LD  HL,KBUF
000E04 4E04 CD5443          17      CALL    MSX
000E07 4E07 18F1            12      JR  GETL1
       4E09                     GETL1V:
000E09 4E09 5F               4      LD  E,A
000E0A 4E0A FE08             7      CP  8
000E0C 4E0C CCA64E          17      CALL    Z,CTRL02
000E0F 4E0F FE20             7      CP  020H
000E11 4E11 D4D24E          17      CALL    NC,INSERT
000E14 4E14 CD3A4D          17      CALL    MSGA1
                                
000E17 4E17 7B               4      LD  A,E
000E18 4E18 FE0D             7      CP  00DH
000E1A 4E1A 20DE            12      JR  NZ,GETL1
                                
000E1C 4E1C 111FF4          10      LD  DE,KBUF
000E1F 4E1F 3AB0F3          13      LD  A,(LINLEN)
000E22 4E22 47               4      LD  B,A
000E23 4E23 CD8250          17      CALL    ZERO_MEMORY_DE
                                
000E26 4E26 2ACAFB          16      LD  HL,(FSTPOS)
000E29 4E29 3ADCF3          13      LD  A,(CSRY)
000E2C 4E2C 6F               4      LD  L,A
000E2D 4E2D E5              11      PUSH    HL
000E2E 4E2E CD034F          17      CALL    LOC0
000E31 4E31 4D               4      LD  C,L
000E32 4E32 44               4      LD  B,H
000E33 4E33 E1              10      POP HL
000E34 4E34 3AB0F3          13      LD  A,(LINLEN)
000E37 4E37 94               4      SUB H
000E38 4E38 3D               4      DEC A
000E39 4E39 5F               4      LD  E,A
000E3A 4E3A 211FF4          10      LD  HL,KBUF
       4E3D                     GETL2:
000E3D 4E3D CD964E          17      CALL    _SCRN
000E40 4E40 03               6      INC BC
000E41 4E41 77               7      LD  (HL),A
000E42 4E42 23               6      INC HL
000E43 4E43 1D               4      DEC E
000E44 4E44 20F7            12      JR  NZ,GETL2
000E46 4E46 CD574D          17      CALL    MSG_CR
                                
000E49 4E49 FDE1            14      POP IY
000E4B 4E4B DDE1            14      POP IX
       4E4D                     GETL3:
000E4D 4E4D 2B               6      DEC HL
000E4E 4E4E 7E               7      LD  A,(HL)
000E4F 4E4F FE21             7      CP  021H
000E51 4E51 D0              11      RET NC
000E52 4E52 3600            10      LD  (HL),0
000E54 4E54 15               4      DEC D
000E55 4E55 20F6            12      JR  NZ,GETL3
000E57 4E57 C9              10      RET
                                
       4E58                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       4E58                     CONSTX:
       4E58                     CPM_CONST:
000E58 4E58 C5              11      PUSH    BC
000E59 4E59 D5              11      PUSH    DE
000E5A 4E5A E5              11      PUSH    HL
000E5B 4E5B DDE5            15      PUSH    IX
000E5D 4E5D DD219C00        14      LD  IX,CHSNS
000E61 4E61 CDD142          17      CALL    CALSLT_R
000E64 4E64 DDE1            14      POP IX
000E66 4E66 E1              10      POP HL
000E67 4E67 D1              10      POP DE
000E68 4E68 C1              10      POP BC
000E69 4E69 C9              10      RET
                                
       4E6A                     _SYS2A:     ;(BDOS)日付の獲得
000E6A 4E6A AF               4      XOR A
000E6B 4E6B 57               4      LD  D,A
000E6C 4E6C 5F               4      LD  E,A
000E6D 4E6D 67               4      LD  H,A
000E6E 4E6E 6F               4      LD  L,A
000E6F 4E6F C9              10      RET
                                
       4E70                     _SYS2C:     ;(BDOS)時刻の獲得
000E70 4E70 AF               4      XOR A
000E71 4E71 57               4      LD  D,A
000E72 4E72 5F               4      LD  E,A
000E73 4E73 67               4      LD  H,A
000E74 4E74 6F               4      LD  L,A
000E75 4E75 C9              10      RET
                                
       4E76                     POS:
000E76 4E76 F5              11      PUSH    AF
000E77 4E77 2ADCF3          16      LD  HL,(CSRY)
000E7A 4E7A 7D               4      LD  A,L
000E7B 4E7B 6C               4      LD  L,H
000E7C 4E7C 67               4      LD  H,A
000E7D 4E7D 2C               4      INC L
000E7E 4E7E 24               4      INC H
000E7F 4E7F F1              10      POP AF
000E80 4E80 C9              10      RET
                                
       4E81                     LOC:
000E81 4E81 F5              11      PUSH    AF
000E82 4E82 E5              11      PUSH    HL
000E83 4E83 7D               4      LD  A,L
000E84 4E84 6C               4      LD  L,H
000E85 4E85 67               4      LD  H,A
000E86 4E86 2D               4      DEC L
000E87 4E87 25               4      DEC H
000E88 4E88 DDE5            15      PUSH    IX
000E8A 4E8A DD21C600        14      LD  IX,POSIT
000E8E 4E8E CDD142          17      CALL    CALSLT_R
000E91 4E91 DDE1            14      POP IX
000E93 4E93 E1              10      POP HL
000E94 4E94 F1              10      POP AF
000E95 4E95 C9              10      RET
                                
       4E96                     _SCRN:
       4E96                     SCRN:
000E96 4E96 E5              11      PUSH    HL
000E97 4E97 DDE5            15      PUSH    IX
                                
000E99 4E99 69               4      LD  L,C
000E9A 4E9A 60               4      LD  H,B
000E9B 4E9B DD214A00        14      LD  IX,RDVRM
000E9F 4E9F CDD142          17      CALL    CALSLT_R
                                
000EA2 4EA2 DDE1            14      POP IX
000EA4 4EA4 E1              10      POP HL
000EA5 4EA5 C9              10      RET
                                
       4EA6                     CTRL02:
000EA6 4EA6 F5              11      PUSH    AF
000EA7 4EA7 D5              11      PUSH    DE
000EA8 4EA8 2ADCF3          16      LD  HL,(CSRY)
000EAB 4EAB 3AB0F3          13      LD  A,(LINLEN)
000EAE 4EAE 4F               4      LD  C,A
000EAF 4EAF 94               4      SUB H   ;CSRX
000EB0 4EB0 C602             7      ADD A,2
000EB2 4EB2 47               4      LD  B,A ;カーソルより右の文字数
000EB3 4EB3 61               4      LD  H,C ;LINLEN
000EB4 4EB4 C5              11      PUSH    BC
000EB5 4EB5 CD034F          17      CALL    LOC0
000EB8 4EB8 C1              10      POP BC
                                
000EB9 4EB9 1620             7      LD  D,020H
       4EBB                     C8X1:
000EBB 4EBB DD214A00        14      LD  IX,RDVRM
000EBF 4EBF CDD142          17      CALL    CALSLT_R
000EC2 4EC2 4F               4      LD  C,A
000EC3 4EC3 7A               4      LD  A,D
000EC4 4EC4 DD214D00        14      LD  IX,WRTVRM
000EC8 4EC8 CDD142          17      CALL    CALSLT_R
000ECB 4ECB 2B               6      DEC HL
000ECC 4ECC 51               4      LD  D,C
000ECD 4ECD 10EC            13      DJNZ    C8X1
000ECF 4ECF D1              10      POP DE
000ED0 4ED0 F1              10      POP AF
000ED1 4ED1 C9              10      RET
                                
       4ED2                     INSERT:
000ED2 4ED2 F5              11      PUSH    AF
000ED3 4ED3 D5              11      PUSH    DE
000ED4 4ED4 2ADCF3          16      LD  HL,(CSRY)
000ED7 4ED7 3AB0F3          13      LD  A,(LINLEN)
000EDA 4EDA 4F               4      LD  C,A
000EDB 4EDB 94               4      SUB H   ;CSRX
000EDC 4EDC 3C               4      INC A
000EDD 4EDD 47               4      LD  B,A ;カーソルより右の文字数
000EDE 4EDE C5              11      PUSH    BC
000EDF 4EDF CD034F          17      CALL    LOC0
000EE2 4EE2 C1              10      POP BC
                                
000EE3 4EE3 1620             7      LD  D,020H
       4EE5                     INS1:
000EE5 4EE5 DD214A00        14      LD  IX,RDVRM
000EE9 4EE9 CDD142          17      CALL    CALSLT_R
000EEC 4EEC 4F               4      LD  C,A
000EED 4EED 7A               4      LD  A,D
000EEE 4EEE DD214D00        14      LD  IX,WRTVRM
000EF2 4EF2 CDD142          17      CALL    CALSLT_R
000EF5 4EF5 23               6      INC HL
000EF6 4EF6 51               4      LD  D,C
000EF7 4EF7 10EC            13      DJNZ    INS1
000EF9 4EF9 D1              10      POP DE
000EFA 4EFA F1              10      POP AF
000EFB 4EFB C9              10      RET
                                
       4EFC                     CONOUT1:
000EFC 4EFC 59               4      LD  E,C
000EFD 4EFD C3304D          10      JP  _PRINT
                                
       4F00                     GETVRAM:
000F00 4F00 2ADCF3          16      LD  HL,(CSRY)
       4F03                     LOC0:
000F03 4F03 2D               4      DEC L
000F04 4F04 25               4      DEC H
000F05 4F05 4C               4      LD  C,H ;CSRX-1
000F06 4F06 5D               4      LD  E,L ;CSRY-1
       4F07                     LOC1:
000F07 4F07 3AB0F3          13      LD  A,(LINLEN)
000F0A 4F0A 67               4      LD  H,A
000F0B 4F0B 1600             7      LD  D,0
000F0D 4F0D 6A               4      LD  L,D ;0
000F0E 4F0E 0608             7      LD  B,8
       4F10                     LOC2:
000F10 4F10 29              11      ADD HL,HL
000F11 4F11 3001            12      JR  NC,LOC3
000F13 4F13 19              11      ADD HL,DE
       4F14                     LOC3:
000F14 4F14 10FA            13      DJNZ    LOC2
000F16 4F16 09              11      ADD HL,BC
000F17 4F17 C9              10      RET
                                
       4F18                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000F18 4F18 212200          10      LD  HL,00022H
000F1B 4F1B AF               4      XOR A
000F1C 4F1C 7D               4      LD  A,L
000F1D 4F1D C9              10      RET
                                
       4F1E                     _SYS0D:     ;(BDOS)ディスク・リセット
000F1E 4F1E 218000          10      LD  HL,00080H
000F21 4F21 222EF1          16      LD  (_DTA),HL
000F24 4F24 C9              10      RET
                                
       4F25                     _SYS0E:     ;(BDOS)カレントドライブの設定
000F25 4F25 3242F1          13      LD  (_DVSW),A
000F28 4F28 C9              10      RET
                                
       4F29                     _SYS0F:     ;(BDOS)ファイルのオープン
000F29 4F29 D5              11      PUSH    DE
000F2A 4F2A FDE1            14      POP IY
000F2C 4F2C CD7250          17      CALL    INIT_FILE
000F2F 4F2F CDF748          17      CALL    ROM_OPEN
000F32 4F32 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
000F34 4F34 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
000F38 4F38 FDE5            15      PUSH    IY
000F3A 4F3A D1              10      POP DE
000F3B 4F3B 13               6      INC DE
000F3C 4F3C 010B00          10      LD  BC,11
000F3F 4F3F EDB0                    LDIR
                                ;               Attribute
000F41 4F41 7E               7      LD  A,(HL)
000F42 4F42 FD770D          19      LD  (IY+13),A
                                ;               TIME
000F45 4F45 110B00          10      LD  DE,11
000F48 4F48 19              11      ADD HL,DE
000F49 4F49 7E               7      LD  A,(HL)
000F4A 4F4A 23               6      INC HL
000F4B 4F4B FD7716          19      LD  (IY+22),A
000F4E 4F4E 7E               7      LD  A,(HL)
000F4F 4F4F 23               6      INC HL
000F50 4F50 FD7717          19      LD  (IY+23),A
                                ;               DATE
000F53 4F53 7E               7      LD  A,(HL)
000F54 4F54 23               6      INC HL
000F55 4F55 FD7714          19      LD  (IY+20),A
000F58 4F58 7E               7      LD  A,(HL)
000F59 4F59 23               6      INC HL
000F5A 4F5A FD7715          19      LD  (IY+21),A
                                ;               First cluster
000F5D 4F5D 7E               7      LD  A,(HL)
000F5E 4F5E 23               6      INC HL
000F5F 4F5F FD771A          19      LD  (IY+26),A
000F62 4F62 7E               7      LD  A,(HL)
000F63 4F63 23               6      INC HL
000F64 4F64 FD771B          19      LD  (IY+27),A
                                ;               SIZE
000F67 4F67 7E               7      LD  A,(HL)
000F68 4F68 23               6      INC HL
000F69 4F69 FD7710          19      LD  (IY+16),A
000F6C 4F6C 7E               7      LD  A,(HL)
000F6D 4F6D 23               6      INC HL
000F6E 4F6E FD7711          19      LD  (IY+17),A
000F71 4F71 7E               7      LD  A,(HL)
000F72 4F72 23               6      INC HL
000F73 4F73 FD7712          19      LD  (IY+18),A
000F76 4F76 7E               7      LD  A,(HL)
000F77 4F77 FD7713          19      LD  (IY+19),A
000F7A 4F7A AF               4      XOR A
000F7B 4F7B FD770C          19      LD  (IY+12),A
000F7E 4F7E C9              10      RET
                                
       4F7F                     _SYS10:     ;(BDOS)ファイルのクローズ
000F7F 4F7F AF               4      XOR A
000F80 4F80 C9              10      RET
                                
       4F81                     S11X1:
000F81 4F81 FD7119          19      LD  (IY+25),C       ;RootEntCnt
000F84 4F84 FD750E          19      LD  (IY+14),L
000F87 4F87 FD740F          19      LD  (IY+15),H
       4F8A                     SCF_FF_RET:
000F8A 4F8A 37               4      SCF
000F8B 4F8B 9F               4      SBC A,A
000F8C 4F8C C9              10      RET
                                
       4F8D                     _SYS11:     ;(BDOS)最初のファイルの検索
000F8D 4F8D ED5336F1        20      LD  (_FCB),DE
000F91 4F91 D5              11      PUSH    DE
000F92 4F92 FDE1            14      POP IY
000F94 4F94 CD7250          17      CALL    INIT_FILE
000F97 4F97 CD0E4B          17      CALL    GET_DIR_DAT
       4F9A                     S12X1:
000F9A 4F9A CD1349          17      CALL    FILESE
000F9D 4F9D 30E2            12      JR  NC,S11X1
000F9F 4F9F 0D               4      DEC C
000FA0 4FA0 FD7119          19      LD  (IY+25),C       ;RootEntCnt
000FA3 4FA3 012000          10      LD  BC,32
000FA6 4FA6 ED5B2EF1        20      LD  DE,(_DTA)
000FAA 4FAA AF               4      XOR A
000FAB 4FAB 12               7      LD  (DE),A      ;ドライブ番号
000FAC 4FAC 13               6      INC DE
000FAD 4FAD EDB0                    LDIR            ;ディレクトリエントリ
000FAF 4FAF FD750E          19      LD  (IY+14),L
000FB2 4FB2 FD740F          19      LD  (IY+15),H
000FB5 4FB5 C9              10      RET
                                
       4FB6                     _SYS12:
000FB6 4FB6 FD2A36F1        20      LD  IY,(_FCB)
000FBA 4FBA FDE5            15      PUSH    IY
000FBC 4FBC D1              10      POP DE
000FBD 4FBD CD7250          17      CALL    INIT_FILE
                                
000FC0 4FC0 FD6E0E          19      LD  L,(IY+14)
000FC3 4FC3 FD660F          19      LD  H,(IY+15)
000FC6 4FC6 FD4E19          19      LD  C,(IY+25)
000FC9 4FC9 18CF            12      JR  S12X1
                                
       4FCB                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000FCB 4FCB CDF44A          17      CALL    SET_FCB
000FCE 4FCE CDC24A          17      CALL    GETSEQ
000FD1 4FD1 CDAF4A          17      CALL    RB_READ
000FD4 4FD4 E5              11      PUSH    HL
000FD5 4FD5 CDCF4A          17      CALL    SETSEQ
000FD8 4FD8 E1              10      POP HL
       4FD9                     SREAD:
000FD9 4FD9 C601             7      ADD A,001H
000FDB 4FDB D8              11      RET C
                                
000FDC 4FDC 7D               4      LD  A,L
000FDD 4FDD D601             7      SUB 001H
000FDF 4FDF 9F               4      SBC A,A
000FE0 4FE0 E603             7      AND 3
000FE2 4FE2 1F               4      RRA
000FE3 4FE3 C9              10      RET
                                
       4FE4                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000FE4 4FE4 210100          10      LD  HL,00001H
000FE7 4FE7 AF               4      XOR A
000FE8 4FE8 C9              10      RET
                                
       4FE9                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000FE9 4FE9 3A42F1          13      LD  A,(_DVSW)
000FEC 4FEC C9              10      RET
                                
       4FED                     _SYS1A:     ;(BDOS)DTAの設定
000FED 4FED ED532EF1        20      LD  (_DTA),DE
000FF1 4FF1 AF               4      XOR A
000FF2 4FF2 C9              10      RET
                                
       4FF3                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000FF3 4FF3 010002          10      LD  BC,512
000FF6 4FF6 11C302          10      LD  DE,707
000FF9 4FF9 210000          10      LD  HL,0
000FFC 4FFC DD2138F1        14      LD  IX,_BUF
001000 5000 FD2138F1        14      LD  IY,_BUF
001004 5004 FD3600F9        19      LD  (IY+0),0F9H
001008 5008 3E02             7      LD  A,2
00100A 500A C9              10      RET
                                
       500B                     _SYS21:     ;(BDOS)ランダムな読み出し
00100B 500B CDF44A          17      CALL    SET_FCB
                                
00100E 500E FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001011 5011 FD6622          19      LD  H,(IY+34)
                                
001014 5014 CDAF4A          17      CALL    RB_READ
001017 5017 18C0            12      JR  SREAD
                                
       5019                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
001019 5019 CD294F          17      CALL    _SYS0F
00101C 501C D8              11      RET C
                                
00101D 501D D5              11      PUSH    DE      ;EX DE,IY
00101E 501E FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001020 5020 CDE44A          17      CALL    GETSIZE
       5023                     _S24X1:
001023 5023 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001026 5026 FD7422          19      LD  (IY+34),H
001029 5029 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
00102D 502D FDE3            23      EX  (SP),IY     ;
00102F 502F D1              10      POP DE      ;
                                
001030 5030 AF               4      XOR A
001031 5031 C9              10      RET
                                
       5032                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
001032 5032 E5              11      PUSH    HL
001033 5033 D5              11      PUSH    DE      ;EX DE,IY
001034 5034 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001036 5036 CDC24A          17      CALL    GETSEQ
001039 5039 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       503B                     _SYS27:     ;(BDOS)ランダムブロック読み込み
00103B 503B CDF44A          17      CALL    SET_FCB
00103E 503E E5              11      PUSH    HL
00103F 503F FD6E21          19      LD  L,(IY+33)
001042 5042 FD6622          19      LD  H,(IY+34)
001045 5045 2224F1          16      LD  (RR_LOW),HL
001048 5048 FD6E23          19      LD  L,(IY+35)
00104B 504B FD6624          19      LD  H,(IY+36)
00104E 504E 2226F1          16      LD  (RR_HIGH),HL
001051 5051 E1              10      POP HL
001052 5052 CD1747          17      CALL    ROM_READ
001055 5055 ED5B24F1        20      LD  DE,(RR_LOW)
001059 5059 FD7321          19      LD  (IY+33),E
00105C 505C FD7222          19      LD  (IY+34),D
00105F 505F ED5B26F1        20      LD  DE,(RR_HIGH)
001063 5063 FD7323          19      LD  (IY+35),E
001066 5066 FD7224          19      LD  (IY+36),D
001069 5069 9F               4      SBC A,A
00106A 506A C9              10      RET
                                
       506B                     _SYS2F:
00106B 506B 44               4      LD  B,H
00106C 506C 2A2EF1          16      LD  HL,(_DTA)
00106F 506F C34A4B          10      JP  DISKIO
                                
       5072                     INIT_FILE:
001072 5072 EB               4      EX  DE,HL
001073 5073 114BF1          10      LD  DE,FDRV
001076 5076 010C00          10      LD  BC,1+8+3
001079 5079 EDB0                    LDIR
00107B 507B CDDC4C          17      CALL    GET_DISK_BANK_FDRV
00107E 507E 320068          13      LD  (BANK1_SEL),A
001081 5081 C9              10      RET
                                
       5082                     ZERO_MEMORY_DE:
001082 5082 AF               4      XOR A
       5083                     FILL_MEMORY_DE:
001083 5083 12               7      LD  (DE),A
001084 5084 13               6      INC DE
001085 5085 10FC            13      DJNZ    FILL_MEMORY_DE
001087 5087 C9              10      RET
                                
001088 5088                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 1D4D334D644D1D4D        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 1D4D1D4D694DAA4D        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 714D1D4DC44D584E        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 184F1E4F254F294F        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 7F4F8D4FB64F1D4D        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 CB4F1D4D1D4D1D4D        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 E44FE94FED4FF34F        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 1D4D1D4D1D4D1950        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 32501D4D1D4D3B50        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 1D4D1D4D6A4E1D4D        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 704E1D4D1D4D6B50        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB8 5FB8 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 1D4D1D4D1D4D1D4D        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM32.ASM:UTF_8]
