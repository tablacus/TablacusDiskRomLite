                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
       0001                     USE_MORMAL32K_OR_ASCII16        EQU 1   ;ノーマル32KB/ASCII-16K ROMを作成する
                                
                                    INCLUDE "DISKROM.ASM"
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       269A                     DECADD  EQU 0269AH
       27E6                     DECMUL  EQU 027E6H
       2F8A                     FRCINT  EQU 02F8AH
                                
       303A                     FRCDBL  EQU 0303AH
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F69B                     FRETOP  EQU 0F69BH
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
       F847                     ARG EQU 0F847H
       F860                     FILTAB  EQU 0F860H
       F862                     NULBUF  EQU 0F862H
       F864                     PTRFIL  EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
       F866                     FILNAM  EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FDDB                     H_PINL  EQU 0FDDBH
                                
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
                                            ;ASCII-16K
       6000                     ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
       7000                     ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                #else
                                            ;ASCII-8K
                                BANK0_SEL EQU   06000H  ;6000-67FF
                                BANK1_SEL EQU   06800H  ;6800-6FFF
                                BANK2_SEL EQU   07000H  ;7000-77FF
                                BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;Konami-8K
                                KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
                                KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
                                KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;Konami-SCC
                                KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
                                KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
                                KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
                                KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                #endif
                                
       F280                     ISC EQU 0F280H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
       F280                     SP32    EQU 0F280H
[EOF:DEF.ASM:UTF_8]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"        ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM    ; Main program execution address.
000004 4004 0F4F                    DW  STATEMENT   ; STATEMENT
000006 4006 3F50                    DW  DEVICE_ENTRY    ; DEVICE
000008 4008 0000                    DW  0       ; TEXT
00000A 400A 000000000000            DW  0,0,0       ; Reserved
                                
000010 4010 C39751          10      JP  DISKIO
000013 4013 C3DD51          10      JP  DSKCHG
000016 4016 C33352          10      JP  GETDPB
000019 4019 C32653          10      JP  CHOICE
00001C 401C C32A53          10      JP  DSKFMT
00001F 401F C32C53          10      JP  DSKSTP
000022 4022 C32D53          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C32A53          10      JP  DSKFMT
000029 4029 C32C53          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C36653          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.4.2.1",0
            204449534B20524F    
            4D204C6974652076    
            302E342E322E3100    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 AF               4      XOR A
000107 4107 2100F3          10      LD  HL,0F300H
00010A 410A 0668             7      LD  B,068H
00010C 410C CDC84B          17      CALL    FILL_MEMORY
                                
00010F 410F 3E01             7      LD  A,1
000111 4111 3221FB          13      LD  (DRVTBL),A
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
000114 4114 2A74F6          16      LD  HL,(STKTOP) ;起動時の空き容量表示の為
000117 4117 01C0FE          10      LD  BC,-00140H
00011A 411A 09              11      ADD HL,BC
00011B 411B 2274F6          16      LD  (STKTOP),HL
                                #else
                                    LD  HL,STKTOP+1 ;起動時の空き容量表示の為
                                    DEC (HL)
                                #endif
                                
00011E 411E AF               4      XOR A
00011F 411F 32EAF2          13      LD  (_DVSW),A
000122 4122 3D               4      DEC A       ;0FFH
000123 4123 3299FD          13      LD  (DEVICE),A
                                
000126 4126 21E242          10      LD  HL,AT_ISC
000129 4129 1180F2          10      LD  DE,ISC
00012C 412C 018800          10      LD  BC,ISC_E-ISC
00012F 412F EDB0                    LDIR
                                    
000131 4131 3EC3             7      LD  A,0C3H      ;JP
000133 4133 3243FF          13      LD  (H_GONE),A
000136 4136 327DF3          13      LD  (BDOS),A
000139 4139 326BF3          13      LD  (RAMUSE),A
00013C 413C 3268F3          13      LD  (ROMUSE),A
00013F 413F 2180F2          10      LD  HL,REPLACE_COMMAND
000142 4142 2244FF          16      LD  (H_GONE+1),HL
000145 4145 2131F3          10      LD  HL,H_BDOS
000148 4148 227EF3          16      LD  (BDOS+1),HL
00014B 414B 21ABF2          10      LD  HL,RAMUSE1
00014E 414E 226CF3          16      LD  (RAMUSE+1),HL
000151 4151 21BEF2          10      LD  HL,ROMUSE1
000154 4154 2269F3          16      LD  (ROMUSE+1),HL
                                
000157 4157 3E                      DB  03EH
000158 4158 F7              12      RST 30H
000159 4159 3271FE          13      LD  (H_BINS),A
00015C 415C 3276FE          13      LD  (H_BINL),A
00015F 415F 327BFE          13      LD  (H_FILE),A
000162 4162 3231F3          13      LD  (H_BDOS),A
000165 4165 32DBFD          13      LD  (H_PINL),A
000168 4168 32A7FF          13      LD  (H_PHYD),A
                                
00016B 416B CD2E42          17      CALL    GTSL1_
00016E 416E 3297F2          13      LD  (ROM_SLT),A
000171 4171 32A7F2          13      LD  (ROM_SLT_COPY),A
000174 4174 3272FE          13      LD  (H_BINS+1),A
000177 4177 3277FE          13      LD  (H_BINL+1),A
00017A 417A 327CFE          13      LD  (H_FILE+1),A
00017D 417D 3232F3          13      LD  (H_BDOS+1),A
000180 4180 32DCFD          13      LD  (H_PINL+1),A
000183 4183 32A8FF          13      LD  (H_PHYD+1),A
000186 4186 3222FB          13      LD  (DRVTBL+1),A
000189 4189 3248F3          13      LD  (MASTERS),A
                                
00018C 418C 21B445          10      LD  HL,ROM_LOAD
00018F 418F 2273FE          16      LD  (H_BINS+2),HL
000192 4192 216547          10      LD  HL,ROM_RUN
000195 4195 2278FE          16      LD  (H_BINL+2),HL
000198 4198 217347          10      LD  HL,ROM_FILES
00019B 419B 227DFE          16      LD  (H_FILE+2),HL
00019E 419E 21CB53          10      LD  HL,ROM_BDOS
0001A1 41A1 2233F3          16      LD  (H_BDOS+2),HL
0001A4 41A4 21A743          10      LD  HL,ROM_BOOT
0001A7 41A7 22DDFD          16      LD  (H_PINL+2),HL
0001AA 41AA 219751          10      LD  HL,DISKIO
0001AD 41AD 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001B0 41B0 3E                      DB  03EH
0001B1 41B1 C9              10      RET
0001B2 41B2 327FFE          13      LD  (H_FILE+4),A
0001B5 41B5 3275FE          13      LD  (H_BINS+4),A
0001B8 41B8 327AFE          13      LD  (H_BINL+4),A
0001BB 41BB 3235F3          13      LD  (H_BDOS+4),A
0001BE 41BE 32DFFD          13      LD  (H_PINL+4),A
0001C1 41C1 32ABFF          13      LD  (H_PHYD+4),A
                                
0001C4 41C4 AF               4      XOR A
                                #if exists USE_MORMAL32K_OR_ASCII16
0001C5 41C5 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001C8 41C8 3A0060          13      LD  A,(BANK1_ADR)
0001CB 41CB FE41             7      CP  'A'
                                #if exists USE_MORMAL32K_OR_ASCII16
0001CD 41CD 284E            12      JR  Z,NOT_BANK_TYPE
0001CF 41CF 3E01             7      LD  A,DISK_BANK
0001D1 41D1 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    JR  NZ,NOT_BANK_TYPE
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001D4 41D4 CD3801          17      CALL    RSLREG      ;read primary slot #
0001D7 41D7 07               4      RLCA
0001D8 41D8 07               4      RLCA
0001D9 41D9 F5              11      PUSH    AF
0001DA 41DA 1605             7      LD  D,4+1
0001DC 41DC CD3542          17      CALL    GTSL2_
0001DF 41DF 3244F3          13      LD  (RAMAD3),A
0001E2 41E2 F1              10      POP AF
0001E3 41E3 07               4      RLCA
0001E4 41E4 07               4      RLCA
0001E5 41E5 1603             7      LD  D,2+1
0001E7 41E7 CD3542          17      CALL    GTSL2_
0001EA 41EA 2680             7      LD  H,080H
0001EC 41EC CD5242          17      CALL    CHK_RAM
0001EF 41EF 3243F3          13      LD  (RAMAD2),A
       41F2                     RAMCHK2:
0001F2 41F2 3A44F3          13      LD  A,(RAMAD3)
0001F5 41F5 2640             7      LD  H,040H
0001F7 41F7 CD5242          17      CALL    CHK_RAM
0001FA 41FA 3242F3          13      LD  (RAMAD1),A
       41FD                     RAMCHK1:
0001FD 41FD 3A44F3          13      LD  A,(RAMAD3)
000200 4200 2600             7      LD  H,00H
000202 4202 CD5242          17      CALL    CHK_RAM
000205 4205 3241F3          13      LD  (RAMAD0),A
       4208                     RAMCHK0:
000208 4208 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
00020B 420B 010F00          10      LD  BC,0000FH       ;切り上げ
00020E 420E 09              11      ADD HL,BC
00020F 420F 7D               4      LD  A,L
                                
000210 4210 0604             7      LD  B,4
       4212                     B_DRIVE1:
000212 4212 CB3C             8      SRL H
000214 4214 1F               4      RRA
000215 4215 10FB            13      DJNZ    B_DRIVE1
                                
000217 4217 C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000219 4219 32E9F2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
00021C 421C C9              10      RET
                                
       421D                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
00021D 421D 21EA43          10      LD  HL,MSG_ERROR_ROM_MODE
000220 4220 CD6D43          17      CALL    MSX
000223 4223 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000227 4227 DD219F00        14      LD  IX,CHGET
00022B 422B C31C00          10      JP  _CALSLT
                                
       422E                     GTSL1_:             ;自分のいるスロットを知る
00022E 422E CD3801          17      CALL    RSLREG      ;read primary slot #
000231 4231 0F               4      RRCA
000232 4232 0F               4      RRCA
000233 4233 1601             7      LD  D,1
       4235                     GTSL2_:
000235 4235 E603             7      AND 3       ;[A]=000000PP
000237 4237 5F               4      LD  E,A     ;[E]=000000PP
000238 4238 21C1FC          10      LD  HL,EXPTBL
00023B 423B 85               4      ADD A,L     ;桁上りは無い
00023C 423C 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
00023D 423D 7B               4      LD  A,E     ;[A]=000000PP
00023E 423E CB7E            13      BIT 7,(HL)
000240 4240 C8              11      RET Z
000241 4241 7D               4      LD  A,L     ;point to SLTTBL entry
000242 4242 C604             7      ADD A,4     ;桁上りは無い
000244 4244 6F               4      LD  L,A
000245 4245 7E               7      LD  A,(HL)      ;get currently expansion slot register
       4246                     GTSL3_:
000246 4246 15               4      DEC D
000247 4247 2803            12      JR  Z,GTSL4_:
000249 4249 0F               4      RRCA
00024A 424A 18FA            12      JR  GTSL3_:
       424C                     GTSL4_:
00024C 424C E60C             7      AND 00CH        ;[A] = 0000SS00
00024E 424E B3               4      OR  E       ;[A] = 0000SSPP
00024F 424F F680             7      OR  080H        ;[A] = 1000SSPP
000251 4251 C9              10      RET
                                
       4252                     CHK_RAM:
000252 4252 E5              11      PUSH    HL
000253 4253 CDA742          17      CALL    CHK_RAM0
000256 4256 E1              10      POP HL
000257 4257 C8              11      RET Z
000258 4258 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
00025B 425B E680             7      AND 080H
00025D 425D CD7E42          17      CALL    CHK_RAM_SLT
000260 4260 C8              11      RET Z
000261 4261 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000264 4264 E680             7      AND 080H
000266 4266 C601             7      ADD A,1
000268 4268 CD7E42          17      CALL    CHK_RAM_SLT
00026B 426B C8              11      RET Z
00026C 426C 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
00026F 426F E680             7      AND 080H
000271 4271 C602             7      ADD A,2
000273 4273 CD7E42          17      CALL    CHK_RAM_SLT
000276 4276 C8              11      RET Z
000277 4277 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
00027A 427A E680             7      AND 080H
00027C 427C C603             7      ADD A,3
       427E                     CHK_RAM_SLT:
00027E 427E E5              11      PUSH    HL
00027F 427F CDA742          17      CALL    CHK_RAM0        ;スロット#X or X-0
000282 4282 E1              10      POP HL
000283 4283 C8              11      RET Z
000284 4284 CB79             8      BIT 7,C
000286 4286 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000288 4288 79               4      LD  A,C
000289 4289 C604             7      ADD A,4*1           ;スロット#X-1
00028B 428B E5              11      PUSH    HL
00028C 428C CDA742          17      CALL    CHK_RAM0
00028F 428F E1              10      POP HL
000290 4290 C8              11      RET Z
000291 4291 79               4      LD  A,C
000292 4292 C608             7      ADD A,4*2           ;スロット#X-2
000294 4294 E5              11      PUSH    HL
000295 4295 CDA742          17      CALL    CHK_RAM0
000298 4298 E1              10      POP HL
000299 4299 C8              11      RET Z
00029A 429A 79               4      LD  A,C
00029B 429B C60C             7      ADD A,4*3           ;スロット#X-3
00029D 429D E5              11      PUSH    HL
00029E 429E CDA742          17      CALL    CHK_RAM0
0002A1 42A1 E1              10      POP HL
       42A2                     CHK_RAM_E:
0002A2 42A2 AF               4      XOR A
0002A3 42A3 3C               4      INC A           ;ZF=0にする
0002A4 42A4 3E00             7      LD  A,0
0002A6 42A6 C9              10      RET
                                
       42A7                     CHK_RAM0:
0002A7 42A7 4F               4      LD  C,A
0002A8 42A8 3A97F2          13      LD  A,(ROM_SLT)
0002AB 42AB B9               4      CP  C
0002AC 42AC 28F4            12      JR  Z,CHK_RAM_E
0002AE 42AE 2E00             7      LD  L,0
       42B0                     CHK_RAM1:
0002B0 42B0 79               4      LD  A,C
0002B1 42B1 CD9F43          17      CALL    RDSLTX
0002B4 42B4 C6E5             7      ADD A,0E5H
0002B6 42B6 47               4      LD  B,A
0002B7 42B7 5F               4      LD  E,A
0002B8 42B8 79               4      LD  A,C
0002B9 42B9 C5              11      PUSH    BC
0002BA 42BA CD1400          17      CALL    _WRSLT
0002BD 42BD C1              10      POP BC
0002BE 42BE 79               4      LD  A,C
0002BF 42BF CD9F43          17      CALL    RDSLTX
0002C2 42C2 B8               4      CP  B
0002C3 42C3 C0              11      RET NZ
0002C4 42C4 D6E5             7      SUB 0E5H
0002C6 42C6 79               4      LD  A,C
0002C7 42C7 5F               4      LD  E,A
0002C8 42C8 C5              11      PUSH    BC
0002C9 42C9 CD1400          17      CALL    _WRSLT
0002CC 42CC C1              10      POP BC
0002CD 42CD 24               4      INC H
0002CE 42CE 7D               4      LD  A,L
0002CF 42CF C604             7      ADD A,4
0002D1 42D1 6F               4      LD  L,A
0002D2 42D2 20DC            12      JR  NZ,CHK_RAM1
0002D4 42D4 79               4      LD  A,C     ;ZF=1のハズ
0002D5 42D5 C9              10      RET
                                
       42D6                     CALSLT_R:
0002D6 42D6 C5              11      PUSH    BC
0002D7 42D7 E5              11      PUSH    HL
0002D8 42D8 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0002DC 42DC CD1C00          17      CALL    _CALSLT
0002DF 42DF E1              10      POP HL
0002E0 42E0 C1              10      POP BC
0002E1 42E1 C9              10      RET
                                
       42E2                     AT_ISC:
0002E2 F280                         ORG ISC,AT_ISC-RUN
       F280                     REPLACE_COMMAND:
0002E2 F280 FEB7             7      CP  0B7H            ;FILES
0002E4 F282 CC7BFE          17      CALL    Z,H_FILE
0002E7 F285 FEB5             7      CP  0B5H            ;LOAD
0002E9 F287 CA71FE          10      JP  Z,H_BINS
0002EC F28A FE8A             7      CP  08AH            ;RUN
0002EE F28C CA76FE          10      JP  Z,H_BINL
0002F1 F28F FED6             7      CP  0D6H            ;COPY
0002F3 F291 2813            12      JR  Z,FIX_COPY
0002F5 F293 FECF             7      CP  0CFH            ;BLOAD
0002F7 F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
0002F8 F296 F7              12      RST 30H
       F297                     ROM_SLT:
0002F9 F297 00                      DB  0
0002FA F298 9646                    DW  ROM_BLOAD
0002FC F29A F5              11      PUSH    AF
0002FD F29B E5              11      PUSH    HL
0002FE F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
000301 F29F E1              10      POP HL
000302 F2A0 F1              10      POP AF
000303 F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
000305 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
000307 F2A5 C9              10      RET
       F2A6                     FIX_COPY:
000308 F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
000309 F2A7 00                      DB  0
00030A F2A8 1548                    DW  ROM_COPY
00030C F2AA C9              10      RET
       F2AB                     RAMUSE1:
00030D F2AB 3A42F3          13      LD  A,(RAMAD1)
       F2AE                     ROMUSE2:
000310 F2AE C32400          10      JP  _ENASLT
       F2B1                     CAL_MP:
000313 F2B1 2640             7      LD  H,040H
000315 F2B3 3AC1FC          13      LD  A,(EXPTBL)
000318 F2B6 CD2400          17      CALL    _ENASLT
00031B F2B9 CD1C00          17      CALL    _CALSLT
00031E F2BC 2640             7      LD  H,040H
       F2BE                     ROMUSE1:
000320 F2BE 3A97F2          13      LD  A,(ROM_SLT)
000323 F2C1 18EB            12      JR  ROMUSE2
                                
       F2C3                     _RESULT:
000325 F2C3 00                      DB  0
       F2C4                     _BANK:
000326 F2C4 00                      DB  0
       F2C5                     _BANK1:
000327 F2C5 00                      DB  0
       F2C6                     CLSZ:               ;クラスタサイズ
000328 F2C6 0004                    DW  1024
       F2C7                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2C8                     SECSZ:              ;セクタサイズ
00032A F2C8 0002                    DW  512
       F2C9                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2CA                     RR_LOW:
00032C F2CA 0000                    DW  0
       F2CB                     RR_MID  EQU $-1
       F2CC                     RR_HIGH:
00032E F2CC 0000                    DW  0
       F2CE                     _CLPS:
000330 F2CE 0000                    DW  0
       F2D0                     _LEFT:
000332 F2D0 0000                    DW  0
       F2D2                     _DTPS:
000334 F2D2 0000                    DW  0
       F2D4                     _DTA:
000336 F2D4 0000                    DW  0
       F2D6                     FLG_LDIR:
000338 F2D6 00                      DB  0
       F2D7                     _FCB:
000339 F2D7 0000                    DW  0
       F2D9                     _BUF:
       F2D9                     _BUF_LO:        ;LOGICAL OPERATION
00033B F2D9 00                      DB  0
       F2DA                     _BUF_ST:
00033C F2DA 0000                    DW  0
       F2DC                     _BUF_EN:
00033E F2DC 0000                    DW  0
       F2DE                     _BUF_EX:
       F2DE                     _BUF_W:
000340 F2DE 0000                    DW  0
       F2E0                     _BUF_H:
000342 F2E0 0000                    DW  0
       F2E2                     _BUF_X:
000344 F2E2 0000                    DW  0
       F2E4                     _BUF_Y:
000346 F2E4 00                      DB  0
       F2E5                     _BUF_P:
000347 F2E5 00                      DB  0
       F2E6                     _BUF_O:
000348 F2E6 00                      DB  0
       F2E7                     DTAX:
000349 F2E7 0000                    DW  0
       F2E9                     B_DRIVE:
00034B F2E9 00                      DB  0
       F2EA                     _DVSW:          ;カレントドライブ
00034C F2EA 00                      DB  0
       F2EB                     _CD:            ;カレントディレクトリ
00034D F2EB 0000                    DW  0
       F2ED                     DIRENT1:
00034F F2ED 0000                    DW  0
       F2EF                     _DIR_BANK:
000351 F2EF 00                      DB  0
       F2F0                     LEFTX:
000352 F2F0 0000                    DW  0
       F2F2                     PARAM0:
000354 F2F2 0000                    DW  0
       F2F4                     PARAM1:
000356 F2F4 0000                    DW  0
       F2F6                     _CDX:
000358 F2F6 0000                    DW  0
       F2F8                     FDRV:
00035A F2F8 00                      DB  0
       F2F9                     FNAME:
00035B F2F9                         DS  8+3
       F304                     _HL:
000366 F304 0000                    DW  0
       F306                     _SP:
000368 F306 0000                    DW  0
       F307                     _SP_H   EQU $-1
       F308                     ISC_E:
00036A 436A                         ORG $$+RUN          ;$DEPHASE
                                
       436A                     MSX1:
00036A 436A CDE453          17      CALL    MSGA1
       436D                     MSX:
00036D 436D 7E               7      LD  A,(HL)
00036E 436E 23               6      INC HL
00036F 436F B7               4      OR  A
000370 4370 20F8            12      JR  NZ,MSX1
000372 4372 C9              10      RET
                                
       4373                     PRTHX:
000373 4373 F5              11      PUSH    AF
000374 4374 07               4      RLCA
000375 4375 07               4      RLCA
000376 4376 07               4      RLCA
000377 4377 07               4      RLCA
000378 4378 CD7C43          17      CALL    PRTA2
00037B 437B F1              10      POP AF
       437C                     PRTA2:
00037C 437C CD8243          17      CALL    ASC
00037F 437F C3E053          10      JP  MSG_A
                                    
       4382                     ASC:
000382 4382 E60F             7      AND $0F
000384 4384 F630             7      OR  $30
000386 4386 FE3A             7      CP  $3A
000388 4388 D8              11      RET C
000389 4389 C607             7      ADD A,7
00038B 438B C9              10      RET
                                
       438C                     MSN:
                                #if exists USE_MORMAL32K_OR_ASCII16
00038C 438C CD9843          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
00038F 438F 23               6      INC HL
000390 4390 CDE053          17      CALL    MSG_A
000393 4393 10F7            13      DJNZ    MSN
000395 4395 C9              10      RET
                                
       4396                     RDSLT_ROM3:
000396 4396 7E               7      LD  A,(HL)
000397 4397 C9              10      RET
       4398                     RDSLT_ROM:
000398 4398 CB7C             8      BIT 7,H
00039A 439A 28FA            12      JR  Z,RDSLT_ROM3
       439C                     RDSLT_ROM2:
00039C 439C 3A97F2          13      LD  A,(ROM_SLT)
       439F                     RDSLTX:
00039F 439F C5              11      PUSH    BC
0003A0 43A0 D5              11      PUSH    DE
0003A1 43A1 CD0C00          17      CALL    _RDSLT
0003A4 43A4 D1              10      POP DE
0003A5 43A5 C1              10      POP BC
0003A6 43A6 C9              10      RET
                                
       43A7                     ROM_BOOT:
0003A7 43A7 3E                      DB  03EH
0003A8 43A8 C9              10      RET
0003A9 43A9 32DBFD          13      LD  (H_PINL),A
0003AC 43AC 3ACAFF          13      LD  A,(EXTBIO)
0003AF 43AF FEF7             7      CP  0F7H        ;RST 30H
0003B1 43B1 280A            12      JR  Z,EXTBIO_OK
0003B3 43B3 3E                      DB  03EH
0003B4 43B4 C9              10      RET
0003B5 43B5 21CAFF          10      LD  HL,EXTBIO
0003B8 43B8 061D             7      LD  B,29
0003BA 43BA CDC84B          17      CALL    FILL_MEMORY
       43BD                     EXTBIO_OK:
0003BD 43BD 210744          10      LD  HL,DELOK
0003C0 43C0 CD6D43          17      CALL    MSX
                                
0003C3 43C3 AF               4      XOR A
0003C4 43C4 3240F3          13      LD  (REBOOT),A
0003C7 43C7 2A48FC          16      LD  HL,(BOTTOM)
0003CA 43CA 110040          10      LD  DE,16384
0003CD 43CD 19              11      ADD HL,DE
0003CE 43CE 3817            12      JR  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
0003D0 43D0 57               4      LD  D,A
0003D1 43D1 0601             7      LD  B,1
0003D3 43D3 2100C0          10      LD  HL,0C000H
0003D6 43D6 CD9751          17      CALL    DISKIO
                                
0003D9 43D9 116BF3          10      LD  DE,RAMUSE
0003DC 43DC AF               4      XOR A
0003DD 43DD CD1EC0          17      CALL    0C01EH
0003E0 43E0 116BF3          10      LD  DE,RAMUSE
0003E3 43E3 37               4      SCF
0003E4 43E4 CD1EC0          17      CALL    0C01EH
       43E7                     BOOT1:
0003E7 43E7 C32D53          10      JP  BASENT
                                
       43EA                     MSG_ERROR_ROM_MODE:
                                #if exists USE_MORMAL32K_OR_ASCII16
0003EA 43EA 4E6F726D616C2052        DB  "Normal ROM/ASCII-16K only!",13,10
            4F4D2F4153434949    
            2D31364B206F6E6C    
            79210D0A            
                                #else
                                    DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
                                #endif
       4406                     NULL:
000406 4406 00                      DB  0
       4407                     DELOK:
000407 4407 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       440B                     ROM_LDIR:
00040B 440B 3AD6F2          13      LD  A,(FLG_LDIR)
00040E 440E B7               4      OR  A
00040F 440F 206A            12      JR  NZ,ROM_LDIRVM
000411 4411 CB7A             8      BIT 7,D
000413 4413 CAAB44          10      JP  Z,ROM_LDIRSLT
                                #if exists USE_MORMAL32K_OR_ASCII16
       4416                     LDIRA:
000416 4416 F3               4      DI
000417 4417 ED7306F3        20      LD  (_SP),SP
00041B 441B 3A07F3          13      LD  A,(_SP_H)
00041E 441E FEC0             7      CP  0C0H
000420 4420 3003            12      JR  NC,SPJ1
000422 4422 3180F2          10      LD  SP,SP32
       4425                     SPJ1:
       4425                     LDIR1:
000425 4425 78               4      LD  A,B
000426 4426 B1               4      OR  C
000427 4427 284D            12      JR  Z,LDIRE
                                
000429 4429 C5              11      PUSH    BC
00042A 442A D5              11      PUSH    DE
00042B 442B E5              11      PUSH    HL
00042C 442C 3A97F2          13      LD  A,(ROM_SLT)
00042F 442F 2680             7      LD  H,080H
000431 4431 CD2400          17      CALL    _ENASLT
000434 4434 E1              10      POP HL
000435 4435 D1              10      POP DE
000436 4436 C1              10      POP BC
       4437                     LDIR2:
000437 4437 7A               4      LD  A,D
000438 4438 FEC0             7      CP  0C0H
00043A 443A 302C            12      JR  NC,LDIR4
                                
00043C 443C C5              11      PUSH    BC
00043D 443D D5              11      PUSH    DE
00043E 443E 115EF5          10      LD  DE,BUF
                                
000441 4441 78               4      LD  A,B
000442 4442 B7               4      OR  A
000443 4443 2803            12      JR  Z,LDIR3
000445 4445 010001          10      LD  BC,00100H
       4448                     LDIR3:
000448 4448 C5              11      PUSH    BC
000449 4449 EDB0                    LDIR
00044B 444B 2204F3          16      LD  (_HL),HL
                                
00044E 444E 3A43F3          13      LD  A,(RAMAD2)
000451 4451 2680             7      LD  H,080H
000453 4453 CD2400          17      CALL    _ENASLT
                                
000456 4456 C1              10      POP BC
000457 4457 D1              10      POP DE
000458 4458 215EF5          10      LD  HL,BUF
00045B 445B EDB0                    LDIR
                                
00045D 445D 2A04F3          16      LD  HL,(_HL)
000460 4460 C1              10      POP BC
000461 4461 78               4      LD  A,B
000462 4462 B7               4      OR  A
000463 4463 2811            12      JR  Z,LDIRE
000465 4465 05               4      DEC B
000466 4466 18BD            12      JR  LDIR1
       4468                     LDIR4:
                                #endif
000468 4468 EDB0                    LDIR
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
       446A                     LDIRE2:
00046A 446A D5              11      PUSH    DE
00046B 446B E5              11      PUSH    HL
00046C 446C 3A43F3          13      LD  A,(RAMAD2)
00046F 446F 2680             7      LD  H,080H
000471 4471 CD2400          17      CALL    _ENASLT
000474 4474 E1              10      POP HL
000475 4475 D1              10      POP DE
       4476                     LDIRE:
000476 4476 ED7B06F3        20      LD  SP,(_SP)
                                #endif
00047A 447A C9              10      RET
                                
       447B                     ROM_LDIRVM:
                                #if exists USE_MORMAL32K_OR_ASCII16
00047B 447B F3               4      DI
00047C 447C ED7306F3        20      LD  (_SP),SP
000480 4480 3A07F3          13      LD  A,(_SP_H)
000483 4483 FEC0             7      CP  0C0H
000485 4485 3003            12      JR  NC,SPJ2
000487 4487 3180F2          10      LD  SP,SP32
       448A                     SPJ2:
00048A 448A C5              11      PUSH    BC
00048B 448B D5              11      PUSH    DE
00048C 448C E5              11      PUSH    HL
00048D 448D 3A97F2          13      LD  A,(ROM_SLT)
000490 4490 2680             7      LD  H,080H
000492 4492 CD2400          17      CALL    _ENASLT
000495 4495 E1              10      POP HL
000496 4496 D1              10      POP DE
000497 4497 C1              10      POP BC
                                #endif
000498 4498 C5              11      PUSH    BC
000499 4499 D5              11      PUSH    DE
00049A 449A FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00049E 449E DD215C00        14      LD  IX,LDIRVM
0004A2 44A2 CD1C00          17      CALL    _CALSLT
0004A5 44A5 E1              10      POP HL
0004A6 44A6 C1              10      POP BC
0004A7 44A7 09              11      ADD HL,BC
0004A8 44A8 EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
0004A9 44A9 18BF            12      JR  LDIRE2
                                #else
                                    RET
                                #endif
                                
       44AB                     ROM_LDIRSLT:
                                #if exists USE_MORMAL32K_OR_ASCII16
0004AB 44AB F3               4      DI
0004AC 44AC ED7306F3        20      LD  (_SP),SP
0004B0 44B0 3A07F3          13      LD  A,(_SP_H)
0004B3 44B3 FEC0             7      CP  0C0H
0004B5 44B5 3003            12      JR  NC,SPJ3
0004B7 44B7 3180F2          10      LD  SP,SP32
       44BA                     SPJ3:
0004BA 44BA C5              11      PUSH    BC
0004BB 44BB D5              11      PUSH    DE
0004BC 44BC E5              11      PUSH    HL
0004BD 44BD 3A97F2          13      LD  A,(ROM_SLT)
0004C0 44C0 2680             7      LD  H,080H
0004C2 44C2 CD2400          17      CALL    _ENASLT
0004C5 44C5 E1              10      POP HL
0004C6 44C6 D1              10      POP DE
0004C7 44C7 C1              10      POP BC
                                #endif
       44C8                     ROM_LDIRSLT1:
0004C8 44C8 EB               4      EX  DE,HL
       44C9                     RLDIRSLT1:
0004C9 44C9 CB7C             8      BIT 7,H
0004CB 44CB 2021            12      JR  NZ,RLDIRSLT_EXIT
0004CD 44CD 1A               7      LD  A,(DE)
0004CE 44CE 13               6      INC DE
0004CF 44CF C5              11      PUSH    BC
0004D0 44D0 D5              11      PUSH    DE
0004D1 44D1 E5              11      PUSH    HL
0004D2 44D2 5F               4      LD  E,A
                                
0004D3 44D3 0141F3          10      LD  BC,RAMAD0
0004D6 44D6 7C               4      LD  A,H
0004D7 44D7 07               4      RLCA
0004D8 44D8 07               4      RLCA
0004D9 44D9 E603             7      AND 3
0004DB 44DB 81               4      ADD A,C
0004DC 44DC 4F               4      LD  C,A
0004DD 44DD 0A               7      LD  A,(BC)
       44DE                     RLDIRSLT2:
0004DE 44DE CD1400          17      CALL    _WRSLT
0004E1 44E1 08               4      EX  AF,AF'
0004E2 44E2 E1              10      POP HL
0004E3 44E3 D1              10      POP DE
0004E4 44E4 C1              10      POP BC
0004E5 44E5 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0004E7 44E7 EAC944          10      JP  PE,RLDIRSLT1
0004EA 44EA EB               4      EX  DE,HL
                                #if exists USE_MORMAL32K_OR_ASCII16
0004EB 44EB C36A44          10      JP  LDIRE2
       44EE                     RLDIRSLT_EXIT:
0004EE 44EE EB               4      EX  DE,HL
0004EF 44EF C32544          10      JP  LDIR1
                                #else
                                    RET
                                RLDIRSLT_EXIT:
                                    EX  DE,HL
                                    LDIR
                                    RET
                                #endif
                                
       44F2                     END_OF_LINE:
0004F2 44F2 215EF5          10      LD  HL,BUF
       44F5                     EOL1:
0004F5 44F5 7E               7      LD  A,(HL)
0004F6 44F6 C8              11      RET Z
0004F7 44F7 FE0D             7      CP  00DH
0004F9 44F9 2807            12      JR  Z,EOLE
0004FB 44FB FE0A             7      CP  00AH
0004FD 44FD 2803            12      JR  Z,EOLE
0004FF 44FF 23               6      INC HL
000500 4500 18F3            12      JR  EOL1
       4502                     EOLE:
000502 4502 3600            10      LD  (HL),0
000504 4504 23               6      INC HL
000505 4505 7E               7      LD  A,(HL)
000506 4506 FE0A             7      CP  00AH
000508 4508 C0              11      RET NZ
000509 4509 23               6      INC HL
00050A 450A C9              10      RET
                                
       450B                     ROM_LOAD_ASCII:
00050B 450B 210000          10      LD  HL,0
00050E 450E 22DAF2          16      LD  (_BUF_ST),HL    ;読み出し位置
000511 4511 2A76F6          16      LD  HL,(TXTTAB)
000514 4514 22DCF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
000517 4517 215EF5          10      LD  HL,BUF
00051A 451A 22D4F2          16      LD  (_DTA),HL
       451D                     RLOAD_A1:
00051D 451D 2ADAF2          16      LD  HL,(_BUF_ST)
000520 4520 22CAF2          16      LD  (RR_LOW),HL
000523 4523 210201          10      LD  HL,258
000526 4526 CD354A          17      CALL    ROM_READ
000529 4529 7C               4      LD  A,H
00052A 452A B5               4      OR  L
00052B 452B 2879            12      JR  Z,RLOAD_AEND
00052D 452D 015EF5          10      LD  BC,BUF
000530 4530 09              11      ADD HL,BC
000531 4531 3600            10      LD  (HL),0
000533 4533 CDF244          17      CALL    END_OF_LINE
000536 4536 015EF5          10      LD  BC,BUF
000539 4539 A7               4      AND A
00053A 453A ED42            15      SBC HL,BC
00053C 453C 2810            12      JR  Z,RLOAD_A2
00053E 453E 4D               4      LD  C,L
00053F 453F 44               4      LD  B,H
000540 4540 ED5BDAF2        20      LD  DE,(_BUF_ST)
000544 4544 19              11      ADD HL,DE
000545 4545 22DAF2          16      LD  (_BUF_ST),HL
000548 4548 3A5EF5          13      LD  A,(BUF)
00054B 454B B7               4      OR  A
00054C 454C 28CF            12      JR  Z,RLOAD_A1
       454E                     RLOAD_A2:
00054E 454E 115EF5          10      LD  DE,BUF
000551 4551 CDFF4B          17      CALL    SPCUTEX
000554 4554 1A               7      LD  A,(DE)
000555 4555 B7               4      OR  A
000556 4556 284E            12      JR  Z,RLOAD_AEND
000558 4558 CD114C          17      CALL    GETNUM
00055B 455B 7C               4      LD  A,H
00055C 455C B5               4      OR  L
00055D 455D CA7D46          10      JP  Z,ERROR_DIRECT_IN_FILE
000560 4560 DD2ADCF2        20      LD  IX,(_BUF_EN)
000564 4564 DD7502          19      LD  (IX+2),L
000567 4567 DD7403          19      LD  (IX+3),H
                                
00056A 456A CDF84B          17      CALL    SPCUT
00056D 456D EB               4      EX  DE,HL
00056E 456E DDE5            15      PUSH    IX
000570 4570 DD21B242        14      LD  IX,CRUNCH
000574 4574 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000578 4578 CD1C00          17      CALL    _CALSLT
00057B 457B DDE1            14      POP IX
00057D 457D EB               4      EX  DE,HL
00057E 457E 111FF4          10      LD  DE,KBUF
000581 4581 37               4      SCF
000582 4582 ED52            15      SBC HL,DE
000584 4584 CA7D46          10      JP  Z,ERROR_DIRECT_IN_FILE
000587 4587 DA7D46          10      JP  C,ERROR_DIRECT_IN_FILE
00058A 458A 4D               4      LD  C,L
00058B 458B 44               4      LD  B,H
00058C 458C 2ADCF2          16      LD  HL,(_BUF_EN)
00058F 458F 110400          10      LD  DE,4
000592 4592 19              11      ADD HL,DE
000593 4593 111FF4          10      LD  DE,KBUF
                                
000596 4596 EB               4      EX  DE,HL
000597 4597 EDB0                    LDIR
000599 4599 EB               4      EX  DE,HL
                                
00059A 459A DD7500          19      LD  (IX+0),L
00059D 459D DD7401          19      LD  (IX+1),H
0005A0 45A0 22DCF2          16      LD  (_BUF_EN),HL
0005A3 45A3 C31D45          10      JP  RLOAD_A1
                                
       45A6                     RLOAD_AEND:
0005A6 45A6 2ADCF2          16      LD  HL,(_BUF_EN)
0005A9 45A9 AF               4      XOR A
0005AA 45AA 77               7      LD  (HL),A
0005AB 45AB 23               6      INC HL
0005AC 45AC 77               7      LD  (HL),A
0005AD 45AD 23               6      INC HL
0005AE 45AE 22DCF2          16      LD  (_BUF_EN),HL
0005B1 45B1 C34046          10      JP  RLOAD_END1
                                
       45B4                     ROM_LOAD:
0005B4 45B4 CDE347          17      CALL    INIT_PARAM
0005B7 45B7 7E               7      LD  A,(HL)
0005B8 45B8 FE2C             7      CP  ','
0005BA 45BA 2003            12      JR  NZ,ROM_LOAD0
0005BC 45BC 23               6      INC HL
0005BD 45BD 7E               7      LD  A,(HL)
0005BE 45BE 2B               6      DEC HL
       45BF                     ROM_LOAD0:
0005BF 45BF 32BEFC          13      LD  (RUNBNF),A
0005C2 45C2 CDD64A          17      CALL    FILE_B
0005C5 45C5 3AF9F2          13      LD  A,(FNAME)
0005C8 45C8 FE20             7      CP  020H
0005CA 45CA CAD14A          10      JP  Z,ROM_ORG
                                
0005CD 45CD CD684C          17      CALL    ROM_OPEN
0005D0 45D0 DA8946          10      JP  C,ERROR_FILE_NOT_FOUND
       45D3                     ROM_LOAD1:
0005D3 45D3 21D9F2          10      LD  HL,_BUF
0005D6 45D6 22D4F2          16      LD  (_DTA),HL
0005D9 45D9 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
0005DC 45DC CD354A          17      CALL    ROM_READ
0005DF 45DF 3AD9F2          13      LD  A,(_BUF)
0005E2 45E2 3C               4      INC A
0005E3 45E3 C20B45          10      JP  NZ,ROM_LOAD_ASCII
0005E6 45E6 2A76F6          16      LD  HL,(TXTTAB)
0005E9 45E9 22D4F2          16      LD  (_DTA),HL
0005EC 45EC EB               4      EX  DE,HL
0005ED 45ED 2100FF          10      LD  HL,-256
0005F0 45F0 39              11      ADD HL,SP
0005F1 45F1 ED52            15      SBC HL,DE
0005F3 45F3 CD354A          17      CALL    ROM_READ
0005F6 45F6 ED5BD4F2        20      LD  DE,(_DTA)
0005FA 45FA 19              11      ADD HL,DE
0005FB 45FB E5              11      PUSH    HL
0005FC 45FC 2A76F6          16      LD  HL,(TXTTAB)
       45FF                     ROM_LOAD2:          ;リンクポインタをFIX
0005FF 45FF E5              11      PUSH    HL
000600 4600 DDE1            14      POP IX
000602 4602 7E               7      LD  A,(HL)      ;リンクポインタL
000603 4603 23               6      INC HL
000604 4604 B6               7      OR  (HL)        ;リンクポインタH
000605 4605 23               6      INC HL
000606 4606 2837            12      JR  Z,RLOAD_END0
000608 4608 23               6      INC HL      ;行番号
000609 4609 23               6      INC HL      ;行番号
       460A                     ROM_LOAD3:
00060A 460A 7E               7      LD  A,(HL)
00060B 460B 23               6      INC HL
00060C 460C FE0B             7      CP  00BH        ;8進数(&O)
00060E 460E 2822            12      JR  Z,INC_HL2
000610 4610 FE0C             7      CP  00CH        ;16進数(&H)
000612 4612 281E            12      JR  Z,INC_HL2
000614 4614 FE0D             7      CP  00DH        ;行番号(RUN後)
000616 4616 281A            12      JR  Z,INC_HL2
000618 4618 FE0E             7      CP  00EH        ;行番号(RUN前)
00061A 461A 2816            12      JR  Z,INC_HL2
00061C 461C FE0F             7      CP  00FH        ;10～255の整数(%)
00061E 461E 2813            12      JR  Z,INC_HL1
000620 4620 FE1C             7      CP  01CH        ;256～65535の整数(%)
000622 4622 280E            12      JR  Z,INC_HL2
000624 4624 FE1D             7      CP  01DH        ;単精度実数(!)
000626 4626 2808            12      JR  Z,INC_HL4
000628 4628 FE1F             7      CP  01FH        ;倍制度実数(#)
00062A 462A 2008            12      JR  NZ,INC_HL0
00062C 462C 23               6      INC HL
00062D 462D 23               6      INC HL
00062E 462E 23               6      INC HL
00062F 462F 23               6      INC HL
       4630                     INC_HL4:
000630 4630 23               6      INC HL
000631 4631 23               6      INC HL
       4632                     INC_HL2:
000632 4632 23               6      INC HL
       4633                     INC_HL1:
000633 4633 23               6      INC HL
       4634                     INC_HL0:
000634 4634 B7               4      OR  A
000635 4635 20D3            12      JR  NZ,ROM_LOAD3
000637 4637 DD7500          19      LD  (IX+0),L
00063A 463A DD7401          19      LD  (IX+1),H
00063D 463D 18C0            12      JR  ROM_LOAD2
       463F                     RLOAD_END0:
00063F 463F E1              10      POP HL
       4640                     RLOAD_END1:
000640 4640 22C2F6          16      LD  (VARTAB),HL
000643 4643 22C4F6          16      LD  (ARYTAB),HL
000646 4646 22C6F6          16      LD  (STREND),HL
                                
000649 4649 3ABEFC          13      LD  A,(RUNBNF)
00064C 464C CD524C          17      CALL    CAP
00064F 464F FE52             7      CP  'R'
000651 4651 280E            12      JR  Z,RLOAD_END2
000653 4653 AF               4      XOR A
000654 4654 21DCF2          10      LD  HL,_BUF+3
000657 4657 77               7      LD  (HL),A      ;3
000658 4658 2B               6      DEC HL
000659 4659 77               7      LD  (HL),A      ;2
00065A 465A 2B               6      DEC HL
00065B 465B 77               7      LD  (HL),A      ;1
00065C 465C 2B               6      DEC HL
00065D 465D 3E8F             7      LD  A,08FH      ;REM
00065F 465F 77               7      LD  (HL),A      ;0
000660 4660 C9              10      RET
       4661                     RLOAD_END2:
000661 4661 D5              11      PUSH    DE
000662 4662 ED5B76F6        20      LD  DE,(TXTTAB)
000666 4666 1B               6      DEC DE
000667 4667 AF               4      XOR A
000668 4668 21DFF2          10      LD  HL,_BUF+6
00066B 466B 77               7      LD  (HL),A      ;6
00066C 466C 2B               6      DEC HL
00066D 466D 77               7      LD  (HL),A      ;5
00066E 466E 2B               6      DEC HL
00066F 466F 77               7      LD  (HL),A      ;4
000670 4670 2B               6      DEC HL
000671 4671 72               7      LD  (HL),D      ;3 行番号H
000672 4672 2B               6      DEC HL
000673 4673 73               7      LD  (HL),E      ;2 行番号L
000674 4674 2B               6      DEC HL
000675 4675 360D            10      LD  (HL),00DH   ;1 行番号(RUN後)
000677 4677 2B               6      DEC HL
000678 4678 3E89             7      LD  A,089H      ;GOTO
00067A 467A 77               7      LD  (HL),A      ;0
00067B 467B D1              10      POP DE
00067C 467C C9              10      RET
                                
       467D                     ERROR_DIRECT_IN_FILE:
00067D 467D 1E39             7      LD  E,57            ;Direct statement in file
00067F 467F 01                      DB  1           ;LD BC,
       4680                     ERROR_DEVICE_IO_ERROR:
000680 4680 1E13             7      LD  E,19            ;Device I/O error
000682 4682 01                      DB  1           ;LD BC,
       4683                     ERROR_INTERNAL_ERROR:
000683 4683 1E33             7      LD  E,51            ;Internal error
000685 4685 01                      DB  1           ;LD BC,
       4686                     ERROR_FILE_NOT_OPEN:
000686 4686 1E3B             7      LD  E,59            ;File not OPEN
000688 4688 01                      DB  1           ;LD BC,
       4689                     ERROR_FILE_NOT_FOUND:
000689 4689 1E35             7      LD  E,53            ;File not found
       468B                     ERROR:
00068B 468B FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00068F 468F DD216F40        14      LD  IX,ERRHAND
000693 4693 C31C00          10      JP  _CALSLT
                                
       4696                     ROM_BLOAD:
000696 4696 CDE347          17      CALL    INIT_PARAM
000699 4699 CDD64A          17      CALL    FILE_B
00069C 469C CD684C          17      CALL    ROM_OPEN
00069F 469F 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
0006A1 46A1 21D9F2          10      LD  HL,_BUF
0006A4 46A4 22D4F2          16      LD  (_DTA),HL
0006A7 46A7 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
0006AA 46AA CD354A          17      CALL    ROM_READ
0006AD 46AD 3AD9F2          13      LD  A,(_BUF)
0006B0 46B0 FEFE             7      CP  0FEH
0006B2 46B2 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
0006B4 46B4 21A5F2          10      LD  HL,BLOAD_RET
0006B7 46B7 229DF2          16      LD  (SWC_BLOAD),HL
                                
0006BA 46BA 2AF4F2          16      LD  HL,(PARAM1)
0006BD 46BD 7E               7      LD  A,(HL)
0006BE 46BE FE2C             7      CP  ','
0006C0 46C0 2049            12      JR  NZ,RBREAD_MEM
0006C2 46C2 23               6      INC HL
0006C3 46C3 7E               7      LD  A,(HL)
0006C4 46C4 CD524C          17      CALL    CAP
0006C7 46C7 32BEFC          13      LD  (RUNBNF),A
0006CA 46CA FE52             7      CP  'R'     ;R,Sスイッチじゃ無い場合はオフセット値として処理する
0006CC 46CC 2808            12      JR  Z,RBOS1
0006CE 46CE FE53             7      CP  'S'
0006D0 46D0 2804            12      JR  Z,RBOS1
0006D2 46D2 FE2C             7      CP  ','
0006D4 46D4 200D            12      JR  NZ,RBOS2
       46D6                     RBOS1:
0006D6 46D6 7E               7      LD  A,(HL)
0006D7 46D7 23               6      INC HL
0006D8 46D8 B7               4      OR  A
0006D9 46D9 2824            12      JR  Z,RBREAD_OSE
0006DB 46DB FE3A             7      CP  ':'
0006DD 46DD 2820            12      JR  Z,RBREAD_OSE
0006DF 46DF FE2C             7      CP  ','     ;次のパラメータを探す
0006E1 46E1 20F3            12      JR  NZ,RBOS1
       46E3                     RBOS2:              ;オフセット
0006E3 46E3 22F4F2          16      LD  (PARAM1),HL
0006E6 46E6 7E               7      LD  A,(HL)
0006E7 46E7 B7               4      OR  A
0006E8 46E8 2815            12      JR  Z,RBREAD_OSE
0006EA 46EA DD212F54        14      LD  IX,FRMQNT
0006EE 46EE FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0006F2 46F2 CD1C00          17      CALL    _CALSLT
0006F5 46F5 22F4F2          16      LD  (PARAM1),HL
0006F8 46F8 2ADAF2          16      LD  HL,(_BUF_ST)
0006FB 46FB 19              11      ADD HL,DE
0006FC 46FC 22DAF2          16      LD  (_BUF_ST),HL
       46FF                     RBREAD_OSE:
0006FF 46FF 3ABEFC          13      LD  A,(RUNBNF)
000702 4702 FE53             7      CP  'S'
000704 4704 2005            12      JR  NZ,RBREAD_MEM
000706 4706 3E01             7      LD  A,1
000708 4708 32D6F2          13      LD  (FLG_LDIR),A
       470B                     RBREAD_MEM:
00070B 470B 2ADAF2          16      LD  HL,(_BUF_ST)
00070E 470E 22BFFC          16      LD  (SAVENT),HL
000711 4711 22D4F2          16      LD  (_DTA),HL
000714 4714 21FFFF          10      LD  HL,0FFFFH
000717 4717 CD354A          17      CALL    ROM_READ
00071A 471A AF               4      XOR A
00071B 471B 32D6F2          13      LD  (FLG_LDIR),A
00071E 471E 3ABEFC          13      LD  A,(RUNBNF)
000721 4721 FE52             7      CP  'R'
000723 4723 2006            12      JR  NZ,RBREAD1
000725 4725 2ADEF2          16      LD  HL,(_BUF_EX)
000728 4728 229DF2          16      LD  (SWC_BLOAD),HL
       472B                     RBREAD1:
       472B                     ROM_NEXT:
00072B 472B 2AF4F2          16      LD  HL,(PARAM1)
00072E 472E 7E               7      LD  A,(HL)
00072F 472F 2B               6      DEC HL
000730 4730 B7               4      OR  A
000731 4731 2805            12      JR  Z,ROM_NEXT1
000733 4733 FE3A             7      CP  ':'
000735 4735 2801            12      JR  Z,ROM_NEXT1
000737 4737 23               6      INC HL
       4738                     ROM_NEXT1:
000738 4738 5D               4      LD  E,L
000739 4739 54               4      LD  D,H
                                
00073A 473A CD284C          17      CALL    SEARCH_END
00073D 473D B7               4      OR  A
00073E 473E 2821            12      JR  Z,REM
       4740                     RN3:                    ;マルチステートメントの処理
000740 4740 7E               7      LD  A,(HL)
                                
000741 4741 FEB5             7      CP  0B5H            ;LOAD
000743 4743 CAB445          10      JP  Z,ROM_LOAD
000746 4746 FE8A             7      CP  08AH            ;RUN
000748 4748 281B            12      JR  Z,ROM_RUN
00074A 474A FEB7             7      CP  0B7H            ;FILES
00074C 474C 2825            12      JR  Z,ROM_FILES
00074E 474E FED6             7      CP  0D6H            ;COPY
000750 4750 CA1548          10      JP  Z,ROM_COPY
000753 4753 FE20             7      CP  020H
000755 4755 2807            12      JR  Z,RN_SP
                                
000757 4757 3E28             7      LD  A,028H          ;JR Z,
000759 4759 32A3F2          13      LD  (SWC_BLOAD_M),A
00075C 475C 7E               7      LD  A,(HL)
00075D 475D C9              10      RET
       475E                     RN_SP:
00075E 475E 23               6      INC HL
00075F 475F 18DF            12      JR  RN3
                                
       4761                     REM:
000761 4761 EB               4      EX  DE,HL
000762 4762 3E8F             7      LD  A,08FH          ;REM
000764 4764 C9              10      RET
                                
       4765                     ROM_RUN:
000765 4765 23               6      INC HL
000766 4766 7E               7      LD  A,(HL)
000767 4767 2B               6      DEC HL
000768 4768 B7               4      OR  A
000769 4769 C4B445          17      CALL    NZ,ROM_LOAD
00076C 476C FE8F             7      CP  08FH            ;REM
00076E 476E 3E8A             7      LD  A,08AH          ;RUN
000770 4770 C0              11      RET NZ
000771 4771 77               7      LD  (HL),A
000772 4772 C9              10      RET
                                
       4773                     ROM_FILES:
000773 4773 CDE347          17      CALL    INIT_PARAM
000776 4776 CDD64A          17      CALL    FILE_B
000779 4779 CD6A53          17      CALL    GET_DISK_BANK_FDRV
00077C 477C 3AC9F2          13      LD  A,(SECSZ_H)
00077F 477F CD2852          17      CALL    IS_BPB1
000782 4782 DA8046          10      JP  C,ERROR_DEVICE_IO_ERROR
000785 4785 3AF9F2          13      LD  A,(FNAME)
000788 4788 FE21             7      CP  021H
00078A 478A 3005            12      JR  NC,RFILES0
00078C 478C 060B             7      LD  B,11
00078E 478E CDBC4B          17      CALL    FILE10
       4791                     RFILES0:
000791 4791 CDC44E          17      CALL    GET_DIR_DAT
       4794                     RFILES1:
000794 4794 CD844C          17      CALL    FILESE
000797 4797 3045            12      JR  NC,RFILES_NOT_MATCH
       4799                     RFILES_DISP:
000799 4799 E5              11      PUSH    HL
00079A 479A 110B00          10      LD  DE,0000BH   ;属性
00079D 479D 19              11      ADD HL,DE
                                #if exists USE_MORMAL32K_OR_ASCII16
00079E 479E CD9843          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
0007A1 47A1 E1              10      POP HL
0007A2 47A2 CB4F             8      BIT 1,A     ;不可視属性
0007A4 47A4 2035            12      JR  NZ,RFILES_NEXT
0007A6 47A6 E5              11      PUSH    HL
0007A7 47A7 0608             7      LD  B,8
0007A9 47A9 CD8C43          17      CALL    MSN
                                #if exists USE_MORMAL32K_OR_ASCII16
0007AC 47AC CD9843          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
0007AF 47AF FE20             7      CP  020H
0007B1 47B1 F5              11      PUSH    AF
0007B2 47B2 3E2E             7      LD  A,'.'
0007B4 47B4 C4E053          17      CALL    NZ,MSG_A
0007B7 47B7 0603             7      LD  B,3
0007B9 47B9 CD8C43          17      CALL    MSN
0007BC 47BC F1              10      POP AF
0007BD 47BD CCE053          17      CALL    Z,MSG_A
0007C0 47C0 3ADDF3          13      LD  A,(CSRX)
0007C3 47C3 47               4      LD  B,A
0007C4 47C4 3AB0F3          13      LD  A,(LINLEN)
0007C7 47C7 90               4      SUB B
0007C8 47C8 FE0C             7      CP  12
0007CA 47CA 3009            12      JR  NC,RFILES2
0007CC 47CC 3E0D             7      LD  A,00DH      ;改行
0007CE 47CE CDE053          17      CALL    MSG_A
0007D1 47D1 3E0A             7      LD  A,00AH
0007D3 47D3 1802            12      JR  RFILES3
       47D5                     RFILES2:
0007D5 47D5 3E20             7      LD  A,020H
       47D7                     RFILES3:
0007D7 47D7 CDE053          17      CALL    MSG_A
0007DA 47DA E1              10      POP HL
       47DB                     RFILES_NEXT:
0007DB 47DB CDA24C          17      CALL    FNEXT
       47DE                     RFILES_NOT_MATCH:
0007DE 47DE 20B4            12      JR  NZ,RFILES1
0007E0 47E0 C32B47          10      JP  ROM_NEXT
                                
       47E3                     INIT_PARAM:
0007E3 47E3 22F2F2          16      LD  (PARAM0),HL
0007E6 47E6 22F4F2          16      LD  (PARAM1),HL
0007E9 47E9 EB               4      EX  DE,HL
0007EA 47EA 32BEFC          13      LD  (RUNBNF),A
0007ED 47ED 3263F6          13      LD  (VALTYP),A
0007F0 47F0 E5              11      PUSH    HL
0007F1 47F1 2AEBF2          16      LD  HL,(_CD)
0007F4 47F4 22F6F2          16      LD  (_CDX),HL
0007F7 47F7 E1              10      POP HL
0007F8 47F8 13               6      INC DE
0007F9 47F9 CDF84B          17      CALL    SPCUT
0007FC 47FC 1A               7      LD  A,(DE)
0007FD 47FD B7               4      OR  A
0007FE 47FE C8              11      RET Z
0007FF 47FF FE3A             7      CP  ':'
000801 4801 C8              11      RET Z
000802 4802 FE28             7      CP  '('
000804 4804 C8              11      RET Z
000805 4805 EB               4      EX  DE,HL
000806 4806 DD21644C        14      LD  IX,FRMEVL
00080A 480A FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00080E 480E CD1C00          17      CALL    _CALSLT
000811 4811 22F4F2          16      LD  (PARAM1),HL
000814 4814 C9              10      RET
                                
       4815                     ROM_COPY:
000815 4815 CDE347          17      CALL    INIT_PARAM
000818 4818 3A63F6          13      LD  A,(VALTYP)
00081B 481B FE03             7      CP  3       ;string
00081D 481D C2D14A          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
000820 4820 CDD64A          17      CALL    FILE_B
000823 4823 CD684C          17      CALL    ROM_OPEN
000826 4826 DA8946          10      JP  C,ERROR_FILE_NOT_FOUND
                                
000829 4829 21DEF2          10      LD  HL,_BUF_W
00082C 482C 22D4F2          16      LD  (_DTA),HL
00082F 482F 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
000832 4832 CD354A          17      CALL    ROM_READ
                                
000835 4835 AF               4      XOR A
000836 4836 32D9F2          13      LD  (_BUF_LO),A     ;PSET
000839 4839 32E6F2          13      LD  (_BUF_O),A      ;向き
                                
00083C 483C 2AF4F2          16      LD  HL,(PARAM1)
       483F                     RCP_PARAM1:
00083F 483F 7E               7      LD  A,(HL)
000840 4840 23               6      INC HL
000841 4841 B7               4      OR  A
000842 4842 CA3847          10      JP  Z,ROM_NEXT1
000845 4845 FE3A             7      CP  ':'
000847 4847 CA3847          10      JP  Z,ROM_NEXT1
00084A 484A FE2C             7      CP  ','
00084C 484C 2012            12      JR  NZ,RCP_PARAM1_
                                
00084E 484E DD212F54        14      LD  IX,FRMQNT
000852 4852 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000856 4856 CD1C00          17      CALL    _CALSLT
000859 4859 7B               4      LD  A,E
00085A 485A 87               4      ADD A,A
00085B 485B 87               4      ADD A,A
00085C 485C 32E6F2          13      LD  (_BUF_O),A
00085F 485F 7E               7      LD  A,(HL)
       4860                     RCP_PARAM1_:
000860 4860 FE28             7      CP  '('
000862 4862 20DB            12      JR  NZ,RCP_PARAM1
000864 4864 DD212F54        14      LD  IX,FRMQNT
000868 4868 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00086C 486C CD1C00          17      CALL    _CALSLT
                                
00086F 486F ED53E2F2        20      LD  (_BUF_X),DE
                                
       4873                     RCP_PARAM2:
000873 4873 23               6      INC HL
000874 4874 7E               7      LD  A,(HL)
000875 4875 FE20             7      CP  020H
000877 4877 28FA            12      JR  Z,RCP_PARAM2
000879 4879 FE2C             7      CP  ','
00087B 487B 28F6            12      JR  Z,RCP_PARAM2
                                
00087D 487D DD212F54        14      LD  IX,FRMQNT
000881 4881 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000885 4885 CD1C00          17      CALL    _CALSLT
                                
000888 4888 3AF6FA          13      LD  A,(ACPAGE)
00088B 488B 57               4      LD  D,A
00088C 488C ED53E4F2        20      LD  (_BUF_Y),DE
       4890                     RCP_PARAM3:
000890 4890 23               6      INC HL
000891 4891 7E               7      LD  A,(HL)
000892 4892 FE20             7      CP  020H
000894 4894 28FA            12      JR  Z,RCP_PARAM3
000896 4896 FE29             7      CP  ')'
000898 4898 28F6            12      JR  Z,RCP_PARAM3
00089A 489A FE2C             7      CP  ','
00089C 489C 2033            12      JR  NZ,RCP_ST
                                
00089E 489E 23               6      INC HL
00089F 489F DD212F54        14      LD  IX,FRMQNT
0008A3 48A3 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0008A7 48A7 CD1C00          17      CALL    _CALSLT
                                
0008AA 48AA 7B               4      LD  A,E
0008AB 48AB 32E5F2          13      LD  (_BUF_P),A
                                
       48AE                     RCP_PARAM4:
0008AE 48AE 7E               7      LD  A,(HL)
0008AF 48AF 23               6      INC HL
0008B0 48B0 FE20             7      CP  020H
0008B2 48B2 28FA            12      JR  Z,RCP_PARAM4
                                
0008B4 48B4 FE2C             7      CP  ','
0008B6 48B6 2019            12      JR  NZ,RCP_ST
                                
0008B8 48B8 7E               7      LD  A,(HL)
0008B9 48B9 0604             7      LD  B,4
0008BB 48BB FEC3             7      CP  0C3H        ;PRESET
0008BD 48BD 280E            12      JR  Z,RCP_LO
0008BF 48BF 05               4      DEC B       ;3
0008C0 48C0 D6F8             7      SUB 0F8H        ;XOR
0008C2 48C2 2809            12      JR  Z,RCP_LO
0008C4 48C4 05               4      DEC B       ;2
0008C5 48C5 3C               4      INC A       ;OR
0008C6 48C6 2805            12      JR  Z,RCP_LO
0008C8 48C8 05               4      DEC B       ;1
0008C9 48C9 3C               4      INC A       ;AND
0008CA 48CA 2801            12      JR  Z,RCP_LO
0008CC 48CC 05               4      DEC B       ;0
                                                ;PSET
       48CD                     RCP_LO:
0008CD 48CD 78               4      LD  A,B
0008CE 48CE 32D9F2          13      LD  (_BUF_LO),A
       48D1                     RCP_ST:
0008D1 48D1 2AC6F6          16      LD  HL,(STREND)
0008D4 48D4 22D4F2          16      LD  (_DTA),HL
0008D7 48D7 EB               4      EX  DE,HL
0008D8 48D8 2100FE          10      LD  HL,-512
0008DB 48DB 39              11      ADD HL,SP
0008DC 48DC AF               4      XOR A
0008DD 48DD ED52            15      SBC HL,DE
0008DF 48DF 3008            12      JR  NC,RCP0
0008E1 48E1 215EF5          10      LD  HL,BUF
0008E4 48E4 22D4F2          16      LD  (_DTA),HL
0008E7 48E7 6F               4      LD  L,A ;0
0008E8 48E8 67               4      LD  H,A ;0
       48E9                     RCP0:
0008E9 48E9 24               4      INC H
0008EA 48EA 22DCF2          16      LD  (_BUF_EN),HL
       48ED                     RCP1:
0008ED 48ED F3               4      DI
0008EE 48EE CDC349          17      CALL    WAIT_VDP
                                
0008F1 48F1 3A0700          13      LD  A,(WRVDP)
0008F4 48F4 4F               4      LD  C,A
0008F5 48F5 0C               4      INC C       ;C := PORT#1's address(WR)
0008F6 48F6 3E24             7      LD  A,36
0008F8 48F8 ED79            12      OUT (C),A
0008FA 48FA 3E91             7      LD  A,080H+17
0008FC 48FC ED79            12      OUT (C),A       ;R#17 := 36
                                
0008FE 48FE 0C               4      INC C
0008FF 48FF 0C               4      INC C       ;C := PORT#3's address(WR)
000900 4900 2AE2F2          16      LD  HL,(_BUF_X)
000903 4903 ED69            12      OUT (C),L       ;R#36 DX
000905 4905 ED61            12      OUT (C),H       ;R#37
000907 4907 2AE4F2          16      LD  HL,(_BUF_Y)
00090A 490A ED69            12      OUT (C),L       ;R#38 DY
00090C 490C ED61            12      OUT (C),H       ;R#39
00090E 490E 2ADEF2          16      LD  HL,(_BUF_W)
000911 4911 ED69            12      OUT (C),L       ;R#40 NX
000913 4913 ED61            12      OUT (C),H       ;R#41
000915 4915 2AE0F2          16      LD  HL,(_BUF_H)
000918 4918 ED69            12      OUT (C),L       ;R#42 NY
00091A 491A ED61            12      OUT (C),H       ;R#43
                                
00091C 491C DD2AAFFC        20      LD  IX,(SCRMOD)
000920 4920 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000923 4923 B7               4      OR  A
000924 4924 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000926 4926 DD7D             9      LD  A,IXL
000928 4928 FE08             7      CP  8
00092A 492A 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
00092C 492C FE06             7      CP  6
00092E 492E 2AE2F2          16      LD  HL,(_BUF_X)
000931 4931 3ADEF2          13      LD  A,(_BUF_W)
000934 4934 2005            12      JR  NZ,SCR57
000936 4936 B5               4      OR  L       ;スクリーン6
000937 4937 E603             7      AND 3
000939 4939 200D            12      JR  NZ,USE_LMMC
       493B                     SCR57:              ;スクリーン5,7
00093B 493B B5               4      OR  L
00093C 493C E601             7      AND 1
00093E 493E 2008            12      JR  NZ,USE_LMMC
       4940                     USE_HMMC:
000940 4940 DD2E08          10      LD  IXL,8
       4943                     USE_HMMC8:
000943 4943 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
000945 4945 32D9F2          13      LD  (_BUF_LO),A
       4948                     USE_LMMC:
000948 4948 110000          10      LD  DE,0
00094B 494B 06FF             7      LD  B,-1
00094D 494D CDEE49          17      CALL    GET_PIXEL
000950 4950 ED79            12      OUT (C),A       ;R#44 first DATA
000952 4952 3AE6F2          13      LD  A,(_BUF_O)
000955 4955 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
000957 4957 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00095A 495A F6B0             7      OR  0B0H        ;R#46 LMMC command
00095C 495C ED79            12      OUT (C),A
                                
00095E 495E FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
000960 4960 0D               4      DEC C
000961 4961 0D               4      DEC C       ;C := PORT#1's address(WR)
000962 4962 3EAC             7      LD  A,080H+44
000964 4964 ED79            12      OUT (C),A
000966 4966 3E91             7      LD  A,080H+17
000968 4968 ED79            12      OUT (C),A       ;R#17 := 44
                                
00096A 496A 3A0600          13      LD  A,(RDVDP)
00096D 496D 3C               4      INC A
00096E 496E FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
000970 4970 3E02             7      LD  A,2
000972 4972 ED79            12      OUT (C),A
000974 4974 3E8F             7      LD  A,08FH
000976 4976 ED79            12      OUT (C),A
000978 4978 3AD9F2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00097B 497B E640             7      AND 040H
00097D 497D 201C            12      JR  NZ,LOOP_HMMC
       497F                     LOOP_COPY:
00097F 497F CDEE49          17      CALL    GET_PIXEL
000982 4982 08               4      EX  AF,AF'
000983 4983 FD4C             9      LD  C,IYH
       4985                     LOOP_COPY1:
000985 4985 ED78            12      IN  A,(C)
000987 4987 0F               4      RRCA            ;RRCAではサインフラグは変化しない
000988 4988 300A            12      JR  NC,EXIT_COPY    ;check CE bit
00098A 498A F28549          10      JP  P,LOOP_COPY1    ;check TR bit
00098D 498D 08               4      EX  AF,AF'
00098E 498E FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
000990 4990 ED79            12      OUT (C),A
000992 4992 18EB            12      JR  LOOP_COPY
                                
       4994                     EXIT_COPY:
000994 4994 CDCB49          17      CALL    GET_STATUS_0
000997 4997 FB               4      EI
000998 4998 C32B47          10      JP  ROM_NEXT
                                
       499B                     LOOP_HMMC:
00099B 499B F3               4      DI          ;必要
00099C 499C FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
00099E 499E 43               4      LD  B,E
00099F 499F 7B               4      LD  A,E
0009A0 49A0 B7               4      OR  A
0009A1 49A1 2802            12      JR  Z,LOOP_HMMC1
0009A3 49A3 EDB3                    OTIR
       49A5                     LOOP_HMMC1:
0009A5 49A5 14               4      INC D
       49A6                     LOOP_HMMC2:
0009A6 49A6 15               4      DEC D
0009A7 49A7 2805            12      JR  Z,LOOP_HMMC3
0009A9 49A9 EDB3                    OTIR
0009AB 49AB C3A649          10      JP  LOOP_HMMC2
       49AE                     LOOP_HMMC3:
0009AE 49AE ED78            12      IN  A,(C)
0009B0 49B0 0F               4      RRCA
0009B1 49B1 30E1            12      JR  NC,EXIT_COPY    ;check CE bit
0009B3 49B3 2ADCF2          16      LD  HL,(_BUF_EN)
0009B6 49B6 CD354A          17      CALL    ROM_READ
0009B9 49B9 EB               4      EX  DE,HL
0009BA 49BA 2AD4F2          16      LD  HL,(_DTA)
0009BD 49BD 7A               4      LD  A,D
0009BE 49BE B3               4      OR  E
0009BF 49BF 20DA            12      JR  NZ,LOOP_HMMC
0009C1 49C1 18C2            12      JR  LOOP_COPY1
                                    
       49C3                     WAIT_VDP:
0009C3 49C3 3E02             7      LD  A,2
0009C5 49C5 CDCC49          17      CALL    GET_STATUS
0009C8 49C8 0F               4      RRCA
0009C9 49C9 38F8            12      JR  C,WAIT_VDP
       49CB                     GET_STATUS_0:
0009CB 49CB AF               4      XOR A
       49CC                     GET_STATUS:
0009CC 49CC C5              11      PUSH    BC
0009CD 49CD ED4B0600        20      LD  BC,(RDVDP)
0009D1 49D1 0C               4      INC C
0009D2 49D2 ED79            12      OUT (C),A
0009D4 49D4 3E8F             7      LD  A,08FH
0009D6 49D6 ED79            12      OUT (C),A
0009D8 49D8 ED78            12      IN  A,(C)
0009DA 49DA C1              10      POP BC
0009DB 49DB C9              10      RET
                                
       49DC                     GET_PIXEL256:
0009DC 49DC 7A               4      LD  A,D
0009DD 49DD B3               4      OR  E
0009DE 49DE 200A            12      JR  NZ,GET_PIXEL1
0009E0 49E0 2ADCF2          16      LD  HL,(_BUF_EN)
0009E3 49E3 CD354A          17      CALL    ROM_READ
0009E6 49E6 EB               4      EX  DE,HL
0009E7 49E7 2AD4F2          16      LD  HL,(_DTA)
       49EA                     GET_PIXEL1:
0009EA 49EA 7E               7      LD  A,(HL)
0009EB 49EB 23               6      INC HL
0009EC 49EC 1B               6      DEC DE
0009ED 49ED C9              10      RET
                                
       49EE                     GET_PIXEL:
0009EE 49EE DD7D             9      LD  A,IXL
0009F0 49F0 FE08             7      CP  8
0009F2 49F2 28E8            12      JR  Z,GET_PIXEL256
0009F4 49F4 04               4      INC B
0009F5 49F5 FE06             7      CP  6
0009F7 49F7 282E            12      JR  Z,GET_PIXEL4
                                
0009F9 49F9 CB40             8      BIT 0,B
0009FB 49FB 20ED            12      JR  NZ,GET_PIXEL1
                                
0009FD 49FD 7A               4      LD  A,D
0009FE 49FE B3               4      OR  E
0009FF 49FF 200A            12      JR  NZ,GET_PIXEL2
                                
000A01 4A01 2ADCF2          16      LD  HL,(_BUF_EN)
000A04 4A04 CD354A          17      CALL    ROM_READ
000A07 4A07 EB               4      EX  DE,HL
000A08 4A08 2AD4F2          16      LD  HL,(_DTA)
                                
       4A0B                     GET_PIXEL2:
000A0B 4A0B 7E               7      LD  A,(HL)
000A0C 4A0C 0F               4      RRCA
000A0D 4A0D 0F               4      RRCA
000A0E 4A0E 0F               4      RRCA
000A0F 4A0F 0F               4      RRCA
000A10 4A10 C9              10      RET
                                
       4A11                     GET_PIXEL3:
000A11 4A11 7A               4      LD  A,D
000A12 4A12 B3               4      OR  E
000A13 4A13 200A            12      JR  NZ,GET_PIXEL5
                                
000A15 4A15 2ADCF2          16      LD  HL,(_BUF_EN)
000A18 4A18 CD354A          17      CALL    ROM_READ
000A1B 4A1B EB               4      EX  DE,HL
000A1C 4A1C 2AD4F2          16      LD  HL,(_DTA)
       4A1F                     GET_PIXEL5:
000A1F 4A1F 7E               7      LD  A,(HL)
000A20 4A20 0F               4      RRCA
000A21 4A21 0F               4      RRCA
000A22 4A22 0F               4      RRCA
000A23 4A23 0F               4      RRCA
000A24 4A24 0F               4      RRCA
000A25 4A25 0F               4      RRCA
000A26 4A26 C9              10      RET
                                
       4A27                     GET_PIXEL4:
000A27 4A27 78               4      LD  A,B
000A28 4A28 E603             7      AND 3   ;+0
000A2A 4A2A 28E5            12      JR  Z,GET_PIXEL3
000A2C 4A2C 3D               4      DEC A   ;+1
000A2D 4A2D 28DC            12      JR  Z,GET_PIXEL2
000A2F 4A2F 3D               4      DEC A   ;+2
000A30 4A30 7E               7      LD  A,(HL)
000A31 4A31 C0              11      RET NZ
000A32 4A32 0F               4      RRCA        ;+3
000A33 4A33 0F               4      RRCA
000A34 4A34 C9              10      RET
                                
       4A35                     ROM_READ:
000A35 4A35 E5              11      PUSH    HL
000A36 4A36 D5              11      PUSH    DE
000A37 4A37 C5              11      PUSH    BC
000A38 4A38 FDE5            15      PUSH    IY
000A3A 4A3A 22F0F2          16      LD  (LEFTX),HL
000A3D 4A3D 2AD4F2          16      LD  HL,(_DTA)
000A40 4A40 22E7F2          16      LD  (DTAX),HL
000A43 4A43 2AF0F2          16      LD  HL,(LEFTX)
                                
000A46 4A46 CDE94C          17      CALL    RBX1
000A49 4A49 3870            12      JR  C,RBRERR1
000A4B 4A4B 79               4      LD  A,C
000A4C 4A4C EB               4      EX  DE,HL
000A4D 4A4D ED52            15      SBC HL,DE       ;CP 0HL,CDE
000A4F 4A4F 19              11      ADD HL,DE
000A50 4A50 DE00             7      SBC A,000H
000A52 4A52 3801            12      JR  C,RBR1
000A54 4A54 EB               4      EX  DE,HL
       4A55                     RBR1:
000A55 4A55 9F               4      SBC A,A
000A56 4A56 E601             7      AND 1
000A58 4A58 32C3F2          13      LD  (_RESULT),A
000A5B 4A5B 7C               4      LD  A,H
000A5C 4A5C B5               4      OR  L
000A5D 4A5D CAB14A          10      JP  Z,RBREND0
                                
000A60 4A60 22D0F2          16      LD  (_LEFT),HL  ;Read record byte
000A63 4A63 22F0F2          16      LD  (LEFTX),HL
                                
000A66 4A66 CD1C4D          17      CALL    RBX2
000A69 4A69 281A            12      JR  Z,RBRB
                                                ;先頭の端数
000A6B 4A6B CD2F4D          17      CALL    RBXA
000A6E 4A6E DAC74A          10      JP  C,RBRERR
000A71 4A71 C5              11      PUSH    BC
000A72 4A72 CD0B44          17      CALL    ROM_LDIR
000A75 4A75 ED53E7F2        20      LD  (DTAX),DE
000A79 4A79 2AF0F2          16      LD  HL,(LEFTX)
000A7C 4A7C D1              10      POP DE
000A7D 4A7D A7               4      AND A
000A7E 4A7E ED52            15      SBC HL,DE
000A80 4A80 22F0F2          16      LD  (LEFTX),HL
000A83 4A83 2829            12      JR  Z,RBREND
                                
       4A85                     RBRB:
000A85 4A85 CD684D          17      CALL    RBXB
000A88 4A88 2818            12      JR  Z,RBRC
       4A8A                     RBRB1:
000A8A 4A8A C5              11      PUSH    BC
000A8B 4A8B D5              11      PUSH    DE
000A8C 4A8C CD194E          17      CALL    CLUST
000A8F 4A8F EB               4      EX  DE,HL
000A90 4A90 ED4BC6F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
000A94 4A94 CD0B44          17      CALL    ROM_LDIR
000A97 4A97 EB               4      EX  DE,HL
000A98 4A98 D1              10      POP DE
000A99 4A99 C1              10      POP BC
000A9A 4A9A CDF64D          17      CALL    GNCL
000A9D 4A9D DAC74A          10      JP  C,RBRERR
000AA0 4AA0 10E8            13      DJNZ    RBRB1
       4AA2                     RBRC:
000AA2 4AA2 CD804D          17      CALL    RBXC
000AA5 4AA5 2807            12      JR  Z,RBREND
                                
000AA7 4AA7 CD194E          17      CALL    CLUST
000AAA 4AAA EB               4      EX  DE,HL
000AAB 4AAB CD0B44          17      CALL    ROM_LDIR
       4AAE                     RBREND:
000AAE 4AAE CD8C4D          17      CALL    RBXEND
       4AB1                     RBREND0:
000AB1 4AB1 FDE1            14      POP IY
000AB3 4AB3 C1              10      POP BC
000AB4 4AB4 D1              10      POP DE
000AB5 4AB5 F1              10      POP AF  ;(HL)
000AB6 4AB6 AF               4      XOR A
000AB7 4AB7 3AC3F2          13      LD  A,(_RESULT)
000ABA 4ABA C9              10      RET
                                
       4ABB                     RBRERR1:
000ABB 4ABB 3E01             7      LD  A,001H
       4ABD                     RBRERR2:
000ABD 4ABD FDE1            14      POP IY
000ABF 4ABF C1              10      POP BC
000AC0 4AC0 D1              10      POP DE
000AC1 4AC1 E1              10      POP HL
000AC2 4AC2 37               4      SCF
000AC3 4AC3 210000          10      LD  HL,0
000AC6 4AC6 C9              10      RET
       4AC7                     RBRERR:
000AC7 4AC7 3EFF             7      LD  A,0FFH
000AC9 4AC9 18F2            12      JR  RBRERR2
                                
       4ACB                     FILE_DD:
000ACB 4ACB E1              10      POP HL
000ACC 4ACC 3E                      DB  03EH
000ACD 4ACD C9              10      RET
000ACE 4ACE 32A3F2          13      LD  (SWC_BLOAD_M),A
       4AD1                     ROM_ORG:
000AD1 4AD1 2AF2F2          16      LD  HL,(PARAM0)
000AD4 4AD4 7E               7      LD  A,(HL)
000AD5 4AD5 C9              10      RET
       4AD6                     FILE_B:
000AD6 4AD6 AF               4      XOR A
000AD7 4AD7 32F8F2          13      LD  (FDRV),A
000ADA 4ADA 1E00             7      LD  E,0
000ADC 4ADC 3A63F6          13      LD  A,(VALTYP)
000ADF 4ADF FE03             7      CP  3       ;string
000AE1 4AE1 C2794B          10      JP  NZ,FILED
                                
000AE4 4AE4 DD21D067        14      LD  IX,FRESTR
000AE8 4AE8 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000AEC 4AEC CD1C00          17      CALL    _CALSLT
000AEF 4AEF E5              11      PUSH    HL
000AF0 4AF0 DDE1            14      POP IX
                                
000AF2 4AF2 DD5E00          19      LD  E,(IX+0)
000AF5 4AF5 DD7E01          19      LD  A,(IX+1)
000AF8 4AF8 DD5602          19      LD  D,(IX+2)
000AFB 4AFB DD62             9      LD  IXH,D
000AFD 4AFD DD6F             9      LD  IXL,A
000AFF 4AFF 7B               4      LD  A,E
       4B00                     FILE_BDOS:
000B00 4B00 FE04             7      CP  4
000B02 4B02 3808            12      JR  C,FILEB1
000B04 4B04 DD7E03          19      LD  A,(IX+3)
000B07 4B07 FE3A             7      CP  ':'
000B09 4B09 28C0            12      JR  Z,FILE_DD
000B0B 4B0B 7B               4      LD  A,E
       4B0C                     FILEB1:
000B0C 4B0C FE02             7      CP  2
000B0E 4B0E 3818            12      JR  C,DEVI1
000B10 4B10 DD7E01          19      LD  A,(IX+1)
000B13 4B13 FE3A             7      CP  ':'
000B15 4B15 2011            12      JR  NZ,DEVI1
000B17 4B17 DD7E00          19      LD  A,(IX+0)        ;DRIVE
000B1A 4B1A CD524C          17      CALL    CAP
000B1D 4B1D D640             7      SUB '@'
000B1F 4B1F DD23            10      INC IX
000B21 4B21 DD23            10      INC IX
000B23 4B23 1D               4      DEC E
000B24 4B24 1D               4      DEC E
000B25 4B25 32F8F2          13      LD  (FDRV),A
       4B28                     DEVI1:
000B28 4B28 DD7E00          19      LD  A,(IX+0)
000B2B 4B2B D65C             7      SUB 05CH        ;\
000B2D 4B2D 2008            12      JR  NZ,NOROOT
000B2F 4B2F 6F               4      LD  L,A
000B30 4B30 67               4      LD  H,A
000B31 4B31 22F6F2          16      LD  (_CDX),HL
000B34 4B34 DD23            10      INC IX
000B36 4B36 1D               4      DEC E
       4B37                     NOROOT:
                                
       4B37                     SETDIR:
000B37 4B37 CD794B          17      CALL    FILED
000B3A 4B3A DD7E00          19      LD  A,(IX+0)
000B3D 4B3D FE5C             7      CP  05CH        ;\
000B3F 4B3F C0              11      RET NZ
000B40 4B40 DD23            10      INC IX
000B42 4B42 1D               4      DEC E
000B43 4B43 3AF9F2          13      LD  A,(FNAME)
000B46 4B46 FE20             7      CP  020H        ;. の処理
000B48 4B48 28ED            12      JR  Z,SETDIR
                                
000B4A 4B4A CD684C          17      CALL    ROM_OPEN
000B4D 4B4D B7               4      OR  A
000B4E 4B4E C0              11      RET NZ
                                
                                #if exists USE_MORMAL32K_OR_ASCII16
000B4F 4B4F D5              11      PUSH    DE
000B50 4B50 2AEDF2          16      LD  HL,(DIRENT1)
000B53 4B53 110B00          10      LD  DE,0000BH   ;属性(アトリビュート)
000B56 4B56 19              11      ADD HL,DE
000B57 4B57 CD9843          17      CALL    RDSLT_ROM
000B5A 4B5A D1              10      POP DE
000B5B 4B5B CB67             8      BIT 4,A     ;ディレクトリ
                                #else
                                    LD  IY,(DIRENT1)
                                    BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                #endif
000B5D 4B5D C8              11      RET Z
000B5E 4B5E CDC04B          17      CALL    FILEI
                                #if exists USE_MORMAL32K_OR_ASCII16
000B61 4B61 D5              11      PUSH    DE
000B62 4B62 2AEDF2          16      LD  HL,(DIRENT1)
000B65 4B65 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000B68 4B68 19              11      ADD HL,DE
000B69 4B69 CD9843          17      CALL    RDSLT_ROM
000B6C 4B6C 23               6      INC HL
000B6D 4B6D 5F               4      LD  E,A
000B6E 4B6E CD9843          17      CALL    RDSLT_ROM
000B71 4B71 57               4      LD  D,A
000B72 4B72 EB               4      EX  DE,HL
000B73 4B73 D1              10      POP DE
                                #else
                                    LD  L,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  H,(IY+01BH)
                                #endif
000B74 4B74 22F6F2          16      LD  (_CDX),HL
000B77 4B77 18BE            12      JR  SETDIR
                                
       4B79                     FILED:
000B79 4B79 CDC04B          17      CALL    FILEI
000B7C 4B7C 21F9F2          10      LD  HL,FNAME
                                
000B7F 4B7F 0608             7      LD  B,8
       4B81                     FILE2:
000B81 4B81 CDCD4B          17      CALL    CCHKF
000B84 4B84 C8              11      RET Z
000B85 4B85 FE2A             7      CP  '*'
000B87 4B87 282E            12      JR  Z,FILE9
000B89 4B89 FE2E             7      CP  '.'
000B8B 4B8B 280C            12      JR  Z,FILE4
000B8D 4B8D 77               7      LD  (HL),A
000B8E 4B8E 23               6      INC HL
000B8F 4B8F 10F0            13      DJNZ    FILE2
                                
       4B91                     FILE3:
000B91 4B91 CDCD4B          17      CALL    CCHKF
000B94 4B94 C8              11      RET Z
000B95 4B95 FE2E             7      CP  '.'
000B97 4B97 20F8            12      JR  NZ,FILE3
                                
       4B99                     FILE4:
000B99 4B99 2101F3          10      LD  HL,FNAME+8
000B9C 4B9C 0603             7      LD  B,3
                                
       4B9E                     FILE4L:
000B9E 4B9E CDCD4B          17      CALL    CCHKF
000BA1 4BA1 C8              11      RET Z
000BA2 4BA2 FE2E             7      CP  '.'
000BA4 4BA4 2008            12      JR  NZ,FILE12
000BA6 4BA6 32F9F2          13      LD  (FNAME),A   ;Parent directory(..)
000BA9 4BA9 32FAF2          13      LD  (FNAME+1),A
000BAC 4BAC 3E20             7      LD  A,020H
       4BAE                     FILE12:
000BAE 4BAE FE2A             7      CP  '*'
000BB0 4BB0 280A            12      JR  Z,FILE10
000BB2 4BB2 77               7      LD  (HL),A
000BB3 4BB3 23               6      INC HL
000BB4 4BB4 10E8            13      DJNZ    FILE4L
000BB6 4BB6 C9              10      RET
                                
       4BB7                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000BB7 4BB7 CDBC4B          17      CALL    FILE10
000BBA 4BBA 18D5            12      JR  FILE3
                                
       4BBC                     FILE10:
000BBC 4BBC 3E3F             7      LD  A,'?'
000BBE 4BBE 1808            12      JR  FILL_MEMORY
       4BC0                     FILEI:              ;名前＋拡張子をスペースで初期化
000BC0 4BC0 3E20             7      LD  A,020H
000BC2 4BC2 01000B          10      LD  BC,11*256   ;C=0にしておく
000BC5 4BC5 21F9F2          10      LD  HL,FNAME
       4BC8                     FILL_MEMORY:            ;HLからBバイトAで埋める
000BC8 4BC8 77               7      LD  (HL),A
000BC9 4BC9 23               6      INC HL
000BCA 4BCA 10FC            13      DJNZ    FILL_MEMORY
000BCC 4BCC C9              10      RET
                                
       4BCD                     CCHKF:
000BCD 4BCD 7B               4      LD  A,E
000BCE 4BCE B7               4      OR  A
000BCF 4BCF C8              11      RET Z
000BD0 4BD0 DD7E00          19      LD  A,(IX+0)
000BD3 4BD3 CDDA4B          17      CALL    CCHK2
000BD6 4BD6 C8              11      RET Z
000BD7 4BD7 C33D4C          10      JP  FKAN
                                
       4BDA                     CCHK2:
000BDA 4BDA 0C               4      INC C
000BDB 4BDB 0D               4      DEC C
000BDC 4BDC C0              11      RET NZ
       4BDD                     CCHK3:              ;ZF=1 で使えない文字
000BDD 4BDD FE2B             7      CP  '+'
000BDF 4BDF C8              11      RET Z
000BE0 4BE0 FE2C             7      CP  ','
000BE2 4BE2 C8              11      RET Z
000BE3 4BE3 FE2F             7      CP  '/'
000BE5 4BE5 C8              11      RET Z
000BE6 4BE6 FE3A             7      CP  ':'
000BE8 4BE8 C8              11      RET Z
000BE9 4BE9 FE3B             7      CP  ';'
000BEB 4BEB C8              11      RET Z
000BEC 4BEC FE3D             7      CP  '='
000BEE 4BEE C8              11      RET Z
000BEF 4BEF FE5C             7      CP  05CH    ;\
000BF1 4BF1 C8              11      RET Z
000BF2 4BF2 FE1F             7      CP  01FH
000BF4 4BF4 D0              11      RET NC
000BF5 4BF5 BF               4      CP  A       ;Z=1
000BF6 4BF6 C9              10      RET
                                
       4BF7                     SS1:
000BF7 4BF7 13               6      INC DE
       4BF8                     SPCUT:              ;スペースをカット
000BF8 4BF8 1A               7      LD  A,(DE)
000BF9 4BF9 FE20             7      CP  020H
000BFB 4BFB 28FA            12      JR  Z,SS1
000BFD 4BFD C9              10      RET
                                
       4BFE                     SCREOF1:
000BFE 4BFE 13               6      INC DE
       4BFF                     SPCUTEX:            ;スペース改行などをカット
000BFF 4BFF 1A               7      LD  A,(DE)
000C00 4C00 FE20             7      CP  020H
000C02 4C02 28FA            12      JR  Z,SCREOF1
000C04 4C04 FE0D             7      CP  00DH
000C06 4C06 28F6            12      JR  Z,SCREOF1
000C08 4C08 FE0A             7      CP  00AH
000C0A 4C0A 28F2            12      JR  Z,SCREOF1
000C0C 4C0C FE1A             7      CP  01AH
000C0E 4C0E 28EE            12      JR  Z,SCREOF1
000C10 4C10 C9              10      RET
                                
       4C11                     GETNUM:
000C11 4C11 210000          10      LD  HL,0
       4C14                     GETNUM1:
000C14 4C14 1A               7      LD  A,(DE)
000C15 4C15 13               6      INC DE
000C16 4C16 D630             7      SUB '0'
000C18 4C18 D8              11      RET C
000C19 4C19 FE0A             7      CP  10
000C1B 4C1B D0              11      RET NC
000C1C 4C1C 4D               4      LD  C,L
000C1D 4C1D 44               4      LD  B,H
000C1E 4C1E 29              11      ADD HL,HL   ;*2
000C1F 4C1F 29              11      ADD HL,HL   ;*4
000C20 4C20 09              11      ADD HL,BC   ;*5
000C21 4C21 29              11      ADD HL,HL   ;*10
000C22 4C22 4F               4      LD  C,A
000C23 4C23 0600             7      LD  B,0
000C25 4C25 09              11      ADD HL,BC
000C26 4C26 18EC            12      JR  GETNUM1
                                
       4C28                     SEARCH_END:
000C28 4C28 7E               7      LD  A,(HL)
       4C29                     SEARCH_END1:
000C29 4C29 23               6      INC HL
000C2A 4C2A B7               4      OR  A
000C2B 4C2B C8              11      RET Z
000C2C 4C2C FE3A             7      CP  ':'
000C2E 4C2E 20F8            12      JR  NZ,SEARCH_END
000C30 4C30 7E               7      LD  A,(HL)
000C31 4C31 FE3A             7      CP  ':'
000C33 4C33 28F4            12      JR  Z,SEARCH_END1
000C35 4C35 C9              10      RET
                                
       4C36                     FKANC:
000C36 4C36 CB41             8      BIT 0,C
000C38 4C38 CC5B4C          17      CALL    Z,CAP2
000C3B 4C3B 1803            12      JR  FKANX
       4C3D                     FKAN:           ;漢字チェック
000C3D 4C3D DD23            10      INC IX
000C3F 4C3F 1D               4      DEC E
       4C40                     FKANX:
000C40 4C40 CB41             8      BIT 0,C
000C42 4C42 CB81             8      RES 0,C
000C44 4C44 C0              11      RET NZ
000C45 4C45 FE80             7      CP  080H
000C47 4C47 D8              11      RET C
000C48 4C48 FEA0             7      CP  0A0H
000C4A 4C4A 3803            12      JR  C,FKAN1
000C4C 4C4C FEE0             7      CP  0E0H
000C4E 4C4E D8              11      RET C
       4C4F                     FKAN1:
000C4F 4C4F 0C               4      INC C
000C50 4C50 A7               4      AND A
000C51 4C51 C9              10      RET
                                
       4C52                     CAP:
000C52 4C52 FE61             7      CP  'a'
000C54 4C54 D8              11      RET C
000C55 4C55 FE7B             7      CP  'z'+1
000C57 4C57 D0              11      RET NC
000C58 4C58 D620             7      SUB 020H
000C5A 4C5A C9              10      RET
       4C5B                     CAP2:
000C5B 4C5B CD524C          17      CALL    CAP
       4C5E                     CAP3:               ;
000C5E 4C5E FE05             7      CP  5
000C60 4C60 2803            12      JR  Z,CAP4
000C62 4C62 FE21             7      CP  021H
000C64 4C64 C9              10      RET
       4C65                     CAP4:
000C65 4C65 3EE5             7      LD  A,0E5H
000C67 4C67 C9              10      RET
                                
       4C68                     ROM_OPEN:
000C68 4C68 CD6A53          17      CALL    GET_DISK_BANK_FDRV
                                
000C6B 4C6B CDC44E          17      CALL    GET_DIR_DAT
000C6E 4C6E D5              11      PUSH    DE
000C6F 4C6F CD844C          17      CALL    FILESE
000C72 4C72 D1              10      POP DE
000C73 4C73 3F               4      CCF
000C74 4C74 D8              11      RET C
000C75 4C75 22EDF2          16      LD  (DIRENT1),HL
000C78 4C78 E5              11      PUSH    HL
000C79 4C79 210000          10      LD  HL,0
000C7C 4C7C 22CAF2          16      LD  (RR_LOW),HL
000C7F 4C7F 22CCF2          16      LD  (RR_HIGH),HL
000C82 4C82 E1              10      POP HL
000C83 4C83 C9              10      RET
                                
       4C84                     FILESE:
       4C84                     FILESE0:
                                #if exists USE_MORMAL32K_OR_ASCII16
000C84 4C84 CD9843          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000C87 4C87 B7               4      OR  A
000C88 4C88 C8              11      RET Z       ;END:ZF=1 CF=0
000C89 4C89 FEE5             7      CP  0E5H
000C8B 4C8B 280D            12      JR  Z,FILESE1
000C8D 4C8D 11F9F2          10      LD  DE,FNAME
000C90 4C90 E5              11      PUSH    HL
000C91 4C91 CDC04C          17      CALL    CPFILE
000C94 4C94 CCE34C          17      CALL    Z,CPFILE2
000C97 4C97 E1              10      POP HL
000C98 4C98 37               4      SCF
000C99 4C99 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4C9A                     FILESE1:
000C9A 4C9A CDA24C          17      CALL    FNEXT
000C9D 4C9D 20E5            12      JR  NZ,FILESE0
000C9F 4C9F F6FF             7      OR  0FFH        ;ZF=0 CF=0
000CA1 4CA1 C9              10      RET
                                
       4CA2                     FNEXT:
000CA2 4CA2 112000          10      LD  DE,020H
000CA5 4CA5 19              11      ADD HL,DE
000CA6 4CA6 ED5BF6F2        20      LD  DE,(_CDX)
000CAA 4CAA 7A               4      LD  A,D
000CAB 4CAB B3               4      OR  E
000CAC 4CAC 2002            12      JR  NZ,FNEXT_SUBDIR
000CAE 4CAE 0D               4      DEC C
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
                                    PUSH    AF      ;※フラグを保存する必要あり
                                    BIT 7,H
                                    JR  Z,CHECK_DIR_PAGE1
                                    LD  A,H
                                    SUB 020H
                                    LD  H,A
                                    LD  A,(_DIR_BANK)
                                    INC A
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_DIR_BANK),A
                                CHECK_DIR_PAGE1:
                                    POP AF
                                #endif
000CAF 4CAF C9              10      RET
                                
       4CB0                     FNEXT_SUBDIR:           ;サブディレクトリ
000CB0 4CB0 0D               4      DEC C
000CB1 4CB1 C0              11      RET NZ
                                
000CB2 4CB2 ED5BF6F2        20      LD  DE,(_CDX)
000CB6 4CB6 CDF64D          17      CALL    GNCL
000CB9 4CB9 EB               4      EX  DE,HL
000CBA 4CBA 22F6F2          16      LD  (_CDX),HL
000CBD 4CBD C3FD4E          10      JP  GET_SUBDIR
                                
       4CC0                     CPFILE:
000CC0 4CC0 C5              11      PUSH    BC
000CC1 4CC1 01000B          10      LD  BC,00B00H
       4CC4                     CPSTR1:
000CC4 4CC4 1A               7      LD  A,(DE)
000CC5 4CC5 FE3F             7      CP  '?'     ;Wild card
000CC7 4CC7 2814            12      JR  Z,CPSTR2
                                #if exists USE_MORMAL32K_OR_ASCII16
000CC9 4CC9 CD9843          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000CCC 4CCC CD364C          17      CALL    FKANC
000CCF 4CCF E5              11      PUSH    HL
000CD0 4CD0 67               4      LD  H,A
000CD1 4CD1 1A               7      LD  A,(DE)
000CD2 4CD2 CB01             4      RLC C
000CD4 4CD4 CD364C          17      CALL    FKANC
000CD7 4CD7 CB09             4      RRC C
000CD9 4CD9 BC               4      CP  H       ;CP (HL),(DE)
000CDA 4CDA E1              10      POP HL
000CDB 4CDB 2004            12      JR  NZ,CPSTR3
       4CDD                     CPSTR2:
000CDD 4CDD 13               6      INC DE
000CDE 4CDE 23               6      INC HL
000CDF 4CDF 10E3            13      DJNZ    CPSTR1
       4CE1                     CPSTR3:
000CE1 4CE1 C1              10      POP BC
000CE2 4CE2 C9              10      RET
                                
       4CE3                     CPFILE2:
                                #if exists USE_MORMAL32K_OR_ASCII16
000CE3 4CE3 CD9843          17      CALL    RDSLT_ROM
                                #else
                                    LD  A,(HL)
                                #endif
000CE6 4CE6 E608             7      AND 008H    ;~0F7H
000CE8 4CE8 C9              10      RET
                                
       4CE9                     RBX1:
000CE9 4CE9 E5              11      PUSH    HL      ;Record byte
                                
000CEA 4CEA ED5BCAF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000CEE 4CEE 3ACDF2          13      LD  A,(RR_HIGH+1)
000CF1 4CF1 4F               4      LD  C,A
                                
000CF2 4CF2 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
000CF5 4CF5 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
000CF8 4CF8 D5              11      PUSH    DE
000CF9 4CF9 2AEDF2          16      LD  HL,(DIRENT1)
000CFC 4CFC 111C00          10      LD  DE,0001CH
000CFF 4CFF 19              11      ADD HL,DE
000D00 4D00 CD9843          17      CALL    RDSLT_ROM
000D03 4D03 23               6      INC HL
000D04 4D04 5F               4      LD  E,A
000D05 4D05 CD9843          17      CALL    RDSLT_ROM
000D08 4D08 23               6      INC HL
000D09 4D09 57               4      LD  D,A
000D0A 4D0A CD9843          17      CALL    RDSLT_ROM
000D0D 4D0D EB               4      EX  DE,HL       ;AHL=File size
000D0E 4D0E D1              10      POP DE
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  L,(IY+01CH) ;AHL=File size
                                    LD  H,(IY+01DH)
                                    LD  A,(IY+01EH)
                                #endif
                                
000D0F 4D0F A7               4      AND A
000D10 4D10 ED52            15      SBC HL,DE
000D12 4D12 99               4      SBC A,C
000D13 4D13 D1              10      POP DE
                                
000D14 4D14 D8              11      RET C
000D15 4D15 4F               4      LD  C,A
000D16 4D16 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000D17 4D17 B2               4      OR  D
000D18 4D18 B3               4      OR  E
000D19 4D19 C0              11      RET NZ
000D1A 4D1A 37               4      SCF
000D1B 4D1B C9              10      RET
                                
       4D1C                     RBX2:
000D1C 4D1C ED4BCBF2        20      LD  BC,(RR_LOW+1)
000D20 4D20 CDA14D          17      CALL    RWXR
000D23 4D23 3AC7F2          13      LD  A,(CLSZ_H)
000D26 4D26 3D               4      DEC A
000D27 4D27 E5              11      PUSH    HL
000D28 4D28 2ACAF2          16      LD  HL,(RR_LOW)
000D2B 4D2B A4               4      AND H
000D2C 4D2C B5               4      OR  L
000D2D 4D2D E1              10      POP HL
000D2E 4D2E C9              10      RET
                                
       4D2F                     RBXA:
000D2F 4D2F D5              11      PUSH    DE
000D30 4D30 CD194E          17      CALL    CLUST
000D33 4D33 ED53D2F2        20      LD  (_DTPS),DE
000D37 4D37 D1              10      POP DE
000D38 4D38 CDF64D          17      CALL    GNCL
000D3B 4D3B D8              11      RET C
000D3C 4D3C ED53CEF2        20      LD  (_CLPS),DE
                                
000D40 4D40 ED4BCAF2        20      LD  BC,(RR_LOW)
000D44 4D44 2AC6F2          16      LD  HL,(CLSZ)
000D47 4D47 7C               4      LD  A,H
000D48 4D48 3D               4      DEC A
000D49 4D49 A0               4      AND B
000D4A 4D4A 47               4      LD  B,A
000D4B 4D4B ED42            15      SBC HL,BC       ;remaining cluster
                                
000D4D 4D4D ED5BF0F2        20      LD  DE,(LEFTX)
000D51 4D51 ED52            15      SBC HL,DE       ;CP HL,DE
000D53 4D53 19              11      ADD HL,DE
000D54 4D54 3801            12      JR  C,RBXA1
000D56 4D56 EB               4      EX  DE,HL
       4D57                     RBXA1:
000D57 4D57 3AC4F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_MORMAL32K_OR_ASCII16
000D5A 4D5A 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000D5D 4D5D E5              11      PUSH    HL
000D5E 4D5E 2AD2F2          16      LD  HL,(_DTPS)
000D61 4D61 09              11      ADD HL,BC
000D62 4D62 ED5BE7F2        20      LD  DE,(DTAX)
000D66 4D66 C1              10      POP BC
000D67 4D67 C9              10      RET
                                
       4D68                     RBXB:
000D68 4D68 2AE7F2          16      LD  HL,(DTAX)
000D6B 4D6B ED5BCEF2        20      LD  DE,(_CLPS)
000D6F 4D6F 3AF1F2          13      LD  A,(LEFTX+1)
000D72 4D72 47               4      LD  B,A
000D73 4D73 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4D76                     RBXB1:
000D76 4D76 1F               4      RRA     ;->CF
000D77 4D77 3804            12      JR  C,RBXB2
000D79 4D79 CB38             8      SRL B   ;B=B/2
000D7B 4D7B 18F9            12      JR  RBXB1
       4D7D                     RBXB2:
000D7D 4D7D 78               4      LD  A,B
000D7E 4D7E B7               4      OR  A
000D7F 4D7F C9              10      RET
                                
       4D80                     RBXC:
000D80 4D80 ED4BF0F2        20      LD  BC,(LEFTX)
000D84 4D84 3AC7F2          13      LD  A,(CLSZ_H)
000D87 4D87 3D               4      DEC A
000D88 4D88 A0               4      AND B
000D89 4D89 47               4      LD  B,A
000D8A 4D8A B1               4      OR  C
000D8B 4D8B C9              10      RET
                                
       4D8C                     RBXEND:
000D8C 4D8C ED5BD0F2        20      LD  DE,(_LEFT)
000D90 4D90 2ACAF2          16      LD  HL,(RR_LOW)
000D93 4D93 3ACDF2          13      LD  A,(RR_HIGH+1)
000D96 4D96 19              11      ADD HL,DE
000D97 4D97 CE00             7      ADC A,0
000D99 4D99 22CAF2          16      LD  (RR_LOW),HL
000D9C 4D9C 32CDF2          13      LD  (RR_HIGH+1),A
000D9F 4D9F EB               4      EX  DE,HL       ;HL=Read byte
000DA0 4DA0 C9              10      RET 
                                
       4DA1                     RWXR:
000DA1 4DA1 3AC7F2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4DA4                     L_RWX:
000DA4 4DA4 1F               4      RRA     ;->CF
000DA5 4DA5 3806            12      JR  C,E_RWX
000DA7 4DA7 CB38             8      SRL B   ;BC=BC/2
000DA9 4DA9 CB19             8      RR  C   ;
000DAB 4DAB 18F7            12      JR  L_RWX
       4DAD                     E_RWX:
000DAD 4DAD 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
000DB0 4DB0 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                
000DB3 4DB3 E5              11      PUSH    HL
000DB4 4DB4 2AEDF2          16      LD  HL,(DIRENT1)
000DB7 4DB7 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000DBA 4DBA 19              11      ADD HL,DE
000DBB 4DBB CD9843          17      CALL    RDSLT_ROM
000DBE 4DBE 23               6      INC HL
000DBF 4DBF 5F               4      LD  E,A
000DC0 4DC0 CD9843          17      CALL    RDSLT_ROM
000DC3 4DC3 23               6      INC HL
000DC4 4DC4 57               4      LD  D,A
000DC5 4DC5 E1              10      POP HL
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  E,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  D,(IY+01BH)
                                #endif
000DC6 4DC6 CD6A53          17      CALL    GET_DISK_BANK_FDRV
       4DC9                     RWX1:
000DC9 4DC9 ED53CEF2        20      LD  (_CLPS),DE
000DCD 4DCD 7A               4      LD  A,D
000DCE 4DCE B3               4      OR  E
000DCF 4DCF 37               4      SCF
000DD0 4DD0 C8              11      RET Z
                                
000DD1 4DD1 78               4      LD  A,B
000DD2 4DD2 B1               4      OR  C
000DD3 4DD3 C8              11      RET Z
                                
000DD4 4DD4 CDF64D          17      CALL    GNCL
000DD7 4DD7 D8              11      RET C
000DD8 4DD8 0B               6      DEC BC
000DD9 4DD9 CD5D4E          17      CALL    ENDCL
000DDC 4DDC 38EB            12      JR  C,RWX1
000DDE 4DDE 37               4      SCF
000DDF 4DDF C9              10      RET
                                
       4DE0                     NCL3:
000DE0 4DE0 CD6A53          17      CALL    GET_DISK_BANK_FDRV
000DE3 4DE3 6B               4      LD  L,E
000DE4 4DE4 62               4      LD  H,D
000DE5 4DE5 CB3C             8      SRL H
000DE7 4DE7 CB1D             8      RR  L
000DE9 4DE9 1F               4      RRA
000DEA 4DEA 19              11      ADD HL,DE
000DEB 4DEB 010060          10      LD  BC,BANK1_ADR
000DEE 4DEE 09              11      ADD HL,BC
000DEF 4DEF ED4BC8F2        20      LD  BC,(SECSZ)
000DF3 4DF3 09              11      ADD HL,BC
000DF4 4DF4 17               4      RLA
000DF5 4DF5 C9              10      RET
                                
       4DF6                     GNCL:
000DF6 4DF6 7A               4      LD  A,D
000DF7 4DF7 B3               4      OR  E
000DF8 4DF8 37               4      SCF
000DF9 4DF9 C8              11      RET Z
000DFA 4DFA C5              11      PUSH    BC
000DFB 4DFB E5              11      PUSH    HL
000DFC 4DFC CDE04D          17      CALL    NCL3
000DFF 4DFF 3809            12      JR  C,GNC1
000E01 4E01 5E               7      LD  E,(HL)
000E02 4E02 23               6      INC HL
000E03 4E03 7E               7      LD  A,(HL)
000E04 4E04 E60F             7      AND 00FH
000E06 4E06 57               4      LD  D,A
000E07 4E07 E1              10      POP HL
000E08 4E08 C1              10      POP BC
000E09 4E09 C9              10      RET
       4E0A                     GNC1:
000E0A 4E0A 7E               7      LD  A,(HL)
000E0B 4E0B 23               6      INC HL
000E0C 4E0C 56               7      LD  D,(HL)
000E0D 4E0D 0604             7      LD  B,4
       4E0F                     GNC1L:
000E0F 4E0F CB3A             8      SRL D
000E11 4E11 1F               4      RRA
000E12 4E12 10FB            13      DJNZ    GNC1L
                                
000E14 4E14 5F               4      LD  E,A
000E15 4E15 E1              10      POP HL
000E16 4E16 C1              10      POP BC
000E17 4E17 A7               4      AND A
000E18 4E18 C9              10      RET
                                
       4E19                     CLUST:
000E19 4E19 EB               4      EX  DE,HL
       4E1A                     CLUST_HL:
000E1A 4E1A 2B               6      DEC HL
000E1B 4E1B 2B               6      DEC HL
000E1C 4E1C C5              11      PUSH    BC
000E1D 4E1D 3AC7F2          13      LD  A,(CLSZ_H)
000E20 4E20 CD9753          17      CALL    MUL_AHL
                                
000E23 4E23 CDDE4E          17      CALL    GET_DIR_POS
000E26 4E26 4F               4      LD  C,A
000E27 4E27 0600             7      LD  B,0
000E29 4E29 09              11      ADD HL,BC
                                
000E2A 4E2A ED4B1160        20      LD  BC,(BANK1_ADR+17)   ;BPB_RootEntCnt
000E2E 4E2E CB38             8      SRL B
000E30 4E30 CB19             8      RR  C           ;/2
000E32 4E32 CB38             8      SRL B
000E34 4E34 CB19             8      RR  C           ;/4
000E36 4E36 CB38             8      SRL B
000E38 4E38 CB19             8      RR  C           ;/8
000E3A 4E3A 09              11      ADD HL,BC
                                #if exists USE_MORMAL32K_OR_ASCII16
000E3B 4E3B 7D               4      LD  A,L
000E3C 4E3C 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
000E3F 4E3F 09              11      ADD HL,BC
000E40 4E40 3013            12      JR  NC,CLUST2
000E42 4E42 4D               4      LD  C,L     ;C=読み出し元
000E43 4E43 29              11      ADD HL,HL   ;64KB→32KB
000E44 4E44 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
000E45 4E45 CD6A53          17      CALL    GET_DISK_BANK_FDRV
000E48 4E48 84               4      ADD A,H
000E49 4E49 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
000E4C 4E4C 32C4F2          13      LD  (_BANK),A
000E4F 4E4F 69               4      LD  L,C     ;C=読み出し元
000E50 4E50 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
000E52 4E52 A5               4      AND L
000E53 4E53 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB
                                    ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
                                    AND L
                                #endif
       4E55                     CLUST2:
000E55 4E55 C660             7      ADD A,high BANK1_ADR
000E57 4E57 67               4      LD  H,A
000E58 4E58 2E00             7      LD  L,0
000E5A 4E5A EB               4      EX  DE,HL
000E5B 4E5B C1              10      POP BC
000E5C 4E5C C9              10      RET
                                
       4E5D                     ENDCL:
000E5D 4E5D 7A               4      LD  A,D ;END CLUSTER
000E5E 4E5E FE0F             7      CP  00FH    ;FAT12の最大値
000E60 4E60 C0              11      RET NZ
000E61 4E61 7B               4      LD  A,E
000E62 4E62 FEF7             7      CP  0F7H
000E64 4E64 C9              10      RET
                                
       4E65                     RB_READ:
000E65 4E65 AF               4      XOR A   ;HLA = HL*128
000E66 4E66 CB3C             8      SRL H
000E68 4E68 CB1D             8      RR  L
000E6A 4E6A 1F               4      RRA
000E6B 4E6B 32CAF2          13      LD  (RR_LOW),A
000E6E 4E6E 22CBF2          16      LD  (RR_MID),HL
000E71 4E71 218000          10      LD  HL,128
                                
000E74 4E74 CD354A          17      CALL    ROM_READ
000E77 4E77 C9              10      RET
                                
       4E78                     GETSEQ:
000E78 4E78 FD6E20          19      LD  L,(IY+32)
000E7B 4E7B FD660C          19      LD  H,(IY+12)
                                
000E7E 4E7E CB25             8      SLA L
                                
000E80 4E80 CB3C             8      SRL H
000E82 4E82 CB1D             8      RR  L
000E84 4E84 C9              10      RET
                                
       4E85                     SETSEQ:
000E85 4E85 F5              11      PUSH    AF
000E86 4E86 3ACAF2          13      LD  A,(RR_LOW)
000E89 4E89 2ACBF2          16      LD  HL,(RR_MID)
                                
000E8C 4E8C CDA34E          17      CALL    SSQ1
                                
000E8F 4E8F 29              11      ADD HL,HL
000E90 4E90 CB3D             8      SRL L
000E92 4E92 FD7520          19      LD  (IY+32),L
000E95 4E95 FD740C          19      LD  (IY+12),H
000E98 4E98 F1              10      POP AF
000E99 4E99 C9              10      RET
                                
       4E9A                     GETSIZE:
000E9A 4E9A FD7E10          19      LD  A,(IY+16)
000E9D 4E9D FD6E11          19      LD  L,(IY+17)
000EA0 4EA0 FD6612          19      LD  H,(IY+18)
       4EA3                     SSQ1:
000EA3 4EA3 87               4      ADD A,A
000EA4 4EA4 ED6A            15      ADC HL,HL
000EA6 4EA6 B7               4      OR  A
000EA7 4EA7 C8              11      RET Z
000EA8 4EA8 23               6      INC HL
000EA9 4EA9 C9              10      RET
                                
       4EAA                     SET_FCB:
000EAA 4EAA D5              11      PUSH    DE
000EAB 4EAB FDE1            14      POP IY
000EAD 4EAD FD7E1C          19      LD  A,(IY+28)
000EB0 4EB0 FEFF             7      CP  0FFH
000EB2 4EB2 200C            12      JR  NZ,POPAF_SCF_FF_RET
000EB4 4EB4 E5              11      PUSH    HL
000EB5 4EB5 FD6E1A          19      LD  L,(IY+26)
000EB8 4EB8 FD661B          19      LD  H,(IY+27)
000EBB 4EBB 22CEF2          16      LD  (_CLPS),HL
000EBE 4EBE E1              10      POP HL
000EBF 4EBF C9              10      RET
                                
       4EC0                     POPAF_SCF_FF_RET:
000EC0 4EC0 F1              10      POP AF
000EC1 4EC1 37               4      SCF
000EC2 4EC2 9F               4      SBC A,A
000EC3 4EC3 C9              10      RET
                                
       4EC4                     GET_DIR_DAT:
000EC4 4EC4 2AF6F2          16      LD  HL,(_CDX)
000EC7 4EC7 7C               4      LD  A,H
000EC8 4EC8 B5               4      OR  L
000EC9 4EC9 2032            12      JR  NZ,GET_SUBDIR
000ECB 4ECB CDDE4E          17      CALL    GET_DIR_POS
000ECE 4ECE C660             7      ADD A,high BANK1_ADR
000ED0 4ED0 2E00             7      LD  L,0
000ED2 4ED2 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_MORMAL32K_OR_ASCII16
                                #else
                                    CALL    CHECK_DIR_PAGE
                                #endif
000ED3 4ED3 3AC5F2          13      LD  A,(_BANK1)
000ED6 4ED6 32EFF2          13      LD  (_DIR_BANK),A
                                
000ED9 4ED9 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000EDC 4EDC 4F               4      LD  C,A
000EDD 4EDD C9              10      RET
                                
       4EDE                     GET_DIR_POS:                ;ルートディレクトリ
000EDE 4EDE CD6A53          17      CALL    GET_DISK_BANK_FDRV
000EE1 4EE1 32C5F2          13      LD  (_BANK1),A
000EE4 4EE4 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000EE7 4EE7 47               4      LD  B,A
000EE8 4EE8 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000EEB 4EEB 4F               4      LD  C,A
000EEC 4EEC 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4EEF                     GET_DIR_POS1:
000EEF 4EEF 81               4      ADD A,C
000EF0 4EF0 10FD            13      DJNZ    GET_DIR_POS1
                                
000EF2 4EF2 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec
000EF6 4EF6 37               4      SCF     ;無限ループ回避
       4EF7                     L_MDP:
000EF7 4EF7 CB18             8      RR  B   ;->CF
000EF9 4EF9 D8              11      RET C
000EFA 4EFA 87               4      ADD A,A
000EFB 4EFB 18FA            12      JR  L_MDP
                                
       4EFD                     GET_SUBDIR:             ;サブディレクトリ
000EFD 4EFD CD1A4E          17      CALL    CLUST_HL
000F00 4F00 EB               4      EX  DE,HL
000F01 4F01 3AC4F2          13      LD  A,(_BANK)
000F04 4F04 32EFF2          13      LD  (_DIR_BANK),A
000F07 4F07 3AC7F2          13      LD  A,(CLSZ_H)
000F0A 4F0A 87               4      ADD A,A     ;*2
000F0B 4F0B 87               4      ADD A,A     ;*4
000F0C 4F0C 87               4      ADD A,A     ;*8
000F0D 4F0D 4F               4      LD  C,A
000F0E 4F0E C9              10      RET
                                
       4F0F                     STATEMENT:
000F0F 4F0F 117C51          10      LD  DE,STR_CHDIR
000F12 4F12 CD6251          17      CALL    CPPROCNM
000F15 4F15 2812            12      JR  Z,_CHDIR
000F17 4F17 118251          10      LD  DE,STR_CHDRV
000F1A 4F1A CD6251          17      CALL    CPPROCNM
000F1D 4F1D 281C            12      JR  Z,_CHDRV
000F1F 4F1F 118851          10      LD  DE,STR_RAMDISK
000F22 4F22 CD6251          17      CALL    CPPROCNM
000F25 4F25 2829            12      JR  Z,_RAMDISK
000F27 4F27 37               4      SCF
000F28 4F28 C9              10      RET
       4F29                     _CHDIR:
000F29 4F29 7E               7      LD  A,(HL)
000F2A 4F2A FE28             7      CP  '('
000F2C 4F2C 37               4      SCF
000F2D 4F2D C0              11      RET NZ
000F2E 4F2E CDE347          17      CALL    INIT_PARAM
000F31 4F31 CDD64A          17      CALL    FILE_B
000F34 4F34 CD644F          17      CALL    ROM_CD
000F37 4F37 D0              11      RET NC
000F38 4F38 C38946          10      JP  ERROR_FILE_NOT_FOUND
                                
       4F3B                     _CHDRV:
000F3B 4F3B 7E               7      LD  A,(HL)
000F3C 4F3C FE28             7      CP  '('
000F3E 4F3E 37               4      SCF
000F3F 4F3F C0              11      RET NZ
000F40 4F40 CDE347          17      CALL    INIT_PARAM
000F43 4F43 E5              11      PUSH    HL
000F44 4F44 CDD64A          17      CALL    FILE_B
000F47 4F47 E1              10      POP HL
000F48 4F48 23               6      INC HL
000F49 4F49 3AF8F2          13      LD  A,(FDRV)
000F4C 4F4C 3D               4      DEC A
000F4D 4F4D C3D055          10      JP  _SYS0EX1
                                
       4F50                     _RAMDISK:
000F50 4F50 7E               7      LD  A,(HL)
000F51 4F51 FE28             7      CP  '('
000F53 4F53 37               4      SCF
000F54 4F54 C0              11      RET NZ
000F55 4F55 23               6      INC HL
000F56 4F56 DD212F54        14      LD  IX,FRMQNT
000F5A 4F5A FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000F5E 4F5E CD1C00          17      CALL    _CALSLT
                                ;   LD  A,(HOKVLD)  ;bit0: 拡張 BIOSの存在
                                ;   CPL
                                ;   AND 1
                                ;   LD  A,D
                                ;   OR  E
                                ;   JP  NZ,ERROR_INTERNAL_ERROR
                                ;   PUSH    HL      ;EXTBIOもDISK BIOSで初期化してそう
                                ;   XOR A
                                ;   LD  DE,0401H    ;D=マッパサポートルチン(4) E=機能番号(1)
                                ;   CALL    EXTBIO
                                ;   POP HL
                                ;   OR  A
                                ;   JP  Z,ERROR_INTERNAL_ERROR
000F61 4F61 23               6      INC HL
000F62 4F62 AF               4      XOR A
000F63 4F63 C9              10      RET
                                
       4F64                     ROM_CD:
000F64 4F64 3AF9F2          13      LD  A,(FNAME)
000F67 4F67 FE20             7      CP  020H
000F69 4F69 2835            12      JR  Z,CD1
000F6B 4F6B CD684C          17      CALL    ROM_OPEN
000F6E 4F6E D8              11      RET C
                                #if exists USE_MORMAL32K_OR_ASCII16
000F6F 4F6F D5              11      PUSH    DE
000F70 4F70 2AEDF2          16      LD  HL,(DIRENT1)
000F73 4F73 110B00          10      LD  DE,0000BH   ;属性(アトリビュート)
000F76 4F76 19              11      ADD HL,DE
000F77 4F77 CD9843          17      CALL    RDSLT_ROM
000F7A 4F7A D1              10      POP DE
000F7B 4F7B CB67             8      BIT 4,A     ;ディレクトリ
000F7D 4F7D CA8946          10      JP  Z,ERROR_FILE_NOT_FOUND
000F80 4F80 D5              11      PUSH    DE
000F81 4F81 2AEDF2          16      LD  HL,(DIRENT1)
000F84 4F84 111A00          10      LD  DE,0001AH   ;ファイルの先頭クラスタ
000F87 4F87 19              11      ADD HL,DE
000F88 4F88 CD9843          17      CALL    RDSLT_ROM
000F8B 4F8B 23               6      INC HL
000F8C 4F8C 5F               4      LD  E,A
000F8D 4F8D CD9843          17      CALL    RDSLT_ROM
000F90 4F90 57               4      LD  D,A
000F91 4F91 EB               4      EX  DE,HL
000F92 4F92 D1              10      POP DE
                                #else
                                    LD  IY,(DIRENT1)
                                    BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
                                    JP  Z,ERROR_FILE_NOT_FOUND
                                    LD  L,(IY+01AH) ;ファイルの先頭クラスタ
                                    LD  H,(IY+01BH)
                                #endif
       4F93                     CD2:
000F93 4F93 22EBF2          16      LD  (_CD),HL
000F96 4F96 2AF4F2          16      LD  HL,(PARAM1)
       4F99                     CD_SKIP:
000F99 4F99 7E               7      LD  A,(HL)
000F9A 4F9A 23               6      INC HL
000F9B 4F9B FE21             7      CP  021H
000F9D 4F9D 38FA            12      JR  C,CD_SKIP
000F9F 4F9F C9              10      RET
       4FA0                     CD1:
000FA0 4FA0 2AF6F2          16      LD  HL,(_CDX)
000FA3 4FA3 18EE            12      JR  CD2
                                
       4FA5                     GET_BASIC_FCB:
000FA5 4FA5 D5              11      PUSH    DE
000FA6 4FA6 23               6      INC HL  ;+1
000FA7 4FA7 5E               7      LD  E,(HL)  ;FCB[1]
000FA8 4FA8 23               6      INC HL  ;+2
000FA9 4FA9 56               7      LD  D,(HL)  ;FCB[2]
000FAA 4FAA 23               6      INC HL  ;+3
000FAB 4FAB ED53EDF2        20      LD  (DIRENT1),DE
                                            ;FCB[3] backup char
000FAF 4FAF 23               6      INC HL  ;+4
                                            ;FCB[4]
000FB0 4FB0 23               6      INC HL  ;+5
000FB1 4FB1 7E               7      LD  A,(HL)  ;FCB[5]
000FB2 4FB2 23               6      INC HL  ;+6
000FB3 4FB3 32EFF2          13      LD  (_DIR_BANK),A
000FB6 4FB6 5E               7      LD  E,(HL)  ;FCB[6]
000FB7 4FB7 23               6      INC HL  ;+7
000FB8 4FB8 56               7      LD  D,(HL)  ;FCB[7]
000FB9 4FB9 23               6      INC HL  ;+8
000FBA 4FBA ED53CAF2        20      LD  (RR_LOW),DE
000FBE 4FBE 7E               7      LD  A,(HL)  ;FCB[8]
000FBF 4FBF 23               6      INC HL  ;+9
000FC0 4FC0 32CCF2          13      LD  (RR_HIGH),A
000FC3 4FC3 22D4F2          16      LD  (_DTA),HL   ;FCB[9]
000FC6 4FC6 D1              10      POP DE
000FC7 4FC7 C9              10      RET
                                
       4FC8                     SET_BASIC_FCB:
000FC8 4FC8 E5              11      PUSH    HL
000FC9 4FC9 2A64F8          16      LD  HL,(PTRFIL)
000FCC 4FCC 23               6      INC HL  ;+1
000FCD 4FCD D5              11      PUSH    DE
000FCE 4FCE ED5BEDF2        20      LD  DE,(DIRENT1)
000FD2 4FD2 73               7      LD  (HL),E  ;FCB[1]
000FD3 4FD3 23               6      INC HL  ;+2
000FD4 4FD4 72               7      LD  (HL),D  ;FCB[2]
000FD5 4FD5 23               6      INC HL  ;+3
000FD6 4FD6 77               7      LD  (HL),A  ;FCB[3] backup char ハンドリング必要
000FD7 4FD7 23               6      INC HL  ;+4
                                            ;FCB[4] 変更しない
000FD8 4FD8 23               6      INC HL  ;+5
000FD9 4FD9 3AEFF2          13      LD  A,(_DIR_BANK)
000FDC 4FDC 77               7      LD  (HL),A  ;FCB[5]
000FDD 4FDD 23               6      INC HL  ;+6
000FDE 4FDE ED5BCAF2        20      LD  DE,(RR_LOW)
000FE2 4FE2 73               7      LD  (HL),E  ;FCB[6]
000FE3 4FE3 23               6      INC HL  ;+7
000FE4 4FE4 72               7      LD  (HL),D  ;FCB[7]
000FE5 4FE5 23               6      INC HL  ;+8
000FE6 4FE6 3ACCF2          13      LD  A,(RR_HIGH)
000FE9 4FE9 77               7      LD  (HL),A  ;FCB[8]
000FEA 4FEA D1              10      POP DE
000FEB 4FEB E1              10      POP HL
000FEC 4FEC C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_18:BACKUP
                                ;in
                                ;   C : backup charactor
                                ;   HL: FBC pointer
                                ;out
       4FED                     DEVICE_18_BACKUP:
000FED 4FED D5              11      PUSH    DE
000FEE 4FEE E5              11      PUSH    HL
000FEF 4FEF 110300          10      LD  DE,3
000FF2 4FF2 19              11      ADD HL,DE
000FF3 4FF3 71               7      LD  (HL),C
000FF4 4FF4 E1              10      POP HL
000FF5 4FF5 D1              10      POP DE
000FF6 4FF6 C9              10      RET
                                
       4FF7                     DEVICE_CHECK:
000FF7 4FF7 23               6      INC HL
000FF8 4FF8 7E               7      LD  A,(HL)
000FF9 4FF9 2B               6      DEC HL
000FFA 4FFA B7               4      OR  A
000FFB 4FFB C8              11      RET Z
000FFC 4FFC 119051          10      LD  DE,STR_ROM
000FFF 4FFF CD6251          17      CALL    CPPROCNM
001002 5002 2802            12      JR  Z,DEVICE_OK
001004 5004 37               4      SCF
001005 5005 C9              10      RET
       5006                     DEVICE_OK:
001006 5006 AF               4      XOR A
001007 5007 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_0:open
                                ;in
                                ;   A : 0
                                ;   C : receive buffer size ?
                                ;   E : open mode
                                ;   HL: FCB pointer
                                ;out
                                ;   CF: 0=OK ,1=ERROR
                                ;note:
                                ;
                                ; FCB
                                ; +00: OPEN MODE
                                ; +01: 対象ファイルのディレクトリエントリのアドレスL
                                ; +02: 対象ファイルのディレクトリエントリのアドレスH
                                ; +03: backup charactor buffer
                                ; +04: device ID (FF=CAS,FE=LPT,FD=CRT,FC=?,other=ROM-SLOT)
                                ; +05: 対象ディレクトリのバンク
                                ; +06: ランダムレコードL
                                ; +07: ランダムレコードM
                                ; +08: ランダムレコードH
                                ; +09: バッファ
                                
       5008                     DEVICE_0_OPEN:
001008 5008 7B               4      LD  A,E
001009 5009 FE02             7      CP  2       ;FOR OUTPUT
00100B 500B 281B            12      JR  Z,OPEN2
00100D 500D D5              11      PUSH    DE
00100E 500E E5              11      push    hl
                                ;
00100F 500F 3E01             7      LD  A,1     ;ドライブA
001011 5011 32F8F2          13      LD  (FDRV),A
001014 5014 2166F8          10      LD  HL,FILNAM
001017 5017 11F9F2          10      LD  DE,FNAME
00101A 501A 010B00          10      LD  BC,8+3
00101D 501D CD4D57          17      CALL    INIT_FILE1
001020 5020 CD684C          17      CALL    ROM_OPEN
001023 5023 DA8946          10      JP  C,ERROR_FILE_NOT_FOUND
001026 5026 E1              10      pop hl
001027 5027 D1              10      POP DE
       5028                     OPEN2:
001028 5028 2264F8          16      ld  (PTRFIL),hl ;ストアしないとエラーになる
00102B 502B 73               7      ld  (hl),e  ;FCB[0] ;open type : 合わせないとエラーになる
00102C 502C AF               4      XOR A
00102D 502D 32F0F2          13      LD  (LEFTX),A
001030 5030 CDC84F          17      CALL    SET_BASIC_FCB
001033 5033 7B               4      ld  a,e
001034 5034 FE08             7      cp  8
001036 5036 3F               4      ccf
001037 5037 C9              10      ret
                                
       5038                     DEVICE_2_CLOSE:
001038 5038 AF               4      XOR A
                                ;   LD  (HL),A
001039 5039 6F               4      LD  L,A
00103A 503A 67               4      LD  H,A
00103B 503B 2264F8          16      LD  (PTRFIL),HL
00103E 503E C9              10      RET
                                
       503F                     DEVICE_ENTRY:
00103F 503F FE08             7      CP  8
001041 5041 2826            12      JR  Z,DEVICE_8_SIN
001043 5043 3C               4      INC A
001044 5044 28B1            12      JR  Z,DEVICE_CHECK:
001046 5046 3D               4      DEC A
001047 5047 28BF            12      JR  Z,DEVICE_0_OPEN
001049 5049 FE0E             7      CP  14
00104B 504B 2860            12      JR  Z,DEVICE_14_EOF
00104D 504D FE04             7      CP  4
00104F 504F 2834            12      JR  Z,DEVICE_4_RANDOM
001051 5051 FE0A             7      CP  10
001053 5053 2850            12      JR  Z,DEVICE_10_LOC
001055 5055 FE0C             7      CP  12
001057 5057 2878            12      JR  Z,DEVICE_12_LOF
001059 5059 FE02             7      CP  2
00105B 505B 2890            12      JR  Z,DEVICE_18_BACKUP  
00105D 505D FE02             7      CP  2
00105F 505F 28D7            12      JR  Z,DEVICE_2_CLOSE
001061 5061 FE06             7      CP  6
001063 5063 2802            12      JR  Z,DEVICE_6_SOUT
001065 5065 37               4      SCF
001066 5066 C9              10      RET
                                
       5067                     DEVICE_6_SOUT:
001067 5067 AF               4      XOR A
001068 5068 C9              10      RET
                                
       5069                     DEVICE_8_SIN:
001069 5069 CDA54F          17      CALL    GET_BASIC_FCB
00106C 506C 210100          10      LD  HL,1
00106F 506F CD354A          17      CALL    ROM_READ
001072 5072 7C               4      LD  A,H
001073 5073 B5               4      OR  L
001074 5074 280D            12      JR  Z,CCF_RET
001076 5076 2AD4F2          16      LD  HL,(_DTA)
001079 5079 7E               7      LD  A,(HL)
00107A 507A F5              11      PUSH    AF
00107B 507B CDC84F          17      CALL    SET_BASIC_FCB
00107E 507E F1              10      POP AF
00107F 507F FE0A             7      CP  00AH
001081 5081 C8              11      RET Z   ;ZF=separate
                                ;   CP  01AH
                                ;   JR  Z,SCF_RET
001082 5082 37               4      SCF     ;
       5083                     CCF_RET:
001083 5083 3F               4      CCF     ;ZF=0 CF=0にしたい
001084 5084 C9              10      RET
                                
                                ;--------------------------------------
                                ;FUNC_4:RANDOM
                                ;in
                                ;   A : 4
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
       5085                     DEVICE_4_RANDOM:
001085 5085 D5              11      PUSH    DE
001086 5086 CDA54F          17      CALL    GET_BASIC_FCB
001089 5089 DDE5            15      PUSH    IX
00108B 508B DD218A2F        14      LD  IX,FRCINT
00108F 508F FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001093 5093 CDB1F2          17      CALL    CAL_MP
001096 5096 DDE1            14      POP IX
001098 5098 2AF8F7          16      LD  HL,(DACDAT)
00109B 509B 22CAF2          16      LD  (RR_LOW),HL
00109E 509E AF               4      XOR A
00109F 509F CDC84F          17      CALL    SET_BASIC_FCB
0010A2 50A2 D1              10      POP DE
0010A3 50A3 AF               4      XOR A
0010A4 50A4 C9              10      RET
                                
                                ;FUNC_10:LOC
                                ;in
                                ;   A : 10
                                ;out
                                ;   DAC    : value of received bytes
                                ;   VALTYP : DAC type
       50A5                     DEVICE_10_LOC:
0010A5 50A5 CDA54F          17      CALL    GET_BASIC_FCB
0010A8 50A8 2ACAF2          16      LD  HL,(RR_LOW)
0010AB 50AB 1844            12      JR  RETURN_TYPE8_AHL
                                
                                ;--------------------------------------
                                ;FUNC_14:EOF
                                ;in
                                ;   A : 14
                                ;out
                                ;   DAC    : value of EOF value (EOF=-1)
                                ;   VALTYP : DAC type
       50AD                     DEVICE_14_EOF:
0010AD 50AD CDA54F          17      CALL    GET_BASIC_FCB
0010B0 50B0 CDE94C          17      CALL    RBX1
0010B3 50B3 3810            12      JR  C,DEVICE_14_EOF1
0010B5 50B5 210100          10      LD  HL,1
0010B8 50B8 CD354A          17      CALL    ROM_READ
0010BB 50BB 2AD4F2          16      LD  HL,(_DTA)
0010BE 50BE 7E               7      LD  A,(HL)
0010BF 50BF FE1A             7      CP  01AH
0010C1 50C1 37               4      SCF
0010C2 50C2 2801            12      JR  Z,DEVICE_14_EOF1
0010C4 50C4 3F               4      CCF
       50C5                     DEVICE_14_EOF1:
0010C5 50C5 9F               4      SBC A,A
0010C6 50C6 6F               4      LD  L,A
0010C7 50C7 67               4      LD  H,A
       50C8                     return_type2_hl:
0010C8 50C8 22F8F7          16      ld  (DACDAT),hl
0010CB 50CB 3E02             7      ld  a,2
0010CD 50CD 3263F6          13      ld  (VALTYP),a
0010D0 50D0 C9              10      ret
                                
                                ;--------------------------------------
                                ;FUNC_16:FPOS
                                ;in
                                ;   unknown
                                ;out
                                ;   unknown
                                ;note:
                                ;   illegal function call
                                
                                ;--------------------------------------
                                ;FUNC_12:LOF
                                ;in
                                ;   A : 12
                                ;out
                                ;   DAC    : value of LOC+RSIQLN
                                ;   VALTYP : DAC type
       50D1                     DEVICE_12_LOF:
0010D1 50D1 CDA54F          17      CALL    GET_BASIC_FCB
                                
0010D4 50D4 3AEFF2          13      LD  A,(_DIR_BANK)
                                #if exists USE_MORMAL32K_OR_ASCII16
0010D7 50D7 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
0010DA 50DA D5              11      PUSH    DE
0010DB 50DB 2AEDF2          16      LD  HL,(DIRENT1)
0010DE 50DE 111C00          10      LD  DE,0001CH
0010E1 50E1 19              11      ADD HL,DE
0010E2 50E2 CD9843          17      CALL    RDSLT_ROM
0010E5 50E5 23               6      INC HL
0010E6 50E6 5F               4      LD  E,A
0010E7 50E7 CD9843          17      CALL    RDSLT_ROM
0010EA 50EA 23               6      INC HL
0010EB 50EB 57               4      LD  D,A
0010EC 50EC CD9843          17      CALL    RDSLT_ROM
0010EF 50EF EB               4      EX  DE,HL       ;AHL=File size
0010F0 50F0 D1              10      POP DE
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  IY,(DIRENT1)
                                    LD  L,(IY+01CH) ;AHL=File size
                                    LD  H,(IY+01DH)
                                    LD  A,(IY+01EH)
                                #endif
       50F1                     RETURN_TYPE8_AHL:
0010F1 50F1 B7               4      OR  A
0010F2 50F2 2004            12      JR  NZ,RT8AHL1
0010F4 50F4 CB7C             8      BIT 7,H
0010F6 50F6 28D0            12      JR  Z,return_type2_hl
       50F8                     RT8AHL1:
0010F8 50F8 E5              11      PUSH    HL
0010F9 50F9 29              11      ADD HL,HL
0010FA 50FA 8F               4      ADC A,A
0010FB 50FB 32F8F7          13      LD  (DACDAT),A
0010FE 50FE 3E00             7      LD  A,0
001100 5100 8F               4      ADC A,A
001101 5101 32F9F7          13      LD  (DACDAT+1),A
                                
001104 5104 3E02             7      LD  A,2
001106 5106 3263F6          13      LD  (VALTYP),A
001109 5109 DD213A30        14      LD  IX,FRCDBL
00110D 510D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001111 5111 CDB1F2          17      CALL    CAL_MP
                                
001114 5114 215A51          10      LD  HL,DBL32768
001117 5117 1147F8          10      LD  DE,ARG
00111A 511A 010800          10      LD  BC,8
00111D 511D EDB0                    LDIR
                                
00111F 511F DD21E627        14      LD  IX,DECMUL
001123 5123 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001127 5127 CDB1F2          17      CALL    CAL_MP
                                
00112A 512A 21F6F7          10      LD  HL,DAC
00112D 512D 1147F8          10      LD  DE,ARG
001130 5130 010800          10      LD  BC,8
001133 5133 EDB0                    LDIR
                                
001135 5135 E1              10      POP HL
001136 5136 22F8F7          16      LD  (DACDAT),HL
                                
001139 5139 3E02             7      LD  A,2
00113B 513B 3263F6          13      LD  (VALTYP),A
00113E 513E DD213A30        14      LD  IX,FRCDBL
001142 5142 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001146 5146 CDB1F2          17      CALL    CAL_MP
                                
001149 5149 DD219A26        14      LD  IX,DECADD
00114D 514D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
001151 5151 CDB1F2          17      CALL    CAL_MP
                                
001154 5154 3E08             7      LD  A,8
001156 5156 3263F6          13      LD  (VALTYP),A
001159 5159 C9              10      RET
                                
       515A                     DBL32768:
00115A 515A 4532768000000000        DB  045H,032H,076H,080H,0,0,0,0
                                
       5162                     CPPROCNM:
001162 5162 E5              11      PUSH    HL
001163 5163 2189FD          10      LD  HL,PROCNM
       5166                     CPPROCNM1:
001166 5166 1A               7      LD  A,(DE)
001167 5167 13               6      INC DE
001168 5168 BE               7      CP  (HL)
001169 5169 23               6      INC HL
00116A 516A 2003            12      JR  NZ,CPPROCNM2
00116C 516C B7               4      OR  A
00116D 516D 20F7            12      JR  NZ,CPPROCNM1
       516F                     CPPROCNM2:
00116F 516F E1              10      POP HL
001170 5170 C9              10      RET
                                
       5171                     WILDCARD:
001171 5171 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       517C                     STR_CHDIR:
00117C 517C 434844495200            DB  "CHDIR",0
       5182                     STR_CHDRV:
001182 5182 434844525600            DB  "CHDRV",0
       5188                     STR_RAMDISK:
001188 5188 52414D4449534B00        DB  "RAMDISK",0
       5190                     STR_ROM:
001190 5190 524F4D00                DB  "ROM",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       5194                     ERROR_WRITE_PROTECTED:
001194 5194 3E00             7      LD  A,0     ;Write protected
001196 5196 C9              10      RET
       5197                     DISKIO:
001197 5197 38FB            12      JR  C,ERROR_WRITE_PROTECTED
001199 5199 48               4      LD  C,B
00119A 519A CD7453          17      CALL    GET_DISK_BANK
       519D                     SETMAP1:        
00119D 519D E5              11      PUSH    HL
       519E                     DISKIO1:
00119E 519E C5              11      PUSH    BC      ;B=残りのセクタ数
00119F 519F D5              11      PUSH    DE      ;DE=セクタ番号
0011A0 51A0 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
0011A1 51A1 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
0011A2 51A2 F5              11      PUSH    AF
0011A3 51A3 3AC9F2          13      LD  A,(SECSZ_H)
0011A6 51A6 CD9753          17      CALL    MUL_AHL
0011A9 51A9 F1              10      POP AF
                                #if exists USE_MORMAL32K_OR_ASCII16
0011AA 51AA 7D               4      LD  A,L
0011AB 51AB C5              11      PUSH    BC
0011AC 51AC 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
0011AF 51AF 09              11      ADD HL,BC
0011B0 51B0 C1              10      POP BC
0011B1 51B1 3013            12      JR  NC,DISKIO2
0011B3 51B3 4D               4      LD  C,L     ;C=読み出し元
0011B4 51B4 29              11      ADD HL,HL   ;64KB→32KB
0011B5 51B5 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
0011B6 51B6 CD6A53          17      CALL    GET_DISK_BANK_FDRV
0011B9 51B9 84               4      ADD A,H
0011BA 51BA 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
0011BD 51BD 32C4F2          13      LD  (_BANK),A
0011C0 51C0 69               4      LD  L,C     ;C=読み出し元
0011C1 51C1 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
0011C3 51C3 A5               4      AND L
0011C4 51C4 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL       ;64KB→32KB
                                    ADD HL,HL       ;32KB→16KB
                                    ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  A,C     ;C=読み出し元
                                    AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       51C6                     DISKIO2:
0011C6 51C6 C660             7      ADD A,high BANK1_ADR
0011C8 51C8 67               4      LD  H,A
0011C9 51C9 ED4BC8F2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
0011CD 51CD 69               4      LD  L,C     ;C=0
0011CE 51CE CD0B44          17      CALL    ROM_LDIR
0011D1 51D1 EB               4      EX  DE,HL
0011D2 51D2 F1              10      POP AF
0011D3 51D3 D1              10      POP DE
0011D4 51D4 13               6      INC DE
0011D5 51D5 C1              10      POP BC
0011D6 51D6 10C6            13      DJNZ    DISKIO1
0011D8 51D8 41               4      LD  B,C
                                
0011D9 51D9 E1              10      POP HL
0011DA 51DA AF               4      XOR A
                                
0011DB 51DB FB               4      EI
0011DC 51DC C9              10      RET
                                
       51DD                     DSKCHG:
0011DD 51DD CD1652          17      CALL    IS_BPB
0011E0 51E0 3824            12      JR  C,NOTREADY
0011E2 51E2 3A23FB          13      LD  A,(DRVTBL+2)
0011E5 51E5 B7               4      OR  A
0011E6 51E6 201A            12      JR  NZ,DSKCHG1
0011E8 51E8 3A21FB          13      LD  A,(DRVTBL)
0011EB 51EB FE02             7      CP  2
0011ED 51ED 2013            12      JR  NZ,DSKCHG1
0011EF 51EF CD1652          17      CALL    IS_BPB
0011F2 51F2 300E            12      JR  NC,DSKCHG1
0011F4 51F4 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
0011F6 51F6 3221FB          13      LD  (DRVTBL),A
0011F9 51F9 3223FB          13      LD  (DRVTBL+2),A
0011FC 51FC 3A48F3          13      LD  A,(MASTERS)
0011FF 51FF 3224FB          13      LD  (DRVTBL+3),A
       5202                     DSKCHG1:
001202 5202 AF               4      XOR A
001203 5203 0601             7      LD  B,1
001205 5205 C9              10      RET
       5206                     NOTREADY:
001206 5206 3E02             7      LD  A,2
001208 5208 37               4      SCF
001209 5209 C9              10      RET
                                
       520A                     NO_BPB:
00120A 520A E1              10      POP HL
00120B 520B 23               6      INC HL
00120C 520C 119D53          10      LD  DE,DPB2DD
00120F 520F 011200          10      LD  BC,DPB2DD_E-DPB2DD
001212 5212 EDB0                    LDIR
001214 5214 AF               4      XOR A
001215 5215 C9              10      RET
                                
       5216                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
001216 5216 CD7453          17      CALL    GET_DISK_BANK
                                
001219 5219 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
00121C 521C FE01             7      CP  1
00121E 521E D8              11      RET C
                                
00121F 521F 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
001222 5222 C6FF             7      ADD A,0FFH
001224 5224 D8              11      RET C
                                
001225 5225 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       5228                     IS_BPB1:
001228 5228 FE01             7      CP  1
00122A 522A C8              11      RET Z
00122B 522B FE02             7      CP  2
00122D 522D C8              11      RET Z
00122E 522E FE04             7      CP  4
001230 5230 C8              11      RET Z
001231 5231 37               4      SCF
001232 5232 C9              10      RET
                                
       5233                     GETDPB:
001233 5233 E5              11      PUSH    HL
001234 5234 CD7453          17      CALL    GET_DISK_BANK
                                
001237 5237 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
00123A 523A B7               4      OR  A
00123B 523B 28CD            12      JR  Z,NO_BPB
00123D 523D DDE1            14      POP IX
00123F 523F DD7701          19      LD  (IX+1),A        ;MEDIA
                                
001242 5242 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
001245 5245 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
001248 5248 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
00124B 524B DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
00124E 524E 87               4      ADD A,A
00124F 524F 87               4      ADD A,A
001250 5250 87               4      ADD A,A
001251 5251 3D               4      DEC A
001252 5252 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
001255 5255 06FF             7      LD  B,-1
001257 5257 A7               4      AND A           ;無限ループ阻止
       5258                     GETDPB1:
001258 5258 04               4      INC B
001259 5259 1F               4      RRA
00125A 525A 38FC            12      JR  C,GETDPB1
00125C 525C DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
00125F 525F 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
001262 5262 3D               4      DEC A
001263 5263 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
001266 5266 A7               4      AND A           ;無限ループ阻止
001267 5267 06FF             7      LD  B,-1
       5269                     GETDPB2:
001269 5269 04               4      INC B
00126A 526A 1F               4      RRA
00126B 526B 38FC            12      JR  C,GETDPB2
00126D 526D 04               4      INC B
00126E 526E DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
001271 5271 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
001274 5274 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
001277 5277 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
00127A 527A 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
00127D 527D DD770A          19      LD  (IX+10),A       ;FATCNT
                                
001280 5280 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
001283 5283 DD770B          19      LD  (IX+11),A       ;MAXENT
                                
001286 5286 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
00128A 528A DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
00128D 528D DD460A          19      LD  B,(IX+10)       ;FATCNT
001290 5290 210000          10      LD  HL,0
       5293                     GETDPB3:
001293 5293 19              11      ADD HL,DE
001294 5294 10FD            13      DJNZ    GETDPB3
       5296                     GETDPB4:
001296 5296 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
001299 5299 DD5609          19      LD  D,(IX+9)        ;FIRFAT
00129C 529C 19              11      ADD HL,DE
00129D 529D DD7511          19      LD  (IX+17),L       ;FIRDIR
0012A0 52A0 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
0012A3 52A3 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0012A6 52A6 87               4      ADD A,A
0012A7 52A7 87               4      ADD A,A
0012A8 52A8 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       52AB                     GETDPB5:
0012AB 52AB CB3B             8      SRL E
0012AD 52AD 1F               4      RRA
0012AE 52AE 30FB            12      JR  NC,GETDPB5
0012B0 52B0 1600             7      LD  D,0
0012B2 52B2 19              11      ADD HL,DE
0012B3 52B3 DD750C          19      LD  (IX+12),L       ;FIRREC
0012B6 52B6 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
0012B9 52B9 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
0012BC 52BC DD5E0C          19      LD  E,(IX+12)       ;FIRREC
0012BF 52BF DD560D          19      LD  D,(IX+13)       ;FIRREC
0012C2 52C2 A7               4      AND A
0012C3 52C3 ED52            15      SBC HL,DE
                                
0012C5 52C5 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
0012C8 52C8 3C               4      INC A
0012C9 52C9 37               4      SCF             ;無限ループ阻止
       52CA                     GETDPB6:
0012CA 52CA 1F               4      RRA
0012CB 52CB 3806            12      JR  C,GETDPB7
0012CD 52CD CB3C             8      SRL H
0012CF 52CF CB1D             8      RR  L
0012D1 52D1 18F7            12      JR  GETDPB6
       52D3                     GETDPB7:
0012D3 52D3 23               6      INC HL
0012D4 52D4 DD750E          19      LD  (IX+14),L       ;MAXCLUS
0012D7 52D7 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       52DA                     GETDPBD1:
0012DA 52DA DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
0012DD 52DD E6FC             7      AND 0FCH
0012DF 52DF C8              11      RET Z
                                
0012E0 52E0 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
0012E4 52E4 37               4      SCF
0012E5 52E5 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
0012E9 52E9 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
0012EC 52EC DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
0012F0 52F0 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
0012F4 52F4 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
0012F8 52F8 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
0012FC 52FC DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
001300 5300 DDCB1126        23      SLA (IX+17)         ;FIRDIR
001304 5304 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
001308 5308 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
00130B 530B DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
00130E 530E DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001311 5311 87               4      ADD A,A
001312 5312 87               4      ADD A,A
001313 5313 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       5316                     GETDPBD5:
001316 5316 CB3B             8      SRL E
001318 5318 1F               4      RRA
001319 5319 30FB            12      JR  NC,GETDPBD5
00131B 531B 1600             7      LD  D,0
00131D 531D 19              11      ADD HL,DE
00131E 531E DD750C          19      LD  (IX+12),L       ;FIRREC
001321 5321 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001324 5324 18B4            12      JR  GETDPBD1
                                
       5326                     CHOICE:
001326 5326 210000          10      LD  HL,0
001329 5329 C9              10      RET
                                
       532A                     DSKFMT:
00132A 532A AF               4      XOR A
00132B 532B 37               4      SCF
       532C                     DSKSTP:
00132C 532C C9              10      RET
                                
       532D                     BASENT:
00132D 532D 2A74F6          16      LD  HL,(STKTOP)
001330 5330 3A40F3          13      LD  A,(REBOOT)
001333 5333 C6FF             7      ADD A,0FFH
001335 5335 3811            12      JR  C,REBOOT1
001337 5337 21AF53          10      LD  HL,AUTOEXEC
00133A 533A 11F8F2          10      LD  DE,FDRV
00133D 533D 010C00          10      LD  BC,1+8+3
001340 5340 EDB0                    LDIR
001342 5342 CD684C          17      CALL    ROM_OPEN
001345 5345 D4D345          17      CALL    NC,ROM_LOAD1
       5348                     REBOOT1:
001348 5348 21BB53          10      LD  HL,CMD_RUN
00134B 534B 111FF4          10      LD  DE,KBUF
00134E 534E 010B00          10      LD  BC,CMD_RUN_E-CMD_RUN
001351 5351 D5              11      PUSH    DE
001352 5352 EDB0                    LDIR
001354 5354 3004            12      JR  NC,REBOOT2
001356 5356 AF               4      XOR A
001357 5357 3227F4          13      LD  (KBUF+CMD_CLEAR_E-CMD_RUN),A
       535A                     REBOOT2:
00135A 535A E1              10      POP HL
00135B 535B FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00135F 535F DD210146        14      LD  IX,NEWSTT
001363 5363 C31C00          10      JP  _CALSLT
                                
       5366                     GETSLT:
001366 5366 3A22FB          13      LD  A,(DRVTBL+1)
001369 5369 C9              10      RET
                                
       536A                     GET_DISK_BANK_FDRV:
00136A 536A 3AF8F2          13      LD  A,(FDRV)
00136D 536D D601             7      SUB 1
00136F 536F 3003            12      JR  NC,GET_DISK_BANK
001371 5371 3AEAF2          13      LD  A,(_DVSW)
       5374                     GET_DISK_BANK:
001374 5374 FE07             7      CP  7       ;H:
001376 5376 2801            12      JR  Z,SET_DISK_BANK_A
001378 5378 B7               4      OR  A       ;A=DRIVE
       5379                     SET_DISK_BANK_A:
001379 5379 3E01             7      LD  A,DISK_BANK
00137B 537B 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
00137D 537D 3AE9F2          13      LD  A,(B_DRIVE)
                                #endif
       5380                     SET_DISK_BANK:
                                #if exists USE_MORMAL32K_OR_ASCII16
001380 5380 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
001383 5383 F5              11      PUSH    AF
001384 5384 E5              11      PUSH    HL
001385 5385 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
001388 5388 22C8F2          16      LD  (SECSZ),HL
00138B 538B 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
00138E 538E CD9753          17      CALL    MUL_AHL
001391 5391 22C6F2          16      LD  (CLSZ),HL
001394 5394 E1              10      POP HL
001395 5395 F1              10      POP AF
001396 5396 C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       5397                     MUL_AHL:
001397 5397 37               4      SCF     ;無限ループ回避
       5398                     MUL_AHL1:
001398 5398 1F               4      RRA     ;->CF
001399 5399 D8              11      RET C
00139A 539A 29              11      ADD HL,HL
00139B 539B 18FB            12      JR  MUL_AHL1
                                
       539D                     DPB2DD:
00139D 539D F9                      DB  0F9H    ;MEDIA
00139E 539E 0002                    DW  00200H  ;SECSIZ
0013A0 53A0 0F                      DB  00FH    ;DIRMSK
0013A1 53A1 04                      DB  004H    ;DIRSHFT
0013A2 53A2 01                      DB  001H    ;CLUSMSK
0013A3 53A3 02                      DB  002H    ;CLUSSHFT
0013A4 53A4 0100                    DW  00001H  ;FIRFAT
0013A6 53A6 02                      DB  002H    ;FATCNT
0013A7 53A7 70                      DB  070H    ;MAXENT
0013A8 53A8 0E00                    DW  0000EH  ;FIRREC
0013AA 53AA CA02                    DW  002CAH  ;MAXCLUS
0013AC 53AC 03                      DB  003H    ;FATSIZ
0013AD 53AD 0700                    DW  0007H   ;FIRDIR
       53AF                     DPB2DD_E:
                                
       53AF                     AUTOEXEC:
0013AF 53AF 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       53BB                     CMD_RUN:
0013BB 53BB 3A920FC82C0C            DB  03AH,092H,00FH,200,',',00CH ;CLEAR200,&HF280
                                #if exists USE_MORMAL32K_OR_ASCII16
0013C1 53C1 80F2                    DW  0F280H
                                #else
                                    DW  0F240H
                                #endif
       53C3                     CMD_CLEAR_E:
0013C3 53C3 3A8A00                  DB  03AH,08AH,0         ;RUN
       53C6                     CMD_RUN_E:
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       53C6                     POP_HL_ERROR:
0013C6 53C6 E1              10      POP     HL
       53C7                     _ERROR:
0013C7 53C7 0600             7      LD  B,0
0013C9 53C9 A7               4      AND A
0013CA 53CA C9              10      RET
                                
       53CB                     ROM_BDOS:
0013CB 53CB E5              11      PUSH    HL
0013CC 53CC 79               4      LD  A,C
0013CD 53CD 87               4      ADD A,A
0013CE 53CE 38F7            12      JR  C,_ERROR
0013D0 53D0 6F               4      LD  L,A
0013D1 53D1 265F             7      LD  H,high STABLE
0013D3 53D3 7E               7      LD  A,(HL)
0013D4 53D4 2C               4      INC L
0013D5 53D5 66               7      LD  H,(HL)
0013D6 53D6 6F               4      LD  L,A
0013D7 53D7 E3              19      EX  (SP),HL
0013D8 53D8 79               4      LD  A,C
0013D9 53D9 C9              10      RET
                                
       53DA                     _PRINT:
       53DA                     PRINT:
0013DA 53DA 7B               4      LD  A,E
0013DB 53DB 1803            12      JR  MSG_A
                                
       53DD                     _SYS01:     ;(BDOS)コンソール入力
0013DD 53DD CD5454          17      CALL    _SYS07
       53E0                     MSG_A:
0013E0 53E0 FE03             7      CP  3
0013E2 53E2 2814            12      JR  Z,MSG_BR
       53E4                     MSGA1:
0013E4 53E4 F5              11      PUSH    AF
0013E5 53E5 C5              11      PUSH    BC
0013E6 53E6 D5              11      PUSH    DE
0013E7 53E7 E5              11      PUSH    HL
0013E8 53E8 DDE5            15      PUSH    IX
0013EA 53EA DD21A200        14      LD  IX,CHPUT
0013EE 53EE CDD642          17      CALL    CALSLT_R
0013F1 53F1 DDE1            14      POP IX
0013F3 53F3 E1              10      POP HL
0013F4 53F4 D1              10      POP DE
0013F5 53F5 C1              10      POP BC
       53F6                     MSGA2:
0013F6 53F6 F1              10      POP AF
0013F7 53F7 C9              10      RET
       53F8                     MSG_BR:
0013F8 53F8 F5              11      PUSH    AF
0013F9 53F9 3ADDF3          13      LD  A,(CSRX)
0013FC 53FC FE02             7      CP  2
0013FE 53FE 38F6            12      JR  C,MSGA2
001400 5400 F1              10      POP AF
       5401                     MSG_CR:
001401 5401 F5              11      PUSH    AF
001402 5402 3E0D             7      LD  A,00DH
001404 5404 CDE453          17      CALL    MSGA1
001407 5407 3E0A             7      LD  A,00AH
001409 5409 CDE453          17      CALL    MSGA1
00140C 540C F1              10      POP AF
00140D 540D C9              10      RET
                                
       540E                     _SYS02:     ;(BDOS)コンソール出力
00140E 540E CD2954          17      CALL    BREAK
001411 5411 1805            12      JR  PRINTX
                                
       5413                     _SYS06:     ;(BDOS)コンソール直接入出力
001413 5413 7B               4      LD  A,E
001414 5414 3C               4      INC A
001415 5415 CA6854          10      JP  Z,_INKEY
       5418                     PRINTX:
001418 5418 C3DA53          10      JP  _PRINT
                                
       541B                     _SYS08:     ;(BDOS)エコーなしコンソール入力
00141B 541B CD5454          17      CALL    _SYS07
00141E 541E FE03             7      CP  3
001420 5420 CC2954          17      CALL    Z,_BREAK
001423 5423 FE13             7      CP  013H        ;CTRL+S
001425 5425 C0              11      RET NZ
       5426                     PAUSE:
001426 5426 CD4054          17      CALL    KEYBC
                                
       5429                     _BREAK:
       5429                     BREAK:
001429 5429 F5              11      PUSH    AF
00142A 542A C5              11      PUSH    BC
00142B 542B D5              11      PUSH    DE
00142C 542C E5              11      PUSH    HL
00142D 542D DDE5            15      PUSH    IX
00142F 542F DD21B700        14      LD  IX,BREAKX
001433 5433 CDD642          17      CALL    CALSLT_R
001436 5436 DDE1            14      POP IX
001438 5438 E1              10      POP HL
001439 5439 D1              10      POP DE
00143A 543A C1              10      POP BC
00143B 543B DC2954          17      CALL    C,_BREAK
00143E 543E F1              10      POP AF
00143F 543F C9              10      RET
       5440                     KEYBC:
001440 5440 F5              11      PUSH    AF
001441 5441 C5              11      PUSH    BC
001442 5442 D5              11      PUSH    DE
001443 5443 E5              11      PUSH    HL
001444 5444 DDE5            15      PUSH    IX
001446 5446 DD215601        14      LD  IX,KILBUF
00144A 544A CDD642          17      CALL    CALSLT_R
00144D 544D DDE1            14      POP IX
00144F 544F E1              10      POP HL
001450 5450 D1              10      POP DE
001451 5451 C1              10      POP BC
001452 5452 F1              10      POP AF
001453 5453 C9              10      RET
                                
       5454                     _SYS07:
       5454                     FLGET:
001454 5454 C5              11      PUSH    BC
001455 5455 D5              11      PUSH    DE
001456 5456 E5              11      PUSH    HL
001457 5457 DDE5            15      PUSH    IX
001459 5459 DD219F00        14      LD  IX,CHGET
00145D 545D CDD642          17      CALL    CALSLT_R
001460 5460 DDE1            14      POP IX
001462 5462 E1              10      POP HL
001463 5463 D1              10      POP DE
001464 5464 C1              10      POP BC
001465 5465 FE03             7      CP  3
001467 5467 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       5468                     _INKEY:
       5468                     INKEY:
001468 5468 CD0255          17      CALL    CPM_CONST
00146B 546B C8              11      RET Z
00146C 546C 18E6            12      JR  FLGET
                                
       546E                     _SYS0A:     ;(BDOS)文字列入力
00146E 546E C5              11      PUSH    BC
00146F 546F E5              11      PUSH    HL
001470 5470 D5              11      PUSH    DE
001471 5471 CD9A54          17      CALL    GETL
001474 5474 111FF4          10      LD  DE,KBUF
001477 5477 E1              10      POP HL
001478 5478 E5              11      PUSH    HL
001479 5479 0E00             7      LD  C,0
00147B 547B 3004            12      JR  NC,SAX0
00147D 547D 23               6      INC HL
00147E 547E 23               6      INC HL
00147F 547F 1808            12      JR  SAX4
       5481                     SAX0:
001481 5481 46               7      LD  B,(HL)
001482 5482 23               6      INC HL
       5483                     SAX1:
001483 5483 23               6      INC HL
001484 5484 1A               7      LD  A,(DE)
001485 5485 13               6      INC DE
001486 5486 B7               4      OR  A
001487 5487 2004            12      JR  NZ,SAX2
       5489                     SAX4:
001489 5489 360D            10      LD  (HL),00DH
00148B 548B 1804            12      JR  SAX3
       548D                     SAX2:
00148D 548D 77               7      LD  (HL),A
00148E 548E 0C               4      INC C
00148F 548F 10F2            13      DJNZ    SAX1
       5491                     SAX3:
001491 5491 D1              10      POP DE
001492 5492 79               4      LD  A,C
001493 5493 13               6      INC DE
001494 5494 12               7      LD  (DE),A
001495 5495 1B               6      DEC DE
001496 5496 E1              10      POP HL
001497 5497 C1              10      POP BC
001498 5498 A7               4      AND A
001499 5499 C9              10      RET
       549A                     GETL:
00149A 549A DDE5            15      PUSH    IX
00149C 549C FDE5            15      PUSH    IY
                                
00149E 549E 2ADCF3          16      LD  HL,(CSRY)
0014A1 54A1 22CAFB          16      LD  (FSTPOS),HL
       54A4                     GETL1:
0014A4 54A4 CD1B54          17      CALL    _SYS08
0014A7 54A7 FE09             7      CP  9
0014A9 54A9 2008            12      JR  NZ,GETL1V
0014AB 54AB 211FF4          10      LD  HL,KBUF
0014AE 54AE CD6D43          17      CALL    MSX
0014B1 54B1 18F1            12      JR  GETL1
       54B3                     GETL1V:
0014B3 54B3 5F               4      LD  E,A
0014B4 54B4 FE08             7      CP  8
0014B6 54B6 CC5055          17      CALL    Z,CTRL02
0014B9 54B9 FE20             7      CP  020H
0014BB 54BB D47C55          17      CALL    NC,INSERT
0014BE 54BE CDE453          17      CALL    MSGA1
                                
0014C1 54C1 7B               4      LD  A,E
0014C2 54C2 FE0D             7      CP  00DH
0014C4 54C4 20DE            12      JR  NZ,GETL1
                                
0014C6 54C6 111FF4          10      LD  DE,KBUF
0014C9 54C9 3AB0F3          13      LD  A,(LINLEN)
0014CC 54CC 47               4      LD  B,A
0014CD 54CD CD5C57          17      CALL    ZERO_MEMORY_DE
                                
0014D0 54D0 2ACAFB          16      LD  HL,(FSTPOS)
0014D3 54D3 3ADCF3          13      LD  A,(CSRY)
0014D6 54D6 6F               4      LD  L,A
0014D7 54D7 E5              11      PUSH    HL
0014D8 54D8 CDAD55          17      CALL    LOC0
0014DB 54DB 4D               4      LD  C,L
0014DC 54DC 44               4      LD  B,H
0014DD 54DD E1              10      POP HL
0014DE 54DE 3AB0F3          13      LD  A,(LINLEN)
0014E1 54E1 94               4      SUB H
0014E2 54E2 3D               4      DEC A
0014E3 54E3 5F               4      LD  E,A
0014E4 54E4 211FF4          10      LD  HL,KBUF
       54E7                     GETL2:
0014E7 54E7 CD4055          17      CALL    _SCRN
0014EA 54EA 03               6      INC BC
0014EB 54EB 77               7      LD  (HL),A
0014EC 54EC 23               6      INC HL
0014ED 54ED 1D               4      DEC E
0014EE 54EE 20F7            12      JR  NZ,GETL2
0014F0 54F0 CD0154          17      CALL    MSG_CR
                                
0014F3 54F3 FDE1            14      POP IY
0014F5 54F5 DDE1            14      POP IX
       54F7                     GETL3:
0014F7 54F7 2B               6      DEC HL
0014F8 54F8 7E               7      LD  A,(HL)
0014F9 54F9 FE21             7      CP  021H
0014FB 54FB D0              11      RET NC
0014FC 54FC 3600            10      LD  (HL),0
0014FE 54FE 15               4      DEC D
0014FF 54FF 20F6            12      JR  NZ,GETL3
001501 5501 C9              10      RET
                                
       5502                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       5502                     CONSTX:
       5502                     CPM_CONST:
001502 5502 C5              11      PUSH    BC
001503 5503 D5              11      PUSH    DE
001504 5504 E5              11      PUSH    HL
001505 5505 DDE5            15      PUSH    IX
001507 5507 DD219C00        14      LD  IX,CHSNS
00150B 550B CDD642          17      CALL    CALSLT_R
00150E 550E DDE1            14      POP IX
001510 5510 E1              10      POP HL
001511 5511 D1              10      POP DE
001512 5512 C1              10      POP BC
001513 5513 C9              10      RET
                                
       5514                     _SYS2A:     ;(BDOS)日付の獲得
001514 5514 AF               4      XOR A
001515 5515 57               4      LD  D,A
001516 5516 5F               4      LD  E,A
001517 5517 67               4      LD  H,A
001518 5518 6F               4      LD  L,A
001519 5519 C9              10      RET
                                
       551A                     _SYS2C:     ;(BDOS)時刻の獲得
00151A 551A AF               4      XOR A
00151B 551B 57               4      LD  D,A
00151C 551C 5F               4      LD  E,A
00151D 551D 67               4      LD  H,A
00151E 551E 6F               4      LD  L,A
00151F 551F C9              10      RET
                                
       5520                     POS:
001520 5520 F5              11      PUSH    AF
001521 5521 2ADCF3          16      LD  HL,(CSRY)
001524 5524 7D               4      LD  A,L
001525 5525 6C               4      LD  L,H
001526 5526 67               4      LD  H,A
001527 5527 2C               4      INC L
001528 5528 24               4      INC H
001529 5529 F1              10      POP AF
00152A 552A C9              10      RET
                                
       552B                     LOC:
00152B 552B F5              11      PUSH    AF
00152C 552C E5              11      PUSH    HL
00152D 552D 7D               4      LD  A,L
00152E 552E 6C               4      LD  L,H
00152F 552F 67               4      LD  H,A
001530 5530 2D               4      DEC L
001531 5531 25               4      DEC H
001532 5532 DDE5            15      PUSH    IX
001534 5534 DD21C600        14      LD  IX,POSIT
001538 5538 CDD642          17      CALL    CALSLT_R
00153B 553B DDE1            14      POP IX
00153D 553D E1              10      POP HL
00153E 553E F1              10      POP AF
00153F 553F C9              10      RET
                                
       5540                     _SCRN:
       5540                     SCRN:
001540 5540 E5              11      PUSH    HL
001541 5541 DDE5            15      PUSH    IX
                                
001543 5543 69               4      LD  L,C
001544 5544 60               4      LD  H,B
001545 5545 DD214A00        14      LD  IX,RDVRM
001549 5549 CDD642          17      CALL    CALSLT_R
                                
00154C 554C DDE1            14      POP IX
00154E 554E E1              10      POP HL
00154F 554F C9              10      RET
                                
       5550                     CTRL02:
001550 5550 F5              11      PUSH    AF
001551 5551 D5              11      PUSH    DE
001552 5552 2ADCF3          16      LD  HL,(CSRY)
001555 5555 3AB0F3          13      LD  A,(LINLEN)
001558 5558 4F               4      LD  C,A
001559 5559 94               4      SUB H   ;CSRX
00155A 555A C602             7      ADD A,2
00155C 555C 47               4      LD  B,A ;カーソルより右の文字数
00155D 555D 61               4      LD  H,C ;LINLEN
00155E 555E C5              11      PUSH    BC
00155F 555F CDAD55          17      CALL    LOC0
001562 5562 C1              10      POP BC
                                
001563 5563 1620             7      LD  D,020H
       5565                     C8X1:
001565 5565 DD214A00        14      LD  IX,RDVRM
001569 5569 CDD642          17      CALL    CALSLT_R
00156C 556C 4F               4      LD  C,A
00156D 556D 7A               4      LD  A,D
00156E 556E DD214D00        14      LD  IX,WRTVRM
001572 5572 CDD642          17      CALL    CALSLT_R
001575 5575 2B               6      DEC HL
001576 5576 51               4      LD  D,C
001577 5577 10EC            13      DJNZ    C8X1
001579 5579 D1              10      POP DE
00157A 557A F1              10      POP AF
00157B 557B C9              10      RET
                                
       557C                     INSERT:
00157C 557C F5              11      PUSH    AF
00157D 557D D5              11      PUSH    DE
00157E 557E 2ADCF3          16      LD  HL,(CSRY)
001581 5581 3AB0F3          13      LD  A,(LINLEN)
001584 5584 4F               4      LD  C,A
001585 5585 94               4      SUB H   ;CSRX
001586 5586 3C               4      INC A
001587 5587 47               4      LD  B,A ;カーソルより右の文字数
001588 5588 C5              11      PUSH    BC
001589 5589 CDAD55          17      CALL    LOC0
00158C 558C C1              10      POP BC
                                
00158D 558D 1620             7      LD  D,020H
       558F                     INS1:
00158F 558F DD214A00        14      LD  IX,RDVRM
001593 5593 CDD642          17      CALL    CALSLT_R
001596 5596 4F               4      LD  C,A
001597 5597 7A               4      LD  A,D
001598 5598 DD214D00        14      LD  IX,WRTVRM
00159C 559C CDD642          17      CALL    CALSLT_R
00159F 559F 23               6      INC HL
0015A0 55A0 51               4      LD  D,C
0015A1 55A1 10EC            13      DJNZ    INS1
0015A3 55A3 D1              10      POP DE
0015A4 55A4 F1              10      POP AF
0015A5 55A5 C9              10      RET
                                
       55A6                     CONOUT1:
0015A6 55A6 59               4      LD  E,C
0015A7 55A7 C3DA53          10      JP  _PRINT
                                
       55AA                     GETVRAM:
0015AA 55AA 2ADCF3          16      LD  HL,(CSRY)
       55AD                     LOC0:
0015AD 55AD 2D               4      DEC L
0015AE 55AE 25               4      DEC H
0015AF 55AF 4C               4      LD  C,H ;CSRX-1
0015B0 55B0 5D               4      LD  E,L ;CSRY-1
       55B1                     LOC1:
0015B1 55B1 3AB0F3          13      LD  A,(LINLEN)
0015B4 55B4 67               4      LD  H,A
0015B5 55B5 1600             7      LD  D,0
0015B7 55B7 6A               4      LD  L,D ;0
0015B8 55B8 0608             7      LD  B,8
       55BA                     LOC2:
0015BA 55BA 29              11      ADD HL,HL
0015BB 55BB 3001            12      JR  NC,LOC3
0015BD 55BD 19              11      ADD HL,DE
       55BE                     LOC3:
0015BE 55BE 10FA            13      DJNZ    LOC2
0015C0 55C0 09              11      ADD HL,BC
0015C1 55C1 C9              10      RET
                                
       55C2                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0015C2 55C2 212200          10      LD  HL,00022H
0015C5 55C5 AF               4      XOR A
0015C6 55C6 7D               4      LD  A,L
0015C7 55C7 C9              10      RET
                                
       55C8                     _SYS0D:     ;(BDOS)ディスク・リセット
0015C8 55C8 218000          10      LD  HL,00080H
0015CB 55CB 22D4F2          16      LD  (_DTA),HL
0015CE 55CE C9              10      RET
                                
       55CF                     _SYS0E:     ;(BDOS)カレントドライブの設定
0015CF 55CF 7B               4      LD  A,E
       55D0                     _SYS0EX1:
0015D0 55D0 FE08             7      CP  8
0015D2 55D2 3F               4      CCF
0015D3 55D3 D8              11      RET C
0015D4 55D4 32EAF2          13      LD  (_DVSW),A
0015D7 55D7 C9              10      RET
                                
       55D8                     _SYS0F:     ;(BDOS)ファイルのオープン
0015D8 55D8 D5              11      PUSH    DE
0015D9 55D9 FDE1            14      POP IY
0015DB 55DB CD4657          17      CALL    INIT_FILE
0015DE 55DE CD684C          17      CALL    ROM_OPEN
0015E1 55E1 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
0015E3 55E3 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
0015E7 55E7 FDE5            15      PUSH    IY
0015E9 55E9 D1              10      POP DE
0015EA 55EA 13               6      INC DE
0015EB 55EB 010B00          10      LD  BC,11
0015EE 55EE EDB0                    LDIR
                                ;               Attribute
0015F0 55F0 7E               7      LD  A,(HL)
0015F1 55F1 FD770D          19      LD  (IY+13),A
                                ;               TIME
0015F4 55F4 110B00          10      LD  DE,11
0015F7 55F7 19              11      ADD HL,DE
0015F8 55F8 7E               7      LD  A,(HL)
0015F9 55F9 23               6      INC HL
0015FA 55FA FD7716          19      LD  (IY+22),A
0015FD 55FD 7E               7      LD  A,(HL)
0015FE 55FE 23               6      INC HL
0015FF 55FF FD7717          19      LD  (IY+23),A
                                ;               DATE
001602 5602 7E               7      LD  A,(HL)
001603 5603 23               6      INC HL
001604 5604 FD7714          19      LD  (IY+20),A
001607 5607 7E               7      LD  A,(HL)
001608 5608 23               6      INC HL
001609 5609 FD7715          19      LD  (IY+21),A
                                ;               First cluster
00160C 560C 7E               7      LD  A,(HL)
00160D 560D 23               6      INC HL
00160E 560E FD771A          19      LD  (IY+26),A
001611 5611 7E               7      LD  A,(HL)
001612 5612 23               6      INC HL
001613 5613 FD771B          19      LD  (IY+27),A
                                ;               SIZE
001616 5616 7E               7      LD  A,(HL)
001617 5617 23               6      INC HL
001618 5618 FD7710          19      LD  (IY+16),A
00161B 561B 7E               7      LD  A,(HL)
00161C 561C 23               6      INC HL
00161D 561D FD7711          19      LD  (IY+17),A
001620 5620 7E               7      LD  A,(HL)
001621 5621 23               6      INC HL
001622 5622 FD7712          19      LD  (IY+18),A
001625 5625 7E               7      LD  A,(HL)
001626 5626 FD7713          19      LD  (IY+19),A
001629 5629 AF               4      XOR A
00162A 562A FD770C          19      LD  (IY+12),A
00162D 562D C9              10      RET
                                
       562E                     _SYS10:     ;(BDOS)ファイルのクローズ
00162E 562E AF               4      XOR A
00162F 562F C9              10      RET
                                
       5630                     S11X1:
001630 5630 FD7119          19      LD  (IY+25),C       ;RootEntCnt
001633 5633 FD750E          19      LD  (IY+14),L
001636 5636 FD740F          19      LD  (IY+15),H
       5639                     SCF_FF_RET:
001639 5639 37               4      SCF
00163A 563A 9F               4      SBC A,A
00163B 563B C9              10      RET
                                
       563C                     _SYS11:     ;(BDOS)最初のファイルの検索
00163C 563C ED53D7F2        20      LD  (_FCB),DE
001640 5640 D5              11      PUSH    DE
001641 5641 FDE1            14      POP IY
001643 5643 CD4657          17      CALL    INIT_FILE
001646 5646 CDC44E          17      CALL    GET_DIR_DAT
       5649                     S12X1:
001649 5649 CD844C          17      CALL    FILESE
00164C 564C 30E2            12      JR  NC,S11X1
00164E 564E 0D               4      DEC C
00164F 564F FD7119          19      LD  (IY+25),C       ;RootEntCnt
001652 5652 FDCB0D66        20      BIT 4,(IY+13)
001656 5656 2809            12      JR  Z,S12X2
001658 5658 E5              11      PUSH    HL
001659 5659 DDE1            14      POP IX
00165B 565B DDCB0E66        20      BIT 4,(IX+1+13)
00165F 565F 28E8            12      JR  Z,S12X1
       5661                     S12X2:
001661 5661 012000          10      LD  BC,32
001664 5664 ED5BD4F2        20      LD  DE,(_DTA)
001668 5668 AF               4      XOR A
001669 5669 12               7      LD  (DE),A      ;ドライブ番号
00166A 566A 13               6      INC DE
00166B 566B EDB0                    LDIR            ;ディレクトリエントリ
00166D 566D FD750E          19      LD  (IY+14),L
001670 5670 FD740F          19      LD  (IY+15),H
001673 5673 C9              10      RET
                                
       5674                     _SYS12:
001674 5674 FD2AD7F2        20      LD  IY,(_FCB)
001678 5678 FDE5            15      PUSH    IY
00167A 567A D1              10      POP DE
00167B 567B CD4657          17      CALL    INIT_FILE
                                
00167E 567E FD6E0E          19      LD  L,(IY+14)
001681 5681 FD660F          19      LD  H,(IY+15)
001684 5684 FD4E19          19      LD  C,(IY+25)
001687 5687 18C0            12      JR  S12X1
                                
       5689                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
001689 5689 CDAA4E          17      CALL    SET_FCB
00168C 568C CD784E          17      CALL    GETSEQ
00168F 568F CD654E          17      CALL    RB_READ
001692 5692 E5              11      PUSH    HL
001693 5693 CD854E          17      CALL    SETSEQ
001696 5696 E1              10      POP HL
       5697                     SREAD:
001697 5697 C601             7      ADD A,001H
001699 5699 D8              11      RET C
                                
00169A 569A 7D               4      LD  A,L
00169B 569B D601             7      SUB 001H
00169D 569D 9F               4      SBC A,A
00169E 569E E603             7      AND 3
0016A0 56A0 1F               4      RRA
0016A1 56A1 C9              10      RET
                                
       56A2                     _SYS18:     ;(BDOS)ログインベクトルの獲得
0016A2 56A2 210100          10      LD  HL,00001H
0016A5 56A5 AF               4      XOR A
0016A6 56A6 C9              10      RET
                                
       56A7                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
0016A7 56A7 3AEAF2          13      LD  A,(_DVSW)
0016AA 56AA C9              10      RET
                                
       56AB                     _SYS1A:     ;(BDOS)DTAの設定
0016AB 56AB ED53D4F2        20      LD  (_DTA),DE
0016AF 56AF AF               4      XOR A
0016B0 56B0 C9              10      RET
                                
       56B1                     _SYS1B:     ;(BDOS)ディスク情報の獲得
0016B1 56B1 010002          10      LD  BC,512
0016B4 56B4 11C302          10      LD  DE,707
0016B7 56B7 210000          10      LD  HL,0
0016BA 56BA DD21D9F2        14      LD  IX,_BUF
0016BE 56BE FD21D9F2        14      LD  IY,_BUF
0016C2 56C2 FD3600F9        19      LD  (IY+0),0F9H
0016C6 56C6 3E02             7      LD  A,2
0016C8 56C8 C9              10      RET
                                
       56C9                     _SYS21:     ;(BDOS)ランダムな読み出し
0016C9 56C9 CDAA4E          17      CALL    SET_FCB
                                
0016CC 56CC FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0016CF 56CF FD6622          19      LD  H,(IY+34)
                                
0016D2 56D2 CD654E          17      CALL    RB_READ
0016D5 56D5 18C0            12      JR  SREAD
                                
       56D7                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
0016D7 56D7 CDD855          17      CALL    _SYS0F
0016DA 56DA D8              11      RET C
                                
0016DB 56DB D5              11      PUSH    DE      ;EX DE,IY
0016DC 56DC FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0016DE 56DE CD9A4E          17      CALL    GETSIZE
       56E1                     _S24X1:
0016E1 56E1 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
0016E4 56E4 FD7422          19      LD  (IY+34),H
0016E7 56E7 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
0016EB 56EB FDE3            23      EX  (SP),IY     ;
0016ED 56ED D1              10      POP DE      ;
                                
0016EE 56EE AF               4      XOR A
0016EF 56EF C9              10      RET
                                
       56F0                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
0016F0 56F0 E5              11      PUSH    HL
0016F1 56F1 D5              11      PUSH    DE      ;EX DE,IY
0016F2 56F2 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0016F4 56F4 CD784E          17      CALL    GETSEQ
0016F7 56F7 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       56F9                     _SYS27:     ;(BDOS)ランダムブロック読み込み
0016F9 56F9 CDAA4E          17      CALL    SET_FCB
0016FC 56FC E5              11      PUSH    HL
0016FD 56FD FD6E21          19      LD  L,(IY+33)
001700 5700 FD6622          19      LD  H,(IY+34)
001703 5703 22CAF2          16      LD  (RR_LOW),HL
001706 5706 FD6E23          19      LD  L,(IY+35)
001709 5709 FD6624          19      LD  H,(IY+36)
00170C 570C 22CCF2          16      LD  (RR_HIGH),HL
00170F 570F E1              10      POP HL
001710 5710 CD354A          17      CALL    ROM_READ
001713 5713 ED5BCAF2        20      LD  DE,(RR_LOW)
001717 5717 FD7321          19      LD  (IY+33),E
00171A 571A FD7222          19      LD  (IY+34),D
00171D 571D ED5BCCF2        20      LD  DE,(RR_HIGH)
001721 5721 FD7323          19      LD  (IY+35),E
001724 5724 FD7224          19      LD  (IY+36),D
001727 5727 9F               4      SBC A,A
001728 5728 C9              10      RET
                                
       5729                     _SYS2F:
001729 5729 44               4      LD  B,H
00172A 572A 2AD4F2          16      LD  HL,(_DTA)
00172D 572D C39751          10      JP  DISKIO
                                
       5730                     _SYS5A:
001730 5730 0600             7      LD  B,0
001732 5732 D5              11      PUSH    DE
001733 5733 DDE1            14      POP IX
       5735                     _SX5A1:
001735 5735 1A               7      LD  A,(DE)
001736 5736 B7               4      OR  A
001737 5737 2804            12      JR  Z,_SX5A2
001739 5739 13               6      INC DE
00173A 573A 04               4      INC B
00173B 573B 18F8            12      JR  _SX5A1
                                
       573D                     _SX5A2:
00173D 573D 78               4      LD  A,B
00173E 573E CD004B          17      CALL    FILE_BDOS
001741 5741 CD644F          17      CALL    ROM_CD
001744 5744 9F               4      SBC A,A
001745 5745 C9              10      RET
                                
       5746                     INIT_FILE:
001746 5746 EB               4      EX  DE,HL
001747 5747 11F8F2          10      LD  DE,FDRV
00174A 574A 010C00          10      LD  BC,1+8+3
       574D                     INIT_FILE1:
00174D 574D EDB0                    LDIR
00174F 574F CD6A53          17      CALL    GET_DISK_BANK_FDRV
                                #if exists USE_MORMAL32K_OR_ASCII16
001752 5752 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
001755 5755 2AEBF2          16      LD  HL,(_CD)
001758 5758 22F6F2          16      LD  (_CDX),HL           ;カレントディレクトリ
00175B 575B C9              10      RET
                                
       575C                     ZERO_MEMORY_DE:
00175C 575C AF               4      XOR A
       575D                     FILL_MEMORY_DE:
00175D 575D 12               7      LD  (DE),A
00175E 575E 13               6      INC DE
00175F 575F 10FC            13      DJNZ    FILL_MEMORY_DE
001761 5761 C9              10      RET
                                
001762 5762                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 C753DD530E54C753        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 C753C75313545454        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 1B54C7536E540255        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 C255C855CF55D855        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 2E563C567456C753        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 8956C753C753C753        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 A256A756AB56B156        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 C753C753C753D756        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 F056C753C753F956        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 C753C7531455C753        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 1A55C753C7532957        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 C753C7533057C753        DW  _ERROR,_ERROR,_SYS5A,_ERROR
001FB8 5FB8 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 C753C753C753C753        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM.ASM:UTF_8]
[EOF:DISKROM32.ASM:UTF_8]
