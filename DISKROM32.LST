                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       42B2                     CRUNCH  EQU 042B2H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
                                ;PTRFIL EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
                                ;FILNAM EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
                                ;RSTMP  EQU 0FB03H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FEDA                     H_STKE  EQU 0FEDAH
                                
       FF43                     H_GONE  EQU 0FF43H
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;KONAMI-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                
       F0E9                     ISC EQU 0F0E9H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
[EOF:DEF.ASM:UTF_8]
                                
       0001                     USE_NORMAL_32K_ROM      EQU 1   ;ノーマル32KB ROMを作成する
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C3AF4D          10      JP  DISKIO
000013 4013 C3E94D          10      JP  DSKCHG
000016 4016 C33F4E          10      JP  GETDPB
000019 4019 C3324F          10      JP  CHOICE
00001C 401C C3364F          10      JP  DSKFMT
00001F 401F C3384F          10      JP  DSKSTP
000022 4022 C3394F          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C3364F          10      JP  DSKFMT
000029 4029 C3384F          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3404F          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.1.5.2",0
            204449534B20524F    
            4D204C6974652076    
            302E312E352E3200    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 0180FF          10      LD  BC,-00080H
000109 4109 2A72F6          16      LD  HL,(MEMSIZ)
00010C 410C 09              11      ADD HL,BC
00010D 410D 2272F6          16      LD  (MEMSIZ),HL
000110 4110 2A74F6          16      LD  HL,(STKTOP)
000113 4113 09              11      ADD HL,BC
000114 4114 2274F6          16      LD  (STKTOP),HL
000117 4117 2180F0          10      LD  HL,0F080H
00011A 411A 1100F0          10      LD  DE,0F000H
00011D 411D 012000          10      LD  BC,00020H
000120 4120 EDB0                    LDIR
000122 4122 2180FF          10      LD  HL,-00080H
000125 4125 39              11      ADD HL,SP
000126 4126 225FF1          16      LD  (BASSTK),HL
000129 4129 ED7B5FF1        20      LD  SP,(BASSTK)
                                
00012D 412D 3EFF             7      LD  A,0FFH
00012F 412F 3299FD          13      LD  (DEVICE),A
                                
000132 4132 3E01             7      LD  A,1
000134 4134 3221FB          13      LD  (DRVTBL),A
                                
000137 4137 AF               4      XOR A
000138 4138 324AF1          13      LD  (_DVSW),A
                                
00013B 413B 21F342          10      LD  HL,AT_ISC
00013E 413E 11E9F0          10      LD  DE,ISC
000141 4141 017C00          10      LD  BC,ISC_E-ISC
000144 4144 EDB0                    LDIR
                                    
000146 4146 3EC3             7      LD  A,0C3H      ;JP
000148 4148 3243FF          13      LD  (H_GONE),A
00014B 414B 327DF3          13      LD  (BDOS),A
00014E 414E 326BF3          13      LD  (RAMUSE),A
000151 4151 3268F3          13      LD  (ROMUSE),A
000154 4154 21E9F0          10      LD  HL,REPLACE_COMMAND
000157 4157 2244FF          16      LD  (H_GONE+1),HL
00015A 415A 2131F3          10      LD  HL,H_BDOS
00015D 415D 227EF3          16      LD  (BDOS+1),HL
000160 4160 2119F1          10      LD  HL,RAMUSE1
000163 4163 226CF3          16      LD  (RAMUSE+1),HL
000166 4166 2114F1          10      LD  HL,ROMUSE1
000169 4169 2269F3          16      LD  (ROMUSE+1),HL
                                
00016C 416C 3E                      DB  03EH
00016D 416D F7              12      RST 30H
00016E 416E 3271FE          13      LD  (H_BINS),A
000171 4171 3276FE          13      LD  (H_BINL),A
000174 4174 327BFE          13      LD  (H_FILE),A
000177 4177 3231F3          13      LD  (H_BDOS),A
00017A 417A 32DAFE          13      LD  (H_STKE),A
00017D 417D 32A7FF          13      LD  (H_PHYD),A
                                
000180 4180 CD3342          17      CALL    GTSL1_
000183 4183 3200F1          13      LD  (ROM_SLT),A
000186 4186 3210F1          13      LD  (ROM_SLT_COPY),A
000189 4189 3272FE          13      LD  (H_BINS+1),A
00018C 418C 3277FE          13      LD  (H_BINL+1),A
00018F 418F 327CFE          13      LD  (H_FILE+1),A
000192 4192 3232F3          13      LD  (H_BDOS+1),A
000195 4195 32DBFE          13      LD  (H_STKE+1),A
000198 4198 32A8FF          13      LD  (H_PHYD+1),A
00019B 419B 3222FB          13      LD  (DRVTBL+1),A
00019E 419E 3248F3          13      LD  (MASTERS),A
                                
0001A1 41A1 219A45          10      LD  HL,ROM_LOAD
0001A4 41A4 2273FE          16      LD  (H_BINS+2),HL
0001A7 41A7 21C246          10      LD  HL,ROM_RUN
0001AA 41AA 2278FE          16      LD  (H_BINL+2),HL
0001AD 41AD 21CF46          10      LD  HL,ROM_FILES
0001B0 41B0 227DFE          16      LD  (H_FILE+2),HL
0001B3 41B3 218C4F          10      LD  HL,ROM_BDOS
0001B6 41B6 2233F3          16      LD  (H_BDOS+2),HL
0001B9 41B9 219943          10      LD  HL,ROM_STKE
0001BC 41BC 22DCFE          16      LD  (H_STKE+2),HL
0001BF 41BF 21AF4D          10      LD  HL,DISKIO
0001C2 41C2 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001C5 41C5 3E                      DB  03EH
0001C6 41C6 C9              10      RET
0001C7 41C7 327FFE          13      LD  (H_FILE+4),A
0001CA 41CA 3275FE          13      LD  (H_BINS+4),A
0001CD 41CD 327AFE          13      LD  (H_BINL+4),A
0001D0 41D0 3235F3          13      LD  (H_BDOS+4),A
0001D3 41D3 32DEFE          13      LD  (H_STKE+4),A
0001D6 41D6 32ABFF          13      LD  (H_PHYD+4),A
                                
                                #if exists USE_NORMAL_32K_ROM
                                #else
                                    XOR A
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  A,(BANK1_ADR)
                                    CP  'A'
                                    JR  NZ,NOT_8K_BANK
                                    LD  A,DISK_BANK
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001D9 41D9 CD3801          17      CALL    RSLREG      ;read primary slot #
0001DC 41DC 07               4      RLCA
0001DD 41DD 07               4      RLCA
0001DE 41DE F5              11      PUSH    AF
0001DF 41DF 1605             7      LD  D,4+1
0001E1 41E1 CD3A42          17      CALL    GTSL2_
0001E4 41E4 3244F3          13      LD  (RAMAD3),A
0001E7 41E7 F1              10      POP AF
0001E8 41E8 07               4      RLCA
0001E9 41E9 07               4      RLCA
0001EA 41EA 1603             7      LD  D,2+1
0001EC 41EC CD3A42          17      CALL    GTSL2_
0001EF 41EF 2680             7      LD  H,080H
0001F1 41F1 CD5742          17      CALL    CHK_RAM
0001F4 41F4 3243F3          13      LD  (RAMAD2),A
       41F7                     RAMCHK2:
0001F7 41F7 3A44F3          13      LD  A,(RAMAD3)
0001FA 41FA 2640             7      LD  H,040H
0001FC 41FC CD5742          17      CALL    CHK_RAM
0001FF 41FF 3242F3          13      LD  (RAMAD1),A
       4202                     RAMCHK1:
000202 4202 3A44F3          13      LD  A,(RAMAD3)
000205 4205 2600             7      LD  H,00H
000207 4207 CD5742          17      CALL    CHK_RAM
00020A 420A 3241F3          13      LD  (RAMAD0),A
       420D                     RAMCHK0:
00020D 420D 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
000210 4210 010F00          10      LD  BC,0000FH       ;切り上げ
000213 4213 09              11      ADD HL,BC
000214 4214 7D               4      LD  A,L
                                
000215 4215 0604             7      LD  B,4
       4217                     B_DRIVE1:
000217 4217 CB3C             8      SRL H
000219 4219 1F               4      RRA
00021A 421A 10FB            13      DJNZ    B_DRIVE1
                                
00021C 421C C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
00021E 421E 3249F1          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
000221 4221 C9              10      RET
                                
       4222                     NOT_8K_BANK:
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K等)
000222 4222 21E743          10      LD  HL,MSG_ERROR_ROM_MODE
000225 4225 CD7243          17      CALL    MSX
000228 4228 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00022C 422C DD219F00        14      LD  IX,CHGET
000230 4230 C31C00          10      JP  _CALSLT
                                
       4233                     GTSL1_:             ;自分のいるスロットを知る
000233 4233 CD3801          17      CALL    RSLREG      ;read primary slot #
000236 4236 0F               4      RRCA
000237 4237 0F               4      RRCA
000238 4238 1601             7      LD  D,1
       423A                     GTSL2_:
00023A 423A E603             7      AND 3       ;[A]=000000PP
00023C 423C 5F               4      LD  E,A     ;[E]=000000PP
00023D 423D 21C1FC          10      LD  HL,EXPTBL
000240 4240 85               4      ADD A,L     ;桁上りは無い
000241 4241 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000242 4242 7B               4      LD  A,E     ;[A]=000000PP
000243 4243 CB7E            13      BIT 7,(HL)
000245 4245 C8              11      RET Z
000246 4246 7D               4      LD  A,L     ;point to SLTTBL entry
000247 4247 C604             7      ADD A,4     ;桁上りは無い
000249 4249 6F               4      LD  L,A
00024A 424A 7E               7      LD  A,(HL)      ;get currently expansion slot register
       424B                     GTSL3_:
00024B 424B 15               4      DEC D
00024C 424C 2803            12      JR  Z,GTSL4_:
00024E 424E 0F               4      RRCA
00024F 424F 18FA            12      JR  GTSL3_:
       4251                     GTSL4_:
000251 4251 E60C             7      AND 00CH        ;[A] = 0000SS00
000253 4253 B3               4      OR  E       ;[A] = 0000SSPP
000254 4254 F680             7      OR  080H        ;[A] = 1000SSPP
000256 4256 C9              10      RET
                                
       4257                     CHK_RAM:
000257 4257 E5              11      PUSH    HL
000258 4258 CDAC42          17      CALL    CHK_RAM0
00025B 425B E1              10      POP HL
00025C 425C C8              11      RET Z
00025D 425D 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000260 4260 E680             7      AND 080H
000262 4262 CD8342          17      CALL    CHK_RAM_SLT
000265 4265 C8              11      RET Z
000266 4266 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000269 4269 E680             7      AND 080H
00026B 426B C601             7      ADD A,1
00026D 426D CD8342          17      CALL    CHK_RAM_SLT
000270 4270 C8              11      RET Z
000271 4271 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000274 4274 E680             7      AND 080H
000276 4276 C602             7      ADD A,2
000278 4278 CD8342          17      CALL    CHK_RAM_SLT
00027B 427B C8              11      RET Z
00027C 427C 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
00027F 427F E680             7      AND 080H
000281 4281 C603             7      ADD A,3
       4283                     CHK_RAM_SLT:
000283 4283 E5              11      PUSH    HL
000284 4284 CDAC42          17      CALL    CHK_RAM0        ;スロット#X or X-0
000287 4287 E1              10      POP HL
000288 4288 C8              11      RET Z
000289 4289 CB79             8      BIT 7,C
00028B 428B 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
00028D 428D 79               4      LD  A,C
00028E 428E C604             7      ADD A,4*1           ;スロット#X-1
000290 4290 E5              11      PUSH    HL
000291 4291 CDAC42          17      CALL    CHK_RAM0
000294 4294 E1              10      POP HL
000295 4295 C8              11      RET Z
000296 4296 79               4      LD  A,C
000297 4297 C608             7      ADD A,4*2           ;スロット#X-2
000299 4299 E5              11      PUSH    HL
00029A 429A CDAC42          17      CALL    CHK_RAM0
00029D 429D E1              10      POP HL
00029E 429E C8              11      RET Z
00029F 429F 79               4      LD  A,C
0002A0 42A0 C60C             7      ADD A,4*3           ;スロット#X-3
0002A2 42A2 E5              11      PUSH    HL
0002A3 42A3 CDAC42          17      CALL    CHK_RAM0
0002A6 42A6 E1              10      POP HL
       42A7                     CHK_RAM_E:
0002A7 42A7 AF               4      XOR A
0002A8 42A8 3C               4      INC A           ;ZF=0にする
0002A9 42A9 3E00             7      LD  A,0
0002AB 42AB C9              10      RET
                                
       42AC                     CHK_RAM0:
0002AC 42AC 4F               4      LD  C,A
0002AD 42AD 3A00F1          13      LD  A,(ROM_SLT)
0002B0 42B0 B9               4      CP  C
0002B1 42B1 28F4            12      JR  Z,CHK_RAM_E
0002B3 42B3 2E00             7      LD  L,0
       42B5                     CHK_RAM1:
0002B5 42B5 79               4      LD  A,C
0002B6 42B6 DD210C00        14      LD  IX,_RDSLT
0002BA 42BA CDE742          17      CALL    CALSLT_R
0002BD 42BD C6E5             7      ADD A,0E5H
0002BF 42BF 47               4      LD  B,A
0002C0 42C0 5F               4      LD  E,A
0002C1 42C1 79               4      LD  A,C
0002C2 42C2 DD211400        14      LD  IX,_WRSLT
0002C6 42C6 CDE742          17      CALL    CALSLT_R
0002C9 42C9 79               4      LD  A,C
0002CA 42CA DD210C00        14      LD  IX,_RDSLT
0002CE 42CE CDE742          17      CALL    CALSLT_R
0002D1 42D1 B8               4      CP  B
0002D2 42D2 C0              11      RET NZ
0002D3 42D3 D6E5             7      SUB 0E5H
0002D5 42D5 79               4      LD  A,C
0002D6 42D6 5F               4      LD  E,A
0002D7 42D7 DD211400        14      LD  IX,_WRSLT
0002DB 42DB CDE742          17      CALL    CALSLT_R
0002DE 42DE 24               4      INC H
0002DF 42DF 7D               4      LD  A,L
0002E0 42E0 C604             7      ADD A,4
0002E2 42E2 6F               4      LD  L,A
0002E3 42E3 20D0            12      JR  NZ,CHK_RAM1
0002E5 42E5 79               4      LD  A,C     ;ZF=1のハズ
0002E6 42E6 C9              10      RET
                                
       42E7                     CALSLT_R:
0002E7 42E7 C5              11      PUSH    BC
0002E8 42E8 E5              11      PUSH    HL
0002E9 42E9 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0002ED 42ED CD1C00          17      CALL    _CALSLT
0002F0 42F0 E1              10      POP HL
0002F1 42F1 C1              10      POP BC
0002F2 42F2 C9              10      RET
                                
       42F3                     AT_ISC:
0002F3 F0E9                         ORG ISC,AT_ISC-RUN
       F0E9                     REPLACE_COMMAND:
0002F3 F0E9 FEB7             7      CP  0B7H            ;FILES
0002F5 F0EB CC7BFE          17      CALL    Z,H_FILE
0002F8 F0EE FEB5             7      CP  0B5H            ;LOAD
0002FA F0F0 CA71FE          10      JP  Z,H_BINS
0002FD F0F3 FE8A             7      CP  08AH            ;RUN
0002FF F0F5 CA76FE          10      JP  Z,H_BINL
000302 F0F8 FED6             7      CP  0D6H            ;COPY
000304 F0FA 2813            12      JR  Z,FIX_COPY
000306 F0FC FECF             7      CP  0CFH            ;BLOAD
000308 F0FE C0              11      RET NZ
       F0FF                     FIX_BLOAD:
000309 F0FF F7              12      RST 30H
       F100                     ROM_SLT:
00030A F100 00                      DB  0
00030B F101 FF45                    DW  ROM_BLOAD
00030D F103 F5              11      PUSH    AF
00030E F104 E5              11      PUSH    HL
00030F F105 CD0EF1          17      CALL    BLOAD_RET
       F106                     SWC_BLOAD   EQU $-2
000312 F108 E1              10      POP HL
000313 F109 F1              10      POP AF
000314 F10A FECF             7      CP  0CFH            ;BLOAD
       F10C                     SWC_BLOAD_M:
000316 F10C 28DB            12      JR  Z,REPLACE_COMMAND
       F10E                     BLOAD_RET:
000318 F10E C9              10      RET
       F10F                     FIX_COPY:
000319 F10F F7              12      RST 30H
       F110                     ROM_SLT_COPY:
00031A F110 00                      DB  0
00031B F111 5447                    DW  ROM_COPY
00031D F113 C9              10      RET
       F114                     ROMUSE1:
00031E F114 3A00F1          13      LD  A,(ROM_SLT)
000321 F117 1803            12      JR  ROMUSE2
       F119                     RAMUSE1:
000323 F119 3A42F3          13      LD  A,(RAMAD1)
       F11C                     ROMUSE2:
000326 F11C C32400          10      JP  _ENASLT
                                
       F11F                     _RESULT:
000329 F11F 00                      DB  0
       F120                     _BANK:
00032A F120 00                      DB  0
       F121                     CLSZ:               ;クラスタサイズ
00032B F121 0004                    DW  1024
       F122                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F123                     SECSZ:              ;セクタサイズ
00032D F123 0002                    DW  512
       F124                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F125                     RR_LOW:
00032F F125 0000                    DW  0
       F126                     RR_MID  EQU $-1
       F127                     RR_HIGH:
000331 F127 0000                    DW  0
       F129                     _CLPS:
000333 F129 0000                    DW  0
       F12B                     _LEFT:
000335 F12B 0000                    DW  0
       F12D                     _DTPS:
000337 F12D 0000                    DW  0
       F12F                     _DTA:
000339 F12F 0000                    DW  0
       F131                     FLG_LDIR:
00033B F131 00                      DB  0
                                
                                ;   BDOS
00033C F132 F7              12      RST 30H
00033D F133 00                      DB  0
00033E F134 8C4F                    DW  ROM_BDOS
000340 F136 C9              10      RET 
       F137                     _FCB:
000341 F137 0000                    DW  0
       F139                     _BUF:
       F139                     _BUF_LO:        ;LOGICAL OPERATION
000343 F139 00                      DB  0
       F13A                     _BUF_ST:
000344 F13A 0000                    DW  0
       F13C                     _BUF_EN:
000346 F13C 0000                    DW  0
       F13E                     _BUF_EX:
       F13E                     _BUF_W:
000348 F13E 0000                    DW  0
       F140                     _BUF_H:
00034A F140 0000                    DW  0
       F142                     _BUF_X:
00034C F142 0000                    DW  0
       F144                     _BUF_Y:
00034E F144 00                      DB  0
       F145                     _BUF_P:
00034F F145 00                      DB  0
       F146                     _BUF_O:
000350 F146 00                      DB  0
       F147                     DTAX:
000351 F147 0000                    DW  0
       F149                     B_DRIVE:
000353 F149 00                      DB  0
       F14A                     _DVSW:
000354 F14A 00                      DB  0
       F14B                     FCBX:
000355 F14B 0000                    DW  0
       F14D                     LEFTX:
000357 F14D 0000                    DW  0
       F14F                     PARAM0:
000359 F14F 0000                    DW  0
       F151                     PARAM1:
00035B F151 0000                    DW  0
       F153                     FDRV:
00035D F153 00                      DB  0
       F154                     FNAME:
00035E F154                         DS  8+3
                                
       F15F                     BASSTK:
000369 F15F 0000                    DW  0
       F161                     _HL:
00036B F161 0000                    DW  0
       F163                     _SP:
00036D F163 0000                    DW  0
                                
       F165                     ISC_E:
00036F 436F                         ORG $$+RUN          ;$DEPHASE
                                
       436F                     MSX1:
00036F 436F CDA54F          17      CALL    MSGA1
       4372                     MSX:
000372 4372 7E               7      LD  A,(HL)
000373 4373 23               6      INC HL
000374 4374 B7               4      OR  A
000375 4375 20F8            12      JR  NZ,MSX1
000377 4377 C9              10      RET
                                
       4378                     PRTHX:
000378 4378 F5              11      PUSH    AF
000379 4379 07               4      RLCA
00037A 437A 07               4      RLCA
00037B 437B 07               4      RLCA
00037C 437C 07               4      RLCA
00037D 437D CD8143          17      CALL    PRTA2
000380 4380 F1              10      POP AF
       4381                     PRTA2:
000381 4381 CD8743          17      CALL    ASC
000384 4384 C3A14F          10      JP  MSG_A
                                    
       4387                     ASC:
000387 4387 E60F             7      AND $0F
000389 4389 F630             7      OR  $30
00038B 438B FE3A             7      CP  $3A
00038D 438D D8              11      RET C
00038E 438E C607             7      ADD A,7
000390 4390 C9              10      RET
                                
       4391                     MSN:
000391 4391 7E               7      LD  A,(HL)
000392 4392 23               6      INC HL
000393 4393 CDA14F          17      CALL    MSG_A
000396 4396 10F9            13      DJNZ    MSN
000398 4398 C9              10      RET
                                
       4399                     ROM_STKE:
000399 4399 3E                      DB  03EH
00039A 439A C9              10      RET
00039B 439B 32DAFE          13      LD  (H_STKE),A
00039E 439E E5              11      PUSH    HL
00039F 439F D5              11      PUSH    DE
0003A0 43A0 C5              11      PUSH    BC
0003A1 43A1 181D            12      JR  BASAUTO
                                
0003A3 43A3 AF               4      XOR A
0003A4 43A4 5F               4      LD  E,A
0003A5 43A5 57               4      LD  D,A
0003A6 43A6 0601             7      LD  B,1
0003A8 43A8 2100C0          10      LD  HL,0C000H
0003AB 43AB CDAF4D          17      CALL    DISKIO
                                
0003AE 43AE ED735FF1        20      LD  (BASSTK),SP
0003B2 43B2 116BF3          10      LD  DE,RAMUSE
0003B5 43B5 AF               4      XOR A
0003B6 43B6 CD1EC0          17      CALL    0C01EH
0003B9 43B9 116BF3          10      LD  DE,RAMUSE
0003BC 43BC 37               4      SCF
0003BD 43BD CD1EC0          17      CALL    0C01EH
       43C0                     BASAUTO:
0003C0 43C0 210D44          10      LD  HL,AUTOEXEC
0003C3 43C3 1153F1          10      LD  DE,FDRV
0003C6 43C6 010C00          10      LD  BC,1+8+3
0003C9 43C9 EDB0                    LDIR
0003CB 43CB CD534B          17      CALL    ROM_OPEN
0003CE 43CE 3813            12      JR  C,RSTKEE
0003D0 43D0 211944          10      LD  HL,RUN_AUTOEXEC
0003D3 43D3 11F0FB          10      LD  DE,KEYBUF
0003D6 43D6 ED53FAF3        20      LD  (GETPNT),DE
0003DA 43DA 011300          10      LD  BC,RUN_AUTOEXEC_E-RUN_AUTOEXEC
0003DD 43DD EDB0                    LDIR
0003DF 43DF ED53F8F3        20      LD  (PUTPNT),DE
       43E3                     RSTKEE:
0003E3 43E3 C1              10      POP BC
0003E4 43E4 D1              10      POP DE
0003E5 43E5 E1              10      POP HL
0003E6 43E6 C9              10      RET
                                
       43E7                     MSG_ERROR_ROM_MODE:
0003E7 43E7 41534349492D384B        DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
            2F4B6F6E616D692D    
            384B2F4B6F6E616D    
            692D534343206F6E    
            6C79210D0A          
       440C                     NULL:
00040C 440C 00                      DB  0
                                
       440D                     AUTOEXEC:
00040D 440D 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       4419                     RUN_AUTOEXEC:
000419 4419 52554E2022415554        DB  'RUN "AUTOEXEC.BAS"',00DH
            4F455845432E4241    
            53220D              
                                ;   DB  'LOAD "AUTOEXEC.BAS"',00DH  ;テスト用
       442C                     RUN_AUTOEXEC_E:
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       442C                     ROM_LDIR:
00042C 442C 3A31F1          13      LD  A,(FLG_LDIR)
00042F 442F B7               4      OR  A
000430 4430 2062            12      JR  NZ,ROM_LDIRVM
000432 4432 CB7A             8      BIT 7,D
000434 4434 CABC44          10      JP  Z,ROM_LDIRSLT
                                
                                #if exists USE_NORMAL_32K_ROM
000437 4437 ED7363F1        20      LD  (_SP),SP
00043B 443B 3121FB          10      LD  SP,DRVTBL
       443E                     LDIR1:
00043E 443E 78               4      LD  A,B
00043F 443F B1               4      OR  C
000440 4440 2841            12      JR  Z,LDIRE
                                
000442 4442 C5              11      PUSH    BC
000443 4443 D5              11      PUSH    DE
000444 4444 E5              11      PUSH    HL
000445 4445 3A00F1          13      LD  A,(ROM_SLT)
000448 4448 2680             7      LD  H,080H
00044A 444A CD2400          17      CALL    _ENASLT
00044D 444D E1              10      POP HL
00044E 444E D1              10      POP DE
00044F 444F C1              10      POP BC
       4450                     LDIR2:
000450 4450 7A               4      LD  A,D
000451 4451 FEC0             7      CP  0C0H
000453 4453 302C            12      JR  NC,LDIR4
                                
000455 4455 C5              11      PUSH    BC
000456 4456 D5              11      PUSH    DE
000457 4457 115EF5          10      LD  DE,BUF
                                
00045A 445A 78               4      LD  A,B
00045B 445B B7               4      OR  A
00045C 445C 2803            12      JR  Z,LDIR3
00045E 445E 010001          10      LD  BC,00100H
       4461                     LDIR3:
000461 4461 C5              11      PUSH    BC
000462 4462 EDB0                    LDIR
000464 4464 2261F1          16      LD  (_HL),HL
                                
000467 4467 3A43F3          13      LD  A,(RAMAD2)
00046A 446A 2680             7      LD  H,080H
00046C 446C CD2400          17      CALL    _ENASLT
                                
00046F 446F 215EF5          10      LD  HL,BUF
000472 4472 C1              10      POP BC
000473 4473 D1              10      POP DE
000474 4474 EDB0                    LDIR
                                
000476 4476 2A61F1          16      LD  HL,(_HL)
000479 4479 C1              10      POP BC
00047A 447A 78               4      LD  A,B
00047B 447B B7               4      OR  A
00047C 447C 2805            12      JR  Z,LDIRE
00047E 447E 05               4      DEC B
00047F 447F 18BD            12      JR  LDIR1
       4481                     LDIR4:
                                #endif
000481 4481 EDB0                    LDIR
                                
                                #if exists USE_NORMAL_32K_ROM
       4483                     LDIRE:
000483 4483 D5              11      PUSH    DE
000484 4484 E5              11      PUSH    HL
000485 4485 3A43F3          13      LD  A,(RAMAD2)
000488 4488 2680             7      LD  H,080H
00048A 448A CD2400          17      CALL    _ENASLT
00048D 448D E1              10      POP HL
00048E 448E D1              10      POP DE
00048F 448F ED7B63F1        20      LD  SP,(_SP)
                                #endif
000493 4493 C9              10      RET
                                
       4494                     ROM_LDIRVM:
                                #if exists USE_NORMAL_32K_ROM
000494 4494 C5              11      PUSH    BC
000495 4495 D5              11      PUSH    DE
000496 4496 E5              11      PUSH    HL
000497 4497 3A00F1          13      LD  A,(ROM_SLT)
00049A 449A 2680             7      LD  H,080H
00049C 449C CD2400          17      CALL    _ENASLT
00049F 449F E1              10      POP HL
0004A0 44A0 D1              10      POP DE
0004A1 44A1 C1              10      POP BC
                                #endif
0004A2 44A2 C5              11      PUSH    BC
0004A3 44A3 D5              11      PUSH    DE
0004A4 44A4 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0004A8 44A8 DD215C00        14      LD  IX,LDIRVM
0004AC 44AC CD1C00          17      CALL    _CALSLT
                                #if exists USE_NORMAL_32K_ROM
0004AF 44AF 2680             7      LD  H,080H
0004B1 44B1 3A43F3          13      LD  A,(RAMAD2)
0004B4 44B4 CD2400          17      CALL    _ENASLT
                                #endif
0004B7 44B7 E1              10      POP HL
0004B8 44B8 C1              10      POP BC
0004B9 44B9 09              11      ADD HL,BC
0004BA 44BA EB               4      EX  DE,HL
0004BB 44BB C9              10      RET
                                
       44BC                     ROM_LDIRSLT:
0004BC 44BC EB               4      EX  DE,HL
       44BD                     RLDIRSLT1:
0004BD 44BD 1A               7      LD  A,(DE)
0004BE 44BE 13               6      INC DE
0004BF 44BF C5              11      PUSH    BC
0004C0 44C0 D5              11      PUSH    DE
0004C1 44C1 E5              11      PUSH    HL
0004C2 44C2 5F               4      LD  E,A
0004C3 44C3 3A42F3          13      LD  A,(RAMAD1)
0004C6 44C6 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0004CA 44CA DD211400        14      LD  IX,_WRSLT
0004CE 44CE CD1C00          17      CALL    _CALSLT
0004D1 44D1 E1              10      POP HL
0004D2 44D2 D1              10      POP DE
0004D3 44D3 C1              10      POP BC
0004D4 44D4 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0004D6 44D6 EABD44          10      JP  PE,RLDIRSLT1
0004D9 44D9 EB               4      EX  DE,HL
0004DA 44DA C9              10      RET
                                
       44DB                     END_OF_LINE:
0004DB 44DB 215EF5          10      LD  HL,BUF
       44DE                     EOL1:
0004DE 44DE 7E               7      LD  A,(HL)
0004DF 44DF C8              11      RET Z
0004E0 44E0 FE0D             7      CP  00DH
0004E2 44E2 2807            12      JR  Z,EOLE
0004E4 44E4 FE0A             7      CP  00AH
0004E6 44E6 2803            12      JR  Z,EOLE
0004E8 44E8 23               6      INC HL
0004E9 44E9 18F3            12      JR  EOL1
       44EB                     EOLE:
0004EB 44EB 3600            10      LD  (HL),0
0004ED 44ED 23               6      INC HL
0004EE 44EE 7E               7      LD  A,(HL)
0004EF 44EF FE0A             7      CP  00AH
0004F1 44F1 C0              11      RET NZ
0004F2 44F2 23               6      INC HL
0004F3 44F3 C9              10      RET
                                
       44F4                     ROM_LOAD_ASCII:
0004F4 44F4 210000          10      LD  HL,0
0004F7 44F7 223AF1          16      LD  (_BUF_ST),HL    ;読み出し位置
0004FA 44FA 2A76F6          16      LD  HL,(TXTTAB)
0004FD 44FD 223CF1          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
000500 4500 215EF5          10      LD  HL,BUF
000503 4503 222FF1          16      LD  (_DTA),HL
       4506                     RLOAD_A1:
000506 4506 2A3AF1          16      LD  HL,(_BUF_ST)
000509 4509 2225F1          16      LD  (RR_LOW),HL
00050C 450C 210201          10      LD  HL,258
00050F 450F CD6F49          17      CALL    ROM_READ
000512 4512 7C               4      LD  A,H
000513 4513 B5               4      OR  L
000514 4514 2877            12      JR  Z,RLOAD_AEND
000516 4516 015EF5          10      LD  BC,BUF
000519 4519 09              11      ADD HL,BC
00051A 451A 3600            10      LD  (HL),0
00051C 451C CDDB44          17      CALL    END_OF_LINE
00051F 451F 015EF5          10      LD  BC,BUF
000522 4522 A7               4      AND A
000523 4523 ED42            15      SBC HL,BC
000525 4525 2810            12      JR  Z,RLOAD_A2
000527 4527 4D               4      LD  C,L
000528 4528 44               4      LD  B,H
000529 4529 ED5B3AF1        20      LD  DE,(_BUF_ST)
00052D 452D 19              11      ADD HL,DE
00052E 452E 223AF1          16      LD  (_BUF_ST),HL
000531 4531 3A5EF5          13      LD  A,(BUF)
000534 4534 B7               4      OR  A
000535 4535 28CF            12      JR  Z,RLOAD_A1
       4537                     RLOAD_A2:
000537 4537 115EF5          10      LD  DE,BUF
00053A 453A CDE64A          17      CALL    SPCUTEX
00053D 453D 1A               7      LD  A,(DE)
00053E 453E B7               4      OR  A
00053F 453F 284C            12      JR  Z,RLOAD_AEND
000541 4541 CDF84A          17      CALL    GETNUM
000544 4544 7C               4      LD  A,H
000545 4545 B5               4      OR  L
000546 4546 CAEC45          10      JP  Z,ERROR_DIRECT_IN_FILE
000549 4549 DD2A3CF1        20      LD  IX,(_BUF_EN)
00054D 454D DD7502          19      LD  (IX+2),L
000550 4550 DD7403          19      LD  (IX+3),H
                                
000553 4553 CDDF4A          17      CALL    SPCUT
000556 4556 EB               4      EX  DE,HL
000557 4557 DDE5            15      PUSH    IX
000559 4559 DD21B242        14      LD  IX,CRUNCH
00055D 455D FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000561 4561 CD1C00          17      CALL    _CALSLT
000564 4564 DDE1            14      POP IX
000566 4566 EB               4      EX  DE,HL
000567 4567 111FF4          10      LD  DE,KBUF
00056A 456A 37               4      SCF
00056B 456B ED52            15      SBC HL,DE
00056D 456D 287D            12      JR  Z,ERROR_DIRECT_IN_FILE
00056F 456F 387B            12      JR  C,ERROR_DIRECT_IN_FILE
000571 4571 4D               4      LD  C,L
000572 4572 44               4      LD  B,H
000573 4573 2A3CF1          16      LD  HL,(_BUF_EN)
000576 4576 110400          10      LD  DE,4
000579 4579 19              11      ADD HL,DE
00057A 457A 111FF4          10      LD  DE,KBUF
                                
00057D 457D EB               4      EX  DE,HL
00057E 457E EDB0                    LDIR
000580 4580 EB               4      EX  DE,HL
                                
000581 4581 DD7500          19      LD  (IX+0),L
000584 4584 DD7401          19      LD  (IX+1),H
000587 4587 223CF1          16      LD  (_BUF_EN),HL
00058A 458A C30645          10      JP  RLOAD_A1
                                
       458D                     RLOAD_AEND:
00058D 458D 2A3CF1          16      LD  HL,(_BUF_EN)
000590 4590 AF               4      XOR A
000591 4591 77               7      LD  (HL),A
000592 4592 23               6      INC HL
000593 4593 77               7      LD  (HL),A
000594 4594 23               6      INC HL
000595 4595 223CF1          16      LD  (_BUF_EN),HL
000598 4598 183B            12      JR  RLOAD_END1
                                
       459A                     ROM_LOAD:
00059A 459A CD2547          17      CALL    INIT_PARAM
00059D 459D CD0F4A          17      CALL    FILE_B
0005A0 45A0 3A54F1          13      LD  A,(FNAME)
0005A3 45A3 FE20             7      CP  020H
0005A5 45A5 CA0A4A          10      JP  Z,ROM_ORG
                                
0005A8 45A8 CD534B          17      CALL    ROM_OPEN
0005AB 45AB 3845            12      JR  C,ERROR_FILE_NOT_FOUND
                                
0005AD 45AD 2139F1          10      LD  HL,_BUF
0005B0 45B0 222FF1          16      LD  (_DTA),HL
0005B3 45B3 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
0005B6 45B6 CD6F49          17      CALL    ROM_READ
0005B9 45B9 3A39F1          13      LD  A,(_BUF)
0005BC 45BC 3C               4      INC A
0005BD 45BD C2F444          10      JP  NZ,ROM_LOAD_ASCII
0005C0 45C0 2A76F6          16      LD  HL,(TXTTAB)
0005C3 45C3 222FF1          16      LD  (_DTA),HL
0005C6 45C6 EB               4      EX  DE,HL
0005C7 45C7 2100FF          10      LD  HL,-256
0005CA 45CA 39              11      ADD HL,SP
0005CB 45CB ED52            15      SBC HL,DE
0005CD 45CD CD6F49          17      CALL    ROM_READ
0005D0 45D0 ED5B2FF1        20      LD  DE,(_DTA)
0005D4 45D4 19              11      ADD HL,DE
       45D5                     RLOAD_END1:
0005D5 45D5 22C2F6          16      LD  (VARTAB),HL
0005D8 45D8 22C4F6          16      LD  (ARYTAB),HL
0005DB 45DB 22C6F6          16      LD  (STREND),HL
                                
0005DE 45DE AF               4      XOR A
0005DF 45DF 213CF1          10      LD  HL,_BUF+3
0005E2 45E2 77               7      LD  (HL),A
0005E3 45E3 2B               6      DEC HL
0005E4 45E4 77               7      LD  (HL),A
0005E5 45E5 2B               6      DEC HL
0005E6 45E6 77               7      LD  (HL),A
0005E7 45E7 2B               6      DEC HL
0005E8 45E8 3E8F             7      LD  A,08FH          ;REM
0005EA 45EA 77               7      LD  (HL),A
0005EB 45EB C9              10      RET
                                
       45EC                     ERROR_DIRECT_IN_FILE:
0005EC 45EC 1E39             7      LD  E,57            ;Direct statement in file
0005EE 45EE 01                      DB  1           ;LD BC,
       45EF                     ERROR_FILE_NOT_OPEN:
0005EF 45EF 1E3B             7      LD  E,59            ;File not OPEN
0005F1 45F1 01                      DB  1           ;LD BC,
       45F2                     ERROR_FILE_NOT_FOUND:
0005F2 45F2 1E35             7      LD  E,53            ;File not found
       45F4                     ERROR:
0005F4 45F4 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0005F8 45F8 DD216F40        14      LD  IX,ERRHAND
0005FC 45FC C31C00          10      JP  _CALSLT
                                
       45FF                     ROM_BLOAD:
0005FF 45FF CD2547          17      CALL    INIT_PARAM
000602 4602 CD0F4A          17      CALL    FILE_B
000605 4605 CD534B          17      CALL    ROM_OPEN
000608 4608 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
00060A 460A 2139F1          10      LD  HL,_BUF
00060D 460D 222FF1          16      LD  (_DTA),HL
000610 4610 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
000613 4613 CD6F49          17      CALL    ROM_READ
000616 4616 3A39F1          13      LD  A,(_BUF)
000619 4619 FEFE             7      CP  0FEH
00061B 461B 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
00061D 461D 210EF1          10      LD  HL,BLOAD_RET
000620 4620 2206F1          16      LD  (SWC_BLOAD),HL
                                
000623 4623 2A51F1          16      LD  HL,(PARAM1)
000626 4626 7E               7      LD  A,(HL)
000627 4627 FE2C             7      CP  ','
000629 4629 2048            12      JR  NZ,RBREAD_MEM
00062B 462B 23               6      INC HL
00062C 462C 7E               7      LD  A,(HL)
00062D 462D CD3D4B          17      CALL    CAP
000630 4630 32BEFC          13      LD  (RUNBNF),A
       4633                     RBOS1:
000633 4633 7E               7      LD  A,(HL)
000634 4634 23               6      INC HL
000635 4635 B7               4      OR  A
000636 4636 282F            12      JR  Z,RBREAD_OSE
000638 4638 FE3A             7      CP  ':'
00063A 463A 282B            12      JR  Z,RBREAD_OSE
00063C 463C FE2C             7      CP  ','     ;次のパラメータを探す
00063E 463E 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
000640 4640 2251F1          16      LD  (PARAM1),HL
000643 4643 7E               7      LD  A,(HL)
000644 4644 B7               4      OR  A
000645 4645 2820            12      JR  Z,RBREAD_OSE
000647 4647 DD21644C        14      LD  IX,FRMEVL
00064B 464B FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00064F 464F CD1C00          17      CALL    _CALSLT
000652 4652 2251F1          16      LD  (PARAM1),HL
000655 4655 3A63F6          13      LD  A,(VALTYP)
000658 4658 FE02             7      CP  2
00065A 465A 200B            12      JR  NZ,RBREAD_OSE
00065C 465C 2A3AF1          16      LD  HL,(_BUF_ST)
00065F 465F ED5BF8F7        20      LD  DE,(DACDAT)
000663 4663 19              11      ADD HL,DE
000664 4664 223AF1          16      LD  (_BUF_ST),HL
       4667                     RBREAD_OSE:
000667 4667 3ABEFC          13      LD  A,(RUNBNF)
00066A 466A FE53             7      CP  'S'
00066C 466C 2005            12      JR  NZ,RBREAD_MEM
00066E 466E 3E01             7      LD  A,1
000670 4670 3231F1          13      LD  (FLG_LDIR),A
       4673                     RBREAD_MEM:
000673 4673 2A3AF1          16      LD  HL,(_BUF_ST)
000676 4676 22BFFC          16      LD  (SAVENT),HL
000679 4679 222FF1          16      LD  (_DTA),HL
00067C 467C 21FFFF          10      LD  HL,0FFFFH
00067F 467F CD6F49          17      CALL    ROM_READ
000682 4682 3ABEFC          13      LD  A,(RUNBNF)
000685 4685 FE52             7      CP  'R'
000687 4687 2006            12      JR  NZ,RBREAD1
000689 4689 2A3EF1          16      LD  HL,(_BUF_EX)
00068C 468C 2206F1          16      LD  (SWC_BLOAD),HL
       468F                     RBREAD1:
       468F                     ROM_NEXT:
00068F 468F 2A51F1          16      LD  HL,(PARAM1)
000692 4692 7E               7      LD  A,(HL)
000693 4693 2B               6      DEC HL
000694 4694 B7               4      OR  A
000695 4695 2805            12      JR  Z,RN1
000697 4697 FE3A             7      CP  ':'
000699 4699 2801            12      JR  Z,RN1
00069B 469B 23               6      INC HL
       469C                     RN1:
00069C 469C 5D               4      LD  E,L
00069D 469D 54               4      LD  D,H
                                
00069E 469E CD0F4B          17      CALL    SEARCH_END
0006A1 46A1 B7               4      OR  A
0006A2 46A2 281A            12      JR  Z,REM
                                                    ;マルチステートメントの処理
0006A4 46A4 7E               7      LD  A,(HL)
                                
0006A5 46A5 FEB5             7      CP  0B5H            ;LOAD
0006A7 46A7 CA9A45          10      JP  Z,ROM_LOAD
0006AA 46AA FE8A             7      CP  08AH            ;RUN
0006AC 46AC 2814            12      JR  Z,ROM_RUN
0006AE 46AE FEB7             7      CP  0B7H            ;FILES
0006B0 46B0 281D            12      JR  Z,ROM_FILES
0006B2 46B2 FED6             7      CP  0D6H            ;COPY
0006B4 46B4 CA5447          10      JP  Z,ROM_COPY
0006B7 46B7 3E28             7      LD  A,028H          ;JR Z,
0006B9 46B9 320CF1          13      LD  (SWC_BLOAD_M),A
0006BC 46BC 7E               7      LD  A,(HL)
0006BD 46BD C9              10      RET
                                
       46BE                     REM:
0006BE 46BE EB               4      EX  DE,HL
0006BF 46BF 3E8F             7      LD  A,08FH          ;REM
0006C1 46C1 C9              10      RET
                                
       46C2                     ROM_RUN:
0006C2 46C2 23               6      INC HL
0006C3 46C3 7E               7      LD  A,(HL)
0006C4 46C4 2B               6      DEC HL
0006C5 46C5 B7               4      OR  A
0006C6 46C6 2803            12      JR  Z,ROM_RUN1
0006C8 46C8 CD9A45          17      CALL    ROM_LOAD
       46CB                     ROM_RUN1:
0006CB 46CB 3E8A             7      LD  A,08AH          ;RUN
0006CD 46CD 77               7      LD  (HL),A
0006CE 46CE C9              10      RET
                                
       46CF                     ROM_FILES:
0006CF 46CF CD2547          17      CALL    INIT_PARAM
0006D2 46D2 CD0F4A          17      CALL    FILE_B
0006D5 46D5 CD444F          17      CALL    GET_DISK_BANK_FDRV
0006D8 46D8 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0006DB 46DB 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0006DE 46DE 3A54F1          13      LD  A,(FNAME)
0006E1 46E1 FE21             7      CP  021H
0006E3 46E3 3005            12      JR  NC,RFILES0
0006E5 46E5 060B             7      LD  B,11
0006E7 46E7 CDA34A          17      CALL    FILE10
       46EA                     RFILES0:
0006EA 46EA CD704D          17      CALL    GET_DIR_DAT
       46ED                     RFILES1:
0006ED 46ED CD6F4B          17      CALL    FILESE
0006F0 46F0 302E            12      JR  NC,RFILES_NOT_MATCH
       46F2                     RFILES_DISP:
0006F2 46F2 E5              11      PUSH    HL
0006F3 46F3 0608             7      LD  B,8
0006F5 46F5 CD9143          17      CALL    MSN
0006F8 46F8 3E2E             7      LD  A,'.'
0006FA 46FA CDA14F          17      CALL    MSG_A
0006FD 46FD 0603             7      LD  B,3
0006FF 46FF CD9143          17      CALL    MSN
000702 4702 3ADDF3          13      LD  A,(CSRX)
000705 4705 47               4      LD  B,A
000706 4706 3AB0F3          13      LD  A,(LINLEN)
000709 4709 90               4      SUB B
00070A 470A FE0C             7      CP  12
00070C 470C 3009            12      JR  NC,RFILES2
00070E 470E 3E0D             7      LD  A,00DH      ;改行
000710 4710 CDA14F          17      CALL    MSG_A
000713 4713 3E0A             7      LD  A,00AH
000715 4715 1802            12      JR  RFILES3
       4717                     RFILES2:
000717 4717 3E20             7      LD  A,020H
       4719                     RFILES3:
000719 4719 CDA14F          17      CALL    MSG_A
00071C 471C E1              10      POP HL
00071D 471D CD8B4B          17      CALL    FNEXT
       4720                     RFILES_NOT_MATCH:
000720 4720 20CB            12      JR  NZ,RFILES1
000722 4722 C38F46          10      JP  ROM_NEXT
                                
       4725                     INIT_PARAM:
000725 4725 224FF1          16      LD  (PARAM0),HL
000728 4728 2251F1          16      LD  (PARAM1),HL
00072B 472B EB               4      EX  DE,HL
00072C 472C AF               4      XOR A
00072D 472D 3231F1          13      LD  (FLG_LDIR),A
000730 4730 32BEFC          13      LD  (RUNBNF),A
000733 4733 3263F6          13      LD  (VALTYP),A
000736 4736 13               6      INC DE
000737 4737 CDDF4A          17      CALL    SPCUT
00073A 473A 1A               7      LD  A,(DE)
00073B 473B B7               4      OR  A
00073C 473C C8              11      RET Z
00073D 473D FE3A             7      CP  ':'
00073F 473F C8              11      RET Z
000740 4740 FE28             7      CP  '('
000742 4742 C8              11      RET Z
000743 4743 EB               4      EX  DE,HL
000744 4744 DD21644C        14      LD  IX,FRMEVL
000748 4748 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00074C 474C CD1C00          17      CALL    _CALSLT
00074F 474F 2251F1          16      LD  (PARAM1),HL
000752 4752 C9              10      RET
                                
000753 4753 00               4      NOP
       4754                     ROM_COPY:
000754 4754 CD2547          17      CALL    INIT_PARAM
000757 4757 3A63F6          13      LD  A,(VALTYP)
00075A 475A FE03             7      CP  3       ;string
00075C 475C C20A4A          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
00075F 475F CD0F4A          17      CALL    FILE_B
000762 4762 CD534B          17      CALL    ROM_OPEN
000765 4765 DAF245          10      JP  C,ERROR_FILE_NOT_FOUND
                                
000768 4768 213EF1          10      LD  HL,_BUF_W
00076B 476B 222FF1          16      LD  (_DTA),HL
00076E 476E 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
000771 4771 CD6F49          17      CALL    ROM_READ
                                
000774 4774 AF               4      XOR A
000775 4775 3239F1          13      LD  (_BUF_LO),A     ;PSET
000778 4778 3246F1          13      LD  (_BUF_O),A      ;向き
                                
00077B 477B 2A51F1          16      LD  HL,(PARAM1)
       477E                     RCP_PARAM1:
00077E 477E 7E               7      LD  A,(HL)
00077F 477F 23               6      INC HL
000780 4780 B7               4      OR  A
000781 4781 CA0A4A          10      JP  Z,ROM_ORG
000784 4784 FE3A             7      CP  ':'
000786 4786 CA0A4A          10      JP  Z,ROM_ORG
000789 4789 FE2C             7      CP  ','
00078B 478B 2012            12      JR  NZ,RCP_PARAM1_
                                
00078D 478D DD212F54        14      LD  IX,FRMQNT
000791 4791 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000795 4795 CD1C00          17      CALL    _CALSLT
000798 4798 7B               4      LD  A,E
000799 4799 87               4      ADD A,A
00079A 479A 87               4      ADD A,A
00079B 479B 3246F1          13      LD  (_BUF_O),A
00079E 479E 7E               7      LD  A,(HL)
       479F                     RCP_PARAM1_:
00079F 479F FE28             7      CP  '('
0007A1 47A1 20DB            12      JR  NZ,RCP_PARAM1
                                
0007A3 47A3 DD212F54        14      LD  IX,FRMQNT
0007A7 47A7 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007AB 47AB CD1C00          17      CALL    _CALSLT
                                
0007AE 47AE ED5342F1        20      LD  (_BUF_X),DE
                                
       47B2                     RCP_PARAM2:
0007B2 47B2 23               6      INC HL
0007B3 47B3 7E               7      LD  A,(HL)
0007B4 47B4 FE20             7      CP  020H
0007B6 47B6 28FA            12      JR  Z,RCP_PARAM2
0007B8 47B8 FE2C             7      CP  ','
0007BA 47BA 28F6            12      JR  Z,RCP_PARAM2
                                
0007BC 47BC DD212F54        14      LD  IX,FRMQNT
0007C0 47C0 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007C4 47C4 CD1C00          17      CALL    _CALSLT
                                
0007C7 47C7 ED5344F1        20      LD  (_BUF_Y),DE
       47CB                     RCP_PARAM3:
0007CB 47CB 23               6      INC HL
0007CC 47CC 7E               7      LD  A,(HL)
0007CD 47CD FE20             7      CP  020H
0007CF 47CF 28FA            12      JR  Z,RCP_PARAM3
0007D1 47D1 FE29             7      CP  ')'
0007D3 47D3 28F6            12      JR  Z,RCP_PARAM3
0007D5 47D5 FE2C             7      CP  ','
0007D7 47D7 2033            12      JR  NZ,RCP_ST
                                
0007D9 47D9 23               6      INC HL
0007DA 47DA DD212F54        14      LD  IX,FRMQNT
0007DE 47DE FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007E2 47E2 CD1C00          17      CALL    _CALSLT
                                
0007E5 47E5 7B               4      LD  A,E
0007E6 47E6 3245F1          13      LD  (_BUF_P),A
                                
       47E9                     RCP_PARAM4:
0007E9 47E9 7E               7      LD  A,(HL)
0007EA 47EA 23               6      INC HL
0007EB 47EB FE20             7      CP  020H
0007ED 47ED 28FA            12      JR  Z,RCP_PARAM4
                                
0007EF 47EF FE2C             7      CP  ','
0007F1 47F1 2019            12      JR  NZ,RCP_ST
                                
0007F3 47F3 7E               7      LD  A,(HL)
0007F4 47F4 0604             7      LD  B,4
0007F6 47F6 FEC3             7      CP  0C3H        ;PRESET
0007F8 47F8 280E            12      JR  Z,RCP_LO
0007FA 47FA 05               4      DEC B       ;3
0007FB 47FB D6F8             7      SUB 0F8H        ;XOR
0007FD 47FD 2809            12      JR  Z,RCP_LO
0007FF 47FF 05               4      DEC B       ;2
000800 4800 3C               4      INC A       ;OR
000801 4801 2805            12      JR  Z,RCP_LO
000803 4803 05               4      DEC B       ;1
000804 4804 3C               4      INC A       ;AND
000805 4805 2801            12      JR  Z,RCP_LO
000807 4807 05               4      DEC B       ;0
                                                ;PSET
       4808                     RCP_LO:
000808 4808 78               4      LD  A,B
000809 4809 3239F1          13      LD  (_BUF_LO),A
       480C                     RCP_ST:
00080C 480C 2AC6F6          16      LD  HL,(STREND)
00080F 480F 222FF1          16      LD  (_DTA),HL
000812 4812 EB               4      EX  DE,HL
000813 4813 2100FE          10      LD  HL,-512
000816 4816 39              11      ADD HL,SP
000817 4817 AF               4      XOR A
000818 4818 ED52            15      SBC HL,DE
00081A 481A 3008            12      JR  NC,RCP0
00081C 481C 215EF5          10      LD  HL,BUF
00081F 481F 222FF1          16      LD  (_DTA),HL
000822 4822 6F               4      LD  L,A ;0
000823 4823 67               4      LD  H,A ;0
       4824                     RCP0:
000824 4824 24               4      INC H
000825 4825 223CF1          16      LD  (_BUF_EN),HL
       4828                     RCP1:
000828 4828 F3               4      DI
000829 4829 CDFD48          17      CALL    WAIT_VDP
                                
00082C 482C 3A0700          13      LD  A,(WRVDP)
00082F 482F 4F               4      LD  C,A
000830 4830 0C               4      INC C       ;C := PORT#1's address(WR)
000831 4831 3E24             7      LD  A,36
000833 4833 ED79            12      OUT (C),A
000835 4835 3E91             7      LD  A,080H+17
000837 4837 ED79            12      OUT (C),A       ;R#17 := 36
                                
000839 4839 0C               4      INC C
00083A 483A 0C               4      INC C       ;C := PORT#3's address(WR)
00083B 483B 2A42F1          16      LD  HL,(_BUF_X)
00083E 483E ED69            12      OUT (C),L       ;R#36 DX
000840 4840 ED61            12      OUT (C),H       ;R#37
000842 4842 2A44F1          16      LD  HL,(_BUF_Y)
000845 4845 ED69            12      OUT (C),L       ;R#38 DY
000847 4847 ED61            12      OUT (C),H       ;R#39
000849 4849 2A3EF1          16      LD  HL,(_BUF_W)
00084C 484C ED69            12      OUT (C),L       ;R#40 NX
00084E 484E ED61            12      OUT (C),H       ;R#41
000850 4850 2A40F1          16      LD  HL,(_BUF_H)
000853 4853 ED69            12      OUT (C),L       ;R#42 NY
000855 4855 ED61            12      OUT (C),H       ;R#43
                                
000857 4857 DD2AAFFC        20      LD  IX,(SCRMOD)
00085B 485B 3A39F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00085E 485E B7               4      OR  A
00085F 485F 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000861 4861 DD7D             9      LD  A,IXL
000863 4863 FE08             7      CP  8
000865 4865 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
000867 4867 FE06             7      CP  6
000869 4869 2A42F1          16      LD  HL,(_BUF_X)
00086C 486C 3A3EF1          13      LD  A,(_BUF_W)
00086F 486F 2005            12      JR  NZ,SCR57
000871 4871 B5               4      OR  L       ;スクリーン6
000872 4872 E603             7      AND 3
000874 4874 200D            12      JR  NZ,USE_LMMC
       4876                     SCR57:              ;スクリーン5,7
000876 4876 B5               4      OR  L
000877 4877 E601             7      AND 1
000879 4879 2008            12      JR  NZ,USE_LMMC
       487B                     USE_HMMC:
00087B 487B DD2E08          10      LD  IXL,8
       487E                     USE_HMMC8:
00087E 487E 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
000880 4880 3239F1          13      LD  (_BUF_LO),A
       4883                     USE_LMMC:
000883 4883 110000          10      LD  DE,0
000886 4886 06FF             7      LD  B,-1
000888 4888 CD2849          17      CALL    GET_PIXEL
00088B 488B ED79            12      OUT (C),A       ;R#44 first DATA
00088D 488D 3A46F1          13      LD  A,(_BUF_O)
000890 4890 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
000892 4892 3A39F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000895 4895 F6B0             7      OR  0B0H        ;R#46 LMMC command
000897 4897 ED79            12      OUT (C),A
                                
000899 4899 FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
00089B 489B 0D               4      DEC C
00089C 489C 0D               4      DEC C       ;C := PORT#1's address(WR)
00089D 489D 3EAC             7      LD  A,080H+44
00089F 489F ED79            12      OUT (C),A
0008A1 48A1 3E91             7      LD  A,080H+17
0008A3 48A3 ED79            12      OUT (C),A       ;R#17 := 44
                                
0008A5 48A5 3A0600          13      LD  A,(RDVDP)
0008A8 48A8 3C               4      INC A
0008A9 48A9 FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
0008AB 48AB 3E02             7      LD  A,2
0008AD 48AD ED79            12      OUT (C),A
0008AF 48AF 3E8F             7      LD  A,08FH
0008B1 48B1 ED79            12      OUT (C),A
0008B3 48B3 3A39F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0008B6 48B6 E640             7      AND 040H
0008B8 48B8 201C            12      JR  NZ,LOOP_HMMC
       48BA                     LOOP_COPY:
0008BA 48BA CD2849          17      CALL    GET_PIXEL
0008BD 48BD 08               4      EX  AF,AF'
0008BE 48BE FD4C             9      LD  C,IYH
       48C0                     LOOP_COPY1:
0008C0 48C0 ED78            12      IN  A,(C)
0008C2 48C2 0F               4      RRCA            ;RRCAではサインフラグは変化しない
0008C3 48C3 300A            12      JR  NC,EXIT_COPY    ;check CE bit
0008C5 48C5 F2C048          10      JP  P,LOOP_COPY1    ;check TR bit
0008C8 48C8 08               4      EX  AF,AF'
0008C9 48C9 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
0008CB 48CB ED79            12      OUT (C),A
0008CD 48CD 18EB            12      JR  LOOP_COPY
                                
       48CF                     EXIT_COPY:
0008CF 48CF CD0549          17      CALL    GET_STATUS_0
0008D2 48D2 FB               4      EI
0008D3 48D3 C38F46          10      JP  ROM_NEXT
                                
       48D6                     LOOP_HMMC:
0008D6 48D6 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
0008D8 48D8 43               4      LD  B,E
0008D9 48D9 7B               4      LD  A,E
0008DA 48DA B7               4      OR  A
0008DB 48DB 2802            12      JR  Z,LOOP_HMMC1
0008DD 48DD EDB3                    OTIR
       48DF                     LOOP_HMMC1:
0008DF 48DF 14               4      INC D
       48E0                     LOOP_HMMC2:
0008E0 48E0 15               4      DEC D
0008E1 48E1 2805            12      JR  Z,LOOP_HMMC3
0008E3 48E3 EDB3                    OTIR
0008E5 48E5 C3E048          10      JP  LOOP_HMMC2
       48E8                     LOOP_HMMC3:
0008E8 48E8 ED78            12      IN  A,(C)
0008EA 48EA 0F               4      RRCA
0008EB 48EB 30E2            12      JR  NC,EXIT_COPY    ;check CE bit
0008ED 48ED 2A3CF1          16      LD  HL,(_BUF_EN)
0008F0 48F0 CD6F49          17      CALL    ROM_READ
0008F3 48F3 EB               4      EX  DE,HL
0008F4 48F4 2A2FF1          16      LD  HL,(_DTA)
0008F7 48F7 7A               4      LD  A,D
0008F8 48F8 B3               4      OR  E
0008F9 48F9 20DB            12      JR  NZ,LOOP_HMMC
0008FB 48FB 18C3            12      JR  LOOP_COPY1
                                    
       48FD                     WAIT_VDP:
0008FD 48FD 3E02             7      LD  A,2
0008FF 48FF CD0649          17      CALL    GET_STATUS
000902 4902 0F               4      RRCA
000903 4903 38F8            12      JR  C,WAIT_VDP
       4905                     GET_STATUS_0:
000905 4905 AF               4      XOR A
       4906                     GET_STATUS:
000906 4906 C5              11      PUSH    BC
000907 4907 ED4B0600        20      LD  BC,(RDVDP)
00090B 490B 0C               4      INC C
00090C 490C ED79            12      OUT (C),A
00090E 490E 3E8F             7      LD  A,08FH
000910 4910 ED79            12      OUT (C),A
000912 4912 ED78            12      IN  A,(C)
000914 4914 C1              10      POP BC
000915 4915 C9              10      RET
                                
       4916                     GET_PIXEL256:
000916 4916 7A               4      LD  A,D
000917 4917 B3               4      OR  E
000918 4918 200A            12      JR  NZ,GET_PIXEL1
00091A 491A 2A3CF1          16      LD  HL,(_BUF_EN)
00091D 491D CD6F49          17      CALL    ROM_READ
000920 4920 EB               4      EX  DE,HL
000921 4921 2A2FF1          16      LD  HL,(_DTA)
       4924                     GET_PIXEL1:
000924 4924 7E               7      LD  A,(HL)
000925 4925 23               6      INC HL
000926 4926 1B               6      DEC DE
000927 4927 C9              10      RET
                                
       4928                     GET_PIXEL:
000928 4928 04               4      INC B
000929 4929 DD7D             9      LD  A,IXL
00092B 492B FE08             7      CP  8
00092D 492D 28E7            12      JR  Z,GET_PIXEL256
00092F 492F FE06             7      CP  6
000931 4931 282E            12      JR  Z,GET_PIXEL4
                                
000933 4933 CB40             8      BIT 0,B
000935 4935 20ED            12      JR  NZ,GET_PIXEL1
                                
000937 4937 7A               4      LD  A,D
000938 4938 B3               4      OR  E
000939 4939 200A            12      JR  NZ,GET_PIXEL2
                                
00093B 493B 2A3CF1          16      LD  HL,(_BUF_EN)
00093E 493E CD6F49          17      CALL    ROM_READ
000941 4941 EB               4      EX  DE,HL
000942 4942 2A2FF1          16      LD  HL,(_DTA)
                                
       4945                     GET_PIXEL2:
000945 4945 7E               7      LD  A,(HL)
000946 4946 0F               4      RRCA
000947 4947 0F               4      RRCA
000948 4948 0F               4      RRCA
000949 4949 0F               4      RRCA
00094A 494A C9              10      RET
                                
       494B                     GET_PIXEL3:
00094B 494B 7A               4      LD  A,D
00094C 494C B3               4      OR  E
00094D 494D 200A            12      JR  NZ,GET_PIXEL5
                                
00094F 494F 2A3CF1          16      LD  HL,(_BUF_EN)
000952 4952 CD6F49          17      CALL    ROM_READ
000955 4955 EB               4      EX  DE,HL
000956 4956 2A2FF1          16      LD  HL,(_DTA)
       4959                     GET_PIXEL5:
000959 4959 7E               7      LD  A,(HL)
00095A 495A 0F               4      RRCA
00095B 495B 0F               4      RRCA
00095C 495C 0F               4      RRCA
00095D 495D 0F               4      RRCA
00095E 495E 0F               4      RRCA
00095F 495F 0F               4      RRCA
000960 4960 C9              10      RET
                                
       4961                     GET_PIXEL4:
000961 4961 78               4      LD  A,B
000962 4962 E603             7      AND 3   ;+0
000964 4964 28E5            12      JR  Z,GET_PIXEL3
000966 4966 3D               4      DEC A   ;+1
000967 4967 28DC            12      JR  Z,GET_PIXEL2
000969 4969 3D               4      DEC A   ;+2
00096A 496A 7E               7      LD  A,(HL)
00096B 496B C0              11      RET NZ
00096C 496C 0F               4      RRCA        ;+3
00096D 496D 0F               4      RRCA
00096E 496E C9              10      RET
                                
       496F                     ROM_READ:
00096F 496F E5              11      PUSH    HL
000970 4970 D5              11      PUSH    DE
000971 4971 C5              11      PUSH    BC
000972 4972 FDE5            15      PUSH    IY
000974 4974 224DF1          16      LD  (LEFTX),HL
000977 4977 2A2FF1          16      LD  HL,(_DTA)
00097A 497A 2247F1          16      LD  (DTAX),HL
00097D 497D 2A4DF1          16      LD  HL,(LEFTX)
                                
000980 4980 CDB74B          17      CALL    RBX1
000983 4983 3870            12      JR  C,RBRERR1
000985 4985 79               4      LD  A,C
000986 4986 EB               4      EX  DE,HL
000987 4987 ED52            15      SBC HL,DE       ;CP 0HL,CDE
000989 4989 19              11      ADD HL,DE
00098A 498A DE00             7      SBC A,000H
00098C 498C 3801            12      JR  C,RBR1
00098E 498E EB               4      EX  DE,HL
       498F                     RBR1:
00098F 498F 9F               4      SBC A,A
000990 4990 E601             7      AND 1
000992 4992 321FF1          13      LD  (_RESULT),A
000995 4995 7C               4      LD  A,H
000996 4996 B5               4      OR  L
000997 4997 CAEB49          10      JP  Z,RBREND0
                                
00099A 499A 222BF1          16      LD  (_LEFT),HL  ;Read record byte
00099D 499D 224DF1          16      LD  (LEFTX),HL
                                
0009A0 49A0 CDDD4B          17      CALL    RBX2
0009A3 49A3 281A            12      JR  Z,RBRB
                                                ;先頭の端数
0009A5 49A5 CDF04B          17      CALL    RBXA
0009A8 49A8 DA014A          10      JP  C,RBRERR
0009AB 49AB C5              11      PUSH    BC
0009AC 49AC CD2C44          17      CALL    ROM_LDIR
0009AF 49AF ED5347F1        20      LD  (DTAX),DE
0009B3 49B3 2A4DF1          16      LD  HL,(LEFTX)
0009B6 49B6 D1              10      POP DE
0009B7 49B7 A7               4      AND A
0009B8 49B8 ED52            15      SBC HL,DE
0009BA 49BA 224DF1          16      LD  (LEFTX),HL
0009BD 49BD 2829            12      JR  Z,RBREND
                                
       49BF                     RBRB:
0009BF 49BF CD2C4C          17      CALL    RBXB
0009C2 49C2 2818            12      JR  Z,RBRC
       49C4                     RBRB1:
0009C4 49C4 C5              11      PUSH    BC
0009C5 49C5 D5              11      PUSH    DE
0009C6 49C6 CDD44C          17      CALL    CLUST
0009C9 49C9 EB               4      EX  DE,HL
0009CA 49CA ED4B21F1        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
0009CE 49CE CD2C44          17      CALL    ROM_LDIR
0009D1 49D1 EB               4      EX  DE,HL
0009D2 49D2 D1              10      POP DE
0009D3 49D3 C1              10      POP BC
0009D4 49D4 CDB14C          17      CALL    GNCL
0009D7 49D7 DA014A          10      JP  C,RBRERR
0009DA 49DA 10E8            13      DJNZ    RBRB1
       49DC                     RBRC:
0009DC 49DC CD444C          17      CALL    RBXC
0009DF 49DF 2807            12      JR  Z,RBREND
                                
0009E1 49E1 CDD44C          17      CALL    CLUST
0009E4 49E4 EB               4      EX  DE,HL
0009E5 49E5 CD2C44          17      CALL    ROM_LDIR
       49E8                     RBREND:
0009E8 49E8 CD504C          17      CALL    RBXEND
       49EB                     RBREND0:
0009EB 49EB FDE1            14      POP IY
0009ED 49ED C1              10      POP BC
0009EE 49EE D1              10      POP DE
0009EF 49EF F1              10      POP AF  ;(HL)
0009F0 49F0 AF               4      XOR A
0009F1 49F1 3A1FF1          13      LD  A,(_RESULT)
0009F4 49F4 C9              10      RET
                                
       49F5                     RBRERR1:
0009F5 49F5 3E01             7      LD  A,001H
       49F7                     RBRERR2:
0009F7 49F7 FDE1            14      POP IY
0009F9 49F9 C1              10      POP BC
0009FA 49FA D1              10      POP DE
0009FB 49FB E1              10      POP HL
0009FC 49FC 37               4      SCF
0009FD 49FD 210000          10      LD  HL,0
000A00 4A00 C9              10      RET
       4A01                     RBRERR:
000A01 4A01 3EFF             7      LD  A,0FFH
000A03 4A03 18F2            12      JR  RBRERR2
                                
       4A05                     FILE_DD:
000A05 4A05 3E                      DB  03EH
000A06 4A06 C9              10      RET
000A07 4A07 320CF1          13      LD  (SWC_BLOAD_M),A
       4A0A                     ROM_ORG:
000A0A 4A0A 2A4FF1          16      LD  HL,(PARAM0)
000A0D 4A0D 7E               7      LD  A,(HL)
000A0E 4A0E C9              10      RET
       4A0F                     FILE_B:
000A0F 4A0F AF               4      XOR A
000A10 4A10 3253F1          13      LD  (FDRV),A
000A13 4A13 1E00             7      LD  E,0
000A15 4A15 3A63F6          13      LD  A,(VALTYP)
000A18 4A18 FE03             7      CP  3       ;string
000A1A 4A1A 2044            12      JR  NZ,FILED
                                
000A1C 4A1C DD21D067        14      LD  IX,FRESTR
000A20 4A20 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000A24 4A24 CD1C00          17      CALL    _CALSLT
000A27 4A27 E5              11      PUSH    HL
000A28 4A28 DDE1            14      POP IX
                                
000A2A 4A2A DD5E00          19      LD  E,(IX+0)
000A2D 4A2D DD7E01          19      LD  A,(IX+1)
000A30 4A30 DD5602          19      LD  D,(IX+2)
000A33 4A33 DD62             9      LD  IXH,D
000A35 4A35 DD6F             9      LD  IXL,A
000A37 4A37 7B               4      LD  A,E
000A38 4A38 FE04             7      CP  4
000A3A 4A3A 3808            12      JR  C,FILEB1
000A3C 4A3C DD7E03          19      LD  A,(IX+3)
000A3F 4A3F FE3A             7      CP  ':'
000A41 4A41 28C2            12      JR  Z,FILE_DD
000A43 4A43 7B               4      LD  A,E
       4A44                     FILEB1:
000A44 4A44 FE02             7      CP  2
000A46 4A46 3818            12      JR  C,FILED
000A48 4A48 DD7E01          19      LD  A,(IX+1)
000A4B 4A4B FE3A             7      CP  ':'
000A4D 4A4D 2011            12      JR  NZ,DEVI1
000A4F 4A4F DD7E00          19      LD  A,(IX+0)        ;DRIVE
000A52 4A52 CD3D4B          17      CALL    CAP
000A55 4A55 D640             7      SUB '@'
000A57 4A57 DD23            10      INC IX
000A59 4A59 DD23            10      INC IX
000A5B 4A5B 1D               4      DEC E
000A5C 4A5C 1D               4      DEC E
000A5D 4A5D 3253F1          13      LD  (FDRV),A
       4A60                     DEVI1:
                                
       4A60                     FILED:
000A60 4A60 CDA74A          17      CALL    FILEI
000A63 4A63 2154F1          10      LD  HL,FNAME
                                
000A66 4A66 0608             7      LD  B,8
       4A68                     FILE2:
000A68 4A68 CDB44A          17      CALL    CCHKF
000A6B 4A6B C8              11      RET Z
000A6C 4A6C FE2A             7      CP  '*'
000A6E 4A6E 282E            12      JR  Z,FILE9
000A70 4A70 FE2E             7      CP  '.'
000A72 4A72 280C            12      JR  Z,FILE4
000A74 4A74 77               7      LD  (HL),A
000A75 4A75 23               6      INC HL
000A76 4A76 10F0            13      DJNZ    FILE2
                                
       4A78                     FILE3:
000A78 4A78 CDB44A          17      CALL    CCHKF
000A7B 4A7B C8              11      RET Z
000A7C 4A7C FE2E             7      CP  '.'
000A7E 4A7E 20F8            12      JR  NZ,FILE3
                                
       4A80                     FILE4:
000A80 4A80 215CF1          10      LD  HL,FNAME+8
000A83 4A83 0603             7      LD  B,3
                                
       4A85                     FILE4L:
000A85 4A85 CDB44A          17      CALL    CCHKF
000A88 4A88 C8              11      RET Z
000A89 4A89 FE2E             7      CP  '.'
000A8B 4A8B 2008            12      JR  NZ,FILE12
000A8D 4A8D 3254F1          13      LD  (FNAME),A   ;Parent directory(..)
000A90 4A90 3255F1          13      LD  (FNAME+1),A
000A93 4A93 3E20             7      LD  A,020H
       4A95                     FILE12:
000A95 4A95 FE2A             7      CP  '*'
000A97 4A97 280A            12      JR  Z,FILE10
000A99 4A99 77               7      LD  (HL),A
000A9A 4A9A 23               6      INC HL
000A9B 4A9B 10E8            13      DJNZ    FILE4L
000A9D 4A9D C9              10      RET
                                
       4A9E                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000A9E 4A9E CDA34A          17      CALL    FILE10
000AA1 4AA1 18D5            12      JR  FILE3
                                
       4AA3                     FILE10:
000AA3 4AA3 3E3F             7      LD  A,'?'
000AA5 4AA5 1808            12      JR  FILL_MEMORY
       4AA7                     FILEI:              ;名前＋拡張子をスペースで初期化
000AA7 4AA7 3E20             7      LD  A,020H
000AA9 4AA9 01000B          10      LD  BC,11*256   ;C=0にしておく
000AAC 4AAC 2154F1          10      LD  HL,FNAME
       4AAF                     FILL_MEMORY:            ;HLからBバイトAで埋める
000AAF 4AAF 77               7      LD  (HL),A
000AB0 4AB0 23               6      INC HL
000AB1 4AB1 10FC            13      DJNZ    FILL_MEMORY
000AB3 4AB3 C9              10      RET
                                
       4AB4                     CCHKF:
000AB4 4AB4 7B               4      LD  A,E
000AB5 4AB5 B7               4      OR  A
000AB6 4AB6 C8              11      RET Z
000AB7 4AB7 DD7E00          19      LD  A,(IX+0)
000ABA 4ABA CDC14A          17      CALL    CCHK2
000ABD 4ABD C8              11      RET Z
000ABE 4ABE C3284B          10      JP  FKAN
                                
       4AC1                     CCHK2:
000AC1 4AC1 0C               4      INC C
000AC2 4AC2 0D               4      DEC C
000AC3 4AC3 C0              11      RET NZ
       4AC4                     CCHK3:              ;ZF=1 で使えない文字
000AC4 4AC4 FE2B             7      CP  '+'
000AC6 4AC6 C8              11      RET Z
000AC7 4AC7 FE2C             7      CP  ','
000AC9 4AC9 C8              11      RET Z
000ACA 4ACA FE2F             7      CP  '/'
000ACC 4ACC C8              11      RET Z
000ACD 4ACD FE3A             7      CP  ':'
000ACF 4ACF C8              11      RET Z
000AD0 4AD0 FE3B             7      CP  ';'
000AD2 4AD2 C8              11      RET Z
000AD3 4AD3 FE3D             7      CP  '='
000AD5 4AD5 C8              11      RET Z
000AD6 4AD6 FE5C             7      CP  05CH    ;\
000AD8 4AD8 C8              11      RET Z
000AD9 4AD9 FE1F             7      CP  01FH
000ADB 4ADB D0              11      RET NC
000ADC 4ADC BF               4      CP  A       ;Z=1
000ADD 4ADD C9              10      RET
                                
       4ADE                     SS1:
000ADE 4ADE 13               6      INC DE
       4ADF                     SPCUT:              ;スペースをカット
000ADF 4ADF 1A               7      LD  A,(DE)
000AE0 4AE0 FE20             7      CP  020H
000AE2 4AE2 28FA            12      JR  Z,SS1
000AE4 4AE4 C9              10      RET
                                
       4AE5                     SCREOF1:
000AE5 4AE5 13               6      INC DE
       4AE6                     SPCUTEX:            ;スペース改行などをカット
000AE6 4AE6 1A               7      LD  A,(DE)
000AE7 4AE7 FE20             7      CP  020H
000AE9 4AE9 28FA            12      JR  Z,SCREOF1
000AEB 4AEB FE0D             7      CP  00DH
000AED 4AED 28F6            12      JR  Z,SCREOF1
000AEF 4AEF FE0A             7      CP  00AH
000AF1 4AF1 28F2            12      JR  Z,SCREOF1
000AF3 4AF3 FE1A             7      CP  01AH
000AF5 4AF5 28EE            12      JR  Z,SCREOF1
000AF7 4AF7 C9              10      RET
                                
       4AF8                     GETNUM:
000AF8 4AF8 210000          10      LD  HL,0
       4AFB                     GETNUM1:
000AFB 4AFB 1A               7      LD  A,(DE)
000AFC 4AFC 13               6      INC DE
000AFD 4AFD D630             7      SUB '0'
000AFF 4AFF D8              11      RET C
000B00 4B00 FE0A             7      CP  10
000B02 4B02 D0              11      RET NC
000B03 4B03 4D               4      LD  C,L
000B04 4B04 44               4      LD  B,H
000B05 4B05 29              11      ADD HL,HL   ;*2
000B06 4B06 29              11      ADD HL,HL   ;*4
000B07 4B07 09              11      ADD HL,BC   ;*5
000B08 4B08 29              11      ADD HL,HL   ;*10
000B09 4B09 4F               4      LD  C,A
000B0A 4B0A 0600             7      LD  B,0
000B0C 4B0C 09              11      ADD HL,BC
000B0D 4B0D 18EC            12      JR  GETNUM1
                                
       4B0F                     SEARCH_END:
000B0F 4B0F 7E               7      LD  A,(HL)
       4B10                     SEARCH_END1:
000B10 4B10 23               6      INC HL
000B11 4B11 B7               4      OR  A
000B12 4B12 C8              11      RET Z
000B13 4B13 FE3A             7      CP  ':'
000B15 4B15 20F8            12      JR  NZ,SEARCH_END
000B17 4B17 7E               7      LD  A,(HL)
000B18 4B18 FE3A             7      CP  ':'
000B1A 4B1A 28F4            12      JR  Z,SEARCH_END1
000B1C 4B1C FE20             7      CP  020H
000B1E 4B1E 28F0            12      JR  Z,SEARCH_END1
000B20 4B20 C9              10      RET
                                
       4B21                     FKANC:
000B21 4B21 CB41             8      BIT 0,C
000B23 4B23 CC464B          17      CALL    Z,CAP2
000B26 4B26 1803            12      JR  FKANX
       4B28                     FKAN:           ;漢字チェック
000B28 4B28 DD23            10      INC IX
000B2A 4B2A 1D               4      DEC E
       4B2B                     FKANX:
000B2B 4B2B CB41             8      BIT 0,C
000B2D 4B2D CB81             8      RES 0,C
000B2F 4B2F C0              11      RET NZ
000B30 4B30 FE80             7      CP  080H
000B32 4B32 D8              11      RET C
000B33 4B33 FEA0             7      CP  0A0H
000B35 4B35 3803            12      JR  C,FKAN1
000B37 4B37 FEE0             7      CP  0E0H
000B39 4B39 D8              11      RET C
       4B3A                     FKAN1:
000B3A 4B3A 0C               4      INC C
000B3B 4B3B A7               4      AND A
000B3C 4B3C C9              10      RET
                                
       4B3D                     CAP:
000B3D 4B3D FE61             7      CP  'a'
000B3F 4B3F D8              11      RET C
000B40 4B40 FE7B             7      CP  'z'+1
000B42 4B42 D0              11      RET NC
000B43 4B43 D620             7      SUB 020H
000B45 4B45 C9              10      RET
       4B46                     CAP2:
000B46 4B46 CD3D4B          17      CALL    CAP
       4B49                     CAP3:               ;
000B49 4B49 FE05             7      CP  5
000B4B 4B4B 2803            12      JR  Z,CAP4
000B4D 4B4D FE21             7      CP  021H
000B4F 4B4F C9              10      RET
       4B50                     CAP4:
000B50 4B50 3EE5             7      LD  A,0E5H
000B52 4B52 C9              10      RET
                                
       4B53                     ROM_OPEN:
000B53 4B53 CD444F          17      CALL    GET_DISK_BANK_FDRV
                                
000B56 4B56 CD704D          17      CALL    GET_DIR_DAT
000B59 4B59 D5              11      PUSH    DE
000B5A 4B5A CD6F4B          17      CALL    FILESE
000B5D 4B5D D1              10      POP DE
000B5E 4B5E 3F               4      CCF
000B5F 4B5F D8              11      RET C
000B60 4B60 224BF1          16      LD  (FCBX),HL
000B63 4B63 E5              11      PUSH    HL
000B64 4B64 210000          10      LD  HL,0
000B67 4B67 2225F1          16      LD  (RR_LOW),HL
000B6A 4B6A 2227F1          16      LD  (RR_HIGH),HL
000B6D 4B6D E1              10      POP HL
000B6E 4B6E C9              10      RET
                                
       4B6F                     FILESE:
000B6F 4B6F 7E               7      LD  A,(HL)
000B70 4B70 B7               4      OR  A
000B71 4B71 C8              11      RET Z       ;END:ZF=1 CF=0
000B72 4B72 FEE5             7      CP  0E5H
000B74 4B74 280D            12      JR  Z,FILESE1
000B76 4B76 1154F1          10      LD  DE,FNAME
000B79 4B79 E5              11      PUSH    HL
000B7A 4B7A CD914B          17      CALL    CPFILE
000B7D 4B7D CCB24B          17      CALL    Z,CPFILE2
000B80 4B80 E1              10      POP HL
000B81 4B81 37               4      SCF
000B82 4B82 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4B83                     FILESE1:
000B83 4B83 CD8B4B          17      CALL    FNEXT
000B86 4B86 20E7            12      JR  NZ,FILESE
       4B88                     ZF0_CF0_AFF_RET:
000B88 4B88 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000B8A 4B8A C9              10      RET
                                
       4B8B                     FNEXT:
000B8B 4B8B 112000          10      LD  DE,020H
000B8E 4B8E 19              11      ADD HL,DE
000B8F 4B8F 0D               4      DEC C
                                #if exists USE_NORMAL_32K_ROM
                                #else
                                CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
                                    PUSH    AF
                                    BIT 7,H
                                    JR  Z,CHECK_DIR_PAGE1
                                    LD  A,H
                                    SUB 020H
                                    LD  H,A
                                    LD  A,(_BANK)
                                    INC A
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                CHECK_DIR_PAGE1:
                                    POP AF
                                #endif
000B90 4B90 C9              10      RET
                                
       4B91                     CPFILE:
000B91 4B91 C5              11      PUSH    BC
000B92 4B92 01000B          10      LD  BC,00B00H
       4B95                     CPSTR1:
000B95 4B95 1A               7      LD  A,(DE)
000B96 4B96 FE3F             7      CP  '?'     ;Wild card
000B98 4B98 2812            12      JR  Z,CPSTR2
000B9A 4B9A 7E               7      LD  A,(HL)
000B9B 4B9B CD214B          17      CALL    FKANC
000B9E 4B9E E5              11      PUSH    HL
000B9F 4B9F 67               4      LD  H,A
000BA0 4BA0 1A               7      LD  A,(DE)
000BA1 4BA1 CB01             4      RLC C
000BA3 4BA3 CD214B          17      CALL    FKANC
000BA6 4BA6 CB09             4      RRC C
000BA8 4BA8 BC               4      CP  H       ;CP (HL),(DE)
000BA9 4BA9 E1              10      POP HL
000BAA 4BAA 2004            12      JR  NZ,CPSTR3
       4BAC                     CPSTR2:
000BAC 4BAC 13               6      INC DE
000BAD 4BAD 23               6      INC HL
000BAE 4BAE 10E5            13      DJNZ    CPSTR1
       4BB0                     CPSTR3:
000BB0 4BB0 C1              10      POP BC
000BB1 4BB1 C9              10      RET
                                
       4BB2                     CPFILE2:
                                ;   LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
                                ;   OR  0E1H
000BB2 4BB2 3EE1             7      LD  A,0E1H
000BB4 4BB4 2F               4      CPL
000BB5 4BB5 A6               7      AND (HL)
000BB6 4BB6 C9              10      RET
                                
       4BB7                     RBX1:
000BB7 4BB7 E5              11      PUSH    HL      ;Record byte
                                
000BB8 4BB8 ED5B25F1        20      LD  DE,(RR_LOW) ;CDE=Random record
000BBC 4BBC 3A28F1          13      LD  A,(RR_HIGH+1)
000BBF 4BBF 4F               4      LD  C,A
                                
000BC0 4BC0 CD444F          17      CALL    GET_DISK_BANK_FDRV
                                
000BC3 4BC3 FD2A4BF1        20      LD  IY,(FCBX)
000BC7 4BC7 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000BCA 4BCA FD661D          19      LD  H,(IY+01DH)
000BCD 4BCD FD7E1E          19      LD  A,(IY+01EH)
                                
000BD0 4BD0 A7               4      AND A
000BD1 4BD1 ED52            15      SBC HL,DE
000BD3 4BD3 99               4      SBC A,C
000BD4 4BD4 D1              10      POP DE
                                
000BD5 4BD5 D8              11      RET C
000BD6 4BD6 4F               4      LD  C,A
000BD7 4BD7 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000BD8 4BD8 B2               4      OR  D
000BD9 4BD9 B3               4      OR  E
000BDA 4BDA C0              11      RET NZ
000BDB 4BDB 37               4      SCF
000BDC 4BDC C9              10      RET
                                
       4BDD                     RBX2:
000BDD 4BDD ED4B26F1        20      LD  BC,(RR_LOW+1)
000BE1 4BE1 CD654C          17      CALL    RWXR
000BE4 4BE4 3A22F1          13      LD  A,(CLSZ_H)
000BE7 4BE7 3D               4      DEC A
000BE8 4BE8 E5              11      PUSH    HL
000BE9 4BE9 2A25F1          16      LD  HL,(RR_LOW)
000BEC 4BEC A4               4      AND H
000BED 4BED B5               4      OR  L
000BEE 4BEE E1              10      POP HL
000BEF 4BEF C9              10      RET
                                
       4BF0                     RBXA:
000BF0 4BF0 D5              11      PUSH    DE
000BF1 4BF1 CDD44C          17      CALL    CLUST
000BF4 4BF4 ED532DF1        20      LD  (_DTPS),DE
000BF8 4BF8 D1              10      POP DE
000BF9 4BF9 CDB14C          17      CALL    GNCL
000BFC 4BFC D8              11      RET C
000BFD 4BFD ED5329F1        20      LD  (_CLPS),DE
                                
000C01 4C01 ED4B25F1        20      LD  BC,(RR_LOW)
000C05 4C05 2A21F1          16      LD  HL,(CLSZ)
000C08 4C08 7C               4      LD  A,H
000C09 4C09 3D               4      DEC A
000C0A 4C0A A0               4      AND B
000C0B 4C0B 47               4      LD  B,A
000C0C 4C0C ED42            15      SBC HL,BC       ;remaining cluster
                                
000C0E 4C0E ED5B4DF1        20      LD  DE,(LEFTX)
000C12 4C12 ED52            15      SBC HL,DE       ;CP HL,DE
000C14 4C14 19              11      ADD HL,DE
000C15 4C15 3801            12      JR  C,RBXA1
000C17 4C17 EB               4      EX  DE,HL
       4C18                     RBXA1:
000C18 4C18 3A20F1          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
000C1B 4C1B 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C1E 4C1E 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000C21 4C21 E5              11      PUSH    HL
000C22 4C22 2A2DF1          16      LD  HL,(_DTPS)
000C25 4C25 09              11      ADD HL,BC
000C26 4C26 ED5B47F1        20      LD  DE,(DTAX)
000C2A 4C2A C1              10      POP BC
000C2B 4C2B C9              10      RET
                                
       4C2C                     RBXB:
000C2C 4C2C 2A47F1          16      LD  HL,(DTAX)
000C2F 4C2F ED5B29F1        20      LD  DE,(_CLPS)
000C33 4C33 3A4EF1          13      LD  A,(LEFTX+1)
000C36 4C36 47               4      LD  B,A
000C37 4C37 3A22F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4C3A                     RBXB1:
000C3A 4C3A 1F               4      RRA     ;->CF
000C3B 4C3B 3804            12      JR  C,RBXB2
000C3D 4C3D CB38             8      SRL B   ;B=B/2
000C3F 4C3F 18F9            12      JR  RBXB1
       4C41                     RBXB2:
000C41 4C41 78               4      LD  A,B
000C42 4C42 B7               4      OR  A
000C43 4C43 C9              10      RET
                                
       4C44                     RBXC:
000C44 4C44 ED4B4DF1        20      LD  BC,(LEFTX)
000C48 4C48 3A22F1          13      LD  A,(CLSZ_H)
000C4B 4C4B 3D               4      DEC A
000C4C 4C4C A0               4      AND B
000C4D 4C4D 47               4      LD  B,A
000C4E 4C4E B1               4      OR  C
000C4F 4C4F C9              10      RET
                                
       4C50                     RBXEND:
000C50 4C50 ED5B2BF1        20      LD  DE,(_LEFT)
000C54 4C54 2A25F1          16      LD  HL,(RR_LOW)
000C57 4C57 3A28F1          13      LD  A,(RR_HIGH+1)
000C5A 4C5A 19              11      ADD HL,DE
000C5B 4C5B CE00             7      ADC A,0
000C5D 4C5D 2225F1          16      LD  (RR_LOW),HL
000C60 4C60 3228F1          13      LD  (RR_HIGH+1),A
000C63 4C63 EB               4      EX  DE,HL       ;HL=Read byte
000C64 4C64 C9              10      RET 
                                
       4C65                     RWXR:
000C65 4C65 3A22F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4C68                     L_RWX:
000C68 4C68 1F               4      RRA     ;->CF
000C69 4C69 3806            12      JR  C,E_RWX
000C6B 4C6B CB38             8      SRL B   ;BC=BC/2
000C6D 4C6D CB19             8      RR  C   ;
000C6F 4C6F 18F7            12      JR  L_RWX
       4C71                     E_RWX:
000C71 4C71 CD444F          17      CALL    GET_DISK_BANK_FDRV
                                
000C74 4C74 FD2A4BF1        20      LD  IY,(FCBX)
000C78 4C78 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000C7B 4C7B FD561B          19      LD  D,(IY+01BH)
       4C7E                     RWX1:
000C7E 4C7E ED5329F1        20      LD  (_CLPS),DE
000C82 4C82 7A               4      LD  A,D
000C83 4C83 B3               4      OR  E
000C84 4C84 37               4      SCF
000C85 4C85 C8              11      RET Z
                                
000C86 4C86 78               4      LD  A,B
000C87 4C87 B1               4      OR  C
000C88 4C88 C8              11      RET Z
                                
000C89 4C89 CDB14C          17      CALL    GNCL
000C8C 4C8C D8              11      RET C
000C8D 4C8D 0B               6      DEC BC
000C8E 4C8E CD094D          17      CALL    ENDCL
000C91 4C91 38EB            12      JR  C,RWX1
000C93 4C93 37               4      SCF
000C94 4C94 C9              10      RET
                                
       4C95                     NCL3:
000C95 4C95 CD444F          17      CALL    GET_DISK_BANK_FDRV
000C98 4C98 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000C9B 4C9B 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000C9E 4C9E 6B               4      LD  L,E
000C9F 4C9F 62               4      LD  H,D
000CA0 4CA0 CB3C             8      SRL H
000CA2 4CA2 CB1D             8      RR  L
000CA4 4CA4 1F               4      RRA
000CA5 4CA5 19              11      ADD HL,DE
000CA6 4CA6 010060          10      LD  BC,BANK1_ADR
000CA9 4CA9 09              11      ADD HL,BC
000CAA 4CAA ED4B23F1        20      LD  BC,(SECSZ)
000CAE 4CAE 09              11      ADD HL,BC
000CAF 4CAF 17               4      RLA
000CB0 4CB0 C9              10      RET
                                
       4CB1                     GNCL:
000CB1 4CB1 7A               4      LD  A,D
000CB2 4CB2 B3               4      OR  E
000CB3 4CB3 37               4      SCF
000CB4 4CB4 C8              11      RET Z
000CB5 4CB5 C5              11      PUSH    BC
000CB6 4CB6 E5              11      PUSH    HL
000CB7 4CB7 CD954C          17      CALL    NCL3
000CBA 4CBA 3809            12      JR  C,GNC1
000CBC 4CBC 5E               7      LD  E,(HL)
000CBD 4CBD 23               6      INC HL
000CBE 4CBE 7E               7      LD  A,(HL)
000CBF 4CBF E60F             7      AND 00FH
000CC1 4CC1 57               4      LD  D,A
000CC2 4CC2 E1              10      POP HL
000CC3 4CC3 C1              10      POP BC
000CC4 4CC4 C9              10      RET
       4CC5                     GNC1:
000CC5 4CC5 7E               7      LD  A,(HL)
000CC6 4CC6 23               6      INC HL
000CC7 4CC7 56               7      LD  D,(HL)
000CC8 4CC8 0604             7      LD  B,4
       4CCA                     GNC1L:
000CCA 4CCA CB3A             8      SRL D
000CCC 4CCC 1F               4      RRA
000CCD 4CCD 10FB            13      DJNZ    GNC1L
                                
000CCF 4CCF 5F               4      LD  E,A
000CD0 4CD0 E1              10      POP HL
000CD1 4CD1 C1              10      POP BC
000CD2 4CD2 A7               4      AND A
000CD3 4CD3 C9              10      RET
                                
       4CD4                     CLUST:
000CD4 4CD4 EB               4      EX  DE,HL
000CD5 4CD5 C5              11      PUSH    BC
000CD6 4CD6 3A22F1          13      LD  A,(CLSZ_H)
000CD9 4CD9 CD704F          17      CALL    MUL_AHL
                                
000CDC 4CDC CD7D4D          17      CALL    GET_DIR_POS
000CDF 4CDF 4F               4      LD  C,A
000CE0 4CE0 0600             7      LD  B,0
000CE2 4CE2 09              11      ADD HL,BC
                                
000CE3 4CE3 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000CE6 4CE6 0F               4      RRCA
000CE7 4CE7 0F               4      RRCA
000CE8 4CE8 0F               4      RRCA
000CE9 4CE9 0F               4      RRCA
000CEA 4CEA 4F               4      LD  C,A
                                
000CEB 4CEB 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000CEE 4CEE FE02             7      CP  2
000CF0 4CF0 280C            12      JR  Z,CLUST1
000CF2 4CF2 CB01             4      RLC C
000CF4 4CF4 0D               4      DEC C
000CF5 4CF5 3A0C60          13      LD  A,(BANK1_ADR+11+1)  ;BPB_BytsPerSec High    
000CF8 4CF8 FE02             7      CP  2
000CFA 4CFA 2002            12      JR  NZ,CLUST1
000CFC 4CFC 0D               4      DEC C
000CFD 4CFD 0D               4      DEC C
       4CFE                     CLUST1:
000CFE 4CFE 0D               4      DEC C
000CFF 4CFF 09              11      ADD HL,BC
                                
                                #if exists USE_NORMAL_32K_ROM
000D00 4D00 7D               4      LD  A,L
                                #else
                                    PUSH    HL
                                    ADD HL,HL   ;*2
                                    ADD HL,HL   ;*4
                                    ADD HL,HL   ;*8
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    POP HL
                                    LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
                                    AND L
                                #endif
000D01 4D01 C660             7      ADD A,high BANK1_ADR
000D03 4D03 67               4      LD  H,A
000D04 4D04 2E00             7      LD  L,0
000D06 4D06 EB               4      EX  DE,HL
000D07 4D07 C1              10      POP BC
000D08 4D08 C9              10      RET
                                
       4D09                     ENDCL:
000D09 4D09 7A               4      LD  A,D ;END CLUSTER
000D0A 4D0A FE0F             7      CP  00FH    ;FAT12の最大値
000D0C 4D0C C0              11      RET NZ
000D0D 4D0D 7B               4      LD  A,E
000D0E 4D0E FEF7             7      CP  0F7H
000D10 4D10 C9              10      RET
                                
       4D11                     RB_READ:
000D11 4D11 AF               4      XOR A   ;HLA = HL*128
000D12 4D12 CB3C             8      SRL H
000D14 4D14 CB1D             8      RR  L
000D16 4D16 1F               4      RRA
000D17 4D17 3225F1          13      LD  (RR_LOW),A
000D1A 4D1A 2226F1          16      LD  (RR_MID),HL
000D1D 4D1D 218000          10      LD  HL,128
                                
000D20 4D20 CD6F49          17      CALL    ROM_READ
000D23 4D23 C9              10      RET
                                
       4D24                     GETSEQ:
000D24 4D24 FD6E20          19      LD  L,(IY+32)
000D27 4D27 FD660C          19      LD  H,(IY+12)
                                
000D2A 4D2A CB25             8      SLA L
                                
000D2C 4D2C CB3C             8      SRL H
000D2E 4D2E CB1D             8      RR  L
000D30 4D30 C9              10      RET
                                
       4D31                     SETSEQ:
000D31 4D31 F5              11      PUSH    AF
000D32 4D32 3A25F1          13      LD  A,(RR_LOW)
000D35 4D35 2A26F1          16      LD  HL,(RR_MID)
                                
000D38 4D38 CD4F4D          17      CALL    SSQ1
                                
000D3B 4D3B 29              11      ADD HL,HL
000D3C 4D3C CB3D             8      SRL L
000D3E 4D3E FD7520          19      LD  (IY+32),L
000D41 4D41 FD740C          19      LD  (IY+12),H
000D44 4D44 F1              10      POP AF
000D45 4D45 C9              10      RET
                                
       4D46                     GETSIZE:
000D46 4D46 FD7E10          19      LD  A,(IY+16)
000D49 4D49 FD6E11          19      LD  L,(IY+17)
000D4C 4D4C FD6612          19      LD  H,(IY+18)
       4D4F                     SSQ1:
000D4F 4D4F 87               4      ADD A,A
000D50 4D50 ED6A            15      ADC HL,HL
000D52 4D52 B7               4      OR  A
000D53 4D53 C8              11      RET Z
000D54 4D54 23               6      INC HL
000D55 4D55 C9              10      RET
                                
       4D56                     SET_FCB:
000D56 4D56 D5              11      PUSH    DE
000D57 4D57 FDE1            14      POP IY
000D59 4D59 FD7E1C          19      LD  A,(IY+28)
000D5C 4D5C FEFF             7      CP  0FFH
000D5E 4D5E 200C            12      JR  NZ,POPAF_SCF_FF_RET
000D60 4D60 E5              11      PUSH    HL
000D61 4D61 FD6E1A          19      LD  L,(IY+26)
000D64 4D64 FD661B          19      LD  H,(IY+27)
000D67 4D67 2229F1          16      LD  (_CLPS),HL
000D6A 4D6A E1              10      POP HL
000D6B 4D6B C9              10      RET
                                
       4D6C                     POPAF_SCF_FF_RET:
000D6C 4D6C F1              10      POP AF
000D6D 4D6D 37               4      SCF
000D6E 4D6E 9F               4      SBC A,A
000D6F 4D6F C9              10      RET
                                
       4D70                     GET_DIR_DAT:
000D70 4D70 CD7D4D          17      CALL    GET_DIR_POS
000D73 4D73 C660             7      ADD A,high BANK1_ADR
000D75 4D75 2E00             7      LD  L,0
000D77 4D77 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_NORMAL_32K_ROM
                                #else
                                    CALL    CHECK_DIR_PAGE
                                #endif
000D78 4D78 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000D7B 4D7B 4F               4      LD  C,A
000D7C 4D7C C9              10      RET
                                
       4D7D                     GET_DIR_POS:
000D7D 4D7D CD444F          17      CALL    GET_DISK_BANK_FDRV
000D80 4D80 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000D83 4D83 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000D86 4D86 3220F1          13      LD  (_BANK),A
000D89 4D89 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000D8C 4D8C 47               4      LD  B,A
000D8D 4D8D 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000D90 4D90 4F               4      LD  C,A
000D91 4D91 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4D94                     GET_DIR_POS1:
000D94 4D94 81               4      ADD A,C
000D95 4D95 10FD            13      DJNZ    GET_DIR_POS1
                                
000D97 4D97 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec 
       4D9B                     L_MDP:
000D9B 4D9B CB18             8      RR  B   ;->CF
000D9D 4D9D D8              11      RET C
000D9E 4D9E 87               4      ADD A,A
000D9F 4D9F 18FA            12      JR  L_MDP
                                
       4DA1                     WILDCARD:
000DA1 4DA1 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4DAC                     ERROR_WRITE_PROTECTED:
000DAC 4DAC 3E00             7      LD  A,0     ;Write protected
000DAE 4DAE C9              10      RET
       4DAF                     DISKIO:
000DAF 4DAF 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000DB1 4DB1 48               4      LD  C,B
000DB2 4DB2 CD4E4F          17      CALL    GET_DISK_BANK
       4DB5                     SETMAP1:        
000DB5 4DB5 E5              11      PUSH    HL
       4DB6                     DISKIO1:
000DB6 4DB6 C5              11      PUSH    BC      ;B=残りのセクタ数
000DB7 4DB7 D5              11      PUSH    DE      ;DE=セクタ番号
000DB8 4DB8 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
000DB9 4DB9 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
000DBA 4DBA F5              11      PUSH    AF
000DBB 4DBB 3A24F1          13      LD  A,(SECSZ_H)
000DBE 4DBE CD704F          17      CALL    MUL_AHL
000DC1 4DC1 F1              10      POP AF
000DC2 4DC2 4D               4      LD  C,L     ;C=読み出し元
000DC3 4DC3 29              11      ADD HL,HL       ;64KB→32KB
000DC4 4DC4 29              11      ADD HL,HL       ;32KB→16KB
000DC5 4DC5 29              11      ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
000DC6 4DC6 84               4      ADD A,H
000DC7 4DC7 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000DCA 4DCA 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000DCD 4DCD 3220F1          13      LD  (_BANK),A
000DD0 4DD0 79               4      LD  A,C     ;C=読み出し元
000DD1 4DD1 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
000DD3 4DD3 C660             7      ADD A,high BANK1_ADR
000DD5 4DD5 67               4      LD  H,A
000DD6 4DD6 ED4B23F1        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
000DDA 4DDA 69               4      LD  L,C     ;C=0
000DDB 4DDB EDB0                    LDIR
000DDD 4DDD EB               4      EX  DE,HL
000DDE 4DDE F1              10      POP AF
000DDF 4DDF D1              10      POP DE
000DE0 4DE0 13               6      INC DE
000DE1 4DE1 C1              10      POP BC
000DE2 4DE2 10D2            13      DJNZ    DISKIO1
000DE4 4DE4 41               4      LD  B,C
                                
000DE5 4DE5 E1              10      POP HL
000DE6 4DE6 AF               4      XOR A
000DE7 4DE7 FB               4      EI
000DE8 4DE8 C9              10      RET
                                
       4DE9                     DSKCHG:
000DE9 4DE9 CD224E          17      CALL    IS_BPB
000DEC 4DEC 3824            12      JR  C,NOTREADY
000DEE 4DEE 3A23FB          13      LD  A,(DRVTBL+2)
000DF1 4DF1 B7               4      OR  A
000DF2 4DF2 201A            12      JR  NZ,DSKCHG1
000DF4 4DF4 3A21FB          13      LD  A,(DRVTBL)
000DF7 4DF7 FE02             7      CP  2
000DF9 4DF9 2013            12      JR  NZ,DSKCHG1
000DFB 4DFB CD224E          17      CALL    IS_BPB
000DFE 4DFE 300E            12      JR  NC,DSKCHG1
000E00 4E00 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000E02 4E02 3221FB          13      LD  (DRVTBL),A
000E05 4E05 3223FB          13      LD  (DRVTBL+2),A
000E08 4E08 3A48F3          13      LD  A,(MASTERS)
000E0B 4E0B 3224FB          13      LD  (DRVTBL+3),A
       4E0E                     DSKCHG1:
000E0E 4E0E AF               4      XOR A
000E0F 4E0F 0601             7      LD  B,1
000E11 4E11 C9              10      RET
       4E12                     NOTREADY:
000E12 4E12 3E02             7      LD  A,2
000E14 4E14 37               4      SCF
000E15 4E15 C9              10      RET
                                
       4E16                     NO_BPB:
000E16 4E16 E1              10      POP HL
000E17 4E17 23               6      INC HL
000E18 4E18 11754F          10      LD  DE,DPB2DD
000E1B 4E1B 011200          10      LD  BC,DPB2DD_E-DPB2DD
000E1E 4E1E EDB0                    LDIR
000E20 4E20 AF               4      XOR A
000E21 4E21 C9              10      RET
                                
       4E22                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000E22 4E22 CD4E4F          17      CALL    GET_DISK_BANK
                                
000E25 4E25 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000E28 4E28 FE01             7      CP  1
000E2A 4E2A D8              11      RET C
                                
000E2B 4E2B 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000E2E 4E2E C6FF             7      ADD A,0FFH
000E30 4E30 D8              11      RET C
                                
000E31 4E31 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
000E34 4E34 FE01             7      CP  1
000E36 4E36 C8              11      RET Z
000E37 4E37 FE02             7      CP  2
000E39 4E39 C8              11      RET Z
000E3A 4E3A FE04             7      CP  4
000E3C 4E3C C8              11      RET Z
000E3D 4E3D 37               4      SCF
000E3E 4E3E C9              10      RET
                                
       4E3F                     GETDPB:
000E3F 4E3F E5              11      PUSH    HL
000E40 4E40 CD4E4F          17      CALL    GET_DISK_BANK
                                
000E43 4E43 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000E46 4E46 B7               4      OR  A
000E47 4E47 28CD            12      JR  Z,NO_BPB
000E49 4E49 DDE1            14      POP IX
000E4B 4E4B DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000E4E 4E4E 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000E51 4E51 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000E54 4E54 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000E57 4E57 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000E5A 4E5A 87               4      ADD A,A
000E5B 4E5B 87               4      ADD A,A
000E5C 4E5C 87               4      ADD A,A
000E5D 4E5D 3D               4      DEC A
000E5E 4E5E DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000E61 4E61 06FF             7      LD  B,-1
000E63 4E63 A7               4      AND A           ;無限ループ阻止
       4E64                     GETDPB1:
000E64 4E64 04               4      INC B
000E65 4E65 1F               4      RRA
000E66 4E66 38FC            12      JR  C,GETDPB1
000E68 4E68 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000E6B 4E6B 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000E6E 4E6E 3D               4      DEC A
000E6F 4E6F DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000E72 4E72 A7               4      AND A           ;無限ループ阻止
000E73 4E73 06FF             7      LD  B,-1
       4E75                     GETDPB2:
000E75 4E75 04               4      INC B
000E76 4E76 1F               4      RRA
000E77 4E77 38FC            12      JR  C,GETDPB2
000E79 4E79 04               4      INC B
000E7A 4E7A DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000E7D 4E7D 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
000E80 4E80 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
000E83 4E83 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
000E86 4E86 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
000E89 4E89 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000E8C 4E8C 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
000E8F 4E8F DD770B          19      LD  (IX+11),A       ;FATCNT
                                
000E92 4E92 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
000E96 4E96 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
000E99 4E99 DD460A          19      LD  B,(IX+10)       ;FATCNT
000E9C 4E9C 210000          10      LD  HL,0
       4E9F                     GETDPB3:
000E9F 4E9F 19              11      ADD HL,DE
000EA0 4EA0 10FD            13      DJNZ    GETDPB3
       4EA2                     GETDPB4:
000EA2 4EA2 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
000EA5 4EA5 DD5609          19      LD  D,(IX+9)        ;FIRFAT
000EA8 4EA8 19              11      ADD HL,DE
000EA9 4EA9 DD7511          19      LD  (IX+17),L       ;FIRDIR
000EAC 4EAC DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000EAF 4EAF DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000EB2 4EB2 87               4      ADD A,A
000EB3 4EB3 87               4      ADD A,A
000EB4 4EB4 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4EB7                     GETDPB5:
000EB7 4EB7 CB3B             8      SRL E
000EB9 4EB9 1F               4      RRA
000EBA 4EBA 30FB            12      JR  NC,GETDPB5
000EBC 4EBC 1600             7      LD  D,0
000EBE 4EBE 19              11      ADD HL,DE
000EBF 4EBF DD750C          19      LD  (IX+12),L       ;FIRREC
000EC2 4EC2 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000EC5 4EC5 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
000EC8 4EC8 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
000ECB 4ECB DD560D          19      LD  D,(IX+13)       ;FIRREC
000ECE 4ECE A7               4      AND A
000ECF 4ECF ED52            15      SBC HL,DE
                                
000ED1 4ED1 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
000ED4 4ED4 3C               4      INC A
000ED5 4ED5 37               4      SCF             ;無限ループ阻止
       4ED6                     GETDPB6:
000ED6 4ED6 1F               4      RRA
000ED7 4ED7 3806            12      JR  C,GETDPB7
000ED9 4ED9 CB3C             8      SRL H
000EDB 4EDB CB1D             8      RR  L
000EDD 4EDD 18F7            12      JR  GETDPB6
       4EDF                     GETDPB7:
000EDF 4EDF 23               6      INC HL
000EE0 4EE0 DD750E          19      LD  (IX+14),L       ;MAXCLUS
000EE3 4EE3 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       4EE6                     GETDPBD1:
000EE6 4EE6 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000EE9 4EE9 E6FC             7      AND 0FCH
000EEB 4EEB C8              11      RET Z
                                
000EEC 4EEC DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
000EF0 4EF0 37               4      SCF
000EF1 4EF1 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
000EF5 4EF5 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
000EF8 4EF8 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
000EFC 4EFC DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
000F00 4F00 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
000F04 4F04 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
000F08 4F08 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
000F0C 4F0C DDCB1126        23      SLA (IX+17)         ;FIRDIR
000F10 4F10 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
000F14 4F14 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
000F17 4F17 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
000F1A 4F1A DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000F1D 4F1D 87               4      ADD A,A
000F1E 4F1E 87               4      ADD A,A
000F1F 4F1F DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4F22                     GETDPBD5:
000F22 4F22 CB3B             8      SRL E
000F24 4F24 1F               4      RRA
000F25 4F25 30FB            12      JR  NC,GETDPBD5
000F27 4F27 1600             7      LD  D,0
000F29 4F29 19              11      ADD HL,DE
000F2A 4F2A DD750C          19      LD  (IX+12),L       ;FIRREC
000F2D 4F2D DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000F30 4F30 18B4            12      JR  GETDPBD1
                                
       4F32                     CHOICE:
000F32 4F32 210000          10      LD  HL,0
000F35 4F35 C9              10      RET
                                
       4F36                     DSKFMT:
000F36 4F36 AF               4      XOR A
000F37 4F37 37               4      SCF
       4F38                     DSKSTP:
000F38 4F38 C9              10      RET
                                
       4F39                     BASENT:
000F39 4F39 ED7B5FF1        20      LD  SP,(BASSTK)
000F3D 4F3D C3C043          10      JP  BASAUTO
                                
       4F40                     GETSLT:
000F40 4F40 3A22FB          13      LD  A,(DRVTBL+1)
000F43 4F43 C9              10      RET
                                
       4F44                     GET_DISK_BANK_FDRV:
000F44 4F44 3A53F1          13      LD  A,(FDRV)
000F47 4F47 D601             7      SUB 1
000F49 4F49 3003            12      JR  NC,GET_DISK_BANK
000F4B 4F4B 3A4AF1          13      LD  A,(_DVSW)
       4F4E                     GET_DISK_BANK:
000F4E 4F4E B7               4      OR  A       ;A=DRIVE
000F4F 4F4F 3E01             7      LD  A,DISK_BANK
000F51 4F51 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
000F53 4F53 3A49F1          13      LD  A,(B_DRIVE)
                                #endif
       4F56                     SET_DISK_BANK:
000F56 4F56 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
000F59 4F59 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
000F5C 4F5C F5              11      PUSH    AF
000F5D 4F5D E5              11      PUSH    HL
000F5E 4F5E 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
000F61 4F61 2223F1          16      LD  (SECSZ),HL
000F64 4F64 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000F67 4F67 CD704F          17      CALL    MUL_AHL
000F6A 4F6A 2221F1          16      LD  (CLSZ),HL
000F6D 4F6D E1              10      POP HL
000F6E 4F6E F1              10      POP AF
000F6F 4F6F C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)
       4F70                     MUL_AHL:
000F70 4F70 1F               4      RRA     ;->CF
000F71 4F71 D8              11      RET C
000F72 4F72 29              11      ADD HL,HL
000F73 4F73 18FB            12      JR  MUL_AHL
                                
       4F75                     DPB2DD:
000F75 4F75 F9                      DB  0F9H    ;MEDIA
000F76 4F76 0002                    DW  00200H  ;SECSIZ
000F78 4F78 0F                      DB  00FH    ;DIRMSK
000F79 4F79 04                      DB  004H    ;DIRSHFT
000F7A 4F7A 01                      DB  001H    ;CLUSMSK
000F7B 4F7B 02                      DB  002H    ;CLUSSHFT
000F7C 4F7C 0100                    DW  00001H  ;FIRFAT
000F7E 4F7E 02                      DB  002H    ;FATCNT
000F7F 4F7F 70                      DB  070H    ;MAXENT
000F80 4F80 0E00                    DW  0000EH  ;FIRREC
000F82 4F82 CA02                    DW  002CAH  ;MAXCLUS
000F84 4F84 03                      DB  003H    ;FATSIZ
000F85 4F85 0700                    DW  0007H   ;FIRDIR
       4F87                     DPB2DD_E:
                                
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       4F87                     POP_HL_ERROR:
000F87 4F87 E1              10      POP     HL
       4F88                     _ERROR:
000F88 4F88 0600             7      LD  B,0
000F8A 4F8A A7               4      AND A
000F8B 4F8B C9              10      RET
                                
       4F8C                     ROM_BDOS:
000F8C 4F8C E5              11      PUSH    HL
000F8D 4F8D 79               4      LD  A,C
000F8E 4F8E 87               4      ADD A,A
000F8F 4F8F 38F7            12      JR  C,_ERROR
000F91 4F91 6F               4      LD  L,A
000F92 4F92 265F             7      LD  H,high STABLE
000F94 4F94 7E               7      LD  A,(HL)
000F95 4F95 2C               4      INC L
000F96 4F96 66               7      LD  H,(HL)
000F97 4F97 6F               4      LD  L,A
000F98 4F98 E3              19      EX  (SP),HL
000F99 4F99 79               4      LD  A,C
000F9A 4F9A C9              10      RET
                                
       4F9B                     _PRINT:
       4F9B                     PRINT:
000F9B 4F9B 7B               4      LD  A,E
000F9C 4F9C 1803            12      JR  MSG_A
                                
       4F9E                     _SYS01:     ;(BDOS)コンソール入力
000F9E 4F9E CD1550          17      CALL    _SYS07
       4FA1                     MSG_A:
000FA1 4FA1 FE03             7      CP  3
000FA3 4FA3 2814            12      JR  Z,MSG_BR
       4FA5                     MSGA1:
000FA5 4FA5 F5              11      PUSH    AF
000FA6 4FA6 C5              11      PUSH    BC
000FA7 4FA7 D5              11      PUSH    DE
000FA8 4FA8 E5              11      PUSH    HL
000FA9 4FA9 DDE5            15      PUSH    IX
000FAB 4FAB DD21A200        14      LD  IX,CHPUT
000FAF 4FAF CDE742          17      CALL    CALSLT_R
000FB2 4FB2 DDE1            14      POP IX
000FB4 4FB4 E1              10      POP HL
000FB5 4FB5 D1              10      POP DE
000FB6 4FB6 C1              10      POP BC
       4FB7                     MSGA2:
000FB7 4FB7 F1              10      POP AF
000FB8 4FB8 C9              10      RET
       4FB9                     MSG_BR:
000FB9 4FB9 F5              11      PUSH    AF
000FBA 4FBA 3ADDF3          13      LD  A,(CSRX)
000FBD 4FBD FE02             7      CP  2
000FBF 4FBF 38F6            12      JR  C,MSGA2
000FC1 4FC1 F1              10      POP AF
       4FC2                     MSG_CR:
000FC2 4FC2 F5              11      PUSH    AF
000FC3 4FC3 3E0D             7      LD  A,00DH
000FC5 4FC5 CDA54F          17      CALL    MSGA1
000FC8 4FC8 3E0A             7      LD  A,00AH
000FCA 4FCA CDA54F          17      CALL    MSGA1
000FCD 4FCD F1              10      POP AF
000FCE 4FCE C9              10      RET
                                
       4FCF                     _SYS02:     ;(BDOS)コンソール出力
000FCF 4FCF CDEA4F          17      CALL    BREAK
000FD2 4FD2 1805            12      JR  PRINTX
                                
       4FD4                     _SYS06:     ;(BDOS)コンソール直接入出力
000FD4 4FD4 7B               4      LD  A,E
000FD5 4FD5 3C               4      INC A
000FD6 4FD6 CA2950          10      JP  Z,_INKEY
       4FD9                     PRINTX:
000FD9 4FD9 C39B4F          10      JP  _PRINT
                                
       4FDC                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000FDC 4FDC CD1550          17      CALL    _SYS07
000FDF 4FDF FE03             7      CP  3
000FE1 4FE1 CCEA4F          17      CALL    Z,_BREAK
000FE4 4FE4 FE13             7      CP  013H        ;CTRL+S
000FE6 4FE6 C0              11      RET NZ
       4FE7                     PAUSE:
000FE7 4FE7 CD0150          17      CALL    KEYBC
                                
       4FEA                     _BREAK:
       4FEA                     BREAK:
000FEA 4FEA F5              11      PUSH    AF
000FEB 4FEB C5              11      PUSH    BC
000FEC 4FEC D5              11      PUSH    DE
000FED 4FED E5              11      PUSH    HL
000FEE 4FEE DDE5            15      PUSH    IX
000FF0 4FF0 DD21B700        14      LD  IX,BREAKX
000FF4 4FF4 CDE742          17      CALL    CALSLT_R
000FF7 4FF7 DDE1            14      POP IX
000FF9 4FF9 E1              10      POP HL
000FFA 4FFA D1              10      POP DE
000FFB 4FFB C1              10      POP BC
000FFC 4FFC DCEA4F          17      CALL    C,_BREAK
000FFF 4FFF F1              10      POP AF
001000 5000 C9              10      RET
       5001                     KEYBC:
001001 5001 F5              11      PUSH    AF
001002 5002 C5              11      PUSH    BC
001003 5003 D5              11      PUSH    DE
001004 5004 E5              11      PUSH    HL
001005 5005 DDE5            15      PUSH    IX
001007 5007 DD215601        14      LD  IX,KILBUF
00100B 500B CDE742          17      CALL    CALSLT_R
00100E 500E DDE1            14      POP IX
001010 5010 E1              10      POP HL
001011 5011 D1              10      POP DE
001012 5012 C1              10      POP BC
001013 5013 F1              10      POP AF
001014 5014 C9              10      RET
                                
       5015                     _SYS07:
       5015                     FLGET:
001015 5015 C5              11      PUSH    BC
001016 5016 D5              11      PUSH    DE
001017 5017 E5              11      PUSH    HL
001018 5018 DDE5            15      PUSH    IX
00101A 501A DD219F00        14      LD  IX,CHGET
00101E 501E CDE742          17      CALL    CALSLT_R
001021 5021 DDE1            14      POP IX
001023 5023 E1              10      POP HL
001024 5024 D1              10      POP DE
001025 5025 C1              10      POP BC
001026 5026 FE03             7      CP  3
001028 5028 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       5029                     _INKEY:
       5029                     INKEY:
001029 5029 CDC350          17      CALL    CPM_CONST
00102C 502C C8              11      RET Z
00102D 502D 18E6            12      JR  FLGET
                                
       502F                     _SYS0A:     ;(BDOS)文字列入力
00102F 502F C5              11      PUSH    BC
001030 5030 E5              11      PUSH    HL
001031 5031 D5              11      PUSH    DE
001032 5032 CD5B50          17      CALL    GETL
001035 5035 111FF4          10      LD  DE,KBUF
001038 5038 E1              10      POP HL
001039 5039 E5              11      PUSH    HL
00103A 503A 0E00             7      LD  C,0
00103C 503C 3004            12      JR  NC,SAX0
00103E 503E 23               6      INC HL
00103F 503F 23               6      INC HL
001040 5040 1808            12      JR  SAX4
       5042                     SAX0:
001042 5042 46               7      LD  B,(HL)
001043 5043 23               6      INC HL
       5044                     SAX1:
001044 5044 23               6      INC HL
001045 5045 1A               7      LD  A,(DE)
001046 5046 13               6      INC DE
001047 5047 B7               4      OR  A
001048 5048 2004            12      JR  NZ,SAX2
       504A                     SAX4:
00104A 504A 360D            10      LD  (HL),00DH
00104C 504C 1804            12      JR  SAX3
       504E                     SAX2:
00104E 504E 77               7      LD  (HL),A
00104F 504F 0C               4      INC C
001050 5050 10F2            13      DJNZ    SAX1
       5052                     SAX3:
001052 5052 D1              10      POP DE
001053 5053 79               4      LD  A,C
001054 5054 13               6      INC DE
001055 5055 12               7      LD  (DE),A
001056 5056 1B               6      DEC DE
001057 5057 E1              10      POP HL
001058 5058 C1              10      POP BC
001059 5059 A7               4      AND A
00105A 505A C9              10      RET
       505B                     GETL:
00105B 505B DDE5            15      PUSH    IX
00105D 505D FDE5            15      PUSH    IY
                                
00105F 505F 2ADCF3          16      LD  HL,(CSRY)
001062 5062 22CAFB          16      LD  (FSTPOS),HL
       5065                     GETL1:
001065 5065 CDDC4F          17      CALL    _SYS08
001068 5068 FE09             7      CP  9
00106A 506A 2008            12      JR  NZ,GETL1V
00106C 506C 211FF4          10      LD  HL,KBUF
00106F 506F CD7243          17      CALL    MSX
001072 5072 18F1            12      JR  GETL1
       5074                     GETL1V:
001074 5074 5F               4      LD  E,A
001075 5075 FE08             7      CP  8
001077 5077 CC1151          17      CALL    Z,CTRL02
00107A 507A FE20             7      CP  020H
00107C 507C D43D51          17      CALL    NC,INSERT
00107F 507F CDA54F          17      CALL    MSGA1
                                
001082 5082 7B               4      LD  A,E
001083 5083 FE0D             7      CP  00DH
001085 5085 20DE            12      JR  NZ,GETL1
                                
001087 5087 111FF4          10      LD  DE,KBUF
00108A 508A 3AB0F3          13      LD  A,(LINLEN)
00108D 508D 47               4      LD  B,A
00108E 508E CDF052          17      CALL    ZERO_MEMORY_DE
                                
001091 5091 2ACAFB          16      LD  HL,(FSTPOS)
001094 5094 3ADCF3          13      LD  A,(CSRY)
001097 5097 6F               4      LD  L,A
001098 5098 E5              11      PUSH    HL
001099 5099 CD6E51          17      CALL    LOC0
00109C 509C 4D               4      LD  C,L
00109D 509D 44               4      LD  B,H
00109E 509E E1              10      POP HL
00109F 509F 3AB0F3          13      LD  A,(LINLEN)
0010A2 50A2 94               4      SUB H
0010A3 50A3 3D               4      DEC A
0010A4 50A4 5F               4      LD  E,A
0010A5 50A5 211FF4          10      LD  HL,KBUF
       50A8                     GETL2:
0010A8 50A8 CD0151          17      CALL    _SCRN
0010AB 50AB 03               6      INC BC
0010AC 50AC 77               7      LD  (HL),A
0010AD 50AD 23               6      INC HL
0010AE 50AE 1D               4      DEC E
0010AF 50AF 20F7            12      JR  NZ,GETL2
0010B1 50B1 CDC24F          17      CALL    MSG_CR
                                
0010B4 50B4 FDE1            14      POP IY
0010B6 50B6 DDE1            14      POP IX
       50B8                     GETL3:
0010B8 50B8 2B               6      DEC HL
0010B9 50B9 7E               7      LD  A,(HL)
0010BA 50BA FE21             7      CP  021H
0010BC 50BC D0              11      RET NC
0010BD 50BD 3600            10      LD  (HL),0
0010BF 50BF 15               4      DEC D
0010C0 50C0 20F6            12      JR  NZ,GETL3
0010C2 50C2 C9              10      RET
                                
       50C3                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       50C3                     CONSTX:
       50C3                     CPM_CONST:
0010C3 50C3 C5              11      PUSH    BC
0010C4 50C4 D5              11      PUSH    DE
0010C5 50C5 E5              11      PUSH    HL
0010C6 50C6 DDE5            15      PUSH    IX
0010C8 50C8 DD219C00        14      LD  IX,CHSNS
0010CC 50CC CDE742          17      CALL    CALSLT_R
0010CF 50CF DDE1            14      POP IX
0010D1 50D1 E1              10      POP HL
0010D2 50D2 D1              10      POP DE
0010D3 50D3 C1              10      POP BC
0010D4 50D4 C9              10      RET
                                
       50D5                     _SYS2A:     ;(BDOS)日付の獲得
0010D5 50D5 AF               4      XOR A
0010D6 50D6 57               4      LD  D,A
0010D7 50D7 5F               4      LD  E,A
0010D8 50D8 67               4      LD  H,A
0010D9 50D9 6F               4      LD  L,A
0010DA 50DA C9              10      RET
                                
       50DB                     _SYS2C:     ;(BDOS)時刻の獲得
0010DB 50DB AF               4      XOR A
0010DC 50DC 57               4      LD  D,A
0010DD 50DD 5F               4      LD  E,A
0010DE 50DE 67               4      LD  H,A
0010DF 50DF 6F               4      LD  L,A
0010E0 50E0 C9              10      RET
                                
       50E1                     POS:
0010E1 50E1 F5              11      PUSH    AF
0010E2 50E2 2ADCF3          16      LD  HL,(CSRY)
0010E5 50E5 7D               4      LD  A,L
0010E6 50E6 6C               4      LD  L,H
0010E7 50E7 67               4      LD  H,A
0010E8 50E8 2C               4      INC L
0010E9 50E9 24               4      INC H
0010EA 50EA F1              10      POP AF
0010EB 50EB C9              10      RET
                                
       50EC                     LOC:
0010EC 50EC F5              11      PUSH    AF
0010ED 50ED E5              11      PUSH    HL
0010EE 50EE 7D               4      LD  A,L
0010EF 50EF 6C               4      LD  L,H
0010F0 50F0 67               4      LD  H,A
0010F1 50F1 2D               4      DEC L
0010F2 50F2 25               4      DEC H
0010F3 50F3 DDE5            15      PUSH    IX
0010F5 50F5 DD21C600        14      LD  IX,POSIT
0010F9 50F9 CDE742          17      CALL    CALSLT_R
0010FC 50FC DDE1            14      POP IX
0010FE 50FE E1              10      POP HL
0010FF 50FF F1              10      POP AF
001100 5100 C9              10      RET
                                
       5101                     _SCRN:
       5101                     SCRN:
001101 5101 E5              11      PUSH    HL
001102 5102 DDE5            15      PUSH    IX
                                
001104 5104 69               4      LD  L,C
001105 5105 60               4      LD  H,B
001106 5106 DD214A00        14      LD  IX,RDVRM
00110A 510A CDE742          17      CALL    CALSLT_R
                                
00110D 510D DDE1            14      POP IX
00110F 510F E1              10      POP HL
001110 5110 C9              10      RET
                                
       5111                     CTRL02:
001111 5111 F5              11      PUSH    AF
001112 5112 D5              11      PUSH    DE
001113 5113 2ADCF3          16      LD  HL,(CSRY)
001116 5116 3AB0F3          13      LD  A,(LINLEN)
001119 5119 4F               4      LD  C,A
00111A 511A 94               4      SUB H   ;CSRX
00111B 511B C602             7      ADD A,2
00111D 511D 47               4      LD  B,A ;カーソルより右の文字数
00111E 511E 61               4      LD  H,C ;LINLEN
00111F 511F C5              11      PUSH    BC
001120 5120 CD6E51          17      CALL    LOC0
001123 5123 C1              10      POP BC
                                
001124 5124 1620             7      LD  D,020H
       5126                     C8X1:
001126 5126 DD214A00        14      LD  IX,RDVRM
00112A 512A CDE742          17      CALL    CALSLT_R
00112D 512D 4F               4      LD  C,A
00112E 512E 7A               4      LD  A,D
00112F 512F DD214D00        14      LD  IX,WRTVRM
001133 5133 CDE742          17      CALL    CALSLT_R
001136 5136 2B               6      DEC HL
001137 5137 51               4      LD  D,C
001138 5138 10EC            13      DJNZ    C8X1
00113A 513A D1              10      POP DE
00113B 513B F1              10      POP AF
00113C 513C C9              10      RET
                                
       513D                     INSERT:
00113D 513D F5              11      PUSH    AF
00113E 513E D5              11      PUSH    DE
00113F 513F 2ADCF3          16      LD  HL,(CSRY)
001142 5142 3AB0F3          13      LD  A,(LINLEN)
001145 5145 4F               4      LD  C,A
001146 5146 94               4      SUB H   ;CSRX
001147 5147 3C               4      INC A
001148 5148 47               4      LD  B,A ;カーソルより右の文字数
001149 5149 C5              11      PUSH    BC
00114A 514A CD6E51          17      CALL    LOC0
00114D 514D C1              10      POP BC
                                
00114E 514E 1620             7      LD  D,020H
       5150                     INS1:
001150 5150 DD214A00        14      LD  IX,RDVRM
001154 5154 CDE742          17      CALL    CALSLT_R
001157 5157 4F               4      LD  C,A
001158 5158 7A               4      LD  A,D
001159 5159 DD214D00        14      LD  IX,WRTVRM
00115D 515D CDE742          17      CALL    CALSLT_R
001160 5160 23               6      INC HL
001161 5161 51               4      LD  D,C
001162 5162 10EC            13      DJNZ    INS1
001164 5164 D1              10      POP DE
001165 5165 F1              10      POP AF
001166 5166 C9              10      RET
                                
       5167                     CONOUT1:
001167 5167 59               4      LD  E,C
001168 5168 C39B4F          10      JP  _PRINT
                                
       516B                     GETVRAM:
00116B 516B 2ADCF3          16      LD  HL,(CSRY)
       516E                     LOC0:
00116E 516E 2D               4      DEC L
00116F 516F 25               4      DEC H
001170 5170 4C               4      LD  C,H ;CSRX-1
001171 5171 5D               4      LD  E,L ;CSRY-1
       5172                     LOC1:
001172 5172 3AB0F3          13      LD  A,(LINLEN)
001175 5175 67               4      LD  H,A
001176 5176 1600             7      LD  D,0
001178 5178 6A               4      LD  L,D ;0
001179 5179 0608             7      LD  B,8
       517B                     LOC2:
00117B 517B 29              11      ADD HL,HL
00117C 517C 3001            12      JR  NC,LOC3
00117E 517E 19              11      ADD HL,DE
       517F                     LOC3:
00117F 517F 10FA            13      DJNZ    LOC2
001181 5181 09              11      ADD HL,BC
001182 5182 C9              10      RET
                                
       5183                     _SYS0C:     ;(BDOS)バージョン番号の獲得
001183 5183 212200          10      LD  HL,00022H
001186 5186 AF               4      XOR A
001187 5187 7D               4      LD  A,L
001188 5188 C9              10      RET
                                
       5189                     _SYS0D:     ;(BDOS)ディスク・リセット
001189 5189 218000          10      LD  HL,00080H
00118C 518C 222FF1          16      LD  (_DTA),HL
00118F 518F C9              10      RET
                                
       5190                     _SYS0E:     ;(BDOS)カレントドライブの設定
001190 5190 324AF1          13      LD  (_DVSW),A
001193 5193 C9              10      RET
                                
       5194                     _SYS0F:     ;(BDOS)ファイルのオープン
001194 5194 D5              11      PUSH    DE
001195 5195 FDE1            14      POP IY
001197 5197 CDDD52          17      CALL    INIT_FILE
00119A 519A CD534B          17      CALL    ROM_OPEN
00119D 519D 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
00119F 519F FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
0011A3 51A3 FDE5            15      PUSH    IY
0011A5 51A5 D1              10      POP DE
0011A6 51A6 13               6      INC DE
0011A7 51A7 010B00          10      LD  BC,11
0011AA 51AA EDB0                    LDIR
                                ;               Attribute
0011AC 51AC 7E               7      LD  A,(HL)
0011AD 51AD FD770D          19      LD  (IY+13),A
                                ;               TIME
0011B0 51B0 110B00          10      LD  DE,11
0011B3 51B3 19              11      ADD HL,DE
0011B4 51B4 7E               7      LD  A,(HL)
0011B5 51B5 23               6      INC HL
0011B6 51B6 FD7716          19      LD  (IY+22),A
0011B9 51B9 7E               7      LD  A,(HL)
0011BA 51BA 23               6      INC HL
0011BB 51BB FD7717          19      LD  (IY+23),A
                                ;               DATE
0011BE 51BE 7E               7      LD  A,(HL)
0011BF 51BF 23               6      INC HL
0011C0 51C0 FD7714          19      LD  (IY+20),A
0011C3 51C3 7E               7      LD  A,(HL)
0011C4 51C4 23               6      INC HL
0011C5 51C5 FD7715          19      LD  (IY+21),A
                                ;               First cluster
0011C8 51C8 7E               7      LD  A,(HL)
0011C9 51C9 23               6      INC HL
0011CA 51CA FD771A          19      LD  (IY+26),A
0011CD 51CD 7E               7      LD  A,(HL)
0011CE 51CE 23               6      INC HL
0011CF 51CF FD771B          19      LD  (IY+27),A
                                ;               SIZE
0011D2 51D2 7E               7      LD  A,(HL)
0011D3 51D3 23               6      INC HL
0011D4 51D4 FD7710          19      LD  (IY+16),A
0011D7 51D7 7E               7      LD  A,(HL)
0011D8 51D8 23               6      INC HL
0011D9 51D9 FD7711          19      LD  (IY+17),A
0011DC 51DC 7E               7      LD  A,(HL)
0011DD 51DD 23               6      INC HL
0011DE 51DE FD7712          19      LD  (IY+18),A
0011E1 51E1 7E               7      LD  A,(HL)
0011E2 51E2 FD7713          19      LD  (IY+19),A
0011E5 51E5 AF               4      XOR A
0011E6 51E6 FD770C          19      LD  (IY+12),A
0011E9 51E9 C9              10      RET
                                
       51EA                     _SYS10:     ;(BDOS)ファイルのクローズ
0011EA 51EA AF               4      XOR A
0011EB 51EB C9              10      RET
                                
       51EC                     S11X1:
0011EC 51EC FD7119          19      LD  (IY+25),C       ;RootEntCnt
0011EF 51EF FD750E          19      LD  (IY+14),L
0011F2 51F2 FD740F          19      LD  (IY+15),H
       51F5                     SCF_FF_RET:
0011F5 51F5 37               4      SCF
0011F6 51F6 9F               4      SBC A,A
0011F7 51F7 C9              10      RET
                                
       51F8                     _SYS11:     ;(BDOS)最初のファイルの検索
0011F8 51F8 ED5337F1        20      LD  (_FCB),DE
0011FC 51FC D5              11      PUSH    DE
0011FD 51FD FDE1            14      POP IY
0011FF 51FF CDDD52          17      CALL    INIT_FILE
001202 5202 CD704D          17      CALL    GET_DIR_DAT
       5205                     S12X1:
001205 5205 CD6F4B          17      CALL    FILESE
001208 5208 30E2            12      JR  NC,S11X1
00120A 520A 0D               4      DEC C
00120B 520B FD7119          19      LD  (IY+25),C       ;RootEntCnt
00120E 520E 012000          10      LD  BC,32
001211 5211 ED5B2FF1        20      LD  DE,(_DTA)
001215 5215 AF               4      XOR A
001216 5216 12               7      LD  (DE),A      ;ドライブ番号
001217 5217 13               6      INC DE
001218 5218 EDB0                    LDIR            ;ディレクトリエントリ
00121A 521A FD750E          19      LD  (IY+14),L
00121D 521D FD740F          19      LD  (IY+15),H
001220 5220 C9              10      RET
                                
       5221                     _SYS12:
001221 5221 FD2A37F1        20      LD  IY,(_FCB)
001225 5225 FDE5            15      PUSH    IY
001227 5227 D1              10      POP DE
001228 5228 CDDD52          17      CALL    INIT_FILE
                                
00122B 522B FD6E0E          19      LD  L,(IY+14)
00122E 522E FD660F          19      LD  H,(IY+15)
001231 5231 FD4E19          19      LD  C,(IY+25)
001234 5234 18CF            12      JR  S12X1
                                
       5236                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
001236 5236 CD564D          17      CALL    SET_FCB
001239 5239 CD244D          17      CALL    GETSEQ
00123C 523C CD114D          17      CALL    RB_READ
00123F 523F E5              11      PUSH    HL
001240 5240 CD314D          17      CALL    SETSEQ
001243 5243 E1              10      POP HL
       5244                     SREAD:
001244 5244 C601             7      ADD A,001H
001246 5246 D8              11      RET C
                                
001247 5247 7D               4      LD  A,L
001248 5248 D601             7      SUB 001H
00124A 524A 9F               4      SBC A,A
00124B 524B E603             7      AND 3
00124D 524D 1F               4      RRA
00124E 524E C9              10      RET
                                
       524F                     _SYS18:     ;(BDOS)ログインベクトルの獲得
00124F 524F 210100          10      LD  HL,00001H
001252 5252 AF               4      XOR A
001253 5253 C9              10      RET
                                
       5254                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
001254 5254 3A4AF1          13      LD  A,(_DVSW)
001257 5257 C9              10      RET
                                
       5258                     _SYS1A:     ;(BDOS)DTAの設定
001258 5258 ED532FF1        20      LD  (_DTA),DE
00125C 525C AF               4      XOR A
00125D 525D C9              10      RET
                                
       525E                     _SYS1B:     ;(BDOS)ディスク情報の獲得
00125E 525E 010002          10      LD  BC,512
001261 5261 11C302          10      LD  DE,707
001264 5264 210000          10      LD  HL,0
001267 5267 DD2139F1        14      LD  IX,_BUF
00126B 526B FD2139F1        14      LD  IY,_BUF
00126F 526F FD3600F9        19      LD  (IY+0),0F9H
001273 5273 3E02             7      LD  A,2
001275 5275 C9              10      RET
                                
       5276                     _SYS21:     ;(BDOS)ランダムな読み出し
001276 5276 CD564D          17      CALL    SET_FCB
                                
001279 5279 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
00127C 527C FD6622          19      LD  H,(IY+34)
                                
00127F 527F CD114D          17      CALL    RB_READ
001282 5282 18C0            12      JR  SREAD
                                
       5284                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
001284 5284 CD9451          17      CALL    _SYS0F
001287 5287 D8              11      RET C
                                
001288 5288 D5              11      PUSH    DE      ;EX DE,IY
001289 5289 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00128B 528B CD464D          17      CALL    GETSIZE
       528E                     _S24X1:
00128E 528E FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001291 5291 FD7422          19      LD  (IY+34),H
001294 5294 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
001298 5298 FDE3            23      EX  (SP),IY     ;
00129A 529A D1              10      POP DE      ;
                                
00129B 529B AF               4      XOR A
00129C 529C C9              10      RET
                                
       529D                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
00129D 529D E5              11      PUSH    HL
00129E 529E D5              11      PUSH    DE      ;EX DE,IY
00129F 529F FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0012A1 52A1 CD244D          17      CALL    GETSEQ
0012A4 52A4 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       52A6                     _SYS27:     ;(BDOS)ランダムブロック読み込み
0012A6 52A6 CD564D          17      CALL    SET_FCB
0012A9 52A9 E5              11      PUSH    HL
0012AA 52AA FD6E21          19      LD  L,(IY+33)
0012AD 52AD FD6622          19      LD  H,(IY+34)
0012B0 52B0 2225F1          16      LD  (RR_LOW),HL
0012B3 52B3 FD6E23          19      LD  L,(IY+35)
0012B6 52B6 FD6624          19      LD  H,(IY+36)
0012B9 52B9 2227F1          16      LD  (RR_HIGH),HL
0012BC 52BC E1              10      POP HL
0012BD 52BD CD6F49          17      CALL    ROM_READ
0012C0 52C0 ED5B25F1        20      LD  DE,(RR_LOW)
0012C4 52C4 FD7321          19      LD  (IY+33),E
0012C7 52C7 FD7222          19      LD  (IY+34),D
0012CA 52CA ED5B27F1        20      LD  DE,(RR_HIGH)
0012CE 52CE FD7323          19      LD  (IY+35),E
0012D1 52D1 FD7224          19      LD  (IY+36),D
0012D4 52D4 9F               4      SBC A,A
0012D5 52D5 C9              10      RET
                                
       52D6                     _SYS2F:
0012D6 52D6 44               4      LD  B,H
0012D7 52D7 2A2FF1          16      LD  HL,(_DTA)
0012DA 52DA C3AF4D          10      JP  DISKIO
                                
       52DD                     INIT_FILE:
0012DD 52DD EB               4      EX  DE,HL
0012DE 52DE 1153F1          10      LD  DE,FDRV
0012E1 52E1 010C00          10      LD  BC,1+8+3
0012E4 52E4 EDB0                    LDIR
0012E6 52E6 CD444F          17      CALL    GET_DISK_BANK_FDRV
0012E9 52E9 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0012EC 52EC 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0012EF 52EF C9              10      RET
                                
       52F0                     ZERO_MEMORY_DE:
0012F0 52F0 AF               4      XOR A
       52F1                     FILL_MEMORY_DE:
0012F1 52F1 12               7      LD  (DE),A
0012F2 52F2 13               6      INC DE
0012F3 52F3 10FC            13      DJNZ    FILL_MEMORY_DE
0012F5 52F5 C9              10      RET
                                
0012F6 52F6                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 884F9E4FCF4F884F        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 884F884FD44F1550        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 DC4F884F2F50C350        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 8351895190519451        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 EA51F8512152884F        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 3652884F884F884F        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 4F52545258525E52        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 884F884F884F8452        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 9D52884F884FA652        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 884F884FD550884F        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 DB50884F884FD652        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB8 5FB8 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 884F884F884F884F        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM32.ASM:UTF_8]
