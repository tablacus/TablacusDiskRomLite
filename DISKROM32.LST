                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
                                ;PTRFIL EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
                                ;FILNAM EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FDDB                     H_PINL  EQU 0FDDBH
                                
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;ASCII-16K
       6000                     ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
       7000                     ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                            ;KONAMI-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;KONAMI-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                
       F0E9                     ISC EQU 0F0E9H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
[EOF:DEF.ASM:UTF_8]
                                
       0001                     USE_NORMAL_32K_ROM      EQU 1   ;ノーマル32KB ROMを作成する
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 234E                    DW  STATEMENT  ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C3C44E          10      JP  DISKIO
000013 4013 C30A4F          10      JP  DSKCHG
000016 4016 C3604F          10      JP  GETDPB
000019 4019 C35350          10      JP  CHOICE
00001C 401C C35750          10      JP  DSKFMT
00001F 401F C35950          10      JP  DSKSTP
000022 4022 C35A50          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C35750          10      JP  DSKFMT
000029 4029 C35950          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C39650          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.2.0.2",0
            204449534B20524F    
            4D204C6974652076    
            302E322E302E3200    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 0180FF          10      LD  BC,-00080H
000109 4109 2A72F6          16      LD  HL,(MEMSIZ)
00010C 410C 09              11      ADD HL,BC
00010D 410D 2272F6          16      LD  (MEMSIZ),HL
000110 4110 2A74F6          16      LD  HL,(STKTOP)
000113 4113 09              11      ADD HL,BC
000114 4114 2274F6          16      LD  (STKTOP),HL
000117 4117 2180F0          10      LD  HL,0F080H
00011A 411A 1100F0          10      LD  DE,0F000H
00011D 411D 012000          10      LD  BC,00020H
000120 4120 EDB0                    LDIR
000122 4122 2180FF          10      LD  HL,-00080H
000125 4125 39              11      ADD HL,SP
000126 4126 2262F1          16      LD  (_SP),HL
000129 4129 ED7B62F1        20      LD  SP,(_SP)
                                
00012D 412D 3EFF             7      LD  A,0FFH
00012F 412F 3299FD          13      LD  (DEVICE),A
                                
000132 4132 3E01             7      LD  A,1
000134 4134 3221FB          13      LD  (DRVTBL),A
                                
000137 4137 AF               4      XOR A
000138 4138 3246F1          13      LD  (_DVSW),A
                                
00013B 413B 210643          10      LD  HL,AT_ISC
00013E 413E 11E9F0          10      LD  DE,ISC
000141 4141 017B00          10      LD  BC,ISC_E-ISC
000144 4144 EDB0                    LDIR
                                    
000146 4146 3EC3             7      LD  A,0C3H      ;JP
000148 4148 3243FF          13      LD  (H_GONE),A
00014B 414B 327DF3          13      LD  (BDOS),A
00014E 414E 326BF3          13      LD  (RAMUSE),A
000151 4151 3268F3          13      LD  (ROMUSE),A
000154 4154 21E9F0          10      LD  HL,REPLACE_COMMAND
000157 4157 2244FF          16      LD  (H_GONE+1),HL
00015A 415A 2131F3          10      LD  HL,H_BDOS
00015D 415D 227EF3          16      LD  (BDOS+1),HL
000160 4160 2119F1          10      LD  HL,RAMUSE1
000163 4163 226CF3          16      LD  (RAMUSE+1),HL
000166 4166 2114F1          10      LD  HL,ROMUSE1
000169 4169 2269F3          16      LD  (ROMUSE+1),HL
                                
00016C 416C 3E                      DB  03EH
00016D 416D F7              12      RST 30H
00016E 416E 3271FE          13      LD  (H_BINS),A
000171 4171 3276FE          13      LD  (H_BINL),A
000174 4174 327BFE          13      LD  (H_FILE),A
000177 4177 3231F3          13      LD  (H_BDOS),A
00017A 417A 32DBFD          13      LD  (H_PINL),A
00017D 417D 32A7FF          13      LD  (H_PHYD),A
                                
000180 4180 CD4642          17      CALL    GTSL1_
000183 4183 3200F1          13      LD  (ROM_SLT),A
000186 4186 3210F1          13      LD  (ROM_SLT_COPY),A
000189 4189 3272FE          13      LD  (H_BINS+1),A
00018C 418C 3277FE          13      LD  (H_BINL+1),A
00018F 418F 327CFE          13      LD  (H_FILE+1),A
000192 4192 3232F3          13      LD  (H_BDOS+1),A
000195 4195 32DCFD          13      LD  (H_PINL+1),A
000198 4198 32A8FF          13      LD  (H_PHYD+1),A
00019B 419B 3222FB          13      LD  (DRVTBL+1),A
00019E 419E 3248F3          13      LD  (MASTERS),A
                                
0001A1 41A1 218745          10      LD  HL,ROM_LOAD
0001A4 41A4 2273FE          16      LD  (H_BINS+2),HL
0001A7 41A7 21B946          10      LD  HL,ROM_RUN
0001AA 41AA 2278FE          16      LD  (H_BINL+2),HL
0001AD 41AD 21C646          10      LD  HL,ROM_FILES
0001B0 41B0 227DFE          16      LD  (H_FILE+2),HL
0001B3 41B3 21EF50          10      LD  HL,ROM_BDOS
0001B6 41B6 2233F3          16      LD  (H_BDOS+2),HL
0001B9 41B9 21AB43          10      LD  HL,ROM_BOOT
0001BC 41BC 22DDFD          16      LD  (H_PINL+2),HL
0001BF 41BF 21C44E          10      LD  HL,DISKIO
0001C2 41C2 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001C5 41C5 3E                      DB  03EH
0001C6 41C6 C9              10      RET
0001C7 41C7 327FFE          13      LD  (H_FILE+4),A
0001CA 41CA 3275FE          13      LD  (H_BINS+4),A
0001CD 41CD 327AFE          13      LD  (H_BINL+4),A
0001D0 41D0 3235F3          13      LD  (H_BDOS+4),A
0001D3 41D3 32DFFD          13      LD  (H_PINL+4),A
0001D6 41D6 32ABFF          13      LD  (H_PHYD+4),A
                                
0001D9 41D9 AF               4      XOR A
0001DA 41DA 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001DD 41DD 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0001E0 41E0 3A0060          13      LD  A,(BANK1_ADR)
0001E3 41E3 FE41             7      CP  'A'
                                #if exists USE_NORMAL_32K_ROM
0001E5 41E5 284E            12      JR  Z,NOT_BANK_TYPE
0001E7 41E7 3E01             7      LD  A,DISK_BANK
0001E9 41E9 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    JR  NZ,NOT_BANK_TYPE
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001EC 41EC CD3801          17      CALL    RSLREG      ;read primary slot #
0001EF 41EF 07               4      RLCA
0001F0 41F0 07               4      RLCA
0001F1 41F1 F5              11      PUSH    AF
0001F2 41F2 1605             7      LD  D,4+1
0001F4 41F4 CD4D42          17      CALL    GTSL2_
0001F7 41F7 3244F3          13      LD  (RAMAD3),A
0001FA 41FA F1              10      POP AF
0001FB 41FB 07               4      RLCA
0001FC 41FC 07               4      RLCA
0001FD 41FD 1603             7      LD  D,2+1
0001FF 41FF CD4D42          17      CALL    GTSL2_
000202 4202 2680             7      LD  H,080H
000204 4204 CD6A42          17      CALL    CHK_RAM
000207 4207 3243F3          13      LD  (RAMAD2),A
       420A                     RAMCHK2:
00020A 420A 3A44F3          13      LD  A,(RAMAD3)
00020D 420D 2640             7      LD  H,040H
00020F 420F CD6A42          17      CALL    CHK_RAM
000212 4212 3242F3          13      LD  (RAMAD1),A
       4215                     RAMCHK1:
000215 4215 3A44F3          13      LD  A,(RAMAD3)
000218 4218 2600             7      LD  H,00H
00021A 421A CD6A42          17      CALL    CHK_RAM
00021D 421D 3241F3          13      LD  (RAMAD0),A
       4220                     RAMCHK0:
000220 4220 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
000223 4223 010F00          10      LD  BC,0000FH       ;切り上げ
000226 4226 09              11      ADD HL,BC
000227 4227 7D               4      LD  A,L
                                
000228 4228 0604             7      LD  B,4
       422A                     B_DRIVE1:
00022A 422A CB3C             8      SRL H
00022C 422C 1F               4      RRA
00022D 422D 10FB            13      DJNZ    B_DRIVE1
                                
00022F 422F C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
000231 4231 3245F1          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
000234 4234 C9              10      RET
                                
       4235                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
000235 4235 21DD43          10      LD  HL,MSG_ERROR_ROM_MODE
000238 4238 CD8443          17      CALL    MSX
00023B 423B FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00023F 423F DD219F00        14      LD  IX,CHGET
000243 4243 C31C00          10      JP  _CALSLT
                                
       4246                     GTSL1_:             ;自分のいるスロットを知る
000246 4246 CD3801          17      CALL    RSLREG      ;read primary slot #
000249 4249 0F               4      RRCA
00024A 424A 0F               4      RRCA
00024B 424B 1601             7      LD  D,1
       424D                     GTSL2_:
00024D 424D E603             7      AND 3       ;[A]=000000PP
00024F 424F 5F               4      LD  E,A     ;[E]=000000PP
000250 4250 21C1FC          10      LD  HL,EXPTBL
000253 4253 85               4      ADD A,L     ;桁上りは無い
000254 4254 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000255 4255 7B               4      LD  A,E     ;[A]=000000PP
000256 4256 CB7E            13      BIT 7,(HL)
000258 4258 C8              11      RET Z
000259 4259 7D               4      LD  A,L     ;point to SLTTBL entry
00025A 425A C604             7      ADD A,4     ;桁上りは無い
00025C 425C 6F               4      LD  L,A
00025D 425D 7E               7      LD  A,(HL)      ;get currently expansion slot register
       425E                     GTSL3_:
00025E 425E 15               4      DEC D
00025F 425F 2803            12      JR  Z,GTSL4_:
000261 4261 0F               4      RRCA
000262 4262 18FA            12      JR  GTSL3_:
       4264                     GTSL4_:
000264 4264 E60C             7      AND 00CH        ;[A] = 0000SS00
000266 4266 B3               4      OR  E       ;[A] = 0000SSPP
000267 4267 F680             7      OR  080H        ;[A] = 1000SSPP
000269 4269 C9              10      RET
                                
       426A                     CHK_RAM:
00026A 426A E5              11      PUSH    HL
00026B 426B CDBF42          17      CALL    CHK_RAM0
00026E 426E E1              10      POP HL
00026F 426F C8              11      RET Z
000270 4270 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
000273 4273 E680             7      AND 080H
000275 4275 CD9642          17      CALL    CHK_RAM_SLT
000278 4278 C8              11      RET Z
000279 4279 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
00027C 427C E680             7      AND 080H
00027E 427E C601             7      ADD A,1
000280 4280 CD9642          17      CALL    CHK_RAM_SLT
000283 4283 C8              11      RET Z
000284 4284 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000287 4287 E680             7      AND 080H
000289 4289 C602             7      ADD A,2
00028B 428B CD9642          17      CALL    CHK_RAM_SLT
00028E 428E C8              11      RET Z
00028F 428F 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000292 4292 E680             7      AND 080H
000294 4294 C603             7      ADD A,3
       4296                     CHK_RAM_SLT:
000296 4296 E5              11      PUSH    HL
000297 4297 CDBF42          17      CALL    CHK_RAM0        ;スロット#X or X-0
00029A 429A E1              10      POP HL
00029B 429B C8              11      RET Z
00029C 429C CB79             8      BIT 7,C
00029E 429E 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
0002A0 42A0 79               4      LD  A,C
0002A1 42A1 C604             7      ADD A,4*1           ;スロット#X-1
0002A3 42A3 E5              11      PUSH    HL
0002A4 42A4 CDBF42          17      CALL    CHK_RAM0
0002A7 42A7 E1              10      POP HL
0002A8 42A8 C8              11      RET Z
0002A9 42A9 79               4      LD  A,C
0002AA 42AA C608             7      ADD A,4*2           ;スロット#X-2
0002AC 42AC E5              11      PUSH    HL
0002AD 42AD CDBF42          17      CALL    CHK_RAM0
0002B0 42B0 E1              10      POP HL
0002B1 42B1 C8              11      RET Z
0002B2 42B2 79               4      LD  A,C
0002B3 42B3 C60C             7      ADD A,4*3           ;スロット#X-3
0002B5 42B5 E5              11      PUSH    HL
0002B6 42B6 CDBF42          17      CALL    CHK_RAM0
0002B9 42B9 E1              10      POP HL
       42BA                     CHK_RAM_E:
0002BA 42BA AF               4      XOR A
0002BB 42BB 3C               4      INC A           ;ZF=0にする
0002BC 42BC 3E00             7      LD  A,0
0002BE 42BE C9              10      RET
                                
       42BF                     CHK_RAM0:
0002BF 42BF 4F               4      LD  C,A
0002C0 42C0 3A00F1          13      LD  A,(ROM_SLT)
0002C3 42C3 B9               4      CP  C
0002C4 42C4 28F4            12      JR  Z,CHK_RAM_E
0002C6 42C6 2E00             7      LD  L,0
       42C8                     CHK_RAM1:
0002C8 42C8 79               4      LD  A,C
0002C9 42C9 DD210C00        14      LD  IX,_RDSLT
0002CD 42CD CDFA42          17      CALL    CALSLT_R
0002D0 42D0 C6E5             7      ADD A,0E5H
0002D2 42D2 47               4      LD  B,A
0002D3 42D3 5F               4      LD  E,A
0002D4 42D4 79               4      LD  A,C
0002D5 42D5 DD211400        14      LD  IX,_WRSLT
0002D9 42D9 CDFA42          17      CALL    CALSLT_R
0002DC 42DC 79               4      LD  A,C
0002DD 42DD DD210C00        14      LD  IX,_RDSLT
0002E1 42E1 CDFA42          17      CALL    CALSLT_R
0002E4 42E4 B8               4      CP  B
0002E5 42E5 C0              11      RET NZ
0002E6 42E6 D6E5             7      SUB 0E5H
0002E8 42E8 79               4      LD  A,C
0002E9 42E9 5F               4      LD  E,A
0002EA 42EA DD211400        14      LD  IX,_WRSLT
0002EE 42EE CDFA42          17      CALL    CALSLT_R
0002F1 42F1 24               4      INC H
0002F2 42F2 7D               4      LD  A,L
0002F3 42F3 C604             7      ADD A,4
0002F5 42F5 6F               4      LD  L,A
0002F6 42F6 20D0            12      JR  NZ,CHK_RAM1
0002F8 42F8 79               4      LD  A,C     ;ZF=1のハズ
0002F9 42F9 C9              10      RET
                                
       42FA                     CALSLT_R:
0002FA 42FA C5              11      PUSH    BC
0002FB 42FB E5              11      PUSH    HL
0002FC 42FC FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000300 4300 CD1C00          17      CALL    _CALSLT
000303 4303 E1              10      POP HL
000304 4304 C1              10      POP BC
000305 4305 C9              10      RET
                                
       4306                     AT_ISC:
000306 F0E9                         ORG ISC,AT_ISC-RUN
       F0E9                     REPLACE_COMMAND:
000306 F0E9 FEB7             7      CP  0B7H            ;FILES
000308 F0EB CC7BFE          17      CALL    Z,H_FILE
00030B F0EE FEB5             7      CP  0B5H            ;LOAD
00030D F0F0 CA71FE          10      JP  Z,H_BINS
000310 F0F3 FE8A             7      CP  08AH            ;RUN
000312 F0F5 CA76FE          10      JP  Z,H_BINL
000315 F0F8 FED6             7      CP  0D6H            ;COPY
000317 F0FA 2813            12      JR  Z,FIX_COPY
000319 F0FC FECF             7      CP  0CFH            ;BLOAD
00031B F0FE C0              11      RET NZ
       F0FF                     FIX_BLOAD:
00031C F0FF F7              12      RST 30H
       F100                     ROM_SLT:
00031D F100 00                      DB  0
00031E F101 EF45                    DW  ROM_BLOAD
000320 F103 F5              11      PUSH    AF
000321 F104 E5              11      PUSH    HL
000322 F105 CD0EF1          17      CALL    BLOAD_RET
       F106                     SWC_BLOAD   EQU $-2
000325 F108 E1              10      POP HL
000326 F109 F1              10      POP AF
000327 F10A FECF             7      CP  0CFH            ;BLOAD
       F10C                     SWC_BLOAD_M:
000329 F10C 28DB            12      JR  Z,REPLACE_COMMAND
       F10E                     BLOAD_RET:
00032B F10E C9              10      RET
       F10F                     FIX_COPY:
00032C F10F F7              12      RST 30H
       F110                     ROM_SLT_COPY:
00032D F110 00                      DB  0
00032E F111 4C47                    DW  ROM_COPY
000330 F113 C9              10      RET
       F114                     ROMUSE1:
000331 F114 3A00F1          13      LD  A,(ROM_SLT)
000334 F117 1803            12      JR  ROMUSE2
       F119                     RAMUSE1:
000336 F119 3A42F3          13      LD  A,(RAMAD1)
       F11C                     ROMUSE2:
000339 F11C C32400          10      JP  _ENASLT
                                
       F11F                     _RESULT:
00033C F11F 00                      DB  0
       F120                     _BANK:
00033D F120 00                      DB  0
       F121                     _BANK1:
00033E F121 00                      DB  0
       F122                     CLSZ:               ;クラスタサイズ
00033F F122 0004                    DW  1024
       F123                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F124                     SECSZ:              ;セクタサイズ
000341 F124 0002                    DW  512
       F125                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F126                     RR_LOW:
000343 F126 0000                    DW  0
       F127                     RR_MID  EQU $-1
       F128                     RR_HIGH:
000345 F128 0000                    DW  0
       F12A                     _CLPS:
000347 F12A 0000                    DW  0
       F12C                     _LEFT:
000349 F12C 0000                    DW  0
       F12E                     _DTPS:
00034B F12E 0000                    DW  0
       F130                     _DTA:
00034D F130 0000                    DW  0
       F132                     FLG_LDIR:
00034F F132 00                      DB  0
       F133                     _FCB:
000350 F133 0000                    DW  0
       F135                     _BUF:
       F135                     _BUF_LO:        ;LOGICAL OPERATION
000352 F135 00                      DB  0
       F136                     _BUF_ST:
000353 F136 0000                    DW  0
       F138                     _BUF_EN:
000355 F138 0000                    DW  0
       F13A                     _BUF_EX:
       F13A                     _BUF_W:
000357 F13A 0000                    DW  0
       F13C                     _BUF_H:
000359 F13C 0000                    DW  0
       F13E                     _BUF_X:
00035B F13E 0000                    DW  0
       F140                     _BUF_Y:
00035D F140 00                      DB  0
       F141                     _BUF_P:
00035E F141 00                      DB  0
       F142                     _BUF_O:
00035F F142 00                      DB  0
       F143                     DTAX:
000360 F143 0000                    DW  0
       F145                     B_DRIVE:
000362 F145 00                      DB  0
       F146                     _DVSW:
000363 F146 00                      DB  0
       F147                     DIRENT1:
000364 F147 0000                    DW  0
       F149                     _DIR_BANK:
000366 F149 00                      DB  0
       F14A                     LEFTX:
000367 F14A 0000                    DW  0
       F14C                     PARAM0:
000369 F14C 0000                    DW  0
       F14E                     PARAM1:
00036B F14E 0000                    DW  0
       F150                     FDRV:
00036D F150 00                      DB  0
       F151                     FNAME:
00036E F151                         DS  8+3
       F15C                     _CD:            ;カレントディレクトリ
000379 F15C 0000                    DW  0
       F15E                     _CDX:
00037B F15E 0000                    DW  0
       F160                     _HL:
00037D F160 0000                    DW  0
       F162                     _SP:
00037F F162 0000                    DW  0
                                
       F164                     ISC_E:
000381 4381                         ORG $$+RUN          ;$DEPHASE
                                
       4381                     MSX1:
000381 4381 CD0851          17      CALL    MSGA1
       4384                     MSX:
000384 4384 7E               7      LD  A,(HL)
000385 4385 23               6      INC HL
000386 4386 B7               4      OR  A
000387 4387 20F8            12      JR  NZ,MSX1
000389 4389 C9              10      RET
                                
       438A                     PRTHX:
00038A 438A F5              11      PUSH    AF
00038B 438B 07               4      RLCA
00038C 438C 07               4      RLCA
00038D 438D 07               4      RLCA
00038E 438E 07               4      RLCA
00038F 438F CD9343          17      CALL    PRTA2
000392 4392 F1              10      POP AF
       4393                     PRTA2:
000393 4393 CD9943          17      CALL    ASC
000396 4396 C30451          10      JP  MSG_A
                                    
       4399                     ASC:
000399 4399 E60F             7      AND $0F
00039B 439B F630             7      OR  $30
00039D 439D FE3A             7      CP  $3A
00039F 439F D8              11      RET C
0003A0 43A0 C607             7      ADD A,7
0003A2 43A2 C9              10      RET
                                
       43A3                     MSN:
0003A3 43A3 7E               7      LD  A,(HL)
0003A4 43A4 23               6      INC HL
0003A5 43A5 CD0451          17      CALL    MSG_A
0003A8 43A8 10F9            13      DJNZ    MSN
0003AA 43AA C9              10      RET
                                
       43AB                     ROM_BOOT:
0003AB 43AB 3E                      DB  03EH
0003AC 43AC C9              10      RET
0003AD 43AD 32DBFD          13      LD  (H_PINL),A
                                
0003B0 43B0 21FA43          10      LD  HL,DELOK
0003B3 43B3 CD8443          17      CALL    MSX
                                
0003B6 43B6 AF               4      XOR A
0003B7 43B7 3240F3          13      LD  (REBOOT),A
0003BA 43BA 2A48FC          16      LD  HL,(BOTTOM)
0003BD 43BD 110040          10      LD  DE,16384
0003C0 43C0 19              11      ADD HL,DE
0003C1 43C1 3817            12      JR  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
0003C3 43C3 57               4      LD  D,A
0003C4 43C4 0601             7      LD  B,1
0003C6 43C6 2100C0          10      LD  HL,0C000H
0003C9 43C9 CDC44E          17      CALL    DISKIO
                                
0003CC 43CC 116BF3          10      LD  DE,RAMUSE
0003CF 43CF AF               4      XOR A
0003D0 43D0 CD1EC0          17      CALL    0C01EH
0003D3 43D3 116BF3          10      LD  DE,RAMUSE
0003D6 43D6 37               4      SCF
0003D7 43D7 CD1EC0          17      CALL    0C01EH
       43DA                     BOOT1:
0003DA 43DA C35A50          10      JP  BASENT
                                
       43DD                     MSG_ERROR_ROM_MODE:
                                #if exists USE_NORMAL_32K_ROM
0003DD 43DD 4E6F726D616C2052        DB  "Normal ROM/ASCII-16K only!",13,10
            4F4D2F4153434949    
            2D31364B206F6E6C    
            79210D0A            
                                #else
                                    DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
                                #endif
       43F9                     NULL:
0003F9 43F9 00                      DB  0
       43FA                     DELOK:
0003FA 43FA 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       43FE                     ROM_LDIR:
0003FE 43FE 3A32F1          13      LD  A,(FLG_LDIR)
000401 4401 B7               4      OR  A
000402 4402 2064            12      JR  NZ,ROM_LDIRVM
000404 4404 CB7A             8      BIT 7,D
000406 4406 CA9144          10      JP  Z,ROM_LDIRSLT
                                #if exists USE_NORMAL_32K_ROM
       4409                     LDIRA:
000409 4409 F3               4      DI
00040A 440A ED7362F1        20      LD  (_SP),SP
00040E 440E 3121FB          10      LD  SP,DRVTBL
       4411                     LDIR1:
000411 4411 78               4      LD  A,B
000412 4412 B1               4      OR  C
000413 4413 284D            12      JR  Z,LDIRE
                                
000415 4415 C5              11      PUSH    BC
000416 4416 D5              11      PUSH    DE
000417 4417 E5              11      PUSH    HL
000418 4418 3A00F1          13      LD  A,(ROM_SLT)
00041B 441B 2680             7      LD  H,080H
00041D 441D CD2400          17      CALL    _ENASLT
000420 4420 E1              10      POP HL
000421 4421 D1              10      POP DE
000422 4422 C1              10      POP BC
       4423                     LDIR2:
000423 4423 7A               4      LD  A,D
000424 4424 FEC0             7      CP  0C0H
000426 4426 302C            12      JR  NC,LDIR4
                                
000428 4428 C5              11      PUSH    BC
000429 4429 D5              11      PUSH    DE
00042A 442A 115EF5          10      LD  DE,BUF
                                
00042D 442D 78               4      LD  A,B
00042E 442E B7               4      OR  A
00042F 442F 2803            12      JR  Z,LDIR3
000431 4431 010001          10      LD  BC,00100H
       4434                     LDIR3:
000434 4434 C5              11      PUSH    BC
000435 4435 EDB0                    LDIR
000437 4437 2260F1          16      LD  (_HL),HL
                                
00043A 443A 3A43F3          13      LD  A,(RAMAD2)
00043D 443D 2680             7      LD  H,080H
00043F 443F CD2400          17      CALL    _ENASLT
                                
000442 4442 C1              10      POP BC
000443 4443 D1              10      POP DE
000444 4444 215EF5          10      LD  HL,BUF
000447 4447 EDB0                    LDIR
                                
000449 4449 2A60F1          16      LD  HL,(_HL)
00044C 444C C1              10      POP BC
00044D 444D 78               4      LD  A,B
00044E 444E B7               4      OR  A
00044F 444F 2811            12      JR  Z,LDIRE
000451 4451 05               4      DEC B
000452 4452 18BD            12      JR  LDIR1
       4454                     LDIR4:
                                #endif
000454 4454 EDB0                    LDIR
                                
                                #if exists USE_NORMAL_32K_ROM
       4456                     LDIRE2:
000456 4456 D5              11      PUSH    DE
000457 4457 E5              11      PUSH    HL
000458 4458 3A43F3          13      LD  A,(RAMAD2)
00045B 445B 2680             7      LD  H,080H
00045D 445D CD2400          17      CALL    _ENASLT
000460 4460 E1              10      POP HL
000461 4461 D1              10      POP DE
       4462                     LDIRE:
000462 4462 ED7B62F1        20      LD  SP,(_SP)
000466 4466 FB               4      EI
                                #endif
000467 4467 C9              10      RET
                                
       4468                     ROM_LDIRVM:
                                #if exists USE_NORMAL_32K_ROM
000468 4468 F3               4      DI
000469 4469 ED7362F1        20      LD  (_SP),SP
00046D 446D 3121FB          10      LD  SP,DRVTBL
000470 4470 C5              11      PUSH    BC
000471 4471 D5              11      PUSH    DE
000472 4472 E5              11      PUSH    HL
000473 4473 3A00F1          13      LD  A,(ROM_SLT)
000476 4476 2680             7      LD  H,080H
000478 4478 CD2400          17      CALL    _ENASLT
00047B 447B E1              10      POP HL
00047C 447C D1              10      POP DE
00047D 447D C1              10      POP BC
                                #endif
00047E 447E C5              11      PUSH    BC
00047F 447F D5              11      PUSH    DE
000480 4480 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000484 4484 DD215C00        14      LD  IX,LDIRVM
000488 4488 CD1C00          17      CALL    _CALSLT
00048B 448B E1              10      POP HL
00048C 448C C1              10      POP BC
00048D 448D 09              11      ADD HL,BC
00048E 448E EB               4      EX  DE,HL
                                #if exists USE_NORMAL_32K_ROM
00048F 448F 18C5            12      JR  LDIRE2
                                #else
                                    RET
                                #endif
                                
       4491                     ROM_LDIRSLT:
                                #if exists USE_NORMAL_32K_ROM
000491 4491 F3               4      DI
000492 4492 ED7362F1        20      LD  (_SP),SP
000496 4496 3121FB          10      LD  SP,DRVTBL
000499 4499 C5              11      PUSH    BC
00049A 449A D5              11      PUSH    DE
00049B 449B E5              11      PUSH    HL
00049C 449C 3A00F1          13      LD  A,(ROM_SLT)
00049F 449F 2680             7      LD  H,080H
0004A1 44A1 CD2400          17      CALL    _ENASLT
0004A4 44A4 E1              10      POP HL
0004A5 44A5 D1              10      POP DE
0004A6 44A6 C1              10      POP BC
                                #endif
       44A7                     ROM_LDIRSLT1:
0004A7 44A7 EB               4      EX  DE,HL
       44A8                     RLDIRSLT1:
0004A8 44A8 1A               7      LD  A,(DE)
0004A9 44A9 13               6      INC DE
0004AA 44AA C5              11      PUSH    BC
0004AB 44AB D5              11      PUSH    DE
0004AC 44AC E5              11      PUSH    HL
0004AD 44AD 5F               4      LD  E,A
                                
0004AE 44AE 0141F3          10      LD  BC,RAMAD0
0004B1 44B1 7C               4      LD  A,H
0004B2 44B2 07               4      RLCA
0004B3 44B3 07               4      RLCA
0004B4 44B4 E603             7      AND 3
0004B6 44B6 81               4      ADD A,C
0004B7 44B7 4F               4      LD  C,A
0004B8 44B8 0A               7      LD  A,(BC)
       44B9                     RLDIRSLT2:
0004B9 44B9 CD1400          17      CALL    _WRSLT
0004BC 44BC 08               4      EX  AF,AF'
0004BD 44BD E1              10      POP HL
0004BE 44BE D1              10      POP DE
0004BF 44BF C1              10      POP BC
0004C0 44C0 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0004C2 44C2 EAA844          10      JP  PE,RLDIRSLT1
0004C5 44C5 EB               4      EX  DE,HL
                                #if exists USE_NORMAL_32K_ROM
0004C6 44C6 188E            12      JR  LDIRE2
                                #else
                                    RET
                                #endif
                                
       44C8                     END_OF_LINE:
0004C8 44C8 215EF5          10      LD  HL,BUF
       44CB                     EOL1:
0004CB 44CB 7E               7      LD  A,(HL)
0004CC 44CC C8              11      RET Z
0004CD 44CD FE0D             7      CP  00DH
0004CF 44CF 2807            12      JR  Z,EOLE
0004D1 44D1 FE0A             7      CP  00AH
0004D3 44D3 2803            12      JR  Z,EOLE
0004D5 44D5 23               6      INC HL
0004D6 44D6 18F3            12      JR  EOL1
       44D8                     EOLE:
0004D8 44D8 3600            10      LD  (HL),0
0004DA 44DA 23               6      INC HL
0004DB 44DB 7E               7      LD  A,(HL)
0004DC 44DC FE0A             7      CP  00AH
0004DE 44DE C0              11      RET NZ
0004DF 44DF 23               6      INC HL
0004E0 44E0 C9              10      RET
                                
       44E1                     ROM_LOAD_ASCII:
0004E1 44E1 210000          10      LD  HL,0
0004E4 44E4 2236F1          16      LD  (_BUF_ST),HL    ;読み出し位置
0004E7 44E7 2A76F6          16      LD  HL,(TXTTAB)
0004EA 44EA 2238F1          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
0004ED 44ED 215EF5          10      LD  HL,BUF
0004F0 44F0 2230F1          16      LD  (_DTA),HL
       44F3                     RLOAD_A1:
0004F3 44F3 2A36F1          16      LD  HL,(_BUF_ST)
0004F6 44F6 2226F1          16      LD  (RR_LOW),HL
0004F9 44F9 210201          10      LD  HL,258
0004FC 44FC CD6749          17      CALL    ROM_READ
0004FF 44FF 7C               4      LD  A,H
000500 4500 B5               4      OR  L
000501 4501 2877            12      JR  Z,RLOAD_AEND
000503 4503 015EF5          10      LD  BC,BUF
000506 4506 09              11      ADD HL,BC
000507 4507 3600            10      LD  (HL),0
000509 4509 CDC844          17      CALL    END_OF_LINE
00050C 450C 015EF5          10      LD  BC,BUF
00050F 450F A7               4      AND A
000510 4510 ED42            15      SBC HL,BC
000512 4512 2810            12      JR  Z,RLOAD_A2
000514 4514 4D               4      LD  C,L
000515 4515 44               4      LD  B,H
000516 4516 ED5B36F1        20      LD  DE,(_BUF_ST)
00051A 451A 19              11      ADD HL,DE
00051B 451B 2236F1          16      LD  (_BUF_ST),HL
00051E 451E 3A5EF5          13      LD  A,(BUF)
000521 4521 B7               4      OR  A
000522 4522 28CF            12      JR  Z,RLOAD_A1
       4524                     RLOAD_A2:
000524 4524 115EF5          10      LD  DE,BUF
000527 4527 CD1E4B          17      CALL    SPCUTEX
00052A 452A 1A               7      LD  A,(DE)
00052B 452B B7               4      OR  A
00052C 452C 284C            12      JR  Z,RLOAD_AEND
00052E 452E CD304B          17      CALL    GETNUM
000531 4531 7C               4      LD  A,H
000532 4532 B5               4      OR  L
000533 4533 CAD945          10      JP  Z,ERROR_DIRECT_IN_FILE
000536 4536 DD2A38F1        20      LD  IX,(_BUF_EN)
00053A 453A DD7502          19      LD  (IX+2),L
00053D 453D DD7403          19      LD  (IX+3),H
                                
000540 4540 CD174B          17      CALL    SPCUT
000543 4543 EB               4      EX  DE,HL
000544 4544 DDE5            15      PUSH    IX
000546 4546 DD21B242        14      LD  IX,CRUNCH
00054A 454A FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00054E 454E CD1C00          17      CALL    _CALSLT
000551 4551 DDE1            14      POP IX
000553 4553 EB               4      EX  DE,HL
000554 4554 111FF4          10      LD  DE,KBUF
000557 4557 37               4      SCF
000558 4558 ED52            15      SBC HL,DE
00055A 455A 287D            12      JR  Z,ERROR_DIRECT_IN_FILE
00055C 455C 387B            12      JR  C,ERROR_DIRECT_IN_FILE
00055E 455E 4D               4      LD  C,L
00055F 455F 44               4      LD  B,H
000560 4560 2A38F1          16      LD  HL,(_BUF_EN)
000563 4563 110400          10      LD  DE,4
000566 4566 19              11      ADD HL,DE
000567 4567 111FF4          10      LD  DE,KBUF
                                
00056A 456A EB               4      EX  DE,HL
00056B 456B EDB0                    LDIR
00056D 456D EB               4      EX  DE,HL
                                
00056E 456E DD7500          19      LD  (IX+0),L
000571 4571 DD7401          19      LD  (IX+1),H
000574 4574 2238F1          16      LD  (_BUF_EN),HL
000577 4577 C3F344          10      JP  RLOAD_A1
                                
       457A                     RLOAD_AEND:
00057A 457A 2A38F1          16      LD  HL,(_BUF_EN)
00057D 457D AF               4      XOR A
00057E 457E 77               7      LD  (HL),A
00057F 457F 23               6      INC HL
000580 4580 77               7      LD  (HL),A
000581 4581 23               6      INC HL
000582 4582 2238F1          16      LD  (_BUF_EN),HL
000585 4585 183B            12      JR  RLOAD_END1
                                
       4587                     ROM_LOAD:
000587 4587 CD1647          17      CALL    INIT_PARAM
00058A 458A CD084A          17      CALL    FILE_B
00058D 458D 3A51F1          13      LD  A,(FNAME)
000590 4590 FE20             7      CP  020H
000592 4592 CA034A          10      JP  Z,ROM_ORG
                                
000595 4595 CD874B          17      CALL    ROM_OPEN
000598 4598 3848            12      JR  C,ERROR_FILE_NOT_FOUND
       459A                     ROM_LOAD1:
00059A 459A 2135F1          10      LD  HL,_BUF
00059D 459D 2230F1          16      LD  (_DTA),HL
0005A0 45A0 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
0005A3 45A3 CD6749          17      CALL    ROM_READ
0005A6 45A6 3A35F1          13      LD  A,(_BUF)
0005A9 45A9 3C               4      INC A
0005AA 45AA C2E144          10      JP  NZ,ROM_LOAD_ASCII
0005AD 45AD 2A76F6          16      LD  HL,(TXTTAB)
0005B0 45B0 2230F1          16      LD  (_DTA),HL
0005B3 45B3 EB               4      EX  DE,HL
0005B4 45B4 2100FF          10      LD  HL,-256
0005B7 45B7 39              11      ADD HL,SP
0005B8 45B8 ED52            15      SBC HL,DE
0005BA 45BA CD6749          17      CALL    ROM_READ
0005BD 45BD ED5B30F1        20      LD  DE,(_DTA)
0005C1 45C1 19              11      ADD HL,DE
       45C2                     RLOAD_END1:
0005C2 45C2 22C2F6          16      LD  (VARTAB),HL
0005C5 45C5 22C4F6          16      LD  (ARYTAB),HL
0005C8 45C8 22C6F6          16      LD  (STREND),HL
                                
0005CB 45CB AF               4      XOR A
0005CC 45CC 2138F1          10      LD  HL,_BUF+3
0005CF 45CF 77               7      LD  (HL),A
0005D0 45D0 2B               6      DEC HL
0005D1 45D1 77               7      LD  (HL),A
0005D2 45D2 2B               6      DEC HL
0005D3 45D3 77               7      LD  (HL),A
0005D4 45D4 2B               6      DEC HL
0005D5 45D5 3E8F             7      LD  A,08FH          ;REM
0005D7 45D7 77               7      LD  (HL),A
0005D8 45D8 C9              10      RET
                                
       45D9                     ERROR_DIRECT_IN_FILE:
0005D9 45D9 1E39             7      LD  E,57            ;Direct statement in file
0005DB 45DB 01                      DB  1           ;LD BC,
       45DC                     ERROR_INTERNAL_ERROR:
0005DC 45DC 1E33             7      LD  E,51            ;Internal error
0005DE 45DE 01                      DB  1           ;LD BC,
       45DF                     ERROR_FILE_NOT_OPEN:
0005DF 45DF 1E3B             7      LD  E,59            ;File not OPEN
0005E1 45E1 01                      DB  1           ;LD BC,
       45E2                     ERROR_FILE_NOT_FOUND:
0005E2 45E2 1E35             7      LD  E,53            ;File not found
       45E4                     ERROR:
0005E4 45E4 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0005E8 45E8 DD216F40        14      LD  IX,ERRHAND
0005EC 45EC C31C00          10      JP  _CALSLT
                                
       45EF                     ROM_BLOAD:
0005EF 45EF CD1647          17      CALL    INIT_PARAM
0005F2 45F2 CD084A          17      CALL    FILE_B
0005F5 45F5 CD874B          17      CALL    ROM_OPEN
0005F8 45F8 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
0005FA 45FA 2135F1          10      LD  HL,_BUF
0005FD 45FD 2230F1          16      LD  (_DTA),HL
000600 4600 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
000603 4603 CD6749          17      CALL    ROM_READ
000606 4606 3A35F1          13      LD  A,(_BUF)
000609 4609 FEFE             7      CP  0FEH
00060B 460B 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
00060D 460D 210EF1          10      LD  HL,BLOAD_RET
000610 4610 2206F1          16      LD  (SWC_BLOAD),HL
                                
000613 4613 2A4EF1          16      LD  HL,(PARAM1)
000616 4616 7E               7      LD  A,(HL)
000617 4617 FE2C             7      CP  ','
000619 4619 2048            12      JR  NZ,RBREAD_MEM
00061B 461B 23               6      INC HL
00061C 461C 7E               7      LD  A,(HL)
00061D 461D CD714B          17      CALL    CAP
000620 4620 32BEFC          13      LD  (RUNBNF),A
       4623                     RBOS1:
000623 4623 7E               7      LD  A,(HL)
000624 4624 23               6      INC HL
000625 4625 B7               4      OR  A
000626 4626 282F            12      JR  Z,RBREAD_OSE
000628 4628 FE3A             7      CP  ':'
00062A 462A 282B            12      JR  Z,RBREAD_OSE
00062C 462C FE2C             7      CP  ','     ;次のパラメータを探す
00062E 462E 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
000630 4630 224EF1          16      LD  (PARAM1),HL
000633 4633 7E               7      LD  A,(HL)
000634 4634 B7               4      OR  A
000635 4635 2820            12      JR  Z,RBREAD_OSE
000637 4637 DD21644C        14      LD  IX,FRMEVL
00063B 463B FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00063F 463F CD1C00          17      CALL    _CALSLT
000642 4642 224EF1          16      LD  (PARAM1),HL
000645 4645 3A63F6          13      LD  A,(VALTYP)
000648 4648 FE02             7      CP  2
00064A 464A 200B            12      JR  NZ,RBREAD_OSE
00064C 464C 2A36F1          16      LD  HL,(_BUF_ST)
00064F 464F ED5BF8F7        20      LD  DE,(DACDAT)
000653 4653 19              11      ADD HL,DE
000654 4654 2236F1          16      LD  (_BUF_ST),HL
       4657                     RBREAD_OSE:
000657 4657 3ABEFC          13      LD  A,(RUNBNF)
00065A 465A FE53             7      CP  'S'
00065C 465C 2005            12      JR  NZ,RBREAD_MEM
00065E 465E 3E01             7      LD  A,1
000660 4660 3232F1          13      LD  (FLG_LDIR),A
       4663                     RBREAD_MEM:
000663 4663 2A36F1          16      LD  HL,(_BUF_ST)
000666 4666 22BFFC          16      LD  (SAVENT),HL
000669 4669 2230F1          16      LD  (_DTA),HL
00066C 466C 21FFFF          10      LD  HL,0FFFFH
00066F 466F CD6749          17      CALL    ROM_READ
000672 4672 3ABEFC          13      LD  A,(RUNBNF)
000675 4675 FE52             7      CP  'R'
000677 4677 2006            12      JR  NZ,RBREAD1
000679 4679 2A3AF1          16      LD  HL,(_BUF_EX)
00067C 467C 2206F1          16      LD  (SWC_BLOAD),HL
       467F                     RBREAD1:
       467F                     ROM_NEXT:
00067F 467F 2A4EF1          16      LD  HL,(PARAM1)
000682 4682 7E               7      LD  A,(HL)
000683 4683 2B               6      DEC HL
000684 4684 B7               4      OR  A
000685 4685 2805            12      JR  Z,RN1
000687 4687 FE3A             7      CP  ':'
000689 4689 2801            12      JR  Z,RN1
00068B 468B 23               6      INC HL
       468C                     RN1:
00068C 468C 5D               4      LD  E,L
00068D 468D 54               4      LD  D,H
                                
00068E 468E CD474B          17      CALL    SEARCH_END
000691 4691 B7               4      OR  A
000692 4692 2821            12      JR  Z,REM
       4694                     RN3:                    ;マルチステートメントの処理
000694 4694 7E               7      LD  A,(HL)
                                
000695 4695 FEB5             7      CP  0B5H            ;LOAD
000697 4697 CA8745          10      JP  Z,ROM_LOAD
00069A 469A FE8A             7      CP  08AH            ;RUN
00069C 469C 281B            12      JR  Z,ROM_RUN
00069E 469E FEB7             7      CP  0B7H            ;FILES
0006A0 46A0 2824            12      JR  Z,ROM_FILES
0006A2 46A2 FED6             7      CP  0D6H            ;COPY
0006A4 46A4 CA4C47          10      JP  Z,ROM_COPY
0006A7 46A7 FE20             7      CP  020H
0006A9 46A9 2807            12      JR  Z,RN_SP
                                
0006AB 46AB 3E28             7      LD  A,028H          ;JR Z,
0006AD 46AD 320CF1          13      LD  (SWC_BLOAD_M),A
0006B0 46B0 7E               7      LD  A,(HL)
0006B1 46B1 C9              10      RET
       46B2                     RN_SP:
0006B2 46B2 23               6      INC HL
0006B3 46B3 18DF            12      JR  RN3
                                
       46B5                     REM:
0006B5 46B5 EB               4      EX  DE,HL
0006B6 46B6 3E8F             7      LD  A,08FH          ;REM
0006B8 46B8 C9              10      RET
                                
       46B9                     ROM_RUN:
0006B9 46B9 23               6      INC HL
0006BA 46BA 7E               7      LD  A,(HL)
0006BB 46BB 2B               6      DEC HL
0006BC 46BC B7               4      OR  A
0006BD 46BD 2803            12      JR  Z,ROM_RUN1
0006BF 46BF CD8745          17      CALL    ROM_LOAD
       46C2                     ROM_RUN1:
0006C2 46C2 3E8A             7      LD  A,08AH          ;RUN
0006C4 46C4 77               7      LD  (HL),A
0006C5 46C5 C9              10      RET
                                
       46C6                     ROM_FILES:
0006C6 46C6 CD1647          17      CALL    INIT_PARAM
0006C9 46C9 CD084A          17      CALL    FILE_B
0006CC 46CC CD9A50          17      CALL    GET_DISK_BANK_FDRV
0006CF 46CF 3A51F1          13      LD  A,(FNAME)
0006D2 46D2 FE21             7      CP  021H
0006D4 46D4 3005            12      JR  NC,RFILES0
0006D6 46D6 060B             7      LD  B,11
0006D8 46D8 CDDB4A          17      CALL    FILE10
       46DB                     RFILES0:
0006DB 46DB CDD94D          17      CALL    GET_DIR_DAT
       46DE                     RFILES1:
0006DE 46DE CDA34B          17      CALL    FILESE
0006E1 46E1 302E            12      JR  NC,RFILES_NOT_MATCH
       46E3                     RFILES_DISP:
0006E3 46E3 E5              11      PUSH    HL
0006E4 46E4 0608             7      LD  B,8
0006E6 46E6 CDA343          17      CALL    MSN
0006E9 46E9 3E2E             7      LD  A,'.'
0006EB 46EB CD0451          17      CALL    MSG_A
0006EE 46EE 0603             7      LD  B,3
0006F0 46F0 CDA343          17      CALL    MSN
0006F3 46F3 3ADDF3          13      LD  A,(CSRX)
0006F6 46F6 47               4      LD  B,A
0006F7 46F7 3AB0F3          13      LD  A,(LINLEN)
0006FA 46FA 90               4      SUB B
0006FB 46FB FE0C             7      CP  12
0006FD 46FD 3009            12      JR  NC,RFILES2
0006FF 46FF 3E0D             7      LD  A,00DH      ;改行
000701 4701 CD0451          17      CALL    MSG_A
000704 4704 3E0A             7      LD  A,00AH
000706 4706 1802            12      JR  RFILES3
       4708                     RFILES2:
000708 4708 3E20             7      LD  A,020H
       470A                     RFILES3:
00070A 470A CD0451          17      CALL    MSG_A
00070D 470D E1              10      POP HL
00070E 470E CDBF4B          17      CALL    FNEXT
       4711                     RFILES_NOT_MATCH:
000711 4711 20CB            12      JR  NZ,RFILES1
000713 4713 C37F46          10      JP  ROM_NEXT
                                
       4716                     INIT_PARAM:
000716 4716 224CF1          16      LD  (PARAM0),HL
000719 4719 224EF1          16      LD  (PARAM1),HL
00071C 471C EB               4      EX  DE,HL
00071D 471D AF               4      XOR A
00071E 471E 3232F1          13      LD  (FLG_LDIR),A
000721 4721 32BEFC          13      LD  (RUNBNF),A
000724 4724 3263F6          13      LD  (VALTYP),A
000727 4727 E5              11      PUSH    HL
000728 4728 2A5CF1          16      LD  HL,(_CD)
00072B 472B 225EF1          16      LD  (_CDX),HL
00072E 472E E1              10      POP HL
00072F 472F 13               6      INC DE
000730 4730 CD174B          17      CALL    SPCUT
000733 4733 1A               7      LD  A,(DE)
000734 4734 B7               4      OR  A
000735 4735 C8              11      RET Z
000736 4736 FE3A             7      CP  ':'
000738 4738 C8              11      RET Z
000739 4739 FE28             7      CP  '('
00073B 473B C8              11      RET Z
00073C 473C EB               4      EX  DE,HL
00073D 473D DD21644C        14      LD  IX,FRMEVL
000741 4741 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000745 4745 CD1C00          17      CALL    _CALSLT
000748 4748 224EF1          16      LD  (PARAM1),HL
00074B 474B C9              10      RET
                                
       474C                     ROM_COPY:
00074C 474C CD1647          17      CALL    INIT_PARAM
00074F 474F 3A63F6          13      LD  A,(VALTYP)
000752 4752 FE03             7      CP  3       ;string
000754 4754 C2034A          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
000757 4757 CD084A          17      CALL    FILE_B
00075A 475A CD874B          17      CALL    ROM_OPEN
00075D 475D DAE245          10      JP  C,ERROR_FILE_NOT_FOUND
                                
000760 4760 213AF1          10      LD  HL,_BUF_W
000763 4763 2230F1          16      LD  (_DTA),HL
000766 4766 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
000769 4769 CD6749          17      CALL    ROM_READ
                                
00076C 476C AF               4      XOR A
00076D 476D 3235F1          13      LD  (_BUF_LO),A     ;PSET
000770 4770 3242F1          13      LD  (_BUF_O),A      ;向き
                                
000773 4773 2A4EF1          16      LD  HL,(PARAM1)
       4776                     RCP_PARAM1:
000776 4776 7E               7      LD  A,(HL)
000777 4777 23               6      INC HL
000778 4778 B7               4      OR  A
000779 4779 CA034A          10      JP  Z,ROM_ORG
00077C 477C FE3A             7      CP  ':'
00077E 477E CA034A          10      JP  Z,ROM_ORG
000781 4781 FE2C             7      CP  ','
000783 4783 2012            12      JR  NZ,RCP_PARAM1_
                                
000785 4785 DD212F54        14      LD  IX,FRMQNT
000789 4789 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
00078D 478D CD1C00          17      CALL    _CALSLT
000790 4790 7B               4      LD  A,E
000791 4791 87               4      ADD A,A
000792 4792 87               4      ADD A,A
000793 4793 3242F1          13      LD  (_BUF_O),A
000796 4796 7E               7      LD  A,(HL)
       4797                     RCP_PARAM1_:
000797 4797 FE28             7      CP  '('
000799 4799 20DB            12      JR  NZ,RCP_PARAM1
                                
00079B 479B DD212F54        14      LD  IX,FRMQNT
00079F 479F FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007A3 47A3 CD1C00          17      CALL    _CALSLT
                                
0007A6 47A6 ED533EF1        20      LD  (_BUF_X),DE
                                
       47AA                     RCP_PARAM2:
0007AA 47AA 23               6      INC HL
0007AB 47AB 7E               7      LD  A,(HL)
0007AC 47AC FE20             7      CP  020H
0007AE 47AE 28FA            12      JR  Z,RCP_PARAM2
0007B0 47B0 FE2C             7      CP  ','
0007B2 47B2 28F6            12      JR  Z,RCP_PARAM2
                                
0007B4 47B4 DD212F54        14      LD  IX,FRMQNT
0007B8 47B8 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007BC 47BC CD1C00          17      CALL    _CALSLT
                                
0007BF 47BF ED5340F1        20      LD  (_BUF_Y),DE
       47C3                     RCP_PARAM3:
0007C3 47C3 23               6      INC HL
0007C4 47C4 7E               7      LD  A,(HL)
0007C5 47C5 FE20             7      CP  020H
0007C7 47C7 28FA            12      JR  Z,RCP_PARAM3
0007C9 47C9 FE29             7      CP  ')'
0007CB 47CB 28F6            12      JR  Z,RCP_PARAM3
0007CD 47CD FE2C             7      CP  ','
0007CF 47CF 2033            12      JR  NZ,RCP_ST
                                
0007D1 47D1 23               6      INC HL
0007D2 47D2 DD212F54        14      LD  IX,FRMQNT
0007D6 47D6 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007DA 47DA CD1C00          17      CALL    _CALSLT
                                
0007DD 47DD 7B               4      LD  A,E
0007DE 47DE 3241F1          13      LD  (_BUF_P),A
                                
       47E1                     RCP_PARAM4:
0007E1 47E1 7E               7      LD  A,(HL)
0007E2 47E2 23               6      INC HL
0007E3 47E3 FE20             7      CP  020H
0007E5 47E5 28FA            12      JR  Z,RCP_PARAM4
                                
0007E7 47E7 FE2C             7      CP  ','
0007E9 47E9 2019            12      JR  NZ,RCP_ST
                                
0007EB 47EB 7E               7      LD  A,(HL)
0007EC 47EC 0604             7      LD  B,4
0007EE 47EE FEC3             7      CP  0C3H        ;PRESET
0007F0 47F0 280E            12      JR  Z,RCP_LO
0007F2 47F2 05               4      DEC B       ;3
0007F3 47F3 D6F8             7      SUB 0F8H        ;XOR
0007F5 47F5 2809            12      JR  Z,RCP_LO
0007F7 47F7 05               4      DEC B       ;2
0007F8 47F8 3C               4      INC A       ;OR
0007F9 47F9 2805            12      JR  Z,RCP_LO
0007FB 47FB 05               4      DEC B       ;1
0007FC 47FC 3C               4      INC A       ;AND
0007FD 47FD 2801            12      JR  Z,RCP_LO
0007FF 47FF 05               4      DEC B       ;0
                                                ;PSET
       4800                     RCP_LO:
000800 4800 78               4      LD  A,B
000801 4801 3235F1          13      LD  (_BUF_LO),A
       4804                     RCP_ST:
000804 4804 2AC6F6          16      LD  HL,(STREND)
000807 4807 2230F1          16      LD  (_DTA),HL
00080A 480A EB               4      EX  DE,HL
00080B 480B 2100FE          10      LD  HL,-512
00080E 480E 39              11      ADD HL,SP
00080F 480F AF               4      XOR A
000810 4810 ED52            15      SBC HL,DE
000812 4812 3008            12      JR  NC,RCP0
000814 4814 215EF5          10      LD  HL,BUF
000817 4817 2230F1          16      LD  (_DTA),HL
00081A 481A 6F               4      LD  L,A ;0
00081B 481B 67               4      LD  H,A ;0
       481C                     RCP0:
00081C 481C 24               4      INC H
00081D 481D 2238F1          16      LD  (_BUF_EN),HL
       4820                     RCP1:
000820 4820 F3               4      DI
000821 4821 CDF548          17      CALL    WAIT_VDP
                                
000824 4824 3A0700          13      LD  A,(WRVDP)
000827 4827 4F               4      LD  C,A
000828 4828 0C               4      INC C       ;C := PORT#1's address(WR)
000829 4829 3E24             7      LD  A,36
00082B 482B ED79            12      OUT (C),A
00082D 482D 3E91             7      LD  A,080H+17
00082F 482F ED79            12      OUT (C),A       ;R#17 := 36
                                
000831 4831 0C               4      INC C
000832 4832 0C               4      INC C       ;C := PORT#3's address(WR)
000833 4833 2A3EF1          16      LD  HL,(_BUF_X)
000836 4836 ED69            12      OUT (C),L       ;R#36 DX
000838 4838 ED61            12      OUT (C),H       ;R#37
00083A 483A 2A40F1          16      LD  HL,(_BUF_Y)
00083D 483D ED69            12      OUT (C),L       ;R#38 DY
00083F 483F ED61            12      OUT (C),H       ;R#39
000841 4841 2A3AF1          16      LD  HL,(_BUF_W)
000844 4844 ED69            12      OUT (C),L       ;R#40 NX
000846 4846 ED61            12      OUT (C),H       ;R#41
000848 4848 2A3CF1          16      LD  HL,(_BUF_H)
00084B 484B ED69            12      OUT (C),L       ;R#42 NY
00084D 484D ED61            12      OUT (C),H       ;R#43
                                
00084F 484F DD2AAFFC        20      LD  IX,(SCRMOD)
000853 4853 3A35F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
000856 4856 B7               4      OR  A
000857 4857 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000859 4859 DD7D             9      LD  A,IXL
00085B 485B FE08             7      CP  8
00085D 485D 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
00085F 485F FE06             7      CP  6
000861 4861 2A3EF1          16      LD  HL,(_BUF_X)
000864 4864 3A3AF1          13      LD  A,(_BUF_W)
000867 4867 2005            12      JR  NZ,SCR57
000869 4869 B5               4      OR  L       ;スクリーン6
00086A 486A E603             7      AND 3
00086C 486C 200D            12      JR  NZ,USE_LMMC
       486E                     SCR57:              ;スクリーン5,7
00086E 486E B5               4      OR  L
00086F 486F E601             7      AND 1
000871 4871 2008            12      JR  NZ,USE_LMMC
       4873                     USE_HMMC:
000873 4873 DD2E08          10      LD  IXL,8
       4876                     USE_HMMC8:
000876 4876 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
000878 4878 3235F1          13      LD  (_BUF_LO),A
       487B                     USE_LMMC:
00087B 487B 110000          10      LD  DE,0
00087E 487E 06FF             7      LD  B,-1
000880 4880 CD2049          17      CALL    GET_PIXEL
000883 4883 ED79            12      OUT (C),A       ;R#44 first DATA
000885 4885 3A42F1          13      LD  A,(_BUF_O)
000888 4888 ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
00088A 488A 3A35F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00088D 488D F6B0             7      OR  0B0H        ;R#46 LMMC command
00088F 488F ED79            12      OUT (C),A
                                
000891 4891 FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
000893 4893 0D               4      DEC C
000894 4894 0D               4      DEC C       ;C := PORT#1's address(WR)
000895 4895 3EAC             7      LD  A,080H+44
000897 4897 ED79            12      OUT (C),A
000899 4899 3E91             7      LD  A,080H+17
00089B 489B ED79            12      OUT (C),A       ;R#17 := 44
                                
00089D 489D 3A0600          13      LD  A,(RDVDP)
0008A0 48A0 3C               4      INC A
0008A1 48A1 FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
0008A3 48A3 3E02             7      LD  A,2
0008A5 48A5 ED79            12      OUT (C),A
0008A7 48A7 3E8F             7      LD  A,08FH
0008A9 48A9 ED79            12      OUT (C),A
0008AB 48AB 3A35F1          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0008AE 48AE E640             7      AND 040H
0008B0 48B0 201C            12      JR  NZ,LOOP_HMMC
       48B2                     LOOP_COPY:
0008B2 48B2 CD2049          17      CALL    GET_PIXEL
0008B5 48B5 08               4      EX  AF,AF'
0008B6 48B6 FD4C             9      LD  C,IYH
       48B8                     LOOP_COPY1:
0008B8 48B8 ED78            12      IN  A,(C)
0008BA 48BA 0F               4      RRCA            ;RRCAではサインフラグは変化しない
0008BB 48BB 300A            12      JR  NC,EXIT_COPY    ;check CE bit
0008BD 48BD F2B848          10      JP  P,LOOP_COPY1    ;check TR bit
0008C0 48C0 08               4      EX  AF,AF'
0008C1 48C1 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
0008C3 48C3 ED79            12      OUT (C),A
0008C5 48C5 18EB            12      JR  LOOP_COPY
                                
       48C7                     EXIT_COPY:
0008C7 48C7 CDFD48          17      CALL    GET_STATUS_0
0008CA 48CA FB               4      EI
0008CB 48CB C37F46          10      JP  ROM_NEXT
                                
       48CE                     LOOP_HMMC:
0008CE 48CE FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
0008D0 48D0 43               4      LD  B,E
0008D1 48D1 7B               4      LD  A,E
0008D2 48D2 B7               4      OR  A
0008D3 48D3 2802            12      JR  Z,LOOP_HMMC1
0008D5 48D5 EDB3                    OTIR
       48D7                     LOOP_HMMC1:
0008D7 48D7 14               4      INC D
       48D8                     LOOP_HMMC2:
0008D8 48D8 15               4      DEC D
0008D9 48D9 2805            12      JR  Z,LOOP_HMMC3
0008DB 48DB EDB3                    OTIR
0008DD 48DD C3D848          10      JP  LOOP_HMMC2
       48E0                     LOOP_HMMC3:
0008E0 48E0 ED78            12      IN  A,(C)
0008E2 48E2 0F               4      RRCA
0008E3 48E3 30E2            12      JR  NC,EXIT_COPY    ;check CE bit
0008E5 48E5 2A38F1          16      LD  HL,(_BUF_EN)
0008E8 48E8 CD6749          17      CALL    ROM_READ
0008EB 48EB EB               4      EX  DE,HL
0008EC 48EC 2A30F1          16      LD  HL,(_DTA)
0008EF 48EF 7A               4      LD  A,D
0008F0 48F0 B3               4      OR  E
0008F1 48F1 20DB            12      JR  NZ,LOOP_HMMC
0008F3 48F3 18C3            12      JR  LOOP_COPY1
                                    
       48F5                     WAIT_VDP:
0008F5 48F5 3E02             7      LD  A,2
0008F7 48F7 CDFE48          17      CALL    GET_STATUS
0008FA 48FA 0F               4      RRCA
0008FB 48FB 38F8            12      JR  C,WAIT_VDP
       48FD                     GET_STATUS_0:
0008FD 48FD AF               4      XOR A
       48FE                     GET_STATUS:
0008FE 48FE C5              11      PUSH    BC
0008FF 48FF ED4B0600        20      LD  BC,(RDVDP)
000903 4903 0C               4      INC C
000904 4904 ED79            12      OUT (C),A
000906 4906 3E8F             7      LD  A,08FH
000908 4908 ED79            12      OUT (C),A
00090A 490A ED78            12      IN  A,(C)
00090C 490C C1              10      POP BC
00090D 490D C9              10      RET
                                
       490E                     GET_PIXEL256:
00090E 490E 7A               4      LD  A,D
00090F 490F B3               4      OR  E
000910 4910 200A            12      JR  NZ,GET_PIXEL1
000912 4912 2A38F1          16      LD  HL,(_BUF_EN)
000915 4915 CD6749          17      CALL    ROM_READ
000918 4918 EB               4      EX  DE,HL
000919 4919 2A30F1          16      LD  HL,(_DTA)
       491C                     GET_PIXEL1:
00091C 491C 7E               7      LD  A,(HL)
00091D 491D 23               6      INC HL
00091E 491E 1B               6      DEC DE
00091F 491F C9              10      RET
                                
       4920                     GET_PIXEL:
000920 4920 04               4      INC B
000921 4921 DD7D             9      LD  A,IXL
000923 4923 FE08             7      CP  8
000925 4925 28E7            12      JR  Z,GET_PIXEL256
000927 4927 FE06             7      CP  6
000929 4929 282E            12      JR  Z,GET_PIXEL4
                                
00092B 492B CB40             8      BIT 0,B
00092D 492D 20ED            12      JR  NZ,GET_PIXEL1
                                
00092F 492F 7A               4      LD  A,D
000930 4930 B3               4      OR  E
000931 4931 200A            12      JR  NZ,GET_PIXEL2
                                
000933 4933 2A38F1          16      LD  HL,(_BUF_EN)
000936 4936 CD6749          17      CALL    ROM_READ
000939 4939 EB               4      EX  DE,HL
00093A 493A 2A30F1          16      LD  HL,(_DTA)
                                
       493D                     GET_PIXEL2:
00093D 493D 7E               7      LD  A,(HL)
00093E 493E 0F               4      RRCA
00093F 493F 0F               4      RRCA
000940 4940 0F               4      RRCA
000941 4941 0F               4      RRCA
000942 4942 C9              10      RET
                                
       4943                     GET_PIXEL3:
000943 4943 7A               4      LD  A,D
000944 4944 B3               4      OR  E
000945 4945 200A            12      JR  NZ,GET_PIXEL5
                                
000947 4947 2A38F1          16      LD  HL,(_BUF_EN)
00094A 494A CD6749          17      CALL    ROM_READ
00094D 494D EB               4      EX  DE,HL
00094E 494E 2A30F1          16      LD  HL,(_DTA)
       4951                     GET_PIXEL5:
000951 4951 7E               7      LD  A,(HL)
000952 4952 0F               4      RRCA
000953 4953 0F               4      RRCA
000954 4954 0F               4      RRCA
000955 4955 0F               4      RRCA
000956 4956 0F               4      RRCA
000957 4957 0F               4      RRCA
000958 4958 C9              10      RET
                                
       4959                     GET_PIXEL4:
000959 4959 78               4      LD  A,B
00095A 495A E603             7      AND 3   ;+0
00095C 495C 28E5            12      JR  Z,GET_PIXEL3
00095E 495E 3D               4      DEC A   ;+1
00095F 495F 28DC            12      JR  Z,GET_PIXEL2
000961 4961 3D               4      DEC A   ;+2
000962 4962 7E               7      LD  A,(HL)
000963 4963 C0              11      RET NZ
000964 4964 0F               4      RRCA        ;+3
000965 4965 0F               4      RRCA
000966 4966 C9              10      RET
                                
       4967                     ROM_READ:
000967 4967 E5              11      PUSH    HL
000968 4968 D5              11      PUSH    DE
000969 4969 C5              11      PUSH    BC
00096A 496A FDE5            15      PUSH    IY
00096C 496C 224AF1          16      LD  (LEFTX),HL
00096F 496F 2A30F1          16      LD  HL,(_DTA)
000972 4972 2243F1          16      LD  (DTAX),HL
000975 4975 2A4AF1          16      LD  HL,(LEFTX)
                                
000978 4978 CD034C          17      CALL    RBX1
00097B 497B 3870            12      JR  C,RBRERR1
00097D 497D 79               4      LD  A,C
00097E 497E EB               4      EX  DE,HL
00097F 497F ED52            15      SBC HL,DE       ;CP 0HL,CDE
000981 4981 19              11      ADD HL,DE
000982 4982 DE00             7      SBC A,000H
000984 4984 3801            12      JR  C,RBR1
000986 4986 EB               4      EX  DE,HL
       4987                     RBR1:
000987 4987 9F               4      SBC A,A
000988 4988 E601             7      AND 1
00098A 498A 321FF1          13      LD  (_RESULT),A
00098D 498D 7C               4      LD  A,H
00098E 498E B5               4      OR  L
00098F 498F CAE349          10      JP  Z,RBREND0
                                
000992 4992 222CF1          16      LD  (_LEFT),HL  ;Read record byte
000995 4995 224AF1          16      LD  (LEFTX),HL
                                
000998 4998 CD2C4C          17      CALL    RBX2
00099B 499B 281A            12      JR  Z,RBRB
                                                ;先頭の端数
00099D 499D CD3F4C          17      CALL    RBXA
0009A0 49A0 DAF949          10      JP  C,RBRERR
0009A3 49A3 C5              11      PUSH    BC
0009A4 49A4 CDFE43          17      CALL    ROM_LDIR
0009A7 49A7 ED5343F1        20      LD  (DTAX),DE
0009AB 49AB 2A4AF1          16      LD  HL,(LEFTX)
0009AE 49AE D1              10      POP DE
0009AF 49AF A7               4      AND A
0009B0 49B0 ED52            15      SBC HL,DE
0009B2 49B2 224AF1          16      LD  (LEFTX),HL
0009B5 49B5 2829            12      JR  Z,RBREND
                                
       49B7                     RBRB:
0009B7 49B7 CD784C          17      CALL    RBXB
0009BA 49BA 2818            12      JR  Z,RBRC
       49BC                     RBRB1:
0009BC 49BC C5              11      PUSH    BC
0009BD 49BD D5              11      PUSH    DE
0009BE 49BE CD204D          17      CALL    CLUST
0009C1 49C1 EB               4      EX  DE,HL
0009C2 49C2 ED4B22F1        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
0009C6 49C6 CDFE43          17      CALL    ROM_LDIR
0009C9 49C9 EB               4      EX  DE,HL
0009CA 49CA D1              10      POP DE
0009CB 49CB C1              10      POP BC
0009CC 49CC CDFD4C          17      CALL    GNCL
0009CF 49CF DAF949          10      JP  C,RBRERR
0009D2 49D2 10E8            13      DJNZ    RBRB1
       49D4                     RBRC:
0009D4 49D4 CD904C          17      CALL    RBXC
0009D7 49D7 2807            12      JR  Z,RBREND
                                
0009D9 49D9 CD204D          17      CALL    CLUST
0009DC 49DC EB               4      EX  DE,HL
0009DD 49DD CDFE43          17      CALL    ROM_LDIR
       49E0                     RBREND:
0009E0 49E0 CD9C4C          17      CALL    RBXEND
       49E3                     RBREND0:
0009E3 49E3 FDE1            14      POP IY
0009E5 49E5 C1              10      POP BC
0009E6 49E6 D1              10      POP DE
0009E7 49E7 F1              10      POP AF  ;(HL)
0009E8 49E8 AF               4      XOR A
0009E9 49E9 3A1FF1          13      LD  A,(_RESULT)
0009EC 49EC C9              10      RET
                                
       49ED                     RBRERR1:
0009ED 49ED 3E01             7      LD  A,001H
       49EF                     RBRERR2:
0009EF 49EF FDE1            14      POP IY
0009F1 49F1 C1              10      POP BC
0009F2 49F2 D1              10      POP DE
0009F3 49F3 E1              10      POP HL
0009F4 49F4 37               4      SCF
0009F5 49F5 210000          10      LD  HL,0
0009F8 49F8 C9              10      RET
       49F9                     RBRERR:
0009F9 49F9 3EFF             7      LD  A,0FFH
0009FB 49FB 18F2            12      JR  RBRERR2
                                
       49FD                     FILE_DD:
0009FD 49FD E1              10      POP HL
0009FE 49FE 3E                      DB  03EH
0009FF 49FF C9              10      RET
000A00 4A00 320CF1          13      LD  (SWC_BLOAD_M),A
       4A03                     ROM_ORG:
000A03 4A03 2A4CF1          16      LD  HL,(PARAM0)
000A06 4A06 7E               7      LD  A,(HL)
000A07 4A07 C9              10      RET
       4A08                     FILE_B:
000A08 4A08 AF               4      XOR A
000A09 4A09 3250F1          13      LD  (FDRV),A
000A0C 4A0C 1E00             7      LD  E,0
000A0E 4A0E 3A63F6          13      LD  A,(VALTYP)
000A11 4A11 FE03             7      CP  3       ;string
000A13 4A13 C2984A          10      JP  NZ,FILED
                                
000A16 4A16 DD21D067        14      LD  IX,FRESTR
000A1A 4A1A FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000A1E 4A1E CD1C00          17      CALL    _CALSLT
000A21 4A21 E5              11      PUSH    HL
000A22 4A22 DDE1            14      POP IX
                                
000A24 4A24 DD5E00          19      LD  E,(IX+0)
000A27 4A27 DD7E01          19      LD  A,(IX+1)
000A2A 4A2A DD5602          19      LD  D,(IX+2)
000A2D 4A2D DD62             9      LD  IXH,D
000A2F 4A2F DD6F             9      LD  IXL,A
000A31 4A31 7B               4      LD  A,E
       4A32                     FILE_BDOS:
000A32 4A32 FE04             7      CP  4
000A34 4A34 3808            12      JR  C,FILEB1
000A36 4A36 DD7E03          19      LD  A,(IX+3)
000A39 4A39 FE3A             7      CP  ':'
000A3B 4A3B 28C0            12      JR  Z,FILE_DD
000A3D 4A3D 7B               4      LD  A,E
       4A3E                     FILEB1:
000A3E 4A3E FE02             7      CP  2
000A40 4A40 3818            12      JR  C,DEVI1
000A42 4A42 DD7E01          19      LD  A,(IX+1)
000A45 4A45 FE3A             7      CP  ':'
000A47 4A47 2011            12      JR  NZ,DEVI1
000A49 4A49 DD7E00          19      LD  A,(IX+0)        ;DRIVE
000A4C 4A4C CD714B          17      CALL    CAP
000A4F 4A4F D640             7      SUB '@'
000A51 4A51 DD23            10      INC IX
000A53 4A53 DD23            10      INC IX
000A55 4A55 1D               4      DEC E
000A56 4A56 1D               4      DEC E
000A57 4A57 3250F1          13      LD  (FDRV),A
       4A5A                     DEVI1:
000A5A 4A5A DD7E00          19      LD  A,(IX+0)
000A5D 4A5D D65C             7      SUB 05CH        ;\
000A5F 4A5F 2008            12      JR  NZ,NOROOT
000A61 4A61 6F               4      LD  L,A
000A62 4A62 67               4      LD  H,A
000A63 4A63 225EF1          16      LD  (_CDX),HL
000A66 4A66 DD23            10      INC IX
000A68 4A68 1D               4      DEC E
       4A69                     NOROOT:
                                
       4A69                     SETDIR:
000A69 4A69 CD984A          17      CALL    FILED
000A6C 4A6C DD7E00          19      LD  A,(IX+0)
000A6F 4A6F FE5C             7      CP  05CH        ;\
000A71 4A71 C0              11      RET NZ
000A72 4A72 DD23            10      INC IX
000A74 4A74 1D               4      DEC E
000A75 4A75 3A51F1          13      LD  A,(FNAME)
000A78 4A78 FE20             7      CP  020H        ;. の処理
000A7A 4A7A 28ED            12      JR  Z,SETDIR
                                
000A7C 4A7C CD874B          17      CALL    ROM_OPEN
000A7F 4A7F B7               4      OR  A
000A80 4A80 C0              11      RET NZ
                                
000A81 4A81 FD2A47F1        20      LD  IY,(DIRENT1)
000A85 4A85 FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
000A89 4A89 C8              11      RET Z
000A8A 4A8A CDDF4A          17      CALL    FILEI
000A8D 4A8D FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000A90 4A90 FD661B          19      LD  H,(IY+01BH)
000A93 4A93 225EF1          16      LD  (_CDX),HL
000A96 4A96 18D1            12      JR  SETDIR
                                
       4A98                     FILED:
000A98 4A98 CDDF4A          17      CALL    FILEI
000A9B 4A9B 2151F1          10      LD  HL,FNAME
                                
000A9E 4A9E 0608             7      LD  B,8
       4AA0                     FILE2:
000AA0 4AA0 CDEC4A          17      CALL    CCHKF
000AA3 4AA3 C8              11      RET Z
000AA4 4AA4 FE2A             7      CP  '*'
000AA6 4AA6 282E            12      JR  Z,FILE9
000AA8 4AA8 FE2E             7      CP  '.'
000AAA 4AAA 280C            12      JR  Z,FILE4
000AAC 4AAC 77               7      LD  (HL),A
000AAD 4AAD 23               6      INC HL
000AAE 4AAE 10F0            13      DJNZ    FILE2
                                
       4AB0                     FILE3:
000AB0 4AB0 CDEC4A          17      CALL    CCHKF
000AB3 4AB3 C8              11      RET Z
000AB4 4AB4 FE2E             7      CP  '.'
000AB6 4AB6 20F8            12      JR  NZ,FILE3
                                
       4AB8                     FILE4:
000AB8 4AB8 2159F1          10      LD  HL,FNAME+8
000ABB 4ABB 0603             7      LD  B,3
                                
       4ABD                     FILE4L:
000ABD 4ABD CDEC4A          17      CALL    CCHKF
000AC0 4AC0 C8              11      RET Z
000AC1 4AC1 FE2E             7      CP  '.'
000AC3 4AC3 2008            12      JR  NZ,FILE12
000AC5 4AC5 3251F1          13      LD  (FNAME),A   ;Parent directory(..)
000AC8 4AC8 3252F1          13      LD  (FNAME+1),A
000ACB 4ACB 3E20             7      LD  A,020H
       4ACD                     FILE12:
000ACD 4ACD FE2A             7      CP  '*'
000ACF 4ACF 280A            12      JR  Z,FILE10
000AD1 4AD1 77               7      LD  (HL),A
000AD2 4AD2 23               6      INC HL
000AD3 4AD3 10E8            13      DJNZ    FILE4L
000AD5 4AD5 C9              10      RET
                                
       4AD6                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000AD6 4AD6 CDDB4A          17      CALL    FILE10
000AD9 4AD9 18D5            12      JR  FILE3
                                
       4ADB                     FILE10:
000ADB 4ADB 3E3F             7      LD  A,'?'
000ADD 4ADD 1808            12      JR  FILL_MEMORY
       4ADF                     FILEI:              ;名前＋拡張子をスペースで初期化
000ADF 4ADF 3E20             7      LD  A,020H
000AE1 4AE1 01000B          10      LD  BC,11*256   ;C=0にしておく
000AE4 4AE4 2151F1          10      LD  HL,FNAME
       4AE7                     FILL_MEMORY:            ;HLからBバイトAで埋める
000AE7 4AE7 77               7      LD  (HL),A
000AE8 4AE8 23               6      INC HL
000AE9 4AE9 10FC            13      DJNZ    FILL_MEMORY
000AEB 4AEB C9              10      RET
                                
       4AEC                     CCHKF:
000AEC 4AEC 7B               4      LD  A,E
000AED 4AED B7               4      OR  A
000AEE 4AEE C8              11      RET Z
000AEF 4AEF DD7E00          19      LD  A,(IX+0)
000AF2 4AF2 CDF94A          17      CALL    CCHK2
000AF5 4AF5 C8              11      RET Z
000AF6 4AF6 C35C4B          10      JP  FKAN
                                
       4AF9                     CCHK2:
000AF9 4AF9 0C               4      INC C
000AFA 4AFA 0D               4      DEC C
000AFB 4AFB C0              11      RET NZ
       4AFC                     CCHK3:              ;ZF=1 で使えない文字
000AFC 4AFC FE2B             7      CP  '+'
000AFE 4AFE C8              11      RET Z
000AFF 4AFF FE2C             7      CP  ','
000B01 4B01 C8              11      RET Z
000B02 4B02 FE2F             7      CP  '/'
000B04 4B04 C8              11      RET Z
000B05 4B05 FE3A             7      CP  ':'
000B07 4B07 C8              11      RET Z
000B08 4B08 FE3B             7      CP  ';'
000B0A 4B0A C8              11      RET Z
000B0B 4B0B FE3D             7      CP  '='
000B0D 4B0D C8              11      RET Z
000B0E 4B0E FE5C             7      CP  05CH    ;\
000B10 4B10 C8              11      RET Z
000B11 4B11 FE1F             7      CP  01FH
000B13 4B13 D0              11      RET NC
000B14 4B14 BF               4      CP  A       ;Z=1
000B15 4B15 C9              10      RET
                                
       4B16                     SS1:
000B16 4B16 13               6      INC DE
       4B17                     SPCUT:              ;スペースをカット
000B17 4B17 1A               7      LD  A,(DE)
000B18 4B18 FE20             7      CP  020H
000B1A 4B1A 28FA            12      JR  Z,SS1
000B1C 4B1C C9              10      RET
                                
       4B1D                     SCREOF1:
000B1D 4B1D 13               6      INC DE
       4B1E                     SPCUTEX:            ;スペース改行などをカット
000B1E 4B1E 1A               7      LD  A,(DE)
000B1F 4B1F FE20             7      CP  020H
000B21 4B21 28FA            12      JR  Z,SCREOF1
000B23 4B23 FE0D             7      CP  00DH
000B25 4B25 28F6            12      JR  Z,SCREOF1
000B27 4B27 FE0A             7      CP  00AH
000B29 4B29 28F2            12      JR  Z,SCREOF1
000B2B 4B2B FE1A             7      CP  01AH
000B2D 4B2D 28EE            12      JR  Z,SCREOF1
000B2F 4B2F C9              10      RET
                                
       4B30                     GETNUM:
000B30 4B30 210000          10      LD  HL,0
       4B33                     GETNUM1:
000B33 4B33 1A               7      LD  A,(DE)
000B34 4B34 13               6      INC DE
000B35 4B35 D630             7      SUB '0'
000B37 4B37 D8              11      RET C
000B38 4B38 FE0A             7      CP  10
000B3A 4B3A D0              11      RET NC
000B3B 4B3B 4D               4      LD  C,L
000B3C 4B3C 44               4      LD  B,H
000B3D 4B3D 29              11      ADD HL,HL   ;*2
000B3E 4B3E 29              11      ADD HL,HL   ;*4
000B3F 4B3F 09              11      ADD HL,BC   ;*5
000B40 4B40 29              11      ADD HL,HL   ;*10
000B41 4B41 4F               4      LD  C,A
000B42 4B42 0600             7      LD  B,0
000B44 4B44 09              11      ADD HL,BC
000B45 4B45 18EC            12      JR  GETNUM1
                                
       4B47                     SEARCH_END:
000B47 4B47 7E               7      LD  A,(HL)
       4B48                     SEARCH_END1:
000B48 4B48 23               6      INC HL
000B49 4B49 B7               4      OR  A
000B4A 4B4A C8              11      RET Z
000B4B 4B4B FE3A             7      CP  ':'
000B4D 4B4D 20F8            12      JR  NZ,SEARCH_END
000B4F 4B4F 7E               7      LD  A,(HL)
000B50 4B50 FE3A             7      CP  ':'
000B52 4B52 28F4            12      JR  Z,SEARCH_END1
000B54 4B54 C9              10      RET
                                
       4B55                     FKANC:
000B55 4B55 CB41             8      BIT 0,C
000B57 4B57 CC7A4B          17      CALL    Z,CAP2
000B5A 4B5A 1803            12      JR  FKANX
       4B5C                     FKAN:           ;漢字チェック
000B5C 4B5C DD23            10      INC IX
000B5E 4B5E 1D               4      DEC E
       4B5F                     FKANX:
000B5F 4B5F CB41             8      BIT 0,C
000B61 4B61 CB81             8      RES 0,C
000B63 4B63 C0              11      RET NZ
000B64 4B64 FE80             7      CP  080H
000B66 4B66 D8              11      RET C
000B67 4B67 FEA0             7      CP  0A0H
000B69 4B69 3803            12      JR  C,FKAN1
000B6B 4B6B FEE0             7      CP  0E0H
000B6D 4B6D D8              11      RET C
       4B6E                     FKAN1:
000B6E 4B6E 0C               4      INC C
000B6F 4B6F A7               4      AND A
000B70 4B70 C9              10      RET
                                
       4B71                     CAP:
000B71 4B71 FE61             7      CP  'a'
000B73 4B73 D8              11      RET C
000B74 4B74 FE7B             7      CP  'z'+1
000B76 4B76 D0              11      RET NC
000B77 4B77 D620             7      SUB 020H
000B79 4B79 C9              10      RET
       4B7A                     CAP2:
000B7A 4B7A CD714B          17      CALL    CAP
       4B7D                     CAP3:               ;
000B7D 4B7D FE05             7      CP  5
000B7F 4B7F 2803            12      JR  Z,CAP4
000B81 4B81 FE21             7      CP  021H
000B83 4B83 C9              10      RET
       4B84                     CAP4:
000B84 4B84 3EE5             7      LD  A,0E5H
000B86 4B86 C9              10      RET
                                
       4B87                     ROM_OPEN:
000B87 4B87 CD9A50          17      CALL    GET_DISK_BANK_FDRV
                                
000B8A 4B8A CDD94D          17      CALL    GET_DIR_DAT
000B8D 4B8D D5              11      PUSH    DE
000B8E 4B8E CDA34B          17      CALL    FILESE
000B91 4B91 D1              10      POP DE
000B92 4B92 3F               4      CCF
000B93 4B93 D8              11      RET C
000B94 4B94 2247F1          16      LD  (DIRENT1),HL
000B97 4B97 E5              11      PUSH    HL
000B98 4B98 210000          10      LD  HL,0
000B9B 4B9B 2226F1          16      LD  (RR_LOW),HL
000B9E 4B9E 2228F1          16      LD  (RR_HIGH),HL
000BA1 4BA1 E1              10      POP HL
000BA2 4BA2 C9              10      RET
                                
       4BA3                     FILESE:
000BA3 4BA3 7E               7      LD  A,(HL)
000BA4 4BA4 B7               4      OR  A
000BA5 4BA5 C8              11      RET Z       ;END:ZF=1 CF=0
000BA6 4BA6 FEE5             7      CP  0E5H
000BA8 4BA8 280D            12      JR  Z,FILESE1
000BAA 4BAA 1151F1          10      LD  DE,FNAME
000BAD 4BAD E5              11      PUSH    HL
000BAE 4BAE CDDD4B          17      CALL    CPFILE
000BB1 4BB1 CCFE4B          17      CALL    Z,CPFILE2
000BB4 4BB4 E1              10      POP HL
000BB5 4BB5 37               4      SCF
000BB6 4BB6 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4BB7                     FILESE1:
000BB7 4BB7 CDBF4B          17      CALL    FNEXT
000BBA 4BBA 20E7            12      JR  NZ,FILESE
000BBC 4BBC F6FF             7      OR  0FFH        ;ZF=0 CF=0
000BBE 4BBE C9              10      RET
                                
       4BBF                     FNEXT:
000BBF 4BBF 112000          10      LD  DE,020H
000BC2 4BC2 19              11      ADD HL,DE
000BC3 4BC3 ED5B5EF1        20      LD  DE,(_CDX)
000BC7 4BC7 7A               4      LD  A,D
000BC8 4BC8 B3               4      OR  E
000BC9 4BC9 2002            12      JR  NZ,FNEXT_SUBDIR
000BCB 4BCB 0D               4      DEC C
                                #if exists USE_NORMAL_32K_ROM
                                #else
                                CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
                                    PUSH    AF      ;※フラグを保存する必要あり
                                    BIT 7,H
                                    JR  Z,CHECK_DIR_PAGE1
                                    LD  A,H
                                    SUB 020H
                                    LD  H,A
                                    LD  A,(_DIR_BANK)
                                    INC A
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_DIR_BANK),A
                                CHECK_DIR_PAGE1:
                                    POP AF
                                #endif
000BCC 4BCC C9              10      RET
                                
       4BCD                     FNEXT_SUBDIR:           ;サブディレクトリ
000BCD 4BCD 0D               4      DEC C
000BCE 4BCE C0              11      RET NZ
                                
000BCF 4BCF ED5B5EF1        20      LD  DE,(_CDX)
000BD3 4BD3 CDFD4C          17      CALL    GNCL
000BD6 4BD6 EB               4      EX  DE,HL
000BD7 4BD7 225EF1          16      LD  (_CDX),HL
000BDA 4BDA C3114E          10      JP  GET_SUBDIR
                                
       4BDD                     CPFILE:
000BDD 4BDD C5              11      PUSH    BC
000BDE 4BDE 01000B          10      LD  BC,00B00H
       4BE1                     CPSTR1:
000BE1 4BE1 1A               7      LD  A,(DE)
000BE2 4BE2 FE3F             7      CP  '?'     ;Wild card
000BE4 4BE4 2812            12      JR  Z,CPSTR2
000BE6 4BE6 7E               7      LD  A,(HL)
000BE7 4BE7 CD554B          17      CALL    FKANC
000BEA 4BEA E5              11      PUSH    HL
000BEB 4BEB 67               4      LD  H,A
000BEC 4BEC 1A               7      LD  A,(DE)
000BED 4BED CB01             4      RLC C
000BEF 4BEF CD554B          17      CALL    FKANC
000BF2 4BF2 CB09             4      RRC C
000BF4 4BF4 BC               4      CP  H       ;CP (HL),(DE)
000BF5 4BF5 E1              10      POP HL
000BF6 4BF6 2004            12      JR  NZ,CPSTR3
       4BF8                     CPSTR2:
000BF8 4BF8 13               6      INC DE
000BF9 4BF9 23               6      INC HL
000BFA 4BFA 10E5            13      DJNZ    CPSTR1
       4BFC                     CPSTR3:
000BFC 4BFC C1              10      POP BC
000BFD 4BFD C9              10      RET
                                
       4BFE                     CPFILE2:
                                ;   LD  A,0E1H
000BFE 4BFE 3EF1             7      LD  A,0F1H
000C00 4C00 2F               4      CPL
000C01 4C01 A6               7      AND (HL)
000C02 4C02 C9              10      RET
                                
       4C03                     RBX1:
000C03 4C03 E5              11      PUSH    HL      ;Record byte
                                
000C04 4C04 ED5B26F1        20      LD  DE,(RR_LOW) ;CDE=Random record
000C08 4C08 3A29F1          13      LD  A,(RR_HIGH+1)
000C0B 4C0B 4F               4      LD  C,A
                                
000C0C 4C0C 3A49F1          13      LD  A,(_DIR_BANK)
                                #if exists USE_NORMAL_32K_ROM
000C0F 4C0F 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000C12 4C12 FD2A47F1        20      LD  IY,(DIRENT1)
000C16 4C16 FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000C19 4C19 FD661D          19      LD  H,(IY+01DH)
000C1C 4C1C FD7E1E          19      LD  A,(IY+01EH)
                                
000C1F 4C1F A7               4      AND A
000C20 4C20 ED52            15      SBC HL,DE
000C22 4C22 99               4      SBC A,C
000C23 4C23 D1              10      POP DE
                                
000C24 4C24 D8              11      RET C
000C25 4C25 4F               4      LD  C,A
000C26 4C26 EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000C27 4C27 B2               4      OR  D
000C28 4C28 B3               4      OR  E
000C29 4C29 C0              11      RET NZ
000C2A 4C2A 37               4      SCF
000C2B 4C2B C9              10      RET
                                
       4C2C                     RBX2:
000C2C 4C2C ED4B27F1        20      LD  BC,(RR_LOW+1)
000C30 4C30 CDB14C          17      CALL    RWXR
000C33 4C33 3A23F1          13      LD  A,(CLSZ_H)
000C36 4C36 3D               4      DEC A
000C37 4C37 E5              11      PUSH    HL
000C38 4C38 2A26F1          16      LD  HL,(RR_LOW)
000C3B 4C3B A4               4      AND H
000C3C 4C3C B5               4      OR  L
000C3D 4C3D E1              10      POP HL
000C3E 4C3E C9              10      RET
                                
       4C3F                     RBXA:
000C3F 4C3F D5              11      PUSH    DE
000C40 4C40 CD204D          17      CALL    CLUST
000C43 4C43 ED532EF1        20      LD  (_DTPS),DE
000C47 4C47 D1              10      POP DE
000C48 4C48 CDFD4C          17      CALL    GNCL
000C4B 4C4B D8              11      RET C
000C4C 4C4C ED532AF1        20      LD  (_CLPS),DE
                                
000C50 4C50 ED4B26F1        20      LD  BC,(RR_LOW)
000C54 4C54 2A22F1          16      LD  HL,(CLSZ)
000C57 4C57 7C               4      LD  A,H
000C58 4C58 3D               4      DEC A
000C59 4C59 A0               4      AND B
000C5A 4C5A 47               4      LD  B,A
000C5B 4C5B ED42            15      SBC HL,BC       ;remaining cluster
                                
000C5D 4C5D ED5B4AF1        20      LD  DE,(LEFTX)
000C61 4C61 ED52            15      SBC HL,DE       ;CP HL,DE
000C63 4C63 19              11      ADD HL,DE
000C64 4C64 3801            12      JR  C,RBXA1
000C66 4C66 EB               4      EX  DE,HL
       4C67                     RBXA1:
000C67 4C67 3A20F1          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_NORMAL_32K_ROM
000C6A 4C6A 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000C6D 4C6D E5              11      PUSH    HL
000C6E 4C6E 2A2EF1          16      LD  HL,(_DTPS)
000C71 4C71 09              11      ADD HL,BC
000C72 4C72 ED5B43F1        20      LD  DE,(DTAX)
000C76 4C76 C1              10      POP BC
000C77 4C77 C9              10      RET
                                
       4C78                     RBXB:
000C78 4C78 2A43F1          16      LD  HL,(DTAX)
000C7B 4C7B ED5B2AF1        20      LD  DE,(_CLPS)
000C7F 4C7F 3A4BF1          13      LD  A,(LEFTX+1)
000C82 4C82 47               4      LD  B,A
000C83 4C83 3A23F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4C86                     RBXB1:
000C86 4C86 1F               4      RRA     ;->CF
000C87 4C87 3804            12      JR  C,RBXB2
000C89 4C89 CB38             8      SRL B   ;B=B/2
000C8B 4C8B 18F9            12      JR  RBXB1
       4C8D                     RBXB2:
000C8D 4C8D 78               4      LD  A,B
000C8E 4C8E B7               4      OR  A
000C8F 4C8F C9              10      RET
                                
       4C90                     RBXC:
000C90 4C90 ED4B4AF1        20      LD  BC,(LEFTX)
000C94 4C94 3A23F1          13      LD  A,(CLSZ_H)
000C97 4C97 3D               4      DEC A
000C98 4C98 A0               4      AND B
000C99 4C99 47               4      LD  B,A
000C9A 4C9A B1               4      OR  C
000C9B 4C9B C9              10      RET
                                
       4C9C                     RBXEND:
000C9C 4C9C ED5B2CF1        20      LD  DE,(_LEFT)
000CA0 4CA0 2A26F1          16      LD  HL,(RR_LOW)
000CA3 4CA3 3A29F1          13      LD  A,(RR_HIGH+1)
000CA6 4CA6 19              11      ADD HL,DE
000CA7 4CA7 CE00             7      ADC A,0
000CA9 4CA9 2226F1          16      LD  (RR_LOW),HL
000CAC 4CAC 3229F1          13      LD  (RR_HIGH+1),A
000CAF 4CAF EB               4      EX  DE,HL       ;HL=Read byte
000CB0 4CB0 C9              10      RET 
                                
       4CB1                     RWXR:
000CB1 4CB1 3A23F1          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4CB4                     L_RWX:
000CB4 4CB4 1F               4      RRA     ;->CF
000CB5 4CB5 3806            12      JR  C,E_RWX
000CB7 4CB7 CB38             8      SRL B   ;BC=BC/2
000CB9 4CB9 CB19             8      RR  C   ;
000CBB 4CBB 18F7            12      JR  L_RWX
       4CBD                     E_RWX:
000CBD 4CBD 3A49F1          13      LD  A,(_DIR_BANK)
                                #if exists USE_NORMAL_32K_ROM
000CC0 4CC0 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000CC3 4CC3 FD2A47F1        20      LD  IY,(DIRENT1)
000CC7 4CC7 FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000CCA 4CCA FD561B          19      LD  D,(IY+01BH)
000CCD 4CCD CD9A50          17      CALL    GET_DISK_BANK_FDRV
       4CD0                     RWX1:
000CD0 4CD0 ED532AF1        20      LD  (_CLPS),DE
000CD4 4CD4 7A               4      LD  A,D
000CD5 4CD5 B3               4      OR  E
000CD6 4CD6 37               4      SCF
000CD7 4CD7 C8              11      RET Z
                                
000CD8 4CD8 78               4      LD  A,B
000CD9 4CD9 B1               4      OR  C
000CDA 4CDA C8              11      RET Z
                                
000CDB 4CDB CDFD4C          17      CALL    GNCL
000CDE 4CDE D8              11      RET C
000CDF 4CDF 0B               6      DEC BC
000CE0 4CE0 CD724D          17      CALL    ENDCL
000CE3 4CE3 38EB            12      JR  C,RWX1
000CE5 4CE5 37               4      SCF
000CE6 4CE6 C9              10      RET
                                
       4CE7                     NCL3:
000CE7 4CE7 CD9A50          17      CALL    GET_DISK_BANK_FDRV
000CEA 4CEA 6B               4      LD  L,E
000CEB 4CEB 62               4      LD  H,D
000CEC 4CEC CB3C             8      SRL H
000CEE 4CEE CB1D             8      RR  L
000CF0 4CF0 1F               4      RRA
000CF1 4CF1 19              11      ADD HL,DE
000CF2 4CF2 010060          10      LD  BC,BANK1_ADR
000CF5 4CF5 09              11      ADD HL,BC
000CF6 4CF6 ED4B24F1        20      LD  BC,(SECSZ)
000CFA 4CFA 09              11      ADD HL,BC
000CFB 4CFB 17               4      RLA
000CFC 4CFC C9              10      RET
                                
       4CFD                     GNCL:
000CFD 4CFD 7A               4      LD  A,D
000CFE 4CFE B3               4      OR  E
000CFF 4CFF 37               4      SCF
000D00 4D00 C8              11      RET Z
000D01 4D01 C5              11      PUSH    BC
000D02 4D02 E5              11      PUSH    HL
000D03 4D03 CDE74C          17      CALL    NCL3
000D06 4D06 3809            12      JR  C,GNC1
000D08 4D08 5E               7      LD  E,(HL)
000D09 4D09 23               6      INC HL
000D0A 4D0A 7E               7      LD  A,(HL)
000D0B 4D0B E60F             7      AND 00FH
000D0D 4D0D 57               4      LD  D,A
000D0E 4D0E E1              10      POP HL
000D0F 4D0F C1              10      POP BC
000D10 4D10 C9              10      RET
       4D11                     GNC1:
000D11 4D11 7E               7      LD  A,(HL)
000D12 4D12 23               6      INC HL
000D13 4D13 56               7      LD  D,(HL)
000D14 4D14 0604             7      LD  B,4
       4D16                     GNC1L:
000D16 4D16 CB3A             8      SRL D
000D18 4D18 1F               4      RRA
000D19 4D19 10FB            13      DJNZ    GNC1L
                                
000D1B 4D1B 5F               4      LD  E,A
000D1C 4D1C E1              10      POP HL
000D1D 4D1D C1              10      POP BC
000D1E 4D1E A7               4      AND A
000D1F 4D1F C9              10      RET
                                
       4D20                     CLUST:
000D20 4D20 EB               4      EX  DE,HL
       4D21                     CLUST_HL:
000D21 4D21 C5              11      PUSH    BC
000D22 4D22 3A23F1          13      LD  A,(CLSZ_H)
000D25 4D25 CDC350          17      CALL    MUL_AHL
                                
000D28 4D28 CDF34D          17      CALL    GET_DIR_POS
000D2B 4D2B 4F               4      LD  C,A
000D2C 4D2C 0600             7      LD  B,0
000D2E 4D2E 09              11      ADD HL,BC
                                
000D2F 4D2F 3A1260          13      LD  A,(BANK1_ADR+17+1)  ;BPB_RootEntCnt High
000D32 4D32 1F               4      RRA
000D33 4D33 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000D36 4D36 1F               4      RRA
000D37 4D37 0F               4      RRCA
000D38 4D38 0F               4      RRCA
000D39 4D39 0F               4      RRCA
000D3A 4D3A 4F               4      LD  C,A
                                
000D3B 4D3B 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000D3E 4D3E FE02             7      CP  2
000D40 4D40 280C            12      JR  Z,CLUST1
000D42 4D42 CB01             4      RLC C
000D44 4D44 0D               4      DEC C
000D45 4D45 3A0C60          13      LD  A,(BANK1_ADR+11+1)  ;BPB_BytsPerSec High    
000D48 4D48 FE02             7      CP  2
000D4A 4D4A 2002            12      JR  NZ,CLUST1
000D4C 4D4C 0D               4      DEC C
000D4D 4D4D 0D               4      DEC C
       4D4E                     CLUST1:
000D4E 4D4E 0D               4      DEC C
000D4F 4D4F 09              11      ADD HL,BC
                                
                                #if exists USE_NORMAL_32K_ROM
000D50 4D50 7D               4      LD  A,L
000D51 4D51 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
000D54 4D54 09              11      ADD HL,BC
000D55 4D55 3013            12      JR  NC,CLUST2
000D57 4D57 4D               4      LD  C,L     ;C=読み出し元
000D58 4D58 29              11      ADD HL,HL   ;64KB→32KB
000D59 4D59 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
000D5A 4D5A CD9A50          17      CALL    GET_DISK_BANK_FDRV
000D5D 4D5D 84               4      ADD A,H
000D5E 4D5E 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
000D61 4D61 3220F1          13      LD  (_BANK),A
000D64 4D64 69               4      LD  L,C     ;C=読み出し元
000D65 4D65 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
000D67 4D67 A5               4      AND L
000D68 4D68 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB
                                    ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
                                    AND L
                                #endif
       4D6A                     CLUST2:
000D6A 4D6A C660             7      ADD A,high BANK1_ADR
000D6C 4D6C 67               4      LD  H,A
000D6D 4D6D 2E00             7      LD  L,0
000D6F 4D6F EB               4      EX  DE,HL
000D70 4D70 C1              10      POP BC
000D71 4D71 C9              10      RET
                                
       4D72                     ENDCL:
000D72 4D72 7A               4      LD  A,D ;END CLUSTER
000D73 4D73 FE0F             7      CP  00FH    ;FAT12の最大値
000D75 4D75 C0              11      RET NZ
000D76 4D76 7B               4      LD  A,E
000D77 4D77 FEF7             7      CP  0F7H
000D79 4D79 C9              10      RET
                                
       4D7A                     RB_READ:
000D7A 4D7A AF               4      XOR A   ;HLA = HL*128
000D7B 4D7B CB3C             8      SRL H
000D7D 4D7D CB1D             8      RR  L
000D7F 4D7F 1F               4      RRA
000D80 4D80 3226F1          13      LD  (RR_LOW),A
000D83 4D83 2227F1          16      LD  (RR_MID),HL
000D86 4D86 218000          10      LD  HL,128
                                
000D89 4D89 CD6749          17      CALL    ROM_READ
000D8C 4D8C C9              10      RET
                                
       4D8D                     GETSEQ:
000D8D 4D8D FD6E20          19      LD  L,(IY+32)
000D90 4D90 FD660C          19      LD  H,(IY+12)
                                
000D93 4D93 CB25             8      SLA L
                                
000D95 4D95 CB3C             8      SRL H
000D97 4D97 CB1D             8      RR  L
000D99 4D99 C9              10      RET
                                
       4D9A                     SETSEQ:
000D9A 4D9A F5              11      PUSH    AF
000D9B 4D9B 3A26F1          13      LD  A,(RR_LOW)
000D9E 4D9E 2A27F1          16      LD  HL,(RR_MID)
                                
000DA1 4DA1 CDB84D          17      CALL    SSQ1
                                
000DA4 4DA4 29              11      ADD HL,HL
000DA5 4DA5 CB3D             8      SRL L
000DA7 4DA7 FD7520          19      LD  (IY+32),L
000DAA 4DAA FD740C          19      LD  (IY+12),H
000DAD 4DAD F1              10      POP AF
000DAE 4DAE C9              10      RET
                                
       4DAF                     GETSIZE:
000DAF 4DAF FD7E10          19      LD  A,(IY+16)
000DB2 4DB2 FD6E11          19      LD  L,(IY+17)
000DB5 4DB5 FD6612          19      LD  H,(IY+18)
       4DB8                     SSQ1:
000DB8 4DB8 87               4      ADD A,A
000DB9 4DB9 ED6A            15      ADC HL,HL
000DBB 4DBB B7               4      OR  A
000DBC 4DBC C8              11      RET Z
000DBD 4DBD 23               6      INC HL
000DBE 4DBE C9              10      RET
                                
       4DBF                     SET_FCB:
000DBF 4DBF D5              11      PUSH    DE
000DC0 4DC0 FDE1            14      POP IY
000DC2 4DC2 FD7E1C          19      LD  A,(IY+28)
000DC5 4DC5 FEFF             7      CP  0FFH
000DC7 4DC7 200C            12      JR  NZ,POPAF_SCF_FF_RET
000DC9 4DC9 E5              11      PUSH    HL
000DCA 4DCA FD6E1A          19      LD  L,(IY+26)
000DCD 4DCD FD661B          19      LD  H,(IY+27)
000DD0 4DD0 222AF1          16      LD  (_CLPS),HL
000DD3 4DD3 E1              10      POP HL
000DD4 4DD4 C9              10      RET
                                
       4DD5                     POPAF_SCF_FF_RET:
000DD5 4DD5 F1              10      POP AF
000DD6 4DD6 37               4      SCF
000DD7 4DD7 9F               4      SBC A,A
000DD8 4DD8 C9              10      RET
                                
       4DD9                     GET_DIR_DAT:
000DD9 4DD9 2A5EF1          16      LD  HL,(_CDX)
000DDC 4DDC 7C               4      LD  A,H
000DDD 4DDD B5               4      OR  L
000DDE 4DDE 2031            12      JR  NZ,GET_SUBDIR
000DE0 4DE0 CDF34D          17      CALL    GET_DIR_POS
000DE3 4DE3 C660             7      ADD A,high BANK1_ADR
000DE5 4DE5 2E00             7      LD  L,0
000DE7 4DE7 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_NORMAL_32K_ROM
                                #else
                                    CALL    CHECK_DIR_PAGE
                                #endif
000DE8 4DE8 3A21F1          13      LD  A,(_BANK1)
000DEB 4DEB 3249F1          13      LD  (_DIR_BANK),A
                                
000DEE 4DEE 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000DF1 4DF1 4F               4      LD  C,A
000DF2 4DF2 C9              10      RET
                                
       4DF3                     GET_DIR_POS:                ;ルートディレクトリ
000DF3 4DF3 CD9A50          17      CALL    GET_DISK_BANK_FDRV
000DF6 4DF6 3221F1          13      LD  (_BANK1),A
000DF9 4DF9 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000DFC 4DFC 47               4      LD  B,A
000DFD 4DFD 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000E00 4E00 4F               4      LD  C,A
000E01 4E01 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4E04                     GET_DIR_POS1:
000E04 4E04 81               4      ADD A,C
000E05 4E05 10FD            13      DJNZ    GET_DIR_POS1
                                
000E07 4E07 ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec 
       4E0B                     L_MDP:
000E0B 4E0B CB18             8      RR  B   ;->CF
000E0D 4E0D D8              11      RET C
000E0E 4E0E 87               4      ADD A,A
000E0F 4E0F 18FA            12      JR  L_MDP
                                
       4E11                     GET_SUBDIR:             ;サブディレクトリ
000E11 4E11 CD214D          17      CALL    CLUST_HL
000E14 4E14 EB               4      EX  DE,HL
000E15 4E15 3A20F1          13      LD  A,(_BANK)
000E18 4E18 3249F1          13      LD  (_DIR_BANK),A
000E1B 4E1B 3A23F1          13      LD  A,(CLSZ_H)
000E1E 4E1E 87               4      ADD A,A     ;*2
000E1F 4E1F 87               4      ADD A,A     ;*4
000E20 4E20 87               4      ADD A,A     ;*8
000E21 4E21 4F               4      LD  C,A
000E22 4E22 C9              10      RET
                                
       4E23                     STATEMENT:
000E23 4E23 11B14E          10      LD  DE,STR_CHDIR
000E26 4E26 CD974E          17      CALL    CPPROCNM
000E29 4E29 280A            12      JR  Z,_CHDIR
000E2B 4E2B 11B74E          10      LD  DE,STR_RAMDISK
000E2E 4E2E CD974E          17      CALL    CPPROCNM
000E31 4E31 2814            12      JR  Z,_RAMDISK
000E33 4E33 37               4      SCF
000E34 4E34 C9              10      RET
       4E35                     _CHDIR:
000E35 4E35 7E               7      LD  A,(HL)
000E36 4E36 FE28             7      CP  '('
000E38 4E38 37               4      SCF
000E39 4E39 C0              11      RET NZ
000E3A 4E3A CD1647          17      CALL    INIT_PARAM
000E3D 4E3D CD084A          17      CALL    FILE_B
000E40 4E40 CD5F4E          17      CALL    ROM_CD
000E43 4E43 DAE245          10      JP  C,ERROR_FILE_NOT_FOUND
000E46 4E46 C9              10      RET
                                
       4E47                     _RAMDISK:
000E47 4E47 7E               7      LD  A,(HL)
000E48 4E48 FE28             7      CP  '('
000E4A 4E4A 37               4      SCF
000E4B 4E4B C0              11      RET NZ
000E4C 4E4C 23               6      INC HL
000E4D 4E4D DD212F54        14      LD  IX,FRMQNT
000E51 4E51 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000E55 4E55 CD1C00          17      CALL    _CALSLT
                                ;   LD  A,(HOKVLD)  ;bit0: 拡張 BIOSの存在
                                ;   CPL
                                ;   AND 1
000E58 4E58 7A               4      LD  A,D
000E59 4E59 B3               4      OR  E
000E5A 4E5A C2DC45          10      JP  NZ,ERROR_INTERNAL_ERROR
                                ;   PUSH    HL      ;EXTBIOもDISK BIOSで初期化してそう
                                ;   LD  A,0     ;すでにA=0になっている
                                ;   LD  DE,0401H    ;D=マッパサポートルチン(4) E=機能番号(1)
                                ;   CALL    EXTBIO
                                ;   POP HL
                                ;   OR  A
                                ;   JP  Z,ERROR_INTERNAL_ERROR
000E5D 4E5D 23               6      INC HL
000E5E 4E5E C9              10      RET
                                
       4E5F                     ROM_CD:
000E5F 4E5F 3A51F1          13      LD  A,(FNAME)
000E62 4E62 FE20             7      CP  020H
000E64 4E64 2822            12      JR  Z,CD1
000E66 4E66 CD874B          17      CALL    ROM_OPEN
000E69 4E69 D8              11      RET C
000E6A 4E6A FD2A47F1        20      LD  IY,(DIRENT1)
000E6E 4E6E FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
000E72 4E72 CAE245          10      JP  Z,ERROR_FILE_NOT_FOUND
000E75 4E75 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000E78 4E78 FD661B          19      LD  H,(IY+01BH)
       4E7B                     CD2:
000E7B 4E7B 225CF1          16      LD  (_CD),HL
000E7E 4E7E 2A4EF1          16      LD  HL,(PARAM1)
       4E81                     CD_SKIP:
000E81 4E81 7E               7      LD  A,(HL)
000E82 4E82 23               6      INC HL
000E83 4E83 FE21             7      CP  021H
000E85 4E85 38FA            12      JR  C,CD_SKIP
000E87 4E87 C9              10      RET
       4E88                     CD1:
000E88 4E88 2A5EF1          16      LD  HL,(_CDX)
000E8B 4E8B 18EE            12      JR  CD2
                                
       4E8D                     DEVICE1:
000E8D 4E8D 11BF4E          10      LD  DE,STR_A
000E90 4E90 CD974E          17      CALL    CPPROCNM
000E93 4E93 37               4      SCF
000E94 4E94 C0              11      RET NZ
000E95 4E95 AF               4      XOR A
000E96 4E96 C9              10      RET
                                
       4E97                     CPPROCNM:
000E97 4E97 E5              11      PUSH    HL
000E98 4E98 2189FD          10      LD  HL,PROCNM
       4E9B                     CPPROCNM1:
000E9B 4E9B 1A               7      LD  A,(DE)
000E9C 4E9C 13               6      INC DE
000E9D 4E9D BE               7      CP  (HL)
000E9E 4E9E 23               6      INC HL
000E9F 4E9F 2003            12      JR  NZ,CPPROCNM2
000EA1 4EA1 B7               4      OR  A
000EA2 4EA2 20F7            12      JR  NZ,CPPROCNM1
       4EA4                     CPPROCNM2:
000EA4 4EA4 E1              10      POP HL
000EA5 4EA5 C9              10      RET
                                
       4EA6                     WILDCARD:
000EA6 4EA6 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       4EB1                     STR_CHDIR:
000EB1 4EB1 434844495200            DB  "CHDIR",0
       4EB7                     STR_RAMDISK:
000EB7 4EB7 52414D4449534B00        DB  "RAMDISK",0
       4EBF                     STR_A:
000EBF 4EBF 4100                    DB  "A",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4EC1                     ERROR_WRITE_PROTECTED:
000EC1 4EC1 3E00             7      LD  A,0     ;Write protected
000EC3 4EC3 C9              10      RET
       4EC4                     DISKIO:
000EC4 4EC4 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000EC6 4EC6 48               4      LD  C,B
000EC7 4EC7 CDA450          17      CALL    GET_DISK_BANK
       4ECA                     SETMAP1:        
000ECA 4ECA E5              11      PUSH    HL
       4ECB                     DISKIO1:
000ECB 4ECB C5              11      PUSH    BC      ;B=残りのセクタ数
000ECC 4ECC D5              11      PUSH    DE      ;DE=セクタ番号
000ECD 4ECD F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
000ECE 4ECE EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
000ECF 4ECF F5              11      PUSH    AF
000ED0 4ED0 3A25F1          13      LD  A,(SECSZ_H)
000ED3 4ED3 CDC350          17      CALL    MUL_AHL
000ED6 4ED6 F1              10      POP AF
                                #if exists USE_NORMAL_32K_ROM
000ED7 4ED7 7D               4      LD  A,L
000ED8 4ED8 C5              11      PUSH    BC
000ED9 4ED9 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
000EDC 4EDC 09              11      ADD HL,BC
000EDD 4EDD C1              10      POP BC
000EDE 4EDE 3013            12      JR  NC,DISKIO2
000EE0 4EE0 4D               4      LD  C,L     ;C=読み出し元
000EE1 4EE1 29              11      ADD HL,HL   ;64KB→32KB
000EE2 4EE2 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
000EE3 4EE3 CD9A50          17      CALL    GET_DISK_BANK_FDRV
000EE6 4EE6 84               4      ADD A,H
000EE7 4EE7 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
000EEA 4EEA 3220F1          13      LD  (_BANK),A
000EED 4EED 69               4      LD  L,C     ;C=読み出し元
000EEE 4EEE 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
000EF0 4EF0 A5               4      AND L
000EF1 4EF1 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL       ;64KB→32KB
                                    ADD HL,HL       ;32KB→16KB
                                    ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  A,C     ;C=読み出し元
                                    AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       4EF3                     DISKIO2:
000EF3 4EF3 C660             7      ADD A,high BANK1_ADR
000EF5 4EF5 67               4      LD  H,A
000EF6 4EF6 ED4B24F1        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
000EFA 4EFA 69               4      LD  L,C     ;C=0
000EFB 4EFB CDFE43          17      CALL    ROM_LDIR
000EFE 4EFE EB               4      EX  DE,HL
000EFF 4EFF F1              10      POP AF
000F00 4F00 D1              10      POP DE
000F01 4F01 13               6      INC DE
000F02 4F02 C1              10      POP BC
000F03 4F03 10C6            13      DJNZ    DISKIO1
000F05 4F05 41               4      LD  B,C
                                
000F06 4F06 E1              10      POP HL
000F07 4F07 AF               4      XOR A
                                
000F08 4F08 FB               4      EI
000F09 4F09 C9              10      RET
                                
       4F0A                     DSKCHG:
000F0A 4F0A CD434F          17      CALL    IS_BPB
000F0D 4F0D 3824            12      JR  C,NOTREADY
000F0F 4F0F 3A23FB          13      LD  A,(DRVTBL+2)
000F12 4F12 B7               4      OR  A
000F13 4F13 201A            12      JR  NZ,DSKCHG1
000F15 4F15 3A21FB          13      LD  A,(DRVTBL)
000F18 4F18 FE02             7      CP  2
000F1A 4F1A 2013            12      JR  NZ,DSKCHG1
000F1C 4F1C CD434F          17      CALL    IS_BPB
000F1F 4F1F 300E            12      JR  NC,DSKCHG1
000F21 4F21 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000F23 4F23 3221FB          13      LD  (DRVTBL),A
000F26 4F26 3223FB          13      LD  (DRVTBL+2),A
000F29 4F29 3A48F3          13      LD  A,(MASTERS)
000F2C 4F2C 3224FB          13      LD  (DRVTBL+3),A
       4F2F                     DSKCHG1:
000F2F 4F2F AF               4      XOR A
000F30 4F30 0601             7      LD  B,1
000F32 4F32 C9              10      RET
       4F33                     NOTREADY:
000F33 4F33 3E02             7      LD  A,2
000F35 4F35 37               4      SCF
000F36 4F36 C9              10      RET
                                
       4F37                     NO_BPB:
000F37 4F37 E1              10      POP HL
000F38 4F38 23               6      INC HL
000F39 4F39 11C950          10      LD  DE,DPB2DD
000F3C 4F3C 011200          10      LD  BC,DPB2DD_E-DPB2DD
000F3F 4F3F EDB0                    LDIR
000F41 4F41 AF               4      XOR A
000F42 4F42 C9              10      RET
                                
       4F43                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000F43 4F43 CDA450          17      CALL    GET_DISK_BANK
                                
000F46 4F46 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000F49 4F49 FE01             7      CP  1
000F4B 4F4B D8              11      RET C
                                
000F4C 4F4C 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000F4F 4F4F C6FF             7      ADD A,0FFH
000F51 4F51 D8              11      RET C
                                
000F52 4F52 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
000F55 4F55 FE01             7      CP  1
000F57 4F57 C8              11      RET Z
000F58 4F58 FE02             7      CP  2
000F5A 4F5A C8              11      RET Z
000F5B 4F5B FE04             7      CP  4
000F5D 4F5D C8              11      RET Z
000F5E 4F5E 37               4      SCF
000F5F 4F5F C9              10      RET
                                
       4F60                     GETDPB:
000F60 4F60 E5              11      PUSH    HL
000F61 4F61 CDA450          17      CALL    GET_DISK_BANK
                                
000F64 4F64 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000F67 4F67 B7               4      OR  A
000F68 4F68 28CD            12      JR  Z,NO_BPB
000F6A 4F6A DDE1            14      POP IX
000F6C 4F6C DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000F6F 4F6F 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000F72 4F72 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000F75 4F75 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000F78 4F78 DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000F7B 4F7B 87               4      ADD A,A
000F7C 4F7C 87               4      ADD A,A
000F7D 4F7D 87               4      ADD A,A
000F7E 4F7E 3D               4      DEC A
000F7F 4F7F DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000F82 4F82 06FF             7      LD  B,-1
000F84 4F84 A7               4      AND A           ;無限ループ阻止
       4F85                     GETDPB1:
000F85 4F85 04               4      INC B
000F86 4F86 1F               4      RRA
000F87 4F87 38FC            12      JR  C,GETDPB1
000F89 4F89 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000F8C 4F8C 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000F8F 4F8F 3D               4      DEC A
000F90 4F90 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000F93 4F93 A7               4      AND A           ;無限ループ阻止
000F94 4F94 06FF             7      LD  B,-1
       4F96                     GETDPB2:
000F96 4F96 04               4      INC B
000F97 4F97 1F               4      RRA
000F98 4F98 38FC            12      JR  C,GETDPB2
000F9A 4F9A 04               4      INC B
000F9B 4F9B DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000F9E 4F9E 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
000FA1 4FA1 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
000FA4 4FA4 DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
000FA7 4FA7 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
000FAA 4FAA DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000FAD 4FAD 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
000FB0 4FB0 DD770B          19      LD  (IX+11),A       ;MAXENT
                                
000FB3 4FB3 ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
000FB7 4FB7 DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
000FBA 4FBA DD460A          19      LD  B,(IX+10)       ;FATCNT
000FBD 4FBD 210000          10      LD  HL,0
       4FC0                     GETDPB3:
000FC0 4FC0 19              11      ADD HL,DE
000FC1 4FC1 10FD            13      DJNZ    GETDPB3
       4FC3                     GETDPB4:
000FC3 4FC3 DD5E08          19      LD  E,(IX+8)        ;FIRFAT
000FC6 4FC6 DD5609          19      LD  D,(IX+9)        ;FIRFAT
000FC9 4FC9 19              11      ADD HL,DE
000FCA 4FCA DD7511          19      LD  (IX+17),L       ;FIRDIR
000FCD 4FCD DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000FD0 4FD0 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000FD3 4FD3 87               4      ADD A,A
000FD4 4FD4 87               4      ADD A,A
000FD5 4FD5 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4FD8                     GETDPB5:
000FD8 4FD8 CB3B             8      SRL E
000FDA 4FDA 1F               4      RRA
000FDB 4FDB 30FB            12      JR  NC,GETDPB5
000FDD 4FDD 1600             7      LD  D,0
000FDF 4FDF 19              11      ADD HL,DE
000FE0 4FE0 DD750C          19      LD  (IX+12),L       ;FIRREC
000FE3 4FE3 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000FE6 4FE6 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
000FE9 4FE9 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
000FEC 4FEC DD560D          19      LD  D,(IX+13)       ;FIRREC
000FEF 4FEF A7               4      AND A
000FF0 4FF0 ED52            15      SBC HL,DE
                                
000FF2 4FF2 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
000FF5 4FF5 3C               4      INC A
000FF6 4FF6 37               4      SCF             ;無限ループ阻止
       4FF7                     GETDPB6:
000FF7 4FF7 1F               4      RRA
000FF8 4FF8 3806            12      JR  C,GETDPB7
000FFA 4FFA CB3C             8      SRL H
000FFC 4FFC CB1D             8      RR  L
000FFE 4FFE 18F7            12      JR  GETDPB6
       5000                     GETDPB7:
001000 5000 23               6      INC HL
001001 5001 DD750E          19      LD  (IX+14),L       ;MAXCLUS
001004 5004 DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       5007                     GETDPBD1:
001007 5007 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
00100A 500A E6FC             7      AND 0FCH
00100C 500C C8              11      RET Z
                                
00100D 500D DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
001011 5011 37               4      SCF
001012 5012 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
001016 5016 DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
001019 5019 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
00101D 501D DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
001021 5021 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
001025 5025 DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
001029 5029 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
00102D 502D DDCB1126        23      SLA (IX+17)         ;FIRDIR
001031 5031 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
001035 5035 DD6E11          19      LD  L,(IX+17)       ;FIRDIR
001038 5038 DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
00103B 503B DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
00103E 503E 87               4      ADD A,A
00103F 503F 87               4      ADD A,A
001040 5040 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       5043                     GETDPBD5:
001043 5043 CB3B             8      SRL E
001045 5045 1F               4      RRA
001046 5046 30FB            12      JR  NC,GETDPBD5
001048 5048 1600             7      LD  D,0
00104A 504A 19              11      ADD HL,DE
00104B 504B DD750C          19      LD  (IX+12),L       ;FIRREC
00104E 504E DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001051 5051 18B4            12      JR  GETDPBD1
                                
       5053                     CHOICE:
001053 5053 210000          10      LD  HL,0
001056 5056 C9              10      RET
                                
       5057                     DSKFMT:
001057 5057 AF               4      XOR A
001058 5058 37               4      SCF
       5059                     DSKSTP:
001059 5059 C9              10      RET
                                
       505A                     BASENT:
00105A 505A 3A40F3          13      LD  A,(REBOOT)
00105D 505D B7               4      OR  A
00105E 505E 202B            12      JR  NZ,REBOOT1
001060 5060 21DB50          10      LD  HL,AUTOEXEC
001063 5063 1150F1          10      LD  DE,FDRV
001066 5066 010C00          10      LD  BC,1+8+3
001069 5069 EDB0                    LDIR
00106B 506B CD874B          17      CALL    ROM_OPEN
00106E 506E 381B            12      JR  C,REBOOT1
001070 5070 CD9A45          17      CALL    ROM_LOAD1
001073 5073 21E750          10      LD  HL,CMD_RUN
001076 5076 111FF4          10      LD  DE,KBUF
001079 5079 D5              11      PUSH    DE
00107A 507A 010300          10      LD  BC,3
00107D 507D EDB0                    LDIR
00107F 507F E1              10      POP HL
001080 5080 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
001084 5084 DD210146        14      LD  IX,NEWSTT
001088 5088 CD1C00          17      CALL    _CALSLT
       508B                     REBOOT1:
00108B 508B FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00108F 508F DD219B40        14      LD  IX,READYR
001093 5093 C31C00          10      JP  _CALSLT
                                
       5096                     GETSLT:
001096 5096 3A22FB          13      LD  A,(DRVTBL+1)
001099 5099 C9              10      RET
                                
       509A                     GET_DISK_BANK_FDRV:
00109A 509A 3A50F1          13      LD  A,(FDRV)
00109D 509D D601             7      SUB 1
00109F 509F 3003            12      JR  NC,GET_DISK_BANK
0010A1 50A1 3A46F1          13      LD  A,(_DVSW)
       50A4                     GET_DISK_BANK:
0010A4 50A4 B7               4      OR  A       ;A=DRIVE
0010A5 50A5 3E01             7      LD  A,DISK_BANK
0010A7 50A7 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
0010A9 50A9 3A45F1          13      LD  A,(B_DRIVE)
                                #endif
       50AC                     SET_DISK_BANK:
                                #if exists USE_NORMAL_32K_ROM
0010AC 50AC 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0010AF 50AF F5              11      PUSH    AF
0010B0 50B0 E5              11      PUSH    HL
0010B1 50B1 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
0010B4 50B4 2224F1          16      LD  (SECSZ),HL
0010B7 50B7 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0010BA 50BA CDC350          17      CALL    MUL_AHL
0010BD 50BD 2222F1          16      LD  (CLSZ),HL
0010C0 50C0 E1              10      POP HL
0010C1 50C1 F1              10      POP AF
0010C2 50C2 C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       50C3                     MUL_AHL:
0010C3 50C3 37               4      SCF     ;無限ループ回避
       50C4                     MUL_AHL1:
0010C4 50C4 1F               4      RRA     ;->CF
0010C5 50C5 D8              11      RET C
0010C6 50C6 29              11      ADD HL,HL
0010C7 50C7 18FB            12      JR  MUL_AHL1
                                
       50C9                     DPB2DD:
0010C9 50C9 F9                      DB  0F9H    ;MEDIA
0010CA 50CA 0002                    DW  00200H  ;SECSIZ
0010CC 50CC 0F                      DB  00FH    ;DIRMSK
0010CD 50CD 04                      DB  004H    ;DIRSHFT
0010CE 50CE 01                      DB  001H    ;CLUSMSK
0010CF 50CF 02                      DB  002H    ;CLUSSHFT
0010D0 50D0 0100                    DW  00001H  ;FIRFAT
0010D2 50D2 02                      DB  002H    ;FATCNT
0010D3 50D3 70                      DB  070H    ;MAXENT
0010D4 50D4 0E00                    DW  0000EH  ;FIRREC
0010D6 50D6 CA02                    DW  002CAH  ;MAXCLUS
0010D8 50D8 03                      DB  003H    ;FATSIZ
0010D9 50D9 0700                    DW  0007H   ;FIRDIR
       50DB                     DPB2DD_E:
                                
       50DB                     AUTOEXEC:
0010DB 50DB 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       50E7                     CMD_RUN:
0010E7 50E7 3A8A00                  DB  03AH,08AH,0
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       50EA                     POP_HL_ERROR:
0010EA 50EA E1              10      POP     HL
       50EB                     _ERROR:
0010EB 50EB 0600             7      LD  B,0
0010ED 50ED A7               4      AND A
0010EE 50EE C9              10      RET
                                
       50EF                     ROM_BDOS:
0010EF 50EF E5              11      PUSH    HL
0010F0 50F0 79               4      LD  A,C
0010F1 50F1 87               4      ADD A,A
0010F2 50F2 38F7            12      JR  C,_ERROR
0010F4 50F4 6F               4      LD  L,A
0010F5 50F5 265F             7      LD  H,high STABLE
0010F7 50F7 7E               7      LD  A,(HL)
0010F8 50F8 2C               4      INC L
0010F9 50F9 66               7      LD  H,(HL)
0010FA 50FA 6F               4      LD  L,A
0010FB 50FB E3              19      EX  (SP),HL
0010FC 50FC 79               4      LD  A,C
0010FD 50FD C9              10      RET
                                
       50FE                     _PRINT:
       50FE                     PRINT:
0010FE 50FE 7B               4      LD  A,E
0010FF 50FF 1803            12      JR  MSG_A
                                
       5101                     _SYS01:     ;(BDOS)コンソール入力
001101 5101 CD7851          17      CALL    _SYS07
       5104                     MSG_A:
001104 5104 FE03             7      CP  3
001106 5106 2814            12      JR  Z,MSG_BR
       5108                     MSGA1:
001108 5108 F5              11      PUSH    AF
001109 5109 C5              11      PUSH    BC
00110A 510A D5              11      PUSH    DE
00110B 510B E5              11      PUSH    HL
00110C 510C DDE5            15      PUSH    IX
00110E 510E DD21A200        14      LD  IX,CHPUT
001112 5112 CDFA42          17      CALL    CALSLT_R
001115 5115 DDE1            14      POP IX
001117 5117 E1              10      POP HL
001118 5118 D1              10      POP DE
001119 5119 C1              10      POP BC
       511A                     MSGA2:
00111A 511A F1              10      POP AF
00111B 511B C9              10      RET
       511C                     MSG_BR:
00111C 511C F5              11      PUSH    AF
00111D 511D 3ADDF3          13      LD  A,(CSRX)
001120 5120 FE02             7      CP  2
001122 5122 38F6            12      JR  C,MSGA2
001124 5124 F1              10      POP AF
       5125                     MSG_CR:
001125 5125 F5              11      PUSH    AF
001126 5126 3E0D             7      LD  A,00DH
001128 5128 CD0851          17      CALL    MSGA1
00112B 512B 3E0A             7      LD  A,00AH
00112D 512D CD0851          17      CALL    MSGA1
001130 5130 F1              10      POP AF
001131 5131 C9              10      RET
                                
       5132                     _SYS02:     ;(BDOS)コンソール出力
001132 5132 CD4D51          17      CALL    BREAK
001135 5135 1805            12      JR  PRINTX
                                
       5137                     _SYS06:     ;(BDOS)コンソール直接入出力
001137 5137 7B               4      LD  A,E
001138 5138 3C               4      INC A
001139 5139 CA8C51          10      JP  Z,_INKEY
       513C                     PRINTX:
00113C 513C C3FE50          10      JP  _PRINT
                                
       513F                     _SYS08:     ;(BDOS)エコーなしコンソール入力
00113F 513F CD7851          17      CALL    _SYS07
001142 5142 FE03             7      CP  3
001144 5144 CC4D51          17      CALL    Z,_BREAK
001147 5147 FE13             7      CP  013H        ;CTRL+S
001149 5149 C0              11      RET NZ
       514A                     PAUSE:
00114A 514A CD6451          17      CALL    KEYBC
                                
       514D                     _BREAK:
       514D                     BREAK:
00114D 514D F5              11      PUSH    AF
00114E 514E C5              11      PUSH    BC
00114F 514F D5              11      PUSH    DE
001150 5150 E5              11      PUSH    HL
001151 5151 DDE5            15      PUSH    IX
001153 5153 DD21B700        14      LD  IX,BREAKX
001157 5157 CDFA42          17      CALL    CALSLT_R
00115A 515A DDE1            14      POP IX
00115C 515C E1              10      POP HL
00115D 515D D1              10      POP DE
00115E 515E C1              10      POP BC
00115F 515F DC4D51          17      CALL    C,_BREAK
001162 5162 F1              10      POP AF
001163 5163 C9              10      RET
       5164                     KEYBC:
001164 5164 F5              11      PUSH    AF
001165 5165 C5              11      PUSH    BC
001166 5166 D5              11      PUSH    DE
001167 5167 E5              11      PUSH    HL
001168 5168 DDE5            15      PUSH    IX
00116A 516A DD215601        14      LD  IX,KILBUF
00116E 516E CDFA42          17      CALL    CALSLT_R
001171 5171 DDE1            14      POP IX
001173 5173 E1              10      POP HL
001174 5174 D1              10      POP DE
001175 5175 C1              10      POP BC
001176 5176 F1              10      POP AF
001177 5177 C9              10      RET
                                
       5178                     _SYS07:
       5178                     FLGET:
001178 5178 C5              11      PUSH    BC
001179 5179 D5              11      PUSH    DE
00117A 517A E5              11      PUSH    HL
00117B 517B DDE5            15      PUSH    IX
00117D 517D DD219F00        14      LD  IX,CHGET
001181 5181 CDFA42          17      CALL    CALSLT_R
001184 5184 DDE1            14      POP IX
001186 5186 E1              10      POP HL
001187 5187 D1              10      POP DE
001188 5188 C1              10      POP BC
001189 5189 FE03             7      CP  3
00118B 518B C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       518C                     _INKEY:
       518C                     INKEY:
00118C 518C CD2652          17      CALL    CPM_CONST
00118F 518F C8              11      RET Z
001190 5190 18E6            12      JR  FLGET
                                
       5192                     _SYS0A:     ;(BDOS)文字列入力
001192 5192 C5              11      PUSH    BC
001193 5193 E5              11      PUSH    HL
001194 5194 D5              11      PUSH    DE
001195 5195 CDBE51          17      CALL    GETL
001198 5198 111FF4          10      LD  DE,KBUF
00119B 519B E1              10      POP HL
00119C 519C E5              11      PUSH    HL
00119D 519D 0E00             7      LD  C,0
00119F 519F 3004            12      JR  NC,SAX0
0011A1 51A1 23               6      INC HL
0011A2 51A2 23               6      INC HL
0011A3 51A3 1808            12      JR  SAX4
       51A5                     SAX0:
0011A5 51A5 46               7      LD  B,(HL)
0011A6 51A6 23               6      INC HL
       51A7                     SAX1:
0011A7 51A7 23               6      INC HL
0011A8 51A8 1A               7      LD  A,(DE)
0011A9 51A9 13               6      INC DE
0011AA 51AA B7               4      OR  A
0011AB 51AB 2004            12      JR  NZ,SAX2
       51AD                     SAX4:
0011AD 51AD 360D            10      LD  (HL),00DH
0011AF 51AF 1804            12      JR  SAX3
       51B1                     SAX2:
0011B1 51B1 77               7      LD  (HL),A
0011B2 51B2 0C               4      INC C
0011B3 51B3 10F2            13      DJNZ    SAX1
       51B5                     SAX3:
0011B5 51B5 D1              10      POP DE
0011B6 51B6 79               4      LD  A,C
0011B7 51B7 13               6      INC DE
0011B8 51B8 12               7      LD  (DE),A
0011B9 51B9 1B               6      DEC DE
0011BA 51BA E1              10      POP HL
0011BB 51BB C1              10      POP BC
0011BC 51BC A7               4      AND A
0011BD 51BD C9              10      RET
       51BE                     GETL:
0011BE 51BE DDE5            15      PUSH    IX
0011C0 51C0 FDE5            15      PUSH    IY
                                
0011C2 51C2 2ADCF3          16      LD  HL,(CSRY)
0011C5 51C5 22CAFB          16      LD  (FSTPOS),HL
       51C8                     GETL1:
0011C8 51C8 CD3F51          17      CALL    _SYS08
0011CB 51CB FE09             7      CP  9
0011CD 51CD 2008            12      JR  NZ,GETL1V
0011CF 51CF 211FF4          10      LD  HL,KBUF
0011D2 51D2 CD8443          17      CALL    MSX
0011D5 51D5 18F1            12      JR  GETL1
       51D7                     GETL1V:
0011D7 51D7 5F               4      LD  E,A
0011D8 51D8 FE08             7      CP  8
0011DA 51DA CC7452          17      CALL    Z,CTRL02
0011DD 51DD FE20             7      CP  020H
0011DF 51DF D4A052          17      CALL    NC,INSERT
0011E2 51E2 CD0851          17      CALL    MSGA1
                                
0011E5 51E5 7B               4      LD  A,E
0011E6 51E6 FE0D             7      CP  00DH
0011E8 51E8 20DE            12      JR  NZ,GETL1
                                
0011EA 51EA 111FF4          10      LD  DE,KBUF
0011ED 51ED 3AB0F3          13      LD  A,(LINLEN)
0011F0 51F0 47               4      LD  B,A
0011F1 51F1 CD7E54          17      CALL    ZERO_MEMORY_DE
                                
0011F4 51F4 2ACAFB          16      LD  HL,(FSTPOS)
0011F7 51F7 3ADCF3          13      LD  A,(CSRY)
0011FA 51FA 6F               4      LD  L,A
0011FB 51FB E5              11      PUSH    HL
0011FC 51FC CDD152          17      CALL    LOC0
0011FF 51FF 4D               4      LD  C,L
001200 5200 44               4      LD  B,H
001201 5201 E1              10      POP HL
001202 5202 3AB0F3          13      LD  A,(LINLEN)
001205 5205 94               4      SUB H
001206 5206 3D               4      DEC A
001207 5207 5F               4      LD  E,A
001208 5208 211FF4          10      LD  HL,KBUF
       520B                     GETL2:
00120B 520B CD6452          17      CALL    _SCRN
00120E 520E 03               6      INC BC
00120F 520F 77               7      LD  (HL),A
001210 5210 23               6      INC HL
001211 5211 1D               4      DEC E
001212 5212 20F7            12      JR  NZ,GETL2
001214 5214 CD2551          17      CALL    MSG_CR
                                
001217 5217 FDE1            14      POP IY
001219 5219 DDE1            14      POP IX
       521B                     GETL3:
00121B 521B 2B               6      DEC HL
00121C 521C 7E               7      LD  A,(HL)
00121D 521D FE21             7      CP  021H
00121F 521F D0              11      RET NC
001220 5220 3600            10      LD  (HL),0
001222 5222 15               4      DEC D
001223 5223 20F6            12      JR  NZ,GETL3
001225 5225 C9              10      RET
                                
       5226                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       5226                     CONSTX:
       5226                     CPM_CONST:
001226 5226 C5              11      PUSH    BC
001227 5227 D5              11      PUSH    DE
001228 5228 E5              11      PUSH    HL
001229 5229 DDE5            15      PUSH    IX
00122B 522B DD219C00        14      LD  IX,CHSNS
00122F 522F CDFA42          17      CALL    CALSLT_R
001232 5232 DDE1            14      POP IX
001234 5234 E1              10      POP HL
001235 5235 D1              10      POP DE
001236 5236 C1              10      POP BC
001237 5237 C9              10      RET
                                
       5238                     _SYS2A:     ;(BDOS)日付の獲得
001238 5238 AF               4      XOR A
001239 5239 57               4      LD  D,A
00123A 523A 5F               4      LD  E,A
00123B 523B 67               4      LD  H,A
00123C 523C 6F               4      LD  L,A
00123D 523D C9              10      RET
                                
       523E                     _SYS2C:     ;(BDOS)時刻の獲得
00123E 523E AF               4      XOR A
00123F 523F 57               4      LD  D,A
001240 5240 5F               4      LD  E,A
001241 5241 67               4      LD  H,A
001242 5242 6F               4      LD  L,A
001243 5243 C9              10      RET
                                
       5244                     POS:
001244 5244 F5              11      PUSH    AF
001245 5245 2ADCF3          16      LD  HL,(CSRY)
001248 5248 7D               4      LD  A,L
001249 5249 6C               4      LD  L,H
00124A 524A 67               4      LD  H,A
00124B 524B 2C               4      INC L
00124C 524C 24               4      INC H
00124D 524D F1              10      POP AF
00124E 524E C9              10      RET
                                
       524F                     LOC:
00124F 524F F5              11      PUSH    AF
001250 5250 E5              11      PUSH    HL
001251 5251 7D               4      LD  A,L
001252 5252 6C               4      LD  L,H
001253 5253 67               4      LD  H,A
001254 5254 2D               4      DEC L
001255 5255 25               4      DEC H
001256 5256 DDE5            15      PUSH    IX
001258 5258 DD21C600        14      LD  IX,POSIT
00125C 525C CDFA42          17      CALL    CALSLT_R
00125F 525F DDE1            14      POP IX
001261 5261 E1              10      POP HL
001262 5262 F1              10      POP AF
001263 5263 C9              10      RET
                                
       5264                     _SCRN:
       5264                     SCRN:
001264 5264 E5              11      PUSH    HL
001265 5265 DDE5            15      PUSH    IX
                                
001267 5267 69               4      LD  L,C
001268 5268 60               4      LD  H,B
001269 5269 DD214A00        14      LD  IX,RDVRM
00126D 526D CDFA42          17      CALL    CALSLT_R
                                
001270 5270 DDE1            14      POP IX
001272 5272 E1              10      POP HL
001273 5273 C9              10      RET
                                
       5274                     CTRL02:
001274 5274 F5              11      PUSH    AF
001275 5275 D5              11      PUSH    DE
001276 5276 2ADCF3          16      LD  HL,(CSRY)
001279 5279 3AB0F3          13      LD  A,(LINLEN)
00127C 527C 4F               4      LD  C,A
00127D 527D 94               4      SUB H   ;CSRX
00127E 527E C602             7      ADD A,2
001280 5280 47               4      LD  B,A ;カーソルより右の文字数
001281 5281 61               4      LD  H,C ;LINLEN
001282 5282 C5              11      PUSH    BC
001283 5283 CDD152          17      CALL    LOC0
001286 5286 C1              10      POP BC
                                
001287 5287 1620             7      LD  D,020H
       5289                     C8X1:
001289 5289 DD214A00        14      LD  IX,RDVRM
00128D 528D CDFA42          17      CALL    CALSLT_R
001290 5290 4F               4      LD  C,A
001291 5291 7A               4      LD  A,D
001292 5292 DD214D00        14      LD  IX,WRTVRM
001296 5296 CDFA42          17      CALL    CALSLT_R
001299 5299 2B               6      DEC HL
00129A 529A 51               4      LD  D,C
00129B 529B 10EC            13      DJNZ    C8X1
00129D 529D D1              10      POP DE
00129E 529E F1              10      POP AF
00129F 529F C9              10      RET
                                
       52A0                     INSERT:
0012A0 52A0 F5              11      PUSH    AF
0012A1 52A1 D5              11      PUSH    DE
0012A2 52A2 2ADCF3          16      LD  HL,(CSRY)
0012A5 52A5 3AB0F3          13      LD  A,(LINLEN)
0012A8 52A8 4F               4      LD  C,A
0012A9 52A9 94               4      SUB H   ;CSRX
0012AA 52AA 3C               4      INC A
0012AB 52AB 47               4      LD  B,A ;カーソルより右の文字数
0012AC 52AC C5              11      PUSH    BC
0012AD 52AD CDD152          17      CALL    LOC0
0012B0 52B0 C1              10      POP BC
                                
0012B1 52B1 1620             7      LD  D,020H
       52B3                     INS1:
0012B3 52B3 DD214A00        14      LD  IX,RDVRM
0012B7 52B7 CDFA42          17      CALL    CALSLT_R
0012BA 52BA 4F               4      LD  C,A
0012BB 52BB 7A               4      LD  A,D
0012BC 52BC DD214D00        14      LD  IX,WRTVRM
0012C0 52C0 CDFA42          17      CALL    CALSLT_R
0012C3 52C3 23               6      INC HL
0012C4 52C4 51               4      LD  D,C
0012C5 52C5 10EC            13      DJNZ    INS1
0012C7 52C7 D1              10      POP DE
0012C8 52C8 F1              10      POP AF
0012C9 52C9 C9              10      RET
                                
       52CA                     CONOUT1:
0012CA 52CA 59               4      LD  E,C
0012CB 52CB C3FE50          10      JP  _PRINT
                                
       52CE                     GETVRAM:
0012CE 52CE 2ADCF3          16      LD  HL,(CSRY)
       52D1                     LOC0:
0012D1 52D1 2D               4      DEC L
0012D2 52D2 25               4      DEC H
0012D3 52D3 4C               4      LD  C,H ;CSRX-1
0012D4 52D4 5D               4      LD  E,L ;CSRY-1
       52D5                     LOC1:
0012D5 52D5 3AB0F3          13      LD  A,(LINLEN)
0012D8 52D8 67               4      LD  H,A
0012D9 52D9 1600             7      LD  D,0
0012DB 52DB 6A               4      LD  L,D ;0
0012DC 52DC 0608             7      LD  B,8
       52DE                     LOC2:
0012DE 52DE 29              11      ADD HL,HL
0012DF 52DF 3001            12      JR  NC,LOC3
0012E1 52E1 19              11      ADD HL,DE
       52E2                     LOC3:
0012E2 52E2 10FA            13      DJNZ    LOC2
0012E4 52E4 09              11      ADD HL,BC
0012E5 52E5 C9              10      RET
                                
       52E6                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0012E6 52E6 212200          10      LD  HL,00022H
0012E9 52E9 AF               4      XOR A
0012EA 52EA 7D               4      LD  A,L
0012EB 52EB C9              10      RET
                                
       52EC                     _SYS0D:     ;(BDOS)ディスク・リセット
0012EC 52EC 218000          10      LD  HL,00080H
0012EF 52EF 2230F1          16      LD  (_DTA),HL
0012F2 52F2 C9              10      RET
                                
       52F3                     _SYS0E:     ;(BDOS)カレントドライブの設定
0012F3 52F3 3246F1          13      LD  (_DVSW),A
0012F6 52F6 C9              10      RET
                                
       52F7                     _SYS0F:     ;(BDOS)ファイルのオープン
0012F7 52F7 D5              11      PUSH    DE
0012F8 52F8 FDE1            14      POP IY
0012FA 52FA CD6554          17      CALL    INIT_FILE
0012FD 52FD CD874B          17      CALL    ROM_OPEN
001300 5300 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
001302 5302 FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
001306 5306 FDE5            15      PUSH    IY
001308 5308 D1              10      POP DE
001309 5309 13               6      INC DE
00130A 530A 010B00          10      LD  BC,11
00130D 530D EDB0                    LDIR
                                ;               Attribute
00130F 530F 7E               7      LD  A,(HL)
001310 5310 FD770D          19      LD  (IY+13),A
                                ;               TIME
001313 5313 110B00          10      LD  DE,11
001316 5316 19              11      ADD HL,DE
001317 5317 7E               7      LD  A,(HL)
001318 5318 23               6      INC HL
001319 5319 FD7716          19      LD  (IY+22),A
00131C 531C 7E               7      LD  A,(HL)
00131D 531D 23               6      INC HL
00131E 531E FD7717          19      LD  (IY+23),A
                                ;               DATE
001321 5321 7E               7      LD  A,(HL)
001322 5322 23               6      INC HL
001323 5323 FD7714          19      LD  (IY+20),A
001326 5326 7E               7      LD  A,(HL)
001327 5327 23               6      INC HL
001328 5328 FD7715          19      LD  (IY+21),A
                                ;               First cluster
00132B 532B 7E               7      LD  A,(HL)
00132C 532C 23               6      INC HL
00132D 532D FD771A          19      LD  (IY+26),A
001330 5330 7E               7      LD  A,(HL)
001331 5331 23               6      INC HL
001332 5332 FD771B          19      LD  (IY+27),A
                                ;               SIZE
001335 5335 7E               7      LD  A,(HL)
001336 5336 23               6      INC HL
001337 5337 FD7710          19      LD  (IY+16),A
00133A 533A 7E               7      LD  A,(HL)
00133B 533B 23               6      INC HL
00133C 533C FD7711          19      LD  (IY+17),A
00133F 533F 7E               7      LD  A,(HL)
001340 5340 23               6      INC HL
001341 5341 FD7712          19      LD  (IY+18),A
001344 5344 7E               7      LD  A,(HL)
001345 5345 FD7713          19      LD  (IY+19),A
001348 5348 AF               4      XOR A
001349 5349 FD770C          19      LD  (IY+12),A
00134C 534C C9              10      RET
                                
       534D                     _SYS10:     ;(BDOS)ファイルのクローズ
00134D 534D AF               4      XOR A
00134E 534E C9              10      RET
                                
       534F                     S11X1:
00134F 534F FD7119          19      LD  (IY+25),C       ;RootEntCnt
001352 5352 FD750E          19      LD  (IY+14),L
001355 5355 FD740F          19      LD  (IY+15),H
       5358                     SCF_FF_RET:
001358 5358 37               4      SCF
001359 5359 9F               4      SBC A,A
00135A 535A C9              10      RET
                                
       535B                     _SYS11:     ;(BDOS)最初のファイルの検索
00135B 535B ED5333F1        20      LD  (_FCB),DE
00135F 535F D5              11      PUSH    DE
001360 5360 FDE1            14      POP IY
001362 5362 CD6554          17      CALL    INIT_FILE
001365 5365 CDD94D          17      CALL    GET_DIR_DAT
       5368                     S12X1:
001368 5368 CDA34B          17      CALL    FILESE
00136B 536B 30E2            12      JR  NC,S11X1
00136D 536D 0D               4      DEC C
00136E 536E FD7119          19      LD  (IY+25),C       ;RootEntCnt
001371 5371 FDCB0D66        20      BIT 4,(IY+13)
001375 5375 2809            12      JR  Z,S12X2
001377 5377 E5              11      PUSH    HL
001378 5378 DDE1            14      POP IX
00137A 537A DDCB0E66        20      BIT 4,(IX+1+13)
00137E 537E 28E8            12      JR  Z,S12X1
       5380                     S12X2:
001380 5380 012000          10      LD  BC,32
001383 5383 ED5B30F1        20      LD  DE,(_DTA)
001387 5387 AF               4      XOR A
001388 5388 12               7      LD  (DE),A      ;ドライブ番号
001389 5389 13               6      INC DE
00138A 538A EDB0                    LDIR            ;ディレクトリエントリ
00138C 538C FD750E          19      LD  (IY+14),L
00138F 538F FD740F          19      LD  (IY+15),H
001392 5392 C9              10      RET
                                
       5393                     _SYS12:
001393 5393 FD2A33F1        20      LD  IY,(_FCB)
001397 5397 FDE5            15      PUSH    IY
001399 5399 D1              10      POP DE
00139A 539A CD6554          17      CALL    INIT_FILE
                                
00139D 539D FD6E0E          19      LD  L,(IY+14)
0013A0 53A0 FD660F          19      LD  H,(IY+15)
0013A3 53A3 FD4E19          19      LD  C,(IY+25)
0013A6 53A6 18C0            12      JR  S12X1
                                
       53A8                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0013A8 53A8 CDBF4D          17      CALL    SET_FCB
0013AB 53AB CD8D4D          17      CALL    GETSEQ
0013AE 53AE CD7A4D          17      CALL    RB_READ
0013B1 53B1 E5              11      PUSH    HL
0013B2 53B2 CD9A4D          17      CALL    SETSEQ
0013B5 53B5 E1              10      POP HL
       53B6                     SREAD:
0013B6 53B6 C601             7      ADD A,001H
0013B8 53B8 D8              11      RET C
                                
0013B9 53B9 7D               4      LD  A,L
0013BA 53BA D601             7      SUB 001H
0013BC 53BC 9F               4      SBC A,A
0013BD 53BD E603             7      AND 3
0013BF 53BF 1F               4      RRA
0013C0 53C0 C9              10      RET
                                
       53C1                     _SYS18:     ;(BDOS)ログインベクトルの獲得
0013C1 53C1 210100          10      LD  HL,00001H
0013C4 53C4 AF               4      XOR A
0013C5 53C5 C9              10      RET
                                
       53C6                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
0013C6 53C6 3A46F1          13      LD  A,(_DVSW)
0013C9 53C9 C9              10      RET
                                
       53CA                     _SYS1A:     ;(BDOS)DTAの設定
0013CA 53CA ED5330F1        20      LD  (_DTA),DE
0013CE 53CE AF               4      XOR A
0013CF 53CF C9              10      RET
                                
       53D0                     _SYS1B:     ;(BDOS)ディスク情報の獲得
0013D0 53D0 010002          10      LD  BC,512
0013D3 53D3 11C302          10      LD  DE,707
0013D6 53D6 210000          10      LD  HL,0
0013D9 53D9 DD2135F1        14      LD  IX,_BUF
0013DD 53DD FD2135F1        14      LD  IY,_BUF
0013E1 53E1 FD3600F9        19      LD  (IY+0),0F9H
0013E5 53E5 3E02             7      LD  A,2
0013E7 53E7 C9              10      RET
                                
       53E8                     _SYS21:     ;(BDOS)ランダムな読み出し
0013E8 53E8 CDBF4D          17      CALL    SET_FCB
                                
0013EB 53EB FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0013EE 53EE FD6622          19      LD  H,(IY+34)
                                
0013F1 53F1 CD7A4D          17      CALL    RB_READ
0013F4 53F4 18C0            12      JR  SREAD
                                
       53F6                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
0013F6 53F6 CDF752          17      CALL    _SYS0F
0013F9 53F9 D8              11      RET C
                                
0013FA 53FA D5              11      PUSH    DE      ;EX DE,IY
0013FB 53FB FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
0013FD 53FD CDAF4D          17      CALL    GETSIZE
       5400                     _S24X1:
001400 5400 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001403 5403 FD7422          19      LD  (IY+34),H
001406 5406 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
00140A 540A FDE3            23      EX  (SP),IY     ;
00140C 540C D1              10      POP DE      ;
                                
00140D 540D AF               4      XOR A
00140E 540E C9              10      RET
                                
       540F                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
00140F 540F E5              11      PUSH    HL
001410 5410 D5              11      PUSH    DE      ;EX DE,IY
001411 5411 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001413 5413 CD8D4D          17      CALL    GETSEQ
001416 5416 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       5418                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001418 5418 CDBF4D          17      CALL    SET_FCB
00141B 541B E5              11      PUSH    HL
00141C 541C FD6E21          19      LD  L,(IY+33)
00141F 541F FD6622          19      LD  H,(IY+34)
001422 5422 2226F1          16      LD  (RR_LOW),HL
001425 5425 FD6E23          19      LD  L,(IY+35)
001428 5428 FD6624          19      LD  H,(IY+36)
00142B 542B 2228F1          16      LD  (RR_HIGH),HL
00142E 542E E1              10      POP HL
00142F 542F CD6749          17      CALL    ROM_READ
001432 5432 ED5B26F1        20      LD  DE,(RR_LOW)
001436 5436 FD7321          19      LD  (IY+33),E
001439 5439 FD7222          19      LD  (IY+34),D
00143C 543C ED5B28F1        20      LD  DE,(RR_HIGH)
001440 5440 FD7323          19      LD  (IY+35),E
001443 5443 FD7224          19      LD  (IY+36),D
001446 5446 9F               4      SBC A,A
001447 5447 C9              10      RET
                                
       5448                     _SYS2F:
001448 5448 44               4      LD  B,H
001449 5449 2A30F1          16      LD  HL,(_DTA)
00144C 544C C3C44E          10      JP  DISKIO
                                
       544F                     _SYS5A:
00144F 544F 0600             7      LD  B,0
001451 5451 D5              11      PUSH    DE
001452 5452 DDE1            14      POP IX
       5454                     _SX5A1:
001454 5454 1A               7      LD  A,(DE)
001455 5455 B7               4      OR  A
001456 5456 2804            12      JR  Z,_SX5A2
001458 5458 13               6      INC DE
001459 5459 04               4      INC B
00145A 545A 18F8            12      JR  _SX5A1
                                
       545C                     _SX5A2:
00145C 545C 78               4      LD  A,B
00145D 545D CD324A          17      CALL    FILE_BDOS
001460 5460 CD5F4E          17      CALL    ROM_CD
001463 5463 9F               4      SBC A,A
001464 5464 C9              10      RET
                                
       5465                     INIT_FILE:
001465 5465 EB               4      EX  DE,HL
001466 5466 1150F1          10      LD  DE,FDRV
001469 5469 010C00          10      LD  BC,1+8+3
00146C 546C EDB0                    LDIR
00146E 546E CD9A50          17      CALL    GET_DISK_BANK_FDRV
001471 5471 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
001474 5474 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
001477 5477 2A5CF1          16      LD  HL,(_CD)
00147A 547A 225EF1          16      LD  (_CDX),HL           ;カレントディレクトリ
00147D 547D C9              10      RET
                                
       547E                     ZERO_MEMORY_DE:
00147E 547E AF               4      XOR A
       547F                     FILL_MEMORY_DE:
00147F 547F 12               7      LD  (DE),A
001480 5480 13               6      INC DE
001481 5481 10FC            13      DJNZ    FILL_MEMORY_DE
001483 5483 C9              10      RET
                                
001484 5484                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 EB5001513251EB50        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 EB50EB5037517851        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 3F51EB5092512652        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 E652EC52F352F752        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 4D535B539353EB50        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 A853EB50EB50EB50        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 C153C653CA53D053        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 EB50EB50EB50F653        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 0F54EB50EB501854        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 EB50EB503852EB50        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 3E52EB50EB504854        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 EB50EB504F54EB50        DW  _ERROR,_ERROR,_SYS5A,_ERROR
001FB8 5FB8 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 EB50EB50EB50EB50        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM32.ASM:UTF_8]
