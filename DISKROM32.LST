                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   Tablacus DISK ROM Lite for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                ;
                                    INCLUDE "DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       4000                     RUN EQU 04000H
                                
       0006                     RDVDP   EQU 0006H
       0007                     WRVDP   EQU 0007H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       005C                     LDIRVM  EQU 0005CH
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00B7                     BREAKX  EQU 000B7H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0156                     KILBUF  EQU 00156H
                                
       406F                     ERRHAND EQU 0406FH
       409B                     READYR  EQU 0409BH
       42B2                     CRUNCH  EQU 042B2H
       4601                     NEWSTT  EQU 04601H
       4C64                     FRMEVL  EQU 04C64H
       542F                     FRMQNT  EQU 0542FH
       67D0                     FRESTR  EQU 067D0H
                                
       F331                     H_BDOS  EQU 0F331H
       F340                     REBOOT  EQU 0F340H
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F348                     MASTERS EQU 0F348H
       F368                     ROMUSE  EQU 0F368H
       F36B                     RAMUSE  EQU 0F36BH
       F37D                     BDOS    EQU 0F37DH
       F38C                     CLPRIM  EQU 0F38CH
       F3B0                     LINLEN  EQU 0F3B0H
       F3B9                     TXTATR  EQU 0F3B9H
       F3BB                     TXTPAT  EQU 0F3BBH
       F3D3                     MLTCOL  EQU 0F3D3H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
       F3F8                     PUTPNT  EQU 0F3F8H
       F3FA                     GETPNT  EQU 0F3FAH
       F3FC                     CS120   EQU 0F3FCH
                                
       F41F                     KBUF    EQU 0F41FH
                                
       F55E                     BUF EQU 0F55EH
                                
       F663                     VALTYP  EQU 0F663H
       F672                     MEMSIZ  EQU 0F672H
       F674                     STKTOP  EQU 0F674H
       F676                     TXTTAB  EQU 0F676H
       F6B1                     SAVSTK  EQU 0F6B1H
       F6C2                     VARTAB  EQU 0F6C2H
       F6C4                     ARYTAB  EQU 0F6C4H
       F6C6                     STREND  EQU 0F6C6H
                                
       F7F6                     DAC EQU 0F7F6H
                                
                                ;FBUFFR EQU 0F7C5H
                                
                                ;PTRFIL EQU 0F864H
       F866                     RUNFLG  EQU 0F866H
                                ;FILNAM EQU 0F866H
                                ;FILNM2 EQU 0F871H
                                
       FAF6                     ACPAGE  EQU 0FAF6H
                                
                                ;RSTMP  EQU 0FB03H
       FB20                     HOKVLD  EQU 0FB20H
       FB21                     DRVTBL  EQU 0FB21H
       FBCA                     FSTPOS  EQU 0FBCAH
       FBF0                     KEYBUF  EQU 0FBF0H
                                
       FC48                     BOTTOM  EQU 0FC48H
       FC4A                     HIMEM   EQU 0FC4AH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCAF                     SCRMOD  EQU 0FCAFH
       FCBE                     RUNBNF  EQU 0FCBEH
       FCBF                     SAVENT  EQU 0FCBFH
                                
       FD89                     PROCNM  EQU 0FD89H
                                
       FD99                     DEVICE  EQU 0FD99H
       FE71                     H_BINS  EQU 0FE71H
       FE76                     H_BINL  EQU 0FE76H
       FE7B                     H_FILE  EQU 0FE7BH
       FFA7                     H_PHYD  EQU 0FFA7H
       FDDB                     H_PINL  EQU 0FDDBH
                                
       FF43                     H_GONE  EQU 0FF43H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU   06000H  ;6000-67FF
       6800                     BANK1_SEL EQU   06800H  ;6800-6FFF
       7000                     BANK2_SEL EQU   07000H  ;7000-77FF
       7800                     BANK3_SEL EQU   07800H  ;7800-7FFF
                                            ;ASCII-16K
       6000                     ASCII16_BANK0_SEL EQU 06000H    ;6000-67FF
       7000                     ASCII16_BANK1_SEL EQU 07000H    ;7000-77FF
                                            ;KONAMI-8K
       6000                     KONAMI_BANK1_SEL EQU    06000H  ;6000-7FFF
       8000                     KONAMI_BANK2_SEL EQU    08000H  ;8000-9FFF
       A000                     KONAMI_BANK3_SEL EQU    0A000H  ;A000-BFFF
                                                ;KONAMI-SCC
       5000                     KONAMI_SCC_BANK0_SEL EQU    05000H  ;5000-57FF
       7000                     KONAMI_SCC_BANK1_SEL EQU    07000H  ;7000-77FF
       9000                     KONAMI_SCC_BANK2_SEL EQU    09000H  ;9000-97FF
       B000                     KONAMI_SCC_BANK3_SEL EQU    0B000H  ;B000-B7FF
                                
       F280                     ISC EQU 0F280H
                                
       0001                     DISK_BANK   EQU 1       ;ドライブAが始まるバンク#
       6000                     BANK1_ADR   EQU 06000H      ;バンク1の開始アドレス
                                
       F7F8                     DACDAT  EQU DAC+2
[EOF:DEF.ASM:UTF_8]
                                
       0001                     USE_NORMAL_32K_ROM      EQU 1   ;ノーマル32KB ROMを作成する
                                
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 0041                    DW  INIT_ROM   ; Main program execution address.
000004 4004 3A4E                    DW  STATEMENT  ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
000010 4010 C3DB4E          10      JP  DISKIO
000013 4013 C3214F          10      JP  DSKCHG
000016 4016 C3774F          10      JP  GETDPB
000019 4019 C36A50          10      JP  CHOICE
00001C 401C C36E50          10      JP  DSKFMT
00001F 401F C37050          10      JP  DSKSTP
000022 4022 C37150          10      JP  BASENT
000025 4025 37               4      SCF
000026 4026 C36E50          10      JP  DSKFMT
000029 4029 C37050          10      JP  DSKSTP
00002C 402C 00               4      NOP
00002D 402D C3AD50          10      JP  GETSLT
000030 4030 2A4BF3          16      LD  HL,(0F34BH)
000033 4033 C9              10      RET
                                
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
                                ; Version
000080 4080 5461626C61637573        DB  "Tablacus DISK ROM Lite v0.2.0.5",0
            204449534B20524F    
            4D204C6974652076    
            302E322E302E3500    
                                
0000FF 40FF                         ORG 040FFH
0000FF 40FF C9              10      RET
                                
                                    INCLUDE "INIT.ASM"
                                
                                ;   Tablacus DISK ROM - INIT
                                ;
                                
       4100                     INIT_ROM:
000100 4100 3A21FB          13      LD  A,(DRVTBL)
000103 4103 FE01             7      CP  1
000105 4105 C8              11      RET Z
                                
000106 4106 214BFC          10      LD  HL,HIMEM+1
000109 4109 35              11      DEC (HL)
00010A 410A 2173F6          10      LD  HL,MEMSIZ+1
00010D 410D 35              11      DEC (HL)
00010E 410E 2175F6          10      LD  HL,STKTOP+1
000111 4111 35              11      DEC (HL)
000112 4112 2A74F6          16      LD  HL,(STKTOP)
000115 4115 5D               4      LD  E,L
000116 4116 54               4      LD  D,H
000117 4117 24               4      INC H
000118 4118 012000          10      LD  BC,00020H
00011B 411B EDB8                    LDDR
00011D 411D 2100FF          10      LD  HL,-00100H
000120 4120 39              11      ADD HL,SP
000121 4121 22F9F2          16      LD  (_SP),HL
000124 4124 ED7BF9F2        20      LD  SP,(_SP)
                                
000128 4128 3EFF             7      LD  A,0FFH
00012A 412A 3299FD          13      LD  (DEVICE),A
                                
00012D 412D 3E01             7      LD  A,1
00012F 412F 3221FB          13      LD  (DRVTBL),A
                                
000132 4132 AF               4      XOR A
000133 4133 32DDF2          13      LD  (_DVSW),A
                                
000136 4136 210143          10      LD  HL,AT_ISC
000139 4139 1180F2          10      LD  DE,ISC
00013C 413C 017B00          10      LD  BC,ISC_E-ISC
00013F 413F EDB0                    LDIR
                                    
000141 4141 3EC3             7      LD  A,0C3H      ;JP
000143 4143 3243FF          13      LD  (H_GONE),A
000146 4146 327DF3          13      LD  (BDOS),A
000149 4149 326BF3          13      LD  (RAMUSE),A
00014C 414C 3268F3          13      LD  (ROMUSE),A
00014F 414F 2180F2          10      LD  HL,REPLACE_COMMAND
000152 4152 2244FF          16      LD  (H_GONE+1),HL
000155 4155 2131F3          10      LD  HL,H_BDOS
000158 4158 227EF3          16      LD  (BDOS+1),HL
00015B 415B 21B0F2          10      LD  HL,RAMUSE1
00015E 415E 226CF3          16      LD  (RAMUSE+1),HL
000161 4161 21ABF2          10      LD  HL,ROMUSE1
000164 4164 2269F3          16      LD  (ROMUSE+1),HL
                                
000167 4167 3E                      DB  03EH
000168 4168 F7              12      RST 30H
000169 4169 3271FE          13      LD  (H_BINS),A
00016C 416C 3276FE          13      LD  (H_BINL),A
00016F 416F 327BFE          13      LD  (H_FILE),A
000172 4172 3231F3          13      LD  (H_BDOS),A
000175 4175 32DBFD          13      LD  (H_PINL),A
000178 4178 32A7FF          13      LD  (H_PHYD),A
                                
00017B 417B CD4142          17      CALL    GTSL1_
00017E 417E 3297F2          13      LD  (ROM_SLT),A
000181 4181 32A7F2          13      LD  (ROM_SLT_COPY),A
000184 4184 3272FE          13      LD  (H_BINS+1),A
000187 4187 3277FE          13      LD  (H_BINL+1),A
00018A 418A 327CFE          13      LD  (H_FILE+1),A
00018D 418D 3232F3          13      LD  (H_BDOS+1),A
000190 4190 32DCFD          13      LD  (H_PINL+1),A
000193 4193 32A8FF          13      LD  (H_PHYD+1),A
000196 4196 3222FB          13      LD  (DRVTBL+1),A
000199 4199 3248F3          13      LD  (MASTERS),A
                                
00019C 419C 218E45          10      LD  HL,ROM_LOAD
00019F 419F 2273FE          16      LD  (H_BINS+2),HL
0001A2 41A2 21C346          10      LD  HL,ROM_RUN
0001A5 41A5 2278FE          16      LD  (H_BINL+2),HL
0001A8 41A8 21D046          10      LD  HL,ROM_FILES
0001AB 41AB 227DFE          16      LD  (H_FILE+2),HL
0001AE 41AE 210651          10      LD  HL,ROM_BDOS
0001B1 41B1 2233F3          16      LD  (H_BDOS+2),HL
0001B4 41B4 21A643          10      LD  HL,ROM_BOOT
0001B7 41B7 22DDFD          16      LD  (H_PINL+2),HL
0001BA 41BA 21DB4E          10      LD  HL,DISKIO
0001BD 41BD 22A9FF          16      LD  (H_PHYD+2),HL
                                
0001C0 41C0 3E                      DB  03EH
0001C1 41C1 C9              10      RET
0001C2 41C2 327FFE          13      LD  (H_FILE+4),A
0001C5 41C5 3275FE          13      LD  (H_BINS+4),A
0001C8 41C8 327AFE          13      LD  (H_BINL+4),A
0001CB 41CB 3235F3          13      LD  (H_BDOS+4),A
0001CE 41CE 32DFFD          13      LD  (H_PINL+4),A
0001D1 41D1 32ABFF          13      LD  (H_PHYD+4),A
                                
0001D4 41D4 AF               4      XOR A
0001D5 41D5 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
0001D8 41D8 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
0001DB 41DB 3A0060          13      LD  A,(BANK1_ADR)
0001DE 41DE FE41             7      CP  'A'
                                #if exists USE_NORMAL_32K_ROM
0001E0 41E0 284E            12      JR  Z,NOT_BANK_TYPE
0001E2 41E2 3E01             7      LD  A,DISK_BANK
0001E4 41E4 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    JR  NZ,NOT_BANK_TYPE
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0001E7 41E7 CD3801          17      CALL    RSLREG      ;read primary slot #
0001EA 41EA 07               4      RLCA
0001EB 41EB 07               4      RLCA
0001EC 41EC F5              11      PUSH    AF
0001ED 41ED 1605             7      LD  D,4+1
0001EF 41EF CD4842          17      CALL    GTSL2_
0001F2 41F2 3244F3          13      LD  (RAMAD3),A
0001F5 41F5 F1              10      POP AF
0001F6 41F6 07               4      RLCA
0001F7 41F7 07               4      RLCA
0001F8 41F8 1603             7      LD  D,2+1
0001FA 41FA CD4842          17      CALL    GTSL2_
0001FD 41FD 2680             7      LD  H,080H
0001FF 41FF CD6542          17      CALL    CHK_RAM
000202 4202 3243F3          13      LD  (RAMAD2),A
       4205                     RAMCHK2:
000205 4205 3A44F3          13      LD  A,(RAMAD3)
000208 4208 2640             7      LD  H,040H
00020A 420A CD6542          17      CALL    CHK_RAM
00020D 420D 3242F3          13      LD  (RAMAD1),A
       4210                     RAMCHK1:
000210 4210 3A44F3          13      LD  A,(RAMAD3)
000213 4213 2600             7      LD  H,00H
000215 4215 CD6542          17      CALL    CHK_RAM
000218 4218 3241F3          13      LD  (RAMAD0),A
       421B                     RAMCHK0:
00021B 421B 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
00021E 421E 010F00          10      LD  BC,0000FH       ;切り上げ
000221 4221 09              11      ADD HL,BC
000222 4222 7D               4      LD  A,L
                                
000223 4223 0604             7      LD  B,4
       4225                     B_DRIVE1:
000225 4225 CB3C             8      SRL H
000227 4227 1F               4      RRA
000228 4228 10FB            13      DJNZ    B_DRIVE1
                                
00022A 422A C601             7      ADD A,DISK_BANK     ;A=(TotSec16/16)+DISK_BANK
00022C 422C 32DCF2          13      LD  (B_DRIVE),A
                                
                                #if exists FIX_DRIVE
                                    LD  A,(B_DRIVE)
                                    CP  FIX_DRIVE
                                    JR  Z,OK_FIX_DRIVE
                                    LD  HL,MSG_ERROR_DRIVE
                                    CALL    MSX
                                    LD  A,(B_DRIVE)
                                    CALL    PRTHX
                                    LD  IY,(EXPTBL-1) ;メインROMスロット
                                    LD  IX,CHGET
                                    CALL    _CALSLT
                                    LD  HL,MSG_CRLF
                                    CALL    MSX
                                OK_FIX_DRIVE:
                                #endif
00022F 422F C9              10      RET
                                
       4230                     NOT_BANK_TYPE:
                                                ;ROMのタイプが違う
000230 4230 21E443          10      LD  HL,MSG_ERROR_ROM_MODE
000233 4233 CD7F43          17      CALL    MSX
000236 4236 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00023A 423A DD219F00        14      LD  IX,CHGET
00023E 423E C31C00          10      JP  _CALSLT
                                
       4241                     GTSL1_:             ;自分のいるスロットを知る
000241 4241 CD3801          17      CALL    RSLREG      ;read primary slot #
000244 4244 0F               4      RRCA
000245 4245 0F               4      RRCA
000246 4246 1601             7      LD  D,1
       4248                     GTSL2_:
000248 4248 E603             7      AND 3       ;[A]=000000PP
00024A 424A 5F               4      LD  E,A     ;[E]=000000PP
00024B 424B 21C1FC          10      LD  HL,EXPTBL
00024E 424E 85               4      ADD A,L     ;桁上りは無い
00024F 424F 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000250 4250 7B               4      LD  A,E     ;[A]=000000PP
000251 4251 CB7E            13      BIT 7,(HL)
000253 4253 C8              11      RET Z
000254 4254 7D               4      LD  A,L     ;point to SLTTBL entry
000255 4255 C604             7      ADD A,4     ;桁上りは無い
000257 4257 6F               4      LD  L,A
000258 4258 7E               7      LD  A,(HL)      ;get currently expansion slot register
       4259                     GTSL3_:
000259 4259 15               4      DEC D
00025A 425A 2803            12      JR  Z,GTSL4_:
00025C 425C 0F               4      RRCA
00025D 425D 18FA            12      JR  GTSL3_:
       425F                     GTSL4_:
00025F 425F E60C             7      AND 00CH        ;[A] = 0000SS00
000261 4261 B3               4      OR  E       ;[A] = 0000SSPP
000262 4262 F680             7      OR  080H        ;[A] = 1000SSPP
000264 4264 C9              10      RET
                                
       4265                     CHK_RAM:
000265 4265 E5              11      PUSH    HL
000266 4266 CDBA42          17      CALL    CHK_RAM0
000269 4269 E1              10      POP HL
00026A 426A C8              11      RET Z
00026B 426B 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
00026E 426E E680             7      AND 080H
000270 4270 CD9142          17      CALL    CHK_RAM_SLT
000273 4273 C8              11      RET Z
000274 4274 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000277 4277 E680             7      AND 080H
000279 4279 C601             7      ADD A,1
00027B 427B CD9142          17      CALL    CHK_RAM_SLT
00027E 427E C8              11      RET Z
00027F 427F 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000282 4282 E680             7      AND 080H
000284 4284 C602             7      ADD A,2
000286 4286 CD9142          17      CALL    CHK_RAM_SLT
000289 4289 C8              11      RET Z
00028A 428A 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
00028D 428D E680             7      AND 080H
00028F 428F C603             7      ADD A,3
       4291                     CHK_RAM_SLT:
000291 4291 E5              11      PUSH    HL
000292 4292 CDBA42          17      CALL    CHK_RAM0        ;スロット#X or X-0
000295 4295 E1              10      POP HL
000296 4296 C8              11      RET Z
000297 4297 CB79             8      BIT 7,C
000299 4299 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
00029B 429B 79               4      LD  A,C
00029C 429C C604             7      ADD A,4*1           ;スロット#X-1
00029E 429E E5              11      PUSH    HL
00029F 429F CDBA42          17      CALL    CHK_RAM0
0002A2 42A2 E1              10      POP HL
0002A3 42A3 C8              11      RET Z
0002A4 42A4 79               4      LD  A,C
0002A5 42A5 C608             7      ADD A,4*2           ;スロット#X-2
0002A7 42A7 E5              11      PUSH    HL
0002A8 42A8 CDBA42          17      CALL    CHK_RAM0
0002AB 42AB E1              10      POP HL
0002AC 42AC C8              11      RET Z
0002AD 42AD 79               4      LD  A,C
0002AE 42AE C60C             7      ADD A,4*3           ;スロット#X-3
0002B0 42B0 E5              11      PUSH    HL
0002B1 42B1 CDBA42          17      CALL    CHK_RAM0
0002B4 42B4 E1              10      POP HL
       42B5                     CHK_RAM_E:
0002B5 42B5 AF               4      XOR A
0002B6 42B6 3C               4      INC A           ;ZF=0にする
0002B7 42B7 3E00             7      LD  A,0
0002B9 42B9 C9              10      RET
                                
       42BA                     CHK_RAM0:
0002BA 42BA 4F               4      LD  C,A
0002BB 42BB 3A97F2          13      LD  A,(ROM_SLT)
0002BE 42BE B9               4      CP  C
0002BF 42BF 28F4            12      JR  Z,CHK_RAM_E
0002C1 42C1 2E00             7      LD  L,0
       42C3                     CHK_RAM1:
0002C3 42C3 79               4      LD  A,C
0002C4 42C4 DD210C00        14      LD  IX,_RDSLT
0002C8 42C8 CDF542          17      CALL    CALSLT_R
0002CB 42CB C6E5             7      ADD A,0E5H
0002CD 42CD 47               4      LD  B,A
0002CE 42CE 5F               4      LD  E,A
0002CF 42CF 79               4      LD  A,C
0002D0 42D0 DD211400        14      LD  IX,_WRSLT
0002D4 42D4 CDF542          17      CALL    CALSLT_R
0002D7 42D7 79               4      LD  A,C
0002D8 42D8 DD210C00        14      LD  IX,_RDSLT
0002DC 42DC CDF542          17      CALL    CALSLT_R
0002DF 42DF B8               4      CP  B
0002E0 42E0 C0              11      RET NZ
0002E1 42E1 D6E5             7      SUB 0E5H
0002E3 42E3 79               4      LD  A,C
0002E4 42E4 5F               4      LD  E,A
0002E5 42E5 DD211400        14      LD  IX,_WRSLT
0002E9 42E9 CDF542          17      CALL    CALSLT_R
0002EC 42EC 24               4      INC H
0002ED 42ED 7D               4      LD  A,L
0002EE 42EE C604             7      ADD A,4
0002F0 42F0 6F               4      LD  L,A
0002F1 42F1 20D0            12      JR  NZ,CHK_RAM1
0002F3 42F3 79               4      LD  A,C     ;ZF=1のハズ
0002F4 42F4 C9              10      RET
                                
       42F5                     CALSLT_R:
0002F5 42F5 C5              11      PUSH    BC
0002F6 42F6 E5              11      PUSH    HL
0002F7 42F7 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0002FB 42FB CD1C00          17      CALL    _CALSLT
0002FE 42FE E1              10      POP HL
0002FF 42FF C1              10      POP BC
000300 4300 C9              10      RET
                                
       4301                     AT_ISC:
000301 F280                         ORG ISC,AT_ISC-RUN
       F280                     REPLACE_COMMAND:
000301 F280 FEB7             7      CP  0B7H            ;FILES
000303 F282 CC7BFE          17      CALL    Z,H_FILE
000306 F285 FEB5             7      CP  0B5H            ;LOAD
000308 F287 CA71FE          10      JP  Z,H_BINS
00030B F28A FE8A             7      CP  08AH            ;RUN
00030D F28C CA76FE          10      JP  Z,H_BINL
000310 F28F FED6             7      CP  0D6H            ;COPY
000312 F291 2813            12      JR  Z,FIX_COPY
000314 F293 FECF             7      CP  0CFH            ;BLOAD
000316 F295 C0              11      RET NZ
       F296                     FIX_BLOAD:
000317 F296 F7              12      RST 30H
       F297                     ROM_SLT:
000318 F297 00                      DB  0
000319 F298 F945                    DW  ROM_BLOAD
00031B F29A F5              11      PUSH    AF
00031C F29B E5              11      PUSH    HL
00031D F29C CDA5F2          17      CALL    BLOAD_RET
       F29D                     SWC_BLOAD   EQU $-2
000320 F29F E1              10      POP HL
000321 F2A0 F1              10      POP AF
000322 F2A1 FECF             7      CP  0CFH            ;BLOAD
       F2A3                     SWC_BLOAD_M:
000324 F2A3 28DB            12      JR  Z,REPLACE_COMMAND
       F2A5                     BLOAD_RET:
000326 F2A5 C9              10      RET
       F2A6                     FIX_COPY:
000327 F2A6 F7              12      RST 30H
       F2A7                     ROM_SLT_COPY:
000328 F2A7 00                      DB  0
000329 F2A8 5F47                    DW  ROM_COPY
00032B F2AA C9              10      RET
       F2AB                     ROMUSE1:
00032C F2AB 3A97F2          13      LD  A,(ROM_SLT)
00032F F2AE 1803            12      JR  ROMUSE2
       F2B0                     RAMUSE1:
000331 F2B0 3A42F3          13      LD  A,(RAMAD1)
       F2B3                     ROMUSE2:
000334 F2B3 C32400          10      JP  _ENASLT
                                
       F2B6                     _RESULT:
000337 F2B6 00                      DB  0
       F2B7                     _BANK:
000338 F2B7 00                      DB  0
       F2B8                     _BANK1:
000339 F2B8 00                      DB  0
       F2B9                     CLSZ:               ;クラスタサイズ
00033A F2B9 0004                    DW  1024
       F2BA                     CLSZ_H  EQU $-1     ;クラスタサイズ上位8ビット
       F2BB                     SECSZ:              ;セクタサイズ
00033C F2BB 0002                    DW  512
       F2BC                     SECSZ_H EQU $-1     ;セクタサイズ上位8ビット
       F2BD                     RR_LOW:
00033E F2BD 0000                    DW  0
       F2BE                     RR_MID  EQU $-1
       F2BF                     RR_HIGH:
000340 F2BF 0000                    DW  0
       F2C1                     _CLPS:
000342 F2C1 0000                    DW  0
       F2C3                     _LEFT:
000344 F2C3 0000                    DW  0
       F2C5                     _DTPS:
000346 F2C5 0000                    DW  0
       F2C7                     _DTA:
000348 F2C7 0000                    DW  0
       F2C9                     FLG_LDIR:
00034A F2C9 00                      DB  0
       F2CA                     _FCB:
00034B F2CA 0000                    DW  0
       F2CC                     _BUF:
       F2CC                     _BUF_LO:        ;LOGICAL OPERATION
00034D F2CC 00                      DB  0
       F2CD                     _BUF_ST:
00034E F2CD 0000                    DW  0
       F2CF                     _BUF_EN:
000350 F2CF 0000                    DW  0
       F2D1                     _BUF_EX:
       F2D1                     _BUF_W:
000352 F2D1 0000                    DW  0
       F2D3                     _BUF_H:
000354 F2D3 0000                    DW  0
       F2D5                     _BUF_X:
000356 F2D5 0000                    DW  0
       F2D7                     _BUF_Y:
000358 F2D7 00                      DB  0
       F2D8                     _BUF_P:
000359 F2D8 00                      DB  0
       F2D9                     _BUF_O:
00035A F2D9 00                      DB  0
       F2DA                     DTAX:
00035B F2DA 0000                    DW  0
       F2DC                     B_DRIVE:
00035D F2DC 00                      DB  0
       F2DD                     _DVSW:          ;カレントドライブ
00035E F2DD 00                      DB  0
       F2DE                     _CD:            ;カレントディレクトリ
00035F F2DE 0000                    DW  0
       F2E0                     DIRENT1:
000361 F2E0 0000                    DW  0
       F2E2                     _DIR_BANK:
000363 F2E2 00                      DB  0
       F2E3                     LEFTX:
000364 F2E3 0000                    DW  0
       F2E5                     PARAM0:
000366 F2E5 0000                    DW  0
       F2E7                     PARAM1:
000368 F2E7 0000                    DW  0
       F2E9                     _CDX:
00036A F2E9 0000                    DW  0
       F2EB                     FDRV:
00036C F2EB 00                      DB  0
       F2EC                     FNAME:
00036D F2EC                         DS  8+3
       F2F7                     _HL:
000378 F2F7 0000                    DW  0
       F2F9                     _SP:
00037A F2F9 0000                    DW  0
                                
       F2FB                     ISC_E:
00037C 437C                         ORG $$+RUN          ;$DEPHASE
                                
       437C                     MSX1:
00037C 437C CD1F51          17      CALL    MSGA1
       437F                     MSX:
00037F 437F 7E               7      LD  A,(HL)
000380 4380 23               6      INC HL
000381 4381 B7               4      OR  A
000382 4382 20F8            12      JR  NZ,MSX1
000384 4384 C9              10      RET
                                
       4385                     PRTHX:
000385 4385 F5              11      PUSH    AF
000386 4386 07               4      RLCA
000387 4387 07               4      RLCA
000388 4388 07               4      RLCA
000389 4389 07               4      RLCA
00038A 438A CD8E43          17      CALL    PRTA2
00038D 438D F1              10      POP AF
       438E                     PRTA2:
00038E 438E CD9443          17      CALL    ASC
000391 4391 C31B51          10      JP  MSG_A
                                    
       4394                     ASC:
000394 4394 E60F             7      AND $0F
000396 4396 F630             7      OR  $30
000398 4398 FE3A             7      CP  $3A
00039A 439A D8              11      RET C
00039B 439B C607             7      ADD A,7
00039D 439D C9              10      RET
                                
       439E                     MSN:
00039E 439E 7E               7      LD  A,(HL)
00039F 439F 23               6      INC HL
0003A0 43A0 CD1B51          17      CALL    MSG_A
0003A3 43A3 10F9            13      DJNZ    MSN
0003A5 43A5 C9              10      RET
                                
       43A6                     ROM_BOOT:
0003A6 43A6 3E                      DB  03EH
0003A7 43A7 C9              10      RET
0003A8 43A8 32DBFD          13      LD  (H_PINL),A
0003AB 43AB 3ACAFF          13      LD  A,(EXTBIO)
0003AE 43AE FEF7             7      CP  0F7H        ;RST 30H
0003B0 43B0 2805            12      JR  Z,EXTBIO_OK
0003B2 43B2 3E                      DB  03EH
0003B3 43B3 C9              10      RET
0003B4 43B4 32CAFF          13      LD  (EXTBIO),A
       43B7                     EXTBIO_OK:
0003B7 43B7 210144          10      LD  HL,DELOK
0003BA 43BA CD7F43          17      CALL    MSX
                                
0003BD 43BD AF               4      XOR A
0003BE 43BE 3240F3          13      LD  (REBOOT),A
0003C1 43C1 2A48FC          16      LD  HL,(BOTTOM)
0003C4 43C4 110040          10      LD  DE,16384
0003C7 43C7 19              11      ADD HL,DE
0003C8 43C8 3817            12      JR  C,BOOT1     ;RAM16KB以下の場合はブートセクタを実行しない
                                
                                ;   LD  E,A     ;すでにE=0
0003CA 43CA 57               4      LD  D,A
0003CB 43CB 0601             7      LD  B,1
0003CD 43CD 2100C0          10      LD  HL,0C000H
0003D0 43D0 CDDB4E          17      CALL    DISKIO
                                
0003D3 43D3 116BF3          10      LD  DE,RAMUSE
0003D6 43D6 AF               4      XOR A
0003D7 43D7 CD1EC0          17      CALL    0C01EH
0003DA 43DA 116BF3          10      LD  DE,RAMUSE
0003DD 43DD 37               4      SCF
0003DE 43DE CD1EC0          17      CALL    0C01EH
       43E1                     BOOT1:
0003E1 43E1 C37150          10      JP  BASENT
                                
       43E4                     MSG_ERROR_ROM_MODE:
                                #if exists USE_NORMAL_32K_ROM
0003E4 43E4 4E6F726D616C2052        DB  "Normal ROM/ASCII-16K only!",13,10
            4F4D2F4153434949    
            2D31364B206F6E6C    
            79210D0A            
                                #else
                                    DB  "ASCII-8K/Konami-8K/Konami-SCC only!",13,10
                                #endif
       4400                     NULL:
000400 4400 00                      DB  0
       4401                     DELOK:
000401 4401 1E1B4B00                DB  01EH,01BH,'K',0
[EOF:INIT.ASM:UTF_8]
                                    INCLUDE "FILE.ASM"
       4405                     ROM_LDIR:
000405 4405 3AC9F2          13      LD  A,(FLG_LDIR)
000408 4408 B7               4      OR  A
000409 4409 2064            12      JR  NZ,ROM_LDIRVM
00040B 440B CB7A             8      BIT 7,D
00040D 440D CA9844          10      JP  Z,ROM_LDIRSLT
                                #if exists USE_NORMAL_32K_ROM
       4410                     LDIRA:
000410 4410 F3               4      DI
000411 4411 ED73F9F2        20      LD  (_SP),SP
000415 4415 3121FB          10      LD  SP,DRVTBL
       4418                     LDIR1:
000418 4418 78               4      LD  A,B
000419 4419 B1               4      OR  C
00041A 441A 284D            12      JR  Z,LDIRE
                                
00041C 441C C5              11      PUSH    BC
00041D 441D D5              11      PUSH    DE
00041E 441E E5              11      PUSH    HL
00041F 441F 3A97F2          13      LD  A,(ROM_SLT)
000422 4422 2680             7      LD  H,080H
000424 4424 CD2400          17      CALL    _ENASLT
000427 4427 E1              10      POP HL
000428 4428 D1              10      POP DE
000429 4429 C1              10      POP BC
       442A                     LDIR2:
00042A 442A 7A               4      LD  A,D
00042B 442B FEC0             7      CP  0C0H
00042D 442D 302C            12      JR  NC,LDIR4
                                
00042F 442F C5              11      PUSH    BC
000430 4430 D5              11      PUSH    DE
000431 4431 115EF5          10      LD  DE,BUF
                                
000434 4434 78               4      LD  A,B
000435 4435 B7               4      OR  A
000436 4436 2803            12      JR  Z,LDIR3
000438 4438 010001          10      LD  BC,00100H
       443B                     LDIR3:
00043B 443B C5              11      PUSH    BC
00043C 443C EDB0                    LDIR
00043E 443E 22F7F2          16      LD  (_HL),HL
                                
000441 4441 3A43F3          13      LD  A,(RAMAD2)
000444 4444 2680             7      LD  H,080H
000446 4446 CD2400          17      CALL    _ENASLT
                                
000449 4449 C1              10      POP BC
00044A 444A D1              10      POP DE
00044B 444B 215EF5          10      LD  HL,BUF
00044E 444E EDB0                    LDIR
                                
000450 4450 2AF7F2          16      LD  HL,(_HL)
000453 4453 C1              10      POP BC
000454 4454 78               4      LD  A,B
000455 4455 B7               4      OR  A
000456 4456 2811            12      JR  Z,LDIRE
000458 4458 05               4      DEC B
000459 4459 18BD            12      JR  LDIR1
       445B                     LDIR4:
                                #endif
00045B 445B EDB0                    LDIR
                                
                                #if exists USE_NORMAL_32K_ROM
       445D                     LDIRE2:
00045D 445D D5              11      PUSH    DE
00045E 445E E5              11      PUSH    HL
00045F 445F 3A43F3          13      LD  A,(RAMAD2)
000462 4462 2680             7      LD  H,080H
000464 4464 CD2400          17      CALL    _ENASLT
000467 4467 E1              10      POP HL
000468 4468 D1              10      POP DE
       4469                     LDIRE:
000469 4469 ED7BF9F2        20      LD  SP,(_SP)
00046D 446D FB               4      EI
                                #endif
00046E 446E C9              10      RET
                                
       446F                     ROM_LDIRVM:
                                #if exists USE_NORMAL_32K_ROM
00046F 446F F3               4      DI
000470 4470 ED73F9F2        20      LD  (_SP),SP
000474 4474 3121FB          10      LD  SP,DRVTBL
000477 4477 C5              11      PUSH    BC
000478 4478 D5              11      PUSH    DE
000479 4479 E5              11      PUSH    HL
00047A 447A 3A97F2          13      LD  A,(ROM_SLT)
00047D 447D 2680             7      LD  H,080H
00047F 447F CD2400          17      CALL    _ENASLT
000482 4482 E1              10      POP HL
000483 4483 D1              10      POP DE
000484 4484 C1              10      POP BC
                                #endif
000485 4485 C5              11      PUSH    BC
000486 4486 D5              11      PUSH    DE
000487 4487 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00048B 448B DD215C00        14      LD  IX,LDIRVM
00048F 448F CD1C00          17      CALL    _CALSLT
000492 4492 E1              10      POP HL
000493 4493 C1              10      POP BC
000494 4494 09              11      ADD HL,BC
000495 4495 EB               4      EX  DE,HL
                                #if exists USE_NORMAL_32K_ROM
000496 4496 18C5            12      JR  LDIRE2
                                #else
                                    RET
                                #endif
                                
       4498                     ROM_LDIRSLT:
                                #if exists USE_NORMAL_32K_ROM
000498 4498 F3               4      DI
000499 4499 ED73F9F2        20      LD  (_SP),SP
00049D 449D 3121FB          10      LD  SP,DRVTBL
0004A0 44A0 C5              11      PUSH    BC
0004A1 44A1 D5              11      PUSH    DE
0004A2 44A2 E5              11      PUSH    HL
0004A3 44A3 3A97F2          13      LD  A,(ROM_SLT)
0004A6 44A6 2680             7      LD  H,080H
0004A8 44A8 CD2400          17      CALL    _ENASLT
0004AB 44AB E1              10      POP HL
0004AC 44AC D1              10      POP DE
0004AD 44AD C1              10      POP BC
                                #endif
       44AE                     ROM_LDIRSLT1:
0004AE 44AE EB               4      EX  DE,HL
       44AF                     RLDIRSLT1:
0004AF 44AF 1A               7      LD  A,(DE)
0004B0 44B0 13               6      INC DE
0004B1 44B1 C5              11      PUSH    BC
0004B2 44B2 D5              11      PUSH    DE
0004B3 44B3 E5              11      PUSH    HL
0004B4 44B4 5F               4      LD  E,A
                                
0004B5 44B5 0141F3          10      LD  BC,RAMAD0
0004B8 44B8 7C               4      LD  A,H
0004B9 44B9 07               4      RLCA
0004BA 44BA 07               4      RLCA
0004BB 44BB E603             7      AND 3
0004BD 44BD 81               4      ADD A,C
0004BE 44BE 4F               4      LD  C,A
0004BF 44BF 0A               7      LD  A,(BC)
       44C0                     RLDIRSLT2:
0004C0 44C0 CD1400          17      CALL    _WRSLT
0004C3 44C3 08               4      EX  AF,AF'
0004C4 44C4 E1              10      POP HL
0004C5 44C5 D1              10      POP DE
0004C6 44C6 C1              10      POP BC
0004C7 44C7 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0004C9 44C9 EAAF44          10      JP  PE,RLDIRSLT1
0004CC 44CC EB               4      EX  DE,HL
                                #if exists USE_NORMAL_32K_ROM
0004CD 44CD 188E            12      JR  LDIRE2
                                #else
                                    RET
                                #endif
                                
       44CF                     END_OF_LINE:
0004CF 44CF 215EF5          10      LD  HL,BUF
       44D2                     EOL1:
0004D2 44D2 7E               7      LD  A,(HL)
0004D3 44D3 C8              11      RET Z
0004D4 44D4 FE0D             7      CP  00DH
0004D6 44D6 2807            12      JR  Z,EOLE
0004D8 44D8 FE0A             7      CP  00AH
0004DA 44DA 2803            12      JR  Z,EOLE
0004DC 44DC 23               6      INC HL
0004DD 44DD 18F3            12      JR  EOL1
       44DF                     EOLE:
0004DF 44DF 3600            10      LD  (HL),0
0004E1 44E1 23               6      INC HL
0004E2 44E2 7E               7      LD  A,(HL)
0004E3 44E3 FE0A             7      CP  00AH
0004E5 44E5 C0              11      RET NZ
0004E6 44E6 23               6      INC HL
0004E7 44E7 C9              10      RET
                                
       44E8                     ROM_LOAD_ASCII:
0004E8 44E8 210000          10      LD  HL,0
0004EB 44EB 22CDF2          16      LD  (_BUF_ST),HL    ;読み出し位置
0004EE 44EE 2A76F6          16      LD  HL,(TXTTAB)
0004F1 44F1 22CFF2          16      LD  (_BUF_EN),HL    ;書き出し位置
                                
0004F4 44F4 215EF5          10      LD  HL,BUF
0004F7 44F7 22C7F2          16      LD  (_DTA),HL
       44FA                     RLOAD_A1:
0004FA 44FA 2ACDF2          16      LD  HL,(_BUF_ST)
0004FD 44FD 22BDF2          16      LD  (RR_LOW),HL
000500 4500 210201          10      LD  HL,258
000503 4503 CD7E49          17      CALL    ROM_READ
000506 4506 7C               4      LD  A,H
000507 4507 B5               4      OR  L
000508 4508 2877            12      JR  Z,RLOAD_AEND
00050A 450A 015EF5          10      LD  BC,BUF
00050D 450D 09              11      ADD HL,BC
00050E 450E 3600            10      LD  (HL),0
000510 4510 CDCF44          17      CALL    END_OF_LINE
000513 4513 015EF5          10      LD  BC,BUF
000516 4516 A7               4      AND A
000517 4517 ED42            15      SBC HL,BC
000519 4519 2810            12      JR  Z,RLOAD_A2
00051B 451B 4D               4      LD  C,L
00051C 451C 44               4      LD  B,H
00051D 451D ED5BCDF2        20      LD  DE,(_BUF_ST)
000521 4521 19              11      ADD HL,DE
000522 4522 22CDF2          16      LD  (_BUF_ST),HL
000525 4525 3A5EF5          13      LD  A,(BUF)
000528 4528 B7               4      OR  A
000529 4529 28CF            12      JR  Z,RLOAD_A1
       452B                     RLOAD_A2:
00052B 452B 115EF5          10      LD  DE,BUF
00052E 452E CD354B          17      CALL    SPCUTEX
000531 4531 1A               7      LD  A,(DE)
000532 4532 B7               4      OR  A
000533 4533 284C            12      JR  Z,RLOAD_AEND
000535 4535 CD474B          17      CALL    GETNUM
000538 4538 7C               4      LD  A,H
000539 4539 B5               4      OR  L
00053A 453A CAE045          10      JP  Z,ERROR_DIRECT_IN_FILE
00053D 453D DD2ACFF2        20      LD  IX,(_BUF_EN)
000541 4541 DD7502          19      LD  (IX+2),L
000544 4544 DD7403          19      LD  (IX+3),H
                                
000547 4547 CD2E4B          17      CALL    SPCUT
00054A 454A EB               4      EX  DE,HL
00054B 454B DDE5            15      PUSH    IX
00054D 454D DD21B242        14      LD  IX,CRUNCH
000551 4551 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000555 4555 CD1C00          17      CALL    _CALSLT
000558 4558 DDE1            14      POP IX
00055A 455A EB               4      EX  DE,HL
00055B 455B 111FF4          10      LD  DE,KBUF
00055E 455E 37               4      SCF
00055F 455F ED52            15      SBC HL,DE
000561 4561 287D            12      JR  Z,ERROR_DIRECT_IN_FILE
000563 4563 387B            12      JR  C,ERROR_DIRECT_IN_FILE
000565 4565 4D               4      LD  C,L
000566 4566 44               4      LD  B,H
000567 4567 2ACFF2          16      LD  HL,(_BUF_EN)
00056A 456A 110400          10      LD  DE,4
00056D 456D 19              11      ADD HL,DE
00056E 456E 111FF4          10      LD  DE,KBUF
                                
000571 4571 EB               4      EX  DE,HL
000572 4572 EDB0                    LDIR
000574 4574 EB               4      EX  DE,HL
                                
000575 4575 DD7500          19      LD  (IX+0),L
000578 4578 DD7401          19      LD  (IX+1),H
00057B 457B 22CFF2          16      LD  (_BUF_EN),HL
00057E 457E C3FA44          10      JP  RLOAD_A1
                                
       4581                     RLOAD_AEND:
000581 4581 2ACFF2          16      LD  HL,(_BUF_EN)
000584 4584 AF               4      XOR A
000585 4585 77               7      LD  (HL),A
000586 4586 23               6      INC HL
000587 4587 77               7      LD  (HL),A
000588 4588 23               6      INC HL
000589 4589 22CFF2          16      LD  (_BUF_EN),HL
00058C 458C 183B            12      JR  RLOAD_END1
                                
       458E                     ROM_LOAD:
00058E 458E CD2947          17      CALL    INIT_PARAM
000591 4591 CD1F4A          17      CALL    FILE_B
000594 4594 3AECF2          13      LD  A,(FNAME)
000597 4597 FE20             7      CP  020H
000599 4599 CA1A4A          10      JP  Z,ROM_ORG
                                
00059C 459C CD9E4B          17      CALL    ROM_OPEN
00059F 459F 384B            12      JR  C,ERROR_FILE_NOT_FOUND
       45A1                     ROM_LOAD1:
0005A1 45A1 21CCF2          10      LD  HL,_BUF
0005A4 45A4 22C7F2          16      LD  (_DTA),HL
0005A7 45A7 210100          10      LD  HL,1            ;ヘッダを1バイト読み込む
0005AA 45AA CD7E49          17      CALL    ROM_READ
0005AD 45AD 3ACCF2          13      LD  A,(_BUF)
0005B0 45B0 3C               4      INC A
0005B1 45B1 C2E844          10      JP  NZ,ROM_LOAD_ASCII
0005B4 45B4 2A76F6          16      LD  HL,(TXTTAB)
0005B7 45B7 22C7F2          16      LD  (_DTA),HL
0005BA 45BA EB               4      EX  DE,HL
0005BB 45BB 2100FF          10      LD  HL,-256
0005BE 45BE 39              11      ADD HL,SP
0005BF 45BF ED52            15      SBC HL,DE
0005C1 45C1 CD7E49          17      CALL    ROM_READ
0005C4 45C4 ED5BC7F2        20      LD  DE,(_DTA)
0005C8 45C8 19              11      ADD HL,DE
       45C9                     RLOAD_END1:
0005C9 45C9 22C2F6          16      LD  (VARTAB),HL
0005CC 45CC 22C4F6          16      LD  (ARYTAB),HL
0005CF 45CF 22C6F6          16      LD  (STREND),HL
                                
0005D2 45D2 AF               4      XOR A
0005D3 45D3 21CFF2          10      LD  HL,_BUF+3
0005D6 45D6 77               7      LD  (HL),A
0005D7 45D7 2B               6      DEC HL
0005D8 45D8 77               7      LD  (HL),A
0005D9 45D9 2B               6      DEC HL
0005DA 45DA 77               7      LD  (HL),A
0005DB 45DB 2B               6      DEC HL
0005DC 45DC 3E8F             7      LD  A,08FH          ;REM
0005DE 45DE 77               7      LD  (HL),A
0005DF 45DF C9              10      RET
                                
       45E0                     ERROR_DIRECT_IN_FILE:
0005E0 45E0 1E39             7      LD  E,57            ;Direct statement in file
0005E2 45E2 01                      DB  1           ;LD BC,
       45E3                     ERROR_DEVICE_IO_ERROR:
0005E3 45E3 1E13             7      LD  E,19            ;Device I/O error
0005E5 45E5 01                      DB  1           ;LD BC,
       45E6                     ERROR_INTERNAL_ERROR:
0005E6 45E6 1E33             7      LD  E,51            ;Internal error
0005E8 45E8 01                      DB  1           ;LD BC,
       45E9                     ERROR_FILE_NOT_OPEN:
0005E9 45E9 1E3B             7      LD  E,59            ;File not OPEN
0005EB 45EB 01                      DB  1           ;LD BC,
       45EC                     ERROR_FILE_NOT_FOUND:
0005EC 45EC 1E35             7      LD  E,53            ;File not found
       45EE                     ERROR:
0005EE 45EE FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0005F2 45F2 DD216F40        14      LD  IX,ERRHAND
0005F6 45F6 C31C00          10      JP  _CALSLT
                                
       45F9                     ROM_BLOAD:
0005F9 45F9 CD2947          17      CALL    INIT_PARAM
0005FC 45FC CD1F4A          17      CALL    FILE_B
0005FF 45FF CD9E4B          17      CALL    ROM_OPEN
000602 4602 38E8            12      JR  C,ERROR_FILE_NOT_FOUND
                                
000604 4604 21CCF2          10      LD  HL,_BUF
000607 4607 22C7F2          16      LD  (_DTA),HL
00060A 460A 210700          10      LD  HL,7            ;ヘッダを7バイト読み込む
00060D 460D CD7E49          17      CALL    ROM_READ
000610 4610 3ACCF2          13      LD  A,(_BUF)
000613 4613 FEFE             7      CP  0FEH
000615 4615 20D2            12      JR  NZ,ERROR_FILE_NOT_OPEN
                                
000617 4617 21A5F2          10      LD  HL,BLOAD_RET
00061A 461A 229DF2          16      LD  (SWC_BLOAD),HL
                                
00061D 461D 2AE7F2          16      LD  HL,(PARAM1)
000620 4620 7E               7      LD  A,(HL)
000621 4621 FE2C             7      CP  ','
000623 4623 2048            12      JR  NZ,RBREAD_MEM
000625 4625 23               6      INC HL
000626 4626 7E               7      LD  A,(HL)
000627 4627 CD884B          17      CALL    CAP
00062A 462A 32BEFC          13      LD  (RUNBNF),A
       462D                     RBOS1:
00062D 462D 7E               7      LD  A,(HL)
00062E 462E 23               6      INC HL
00062F 462F B7               4      OR  A
000630 4630 282F            12      JR  Z,RBREAD_OSE
000632 4632 FE3A             7      CP  ':'
000634 4634 282B            12      JR  Z,RBREAD_OSE
000636 4636 FE2C             7      CP  ','     ;次のパラメータを探す
000638 4638 20F3            12      JR  NZ,RBOS1
                                                ;オフセット
00063A 463A 22E7F2          16      LD  (PARAM1),HL
00063D 463D 7E               7      LD  A,(HL)
00063E 463E B7               4      OR  A
00063F 463F 2820            12      JR  Z,RBREAD_OSE
000641 4641 DD21644C        14      LD  IX,FRMEVL
000645 4645 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000649 4649 CD1C00          17      CALL    _CALSLT
00064C 464C 22E7F2          16      LD  (PARAM1),HL
00064F 464F 3A63F6          13      LD  A,(VALTYP)
000652 4652 FE02             7      CP  2
000654 4654 200B            12      JR  NZ,RBREAD_OSE
000656 4656 2ACDF2          16      LD  HL,(_BUF_ST)
000659 4659 ED5BF8F7        20      LD  DE,(DACDAT)
00065D 465D 19              11      ADD HL,DE
00065E 465E 22CDF2          16      LD  (_BUF_ST),HL
       4661                     RBREAD_OSE:
000661 4661 3ABEFC          13      LD  A,(RUNBNF)
000664 4664 FE53             7      CP  'S'
000666 4666 2005            12      JR  NZ,RBREAD_MEM
000668 4668 3E01             7      LD  A,1
00066A 466A 32C9F2          13      LD  (FLG_LDIR),A
       466D                     RBREAD_MEM:
00066D 466D 2ACDF2          16      LD  HL,(_BUF_ST)
000670 4670 22BFFC          16      LD  (SAVENT),HL
000673 4673 22C7F2          16      LD  (_DTA),HL
000676 4676 21FFFF          10      LD  HL,0FFFFH
000679 4679 CD7E49          17      CALL    ROM_READ
00067C 467C 3ABEFC          13      LD  A,(RUNBNF)
00067F 467F FE52             7      CP  'R'
000681 4681 2006            12      JR  NZ,RBREAD1
000683 4683 2AD1F2          16      LD  HL,(_BUF_EX)
000686 4686 229DF2          16      LD  (SWC_BLOAD),HL
       4689                     RBREAD1:
       4689                     ROM_NEXT:
000689 4689 2AE7F2          16      LD  HL,(PARAM1)
00068C 468C 7E               7      LD  A,(HL)
00068D 468D 2B               6      DEC HL
00068E 468E B7               4      OR  A
00068F 468F 2805            12      JR  Z,RN1
000691 4691 FE3A             7      CP  ':'
000693 4693 2801            12      JR  Z,RN1
000695 4695 23               6      INC HL
       4696                     RN1:
000696 4696 5D               4      LD  E,L
000697 4697 54               4      LD  D,H
                                
000698 4698 CD5E4B          17      CALL    SEARCH_END
00069B 469B B7               4      OR  A
00069C 469C 2821            12      JR  Z,REM
       469E                     RN3:                    ;マルチステートメントの処理
00069E 469E 7E               7      LD  A,(HL)
                                
00069F 469F FEB5             7      CP  0B5H            ;LOAD
0006A1 46A1 CA8E45          10      JP  Z,ROM_LOAD
0006A4 46A4 FE8A             7      CP  08AH            ;RUN
0006A6 46A6 281B            12      JR  Z,ROM_RUN
0006A8 46A8 FEB7             7      CP  0B7H            ;FILES
0006AA 46AA 2824            12      JR  Z,ROM_FILES
0006AC 46AC FED6             7      CP  0D6H            ;COPY
0006AE 46AE CA5F47          10      JP  Z,ROM_COPY
0006B1 46B1 FE20             7      CP  020H
0006B3 46B3 2807            12      JR  Z,RN_SP
                                
0006B5 46B5 3E28             7      LD  A,028H          ;JR Z,
0006B7 46B7 32A3F2          13      LD  (SWC_BLOAD_M),A
0006BA 46BA 7E               7      LD  A,(HL)
0006BB 46BB C9              10      RET
       46BC                     RN_SP:
0006BC 46BC 23               6      INC HL
0006BD 46BD 18DF            12      JR  RN3
                                
       46BF                     REM:
0006BF 46BF EB               4      EX  DE,HL
0006C0 46C0 3E8F             7      LD  A,08FH          ;REM
0006C2 46C2 C9              10      RET
                                
       46C3                     ROM_RUN:
0006C3 46C3 23               6      INC HL
0006C4 46C4 7E               7      LD  A,(HL)
0006C5 46C5 2B               6      DEC HL
0006C6 46C6 B7               4      OR  A
0006C7 46C7 2803            12      JR  Z,ROM_RUN1
0006C9 46C9 CD8E45          17      CALL    ROM_LOAD
       46CC                     ROM_RUN1:
0006CC 46CC 3E8A             7      LD  A,08AH          ;RUN
0006CE 46CE 77               7      LD  (HL),A
0006CF 46CF C9              10      RET
                                
       46D0                     ROM_FILES:
0006D0 46D0 CD2947          17      CALL    INIT_PARAM
0006D3 46D3 CD1F4A          17      CALL    FILE_B
0006D6 46D6 CDB150          17      CALL    GET_DISK_BANK_FDRV
0006D9 46D9 3ABCF2          13      LD  A,(SECSZ_H)
0006DC 46DC CD6C4F          17      CALL    IS_BPB1
0006DF 46DF DAE345          10      JP  C,ERROR_DEVICE_IO_ERROR
0006E2 46E2 3AECF2          13      LD  A,(FNAME)
0006E5 46E5 FE21             7      CP  021H
0006E7 46E7 3005            12      JR  NC,RFILES0
0006E9 46E9 060B             7      LD  B,11
0006EB 46EB CDF24A          17      CALL    FILE10
       46EE                     RFILES0:
0006EE 46EE CDF04D          17      CALL    GET_DIR_DAT
       46F1                     RFILES1:
0006F1 46F1 CDBA4B          17      CALL    FILESE
0006F4 46F4 302E            12      JR  NC,RFILES_NOT_MATCH
       46F6                     RFILES_DISP:
0006F6 46F6 E5              11      PUSH    HL
0006F7 46F7 0608             7      LD  B,8
0006F9 46F9 CD9E43          17      CALL    MSN
0006FC 46FC 3E2E             7      LD  A,'.'
0006FE 46FE CD1B51          17      CALL    MSG_A
000701 4701 0603             7      LD  B,3
000703 4703 CD9E43          17      CALL    MSN
000706 4706 3ADDF3          13      LD  A,(CSRX)
000709 4709 47               4      LD  B,A
00070A 470A 3AB0F3          13      LD  A,(LINLEN)
00070D 470D 90               4      SUB B
00070E 470E FE0C             7      CP  12
000710 4710 3009            12      JR  NC,RFILES2
000712 4712 3E0D             7      LD  A,00DH      ;改行
000714 4714 CD1B51          17      CALL    MSG_A
000717 4717 3E0A             7      LD  A,00AH
000719 4719 1802            12      JR  RFILES3
       471B                     RFILES2:
00071B 471B 3E20             7      LD  A,020H
       471D                     RFILES3:
00071D 471D CD1B51          17      CALL    MSG_A
000720 4720 E1              10      POP HL
000721 4721 CDD64B          17      CALL    FNEXT
       4724                     RFILES_NOT_MATCH:
000724 4724 20CB            12      JR  NZ,RFILES1
000726 4726 C38946          10      JP  ROM_NEXT
                                
       4729                     INIT_PARAM:
000729 4729 22E5F2          16      LD  (PARAM0),HL
00072C 472C 22E7F2          16      LD  (PARAM1),HL
00072F 472F EB               4      EX  DE,HL
000730 4730 AF               4      XOR A
000731 4731 32C9F2          13      LD  (FLG_LDIR),A
000734 4734 32BEFC          13      LD  (RUNBNF),A
000737 4737 3263F6          13      LD  (VALTYP),A
00073A 473A E5              11      PUSH    HL
00073B 473B 2ADEF2          16      LD  HL,(_CD)
00073E 473E 22E9F2          16      LD  (_CDX),HL
000741 4741 E1              10      POP HL
000742 4742 13               6      INC DE
000743 4743 CD2E4B          17      CALL    SPCUT
000746 4746 1A               7      LD  A,(DE)
000747 4747 B7               4      OR  A
000748 4748 C8              11      RET Z
000749 4749 FE3A             7      CP  ':'
00074B 474B C8              11      RET Z
00074C 474C FE28             7      CP  '('
00074E 474E C8              11      RET Z
00074F 474F EB               4      EX  DE,HL
000750 4750 DD21644C        14      LD  IX,FRMEVL
000754 4754 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000758 4758 CD1C00          17      CALL    _CALSLT
00075B 475B 22E7F2          16      LD  (PARAM1),HL
00075E 475E C9              10      RET
                                
       475F                     ROM_COPY:
00075F 475F CD2947          17      CALL    INIT_PARAM
000762 4762 3A63F6          13      LD  A,(VALTYP)
000765 4765 FE03             7      CP  3       ;string
000767 4767 C21A4A          10      JP  NZ,ROM_ORG  ;最初の引数が文字列ではない場合はオリジナルを実行する
                                
00076A 476A CD1F4A          17      CALL    FILE_B
00076D 476D CD9E4B          17      CALL    ROM_OPEN
000770 4770 DAEC45          10      JP  C,ERROR_FILE_NOT_FOUND
                                
000773 4773 21D1F2          10      LD  HL,_BUF_W
000776 4776 22C7F2          16      LD  (_DTA),HL
000779 4779 210400          10      LD  HL,4            ;ヘッダを4バイト読み込む
00077C 477C CD7E49          17      CALL    ROM_READ
                                
00077F 477F AF               4      XOR A
000780 4780 32CCF2          13      LD  (_BUF_LO),A     ;PSET
000783 4783 32D9F2          13      LD  (_BUF_O),A      ;向き
                                
000786 4786 2AE7F2          16      LD  HL,(PARAM1)
       4789                     RCP_PARAM1:
000789 4789 7E               7      LD  A,(HL)
00078A 478A 23               6      INC HL
00078B 478B B7               4      OR  A
00078C 478C CA1A4A          10      JP  Z,ROM_ORG
00078F 478F FE3A             7      CP  ':'
000791 4791 CA1A4A          10      JP  Z,ROM_ORG
000794 4794 FE2C             7      CP  ','
000796 4796 2012            12      JR  NZ,RCP_PARAM1_
                                
000798 4798 DD212F54        14      LD  IX,FRMQNT
00079C 479C FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007A0 47A0 CD1C00          17      CALL    _CALSLT
0007A3 47A3 7B               4      LD  A,E
0007A4 47A4 87               4      ADD A,A
0007A5 47A5 87               4      ADD A,A
0007A6 47A6 32D9F2          13      LD  (_BUF_O),A
0007A9 47A9 7E               7      LD  A,(HL)
       47AA                     RCP_PARAM1_:
0007AA 47AA FE28             7      CP  '('
0007AC 47AC 20DB            12      JR  NZ,RCP_PARAM1
                                
0007AE 47AE DD212F54        14      LD  IX,FRMQNT
0007B2 47B2 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007B6 47B6 CD1C00          17      CALL    _CALSLT
                                
0007B9 47B9 ED53D5F2        20      LD  (_BUF_X),DE
                                
       47BD                     RCP_PARAM2:
0007BD 47BD 23               6      INC HL
0007BE 47BE 7E               7      LD  A,(HL)
0007BF 47BF FE20             7      CP  020H
0007C1 47C1 28FA            12      JR  Z,RCP_PARAM2
0007C3 47C3 FE2C             7      CP  ','
0007C5 47C5 28F6            12      JR  Z,RCP_PARAM2
                                
0007C7 47C7 DD212F54        14      LD  IX,FRMQNT
0007CB 47CB FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007CF 47CF CD1C00          17      CALL    _CALSLT
                                
0007D2 47D2 3AF6FA          13      LD  A,(ACPAGE)
0007D5 47D5 57               4      LD  D,A
0007D6 47D6 ED53D7F2        20      LD  (_BUF_Y),DE
       47DA                     RCP_PARAM3:
0007DA 47DA 23               6      INC HL
0007DB 47DB 7E               7      LD  A,(HL)
0007DC 47DC FE20             7      CP  020H
0007DE 47DE 28FA            12      JR  Z,RCP_PARAM3
0007E0 47E0 FE29             7      CP  ')'
0007E2 47E2 28F6            12      JR  Z,RCP_PARAM3
0007E4 47E4 FE2C             7      CP  ','
0007E6 47E6 2033            12      JR  NZ,RCP_ST
                                
0007E8 47E8 23               6      INC HL
0007E9 47E9 DD212F54        14      LD  IX,FRMQNT
0007ED 47ED FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
0007F1 47F1 CD1C00          17      CALL    _CALSLT
                                
0007F4 47F4 7B               4      LD  A,E
0007F5 47F5 32D8F2          13      LD  (_BUF_P),A
                                
       47F8                     RCP_PARAM4:
0007F8 47F8 7E               7      LD  A,(HL)
0007F9 47F9 23               6      INC HL
0007FA 47FA FE20             7      CP  020H
0007FC 47FC 28FA            12      JR  Z,RCP_PARAM4
                                
0007FE 47FE FE2C             7      CP  ','
000800 4800 2019            12      JR  NZ,RCP_ST
                                
000802 4802 7E               7      LD  A,(HL)
000803 4803 0604             7      LD  B,4
000805 4805 FEC3             7      CP  0C3H        ;PRESET
000807 4807 280E            12      JR  Z,RCP_LO
000809 4809 05               4      DEC B       ;3
00080A 480A D6F8             7      SUB 0F8H        ;XOR
00080C 480C 2809            12      JR  Z,RCP_LO
00080E 480E 05               4      DEC B       ;2
00080F 480F 3C               4      INC A       ;OR
000810 4810 2805            12      JR  Z,RCP_LO
000812 4812 05               4      DEC B       ;1
000813 4813 3C               4      INC A       ;AND
000814 4814 2801            12      JR  Z,RCP_LO
000816 4816 05               4      DEC B       ;0
                                                ;PSET
       4817                     RCP_LO:
000817 4817 78               4      LD  A,B
000818 4818 32CCF2          13      LD  (_BUF_LO),A
       481B                     RCP_ST:
00081B 481B 2AC6F6          16      LD  HL,(STREND)
00081E 481E 22C7F2          16      LD  (_DTA),HL
000821 4821 EB               4      EX  DE,HL
000822 4822 2100FE          10      LD  HL,-512
000825 4825 39              11      ADD HL,SP
000826 4826 AF               4      XOR A
000827 4827 ED52            15      SBC HL,DE
000829 4829 3008            12      JR  NC,RCP0
00082B 482B 215EF5          10      LD  HL,BUF
00082E 482E 22C7F2          16      LD  (_DTA),HL
000831 4831 6F               4      LD  L,A ;0
000832 4832 67               4      LD  H,A ;0
       4833                     RCP0:
000833 4833 24               4      INC H
000834 4834 22CFF2          16      LD  (_BUF_EN),HL
       4837                     RCP1:
000837 4837 F3               4      DI
000838 4838 CD0C49          17      CALL    WAIT_VDP
                                
00083B 483B 3A0700          13      LD  A,(WRVDP)
00083E 483E 4F               4      LD  C,A
00083F 483F 0C               4      INC C       ;C := PORT#1's address(WR)
000840 4840 3E24             7      LD  A,36
000842 4842 ED79            12      OUT (C),A
000844 4844 3E91             7      LD  A,080H+17
000846 4846 ED79            12      OUT (C),A       ;R#17 := 36
                                
000848 4848 0C               4      INC C
000849 4849 0C               4      INC C       ;C := PORT#3's address(WR)
00084A 484A 2AD5F2          16      LD  HL,(_BUF_X)
00084D 484D ED69            12      OUT (C),L       ;R#36 DX
00084F 484F ED61            12      OUT (C),H       ;R#37
000851 4851 2AD7F2          16      LD  HL,(_BUF_Y)
000854 4854 ED69            12      OUT (C),L       ;R#38 DY
000856 4856 ED61            12      OUT (C),H       ;R#39
000858 4858 2AD1F2          16      LD  HL,(_BUF_W)
00085B 485B ED69            12      OUT (C),L       ;R#40 NX
00085D 485D ED61            12      OUT (C),H       ;R#41
00085F 485F 2AD3F2          16      LD  HL,(_BUF_H)
000862 4862 ED69            12      OUT (C),L       ;R#42 NY
000864 4864 ED61            12      OUT (C),H       ;R#43
                                
000866 4866 DD2AAFFC        20      LD  IX,(SCRMOD)
00086A 486A 3ACCF2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
00086D 486D B7               4      OR  A
00086E 486E 2022            12      JR  NZ,USE_LMMC ;PSETじゃない場合はLMMC
                                
000870 4870 DD7D             9      LD  A,IXL
000872 4872 FE08             7      CP  8
000874 4874 2817            12      JR  Z,USE_HMMC8 ;スクリーン8でPSET
000876 4876 FE06             7      CP  6
000878 4878 2AD5F2          16      LD  HL,(_BUF_X)
00087B 487B 3AD1F2          13      LD  A,(_BUF_W)
00087E 487E 2005            12      JR  NZ,SCR57
000880 4880 B5               4      OR  L       ;スクリーン6
000881 4881 E603             7      AND 3
000883 4883 200D            12      JR  NZ,USE_LMMC
       4885                     SCR57:              ;スクリーン5,7
000885 4885 B5               4      OR  L
000886 4886 E601             7      AND 1
000888 4888 2008            12      JR  NZ,USE_LMMC
       488A                     USE_HMMC:
00088A 488A DD2E08          10      LD  IXL,8
       488D                     USE_HMMC8:
00088D 488D 3EF0             7      LD  A,0F0H      ;R#46 HMMC command
00088F 488F 32CCF2          13      LD  (_BUF_LO),A
       4892                     USE_LMMC:
000892 4892 110000          10      LD  DE,0
000895 4895 06FF             7      LD  B,-1
000897 4897 CD3749          17      CALL    GET_PIXEL
00089A 489A ED79            12      OUT (C),A       ;R#44 first DATA
00089C 489C 3AD9F2          13      LD  A,(_BUF_O)
00089F 489F ED79            12      OUT (C),A       ;R#45 DIX and DIY
                                
0008A1 48A1 3ACCF2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0008A4 48A4 F6B0             7      OR  0B0H        ;R#46 LMMC command
0008A6 48A6 ED79            12      OUT (C),A
                                
0008A8 48A8 FD69             9      LD  IYL,C       ;IYL := PORT#3's address(WR)
0008AA 48AA 0D               4      DEC C
0008AB 48AB 0D               4      DEC C       ;C := PORT#1's address(WR)
0008AC 48AC 3EAC             7      LD  A,080H+44
0008AE 48AE ED79            12      OUT (C),A
0008B0 48B0 3E91             7      LD  A,080H+17
0008B2 48B2 ED79            12      OUT (C),A       ;R#17 := 44
                                
0008B4 48B4 3A0600          13      LD  A,(RDVDP)
0008B7 48B7 3C               4      INC A
0008B8 48B8 FD67             9      LD  IYH,A       ;IYX := PORT#1's address(RD)
0008BA 48BA 3E02             7      LD  A,2
0008BC 48BC ED79            12      OUT (C),A
0008BE 48BE 3E8F             7      LD  A,08FH
0008C0 48C0 ED79            12      OUT (C),A
0008C2 48C2 3ACCF2          13      LD  A,(_BUF_LO) ;LOGICAL OPERATION
0008C5 48C5 E640             7      AND 040H
0008C7 48C7 201C            12      JR  NZ,LOOP_HMMC
       48C9                     LOOP_COPY:
0008C9 48C9 CD3749          17      CALL    GET_PIXEL
0008CC 48CC 08               4      EX  AF,AF'
0008CD 48CD FD4C             9      LD  C,IYH
       48CF                     LOOP_COPY1:
0008CF 48CF ED78            12      IN  A,(C)
0008D1 48D1 0F               4      RRCA            ;RRCAではサインフラグは変化しない
0008D2 48D2 300A            12      JR  NC,EXIT_COPY    ;check CE bit
0008D4 48D4 F2CF48          10      JP  P,LOOP_COPY1    ;check TR bit
0008D7 48D7 08               4      EX  AF,AF'
0008D8 48D8 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
0008DA 48DA ED79            12      OUT (C),A
0008DC 48DC 18EB            12      JR  LOOP_COPY
                                
       48DE                     EXIT_COPY:
0008DE 48DE CD1449          17      CALL    GET_STATUS_0
0008E1 48E1 FB               4      EI
0008E2 48E2 C38946          10      JP  ROM_NEXT
                                
       48E5                     LOOP_HMMC:
0008E5 48E5 FD4D             9      LD  C,IYL       ;IYL := PORT#3's address(WR)
0008E7 48E7 43               4      LD  B,E
0008E8 48E8 7B               4      LD  A,E
0008E9 48E9 B7               4      OR  A
0008EA 48EA 2802            12      JR  Z,LOOP_HMMC1
0008EC 48EC EDB3                    OTIR
       48EE                     LOOP_HMMC1:
0008EE 48EE 14               4      INC D
       48EF                     LOOP_HMMC2:
0008EF 48EF 15               4      DEC D
0008F0 48F0 2805            12      JR  Z,LOOP_HMMC3
0008F2 48F2 EDB3                    OTIR
0008F4 48F4 C3EF48          10      JP  LOOP_HMMC2
       48F7                     LOOP_HMMC3:
0008F7 48F7 ED78            12      IN  A,(C)
0008F9 48F9 0F               4      RRCA
0008FA 48FA 30E2            12      JR  NC,EXIT_COPY    ;check CE bit
0008FC 48FC 2ACFF2          16      LD  HL,(_BUF_EN)
0008FF 48FF CD7E49          17      CALL    ROM_READ
000902 4902 EB               4      EX  DE,HL
000903 4903 2AC7F2          16      LD  HL,(_DTA)
000906 4906 7A               4      LD  A,D
000907 4907 B3               4      OR  E
000908 4908 20DB            12      JR  NZ,LOOP_HMMC
00090A 490A 18C3            12      JR  LOOP_COPY1
                                    
       490C                     WAIT_VDP:
00090C 490C 3E02             7      LD  A,2
00090E 490E CD1549          17      CALL    GET_STATUS
000911 4911 0F               4      RRCA
000912 4912 38F8            12      JR  C,WAIT_VDP
       4914                     GET_STATUS_0:
000914 4914 AF               4      XOR A
       4915                     GET_STATUS:
000915 4915 C5              11      PUSH    BC
000916 4916 ED4B0600        20      LD  BC,(RDVDP)
00091A 491A 0C               4      INC C
00091B 491B ED79            12      OUT (C),A
00091D 491D 3E8F             7      LD  A,08FH
00091F 491F ED79            12      OUT (C),A
000921 4921 ED78            12      IN  A,(C)
000923 4923 C1              10      POP BC
000924 4924 C9              10      RET
                                
       4925                     GET_PIXEL256:
000925 4925 7A               4      LD  A,D
000926 4926 B3               4      OR  E
000927 4927 200A            12      JR  NZ,GET_PIXEL1
000929 4929 2ACFF2          16      LD  HL,(_BUF_EN)
00092C 492C CD7E49          17      CALL    ROM_READ
00092F 492F EB               4      EX  DE,HL
000930 4930 2AC7F2          16      LD  HL,(_DTA)
       4933                     GET_PIXEL1:
000933 4933 7E               7      LD  A,(HL)
000934 4934 23               6      INC HL
000935 4935 1B               6      DEC DE
000936 4936 C9              10      RET
                                
       4937                     GET_PIXEL:
000937 4937 04               4      INC B
000938 4938 DD7D             9      LD  A,IXL
00093A 493A FE08             7      CP  8
00093C 493C 28E7            12      JR  Z,GET_PIXEL256
00093E 493E FE06             7      CP  6
000940 4940 282E            12      JR  Z,GET_PIXEL4
                                
000942 4942 CB40             8      BIT 0,B
000944 4944 20ED            12      JR  NZ,GET_PIXEL1
                                
000946 4946 7A               4      LD  A,D
000947 4947 B3               4      OR  E
000948 4948 200A            12      JR  NZ,GET_PIXEL2
                                
00094A 494A 2ACFF2          16      LD  HL,(_BUF_EN)
00094D 494D CD7E49          17      CALL    ROM_READ
000950 4950 EB               4      EX  DE,HL
000951 4951 2AC7F2          16      LD  HL,(_DTA)
                                
       4954                     GET_PIXEL2:
000954 4954 7E               7      LD  A,(HL)
000955 4955 0F               4      RRCA
000956 4956 0F               4      RRCA
000957 4957 0F               4      RRCA
000958 4958 0F               4      RRCA
000959 4959 C9              10      RET
                                
       495A                     GET_PIXEL3:
00095A 495A 7A               4      LD  A,D
00095B 495B B3               4      OR  E
00095C 495C 200A            12      JR  NZ,GET_PIXEL5
                                
00095E 495E 2ACFF2          16      LD  HL,(_BUF_EN)
000961 4961 CD7E49          17      CALL    ROM_READ
000964 4964 EB               4      EX  DE,HL
000965 4965 2AC7F2          16      LD  HL,(_DTA)
       4968                     GET_PIXEL5:
000968 4968 7E               7      LD  A,(HL)
000969 4969 0F               4      RRCA
00096A 496A 0F               4      RRCA
00096B 496B 0F               4      RRCA
00096C 496C 0F               4      RRCA
00096D 496D 0F               4      RRCA
00096E 496E 0F               4      RRCA
00096F 496F C9              10      RET
                                
       4970                     GET_PIXEL4:
000970 4970 78               4      LD  A,B
000971 4971 E603             7      AND 3   ;+0
000973 4973 28E5            12      JR  Z,GET_PIXEL3
000975 4975 3D               4      DEC A   ;+1
000976 4976 28DC            12      JR  Z,GET_PIXEL2
000978 4978 3D               4      DEC A   ;+2
000979 4979 7E               7      LD  A,(HL)
00097A 497A C0              11      RET NZ
00097B 497B 0F               4      RRCA        ;+3
00097C 497C 0F               4      RRCA
00097D 497D C9              10      RET
                                
       497E                     ROM_READ:
00097E 497E E5              11      PUSH    HL
00097F 497F D5              11      PUSH    DE
000980 4980 C5              11      PUSH    BC
000981 4981 FDE5            15      PUSH    IY
000983 4983 22E3F2          16      LD  (LEFTX),HL
000986 4986 2AC7F2          16      LD  HL,(_DTA)
000989 4989 22DAF2          16      LD  (DTAX),HL
00098C 498C 2AE3F2          16      LD  HL,(LEFTX)
                                
00098F 498F CD1A4C          17      CALL    RBX1
000992 4992 3870            12      JR  C,RBRERR1
000994 4994 79               4      LD  A,C
000995 4995 EB               4      EX  DE,HL
000996 4996 ED52            15      SBC HL,DE       ;CP 0HL,CDE
000998 4998 19              11      ADD HL,DE
000999 4999 DE00             7      SBC A,000H
00099B 499B 3801            12      JR  C,RBR1
00099D 499D EB               4      EX  DE,HL
       499E                     RBR1:
00099E 499E 9F               4      SBC A,A
00099F 499F E601             7      AND 1
0009A1 49A1 32B6F2          13      LD  (_RESULT),A
0009A4 49A4 7C               4      LD  A,H
0009A5 49A5 B5               4      OR  L
0009A6 49A6 CAFA49          10      JP  Z,RBREND0
                                
0009A9 49A9 22C3F2          16      LD  (_LEFT),HL  ;Read record byte
0009AC 49AC 22E3F2          16      LD  (LEFTX),HL
                                
0009AF 49AF CD434C          17      CALL    RBX2
0009B2 49B2 281A            12      JR  Z,RBRB
                                                ;先頭の端数
0009B4 49B4 CD564C          17      CALL    RBXA
0009B7 49B7 DA104A          10      JP  C,RBRERR
0009BA 49BA C5              11      PUSH    BC
0009BB 49BB CD0544          17      CALL    ROM_LDIR
0009BE 49BE ED53DAF2        20      LD  (DTAX),DE
0009C2 49C2 2AE3F2          16      LD  HL,(LEFTX)
0009C5 49C5 D1              10      POP DE
0009C6 49C6 A7               4      AND A
0009C7 49C7 ED52            15      SBC HL,DE
0009C9 49C9 22E3F2          16      LD  (LEFTX),HL
0009CC 49CC 2829            12      JR  Z,RBREND
                                
       49CE                     RBRB:
0009CE 49CE CD8F4C          17      CALL    RBXB
0009D1 49D1 2818            12      JR  Z,RBRC
       49D3                     RBRB1:
0009D3 49D3 C5              11      PUSH    BC
0009D4 49D4 D5              11      PUSH    DE
0009D5 49D5 CD374D          17      CALL    CLUST
0009D8 49D8 EB               4      EX  DE,HL
0009D9 49D9 ED4BB9F2        20      LD  BC,(CLSZ)       ;1クラスタのサイズ
0009DD 49DD CD0544          17      CALL    ROM_LDIR
0009E0 49E0 EB               4      EX  DE,HL
0009E1 49E1 D1              10      POP DE
0009E2 49E2 C1              10      POP BC
0009E3 49E3 CD144D          17      CALL    GNCL
0009E6 49E6 DA104A          10      JP  C,RBRERR
0009E9 49E9 10E8            13      DJNZ    RBRB1
       49EB                     RBRC:
0009EB 49EB CDA74C          17      CALL    RBXC
0009EE 49EE 2807            12      JR  Z,RBREND
                                
0009F0 49F0 CD374D          17      CALL    CLUST
0009F3 49F3 EB               4      EX  DE,HL
0009F4 49F4 CD0544          17      CALL    ROM_LDIR
       49F7                     RBREND:
0009F7 49F7 CDB34C          17      CALL    RBXEND
       49FA                     RBREND0:
0009FA 49FA FDE1            14      POP IY
0009FC 49FC C1              10      POP BC
0009FD 49FD D1              10      POP DE
0009FE 49FE F1              10      POP AF  ;(HL)
0009FF 49FF AF               4      XOR A
000A00 4A00 3AB6F2          13      LD  A,(_RESULT)
000A03 4A03 C9              10      RET
                                
       4A04                     RBRERR1:
000A04 4A04 3E01             7      LD  A,001H
       4A06                     RBRERR2:
000A06 4A06 FDE1            14      POP IY
000A08 4A08 C1              10      POP BC
000A09 4A09 D1              10      POP DE
000A0A 4A0A E1              10      POP HL
000A0B 4A0B 37               4      SCF
000A0C 4A0C 210000          10      LD  HL,0
000A0F 4A0F C9              10      RET
       4A10                     RBRERR:
000A10 4A10 3EFF             7      LD  A,0FFH
000A12 4A12 18F2            12      JR  RBRERR2
                                
       4A14                     FILE_DD:
000A14 4A14 E1              10      POP HL
000A15 4A15 3E                      DB  03EH
000A16 4A16 C9              10      RET
000A17 4A17 32A3F2          13      LD  (SWC_BLOAD_M),A
       4A1A                     ROM_ORG:
000A1A 4A1A 2AE5F2          16      LD  HL,(PARAM0)
000A1D 4A1D 7E               7      LD  A,(HL)
000A1E 4A1E C9              10      RET
       4A1F                     FILE_B:
000A1F 4A1F AF               4      XOR A
000A20 4A20 32EBF2          13      LD  (FDRV),A
000A23 4A23 1E00             7      LD  E,0
000A25 4A25 3A63F6          13      LD  A,(VALTYP)
000A28 4A28 FE03             7      CP  3       ;string
000A2A 4A2A C2AF4A          10      JP  NZ,FILED
                                
000A2D 4A2D DD21D067        14      LD  IX,FRESTR
000A31 4A31 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000A35 4A35 CD1C00          17      CALL    _CALSLT
000A38 4A38 E5              11      PUSH    HL
000A39 4A39 DDE1            14      POP IX
                                
000A3B 4A3B DD5E00          19      LD  E,(IX+0)
000A3E 4A3E DD7E01          19      LD  A,(IX+1)
000A41 4A41 DD5602          19      LD  D,(IX+2)
000A44 4A44 DD62             9      LD  IXH,D
000A46 4A46 DD6F             9      LD  IXL,A
000A48 4A48 7B               4      LD  A,E
       4A49                     FILE_BDOS:
000A49 4A49 FE04             7      CP  4
000A4B 4A4B 3808            12      JR  C,FILEB1
000A4D 4A4D DD7E03          19      LD  A,(IX+3)
000A50 4A50 FE3A             7      CP  ':'
000A52 4A52 28C0            12      JR  Z,FILE_DD
000A54 4A54 7B               4      LD  A,E
       4A55                     FILEB1:
000A55 4A55 FE02             7      CP  2
000A57 4A57 3818            12      JR  C,DEVI1
000A59 4A59 DD7E01          19      LD  A,(IX+1)
000A5C 4A5C FE3A             7      CP  ':'
000A5E 4A5E 2011            12      JR  NZ,DEVI1
000A60 4A60 DD7E00          19      LD  A,(IX+0)        ;DRIVE
000A63 4A63 CD884B          17      CALL    CAP
000A66 4A66 D640             7      SUB '@'
000A68 4A68 DD23            10      INC IX
000A6A 4A6A DD23            10      INC IX
000A6C 4A6C 1D               4      DEC E
000A6D 4A6D 1D               4      DEC E
000A6E 4A6E 32EBF2          13      LD  (FDRV),A
       4A71                     DEVI1:
000A71 4A71 DD7E00          19      LD  A,(IX+0)
000A74 4A74 D65C             7      SUB 05CH        ;\
000A76 4A76 2008            12      JR  NZ,NOROOT
000A78 4A78 6F               4      LD  L,A
000A79 4A79 67               4      LD  H,A
000A7A 4A7A 22E9F2          16      LD  (_CDX),HL
000A7D 4A7D DD23            10      INC IX
000A7F 4A7F 1D               4      DEC E
       4A80                     NOROOT:
                                
       4A80                     SETDIR:
000A80 4A80 CDAF4A          17      CALL    FILED
000A83 4A83 DD7E00          19      LD  A,(IX+0)
000A86 4A86 FE5C             7      CP  05CH        ;\
000A88 4A88 C0              11      RET NZ
000A89 4A89 DD23            10      INC IX
000A8B 4A8B 1D               4      DEC E
000A8C 4A8C 3AECF2          13      LD  A,(FNAME)
000A8F 4A8F FE20             7      CP  020H        ;. の処理
000A91 4A91 28ED            12      JR  Z,SETDIR
                                
000A93 4A93 CD9E4B          17      CALL    ROM_OPEN
000A96 4A96 B7               4      OR  A
000A97 4A97 C0              11      RET NZ
                                
000A98 4A98 FD2AE0F2        20      LD  IY,(DIRENT1)
000A9C 4A9C FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
000AA0 4AA0 C8              11      RET Z
000AA1 4AA1 CDF64A          17      CALL    FILEI
000AA4 4AA4 FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000AA7 4AA7 FD661B          19      LD  H,(IY+01BH)
000AAA 4AAA 22E9F2          16      LD  (_CDX),HL
000AAD 4AAD 18D1            12      JR  SETDIR
                                
       4AAF                     FILED:
000AAF 4AAF CDF64A          17      CALL    FILEI
000AB2 4AB2 21ECF2          10      LD  HL,FNAME
                                
000AB5 4AB5 0608             7      LD  B,8
       4AB7                     FILE2:
000AB7 4AB7 CD034B          17      CALL    CCHKF
000ABA 4ABA C8              11      RET Z
000ABB 4ABB FE2A             7      CP  '*'
000ABD 4ABD 282E            12      JR  Z,FILE9
000ABF 4ABF FE2E             7      CP  '.'
000AC1 4AC1 280C            12      JR  Z,FILE4
000AC3 4AC3 77               7      LD  (HL),A
000AC4 4AC4 23               6      INC HL
000AC5 4AC5 10F0            13      DJNZ    FILE2
                                
       4AC7                     FILE3:
000AC7 4AC7 CD034B          17      CALL    CCHKF
000ACA 4ACA C8              11      RET Z
000ACB 4ACB FE2E             7      CP  '.'
000ACD 4ACD 20F8            12      JR  NZ,FILE3
                                
       4ACF                     FILE4:
000ACF 4ACF 21F4F2          10      LD  HL,FNAME+8
000AD2 4AD2 0603             7      LD  B,3
                                
       4AD4                     FILE4L:
000AD4 4AD4 CD034B          17      CALL    CCHKF
000AD7 4AD7 C8              11      RET Z
000AD8 4AD8 FE2E             7      CP  '.'
000ADA 4ADA 2008            12      JR  NZ,FILE12
000ADC 4ADC 32ECF2          13      LD  (FNAME),A   ;Parent directory(..)
000ADF 4ADF 32EDF2          13      LD  (FNAME+1),A
000AE2 4AE2 3E20             7      LD  A,020H
       4AE4                     FILE12:
000AE4 4AE4 FE2A             7      CP  '*'
000AE6 4AE6 280A            12      JR  Z,FILE10
000AE8 4AE8 77               7      LD  (HL),A
000AE9 4AE9 23               6      INC HL
000AEA 4AEA 10E8            13      DJNZ    FILE4L
000AEC 4AEC C9              10      RET
                                
       4AED                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000AED 4AED CDF24A          17      CALL    FILE10
000AF0 4AF0 18D5            12      JR  FILE3
                                
       4AF2                     FILE10:
000AF2 4AF2 3E3F             7      LD  A,'?'
000AF4 4AF4 1808            12      JR  FILL_MEMORY
       4AF6                     FILEI:              ;名前＋拡張子をスペースで初期化
000AF6 4AF6 3E20             7      LD  A,020H
000AF8 4AF8 01000B          10      LD  BC,11*256   ;C=0にしておく
000AFB 4AFB 21ECF2          10      LD  HL,FNAME
       4AFE                     FILL_MEMORY:            ;HLからBバイトAで埋める
000AFE 4AFE 77               7      LD  (HL),A
000AFF 4AFF 23               6      INC HL
000B00 4B00 10FC            13      DJNZ    FILL_MEMORY
000B02 4B02 C9              10      RET
                                
       4B03                     CCHKF:
000B03 4B03 7B               4      LD  A,E
000B04 4B04 B7               4      OR  A
000B05 4B05 C8              11      RET Z
000B06 4B06 DD7E00          19      LD  A,(IX+0)
000B09 4B09 CD104B          17      CALL    CCHK2
000B0C 4B0C C8              11      RET Z
000B0D 4B0D C3734B          10      JP  FKAN
                                
       4B10                     CCHK2:
000B10 4B10 0C               4      INC C
000B11 4B11 0D               4      DEC C
000B12 4B12 C0              11      RET NZ
       4B13                     CCHK3:              ;ZF=1 で使えない文字
000B13 4B13 FE2B             7      CP  '+'
000B15 4B15 C8              11      RET Z
000B16 4B16 FE2C             7      CP  ','
000B18 4B18 C8              11      RET Z
000B19 4B19 FE2F             7      CP  '/'
000B1B 4B1B C8              11      RET Z
000B1C 4B1C FE3A             7      CP  ':'
000B1E 4B1E C8              11      RET Z
000B1F 4B1F FE3B             7      CP  ';'
000B21 4B21 C8              11      RET Z
000B22 4B22 FE3D             7      CP  '='
000B24 4B24 C8              11      RET Z
000B25 4B25 FE5C             7      CP  05CH    ;\
000B27 4B27 C8              11      RET Z
000B28 4B28 FE1F             7      CP  01FH
000B2A 4B2A D0              11      RET NC
000B2B 4B2B BF               4      CP  A       ;Z=1
000B2C 4B2C C9              10      RET
                                
       4B2D                     SS1:
000B2D 4B2D 13               6      INC DE
       4B2E                     SPCUT:              ;スペースをカット
000B2E 4B2E 1A               7      LD  A,(DE)
000B2F 4B2F FE20             7      CP  020H
000B31 4B31 28FA            12      JR  Z,SS1
000B33 4B33 C9              10      RET
                                
       4B34                     SCREOF1:
000B34 4B34 13               6      INC DE
       4B35                     SPCUTEX:            ;スペース改行などをカット
000B35 4B35 1A               7      LD  A,(DE)
000B36 4B36 FE20             7      CP  020H
000B38 4B38 28FA            12      JR  Z,SCREOF1
000B3A 4B3A FE0D             7      CP  00DH
000B3C 4B3C 28F6            12      JR  Z,SCREOF1
000B3E 4B3E FE0A             7      CP  00AH
000B40 4B40 28F2            12      JR  Z,SCREOF1
000B42 4B42 FE1A             7      CP  01AH
000B44 4B44 28EE            12      JR  Z,SCREOF1
000B46 4B46 C9              10      RET
                                
       4B47                     GETNUM:
000B47 4B47 210000          10      LD  HL,0
       4B4A                     GETNUM1:
000B4A 4B4A 1A               7      LD  A,(DE)
000B4B 4B4B 13               6      INC DE
000B4C 4B4C D630             7      SUB '0'
000B4E 4B4E D8              11      RET C
000B4F 4B4F FE0A             7      CP  10
000B51 4B51 D0              11      RET NC
000B52 4B52 4D               4      LD  C,L
000B53 4B53 44               4      LD  B,H
000B54 4B54 29              11      ADD HL,HL   ;*2
000B55 4B55 29              11      ADD HL,HL   ;*4
000B56 4B56 09              11      ADD HL,BC   ;*5
000B57 4B57 29              11      ADD HL,HL   ;*10
000B58 4B58 4F               4      LD  C,A
000B59 4B59 0600             7      LD  B,0
000B5B 4B5B 09              11      ADD HL,BC
000B5C 4B5C 18EC            12      JR  GETNUM1
                                
       4B5E                     SEARCH_END:
000B5E 4B5E 7E               7      LD  A,(HL)
       4B5F                     SEARCH_END1:
000B5F 4B5F 23               6      INC HL
000B60 4B60 B7               4      OR  A
000B61 4B61 C8              11      RET Z
000B62 4B62 FE3A             7      CP  ':'
000B64 4B64 20F8            12      JR  NZ,SEARCH_END
000B66 4B66 7E               7      LD  A,(HL)
000B67 4B67 FE3A             7      CP  ':'
000B69 4B69 28F4            12      JR  Z,SEARCH_END1
000B6B 4B6B C9              10      RET
                                
       4B6C                     FKANC:
000B6C 4B6C CB41             8      BIT 0,C
000B6E 4B6E CC914B          17      CALL    Z,CAP2
000B71 4B71 1803            12      JR  FKANX
       4B73                     FKAN:           ;漢字チェック
000B73 4B73 DD23            10      INC IX
000B75 4B75 1D               4      DEC E
       4B76                     FKANX:
000B76 4B76 CB41             8      BIT 0,C
000B78 4B78 CB81             8      RES 0,C
000B7A 4B7A C0              11      RET NZ
000B7B 4B7B FE80             7      CP  080H
000B7D 4B7D D8              11      RET C
000B7E 4B7E FEA0             7      CP  0A0H
000B80 4B80 3803            12      JR  C,FKAN1
000B82 4B82 FEE0             7      CP  0E0H
000B84 4B84 D8              11      RET C
       4B85                     FKAN1:
000B85 4B85 0C               4      INC C
000B86 4B86 A7               4      AND A
000B87 4B87 C9              10      RET
                                
       4B88                     CAP:
000B88 4B88 FE61             7      CP  'a'
000B8A 4B8A D8              11      RET C
000B8B 4B8B FE7B             7      CP  'z'+1
000B8D 4B8D D0              11      RET NC
000B8E 4B8E D620             7      SUB 020H
000B90 4B90 C9              10      RET
       4B91                     CAP2:
000B91 4B91 CD884B          17      CALL    CAP
       4B94                     CAP3:               ;
000B94 4B94 FE05             7      CP  5
000B96 4B96 2803            12      JR  Z,CAP4
000B98 4B98 FE21             7      CP  021H
000B9A 4B9A C9              10      RET
       4B9B                     CAP4:
000B9B 4B9B 3EE5             7      LD  A,0E5H
000B9D 4B9D C9              10      RET
                                
       4B9E                     ROM_OPEN:
000B9E 4B9E CDB150          17      CALL    GET_DISK_BANK_FDRV
                                
000BA1 4BA1 CDF04D          17      CALL    GET_DIR_DAT
000BA4 4BA4 D5              11      PUSH    DE
000BA5 4BA5 CDBA4B          17      CALL    FILESE
000BA8 4BA8 D1              10      POP DE
000BA9 4BA9 3F               4      CCF
000BAA 4BAA D8              11      RET C
000BAB 4BAB 22E0F2          16      LD  (DIRENT1),HL
000BAE 4BAE E5              11      PUSH    HL
000BAF 4BAF 210000          10      LD  HL,0
000BB2 4BB2 22BDF2          16      LD  (RR_LOW),HL
000BB5 4BB5 22BFF2          16      LD  (RR_HIGH),HL
000BB8 4BB8 E1              10      POP HL
000BB9 4BB9 C9              10      RET
                                
       4BBA                     FILESE:
000BBA 4BBA 7E               7      LD  A,(HL)
000BBB 4BBB B7               4      OR  A
000BBC 4BBC C8              11      RET Z       ;END:ZF=1 CF=0
000BBD 4BBD FEE5             7      CP  0E5H
000BBF 4BBF 280D            12      JR  Z,FILESE1
000BC1 4BC1 11ECF2          10      LD  DE,FNAME
000BC4 4BC4 E5              11      PUSH    HL
000BC5 4BC5 CDF44B          17      CALL    CPFILE
000BC8 4BC8 CC154C          17      CALL    Z,CPFILE2
000BCB 4BCB E1              10      POP HL
000BCC 4BCC 37               4      SCF
000BCD 4BCD C8              11      RET Z       ;!!!:(ZF=1) CF=1
       4BCE                     FILESE1:
000BCE 4BCE CDD64B          17      CALL    FNEXT
000BD1 4BD1 20E7            12      JR  NZ,FILESE
000BD3 4BD3 F6FF             7      OR  0FFH        ;ZF=0 CF=0
000BD5 4BD5 C9              10      RET
                                
       4BD6                     FNEXT:
000BD6 4BD6 112000          10      LD  DE,020H
000BD9 4BD9 19              11      ADD HL,DE
000BDA 4BDA ED5BE9F2        20      LD  DE,(_CDX)
000BDE 4BDE 7A               4      LD  A,D
000BDF 4BDF B3               4      OR  E
000BE0 4BE0 2002            12      JR  NZ,FNEXT_SUBDIR
000BE2 4BE2 0D               4      DEC C
                                #if exists USE_NORMAL_32K_ROM
                                #else
                                CHECK_DIR_PAGE:         ;ディレクトリが2ページ目に跨るかチェックする
                                    PUSH    AF      ;※フラグを保存する必要あり
                                    BIT 7,H
                                    JR  Z,CHECK_DIR_PAGE1
                                    LD  A,H
                                    SUB 020H
                                    LD  H,A
                                    LD  A,(_DIR_BANK)
                                    INC A
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_DIR_BANK),A
                                CHECK_DIR_PAGE1:
                                    POP AF
                                #endif
000BE3 4BE3 C9              10      RET
                                
       4BE4                     FNEXT_SUBDIR:           ;サブディレクトリ
000BE4 4BE4 0D               4      DEC C
000BE5 4BE5 C0              11      RET NZ
                                
000BE6 4BE6 ED5BE9F2        20      LD  DE,(_CDX)
000BEA 4BEA CD144D          17      CALL    GNCL
000BED 4BED EB               4      EX  DE,HL
000BEE 4BEE 22E9F2          16      LD  (_CDX),HL
000BF1 4BF1 C3284E          10      JP  GET_SUBDIR
                                
       4BF4                     CPFILE:
000BF4 4BF4 C5              11      PUSH    BC
000BF5 4BF5 01000B          10      LD  BC,00B00H
       4BF8                     CPSTR1:
000BF8 4BF8 1A               7      LD  A,(DE)
000BF9 4BF9 FE3F             7      CP  '?'     ;Wild card
000BFB 4BFB 2812            12      JR  Z,CPSTR2
000BFD 4BFD 7E               7      LD  A,(HL)
000BFE 4BFE CD6C4B          17      CALL    FKANC
000C01 4C01 E5              11      PUSH    HL
000C02 4C02 67               4      LD  H,A
000C03 4C03 1A               7      LD  A,(DE)
000C04 4C04 CB01             4      RLC C
000C06 4C06 CD6C4B          17      CALL    FKANC
000C09 4C09 CB09             4      RRC C
000C0B 4C0B BC               4      CP  H       ;CP (HL),(DE)
000C0C 4C0C E1              10      POP HL
000C0D 4C0D 2004            12      JR  NZ,CPSTR3
       4C0F                     CPSTR2:
000C0F 4C0F 13               6      INC DE
000C10 4C10 23               6      INC HL
000C11 4C11 10E5            13      DJNZ    CPSTR1
       4C13                     CPSTR3:
000C13 4C13 C1              10      POP BC
000C14 4C14 C9              10      RET
                                
       4C15                     CPFILE2:
                                ;   LD  A,0E1H
000C15 4C15 3EF1             7      LD  A,0F1H
000C17 4C17 2F               4      CPL
000C18 4C18 A6               7      AND (HL)
000C19 4C19 C9              10      RET
                                
       4C1A                     RBX1:
000C1A 4C1A E5              11      PUSH    HL      ;Record byte
                                
000C1B 4C1B ED5BBDF2        20      LD  DE,(RR_LOW) ;CDE=Random record
000C1F 4C1F 3AC0F2          13      LD  A,(RR_HIGH+1)
000C22 4C22 4F               4      LD  C,A
                                
000C23 4C23 3AE2F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_NORMAL_32K_ROM
000C26 4C26 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000C29 4C29 FD2AE0F2        20      LD  IY,(DIRENT1)
000C2D 4C2D FD6E1C          19      LD  L,(IY+01CH) ;AHL=File size
000C30 4C30 FD661D          19      LD  H,(IY+01DH)
000C33 4C33 FD7E1E          19      LD  A,(IY+01EH)
                                
000C36 4C36 A7               4      AND A
000C37 4C37 ED52            15      SBC HL,DE
000C39 4C39 99               4      SBC A,C
000C3A 4C3A D1              10      POP DE
                                
000C3B 4C3B D8              11      RET C
000C3C 4C3C 4F               4      LD  C,A
000C3D 4C3D EB               4      EX  DE,HL   ;CDE=File byte  HL=Record byte
000C3E 4C3E B2               4      OR  D
000C3F 4C3F B3               4      OR  E
000C40 4C40 C0              11      RET NZ
000C41 4C41 37               4      SCF
000C42 4C42 C9              10      RET
                                
       4C43                     RBX2:
000C43 4C43 ED4BBEF2        20      LD  BC,(RR_LOW+1)
000C47 4C47 CDC84C          17      CALL    RWXR
000C4A 4C4A 3ABAF2          13      LD  A,(CLSZ_H)
000C4D 4C4D 3D               4      DEC A
000C4E 4C4E E5              11      PUSH    HL
000C4F 4C4F 2ABDF2          16      LD  HL,(RR_LOW)
000C52 4C52 A4               4      AND H
000C53 4C53 B5               4      OR  L
000C54 4C54 E1              10      POP HL
000C55 4C55 C9              10      RET
                                
       4C56                     RBXA:
000C56 4C56 D5              11      PUSH    DE
000C57 4C57 CD374D          17      CALL    CLUST
000C5A 4C5A ED53C5F2        20      LD  (_DTPS),DE
000C5E 4C5E D1              10      POP DE
000C5F 4C5F CD144D          17      CALL    GNCL
000C62 4C62 D8              11      RET C
000C63 4C63 ED53C1F2        20      LD  (_CLPS),DE
                                
000C67 4C67 ED4BBDF2        20      LD  BC,(RR_LOW)
000C6B 4C6B 2AB9F2          16      LD  HL,(CLSZ)
000C6E 4C6E 7C               4      LD  A,H
000C6F 4C6F 3D               4      DEC A
000C70 4C70 A0               4      AND B
000C71 4C71 47               4      LD  B,A
000C72 4C72 ED42            15      SBC HL,BC       ;remaining cluster
                                
000C74 4C74 ED5BE3F2        20      LD  DE,(LEFTX)
000C78 4C78 ED52            15      SBC HL,DE       ;CP HL,DE
000C7A 4C7A 19              11      ADD HL,DE
000C7B 4C7B 3801            12      JR  C,RBXA1
000C7D 4C7D EB               4      EX  DE,HL
       4C7E                     RBXA1:
000C7E 4C7E 3AB7F2          13      LD  A,(_BANK)   ;GNCLでバンクを切り替えたのでデータのあるバンク
                                #if exists USE_NORMAL_32K_ROM
000C81 4C81 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000C84 4C84 E5              11      PUSH    HL
000C85 4C85 2AC5F2          16      LD  HL,(_DTPS)
000C88 4C88 09              11      ADD HL,BC
000C89 4C89 ED5BDAF2        20      LD  DE,(DTAX)
000C8D 4C8D C1              10      POP BC
000C8E 4C8E C9              10      RET
                                
       4C8F                     RBXB:
000C8F 4C8F 2ADAF2          16      LD  HL,(DTAX)
000C92 4C92 ED5BC1F2        20      LD  DE,(_CLPS)
000C96 4C96 3AE4F2          13      LD  A,(LEFTX+1)
000C99 4C99 47               4      LD  B,A
000C9A 4C9A 3ABAF2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4C9D                     RBXB1:
000C9D 4C9D 1F               4      RRA     ;->CF
000C9E 4C9E 3804            12      JR  C,RBXB2
000CA0 4CA0 CB38             8      SRL B   ;B=B/2
000CA2 4CA2 18F9            12      JR  RBXB1
       4CA4                     RBXB2:
000CA4 4CA4 78               4      LD  A,B
000CA5 4CA5 B7               4      OR  A
000CA6 4CA6 C9              10      RET
                                
       4CA7                     RBXC:
000CA7 4CA7 ED4BE3F2        20      LD  BC,(LEFTX)
000CAB 4CAB 3ABAF2          13      LD  A,(CLSZ_H)
000CAE 4CAE 3D               4      DEC A
000CAF 4CAF A0               4      AND B
000CB0 4CB0 47               4      LD  B,A
000CB1 4CB1 B1               4      OR  C
000CB2 4CB2 C9              10      RET
                                
       4CB3                     RBXEND:
000CB3 4CB3 ED5BC3F2        20      LD  DE,(_LEFT)
000CB7 4CB7 2ABDF2          16      LD  HL,(RR_LOW)
000CBA 4CBA 3AC0F2          13      LD  A,(RR_HIGH+1)
000CBD 4CBD 19              11      ADD HL,DE
000CBE 4CBE CE00             7      ADC A,0
000CC0 4CC0 22BDF2          16      LD  (RR_LOW),HL
000CC3 4CC3 32C0F2          13      LD  (RR_HIGH+1),A
000CC6 4CC6 EB               4      EX  DE,HL       ;HL=Read byte
000CC7 4CC7 C9              10      RET 
                                
       4CC8                     RWXR:
000CC8 4CC8 3ABAF2          13      LD  A,(CLSZ_H)  ;1024=4 / 512=2 / 256=1
       4CCB                     L_RWX:
000CCB 4CCB 1F               4      RRA     ;->CF
000CCC 4CCC 3806            12      JR  C,E_RWX
000CCE 4CCE CB38             8      SRL B   ;BC=BC/2
000CD0 4CD0 CB19             8      RR  C   ;
000CD2 4CD2 18F7            12      JR  L_RWX
       4CD4                     E_RWX:
000CD4 4CD4 3AE2F2          13      LD  A,(_DIR_BANK)
                                #if exists USE_NORMAL_32K_ROM
000CD7 4CD7 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
000CDA 4CDA FD2AE0F2        20      LD  IY,(DIRENT1)
000CDE 4CDE FD5E1A          19      LD  E,(IY+01AH) ;ファイルの先頭クラスタ
000CE1 4CE1 FD561B          19      LD  D,(IY+01BH)
000CE4 4CE4 CDB150          17      CALL    GET_DISK_BANK_FDRV
       4CE7                     RWX1:
000CE7 4CE7 ED53C1F2        20      LD  (_CLPS),DE
000CEB 4CEB 7A               4      LD  A,D
000CEC 4CEC B3               4      OR  E
000CED 4CED 37               4      SCF
000CEE 4CEE C8              11      RET Z
                                
000CEF 4CEF 78               4      LD  A,B
000CF0 4CF0 B1               4      OR  C
000CF1 4CF1 C8              11      RET Z
                                
000CF2 4CF2 CD144D          17      CALL    GNCL
000CF5 4CF5 D8              11      RET C
000CF6 4CF6 0B               6      DEC BC
000CF7 4CF7 CD894D          17      CALL    ENDCL
000CFA 4CFA 38EB            12      JR  C,RWX1
000CFC 4CFC 37               4      SCF
000CFD 4CFD C9              10      RET
                                
       4CFE                     NCL3:
000CFE 4CFE CDB150          17      CALL    GET_DISK_BANK_FDRV
000D01 4D01 6B               4      LD  L,E
000D02 4D02 62               4      LD  H,D
000D03 4D03 CB3C             8      SRL H
000D05 4D05 CB1D             8      RR  L
000D07 4D07 1F               4      RRA
000D08 4D08 19              11      ADD HL,DE
000D09 4D09 010060          10      LD  BC,BANK1_ADR
000D0C 4D0C 09              11      ADD HL,BC
000D0D 4D0D ED4BBBF2        20      LD  BC,(SECSZ)
000D11 4D11 09              11      ADD HL,BC
000D12 4D12 17               4      RLA
000D13 4D13 C9              10      RET
                                
       4D14                     GNCL:
000D14 4D14 7A               4      LD  A,D
000D15 4D15 B3               4      OR  E
000D16 4D16 37               4      SCF
000D17 4D17 C8              11      RET Z
000D18 4D18 C5              11      PUSH    BC
000D19 4D19 E5              11      PUSH    HL
000D1A 4D1A CDFE4C          17      CALL    NCL3
000D1D 4D1D 3809            12      JR  C,GNC1
000D1F 4D1F 5E               7      LD  E,(HL)
000D20 4D20 23               6      INC HL
000D21 4D21 7E               7      LD  A,(HL)
000D22 4D22 E60F             7      AND 00FH
000D24 4D24 57               4      LD  D,A
000D25 4D25 E1              10      POP HL
000D26 4D26 C1              10      POP BC
000D27 4D27 C9              10      RET
       4D28                     GNC1:
000D28 4D28 7E               7      LD  A,(HL)
000D29 4D29 23               6      INC HL
000D2A 4D2A 56               7      LD  D,(HL)
000D2B 4D2B 0604             7      LD  B,4
       4D2D                     GNC1L:
000D2D 4D2D CB3A             8      SRL D
000D2F 4D2F 1F               4      RRA
000D30 4D30 10FB            13      DJNZ    GNC1L
                                
000D32 4D32 5F               4      LD  E,A
000D33 4D33 E1              10      POP HL
000D34 4D34 C1              10      POP BC
000D35 4D35 A7               4      AND A
000D36 4D36 C9              10      RET
                                
       4D37                     CLUST:
000D37 4D37 EB               4      EX  DE,HL
       4D38                     CLUST_HL:
000D38 4D38 C5              11      PUSH    BC
000D39 4D39 3ABAF2          13      LD  A,(CLSZ_H)
000D3C 4D3C CDDA50          17      CALL    MUL_AHL
                                
000D3F 4D3F CD0A4E          17      CALL    GET_DIR_POS
000D42 4D42 4F               4      LD  C,A
000D43 4D43 0600             7      LD  B,0
000D45 4D45 09              11      ADD HL,BC
                                
000D46 4D46 3A1260          13      LD  A,(BANK1_ADR+17+1)  ;BPB_RootEntCnt High
000D49 4D49 1F               4      RRA
000D4A 4D4A 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000D4D 4D4D 1F               4      RRA
000D4E 4D4E 0F               4      RRCA
000D4F 4D4F 0F               4      RRCA
000D50 4D50 0F               4      RRCA
000D51 4D51 4F               4      LD  C,A
                                
000D52 4D52 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000D55 4D55 FE02             7      CP  2
000D57 4D57 280C            12      JR  Z,CLUST1
000D59 4D59 CB01             4      RLC C
000D5B 4D5B 0D               4      DEC C
000D5C 4D5C 3A0C60          13      LD  A,(BANK1_ADR+11+1)  ;BPB_BytsPerSec High    
000D5F 4D5F FE02             7      CP  2
000D61 4D61 2002            12      JR  NZ,CLUST1
000D63 4D63 0D               4      DEC C
000D64 4D64 0D               4      DEC C
       4D65                     CLUST1:
000D65 4D65 0D               4      DEC C
000D66 4D66 09              11      ADD HL,BC
                                
                                #if exists USE_NORMAL_32K_ROM
000D67 4D67 7D               4      LD  A,L
000D68 4D68 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
000D6B 4D6B 09              11      ADD HL,BC
000D6C 4D6C 3013            12      JR  NC,CLUST2
000D6E 4D6E 4D               4      LD  C,L     ;C=読み出し元
000D6F 4D6F 29              11      ADD HL,HL   ;64KB→32KB
000D70 4D70 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
000D71 4D71 CDB150          17      CALL    GET_DISK_BANK_FDRV
000D74 4D74 84               4      ADD A,H
000D75 4D75 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
000D78 4D78 32B7F2          13      LD  (_BANK),A
000D7B 4D7B 69               4      LD  L,C     ;C=読み出し元
000D7C 4D7C 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
000D7E 4D7E A5               4      AND L
000D7F 4D7F C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL   ;64KB→32KB
                                    ADD HL,HL   ;32KB→16KB
                                    ADD HL,HL   ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    CALL    GET_DISK_BANK_FDRV
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  L,C     ;C=読み出し元
                                    LD  A,01FH          ;セグメントのサイズでフィルタする(8K:1F)
                                    AND L
                                #endif
       4D81                     CLUST2:
000D81 4D81 C660             7      ADD A,high BANK1_ADR
000D83 4D83 67               4      LD  H,A
000D84 4D84 2E00             7      LD  L,0
000D86 4D86 EB               4      EX  DE,HL
000D87 4D87 C1              10      POP BC
000D88 4D88 C9              10      RET
                                
       4D89                     ENDCL:
000D89 4D89 7A               4      LD  A,D ;END CLUSTER
000D8A 4D8A FE0F             7      CP  00FH    ;FAT12の最大値
000D8C 4D8C C0              11      RET NZ
000D8D 4D8D 7B               4      LD  A,E
000D8E 4D8E FEF7             7      CP  0F7H
000D90 4D90 C9              10      RET
                                
       4D91                     RB_READ:
000D91 4D91 AF               4      XOR A   ;HLA = HL*128
000D92 4D92 CB3C             8      SRL H
000D94 4D94 CB1D             8      RR  L
000D96 4D96 1F               4      RRA
000D97 4D97 32BDF2          13      LD  (RR_LOW),A
000D9A 4D9A 22BEF2          16      LD  (RR_MID),HL
000D9D 4D9D 218000          10      LD  HL,128
                                
000DA0 4DA0 CD7E49          17      CALL    ROM_READ
000DA3 4DA3 C9              10      RET
                                
       4DA4                     GETSEQ:
000DA4 4DA4 FD6E20          19      LD  L,(IY+32)
000DA7 4DA7 FD660C          19      LD  H,(IY+12)
                                
000DAA 4DAA CB25             8      SLA L
                                
000DAC 4DAC CB3C             8      SRL H
000DAE 4DAE CB1D             8      RR  L
000DB0 4DB0 C9              10      RET
                                
       4DB1                     SETSEQ:
000DB1 4DB1 F5              11      PUSH    AF
000DB2 4DB2 3ABDF2          13      LD  A,(RR_LOW)
000DB5 4DB5 2ABEF2          16      LD  HL,(RR_MID)
                                
000DB8 4DB8 CDCF4D          17      CALL    SSQ1
                                
000DBB 4DBB 29              11      ADD HL,HL
000DBC 4DBC CB3D             8      SRL L
000DBE 4DBE FD7520          19      LD  (IY+32),L
000DC1 4DC1 FD740C          19      LD  (IY+12),H
000DC4 4DC4 F1              10      POP AF
000DC5 4DC5 C9              10      RET
                                
       4DC6                     GETSIZE:
000DC6 4DC6 FD7E10          19      LD  A,(IY+16)
000DC9 4DC9 FD6E11          19      LD  L,(IY+17)
000DCC 4DCC FD6612          19      LD  H,(IY+18)
       4DCF                     SSQ1:
000DCF 4DCF 87               4      ADD A,A
000DD0 4DD0 ED6A            15      ADC HL,HL
000DD2 4DD2 B7               4      OR  A
000DD3 4DD3 C8              11      RET Z
000DD4 4DD4 23               6      INC HL
000DD5 4DD5 C9              10      RET
                                
       4DD6                     SET_FCB:
000DD6 4DD6 D5              11      PUSH    DE
000DD7 4DD7 FDE1            14      POP IY
000DD9 4DD9 FD7E1C          19      LD  A,(IY+28)
000DDC 4DDC FEFF             7      CP  0FFH
000DDE 4DDE 200C            12      JR  NZ,POPAF_SCF_FF_RET
000DE0 4DE0 E5              11      PUSH    HL
000DE1 4DE1 FD6E1A          19      LD  L,(IY+26)
000DE4 4DE4 FD661B          19      LD  H,(IY+27)
000DE7 4DE7 22C1F2          16      LD  (_CLPS),HL
000DEA 4DEA E1              10      POP HL
000DEB 4DEB C9              10      RET
                                
       4DEC                     POPAF_SCF_FF_RET:
000DEC 4DEC F1              10      POP AF
000DED 4DED 37               4      SCF
000DEE 4DEE 9F               4      SBC A,A
000DEF 4DEF C9              10      RET
                                
       4DF0                     GET_DIR_DAT:
000DF0 4DF0 2AE9F2          16      LD  HL,(_CDX)
000DF3 4DF3 7C               4      LD  A,H
000DF4 4DF4 B5               4      OR  L
000DF5 4DF5 2031            12      JR  NZ,GET_SUBDIR
000DF7 4DF7 CD0A4E          17      CALL    GET_DIR_POS
000DFA 4DFA C660             7      ADD A,high BANK1_ADR
000DFC 4DFC 2E00             7      LD  L,0
000DFE 4DFE 67               4      LD  H,A         ;HL=BANK1_ADR+(BPB_RsvdSecCnt+BPB_FATSz16*BPB_NumFATs)*BPB_BytsPerSec
                                #if exists USE_NORMAL_32K_ROM
                                #else
                                    CALL    CHECK_DIR_PAGE
                                #endif
000DFF 4DFF 3AB8F2          13      LD  A,(_BANK1)
000E02 4E02 32E2F2          13      LD  (_DIR_BANK),A
                                
000E05 4E05 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt
000E08 4E08 4F               4      LD  C,A
000E09 4E09 C9              10      RET
                                
       4E0A                     GET_DIR_POS:                ;ルートディレクトリ
000E0A 4E0A CDB150          17      CALL    GET_DISK_BANK_FDRV
000E0D 4E0D 32B8F2          13      LD  (_BANK1),A
000E10 4E10 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs
000E13 4E13 47               4      LD  B,A
000E14 4E14 3A1660          13      LD  A,(BANK1_ADR+22)    ;BPB_FATSz16
000E17 4E17 4F               4      LD  C,A
000E18 4E18 3A0E60          13      LD  A,(BANK1_ADR+14)    ;BPB_RsvdSecCnt
       4E1B                     GET_DIR_POS1:
000E1B 4E1B 81               4      ADD A,C
000E1C 4E1C 10FD            13      DJNZ    GET_DIR_POS1
                                
000E1E 4E1E ED4B0B60        20      LD  BC,(BANK1_ADR+11)   ;BPB_BytsPerSec 
       4E22                     L_MDP:
000E22 4E22 CB18             8      RR  B   ;->CF
000E24 4E24 D8              11      RET C
000E25 4E25 87               4      ADD A,A
000E26 4E26 18FA            12      JR  L_MDP
                                
       4E28                     GET_SUBDIR:             ;サブディレクトリ
000E28 4E28 CD384D          17      CALL    CLUST_HL
000E2B 4E2B EB               4      EX  DE,HL
000E2C 4E2C 3AB7F2          13      LD  A,(_BANK)
000E2F 4E2F 32E2F2          13      LD  (_DIR_BANK),A
000E32 4E32 3ABAF2          13      LD  A,(CLSZ_H)
000E35 4E35 87               4      ADD A,A     ;*2
000E36 4E36 87               4      ADD A,A     ;*4
000E37 4E37 87               4      ADD A,A     ;*8
000E38 4E38 4F               4      LD  C,A
000E39 4E39 C9              10      RET
                                
       4E3A                     STATEMENT:
000E3A 4E3A 11C84E          10      LD  DE,STR_CHDIR
000E3D 4E3D CDAE4E          17      CALL    CPPROCNM
000E40 4E40 280A            12      JR  Z,_CHDIR
000E42 4E42 11CE4E          10      LD  DE,STR_RAMDISK
000E45 4E45 CDAE4E          17      CALL    CPPROCNM
000E48 4E48 2814            12      JR  Z,_RAMDISK
000E4A 4E4A 37               4      SCF
000E4B 4E4B C9              10      RET
       4E4C                     _CHDIR:
000E4C 4E4C 7E               7      LD  A,(HL)
000E4D 4E4D FE28             7      CP  '('
000E4F 4E4F 37               4      SCF
000E50 4E50 C0              11      RET NZ
000E51 4E51 CD2947          17      CALL    INIT_PARAM
000E54 4E54 CD1F4A          17      CALL    FILE_B
000E57 4E57 CD764E          17      CALL    ROM_CD
000E5A 4E5A DAEC45          10      JP  C,ERROR_FILE_NOT_FOUND
000E5D 4E5D C9              10      RET
                                
       4E5E                     _RAMDISK:
000E5E 4E5E 7E               7      LD  A,(HL)
000E5F 4E5F FE28             7      CP  '('
000E61 4E61 37               4      SCF
000E62 4E62 C0              11      RET NZ
000E63 4E63 23               6      INC HL
000E64 4E64 DD212F54        14      LD  IX,FRMQNT
000E68 4E68 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000E6C 4E6C CD1C00          17      CALL    _CALSLT
                                ;   LD  A,(HOKVLD)  ;bit0: 拡張 BIOSの存在
                                ;   CPL
                                ;   AND 1
000E6F 4E6F 7A               4      LD  A,D
000E70 4E70 B3               4      OR  E
000E71 4E71 C2E645          10      JP  NZ,ERROR_INTERNAL_ERROR
                                ;   PUSH    HL      ;EXTBIOもDISK BIOSで初期化してそう
                                ;   LD  A,0     ;すでにA=0になっている
                                ;   LD  DE,0401H    ;D=マッパサポートルチン(4) E=機能番号(1)
                                ;   CALL    EXTBIO
                                ;   POP HL
                                ;   OR  A
                                ;   JP  Z,ERROR_INTERNAL_ERROR
000E74 4E74 23               6      INC HL
000E75 4E75 C9              10      RET
                                
       4E76                     ROM_CD:
000E76 4E76 3AECF2          13      LD  A,(FNAME)
000E79 4E79 FE20             7      CP  020H
000E7B 4E7B 2822            12      JR  Z,CD1
000E7D 4E7D CD9E4B          17      CALL    ROM_OPEN
000E80 4E80 D8              11      RET C
000E81 4E81 FD2AE0F2        20      LD  IY,(DIRENT1)
000E85 4E85 FDCB0B66        20      BIT 4,(IY+00BH) ;属性(アトリビュート) ディレクトリ
000E89 4E89 CAEC45          10      JP  Z,ERROR_FILE_NOT_FOUND
000E8C 4E8C FD6E1A          19      LD  L,(IY+01AH) ;ファイルの先頭クラスタ
000E8F 4E8F FD661B          19      LD  H,(IY+01BH)
       4E92                     CD2:
000E92 4E92 22DEF2          16      LD  (_CD),HL
000E95 4E95 2AE7F2          16      LD  HL,(PARAM1)
       4E98                     CD_SKIP:
000E98 4E98 7E               7      LD  A,(HL)
000E99 4E99 23               6      INC HL
000E9A 4E9A FE21             7      CP  021H
000E9C 4E9C 38FA            12      JR  C,CD_SKIP
000E9E 4E9E C9              10      RET
       4E9F                     CD1:
000E9F 4E9F 2AE9F2          16      LD  HL,(_CDX)
000EA2 4EA2 18EE            12      JR  CD2
                                
       4EA4                     DEVICE1:
000EA4 4EA4 11D64E          10      LD  DE,STR_A
000EA7 4EA7 CDAE4E          17      CALL    CPPROCNM
000EAA 4EAA 37               4      SCF
000EAB 4EAB C0              11      RET NZ
000EAC 4EAC AF               4      XOR A
000EAD 4EAD C9              10      RET
                                
       4EAE                     CPPROCNM:
000EAE 4EAE E5              11      PUSH    HL
000EAF 4EAF 2189FD          10      LD  HL,PROCNM
       4EB2                     CPPROCNM1:
000EB2 4EB2 1A               7      LD  A,(DE)
000EB3 4EB3 13               6      INC DE
000EB4 4EB4 BE               7      CP  (HL)
000EB5 4EB5 23               6      INC HL
000EB6 4EB6 2003            12      JR  NZ,CPPROCNM2
000EB8 4EB8 B7               4      OR  A
000EB9 4EB9 20F7            12      JR  NZ,CPPROCNM1
       4EBB                     CPPROCNM2:
000EBB 4EBB E1              10      POP HL
000EBC 4EBC C9              10      RET
                                
       4EBD                     WILDCARD:
000EBD 4EBD 3F3F3F3F3F3F3F3F        DB  "???????????"
            3F3F3F              
                                
       4EC8                     STR_CHDIR:
000EC8 4EC8 434844495200            DB  "CHDIR",0
       4ECE                     STR_RAMDISK:
000ECE 4ECE 52414D4449534B00        DB  "RAMDISK",0
       4ED6                     STR_A:
000ED6 4ED6 4100                    DB  "A",0
[EOF:FILE.ASM:UTF_8]
                                    INCLUDE "DISK.ASM"
                                
                                ;   Tablacus DISK ROM - DISK
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ512
                                
       4ED8                     ERROR_WRITE_PROTECTED:
000ED8 4ED8 3E00             7      LD  A,0     ;Write protected
000EDA 4EDA C9              10      RET
       4EDB                     DISKIO:
000EDB 4EDB 38FB            12      JR  C,ERROR_WRITE_PROTECTED
000EDD 4EDD 48               4      LD  C,B
000EDE 4EDE CDBB50          17      CALL    GET_DISK_BANK
       4EE1                     SETMAP1:        
000EE1 4EE1 E5              11      PUSH    HL
       4EE2                     DISKIO1:
000EE2 4EE2 C5              11      PUSH    BC      ;B=残りのセクタ数
000EE3 4EE3 D5              11      PUSH    DE      ;DE=セクタ番号
000EE4 4EE4 F5              11      PUSH    AF      ;A=8KB単位でカートリッジ内のディスクが存在する位置を指定
                                
000EE5 4EE5 EB               4      EX  DE,HL       ;DE=受け取る読み出し先のメモリアドレス HL=セクタ番号
000EE6 4EE6 F5              11      PUSH    AF
000EE7 4EE7 3ABCF2          13      LD  A,(SECSZ_H)
000EEA 4EEA CDDA50          17      CALL    MUL_AHL
000EED 4EED F1              10      POP AF
                                #if exists USE_NORMAL_32K_ROM
000EEE 4EEE 7D               4      LD  A,L
000EEF 4EEF C5              11      PUSH    BC
000EF0 4EF0 01E0FF          10      LD  BC,-00020H  ;先頭の8KB部分
000EF3 4EF3 09              11      ADD HL,BC
000EF4 4EF4 C1              10      POP BC
000EF5 4EF5 3013            12      JR  NC,DISKIO2
000EF7 4EF7 4D               4      LD  C,L     ;C=読み出し元
000EF8 4EF8 29              11      ADD HL,HL   ;64KB→32KB
000EF9 4EF9 29              11      ADD HL,HL   ;32KB→16KB バンク切り替えのサイズに合わせる
000EFA 4EFA CDB150          17      CALL    GET_DISK_BANK_FDRV
000EFD 4EFD 84               4      ADD A,H
000EFE 4EFE 320070          13      LD  (ASCII16_BANK1_SEL),A   ;ASCII-16K
000F01 4F01 32B7F2          13      LD  (_BANK),A
000F04 4F04 69               4      LD  L,C     ;C=読み出し元
000F05 4F05 3E3F             7      LD  A,03FH      ;セグメントのサイズでフィルタする(16K:3F)
000F07 4F07 A5               4      AND L
000F08 4F08 C620             7      ADD A,020H
                                #else
                                    LD  C,L     ;C=読み出し元
                                    ADD HL,HL       ;64KB→32KB
                                    ADD HL,HL       ;32KB→16KB
                                    ADD HL,HL       ;16KB→8KB  バンク切り替えのサイズに合わせる
                                    ADD A,H
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                    LD  (_BANK),A
                                    LD  A,C     ;C=読み出し元
                                    AND 01FH        ;セグメントのサイズでフィルタする(8K:1F)
                                #endif
       4F0A                     DISKIO2:
000F0A 4F0A C660             7      ADD A,high BANK1_ADR
000F0C 4F0C 67               4      LD  H,A
000F0D 4F0D ED4BBBF2        20      LD  BC,(SECSZ)  ;BCは読み出すセクタサイズ
000F11 4F11 69               4      LD  L,C     ;C=0
000F12 4F12 CD0544          17      CALL    ROM_LDIR
000F15 4F15 EB               4      EX  DE,HL
000F16 4F16 F1              10      POP AF
000F17 4F17 D1              10      POP DE
000F18 4F18 13               6      INC DE
000F19 4F19 C1              10      POP BC
000F1A 4F1A 10C6            13      DJNZ    DISKIO1
000F1C 4F1C 41               4      LD  B,C
                                
000F1D 4F1D E1              10      POP HL
000F1E 4F1E AF               4      XOR A
                                
000F1F 4F1F FB               4      EI
000F20 4F20 C9              10      RET
                                
       4F21                     DSKCHG:
000F21 4F21 CD5A4F          17      CALL    IS_BPB
000F24 4F24 3824            12      JR  C,NOTREADY
000F26 4F26 3A23FB          13      LD  A,(DRVTBL+2)
000F29 4F29 B7               4      OR  A
000F2A 4F2A 201A            12      JR  NZ,DSKCHG1
000F2C 4F2C 3A21FB          13      LD  A,(DRVTBL)
000F2F 4F2F FE02             7      CP  2
000F31 4F31 2013            12      JR  NZ,DSKCHG1
000F33 4F33 CD5A4F          17      CALL    IS_BPB
000F36 4F36 300E            12      JR  NC,DSKCHG1
000F38 4F38 3E01             7      LD  A,1         ;ドライブテーブルを拡張 A:Tablacus DISK ROM B:MASTER SLOT ROM
000F3A 4F3A 3221FB          13      LD  (DRVTBL),A
000F3D 4F3D 3223FB          13      LD  (DRVTBL+2),A
000F40 4F40 3A48F3          13      LD  A,(MASTERS)
000F43 4F43 3224FB          13      LD  (DRVTBL+3),A
       4F46                     DSKCHG1:
000F46 4F46 AF               4      XOR A
000F47 4F47 0601             7      LD  B,1
000F49 4F49 C9              10      RET
       4F4A                     NOTREADY:
000F4A 4F4A 3E02             7      LD  A,2
000F4C 4F4C 37               4      SCF
000F4D 4F4D C9              10      RET
                                
       4F4E                     NO_BPB:
000F4E 4F4E E1              10      POP HL
000F4F 4F4F 23               6      INC HL
000F50 4F50 11E050          10      LD  DE,DPB2DD
000F53 4F53 011200          10      LD  BC,DPB2DD_E-DPB2DD
000F56 4F56 EDB0                    LDIR
000F58 4F58 AF               4      XOR A
000F59 4F59 C9              10      RET
                                
       4F5A                     IS_BPB:
                                ; in
                                ; A=DRIVE 0:A 1:B
                                ; out
                                ; CF=0ディスクは存在する CF=1 ディスクは存在しない
000F5A 4F5A CDBB50          17      CALL    GET_DISK_BANK
                                
000F5D 4F5D 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media
000F60 4F60 FE01             7      CP  1
000F62 4F62 D8              11      RET C
                                
000F63 4F63 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec
000F66 4F66 C6FF             7      ADD A,0FFH
000F68 4F68 D8              11      RET C
                                
000F69 4F69 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec
       4F6C                     IS_BPB1:
000F6C 4F6C FE01             7      CP  1
000F6E 4F6E C8              11      RET Z
000F6F 4F6F FE02             7      CP  2
000F71 4F71 C8              11      RET Z
000F72 4F72 FE04             7      CP  4
000F74 4F74 C8              11      RET Z
000F75 4F75 37               4      SCF
000F76 4F76 C9              10      RET
                                
       4F77                     GETDPB:
000F77 4F77 E5              11      PUSH    HL
000F78 4F78 CDBB50          17      CALL    GET_DISK_BANK
                                
000F7B 4F7B 3A1560          13      LD  A,(BANK1_ADR+21)    ;BPB_Media  
000F7E 4F7E B7               4      OR  A
000F7F 4F7F 28CD            12      JR  Z,NO_BPB
000F81 4F81 DDE1            14      POP IX
000F83 4F83 DD7701          19      LD  (IX+1),A        ;MEDIA
                                
000F86 4F86 3A0B60          13      LD  A,(BANK1_ADR+11)    ;BPB_BytsPerSec 
000F89 4F89 DD7702          19      LD  (IX+2),A        ;SECSIZ LOW
                                
000F8C 4F8C 3A0C60          13      LD  A,(BANK1_ADR+12)    ;BPB_BytsPerSec 
000F8F 4F8F DD7703          19      LD  (IX+3),A        ;SECSIZ HIGH
                                
000F92 4F92 87               4      ADD A,A
000F93 4F93 87               4      ADD A,A
000F94 4F94 87               4      ADD A,A
000F95 4F95 3D               4      DEC A
000F96 4F96 DD7704          19      LD  (IX+4),A        ;DIRMSK
                                
000F99 4F99 06FF             7      LD  B,-1
000F9B 4F9B A7               4      AND A           ;無限ループ阻止
       4F9C                     GETDPB1:
000F9C 4F9C 04               4      INC B
000F9D 4F9D 1F               4      RRA
000F9E 4F9E 38FC            12      JR  C,GETDPB1
000FA0 4FA0 DD7005          19      LD  (IX+5),B        ;DIRSHFT
                                
000FA3 4FA3 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
000FA6 4FA6 3D               4      DEC A
000FA7 4FA7 DD7706          19      LD  (IX+6),A        ;CLUSMSK
                                
000FAA 4FAA A7               4      AND A           ;無限ループ阻止
000FAB 4FAB 06FF             7      LD  B,-1
       4FAD                     GETDPB2:
000FAD 4FAD 04               4      INC B
000FAE 4FAE 1F               4      RRA
000FAF 4FAF 38FC            12      JR  C,GETDPB2
000FB1 4FB1 04               4      INC B
000FB2 4FB2 DD7007          19      LD  (IX+7),B        ;CLUSSHFT
                                
000FB5 4FB5 2A0E60          16      LD  HL,(BANK1_ADR+14)   ;BPB_RsvdSecCnt 
000FB8 4FB8 DD7508          19      LD  (IX+8),L        ;FIRFAT LOW
000FBB 4FBB DD7409          19      LD  (IX+9),H        ;FIRFAT HIGH
                                
000FBE 4FBE 3A1060          13      LD  A,(BANK1_ADR+16)    ;BPB_NumFATs    
000FC1 4FC1 DD770A          19      LD  (IX+10),A       ;FATCNT
                                
000FC4 4FC4 3A1160          13      LD  A,(BANK1_ADR+17)    ;BPB_RootEntCnt 
000FC7 4FC7 DD770B          19      LD  (IX+11),A       ;MAXENT
                                
000FCA 4FCA ED5B1660        20      LD  DE,(BANK1_ADR+22)   ;BPB_FATSz16    
000FCE 4FCE DD7310          19      LD  (IX+16),E       ;FATSIZ
                                
000FD1 4FD1 DD460A          19      LD  B,(IX+10)       ;FATCNT
000FD4 4FD4 210000          10      LD  HL,0
       4FD7                     GETDPB3:
000FD7 4FD7 19              11      ADD HL,DE
000FD8 4FD8 10FD            13      DJNZ    GETDPB3
       4FDA                     GETDPB4:
000FDA 4FDA DD5E08          19      LD  E,(IX+8)        ;FIRFAT
000FDD 4FDD DD5609          19      LD  D,(IX+9)        ;FIRFAT
000FE0 4FE0 19              11      ADD HL,DE
000FE1 4FE1 DD7511          19      LD  (IX+17),L       ;FIRDIR
000FE4 4FE4 DD7412          19      LD  (IX+18),H       ;FIRDIR
                                
000FE7 4FE7 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
000FEA 4FEA 87               4      ADD A,A
000FEB 4FEB 87               4      ADD A,A
000FEC 4FEC DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       4FEF                     GETDPB5:
000FEF 4FEF CB3B             8      SRL E
000FF1 4FF1 1F               4      RRA
000FF2 4FF2 30FB            12      JR  NC,GETDPB5
000FF4 4FF4 1600             7      LD  D,0
000FF6 4FF6 19              11      ADD HL,DE
000FF7 4FF7 DD750C          19      LD  (IX+12),L       ;FIRREC
000FFA 4FFA DD740D          19      LD  (IX+13),H       ;FIRREC
                                
000FFD 4FFD 2A1360          16      LD  HL,(BANK1_ADR+19)   ;BPB_TotSec16   
                                
001000 5000 DD5E0C          19      LD  E,(IX+12)       ;FIRREC
001003 5003 DD560D          19      LD  D,(IX+13)       ;FIRREC
001006 5006 A7               4      AND A
001007 5007 ED52            15      SBC HL,DE
                                
001009 5009 DD7E06          19      LD  A,(IX+6)        ;CLUSMSK
00100C 500C 3C               4      INC A
00100D 500D 37               4      SCF             ;無限ループ阻止
       500E                     GETDPB6:
00100E 500E 1F               4      RRA
00100F 500F 3806            12      JR  C,GETDPB7
001011 5011 CB3C             8      SRL H
001013 5013 CB1D             8      RR  L
001015 5015 18F7            12      JR  GETDPB6
       5017                     GETDPB7:
001017 5017 23               6      INC HL
001018 5018 DD750E          19      LD  (IX+14),L       ;MAXCLUS
00101B 501B DD740F          19      LD  (IX+15),H       ;MAXCLUS
                                
                                    ;1セクタが512バイト以上の場合を考慮(2HD/1セクタ1024バイト/1.23MB等)
       501E                     GETDPBD1:
00101E 501E DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001021 5021 E6FC             7      AND 0FCH
001023 5023 C8              11      RET Z
                                
001024 5024 DDCB033E        23      SRL (IX+3)          ;SECSIZ HIGH
                                
001028 5028 37               4      SCF
001029 5029 DDCB0616        23      RL  (IX+6)          ;CLUSMSK
                                
00102D 502D DD3407          23      INC (IX+7)          ;CLUSSHFT
                                
001030 5030 DDCB0826        23      SLA (IX+8)          ;FIRFAT LOW
001034 5034 DDCB0916        23      RL  (IX+9)          ;FIRFAT HIGH
                                
001038 5038 DDCB0E25        23      SLA (IX+14),L       ;MAXCLUS
00103C 503C DDCB0F14        23      RL  (IX+15),H       ;MAXCLUS
                                
001040 5040 DDCB1026        23      SLA (IX+16)         ;FATSIZ
                                
001044 5044 DDCB1126        23      SLA (IX+17)         ;FIRDIR
001048 5048 DDCB1216        23      RL  (IX+18)         ;FIRDIR
                                
00104C 504C DD6E11          19      LD  L,(IX+17)       ;FIRDIR
00104F 504F DD6612          19      LD  H,(IX+18)       ;FIRDIR
                                
001052 5052 DD7E03          19      LD  A,(IX+3)        ;SECSIZ HIGH
001055 5055 87               4      ADD A,A
001056 5056 87               4      ADD A,A
001057 5057 DD5E0B          19      LD  E,(IX+11)       ;MAXENT
       505A                     GETDPBD5:
00105A 505A CB3B             8      SRL E
00105C 505C 1F               4      RRA
00105D 505D 30FB            12      JR  NC,GETDPBD5
00105F 505F 1600             7      LD  D,0
001061 5061 19              11      ADD HL,DE
001062 5062 DD750C          19      LD  (IX+12),L       ;FIRREC
001065 5065 DD740D          19      LD  (IX+13),H       ;FIRREC
                                
001068 5068 18B4            12      JR  GETDPBD1
                                
       506A                     CHOICE:
00106A 506A 210000          10      LD  HL,0
00106D 506D C9              10      RET
                                
       506E                     DSKFMT:
00106E 506E AF               4      XOR A
00106F 506F 37               4      SCF
       5070                     DSKSTP:
001070 5070 C9              10      RET
                                
       5071                     BASENT:
001071 5071 3A40F3          13      LD  A,(REBOOT)
001074 5074 B7               4      OR  A
001075 5075 202B            12      JR  NZ,REBOOT1
001077 5077 21F250          10      LD  HL,AUTOEXEC
00107A 507A 11EBF2          10      LD  DE,FDRV
00107D 507D 010C00          10      LD  BC,1+8+3
001080 5080 EDB0                    LDIR
001082 5082 CD9E4B          17      CALL    ROM_OPEN
001085 5085 381B            12      JR  C,REBOOT1
001087 5087 CDA145          17      CALL    ROM_LOAD1
00108A 508A 21FE50          10      LD  HL,CMD_RUN
00108D 508D 111FF4          10      LD  DE,KBUF
001090 5090 D5              11      PUSH    DE
001091 5091 010300          10      LD  BC,3
001094 5094 EDB0                    LDIR
001096 5096 E1              10      POP HL
001097 5097 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00109B 509B DD210146        14      LD  IX,NEWSTT
00109F 509F CD1C00          17      CALL    _CALSLT
       50A2                     REBOOT1:
0010A2 50A2 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
0010A6 50A6 DD219B40        14      LD  IX,READYR
0010AA 50AA C31C00          10      JP  _CALSLT
                                
       50AD                     GETSLT:
0010AD 50AD 3A22FB          13      LD  A,(DRVTBL+1)
0010B0 50B0 C9              10      RET
                                
       50B1                     GET_DISK_BANK_FDRV:
0010B1 50B1 3AEBF2          13      LD  A,(FDRV)
0010B4 50B4 D601             7      SUB 1
0010B6 50B6 3003            12      JR  NC,GET_DISK_BANK
0010B8 50B8 3ADDF2          13      LD  A,(_DVSW)
       50BB                     GET_DISK_BANK:
0010BB 50BB B7               4      OR  A       ;A=DRIVE
0010BC 50BC 3E01             7      LD  A,DISK_BANK
0010BE 50BE 2803            12      JR  Z,SET_DISK_BANK
                                #if exists FIX_DRIVE
                                    LD  A,FIX_DRIVE
                                #else
0010C0 50C0 3ADCF2          13      LD  A,(B_DRIVE)
                                #endif
       50C3                     SET_DISK_BANK:
                                #if exists USE_NORMAL_32K_ROM
0010C3 50C3 320070          13      LD  (ASCII16_BANK1_SEL),A       ;ASCII-16K
                                #else
                                    LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
                                    LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
                                #endif
0010C6 50C6 F5              11      PUSH    AF
0010C7 50C7 E5              11      PUSH    HL
0010C8 50C8 2A0B60          16      LD  HL,(BANK1_ADR+11)   ;BPB_BytsPerSec 
0010CB 50CB 22BBF2          16      LD  (SECSZ),HL
0010CE 50CE 3A0D60          13      LD  A,(BANK1_ADR+13)    ;BPB_SecPerClus
0010D1 50D1 CDDA50          17      CALL    MUL_AHL
0010D4 50D4 22B9F2          16      LD  (CLSZ),HL
0010D7 50D7 E1              10      POP HL
0010D8 50D8 F1              10      POP AF
0010D9 50D9 C9              10      RET
                                
                                ;   HL = HL * A ただし、A=1,2,4,8,16,32,64,128(2のべき乗に限る)0の場合は256倍
       50DA                     MUL_AHL:
0010DA 50DA 37               4      SCF     ;無限ループ回避
       50DB                     MUL_AHL1:
0010DB 50DB 1F               4      RRA     ;->CF
0010DC 50DC D8              11      RET C
0010DD 50DD 29              11      ADD HL,HL
0010DE 50DE 18FB            12      JR  MUL_AHL1
                                
       50E0                     DPB2DD:
0010E0 50E0 F9                      DB  0F9H    ;MEDIA
0010E1 50E1 0002                    DW  00200H  ;SECSIZ
0010E3 50E3 0F                      DB  00FH    ;DIRMSK
0010E4 50E4 04                      DB  004H    ;DIRSHFT
0010E5 50E5 01                      DB  001H    ;CLUSMSK
0010E6 50E6 02                      DB  002H    ;CLUSSHFT
0010E7 50E7 0100                    DW  00001H  ;FIRFAT
0010E9 50E9 02                      DB  002H    ;FATCNT
0010EA 50EA 70                      DB  070H    ;MAXENT
0010EB 50EB 0E00                    DW  0000EH  ;FIRREC
0010ED 50ED CA02                    DW  002CAH  ;MAXCLUS
0010EF 50EF 03                      DB  003H    ;FATSIZ
0010F0 50F0 0700                    DW  0007H   ;FIRDIR
       50F2                     DPB2DD_E:
                                
       50F2                     AUTOEXEC:
0010F2 50F2 004155544F455845        DB  0,"AUTOEXECBAS"
            43424153            
       50FE                     CMD_RUN:
0010FE 50FE 3A8A00                  DB  03AH,08AH,0
[EOF:DISK.ASM:UTF_8]
                                    INCLUDE "BDOS.ASM"
       5101                     POP_HL_ERROR:
001101 5101 E1              10      POP     HL
       5102                     _ERROR:
001102 5102 0600             7      LD  B,0
001104 5104 A7               4      AND A
001105 5105 C9              10      RET
                                
       5106                     ROM_BDOS:
001106 5106 E5              11      PUSH    HL
001107 5107 79               4      LD  A,C
001108 5108 87               4      ADD A,A
001109 5109 38F7            12      JR  C,_ERROR
00110B 510B 6F               4      LD  L,A
00110C 510C 265F             7      LD  H,high STABLE
00110E 510E 7E               7      LD  A,(HL)
00110F 510F 2C               4      INC L
001110 5110 66               7      LD  H,(HL)
001111 5111 6F               4      LD  L,A
001112 5112 E3              19      EX  (SP),HL
001113 5113 79               4      LD  A,C
001114 5114 C9              10      RET
                                
       5115                     _PRINT:
       5115                     PRINT:
001115 5115 7B               4      LD  A,E
001116 5116 1803            12      JR  MSG_A
                                
       5118                     _SYS01:     ;(BDOS)コンソール入力
001118 5118 CD8F51          17      CALL    _SYS07
       511B                     MSG_A:
00111B 511B FE03             7      CP  3
00111D 511D 2814            12      JR  Z,MSG_BR
       511F                     MSGA1:
00111F 511F F5              11      PUSH    AF
001120 5120 C5              11      PUSH    BC
001121 5121 D5              11      PUSH    DE
001122 5122 E5              11      PUSH    HL
001123 5123 DDE5            15      PUSH    IX
001125 5125 DD21A200        14      LD  IX,CHPUT
001129 5129 CDF542          17      CALL    CALSLT_R
00112C 512C DDE1            14      POP IX
00112E 512E E1              10      POP HL
00112F 512F D1              10      POP DE
001130 5130 C1              10      POP BC
       5131                     MSGA2:
001131 5131 F1              10      POP AF
001132 5132 C9              10      RET
       5133                     MSG_BR:
001133 5133 F5              11      PUSH    AF
001134 5134 3ADDF3          13      LD  A,(CSRX)
001137 5137 FE02             7      CP  2
001139 5139 38F6            12      JR  C,MSGA2
00113B 513B F1              10      POP AF
       513C                     MSG_CR:
00113C 513C F5              11      PUSH    AF
00113D 513D 3E0D             7      LD  A,00DH
00113F 513F CD1F51          17      CALL    MSGA1
001142 5142 3E0A             7      LD  A,00AH
001144 5144 CD1F51          17      CALL    MSGA1
001147 5147 F1              10      POP AF
001148 5148 C9              10      RET
                                
       5149                     _SYS02:     ;(BDOS)コンソール出力
001149 5149 CD6451          17      CALL    BREAK
00114C 514C 1805            12      JR  PRINTX
                                
       514E                     _SYS06:     ;(BDOS)コンソール直接入出力
00114E 514E 7B               4      LD  A,E
00114F 514F 3C               4      INC A
001150 5150 CAA351          10      JP  Z,_INKEY
       5153                     PRINTX:
001153 5153 C31551          10      JP  _PRINT
                                
       5156                     _SYS08:     ;(BDOS)エコーなしコンソール入力
001156 5156 CD8F51          17      CALL    _SYS07
001159 5159 FE03             7      CP  3
00115B 515B CC6451          17      CALL    Z,_BREAK
00115E 515E FE13             7      CP  013H        ;CTRL+S
001160 5160 C0              11      RET NZ
       5161                     PAUSE:
001161 5161 CD7B51          17      CALL    KEYBC
                                
       5164                     _BREAK:
       5164                     BREAK:
001164 5164 F5              11      PUSH    AF
001165 5165 C5              11      PUSH    BC
001166 5166 D5              11      PUSH    DE
001167 5167 E5              11      PUSH    HL
001168 5168 DDE5            15      PUSH    IX
00116A 516A DD21B700        14      LD  IX,BREAKX
00116E 516E CDF542          17      CALL    CALSLT_R
001171 5171 DDE1            14      POP IX
001173 5173 E1              10      POP HL
001174 5174 D1              10      POP DE
001175 5175 C1              10      POP BC
001176 5176 DC6451          17      CALL    C,_BREAK
001179 5179 F1              10      POP AF
00117A 517A C9              10      RET
       517B                     KEYBC:
00117B 517B F5              11      PUSH    AF
00117C 517C C5              11      PUSH    BC
00117D 517D D5              11      PUSH    DE
00117E 517E E5              11      PUSH    HL
00117F 517F DDE5            15      PUSH    IX
001181 5181 DD215601        14      LD  IX,KILBUF
001185 5185 CDF542          17      CALL    CALSLT_R
001188 5188 DDE1            14      POP IX
00118A 518A E1              10      POP HL
00118B 518B D1              10      POP DE
00118C 518C C1              10      POP BC
00118D 518D F1              10      POP AF
00118E 518E C9              10      RET
                                
       518F                     _SYS07:
       518F                     FLGET:
00118F 518F C5              11      PUSH    BC
001190 5190 D5              11      PUSH    DE
001191 5191 E5              11      PUSH    HL
001192 5192 DDE5            15      PUSH    IX
001194 5194 DD219F00        14      LD  IX,CHGET
001198 5198 CDF542          17      CALL    CALSLT_R
00119B 519B DDE1            14      POP IX
00119D 519D E1              10      POP HL
00119E 519E D1              10      POP DE
00119F 519F C1              10      POP BC
0011A0 51A0 FE03             7      CP  3
0011A2 51A2 C9              10      RET
                                ;   RET NZ
                                ;   JP  CPM_BOOT
                                
       51A3                     _INKEY:
       51A3                     INKEY:
0011A3 51A3 CD3D52          17      CALL    CPM_CONST
0011A6 51A6 C8              11      RET Z
0011A7 51A7 18E6            12      JR  FLGET
                                
       51A9                     _SYS0A:     ;(BDOS)文字列入力
0011A9 51A9 C5              11      PUSH    BC
0011AA 51AA E5              11      PUSH    HL
0011AB 51AB D5              11      PUSH    DE
0011AC 51AC CDD551          17      CALL    GETL
0011AF 51AF 111FF4          10      LD  DE,KBUF
0011B2 51B2 E1              10      POP HL
0011B3 51B3 E5              11      PUSH    HL
0011B4 51B4 0E00             7      LD  C,0
0011B6 51B6 3004            12      JR  NC,SAX0
0011B8 51B8 23               6      INC HL
0011B9 51B9 23               6      INC HL
0011BA 51BA 1808            12      JR  SAX4
       51BC                     SAX0:
0011BC 51BC 46               7      LD  B,(HL)
0011BD 51BD 23               6      INC HL
       51BE                     SAX1:
0011BE 51BE 23               6      INC HL
0011BF 51BF 1A               7      LD  A,(DE)
0011C0 51C0 13               6      INC DE
0011C1 51C1 B7               4      OR  A
0011C2 51C2 2004            12      JR  NZ,SAX2
       51C4                     SAX4:
0011C4 51C4 360D            10      LD  (HL),00DH
0011C6 51C6 1804            12      JR  SAX3
       51C8                     SAX2:
0011C8 51C8 77               7      LD  (HL),A
0011C9 51C9 0C               4      INC C
0011CA 51CA 10F2            13      DJNZ    SAX1
       51CC                     SAX3:
0011CC 51CC D1              10      POP DE
0011CD 51CD 79               4      LD  A,C
0011CE 51CE 13               6      INC DE
0011CF 51CF 12               7      LD  (DE),A
0011D0 51D0 1B               6      DEC DE
0011D1 51D1 E1              10      POP HL
0011D2 51D2 C1              10      POP BC
0011D3 51D3 A7               4      AND A
0011D4 51D4 C9              10      RET
       51D5                     GETL:
0011D5 51D5 DDE5            15      PUSH    IX
0011D7 51D7 FDE5            15      PUSH    IY
                                
0011D9 51D9 2ADCF3          16      LD  HL,(CSRY)
0011DC 51DC 22CAFB          16      LD  (FSTPOS),HL
       51DF                     GETL1:
0011DF 51DF CD5651          17      CALL    _SYS08
0011E2 51E2 FE09             7      CP  9
0011E4 51E4 2008            12      JR  NZ,GETL1V
0011E6 51E6 211FF4          10      LD  HL,KBUF
0011E9 51E9 CD7F43          17      CALL    MSX
0011EC 51EC 18F1            12      JR  GETL1
       51EE                     GETL1V:
0011EE 51EE 5F               4      LD  E,A
0011EF 51EF FE08             7      CP  8
0011F1 51F1 CC8B52          17      CALL    Z,CTRL02
0011F4 51F4 FE20             7      CP  020H
0011F6 51F6 D4B752          17      CALL    NC,INSERT
0011F9 51F9 CD1F51          17      CALL    MSGA1
                                
0011FC 51FC 7B               4      LD  A,E
0011FD 51FD FE0D             7      CP  00DH
0011FF 51FF 20DE            12      JR  NZ,GETL1
                                
001201 5201 111FF4          10      LD  DE,KBUF
001204 5204 3AB0F3          13      LD  A,(LINLEN)
001207 5207 47               4      LD  B,A
001208 5208 CD9954          17      CALL    ZERO_MEMORY_DE
                                
00120B 520B 2ACAFB          16      LD  HL,(FSTPOS)
00120E 520E 3ADCF3          13      LD  A,(CSRY)
001211 5211 6F               4      LD  L,A
001212 5212 E5              11      PUSH    HL
001213 5213 CDE852          17      CALL    LOC0
001216 5216 4D               4      LD  C,L
001217 5217 44               4      LD  B,H
001218 5218 E1              10      POP HL
001219 5219 3AB0F3          13      LD  A,(LINLEN)
00121C 521C 94               4      SUB H
00121D 521D 3D               4      DEC A
00121E 521E 5F               4      LD  E,A
00121F 521F 211FF4          10      LD  HL,KBUF
       5222                     GETL2:
001222 5222 CD7B52          17      CALL    _SCRN
001225 5225 03               6      INC BC
001226 5226 77               7      LD  (HL),A
001227 5227 23               6      INC HL
001228 5228 1D               4      DEC E
001229 5229 20F7            12      JR  NZ,GETL2
00122B 522B CD3C51          17      CALL    MSG_CR
                                
00122E 522E FDE1            14      POP IY
001230 5230 DDE1            14      POP IX
       5232                     GETL3:
001232 5232 2B               6      DEC HL
001233 5233 7E               7      LD  A,(HL)
001234 5234 FE21             7      CP  021H
001236 5236 D0              11      RET NC
001237 5237 3600            10      LD  (HL),0
001239 5239 15               4      DEC D
00123A 523A 20F6            12      JR  NZ,GETL3
00123C 523C C9              10      RET
                                
       523D                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       523D                     CONSTX:
       523D                     CPM_CONST:
00123D 523D C5              11      PUSH    BC
00123E 523E D5              11      PUSH    DE
00123F 523F E5              11      PUSH    HL
001240 5240 DDE5            15      PUSH    IX
001242 5242 DD219C00        14      LD  IX,CHSNS
001246 5246 CDF542          17      CALL    CALSLT_R
001249 5249 DDE1            14      POP IX
00124B 524B E1              10      POP HL
00124C 524C D1              10      POP DE
00124D 524D C1              10      POP BC
00124E 524E C9              10      RET
                                
       524F                     _SYS2A:     ;(BDOS)日付の獲得
00124F 524F AF               4      XOR A
001250 5250 57               4      LD  D,A
001251 5251 5F               4      LD  E,A
001252 5252 67               4      LD  H,A
001253 5253 6F               4      LD  L,A
001254 5254 C9              10      RET
                                
       5255                     _SYS2C:     ;(BDOS)時刻の獲得
001255 5255 AF               4      XOR A
001256 5256 57               4      LD  D,A
001257 5257 5F               4      LD  E,A
001258 5258 67               4      LD  H,A
001259 5259 6F               4      LD  L,A
00125A 525A C9              10      RET
                                
       525B                     POS:
00125B 525B F5              11      PUSH    AF
00125C 525C 2ADCF3          16      LD  HL,(CSRY)
00125F 525F 7D               4      LD  A,L
001260 5260 6C               4      LD  L,H
001261 5261 67               4      LD  H,A
001262 5262 2C               4      INC L
001263 5263 24               4      INC H
001264 5264 F1              10      POP AF
001265 5265 C9              10      RET
                                
       5266                     LOC:
001266 5266 F5              11      PUSH    AF
001267 5267 E5              11      PUSH    HL
001268 5268 7D               4      LD  A,L
001269 5269 6C               4      LD  L,H
00126A 526A 67               4      LD  H,A
00126B 526B 2D               4      DEC L
00126C 526C 25               4      DEC H
00126D 526D DDE5            15      PUSH    IX
00126F 526F DD21C600        14      LD  IX,POSIT
001273 5273 CDF542          17      CALL    CALSLT_R
001276 5276 DDE1            14      POP IX
001278 5278 E1              10      POP HL
001279 5279 F1              10      POP AF
00127A 527A C9              10      RET
                                
       527B                     _SCRN:
       527B                     SCRN:
00127B 527B E5              11      PUSH    HL
00127C 527C DDE5            15      PUSH    IX
                                
00127E 527E 69               4      LD  L,C
00127F 527F 60               4      LD  H,B
001280 5280 DD214A00        14      LD  IX,RDVRM
001284 5284 CDF542          17      CALL    CALSLT_R
                                
001287 5287 DDE1            14      POP IX
001289 5289 E1              10      POP HL
00128A 528A C9              10      RET
                                
       528B                     CTRL02:
00128B 528B F5              11      PUSH    AF
00128C 528C D5              11      PUSH    DE
00128D 528D 2ADCF3          16      LD  HL,(CSRY)
001290 5290 3AB0F3          13      LD  A,(LINLEN)
001293 5293 4F               4      LD  C,A
001294 5294 94               4      SUB H   ;CSRX
001295 5295 C602             7      ADD A,2
001297 5297 47               4      LD  B,A ;カーソルより右の文字数
001298 5298 61               4      LD  H,C ;LINLEN
001299 5299 C5              11      PUSH    BC
00129A 529A CDE852          17      CALL    LOC0
00129D 529D C1              10      POP BC
                                
00129E 529E 1620             7      LD  D,020H
       52A0                     C8X1:
0012A0 52A0 DD214A00        14      LD  IX,RDVRM
0012A4 52A4 CDF542          17      CALL    CALSLT_R
0012A7 52A7 4F               4      LD  C,A
0012A8 52A8 7A               4      LD  A,D
0012A9 52A9 DD214D00        14      LD  IX,WRTVRM
0012AD 52AD CDF542          17      CALL    CALSLT_R
0012B0 52B0 2B               6      DEC HL
0012B1 52B1 51               4      LD  D,C
0012B2 52B2 10EC            13      DJNZ    C8X1
0012B4 52B4 D1              10      POP DE
0012B5 52B5 F1              10      POP AF
0012B6 52B6 C9              10      RET
                                
       52B7                     INSERT:
0012B7 52B7 F5              11      PUSH    AF
0012B8 52B8 D5              11      PUSH    DE
0012B9 52B9 2ADCF3          16      LD  HL,(CSRY)
0012BC 52BC 3AB0F3          13      LD  A,(LINLEN)
0012BF 52BF 4F               4      LD  C,A
0012C0 52C0 94               4      SUB H   ;CSRX
0012C1 52C1 3C               4      INC A
0012C2 52C2 47               4      LD  B,A ;カーソルより右の文字数
0012C3 52C3 C5              11      PUSH    BC
0012C4 52C4 CDE852          17      CALL    LOC0
0012C7 52C7 C1              10      POP BC
                                
0012C8 52C8 1620             7      LD  D,020H
       52CA                     INS1:
0012CA 52CA DD214A00        14      LD  IX,RDVRM
0012CE 52CE CDF542          17      CALL    CALSLT_R
0012D1 52D1 4F               4      LD  C,A
0012D2 52D2 7A               4      LD  A,D
0012D3 52D3 DD214D00        14      LD  IX,WRTVRM
0012D7 52D7 CDF542          17      CALL    CALSLT_R
0012DA 52DA 23               6      INC HL
0012DB 52DB 51               4      LD  D,C
0012DC 52DC 10EC            13      DJNZ    INS1
0012DE 52DE D1              10      POP DE
0012DF 52DF F1              10      POP AF
0012E0 52E0 C9              10      RET
                                
       52E1                     CONOUT1:
0012E1 52E1 59               4      LD  E,C
0012E2 52E2 C31551          10      JP  _PRINT
                                
       52E5                     GETVRAM:
0012E5 52E5 2ADCF3          16      LD  HL,(CSRY)
       52E8                     LOC0:
0012E8 52E8 2D               4      DEC L
0012E9 52E9 25               4      DEC H
0012EA 52EA 4C               4      LD  C,H ;CSRX-1
0012EB 52EB 5D               4      LD  E,L ;CSRY-1
       52EC                     LOC1:
0012EC 52EC 3AB0F3          13      LD  A,(LINLEN)
0012EF 52EF 67               4      LD  H,A
0012F0 52F0 1600             7      LD  D,0
0012F2 52F2 6A               4      LD  L,D ;0
0012F3 52F3 0608             7      LD  B,8
       52F5                     LOC2:
0012F5 52F5 29              11      ADD HL,HL
0012F6 52F6 3001            12      JR  NC,LOC3
0012F8 52F8 19              11      ADD HL,DE
       52F9                     LOC3:
0012F9 52F9 10FA            13      DJNZ    LOC2
0012FB 52FB 09              11      ADD HL,BC
0012FC 52FC C9              10      RET
                                
       52FD                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0012FD 52FD 212200          10      LD  HL,00022H
001300 5300 AF               4      XOR A
001301 5301 7D               4      LD  A,L
001302 5302 C9              10      RET
                                
       5303                     _SYS0D:     ;(BDOS)ディスク・リセット
001303 5303 218000          10      LD  HL,00080H
001306 5306 22C7F2          16      LD  (_DTA),HL
001309 5309 C9              10      RET
                                
       530A                     _SYS0E:     ;(BDOS)カレントドライブの設定
00130A 530A 7B               4      LD  A,E
00130B 530B FE02             7      CP  2
00130D 530D D0              11      RET NC
00130E 530E 32DDF2          13      LD  (_DVSW),A
001311 5311 C9              10      RET
                                
       5312                     _SYS0F:     ;(BDOS)ファイルのオープン
001312 5312 D5              11      PUSH    DE
001313 5313 FDE1            14      POP IY
001315 5315 CD8054          17      CALL    INIT_FILE
001318 5318 CD9E4B          17      CALL    ROM_OPEN
00131B 531B 3856            12      JR  C,SCF_FF_RET
                                ;               Open(Read)
00131D 531D FD361CFF        19      LD  (IY+28),0FFH
                                ;               FILENAME
001321 5321 FDE5            15      PUSH    IY
001323 5323 D1              10      POP DE
001324 5324 13               6      INC DE
001325 5325 010B00          10      LD  BC,11
001328 5328 EDB0                    LDIR
                                ;               Attribute
00132A 532A 7E               7      LD  A,(HL)
00132B 532B FD770D          19      LD  (IY+13),A
                                ;               TIME
00132E 532E 110B00          10      LD  DE,11
001331 5331 19              11      ADD HL,DE
001332 5332 7E               7      LD  A,(HL)
001333 5333 23               6      INC HL
001334 5334 FD7716          19      LD  (IY+22),A
001337 5337 7E               7      LD  A,(HL)
001338 5338 23               6      INC HL
001339 5339 FD7717          19      LD  (IY+23),A
                                ;               DATE
00133C 533C 7E               7      LD  A,(HL)
00133D 533D 23               6      INC HL
00133E 533E FD7714          19      LD  (IY+20),A
001341 5341 7E               7      LD  A,(HL)
001342 5342 23               6      INC HL
001343 5343 FD7715          19      LD  (IY+21),A
                                ;               First cluster
001346 5346 7E               7      LD  A,(HL)
001347 5347 23               6      INC HL
001348 5348 FD771A          19      LD  (IY+26),A
00134B 534B 7E               7      LD  A,(HL)
00134C 534C 23               6      INC HL
00134D 534D FD771B          19      LD  (IY+27),A
                                ;               SIZE
001350 5350 7E               7      LD  A,(HL)
001351 5351 23               6      INC HL
001352 5352 FD7710          19      LD  (IY+16),A
001355 5355 7E               7      LD  A,(HL)
001356 5356 23               6      INC HL
001357 5357 FD7711          19      LD  (IY+17),A
00135A 535A 7E               7      LD  A,(HL)
00135B 535B 23               6      INC HL
00135C 535C FD7712          19      LD  (IY+18),A
00135F 535F 7E               7      LD  A,(HL)
001360 5360 FD7713          19      LD  (IY+19),A
001363 5363 AF               4      XOR A
001364 5364 FD770C          19      LD  (IY+12),A
001367 5367 C9              10      RET
                                
       5368                     _SYS10:     ;(BDOS)ファイルのクローズ
001368 5368 AF               4      XOR A
001369 5369 C9              10      RET
                                
       536A                     S11X1:
00136A 536A FD7119          19      LD  (IY+25),C       ;RootEntCnt
00136D 536D FD750E          19      LD  (IY+14),L
001370 5370 FD740F          19      LD  (IY+15),H
       5373                     SCF_FF_RET:
001373 5373 37               4      SCF
001374 5374 9F               4      SBC A,A
001375 5375 C9              10      RET
                                
       5376                     _SYS11:     ;(BDOS)最初のファイルの検索
001376 5376 ED53CAF2        20      LD  (_FCB),DE
00137A 537A D5              11      PUSH    DE
00137B 537B FDE1            14      POP IY
00137D 537D CD8054          17      CALL    INIT_FILE
001380 5380 CDF04D          17      CALL    GET_DIR_DAT
       5383                     S12X1:
001383 5383 CDBA4B          17      CALL    FILESE
001386 5386 30E2            12      JR  NC,S11X1
001388 5388 0D               4      DEC C
001389 5389 FD7119          19      LD  (IY+25),C       ;RootEntCnt
00138C 538C FDCB0D66        20      BIT 4,(IY+13)
001390 5390 2809            12      JR  Z,S12X2
001392 5392 E5              11      PUSH    HL
001393 5393 DDE1            14      POP IX
001395 5395 DDCB0E66        20      BIT 4,(IX+1+13)
001399 5399 28E8            12      JR  Z,S12X1
       539B                     S12X2:
00139B 539B 012000          10      LD  BC,32
00139E 539E ED5BC7F2        20      LD  DE,(_DTA)
0013A2 53A2 AF               4      XOR A
0013A3 53A3 12               7      LD  (DE),A      ;ドライブ番号
0013A4 53A4 13               6      INC DE
0013A5 53A5 EDB0                    LDIR            ;ディレクトリエントリ
0013A7 53A7 FD750E          19      LD  (IY+14),L
0013AA 53AA FD740F          19      LD  (IY+15),H
0013AD 53AD C9              10      RET
                                
       53AE                     _SYS12:
0013AE 53AE FD2ACAF2        20      LD  IY,(_FCB)
0013B2 53B2 FDE5            15      PUSH    IY
0013B4 53B4 D1              10      POP DE
0013B5 53B5 CD8054          17      CALL    INIT_FILE
                                
0013B8 53B8 FD6E0E          19      LD  L,(IY+14)
0013BB 53BB FD660F          19      LD  H,(IY+15)
0013BE 53BE FD4E19          19      LD  C,(IY+25)
0013C1 53C1 18C0            12      JR  S12X1
                                
       53C3                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0013C3 53C3 CDD64D          17      CALL    SET_FCB
0013C6 53C6 CDA44D          17      CALL    GETSEQ
0013C9 53C9 CD914D          17      CALL    RB_READ
0013CC 53CC E5              11      PUSH    HL
0013CD 53CD CDB14D          17      CALL    SETSEQ
0013D0 53D0 E1              10      POP HL
       53D1                     SREAD:
0013D1 53D1 C601             7      ADD A,001H
0013D3 53D3 D8              11      RET C
                                
0013D4 53D4 7D               4      LD  A,L
0013D5 53D5 D601             7      SUB 001H
0013D7 53D7 9F               4      SBC A,A
0013D8 53D8 E603             7      AND 3
0013DA 53DA 1F               4      RRA
0013DB 53DB C9              10      RET
                                
       53DC                     _SYS18:     ;(BDOS)ログインベクトルの獲得
0013DC 53DC 210100          10      LD  HL,00001H
0013DF 53DF AF               4      XOR A
0013E0 53E0 C9              10      RET
                                
       53E1                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
0013E1 53E1 3ADDF2          13      LD  A,(_DVSW)
0013E4 53E4 C9              10      RET
                                
       53E5                     _SYS1A:     ;(BDOS)DTAの設定
0013E5 53E5 ED53C7F2        20      LD  (_DTA),DE
0013E9 53E9 AF               4      XOR A
0013EA 53EA C9              10      RET
                                
       53EB                     _SYS1B:     ;(BDOS)ディスク情報の獲得
0013EB 53EB 010002          10      LD  BC,512
0013EE 53EE 11C302          10      LD  DE,707
0013F1 53F1 210000          10      LD  HL,0
0013F4 53F4 DD21CCF2        14      LD  IX,_BUF
0013F8 53F8 FD21CCF2        14      LD  IY,_BUF
0013FC 53FC FD3600F9        19      LD  (IY+0),0F9H
001400 5400 3E02             7      LD  A,2
001402 5402 C9              10      RET
                                
       5403                     _SYS21:     ;(BDOS)ランダムな読み出し
001403 5403 CDD64D          17      CALL    SET_FCB
                                
001406 5406 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001409 5409 FD6622          19      LD  H,(IY+34)
                                
00140C 540C CD914D          17      CALL    RB_READ
00140F 540F 18C0            12      JR  SREAD
                                
       5411                     _SYS23:     ;(BDOS)ファイル・サイズの獲得
001411 5411 CD1253          17      CALL    _SYS0F
001414 5414 D8              11      RET C
                                
001415 5415 D5              11      PUSH    DE      ;EX DE,IY
001416 5416 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
001418 5418 CDC64D          17      CALL    GETSIZE
       541B                     _S24X1:
00141B 541B FD7521          19      LD  (IY+33),L   ;(FCB)Random record
00141E 541E FD7422          19      LD  (IY+34),H
001421 5421 FD362300        19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
001425 5425 FDE3            23      EX  (SP),IY     ;
001427 5427 D1              10      POP DE      ;
                                
001428 5428 AF               4      XOR A
001429 5429 C9              10      RET
                                
       542A                     _SYS24:     ;(BDOS)ランダム・レコード・フィールドの設定
00142A 542A E5              11      PUSH    HL
00142B 542B D5              11      PUSH    DE      ;EX DE,IY
00142C 542C FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00142E 542E CDA44D          17      CALL    GETSEQ
001431 5431 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       5433                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001433 5433 CDD64D          17      CALL    SET_FCB
001436 5436 E5              11      PUSH    HL
001437 5437 FD6E21          19      LD  L,(IY+33)
00143A 543A FD6622          19      LD  H,(IY+34)
00143D 543D 22BDF2          16      LD  (RR_LOW),HL
001440 5440 FD6E23          19      LD  L,(IY+35)
001443 5443 FD6624          19      LD  H,(IY+36)
001446 5446 22BFF2          16      LD  (RR_HIGH),HL
001449 5449 E1              10      POP HL
00144A 544A CD7E49          17      CALL    ROM_READ
00144D 544D ED5BBDF2        20      LD  DE,(RR_LOW)
001451 5451 FD7321          19      LD  (IY+33),E
001454 5454 FD7222          19      LD  (IY+34),D
001457 5457 ED5BBFF2        20      LD  DE,(RR_HIGH)
00145B 545B FD7323          19      LD  (IY+35),E
00145E 545E FD7224          19      LD  (IY+36),D
001461 5461 9F               4      SBC A,A
001462 5462 C9              10      RET
                                
       5463                     _SYS2F:
001463 5463 44               4      LD  B,H
001464 5464 2AC7F2          16      LD  HL,(_DTA)
001467 5467 C3DB4E          10      JP  DISKIO
                                
       546A                     _SYS5A:
00146A 546A 0600             7      LD  B,0
00146C 546C D5              11      PUSH    DE
00146D 546D DDE1            14      POP IX
       546F                     _SX5A1:
00146F 546F 1A               7      LD  A,(DE)
001470 5470 B7               4      OR  A
001471 5471 2804            12      JR  Z,_SX5A2
001473 5473 13               6      INC DE
001474 5474 04               4      INC B
001475 5475 18F8            12      JR  _SX5A1
                                
       5477                     _SX5A2:
001477 5477 78               4      LD  A,B
001478 5478 CD494A          17      CALL    FILE_BDOS
00147B 547B CD764E          17      CALL    ROM_CD
00147E 547E 9F               4      SBC A,A
00147F 547F C9              10      RET
                                
       5480                     INIT_FILE:
001480 5480 EB               4      EX  DE,HL
001481 5481 11EBF2          10      LD  DE,FDRV
001484 5484 010C00          10      LD  BC,1+8+3
001487 5487 EDB0                    LDIR
001489 5489 CDB150          17      CALL    GET_DISK_BANK_FDRV
00148C 548C 320068          13      LD  (BANK1_SEL),A           ;ASCII-8K/Konami-8K
00148F 548F 320070          13      LD  (KONAMI_SCC_BANK1_SEL),A    ;Konami-8K/Konami-SCC
001492 5492 2ADEF2          16      LD  HL,(_CD)
001495 5495 22E9F2          16      LD  (_CDX),HL           ;カレントディレクトリ
001498 5498 C9              10      RET
                                
       5499                     ZERO_MEMORY_DE:
001499 5499 AF               4      XOR A
       549A                     FILL_MEMORY_DE:
00149A 549A 12               7      LD  (DE),A
00149B 549B 13               6      INC DE
00149C 549C 10FC            13      DJNZ    FILL_MEMORY_DE
00149E 549E C9              10      RET
                                
00149F 549F                         DS  05F00H-$
       5F00                     STABLE:
                                ;0
001F00 5F00 0251185149510251        DW  _ERROR,_SYS01,_SYS02,_ERROR
001F08 5F08 025102514E518F51        DW  _ERROR,_ERROR,_SYS06,_SYS07
001F10 5F10 56510251A9513D52        DW  _SYS08,_ERROR,_SYS0A,_SYS0B
001F18 5F18 FD5203530A531253        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001F20 5F20 68537653AE530251        DW  _SYS10,_SYS11,_SYS12,_ERROR
001F28 5F28 C353025102510251        DW  _SYS14,_ERROR,_ERROR,_ERROR
001F30 5F30 DC53E153E553EB53        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001F38 5F38 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;2
001F40 5F40 0251025102511154        DW  _ERROR,_ERROR,_ERROR,_SYS23
001F48 5F48 2A54025102513354        DW  _SYS24,_ERROR,_ERROR,_SYS27
001F50 5F50 025102514F520251        DW  _ERROR,_ERROR,_SYS2A,_ERROR
001F58 5F58 5552025102516354        DW  _SYS2C,_ERROR,_ERROR,_SYS2F
                                ;3
001F60 5F60 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F68 5F68 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F70 5F70 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F78 5F78 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;4
001F80 5F80 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F88 5F88 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F90 5F90 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
001F98 5F98 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;5
001FA0 5FA0 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FA8 5FA8 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FB0 5FB0 025102516A540251        DW  _ERROR,_ERROR,_SYS5A,_ERROR
001FB8 5FB8 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;6
001FC0 5FC0 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FC8 5FC8 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD0 5FD0 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FD8 5FD8 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                ;7
001FE0 5FE0 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FE8 5FE8 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF0 5FF0 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
001FF8 5FF8 0251025102510251        DW  _ERROR,_ERROR,_ERROR,_ERROR
                                
[EOF:BDOS.ASM:UTF_8]
       6000                     LAST_ADR:
                                
                                    END
[EOF:DISKROM32.ASM:UTF_8]
